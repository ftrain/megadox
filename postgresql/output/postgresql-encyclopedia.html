<!DOCTYPE html>

<html lang="" xml:lang="" xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta charset="utf-8"/>
<meta content="pandoc" name="generator"/>
<meta content="width=device-width, initial-scale=1.0, user-scalable=yes" name="viewport"/>
<title>PostgreSQL Internals: An Encyclopedia</title>
<link href="../book-style.css" rel="stylesheet"/>
<style>
    /* Inline critical CSS for faster loading */
    body { font-family: "Palatino", Georgia, serif; }
    .book-nav {
      background: #2c3e50;
      color: white;
      padding: 0.75rem 1.5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    }
    .book-nav a {
      color: white;
      text-decoration: none;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      transition: background 0.2s;
    }
    .book-nav a:hover { background: rgba(255,255,255,0.1); }
    .book-nav .nav-left { display: flex; gap: 1rem; align-items: center; }
    .book-nav .nav-right { display: flex; gap: 0.5rem; }
    .download-btn {
      background: #3498db;
      padding: 0.4rem 0.8rem;
      border-radius: 4px;
      font-size: 0.875rem;
      font-weight: 600;
    }
    .download-btn:hover { background: #2980b9; }
    .pdf-btn { background: #e74c3c; }
    .pdf-btn:hover { background: #c0392b; }
  </style>
</head>
<body>
<nav class="book-nav">
<div class="nav-left">
<a href="../index.html">‚Üê All Books</a>
<span style="opacity: 0.7;">|</span>
<span style="font-weight: 600;">PostgreSQL Internals: An
Encyclopedia</span>
</div>
<div class="nav-right">
<a class="download-btn" href="#" onclick="window.print(); return false;">üñ®Ô∏è Print</a>
<a class="download-btn pdf-btn" href="postgresql-encyclopedia.pdf">üìÑ Download PDF</a>
</div>
</nav>
<div class="book-container">
<nav class="toc-sidebar">
<button class="toc-toggle" onclick="toggleTOC()">üìñ Table of Contents</button>
<div class="toc-content" id="toc-content">
<div class="toc-title">PostgreSQL Internals: An Encyclopedia</div>
<div class="search-container">
<input class="search-input" id="search-input" placeholder="üîç Search..." type="text"/>
<div class="search-results" id="search-results"></div>
</div><nav id="TOC"><ul>
<li><details><summary><a href="#the-postgresql-encyclopedia" id="toc-the-postgresql-encyclopedia"><span class="toc-section-number">1</span> The PostgreSQL Encyclopedia</a></summary><ul>
<li><a href="#the-definitive-guide-to-the-worlds-most-advanced-open-source-database" id="toc-the-definitive-guide-to-the-worlds-most-advanced-open-source-database"><span class="toc-section-number">1.1</span> The Definitive Guide to the
World‚Äôs Most Advanced Open Source Database</a></li>
<li><details><summary><a href="#about-this-work" id="toc-about-this-work"><span class="toc-section-number">1.2</span> About This Work</a></summary><ul>
<li><a href="#what-makes-this-different" id="toc-what-makes-this-different"><span class="toc-section-number">1.2.1</span> What Makes This
Different</a></li>
<li><a href="#scope-and-depth" id="toc-scope-and-depth"><span class="toc-section-number">1.2.2</span> Scope and Depth</a></li>
</ul></details></li>
<li><details><summary><a href="#table-of-contents" id="toc-table-of-contents"><span class="toc-section-number">1.3</span> Table of Contents</a></summary><ul>
<li><a href="#part-i-introduction-and-history" id="toc-part-i-introduction-and-history"><span class="toc-section-number">1.3.1</span> Part I: Introduction and
History</a></li>
<li><a href="#part-ii-architecture" id="toc-part-ii-architecture"><span class="toc-section-number">1.3.2</span> Part II: Architecture</a></li>
<li><a href="#part-iii-extensibility" id="toc-part-iii-extensibility"><span class="toc-section-number">1.3.3</span> Part III: Extensibility</a></li>
<li><a href="#part-iv-tools-and-utilities" id="toc-part-iv-tools-and-utilities"><span class="toc-section-number">1.3.4</span> Part IV: Tools and
Utilities</a></li>
<li><a href="#part-v-build-system-and-development" id="toc-part-v-build-system-and-development"><span class="toc-section-number">1.3.5</span> Part V: Build System and
Development</a></li>
<li><a href="#part-vi-evolution-and-culture" id="toc-part-vi-evolution-and-culture"><span class="toc-section-number">1.3.6</span> Part VI: Evolution and
Culture</a></li>
<li><a href="#part-vii-appendices" id="toc-part-vii-appendices"><span class="toc-section-number">1.3.7</span> Part VII: Appendices</a></li>
</ul></details></li>
<li><details><summary><a href="#how-to-use-this-encyclopedia" id="toc-how-to-use-this-encyclopedia"><span class="toc-section-number">1.4</span> How to Use This Encyclopedia</a></summary><ul>
<li><a href="#for-database-researchers" id="toc-for-database-researchers"><span class="toc-section-number">1.4.1</span> For Database
Researchers</a></li>
<li><a href="#for-postgresql-contributors" id="toc-for-postgresql-contributors"><span class="toc-section-number">1.4.2</span> For PostgreSQL
Contributors</a></li>
<li><a href="#for-system-architects" id="toc-for-system-architects"><span class="toc-section-number">1.4.3</span> For System Architects</a></li>
<li><a href="#for-computer-science-students" id="toc-for-computer-science-students"><span class="toc-section-number">1.4.4</span> For Computer Science
Students</a></li>
<li><a href="#for-dbas" id="toc-for-dbas"><span class="toc-section-number">1.4.5</span> For DBAs</a></li>
</ul></details></li>
<li><details><summary><a href="#technical-specifications" id="toc-technical-specifications"><span class="toc-section-number">1.5</span> Technical Specifications</a></summary><ul>
<li><a href="#codebase-analyzed" id="toc-codebase-analyzed"><span class="toc-section-number">1.5.1</span> Codebase Analyzed</a></li>
<li><a href="#source-statistics" id="toc-source-statistics"><span class="toc-section-number">1.5.2</span> Source Statistics</a></li>
<li><a href="#file-coverage" id="toc-file-coverage"><span class="toc-section-number">1.5.3</span> File Coverage</a></li>
</ul></details></li>
<li><a href="#document-structure" id="toc-document-structure"><span class="toc-section-number">1.6</span> Document Structure</a></li>
<li><details><summary><a href="#compilation" id="toc-compilation"><span class="toc-section-number">1.7</span> Compilation</a></summary><ul>
<li><a href="#epub-e-book" id="toc-epub-e-book"><span class="toc-section-number">1.7.1</span> EPUB (E-book)</a></li>
<li><a href="#pdf" id="toc-pdf"><span class="toc-section-number">1.7.2</span> PDF</a></li>
<li><a href="#html" id="toc-html"><span class="toc-section-number">1.7.3</span> HTML</a></li>
</ul></details></li>
<li><details><summary><a href="#chapter-summaries" id="toc-chapter-summaries"><span class="toc-section-number">1.8</span> Chapter Summaries</a></summary><ul>
<li><a href="#storage-layer-1434-lines" id="toc-storage-layer-1434-lines"><span class="toc-section-number">1.8.1</span> Storage Layer (1,434
lines)</a></li>
<li><a href="#query-processing-complete-pipeline" id="toc-query-processing-complete-pipeline"><span class="toc-section-number">1.8.2</span> Query Processing (Complete
Pipeline)</a></li>
<li><a href="#transactions-754-lines" id="toc-transactions-754-lines"><span class="toc-section-number">1.8.3</span> Transactions (754
lines)</a></li>
<li><a href="#replication-comprehensive-coverage" id="toc-replication-comprehensive-coverage"><span class="toc-section-number">1.8.4</span> Replication (Comprehensive
Coverage)</a></li>
<li><a href="#process-architecture" id="toc-process-architecture"><span class="toc-section-number">1.8.5</span> Process Architecture</a></li>
<li><a href="#extensions-encyclopedic" id="toc-extensions-encyclopedic"><span class="toc-section-number">1.8.6</span> Extensions
(Encyclopedic)</a></li>
<li><a href="#utilities-comprehensive-tool-guide" id="toc-utilities-comprehensive-tool-guide"><span class="toc-section-number">1.8.7</span> Utilities (Comprehensive Tool
Guide)</a></li>
<li><a href="#build-system-1915-lines" id="toc-build-system-1915-lines"><span class="toc-section-number">1.8.8</span> Build System (1,915
lines)</a></li>
</ul></details></li>
<li><details><summary><a href="#methodology" id="toc-methodology"><span class="toc-section-number">1.9</span> Methodology</a></summary><ul>
<li><a href="#systematic-code-exploration-8-parallel-agents" id="toc-systematic-code-exploration-8-parallel-agents"><span class="toc-section-number">1.9.1</span> 1. Systematic Code Exploration
(8 Parallel Agents)</a></li>
<li><a href="#historical-research" id="toc-historical-research"><span class="toc-section-number">1.9.2</span> 2. Historical Research</a></li>
<li><a href="#documentation-review" id="toc-documentation-review"><span class="toc-section-number">1.9.3</span> 3. Documentation Review</a></li>
<li><a href="#source-code-analysis" id="toc-source-code-analysis"><span class="toc-section-number">1.9.4</span> 4. Source Code Analysis</a></li>
</ul></details></li>
<li><details><summary><a href="#contributors-and-acknowledgments" id="toc-contributors-and-acknowledgments"><span class="toc-section-number">1.10</span> Contributors and
Acknowledgments</a></summary><ul>
<li><a href="#postgresql-community" id="toc-postgresql-community"><span class="toc-section-number">1.10.1</span> PostgreSQL Community</a></li>
<li><a href="#top-recent-contributors-sample-period" id="toc-top-recent-contributors-sample-period"><span class="toc-section-number">1.10.2</span> Top Recent Contributors (Sample
Period)</a></li>
<li><a href="#academic-foundation" id="toc-academic-foundation"><span class="toc-section-number">1.10.3</span> Academic Foundation</a></li>
<li><a href="#this-encyclopedia" id="toc-this-encyclopedia"><span class="toc-section-number">1.10.4</span> This Encyclopedia</a></li>
</ul></details></li>
<li><details><summary><a href="#license-and-copyright" id="toc-license-and-copyright"><span class="toc-section-number">1.11</span> License and Copyright</a></summary><ul>
<li><a href="#postgresql-license" id="toc-postgresql-license"><span class="toc-section-number">1.11.1</span> PostgreSQL License</a></li>
<li><a href="#this-encyclopedia-1" id="toc-this-encyclopedia-1"><span class="toc-section-number">1.11.2</span> This Encyclopedia</a></li>
</ul></details></li>
<li><details><summary><a href="#further-resources" id="toc-further-resources"><span class="toc-section-number">1.12</span> Further Resources</a></summary><ul>
<li><a href="#official-postgresql-resources" id="toc-official-postgresql-resources"><span class="toc-section-number">1.12.1</span> Official PostgreSQL
Resources</a></li>
<li><a href="#academic-papers" id="toc-academic-papers"><span class="toc-section-number">1.12.2</span> Academic Papers</a></li>
<li><a href="#books" id="toc-books"><span class="toc-section-number">1.12.3</span> Books</a></li>
<li><a href="#community" id="toc-community"><span class="toc-section-number">1.12.4</span> Community</a></li>
</ul></details></li>
<li><a href="#feedback-and-contributions" id="toc-feedback-and-contributions"><span class="toc-section-number">1.13</span> Feedback and
Contributions</a></li>
<li><a href="#version-history" id="toc-version-history"><span class="toc-section-number">1.14</span> Version History</a></li>
</ul></details></li>
<li><details><summary><a href="#the-postgresql-encyclopedia-1" id="toc-the-postgresql-encyclopedia-1"><span class="toc-section-number">2</span> The PostgreSQL Encyclopedia</a></summary><ul>
<li><a href="#a-comprehensive-guide-to-the-worlds-most-advanced-open-source-database" id="toc-a-comprehensive-guide-to-the-worlds-most-advanced-open-source-database"><span class="toc-section-number">2.1</span> A Comprehensive Guide to the
World‚Äôs Most Advanced Open Source Database</a></li>
<li><details><summary><a href="#preface" id="toc-preface"><span class="toc-section-number">2.2</span> Preface</a></summary><ul>
<li><a href="#purpose-and-scope" id="toc-purpose-and-scope"><span class="toc-section-number">2.2.1</span> Purpose and Scope</a></li>
<li><a href="#who-this-is-for" id="toc-who-this-is-for"><span class="toc-section-number">2.2.2</span> Who This Is For</a></li>
<li><a href="#methodology-1" id="toc-methodology-1"><span class="toc-section-number">2.2.3</span> Methodology</a></li>
</ul></details></li>
<li><details><summary><a href="#chapter-1-what-is-postgresql" id="toc-chapter-1-what-is-postgresql"><span class="toc-section-number">2.3</span> Chapter 1: What is PostgreSQL?</a></summary><ul>
<li><a href="#definition-and-core-characteristics" id="toc-definition-and-core-characteristics"><span class="toc-section-number">2.3.1</span> 1.1 Definition and Core
Characteristics</a></li>
<li><a href="#official-names-throughout-history" id="toc-official-names-throughout-history"><span class="toc-section-number">2.3.2</span> 1.2 Official Names Throughout
History</a></li>
<li><a href="#key-statistics-current-codebase" id="toc-key-statistics-current-codebase"><span class="toc-section-number">2.3.3</span> 1.3 Key Statistics (Current
Codebase)</a></li>
<li><a href="#what-makes-postgresql-different" id="toc-what-makes-postgresql-different"><span class="toc-section-number">2.3.4</span> 1.4 What Makes PostgreSQL
Different</a></li>
<li><a href="#core-features" id="toc-core-features"><span class="toc-section-number">2.3.5</span> 1.5 Core Features</a></li>
</ul></details></li>
<li><details><summary><a href="#chapter-2-historical-context" id="toc-chapter-2-historical-context"><span class="toc-section-number">2.4</span> Chapter 2: Historical Context</a></summary><ul>
<li><a href="#the-berkeley-postgres-era-1986-1994" id="toc-the-berkeley-postgres-era-1986-1994"><span class="toc-section-number">2.4.1</span> 2.1 The Berkeley POSTGRES Era
(1986-1994)</a></li>
<li><a href="#the-transition-postgres95-1994-1996" id="toc-the-transition-postgres95-1994-1996"><span class="toc-section-number">2.4.2</span> 2.2 The Transition: Postgres95
(1994-1996)</a></li>
<li><a href="#postgresql-the-open-source-era-1996-present" id="toc-postgresql-the-open-source-era-1996-present"><span class="toc-section-number">2.4.3</span> 2.3 PostgreSQL: The Open Source
Era (1996-Present)</a></li>
<li><a href="#major-version-milestones" id="toc-major-version-milestones"><span class="toc-section-number">2.4.4</span> 2.4 Major Version
Milestones</a></li>
<li><a href="#the-hardware-context" id="toc-the-hardware-context"><span class="toc-section-number">2.4.5</span> 2.5 The Hardware
Context</a></li>
</ul></details></li>
<li><details><summary><a href="#chapter-3-the-community-and-culture" id="toc-chapter-3-the-community-and-culture"><span class="toc-section-number">2.5</span> Chapter 3: The Community and
Culture</a></summary><ul>
<li><a href="#development-process" id="toc-development-process"><span class="toc-section-number">2.5.1</span> 3.1 Development Process</a></li>
<li><a href="#key-contributors" id="toc-key-contributors"><span class="toc-section-number">2.5.2</span> 3.2 Key Contributors</a></li>
<li><a href="#cultural-values" id="toc-cultural-values"><span class="toc-section-number">2.5.3</span> 3.3 Cultural Values</a></li>
</ul></details></li>
<li><a href="#about-this-encyclopedia" id="toc-about-this-encyclopedia"><span class="toc-section-number">2.6</span> About This Encyclopedia</a></li>
</ul></details></li>
<li><details><summary><a href="#chapter-1-storage-layer-architecture" id="toc-chapter-1-storage-layer-architecture"><span class="toc-section-number">3</span> Chapter 1: Storage Layer
Architecture</a></summary><ul>
<li><a href="#table-of-contents-1" id="toc-table-of-contents-1"><span class="toc-section-number">3.1</span> Table of Contents</a></li>
<li><details><summary><a href="#introduction" id="toc-introduction"><span class="toc-section-number">3.2</span> Introduction</a></summary><ul>
<li><a href="#key-components-overview" id="toc-key-components-overview"><span class="toc-section-number">3.2.1</span> Key Components Overview</a></li>
<li><a href="#design-philosophy" id="toc-design-philosophy"><span class="toc-section-number">3.2.2</span> Design Philosophy</a></li>
</ul></details></li>
<li><details><summary><a href="#page-structure" id="toc-page-structure"><span class="toc-section-number">3.3</span> Page Structure</a></summary><ul>
<li><a href="#overview" id="toc-overview"><span class="toc-section-number">3.3.1</span> Overview</a></li>
<li><a href="#page-layout" id="toc-page-layout"><span class="toc-section-number">3.3.2</span> Page Layout</a></li>
<li><a href="#page-header-structure" id="toc-page-header-structure"><span class="toc-section-number">3.3.3</span> Page Header Structure</a></li>
<li><a href="#item-pointers" id="toc-item-pointers"><span class="toc-section-number">3.3.4</span> Item Pointers</a></li>
<li><a href="#tuple-structure" id="toc-tuple-structure"><span class="toc-section-number">3.3.5</span> Tuple Structure</a></li>
<li><a href="#page-organization-examples" id="toc-page-organization-examples"><span class="toc-section-number">3.3.6</span> Page Organization
Examples</a></li>
<li><a href="#page-level-operations" id="toc-page-level-operations"><span class="toc-section-number">3.3.7</span> Page-Level Operations</a></li>
<li><a href="#page-types" id="toc-page-types"><span class="toc-section-number">3.3.8</span> Page Types</a></li>
<li><a href="#page-file-organization" id="toc-page-file-organization"><span class="toc-section-number">3.3.9</span> Page File Organization</a></li>
<li><a href="#alignment-and-padding" id="toc-alignment-and-padding"><span class="toc-section-number">3.3.10</span> Alignment and Padding</a></li>
<li><a href="#performance-implications" id="toc-performance-implications"><span class="toc-section-number">3.3.11</span> Performance
Implications</a></li>
</ul></details></li>
<li><details><summary><a href="#buffer-manager" id="toc-buffer-manager"><span class="toc-section-number">3.4</span> Buffer Manager</a></summary><ul>
<li><a href="#overview-1" id="toc-overview-1"><span class="toc-section-number">3.4.1</span> Overview</a></li>
<li><a href="#architecture" id="toc-architecture"><span class="toc-section-number">3.4.2</span> Architecture</a></li>
<li><a href="#buffer-pool-structure" id="toc-buffer-pool-structure"><span class="toc-section-number">3.4.3</span> Buffer Pool Structure</a></li>
<li><a href="#buffer-table-hash-table" id="toc-buffer-table-hash-table"><span class="toc-section-number">3.4.4</span> Buffer Table (Hash
Table)</a></li>
<li><a href="#buffer-access-protocol" id="toc-buffer-access-protocol"><span class="toc-section-number">3.4.5</span> Buffer Access Protocol</a></li>
<li><a href="#buffer-replacement-clock-sweep-algorithm" id="toc-buffer-replacement-clock-sweep-algorithm"><span class="toc-section-number">3.4.6</span> Buffer Replacement: Clock Sweep
Algorithm</a></li>
<li><a href="#buffer-access-strategies" id="toc-buffer-access-strategies"><span class="toc-section-number">3.4.7</span> Buffer Access
Strategies</a></li>
<li><a href="#buffer-pinning-and-locking" id="toc-buffer-pinning-and-locking"><span class="toc-section-number">3.4.8</span> Buffer Pinning and
Locking</a></li>
<li><a href="#write-ahead-logging-integration" id="toc-write-ahead-logging-integration"><span class="toc-section-number">3.4.9</span> Write-Ahead Logging
Integration</a></li>
<li><a href="#background-writer-and-checkpointer" id="toc-background-writer-and-checkpointer"><span class="toc-section-number">3.4.10</span> Background Writer and
Checkpointer</a></li>
<li><a href="#buffer-manager-statistics" id="toc-buffer-manager-statistics"><span class="toc-section-number">3.4.11</span> Buffer Manager
Statistics</a></li>
<li><a href="#performance-tuning" id="toc-performance-tuning"><span class="toc-section-number">3.4.12</span> Performance Tuning</a></li>
<li><a href="#local-buffers" id="toc-local-buffers"><span class="toc-section-number">3.4.13</span> Local Buffers</a></li>
<li><a href="#critical-code-paths" id="toc-critical-code-paths"><span class="toc-section-number">3.4.14</span> Critical Code Paths</a></li>
</ul></details></li>
<li><details><summary><a href="#heap-access-method" id="toc-heap-access-method"><span class="toc-section-number">3.5</span> Heap Access Method</a></summary><ul>
<li><a href="#overview-2" id="toc-overview-2"><span class="toc-section-number">3.5.1</span> Overview</a></li>
<li><a href="#heap-tuple-format" id="toc-heap-tuple-format"><span class="toc-section-number">3.5.2</span> Heap Tuple Format</a></li>
<li><a href="#heap-tuple-header-details" id="toc-heap-tuple-header-details"><span class="toc-section-number">3.5.3</span> Heap Tuple Header
Details</a></li>
<li><a href="#heap-tuple-infomask-flags" id="toc-heap-tuple-infomask-flags"><span class="toc-section-number">3.5.4</span> Heap Tuple Infomask
Flags</a></li>
<li><a href="#heap-tuple-operations" id="toc-heap-tuple-operations"><span class="toc-section-number">3.5.5</span> Heap Tuple Operations</a></li>
<li><a href="#hot-heap-only-tuple-updates" id="toc-hot-heap-only-tuple-updates"><span class="toc-section-number">3.5.6</span> HOT (Heap-Only Tuple)
Updates</a></li>
<li><a href="#tuple-locking" id="toc-tuple-locking"><span class="toc-section-number">3.5.7</span> Tuple Locking</a></li>
<li><a href="#heap-file-organization" id="toc-heap-file-organization"><span class="toc-section-number">3.5.8</span> Heap File Organization</a></li>
<li><a href="#heap-statistics-and-monitoring" id="toc-heap-statistics-and-monitoring"><span class="toc-section-number">3.5.9</span> Heap Statistics and
Monitoring</a></li>
<li><a href="#heap-access-method-api" id="toc-heap-access-method-api"><span class="toc-section-number">3.5.10</span> Heap Access Method API</a></li>
<li><a href="#performance-considerations" id="toc-performance-considerations"><span class="toc-section-number">3.5.11</span> Performance
Considerations</a></li>
</ul></details></li>
<li><details><summary><a href="#write-ahead-logging" id="toc-write-ahead-logging"><span class="toc-section-number">3.6</span> Write-Ahead Logging</a></summary><ul>
<li><a href="#overview-3" id="toc-overview-3"><span class="toc-section-number">3.6.1</span> Overview</a></li>
<li><a href="#wal-principles" id="toc-wal-principles"><span class="toc-section-number">3.6.2</span> WAL Principles</a></li>
<li><a href="#lsn-log-sequence-number" id="toc-lsn-log-sequence-number"><span class="toc-section-number">3.6.3</span> LSN (Log Sequence
Number)</a></li>
<li><a href="#wal-record-structure" id="toc-wal-record-structure"><span class="toc-section-number">3.6.4</span> WAL Record Structure</a></li>
<li><a href="#wal-record-types" id="toc-wal-record-types"><span class="toc-section-number">3.6.5</span> WAL Record Types</a></li>
<li><a href="#wal-buffer-and-writing" id="toc-wal-buffer-and-writing"><span class="toc-section-number">3.6.6</span> WAL Buffer and Writing</a></li>
<li><a href="#wal-files-and-segments" id="toc-wal-files-and-segments"><span class="toc-section-number">3.6.7</span> WAL Files and Segments</a></li>
<li><a href="#full-page-writes-fpw" id="toc-full-page-writes-fpw"><span class="toc-section-number">3.6.8</span> Full Page Writes (FPW)</a></li>
<li><a href="#checkpoints" id="toc-checkpoints"><span class="toc-section-number">3.6.9</span> Checkpoints</a></li>
<li><a href="#recovery-process" id="toc-recovery-process"><span class="toc-section-number">3.6.10</span> Recovery Process</a></li>
<li><a href="#wal-archiving" id="toc-wal-archiving"><span class="toc-section-number">3.6.11</span> WAL Archiving</a></li>
<li><a href="#wal-and-replication" id="toc-wal-and-replication"><span class="toc-section-number">3.6.12</span> WAL and Replication</a></li>
<li><a href="#wal-monitoring" id="toc-wal-monitoring"><span class="toc-section-number">3.6.13</span> WAL Monitoring</a></li>
<li><a href="#wal-internals-and-performance" id="toc-wal-internals-and-performance"><span class="toc-section-number">3.6.14</span> WAL Internals and
Performance</a></li>
<li><a href="#wal-record-decoding" id="toc-wal-record-decoding"><span class="toc-section-number">3.6.15</span> WAL Record Decoding</a></li>
</ul></details></li>
<li><details><summary><a href="#multi-version-concurrency-control" id="toc-multi-version-concurrency-control"><span class="toc-section-number">3.7</span> Multi-Version Concurrency
Control</a></summary><ul>
<li><a href="#overview-4" id="toc-overview-4"><span class="toc-section-number">3.7.1</span> Overview</a></li>
<li><a href="#core-mvcc-principles" id="toc-core-mvcc-principles"><span class="toc-section-number">3.7.2</span> Core MVCC Principles</a></li>
<li><a href="#snapshot-structure" id="toc-snapshot-structure"><span class="toc-section-number">3.7.3</span> Snapshot Structure</a></li>
<li><a href="#visibility-rules" id="toc-visibility-rules"><span class="toc-section-number">3.7.4</span> Visibility Rules</a></li>
<li><a href="#transaction-id-management" id="toc-transaction-id-management"><span class="toc-section-number">3.7.5</span> Transaction ID
Management</a></li>
<li><a href="#transaction-status-clog" id="toc-transaction-status-clog"><span class="toc-section-number">3.7.6</span> Transaction Status:
CLOG</a></li>
<li><a href="#isolation-levels" id="toc-isolation-levels"><span class="toc-section-number">3.7.7</span> Isolation Levels</a></li>
<li><a href="#serializable-snapshot-isolation-ssi" id="toc-serializable-snapshot-isolation-ssi"><span class="toc-section-number">3.7.8</span> Serializable Snapshot Isolation
(SSI)</a></li>
<li><a href="#subtransactions" id="toc-subtransactions"><span class="toc-section-number">3.7.9</span> Subtransactions</a></li>
<li><a href="#vacuum-and-dead-tuple-cleanup" id="toc-vacuum-and-dead-tuple-cleanup"><span class="toc-section-number">3.7.10</span> VACUUM and Dead Tuple
Cleanup</a></li>
<li><a href="#bloat-management" id="toc-bloat-management"><span class="toc-section-number">3.7.11</span> Bloat Management</a></li>
<li><a href="#mvcc-performance-implications" id="toc-mvcc-performance-implications"><span class="toc-section-number">3.7.12</span> MVCC Performance
Implications</a></li>
</ul></details></li>
<li><details><summary><a href="#index-access-methods" id="toc-index-access-methods"><span class="toc-section-number">3.8</span> Index Access Methods</a></summary><ul>
<li><a href="#overview-5" id="toc-overview-5"><span class="toc-section-number">3.8.1</span> Overview</a></li>
<li><a href="#b-tree-indexes" id="toc-b-tree-indexes"><span class="toc-section-number">3.8.2</span> B-tree Indexes</a></li>
<li><a href="#hash-indexes" id="toc-hash-indexes"><span class="toc-section-number">3.8.3</span> Hash Indexes</a></li>
<li><a href="#gist-generalized-search-tree" id="toc-gist-generalized-search-tree"><span class="toc-section-number">3.8.4</span> GiST (Generalized Search
Tree)</a></li>
<li><a href="#sp-gist-space-partitioned-gist" id="toc-sp-gist-space-partitioned-gist"><span class="toc-section-number">3.8.5</span> SP-GiST (Space-Partitioned
GiST)</a></li>
<li><a href="#gin-generalized-inverted-index" id="toc-gin-generalized-inverted-index"><span class="toc-section-number">3.8.6</span> GIN (Generalized Inverted
Index)</a></li>
<li><a href="#brin-block-range-index" id="toc-brin-block-range-index"><span class="toc-section-number">3.8.7</span> BRIN (Block Range
Index)</a></li>
<li><a href="#index-comparison-summary" id="toc-index-comparison-summary"><span class="toc-section-number">3.8.8</span> Index Comparison
Summary</a></li>
<li><a href="#index-maintenance" id="toc-index-maintenance"><span class="toc-section-number">3.8.9</span> Index Maintenance</a></li>
<li><a href="#partial-indexes" id="toc-partial-indexes"><span class="toc-section-number">3.8.10</span> Partial Indexes</a></li>
<li><a href="#expression-indexes" id="toc-expression-indexes"><span class="toc-section-number">3.8.11</span> Expression Indexes</a></li>
<li><a href="#index-only-scans" id="toc-index-only-scans"><span class="toc-section-number">3.8.12</span> Index-Only Scans</a></li>
</ul></details></li>
<li><details><summary><a href="#free-space-map" id="toc-free-space-map"><span class="toc-section-number">3.9</span> Free Space Map</a></summary><ul>
<li><a href="#overview-6" id="toc-overview-6"><span class="toc-section-number">3.9.1</span> Overview</a></li>
<li><a href="#purpose-and-benefits" id="toc-purpose-and-benefits"><span class="toc-section-number">3.9.2</span> Purpose and Benefits</a></li>
<li><a href="#fsm-structure" id="toc-fsm-structure"><span class="toc-section-number">3.9.3</span> FSM Structure</a></li>
<li><a href="#fsm-page-format" id="toc-fsm-page-format"><span class="toc-section-number">3.9.4</span> FSM Page Format</a></li>
<li><a href="#fsm-operations" id="toc-fsm-operations"><span class="toc-section-number">3.9.5</span> FSM Operations</a></li>
<li><a href="#fsm-maintenance" id="toc-fsm-maintenance"><span class="toc-section-number">3.9.6</span> FSM Maintenance</a></li>
<li><a href="#fsm-visibility" id="toc-fsm-visibility"><span class="toc-section-number">3.9.7</span> FSM Visibility</a></li>
<li><a href="#fsm-and-table-bloat" id="toc-fsm-and-table-bloat"><span class="toc-section-number">3.9.8</span> FSM and Table Bloat</a></li>
<li><a href="#fsm-limitations" id="toc-fsm-limitations"><span class="toc-section-number">3.9.9</span> FSM Limitations</a></li>
<li><a href="#fsm-performance-impact" id="toc-fsm-performance-impact"><span class="toc-section-number">3.9.10</span> FSM Performance Impact</a></li>
<li><a href="#fsm-code-locations" id="toc-fsm-code-locations"><span class="toc-section-number">3.9.11</span> FSM Code Locations</a></li>
</ul></details></li>
<li><details><summary><a href="#visibility-map" id="toc-visibility-map"><span class="toc-section-number">3.10</span> Visibility Map</a></summary><ul>
<li><a href="#overview-7" id="toc-overview-7"><span class="toc-section-number">3.10.1</span> Overview</a></li>
<li><a href="#structure" id="toc-structure"><span class="toc-section-number">3.10.2</span> Structure</a></li>
<li><a href="#when-pages-become-all-visible" id="toc-when-pages-become-all-visible"><span class="toc-section-number">3.10.3</span> When Pages Become
All-Visible</a></li>
<li><a href="#when-pages-become-not-all-visible" id="toc-when-pages-become-not-all-visible"><span class="toc-section-number">3.10.4</span> When Pages Become Not
All-Visible</a></li>
<li><a href="#vacuum-optimization" id="toc-vacuum-optimization"><span class="toc-section-number">3.10.5</span> VACUUM Optimization</a></li>
<li><a href="#index-only-scans-1" id="toc-index-only-scans-1"><span class="toc-section-number">3.10.6</span> Index-Only Scans</a></li>
<li><a href="#freezing-and-all-frozen-bit" id="toc-freezing-and-all-frozen-bit"><span class="toc-section-number">3.10.7</span> Freezing and All-Frozen
Bit</a></li>
<li><a href="#visibility-map-monitoring" id="toc-visibility-map-monitoring"><span class="toc-section-number">3.10.8</span> Visibility Map
Monitoring</a></li>
<li><a href="#vm-and-wal" id="toc-vm-and-wal"><span class="toc-section-number">3.10.9</span> VM and WAL</a></li>
<li><a href="#vm-file-format" id="toc-vm-file-format"><span class="toc-section-number">3.10.10</span> VM File Format</a></li>
<li><a href="#vm-performance-impact" id="toc-vm-performance-impact"><span class="toc-section-number">3.10.11</span> VM Performance Impact</a></li>
<li><a href="#vm-corruption-recovery" id="toc-vm-corruption-recovery"><span class="toc-section-number">3.10.12</span> VM Corruption
Recovery</a></li>
</ul></details></li>
<li><details><summary><a href="#toast" id="toc-toast"><span class="toc-section-number">3.11</span> TOAST</a></summary><ul>
<li><a href="#overview-8" id="toc-overview-8"><span class="toc-section-number">3.11.1</span> Overview</a></li>
<li><a href="#the-problem-toast-solves" id="toc-the-problem-toast-solves"><span class="toc-section-number">3.11.2</span> The Problem TOAST
Solves</a></li>
<li><a href="#toast-strategies" id="toc-toast-strategies"><span class="toc-section-number">3.11.3</span> TOAST Strategies</a></li>
<li><a href="#toast-threshold" id="toc-toast-threshold"><span class="toc-section-number">3.11.4</span> TOAST Threshold</a></li>
<li><a href="#toast-table-structure" id="toc-toast-table-structure"><span class="toc-section-number">3.11.5</span> TOAST Table Structure</a></li>
<li><a href="#toast-pointers" id="toc-toast-pointers"><span class="toc-section-number">3.11.6</span> TOAST Pointers</a></li>
<li><a href="#compression" id="toc-compression"><span class="toc-section-number">3.11.7</span> Compression</a></li>
<li><a href="#toast-operations" id="toc-toast-operations"><span class="toc-section-number">3.11.8</span> TOAST Operations</a></li>
<li><a href="#toast-and-vacuum" id="toc-toast-and-vacuum"><span class="toc-section-number">3.11.9</span> TOAST and VACUUM</a></li>
<li><a href="#toast-performance-implications" id="toc-toast-performance-implications"><span class="toc-section-number">3.11.10</span> TOAST Performance
Implications</a></li>
<li><a href="#toast-monitoring" id="toc-toast-monitoring"><span class="toc-section-number">3.11.11</span> TOAST Monitoring</a></li>
<li><a href="#toast-limitations" id="toc-toast-limitations"><span class="toc-section-number">3.11.12</span> TOAST Limitations</a></li>
<li><a href="#toast-and-logical-replication" id="toc-toast-and-logical-replication"><span class="toc-section-number">3.11.13</span> TOAST and Logical
Replication</a></li>
<li><a href="#toast-code-locations" id="toc-toast-code-locations"><span class="toc-section-number">3.11.14</span> TOAST Code Locations</a></li>
</ul></details></li>
<li><details><summary><a href="#conclusion" id="toc-conclusion"><span class="toc-section-number">3.12</span> Conclusion</a></summary><ul>
<li><a href="#summary" id="toc-summary"><span class="toc-section-number">3.12.1</span> Summary</a></li>
<li><a href="#architectural-principles" id="toc-architectural-principles"><span class="toc-section-number">3.12.2</span> Architectural
Principles</a></li>
<li><a href="#performance-tuning-summary" id="toc-performance-tuning-summary"><span class="toc-section-number">3.12.3</span> Performance Tuning
Summary</a></li>
<li><a href="#monitoring-essentials" id="toc-monitoring-essentials"><span class="toc-section-number">3.12.4</span> Monitoring Essentials</a></li>
<li><a href="#looking-forward" id="toc-looking-forward"><span class="toc-section-number">3.12.5</span> Looking Forward</a></li>
<li><a href="#cross-references" id="toc-cross-references"><span class="toc-section-number">3.12.6</span> Cross-References</a></li>
<li><a href="#further-reading" id="toc-further-reading"><span class="toc-section-number">3.12.7</span> Further Reading</a></li>
</ul></details></li>
</ul></details></li>
<li><details><summary><a href="#postgresql-query-processing-pipeline" id="toc-postgresql-query-processing-pipeline"><span class="toc-section-number">4</span> PostgreSQL Query Processing
Pipeline</a></summary><ul>
<li><a href="#table-of-contents-2" id="toc-table-of-contents-2"><span class="toc-section-number">4.1</span> Table of Contents</a></li>
<li><details><summary><a href="#introduction-1" id="toc-introduction-1"><span class="toc-section-number">4.2</span> 1. Introduction</a></summary><ul>
<li><a href="#query-processing-overview" id="toc-query-processing-overview"><span class="toc-section-number">4.2.1</span> 1.1 Query Processing
Overview</a></li>
<li><a href="#key-design-principles" id="toc-key-design-principles"><span class="toc-section-number">4.2.2</span> 1.2 Key Design
Principles</a></li>
</ul></details></li>
<li><details><summary><a href="#the-parser" id="toc-the-parser"><span class="toc-section-number">4.3</span> 2. The Parser</a></summary><ul>
<li><a href="#parser-components" id="toc-parser-components"><span class="toc-section-number">4.3.1</span> 2.1 Parser Components</a></li>
<li><a href="#parse-tree-to-query-transformation" id="toc-parse-tree-to-query-transformation"><span class="toc-section-number">4.3.2</span> 2.2 Parse Tree to Query
Transformation</a></li>
<li><a href="#parser-subsystems" id="toc-parser-subsystems"><span class="toc-section-number">4.3.3</span> 2.3 Parser Subsystems</a></li>
</ul></details></li>
<li><details><summary><a href="#the-rewriter" id="toc-the-rewriter"><span class="toc-section-number">4.4</span> 3. The Rewriter</a></summary><ul>
<li><a href="#rewriter-responsibilities" id="toc-rewriter-responsibilities"><span class="toc-section-number">4.4.1</span> 3.1 Rewriter
Responsibilities</a></li>
<li><a href="#main-rewrite-entry-point" id="toc-main-rewrite-entry-point"><span class="toc-section-number">4.4.2</span> 3.2 Main Rewrite Entry
Point</a></li>
<li><a href="#view-expansion" id="toc-view-expansion"><span class="toc-section-number">4.4.3</span> 3.3 View Expansion</a></li>
<li><a href="#row-level-security-rls" id="toc-row-level-security-rls"><span class="toc-section-number">4.4.4</span> 3.4 Row-Level Security
(RLS)</a></li>
<li><a href="#updatable-views" id="toc-updatable-views"><span class="toc-section-number">4.4.5</span> 3.5 Updatable Views</a></li>
</ul></details></li>
<li><details><summary><a href="#the-planneroptimizer" id="toc-the-planneroptimizer"><span class="toc-section-number">4.5</span> 4. The Planner/Optimizer</a></summary><ul>
<li><a href="#planner-architecture" id="toc-planner-architecture"><span class="toc-section-number">4.5.1</span> 4.1 Planner
Architecture</a></li>
<li><a href="#main-planner-entry-point" id="toc-main-planner-entry-point"><span class="toc-section-number">4.5.2</span> 4.2 Main Planner Entry
Point</a></li>
<li><a href="#path-generation" id="toc-path-generation"><span class="toc-section-number">4.5.3</span> 4.3 Path Generation</a></li>
<li><a href="#join-planning" id="toc-join-planning"><span class="toc-section-number">4.5.4</span> 4.4 Join Planning</a></li>
</ul></details></li>
<li><details><summary><a href="#the-executor" id="toc-the-executor"><span class="toc-section-number">4.6</span> 5. The Executor</a></summary><ul>
<li><a href="#executor-architecture" id="toc-executor-architecture"><span class="toc-section-number">4.6.1</span> 5.1 Executor
Architecture</a></li>
<li><a href="#executor-lifecycle" id="toc-executor-lifecycle"><span class="toc-section-number">4.6.2</span> 5.2 Executor Lifecycle</a></li>
<li><a href="#tuple-processing-model" id="toc-tuple-processing-model"><span class="toc-section-number">4.6.3</span> 5.3 Tuple Processing
Model</a></li>
<li><a href="#plan-node-execution" id="toc-plan-node-execution"><span class="toc-section-number">4.6.4</span> 5.4 Plan Node Execution</a></li>
</ul></details></li>
<li><details><summary><a href="#catalog-system-and-syscache" id="toc-catalog-system-and-syscache"><span class="toc-section-number">4.7</span> 6. Catalog System and Syscache</a></summary><ul>
<li><a href="#system-catalogs" id="toc-system-catalogs"><span class="toc-section-number">4.7.1</span> 6.1 System Catalogs</a></li>
<li><a href="#syscache-architecture" id="toc-syscache-architecture"><span class="toc-section-number">4.7.2</span> 6.2 Syscache
Architecture</a></li>
<li><a href="#relcache" id="toc-relcache"><span class="toc-section-number">4.7.3</span> 6.3 Relcache</a></li>
</ul></details></li>
<li><details><summary><a href="#node-types-and-data-structures" id="toc-node-types-and-data-structures"><span class="toc-section-number">4.8</span> 7. Node Types and Data
Structures</a></summary><ul>
<li><a href="#query-node" id="toc-query-node"><span class="toc-section-number">4.8.1</span> 7.1 Query Node</a></li>
<li><a href="#plan-node" id="toc-plan-node"><span class="toc-section-number">4.8.2</span> 7.2 Plan Node</a></li>
<li><a href="#planstate-node" id="toc-planstate-node"><span class="toc-section-number">4.8.3</span> 7.3 PlanState Node</a></li>
<li><a href="#specialized-plan-nodes" id="toc-specialized-plan-nodes"><span class="toc-section-number">4.8.4</span> 7.4 Specialized Plan
Nodes</a></li>
</ul></details></li>
<li><details><summary><a href="#join-algorithms" id="toc-join-algorithms"><span class="toc-section-number">4.9</span> 8. Join Algorithms</a></summary><ul>
<li><a href="#nested-loop-join" id="toc-nested-loop-join"><span class="toc-section-number">4.9.1</span> 8.1 Nested Loop Join</a></li>
<li><a href="#hash-join" id="toc-hash-join"><span class="toc-section-number">4.9.2</span> 8.2 Hash Join</a></li>
<li><a href="#merge-join" id="toc-merge-join"><span class="toc-section-number">4.9.3</span> 8.3 Merge Join</a></li>
</ul></details></li>
<li><details><summary><a href="#cost-model-and-parameters" id="toc-cost-model-and-parameters"><span class="toc-section-number">4.10</span> 9. Cost Model and Parameters</a></summary><ul>
<li><a href="#cost-parameters" id="toc-cost-parameters"><span class="toc-section-number">4.10.1</span> 9.1 Cost Parameters</a></li>
<li><a href="#sequential-scan-costing" id="toc-sequential-scan-costing"><span class="toc-section-number">4.10.2</span> 9.2 Sequential Scan
Costing</a></li>
<li><a href="#index-scan-costing" id="toc-index-scan-costing"><span class="toc-section-number">4.10.3</span> 9.3 Index Scan Costing</a></li>
<li><a href="#join-costing" id="toc-join-costing"><span class="toc-section-number">4.10.4</span> 9.4 Join Costing</a></li>
<li><a href="#selectivity-estimation" id="toc-selectivity-estimation"><span class="toc-section-number">4.10.5</span> 9.5 Selectivity
Estimation</a></li>
</ul></details></li>
<li><details><summary><a href="#expression-evaluation" id="toc-expression-evaluation"><span class="toc-section-number">4.11</span> 10. Expression Evaluation</a></summary><ul>
<li><a href="#exprstate-structure" id="toc-exprstate-structure"><span class="toc-section-number">4.11.1</span> 10.1 ExprState
Structure</a></li>
<li><a href="#expression-compilation" id="toc-expression-compilation"><span class="toc-section-number">4.11.2</span> 10.2 Expression
Compilation</a></li>
<li><a href="#expression-steps" id="toc-expression-steps"><span class="toc-section-number">4.11.3</span> 10.3 Expression Steps</a></li>
<li><a href="#jit-compilation" id="toc-jit-compilation"><span class="toc-section-number">4.11.4</span> 10.4 JIT Compilation</a></li>
</ul></details></li>
<li><details><summary><a href="#complete-query-example-walkthrough" id="toc-complete-query-example-walkthrough"><span class="toc-section-number">4.12</span> 11. Complete Query Example
Walkthrough</a></summary><ul>
<li><a href="#example-query" id="toc-example-query"><span class="toc-section-number">4.12.1</span> 11.1 Example Query</a></li>
<li><a href="#stage-1-parsing" id="toc-stage-1-parsing"><span class="toc-section-number">4.12.2</span> 11.2 Stage 1: Parsing</a></li>
<li><a href="#stage-2-rewriting" id="toc-stage-2-rewriting"><span class="toc-section-number">4.12.3</span> 11.3 Stage 2:
Rewriting</a></li>
<li><a href="#stage-3-planning" id="toc-stage-3-planning"><span class="toc-section-number">4.12.4</span> 11.4 Stage 3: Planning</a></li>
<li><a href="#stage-4-execution" id="toc-stage-4-execution"><span class="toc-section-number">4.12.5</span> 11.5 Stage 4:
Execution</a></li>
<li><a href="#performance-monitoring" id="toc-performance-monitoring"><span class="toc-section-number">4.12.6</span> 11.6 Performance
Monitoring</a></li>
</ul></details></li>
<li><a href="#conclusion-1" id="toc-conclusion-1"><span class="toc-section-number">4.13</span> Conclusion</a></li>
</ul></details></li>
<li><details><summary><a href="#chapter-3-transaction-management" id="toc-chapter-3-transaction-management"><span class="toc-section-number">5</span> Chapter 3: Transaction
Management</a></summary><ul>
<li><a href="#overview-9" id="toc-overview-9"><span class="toc-section-number">5.1</span> Overview</a></li>
<li><details><summary><a href="#acid-properties-implementation" id="toc-acid-properties-implementation"><span class="toc-section-number">5.2</span> 1. ACID Properties
Implementation</a></summary><ul>
<li><a href="#atomicity" id="toc-atomicity"><span class="toc-section-number">5.2.1</span> 1.1 Atomicity</a></li>
<li><a href="#consistency" id="toc-consistency"><span class="toc-section-number">5.2.2</span> 1.2 Consistency</a></li>
<li><a href="#isolation" id="toc-isolation"><span class="toc-section-number">5.2.3</span> 1.3 Isolation</a></li>
<li><a href="#durability" id="toc-durability"><span class="toc-section-number">5.2.4</span> 1.4 Durability</a></li>
</ul></details></li>
<li><details><summary><a href="#multi-version-concurrency-control-mvcc" id="toc-multi-version-concurrency-control-mvcc"><span class="toc-section-number">5.3</span> 2. Multi-Version Concurrency
Control (MVCC)</a></summary><ul>
<li><a href="#overview-10" id="toc-overview-10"><span class="toc-section-number">5.3.1</span> 2.1 Overview</a></li>
<li><a href="#transaction-ids-xids" id="toc-transaction-ids-xids"><span class="toc-section-number">5.3.2</span> 2.2 Transaction IDs
(XIDs)</a></li>
<li><a href="#snapshotdata-structure" id="toc-snapshotdata-structure"><span class="toc-section-number">5.3.3</span> 2.3 SnapshotData
Structure</a></li>
<li><a href="#snapshot-types" id="toc-snapshot-types"><span class="toc-section-number">5.3.4</span> 2.4 Snapshot Types</a></li>
<li><a href="#visibility-determination" id="toc-visibility-determination"><span class="toc-section-number">5.3.5</span> 2.5 Visibility
Determination</a></li>
<li><a href="#snapshot-acquisition" id="toc-snapshot-acquisition"><span class="toc-section-number">5.3.6</span> 2.6 Snapshot
Acquisition</a></li>
</ul></details></li>
<li><details><summary><a href="#process-control-structure-pgproc" id="toc-process-control-structure-pgproc"><span class="toc-section-number">5.4</span> 3. Process Control Structure
(PGPROC)</a></summary><ul>
<li><a href="#proc_hdr-and-dense-arrays" id="toc-proc_hdr-and-dense-arrays"><span class="toc-section-number">5.4.1</span> 3.1 PROC_HDR and Dense
Arrays</a></li>
</ul></details></li>
<li><details><summary><a href="#locking-system" id="toc-locking-system"><span class="toc-section-number">5.5</span> 4. Locking System</a></summary><ul>
<li><a href="#spinlocks" id="toc-spinlocks"><span class="toc-section-number">5.5.1</span> 4.1 Spinlocks</a></li>
<li><a href="#lightweight-locks-lwlocks" id="toc-lightweight-locks-lwlocks"><span class="toc-section-number">5.5.2</span> 4.2 Lightweight Locks
(LWLocks)</a></li>
<li><a href="#heavyweight-locks-regular-locks" id="toc-heavyweight-locks-regular-locks"><span class="toc-section-number">5.5.3</span> 4.3 Heavyweight Locks (Regular
Locks)</a></li>
</ul></details></li>
<li><details><summary><a href="#deadlock-detection" id="toc-deadlock-detection"><span class="toc-section-number">5.6</span> 5. Deadlock Detection</a></summary><ul>
<li><a href="#algorithm" id="toc-algorithm"><span class="toc-section-number">5.6.1</span> 5.1 Algorithm</a></li>
<li><a href="#detection-process" id="toc-detection-process"><span class="toc-section-number">5.6.2</span> 5.2 Detection Process</a></li>
<li><a href="#soft-deadlocks" id="toc-soft-deadlocks"><span class="toc-section-number">5.6.3</span> 5.3 Soft Deadlocks</a></li>
<li><a href="#timeout-strategy" id="toc-timeout-strategy"><span class="toc-section-number">5.6.4</span> 5.4 Timeout Strategy</a></li>
</ul></details></li>
<li><details><summary><a href="#transaction-id-management-and-wraparound" id="toc-transaction-id-management-and-wraparound"><span class="toc-section-number">5.7</span> 6. Transaction ID Management and
Wraparound</a></summary><ul>
<li><a href="#the-wraparound-problem" id="toc-the-wraparound-problem"><span class="toc-section-number">5.7.1</span> 6.1 The Wraparound
Problem</a></li>
<li><a href="#transamvariables-structure" id="toc-transamvariables-structure"><span class="toc-section-number">5.7.2</span> 6.2 TransamVariables
Structure</a></li>
<li><a href="#freezing" id="toc-freezing"><span class="toc-section-number">5.7.3</span> 6.3 Freezing</a></li>
<li><a href="#wraparound-protection" id="toc-wraparound-protection"><span class="toc-section-number">5.7.4</span> 6.4 Wraparound
Protection</a></li>
<li><a href="#multixact-ids" id="toc-multixact-ids"><span class="toc-section-number">5.7.5</span> 6.5 MultiXact IDs</a></li>
</ul></details></li>
<li><details><summary><a href="#transaction-commit-and-abort" id="toc-transaction-commit-and-abort"><span class="toc-section-number">5.8</span> 7. Transaction Commit and
Abort</a></summary><ul>
<li><a href="#commit-processing" id="toc-commit-processing"><span class="toc-section-number">5.8.1</span> 7.1 Commit Processing</a></li>
<li><a href="#commit-record-structure" id="toc-commit-record-structure"><span class="toc-section-number">5.8.2</span> 7.2 Commit Record
Structure</a></li>
<li><a href="#abort-processing" id="toc-abort-processing"><span class="toc-section-number">5.8.3</span> 7.3 Abort Processing</a></li>
<li><a href="#commit-log-clog" id="toc-commit-log-clog"><span class="toc-section-number">5.8.4</span> 7.4 Commit Log (CLOG)</a></li>
<li><a href="#subtransactions-1" id="toc-subtransactions-1"><span class="toc-section-number">5.8.5</span> 7.5 Subtransactions</a></li>
</ul></details></li>
<li><details><summary><a href="#two-phase-commit-2pc" id="toc-two-phase-commit-2pc"><span class="toc-section-number">5.9</span> 8. Two-Phase Commit (2PC)</a></summary><ul>
<li><a href="#overview-11" id="toc-overview-11"><span class="toc-section-number">5.9.1</span> 8.1 Overview</a></li>
<li><a href="#prepared-transactions" id="toc-prepared-transactions"><span class="toc-section-number">5.9.2</span> 8.2 Prepared
Transactions</a></li>
<li><a href="#commitabort-prepared" id="toc-commitabort-prepared"><span class="toc-section-number">5.9.3</span> 8.3 Commit/Abort
Prepared</a></li>
<li><a href="#recovery-of-prepared-transactions" id="toc-recovery-of-prepared-transactions"><span class="toc-section-number">5.9.4</span> 8.4 Recovery of Prepared
Transactions</a></li>
<li><a href="#limitations-and-caveats" id="toc-limitations-and-caveats"><span class="toc-section-number">5.9.5</span> 8.5 Limitations and
Caveats</a></li>
</ul></details></li>
<li><details><summary><a href="#isolation-levels-1" id="toc-isolation-levels-1"><span class="toc-section-number">5.10</span> 9. Isolation Levels</a></summary><ul>
<li><a href="#read-committed" id="toc-read-committed"><span class="toc-section-number">5.10.1</span> 9.1 READ COMMITTED</a></li>
<li><a href="#repeatable-read" id="toc-repeatable-read"><span class="toc-section-number">5.10.2</span> 9.2 REPEATABLE READ</a></li>
<li><a href="#serializable" id="toc-serializable"><span class="toc-section-number">5.10.3</span> 9.3 SERIALIZABLE</a></li>
<li><a href="#serializable-snapshot-isolation-ssi-1" id="toc-serializable-snapshot-isolation-ssi-1"><span class="toc-section-number">5.10.4</span> 9.4 Serializable Snapshot
Isolation (SSI)</a></li>
</ul></details></li>
<li><details><summary><a href="#subtransaction-management" id="toc-subtransaction-management"><span class="toc-section-number">5.11</span> 10. Subtransaction Management</a></summary><ul>
<li><a href="#savepoints" id="toc-savepoints"><span class="toc-section-number">5.11.1</span> 10.1 Savepoints</a></li>
<li><a href="#subtransaction-stack" id="toc-subtransaction-stack"><span class="toc-section-number">5.11.2</span> 10.2 Subtransaction
Stack</a></li>
<li><a href="#xid-assignment-to-subtransactions" id="toc-xid-assignment-to-subtransactions"><span class="toc-section-number">5.11.3</span> 10.3 XID Assignment to
Subtransactions</a></li>
<li><a href="#subtransaction-cache" id="toc-subtransaction-cache"><span class="toc-section-number">5.11.4</span> 10.4 Subtransaction
Cache</a></li>
<li><a href="#commitabort-behavior" id="toc-commitabort-behavior"><span class="toc-section-number">5.11.5</span> 10.5 Commit/Abort
Behavior</a></li>
</ul></details></li>
<li><details><summary><a href="#transaction-state-tracking" id="toc-transaction-state-tracking"><span class="toc-section-number">5.12</span> 11. Transaction State
Tracking</a></summary><ul>
<li><a href="#transaction-state-machine" id="toc-transaction-state-machine"><span class="toc-section-number">5.12.1</span> 11.1 Transaction State
Machine</a></li>
<li><a href="#transaction-flags" id="toc-transaction-flags"><span class="toc-section-number">5.12.2</span> 11.2 Transaction Flags</a></li>
<li><a href="#command-counter" id="toc-command-counter"><span class="toc-section-number">5.12.3</span> 11.3 Command Counter</a></li>
</ul></details></li>
<li><details><summary><a href="#group-commit-optimization" id="toc-group-commit-optimization"><span class="toc-section-number">5.13</span> 12. Group Commit Optimization</a></summary><ul>
<li><a href="#wal-insert-locks" id="toc-wal-insert-locks"><span class="toc-section-number">5.13.1</span> 12.1 WAL Insert Locks</a></li>
<li><a href="#clog-group-update" id="toc-clog-group-update"><span class="toc-section-number">5.13.2</span> 12.2 CLOG Group Update</a></li>
</ul></details></li>
<li><details><summary><a href="#performance-considerations-2" id="toc-performance-considerations-2"><span class="toc-section-number">5.14</span> 13. Performance
Considerations</a></summary><ul>
<li><a href="#lock-contention" id="toc-lock-contention"><span class="toc-section-number">5.14.1</span> 13.1 Lock Contention</a></li>
<li><a href="#transaction-id-consumption" id="toc-transaction-id-consumption"><span class="toc-section-number">5.14.2</span> 13.2 Transaction ID
Consumption</a></li>
<li><a href="#snapshot-scalability" id="toc-snapshot-scalability"><span class="toc-section-number">5.14.3</span> 13.3 Snapshot
Scalability</a></li>
<li><a href="#long-running-transactions" id="toc-long-running-transactions"><span class="toc-section-number">5.14.4</span> 13.4 Long-Running
Transactions</a></li>
</ul></details></li>
<li><details><summary><a href="#debugging-and-monitoring" id="toc-debugging-and-monitoring"><span class="toc-section-number">5.15</span> 14. Debugging and Monitoring</a></summary><ul>
<li><a href="#lock-monitoring" id="toc-lock-monitoring"><span class="toc-section-number">5.15.1</span> 14.1 Lock Monitoring</a></li>
<li><a href="#transaction-information" id="toc-transaction-information"><span class="toc-section-number">5.15.2</span> 14.2 Transaction
Information</a></li>
<li><a href="#deadlock-logging" id="toc-deadlock-logging"><span class="toc-section-number">5.15.3</span> 14.3 Deadlock Logging</a></li>
<li><a href="#trace-flags" id="toc-trace-flags"><span class="toc-section-number">5.15.4</span> 14.4 Trace Flags</a></li>
</ul></details></li>
<li><details><summary><a href="#notable-source-code-locations" id="toc-notable-source-code-locations"><span class="toc-section-number">5.16</span> 15. Notable Source Code
Locations</a></summary><ul>
<li><a href="#core-transaction-files" id="toc-core-transaction-files"><span class="toc-section-number">5.16.1</span> 15.1 Core Transaction
Files</a></li>
<li><a href="#lock-manager-files" id="toc-lock-manager-files"><span class="toc-section-number">5.16.2</span> 15.2 Lock Manager
Files</a></li>
<li><a href="#snapshot-and-visibility" id="toc-snapshot-and-visibility"><span class="toc-section-number">5.16.3</span> 15.3 Snapshot and
Visibility</a></li>
<li><a href="#key-header-files" id="toc-key-header-files"><span class="toc-section-number">5.16.4</span> 15.4 Key Header Files</a></li>
</ul></details></li>
<li><details><summary><a href="#wal-records-for-transactions" id="toc-wal-records-for-transactions"><span class="toc-section-number">5.17</span> 16. WAL Records for
Transactions</a></summary><ul>
<li><a href="#transaction-wal-record-types" id="toc-transaction-wal-record-types"><span class="toc-section-number">5.17.1</span> 16.1 Transaction WAL Record
Types</a></li>
<li><a href="#commit-record-contents" id="toc-commit-record-contents"><span class="toc-section-number">5.17.2</span> 16.2 Commit Record
Contents</a></li>
<li><a href="#recovery" id="toc-recovery"><span class="toc-section-number">5.17.3</span> 16.3 Recovery</a></li>
</ul></details></li>
<li><details><summary><a href="#advanced-topics" id="toc-advanced-topics"><span class="toc-section-number">5.18</span> 17. Advanced Topics</a></summary><ul>
<li><a href="#parallel-query-and-transactions" id="toc-parallel-query-and-transactions"><span class="toc-section-number">5.18.1</span> 17.1 Parallel Query and
Transactions</a></li>
<li><a href="#logical-replication-and-transaction-tracking" id="toc-logical-replication-and-transaction-tracking"><span class="toc-section-number">5.18.2</span> 17.2 Logical Replication and
Transaction Tracking</a></li>
<li><a href="#hot-standby-and-transaction-conflicts" id="toc-hot-standby-and-transaction-conflicts"><span class="toc-section-number">5.18.3</span> 17.3 Hot Standby and
Transaction Conflicts</a></li>
<li><a href="#prepared-transactions-and-replication" id="toc-prepared-transactions-and-replication"><span class="toc-section-number">5.18.4</span> 17.4 Prepared Transactions and
Replication</a></li>
</ul></details></li>
<li><details><summary><a href="#common-pitfalls-and-best-practices" id="toc-common-pitfalls-and-best-practices"><span class="toc-section-number">5.19</span> 18. Common Pitfalls and Best
Practices</a></summary><ul>
<li><a href="#pitfalls" id="toc-pitfalls"><span class="toc-section-number">5.19.1</span> 18.1 Pitfalls</a></li>
<li><a href="#best-practices" id="toc-best-practices"><span class="toc-section-number">5.19.2</span> 18.2 Best Practices</a></li>
</ul></details></li>
<li><details><summary><a href="#future-directions" id="toc-future-directions"><span class="toc-section-number">5.20</span> 19. Future Directions</a></summary><ul>
<li><a href="#ongoing-work" id="toc-ongoing-work"><span class="toc-section-number">5.20.1</span> 19.1 Ongoing Work</a></li>
<li><a href="#research-areas" id="toc-research-areas"><span class="toc-section-number">5.20.2</span> 19.2 Research Areas</a></li>
</ul></details></li>
<li><a href="#conclusion-2" id="toc-conclusion-2"><span class="toc-section-number">5.21</span> Conclusion</a></li>
<li><a href="#references" id="toc-references"><span class="toc-section-number">5.22</span> References</a></li>
</ul></details></li>
<li><details><summary><a href="#chapter-4-replication-and-recovery-systems" id="toc-chapter-4-replication-and-recovery-systems"><span class="toc-section-number">6</span> Chapter 4: Replication and Recovery
Systems</a></summary><ul>
<li><a href="#overview-12" id="toc-overview-12"><span class="toc-section-number">6.1</span> Overview</a></li>
<li><details><summary><a href="#wal-based-streaming-replication" id="toc-wal-based-streaming-replication"><span class="toc-section-number">6.2</span> 1. WAL-Based Streaming
Replication</a></summary><ul>
<li><a href="#architecture-overview" id="toc-architecture-overview"><span class="toc-section-number">6.2.1</span> 1.1 Architecture
Overview</a></li>
<li><a href="#walsender-architecture" id="toc-walsender-architecture"><span class="toc-section-number">6.2.2</span> 1.2 WalSender
Architecture</a></li>
<li><a href="#walreceiver-architecture" id="toc-walreceiver-architecture"><span class="toc-section-number">6.2.3</span> 1.3 WalReceiver
Architecture</a></li>
<li><a href="#replication-protocol-flow" id="toc-replication-protocol-flow"><span class="toc-section-number">6.2.4</span> 1.4 Replication Protocol
Flow</a></li>
</ul></details></li>
<li><details><summary><a href="#logical-replication-and-logical-decoding" id="toc-logical-replication-and-logical-decoding"><span class="toc-section-number">6.3</span> 2. Logical Replication and Logical
Decoding</a></summary><ul>
<li><a href="#logical-replication-overview" id="toc-logical-replication-overview"><span class="toc-section-number">6.3.1</span> 2.1 Logical Replication
Overview</a></li>
<li><a href="#logicaldecodingcontext" id="toc-logicaldecodingcontext"><span class="toc-section-number">6.3.2</span> 2.2
LogicalDecodingContext</a></li>
<li><a href="#reorderbuffer-transaction-reassembly" id="toc-reorderbuffer-transaction-reassembly"><span class="toc-section-number">6.3.3</span> 2.3 ReorderBuffer: Transaction
Reassembly</a></li>
<li><a href="#output-plugins" id="toc-output-plugins"><span class="toc-section-number">6.3.4</span> 2.4 Output Plugins</a></li>
</ul></details></li>
<li><details><summary><a href="#replication-slots" id="toc-replication-slots"><span class="toc-section-number">6.4</span> 3. Replication Slots</a></summary><ul>
<li><a href="#purpose-and-design" id="toc-purpose-and-design"><span class="toc-section-number">6.4.1</span> 3.1 Purpose and Design</a></li>
<li><a href="#replicationslot-data-structure" id="toc-replicationslot-data-structure"><span class="toc-section-number">6.4.2</span> 3.2 ReplicationSlot Data
Structure</a></li>
<li><a href="#slot-invalidation" id="toc-slot-invalidation"><span class="toc-section-number">6.4.3</span> 3.3 Slot Invalidation</a></li>
</ul></details></li>
<li><details><summary><a href="#hot-standby-implementation" id="toc-hot-standby-implementation"><span class="toc-section-number">6.5</span> 4. Hot Standby Implementation</a></summary><ul>
<li><a href="#hot-standby-architecture" id="toc-hot-standby-architecture"><span class="toc-section-number">6.5.1</span> 4.1 Hot Standby
Architecture</a></li>
<li><a href="#wal-replay-during-hot-standby" id="toc-wal-replay-during-hot-standby"><span class="toc-section-number">6.5.2</span> 4.2 WAL Replay During Hot
Standby</a></li>
<li><a href="#hot-standby-feedback" id="toc-hot-standby-feedback"><span class="toc-section-number">6.5.3</span> 4.3 Hot Standby
Feedback</a></li>
</ul></details></li>
<li><details><summary><a href="#point-in-time-recovery-pitr" id="toc-point-in-time-recovery-pitr"><span class="toc-section-number">6.6</span> 5. Point-In-Time Recovery
(PITR)</a></summary><ul>
<li><a href="#pitr-overview" id="toc-pitr-overview"><span class="toc-section-number">6.6.1</span> 5.1 PITR Overview</a></li>
<li><a href="#pitr-configuration" id="toc-pitr-configuration"><span class="toc-section-number">6.6.2</span> 5.2 PITR Configuration</a></li>
<li><a href="#creating-restore-points" id="toc-creating-restore-points"><span class="toc-section-number">6.6.3</span> 5.3 Creating Restore
Points</a></li>
<li><a href="#timeline-management" id="toc-timeline-management"><span class="toc-section-number">6.6.4</span> 5.4 Timeline Management</a></li>
</ul></details></li>
<li><details><summary><a href="#crash-recovery-and-checkpoints" id="toc-crash-recovery-and-checkpoints"><span class="toc-section-number">6.7</span> 6. Crash Recovery and
Checkpoints</a></summary><ul>
<li><a href="#crash-recovery-mechanism" id="toc-crash-recovery-mechanism"><span class="toc-section-number">6.7.1</span> 6.1 Crash Recovery
Mechanism</a></li>
<li><a href="#checkpoint-algorithm" id="toc-checkpoint-algorithm"><span class="toc-section-number">6.7.2</span> 6.2 Checkpoint
Algorithm</a></li>
<li><a href="#checkpoint-scheduling" id="toc-checkpoint-scheduling"><span class="toc-section-number">6.7.3</span> 6.3 Checkpoint
Scheduling</a></li>
<li><a href="#checkpoint-tuning" id="toc-checkpoint-tuning"><span class="toc-section-number">6.7.4</span> 6.4 Checkpoint Tuning</a></li>
</ul></details></li>
<li><details><summary><a href="#pg_basebackup-integration" id="toc-pg_basebackup-integration"><span class="toc-section-number">6.8</span> 7. pg_basebackup Integration</a></summary><ul>
<li><a href="#pg_basebackup-overview" id="toc-pg_basebackup-overview"><span class="toc-section-number">6.8.1</span> 7.1 pg_basebackup
Overview</a></li>
<li><a href="#backup-protocol" id="toc-backup-protocol"><span class="toc-section-number">6.8.2</span> 7.2 Backup Protocol</a></li>
<li><a href="#wal-streaming-during-backup" id="toc-wal-streaming-during-backup"><span class="toc-section-number">6.8.3</span> 7.3 WAL Streaming During
Backup</a></li>
<li><a href="#backup-label-and-tablespace-map" id="toc-backup-label-and-tablespace-map"><span class="toc-section-number">6.8.4</span> 7.4 Backup Label and Tablespace
Map</a></li>
<li><a href="#replication-slot-integration" id="toc-replication-slot-integration"><span class="toc-section-number">6.8.5</span> 7.5 Replication Slot
Integration</a></li>
<li><a href="#backup-verification" id="toc-backup-verification"><span class="toc-section-number">6.8.6</span> 7.6 Backup Verification</a></li>
</ul></details></li>
<li><details><summary><a href="#advanced-replication-topics" id="toc-advanced-replication-topics"><span class="toc-section-number">6.9</span> 8. Advanced Replication Topics</a></summary><ul>
<li><a href="#synchronous-replication" id="toc-synchronous-replication"><span class="toc-section-number">6.9.1</span> 8.1 Synchronous
Replication</a></li>
<li><a href="#cascading-replication" id="toc-cascading-replication"><span class="toc-section-number">6.9.2</span> 8.2 Cascading
Replication</a></li>
<li><a href="#delayed-replication" id="toc-delayed-replication"><span class="toc-section-number">6.9.3</span> 8.3 Delayed Replication</a></li>
<li><a href="#bi-directional-replication" id="toc-bi-directional-replication"><span class="toc-section-number">6.9.4</span> 8.4 Bi-Directional
Replication</a></li>
</ul></details></li>
<li><details><summary><a href="#monitoring-and-diagnostics" id="toc-monitoring-and-diagnostics"><span class="toc-section-number">6.10</span> 9. Monitoring and Diagnostics</a></summary><ul>
<li><a href="#replication-monitoring-views" id="toc-replication-monitoring-views"><span class="toc-section-number">6.10.1</span> 9.1 Replication Monitoring
Views</a></li>
<li><a href="#lag-monitoring" id="toc-lag-monitoring"><span class="toc-section-number">6.10.2</span> 9.2 Lag Monitoring</a></li>
<li><a href="#wal-generation-monitoring" id="toc-wal-generation-monitoring"><span class="toc-section-number">6.10.3</span> 9.3 WAL Generation
Monitoring</a></li>
<li><a href="#diagnostic-queries" id="toc-diagnostic-queries"><span class="toc-section-number">6.10.4</span> 9.4 Diagnostic Queries</a></li>
</ul></details></li>
<li><details><summary><a href="#common-replication-patterns" id="toc-common-replication-patterns"><span class="toc-section-number">6.11</span> 10. Common Replication
Patterns</a></summary><ul>
<li><a href="#primary-standby-active-passive" id="toc-primary-standby-active-passive"><span class="toc-section-number">6.11.1</span> 10.1 Primary-Standby
(Active-Passive)</a></li>
<li><a href="#primary-with-multiple-standbys" id="toc-primary-with-multiple-standbys"><span class="toc-section-number">6.11.2</span> 10.2 Primary with Multiple
Standbys</a></li>
<li><a href="#logical-replication-for-upgrades" id="toc-logical-replication-for-upgrades"><span class="toc-section-number">6.11.3</span> 10.3 Logical Replication for
Upgrades</a></li>
<li><a href="#multi-region-active-active" id="toc-multi-region-active-active"><span class="toc-section-number">6.11.4</span> 10.4 Multi-Region
Active-Active</a></li>
</ul></details></li>
<li><details><summary><a href="#troubleshooting" id="toc-troubleshooting"><span class="toc-section-number">6.12</span> 11. Troubleshooting</a></summary><ul>
<li><a href="#replication-lag-investigation" id="toc-replication-lag-investigation"><span class="toc-section-number">6.12.1</span> 11.1 Replication Lag
Investigation</a></li>
<li><a href="#replication-slot-issues" id="toc-replication-slot-issues"><span class="toc-section-number">6.12.2</span> 11.2 Replication Slot
Issues</a></li>
<li><a href="#hot-standby-query-conflicts" id="toc-hot-standby-query-conflicts"><span class="toc-section-number">6.12.3</span> 11.3 Hot Standby Query
Conflicts</a></li>
<li><a href="#logical-replication-issues" id="toc-logical-replication-issues"><span class="toc-section-number">6.12.4</span> 11.4 Logical Replication
Issues</a></li>
</ul></details></li>
<li><details><summary><a href="#performance-optimization" id="toc-performance-optimization"><span class="toc-section-number">6.13</span> 12. Performance Optimization</a></summary><ul>
<li><a href="#wal-configuration-tuning" id="toc-wal-configuration-tuning"><span class="toc-section-number">6.13.1</span> 12.1 WAL Configuration
Tuning</a></li>
<li><a href="#replication-performance" id="toc-replication-performance"><span class="toc-section-number">6.13.2</span> 12.2 Replication
Performance</a></li>
<li><a href="#checkpoint-tuning-for-replication" id="toc-checkpoint-tuning-for-replication"><span class="toc-section-number">6.13.3</span> 12.3 Checkpoint Tuning for
Replication</a></li>
</ul></details></li>
<li><details><summary><a href="#security-considerations" id="toc-security-considerations"><span class="toc-section-number">6.14</span> 13. Security Considerations</a></summary><ul>
<li><a href="#replication-authentication" id="toc-replication-authentication"><span class="toc-section-number">6.14.1</span> 13.1 Replication
Authentication</a></li>
<li><a href="#ssltls-for-replication" id="toc-ssltls-for-replication"><span class="toc-section-number">6.14.2</span> 13.2 SSL/TLS for
Replication</a></li>
</ul></details></li>
<li><details><summary><a href="#future-directions-1" id="toc-future-directions-1"><span class="toc-section-number">6.15</span> 14. Future Directions</a></summary><ul>
<li><a href="#ongoing-developments" id="toc-ongoing-developments"><span class="toc-section-number">6.15.1</span> 14.1 Ongoing
Developments</a></li>
<li><a href="#postgresql-17-features" id="toc-postgresql-17-features"><span class="toc-section-number">6.15.2</span> 14.2 PostgreSQL 17+
Features</a></li>
</ul></details></li>
<li><a href="#summary-1" id="toc-summary-1"><span class="toc-section-number">6.16</span> 15. Summary</a></li>
<li><a href="#references-1" id="toc-references-1"><span class="toc-section-number">6.17</span> References</a></li>
</ul></details></li>
<li><details><summary><a href="#chapter-5-process-architecture" id="toc-chapter-5-process-architecture"><span class="toc-section-number">7</span> Chapter 5: Process Architecture</a></summary><ul>
<li><a href="#introduction-2" id="toc-introduction-2"><span class="toc-section-number">7.1</span> Introduction</a></li>
<li><details><summary><a href="#the-process-model-philosophy" id="toc-the-process-model-philosophy"><span class="toc-section-number">7.2</span> 1. The Process Model
Philosophy</a></summary><ul>
<li><a href="#why-multi-process-vs-multi-threading" id="toc-why-multi-process-vs-multi-threading"><span class="toc-section-number">7.2.1</span> 1.1 Why Multi-Process vs
Multi-Threading?</a></li>
<li><a href="#process-hierarchy" id="toc-process-hierarchy"><span class="toc-section-number">7.2.2</span> 1.2 Process Hierarchy</a></li>
</ul></details></li>
<li><details><summary><a href="#the-postmaster-supervisor-and-guardian" id="toc-the-postmaster-supervisor-and-guardian"><span class="toc-section-number">7.3</span> 2. The Postmaster: Supervisor and
Guardian</a></summary><ul>
<li><a href="#role-and-responsibilities" id="toc-role-and-responsibilities"><span class="toc-section-number">7.3.1</span> 2.1 Role and
Responsibilities</a></li>
<li><a href="#startup-sequence" id="toc-startup-sequence"><span class="toc-section-number">7.3.2</span> 2.2 Startup Sequence</a></li>
<li><a href="#the-postmaster-never-touches-shared-memory" id="toc-the-postmaster-never-touches-shared-memory"><span class="toc-section-number">7.3.3</span> 2.3 The Postmaster Never Touches
Shared Memory</a></li>
<li><a href="#process-spawning" id="toc-process-spawning"><span class="toc-section-number">7.3.4</span> 2.4 Process Spawning</a></li>
<li><a href="#signal-handling" id="toc-signal-handling"><span class="toc-section-number">7.3.5</span> 2.5 Signal Handling</a></li>
</ul></details></li>
<li><details><summary><a href="#backend-processes" id="toc-backend-processes"><span class="toc-section-number">7.4</span> 3. Backend Processes</a></summary><ul>
<li><a href="#backend-process-types" id="toc-backend-process-types"><span class="toc-section-number">7.4.1</span> 3.1 Backend Process
Types</a></li>
<li><a href="#backend-process-lifecycle" id="toc-backend-process-lifecycle"><span class="toc-section-number">7.4.2</span> 3.2 Backend Process
Lifecycle</a></li>
<li><a href="#backend-state-machine" id="toc-backend-state-machine"><span class="toc-section-number">7.4.3</span> 3.3 Backend State
Machine</a></li>
<li><a href="#main-backend-loop" id="toc-main-backend-loop"><span class="toc-section-number">7.4.4</span> 3.4 Main Backend Loop</a></li>
</ul></details></li>
<li><details><summary><a href="#auxiliary-processes" id="toc-auxiliary-processes"><span class="toc-section-number">7.5</span> 4. Auxiliary Processes</a></summary><ul>
<li><a href="#background-writer-bgwriter" id="toc-background-writer-bgwriter"><span class="toc-section-number">7.5.1</span> 4.1 Background Writer
(bgwriter)</a></li>
<li><a href="#checkpointer" id="toc-checkpointer"><span class="toc-section-number">7.5.2</span> 4.2 Checkpointer</a></li>
<li><a href="#wal-writer" id="toc-wal-writer"><span class="toc-section-number">7.5.3</span> 4.3 WAL Writer</a></li>
<li><a href="#autovacuum-launcher-and-workers" id="toc-autovacuum-launcher-and-workers"><span class="toc-section-number">7.5.4</span> 4.4 Autovacuum Launcher and
Workers</a></li>
<li><a href="#wal-sender" id="toc-wal-sender"><span class="toc-section-number">7.5.5</span> 4.5 WAL Sender</a></li>
<li><a href="#wal-receiver-on-standby" id="toc-wal-receiver-on-standby"><span class="toc-section-number">7.5.6</span> 4.6 WAL Receiver (on
standby)</a></li>
<li><a href="#archiver" id="toc-archiver"><span class="toc-section-number">7.5.7</span> 4.7 Archiver</a></li>
<li><a href="#statistics-collector" id="toc-statistics-collector"><span class="toc-section-number">7.5.8</span> 4.8 Statistics
Collector</a></li>
<li><a href="#logical-replication-launcher-and-workers" id="toc-logical-replication-launcher-and-workers"><span class="toc-section-number">7.5.9</span> 4.9 Logical Replication Launcher
and Workers</a></li>
<li><a href="#logger-syslogger" id="toc-logger-syslogger"><span class="toc-section-number">7.5.10</span> 4.10 Logger
(syslogger)</a></li>
</ul></details></li>
<li><details><summary><a href="#shared-memory-architecture" id="toc-shared-memory-architecture"><span class="toc-section-number">7.6</span> 5. Shared Memory Architecture</a></summary><ul>
<li><a href="#shared-memory-overview" id="toc-shared-memory-overview"><span class="toc-section-number">7.6.1</span> 5.1 Shared Memory
Overview</a></li>
<li><a href="#shared-memory-layout" id="toc-shared-memory-layout"><span class="toc-section-number">7.6.2</span> 5.2 Shared Memory
Layout</a></li>
<li><a href="#shared-memory-initialization" id="toc-shared-memory-initialization"><span class="toc-section-number">7.6.3</span> 5.3 Shared Memory
Initialization</a></li>
<li><a href="#buffer-management" id="toc-buffer-management"><span class="toc-section-number">7.6.4</span> 5.4 Buffer Management</a></li>
</ul></details></li>
<li><details><summary><a href="#inter-process-communication-mechanisms" id="toc-inter-process-communication-mechanisms"><span class="toc-section-number">7.7</span> 6. Inter-Process Communication
Mechanisms</a></summary><ul>
<li><a href="#signals" id="toc-signals"><span class="toc-section-number">7.7.1</span> 6.1 Signals</a></li>
<li><a href="#latches" id="toc-latches"><span class="toc-section-number">7.7.2</span> 6.2 Latches</a></li>
<li><a href="#spinlocks-1" id="toc-spinlocks-1"><span class="toc-section-number">7.7.3</span> 6.3 Spinlocks</a></li>
<li><a href="#lightweight-locks-lwlocks-1" id="toc-lightweight-locks-lwlocks-1"><span class="toc-section-number">7.7.4</span> 6.4 Lightweight Locks
(LWLocks)</a></li>
<li><a href="#heavyweight-locks" id="toc-heavyweight-locks"><span class="toc-section-number">7.7.5</span> 6.5 Heavyweight Locks</a></li>
<li><a href="#wait-events" id="toc-wait-events"><span class="toc-section-number">7.7.6</span> 6.6 Wait Events</a></li>
</ul></details></li>
<li><details><summary><a href="#clientserver-protocol" id="toc-clientserver-protocol"><span class="toc-section-number">7.8</span> 7. Client/Server Protocol</a></summary><ul>
<li><a href="#connection-establishment" id="toc-connection-establishment"><span class="toc-section-number">7.8.1</span> 7.1 Connection
Establishment</a></li>
<li><a href="#message-format" id="toc-message-format"><span class="toc-section-number">7.8.2</span> 7.2 Message Format</a></li>
<li><a href="#message-types" id="toc-message-types"><span class="toc-section-number">7.8.3</span> 7.3 Message Types</a></li>
<li><a href="#simple-query-protocol" id="toc-simple-query-protocol"><span class="toc-section-number">7.8.4</span> 7.4 Simple Query
Protocol</a></li>
<li><a href="#extended-query-protocol" id="toc-extended-query-protocol"><span class="toc-section-number">7.8.5</span> 7.5 Extended Query
Protocol</a></li>
</ul></details></li>
<li><details><summary><a href="#authentication" id="toc-authentication"><span class="toc-section-number">7.9</span> 8. Authentication</a></summary><ul>
<li><a href="#pg_hba.conf-rules" id="toc-pg_hba.conf-rules"><span class="toc-section-number">7.9.1</span> 8.1 pg_hba.conf Rules</a></li>
<li><a href="#authentication-methods" id="toc-authentication-methods"><span class="toc-section-number">7.9.2</span> 8.2 Authentication
Methods</a></li>
<li><a href="#scram-sha-256-authentication-flow" id="toc-scram-sha-256-authentication-flow"><span class="toc-section-number">7.9.3</span> 8.3 SCRAM-SHA-256 Authentication
Flow</a></li>
<li><a href="#ssltls-encryption" id="toc-ssltls-encryption"><span class="toc-section-number">7.9.4</span> 8.4 SSL/TLS Encryption</a></li>
</ul></details></li>
<li><details><summary><a href="#shutdown-modes" id="toc-shutdown-modes"><span class="toc-section-number">7.10</span> 9. Shutdown Modes</a></summary><ul>
<li><a href="#smart-shutdown-sigterm" id="toc-smart-shutdown-sigterm"><span class="toc-section-number">7.10.1</span> 9.1 Smart Shutdown
(SIGTERM)</a></li>
<li><a href="#fast-shutdown-sigint" id="toc-fast-shutdown-sigint"><span class="toc-section-number">7.10.2</span> 9.2 Fast Shutdown
(SIGINT)</a></li>
<li><a href="#immediate-shutdown-sigquit" id="toc-immediate-shutdown-sigquit"><span class="toc-section-number">7.10.3</span> 9.3 Immediate Shutdown
(SIGQUIT)</a></li>
<li><a href="#shutdown-comparison" id="toc-shutdown-comparison"><span class="toc-section-number">7.10.4</span> 9.4 Shutdown
Comparison</a></li>
</ul></details></li>
<li><details><summary><a href="#process-state-diagrams" id="toc-process-state-diagrams"><span class="toc-section-number">7.11</span> 10. Process State Diagrams</a></summary><ul>
<li><a href="#complete-backend-state-machine" id="toc-complete-backend-state-machine"><span class="toc-section-number">7.11.1</span> 10.1 Complete Backend State
Machine</a></li>
<li><a href="#postmaster-state-machine" id="toc-postmaster-state-machine"><span class="toc-section-number">7.11.2</span> 10.2 Postmaster State
Machine</a></li>
</ul></details></li>
<li><details><summary><a href="#implementation-details" id="toc-implementation-details"><span class="toc-section-number">7.12</span> 11. Implementation Details</a></summary><ul>
<li><a href="#key-source-files" id="toc-key-source-files"><span class="toc-section-number">7.12.1</span> 11.1 Key Source Files</a></li>
<li><a href="#key-data-structures" id="toc-key-data-structures"><span class="toc-section-number">7.12.2</span> 11.2 Key Data
Structures</a></li>
<li><a href="#process-title-ps-display" id="toc-process-title-ps-display"><span class="toc-section-number">7.12.3</span> 11.3 Process Title (ps
Display)</a></li>
</ul></details></li>
<li><details><summary><a href="#cross-references-and-related-topics" id="toc-cross-references-and-related-topics"><span class="toc-section-number">7.13</span> 12. Cross-References and Related
Topics</a></summary><ul>
<li><a href="#related-encyclopedia-chapters" id="toc-related-encyclopedia-chapters"><span class="toc-section-number">7.13.1</span> Related Encyclopedia
Chapters</a></li>
<li><a href="#key-system-views" id="toc-key-system-views"><span class="toc-section-number">7.13.2</span> Key System Views</a></li>
<li><a href="#performance-tuning-1" id="toc-performance-tuning-1"><span class="toc-section-number">7.13.3</span> Performance Tuning</a></li>
</ul></details></li>
<li><a href="#conclusion-3" id="toc-conclusion-3"><span class="toc-section-number">7.14</span> Conclusion</a></li>
</ul></details></li>
<li><details><summary><a href="#chapter-6-extension-system" id="toc-chapter-6-extension-system"><span class="toc-section-number">8</span> Chapter 6: Extension System</a></summary><ul>
<li><a href="#overview-13" id="toc-overview-13"><span class="toc-section-number">8.1</span> Overview</a></li>
<li><details><summary><a href="#extension-infrastructure" id="toc-extension-infrastructure"><span class="toc-section-number">8.2</span> Extension Infrastructure</a></summary><ul>
<li><a href="#extension-control-files" id="toc-extension-control-files"><span class="toc-section-number">8.2.1</span> Extension Control Files</a></li>
<li><a href="#extension-sql-scripts" id="toc-extension-sql-scripts"><span class="toc-section-number">8.2.2</span> Extension SQL Scripts</a></li>
<li><a href="#extension-installation-and-upgrade" id="toc-extension-installation-and-upgrade"><span class="toc-section-number">8.2.3</span> Extension Installation and
Upgrade</a></li>
</ul></details></li>
<li><details><summary><a href="#function-manager-fmgr" id="toc-function-manager-fmgr"><span class="toc-section-number">8.3</span> Function Manager (fmgr)</a></summary><ul>
<li><a href="#function-call-interface" id="toc-function-call-interface"><span class="toc-section-number">8.3.1</span> Function Call Interface</a></li>
<li><a href="#writing-c-functions" id="toc-writing-c-functions"><span class="toc-section-number">8.3.2</span> Writing C Functions</a></li>
<li><a href="#module-validation" id="toc-module-validation"><span class="toc-section-number">8.3.3</span> Module Validation</a></li>
<li><a href="#function-manager-hooks" id="toc-function-manager-hooks"><span class="toc-section-number">8.3.4</span> Function Manager Hooks</a></li>
</ul></details></li>
<li><details><summary><a href="#procedural-languages" id="toc-procedural-languages"><span class="toc-section-number">8.4</span> Procedural Languages</a></summary><ul>
<li><a href="#language-handler-interface" id="toc-language-handler-interface"><span class="toc-section-number">8.4.1</span> Language Handler
Interface</a></li>
<li><a href="#plpgsql" id="toc-plpgsql"><span class="toc-section-number">8.4.2</span> PL/pgSQL</a></li>
<li><a href="#plpython-plperl-pltcl" id="toc-plpython-plperl-pltcl"><span class="toc-section-number">8.4.3</span> PL/Python, PL/Perl,
PL/Tcl</a></li>
<li><a href="#language-handler-example-pattern" id="toc-language-handler-example-pattern"><span class="toc-section-number">8.4.4</span> Language Handler Example
Pattern</a></li>
</ul></details></li>
<li><details><summary><a href="#foreign-data-wrappers" id="toc-foreign-data-wrappers"><span class="toc-section-number">8.5</span> Foreign Data Wrappers</a></summary><ul>
<li><a href="#fdw-api-architecture" id="toc-fdw-api-architecture"><span class="toc-section-number">8.5.1</span> FDW API Architecture</a></li>
<li><a href="#fdw-handler-function" id="toc-fdw-handler-function"><span class="toc-section-number">8.5.2</span> FDW Handler Function</a></li>
<li><a href="#file_fdw-example" id="toc-file_fdw-example"><span class="toc-section-number">8.5.3</span> file_fdw Example</a></li>
</ul></details></li>
<li><details><summary><a href="#custom-operators-and-index-access-methods" id="toc-custom-operators-and-index-access-methods"><span class="toc-section-number">8.6</span> Custom Operators and Index Access
Methods</a></summary><ul>
<li><a href="#custom-operators" id="toc-custom-operators"><span class="toc-section-number">8.6.1</span> Custom Operators</a></li>
<li><a href="#index-access-method-api" id="toc-index-access-method-api"><span class="toc-section-number">8.6.2</span> Index Access Method API</a></li>
<li><a href="#bloom-filter-index-example" id="toc-bloom-filter-index-example"><span class="toc-section-number">8.6.3</span> Bloom Filter Index
Example</a></li>
</ul></details></li>
<li><details><summary><a href="#postgresql-hooks-system" id="toc-postgresql-hooks-system"><span class="toc-section-number">8.7</span> PostgreSQL Hooks System</a></summary><ul>
<li><a href="#hook-architecture-pattern" id="toc-hook-architecture-pattern"><span class="toc-section-number">8.7.1</span> Hook Architecture
Pattern</a></li>
<li><a href="#hook-categories" id="toc-hook-categories"><span class="toc-section-number">8.7.2</span> Hook Categories</a></li>
<li><a href="#hook-implementation-example-auto_explain" id="toc-hook-implementation-example-auto_explain"><span class="toc-section-number">8.7.3</span> Hook Implementation Example:
auto_explain</a></li>
</ul></details></li>
<li><details><summary><a href="#contrib-modules" id="toc-contrib-modules"><span class="toc-section-number">8.8</span> Contrib Modules</a></summary><ul>
<li><a href="#hstore-key-value-store" id="toc-hstore-key-value-store"><span class="toc-section-number">8.8.1</span> hstore: Key-Value Store</a></li>
<li><a href="#bloom-bloom-filter-index" id="toc-bloom-bloom-filter-index"><span class="toc-section-number">8.8.2</span> bloom: Bloom Filter
Index</a></li>
<li><a href="#auto_explain-automatic-plan-logging" id="toc-auto_explain-automatic-plan-logging"><span class="toc-section-number">8.8.3</span> auto_explain: Automatic Plan
Logging</a></li>
<li><a href="#additional-notable-contrib-modules" id="toc-additional-notable-contrib-modules"><span class="toc-section-number">8.8.4</span> Additional Notable Contrib
Modules</a></li>
</ul></details></li>
<li><details><summary><a href="#pgxs-build-infrastructure" id="toc-pgxs-build-infrastructure"><span class="toc-section-number">8.9</span> PGXS Build Infrastructure</a></summary><ul>
<li><a href="#pgxs-makefile-structure" id="toc-pgxs-makefile-structure"><span class="toc-section-number">8.9.1</span> PGXS Makefile Structure</a></li>
<li><a href="#pgxs-variables" id="toc-pgxs-variables"><span class="toc-section-number">8.9.2</span> PGXS Variables</a></li>
<li><a href="#pgxs-build-targets" id="toc-pgxs-build-targets"><span class="toc-section-number">8.9.3</span> PGXS Build Targets</a></li>
<li><a href="#complete-extension-example" id="toc-complete-extension-example"><span class="toc-section-number">8.9.4</span> Complete Extension
Example</a></li>
<li><a href="#pgxs-advanced-features" id="toc-pgxs-advanced-features"><span class="toc-section-number">8.9.5</span> PGXS Advanced Features</a></li>
</ul></details></li>
<li><details><summary><a href="#extension-development-best-practices" id="toc-extension-development-best-practices"><span class="toc-section-number">8.10</span> Extension Development Best
Practices</a></summary><ul>
<li><a href="#version-management" id="toc-version-management"><span class="toc-section-number">8.10.1</span> Version Management</a></li>
<li><a href="#dependency-management" id="toc-dependency-management"><span class="toc-section-number">8.10.2</span> Dependency Management</a></li>
<li><a href="#memory-management" id="toc-memory-management"><span class="toc-section-number">8.10.3</span> Memory Management</a></li>
<li><a href="#error-handling" id="toc-error-handling"><span class="toc-section-number">8.10.4</span> Error Handling</a></li>
<li><a href="#security-considerations-1" id="toc-security-considerations-1"><span class="toc-section-number">8.10.5</span> Security
Considerations</a></li>
<li><a href="#performance-optimization-1" id="toc-performance-optimization-1"><span class="toc-section-number">8.10.6</span> Performance
Optimization</a></li>
<li><a href="#documentation" id="toc-documentation"><span class="toc-section-number">8.10.7</span> Documentation</a></li>
</ul></details></li>
<li><a href="#conclusion-4" id="toc-conclusion-4"><span class="toc-section-number">8.11</span> Conclusion</a></li>
</ul></details></li>
<li><details><summary><a href="#chapter-7-postgresql-utility-programs" id="toc-chapter-7-postgresql-utility-programs"><span class="toc-section-number">9</span> Chapter 7: PostgreSQL Utility
Programs</a></summary><ul>
<li><a href="#introduction-3" id="toc-introduction-3"><span class="toc-section-number">9.1</span> Introduction</a></li>
<li><details><summary><a href="#backup-and-restore-utilities" id="toc-backup-and-restore-utilities"><span class="toc-section-number">9.2</span> 1. Backup and Restore
Utilities</a></summary><ul>
<li><a href="#pg_dump---logical-backup" id="toc-pg_dump---logical-backup"><span class="toc-section-number">9.2.1</span> 1.1 pg_dump - Logical
Backup</a></li>
<li><a href="#pg_restore---logical-restore" id="toc-pg_restore---logical-restore"><span class="toc-section-number">9.2.2</span> 1.2 pg_restore - Logical
Restore</a></li>
<li><a href="#pg_basebackup---physical-backup" id="toc-pg_basebackup---physical-backup"><span class="toc-section-number">9.2.3</span> 1.3 pg_basebackup - Physical
Backup</a></li>
<li><a href="#pg_verifybackup---backup-verification" id="toc-pg_verifybackup---backup-verification"><span class="toc-section-number">9.2.4</span> 1.4 pg_verifybackup - Backup
Verification</a></li>
</ul></details></li>
<li><details><summary><a href="#interactive-terminal---psql" id="toc-interactive-terminal---psql"><span class="toc-section-number">9.3</span> 2. Interactive Terminal - psql</a></summary><ul>
<li><a href="#overview-14" id="toc-overview-14"><span class="toc-section-number">9.3.1</span> 2.1 Overview</a></li>
<li><a href="#architecture-1" id="toc-architecture-1"><span class="toc-section-number">9.3.2</span> 2.2 Architecture</a></li>
<li><a href="#major-command-categories" id="toc-major-command-categories"><span class="toc-section-number">9.3.3</span> 2.3 Major Command
Categories</a></li>
<li><a href="#advanced-features" id="toc-advanced-features"><span class="toc-section-number">9.3.4</span> 2.4 Advanced Features</a></li>
<li><a href="#usage-examples" id="toc-usage-examples"><span class="toc-section-number">9.3.5</span> 2.5 Usage Examples</a></li>
<li><a href="#backend-integration" id="toc-backend-integration"><span class="toc-section-number">9.3.6</span> 2.6 Backend Integration</a></li>
</ul></details></li>
<li><details><summary><a href="#cluster-management" id="toc-cluster-management"><span class="toc-section-number">9.4</span> 3. Cluster Management</a></summary><ul>
<li><a href="#initdb---database-cluster-initialization" id="toc-initdb---database-cluster-initialization"><span class="toc-section-number">9.4.1</span> 3.1 initdb - Database Cluster
Initialization</a></li>
<li><a href="#pg_ctl---postgresql-server-control" id="toc-pg_ctl---postgresql-server-control"><span class="toc-section-number">9.4.2</span> 3.2 pg_ctl - PostgreSQL Server
Control</a></li>
</ul></details></li>
<li><details><summary><a href="#maintenance-tools" id="toc-maintenance-tools"><span class="toc-section-number">9.5</span> 4. Maintenance Tools</a></summary><ul>
<li><a href="#vacuumdb---vacuum-database" id="toc-vacuumdb---vacuum-database"><span class="toc-section-number">9.5.1</span> 4.1 vacuumdb - Vacuum
Database</a></li>
<li><a href="#reindexdb---rebuild-indexes" id="toc-reindexdb---rebuild-indexes"><span class="toc-section-number">9.5.2</span> 4.2 reindexdb - Rebuild
Indexes</a></li>
<li><a href="#clusterdb---cluster-tables" id="toc-clusterdb---cluster-tables"><span class="toc-section-number">9.5.3</span> 4.3 clusterdb - Cluster
Tables</a></li>
<li><a href="#convenience-databaseuser-management-tools" id="toc-convenience-databaseuser-management-tools"><span class="toc-section-number">9.5.4</span> 4.4 Convenience Database/User
Management Tools</a></li>
</ul></details></li>
<li><details><summary><a href="#administrative-tools" id="toc-administrative-tools"><span class="toc-section-number">9.6</span> 5. Administrative Tools</a></summary><ul>
<li><a href="#pg_upgrade---in-place-major-version-upgrade" id="toc-pg_upgrade---in-place-major-version-upgrade"><span class="toc-section-number">9.6.1</span> 5.1 pg_upgrade - In-Place Major
Version Upgrade</a></li>
<li><a href="#pg_resetwal---reset-write-ahead-log" id="toc-pg_resetwal---reset-write-ahead-log"><span class="toc-section-number">9.6.2</span> 5.2 pg_resetwal - Reset
Write-Ahead Log</a></li>
<li><a href="#pg_rewind---synchronize-data-directory-with-another-cluster" id="toc-pg_rewind---synchronize-data-directory-with-another-cluster"><span class="toc-section-number">9.6.3</span> 5.3 pg_rewind - Synchronize Data
Directory with Another Cluster</a></li>
</ul></details></li>
<li><details><summary><a href="#diagnostic-and-verification-tools" id="toc-diagnostic-and-verification-tools"><span class="toc-section-number">9.7</span> 6. Diagnostic and Verification
Tools</a></summary><ul>
<li><a href="#pg_waldump---wal-file-decoder" id="toc-pg_waldump---wal-file-decoder"><span class="toc-section-number">9.7.1</span> 6.1 pg_waldump - WAL File
Decoder</a></li>
<li><a href="#pg_amcheck---relation-corruption-detection" id="toc-pg_amcheck---relation-corruption-detection"><span class="toc-section-number">9.7.2</span> 6.2 pg_amcheck - Relation
Corruption Detection</a></li>
<li><a href="#pg_controldata---display-control-file-information" id="toc-pg_controldata---display-control-file-information"><span class="toc-section-number">9.7.3</span> 6.3 pg_controldata - Display
Control File Information</a></li>
<li><a href="#pg_checksums---enabledisableverify-data-checksums" id="toc-pg_checksums---enabledisableverify-data-checksums"><span class="toc-section-number">9.7.4</span> 6.4 pg_checksums -
Enable/Disable/Verify Data Checksums</a></li>
<li><a href="#other-diagnostic-tools" id="toc-other-diagnostic-tools"><span class="toc-section-number">9.7.5</span> 6.5 Other Diagnostic
Tools</a></li>
</ul></details></li>
<li><details><summary><a href="#benchmarking---pgbench" id="toc-benchmarking---pgbench"><span class="toc-section-number">9.8</span> 7. Benchmarking - pgbench</a></summary><ul>
<li><a href="#overview-15" id="toc-overview-15"><span class="toc-section-number">9.8.1</span> 7.1 Overview</a></li>
<li><a href="#main-features" id="toc-main-features"><span class="toc-section-number">9.8.2</span> 7.2 Main Features</a></li>
<li><a href="#usage-examples-1" id="toc-usage-examples-1"><span class="toc-section-number">9.8.3</span> 7.3 Usage Examples</a></li>
<li><a href="#output-interpretation" id="toc-output-interpretation"><span class="toc-section-number">9.8.4</span> 7.4 Output
Interpretation</a></li>
<li><a href="#backend-integration-1" id="toc-backend-integration-1"><span class="toc-section-number">9.8.5</span> 7.5 Backend Integration</a></li>
</ul></details></li>
<li><details><summary><a href="#utility-program-infrastructure" id="toc-utility-program-infrastructure"><span class="toc-section-number">9.9</span> 8. Utility Program
Infrastructure</a></summary><ul>
<li><a href="#shared-components" id="toc-shared-components"><span class="toc-section-number">9.9.1</span> 8.1 Shared Components</a></li>
<li><a href="#connection-handling-patterns" id="toc-connection-handling-patterns"><span class="toc-section-number">9.9.2</span> 8.2 Connection Handling
Patterns</a></li>
<li><a href="#logging-framework" id="toc-logging-framework"><span class="toc-section-number">9.9.3</span> 8.3 Logging Framework</a></li>
<li><a href="#error-handling-conventions" id="toc-error-handling-conventions"><span class="toc-section-number">9.9.4</span> 8.4 Error Handling
Conventions</a></li>
</ul></details></li>
<li><details><summary><a href="#platform-considerations" id="toc-platform-considerations"><span class="toc-section-number">9.10</span> 9. Platform Considerations</a></summary><ul>
<li><a href="#unixlinux" id="toc-unixlinux"><span class="toc-section-number">9.10.1</span> 9.1 Unix/Linux</a></li>
<li><a href="#windows" id="toc-windows"><span class="toc-section-number">9.10.2</span> 9.2 Windows</a></li>
</ul></details></li>
<li><details><summary><a href="#best-practices-and-guidelines" id="toc-best-practices-and-guidelines"><span class="toc-section-number">9.11</span> 10. Best Practices and
Guidelines</a></summary><ul>
<li><a href="#backup-strategies" id="toc-backup-strategies"><span class="toc-section-number">9.11.1</span> 10.1 Backup Strategies</a></li>
<li><a href="#maintenance-schedules" id="toc-maintenance-schedules"><span class="toc-section-number">9.11.2</span> 10.2 Maintenance
Schedules</a></li>
<li><a href="#performance-testing" id="toc-performance-testing"><span class="toc-section-number">9.11.3</span> 10.3 Performance
Testing</a></li>
<li><a href="#security-considerations-2" id="toc-security-considerations-2"><span class="toc-section-number">9.11.4</span> 10.4 Security
Considerations</a></li>
</ul></details></li>
<li><details><summary><a href="#troubleshooting-common-issues" id="toc-troubleshooting-common-issues"><span class="toc-section-number">9.12</span> 11. Troubleshooting Common
Issues</a></summary><ul>
<li><a href="#connection-problems" id="toc-connection-problems"><span class="toc-section-number">9.12.1</span> 11.1 Connection
Problems</a></li>
<li><a href="#backuprestore-issues" id="toc-backuprestore-issues"><span class="toc-section-number">9.12.2</span> 11.2 Backup/Restore
Issues</a></li>
<li><a href="#performance-issues" id="toc-performance-issues"><span class="toc-section-number">9.12.3</span> 11.3 Performance
Issues</a></li>
</ul></details></li>
<li><details><summary><a href="#future-directions-2" id="toc-future-directions-2"><span class="toc-section-number">9.13</span> 12. Future Directions</a></summary><ul>
<li><a href="#recent-enhancements" id="toc-recent-enhancements"><span class="toc-section-number">9.13.1</span> 12.1 Recent
Enhancements</a></li>
<li><a href="#ongoing-development" id="toc-ongoing-development"><span class="toc-section-number">9.13.2</span> 12.2 Ongoing
Development</a></li>
</ul></details></li>
<li><a href="#conclusion-5" id="toc-conclusion-5"><span class="toc-section-number">9.14</span> Conclusion</a></li>
<li><a href="#references-2" id="toc-references-2"><span class="toc-section-number">9.15</span> References</a></li>
</ul></details></li>
<li><details><summary><a href="#chapter-8-historical-evolution-of-postgresql" id="toc-chapter-8-historical-evolution-of-postgresql"><span class="toc-section-number">10</span> Chapter 8: Historical Evolution of
PostgreSQL</a></summary><ul>
<li><a href="#from-berkeley-research-to-modern-enterprise-database" id="toc-from-berkeley-research-to-modern-enterprise-database"><span class="toc-section-number">10.1</span> From Berkeley Research to Modern
Enterprise Database</a></li>
<li><a href="#introduction-4" id="toc-introduction-4"><span class="toc-section-number">10.2</span> Introduction</a></li>
<li><details><summary><a href="#part-1-major-version-milestones" id="toc-part-1-major-version-milestones"><span class="toc-section-number">10.3</span> Part 1: Major Version
Milestones</a></summary><ul>
<li><a href="#the-version-numbering-history" id="toc-the-version-numbering-history"><span class="toc-section-number">10.3.1</span> The Version Numbering
History</a></li>
<li><a href="#version-6.x-series-1997-1998-the-foundation" id="toc-version-6.x-series-1997-1998-the-foundation"><span class="toc-section-number">10.3.2</span> Version 6.x Series (1997-1998):
The Foundation</a></li>
<li><a href="#version-7.x-series-2000-2004-enterprise-features" id="toc-version-7.x-series-2000-2004-enterprise-features"><span class="toc-section-number">10.3.3</span> Version 7.x Series (2000-2004):
Enterprise Features</a></li>
<li><a href="#version-8.x-series-2005-2010-windows-and-maturity" id="toc-version-8.x-series-2005-2010-windows-and-maturity"><span class="toc-section-number">10.3.4</span> Version 8.x Series (2005-2010):
Windows and Maturity</a></li>
<li><a href="#version-9.x-series-2010-2016-replication-and-json" id="toc-version-9.x-series-2010-2016-replication-and-json"><span class="toc-section-number">10.3.5</span> Version 9.x Series (2010-2016):
Replication and JSON</a></li>
<li><a href="#version-10-october-2017-logical-replication-and-partitioning" id="toc-version-10-october-2017-logical-replication-and-partitioning"><span class="toc-section-number">10.3.6</span> Version 10 (October 2017):
Logical Replication and Partitioning</a></li>
<li><a href="#version-11-october-2018-stored-procedures-and-jit" id="toc-version-11-october-2018-stored-procedures-and-jit"><span class="toc-section-number">10.3.7</span> Version 11 (October 2018):
Stored Procedures and JIT</a></li>
<li><a href="#version-12-october-2019-generated-columns-and-pluggable-storage" id="toc-version-12-october-2019-generated-columns-and-pluggable-storage"><span class="toc-section-number">10.3.8</span> Version 12 (October 2019):
Generated Columns and Pluggable Storage</a></li>
<li><a href="#version-13-september-2020-incremental-sorting-and-parallel-vacuum" id="toc-version-13-september-2020-incremental-sorting-and-parallel-vacuum"><span class="toc-section-number">10.3.9</span> Version 13 (September 2020):
Incremental Sorting and Parallel Vacuum</a></li>
<li><a href="#version-14-september-2021-libpq-pipeline-mode" id="toc-version-14-september-2021-libpq-pipeline-mode"><span class="toc-section-number">10.3.10</span> Version 14 (September 2021):
Libpq Pipeline Mode</a></li>
<li><a href="#version-15-october-2022-merge-command" id="toc-version-15-october-2022-merge-command"><span class="toc-section-number">10.3.11</span> Version 15 (October 2022):
MERGE Command</a></li>
<li><a href="#version-16-september-2023-parallelism-and-logical-replication" id="toc-version-16-september-2023-parallelism-and-logical-replication"><span class="toc-section-number">10.3.12</span> Version 16 (September 2023):
Parallelism and Logical Replication</a></li>
<li><a href="#version-17-september-2024-latest-release" id="toc-version-17-september-2024-latest-release"><span class="toc-section-number">10.3.13</span> Version 17 (September 2024):
Latest Release</a></li>
</ul></details></li>
<li><details><summary><a href="#part-2-coding-pattern-evolution" id="toc-part-2-coding-pattern-evolution"><span class="toc-section-number">10.4</span> Part 2: Coding Pattern
Evolution</a></summary><ul>
<li><a href="#early-c-patterns-vs-modern-approaches" id="toc-early-c-patterns-vs-modern-approaches"><span class="toc-section-number">10.4.1</span> Early C Patterns vs Modern
Approaches</a></li>
<li><a href="#parallel-query-evolution" id="toc-parallel-query-evolution"><span class="toc-section-number">10.4.2</span> Parallel Query
Evolution</a></li>
<li><a href="#memory-management-improvements" id="toc-memory-management-improvements"><span class="toc-section-number">10.4.3</span> Memory Management
Improvements</a></li>
<li><a href="#error-handling-evolution-1" id="toc-error-handling-evolution-1"><span class="toc-section-number">10.4.4</span> Error Handling
Evolution</a></li>
</ul></details></li>
<li><details><summary><a href="#part-3-performance-journey" id="toc-part-3-performance-journey"><span class="toc-section-number">10.5</span> Part 3: Performance Journey</a></summary><ul>
<li><a href="#query-optimizer-improvements-over-time" id="toc-query-optimizer-improvements-over-time"><span class="toc-section-number">10.5.1</span> Query Optimizer Improvements
Over Time</a></li>
<li><a href="#lock-contention-reduction" id="toc-lock-contention-reduction"><span class="toc-section-number">10.5.2</span> Lock Contention
Reduction</a></li>
<li><a href="#parallel-execution-introduction" id="toc-parallel-execution-introduction"><span class="toc-section-number">10.5.3</span> Parallel Execution
Introduction</a></li>
<li><a href="#io-and-storage-optimizations" id="toc-io-and-storage-optimizations"><span class="toc-section-number">10.5.4</span> I/O and Storage
Optimizations</a></li>
<li><a href="#hardware-adaptation" id="toc-hardware-adaptation"><span class="toc-section-number">10.5.5</span> Hardware Adaptation</a></li>
</ul></details></li>
<li><details><summary><a href="#part-4-community-growth" id="toc-part-4-community-growth"><span class="toc-section-number">10.6</span> Part 4: Community Growth</a></summary><ul>
<li><a href="#contributor-statistics-over-time" id="toc-contributor-statistics-over-time"><span class="toc-section-number">10.6.1</span> Contributor Statistics Over
Time</a></li>
<li><a href="#corporate-participation-evolution" id="toc-corporate-participation-evolution"><span class="toc-section-number">10.6.2</span> Corporate Participation
Evolution</a></li>
<li><a href="#geographic-distribution" id="toc-geographic-distribution"><span class="toc-section-number">10.6.3</span> Geographic
Distribution</a></li>
<li><a href="#development-process-refinements" id="toc-development-process-refinements"><span class="toc-section-number">10.6.4</span> Development Process
Refinements</a></li>
</ul></details></li>
<li><details><summary><a href="#part-5-lessons-learned" id="toc-part-5-lessons-learned"><span class="toc-section-number">10.7</span> Part 5: Lessons Learned</a></summary><ul>
<li><a href="#what-worked-well" id="toc-what-worked-well"><span class="toc-section-number">10.7.1</span> What Worked Well</a></li>
<li><a href="#what-was-refactored" id="toc-what-was-refactored"><span class="toc-section-number">10.7.2</span> What Was Refactored</a></li>
<li><a href="#design-decisions-that-stood-the-test-of-time" id="toc-design-decisions-that-stood-the-test-of-time"><span class="toc-section-number">10.7.3</span> Design Decisions That Stood the
Test of Time</a></li>
<li><a href="#technical-debt-management" id="toc-technical-debt-management"><span class="toc-section-number">10.7.4</span> Technical Debt
Management</a></li>
</ul></details></li>
<li><details><summary><a href="#conclusion-38-years-of-evolution" id="toc-conclusion-38-years-of-evolution"><span class="toc-section-number">10.8</span> Conclusion: 38 Years of
Evolution</a></summary><ul>
<li><a href="#the-big-picture" id="toc-the-big-picture"><span class="toc-section-number">10.8.1</span> The Big Picture</a></li>
<li><a href="#key-themes-of-evolution" id="toc-key-themes-of-evolution"><span class="toc-section-number">10.8.2</span> Key Themes of
Evolution</a></li>
<li><a href="#the-road-ahead" id="toc-the-road-ahead"><span class="toc-section-number">10.8.3</span> The Road Ahead</a></li>
<li><a href="#reflections" id="toc-reflections"><span class="toc-section-number">10.8.4</span> Reflections</a></li>
</ul></details></li>
<li><a href="#further-reading-1" id="toc-further-reading-1"><span class="toc-section-number">10.9</span> Further Reading</a></li>
</ul></details></li>
<li><details><summary><a href="#postgresql-build-system-and-portability-layer" id="toc-postgresql-build-system-and-portability-layer"><span class="toc-section-number">11</span> PostgreSQL Build System and
Portability Layer</a></summary><ul>
<li><a href="#table-of-contents-3" id="toc-table-of-contents-3"><span class="toc-section-number">11.1</span> Table of Contents</a></li>
<li><details><summary><a href="#autoconfconfigure-build-system" id="toc-autoconfconfigure-build-system"><span class="toc-section-number">11.2</span> 1. Autoconf/Configure Build
System</a></summary><ul>
<li><a href="#overview-16" id="toc-overview-16"><span class="toc-section-number">11.2.1</span> Overview</a></li>
<li><a href="#key-files" id="toc-key-files"><span class="toc-section-number">11.2.2</span> Key Files</a></li>
<li><a href="#platform-templates" id="toc-platform-templates"><span class="toc-section-number">11.2.3</span> Platform Templates</a></li>
<li><a href="#top-level-makefile" id="toc-top-level-makefile"><span class="toc-section-number">11.2.4</span> Top-Level Makefile</a></li>
<li><a href="#global-makefile-configuration" id="toc-global-makefile-configuration"><span class="toc-section-number">11.2.5</span> Global Makefile
Configuration</a></li>
<li><a href="#build-process-flow" id="toc-build-process-flow"><span class="toc-section-number">11.2.6</span> Build Process Flow</a></li>
</ul></details></li>
<li><details><summary><a href="#meson-build-system" id="toc-meson-build-system"><span class="toc-section-number">11.3</span> 2. Meson Build System</a></summary><ul>
<li><a href="#overview-17" id="toc-overview-17"><span class="toc-section-number">11.3.1</span> Overview</a></li>
<li><a href="#main-configuration-file" id="toc-main-configuration-file"><span class="toc-section-number">11.3.2</span> Main Configuration
File</a></li>
<li><a href="#build-options" id="toc-build-options"><span class="toc-section-number">11.3.3</span> Build Options</a></li>
<li><a href="#backend-build-configuration" id="toc-backend-build-configuration"><span class="toc-section-number">11.3.4</span> Backend Build
Configuration</a></li>
<li><a href="#meson-build-process-flow" id="toc-meson-build-process-flow"><span class="toc-section-number">11.3.5</span> Meson Build Process
Flow</a></li>
</ul></details></li>
<li><details><summary><a href="#portability-layer-srcport" id="toc-portability-layer-srcport"><span class="toc-section-number">11.4</span> 3. Portability Layer
(src/port/)</a></summary><ul>
<li><a href="#overview-18" id="toc-overview-18"><span class="toc-section-number">11.4.1</span> Overview</a></li>
<li><a href="#purpose-and-architecture" id="toc-purpose-and-architecture"><span class="toc-section-number">11.4.2</span> Purpose and
Architecture</a></li>
<li><a href="#key-portability-functions" id="toc-key-portability-functions"><span class="toc-section-number">11.4.3</span> Key Portability
Functions</a></li>
<li><a href="#meson-build-configuration" id="toc-meson-build-configuration"><span class="toc-section-number">11.4.4</span> Meson Build
Configuration</a></li>
</ul></details></li>
<li><details><summary><a href="#platform-specific-code" id="toc-platform-specific-code"><span class="toc-section-number">11.5</span> 4. Platform-Specific Code</a></summary><ul>
<li><a href="#platform-headers" id="toc-platform-headers"><span class="toc-section-number">11.5.1</span> Platform Headers</a></li>
<li><a href="#atomic-operations" id="toc-atomic-operations"><span class="toc-section-number">11.5.2</span> Atomic Operations</a></li>
<li><a href="#crc32c-with-hardware-acceleration" id="toc-crc32c-with-hardware-acceleration"><span class="toc-section-number">11.5.3</span> CRC32C with Hardware
Acceleration</a></li>
</ul></details></li>
<li><details><summary><a href="#testing-infrastructure" id="toc-testing-infrastructure"><span class="toc-section-number">11.6</span> 5. Testing Infrastructure</a></summary><ul>
<li><a href="#test-organization" id="toc-test-organization"><span class="toc-section-number">11.6.1</span> Test Organization</a></li>
<li><a href="#perl-test-framework" id="toc-perl-test-framework"><span class="toc-section-number">11.6.2</span> Perl Test Framework</a></li>
<li><a href="#isolation-tests" id="toc-isolation-tests"><span class="toc-section-number">11.6.3</span> Isolation Tests</a></li>
</ul></details></li>
<li><details><summary><a href="#code-generation-tools" id="toc-code-generation-tools"><span class="toc-section-number">11.7</span> 6. Code Generation Tools</a></summary><ul>
<li><a href="#overview-19" id="toc-overview-19"><span class="toc-section-number">11.7.1</span> Overview</a></li>
<li><a href="#main-code-generators" id="toc-main-code-generators"><span class="toc-section-number">11.7.2</span> Main Code Generators</a></li>
<li><a href="#catalog-data-format" id="toc-catalog-data-format"><span class="toc-section-number">11.7.3</span> Catalog Data Format</a></li>
<li><a href="#other-code-generators" id="toc-other-code-generators"><span class="toc-section-number">11.7.4</span> Other Code Generators</a></li>
</ul></details></li>
<li><details><summary><a href="#documentation-build-system" id="toc-documentation-build-system"><span class="toc-section-number">11.8</span> 7. Documentation Build System</a></summary><ul>
<li><a href="#overview-20" id="toc-overview-20"><span class="toc-section-number">11.8.1</span> Overview</a></li>
<li><a href="#build-configuration" id="toc-build-configuration"><span class="toc-section-number">11.8.2</span> Build Configuration</a></li>
<li><a href="#documentation-build-process" id="toc-documentation-build-process"><span class="toc-section-number">11.8.3</span> Documentation Build
Process</a></li>
</ul></details></li>
<li><details><summary><a href="#development-practices-and-coding-standards" id="toc-development-practices-and-coding-standards"><span class="toc-section-number">11.9</span> 8. Development Practices and
Coding Standards</a></summary><ul>
<li><a href="#code-formatting-with-pgindent" id="toc-code-formatting-with-pgindent"><span class="toc-section-number">11.9.1</span> Code Formatting with
pgindent</a></li>
<li><a href="#coding-style-guidelines" id="toc-coding-style-guidelines"><span class="toc-section-number">11.9.2</span> Coding Style
Guidelines</a></li>
<li><a href="#backend-makefile-structure" id="toc-backend-makefile-structure"><span class="toc-section-number">11.9.3</span> Backend Makefile
Structure</a></li>
<li><a href="#developer-workflows" id="toc-developer-workflows"><span class="toc-section-number">11.9.4</span> Developer Workflows</a></li>
</ul></details></li>
<li><details><summary><a href="#summary-2" id="toc-summary-2"><span class="toc-section-number">11.10</span> Summary</a></summary><ul>
<li><a href="#key-strengths" id="toc-key-strengths"><span class="toc-section-number">11.10.1</span> Key Strengths</a></li>
<li><a href="#best-practices-for-contributors" id="toc-best-practices-for-contributors"><span class="toc-section-number">11.10.2</span> Best Practices for
Contributors</a></li>
</ul></details></li>
</ul></details></li>
<li><details><summary><a href="#postgresql-community-and-development-culture" id="toc-postgresql-community-and-development-culture"><span class="toc-section-number">12</span> PostgreSQL Community and
Development Culture</a></summary><ul>
<li><a href="#introduction-5" id="toc-introduction-5"><span class="toc-section-number">12.1</span> Introduction</a></li>
<li><details><summary><a href="#part-i-the-development-process" id="toc-part-i-the-development-process"><span class="toc-section-number">12.2</span> Part I: The Development
Process</a></summary><ul>
<li><a href="#commitfest-postgresqls-development-cycle" id="toc-commitfest-postgresqls-development-cycle"><span class="toc-section-number">12.2.1</span> CommitFest: PostgreSQL‚Äôs
Development Cycle</a></li>
<li><a href="#mailing-list-culture" id="toc-mailing-list-culture"><span class="toc-section-number">12.2.2</span> Mailing List Culture</a></li>
<li><a href="#consensus-based-decision-making" id="toc-consensus-based-decision-making"><span class="toc-section-number">12.2.3</span> Consensus-Based Decision
Making</a></li>
</ul></details></li>
<li><details><summary><a href="#part-ii-key-contributors-and-personalities" id="toc-part-ii-key-contributors-and-personalities"><span class="toc-section-number">12.3</span> Part II: Key Contributors and
Personalities</a></summary><ul>
<li><a href="#tom-lane-the-unwavering-technical-core" id="toc-tom-lane-the-unwavering-technical-core"><span class="toc-section-number">12.3.1</span> Tom Lane: The Unwavering
Technical Core</a></li>
<li><a href="#bruce-momjian-community-shepherd-and-release-manager" id="toc-bruce-momjian-community-shepherd-and-release-manager"><span class="toc-section-number">12.3.2</span> Bruce Momjian: Community
Shepherd and Release Manager</a></li>
<li><a href="#other-core-contributors" id="toc-other-core-contributors"><span class="toc-section-number">12.3.3</span> Other Core
Contributors</a></li>
</ul></details></li>
<li><details><summary><a href="#part-iii-corporate-participation-and-sponsorship" id="toc-part-iii-corporate-participation-and-sponsorship"><span class="toc-section-number">12.4</span> Part III: Corporate Participation
and Sponsorship</a></summary><ul>
<li><a href="#enterprise-database-companies" id="toc-enterprise-database-companies"><span class="toc-section-number">12.4.1</span> Enterprise Database
Companies</a></li>
<li><a href="#funding-and-investment-models" id="toc-funding-and-investment-models"><span class="toc-section-number">12.4.2</span> Funding and Investment
Models</a></li>
<li><a href="#balancing-commercial-and-community-interests" id="toc-balancing-commercial-and-community-interests"><span class="toc-section-number">12.4.3</span> Balancing Commercial and
Community Interests</a></li>
</ul></details></li>
<li><details><summary><a href="#part-iv-cultural-values-and-principles" id="toc-part-iv-cultural-values-and-principles"><span class="toc-section-number">12.5</span> Part IV: Cultural Values and
Principles</a></summary><ul>
<li><a href="#technical-excellence-and-correctness" id="toc-technical-excellence-and-correctness"><span class="toc-section-number">12.5.1</span> Technical Excellence and
Correctness</a></li>
<li><a href="#transparency-and-open-discussion" id="toc-transparency-and-open-discussion"><span class="toc-section-number">12.5.2</span> Transparency and Open
Discussion</a></li>
<li><a href="#inclusivity-and-global-participation" id="toc-inclusivity-and-global-participation"><span class="toc-section-number">12.5.3</span> Inclusivity and Global
Participation</a></li>
<li><a href="#long-term-thinking-and-stability" id="toc-long-term-thinking-and-stability"><span class="toc-section-number">12.5.4</span> Long-Term Thinking and
Stability</a></li>
</ul></details></li>
<li><details><summary><a href="#part-v-decision-making-without-a-bdfl" id="toc-part-v-decision-making-without-a-bdfl"><span class="toc-section-number">12.6</span> Part V: Decision-Making Without a
BDFL</a></summary><ul>
<li><a href="#why-no-benevolent-dictator" id="toc-why-no-benevolent-dictator"><span class="toc-section-number">12.6.1</span> Why No Benevolent
Dictator?</a></li>
<li><a href="#the-rough-consensus-model" id="toc-the-rough-consensus-model"><span class="toc-section-number">12.6.2</span> The Rough Consensus
Model</a></li>
<li><a href="#resolving-intractable-disagreement" id="toc-resolving-intractable-disagreement"><span class="toc-section-number">12.6.3</span> Resolving Intractable
Disagreement</a></li>
</ul></details></li>
<li><details><summary><a href="#part-vi-code-of-conduct-and-communication-style" id="toc-part-vi-code-of-conduct-and-communication-style"><span class="toc-section-number">12.7</span> Part VI: Code of Conduct and
Communication Style</a></summary><ul>
<li><a href="#the-postgresql-code-of-conduct" id="toc-the-postgresql-code-of-conduct"><span class="toc-section-number">12.7.1</span> The PostgreSQL Code of
Conduct</a></li>
<li><a href="#expected-communication-style" id="toc-expected-communication-style"><span class="toc-section-number">12.7.2</span> Expected Communication
Style</a></li>
<li><a href="#handling-conflict" id="toc-handling-conflict"><span class="toc-section-number">12.7.3</span> Handling Conflict</a></li>
</ul></details></li>
<li><details><summary><a href="#part-vii-the-developer-experience" id="toc-part-vii-the-developer-experience"><span class="toc-section-number">12.8</span> Part VII: The Developer
Experience</a></summary><ul>
<li><a href="#becoming-a-postgresql-contributor" id="toc-becoming-a-postgresql-contributor"><span class="toc-section-number">12.8.1</span> Becoming a PostgreSQL
Contributor</a></li>
<li><a href="#resources-for-contributors" id="toc-resources-for-contributors"><span class="toc-section-number">12.8.2</span> Resources for
Contributors</a></li>
<li><a href="#mentorship-and-learning" id="toc-mentorship-and-learning"><span class="toc-section-number">12.8.3</span> Mentorship and
Learning</a></li>
</ul></details></li>
<li><details><summary><a href="#part-viii-challenges-and-evolution" id="toc-part-viii-challenges-and-evolution"><span class="toc-section-number">12.9</span> Part VIII: Challenges and
Evolution</a></summary><ul>
<li><a href="#growth-and-scaling-challenges" id="toc-growth-and-scaling-challenges"><span class="toc-section-number">12.9.1</span> Growth and Scaling
Challenges</a></li>
<li><a href="#responding-to-modern-development-practices" id="toc-responding-to-modern-development-practices"><span class="toc-section-number">12.9.2</span> Responding to Modern
Development Practices</a></li>
<li><a href="#increasing-pressure-for-rapid-development" id="toc-increasing-pressure-for-rapid-development"><span class="toc-section-number">12.9.3</span> Increasing Pressure for Rapid
Development</a></li>
</ul></details></li>
<li><details><summary><a href="#part-ix-the-future-of-postgresql-culture" id="toc-part-ix-the-future-of-postgresql-culture"><span class="toc-section-number">12.10</span> Part IX: The Future of
PostgreSQL Culture</a></summary><ul>
<li><a href="#adaptation-and-resilience" id="toc-adaptation-and-resilience"><span class="toc-section-number">12.10.1</span> Adaptation and
Resilience</a></li>
<li><a href="#inclusivity-and-accessibility" id="toc-inclusivity-and-accessibility"><span class="toc-section-number">12.10.2</span> Inclusivity and
Accessibility</a></li>
<li><a href="#geographic-and-demographic-diversity" id="toc-geographic-and-demographic-diversity"><span class="toc-section-number">12.10.3</span> Geographic and Demographic
Diversity</a></li>
<li><a href="#technical-evolution" id="toc-technical-evolution"><span class="toc-section-number">12.10.4</span> Technical Evolution</a></li>
</ul></details></li>
<li><details><summary><a href="#part-x-postgresql-culture-in-practice" id="toc-part-x-postgresql-culture-in-practice"><span class="toc-section-number">12.11</span> Part X: PostgreSQL Culture in
Practice</a></summary><ul>
<li><a href="#rituals-and-traditions" id="toc-rituals-and-traditions"><span class="toc-section-number">12.11.1</span> Rituals and
Traditions</a></li>
<li><a href="#cultural-values-in-action" id="toc-cultural-values-in-action"><span class="toc-section-number">12.11.2</span> Cultural Values in
Action</a></li>
<li><a href="#postgresqls-influence-on-database-community" id="toc-postgresqls-influence-on-database-community"><span class="toc-section-number">12.11.3</span> PostgreSQL‚Äôs Influence on
Database Community</a></li>
</ul></details></li>
<li><a href="#conclusion-6" id="toc-conclusion-6"><span class="toc-section-number">12.12</span> Conclusion</a></li>
<li><a href="#part-xi-lessons-from-postgresqls-culture" id="toc-part-xi-lessons-from-postgresqls-culture"><span class="toc-section-number">12.13</span> Part XI: Lessons from
PostgreSQL‚Äôs Culture</a></li>
<li><a href="#further-reading-and-resources" id="toc-further-reading-and-resources"><span class="toc-section-number">12.14</span> Further Reading and
Resources</a></li>
</ul></details></li>
<li><details><summary><a href="#postgresql-sql-reference-dialect-and-advanced-features" id="toc-postgresql-sql-reference-dialect-and-advanced-features"><span class="toc-section-number">13</span> PostgreSQL SQL Reference: Dialect
and Advanced Features</a></summary><ul>
<li><details><summary><a href="#postgresqls-rich-type-system" id="toc-postgresqls-rich-type-system"><span class="toc-section-number">13.1</span> 1. PostgreSQL‚Äôs Rich Type
System</a></summary><ul>
<li><a href="#built-in-data-types" id="toc-built-in-data-types"><span class="toc-section-number">13.1.1</span> 1.1 Built-in Data
Types</a></li>
<li><a href="#composite-types" id="toc-composite-types"><span class="toc-section-number">13.1.2</span> 1.2 Composite Types</a></li>
<li><a href="#custom-types-and-domains" id="toc-custom-types-and-domains"><span class="toc-section-number">13.1.3</span> 1.3 Custom Types and
Domains</a></li>
</ul></details></li>
<li><details><summary><a href="#advanced-sql-features" id="toc-advanced-sql-features"><span class="toc-section-number">13.2</span> 2. Advanced SQL Features</a></summary><ul>
<li><a href="#window-functions" id="toc-window-functions"><span class="toc-section-number">13.2.1</span> 2.1 Window Functions</a></li>
<li><a href="#common-table-expressions-ctes-and-recursive-queries" id="toc-common-table-expressions-ctes-and-recursive-queries"><span class="toc-section-number">13.2.2</span> 2.2 Common Table Expressions
(CTEs) and Recursive Queries</a></li>
<li><a href="#lateral-joins" id="toc-lateral-joins"><span class="toc-section-number">13.2.3</span> 2.3 LATERAL Joins</a></li>
<li><a href="#grouping-sets-cube-and-rollup" id="toc-grouping-sets-cube-and-rollup"><span class="toc-section-number">13.2.4</span> 2.4 GROUPING SETS, CUBE, and
ROLLUP</a></li>
<li><a href="#json-and-jsonb-operations" id="toc-json-and-jsonb-operations"><span class="toc-section-number">13.2.5</span> 2.5 JSON and JSONB
Operations</a></li>
</ul></details></li>
<li><details><summary><a href="#plpgsql-procedural-sql-language" id="toc-plpgsql-procedural-sql-language"><span class="toc-section-number">13.3</span> 3. PL/pgSQL: Procedural SQL
Language</a></summary><ul>
<li><a href="#basic-function-structure" id="toc-basic-function-structure"><span class="toc-section-number">13.3.1</span> 3.1 Basic Function
Structure</a></li>
<li><a href="#variables-and-control-flow" id="toc-variables-and-control-flow"><span class="toc-section-number">13.3.2</span> 3.2 Variables and Control
Flow</a></li>
<li><a href="#loops-and-iteration" id="toc-loops-and-iteration"><span class="toc-section-number">13.3.3</span> 3.3 Loops and
Iteration</a></li>
<li><a href="#error-handling-1" id="toc-error-handling-1"><span class="toc-section-number">13.3.4</span> 3.4 Error Handling</a></li>
</ul></details></li>
<li><details><summary><a href="#performance-features" id="toc-performance-features"><span class="toc-section-number">13.4</span> 4. Performance Features</a></summary><ul>
<li><a href="#prepared-statements" id="toc-prepared-statements"><span class="toc-section-number">13.4.1</span> 4.1 Prepared
Statements</a></li>
<li><a href="#query-hints-pattern-pg_hint_plan-extension" id="toc-query-hints-pattern-pg_hint_plan-extension"><span class="toc-section-number">13.4.2</span> 4.2 Query Hints Pattern
(pg_hint_plan Extension)</a></li>
</ul></details></li>
<li><details><summary><a href="#extensions-to-sql-standard" id="toc-extensions-to-sql-standard"><span class="toc-section-number">13.5</span> 5. Extensions to SQL Standard</a></summary><ul>
<li><a href="#distinct-on" id="toc-distinct-on"><span class="toc-section-number">13.5.1</span> 5.1 DISTINCT ON</a></li>
<li><a href="#returning-clause" id="toc-returning-clause"><span class="toc-section-number">13.5.2</span> 5.2 RETURNING Clause</a></li>
<li><a href="#insert-on-conflict-upsert" id="toc-insert-on-conflict-upsert"><span class="toc-section-number">13.5.3</span> 5.3 INSERT ‚Ä¶ ON CONFLICT
(UPSERT)</a></li>
</ul></details></li>
<li><details><summary><a href="#advanced-query-patterns" id="toc-advanced-query-patterns"><span class="toc-section-number">13.6</span> 6. Advanced Query Patterns</a></summary><ul>
<li><a href="#cte-with-window-functions" id="toc-cte-with-window-functions"><span class="toc-section-number">13.6.1</span> 6.1 CTE with Window
Functions</a></li>
<li><a href="#json-aggregation-with-complex-structures" id="toc-json-aggregation-with-complex-structures"><span class="toc-section-number">13.6.2</span> 6.2 JSON Aggregation with
Complex Structures</a></li>
<li><a href="#recursive-cte-for-path-finding" id="toc-recursive-cte-for-path-finding"><span class="toc-section-number">13.6.3</span> 6.3 Recursive CTE for Path
Finding</a></li>
</ul></details></li>
<li><details><summary><a href="#performance-considerations-3" id="toc-performance-considerations-3"><span class="toc-section-number">13.7</span> 7. Performance Considerations</a></summary><ul>
<li><a href="#index-selection-for-advanced-features" id="toc-index-selection-for-advanced-features"><span class="toc-section-number">13.7.1</span> 7.1 Index Selection for
Advanced Features</a></li>
<li><a href="#query-planning-for-window-functions" id="toc-query-planning-for-window-functions"><span class="toc-section-number">13.7.2</span> 7.2 Query Planning for Window
Functions</a></li>
</ul></details></li>
<li><a href="#summary-3" id="toc-summary-3"><span class="toc-section-number">13.8</span> Summary</a></li>
</ul></details></li>
<li><details><summary><a href="#postgresql-glossary" id="toc-postgresql-glossary"><span class="toc-section-number">14</span> PostgreSQL Glossary</a></summary><ul>
<li><a href="#comprehensive-terminology-reference" id="toc-comprehensive-terminology-reference"><span class="toc-section-number">14.1</span> Comprehensive Terminology
Reference</a></li>
<li><a href="#a" id="toc-a"><span class="toc-section-number">14.2</span>
A</a></li>
<li><a href="#b" id="toc-b"><span class="toc-section-number">14.3</span>
B</a></li>
<li><a href="#c" id="toc-c"><span class="toc-section-number">14.4</span>
C</a></li>
<li><a href="#d" id="toc-d"><span class="toc-section-number">14.5</span>
D</a></li>
<li><a href="#e" id="toc-e"><span class="toc-section-number">14.6</span>
E</a></li>
<li><a href="#f" id="toc-f"><span class="toc-section-number">14.7</span>
F</a></li>
<li><a href="#g" id="toc-g"><span class="toc-section-number">14.8</span>
G</a></li>
<li><a href="#h" id="toc-h"><span class="toc-section-number">14.9</span>
H</a></li>
<li><a href="#i" id="toc-i"><span class="toc-section-number">14.10</span> I</a></li>
<li><a href="#j" id="toc-j"><span class="toc-section-number">14.11</span> J</a></li>
<li><a href="#k" id="toc-k"><span class="toc-section-number">14.12</span> K</a></li>
<li><a href="#l" id="toc-l"><span class="toc-section-number">14.13</span> L</a></li>
<li><a href="#m" id="toc-m"><span class="toc-section-number">14.14</span> M</a></li>
<li><a href="#n" id="toc-n"><span class="toc-section-number">14.15</span> N</a></li>
<li><a href="#o" id="toc-o"><span class="toc-section-number">14.16</span> O</a></li>
<li><a href="#p" id="toc-p"><span class="toc-section-number">14.17</span> P</a></li>
<li><a href="#q" id="toc-q"><span class="toc-section-number">14.18</span> Q</a></li>
<li><a href="#r" id="toc-r"><span class="toc-section-number">14.19</span> R</a></li>
<li><a href="#s" id="toc-s"><span class="toc-section-number">14.20</span> S</a></li>
<li><a href="#t" id="toc-t"><span class="toc-section-number">14.21</span> T</a></li>
<li><a href="#u" id="toc-u"><span class="toc-section-number">14.22</span> U</a></li>
<li><a href="#v" id="toc-v"><span class="toc-section-number">14.23</span> V</a></li>
<li><a href="#w" id="toc-w"><span class="toc-section-number">14.24</span> W</a></li>
<li><a href="#x" id="toc-x"><span class="toc-section-number">14.25</span> X</a></li>
<li><a href="#z" id="toc-z"><span class="toc-section-number">14.26</span> Z</a></li>
<li><a href="#acronyms-quick-reference" id="toc-acronyms-quick-reference"><span class="toc-section-number">14.27</span> Acronyms Quick
Reference</a></li>
<li><a href="#see-also" id="toc-see-also"><span class="toc-section-number">14.28</span> See Also</a></li>
</ul></details></li>
<li><details><summary><a href="#postgresql-encyclopedia-comprehensive-alphabetical-index" id="toc-postgresql-encyclopedia-comprehensive-alphabetical-index"><span class="toc-section-number">15</span> PostgreSQL Encyclopedia:
Comprehensive Alphabetical Index</a></summary><ul>
<li><a href="#a-1" id="toc-a-1"><span class="toc-section-number">15.1</span> A</a></li>
<li><a href="#b-1" id="toc-b-1"><span class="toc-section-number">15.2</span> B</a></li>
<li><a href="#c-1" id="toc-c-1"><span class="toc-section-number">15.3</span> C</a></li>
<li><a href="#d-1" id="toc-d-1"><span class="toc-section-number">15.4</span> D</a></li>
<li><a href="#e-1" id="toc-e-1"><span class="toc-section-number">15.5</span> E</a></li>
<li><a href="#f-1" id="toc-f-1"><span class="toc-section-number">15.6</span> F</a></li>
<li><a href="#g-1" id="toc-g-1"><span class="toc-section-number">15.7</span> G</a></li>
<li><a href="#h-1" id="toc-h-1"><span class="toc-section-number">15.8</span> H</a></li>
<li><a href="#i-1" id="toc-i-1"><span class="toc-section-number">15.9</span> I</a></li>
<li><a href="#j-1" id="toc-j-1"><span class="toc-section-number">15.10</span> J</a></li>
<li><a href="#k-1" id="toc-k-1"><span class="toc-section-number">15.11</span> K</a></li>
<li><a href="#l-1" id="toc-l-1"><span class="toc-section-number">15.12</span> L</a></li>
<li><a href="#m-1" id="toc-m-1"><span class="toc-section-number">15.13</span> M</a></li>
<li><a href="#n-1" id="toc-n-1"><span class="toc-section-number">15.14</span> N</a></li>
<li><a href="#o-1" id="toc-o-1"><span class="toc-section-number">15.15</span> O</a></li>
<li><a href="#p-1" id="toc-p-1"><span class="toc-section-number">15.16</span> P</a></li>
<li><a href="#q-1" id="toc-q-1"><span class="toc-section-number">15.17</span> Q</a></li>
<li><a href="#r-1" id="toc-r-1"><span class="toc-section-number">15.18</span> R</a></li>
<li><a href="#s-1" id="toc-s-1"><span class="toc-section-number">15.19</span> S</a></li>
<li><a href="#t-1" id="toc-t-1"><span class="toc-section-number">15.20</span> T</a></li>
<li><a href="#u-1" id="toc-u-1"><span class="toc-section-number">15.21</span> U</a></li>
<li><a href="#v-1" id="toc-v-1"><span class="toc-section-number">15.22</span> V</a></li>
<li><a href="#w-1" id="toc-w-1"><span class="toc-section-number">15.23</span> W</a></li>
<li><a href="#x-1" id="toc-x-1"><span class="toc-section-number">15.24</span> X</a></li>
<li><a href="#y" id="toc-y"><span class="toc-section-number">15.25</span> Y</a></li>
<li><a href="#z-1" id="toc-z-1"><span class="toc-section-number">15.26</span> Z</a></li>
</ul></details></li>
<li><details><summary><a href="#technical-terms-and-concepts-cross-index" id="toc-technical-terms-and-concepts-cross-index"><span class="toc-section-number">16</span> Technical Terms and Concepts
Cross-Index</a></summary><ul>
<li><a href="#data-structures" id="toc-data-structures"><span class="toc-section-number">16.1</span> Data Structures</a></li>
<li><a href="#key-functions" id="toc-key-functions"><span class="toc-section-number">16.2</span> Key Functions</a></li>
<li><details><summary><a href="#configuration-parameters-guc" id="toc-configuration-parameters-guc"><span class="toc-section-number">16.3</span> Configuration Parameters
(GUC)</a></summary><ul>
<li><a href="#memory-parameters" id="toc-memory-parameters"><span class="toc-section-number">16.3.1</span> Memory Parameters</a></li>
<li><a href="#io-parameters" id="toc-io-parameters"><span class="toc-section-number">16.3.2</span> I/O Parameters</a></li>
<li><a href="#query-planning-parameters" id="toc-query-planning-parameters"><span class="toc-section-number">16.3.3</span> Query Planning
Parameters</a></li>
<li><a href="#replication-parameters" id="toc-replication-parameters"><span class="toc-section-number">16.3.4</span> Replication Parameters</a></li>
<li><a href="#maintenance-parameters" id="toc-maintenance-parameters"><span class="toc-section-number">16.3.5</span> Maintenance Parameters</a></li>
</ul></details></li>
<li><a href="#utilities-and-tools" id="toc-utilities-and-tools"><span class="toc-section-number">16.4</span> Utilities and Tools</a></li>
<li><a href="#key-contributors-1" id="toc-key-contributors-1"><span class="toc-section-number">16.5</span> Key Contributors</a></li>
<li><a href="#version-milestones" id="toc-version-milestones"><span class="toc-section-number">16.6</span> Version Milestones</a></li>
<li><details><summary><a href="#important-source-files" id="toc-important-source-files"><span class="toc-section-number">16.7</span> Important Source Files</a></summary><ul>
<li><a href="#core-engine" id="toc-core-engine"><span class="toc-section-number">16.7.1</span> Core Engine</a></li>
<li><a href="#storage" id="toc-storage"><span class="toc-section-number">16.7.2</span> Storage</a></li>
<li><a href="#transactions" id="toc-transactions"><span class="toc-section-number">16.7.3</span> Transactions</a></li>
<li><a href="#process-management" id="toc-process-management"><span class="toc-section-number">16.7.4</span> Process Management</a></li>
<li><a href="#index-access-methods-1" id="toc-index-access-methods-1"><span class="toc-section-number">16.7.5</span> Index Access Methods</a></li>
</ul></details></li>
</ul></details></li>
<li><a href="#index-usage-guide" id="toc-index-usage-guide"><span class="toc-section-number">17</span> Index Usage Guide</a></li>
<li><details><summary><a href="#bibliography-postgresql-encyclopedia" id="toc-bibliography-postgresql-encyclopedia"><span class="toc-section-number">18</span> Bibliography: PostgreSQL
Encyclopedia</a></summary><ul>
<li><details><summary><a href="#academic-papers-1" id="toc-academic-papers-1"><span class="toc-section-number">18.1</span> 1. Academic Papers</a></summary><ul>
<li><a href="#foundational-works" id="toc-foundational-works"><span class="toc-section-number">18.1.1</span> Foundational Works</a></li>
<li><a href="#concurrency-and-isolation" id="toc-concurrency-and-isolation"><span class="toc-section-number">18.1.2</span> Concurrency and
Isolation</a></li>
<li><a href="#mvcc-and-visibility" id="toc-mvcc-and-visibility"><span class="toc-section-number">18.1.3</span> MVCC and Visibility</a></li>
<li><a href="#query-optimization" id="toc-query-optimization"><span class="toc-section-number">18.1.4</span> Query Optimization</a></li>
<li><a href="#distributed-postgresql" id="toc-distributed-postgresql"><span class="toc-section-number">18.1.5</span> Distributed PostgreSQL</a></li>
<li><a href="#full-text-search-and-indexing" id="toc-full-text-search-and-indexing"><span class="toc-section-number">18.1.6</span> Full-Text Search and
Indexing</a></li>
<li><a href="#json-and-unstructured-data" id="toc-json-and-unstructured-data"><span class="toc-section-number">18.1.7</span> JSON and Unstructured
Data</a></li>
<li><a href="#advanced-data-types" id="toc-advanced-data-types"><span class="toc-section-number">18.1.8</span> Advanced Data Types</a></li>
</ul></details></li>
<li><details><summary><a href="#official-postgresql-documentation" id="toc-official-postgresql-documentation"><span class="toc-section-number">18.2</span> 2. Official PostgreSQL
Documentation</a></summary><ul>
<li><a href="#current-documentation-postgresql-17" id="toc-current-documentation-postgresql-17"><span class="toc-section-number">18.2.1</span> Current Documentation
(PostgreSQL 17)</a></li>
<li><a href="#historical-documentation-versions" id="toc-historical-documentation-versions"><span class="toc-section-number">18.2.2</span> Historical Documentation
Versions</a></li>
<li><a href="#technical-documentation" id="toc-technical-documentation"><span class="toc-section-number">18.2.3</span> Technical
Documentation</a></li>
</ul></details></li>
<li><details><summary><a href="#books-1" id="toc-books-1"><span class="toc-section-number">18.3</span> 3. Books</a></summary><ul>
<li><a href="#comprehensive-guides" id="toc-comprehensive-guides"><span class="toc-section-number">18.3.1</span> Comprehensive Guides</a></li>
<li><a href="#administration-and-operations" id="toc-administration-and-operations"><span class="toc-section-number">18.3.2</span> Administration and
Operations</a></li>
<li><a href="#specialized-topics" id="toc-specialized-topics"><span class="toc-section-number">18.3.3</span> Specialized Topics</a></li>
<li><a href="#plpgsql-and-programming" id="toc-plpgsql-and-programming"><span class="toc-section-number">18.3.4</span> PL/pgSQL and
Programming</a></li>
<li><a href="#historical-and-reference" id="toc-historical-and-reference"><span class="toc-section-number">18.3.5</span> Historical and
Reference</a></li>
</ul></details></li>
<li><details><summary><a href="#online-resources" id="toc-online-resources"><span class="toc-section-number">18.4</span> 4. Online Resources</a></summary><ul>
<li><a href="#official-postgresql-sites" id="toc-official-postgresql-sites"><span class="toc-section-number">18.4.1</span> Official PostgreSQL
Sites</a></li>
<li><a href="#documentation-and-guides" id="toc-documentation-and-guides"><span class="toc-section-number">18.4.2</span> Documentation and
Guides</a></li>
<li><a href="#community-resources" id="toc-community-resources"><span class="toc-section-number">18.4.3</span> Community Resources</a></li>
<li><a href="#blogs-and-publications" id="toc-blogs-and-publications"><span class="toc-section-number">18.4.4</span> Blogs and Publications</a></li>
<li><a href="#video-resources" id="toc-video-resources"><span class="toc-section-number">18.4.5</span> Video Resources</a></li>
</ul></details></li>
<li><details><summary><a href="#source-code" id="toc-source-code"><span class="toc-section-number">18.5</span> 5. Source Code</a></summary><ul>
<li><a href="#official-repository" id="toc-official-repository"><span class="toc-section-number">18.5.1</span> Official Repository</a></li>
<li><a href="#key-source-files-and-directories" id="toc-key-source-files-and-directories"><span class="toc-section-number">18.5.2</span> Key Source Files and
Directories</a></li>
<li><a href="#code-analysis-resources" id="toc-code-analysis-resources"><span class="toc-section-number">18.5.3</span> Code Analysis
Resources</a></li>
</ul></details></li>
<li><details><summary><a href="#community-resources-1" id="toc-community-resources-1"><span class="toc-section-number">18.6</span> 6. Community Resources</a></summary><ul>
<li><a href="#conferences-and-events" id="toc-conferences-and-events"><span class="toc-section-number">18.6.1</span> Conferences and Events</a></li>
<li><a href="#online-communities" id="toc-online-communities"><span class="toc-section-number">18.6.2</span> Online Communities</a></li>
<li><a href="#developer-resources" id="toc-developer-resources"><span class="toc-section-number">18.6.3</span> Developer Resources</a></li>
<li><a href="#companies-and-organizations" id="toc-companies-and-organizations"><span class="toc-section-number">18.6.4</span> Companies and
Organizations</a></li>
<li><a href="#educational-programs" id="toc-educational-programs"><span class="toc-section-number">18.6.5</span> Educational Programs</a></li>
</ul></details></li>
<li><details><summary><a href="#related-tools-and-extensions" id="toc-related-tools-and-extensions"><span class="toc-section-number">18.7</span> 7. Related Tools and
Extensions</a></summary><ul>
<li><a href="#popular-postgresql-extensions" id="toc-popular-postgresql-extensions"><span class="toc-section-number">18.7.1</span> Popular PostgreSQL
Extensions</a></li>
<li><a href="#related-tools" id="toc-related-tools"><span class="toc-section-number">18.7.2</span> Related Tools</a></li>
</ul></details></li>
<li><details><summary><a href="#standards-and-specifications" id="toc-standards-and-specifications"><span class="toc-section-number">18.8</span> 8. Standards and
Specifications</a></summary><ul>
<li><a href="#sql-standards" id="toc-sql-standards"><span class="toc-section-number">18.8.1</span> SQL Standards</a></li>
<li><a href="#database-architecture-standards" id="toc-database-architecture-standards"><span class="toc-section-number">18.8.2</span> Database Architecture
Standards</a></li>
</ul></details></li>
<li><details><summary><a href="#recommended-reading-order" id="toc-recommended-reading-order"><span class="toc-section-number">18.9</span> 9. Recommended Reading Order</a></summary><ul>
<li><a href="#for-new-users" id="toc-for-new-users"><span class="toc-section-number">18.9.1</span> For New Users</a></li>
<li><a href="#for-application-developers" id="toc-for-application-developers"><span class="toc-section-number">18.9.2</span> For Application
Developers</a></li>
<li><a href="#for-database-administrators" id="toc-for-database-administrators"><span class="toc-section-number">18.9.3</span> For Database
Administrators</a></li>
<li><a href="#for-performance-engineers" id="toc-for-performance-engineers"><span class="toc-section-number">18.9.4</span> For Performance
Engineers</a></li>
<li><a href="#for-postgresql-contributors-1" id="toc-for-postgresql-contributors-1"><span class="toc-section-number">18.9.5</span> For PostgreSQL
Contributors</a></li>
</ul></details></li>
<li><details><summary><a href="#citation-guide" id="toc-citation-guide"><span class="toc-section-number">18.10</span> 10. Citation Guide</a></summary><ul>
<li><a href="#how-to-cite-postgresql" id="toc-how-to-cite-postgresql"><span class="toc-section-number">18.10.1</span> How to Cite
PostgreSQL</a></li>
</ul></details></li>
<li><details><summary><a href="#additional-resources" id="toc-additional-resources"><span class="toc-section-number">18.11</span> 11. Additional Resources</a></summary><ul>
<li><a href="#newsletters-and-subscriptions" id="toc-newsletters-and-subscriptions"><span class="toc-section-number">18.11.1</span> Newsletters and
Subscriptions</a></li>
<li><a href="#research-and-papers" id="toc-research-and-papers"><span class="toc-section-number">18.11.2</span> Research and Papers</a></li>
<li><a href="#benchmarking-resources" id="toc-benchmarking-resources"><span class="toc-section-number">18.11.3</span> Benchmarking
Resources</a></li>
</ul></details></li>
<li><a href="#conclusion-7" id="toc-conclusion-7"><span class="toc-section-number">18.12</span> Conclusion</a></li>
</ul></details></li>
</ul></nav>

</div>
</nav>
<main class="book-content">
<header class="book-header">
<h1 class="book-title">PostgreSQL Internals: An Encyclopedia</h1>
<p class="book-subtitle">An In-Depth Exploration</p>
</header>
<div class="ai-notice">
<strong>üìù AI-Generated Documentation:</strong> This encyclopedia was entirely created by Claude (Anthropic AI) through comprehensive source code analysis,
      historical research, and community documentation review. Starting from the actual codebase, Claude examined thousands of source files,
      traced git history, and synthesized documentation that explains not just <em>what</em> the code does, but <em>why</em> it exists
      and <em>how</em> it evolved. The result is a deep, systematic exploration compiled with attention to technical accuracy,
      historical context, and educational value.
    </div>
<h1 data-number="1" id="the-postgresql-encyclopedia"><span class="header-section-number">1</span> The PostgreSQL Encyclopedia</h1>
<h2 data-number="1.1" id="the-definitive-guide-to-the-worlds-most-advanced-open-source-database"><span class="header-section-number">1.1</span> The Definitive Guide to the
World‚Äôs Most Advanced Open Source Database</h2>
<p><strong>A comprehensive, encyclopedic exploration of PostgreSQL from
first principles to advanced internals</strong></p>
<hr/>
<h2 data-number="1.2" id="about-this-work"><span class="header-section-number">1.2</span> About This Work</h2>
<p>This encyclopedia represents a deep, systematic exploration of every
aspect of PostgreSQL‚Äîfrom its origins as POSTGRES at UC Berkeley in 1986
to its current status as the world‚Äôs most advanced open source
relational database management system. This is not merely documentation;
it is a technical reference, historical analysis, and cultural study of
one of computing‚Äôs most successful open source projects.</p>
<h3 data-number="1.2.1" id="what-makes-this-different"><span class="header-section-number">1.2.1</span> What Makes This
Different</h3>
<p>Unlike traditional database documentation, this encyclopedia:</p>
<ul>
<li><strong>Includes actual source code</strong> with precise file paths
and line numbers from the PostgreSQL codebase</li>
<li><strong>Traces historical evolution</strong> showing how code and
concepts evolved over nearly 40 years</li>
<li><strong>Documents the culture</strong> examining decision-making
processes, community dynamics, and development philosophy</li>
<li><strong>Provides complete context</strong> explaining not just
‚Äúwhat‚Äù and ‚Äúhow‚Äù but ‚Äúwhy‚Äù architectural decisions were made</li>
<li><strong>Cross-references extensively</strong> connecting related
concepts across all subsystems</li>
</ul>
<h3 data-number="1.2.2" id="scope-and-depth"><span class="header-section-number">1.2.2</span> Scope and Depth</h3>
<ul>
<li><strong>2,292 source files</strong> analyzed across 116MB of
code</li>
<li><strong>324,358 lines</strong> of official documentation
studied</li>
<li><strong>Decades of history</strong> researched through git logs,
mailing lists, and published materials</li>
<li><strong>Eight parallel exploration agents</strong> deployed to
comprehensively document all subsystems</li>
<li><strong>Hundreds of code examples</strong> with line-level
precision</li>
</ul>
<hr/>
<h2 data-number="1.3" id="table-of-contents"><span class="header-section-number">1.3</span> Table of Contents</h2>
<h3 data-number="1.3.1" id="part-i-introduction-and-history"><span class="header-section-number">1.3.1</span> Part I: Introduction and
History</h3>
<p><strong><a href="00-introduction.md">00. Introduction: What is
PostgreSQL?</a></strong> - Definition and core characteristics - Key
features and capabilities - What makes PostgreSQL different - Historical
context from POSTGRES to PostgreSQL - The hardware evolution: from VAX
to Cloud - Community and culture</p>
<h3 data-number="1.3.2" id="part-ii-architecture"><span class="header-section-number">1.3.2</span> Part II: Architecture</h3>
<p><strong><a href="01-storage/README.md">01. Storage Layer
Architecture</a></strong> - Page layout and tuple format - Buffer
management system - Heap storage system - Write-Ahead Logging (WAL) -
Multi-Version Concurrency Control (MVCC) - Index types (B-tree, Hash,
GiST, GIN, SP-GiST, BRIN) - Free Space Map (FSM) - Visibility Map (VM) -
TOAST (The Oversized-Attribute Storage Technique)</p>
<p><strong><a href="02-query-processing/README.md">02. Query Processing
Pipeline</a></strong> - The Parser: SQL to parse trees - The Rewriter:
Rules, views, and row security - The Optimizer/Planner: Path generation
and cost estimation - The Executor: Plan execution - Catalog system and
syscache - Node types and data structures - Complete query lifecycle</p>
<p><strong><a href="03-transactions/README.md">03. Transaction
Management and Concurrency</a></strong> - Transaction management
overview - MVCC implementation - Snapshot isolation - Locking mechanisms
(spinlocks, LWLocks, heavyweight locks) - Deadlock detection -
Transaction ID wraparound and freezing - Commit and abort processing -
Two-phase commit (2PC) - Isolation levels and Serializable Snapshot
Isolation (SSI)</p>
<p><strong><a href="04-replication/README.md">04. Replication and
Recovery</a></strong> - WAL-based replication architecture - Streaming
replication - Logical replication and logical decoding - Recovery and
Point-In-Time Recovery (PITR) - Hot standby implementation - Replication
slots - Backup modes and pg_basebackup - Crash recovery and
checkpoints</p>
<p><strong><a href="05-processes/README.md">05. Process
Architecture</a></strong> - Postmaster: the main server process -
Backend process creation and lifecycle - Auxiliary processes (bgwriter,
checkpointer, walwriter, autovacuum, stats collector) - Client/server
protocol - Shared memory architecture - Inter-process communication
mechanisms - Authentication and connection handling - Startup and
shutdown sequences</p>
<h3 data-number="1.3.3" id="part-iii-extensibility"><span class="header-section-number">1.3.3</span> Part III: Extensibility</h3>
<p><strong><a href="06-extensions/README.md">06. Extension
System</a></strong> - Extension mechanism - User-defined functions and
types - Procedural languages (PL/pgSQL, PL/Python, PL/Perl, PL/Tcl) -
Foreign Data Wrappers (FDW) - Custom operators and access methods -
Hooks system - Contrib modules as examples - Extension build
infrastructure (PGXS)</p>
<h3 data-number="1.3.4" id="part-iv-tools-and-utilities"><span class="header-section-number">1.3.4</span> Part IV: Tools and
Utilities</h3>
<p><strong><a href="07-utilities/README.md">07. Utility
Programs</a></strong> - pg_dump and pg_restore: Logical backup/restore -
pg_basebackup: Physical backups - psql: Interactive terminal - initdb:
Cluster initialization - pg_ctl: Server control - Maintenance tools
(vacuumdb, reindexdb, clusterdb) - Administrative utilities (pg_upgrade,
pg_resetwal, pg_rewind) - Diagnostic tools (pg_waldump, pg_amcheck) -
Testing and benchmarking (pgbench)</p>
<h3 data-number="1.3.5" id="part-v-build-system-and-development"><span class="header-section-number">1.3.5</span> Part V: Build System and
Development</h3>
<p><strong><a href="08-build-system/README.md">08. Build System and
Portability</a></strong> - Autoconf/configure build system - Meson build
system - Portability layer (src/port/) - Platform-specific code -
Testing infrastructure - Code generation tools - Documentation build
system - Coding standards and development practices</p>
<h3 data-number="1.3.6" id="part-vi-evolution-and-culture"><span class="header-section-number">1.3.6</span> Part VI: Evolution and
Culture</h3>
<p><strong><a href="09-evolution/README.md">09. Historical
Evolution</a></strong> - Major version milestones - Coding patterns
evolution - Performance improvements over time - Feature additions and
deprecations - Community growth and changes - Corporate
participation</p>
<p><strong><a href="10-culture/README.md">10. Community and
Culture</a></strong> - Development process and commitfest - Mailing
lists and communication - Decision-making and consensus - Key
contributors - Cultural values - Open source governance</p>
<h3 data-number="1.3.7" id="part-vii-appendices"><span class="header-section-number">1.3.7</span> Part VII: Appendices</h3>
<p><strong><a href="appendices/glossary.md">Glossary of
Terms</a></strong> - Comprehensive A-Z terminology reference - Acronyms
and abbreviations - Cross-references to detailed chapters</p>
<p><strong><a href="appendices/index.md">Index</a></strong> -
Alphabetical index of all topics - Function and file reference - Data
structure reference</p>
<p><strong><a href="appendices/bibliography.md">Bibliography</a></strong> - Academic
papers - Technical documentation - Historical resources - Community
resources</p>
<hr/>
<h2 data-number="1.4" id="how-to-use-this-encyclopedia"><span class="header-section-number">1.4</span> How to Use This
Encyclopedia</h2>
<h3 data-number="1.4.1" id="for-database-researchers"><span class="header-section-number">1.4.1</span> For Database Researchers</h3>
<p>Start with the <strong>Storage Layer</strong> and <strong>Transaction
Management</strong> chapters to understand PostgreSQL‚Äôs MVCC
implementation and WAL system. The <strong>Query Processing</strong>
chapter details the optimizer‚Äôs cost-based approach.</p>
<h3 data-number="1.4.2" id="for-postgresql-contributors"><span class="header-section-number">1.4.2</span> For PostgreSQL
Contributors</h3>
<p>Begin with <strong>Build System</strong> to understand compilation,
then <strong>Process Architecture</strong> for the system structure. The
<strong>Extension System</strong> chapter explains hooks and APIs for
customization.</p>
<h3 data-number="1.4.3" id="for-system-architects"><span class="header-section-number">1.4.3</span> For System Architects</h3>
<p>Read <strong>Introduction</strong> for feature overview, then
<strong>Replication and Recovery</strong> for high-availability
architectures, and <strong>Utility Programs</strong> for operational
tools.</p>
<h3 data-number="1.4.4" id="for-computer-science-students"><span class="header-section-number">1.4.4</span> For Computer Science
Students</h3>
<p>Follow the order: <strong>Introduction</strong> ‚Üí <strong>Storage
Layer</strong> ‚Üí <strong>Query Processing</strong> ‚Üí <strong>Transaction
Management</strong>. This provides a complete DBMS implementation
study.</p>
<h3 data-number="1.4.5" id="for-dbas"><span class="header-section-number">1.4.5</span> For DBAs</h3>
<p>Focus on <strong>Process Architecture</strong>, <strong>Replication
and Recovery</strong>, <strong>Utility Programs</strong>, and the
<strong>Glossary</strong> for operational understanding.</p>
<hr/>
<h2 data-number="1.5" id="technical-specifications"><span class="header-section-number">1.5</span> Technical Specifications</h2>
<h3 data-number="1.5.1" id="codebase-analyzed"><span class="header-section-number">1.5.1</span> Codebase Analyzed</h3>
<p><strong>Version:</strong> PostgreSQL development version (2025)
<strong>Commit:</strong> 77fb395 ‚ÄúFix typo‚Äù (2025-11-18)
<strong>Branch:</strong>
<code>claude/codebase-documentation-guide-01BbUTsZUFzFPoAQXmh4j3eH</code></p>
<h3 data-number="1.5.2" id="source-statistics"><span class="header-section-number">1.5.2</span> Source Statistics</h3>
<pre><code>Directory: /home/user/postgres/
Size: 116 MB
Files: 2,292 C source files
Backend directories: 30+ subsystems
Utilities: 22 command-line tools
Contrib modules: 61 extensions
Documentation: 324,358 lines SGML</code></pre>
<h3 data-number="1.5.3" id="file-coverage"><span class="header-section-number">1.5.3</span> File Coverage</h3>
<p>Every code example in this encyclopedia includes: - Complete file
path (e.g.,
<code>/home/user/postgres/src/backend/storage/buffer/bufmgr.c</code>) -
Line number ranges (e.g., lines 265-293) - Actual source code from the
repository - Contextual explanation</p>
<hr/>
<h2 data-number="1.6" id="document-structure"><span class="header-section-number">1.6</span> Document Structure</h2>
<p>Each chapter follows a consistent format:</p>
<ol type="1">
<li><strong>Overview</strong>: High-level introduction</li>
<li><strong>Key Files</strong>: Location and purpose of source
files</li>
<li><strong>Data Structures</strong>: Actual C structures with line
numbers</li>
<li><strong>Algorithms</strong>: Implementation details with code</li>
<li><strong>Design Decisions</strong>: The ‚Äúwhy‚Äù behind choices</li>
<li><strong>Performance Considerations</strong>: Optimization
techniques</li>
<li><strong>Cross-References</strong>: Links to related topics</li>
<li><strong>Further Reading</strong>: Additional resources</li>
</ol>
<hr/>
<h2 data-number="1.7" id="compilation"><span class="header-section-number">1.7</span> Compilation</h2>
<p>This encyclopedia can be compiled into various formats:</p>
<h3 data-number="1.7.1" id="epub-e-book"><span class="header-section-number">1.7.1</span> EPUB (E-book)</h3>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb2-1"><a aria-hidden="true" href="#cb2-1" tabindex="-1"></a><span class="bu">cd</span> postgresql-encyclopedia</span>
<span id="cb2-2"><a aria-hidden="true" href="#cb2-2" tabindex="-1"></a><span class="ex">pandoc</span> <span class="at">-o</span> postgresql-encyclopedia.epub <span class="dt">\</span></span>
<span id="cb2-3"><a aria-hidden="true" href="#cb2-3" tabindex="-1"></a>  README.md <span class="dt">\</span></span>
<span id="cb2-4"><a aria-hidden="true" href="#cb2-4" tabindex="-1"></a>  00-introduction.md <span class="dt">\</span></span>
<span id="cb2-5"><a aria-hidden="true" href="#cb2-5" tabindex="-1"></a>  01-storage/<span class="pp">*</span>.md <span class="dt">\</span></span>
<span id="cb2-6"><a aria-hidden="true" href="#cb2-6" tabindex="-1"></a>  02-query-processing/<span class="pp">*</span>.md <span class="dt">\</span></span>
<span id="cb2-7"><a aria-hidden="true" href="#cb2-7" tabindex="-1"></a>  03-transactions/<span class="pp">*</span>.md <span class="dt">\</span></span>
<span id="cb2-8"><a aria-hidden="true" href="#cb2-8" tabindex="-1"></a>  04-replication/<span class="pp">*</span>.md <span class="dt">\</span></span>
<span id="cb2-9"><a aria-hidden="true" href="#cb2-9" tabindex="-1"></a>  05-processes/<span class="pp">*</span>.md <span class="dt">\</span></span>
<span id="cb2-10"><a aria-hidden="true" href="#cb2-10" tabindex="-1"></a>  06-extensions/<span class="pp">*</span>.md <span class="dt">\</span></span>
<span id="cb2-11"><a aria-hidden="true" href="#cb2-11" tabindex="-1"></a>  07-utilities/<span class="pp">*</span>.md <span class="dt">\</span></span>
<span id="cb2-12"><a aria-hidden="true" href="#cb2-12" tabindex="-1"></a>  08-build-system/<span class="pp">*</span>.md <span class="dt">\</span></span>
<span id="cb2-13"><a aria-hidden="true" href="#cb2-13" tabindex="-1"></a>  09-evolution/<span class="pp">*</span>.md <span class="dt">\</span></span>
<span id="cb2-14"><a aria-hidden="true" href="#cb2-14" tabindex="-1"></a>  10-culture/<span class="pp">*</span>.md <span class="dt">\</span></span>
<span id="cb2-15"><a aria-hidden="true" href="#cb2-15" tabindex="-1"></a>  appendices/<span class="pp">*</span>.md</span></code></pre></div>
<h3 data-number="1.7.2" id="pdf"><span class="header-section-number">1.7.2</span> PDF</h3>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb3-1"><a aria-hidden="true" href="#cb3-1" tabindex="-1"></a><span class="ex">pandoc</span> <span class="at">-o</span> postgresql-encyclopedia.pdf <span class="dt">\</span></span>
<span id="cb3-2"><a aria-hidden="true" href="#cb3-2" tabindex="-1"></a>  <span class="at">--toc</span> <span class="dt">\</span></span>
<span id="cb3-3"><a aria-hidden="true" href="#cb3-3" tabindex="-1"></a>  <span class="at">--toc-depth</span><span class="op">=</span>3 <span class="dt">\</span></span>
<span id="cb3-4"><a aria-hidden="true" href="#cb3-4" tabindex="-1"></a>  <span class="at">--number-sections</span> <span class="dt">\</span></span>
<span id="cb3-5"><a aria-hidden="true" href="#cb3-5" tabindex="-1"></a>  <span class="at">--pdf-engine</span><span class="op">=</span>xelatex <span class="dt">\</span></span>
<span id="cb3-6"><a aria-hidden="true" href="#cb3-6" tabindex="-1"></a>  <span class="at">-V</span> geometry:margin=1in <span class="dt">\</span></span>
<span id="cb3-7"><a aria-hidden="true" href="#cb3-7" tabindex="-1"></a>  <span class="at">-V</span> fontsize=10pt <span class="dt">\</span></span>
<span id="cb3-8"><a aria-hidden="true" href="#cb3-8" tabindex="-1"></a>  README.md <span class="dt">\</span></span>
<span id="cb3-9"><a aria-hidden="true" href="#cb3-9" tabindex="-1"></a>  [all chapter files]</span></code></pre></div>
<h3 data-number="1.7.3" id="html"><span class="header-section-number">1.7.3</span> HTML</h3>
<div class="sourceCode" id="cb4"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb4-1"><a aria-hidden="true" href="#cb4-1" tabindex="-1"></a><span class="ex">pandoc</span> <span class="at">-s</span> <span class="at">-o</span> index.html <span class="dt">\</span></span>
<span id="cb4-2"><a aria-hidden="true" href="#cb4-2" tabindex="-1"></a>  <span class="at">--toc</span> <span class="dt">\</span></span>
<span id="cb4-3"><a aria-hidden="true" href="#cb4-3" tabindex="-1"></a>  <span class="at">--toc-depth</span><span class="op">=</span>3 <span class="dt">\</span></span>
<span id="cb4-4"><a aria-hidden="true" href="#cb4-4" tabindex="-1"></a>  <span class="at">--css</span><span class="op">=</span>styles.css <span class="dt">\</span></span>
<span id="cb4-5"><a aria-hidden="true" href="#cb4-5" tabindex="-1"></a>  README.md <span class="dt">\</span></span>
<span id="cb4-6"><a aria-hidden="true" href="#cb4-6" tabindex="-1"></a>  [all chapter files]</span></code></pre></div>
<hr/>
<h2 data-number="1.8" id="chapter-summaries"><span class="header-section-number">1.8</span> Chapter Summaries</h2>
<h3 data-number="1.8.1" id="storage-layer-1434-lines"><span class="header-section-number">1.8.1</span> Storage Layer (1,434
lines)</h3>
<p>Comprehensive exploration of PostgreSQL‚Äôs storage architecture
including: - Slotted page layout with 8KB pages - Buffer management with
clock-sweep algorithm - Heap storage and HOT (Heap-Only Tuple)
optimization - WAL architecture with LSN tracking - Six index types with
implementation details - MVCC tuple visibility rules - FSM and
visibility map optimization</p>
<p><strong>Key Files Documented:</strong> -
<code>src/include/storage/bufpage.h</code>: Page layout (lines 158-171:
PageHeaderData) - <code>src/backend/storage/buffer/bufmgr.c</code>:
Buffer manager (7,468 lines) -
<code>src/backend/access/heap/heapam.c</code>: Heap operations (9,337
lines) - <code>src/backend/access/transam/xlog.c</code>: WAL (9,584
lines)</p>
<h3 data-number="1.8.2" id="query-processing-complete-pipeline"><span class="header-section-number">1.8.2</span> Query Processing (Complete
Pipeline)</h3>
<p>End-to-end documentation of query execution: - Parser: gram.y
(513,000 lines) converting SQL to parse trees - Rewriter: View expansion
and rule application - Planner: Cost-based optimization with 156,993
lines in allpaths.c - Executor: Plan execution with 99,539 lines in
execMain.c - Catalog system and syscache for metadata</p>
<p><strong>Key Algorithms:</strong> - Join strategies: Nested Loop, Hash
Join, Merge Join - Cost estimation with configurable parameters -
Dynamic programming for join order - Expression evaluation with JIT
compilation</p>
<h3 data-number="1.8.3" id="transactions-754-lines"><span class="header-section-number">1.8.3</span> Transactions (754 lines)</h3>
<p>Deep dive into PostgreSQL‚Äôs transaction system: - MVCC with snapshot
isolation - Transaction ID management and wraparound prevention -
Three-tier locking: spinlocks, LWLocks, heavyweight locks - Deadlock
detection with wait-for graphs - Serializable Snapshot Isolation (SSI)
for true serializability - Two-phase commit protocol</p>
<p><strong>Critical Data Structures:</strong> -
<code>SnapshotData</code>: MVCC snapshots with active XID lists -
<code>PGPROC</code>: Per-backend process state - <code>LOCK</code>,
<code>PROCLOCK</code>: Heavyweight locking -
<code>TransactionStateData</code>: Transaction state machine</p>
<h3 data-number="1.8.4" id="replication-comprehensive-coverage"><span class="header-section-number">1.8.4</span> Replication (Comprehensive
Coverage)</h3>
<p>Complete replication and recovery documentation: - WAL streaming with
synchronous/asynchronous modes - Logical replication with
publish/subscribe - Hot standby with query conflict resolution -
Replication slots preventing WAL deletion - Point-In-Time Recovery
(PITR) with timeline management - Crash recovery and checkpoint
mechanisms</p>
<p><strong>Key Components:</strong> - WalSender: Streaming WAL to
replicas - WalReceiver: Receiving WAL on standbys -
LogicalDecodingContext: Extracting logical changes - ReplicationSlot:
Maintaining replication state</p>
<h3 data-number="1.8.5" id="process-architecture"><span class="header-section-number">1.8.5</span> Process Architecture</h3>
<p>Detailed exploration of PostgreSQL‚Äôs process model: - Postmaster:
Never touches shared memory (resilience design) - Backend lifecycle:
Fork, authentication, query processing - Auxiliary processes: 18
different types - IPC mechanisms: Signals, shared memory, latches, pipes
- Authentication: Multiple methods (SCRAM-SHA-256, SSL, GSSAPI) -
Shutdown orchestration: Smart, Fast, Immediate modes</p>
<p><strong>Shared Memory:</strong> - Dynamically sized (40+ subsystem
requirements) - Hash table index (‚ÄúShmem Index‚Äù) - Typically hundreds of
MB</p>
<h3 data-number="1.8.6" id="extensions-encyclopedic"><span class="header-section-number">1.8.6</span> Extensions
(Encyclopedic)</h3>
<p>Complete guide to PostgreSQL extensibility: - Extension mechanism
with control files and SQL scripts - Function manager (fmgr) for custom
functions - Four procedural languages in detail - Foreign Data Wrapper
API with file_fdw example - Custom access methods: Bloom filter
implementation - 50+ hooks for intercepting core behavior - PGXS build
system</p>
<p><strong>Example Extensions:</strong> - hstore: Custom data type with
operators - file_fdw: Foreign data wrapper - auto_explain: Hook-based
query logging - bloom: Custom index access method</p>
<h3 data-number="1.8.7" id="utilities-comprehensive-tool-guide"><span class="header-section-number">1.8.7</span> Utilities (Comprehensive Tool
Guide)</h3>
<p>Documentation of all 22+ PostgreSQL utilities: - pg_dump: 20,570
lines, logical backup with parallelism - pg_basebackup: Physical backup
with WAL streaming - psql: 80+ meta-commands, tab completion - initdb:
Bootstrap process creating system catalogs - pg_upgrade: Major version
upgrade with link/copy/clone - pg_waldump: WAL analysis and debugging -
pgbench: TPC-B-like benchmarking</p>
<p><strong>Total Tool Code:</strong> 100+ files representing decades of
refinement</p>
<h3 data-number="1.8.8" id="build-system-1915-lines"><span class="header-section-number">1.8.8</span> Build System (1,915
lines)</h3>
<p>Complete build and portability documentation: - Autoconf system:
configure.ac with platform templates - Meson alternative: Modern build
system - Portability layer: Platform abstraction (src/port/) - Testing
infrastructure: Regression, TAP, isolation tests - Code generation:
Gen_fmgrtab.pl, genbki.pl, Unicode tools - DocBook SGML: Documentation
build process</p>
<p><strong>Platform Support:</strong> - Linux, Windows, macOS, BSD,
Solaris - Hardware-accelerated CRC32C (SSE4.2, ARM, AVX-512) - Atomic
operations abstraction</p>
<hr/>
<h2 data-number="1.9" id="methodology"><span class="header-section-number">1.9</span> Methodology</h2>
<p>This encyclopedia was created through:</p>
<h3 data-number="1.9.1" id="systematic-code-exploration-8-parallel-agents"><span class="header-section-number">1.9.1</span> 1. Systematic Code
Exploration (8 Parallel Agents)</h3>
<p>Eight specialized exploration agents comprehensively analyzed: -
Storage layer - Query processing - Transactions - Replication - Process
architecture - Extensions - Utilities - Build system</p>
<p>Each agent spent hours thoroughly exploring assigned subsystems.</p>
<h3 data-number="1.9.2" id="historical-research"><span class="header-section-number">1.9.2</span> 2. Historical Research</h3>
<ul>
<li>Git commit history analysis</li>
<li>Mailing list archive research (back to 1997)</li>
<li>Academic paper review (Berkeley POSTGRES papers)</li>
<li>Release notes and changelog examination</li>
<li>Web research on community culture</li>
</ul>
<h3 data-number="1.9.3" id="documentation-review"><span class="header-section-number">1.9.3</span> 3. Documentation Review</h3>
<ul>
<li>324,358 lines of official SGML documentation</li>
<li>README files throughout codebase</li>
<li>Developer documentation in src/backend/README files</li>
<li>Contrib module documentation</li>
</ul>
<h3 data-number="1.9.4" id="source-code-analysis"><span class="header-section-number">1.9.4</span> 4. Source Code Analysis</h3>
<ul>
<li>Direct reading of C source files</li>
<li>Header file structure analysis</li>
<li>Makefile dependency tracing</li>
<li>Data structure comprehension</li>
<li>Algorithm implementation study</li>
</ul>
<hr/>
<h2 data-number="1.10" id="contributors-and-acknowledgments"><span class="header-section-number">1.10</span> Contributors and
Acknowledgments</h2>
<h3 data-number="1.10.1" id="postgresql-community"><span class="header-section-number">1.10.1</span> PostgreSQL Community</h3>
<p>This encyclopedia stands on the shoulders of thousands of PostgreSQL
contributors over nearly 40 years. Special acknowledgment to:</p>
<ul>
<li><strong>Michael Stonebraker</strong>: Berkeley POSTGRES founder</li>
<li><strong>Andrew Yu and Jolly Chen</strong>: Added SQL support
creating Postgres95</li>
<li><strong>PostgreSQL Global Development Group</strong>: Steering the
project since 1996</li>
<li><strong>Core Team</strong>: Release management and difficult
decisions</li>
<li><strong>Committers</strong>: Code review and commits (~30
active)</li>
<li><strong>Major Contributors</strong>: Hundreds of regular
contributors</li>
<li><strong>All Contributors</strong>: Thousands over the decades</li>
</ul>
<h3 data-number="1.10.2" id="top-recent-contributors-sample-period"><span class="header-section-number">1.10.2</span> Top Recent Contributors
(Sample Period)</h3>
<p>Based on recent commit analysis: - Michael Paquier: 9 commits - Bruce
Momjian: 8 commits - Nathan Bossart: 7 commits - Tom Lane: 3 commits -
Daniel Gustafsson: 4 commits - And many more‚Ä¶</p>
<h3 data-number="1.10.3" id="academic-foundation"><span class="header-section-number">1.10.3</span> Academic Foundation</h3>
<ul>
<li><strong>UC Berkeley Computer Science Department</strong></li>
<li><strong>DARPA, ARO, NSF</strong>: Original funding</li>
<li><strong>Countless researchers</strong>: Building on and citing
PostgreSQL</li>
</ul>
<h3 data-number="1.10.4" id="this-encyclopedia"><span class="header-section-number">1.10.4</span> This Encyclopedia</h3>
<p>Created by: Claude (Anthropic AI) with guidance from the PostgreSQL
source code, community documentation, and historical records.</p>
<p>Date: November 2025</p>
<hr/>
<h2 data-number="1.11" id="license-and-copyright"><span class="header-section-number">1.11</span> License and Copyright</h2>
<h3 data-number="1.11.1" id="postgresql-license"><span class="header-section-number">1.11.1</span> PostgreSQL License</h3>
<p>PostgreSQL itself is licensed under the PostgreSQL License
(BSD-style):</p>
<pre><code>PostgreSQL Database Management System
(also known as Postgres, formerly known as Postgres95)

Portions Copyright (c) 1996-2025, PostgreSQL Global Development Group
Portions Copyright (c) 1994, The Regents of the University of California

Permission to use, copy, modify, and distribute this software and its
documentation for any purpose, without fee, and without a written agreement
is hereby granted, provided that the above copyright notice and this
paragraph and the following two paragraphs appear in all copies.</code></pre>
<h3 data-number="1.11.2" id="this-encyclopedia-1"><span class="header-section-number">1.11.2</span> This Encyclopedia</h3>
<p>This documentation work is provided for educational purposes. Code
examples and structure definitions are from PostgreSQL source code and
subject to PostgreSQL License. Original analysis and explanatory text
contributed to the public knowledge of PostgreSQL internals.</p>
<hr/>
<h2 data-number="1.12" id="further-resources"><span class="header-section-number">1.12</span> Further Resources</h2>
<h3 data-number="1.12.1" id="official-postgresql-resources"><span class="header-section-number">1.12.1</span> Official PostgreSQL
Resources</h3>
<ul>
<li><strong>Website</strong>: <a href="https://www.postgresql.org">postgresql.org</a></li>
<li><strong>Documentation</strong>: <a href="https://www.postgresql.org/docs/current/">postgresql.org/docs</a></li>
<li><strong>Wiki</strong>: <a href="https://wiki.postgresql.org">wiki.postgresql.org</a></li>
<li><strong>Mailing Lists</strong>: <a href="https://www.postgresql.org/list/">postgresql.org/list</a></li>
<li><strong>Source Code</strong>: <a href="https://git.postgresql.org/gitweb/?p=postgresql.git">git.postgresql.org</a></li>
</ul>
<h3 data-number="1.12.2" id="academic-papers"><span class="header-section-number">1.12.2</span> Academic Papers</h3>
<ul>
<li><strong>The Design of POSTGRES</strong> (Stonebraker &amp; Rowe,
1986)</li>
<li><strong>The POSTGRES Next-Generation Database Management
System</strong> (1991)</li>
<li><strong>Serializable Snapshot Isolation in PostgreSQL</strong> (VLDB
2012)</li>
<li>Countless papers citing or analyzing PostgreSQL</li>
</ul>
<h3 data-number="1.12.3" id="books"><span class="header-section-number">1.12.3</span> Books</h3>
<ul>
<li><strong>PostgreSQL: Up and Running</strong> (O‚ÄôReilly)</li>
<li><strong>PostgreSQL Server Programming</strong> (Packt)</li>
<li><strong>The Art of PostgreSQL</strong> (Dimitri Fontaine)</li>
<li><strong>PostgreSQL Administration Cookbook</strong> (Packt)</li>
</ul>
<h3 data-number="1.12.4" id="community"><span class="header-section-number">1.12.4</span> Community</h3>
<ul>
<li><strong>Planet PostgreSQL</strong>: Blog aggregator</li>
<li><strong>PostgreSQL Slack</strong>: Active community chat</li>
<li><strong>PGCon</strong>: Annual conference</li>
<li><strong>FOSDEM PGDay</strong>: European PostgreSQL day</li>
<li><strong>Hundreds of meetups worldwide</strong></li>
</ul>
<hr/>
<h2 data-number="1.13" id="feedback-and-contributions"><span class="header-section-number">1.13</span> Feedback and
Contributions</h2>
<p>This encyclopedia is a living document. While comprehensive,
PostgreSQL continues to evolve.</p>
<p>For the PostgreSQL project itself: - Bug reports:
pgsql-bugs@lists.postgresql.org - Development discussion:
pgsql-hackers@lists.postgresql.org - Contributions: <a href="https://www.postgresql.org/developer/">postgresql.org/developer</a></p>
<hr/>
<h2 data-number="1.14" id="version-history"><span class="header-section-number">1.14</span> Version History</h2>
<p><strong>Version 1.0 (November 2025)</strong> - Initial comprehensive
release - 8 major subsystem explorations completed - Complete utilities
documentation - Build system and portability guide - Historical and
cultural analysis - Comprehensive glossary</p>
<hr/>
<p><strong>‚ÄúExplaining the universe is considerably easier than
understanding PostgreSQL‚Äôs query optimizer.‚Äù</strong> ‚Äî Anonymous
DBA</p>
<p><strong>‚ÄúIn theory, there is no difference between theory and
practice. In PostgreSQL, there usually is, and it‚Äôs documented
somewhere.‚Äù</strong> ‚Äî With apologies to Yogi Berra</p>
<hr/>
<p><em>The PostgreSQL Encyclopedia - Making the complex understandable,
one source file at a time.</em></p>
<h1 data-number="2" id="the-postgresql-encyclopedia-1"><span class="header-section-number">2</span> The PostgreSQL Encyclopedia</h1>
<h2 data-number="2.1" id="a-comprehensive-guide-to-the-worlds-most-advanced-open-source-database"><span class="header-section-number">2.1</span> A Comprehensive Guide to the
World‚Äôs Most Advanced Open Source Database</h2>
<hr/>
<h2 data-number="2.2" id="preface"><span class="header-section-number">2.2</span> Preface</h2>
<p>This encyclopedic work represents a deep dive into every aspect of
the PostgreSQL database management system‚Äîfrom its origins at the
University of California, Berkeley in 1986 to its current status as the
world‚Äôs most advanced open source relational database. This is not
merely documentation; it is a historical artifact, a technical
reference, and a cultural study of one of the most successful open
source projects in computing history.</p>
<h3 data-number="2.2.1" id="purpose-and-scope"><span class="header-section-number">2.2.1</span> Purpose and Scope</h3>
<p>PostgreSQL is more than software‚Äîit is a living testament to the
power of academic research, community-driven development, and principled
engineering. This encyclopedia aims to document:</p>
<ol type="1">
<li><strong>Technical Architecture</strong>: Every subsystem, from the
parser to the storage engine</li>
<li><strong>Historical Evolution</strong>: How the codebase evolved from
POSTGRES to PostgreSQL</li>
<li><strong>Cultural Dynamics</strong>: The community, decision-making
processes, and development culture</li>
<li><strong>Implementation Details</strong>: Actual source code with
file paths and line numbers</li>
<li><strong>Design Philosophy</strong>: The ‚Äúwhy‚Äù behind architectural
decisions</li>
</ol>
<h3 data-number="2.2.2" id="who-this-is-for"><span class="header-section-number">2.2.2</span> Who This Is For</h3>
<p>This work is designed for:</p>
<ul>
<li><strong>Database Internals Researchers</strong>: Those studying DBMS
implementation</li>
<li><strong>PostgreSQL Contributors</strong>: Developers joining or
already contributing to the project</li>
<li><strong>System Architects</strong>: Those evaluating PostgreSQL for
large-scale deployments</li>
<li><strong>Computer Science Students</strong>: Learning database
systems implementation</li>
<li><strong>Database Administrators</strong>: Understanding the engine
beneath the hood</li>
<li><strong>Software Historians</strong>: Studying successful open
source projects</li>
</ul>
<h3 data-number="2.2.3" id="methodology-1"><span class="header-section-number">2.2.3</span> Methodology</h3>
<p>This encyclopedia was created through:</p>
<ol type="1">
<li><strong>Source Code Analysis</strong>: Deep exploration of 2,292 C
source files totaling 116MB</li>
<li><strong>Historical Research</strong>: Analysis of commit history,
mailing list archives, and community documents</li>
<li><strong>Web Research</strong>: Study of PostgreSQL‚Äôs development
culture and decision-making processes</li>
<li><strong>Documentation Review</strong>: Examination of 324,358 lines
of SGML documentation</li>
<li><strong>Community Insights</strong>: Research into the people and
processes that shaped PostgreSQL</li>
</ol>
<hr/>
<h2 data-number="2.3" id="chapter-1-what-is-postgresql"><span class="header-section-number">2.3</span> Chapter 1: What is
PostgreSQL?</h2>
<h3 data-number="2.3.1" id="definition-and-core-characteristics"><span class="header-section-number">2.3.1</span> 1.1 Definition and Core
Characteristics</h3>
<p><strong>PostgreSQL</strong> (pronounced ‚Äúpost-gress-cue-ell‚Äù) is an
object-relational database management system (ORDBMS) that
emphasizes:</p>
<ul>
<li><strong>Extensibility</strong>: Users can define custom data types,
operators, functions, and even index access methods</li>
<li><strong>Standards Compliance</strong>: Implements much of SQL:2016,
including advanced features</li>
<li><strong>ACID Compliance</strong>: Full support for Atomicity,
Consistency, Isolation, and Durability</li>
<li><strong>MVCC</strong>: Multi-Version Concurrency Control for high
concurrency without read locks</li>
<li><strong>Reliability</strong>: Decades of development focused on data
integrity</li>
<li><strong>Open Source</strong>: Liberal PostgreSQL License
(BSD-style)</li>
</ul>
<h3 data-number="2.3.2" id="official-names-throughout-history"><span class="header-section-number">2.3.2</span> 1.2 Official Names Throughout
History</h3>
<p>The system has been known by several names:</p>
<ol type="1">
<li><strong>POSTGRES</strong> (1986-1994): ‚ÄúPOSTgres‚Äù - Post-Ingres, the
successor to Ingres</li>
<li><strong>Postgres95</strong> (1994-1996): When SQL support was
added</li>
<li><strong>PostgreSQL</strong> (1996-present): Official name reflecting
SQL capabilities</li>
<li><strong>Informal</strong>: Often called just ‚ÄúPostgres‚Äù by the
community</li>
</ol>
<p>From the COPYRIGHT file:</p>
<pre><code>PostgreSQL Database Management System
(also known as Postgres, formerly known as Postgres95)

Portions Copyright (c) 1996-2025, PostgreSQL Global Development Group
Portions Copyright (c) 1994, The Regents of the University of California</code></pre>
<h3 data-number="2.3.3" id="key-statistics-current-codebase"><span class="header-section-number">2.3.3</span> 1.3 Key Statistics (Current
Codebase)</h3>
<p><strong>Codebase Size:</strong> - Source directory: 116 MB - C source
files: 2,292 files - Lines of code: Millions across all components -
Documentation: 324,358 lines of SGML</p>
<p><strong>Major Components:</strong> - Backend subsystems: 30+
directories in <code>src/backend/</code> - Utilities: 22+ command-line
tools in <code>src/bin/</code> - Contrib modules: 61 extension modules -
Interfaces: libpq, ECPG, and more</p>
<p><strong>Contributors (Recent History):</strong> - Top recent
contributors: Michael Paquier, Bruce Momjian, Nathan Bossart, Tom Lane -
Thousands of contributors over nearly 40 years - Active development in
multiple continents and time zones</p>
<h3 data-number="2.3.4" id="what-makes-postgresql-different"><span class="header-section-number">2.3.4</span> 1.4 What Makes PostgreSQL
Different</h3>
<h4 data-number="2.3.4.1" id="compared-to-other-open-source-databases"><span class="header-section-number">2.3.4.1</span> Compared to Other Open
Source Databases</h4>
<p><strong>vs.¬†MySQL:</strong> - <strong>Extensibility</strong>:
PostgreSQL allows custom types, operators, and index methods -
<strong>Standards</strong>: More complete SQL standard implementation -
<strong>MVCC</strong>: True MVCC without locking readers - <strong>Data
Integrity</strong>: Stronger emphasis on ACID compliance -
<strong>Architecture</strong>: Cleaner separation of concerns</p>
<p><strong>vs.¬†SQLite:</strong> - <strong>Scale</strong>: PostgreSQL
designed for concurrent multi-user access -
<strong>Client/Server</strong>: Network-capable with robust
authentication - <strong>Features</strong>: Advanced features like
replication, partitioning, parallel query -
<strong>Extensibility</strong>: Plugin architecture</p>
<h4 data-number="2.3.4.2" id="compared-to-commercial-databases"><span class="header-section-number">2.3.4.2</span> Compared to Commercial
Databases</h4>
<p><strong>vs.¬†Oracle:</strong> - <strong>Cost</strong>: Free and open
source - <strong>License</strong>: Liberal license allows any use -
<strong>Community</strong>: Open development process -
<strong>Innovation</strong>: Faster adoption of new features (e.g.,
JSON, JSONB)</p>
<p><strong>vs.¬†Microsoft SQL Server:</strong> -
<strong>Portability</strong>: Runs on Linux, macOS, Windows, BSD -
<strong>Licensing</strong>: No per-core or per-user costs -
<strong>Extensibility</strong>: More open to customization</p>
<h3 data-number="2.3.5" id="core-features"><span class="header-section-number">2.3.5</span> 1.5 Core Features</h3>
<h4 data-number="2.3.5.1" id="data-types"><span class="header-section-number">2.3.5.1</span> Data Types</h4>
<p>PostgreSQL supports an extensive range of data types:</p>
<p><strong>Numeric:</strong> - Integer types: smallint, integer, bigint
- Arbitrary precision: numeric/decimal - Floating point: real, double
precision - Serial types: auto-incrementing integers</p>
<p><strong>Character:</strong> - varchar(n), char(n), text - Full
Unicode support</p>
<p><strong>Binary:</strong> - bytea (binary data) - Large objects</p>
<p><strong>Date/Time:</strong> - date, time, timestamp, interval -
Timezone awareness - Infinite and -infinite values</p>
<p><strong>Boolean:</strong> - true, false, null</p>
<p><strong>Geometric:</strong> - point, line, lseg, box, path, polygon,
circle</p>
<p><strong>Network:</strong> - inet, cidr (IP addresses) - macaddr (MAC
addresses)</p>
<p><strong>Bit Strings:</strong> - bit(n), bit varying(n)</p>
<p><strong>Text Search:</strong> - tsvector, tsquery for full-text
search</p>
<p><strong>JSON:</strong> - json (text storage) - jsonb (binary storage
with indexing)</p>
<p><strong>Arrays:</strong> - Any data type can be an array</p>
<p><strong>Range Types:</strong> - int4range, int8range, numrange,
tsrange, daterange - Custom range types supported</p>
<p><strong>UUID:</strong> - Universally Unique Identifiers</p>
<p><strong>XML:</strong> - Native XML storage and processing</p>
<p><strong>Custom Types:</strong> - Users can define their own types</p>
<h4 data-number="2.3.5.2" id="query-capabilities"><span class="header-section-number">2.3.5.2</span> Query Capabilities</h4>
<p><strong>Basic SQL:</strong> - SELECT, INSERT, UPDATE, DELETE, MERGE -
Joins: INNER, LEFT, RIGHT, FULL, CROSS - Subqueries and CTEs (WITH
clauses) - UNION, INTERSECT, EXCEPT</p>
<p><strong>Advanced SQL:</strong> - Window functions (OVER clause) -
Recursive queries (WITH RECURSIVE) - Lateral joins - Grouping sets,
CUBE, ROLLUP - VALUES clauses</p>
<p><strong>Full-Text Search:</strong> - Built-in text search with
ranking - Multiple languages supported - Custom dictionaries</p>
<p><strong>JSON Querying:</strong> - Path expressions - Containment
operators - Indexable with GIN indexes</p>
<h4 data-number="2.3.5.3" id="indexes"><span class="header-section-number">2.3.5.3</span> Indexes</h4>
<p><strong>Index Types:</strong> 1. <strong>B-tree</strong>: Default,
general-purpose 2. <strong>Hash</strong>: Equality operations 3.
<strong>GiST</strong>: Generalized Search Tree (geometric, full-text) 4.
<strong>GIN</strong>: Generalized Inverted Index (arrays, JSONB,
full-text) 5. <strong>SP-GiST</strong>: Space-Partitioned GiST
(non-balanced trees) 6. <strong>BRIN</strong>: Block Range Index (large
correlated tables) 7. <strong>Bloom</strong>: Bloom filter (PostgreSQL
10+)</p>
<p><strong>Index Features:</strong> - Partial indexes (with WHERE
clause) - Expression indexes - Multi-column indexes - Covering indexes
(INCLUDE clause) - Concurrent index creation</p>
<h4 data-number="2.3.5.4" id="transactions-and-concurrency"><span class="header-section-number">2.3.5.4</span> Transactions and
Concurrency</h4>
<p><strong>ACID Properties:</strong> - <strong>Atomicity</strong>:
All-or-nothing execution - <strong>Consistency</strong>: Database
remains in valid state - <strong>Isolation</strong>: Concurrent
transactions don‚Äôt interfere - <strong>Durability</strong>: Committed
data persists</p>
<p><strong>Isolation Levels:</strong> - READ UNCOMMITTED (treated as
READ COMMITTED) - READ COMMITTED (default) - REPEATABLE READ -
SERIALIZABLE (true serializability via SSI)</p>
<p><strong>MVCC Benefits:</strong> - Readers never block writers -
Writers never block readers - High concurrency with consistency</p>
<p><strong>Locking:</strong> - Row-level locking - Table-level locking
with multiple modes - Advisory locks for application coordination</p>
<h4 data-number="2.3.5.5" id="replication"><span class="header-section-number">2.3.5.5</span> Replication</h4>
<p><strong>Physical Replication:</strong> - Streaming replication
(WAL-based) - Cascading replication - Synchronous and asynchronous modes
- Hot standby (read queries on replicas)</p>
<p><strong>Logical Replication:</strong> - Row-level replication -
Selective table replication - Cross-version replication - Bi-directional
replication (with BDR extension)</p>
<p><strong>Point-in-Time Recovery (PITR):</strong> - WAL archiving -
Recovery to specific time/transaction - Backup and restore
capabilities</p>
<h4 data-number="2.3.5.6" id="extensibility"><span class="header-section-number">2.3.5.6</span> Extensibility</h4>
<p><strong>Custom Data Types:</strong> - Define new types with operators
- Input/output functions - Type modifiers</p>
<p><strong>Custom Functions:</strong> - SQL, PL/pgSQL, C, Python, Perl,
Tcl, etc. - Set-returning functions - Window functions - Aggregate
functions</p>
<p><strong>Procedural Languages:</strong> - PL/pgSQL (default) -
PL/Python - PL/Perl - PL/Tcl - PL/Java (external) - PL/R (external)</p>
<p><strong>Foreign Data Wrappers:</strong> - Query external data sources
- file_fdw, postgres_fdw built-in - Many third-party FDWs (MySQL,
Oracle, MongoDB, etc.)</p>
<p><strong>Custom Access Methods:</strong> - Define new index types -
Bloom filter example in contrib</p>
<p><strong>Hooks:</strong> - Planner, executor, and utility hooks -
Extensive customization points</p>
<hr/>
<h2 data-number="2.4" id="chapter-2-historical-context"><span class="header-section-number">2.4</span> Chapter 2: Historical
Context</h2>
<h3 data-number="2.4.1" id="the-berkeley-postgres-era-1986-1994"><span class="header-section-number">2.4.1</span> 2.1 The Berkeley POSTGRES Era
(1986-1994)</h3>
<h4 data-number="2.4.1.1" id="origins-post-ingres"><span class="header-section-number">2.4.1.1</span> Origins: Post-Ingres</h4>
<p><strong>POSTGRES</strong> was conceived as the successor to INGRES
(Interactive Graphics and Retrieval System), which Michael Stonebraker
developed at UC Berkeley in the 1970s. After commercializing Ingres and
returning to Berkeley in 1985, Stonebraker wanted to address limitations
he saw in relational databases of the time.</p>
<p><strong>Key Innovations Planned:</strong> 1. <strong>Complex
Objects</strong>: Beyond simple relational tuples 2. <strong>User
Extensibility</strong>: Custom types and operators 3. <strong>Active
Databases</strong>: Rules and triggers 4. <strong>Time Travel</strong>:
Temporal queries (later removed) 5. <strong>Crash Recovery</strong>:
Modern transaction processing</p>
<h4 data-number="2.4.1.2" id="the-darpa-years"><span class="header-section-number">2.4.1.2</span> The DARPA Years</h4>
<p><strong>Funding:</strong> The project was sponsored by: - Defense
Advanced Research Projects Agency (DARPA) - Army Research Office (ARO) -
National Science Foundation (NSF) - ESL, Inc.</p>
<p><strong>Timeline:</strong> - <strong>1986</strong>: Implementation
begins - <strong>1987</strong>: First ‚Äúdemoware‚Äù system operational -
<strong>1988</strong>: Demonstration at ACM-SIGMOD Conference -
<strong>1989</strong>: Version 1 released to external users (June) -
<strong>1990</strong>: Version 2 with redesigned rule system (June) -
<strong>1991</strong>: Version 3 with multiple storage managers -
<strong>1992-1994</strong>: Version 4.x series, final Berkeley
versions</p>
<p><strong>Original Query Language:</strong> Early POSTGRES used
PostQUEL, not SQL. PostQUEL was a query language based on QUEL (used in
Ingres) with extensions for the new features.</p>
<p><strong>Example PostQUEL:</strong></p>
<div class="sourceCode" id="cb7"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb7-1"><a aria-hidden="true" href="#cb7-1" tabindex="-1"></a>retrieve (emp.name, emp.salary)</span>
<span id="cb7-2"><a aria-hidden="true" href="#cb7-2" tabindex="-1"></a><span class="kw">where</span> emp.dept <span class="op">=</span> <span class="ot">"sales"</span></span></code></pre></div>
<h3 data-number="2.4.2" id="the-transition-postgres95-1994-1996"><span class="header-section-number">2.4.2</span> 2.2 The Transition:
Postgres95 (1994-1996)</h3>
<h4 data-number="2.4.2.1" id="adding-sql"><span class="header-section-number">2.4.2.1</span> Adding SQL</h4>
<p>In 1994, <strong>Andrew Yu and Jolly Chen</strong> (UC Berkeley
graduate students) added an SQL language interpreter to POSTGRES. This
was a crucial step toward broader adoption.</p>
<p><strong>Key Changes:</strong> - Replaced PostQUEL with SQL -
Maintained underlying POSTGRES architecture - Made the system more
accessible to SQL users - Performance improvements</p>
<p><strong>First Release:</strong> - <strong>Version 0.01</strong>:
Announced to beta testers, May 5, 1995 - <strong>Version 1.0</strong>:
Public release, September 5, 1995</p>
<p><strong>Name:</strong> The project was called ‚ÄúPostgres95‚Äù to
indicate: - Based on POSTGRES - Released in 1995 - SQL support added</p>
<h3 data-number="2.4.3" id="postgresql-the-open-source-era-1996-present"><span class="header-section-number">2.4.3</span> 2.3 PostgreSQL: The Open
Source Era (1996-Present)</h3>
<h4 data-number="2.4.3.1" id="the-rename"><span class="header-section-number">2.4.3.1</span> The Rename</h4>
<p>By 1996, it became clear that ‚ÄúPostgres95‚Äù wouldn‚Äôt stand the test of
time. The community chose <strong>PostgreSQL</strong> to reflect: -
Heritage from POSTGRES - SQL language support - Professional, lasting
name</p>
<p><strong>First PostgreSQL Version:</strong> 6.0 (January 29, 1997)</p>
<p>The version number started at 6.0 to continue the sequence from the
Berkeley POSTGRES project (versions 1-4.2) and Postgres95 (version
~5).</p>
<h4 data-number="2.4.3.2" id="the-development-model-changes"><span class="header-section-number">2.4.3.2</span> The Development Model
Changes</h4>
<p><strong>Pre-Internet Era (1986-1995):</strong> - University-led
research project - Limited external collaboration - Academic
publication-driven - Periodic snapshot releases</p>
<p><strong>Internet Era (1996-present):</strong> - Distributed worldwide
development - Mailing list-based collaboration - Community-driven
decision making - Regular release cycle</p>
<h4 data-number="2.4.3.3" id="the-postgresql-global-development-group"><span class="header-section-number">2.4.3.3</span> The PostgreSQL Global
Development Group</h4>
<p><strong>Formation:</strong> The PostgreSQL Global Development Group
(PGDG) formed organically as an informal organization of volunteers.</p>
<p><strong>Structure:</strong> - <strong>Core Team</strong>: 7 long-time
members handling releases, infrastructure, difficult decisions -
<strong>Committers</strong>: ~20-30 people with direct commit access -
<strong>Major Contributors</strong>: Hundreds of regular contributors -
<strong>Patch Authors</strong>: Thousands over the years</p>
<p><strong>Decision Making:</strong> - Consensus-driven - Public
discussion on mailing lists - Technical merit over politics - ‚ÄúRough
consensus and running code‚Äù</p>
<p><strong>No Benevolent Dictator:</strong> Unlike many open source
projects, PostgreSQL has no single leader. Decisions emerge from
community discussion.</p>
<h3 data-number="2.4.4" id="major-version-milestones"><span class="header-section-number">2.4.4</span> 2.4 Major Version
Milestones</h3>
<h4 data-number="2.4.4.1" id="version-6.x-series-1997-1998"><span class="header-section-number">2.4.4.1</span> Version 6.x Series
(1997-1998)</h4>
<p><strong>6.0 (January 1997):</strong> - First official PostgreSQL
release - Multi-version concurrency control (MVCC) foundation</p>
<p><strong>6.1-6.5:</strong> - Performance improvements - Bug fixes -
Growing community</p>
<h4 data-number="2.4.4.2" id="version-7.x-series-1999-2004"><span class="header-section-number">2.4.4.2</span> Version 7.x Series
(1999-2004)</h4>
<p><strong>7.0 (May 2000):</strong> - Foreign key support - SQL92 join
syntax - Optimizer improvements - Write-ahead logging (WAL)
foundation</p>
<p><strong>7.1 (April 2001):</strong> - Outer joins - Improved toast
(large object storage)</p>
<p><strong>7.2 (February 2002):</strong> - Schema support -
Internationalization improvements</p>
<p><strong>7.3 (November 2002):</strong> - Prepared queries in protocol
- Internationalization improvements</p>
<p><strong>7.4 (November 2003):</strong> - Improved optimizer -
Multi-column indexes</p>
<h4 data-number="2.4.4.3" id="version-8.x-series-2005-2010"><span class="header-section-number">2.4.4.3</span> Version 8.x Series
(2005-2010)</h4>
<p><strong>8.0 (January 2005):</strong> - <strong>Native Windows
support</strong> (major milestone) - Point-in-time recovery (PITR) -
Tablespaces - Savepoints</p>
<p><strong>8.1 (November 2005):</strong> - Two-phase commit - Table
partitioning improvements - Bitmap index scans</p>
<p><strong>8.2 (December 2006):</strong> - Warm standby - Online index
builds - GIN indexes</p>
<p><strong>8.3 (February 2008):</strong> - Full-text search integrated -
XML support - Heap-only tuples (HOT) - Enum types</p>
<p><strong>8.4 (July 2009):</strong> - Windowing functions - Common
table expressions (CTEs) - Parallel restore - Column permissions</p>
<h4 data-number="2.4.4.4" id="version-9.x-series-2010-2016"><span class="header-section-number">2.4.4.4</span> Version 9.x Series
(2010-2016)</h4>
<p><strong>9.0 (September 2010):</strong> - <strong>Hot standby</strong>
(read queries on replicas) - <strong>Streaming replication</strong> -
In-place upgrades (pg_upgrade) - VACUUM FULL rewrite - Anonymous code
blocks</p>
<p><strong>9.1 (September 2011):</strong> - Synchronous replication -
Per-column collations - Unlogged tables - Foreign data wrappers -
Extensions</p>
<p><strong>9.2 (September 2012):</strong> - Cascading replication - JSON
datatype - Index-only scans - pg_stat_statements</p>
<p><strong>9.3 (September 2013):</strong> - Writeable foreign data
wrappers - Custom background workers - Materialized views - JSON
functions</p>
<p><strong>9.4 (December 2014):</strong> - <strong>JSONB</strong>
(binary JSON with indexing) - Logical replication foundation -
Replication slots - REFRESH MATERIALIZED VIEW CONCURRENTLY</p>
<p><strong>9.5 (January 2016):</strong> - UPSERT (INSERT ‚Ä¶ ON CONFLICT)
- Row-level security - BRIN indexes - TABLESAMPLE - GROUPING SETS</p>
<p><strong>9.6 (September 2016):</strong> - Parallel sequential scans -
Parallel joins - Parallel aggregates - Synchronous replication
improvements - Multiple standbys</p>
<h4 data-number="2.4.4.5" id="version-10-and-beyond-2017-present"><span class="header-section-number">2.4.4.5</span> Version 10 and Beyond
(2017-Present)</h4>
<p><strong>10 (October 2017):</strong> - <strong>Declarative
partitioning</strong> - Logical replication (publish/subscribe) -
Improved parallelism - Quorum-based synchronous replication -
SCRAM-SHA-256 authentication - ICU collation support</p>
<p><strong>11 (October 2018):</strong> - Stored procedures (CALL
command) - Improved partitioning - Parallelism improvements - JIT
compilation (LLVM-based) - Covering indexes</p>
<p><strong>12 (October 2019):</strong> - Generated columns - JSON path
queries - Pluggable table storage - Partitioning improvements - CTE
inlining</p>
<p><strong>13 (September 2020):</strong> - Parallel vacuum - Incremental
sorting - Partitioning improvements - B-tree deduplication - Extended
statistics</p>
<p><strong>14 (September 2021):</strong> - Pipeline mode in libpq -
Stored procedures with OUT parameters - Multirange types - Subscripting
custom types - JSON subscripting</p>
<p><strong>15 (October 2022):</strong> - MERGE command - Regular
expression improvements - Improved compression - Public schema
permissions change - Archive library modules</p>
<p><strong>16 (September 2023):</strong> - Parallelism improvements -
Logical replication improvements - SQL/JSON improvements - pg_stat_io
view - Incremental backups</p>
<p><strong>17 (September 2024):</strong> - Incremental backup
improvements - Vacuum improvements - JSON improvements - MERGE
RETURNING</p>
<p><strong>Version Numbering Change:</strong> Starting with version 10,
PostgreSQL adopted a simpler numbering scheme: - <strong>Old:</strong>
9.6, 9.7, etc. - <strong>New:</strong> 10, 11, 12, etc. - Minor
versions: 10.1, 10.2, etc.</p>
<h3 data-number="2.4.5" id="the-hardware-context"><span class="header-section-number">2.4.5</span> 2.5 The Hardware Context</h3>
<p>Understanding PostgreSQL‚Äôs evolution requires understanding the
hardware constraints of each era.</p>
<h4 data-number="2.4.5.1" id="the-vax-era"><span class="header-section-number">2.4.5.1</span> 1986: The VAX Era</h4>
<p><strong>Typical System:</strong> - DEC VAX minicomputer - 1-16 MB RAM
- 100-500 MB disk storage - No SMP (symmetric multiprocessing) - Tape
backups</p>
<p><strong>Impact on Design:</strong> - Memory management critical -
Buffer management essential - Single-process architecture adequate</p>
<h4 data-number="2.4.5.2" id="s-unix-workstations"><span class="header-section-number">2.4.5.2</span> 1990s: Unix
Workstations</h4>
<p><strong>Typical System:</strong> - Sun SPARCstation or SGI Indigo -
16-128 MB RAM - 1-10 GB disk - Early SMP (2-4 CPUs) - CD-ROM</p>
<p><strong>Impact on Design:</strong> - Multi-process model emerges -
Shared memory for buffer cache - Process-per-connection model</p>
<h4 data-number="2.4.5.3" id="s-commodity-servers"><span class="header-section-number">2.4.5.3</span> 2000s: Commodity
Servers</h4>
<p><strong>Typical System:</strong> - Intel Xeon servers - 1-16 GB RAM -
100 GB - 1 TB disk - 2-8 cores - RAID controllers</p>
<p><strong>Impact on Design:</strong> - WAL optimization for reliability
- Query optimization improvements - Lock partitioning for
concurrency</p>
<h4 data-number="2.4.5.4" id="s-modern-servers"><span class="header-section-number">2.4.5.4</span> 2010s: Modern Servers</h4>
<p><strong>Typical System:</strong> - Multi-socket Xeon servers - 64 GB
- 1 TB RAM - SSDs becoming common - 16-64 cores - 10 Gbps networking</p>
<p><strong>Impact on Design:</strong> - Parallel query execution - NUMA
awareness - Lock-free algorithms - JIT compilation</p>
<h4 data-number="2.4.5.5" id="s-cloud-era"><span class="header-section-number">2.4.5.5</span> 2020s: Cloud Era</h4>
<p><strong>Typical System:</strong> - Cloud VMs (AWS, Azure, GCP) - 1 GB
to several TB RAM - NVMe SSDs - Elastic scaling - Object storage
integration</p>
<p><strong>Impact on Design:</strong> - Pluggable storage - Cloud-native
features - Incremental backups - Better resource isolation</p>
<hr/>
<h2 data-number="2.5" id="chapter-3-the-community-and-culture"><span class="header-section-number">2.5</span> Chapter 3: The Community and
Culture</h2>
<h3 data-number="2.5.1" id="development-process"><span class="header-section-number">2.5.1</span> 3.1 Development Process</h3>
<h4 data-number="2.5.1.1" id="the-commitfest-system"><span class="header-section-number">2.5.1.1</span> The Commitfest System</h4>
<p><strong>What is a CommitFest?</strong> A commitfest is a month-long
period focused on reviewing patches rather than developing new features.
Typically held 4-5 times per development cycle.</p>
<p><strong>Purpose:</strong> - Ensure all submitted work gets reviewed -
Prevent patch backlog - Fair treatment of all contributors - Quality
control through peer review</p>
<p><strong>Rules:</strong> - Patch authors expected to review others‚Äô
patches - Reviews should be thorough and constructive - Patches can be:
committed, rejected, returned with feedback, or moved to next CF</p>
<p><strong>Commitfest Manager:</strong> - Volunteer role - Coordinates
reviews - Tracks patch status - Reports progress</p>
<p><strong>App:</strong> <a href="https://commitfest.postgresql.org">commitfest.postgresql.org</a></p>
<h4 data-number="2.5.1.2" id="mailing-lists"><span class="header-section-number">2.5.1.2</span> Mailing Lists</h4>
<p><strong>Primary Lists:</strong> - <strong>pgsql-hackers</strong>:
Development discussion (highest traffic) - <strong>pgsql-bugs</strong>:
Bug reports - <strong>pgsql-general</strong>: User questions -
<strong>pgsql-admin</strong>: Administration topics -
<strong>pgsql-performance</strong>: Performance tuning -
<strong>pgsql-docs</strong>: Documentation</p>
<p><strong>Culture:</strong> - Technical discussions can be blunt -
Expect rigorous criticism of ideas - Personal attacks not tolerated -
Archive is permanent (accurate history)</p>
<p><strong>Archives:</strong> Available back to 1997</p>
<h4 data-number="2.5.1.3" id="decision-making"><span class="header-section-number">2.5.1.3</span> Decision Making</h4>
<p><strong>Consensus Model:</strong> 1. Proposal posted to pgsql-hackers
2. Community discussion 3. Objections raised and addressed 4. Rough
consensus emerges 5. Committer makes final call</p>
<p><strong>Core Team Role:</strong> - Rarely intervenes in technical
decisions - Handles release management - Resolves conflicts when
consensus fails - Manages infrastructure</p>
<p><strong>No BDFL:</strong> Unlike many projects, no single person has
final say. Tom Lane is often seen as ‚Äúfirst among equals‚Äù due to his
technical expertise and long history, but he doesn‚Äôt have dictatorial
power.</p>
<h3 data-number="2.5.2" id="key-contributors"><span class="header-section-number">2.5.2</span> 3.2 Key Contributors</h3>
<h4 data-number="2.5.2.1" id="the-big-names"><span class="header-section-number">2.5.2.1</span> The ‚ÄúBig Names‚Äù</h4>
<p><strong>Tom Lane:</strong> - Most prolific contributor (82,565 emails
to mailing lists) - 15 emails per day average for over 20 years - Top
committer - Query optimizer expert - Known for thorough code reviews</p>
<p><strong>Bruce Momjian:</strong> - One of original core team members -
Advocacy and community building - Documentation - Release management -
Public face of PostgreSQL for many years</p>
<p><strong>Magnus Hagander:</strong> - Windows port maintainer -
Infrastructure management - Replication features - Community
infrastructure</p>
<p><strong>Andres Freund:</strong> - Performance optimization - JIT
compilation - Query execution - Low-level optimization</p>
<p><strong>Peter Eisentraut:</strong> - Internationalization - Build
system - SQL standards - Long-time contributor</p>
<p><strong>Robert Haas:</strong> - Parallel query execution -
Partitioning - Logical replication - Performance features</p>
<h4 data-number="2.5.2.2" id="corporate-participation"><span class="header-section-number">2.5.2.2</span> Corporate
Participation</h4>
<p><strong>Companies Supporting Development:</strong> - EnterpriseDB
(EDB) - Crunchy Data - 2ndQuadrant (now part of EDB) - Red Hat - Fujitsu
- VMware - Microsoft - Amazon Web Services - Google Cloud</p>
<p><strong>Corporate Policy:</strong> - Core team members can‚Äôt all work
for same company - Prevents single-company control - Maintains
independence</p>
<h3 data-number="2.5.3" id="cultural-values"><span class="header-section-number">2.5.3</span> 3.3 Cultural Values</h3>
<h4 data-number="2.5.3.1" id="technical-excellence"><span class="header-section-number">2.5.3.1</span> Technical Excellence</h4>
<p><strong>Code Quality:</strong> - Rigorous review process - High
standards for commits - Extensive testing required - Performance
considerations</p>
<p><strong>Correctness First:</strong> - Data integrity paramount -
Conservative about changes - Backwards compatibility valued -
Deprecation cycles for changes</p>
<h4 data-number="2.5.3.2" id="transparency"><span class="header-section-number">2.5.3.2</span> Transparency</h4>
<p><strong>Public Development:</strong> - All discussion on public
mailing lists - No private decision making - Commit messages detailed -
Design documents published</p>
<p><strong>Open Archives:</strong> - Mailing list archives permanent -
Commit history preserved - Mistakes documented - Learning from
history</p>
<h4 data-number="2.5.3.3" id="inclusivity-with-roughness"><span class="header-section-number">2.5.3.3</span> Inclusivity (with
Roughness)</h4>
<p><strong>Meritocracy:</strong> - Ideas judged on technical merit -
Contributions welcome from anyone - No gatekeeping based on affiliation
- Newcomers treated same as veterans</p>
<p><strong>Direct Communication:</strong> - Blunt technical criticism
normal - Not personal attacks - Focus on ideas, not people - Can feel
harsh to newcomers</p>
<p><strong>From the wiki:</strong> &gt; ‚ÄúOur discussions can come across
as insulting or overly critical. As a new contributor, you are
encountering a new culture.‚Äù</p>
<h4 data-number="2.5.3.4" id="long-term-thinking"><span class="header-section-number">2.5.3.4</span> Long-Term Thinking</h4>
<p><strong>Sustainability:</strong> - Features designed to last decades
- API stability important - On-disk format changes rare - Upgrade path
always provided</p>
<p><strong>Technical Debt:</strong> - Actively managed - Refactoring
happens - Legacy code improved over time - But stability valued</p>
<hr/>
<h2 data-number="2.6" id="about-this-encyclopedia"><span class="header-section-number">2.6</span> About This Encyclopedia</h2>
<p>This work represents hundreds of hours of code exploration,
historical research, and careful documentation. Each chapter
contains:</p>
<ul>
<li><strong>Actual source code</strong> with file paths and line
numbers</li>
<li><strong>Data structures</strong> from the real codebase</li>
<li><strong>Algorithms</strong> as implemented</li>
<li><strong>Historical context</strong> for design decisions</li>
<li><strong>Cross-references</strong> between related topics</li>
</ul>
<p>The goal is to create the definitive reference for anyone seeking to
understand PostgreSQL deeply‚Äîfrom its humble beginnings at Berkeley to
its current status as the world‚Äôs most advanced open source
database.</p>
<hr/>
<p><strong>Navigation:</strong></p>
<ul>
<li><strong>Next Chapter</strong>: <a href="01-storage-layer.md">Storage
Layer Architecture</a></li>
<li><strong>Jump to</strong>: <a href="README.md">Table of
Contents</a></li>
<li><strong>Index</strong>: <a href="appendices/index.md">Comprehensive
Index</a></li>
<li><strong>Glossary</strong>: <a href="appendices/glossary.md">PostgreSQL Terminology</a></li>
</ul>
<h1 data-number="3" id="chapter-1-storage-layer-architecture"><span class="header-section-number">3</span> Chapter 1: Storage Layer
Architecture</h1>
<h2 data-number="3.1" id="table-of-contents-1"><span class="header-section-number">3.1</span> Table of Contents</h2>
<ul>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#page-structure">Page Structure</a></li>
<li><a href="#buffer-manager">Buffer Manager</a></li>
<li><a href="#heap-access-method">Heap Access Method</a></li>
<li><a href="#write-ahead-logging">Write-Ahead Logging</a></li>
<li><a href="#multi-version-concurrency-control">Multi-Version
Concurrency Control</a></li>
<li><a href="#index-access-methods">Index Access Methods</a></li>
<li><a href="#free-space-map">Free Space Map</a></li>
<li><a href="#visibility-map">Visibility Map</a></li>
<li><a href="#toast">TOAST</a></li>
<li><a href="#conclusion">Conclusion</a></li>
</ul>
<h2 data-number="3.2" id="introduction"><span class="header-section-number">3.2</span> Introduction</h2>
<p>The storage layer is the foundation of PostgreSQL‚Äôs architecture,
responsible for organizing data on disk, managing memory buffers,
ensuring crash recovery, and providing efficient data access. Unlike
many database systems that rely on proprietary storage engines,
PostgreSQL implements a sophisticated storage layer that seamlessly
integrates with its query processing, transaction management, and
concurrency control subsystems.</p>
<p>This chapter explores the complete storage layer architecture, from
the low-level page format to high-level abstractions like access
methods. Understanding these components is essential for database
administrators seeking to optimize performance, developers building
extensions, and anyone interested in the inner workings of a modern
relational database system.</p>
<h3 data-number="3.2.1" id="key-components-overview"><span class="header-section-number">3.2.1</span> Key Components Overview</h3>
<p>The PostgreSQL storage layer consists of several interconnected
components:</p>
<ul>
<li><strong>Page Structure</strong>: The fundamental 8KB unit of storage
organization</li>
<li><strong>Buffer Manager</strong>: Memory caching layer between disk
and query execution</li>
<li><strong>Heap Access Method</strong>: The default table storage
mechanism</li>
<li><strong>Write-Ahead Logging (WAL)</strong>: Crash recovery and
replication foundation</li>
<li><strong>MVCC</strong>: Multi-version concurrency control for
transaction isolation</li>
<li><strong>Index Access Methods</strong>: Six specialized index types
for different query patterns</li>
<li><strong>Free Space Map</strong>: Efficient space management for
INSERT operations</li>
<li><strong>Visibility Map</strong>: Optimization for VACUUM and
index-only scans</li>
<li><strong>TOAST</strong>: Storage system for large attribute
values</li>
</ul>
<h3 data-number="3.2.2" id="design-philosophy"><span class="header-section-number">3.2.2</span> Design Philosophy</h3>
<p>PostgreSQL‚Äôs storage layer embodies several key design
principles:</p>
<ol type="1">
<li><strong>Reliability First</strong>: All data modifications are
protected by WAL</li>
<li><strong>Extensibility</strong>: The access method API allows new
storage engines</li>
<li><strong>Performance</strong>: Multi-level caching and efficient data
structures</li>
<li><strong>Standards Compliance</strong>: Full ACID transaction
support</li>
<li><strong>Flexibility</strong>: Multiple index types for diverse
workloads</li>
</ol>
<h2 data-number="3.3" id="page-structure"><span class="header-section-number">3.3</span> Page Structure</h2>
<h3 data-number="3.3.1" id="overview"><span class="header-section-number">3.3.1</span> Overview</h3>
<p>The page is the fundamental unit of storage in PostgreSQL. All data
files‚Äîtables, indexes, and internal structures‚Äîare organized as
sequences of fixed-size pages. The standard page size is 8KB (8192
bytes), though it can be configured at compile time to 1, 2, 4, 8, 16,
or 32 KB.</p>
<p>The page structure implements a <strong>slotted page design</strong>,
which provides flexibility for variable-length tuples while maintaining
efficient space utilization. This design is defined in
<code>src/include/storage/bufpage.h</code> and implemented throughout
the storage layer.</p>
<h3 data-number="3.3.2" id="page-layout"><span class="header-section-number">3.3.2</span> Page Layout</h3>
<p>Every page follows a consistent layout:</p>
<pre><code>+----------------+ ‚Üê Page Start (offset 0)
| Page Header    | 24 bytes
+----------------+
| Item Pointers  | Array growing forward
|      ...       |
+----------------+ ‚Üê pd_lower
|                |
| Free Space     |
|                |
+----------------+ ‚Üê pd_upper
| Tuple Data     | Growing backward
|      ...       |
+----------------+
| Special Space  | Index-specific data
+----------------+ ‚Üê Page End (offset 8192)</code></pre>
<p><strong>Key characteristics:</strong> - Fixed-size header at the
beginning - Item pointer array grows forward from the header - Tuple
data grows backward from the end - Free space in the middle allows both
areas to grow - Optional special space at the end for index metadata</p>
<h3 data-number="3.3.3" id="page-header-structure"><span class="header-section-number">3.3.3</span> Page Header Structure</h3>
<p>The page header (<code>PageHeaderData</code>) contains essential
metadata:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb9-1"><a aria-hidden="true" href="#cb9-1" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> PageHeaderData</span>
<span id="cb9-2"><a aria-hidden="true" href="#cb9-2" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb9-3"><a aria-hidden="true" href="#cb9-3" tabindex="-1"></a>    PageXLogRecPtr pd_lsn<span class="op">;</span>      <span class="co">/* LSN: next byte after last byte of WAL</span></span>
<span id="cb9-4"><a aria-hidden="true" href="#cb9-4" tabindex="-1"></a><span class="co">                                 * record for last change to this page */</span></span>
<span id="cb9-5"><a aria-hidden="true" href="#cb9-5" tabindex="-1"></a>    uint16      pd_checksum<span class="op">;</span>     <span class="co">/* checksum */</span></span>
<span id="cb9-6"><a aria-hidden="true" href="#cb9-6" tabindex="-1"></a>    uint16      pd_flags<span class="op">;</span>        <span class="co">/* flag bits */</span></span>
<span id="cb9-7"><a aria-hidden="true" href="#cb9-7" tabindex="-1"></a>    LocationIndex pd_lower<span class="op">;</span>      <span class="co">/* offset to start of free space */</span></span>
<span id="cb9-8"><a aria-hidden="true" href="#cb9-8" tabindex="-1"></a>    LocationIndex pd_upper<span class="op">;</span>      <span class="co">/* offset to end of free space */</span></span>
<span id="cb9-9"><a aria-hidden="true" href="#cb9-9" tabindex="-1"></a>    LocationIndex pd_special<span class="op">;</span>    <span class="co">/* offset to start of special space */</span></span>
<span id="cb9-10"><a aria-hidden="true" href="#cb9-10" tabindex="-1"></a>    uint16      pd_pagesize_version<span class="op">;</span></span>
<span id="cb9-11"><a aria-hidden="true" href="#cb9-11" tabindex="-1"></a>    TransactionId pd_prune_xid<span class="op">;</span>  <span class="co">/* oldest prunable XID, or zero if none */</span></span>
<span id="cb9-12"><a aria-hidden="true" href="#cb9-12" tabindex="-1"></a>    ItemIdData  pd_linp<span class="op">[</span>FLEXIBLE_ARRAY_MEMBER<span class="op">];</span> <span class="co">/* line pointer array */</span></span>
<span id="cb9-13"><a aria-hidden="true" href="#cb9-13" tabindex="-1"></a><span class="op">}</span> PageHeaderData<span class="op">;</span></span></code></pre></div>
<p><strong>Field descriptions:</strong></p>
<ul>
<li><strong>pd_lsn</strong>: Log Sequence Number indicating the last WAL
record that modified this page. Critical for crash recovery and
replication.</li>
<li><strong>pd_checksum</strong>: Data integrity verification (when
enabled with <code>--enable-checksum</code>)</li>
<li><strong>pd_flags</strong>: Bitmap of page attributes (has free
space, all tuples visible, etc.)</li>
<li><strong>pd_lower</strong>: Offset to the start of free space (end of
item pointer array)</li>
<li><strong>pd_upper</strong>: Offset to the end of free space (start of
tuple data)</li>
<li><strong>pd_special</strong>: Offset to special space (0 for heap
pages, non-zero for indexes)</li>
<li><strong>pd_pagesize_version</strong>: Page size and layout
version</li>
<li><strong>pd_prune_xid</strong>: Optimization for HOT (Heap-Only
Tuple) pruning</li>
<li><strong>pd_linp</strong>: Beginning of the item pointer array</li>
</ul>
<h3 data-number="3.3.4" id="item-pointers"><span class="header-section-number">3.3.4</span> Item Pointers</h3>
<p>Item pointers (also called line pointers) form an indirection layer
between tuple identifiers and physical tuple locations. Each item
pointer is 4 bytes:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb10-1"><a aria-hidden="true" href="#cb10-1" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> ItemIdData</span>
<span id="cb10-2"><a aria-hidden="true" href="#cb10-2" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb10-3"><a aria-hidden="true" href="#cb10-3" tabindex="-1"></a>    <span class="dt">unsigned</span>    lp_off<span class="op">:</span><span class="dv">15</span><span class="op">,</span>      <span class="co">/* offset to tuple (from start of page) */</span></span>
<span id="cb10-4"><a aria-hidden="true" href="#cb10-4" tabindex="-1"></a>                lp_flags<span class="op">:</span><span class="dv">2</span><span class="op">,</span>     <span class="co">/* state of line pointer */</span></span>
<span id="cb10-5"><a aria-hidden="true" href="#cb10-5" tabindex="-1"></a>                lp_len<span class="op">:</span><span class="dv">15</span><span class="op">;</span>      <span class="co">/* byte length of tuple */</span></span>
<span id="cb10-6"><a aria-hidden="true" href="#cb10-6" tabindex="-1"></a><span class="op">}</span> ItemIdData<span class="op">;</span></span></code></pre></div>
<p><strong>Item pointer states</strong> (lp_flags): -
<strong>LP_UNUSED</strong> (0): Item pointer is available for reuse -
<strong>LP_NORMAL</strong> (1): Points to a normal tuple -
<strong>LP_REDIRECT</strong> (2): Redirects to another item pointer (HOT
chains) - <strong>LP_DEAD</strong> (3): Tuple is dead but space not yet
reclaimed</p>
<p><strong>Why use indirection?</strong></p>
<p>The item pointer array provides critical benefits:</p>
<ol type="1">
<li><strong>Stable Tuple Identifiers</strong>: External references
(indexes, CTID columns) point to item numbers, not physical offsets</li>
<li><strong>Defragmentation</strong>: Tuples can be moved within a page
without updating indexes</li>
<li><strong>HOT Updates</strong>: Tuple chains can be maintained through
redirects</li>
<li><strong>Space Reclamation</strong>: Dead tuples can be compacted
without breaking references</li>
</ol>
<h3 data-number="3.3.5" id="tuple-structure"><span class="header-section-number">3.3.5</span> Tuple Structure</h3>
<p>Heap tuples have a header followed by null bitmap and attribute
data:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb11-1"><a aria-hidden="true" href="#cb11-1" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> HeapTupleHeaderData</span>
<span id="cb11-2"><a aria-hidden="true" href="#cb11-2" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb11-3"><a aria-hidden="true" href="#cb11-3" tabindex="-1"></a>    <span class="kw">union</span></span>
<span id="cb11-4"><a aria-hidden="true" href="#cb11-4" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb11-5"><a aria-hidden="true" href="#cb11-5" tabindex="-1"></a>        HeapTupleFields t_heap<span class="op">;</span></span>
<span id="cb11-6"><a aria-hidden="true" href="#cb11-6" tabindex="-1"></a>        DatumTupleFields t_datum<span class="op">;</span></span>
<span id="cb11-7"><a aria-hidden="true" href="#cb11-7" tabindex="-1"></a>    <span class="op">}</span> t_choice<span class="op">;</span></span>
<span id="cb11-8"><a aria-hidden="true" href="#cb11-8" tabindex="-1"></a></span>
<span id="cb11-9"><a aria-hidden="true" href="#cb11-9" tabindex="-1"></a>    ItemPointerData t_ctid<span class="op">;</span>     <span class="co">/* current TID or next TID in chain */</span></span>
<span id="cb11-10"><a aria-hidden="true" href="#cb11-10" tabindex="-1"></a>    uint16      t_infomask2<span class="op">;</span>    <span class="co">/* attribute count and flags */</span></span>
<span id="cb11-11"><a aria-hidden="true" href="#cb11-11" tabindex="-1"></a>    uint16      t_infomask<span class="op">;</span>     <span class="co">/* various flag bits */</span></span>
<span id="cb11-12"><a aria-hidden="true" href="#cb11-12" tabindex="-1"></a>    uint8       t_hoff<span class="op">;</span>         <span class="co">/* offset to user data */</span></span>
<span id="cb11-13"><a aria-hidden="true" href="#cb11-13" tabindex="-1"></a></span>
<span id="cb11-14"><a aria-hidden="true" href="#cb11-14" tabindex="-1"></a>    <span class="co">/* Followed by null bitmap and attribute data */</span></span>
<span id="cb11-15"><a aria-hidden="true" href="#cb11-15" tabindex="-1"></a><span class="op">}</span> HeapTupleHeaderData<span class="op">;</span></span></code></pre></div>
<p><strong>Critical fields:</strong></p>
<ul>
<li><strong>t_xmin</strong>: Transaction ID that inserted this
tuple</li>
<li><strong>t_xmax</strong>: Transaction ID that deleted or updated this
tuple (0 if current)</li>
<li><strong>t_ctid</strong>: Current tuple ID (self-reference) or
pointer to newer version</li>
<li><strong>t_infomask</strong>: Flags indicating tuple properties (see
MVCC section)</li>
<li><strong>t_hoff</strong>: Header offset where actual column data
begins</li>
</ul>
<h3 data-number="3.3.6" id="page-organization-examples"><span class="header-section-number">3.3.6</span> Page Organization
Examples</h3>
<p><strong>Example 1: Simple heap page with three tuples</strong></p>
<pre><code>Offset | Content
-------+--------------------------------------------------
0      | Page header (24 bytes)
24     | Item 1 pointer ‚Üí offset=8168, len=24
28     | Item 2 pointer ‚Üí offset=8144, len=24
32     | Item 3 pointer ‚Üí offset=8120, len=24
36     | [Free Space: 8084 bytes]
8120   | Tuple 3 data (24 bytes)
8144   | Tuple 2 data (24 bytes)
8168   | Tuple 3 data (24 bytes)</code></pre>
<p><strong>Example 2: Page after DELETE (before VACUUM)</strong></p>
<pre><code>Offset | Content
-------+--------------------------------------------------
0      | Page header
24     | Item 1 pointer ‚Üí LP_NORMAL, offset=8168, len=24
28     | Item 2 pointer ‚Üí LP_DEAD (marked for cleanup)
32     | Item 3 pointer ‚Üí LP_NORMAL, offset=8120, len=24
36     | [Free Space includes dead tuple space]
8120   | Tuple 3 data (24 bytes)
8144   | Dead tuple data (24 bytes, reclaimable)
8168   | Tuple 1 data (24 bytes)</code></pre>
<h3 data-number="3.3.7" id="page-level-operations"><span class="header-section-number">3.3.7</span> Page-Level Operations</h3>
<p>Key operations defined in
<code>src/backend/storage/page/bufpage.c</code>:</p>
<p><strong>PageAddItem</strong>: Adds a new item to a page</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb14-1"><a aria-hidden="true" href="#cb14-1" tabindex="-1"></a>OffsetNumber PageAddItem<span class="op">(</span>Page page<span class="op">,</span> Item item<span class="op">,</span> Size size<span class="op">,</span></span>
<span id="cb14-2"><a aria-hidden="true" href="#cb14-2" tabindex="-1"></a>                         OffsetNumber offsetNumber<span class="op">,</span> <span class="dt">bool</span> overwrite<span class="op">,</span></span>
<span id="cb14-3"><a aria-hidden="true" href="#cb14-3" tabindex="-1"></a>                         <span class="dt">bool</span> is_heap<span class="op">);</span></span></code></pre></div>
<p><strong>PageRepairFragmentation</strong>: Compacts tuples to reclaim
free space</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb15-1"><a aria-hidden="true" href="#cb15-1" tabindex="-1"></a><span class="dt">void</span> PageRepairFragmentation<span class="op">(</span>Page page<span class="op">);</span></span></code></pre></div>
<p><strong>PageGetFreeSpace</strong>: Returns available free space</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb16-1"><a aria-hidden="true" href="#cb16-1" tabindex="-1"></a>Size PageGetFreeSpace<span class="op">(</span>Page page<span class="op">);</span></span></code></pre></div>
<h3 data-number="3.3.8" id="page-types"><span class="header-section-number">3.3.8</span> Page Types</h3>
<p>PostgreSQL uses different page layouts for different purposes:</p>
<ol type="1">
<li><strong>Heap Pages</strong>: Standard table data (no special
space)</li>
<li><strong>B-tree Pages</strong>: Special space contains left/right
sibling links, level</li>
<li><strong>Hash Pages</strong>: Special space contains bucket
information</li>
<li><strong>GiST Pages</strong>: Special space contains flags and tree
navigation data</li>
<li><strong>GIN Pages</strong>: Special space varies by page type (entry
tree vs posting tree)</li>
<li><strong>SP-GiST Pages</strong>: Special space contains node type and
traversal data</li>
</ol>
<h3 data-number="3.3.9" id="page-file-organization"><span class="header-section-number">3.3.9</span> Page File Organization</h3>
<p>Pages are organized in files within the PostgreSQL data
directory:</p>
<pre><code>$PGDATA/base/&lt;database_oid&gt;/&lt;relation_oid&gt;
$PGDATA/base/&lt;database_oid&gt;/&lt;relation_oid&gt;.1  (if &gt; 1GB)
$PGDATA/base/&lt;database_oid&gt;/&lt;relation_oid&gt;_fsm  (free space map)
$PGDATA/base/&lt;database_oid&gt;/&lt;relation_oid&gt;_vm   (visibility map)</code></pre>
<p>Each file is divided into 1GB segments to accommodate filesystems
with size limits. A table‚Äôs first segment has no suffix, subsequent
segments are numbered <code>.1</code>, <code>.2</code>, etc.</p>
<p><strong>Block numbering</strong>: Pages are numbered sequentially
starting from 0. A block number combined with the relation OID uniquely
identifies a page within a database.</p>
<h3 data-number="3.3.10" id="alignment-and-padding"><span class="header-section-number">3.3.10</span> Alignment and Padding</h3>
<p>PostgreSQL enforces strict alignment requirements:</p>
<ul>
<li><strong>MAXALIGN</strong>: Typically 8 bytes on 64-bit systems</li>
<li>Tuple data is aligned to MAXALIGN boundaries</li>
<li>Individual attributes aligned according to their type (2, 4, or 8
bytes)</li>
<li>Padding bytes inserted to maintain alignment</li>
</ul>
<p>This alignment is critical for: - CPU performance (aligned memory
access) - Portability across architectures - Preventing unaligned access
faults on strict architectures</p>
<h3 data-number="3.3.11" id="performance-implications"><span class="header-section-number">3.3.11</span> Performance
Implications</h3>
<p>The slotted page design has important performance
characteristics:</p>
<p><strong>Advantages:</strong> - Efficient use of space with
variable-length tuples - Fast tuple insertion (append to end, add
pointer) - Stable tuple identifiers via indirection - Support for
in-page tuple chains (HOT)</p>
<p><strong>Trade-offs:</strong> - Item pointer overhead (4 bytes per
tuple) - Fragmentation can waste space - Page-level locking during
modifications - Fixed page size limits maximum tuple size</p>
<h2 data-number="3.4" id="buffer-manager"><span class="header-section-number">3.4</span> Buffer Manager</h2>
<h3 data-number="3.4.1" id="overview-1"><span class="header-section-number">3.4.1</span> Overview</h3>
<p>The buffer manager is PostgreSQL‚Äôs memory caching layer, mediating
all access between disk storage and query execution. Located in
<code>src/backend/storage/buffer/bufmgr.c</code> (7,468 lines), it
implements a sophisticated shared buffer pool that dramatically improves
performance by keeping frequently accessed pages in RAM.</p>
<p>Every page read or modification flows through the buffer manager,
making it one of the most performance-critical subsystems in PostgreSQL.
The buffer manager handles page caching, replacement policies, I/O
scheduling, and coordination with the WAL system.</p>
<h3 data-number="3.4.2" id="architecture"><span class="header-section-number">3.4.2</span> Architecture</h3>
<p>The buffer manager architecture consists of several key
components:</p>
<pre><code>+------------------+
| Query Execution  |
+------------------+
         ‚Üì
+------------------+
| Buffer Manager   |
| - Buffer Pool    |
| - Buffer Table   |
| - Buffer Locks   |
| - Replacement    |
+------------------+
         ‚Üì
+------------------+
| Storage Manager  |
| - File I/O       |
+------------------+
         ‚Üì
+------------------+
| Operating System |
| - File Cache     |
+------------------+</code></pre>
<h3 data-number="3.4.3" id="buffer-pool-structure"><span class="header-section-number">3.4.3</span> Buffer Pool Structure</h3>
<p>The buffer pool (<code>shared_buffers</code> configuration parameter)
is a large array of buffer descriptors, each managing one 8KB page:</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb19-1"><a aria-hidden="true" href="#cb19-1" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> BufferDesc</span>
<span id="cb19-2"><a aria-hidden="true" href="#cb19-2" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb19-3"><a aria-hidden="true" href="#cb19-3" tabindex="-1"></a>    BufferTag   tag<span class="op">;</span>            <span class="co">/* ID of page contained in buffer */</span></span>
<span id="cb19-4"><a aria-hidden="true" href="#cb19-4" tabindex="-1"></a>    <span class="dt">int</span>         buf_id<span class="op">;</span>         <span class="co">/* buffer's index in BufferDescriptors */</span></span>
<span id="cb19-5"><a aria-hidden="true" href="#cb19-5" tabindex="-1"></a></span>
<span id="cb19-6"><a aria-hidden="true" href="#cb19-6" tabindex="-1"></a>    pg_atomic_uint32 state<span class="op">;</span>     <span class="co">/* atomic state flags and refcount */</span></span>
<span id="cb19-7"><a aria-hidden="true" href="#cb19-7" tabindex="-1"></a>    <span class="dt">int</span>         wait_backend_pid<span class="op">;</span> <span class="co">/* backend waiting for this buffer */</span></span>
<span id="cb19-8"><a aria-hidden="true" href="#cb19-8" tabindex="-1"></a></span>
<span id="cb19-9"><a aria-hidden="true" href="#cb19-9" tabindex="-1"></a>    <span class="dt">int</span>         freeNext<span class="op">;</span>       <span class="co">/* link in freelist chain */</span></span>
<span id="cb19-10"><a aria-hidden="true" href="#cb19-10" tabindex="-1"></a></span>
<span id="cb19-11"><a aria-hidden="true" href="#cb19-11" tabindex="-1"></a>    LWLock      content_lock<span class="op">;</span>   <span class="co">/* to lock access to buffer contents */</span></span>
<span id="cb19-12"><a aria-hidden="true" href="#cb19-12" tabindex="-1"></a><span class="op">}</span> BufferDesc<span class="op">;</span></span></code></pre></div>
<p><strong>BufferTag</strong> uniquely identifies a page:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb20-1"><a aria-hidden="true" href="#cb20-1" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> BufferTag</span>
<span id="cb20-2"><a aria-hidden="true" href="#cb20-2" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb20-3"><a aria-hidden="true" href="#cb20-3" tabindex="-1"></a>    RelFileNode rnode<span class="op">;</span>          <span class="co">/* relation file identification */</span></span>
<span id="cb20-4"><a aria-hidden="true" href="#cb20-4" tabindex="-1"></a>    ForkNumber  forkNum<span class="op">;</span>        <span class="co">/* fork number (main, FSM, VM, init) */</span></span>
<span id="cb20-5"><a aria-hidden="true" href="#cb20-5" tabindex="-1"></a>    BlockNumber blockNum<span class="op">;</span>       <span class="co">/* block number within the fork */</span></span>
<span id="cb20-6"><a aria-hidden="true" href="#cb20-6" tabindex="-1"></a><span class="op">}</span> BufferTag<span class="op">;</span></span></code></pre></div>
<p><strong>State Flags</strong> (stored in atomic state field): -
<strong>BM_DIRTY</strong>: Page has been modified since read from disk -
<strong>BM_VALID</strong>: Buffer contains valid data -
<strong>BM_TAG_VALID</strong>: Buffer tag is valid -
<strong>BM_IO_IN_PROGRESS</strong>: I/O is in progress for this buffer -
<strong>BM_IO_ERROR</strong>: I/O error occurred -
<strong>BM_JUST_DIRTIED</strong>: Recently dirtied (for WAL
optimization) - <strong>BM_PERMANENT</strong>: Page from permanent
relation - Plus reference count in upper bits</p>
<h3 data-number="3.4.4" id="buffer-table-hash-table"><span class="header-section-number">3.4.4</span> Buffer Table (Hash
Table)</h3>
<p>The buffer table is a shared hash table mapping BufferTags to buffer
descriptors:</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb21-1"><a aria-hidden="true" href="#cb21-1" tabindex="-1"></a><span class="co">/* Hash table for buffer lookup */</span></span>
<span id="cb21-2"><a aria-hidden="true" href="#cb21-2" tabindex="-1"></a><span class="dt">static</span> HTAB <span class="op">*</span>SharedBufHash<span class="op">;</span></span></code></pre></div>
<p><strong>Key operations:</strong></p>
<ol type="1">
<li><strong>BufTableLookup</strong>: Find buffer descriptor for a given
page</li>
<li><strong>BufTableInsert</strong>: Add new page to buffer table</li>
<li><strong>BufTableDelete</strong>: Remove page from buffer table</li>
</ol>
<p>The hash table uses <strong>dynahash</strong> (PostgreSQL‚Äôs
extensible hash table implementation) with partitioned locking to
minimize contention:</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb22-1"><a aria-hidden="true" href="#cb22-1" tabindex="-1"></a><span class="pp">#define NUM_BUFFER_PARTITIONS  </span><span class="dv">128</span></span></code></pre></div>
<p>Each partition has its own lock, allowing concurrent lookups in
different partitions.</p>
<h3 data-number="3.4.5" id="buffer-access-protocol"><span class="header-section-number">3.4.5</span> Buffer Access Protocol</h3>
<p>Reading a page follows a strict protocol:</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb23-1"><a aria-hidden="true" href="#cb23-1" tabindex="-1"></a>Buffer ReadBuffer<span class="op">(</span>Relation reln<span class="op">,</span> BlockNumber blockNum<span class="op">);</span></span></code></pre></div>
<p><strong>Step-by-step process:</strong></p>
<ol type="1">
<li><strong>Compute buffer tag</strong> from relation and block
number</li>
<li><strong>Acquire partition lock</strong> for buffer table lookup</li>
<li><strong>Search buffer table</strong> for existing buffer:
<ul>
<li><strong>If found (cache hit)</strong>:
<ul>
<li>Increment reference count</li>
<li>Release partition lock</li>
<li>Acquire content lock if needed</li>
<li>Return buffer</li>
</ul></li>
<li><strong>If not found (cache miss)</strong>:
<ul>
<li>Select victim buffer using clock sweep algorithm</li>
<li>If victim is dirty, write to disk (possibly via WAL)</li>
<li>Replace victim‚Äôs tag with new tag</li>
<li>Release partition lock</li>
<li>Read page from disk</li>
<li>Mark buffer valid</li>
<li>Return buffer</li>
</ul></li>
</ul></li>
<li><strong>Access page data</strong> through buffer</li>
<li><strong>Release buffer</strong> (decrement reference count)</li>
</ol>
<h3 data-number="3.4.6" id="buffer-replacement-clock-sweep-algorithm"><span class="header-section-number">3.4.6</span> Buffer Replacement: Clock
Sweep Algorithm</h3>
<p>PostgreSQL uses a variant of the <strong>clock sweep
algorithm</strong> for buffer replacement:</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb24-1"><a aria-hidden="true" href="#cb24-1" tabindex="-1"></a><span class="co">/*</span></span>
<span id="cb24-2"><a aria-hidden="true" href="#cb24-2" tabindex="-1"></a><span class="co"> * StrategyGetBuffer - get a buffer from the freelist or evict one</span></span>
<span id="cb24-3"><a aria-hidden="true" href="#cb24-3" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb24-4"><a aria-hidden="true" href="#cb24-4" tabindex="-1"></a>BufferDesc <span class="op">*</span>StrategyGetBuffer<span class="op">(</span>BufferAccessStrategy strategy<span class="op">,</span></span>
<span id="cb24-5"><a aria-hidden="true" href="#cb24-5" tabindex="-1"></a>                              uint32 <span class="op">*</span>buf_state<span class="op">);</span></span></code></pre></div>
<p><strong>Algorithm overview:</strong></p>
<p>The buffer manager maintains a circular list (clock) of all buffers
with a ‚Äúclock hand‚Äù pointer. Each buffer has a usage count (0-5):</p>
<pre><code>      ‚Üì Clock Hand
[Buf0] [Buf1] [Buf2] [Buf3] ... [BufN]
 uc=2   uc=5   uc=0   uc=3      uc=1</code></pre>
<p><strong>Replacement process:</strong></p>
<ol type="1">
<li>Start at current clock hand position</li>
<li>Examine buffer at clock hand:
<ul>
<li>If usage count = 0 and not pinned: <strong>select as
victim</strong></li>
<li>If usage count &gt; 0: <strong>decrement usage count, advance clock
hand</strong></li>
<li>If pinned: <strong>advance clock hand</strong></li>
</ul></li>
<li>Repeat until victim found</li>
</ol>
<p><strong>Usage count incrementation:</strong> - Incremented on buffer
access (up to maximum of 5) - Decremented by clock sweep - Provides a
form of LRU approximation with low overhead</p>
<h3 data-number="3.4.7" id="buffer-access-strategies"><span class="header-section-number">3.4.7</span> Buffer Access Strategies</h3>
<p>For certain operations, PostgreSQL uses specialized <strong>buffer
access strategies</strong> to avoid polluting the buffer cache:</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb26-1"><a aria-hidden="true" href="#cb26-1" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">enum</span> BufferAccessStrategyType</span>
<span id="cb26-2"><a aria-hidden="true" href="#cb26-2" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb26-3"><a aria-hidden="true" href="#cb26-3" tabindex="-1"></a>    BAS_NORMAL<span class="op">,</span>         <span class="co">/* Normal random access */</span></span>
<span id="cb26-4"><a aria-hidden="true" href="#cb26-4" tabindex="-1"></a>    BAS_BULKREAD<span class="op">,</span>       <span class="co">/* Large sequential scan */</span></span>
<span id="cb26-5"><a aria-hidden="true" href="#cb26-5" tabindex="-1"></a>    BAS_BULKWRITE<span class="op">,</span>      <span class="co">/* COPY or bulk INSERT */</span></span>
<span id="cb26-6"><a aria-hidden="true" href="#cb26-6" tabindex="-1"></a>    BAS_VACUUM          <span class="co">/* VACUUM operation */</span></span>
<span id="cb26-7"><a aria-hidden="true" href="#cb26-7" tabindex="-1"></a><span class="op">}</span> BufferAccessStrategyType<span class="op">;</span></span></code></pre></div>
<p><strong>BAS_BULKREAD</strong> (sequential scans): - Uses a small ring
buffer (256 KB by default) - Prevents large table scans from evicting
useful cached pages - Cycles through ring buffer, reusing same
buffers</p>
<p><strong>BAS_VACUUM</strong>: - Uses 256 KB ring buffer - Isolates
VACUUM I/O from normal queries</p>
<p><strong>BAS_BULKWRITE</strong>: - Uses 16 MB ring buffer - For COPY
and CREATE TABLE AS operations</p>
<h3 data-number="3.4.8" id="buffer-pinning-and-locking"><span class="header-section-number">3.4.8</span> Buffer Pinning and
Locking</h3>
<p>Buffers use a two-level locking mechanism:</p>
<p><strong>1. Reference Count (Pin Count)</strong></p>
<div class="sourceCode" id="cb27"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb27-1"><a aria-hidden="true" href="#cb27-1" tabindex="-1"></a>Buffer buf <span class="op">=</span> ReadBuffer<span class="op">(</span>rel<span class="op">,</span> blocknum<span class="op">);</span></span>
<span id="cb27-2"><a aria-hidden="true" href="#cb27-2" tabindex="-1"></a><span class="co">/* Buffer is now "pinned" (reference count &gt; 0) */</span></span>
<span id="cb27-3"><a aria-hidden="true" href="#cb27-3" tabindex="-1"></a><span class="co">/* Prevents buffer from being evicted */</span></span>
<span id="cb27-4"><a aria-hidden="true" href="#cb27-4" tabindex="-1"></a>ReleaseBuffer<span class="op">(</span>buf<span class="op">);</span>  <span class="co">/* Decrement reference count */</span></span></code></pre></div>
<p><strong>2. Content Locks</strong></p>
<div class="sourceCode" id="cb28"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb28-1"><a aria-hidden="true" href="#cb28-1" tabindex="-1"></a>LockBuffer<span class="op">(</span>buf<span class="op">,</span> BUFFER_LOCK_SHARE<span class="op">);</span>     <span class="co">/* Shared lock for reading */</span></span>
<span id="cb28-2"><a aria-hidden="true" href="#cb28-2" tabindex="-1"></a>LockBuffer<span class="op">(</span>buf<span class="op">,</span> BUFFER_LOCK_EXCLUSIVE<span class="op">);</span> <span class="co">/* Exclusive lock for writing */</span></span>
<span id="cb28-3"><a aria-hidden="true" href="#cb28-3" tabindex="-1"></a>LockBuffer<span class="op">(</span>buf<span class="op">,</span> BUFFER_LOCK_UNLOCK<span class="op">);</span>    <span class="co">/* Release lock */</span></span></code></pre></div>
<p><strong>Why two levels?</strong></p>
<ul>
<li><strong>Reference count</strong>: Ensures buffer isn‚Äôt evicted while
in use</li>
<li><strong>Content lock</strong>: Ensures consistent reads/writes of
page data</li>
<li>Can hold pin without lock (e.g., while waiting for another
resource)</li>
<li>Multiple backends can pin same buffer concurrently</li>
</ul>
<h3 data-number="3.4.9" id="write-ahead-logging-integration"><span class="header-section-number">3.4.9</span> Write-Ahead Logging
Integration</h3>
<p>Buffer manager coordinates closely with WAL:</p>
<p><strong>Rule: WAL Before Data (WAL Protocol)</strong></p>
<pre><code>Before writing a dirty buffer to disk:
1. Ensure all WAL records up to buffer's pd_lsn are flushed
2. This guarantees recovery can replay necessary changes</code></pre>
<p>Implementation in <code>FlushBuffer</code>:</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb30-1"><a aria-hidden="true" href="#cb30-1" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> FlushBuffer<span class="op">(</span>BufferDesc <span class="op">*</span>buf<span class="op">,</span> SMgrRelation reln<span class="op">)</span></span>
<span id="cb30-2"><a aria-hidden="true" href="#cb30-2" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb30-3"><a aria-hidden="true" href="#cb30-3" tabindex="-1"></a>    XLogRecPtr  recptr<span class="op">;</span></span>
<span id="cb30-4"><a aria-hidden="true" href="#cb30-4" tabindex="-1"></a></span>
<span id="cb30-5"><a aria-hidden="true" href="#cb30-5" tabindex="-1"></a>    <span class="co">/* Get buffer's LSN */</span></span>
<span id="cb30-6"><a aria-hidden="true" href="#cb30-6" tabindex="-1"></a>    recptr <span class="op">=</span> BufferGetLSN<span class="op">(</span>buf<span class="op">);</span></span>
<span id="cb30-7"><a aria-hidden="true" href="#cb30-7" tabindex="-1"></a></span>
<span id="cb30-8"><a aria-hidden="true" href="#cb30-8" tabindex="-1"></a>    <span class="co">/* Ensure WAL is flushed up to this LSN */</span></span>
<span id="cb30-9"><a aria-hidden="true" href="#cb30-9" tabindex="-1"></a>    XLogFlush<span class="op">(</span>recptr<span class="op">);</span></span>
<span id="cb30-10"><a aria-hidden="true" href="#cb30-10" tabindex="-1"></a></span>
<span id="cb30-11"><a aria-hidden="true" href="#cb30-11" tabindex="-1"></a>    <span class="co">/* Now safe to write buffer to disk */</span></span>
<span id="cb30-12"><a aria-hidden="true" href="#cb30-12" tabindex="-1"></a>    smgrwrite<span class="op">(</span>reln<span class="op">,</span> forkNum<span class="op">,</span> blockNum<span class="op">,</span> bufToWrite<span class="op">,</span> <span class="kw">false</span><span class="op">);</span></span>
<span id="cb30-13"><a aria-hidden="true" href="#cb30-13" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 data-number="3.4.10" id="background-writer-and-checkpointer"><span class="header-section-number">3.4.10</span> Background Writer and
Checkpointer</h3>
<p>Two background processes help manage dirty buffers:</p>
<p><strong>Background Writer</strong> (<code>bgwriter</code>): -
Continuously scans buffer pool - Writes dirty buffers to reduce
checkpoint I/O spike - Uses clock sweep to find dirty buffers with low
usage count - Configured via <code>bgwriter_delay</code>,
<code>bgwriter_lru_maxpages</code>, etc.</p>
<p><strong>Checkpointer</strong>: - Performs periodic checkpoints (see
WAL section) - Writes all dirty buffers to disk - Spreads I/O over
checkpoint interval to avoid spikes - Configured via
<code>checkpoint_timeout</code>,
<code>checkpoint_completion_target</code></p>
<h3 data-number="3.4.11" id="buffer-manager-statistics"><span class="header-section-number">3.4.11</span> Buffer Manager
Statistics</h3>
<p>The <code>pg_buffercache</code> extension provides visibility into
buffer contents:</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb31-1"><a aria-hidden="true" href="#cb31-1" tabindex="-1"></a><span class="kw">SELECT</span> c.relname,</span>
<span id="cb31-2"><a aria-hidden="true" href="#cb31-2" tabindex="-1"></a>       <span class="fu">count</span>(<span class="op">*</span>) <span class="kw">AS</span> buffers,</span>
<span id="cb31-3"><a aria-hidden="true" href="#cb31-3" tabindex="-1"></a>       pg_size_pretty(<span class="fu">count</span>(<span class="op">*</span>) <span class="op">*</span> <span class="dv">8192</span>) <span class="kw">AS</span> <span class="kw">size</span></span>
<span id="cb31-4"><a aria-hidden="true" href="#cb31-4" tabindex="-1"></a><span class="kw">FROM</span> pg_buffercache b</span>
<span id="cb31-5"><a aria-hidden="true" href="#cb31-5" tabindex="-1"></a>  <span class="kw">JOIN</span> pg_class c <span class="kw">ON</span> b.relfilenode <span class="op">=</span> pg_relation_filenode(c.<span class="kw">oid</span>)</span>
<span id="cb31-6"><a aria-hidden="true" href="#cb31-6" tabindex="-1"></a><span class="kw">WHERE</span> b.reldatabase <span class="kw">IN</span> (<span class="dv">0</span>, (<span class="kw">SELECT</span> <span class="kw">oid</span> <span class="kw">FROM</span> pg_database</span>
<span id="cb31-7"><a aria-hidden="true" href="#cb31-7" tabindex="-1"></a>                             <span class="kw">WHERE</span> datname <span class="op">=</span> current_database()))</span>
<span id="cb31-8"><a aria-hidden="true" href="#cb31-8" tabindex="-1"></a><span class="kw">GROUP</span> <span class="kw">BY</span> c.relname</span>
<span id="cb31-9"><a aria-hidden="true" href="#cb31-9" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> <span class="fu">count</span>(<span class="op">*</span>) <span class="kw">DESC</span></span>
<span id="cb31-10"><a aria-hidden="true" href="#cb31-10" tabindex="-1"></a><span class="kw">LIMIT</span> <span class="dv">10</span>;</span></code></pre></div>
<p><strong>Key metrics:</strong> - <strong>cache hit ratio</strong>:
Percentage of page accesses served from cache -
<strong>buffers_checkpoint</strong>: Buffers written by checkpointer -
<strong>buffers_clean</strong>: Buffers written by background writer -
<strong>buffers_backend</strong>: Buffers written by backend
processes</p>
<h3 data-number="3.4.12" id="performance-tuning"><span class="header-section-number">3.4.12</span> Performance Tuning</h3>
<p><strong>shared_buffers</strong> configuration: - Default: 128 MB (too
small for production) - Recommendation: 25% of system RAM (up to 8-16
GB) - Beyond 16 GB often shows diminishing returns - OS page cache
provides additional caching</p>
<p><strong>Monitoring buffer cache effectiveness:</strong></p>
<div class="sourceCode" id="cb32"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb32-1"><a aria-hidden="true" href="#cb32-1" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb32-2"><a aria-hidden="true" href="#cb32-2" tabindex="-1"></a>  <span class="fu">sum</span>(heap_blks_read) <span class="kw">as</span> heap_read,</span>
<span id="cb32-3"><a aria-hidden="true" href="#cb32-3" tabindex="-1"></a>  <span class="fu">sum</span>(heap_blks_hit) <span class="kw">as</span> heap_hit,</span>
<span id="cb32-4"><a aria-hidden="true" href="#cb32-4" tabindex="-1"></a>  <span class="fu">sum</span>(heap_blks_hit) <span class="op">/</span> <span class="fu">nullif</span>(<span class="fu">sum</span>(heap_blks_hit) <span class="op">+</span> <span class="fu">sum</span>(heap_blks_read), <span class="dv">0</span>)</span>
<span id="cb32-5"><a aria-hidden="true" href="#cb32-5" tabindex="-1"></a>    <span class="kw">AS</span> cache_hit_ratio</span>
<span id="cb32-6"><a aria-hidden="true" href="#cb32-6" tabindex="-1"></a><span class="kw">FROM</span> pg_statio_user_tables;</span></code></pre></div>
<p>Target cache hit ratio: &gt; 0.99 for OLTP workloads</p>
<h3 data-number="3.4.13" id="local-buffers"><span class="header-section-number">3.4.13</span> Local Buffers</h3>
<p>In addition to shared buffers, each backend maintains <strong>local
buffers</strong> for temporary tables:</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb33-1"><a aria-hidden="true" href="#cb33-1" tabindex="-1"></a><span class="co">/* Configured via temp_buffers (default 8MB) */</span></span>
<span id="cb33-2"><a aria-hidden="true" href="#cb33-2" tabindex="-1"></a>Buffer LocalBufferAlloc<span class="op">(</span>SMgrRelation smgr<span class="op">,</span> ForkNumber forkNum<span class="op">,</span></span>
<span id="cb33-3"><a aria-hidden="true" href="#cb33-3" tabindex="-1"></a>                        BlockNumber blockNum<span class="op">,</span> <span class="dt">bool</span> <span class="op">*</span>foundPtr<span class="op">);</span></span></code></pre></div>
<p><strong>Characteristics:</strong> - Private to each backend process -
No locking needed (single-threaded access) - Not persistent across
sessions - Simpler implementation than shared buffers</p>
<h3 data-number="3.4.14" id="critical-code-paths"><span class="header-section-number">3.4.14</span> Critical Code Paths</h3>
<p><strong>Core buffer manager functions</strong>
(<code>src/backend/storage/buffer/bufmgr.c</code>):</p>
<ul>
<li><code>ReadBuffer</code> (line ~465): Main entry point for reading
pages</li>
<li><code>ReadBufferExtended</code> (line ~486): Extended version with
options</li>
<li><code>ReleaseBuffer</code> (line ~2040): Release buffer pin</li>
<li><code>MarkBufferDirty</code> (line ~2208): Mark buffer as
modified</li>
<li><code>LockBuffer</code> (line ~3016): Acquire buffer content
lock</li>
<li><code>FlushBuffer</code> (line ~2695): Write dirty buffer to
disk</li>
<li><code>StrategyGetBuffer</code> (line ~115 in freelist.c): Clock
sweep implementation</li>
</ul>
<h2 data-number="3.5" id="heap-access-method"><span class="header-section-number">3.5</span> Heap Access Method</h2>
<h3 data-number="3.5.1" id="overview-2"><span class="header-section-number">3.5.1</span> Overview</h3>
<p>The heap access method is PostgreSQL‚Äôs default storage mechanism for
table data. Located primarily in <code>src/backend/access/heap/</code>
(with heapam.c containing 9,337 lines), it implements an unordered
collection of tuples organized in pages. The term ‚Äúheap‚Äù refers to the
unordered nature‚Äîtuples are not stored in any particular order, unlike
index-organized tables in some other database systems.</p>
<p>The heap access method is responsible for: - Storing and retrieving
tuples - Implementing MVCC tuple visibility - Supporting tuple updates
and deletes - Managing tuple chains (HOT - Heap-Only Tuples) -
Coordinating with VACUUM for space reclamation</p>
<h3 data-number="3.5.2" id="heap-tuple-format"><span class="header-section-number">3.5.2</span> Heap Tuple Format</h3>
<p>A complete heap tuple consists of:</p>
<pre><code>+-------------------+
| HeapTupleHeader   | ~23 bytes + alignment
+-------------------+
| NULL Bitmap       | ceil(natts/8) bytes (if any nullable cols)
+-------------------+
| OID               | 4 bytes (if table has OIDs - deprecated)
+-------------------+
| User Data         | Actual column values
|  - Fixed-length   |
|  - Varlena        |
+-------------------+</code></pre>
<h3 data-number="3.5.3" id="heap-tuple-header-details"><span class="header-section-number">3.5.3</span> Heap Tuple Header
Details</h3>
<div class="sourceCode" id="cb35"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb35-1"><a aria-hidden="true" href="#cb35-1" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> HeapTupleFields</span>
<span id="cb35-2"><a aria-hidden="true" href="#cb35-2" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb35-3"><a aria-hidden="true" href="#cb35-3" tabindex="-1"></a>    TransactionId t_xmin<span class="op">;</span>       <span class="co">/* inserting xact ID */</span></span>
<span id="cb35-4"><a aria-hidden="true" href="#cb35-4" tabindex="-1"></a>    TransactionId t_xmax<span class="op">;</span>       <span class="co">/* deleting or locking xact ID */</span></span>
<span id="cb35-5"><a aria-hidden="true" href="#cb35-5" tabindex="-1"></a></span>
<span id="cb35-6"><a aria-hidden="true" href="#cb35-6" tabindex="-1"></a>    <span class="kw">union</span></span>
<span id="cb35-7"><a aria-hidden="true" href="#cb35-7" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb35-8"><a aria-hidden="true" href="#cb35-8" tabindex="-1"></a>        CommandId   t_cid<span class="op">;</span>      <span class="co">/* inserting or deleting command ID */</span></span>
<span id="cb35-9"><a aria-hidden="true" href="#cb35-9" tabindex="-1"></a>        TransactionId t_xvac<span class="op">;</span>   <span class="co">/* old-style VACUUM FULL xact ID */</span></span>
<span id="cb35-10"><a aria-hidden="true" href="#cb35-10" tabindex="-1"></a>    <span class="op">}</span> t_field3<span class="op">;</span></span>
<span id="cb35-11"><a aria-hidden="true" href="#cb35-11" tabindex="-1"></a><span class="op">}</span> HeapTupleFields<span class="op">;</span></span></code></pre></div>
<p><strong>Transaction ID fields:</strong></p>
<ul>
<li><strong>t_xmin</strong>: Transaction that inserted this tuple
<ul>
<li>Used to determine if tuple is visible to other transactions</li>
<li>Never changes after tuple creation</li>
</ul></li>
<li><strong>t_xmax</strong>: Transaction that deleted or locked this
tuple
<ul>
<li>0 (InvalidTransactionId) if tuple is current</li>
<li>Set on DELETE or UPDATE (which creates new version)</li>
<li>Also used for tuple locking (SELECT FOR UPDATE)</li>
</ul></li>
<li><strong>t_cid</strong>: Command ID within transaction
<ul>
<li>Distinguishes multiple statements within same transaction</li>
<li>Used for intra-transaction visibility</li>
</ul></li>
</ul>
<h3 data-number="3.5.4" id="heap-tuple-infomask-flags"><span class="header-section-number">3.5.4</span> Heap Tuple Infomask
Flags</h3>
<p>The <code>t_infomask</code> and <code>t_infomask2</code> fields
contain crucial tuple state information:</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb36-1"><a aria-hidden="true" href="#cb36-1" tabindex="-1"></a><span class="co">/* t_infomask flags */</span></span>
<span id="cb36-2"><a aria-hidden="true" href="#cb36-2" tabindex="-1"></a><span class="pp">#define HEAP_HASNULL          </span><span class="bn">0x0001</span><span class="pp">  </span><span class="co">/* has null attribute(s) */</span></span>
<span id="cb36-3"><a aria-hidden="true" href="#cb36-3" tabindex="-1"></a><span class="pp">#define HEAP_HASVARWIDTH      </span><span class="bn">0x0002</span><span class="pp">  </span><span class="co">/* has variable-width attribute(s) */</span></span>
<span id="cb36-4"><a aria-hidden="true" href="#cb36-4" tabindex="-1"></a><span class="pp">#define HEAP_HASEXTERNAL      </span><span class="bn">0x0004</span><span class="pp">  </span><span class="co">/* has external stored attribute(s) */</span></span>
<span id="cb36-5"><a aria-hidden="true" href="#cb36-5" tabindex="-1"></a><span class="pp">#define HEAP_HASOID_OLD       </span><span class="bn">0x0008</span><span class="pp">  </span><span class="co">/* has OID (deprecated) */</span></span>
<span id="cb36-6"><a aria-hidden="true" href="#cb36-6" tabindex="-1"></a><span class="pp">#define HEAP_XMAX_KEYSHR_LOCK </span><span class="bn">0x0010</span><span class="pp">  </span><span class="co">/* xmax is key-shared locker */</span></span>
<span id="cb36-7"><a aria-hidden="true" href="#cb36-7" tabindex="-1"></a><span class="pp">#define HEAP_COMBOCID         </span><span class="bn">0x0020</span><span class="pp">  </span><span class="co">/* t_cid is combo CID */</span></span>
<span id="cb36-8"><a aria-hidden="true" href="#cb36-8" tabindex="-1"></a><span class="pp">#define HEAP_XMAX_EXCL_LOCK   </span><span class="bn">0x0040</span><span class="pp">  </span><span class="co">/* xmax is exclusive locker */</span></span>
<span id="cb36-9"><a aria-hidden="true" href="#cb36-9" tabindex="-1"></a><span class="pp">#define HEAP_XMAX_LOCK_ONLY   </span><span class="bn">0x0080</span><span class="pp">  </span><span class="co">/* xmax is locker only, not deleter */</span></span>
<span id="cb36-10"><a aria-hidden="true" href="#cb36-10" tabindex="-1"></a></span>
<span id="cb36-11"><a aria-hidden="true" href="#cb36-11" tabindex="-1"></a><span class="co">/* Tuple visibility flags */</span></span>
<span id="cb36-12"><a aria-hidden="true" href="#cb36-12" tabindex="-1"></a><span class="pp">#define HEAP_XMIN_COMMITTED   </span><span class="bn">0x0100</span><span class="pp">  </span><span class="co">/* t_xmin committed */</span></span>
<span id="cb36-13"><a aria-hidden="true" href="#cb36-13" tabindex="-1"></a><span class="pp">#define HEAP_XMIN_INVALID     </span><span class="bn">0x0200</span><span class="pp">  </span><span class="co">/* t_xmin aborted */</span></span>
<span id="cb36-14"><a aria-hidden="true" href="#cb36-14" tabindex="-1"></a><span class="pp">#define HEAP_XMAX_COMMITTED   </span><span class="bn">0x0400</span><span class="pp">  </span><span class="co">/* t_xmax committed */</span></span>
<span id="cb36-15"><a aria-hidden="true" href="#cb36-15" tabindex="-1"></a><span class="pp">#define HEAP_XMAX_INVALID     </span><span class="bn">0x0800</span><span class="pp">  </span><span class="co">/* t_xmax aborted */</span></span>
<span id="cb36-16"><a aria-hidden="true" href="#cb36-16" tabindex="-1"></a><span class="pp">#define HEAP_XMAX_IS_MULTI    </span><span class="bn">0x1000</span><span class="pp">  </span><span class="co">/* xmax is MultiXactId */</span></span>
<span id="cb36-17"><a aria-hidden="true" href="#cb36-17" tabindex="-1"></a><span class="pp">#define HEAP_UPDATED          </span><span class="bn">0x2000</span><span class="pp">  </span><span class="co">/* this is UPDATEd version of row */</span></span>
<span id="cb36-18"><a aria-hidden="true" href="#cb36-18" tabindex="-1"></a><span class="pp">#define HEAP_MOVED_OFF        </span><span class="bn">0x4000</span><span class="pp">  </span><span class="co">/* old-style VACUUM FULL */</span></span>
<span id="cb36-19"><a aria-hidden="true" href="#cb36-19" tabindex="-1"></a><span class="pp">#define HEAP_MOVED_IN         </span><span class="bn">0x8000</span><span class="pp">  </span><span class="co">/* old-style VACUUM FULL */</span></span></code></pre></div>
<p>These flags optimize visibility checks by caching transaction status
information on the tuple itself, avoiding repeated lookups in CLOG
(commit log).</p>
<h3 data-number="3.5.5" id="heap-tuple-operations"><span class="header-section-number">3.5.5</span> Heap Tuple Operations</h3>
<h4 data-number="3.5.5.1" id="inserting-tuples"><span class="header-section-number">3.5.5.1</span> Inserting Tuples</h4>
<div class="sourceCode" id="cb37"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb37-1"><a aria-hidden="true" href="#cb37-1" tabindex="-1"></a><span class="co">/* Main insertion function */</span></span>
<span id="cb37-2"><a aria-hidden="true" href="#cb37-2" tabindex="-1"></a><span class="dt">void</span> heap_insert<span class="op">(</span>Relation relation<span class="op">,</span> HeapTuple tup<span class="op">,</span> CommandId cid<span class="op">,</span></span>
<span id="cb37-3"><a aria-hidden="true" href="#cb37-3" tabindex="-1"></a>                 <span class="dt">int</span> options<span class="op">,</span> BulkInsertState bistate<span class="op">);</span></span></code></pre></div>
<p><strong>Insertion process:</strong></p>
<ol type="1">
<li><p><strong>Find page with free space</strong>:</p>
<ul>
<li>Check FSM (Free Space Map) for suitable page</li>
<li>If no page found, extend relation with new page</li>
</ul></li>
<li><p><strong>Lock buffer</strong> exclusively</p></li>
<li><p><strong>Prepare tuple</strong>:</p>
<ul>
<li>Set t_xmin to current transaction ID</li>
<li>Set t_xmax to 0 (invalid)</li>
<li>Set t_cid to current command ID</li>
<li>Clear visibility hint bits initially</li>
</ul></li>
<li><p><strong>Write WAL record</strong> (if not temp table):</p>
<ul>
<li>Create XLOG_HEAP_INSERT record</li>
<li>Insert WAL record before modifying page</li>
<li>Get LSN of WAL record</li>
</ul></li>
<li><p><strong>Add tuple to page</strong>:</p>
<ul>
<li>Call PageAddItem to add tuple</li>
<li>Update page LSN</li>
</ul></li>
<li><p><strong>Update indexes</strong>:</p>
<ul>
<li>Insert entries in all indexes</li>
<li>Each index insert also WAL-logged</li>
</ul></li>
<li><p><strong>Update FSM</strong> if significant free space
remains</p></li>
</ol>
<h4 data-number="3.5.5.2" id="reading-tuples"><span class="header-section-number">3.5.5.2</span> Reading Tuples</h4>
<p>Sequential scan implementation:</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb38-1"><a aria-hidden="true" href="#cb38-1" tabindex="-1"></a>HeapTuple heap_getnext<span class="op">(</span>TableScanDesc sscan<span class="op">,</span> ScanDirection direction<span class="op">);</span></span></code></pre></div>
<p><strong>Scan process:</strong></p>
<ol type="1">
<li><strong>Read page</strong> via buffer manager</li>
<li><strong>Iterate through item pointers</strong></li>
<li><strong>For each tuple</strong>:
<ul>
<li>Check visibility using snapshot</li>
<li>Skip if not visible to current transaction</li>
<li>Return visible tuple</li>
</ul></li>
<li><strong>Move to next page</strong> when current page exhausted</li>
</ol>
<p>Index scan:</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb39-1"><a aria-hidden="true" href="#cb39-1" tabindex="-1"></a><span class="dt">bool</span> heap_fetch<span class="op">(</span>Relation relation<span class="op">,</span> Snapshot snapshot<span class="op">,</span></span>
<span id="cb39-2"><a aria-hidden="true" href="#cb39-2" tabindex="-1"></a>                HeapTuple tuple<span class="op">,</span> Buffer <span class="op">*</span>userbuf<span class="op">);</span></span></code></pre></div>
<p>Uses TID (tuple identifier = block number + item number) from index
to directly fetch tuple.</p>
<h4 data-number="3.5.5.3" id="updating-tuples"><span class="header-section-number">3.5.5.3</span> Updating Tuples</h4>
<div class="sourceCode" id="cb40"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb40-1"><a aria-hidden="true" href="#cb40-1" tabindex="-1"></a>TM_Result heap_update<span class="op">(</span>Relation relation<span class="op">,</span> ItemPointer otid<span class="op">,</span></span>
<span id="cb40-2"><a aria-hidden="true" href="#cb40-2" tabindex="-1"></a>                      HeapTuple newtup<span class="op">,</span> CommandId cid<span class="op">,</span></span>
<span id="cb40-3"><a aria-hidden="true" href="#cb40-3" tabindex="-1"></a>                      Snapshot crosscheck<span class="op">,</span> <span class="dt">bool</span> wait<span class="op">,</span></span>
<span id="cb40-4"><a aria-hidden="true" href="#cb40-4" tabindex="-1"></a>                      TM_FailureData <span class="op">*</span>tmfd<span class="op">,</span> LockTupleMode <span class="op">*</span>lockmode<span class="op">);</span></span></code></pre></div>
<p><strong>Update strategies:</strong></p>
<p><strong>1. HOT Update (Heap-Only Tuple)</strong></p>
<p>When new tuple fits on same page AND no indexed columns changed:</p>
<pre><code>Old Tuple                New Tuple
+--------+              +--------+
| t_xmin | -----------&gt; | t_xmin | (new)
| t_xmax | (current)    | t_xmax | (0)
| t_ctid | -----------&gt; | t_ctid | (self-ref)
+--------+              +--------+
   ‚Üë                        ‚Üë
   |                        |
Line Ptr 1              Line Ptr 2
(LP_REDIRECT)           (LP_NORMAL)</code></pre>
<p><strong>Benefits:</strong> - No index updates needed (huge
performance win) - Reduced bloat - Faster VACUUM</p>
<p><strong>Requirements:</strong> - Enough space on same page - No
indexed columns modified - Page not full of redirect pointers</p>
<p><strong>2. Normal Update</strong></p>
<p>When HOT not possible:</p>
<ol type="1">
<li>Insert new tuple (possibly on different page)</li>
<li>Update all indexes to point to new tuple</li>
<li>Set old tuple‚Äôs t_xmax to current XID</li>
<li>Set old tuple‚Äôs t_ctid to point to new tuple</li>
</ol>
<h4 data-number="3.5.5.4" id="deleting-tuples"><span class="header-section-number">3.5.5.4</span> Deleting Tuples</h4>
<div class="sourceCode" id="cb42"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb42-1"><a aria-hidden="true" href="#cb42-1" tabindex="-1"></a>TM_Result heap_delete<span class="op">(</span>Relation relation<span class="op">,</span> ItemPointer tid<span class="op">,</span></span>
<span id="cb42-2"><a aria-hidden="true" href="#cb42-2" tabindex="-1"></a>                      CommandId cid<span class="op">,</span> Snapshot crosscheck<span class="op">,</span></span>
<span id="cb42-3"><a aria-hidden="true" href="#cb42-3" tabindex="-1"></a>                      <span class="dt">bool</span> wait<span class="op">,</span> TM_FailureData <span class="op">*</span>tmfd<span class="op">,</span></span>
<span id="cb42-4"><a aria-hidden="true" href="#cb42-4" tabindex="-1"></a>                      <span class="dt">bool</span> changingPart<span class="op">);</span></span></code></pre></div>
<p><strong>Delete process:</strong></p>
<ol type="1">
<li><strong>Fetch tuple</strong> using TID</li>
<li><strong>Check visibility</strong>: Ensure tuple is visible and not
locked</li>
<li><strong>Mark deleted</strong>:
<ul>
<li>Set t_xmax to current transaction ID</li>
<li>Set HEAP_UPDATED flag in t_infomask</li>
</ul></li>
<li><strong>Write WAL record</strong></li>
<li><strong>Update indexes</strong>: Mark entries as dead</li>
</ol>
<p><strong>Actual space reclamation</strong> happens later during
VACUUM.</p>
<h3 data-number="3.5.6" id="hot-heap-only-tuple-updates"><span class="header-section-number">3.5.6</span> HOT (Heap-Only Tuple)
Updates</h3>
<p>HOT is one of PostgreSQL‚Äôs most important performance optimizations,
introduced in version 8.3.</p>
<p><strong>Problem HOT solves:</strong></p>
<p>Traditional updates require: - New heap tuple - Update every index
(expensive for tables with many indexes) - Bloat in indexes and heap</p>
<p><strong>HOT solution:</strong></p>
<p>When conditions allow, keep old and new tuple versions on same page
with a redirect pointer, avoiding index updates.</p>
<p><strong>HOT chain example:</strong></p>
<pre><code>Page N
+------------------+
| Item Ptr 1       | ‚Üí LP_REDIRECT ‚Üí Item Ptr 3
| Item Ptr 2       | ‚Üí LP_NORMAL ‚Üí Old Tuple (dead)
| Item Ptr 3       | ‚Üí LP_NORMAL ‚Üí New Tuple (current)
+------------------+
         ‚Üë
         |
    Index Entry
    (unchanged)</code></pre>
<p><strong>Index still points to Item Ptr 1</strong>, which redirects to
Item Ptr 3 (current tuple). No index update needed!</p>
<p><strong>HOT pruning:</strong></p>
<p><code>heap_page_prune()</code> cleans up HOT chains: - Removes dead
tuples in middle of chain - Collapses redirect pointers - Reclaims space
within page</p>
<p><strong>Statistics:</strong></p>
<div class="sourceCode" id="cb44"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb44-1"><a aria-hidden="true" href="#cb44-1" tabindex="-1"></a><span class="kw">SELECT</span> n_tup_upd, n_tup_hot_upd,</span>
<span id="cb44-2"><a aria-hidden="true" href="#cb44-2" tabindex="-1"></a>       n_tup_hot_upd:<span class="ch">:float</span> <span class="op">/</span> <span class="fu">nullif</span>(n_tup_upd, <span class="dv">0</span>) <span class="kw">AS</span> hot_ratio</span>
<span id="cb44-3"><a aria-hidden="true" href="#cb44-3" tabindex="-1"></a><span class="kw">FROM</span> pg_stat_user_tables</span>
<span id="cb44-4"><a aria-hidden="true" href="#cb44-4" tabindex="-1"></a><span class="kw">WHERE</span> schemaname <span class="op">=</span> <span class="st">'public'</span>;</span></code></pre></div>
<p>High HOT ratio (close to 1.0) indicates efficient updates.</p>
<h3 data-number="3.5.7" id="tuple-locking"><span class="header-section-number">3.5.7</span> Tuple Locking</h3>
<p>PostgreSQL supports row-level locking for SELECT FOR
UPDATE/SHARE:</p>
<p><strong>Lock modes:</strong> - <strong>FOR KEY SHARE</strong>:
Weakest, blocks UPDATE of key columns - <strong>FOR SHARE</strong>:
Blocks UPDATE and DELETE - <strong>FOR NO KEY UPDATE</strong>: Blocks
UPDATE of key columns and DELETE - <strong>FOR UPDATE</strong>:
Strongest, blocks all concurrent modifications</p>
<p><strong>Implementation:</strong></p>
<p>Locks stored in tuple header‚Äôs t_xmax field: - For single locker:
t_xmax contains locker‚Äôs XID - For multiple lockers: t_xmax contains
MultiXactId</p>
<p><strong>MultiXactId:</strong></p>
<div class="sourceCode" id="cb45"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb45-1"><a aria-hidden="true" href="#cb45-1" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> MultiXactMember</span>
<span id="cb45-2"><a aria-hidden="true" href="#cb45-2" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb45-3"><a aria-hidden="true" href="#cb45-3" tabindex="-1"></a>    TransactionId xid<span class="op">;</span></span>
<span id="cb45-4"><a aria-hidden="true" href="#cb45-4" tabindex="-1"></a>    MultiXactStatus status<span class="op">;</span>  <span class="co">/* lock mode */</span></span>
<span id="cb45-5"><a aria-hidden="true" href="#cb45-5" tabindex="-1"></a><span class="op">}</span> MultiXactMember<span class="op">;</span></span></code></pre></div>
<p>Allows multiple transactions to hold compatible locks on same
tuple.</p>
<h3 data-number="3.5.8" id="heap-file-organization"><span class="header-section-number">3.5.8</span> Heap File Organization</h3>
<p>Heap relations are stored as files in
<code>$PGDATA/base/&lt;database_oid&gt;/</code>:</p>
<pre><code>&lt;relation_oid&gt;      - Main data fork
&lt;relation_oid&gt;_fsm  - Free Space Map fork
&lt;relation_oid&gt;_vm   - Visibility Map fork
&lt;relation_oid&gt;_init - Initialization fork (for unlogged tables)</code></pre>
<p><strong>Forks:</strong></p>
<div class="sourceCode" id="cb47"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb47-1"><a aria-hidden="true" href="#cb47-1" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">enum</span> ForkNumber</span>
<span id="cb47-2"><a aria-hidden="true" href="#cb47-2" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb47-3"><a aria-hidden="true" href="#cb47-3" tabindex="-1"></a>    MAIN_FORKNUM <span class="op">=</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb47-4"><a aria-hidden="true" href="#cb47-4" tabindex="-1"></a>    FSM_FORKNUM<span class="op">,</span></span>
<span id="cb47-5"><a aria-hidden="true" href="#cb47-5" tabindex="-1"></a>    VISIBILITYMAP_FORKNUM<span class="op">,</span></span>
<span id="cb47-6"><a aria-hidden="true" href="#cb47-6" tabindex="-1"></a>    INIT_FORKNUM</span>
<span id="cb47-7"><a aria-hidden="true" href="#cb47-7" tabindex="-1"></a><span class="op">}</span> ForkNumber<span class="op">;</span></span></code></pre></div>
<h3 data-number="3.5.9" id="heap-statistics-and-monitoring"><span class="header-section-number">3.5.9</span> Heap Statistics and
Monitoring</h3>
<div class="sourceCode" id="cb48"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb48-1"><a aria-hidden="true" href="#cb48-1" tabindex="-1"></a><span class="co">-- Table size</span></span>
<span id="cb48-2"><a aria-hidden="true" href="#cb48-2" tabindex="-1"></a><span class="kw">SELECT</span> pg_size_pretty(pg_total_relation_size(<span class="st">'tablename'</span>));</span>
<span id="cb48-3"><a aria-hidden="true" href="#cb48-3" tabindex="-1"></a></span>
<span id="cb48-4"><a aria-hidden="true" href="#cb48-4" tabindex="-1"></a><span class="co">-- Live vs dead tuples</span></span>
<span id="cb48-5"><a aria-hidden="true" href="#cb48-5" tabindex="-1"></a><span class="kw">SELECT</span> relname, n_live_tup, n_dead_tup,</span>
<span id="cb48-6"><a aria-hidden="true" href="#cb48-6" tabindex="-1"></a>       <span class="fu">round</span>(n_dead_tup:<span class="ch">:numeric</span> <span class="op">/</span> <span class="fu">nullif</span>(n_live_tup, <span class="dv">0</span>), <span class="dv">4</span>) <span class="kw">AS</span> dead_ratio</span>
<span id="cb48-7"><a aria-hidden="true" href="#cb48-7" tabindex="-1"></a><span class="kw">FROM</span> pg_stat_user_tables</span>
<span id="cb48-8"><a aria-hidden="true" href="#cb48-8" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> n_dead_tup <span class="kw">DESC</span>;</span>
<span id="cb48-9"><a aria-hidden="true" href="#cb48-9" tabindex="-1"></a></span>
<span id="cb48-10"><a aria-hidden="true" href="#cb48-10" tabindex="-1"></a><span class="co">-- Last vacuum/analyze</span></span>
<span id="cb48-11"><a aria-hidden="true" href="#cb48-11" tabindex="-1"></a><span class="kw">SELECT</span> relname, last_vacuum, last_autovacuum,</span>
<span id="cb48-12"><a aria-hidden="true" href="#cb48-12" tabindex="-1"></a>       last_analyze, last_autoanalyze</span>
<span id="cb48-13"><a aria-hidden="true" href="#cb48-13" tabindex="-1"></a><span class="kw">FROM</span> pg_stat_user_tables;</span></code></pre></div>
<h3 data-number="3.5.10" id="heap-access-method-api"><span class="header-section-number">3.5.10</span> Heap Access Method API</h3>
<p>PostgreSQL 12+ introduced a pluggable table access method API:</p>
<div class="sourceCode" id="cb49"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb49-1"><a aria-hidden="true" href="#cb49-1" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> TableAmRoutine</span>
<span id="cb49-2"><a aria-hidden="true" href="#cb49-2" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb49-3"><a aria-hidden="true" href="#cb49-3" tabindex="-1"></a>    <span class="co">/* Scan operations */</span></span>
<span id="cb49-4"><a aria-hidden="true" href="#cb49-4" tabindex="-1"></a>    TableScanDesc <span class="op">(*</span>scan_begin<span class="op">)</span> <span class="op">(...);</span></span>
<span id="cb49-5"><a aria-hidden="true" href="#cb49-5" tabindex="-1"></a>    <span class="dt">bool</span> <span class="op">(*</span>scan_getnextslot<span class="op">)</span> <span class="op">(...);</span></span>
<span id="cb49-6"><a aria-hidden="true" href="#cb49-6" tabindex="-1"></a>    <span class="dt">void</span> <span class="op">(*</span>scan_end<span class="op">)</span> <span class="op">(...);</span></span>
<span id="cb49-7"><a aria-hidden="true" href="#cb49-7" tabindex="-1"></a></span>
<span id="cb49-8"><a aria-hidden="true" href="#cb49-8" tabindex="-1"></a>    <span class="co">/* Tuple operations */</span></span>
<span id="cb49-9"><a aria-hidden="true" href="#cb49-9" tabindex="-1"></a>    <span class="dt">void</span> <span class="op">(*</span>tuple_insert<span class="op">)</span> <span class="op">(...);</span></span>
<span id="cb49-10"><a aria-hidden="true" href="#cb49-10" tabindex="-1"></a>    TM_Result <span class="op">(*</span>tuple_update<span class="op">)</span> <span class="op">(...);</span></span>
<span id="cb49-11"><a aria-hidden="true" href="#cb49-11" tabindex="-1"></a>    TM_Result <span class="op">(*</span>tuple_delete<span class="op">)</span> <span class="op">(...);</span></span>
<span id="cb49-12"><a aria-hidden="true" href="#cb49-12" tabindex="-1"></a></span>
<span id="cb49-13"><a aria-hidden="true" href="#cb49-13" tabindex="-1"></a>    <span class="co">/* ... many more operations */</span></span>
<span id="cb49-14"><a aria-hidden="true" href="#cb49-14" tabindex="-1"></a><span class="op">}</span> TableAmRoutine<span class="op">;</span></span></code></pre></div>
<p>This allows alternative storage engines (e.g., columnar storage,
in-memory tables) while maintaining compatibility with PostgreSQL‚Äôs
query processing.</p>
<h3 data-number="3.5.11" id="performance-considerations"><span class="header-section-number">3.5.11</span> Performance
Considerations</h3>
<p><strong>Fill factor:</strong></p>
<div class="sourceCode" id="cb50"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb50-1"><a aria-hidden="true" href="#cb50-1" tabindex="-1"></a><span class="kw">ALTER</span> <span class="kw">TABLE</span> tablename <span class="kw">SET</span> (fillfactor <span class="op">=</span> <span class="dv">90</span>);</span></code></pre></div>
<p>Reserves space on each page for HOT updates: - Default: 100 (no
reserved space) - Recommendation: 90 for frequently updated tables -
Trade-off: Slightly larger table vs.¬†better update performance</p>
<p><strong>VACUUM and bloat:</strong></p>
<p>Regular VACUUM is essential: - Reclaims dead tuple space - Updates
FSM and VM - Prevents transaction ID wraparound - Improves query
performance</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb51-1"><a aria-hidden="true" href="#cb51-1" tabindex="-1"></a><span class="co">-- Estimate bloat</span></span>
<span id="cb51-2"><a aria-hidden="true" href="#cb51-2" tabindex="-1"></a><span class="kw">SELECT</span> schemaname, tablename,</span>
<span id="cb51-3"><a aria-hidden="true" href="#cb51-3" tabindex="-1"></a>       pg_size_pretty(pg_total_relation_size(schemaname<span class="op">||</span><span class="st">'.'</span><span class="op">||</span>tablename)) <span class="kw">AS</span> <span class="kw">size</span>,</span>
<span id="cb51-4"><a aria-hidden="true" href="#cb51-4" tabindex="-1"></a>       <span class="fu">round</span>((<span class="cf">CASE</span> <span class="cf">WHEN</span> otta<span class="op">=</span><span class="dv">0</span> <span class="cf">THEN</span> <span class="fl">0.0</span> <span class="cf">ELSE</span> sml.relpages<span class="op">/</span>otta:<span class="ch">:numeric</span> <span class="cf">END</span>):<span class="ch">:numeric</span>, <span class="dv">1</span>) <span class="kw">AS</span> tbloat</span>
<span id="cb51-5"><a aria-hidden="true" href="#cb51-5" tabindex="-1"></a><span class="kw">FROM</span> (</span>
<span id="cb51-6"><a aria-hidden="true" href="#cb51-6" tabindex="-1"></a>  <span class="kw">SELECT</span> schemaname, tablename, cc.relpages, bs,</span>
<span id="cb51-7"><a aria-hidden="true" href="#cb51-7" tabindex="-1"></a>         <span class="fu">CEIL</span>((cc.reltuples<span class="op">*</span>((datahdr<span class="op">+</span>ma<span class="op">-</span>(<span class="cf">CASE</span> <span class="cf">WHEN</span> datahdr%ma<span class="op">=</span><span class="dv">0</span> <span class="cf">THEN</span> ma <span class="cf">ELSE</span> datahdr%ma <span class="cf">END</span>))<span class="op">+</span>nullhdr2<span class="op">+</span><span class="dv">4</span>))<span class="op">/</span>(bs<span class="op">-</span><span class="dv">20</span>:<span class="ch">:float</span>)) <span class="kw">AS</span> otta</span>
<span id="cb51-8"><a aria-hidden="true" href="#cb51-8" tabindex="-1"></a>  <span class="kw">FROM</span> (</span>
<span id="cb51-9"><a aria-hidden="true" href="#cb51-9" tabindex="-1"></a>    <span class="kw">SELECT</span> schemaname, tablename, reltuples, relpages,</span>
<span id="cb51-10"><a aria-hidden="true" href="#cb51-10" tabindex="-1"></a>           (datawidth<span class="op">+</span>(hdr<span class="op">+</span>ma<span class="op">-</span>(<span class="cf">case</span> <span class="cf">when</span> hdr%ma<span class="op">=</span><span class="dv">0</span> <span class="cf">THEN</span> ma <span class="cf">ELSE</span> hdr%ma <span class="cf">END</span>))):<span class="ch">:numeric</span> <span class="kw">AS</span> datahdr,</span>
<span id="cb51-11"><a aria-hidden="true" href="#cb51-11" tabindex="-1"></a>           (maxfracsum<span class="op">*</span>(nullhdr<span class="op">+</span>ma<span class="op">-</span>(<span class="cf">case</span> <span class="cf">when</span> nullhdr%ma<span class="op">=</span><span class="dv">0</span> <span class="cf">THEN</span> ma <span class="cf">ELSE</span> nullhdr%ma <span class="cf">END</span>))) <span class="kw">AS</span> nullhdr2</span>
<span id="cb51-12"><a aria-hidden="true" href="#cb51-12" tabindex="-1"></a>    <span class="kw">FROM</span> (</span>
<span id="cb51-13"><a aria-hidden="true" href="#cb51-13" tabindex="-1"></a>      <span class="kw">SELECT</span> schemaname, tablename, hdr, ma, bs, reltuples, relpages,</span>
<span id="cb51-14"><a aria-hidden="true" href="#cb51-14" tabindex="-1"></a>             <span class="fu">SUM</span>((<span class="dv">1</span><span class="op">-</span>null_frac)<span class="op">*</span>avg_width) <span class="kw">AS</span> datawidth,</span>
<span id="cb51-15"><a aria-hidden="true" href="#cb51-15" tabindex="-1"></a>             <span class="fu">MAX</span>(null_frac) <span class="kw">AS</span> maxfracsum,</span>
<span id="cb51-16"><a aria-hidden="true" href="#cb51-16" tabindex="-1"></a>             hdr<span class="op">+</span>(</span>
<span id="cb51-17"><a aria-hidden="true" href="#cb51-17" tabindex="-1"></a>               <span class="kw">SELECT</span> <span class="dv">1</span><span class="op">+</span><span class="fu">count</span>(<span class="op">*</span>)<span class="op">/</span><span class="dv">8</span></span>
<span id="cb51-18"><a aria-hidden="true" href="#cb51-18" tabindex="-1"></a>               <span class="kw">FROM</span> pg_stats s2</span>
<span id="cb51-19"><a aria-hidden="true" href="#cb51-19" tabindex="-1"></a>               <span class="kw">WHERE</span> null_frac<span class="op">&lt;&gt;</span><span class="dv">0</span> <span class="kw">AND</span> s2.schemaname <span class="op">=</span> s.schemaname <span class="kw">AND</span> s2.tablename <span class="op">=</span> s.tablename</span>
<span id="cb51-20"><a aria-hidden="true" href="#cb51-20" tabindex="-1"></a>             ) <span class="kw">AS</span> nullhdr</span>
<span id="cb51-21"><a aria-hidden="true" href="#cb51-21" tabindex="-1"></a>      <span class="kw">FROM</span> pg_stats s, (<span class="kw">SELECT</span> current_setting(<span class="st">'block_size'</span>):<span class="ch">:numeric</span> <span class="kw">AS</span> bs, <span class="dv">23</span> <span class="kw">AS</span> hdr, <span class="dv">8</span> <span class="kw">AS</span> ma) <span class="kw">AS</span> constants</span>
<span id="cb51-22"><a aria-hidden="true" href="#cb51-22" tabindex="-1"></a>      <span class="kw">GROUP</span> <span class="kw">BY</span> <span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>,<span class="dv">5</span>,<span class="dv">6</span>,<span class="dv">7</span></span>
<span id="cb51-23"><a aria-hidden="true" href="#cb51-23" tabindex="-1"></a>    ) <span class="kw">AS</span> foo</span>
<span id="cb51-24"><a aria-hidden="true" href="#cb51-24" tabindex="-1"></a>  ) <span class="kw">AS</span> rs</span>
<span id="cb51-25"><a aria-hidden="true" href="#cb51-25" tabindex="-1"></a>  <span class="kw">JOIN</span> pg_class cc <span class="kw">ON</span> cc.relname <span class="op">=</span> rs.tablename</span>
<span id="cb51-26"><a aria-hidden="true" href="#cb51-26" tabindex="-1"></a>  <span class="kw">JOIN</span> pg_namespace nn <span class="kw">ON</span> cc.relnamespace <span class="op">=</span> nn.<span class="kw">oid</span> <span class="kw">AND</span> nn.nspname <span class="op">=</span> rs.schemaname</span>
<span id="cb51-27"><a aria-hidden="true" href="#cb51-27" tabindex="-1"></a>) <span class="kw">AS</span> sml</span>
<span id="cb51-28"><a aria-hidden="true" href="#cb51-28" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> tbloat <span class="kw">DESC</span>;</span></code></pre></div>
<h2 data-number="3.6" id="write-ahead-logging"><span class="header-section-number">3.6</span> Write-Ahead Logging</h2>
<h3 data-number="3.6.1" id="overview-3"><span class="header-section-number">3.6.1</span> Overview</h3>
<p>Write-Ahead Logging (WAL) is the cornerstone of PostgreSQL‚Äôs
reliability and recovery mechanisms. Implemented primarily in
<code>src/backend/access/transam/xlog.c</code> (9,584 lines), WAL
ensures that all changes to the database can be recovered after a crash
and provides the foundation for replication.</p>
<p>The WAL protocol follows a simple but powerful principle:
<strong>write the change log to persistent storage before applying
changes to data files</strong>. This guarantees that if the system
crashes, we can replay the log to reconstruct the database state.</p>
<h3 data-number="3.6.2" id="wal-principles"><span class="header-section-number">3.6.2</span> WAL Principles</h3>
<p><strong>The WAL Rule:</strong></p>
<pre><code>Before a data page is written to permanent storage:
1. All log records describing changes to that page must be written to disk
2. This is enforced by checking the page's LSN against flushed WAL position</code></pre>
<p><strong>Benefits:</strong></p>
<ol type="1">
<li><strong>Crash Recovery</strong>: Database can be restored to
consistent state</li>
<li><strong>Performance</strong>: Transforms random writes into
sequential writes</li>
<li><strong>Durability</strong>: ACID compliance with guaranteed
persistence</li>
<li><strong>Replication</strong>: WAL stream enables physical
replication</li>
<li><strong>Point-in-Time Recovery</strong>: Archive logs allow recovery
to any past moment</li>
</ol>
<h3 data-number="3.6.3" id="lsn-log-sequence-number"><span class="header-section-number">3.6.3</span> LSN (Log Sequence
Number)</h3>
<p>Every byte in the WAL stream has a unique identifier called an
LSN:</p>
<div class="sourceCode" id="cb53"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb53-1"><a aria-hidden="true" href="#cb53-1" tabindex="-1"></a><span class="kw">typedef</span> uint64 XLogRecPtr<span class="op">;</span>  <span class="co">/* Also called LSN */</span></span></code></pre></div>
<p><strong>LSN structure:</strong></p>
<ul>
<li>64-bit unsigned integer</li>
<li>Represents byte offset in the logical WAL stream</li>
<li>Lower 32 bits: offset within a WAL segment</li>
<li>Upper 32 bits: segment number</li>
</ul>
<p><strong>Example:</strong></p>
<pre><code>LSN: 0x0/16C4000
     ‚Üë  ‚Üë
     |  +-- Offset within segment
     +----- Segment number</code></pre>
<p>Every page header contains the LSN of the last WAL record that
modified it (<code>pd_lsn</code>).</p>
<h3 data-number="3.6.4" id="wal-record-structure"><span class="header-section-number">3.6.4</span> WAL Record Structure</h3>
<p>WAL records have a header followed by data:</p>
<div class="sourceCode" id="cb55"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb55-1"><a aria-hidden="true" href="#cb55-1" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> XLogRecord</span>
<span id="cb55-2"><a aria-hidden="true" href="#cb55-2" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb55-3"><a aria-hidden="true" href="#cb55-3" tabindex="-1"></a>    uint32      xl_tot_len<span class="op">;</span>     <span class="co">/* total record length */</span></span>
<span id="cb55-4"><a aria-hidden="true" href="#cb55-4" tabindex="-1"></a>    TransactionId xl_xid<span class="op">;</span>       <span class="co">/* xact id */</span></span>
<span id="cb55-5"><a aria-hidden="true" href="#cb55-5" tabindex="-1"></a>    XLogRecPtr  xl_prev<span class="op">;</span>        <span class="co">/* ptr to previous record */</span></span>
<span id="cb55-6"><a aria-hidden="true" href="#cb55-6" tabindex="-1"></a>    uint8       xl_info<span class="op">;</span>        <span class="co">/* flag bits */</span></span>
<span id="cb55-7"><a aria-hidden="true" href="#cb55-7" tabindex="-1"></a>    RmgrId      xl_rmid<span class="op">;</span>        <span class="co">/* resource manager ID */</span></span>
<span id="cb55-8"><a aria-hidden="true" href="#cb55-8" tabindex="-1"></a>    uint32      xl_crc<span class="op">;</span>         <span class="co">/* CRC for entire record */</span></span>
<span id="cb55-9"><a aria-hidden="true" href="#cb55-9" tabindex="-1"></a></span>
<span id="cb55-10"><a aria-hidden="true" href="#cb55-10" tabindex="-1"></a>    <span class="co">/* Followed by variable-length data */</span></span>
<span id="cb55-11"><a aria-hidden="true" href="#cb55-11" tabindex="-1"></a><span class="op">}</span> XLogRecord<span class="op">;</span></span></code></pre></div>
<p><strong>Resource Managers (RmgrId):</strong></p>
<p>PostgreSQL has different resource managers for different
subsystems:</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb56-1"><a aria-hidden="true" href="#cb56-1" tabindex="-1"></a><span class="co">/* Some key resource managers */</span></span>
<span id="cb56-2"><a aria-hidden="true" href="#cb56-2" tabindex="-1"></a><span class="pp">#define RM_XLOG_ID          </span><span class="dv">0</span><span class="pp">   </span><span class="co">/* WAL management */</span></span>
<span id="cb56-3"><a aria-hidden="true" href="#cb56-3" tabindex="-1"></a><span class="pp">#define RM_XACT_ID          </span><span class="dv">1</span><span class="pp">   </span><span class="co">/* Transaction commit/abort */</span></span>
<span id="cb56-4"><a aria-hidden="true" href="#cb56-4" tabindex="-1"></a><span class="pp">#define RM_SMGR_ID          </span><span class="dv">2</span><span class="pp">   </span><span class="co">/* Storage manager */</span></span>
<span id="cb56-5"><a aria-hidden="true" href="#cb56-5" tabindex="-1"></a><span class="pp">#define RM_HEAP_ID          </span><span class="dv">10</span><span class="pp">  </span><span class="co">/* Heap operations */</span></span>
<span id="cb56-6"><a aria-hidden="true" href="#cb56-6" tabindex="-1"></a><span class="pp">#define RM_BTREE_ID         </span><span class="dv">11</span><span class="pp">  </span><span class="co">/* B-tree operations */</span></span>
<span id="cb56-7"><a aria-hidden="true" href="#cb56-7" tabindex="-1"></a><span class="pp">#define RM_HASH_ID          </span><span class="dv">12</span><span class="pp">  </span><span class="co">/* Hash index operations */</span></span>
<span id="cb56-8"><a aria-hidden="true" href="#cb56-8" tabindex="-1"></a><span class="pp">#define RM_GIN_ID           </span><span class="dv">13</span><span class="pp">  </span><span class="co">/* GIN index operations */</span></span>
<span id="cb56-9"><a aria-hidden="true" href="#cb56-9" tabindex="-1"></a><span class="pp">#define RM_GIST_ID          </span><span class="dv">14</span><span class="pp">  </span><span class="co">/* GiST index operations */</span></span>
<span id="cb56-10"><a aria-hidden="true" href="#cb56-10" tabindex="-1"></a><span class="pp">#define RM_SEQ_ID           </span><span class="dv">15</span><span class="pp">  </span><span class="co">/* Sequences */</span></span></code></pre></div>
<p>Each resource manager provides: - <code>redo()</code>: Function to
replay WAL record during recovery - <code>desc()</code>: Function to
describe record (for debugging) - <code>identify()</code>: String
identifier - <code>startup()</code>, <code>cleanup()</code>: Recovery
lifecycle hooks</p>
<h3 data-number="3.6.5" id="wal-record-types"><span class="header-section-number">3.6.5</span> WAL Record Types</h3>
<p><strong>Heap operations:</strong></p>
<div class="sourceCode" id="cb57"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb57-1"><a aria-hidden="true" href="#cb57-1" tabindex="-1"></a><span class="pp">#define XLOG_HEAP_INSERT    </span><span class="bn">0x00</span></span>
<span id="cb57-2"><a aria-hidden="true" href="#cb57-2" tabindex="-1"></a><span class="pp">#define XLOG_HEAP_DELETE    </span><span class="bn">0x10</span></span>
<span id="cb57-3"><a aria-hidden="true" href="#cb57-3" tabindex="-1"></a><span class="pp">#define XLOG_HEAP_UPDATE    </span><span class="bn">0x20</span></span>
<span id="cb57-4"><a aria-hidden="true" href="#cb57-4" tabindex="-1"></a><span class="pp">#define XLOG_HEAP_HOT_UPDATE </span><span class="bn">0x30</span></span>
<span id="cb57-5"><a aria-hidden="true" href="#cb57-5" tabindex="-1"></a><span class="pp">#define XLOG_HEAP_LOCK      </span><span class="bn">0x50</span></span></code></pre></div>
<p><strong>Transaction operations:</strong></p>
<div class="sourceCode" id="cb58"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb58-1"><a aria-hidden="true" href="#cb58-1" tabindex="-1"></a><span class="pp">#define XLOG_XACT_COMMIT    </span><span class="bn">0x00</span></span>
<span id="cb58-2"><a aria-hidden="true" href="#cb58-2" tabindex="-1"></a><span class="pp">#define XLOG_XACT_ABORT     </span><span class="bn">0x20</span></span></code></pre></div>
<p><strong>B-tree operations:</strong></p>
<div class="sourceCode" id="cb59"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb59-1"><a aria-hidden="true" href="#cb59-1" tabindex="-1"></a><span class="pp">#define XLOG_BTREE_INSERT_LEAF   </span><span class="bn">0x00</span></span>
<span id="cb59-2"><a aria-hidden="true" href="#cb59-2" tabindex="-1"></a><span class="pp">#define XLOG_BTREE_INSERT_UPPER  </span><span class="bn">0x10</span></span>
<span id="cb59-3"><a aria-hidden="true" href="#cb59-3" tabindex="-1"></a><span class="pp">#define XLOG_BTREE_SPLIT_L       </span><span class="bn">0x20</span></span>
<span id="cb59-4"><a aria-hidden="true" href="#cb59-4" tabindex="-1"></a><span class="pp">#define XLOG_BTREE_DELETE        </span><span class="bn">0x40</span></span></code></pre></div>
<h3 data-number="3.6.6" id="wal-buffer-and-writing"><span class="header-section-number">3.6.6</span> WAL Buffer and Writing</h3>
<p>WAL records are first written to shared WAL buffers:</p>
<div class="sourceCode" id="cb60"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb60-1"><a aria-hidden="true" href="#cb60-1" tabindex="-1"></a><span class="co">/* Configured via wal_buffers (default: 1/32 of shared_buffers, min 64KB) */</span></span>
<span id="cb60-2"><a aria-hidden="true" href="#cb60-2" tabindex="-1"></a><span class="dt">static</span> <span class="dt">char</span> <span class="op">*</span>XLogCtl<span class="op">-&gt;</span>pages<span class="op">;</span>  <span class="co">/* WAL buffer space */</span></span></code></pre></div>
<p><strong>Write process:</strong></p>
<ol type="1">
<li><strong>Backend generates WAL record</strong> for data
modification</li>
<li><strong>Acquire WAL insertion lock</strong></li>
<li><strong>Copy WAL record to WAL buffer</strong></li>
<li><strong>Release WAL insertion lock</strong></li>
<li><strong>At commit or when buffer fills</strong>: Flush WAL to
disk</li>
<li><strong>Return success</strong> only after WAL is on disk (for
durable commits)</li>
</ol>
<p><strong>WAL Writer Process:</strong></p>
<p>Background process that periodically flushes WAL buffers:</p>
<div class="sourceCode" id="cb61"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb61-1"><a aria-hidden="true" href="#cb61-1" tabindex="-1"></a><span class="co">/* Configuration */</span></span>
<span id="cb61-2"><a aria-hidden="true" href="#cb61-2" tabindex="-1"></a>wal_writer_delay <span class="op">=</span> <span class="dv">200</span><span class="er">ms</span>     <span class="co">/* How often WAL writer wakes up */</span></span>
<span id="cb61-3"><a aria-hidden="true" href="#cb61-3" tabindex="-1"></a>wal_writer_flush_after <span class="op">=</span> <span class="dv">1</span><span class="er">MB</span> <span class="co">/* Write and flush if this much unflushed */</span></span></code></pre></div>
<h3 data-number="3.6.7" id="wal-files-and-segments"><span class="header-section-number">3.6.7</span> WAL Files and Segments</h3>
<p>WAL is stored in files in <code>$PGDATA/pg_wal/</code>:</p>
<pre><code>pg_wal/
  00000001000000000000000A
  00000001000000000000000B
  00000001000000000000000C
  ...</code></pre>
<p><strong>File naming:</strong></p>
<pre><code>TTTTTTTTXXXXXXXXYYYYYYYY
|       |       |
|       |       +-- Segment number within timeline (256MB each)
|       +---------- Upper 32 bits of LSN
+------------------ Timeline ID</code></pre>
<p><strong>WAL segment size</strong>: 16MB by default (configurable at
initdb)</p>
<p><strong>WAL recycling</strong>: Old segments are renamed and reused
rather than deleted</p>
<h3 data-number="3.6.8" id="full-page-writes-fpw"><span class="header-section-number">3.6.8</span> Full Page Writes (FPW)</h3>
<p><strong>The torn page problem:</strong></p>
<p>If the system crashes during a partial page write (e.g., 8KB write
but only 4KB made it to disk), the page is corrupted.</p>
<p><strong>Solution: Full Page Writes</strong></p>
<p>After each checkpoint, the first modification to a page writes the
<strong>entire page</strong> to WAL:</p>
<div class="sourceCode" id="cb64"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb64-1"><a aria-hidden="true" href="#cb64-1" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> BkpBlock</span>
<span id="cb64-2"><a aria-hidden="true" href="#cb64-2" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb64-3"><a aria-hidden="true" href="#cb64-3" tabindex="-1"></a>    RelFileNode node<span class="op">;</span>      <span class="co">/* which relation */</span></span>
<span id="cb64-4"><a aria-hidden="true" href="#cb64-4" tabindex="-1"></a>    ForkNumber  fork<span class="op">;</span>      <span class="co">/* which fork */</span></span>
<span id="cb64-5"><a aria-hidden="true" href="#cb64-5" tabindex="-1"></a>    BlockNumber block<span class="op">;</span>     <span class="co">/* which block */</span></span>
<span id="cb64-6"><a aria-hidden="true" href="#cb64-6" tabindex="-1"></a>    uint16      hole_offset<span class="op">;</span>  <span class="co">/* hole start offset */</span></span>
<span id="cb64-7"><a aria-hidden="true" href="#cb64-7" tabindex="-1"></a>    uint16      hole_length<span class="op">;</span>  <span class="co">/* hole length */</span></span>
<span id="cb64-8"><a aria-hidden="true" href="#cb64-8" tabindex="-1"></a>    <span class="co">/* Followed by full page image (minus any hole) */</span></span>
<span id="cb64-9"><a aria-hidden="true" href="#cb64-9" tabindex="-1"></a><span class="op">}</span> BkpBlock<span class="op">;</span></span></code></pre></div>
<p><strong>Optimization - hole punching:</strong></p>
<p>Most pages have free space in the middle. WAL records only the data
before and after the hole, saving space.</p>
<p><strong>Configuration:</strong></p>
<pre><code>full_page_writes = on  /* Default and strongly recommended */</code></pre>
<p>Disabling is dangerous but might be acceptable with reliable storage
(battery-backed write cache).</p>
<h3 data-number="3.6.9" id="checkpoints"><span class="header-section-number">3.6.9</span> Checkpoints</h3>
<p>A checkpoint is a known good state from which recovery can start:</p>
<p><strong>Checkpoint process:</strong></p>
<ol type="1">
<li><strong>Write all dirty buffers</strong> to disk</li>
<li><strong>Write a checkpoint record</strong> to WAL containing:
<ul>
<li>Redo pointer (WAL location where recovery should start)</li>
<li>System state (next XID, next OID, etc.)</li>
</ul></li>
<li><strong>Update pg_control</strong> file with checkpoint
location</li>
</ol>
<p><strong>Recovery then:</strong> 1. Read pg_control to find latest
checkpoint 2. Start replay from checkpoint‚Äôs redo pointer 3. Replay all
WAL records until end of WAL</p>
<p><strong>Checkpoint configuration:</strong></p>
<pre><code>checkpoint_timeout = 5min           /* Maximum time between checkpoints */
checkpoint_completion_target = 0.9  /* Spread writes over 90% of interval */
max_wal_size = 1GB                  /* Trigger checkpoint if WAL grows */
min_wal_size = 80MB                 /* Recycle WAL files below this */</code></pre>
<p><strong>Checkpoint spreading:</strong></p>
<p>To avoid I/O spikes, PostgreSQL spreads checkpoint writes over
time:</p>
<pre><code>checkpoint_completion_target = 0.9

Time: |----checkpoint_timeout = 5min----|
      |                                  |
Write:|===========(write for 4.5min)====|==| (finalize)</code></pre>
<h3 data-number="3.6.10" id="recovery-process"><span class="header-section-number">3.6.10</span> Recovery Process</h3>
<p><strong>Crash recovery</strong> (automatic on startup after
crash):</p>
<div class="sourceCode" id="cb68"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb68-1"><a aria-hidden="true" href="#cb68-1" tabindex="-1"></a><span class="co">/* src/backend/access/transam/xlog.c */</span></span>
<span id="cb68-2"><a aria-hidden="true" href="#cb68-2" tabindex="-1"></a><span class="dt">void</span> StartupXLOG<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb68-3"><a aria-hidden="true" href="#cb68-3" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb68-4"><a aria-hidden="true" href="#cb68-4" tabindex="-1"></a>    <span class="co">/* 1. Read control file */</span></span>
<span id="cb68-5"><a aria-hidden="true" href="#cb68-5" tabindex="-1"></a>    ReadControlFile<span class="op">();</span></span>
<span id="cb68-6"><a aria-hidden="true" href="#cb68-6" tabindex="-1"></a></span>
<span id="cb68-7"><a aria-hidden="true" href="#cb68-7" tabindex="-1"></a>    <span class="co">/* 2. Locate checkpoint record */</span></span>
<span id="cb68-8"><a aria-hidden="true" href="#cb68-8" tabindex="-1"></a>    record <span class="op">=</span> ReadCheckpointRecord<span class="op">(</span>CheckPointLoc<span class="op">);</span></span>
<span id="cb68-9"><a aria-hidden="true" href="#cb68-9" tabindex="-1"></a></span>
<span id="cb68-10"><a aria-hidden="true" href="#cb68-10" tabindex="-1"></a>    <span class="co">/* 3. Replay WAL from checkpoint redo point */</span></span>
<span id="cb68-11"><a aria-hidden="true" href="#cb68-11" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span>record <span class="op">=</span> ReadRecord<span class="op">(</span>RedoStartLSN<span class="op">);</span> record <span class="op">!=</span> NULL<span class="op">;</span></span>
<span id="cb68-12"><a aria-hidden="true" href="#cb68-12" tabindex="-1"></a>         record <span class="op">=</span> ReadRecord<span class="op">(</span>NextRecPtr<span class="op">))</span></span>
<span id="cb68-13"><a aria-hidden="true" href="#cb68-13" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb68-14"><a aria-hidden="true" href="#cb68-14" tabindex="-1"></a>        <span class="co">/* Apply record using appropriate resource manager */</span></span>
<span id="cb68-15"><a aria-hidden="true" href="#cb68-15" tabindex="-1"></a>        RmgrTable<span class="op">[</span>record<span class="op">-&gt;</span>xl_rmid<span class="op">].</span>rm_redo<span class="op">(</span>record<span class="op">);</span></span>
<span id="cb68-16"><a aria-hidden="true" href="#cb68-16" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb68-17"><a aria-hidden="true" href="#cb68-17" tabindex="-1"></a></span>
<span id="cb68-18"><a aria-hidden="true" href="#cb68-18" tabindex="-1"></a>    <span class="co">/* 4. Create end-of-recovery checkpoint */</span></span>
<span id="cb68-19"><a aria-hidden="true" href="#cb68-19" tabindex="-1"></a>    CreateCheckPoint<span class="op">(</span>CHECKPOINT_END_OF_RECOVERY<span class="op">);</span></span>
<span id="cb68-20"><a aria-hidden="true" href="#cb68-20" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>Point-in-Time Recovery (PITR):</strong></p>
<p>Restore from base backup and replay archived WAL:</p>
<pre><code># postgresql.conf
restore_command = 'cp /archive/%f %p'
recovery_target_time = '2025-11-19 10:00:00'</code></pre>
<h3 data-number="3.6.11" id="wal-archiving"><span class="header-section-number">3.6.11</span> WAL Archiving</h3>
<p>For PITR and replication:</p>
<pre><code># postgresql.conf
wal_level = replica              # or 'logical'
archive_mode = on
archive_command = 'cp %p /archive/%f'</code></pre>
<p><strong>WAL levels:</strong></p>
<ul>
<li><strong>minimal</strong>: Only crash recovery (no
archiving/replication)</li>
<li><strong>replica</strong>: Physical replication supported</li>
<li><strong>logical</strong>: Logical decoding/replication
supported</li>
</ul>
<h3 data-number="3.6.12" id="wal-and-replication"><span class="header-section-number">3.6.12</span> WAL and Replication</h3>
<p><strong>Streaming Replication:</strong></p>
<p>Standby servers connect and stream WAL in real-time:</p>
<ol type="1">
<li><strong>Primary</strong> sends WAL records as they‚Äôre generated</li>
<li><strong>Standby</strong> receives and replays them</li>
<li><strong>Synchronous replication</strong>: Wait for standby
acknowledgment before commit</li>
</ol>
<p><strong>Configuration:</strong></p>
<pre><code># Primary
wal_level = replica
max_wal_senders = 10
synchronous_standby_names = 'standby1'

# Standby
primary_conninfo = 'host=primary port=5432 ...'
hot_standby = on</code></pre>
<h3 data-number="3.6.13" id="wal-monitoring"><span class="header-section-number">3.6.13</span> WAL Monitoring</h3>
<div class="sourceCode" id="cb72"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb72-1"><a aria-hidden="true" href="#cb72-1" tabindex="-1"></a><span class="co">-- Current WAL position</span></span>
<span id="cb72-2"><a aria-hidden="true" href="#cb72-2" tabindex="-1"></a><span class="kw">SELECT</span> pg_current_wal_lsn();</span>
<span id="cb72-3"><a aria-hidden="true" href="#cb72-3" tabindex="-1"></a></span>
<span id="cb72-4"><a aria-hidden="true" href="#cb72-4" tabindex="-1"></a><span class="co">-- WAL generation rate</span></span>
<span id="cb72-5"><a aria-hidden="true" href="#cb72-5" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb72-6"><a aria-hidden="true" href="#cb72-6" tabindex="-1"></a>  wal_records,</span>
<span id="cb72-7"><a aria-hidden="true" href="#cb72-7" tabindex="-1"></a>  wal_fpi,  <span class="co">-- full page images</span></span>
<span id="cb72-8"><a aria-hidden="true" href="#cb72-8" tabindex="-1"></a>  wal_bytes,</span>
<span id="cb72-9"><a aria-hidden="true" href="#cb72-9" tabindex="-1"></a>  pg_size_pretty(wal_bytes) <span class="kw">AS</span> wal_size</span>
<span id="cb72-10"><a aria-hidden="true" href="#cb72-10" tabindex="-1"></a><span class="kw">FROM</span> pg_stat_wal;</span>
<span id="cb72-11"><a aria-hidden="true" href="#cb72-11" tabindex="-1"></a></span>
<span id="cb72-12"><a aria-hidden="true" href="#cb72-12" tabindex="-1"></a><span class="co">-- Replication lag</span></span>
<span id="cb72-13"><a aria-hidden="true" href="#cb72-13" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb72-14"><a aria-hidden="true" href="#cb72-14" tabindex="-1"></a>  client_addr,</span>
<span id="cb72-15"><a aria-hidden="true" href="#cb72-15" tabindex="-1"></a>  pg_wal_lsn_diff(pg_current_wal_lsn(), replay_lsn) <span class="kw">AS</span> lag_bytes,</span>
<span id="cb72-16"><a aria-hidden="true" href="#cb72-16" tabindex="-1"></a>  replay_lag</span>
<span id="cb72-17"><a aria-hidden="true" href="#cb72-17" tabindex="-1"></a><span class="kw">FROM</span> pg_stat_replication;</span></code></pre></div>
<h3 data-number="3.6.14" id="wal-internals-and-performance"><span class="header-section-number">3.6.14</span> WAL Internals and
Performance</h3>
<p><strong>WAL insertion locks:</strong></p>
<p>PostgreSQL 9.4+ uses multiple WAL insertion locks to reduce
contention:</p>
<div class="sourceCode" id="cb73"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb73-1"><a aria-hidden="true" href="#cb73-1" tabindex="-1"></a><span class="pp">#define NUM_XLOGINSERT_LOCKS  </span><span class="dv">8</span></span></code></pre></div>
<p>Backends can insert WAL records in parallel, though commits still
serialize at flush time.</p>
<p><strong>WAL compression:</strong></p>
<pre><code>wal_compression = on  /* Compress full page images (PostgreSQL 9.5+) */</code></pre>
<p>Can significantly reduce WAL volume for workloads with large FPW.</p>
<p><strong>fsync methods:</strong></p>
<pre><code>fsync = on                    /* Must be on for durability */
wal_sync_method = fdatasync   /* OS-dependent, fdatasync often best */</code></pre>
<p><strong>Tuning for performance:</strong></p>
<pre><code># Larger WAL buffers for write-heavy workloads
wal_buffers = 16MB

# Less frequent checkpoints for write-heavy workloads
checkpoint_timeout = 15min
max_wal_size = 2GB

# Async commit for non-critical data (trades durability for speed)
synchronous_commit = off</code></pre>
<p><strong>synchronous_commit modes:</strong></p>
<ul>
<li><strong>on</strong>: Wait for WAL flush (full durability)</li>
<li><strong>remote_write</strong>: Wait for standby to write (not
flush)</li>
<li><strong>remote_apply</strong>: Wait for standby to apply</li>
<li><strong>local</strong>: Wait for local flush only (ignore
standbys)</li>
<li><strong>off</strong>: Don‚Äôt wait (crash may lose last few
transactions)</li>
</ul>
<h3 data-number="3.6.15" id="wal-record-decoding"><span class="header-section-number">3.6.15</span> WAL Record Decoding</h3>
<p>The <code>pg_waldump</code> utility decodes WAL files:</p>
<div class="sourceCode" id="cb77"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb77-1"><a aria-hidden="true" href="#cb77-1" tabindex="-1"></a><span class="ex">pg_waldump</span> <span class="at">-p</span> <span class="va">$PGDATA</span>/pg_wal/ <span class="at">-s</span> 0/16C4000 <span class="at">-n</span> 10</span></code></pre></div>
<p>Example output:</p>
<pre><code>rmgr: Heap        len (rec/tot):     54/   178, tx:        567, lsn: 0/016C4000,
  prev 0/016C3FC0, desc: INSERT off 3, blkref #0: rel 1663/13593/16384 blk 0 FPW
rmgr: Transaction len (rec/tot):     34/    34, tx:        567, lsn: 0/016C40B8,
  prev 0/016C4000, desc: COMMIT 2025-11-19 10:00:00.123456 UTC</code></pre>
<p>Useful for debugging and forensic analysis.</p>
<h2 data-number="3.7" id="multi-version-concurrency-control"><span class="header-section-number">3.7</span> Multi-Version Concurrency
Control</h2>
<h3 data-number="3.7.1" id="overview-4"><span class="header-section-number">3.7.1</span> Overview</h3>
<p>Multi-Version Concurrency Control (MVCC) is PostgreSQL‚Äôs approach to
handling concurrent transactions. Instead of locking data for the
duration of a read, PostgreSQL maintains multiple versions of each row,
allowing readers and writers to operate without blocking each other.</p>
<p>MVCC provides: - <strong>High concurrency</strong>: Readers never
block writers, writers never block readers - <strong>Consistent
snapshots</strong>: Each transaction sees a consistent view of data -
<strong>Isolation levels</strong>: Support for all SQL standard
isolation levels - <strong>No read locks</strong>: SELECT never acquires
locks on data</p>
<h3 data-number="3.7.2" id="core-mvcc-principles"><span class="header-section-number">3.7.2</span> Core MVCC Principles</h3>
<p><strong>Version visibility:</strong></p>
<p>Each transaction sees a snapshot of the database at a specific point
in time. Whether a tuple version is visible depends on:</p>
<ol type="1">
<li>The transaction ID that created it (t_xmin)</li>
<li>The transaction ID that deleted it (t_xmax)</li>
<li>The viewing transaction‚Äôs snapshot</li>
</ol>
<p><strong>Tuple version example:</strong></p>
<pre><code>Table: accounts
Row ID: 1

Version 1:  t_xmin=100, t_xmax=0,   balance=1000  (created by XID 100, still current)
Version 2:  t_xmin=105, t_xmax=0,   balance=1500  (created by XID 105, is UPDATE)
Version 1': t_xmin=100, t_xmax=105, balance=1000  (marked deleted by XID 105)</code></pre>
<p>Transaction 103 would see Version 1 (balance=1000) Transaction 107
would see Version 2 (balance=1500)</p>
<h3 data-number="3.7.3" id="snapshot-structure"><span class="header-section-number">3.7.3</span> Snapshot Structure</h3>
<p>A snapshot captures which transactions are visible:</p>
<div class="sourceCode" id="cb80"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb80-1"><a aria-hidden="true" href="#cb80-1" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> SnapshotData</span>
<span id="cb80-2"><a aria-hidden="true" href="#cb80-2" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb80-3"><a aria-hidden="true" href="#cb80-3" tabindex="-1"></a>    SnapshotType snapshot_type<span class="op">;</span></span>
<span id="cb80-4"><a aria-hidden="true" href="#cb80-4" tabindex="-1"></a></span>
<span id="cb80-5"><a aria-hidden="true" href="#cb80-5" tabindex="-1"></a>    TransactionId xmin<span class="op">;</span>  <span class="co">/* All XID &lt; xmin are either committed or aborted */</span></span>
<span id="cb80-6"><a aria-hidden="true" href="#cb80-6" tabindex="-1"></a>    TransactionId xmax<span class="op">;</span>  <span class="co">/* All XID &gt;= xmax are not yet committed */</span></span>
<span id="cb80-7"><a aria-hidden="true" href="#cb80-7" tabindex="-1"></a></span>
<span id="cb80-8"><a aria-hidden="true" href="#cb80-8" tabindex="-1"></a>    TransactionId <span class="op">*</span>xip<span class="op">;</span>  <span class="co">/* Array of in-progress XIDs at snapshot time */</span></span>
<span id="cb80-9"><a aria-hidden="true" href="#cb80-9" tabindex="-1"></a>    uint32 xcnt<span class="op">;</span>         <span class="co">/* Count of in-progress XIDs */</span></span>
<span id="cb80-10"><a aria-hidden="true" href="#cb80-10" tabindex="-1"></a></span>
<span id="cb80-11"><a aria-hidden="true" href="#cb80-11" tabindex="-1"></a>    TransactionId subxip<span class="op">[</span>PGPROC_MAX_CACHED_SUBXIDS<span class="op">];</span></span>
<span id="cb80-12"><a aria-hidden="true" href="#cb80-12" tabindex="-1"></a>    int32 subxcnt<span class="op">;</span>       <span class="co">/* Count of subtransaction XIDs */</span></span>
<span id="cb80-13"><a aria-hidden="true" href="#cb80-13" tabindex="-1"></a></span>
<span id="cb80-14"><a aria-hidden="true" href="#cb80-14" tabindex="-1"></a>    CommandId curcid<span class="op">;</span>    <span class="co">/* Current command ID */</span></span>
<span id="cb80-15"><a aria-hidden="true" href="#cb80-15" tabindex="-1"></a><span class="op">}</span> SnapshotData<span class="op">;</span></span></code></pre></div>
<p><strong>Snapshot types:</strong></p>
<ul>
<li><strong>MVCC Snapshot</strong>: Regular transaction snapshot (READ
COMMITTED gets new one per statement)</li>
<li><strong>Self Snapshot</strong>: See own changes, used during query
execution</li>
<li><strong>Dirty Snapshot</strong>: See all versions (used by
VACUUM)</li>
<li><strong>Historic Snapshot</strong>: For logical decoding</li>
</ul>
<h3 data-number="3.7.4" id="visibility-rules"><span class="header-section-number">3.7.4</span> Visibility Rules</h3>
<p>The core visibility check (<code>HeapTupleSatisfiesMVCC</code> in
<code>src/backend/access/heap/heapam_visibility.c</code>):</p>
<div class="sourceCode" id="cb81"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb81-1"><a aria-hidden="true" href="#cb81-1" tabindex="-1"></a><span class="dt">bool</span> HeapTupleSatisfiesMVCC<span class="op">(</span>HeapTuple htup<span class="op">,</span> Snapshot snapshot<span class="op">,</span> Buffer buffer<span class="op">)</span></span>
<span id="cb81-2"><a aria-hidden="true" href="#cb81-2" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb81-3"><a aria-hidden="true" href="#cb81-3" tabindex="-1"></a>    <span class="co">/* 1. Check if tuple was created by a transaction visible to snapshot */</span></span>
<span id="cb81-4"><a aria-hidden="true" href="#cb81-4" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>XidInMVCCSnapshot<span class="op">(</span>htup<span class="op">-&gt;</span>t_xmin<span class="op">,</span> snapshot<span class="op">))</span></span>
<span id="cb81-5"><a aria-hidden="true" href="#cb81-5" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span>  <span class="co">/* Creator not yet committed when snapshot taken */</span></span>
<span id="cb81-6"><a aria-hidden="true" href="#cb81-6" tabindex="-1"></a></span>
<span id="cb81-7"><a aria-hidden="true" href="#cb81-7" tabindex="-1"></a>    <span class="co">/* 2. Check if tuple has been deleted/updated */</span></span>
<span id="cb81-8"><a aria-hidden="true" href="#cb81-8" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(!</span>TransactionIdIsValid<span class="op">(</span>htup<span class="op">-&gt;</span>t_xmax<span class="op">))</span></span>
<span id="cb81-9"><a aria-hidden="true" href="#cb81-9" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">true</span><span class="op">;</span>  <span class="co">/* Not deleted, visible */</span></span>
<span id="cb81-10"><a aria-hidden="true" href="#cb81-10" tabindex="-1"></a></span>
<span id="cb81-11"><a aria-hidden="true" href="#cb81-11" tabindex="-1"></a>    <span class="co">/* 3. Check if deleter is visible to snapshot */</span></span>
<span id="cb81-12"><a aria-hidden="true" href="#cb81-12" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>XidInMVCCSnapshot<span class="op">(</span>htup<span class="op">-&gt;</span>t_xmax<span class="op">,</span> snapshot<span class="op">))</span></span>
<span id="cb81-13"><a aria-hidden="true" href="#cb81-13" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">true</span><span class="op">;</span>  <span class="co">/* Deleter not committed when snapshot taken */</span></span>
<span id="cb81-14"><a aria-hidden="true" href="#cb81-14" tabindex="-1"></a></span>
<span id="cb81-15"><a aria-hidden="true" href="#cb81-15" tabindex="-1"></a>    <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span>  <span class="co">/* Deleted by committed transaction */</span></span>
<span id="cb81-16"><a aria-hidden="true" href="#cb81-16" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>Detailed visibility rules:</strong></p>
<ol type="1">
<li><strong>Tuple created after snapshot</strong>: Not visible</li>
<li><strong>Tuple deleted before snapshot</strong>: Not visible</li>
<li><strong>Tuple created by aborted transaction</strong>: Not
visible</li>
<li><strong>Tuple deleted by aborted transaction</strong>: Visible</li>
<li><strong>Tuple created and deleted by in-progress
transaction</strong>: Check if it‚Äôs our own transaction</li>
</ol>
<h3 data-number="3.7.5" id="transaction-id-management"><span class="header-section-number">3.7.5</span> Transaction ID
Management</h3>
<p><strong>Transaction ID (XID):</strong></p>
<div class="sourceCode" id="cb82"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb82-1"><a aria-hidden="true" href="#cb82-1" tabindex="-1"></a><span class="kw">typedef</span> uint32 TransactionId<span class="op">;</span></span>
<span id="cb82-2"><a aria-hidden="true" href="#cb82-2" tabindex="-1"></a></span>
<span id="cb82-3"><a aria-hidden="true" href="#cb82-3" tabindex="-1"></a><span class="pp">#define InvalidTransactionId      </span><span class="dv">0</span></span>
<span id="cb82-4"><a aria-hidden="true" href="#cb82-4" tabindex="-1"></a><span class="pp">#define BootstrapTransactionId    </span><span class="dv">1</span></span>
<span id="cb82-5"><a aria-hidden="true" href="#cb82-5" tabindex="-1"></a><span class="pp">#define FrozenTransactionId       </span><span class="dv">2</span></span>
<span id="cb82-6"><a aria-hidden="true" href="#cb82-6" tabindex="-1"></a><span class="pp">#define FirstNormalTransactionId  </span><span class="dv">3</span></span></code></pre></div>
<p><strong>XID allocation:</strong></p>
<div class="sourceCode" id="cb83"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb83-1"><a aria-hidden="true" href="#cb83-1" tabindex="-1"></a>TransactionId GetNewTransactionId<span class="op">(</span><span class="dt">bool</span> isSubXact<span class="op">);</span></span></code></pre></div>
<p>XIDs are allocated sequentially. PostgreSQL can handle ~2 billion
transactions before wraparound.</p>
<p><strong>XID wraparound problem:</strong></p>
<p>XIDs are 32-bit, forming a circular space:</p>
<pre><code>      newest XID
           ‚Üì
    ... 2B-1, 0, 1, 2 ...
           ‚Üë
      oldest XID</code></pre>
<p>After 2^31 transactions, old tuples would appear to be in the
future!</p>
<p><strong>Solution: Freezing</strong></p>
<p>VACUUM ‚Äúfreezes‚Äù old tuples by setting t_xmin to FrozenTransactionId
(2):</p>
<div class="sourceCode" id="cb85"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb85-1"><a aria-hidden="true" href="#cb85-1" tabindex="-1"></a><span class="co">-- Freeze tuples when XID age exceeds this</span></span>
<span id="cb85-2"><a aria-hidden="true" href="#cb85-2" tabindex="-1"></a>vacuum_freeze_min_age <span class="op">=</span> <span class="dv">50000000</span></span>
<span id="cb85-3"><a aria-hidden="true" href="#cb85-3" tabindex="-1"></a></span>
<span id="cb85-4"><a aria-hidden="true" href="#cb85-4" tabindex="-1"></a><span class="co">-- Force aggressive VACUUM when table age exceeds this</span></span>
<span id="cb85-5"><a aria-hidden="true" href="#cb85-5" tabindex="-1"></a>vacuum_freeze_table_age <span class="op">=</span> <span class="dv">150000000</span></span>
<span id="cb85-6"><a aria-hidden="true" href="#cb85-6" tabindex="-1"></a></span>
<span id="cb85-7"><a aria-hidden="true" href="#cb85-7" tabindex="-1"></a><span class="co">-- Prevent wraparound catastrophe</span></span>
<span id="cb85-8"><a aria-hidden="true" href="#cb85-8" tabindex="-1"></a>autovacuum_freeze_max_age <span class="op">=</span> <span class="dv">200000000</span></span></code></pre></div>
<h3 data-number="3.7.6" id="transaction-status-clog"><span class="header-section-number">3.7.6</span> Transaction Status: CLOG</h3>
<p>The Commit Log (CLOG, also called pg_xact) tracks transaction
status:</p>
<pre><code>XID ‚Üí Status (committed, aborted, in-progress, sub-committed)</code></pre>
<p>Located in <code>$PGDATA/pg_xact/</code>, stores 2 bits per
transaction:</p>
<ul>
<li><code>00</code>: In progress</li>
<li><code>01</code>: Committed</li>
<li><code>10</code>: Aborted</li>
<li><code>11</code>: Sub-committed</li>
</ul>
<p><strong>CLOG lookup:</strong></p>
<div class="sourceCode" id="cb87"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb87-1"><a aria-hidden="true" href="#cb87-1" tabindex="-1"></a>XidStatus TransactionIdGetStatus<span class="op">(</span>TransactionId xid<span class="op">);</span></span></code></pre></div>
<p><strong>Hint bits optimization:</strong></p>
<p>To avoid repeated CLOG lookups, PostgreSQL caches transaction status
in tuple headers:</p>
<div class="sourceCode" id="cb88"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb88-1"><a aria-hidden="true" href="#cb88-1" tabindex="-1"></a><span class="pp">#define HEAP_XMIN_COMMITTED  </span><span class="bn">0x0100</span></span>
<span id="cb88-2"><a aria-hidden="true" href="#cb88-2" tabindex="-1"></a><span class="pp">#define HEAP_XMIN_INVALID    </span><span class="bn">0x0200</span></span>
<span id="cb88-3"><a aria-hidden="true" href="#cb88-3" tabindex="-1"></a><span class="pp">#define HEAP_XMAX_COMMITTED  </span><span class="bn">0x0400</span></span>
<span id="cb88-4"><a aria-hidden="true" href="#cb88-4" tabindex="-1"></a><span class="pp">#define HEAP_XMAX_INVALID    </span><span class="bn">0x0800</span></span></code></pre></div>
<p>First transaction to check a tuple‚Äôs visibility: 1. Looks up XID in
CLOG 2. Sets hint bit on tuple 3. Marks buffer dirty</p>
<p>Subsequent checks use hint bit, avoiding CLOG lookup.</p>
<h3 data-number="3.7.7" id="isolation-levels"><span class="header-section-number">3.7.7</span> Isolation Levels</h3>
<p>PostgreSQL implements SQL standard isolation levels using MVCC:</p>
<p><strong>Read Uncommitted</strong> (treated as Read Committed):</p>
<div class="sourceCode" id="cb89"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb89-1"><a aria-hidden="true" href="#cb89-1" tabindex="-1"></a><span class="cf">BEGIN</span> <span class="kw">TRANSACTION</span> <span class="kw">ISOLATION</span> <span class="kw">LEVEL</span> <span class="kw">READ</span> UNCOMMITTED;</span></code></pre></div>
<ul>
<li>Gets new snapshot for each statement</li>
<li>Sees committed changes from other transactions between
statements</li>
</ul>
<p><strong>Read Committed</strong> (default):</p>
<div class="sourceCode" id="cb90"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb90-1"><a aria-hidden="true" href="#cb90-1" tabindex="-1"></a><span class="cf">BEGIN</span> <span class="kw">TRANSACTION</span> <span class="kw">ISOLATION</span> <span class="kw">LEVEL</span> <span class="kw">READ</span> <span class="kw">COMMITTED</span>;</span></code></pre></div>
<ul>
<li>Gets new snapshot for each statement</li>
<li>Most common isolation level</li>
</ul>
<p><strong>Repeatable Read</strong>:</p>
<div class="sourceCode" id="cb91"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb91-1"><a aria-hidden="true" href="#cb91-1" tabindex="-1"></a><span class="cf">BEGIN</span> <span class="kw">TRANSACTION</span> <span class="kw">ISOLATION</span> <span class="kw">LEVEL</span> REPEATABLE <span class="kw">READ</span>;</span></code></pre></div>
<ul>
<li>Single snapshot for entire transaction</li>
<li>Prevents non-repeatable reads</li>
<li>Can see phantom reads in theory, but PostgreSQL prevents them</li>
</ul>
<p><strong>Serializable</strong>:</p>
<div class="sourceCode" id="cb92"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb92-1"><a aria-hidden="true" href="#cb92-1" tabindex="-1"></a><span class="cf">BEGIN</span> <span class="kw">TRANSACTION</span> <span class="kw">ISOLATION</span> <span class="kw">LEVEL</span> <span class="kw">SERIALIZABLE</span>;</span></code></pre></div>
<ul>
<li>True serializability via Serializable Snapshot Isolation (SSI)</li>
<li>Detects read-write conflicts that could violate serializability</li>
<li>May abort transactions with ‚Äúcould not serialize‚Äù error</li>
</ul>
<h3 data-number="3.7.8" id="serializable-snapshot-isolation-ssi"><span class="header-section-number">3.7.8</span> Serializable Snapshot
Isolation (SSI)</h3>
<p>PostgreSQL‚Äôs SERIALIZABLE implementation uses predicate locking:</p>
<div class="sourceCode" id="cb93"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb93-1"><a aria-hidden="true" href="#cb93-1" tabindex="-1"></a><span class="co">/* Track dangerous read-write patterns */</span></span>
<span id="cb93-2"><a aria-hidden="true" href="#cb93-2" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> SERIALIZABLEXACT</span>
<span id="cb93-3"><a aria-hidden="true" href="#cb93-3" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb93-4"><a aria-hidden="true" href="#cb93-4" tabindex="-1"></a>    VirtualTransactionId vxid<span class="op">;</span></span>
<span id="cb93-5"><a aria-hidden="true" href="#cb93-5" tabindex="-1"></a></span>
<span id="cb93-6"><a aria-hidden="true" href="#cb93-6" tabindex="-1"></a>    <span class="co">/* Conflicts with other transactions */</span></span>
<span id="cb93-7"><a aria-hidden="true" href="#cb93-7" tabindex="-1"></a>    dlist_head possibleUnsafeConflicts<span class="op">;</span></span>
<span id="cb93-8"><a aria-hidden="true" href="#cb93-8" tabindex="-1"></a></span>
<span id="cb93-9"><a aria-hidden="true" href="#cb93-9" tabindex="-1"></a>    <span class="co">/* Read locks */</span></span>
<span id="cb93-10"><a aria-hidden="true" href="#cb93-10" tabindex="-1"></a>    PREDICATELOCKTARGETTAG <span class="op">*</span>predicatelocktarget<span class="op">;</span></span>
<span id="cb93-11"><a aria-hidden="true" href="#cb93-11" tabindex="-1"></a><span class="op">}</span> SERIALIZABLEXACT<span class="op">;</span></span></code></pre></div>
<p><strong>Conflict detection:</strong></p>
<p>SSI looks for dangerous structures:</p>
<pre><code>T1: Read A  ‚Üí Write B
T2: Read B  ‚Üí Write A</code></pre>
<p>If both occur, one transaction is aborted to prevent anomaly.</p>
<p><strong>Performance</strong>: SERIALIZABLE has overhead but provides
strongest guarantees.</p>
<h3 data-number="3.7.9" id="subtransactions"><span class="header-section-number">3.7.9</span> Subtransactions</h3>
<p>Savepoints create subtransactions:</p>
<div class="sourceCode" id="cb95"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb95-1"><a aria-hidden="true" href="#cb95-1" tabindex="-1"></a><span class="cf">BEGIN</span>;</span>
<span id="cb95-2"><a aria-hidden="true" href="#cb95-2" tabindex="-1"></a>  <span class="kw">INSERT</span> <span class="kw">INTO</span> accounts <span class="kw">VALUES</span> (<span class="dv">1</span>, <span class="dv">1000</span>);</span>
<span id="cb95-3"><a aria-hidden="true" href="#cb95-3" tabindex="-1"></a>  <span class="kw">SAVEPOINT</span> sp1;</span>
<span id="cb95-4"><a aria-hidden="true" href="#cb95-4" tabindex="-1"></a>    <span class="kw">UPDATE</span> accounts <span class="kw">SET</span> balance <span class="op">=</span> <span class="dv">1100</span> <span class="kw">WHERE</span> <span class="kw">id</span> <span class="op">=</span> <span class="dv">1</span>;</span>
<span id="cb95-5"><a aria-hidden="true" href="#cb95-5" tabindex="-1"></a>    <span class="co">-- Error occurs</span></span>
<span id="cb95-6"><a aria-hidden="true" href="#cb95-6" tabindex="-1"></a>  <span class="kw">ROLLBACK</span> <span class="kw">TO</span> sp1;  <span class="co">-- Undo UPDATE but keep INSERT</span></span>
<span id="cb95-7"><a aria-hidden="true" href="#cb95-7" tabindex="-1"></a><span class="kw">COMMIT</span>;</span></code></pre></div>
<p><strong>Implementation:</strong></p>
<p>Subtransactions get their own XID (SubTransactionId):</p>
<div class="sourceCode" id="cb96"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb96-1"><a aria-hidden="true" href="#cb96-1" tabindex="-1"></a><span class="kw">typedef</span> uint32 SubTransactionId<span class="op">;</span></span></code></pre></div>
<p>CLOG tracks parent-child relationships. A subtransaction is committed
only if its parent commits.</p>
<h3 data-number="3.7.10" id="vacuum-and-dead-tuple-cleanup"><span class="header-section-number">3.7.10</span> VACUUM and Dead Tuple
Cleanup</h3>
<p>MVCC creates dead tuple versions that must be cleaned up:</p>
<p><strong>VACUUM operations:</strong></p>
<ol type="1">
<li><strong>Identify dead tuples</strong>: Check visibility (no active
snapshot can see them)</li>
<li><strong>Remove from indexes</strong>: Mark index entries as
dead</li>
<li><strong>Remove from heap</strong>: Reclaim space, set item pointers
to LP_UNUSED</li>
<li><strong>Update FSM</strong>: Record available free space</li>
<li><strong>Update VM</strong>: Mark pages as all-visible if
appropriate</li>
<li><strong>Freeze old tuples</strong>: Prevent XID wraparound</li>
<li><strong>Truncate empty pages</strong> at end of table</li>
</ol>
<p><strong>VACUUM types:</strong></p>
<div class="sourceCode" id="cb97"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb97-1"><a aria-hidden="true" href="#cb97-1" tabindex="-1"></a><span class="co">-- Regular VACUUM (reclaims space within file)</span></span>
<span id="cb97-2"><a aria-hidden="true" href="#cb97-2" tabindex="-1"></a>VACUUM tablename;</span>
<span id="cb97-3"><a aria-hidden="true" href="#cb97-3" tabindex="-1"></a></span>
<span id="cb97-4"><a aria-hidden="true" href="#cb97-4" tabindex="-1"></a><span class="co">-- VACUUM FULL (rewrites entire table, exclusive lock)</span></span>
<span id="cb97-5"><a aria-hidden="true" href="#cb97-5" tabindex="-1"></a>VACUUM <span class="kw">FULL</span> tablename;</span>
<span id="cb97-6"><a aria-hidden="true" href="#cb97-6" tabindex="-1"></a></span>
<span id="cb97-7"><a aria-hidden="true" href="#cb97-7" tabindex="-1"></a><span class="co">-- Autovacuum (automatic background process)</span></span></code></pre></div>
<p><strong>Autovacuum configuration:</strong></p>
<pre><code>autovacuum = on
autovacuum_naptime = 1min
autovacuum_vacuum_threshold = 50
autovacuum_vacuum_scale_factor = 0.2

-- Trigger autovacuum when:
-- dead_tuples &gt; threshold + scale_factor * table_size
-- Example: 10M row table ‚Üí vacuum when 2M+ dead tuples</code></pre>
<h3 data-number="3.7.11" id="bloat-management"><span class="header-section-number">3.7.11</span> Bloat Management</h3>
<p>MVCC can cause table bloat:</p>
<p><strong>Bloat causes:</strong> - High UPDATE/DELETE rate -
Long-running transactions (prevent VACUUM from cleaning up) -
Insufficient autovacuum tuning</p>
<p><strong>Monitoring bloat:</strong></p>
<div class="sourceCode" id="cb99"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb99-1"><a aria-hidden="true" href="#cb99-1" tabindex="-1"></a><span class="kw">SELECT</span> schemaname, tablename,</span>
<span id="cb99-2"><a aria-hidden="true" href="#cb99-2" tabindex="-1"></a>  pg_size_pretty(pg_total_relation_size(schemaname<span class="op">||</span><span class="st">'.'</span><span class="op">||</span>tablename)) <span class="kw">AS</span> total_size,</span>
<span id="cb99-3"><a aria-hidden="true" href="#cb99-3" tabindex="-1"></a>  <span class="fu">round</span>(<span class="dv">100</span> <span class="op">*</span> (pg_total_relation_size(schemaname<span class="op">||</span><span class="st">'.'</span><span class="op">||</span>tablename):<span class="ch">:numeric</span> <span class="op">/</span></span>
<span id="cb99-4"><a aria-hidden="true" href="#cb99-4" tabindex="-1"></a>    <span class="fu">nullif</span>(pg_relation_size(schemaname<span class="op">||</span><span class="st">'.'</span><span class="op">||</span>tablename), <span class="dv">0</span>)), <span class="dv">1</span>) <span class="kw">AS</span> bloat_pct</span>
<span id="cb99-5"><a aria-hidden="true" href="#cb99-5" tabindex="-1"></a><span class="kw">FROM</span> pg_tables</span>
<span id="cb99-6"><a aria-hidden="true" href="#cb99-6" tabindex="-1"></a><span class="kw">WHERE</span> schemaname <span class="kw">NOT</span> <span class="kw">IN</span> (<span class="st">'pg_catalog'</span>, <span class="st">'information_schema'</span>)</span>
<span id="cb99-7"><a aria-hidden="true" href="#cb99-7" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> pg_total_relation_size(schemaname<span class="op">||</span><span class="st">'.'</span><span class="op">||</span>tablename) <span class="kw">DESC</span>;</span></code></pre></div>
<p><strong>Reducing bloat:</strong></p>
<ol type="1">
<li>Tune autovacuum to run more aggressively</li>
<li>Use HOT updates (ensure indexed columns not updated)</li>
<li>Set appropriate fillfactor</li>
<li>Avoid long-running transactions</li>
<li>Consider partitioning for large tables</li>
<li>Periodic VACUUM FULL or table rewrite for severe bloat</li>
</ol>
<h3 data-number="3.7.12" id="mvcc-performance-implications"><span class="header-section-number">3.7.12</span> MVCC Performance
Implications</h3>
<p><strong>Advantages:</strong> - Readers never block writers - Writers
never block readers - No read locks - High concurrency</p>
<p><strong>Costs:</strong> - Storage overhead (multiple tuple versions)
- VACUUM overhead - Index updates for every UPDATE (unless HOT) - Bloat
if not properly managed</p>
<p><strong>Best practices:</strong> 1. Monitor autovacuum activity 2.
Tune autovacuum for workload 3. Avoid long-running transactions 4. Use
HOT updates when possible 5. Regular monitoring of table bloat</p>
<h2 data-number="3.8" id="index-access-methods"><span class="header-section-number">3.8</span> Index Access Methods</h2>
<h3 data-number="3.8.1" id="overview-5"><span class="header-section-number">3.8.1</span> Overview</h3>
<p>PostgreSQL provides six built-in index types, each optimized for
different data types and query patterns. The index access method API
allows extensions to add new index types, making PostgreSQL highly
extensible.</p>
<p>All index types share a common interface defined in
<code>src/include/access/amapi.h</code>:</p>
<div class="sourceCode" id="cb100"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb100-1"><a aria-hidden="true" href="#cb100-1" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> IndexAmRoutine</span>
<span id="cb100-2"><a aria-hidden="true" href="#cb100-2" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb100-3"><a aria-hidden="true" href="#cb100-3" tabindex="-1"></a>    NodeTag     type<span class="op">;</span></span>
<span id="cb100-4"><a aria-hidden="true" href="#cb100-4" tabindex="-1"></a></span>
<span id="cb100-5"><a aria-hidden="true" href="#cb100-5" tabindex="-1"></a>    <span class="co">/* Index build callbacks */</span></span>
<span id="cb100-6"><a aria-hidden="true" href="#cb100-6" tabindex="-1"></a>    ambuild_function ambuild<span class="op">;</span></span>
<span id="cb100-7"><a aria-hidden="true" href="#cb100-7" tabindex="-1"></a>    ambuildempty_function ambuildempty<span class="op">;</span></span>
<span id="cb100-8"><a aria-hidden="true" href="#cb100-8" tabindex="-1"></a></span>
<span id="cb100-9"><a aria-hidden="true" href="#cb100-9" tabindex="-1"></a>    <span class="co">/* Index scan callbacks */</span></span>
<span id="cb100-10"><a aria-hidden="true" href="#cb100-10" tabindex="-1"></a>    aminsert_function aminsert<span class="op">;</span></span>
<span id="cb100-11"><a aria-hidden="true" href="#cb100-11" tabindex="-1"></a>    ambulkdelete_function ambulkdelete<span class="op">;</span></span>
<span id="cb100-12"><a aria-hidden="true" href="#cb100-12" tabindex="-1"></a>    amvacuumcleanup_function amvacuumcleanup<span class="op">;</span></span>
<span id="cb100-13"><a aria-hidden="true" href="#cb100-13" tabindex="-1"></a></span>
<span id="cb100-14"><a aria-hidden="true" href="#cb100-14" tabindex="-1"></a>    <span class="co">/* Index scan functions */</span></span>
<span id="cb100-15"><a aria-hidden="true" href="#cb100-15" tabindex="-1"></a>    ambeginscan_function ambeginscan<span class="op">;</span></span>
<span id="cb100-16"><a aria-hidden="true" href="#cb100-16" tabindex="-1"></a>    amrescan_function amrescan<span class="op">;</span></span>
<span id="cb100-17"><a aria-hidden="true" href="#cb100-17" tabindex="-1"></a>    amgettuple_function amgettuple<span class="op">;</span></span>
<span id="cb100-18"><a aria-hidden="true" href="#cb100-18" tabindex="-1"></a></span>
<span id="cb100-19"><a aria-hidden="true" href="#cb100-19" tabindex="-1"></a>    <span class="co">/* ... many more callbacks */</span></span>
<span id="cb100-20"><a aria-hidden="true" href="#cb100-20" tabindex="-1"></a><span class="op">}</span> IndexAmRoutine<span class="op">;</span></span></code></pre></div>
<h3 data-number="3.8.2" id="b-tree-indexes"><span class="header-section-number">3.8.2</span> B-tree Indexes</h3>
<p><strong>Default and most versatile index type</strong>
(<code>src/backend/access/nbtree/</code>).</p>
<p><strong>Characteristics:</strong> - Balanced tree structure -
Logarithmic search time: O(log N) - Ordered data (supports range scans)
- Supports multi-column indexes - Handles NULL values</p>
<p><strong>When to use:</strong> - Equality comparisons:
<code>WHERE id = 5</code> - Range queries:
<code>WHERE created_at BETWEEN ... AND ...</code> - Sorting:
<code>ORDER BY name</code> - Pattern matching:
<code>WHERE name LIKE 'John%'</code> - IS NULL / IS NOT NULL</p>
<p><strong>Supported operators:</strong></p>
<pre><code>&lt;, &lt;=, =, &gt;=, &gt;, BETWEEN, IN, IS NULL, IS NOT NULL</code></pre>
<p><strong>Structure:</strong></p>
<pre><code>                    [Root Page]
                   /     |     \
            [Internal] [Internal] [Internal]
            /    \      /    \      /    \
        [Leaf] [Leaf] [Leaf] [Leaf] [Leaf] [Leaf]
          ‚Üï      ‚Üï      ‚Üï      ‚Üï      ‚Üï      ‚Üï
        (Doubly-linked leaf pages for efficient range scans)</code></pre>
<p><strong>B-tree page structure:</strong></p>
<div class="sourceCode" id="cb103"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb103-1"><a aria-hidden="true" href="#cb103-1" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> BTPageOpaqueData</span>
<span id="cb103-2"><a aria-hidden="true" href="#cb103-2" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb103-3"><a aria-hidden="true" href="#cb103-3" tabindex="-1"></a>    BlockNumber btpo_prev<span class="op">;</span>      <span class="co">/* Left sibling */</span></span>
<span id="cb103-4"><a aria-hidden="true" href="#cb103-4" tabindex="-1"></a>    BlockNumber btpo_next<span class="op">;</span>      <span class="co">/* Right sibling */</span></span>
<span id="cb103-5"><a aria-hidden="true" href="#cb103-5" tabindex="-1"></a>    uint32      btpo_level<span class="op">;</span>     <span class="co">/* Tree level (0 = leaf) */</span></span>
<span id="cb103-6"><a aria-hidden="true" href="#cb103-6" tabindex="-1"></a>    uint16      btpo_flags<span class="op">;</span>     <span class="co">/* Page type and status flags */</span></span>
<span id="cb103-7"><a aria-hidden="true" href="#cb103-7" tabindex="-1"></a>    BTCycleId   btpo_cycleid<span class="op">;</span>   <span class="co">/* Vacuum cycle ID */</span></span>
<span id="cb103-8"><a aria-hidden="true" href="#cb103-8" tabindex="-1"></a><span class="op">}</span> BTPageOpaqueData<span class="op">;</span></span></code></pre></div>
<p><strong>Index tuple format:</strong></p>
<div class="sourceCode" id="cb104"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb104-1"><a aria-hidden="true" href="#cb104-1" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> IndexTupleData</span>
<span id="cb104-2"><a aria-hidden="true" href="#cb104-2" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb104-3"><a aria-hidden="true" href="#cb104-3" tabindex="-1"></a>    ItemPointerData t_tid<span class="op">;</span>  <span class="co">/* TID of heap tuple */</span></span>
<span id="cb104-4"><a aria-hidden="true" href="#cb104-4" tabindex="-1"></a>    <span class="dt">unsigned</span> <span class="dt">short</span> t_info<span class="op">;</span>  <span class="co">/* Various info */</span></span>
<span id="cb104-5"><a aria-hidden="true" href="#cb104-5" tabindex="-1"></a></span>
<span id="cb104-6"><a aria-hidden="true" href="#cb104-6" tabindex="-1"></a>    <span class="co">/* Followed by indexed attribute values */</span></span>
<span id="cb104-7"><a aria-hidden="true" href="#cb104-7" tabindex="-1"></a><span class="op">}</span> IndexTupleData<span class="op">;</span></span></code></pre></div>
<p><strong>B-tree operations:</strong></p>
<p><strong>Insert</strong> (<code>_bt_doinsert</code> in
<code>nbtree.c</code>): 1. Descend tree to find correct leaf page 2. If
page has space: Insert tuple 3. If page full: Split page, propagate
split up tree</p>
<p><strong>Search</strong> (<code>_bt_search</code>): 1. Start at root
2. Binary search within page to find downlink 3. Descend to child 4.
Repeat until leaf page 5. Scan leaf page for matching tuples</p>
<p><strong>Page split:</strong></p>
<pre><code>Before:
[Page A: 1,2,3,4,5,6,7,8] ‚Üí FULL

After split:
[Page A: 1,2,3,4] ‚Üî [Page B: 5,6,7,8]
         ‚Üë                    ‚Üë
         ‚îî‚îÄ‚îÄ‚îÄ Parent: 4, 8 ‚îÄ‚îÄ‚îÄ‚îò</code></pre>
<p><strong>Unique indexes:</strong></p>
<div class="sourceCode" id="cb106"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb106-1"><a aria-hidden="true" href="#cb106-1" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">UNIQUE</span> <span class="kw">INDEX</span> idx_email <span class="kw">ON</span> users(email);</span></code></pre></div>
<p>Enforces uniqueness by checking for existing entry before insert.</p>
<p><strong>Multi-column indexes:</strong></p>
<div class="sourceCode" id="cb107"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb107-1"><a aria-hidden="true" href="#cb107-1" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_name <span class="kw">ON</span> users(last_name, first_name);</span></code></pre></div>
<p>Useful for queries on: - <code>WHERE last_name = 'Smith'</code> -
<code>WHERE last_name = 'Smith' AND first_name = 'John'</code></p>
<p>Not useful for: - <code>WHERE first_name = 'John'</code> (doesn‚Äôt use
index)</p>
<p><strong>Index-only scans:</strong></p>
<p>If all needed columns are in index:</p>
<div class="sourceCode" id="cb108"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb108-1"><a aria-hidden="true" href="#cb108-1" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_covering <span class="kw">ON</span> orders(customer_id, order_date);</span>
<span id="cb108-2"><a aria-hidden="true" href="#cb108-2" tabindex="-1"></a><span class="kw">SELECT</span> order_date <span class="kw">FROM</span> orders <span class="kw">WHERE</span> customer_id <span class="op">=</span> <span class="dv">123</span>;</span></code></pre></div>
<p>PostgreSQL can satisfy query from index alone (if visibility map
indicates pages are all-visible).</p>
<p><strong>B-tree deduplication</strong> (PostgreSQL 13+):</p>
<p>Multiple identical keys stored compactly:</p>
<pre><code>Before: (1,tid1), (1,tid2), (1,tid3), (1,tid4)
After:  (1,[tid1,tid2,tid3,tid4])</code></pre>
<p>Reduces index size for non-unique indexes.</p>
<h3 data-number="3.8.3" id="hash-indexes"><span class="header-section-number">3.8.3</span> Hash Indexes</h3>
<p><strong>Hash-based lookup</strong>
(<code>src/backend/access/hash/</code>).</p>
<p><strong>Characteristics:</strong> - Hash function maps keys to bucket
numbers - O(1) average search time - Only equality searches - Not
crash-safe before PostgreSQL 10 - Smaller than B-tree for equality-only
workloads</p>
<p><strong>When to use:</strong> - Only equality comparisons:
<code>WHERE id = 5</code> - No need for ordering or range scans -
Consider B-tree instead for versatility</p>
<p><strong>Supported operators:</strong></p>
<pre><code>= only</code></pre>
<p><strong>Structure:</strong></p>
<pre><code>Hash Function
     ‚Üì
[Bucket 0] ‚Üí [Overflow Page] ‚Üí [Overflow Page]
[Bucket 1] ‚Üí [Overflow Page]
[Bucket 2]
...
[Bucket N]</code></pre>
<p><strong>Hash page types:</strong></p>
<div class="sourceCode" id="cb112"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb112-1"><a aria-hidden="true" href="#cb112-1" tabindex="-1"></a><span class="pp">#define LH_META_PAGE         </span><span class="dv">0</span><span class="pp">  </span><span class="co">/* Meta page (bucket info) */</span></span>
<span id="cb112-2"><a aria-hidden="true" href="#cb112-2" tabindex="-1"></a><span class="pp">#define LH_BUCKET_PAGE       </span><span class="dv">1</span><span class="pp">  </span><span class="co">/* Primary bucket page */</span></span>
<span id="cb112-3"><a aria-hidden="true" href="#cb112-3" tabindex="-1"></a><span class="pp">#define LH_OVERFLOW_PAGE     </span><span class="dv">2</span><span class="pp">  </span><span class="co">/* Overflow page */</span></span>
<span id="cb112-4"><a aria-hidden="true" href="#cb112-4" tabindex="-1"></a><span class="pp">#define LH_BITMAP_PAGE       </span><span class="dv">3</span><span class="pp">  </span><span class="co">/* Bitmap of free pages */</span></span></code></pre></div>
<p><strong>Example:</strong></p>
<div class="sourceCode" id="cb113"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb113-1"><a aria-hidden="true" href="#cb113-1" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_hash <span class="kw">ON</span> users <span class="kw">USING</span> <span class="kw">HASH</span> (email);</span>
<span id="cb113-2"><a aria-hidden="true" href="#cb113-2" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> users <span class="kw">WHERE</span> email <span class="op">=</span> <span class="st">'user@example.com'</span>;</span></code></pre></div>
<p><strong>Hash function:</strong></p>
<p>Uses high-quality hash function to minimize collisions:</p>
<div class="sourceCode" id="cb114"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb114-1"><a aria-hidden="true" href="#cb114-1" tabindex="-1"></a>uint32 hash_any<span class="op">(</span><span class="dt">const</span> <span class="dt">unsigned</span> <span class="dt">char</span> <span class="op">*</span>k<span class="op">,</span> <span class="dt">int</span> keylen<span class="op">);</span></span></code></pre></div>
<p><strong>Bucket splitting:</strong></p>
<p>When bucket gets too full, hash index can split it:</p>
<pre><code>Before:
Hash(key) % 8 ‚Üí Bucket 0

After split:
Hash(key) % 16 ‚Üí Bucket 0 or Bucket 8</code></pre>
<p><strong>Performance:</strong></p>
<ul>
<li>Slightly faster than B-tree for equality</li>
<li>Cannot support range scans or ORDER BY</li>
<li>Less commonly used than B-tree</li>
</ul>
<h3 data-number="3.8.4" id="gist-generalized-search-tree"><span class="header-section-number">3.8.4</span> GiST (Generalized Search
Tree)</h3>
<p><strong>Extensible balanced tree</strong>
(<code>src/backend/access/gist/</code>).</p>
<p><strong>Characteristics:</strong> - Framework for custom index types
- Supports R-tree-like operations - Handles multi-dimensional data -
Customizable via operator classes</p>
<p><strong>When to use:</strong> - Geometric data types (points, boxes,
polygons) - Full-text search (with tsvector) - Range types -
Nearest-neighbor searches - Custom data types</p>
<p><strong>Supported data types:</strong> - Geometric: point, box,
circle, polygon, path - Network: inet, cidr - Text search: tsvector -
Range types: int4range, tsrange, etc.</p>
<p><strong>Structure:</strong></p>
<pre><code>            [Root: MBR of all children]
           /           |            \
    [MBR: A-F]    [MBR: G-M]    [MBR: N-Z]
     /    \         /    \         /    \
  [A-C] [D-F]   [G-I] [J-M]   [N-Q] [R-Z]
   ‚Üì     ‚Üì       ‚Üì     ‚Üì       ‚Üì     ‚Üì
  Data  Data    Data  Data    Data  Data</code></pre>
<p>MBR = Minimum Bounding Rectangle (or equivalent for key space)</p>
<p><strong>Example - geometric search:</strong></p>
<div class="sourceCode" id="cb117"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb117-1"><a aria-hidden="true" href="#cb117-1" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> places (<span class="kw">id</span> <span class="dt">int</span>, location point);</span>
<span id="cb117-2"><a aria-hidden="true" href="#cb117-2" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_location <span class="kw">ON</span> places <span class="kw">USING</span> GIST (location);</span>
<span id="cb117-3"><a aria-hidden="true" href="#cb117-3" tabindex="-1"></a></span>
<span id="cb117-4"><a aria-hidden="true" href="#cb117-4" tabindex="-1"></a><span class="co">-- Find places within box</span></span>
<span id="cb117-5"><a aria-hidden="true" href="#cb117-5" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> places</span>
<span id="cb117-6"><a aria-hidden="true" href="#cb117-6" tabindex="-1"></a><span class="kw">WHERE</span> location <span class="op">&lt;</span>@ box <span class="st">'((0,0),(10,10))'</span>;</span>
<span id="cb117-7"><a aria-hidden="true" href="#cb117-7" tabindex="-1"></a></span>
<span id="cb117-8"><a aria-hidden="true" href="#cb117-8" tabindex="-1"></a><span class="co">-- Nearest neighbor (K-NN)</span></span>
<span id="cb117-9"><a aria-hidden="true" href="#cb117-9" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> places</span>
<span id="cb117-10"><a aria-hidden="true" href="#cb117-10" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> location <span class="op">&lt;-&gt;</span> point <span class="st">'(5,5)'</span></span>
<span id="cb117-11"><a aria-hidden="true" href="#cb117-11" tabindex="-1"></a><span class="kw">LIMIT</span> <span class="dv">10</span>;</span></code></pre></div>
<p><strong>Example - full-text search:</strong></p>
<div class="sourceCode" id="cb118"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb118-1"><a aria-hidden="true" href="#cb118-1" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_fts <span class="kw">ON</span> documents <span class="kw">USING</span> GIST (content_tsv);</span>
<span id="cb118-2"><a aria-hidden="true" href="#cb118-2" tabindex="-1"></a></span>
<span id="cb118-3"><a aria-hidden="true" href="#cb118-3" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> documents</span>
<span id="cb118-4"><a aria-hidden="true" href="#cb118-4" tabindex="-1"></a><span class="kw">WHERE</span> content_tsv @@ to_tsquery(<span class="st">'postgresql &amp; database'</span>);</span></code></pre></div>
<p><strong>GiST operator classes:</strong></p>
<p>Each data type needs an operator class defining: -
<code>consistent</code>: Does entry match scan key? -
<code>union</code>: Compute bounding predicate for entries -
<code>penalty</code>: Cost of adding entry to subtree -
<code>picksplit</code>: How to split overfull page - <code>same</code>:
Are two entries identical? - <code>distance</code>: For K-NN
searches</p>
<p><strong>Lossy indexes:</strong></p>
<p>GiST can be lossy - index returns candidate set that must be
rechecked:</p>
<ol type="1">
<li>Index scan finds candidates</li>
<li>Heap fetch retrieves actual tuples</li>
<li>Recheck condition on actual data</li>
</ol>
<h3 data-number="3.8.5" id="sp-gist-space-partitioned-gist"><span class="header-section-number">3.8.5</span> SP-GiST (Space-Partitioned
GiST)</h3>
<p><strong>Space-partitioning trees</strong>
(<code>src/backend/access/spgist/</code>).</p>
<p><strong>Characteristics:</strong> - Non-balanced trees (unlike GiST)
- Supports partitioned search spaces - Quad-trees, k-d trees, radix
trees - Excellent for certain data distributions</p>
<p><strong>When to use:</strong> - Geometric data with natural
partitioning - IP addresses (radix tree) - Text with prefix searches -
Point data in 2D/3D space</p>
<p><strong>Example - quad-tree for points:</strong></p>
<pre><code>            [Root: (-‚àû,‚àû) √ó (-‚àû,‚àû)]
          /        |        |        \
      NW Quad   NE Quad   SW Quad   SE Quad
     /  |  \   /  |  \   /  |  \   /  |  \
   ... ... ... ... ... ... ... ... ... ...</code></pre>
<p><strong>Example - range types:</strong></p>
<div class="sourceCode" id="cb120"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb120-1"><a aria-hidden="true" href="#cb120-1" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> reservations (room <span class="dt">int</span>, period tsrange);</span>
<span id="cb120-2"><a aria-hidden="true" href="#cb120-2" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_period <span class="kw">ON</span> reservations <span class="kw">USING</span> SPGIST (period);</span>
<span id="cb120-3"><a aria-hidden="true" href="#cb120-3" tabindex="-1"></a></span>
<span id="cb120-4"><a aria-hidden="true" href="#cb120-4" tabindex="-1"></a><span class="co">-- Find overlapping reservations</span></span>
<span id="cb120-5"><a aria-hidden="true" href="#cb120-5" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> reservations</span>
<span id="cb120-6"><a aria-hidden="true" href="#cb120-6" tabindex="-1"></a><span class="kw">WHERE</span> period &amp;&amp; <span class="st">'[2025-11-19 10:00, 2025-11-19 12:00)'</span>:<span class="ch">:tsrange</span>;</span></code></pre></div>
<p><strong>Example - IP addresses:</strong></p>
<div class="sourceCode" id="cb121"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb121-1"><a aria-hidden="true" href="#cb121-1" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> logs (ip inet, <span class="op">..</span>.);</span>
<span id="cb121-2"><a aria-hidden="true" href="#cb121-2" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_ip <span class="kw">ON</span> logs <span class="kw">USING</span> SPGIST (ip);</span>
<span id="cb121-3"><a aria-hidden="true" href="#cb121-3" tabindex="-1"></a></span>
<span id="cb121-4"><a aria-hidden="true" href="#cb121-4" tabindex="-1"></a><span class="co">-- Subnet search</span></span>
<span id="cb121-5"><a aria-hidden="true" href="#cb121-5" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> logs <span class="kw">WHERE</span> ip <span class="op">&lt;&lt;=</span> <span class="st">'192.168.1.0/24'</span>:<span class="ch">:inet</span>;</span></code></pre></div>
<p><strong>SP-GiST operator classes:</strong></p>
<ul>
<li><code>config</code>: Define tree node structure</li>
<li><code>choose</code>: Select subtree for insertion</li>
<li><code>picksplit</code>: How to split node</li>
<li><code>inner_consistent</code>: Which subtrees to search?</li>
<li><code>leaf_consistent</code>: Does leaf match query?</li>
</ul>
<p><strong>Advantages over GiST:</strong></p>
<ul>
<li>Can be more efficient for naturally partitioned data</li>
<li>Often smaller index size</li>
<li>Better for skewed distributions</li>
</ul>
<p><strong>Disadvantages:</strong></p>
<ul>
<li>Not balanced (worst case can be poor)</li>
<li>More complex to implement operator classes</li>
</ul>
<h3 data-number="3.8.6" id="gin-generalized-inverted-index"><span class="header-section-number">3.8.6</span> GIN (Generalized Inverted
Index)</h3>
<p><strong>Inverted index for multi-value columns</strong>
(<code>src/backend/access/gin/</code>).</p>
<p><strong>Characteristics:</strong> - Stores mapping from values to
tuples containing them - Optimized for cases where column contains
multiple values - Excellent for full-text search - Supports arrays,
jsonb, tsvector</p>
<p><strong>When to use:</strong> - Full-text search - Array contains
queries - JSONB queries - Any multi-valued attributes</p>
<p><strong>Structure:</strong></p>
<pre><code>Entry Tree (B-tree):
  "database" ‚Üí Posting Tree ‚Üí [TID1, TID2, TID17, ...]
  "index"    ‚Üí Posting Tree ‚Üí [TID3, TID5, TID17, ...]
  "postgres" ‚Üí Posting Tree ‚Üí [TID1, TID9, TID12, ...]
  ...</code></pre>
<p><strong>Two-level structure:</strong></p>
<ol type="1">
<li><strong>Entry tree</strong>: B-tree of unique indexed values
(lexemes for text)</li>
<li><strong>Posting tree</strong>: B-tree of tuple IDs for each
entry</li>
</ol>
<p><strong>Example - array search:</strong></p>
<div class="sourceCode" id="cb123"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb123-1"><a aria-hidden="true" href="#cb123-1" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> products (<span class="kw">id</span> <span class="dt">int</span>, tags text[]);</span>
<span id="cb123-2"><a aria-hidden="true" href="#cb123-2" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_tags <span class="kw">ON</span> products <span class="kw">USING</span> GIN (tags);</span>
<span id="cb123-3"><a aria-hidden="true" href="#cb123-3" tabindex="-1"></a></span>
<span id="cb123-4"><a aria-hidden="true" href="#cb123-4" tabindex="-1"></a><span class="co">-- Find products with specific tag</span></span>
<span id="cb123-5"><a aria-hidden="true" href="#cb123-5" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> products <span class="kw">WHERE</span> tags @<span class="op">&gt;</span> <span class="dt">ARRAY</span>[<span class="st">'electronics'</span>];</span>
<span id="cb123-6"><a aria-hidden="true" href="#cb123-6" tabindex="-1"></a></span>
<span id="cb123-7"><a aria-hidden="true" href="#cb123-7" tabindex="-1"></a><span class="co">-- Find products with any of these tags</span></span>
<span id="cb123-8"><a aria-hidden="true" href="#cb123-8" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> products <span class="kw">WHERE</span> tags &amp;&amp; <span class="dt">ARRAY</span>[<span class="st">'sale'</span>, <span class="st">'clearance'</span>];</span></code></pre></div>
<p><strong>Example - full-text search:</strong></p>
<div class="sourceCode" id="cb124"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb124-1"><a aria-hidden="true" href="#cb124-1" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_fts <span class="kw">ON</span> documents <span class="kw">USING</span> GIN (to_tsvector(<span class="st">'english'</span>, content));</span>
<span id="cb124-2"><a aria-hidden="true" href="#cb124-2" tabindex="-1"></a></span>
<span id="cb124-3"><a aria-hidden="true" href="#cb124-3" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> documents</span>
<span id="cb124-4"><a aria-hidden="true" href="#cb124-4" tabindex="-1"></a><span class="kw">WHERE</span> to_tsvector(<span class="st">'english'</span>, content) @@ to_tsquery(<span class="st">'english'</span>, <span class="st">'postgresql &amp; performance'</span>);</span></code></pre></div>
<p><strong>Example - JSONB:</strong></p>
<div class="sourceCode" id="cb125"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb125-1"><a aria-hidden="true" href="#cb125-1" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> <span class="kw">events</span> (<span class="kw">id</span> <span class="dt">int</span>, <span class="kw">data</span> jsonb);</span>
<span id="cb125-2"><a aria-hidden="true" href="#cb125-2" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_data <span class="kw">ON</span> <span class="kw">events</span> <span class="kw">USING</span> GIN (<span class="kw">data</span>);</span>
<span id="cb125-3"><a aria-hidden="true" href="#cb125-3" tabindex="-1"></a></span>
<span id="cb125-4"><a aria-hidden="true" href="#cb125-4" tabindex="-1"></a><span class="co">-- Key exists</span></span>
<span id="cb125-5"><a aria-hidden="true" href="#cb125-5" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> <span class="kw">events</span> <span class="kw">WHERE</span> <span class="kw">data</span> ? <span class="st">'user_id'</span>;</span>
<span id="cb125-6"><a aria-hidden="true" href="#cb125-6" tabindex="-1"></a></span>
<span id="cb125-7"><a aria-hidden="true" href="#cb125-7" tabindex="-1"></a><span class="co">-- Key-value match</span></span>
<span id="cb125-8"><a aria-hidden="true" href="#cb125-8" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> <span class="kw">events</span> <span class="kw">WHERE</span> <span class="kw">data</span> @<span class="op">&gt;</span> <span class="st">'{"status": "completed"}'</span>;</span>
<span id="cb125-9"><a aria-hidden="true" href="#cb125-9" tabindex="-1"></a></span>
<span id="cb125-10"><a aria-hidden="true" href="#cb125-10" tabindex="-1"></a><span class="co">-- Path query</span></span>
<span id="cb125-11"><a aria-hidden="true" href="#cb125-11" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> <span class="kw">events</span> <span class="kw">WHERE</span> <span class="kw">data</span> @@ <span class="st">'$.event.type == "click"'</span>;</span></code></pre></div>
<p><strong>GIN build modes:</strong></p>
<div class="sourceCode" id="cb126"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb126-1"><a aria-hidden="true" href="#cb126-1" tabindex="-1"></a><span class="co">-- Fast build (default): uses less maintenance_work_mem</span></span>
<span id="cb126-2"><a aria-hidden="true" href="#cb126-2" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_gin <span class="kw">ON</span> <span class="kw">table</span> <span class="kw">USING</span> GIN (<span class="kw">column</span>);</span>
<span id="cb126-3"><a aria-hidden="true" href="#cb126-3" tabindex="-1"></a></span>
<span id="cb126-4"><a aria-hidden="true" href="#cb126-4" tabindex="-1"></a><span class="co">-- With fastupdate (maintains pending list for inserts)</span></span>
<span id="cb126-5"><a aria-hidden="true" href="#cb126-5" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_gin <span class="kw">ON</span> <span class="kw">table</span> <span class="kw">USING</span> GIN (<span class="kw">column</span>)</span>
<span id="cb126-6"><a aria-hidden="true" href="#cb126-6" tabindex="-1"></a>  <span class="kw">WITH</span> (fastupdate <span class="op">=</span> <span class="kw">on</span>);</span></code></pre></div>
<p><strong>Pending list:</strong></p>
<p>GIN can batch index updates in a pending list:</p>
<pre><code>New insertions ‚Üí [Pending List]
                      ‚Üì
                (periodically merged into main index)</code></pre>
<p>Improves insertion speed but slows queries (must check pending
list).</p>
<p><strong>Configuration:</strong></p>
<div class="sourceCode" id="cb128"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb128-1"><a aria-hidden="true" href="#cb128-1" tabindex="-1"></a><span class="co">-- Set pending list size</span></span>
<span id="cb128-2"><a aria-hidden="true" href="#cb128-2" tabindex="-1"></a><span class="kw">ALTER</span> <span class="kw">INDEX</span> idx_gin <span class="kw">SET</span> (fastupdate <span class="op">=</span> <span class="kw">on</span>);</span>
<span id="cb128-3"><a aria-hidden="true" href="#cb128-3" tabindex="-1"></a><span class="kw">ALTER</span> <span class="kw">INDEX</span> idx_gin <span class="kw">SET</span> (gin_pending_list_limit <span class="op">=</span> <span class="dv">4096</span>); <span class="co">-- KB</span></span>
<span id="cb128-4"><a aria-hidden="true" href="#cb128-4" tabindex="-1"></a></span>
<span id="cb128-5"><a aria-hidden="true" href="#cb128-5" tabindex="-1"></a><span class="co">-- Disable pending list for faster queries</span></span>
<span id="cb128-6"><a aria-hidden="true" href="#cb128-6" tabindex="-1"></a><span class="kw">ALTER</span> <span class="kw">INDEX</span> idx_gin <span class="kw">SET</span> (fastupdate <span class="op">=</span> <span class="kw">off</span>);</span></code></pre></div>
<p><strong>GIN vs GiST for full-text:</strong></p>
<table>
<thead>
<tr>
<th>Aspect</th>
<th>GIN</th>
<th>GiST</th>
</tr>
</thead>
<tbody>
<tr>
<td>Index size</td>
<td>Larger (3x heap)</td>
<td>Smaller (same as heap)</td>
</tr>
<tr>
<td>Build time</td>
<td>Slower</td>
<td>Faster</td>
</tr>
<tr>
<td>Query speed</td>
<td>Faster</td>
<td>Slower</td>
</tr>
<tr>
<td>Update speed</td>
<td>Slower</td>
<td>Faster</td>
</tr>
<tr>
<td>Recommendation</td>
<td>Read-heavy</td>
<td>Write-heavy</td>
</tr>
</tbody>
</table>
<h3 data-number="3.8.7" id="brin-block-range-index"><span class="header-section-number">3.8.7</span> BRIN (Block Range Index)</h3>
<p><strong>Compact index for large sequential data</strong>
(<code>src/backend/access/brin/</code>).</p>
<p><strong>Characteristics:</strong> - Stores summary info for block
ranges - Extremely compact (1000x smaller than B-tree) - Only effective
for correlated data - Introduced in PostgreSQL 9.5</p>
<p><strong>When to use:</strong> - Large tables with naturally ordered
data - Time-series data (append-only) - Logging tables - Data warehouse
fact tables - Any table with strong physical correlation</p>
<p><strong>Structure:</strong></p>
<pre><code>Block Range 0-127:   [min=1, max=500]
Block Range 128-255: [min=501, max=1000]
Block Range 256-383: [min=1001, max=1500]
...</code></pre>
<p><strong>Example:</strong></p>
<div class="sourceCode" id="cb130"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb130-1"><a aria-hidden="true" href="#cb130-1" tabindex="-1"></a><span class="co">-- Time-series table (naturally ordered by time)</span></span>
<span id="cb130-2"><a aria-hidden="true" href="#cb130-2" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> measurements (</span>
<span id="cb130-3"><a aria-hidden="true" href="#cb130-3" tabindex="-1"></a>  <span class="dt">timestamp</span> timestamptz,</span>
<span id="cb130-4"><a aria-hidden="true" href="#cb130-4" tabindex="-1"></a>  sensor_id <span class="dt">int</span>,</span>
<span id="cb130-5"><a aria-hidden="true" href="#cb130-5" tabindex="-1"></a>  <span class="fu">value</span> <span class="dt">numeric</span></span>
<span id="cb130-6"><a aria-hidden="true" href="#cb130-6" tabindex="-1"></a>);</span>
<span id="cb130-7"><a aria-hidden="true" href="#cb130-7" tabindex="-1"></a></span>
<span id="cb130-8"><a aria-hidden="true" href="#cb130-8" tabindex="-1"></a><span class="co">-- BRIN index (128 pages per range by default)</span></span>
<span id="cb130-9"><a aria-hidden="true" href="#cb130-9" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_ts <span class="kw">ON</span> measurements <span class="kw">USING</span> BRIN (<span class="dt">timestamp</span>);</span>
<span id="cb130-10"><a aria-hidden="true" href="#cb130-10" tabindex="-1"></a></span>
<span id="cb130-11"><a aria-hidden="true" href="#cb130-11" tabindex="-1"></a><span class="co">-- Query</span></span>
<span id="cb130-12"><a aria-hidden="true" href="#cb130-12" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> measurements</span>
<span id="cb130-13"><a aria-hidden="true" href="#cb130-13" tabindex="-1"></a><span class="kw">WHERE</span> <span class="dt">timestamp</span> <span class="kw">BETWEEN</span> <span class="st">'2025-11-01'</span> <span class="kw">AND</span> <span class="st">'2025-11-30'</span>;</span></code></pre></div>
<p><strong>BRIN scan:</strong></p>
<ol type="1">
<li>Lookup block ranges overlapping query predicate</li>
<li>Scan those block ranges</li>
<li>Filter results (index is lossy)</li>
</ol>
<p><strong>Example - highly effective:</strong></p>
<pre><code>Table: log entries inserted in timestamp order
Index size: 100 KB
Table size: 100 GB
Ratio: 0.0001%

Query scans only blocks with matching ranges</code></pre>
<p><strong>Example - ineffective:</strong></p>
<pre><code>Table: randomly inserted data (no correlation)
BRIN returns all block ranges ‚Üí full table scan
B-tree would be much better</code></pre>
<p><strong>Configuration:</strong></p>
<div class="sourceCode" id="cb133"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb133-1"><a aria-hidden="true" href="#cb133-1" tabindex="-1"></a><span class="co">-- Smaller ranges (better selectivity, larger index)</span></span>
<span id="cb133-2"><a aria-hidden="true" href="#cb133-2" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_brin <span class="kw">ON</span> <span class="kw">table</span> <span class="kw">USING</span> BRIN (<span class="kw">column</span>)</span>
<span id="cb133-3"><a aria-hidden="true" href="#cb133-3" tabindex="-1"></a>  <span class="kw">WITH</span> (pages_per_range <span class="op">=</span> <span class="dv">64</span>);</span>
<span id="cb133-4"><a aria-hidden="true" href="#cb133-4" tabindex="-1"></a></span>
<span id="cb133-5"><a aria-hidden="true" href="#cb133-5" tabindex="-1"></a><span class="co">-- Larger ranges (smaller index, less selective)</span></span>
<span id="cb133-6"><a aria-hidden="true" href="#cb133-6" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_brin <span class="kw">ON</span> <span class="kw">table</span> <span class="kw">USING</span> BRIN (<span class="kw">column</span>)</span>
<span id="cb133-7"><a aria-hidden="true" href="#cb133-7" tabindex="-1"></a>  <span class="kw">WITH</span> (pages_per_range <span class="op">=</span> <span class="dv">256</span>);</span></code></pre></div>
<p><strong>BRIN operator classes:</strong></p>
<ul>
<li><strong>minmax</strong>: Stores min/max values (default)</li>
<li><strong>inclusion</strong>: Stores bounding values for geometric
types</li>
<li><strong>bloom</strong>: Uses bloom filter for equality (PostgreSQL
14+)</li>
</ul>
<p><strong>Checking correlation:</strong></p>
<div class="sourceCode" id="cb134"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb134-1"><a aria-hidden="true" href="#cb134-1" tabindex="-1"></a><span class="kw">SELECT</span> attname, correlation</span>
<span id="cb134-2"><a aria-hidden="true" href="#cb134-2" tabindex="-1"></a><span class="kw">FROM</span> pg_stats</span>
<span id="cb134-3"><a aria-hidden="true" href="#cb134-3" tabindex="-1"></a><span class="kw">WHERE</span> tablename <span class="op">=</span> <span class="st">'measurements'</span></span>
<span id="cb134-4"><a aria-hidden="true" href="#cb134-4" tabindex="-1"></a>  <span class="kw">AND</span> attname <span class="op">=</span> <span class="st">'timestamp'</span>;</span>
<span id="cb134-5"><a aria-hidden="true" href="#cb134-5" tabindex="-1"></a></span>
<span id="cb134-6"><a aria-hidden="true" href="#cb134-6" tabindex="-1"></a><span class="co">-- correlation near 1.0 or -1.0: BRIN very effective</span></span>
<span id="cb134-7"><a aria-hidden="true" href="#cb134-7" tabindex="-1"></a><span class="co">-- correlation near 0.0: BRIN ineffective</span></span></code></pre></div>
<p><strong>BRIN maintenance:</strong></p>
<div class="sourceCode" id="cb135"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb135-1"><a aria-hidden="true" href="#cb135-1" tabindex="-1"></a><span class="co">-- Summarize new blocks</span></span>
<span id="cb135-2"><a aria-hidden="true" href="#cb135-2" tabindex="-1"></a><span class="kw">SELECT</span> brin_summarize_new_values(<span class="st">'idx_brin'</span>);</span>
<span id="cb135-3"><a aria-hidden="true" href="#cb135-3" tabindex="-1"></a></span>
<span id="cb135-4"><a aria-hidden="true" href="#cb135-4" tabindex="-1"></a><span class="co">-- Rebuild index</span></span>
<span id="cb135-5"><a aria-hidden="true" href="#cb135-5" tabindex="-1"></a>REINDEX <span class="kw">INDEX</span> idx_brin;</span></code></pre></div>
<p><strong>BRIN advantages:</strong></p>
<ul>
<li>Minuscule index size</li>
<li>Fast index creation</li>
<li>Minimal maintenance overhead</li>
<li>Perfect for append-only data</li>
</ul>
<p><strong>BRIN limitations:</strong></p>
<ul>
<li>Requires strong physical correlation</li>
<li>Lossy (must recheck heap)</li>
<li>Only effective for certain workloads</li>
<li>Not useful for random access</li>
</ul>
<h3 data-number="3.8.8" id="index-comparison-summary"><span class="header-section-number">3.8.8</span> Index Comparison Summary</h3>
<table>
<colgroup>
<col style="width: 17%"/>
<col style="width: 14%"/>
<col style="width: 8%"/>
<col style="width: 17%"/>
<col style="width: 19%"/>
<col style="width: 20%"/>
</colgroup>
<thead>
<tr>
<th>Index Type</th>
<th>Best For</th>
<th>Size</th>
<th>Build Time</th>
<th>Query Speed</th>
<th>Update Speed</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>B-tree</strong></td>
<td>General purpose, ordering</td>
<td>Medium</td>
<td>Medium</td>
<td>Fast</td>
<td>Medium</td>
</tr>
<tr>
<td><strong>Hash</strong></td>
<td>Equality only</td>
<td>Small</td>
<td>Fast</td>
<td>Fast</td>
<td>Medium</td>
</tr>
<tr>
<td><strong>GiST</strong></td>
<td>Geometric, full-text (writes)</td>
<td>Medium</td>
<td>Fast</td>
<td>Medium</td>
<td>Fast</td>
</tr>
<tr>
<td><strong>SP-GiST</strong></td>
<td>Partitioned data, IPs</td>
<td>Small</td>
<td>Medium</td>
<td>Fast</td>
<td>Medium</td>
</tr>
<tr>
<td><strong>GIN</strong></td>
<td>Full-text, arrays, JSONB</td>
<td>Large</td>
<td>Slow</td>
<td>Very Fast</td>
<td>Slow</td>
</tr>
<tr>
<td><strong>BRIN</strong></td>
<td>Sequential/time-series</td>
<td>Tiny</td>
<td>Very Fast</td>
<td>Medium*</td>
<td>Fast</td>
</tr>
</tbody>
</table>
<p>*BRIN query speed depends on data correlation</p>
<h3 data-number="3.8.9" id="index-maintenance"><span class="header-section-number">3.8.9</span> Index Maintenance</h3>
<p><strong>VACUUM and indexes:</strong></p>
<p>VACUUM cleans up dead index entries:</p>
<div class="sourceCode" id="cb136"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb136-1"><a aria-hidden="true" href="#cb136-1" tabindex="-1"></a>VACUUM <span class="kw">ANALYZE</span> tablename;</span></code></pre></div>
<p><strong>REINDEX:</strong></p>
<p>Rebuild index from scratch:</p>
<div class="sourceCode" id="cb137"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb137-1"><a aria-hidden="true" href="#cb137-1" tabindex="-1"></a>REINDEX <span class="kw">INDEX</span> idx_name;</span>
<span id="cb137-2"><a aria-hidden="true" href="#cb137-2" tabindex="-1"></a>REINDEX <span class="kw">TABLE</span> tablename;</span>
<span id="cb137-3"><a aria-hidden="true" href="#cb137-3" tabindex="-1"></a>REINDEX <span class="kw">DATABASE</span> dbname;  <span class="co">-- PostgreSQL 12+</span></span></code></pre></div>
<p>Useful for: - Recovering from index corruption - Eliminating bloat -
Switching index storage parameters</p>
<p><strong>CREATE INDEX CONCURRENTLY:</strong></p>
<p>Build index without blocking writes:</p>
<div class="sourceCode" id="cb138"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb138-1"><a aria-hidden="true" href="#cb138-1" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> CONCURRENTLY idx_name <span class="kw">ON</span> <span class="kw">table</span> (<span class="kw">column</span>);</span></code></pre></div>
<p>Process: 1. Create index in ‚Äúinvalid‚Äù state 2. Wait for transactions
to finish 3. Build index with 2-phase scan 4. Mark index valid</p>
<p><strong>REINDEX CONCURRENTLY</strong> (PostgreSQL 12+):</p>
<div class="sourceCode" id="cb139"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb139-1"><a aria-hidden="true" href="#cb139-1" tabindex="-1"></a>REINDEX <span class="kw">INDEX</span> CONCURRENTLY idx_name;</span></code></pre></div>
<p><strong>Index bloat:</strong></p>
<div class="sourceCode" id="cb140"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb140-1"><a aria-hidden="true" href="#cb140-1" tabindex="-1"></a><span class="co">-- Check index bloat</span></span>
<span id="cb140-2"><a aria-hidden="true" href="#cb140-2" tabindex="-1"></a><span class="kw">SELECT</span> schemaname, tablename, indexname,</span>
<span id="cb140-3"><a aria-hidden="true" href="#cb140-3" tabindex="-1"></a>  pg_size_pretty(pg_relation_size(indexrelid)) <span class="kw">AS</span> index_size,</span>
<span id="cb140-4"><a aria-hidden="true" href="#cb140-4" tabindex="-1"></a>  idx_scan, idx_tup_read, idx_tup_fetch</span>
<span id="cb140-5"><a aria-hidden="true" href="#cb140-5" tabindex="-1"></a><span class="kw">FROM</span> pg_stat_user_indexes</span>
<span id="cb140-6"><a aria-hidden="true" href="#cb140-6" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> pg_relation_size(indexrelid) <span class="kw">DESC</span>;</span></code></pre></div>
<h3 data-number="3.8.10" id="partial-indexes"><span class="header-section-number">3.8.10</span> Partial Indexes</h3>
<p>Index only subset of table:</p>
<div class="sourceCode" id="cb141"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb141-1"><a aria-hidden="true" href="#cb141-1" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_active_users <span class="kw">ON</span> users (email)</span>
<span id="cb141-2"><a aria-hidden="true" href="#cb141-2" tabindex="-1"></a><span class="kw">WHERE</span> active <span class="op">=</span> <span class="kw">true</span>;</span></code></pre></div>
<p>Benefits: - Smaller index - Faster index operations - Query must
include WHERE clause condition</p>
<h3 data-number="3.8.11" id="expression-indexes"><span class="header-section-number">3.8.11</span> Expression Indexes</h3>
<p>Index computed expression:</p>
<div class="sourceCode" id="cb142"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb142-1"><a aria-hidden="true" href="#cb142-1" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_lower_email <span class="kw">ON</span> users (<span class="fu">lower</span>(email));</span>
<span id="cb142-2"><a aria-hidden="true" href="#cb142-2" tabindex="-1"></a></span>
<span id="cb142-3"><a aria-hidden="true" href="#cb142-3" tabindex="-1"></a><span class="co">-- Query uses index</span></span>
<span id="cb142-4"><a aria-hidden="true" href="#cb142-4" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> users <span class="kw">WHERE</span> <span class="fu">lower</span>(email) <span class="op">=</span> <span class="st">'user@example.com'</span>;</span></code></pre></div>
<h3 data-number="3.8.12" id="index-only-scans"><span class="header-section-number">3.8.12</span> Index-Only Scans</h3>
<p>When index contains all needed columns:</p>
<div class="sourceCode" id="cb143"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb143-1"><a aria-hidden="true" href="#cb143-1" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_covering <span class="kw">ON</span> orders (customer_id, order_date, total);</span>
<span id="cb143-2"><a aria-hidden="true" href="#cb143-2" tabindex="-1"></a></span>
<span id="cb143-3"><a aria-hidden="true" href="#cb143-3" tabindex="-1"></a><span class="co">-- Index-only scan possible</span></span>
<span id="cb143-4"><a aria-hidden="true" href="#cb143-4" tabindex="-1"></a><span class="kw">SELECT</span> order_date, total</span>
<span id="cb143-5"><a aria-hidden="true" href="#cb143-5" tabindex="-1"></a><span class="kw">FROM</span> orders</span>
<span id="cb143-6"><a aria-hidden="true" href="#cb143-6" tabindex="-1"></a><span class="kw">WHERE</span> customer_id <span class="op">=</span> <span class="dv">123</span>;</span></code></pre></div>
<p>Requires: - All columns in SELECT/WHERE in index - Pages marked
all-visible in visibility map</p>
<p>Check with:</p>
<div class="sourceCode" id="cb144"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb144-1"><a aria-hidden="true" href="#cb144-1" tabindex="-1"></a><span class="kw">EXPLAIN</span> (<span class="kw">ANALYZE</span>, BUFFERS)</span>
<span id="cb144-2"><a aria-hidden="true" href="#cb144-2" tabindex="-1"></a><span class="kw">SELECT</span> order_date, total <span class="kw">FROM</span> orders <span class="kw">WHERE</span> customer_id <span class="op">=</span> <span class="dv">123</span>;</span></code></pre></div>
<p>Look for ‚ÄúIndex Only Scan‚Äù in plan.</p>
<h2 data-number="3.9" id="free-space-map"><span class="header-section-number">3.9</span> Free Space Map</h2>
<h3 data-number="3.9.1" id="overview-6"><span class="header-section-number">3.9.1</span> Overview</h3>
<p>The Free Space Map (FSM) is an auxiliary data structure that tracks
available free space in each page of a heap relation. Located in
<code>src/backend/storage/freespace/</code>, it enables PostgreSQL to
efficiently find pages with sufficient space for new tuples without
scanning the entire table.</p>
<p>The FSM is stored in a separate fork of the relation file:</p>
<pre><code>$PGDATA/base/&lt;database_oid&gt;/&lt;relation_oid&gt;_fsm</code></pre>
<h3 data-number="3.9.2" id="purpose-and-benefits"><span class="header-section-number">3.9.2</span> Purpose and Benefits</h3>
<p><strong>Without FSM:</strong></p>
<pre><code>INSERT needs 100 bytes
‚Üí Scan every page until finding one with ‚â•100 bytes free
‚Üí O(N) search time</code></pre>
<p><strong>With FSM:</strong></p>
<pre><code>INSERT needs 100 bytes
‚Üí Query FSM for page with ‚â•100 bytes
‚Üí O(log N) search time</code></pre>
<p><strong>Benefits:</strong></p>
<ol type="1">
<li>Fast insertion into tables with free space</li>
<li>Reduced table bloat (reuses existing pages)</li>
<li>Improves UPDATE performance (especially HOT updates)</li>
<li>Essential for large tables</li>
</ol>
<h3 data-number="3.9.3" id="fsm-structure"><span class="header-section-number">3.9.3</span> FSM Structure</h3>
<p>The FSM is organized as a <strong>tree of pages</strong>:</p>
<pre><code>                    [Root FSM Page]
                    Max free space across all children
                   /        |        \
            [Level 1]   [Level 1]   [Level 1]
            Max for     Max for     Max for
            children    children    children
           /    |    \
    [Leaf] [Leaf] [Leaf] ...
    Max free in heap pages (1 leaf per ~4000 heap pages)</code></pre>
<p><strong>Key characteristics:</strong></p>
<ul>
<li>Each FSM leaf page tracks ~4000 heap pages</li>
<li>Each entry stores max free space as category (0-255)</li>
<li>Internal pages store maximum of children</li>
<li>Tree structure allows efficient search</li>
</ul>
<p><strong>Free space categories:</strong></p>
<p>Free space stored as 1 byte per page:</p>
<div class="sourceCode" id="cb149"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb149-1"><a aria-hidden="true" href="#cb149-1" tabindex="-1"></a><span class="co">/* Convert bytes to FSM category (0-255) */</span></span>
<span id="cb149-2"><a aria-hidden="true" href="#cb149-2" tabindex="-1"></a><span class="dt">static</span> uint8 fsm_space_needed_to_cat<span class="op">(</span>Size needed<span class="op">)</span></span>
<span id="cb149-3"><a aria-hidden="true" href="#cb149-3" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb149-4"><a aria-hidden="true" href="#cb149-4" tabindex="-1"></a>    <span class="co">/* Category represents free space in ~32-byte increments */</span></span>
<span id="cb149-5"><a aria-hidden="true" href="#cb149-5" tabindex="-1"></a>    <span class="co">/* 0 = 0-31 bytes, 1 = 32-63 bytes, ..., 255 = 8160-8192 bytes */</span></span>
<span id="cb149-6"><a aria-hidden="true" href="#cb149-6" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>This lossy representation trades precision for compact storage.</p>
<h3 data-number="3.9.4" id="fsm-page-format"><span class="header-section-number">3.9.4</span> FSM Page Format</h3>
<p>FSM pages follow standard page layout with special content:</p>
<div class="sourceCode" id="cb150"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb150-1"><a aria-hidden="true" href="#cb150-1" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> FSMPageData</span>
<span id="cb150-2"><a aria-hidden="true" href="#cb150-2" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb150-3"><a aria-hidden="true" href="#cb150-3" tabindex="-1"></a>    PageHeaderData pd<span class="op">;</span>  <span class="co">/* Standard page header */</span></span>
<span id="cb150-4"><a aria-hidden="true" href="#cb150-4" tabindex="-1"></a></span>
<span id="cb150-5"><a aria-hidden="true" href="#cb150-5" tabindex="-1"></a>    <span class="co">/* Array of free space categories */</span></span>
<span id="cb150-6"><a aria-hidden="true" href="#cb150-6" tabindex="-1"></a>    uint8 fp_nodes<span class="op">[</span>FLEXIBLE_ARRAY_MEMBER<span class="op">];</span></span>
<span id="cb150-7"><a aria-hidden="true" href="#cb150-7" tabindex="-1"></a><span class="op">}</span> FSMPageData<span class="op">;</span></span></code></pre></div>
<p><strong>Constants:</strong></p>
<div class="sourceCode" id="cb151"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb151-1"><a aria-hidden="true" href="#cb151-1" tabindex="-1"></a><span class="pp">#define BLCKSZ </span><span class="dv">8192</span><span class="pp">                    </span><span class="co">/* Page size */</span></span>
<span id="cb151-2"><a aria-hidden="true" href="#cb151-2" tabindex="-1"></a><span class="pp">#define FSM_TREE_DEPTH </span><span class="op">((</span><span class="pp">BLCKSZ </span><span class="op">-</span><span class="pp"> </span><span class="dv">1</span><span class="op">)</span><span class="pp"> </span><span class="op">/</span><span class="pp"> </span><span class="dv">2</span><span class="op">)</span><span class="pp">  </span><span class="co">/* Tree levels on page */</span></span>
<span id="cb151-3"><a aria-hidden="true" href="#cb151-3" tabindex="-1"></a><span class="pp">#define SlotsPerFSMPage </span><span class="dv">4096</span><span class="pp">           </span><span class="co">/* Heap pages tracked per FSM leaf */</span></span></code></pre></div>
<h3 data-number="3.9.5" id="fsm-operations"><span class="header-section-number">3.9.5</span> FSM Operations</h3>
<p><strong>Recording free space</strong>
(<code>RecordPageWithFreeSpace</code>):</p>
<div class="sourceCode" id="cb152"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb152-1"><a aria-hidden="true" href="#cb152-1" tabindex="-1"></a><span class="dt">void</span> RecordPageWithFreeSpace<span class="op">(</span>Relation rel<span class="op">,</span> BlockNumber heapBlk<span class="op">,</span> Size spaceAvail<span class="op">)</span></span>
<span id="cb152-2"><a aria-hidden="true" href="#cb152-2" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb152-3"><a aria-hidden="true" href="#cb152-3" tabindex="-1"></a>    <span class="co">/* Convert space to category */</span></span>
<span id="cb152-4"><a aria-hidden="true" href="#cb152-4" tabindex="-1"></a>    uint8 cat <span class="op">=</span> fsm_space_avail_to_cat<span class="op">(</span>spaceAvail<span class="op">);</span></span>
<span id="cb152-5"><a aria-hidden="true" href="#cb152-5" tabindex="-1"></a></span>
<span id="cb152-6"><a aria-hidden="true" href="#cb152-6" tabindex="-1"></a>    <span class="co">/* Update FSM tree */</span></span>
<span id="cb152-7"><a aria-hidden="true" href="#cb152-7" tabindex="-1"></a>    fsm_set_avail<span class="op">(</span>rel<span class="op">,</span> heapBlk<span class="op">,</span> cat<span class="op">);</span></span>
<span id="cb152-8"><a aria-hidden="true" href="#cb152-8" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Called by: - Heap insert (after adding tuple) - VACUUM (after
reclaiming space) - Page pruning operations</p>
<p><strong>Searching for free space</strong>
(<code>GetPageWithFreeSpace</code>):</p>
<div class="sourceCode" id="cb153"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb153-1"><a aria-hidden="true" href="#cb153-1" tabindex="-1"></a>BlockNumber GetPageWithFreeSpace<span class="op">(</span>Relation rel<span class="op">,</span> Size spaceNeeded<span class="op">)</span></span>
<span id="cb153-2"><a aria-hidden="true" href="#cb153-2" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb153-3"><a aria-hidden="true" href="#cb153-3" tabindex="-1"></a>    <span class="co">/* Convert needed space to category */</span></span>
<span id="cb153-4"><a aria-hidden="true" href="#cb153-4" tabindex="-1"></a>    uint8 cat <span class="op">=</span> fsm_space_needed_to_cat<span class="op">(</span>spaceNeeded<span class="op">);</span></span>
<span id="cb153-5"><a aria-hidden="true" href="#cb153-5" tabindex="-1"></a></span>
<span id="cb153-6"><a aria-hidden="true" href="#cb153-6" tabindex="-1"></a>    <span class="co">/* Search FSM tree for page with enough space */</span></span>
<span id="cb153-7"><a aria-hidden="true" href="#cb153-7" tabindex="-1"></a>    BlockNumber blk <span class="op">=</span> fsm_search<span class="op">(</span>rel<span class="op">,</span> cat<span class="op">);</span></span>
<span id="cb153-8"><a aria-hidden="true" href="#cb153-8" tabindex="-1"></a></span>
<span id="cb153-9"><a aria-hidden="true" href="#cb153-9" tabindex="-1"></a>    <span class="cf">return</span> blk<span class="op">;</span></span>
<span id="cb153-10"><a aria-hidden="true" href="#cb153-10" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>Search algorithm:</strong></p>
<ol type="1">
<li>Start at FSM root</li>
<li>Find child with max space ‚â• requested</li>
<li>Descend to that child</li>
<li>Repeat until reaching leaf</li>
<li>Return heap page number</li>
</ol>
<p>Time complexity: O(log N) where N is number of heap pages</p>
<h3 data-number="3.9.6" id="fsm-maintenance"><span class="header-section-number">3.9.6</span> FSM Maintenance</h3>
<p><strong>VACUUM updates FSM:</strong></p>
<div class="sourceCode" id="cb154"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb154-1"><a aria-hidden="true" href="#cb154-1" tabindex="-1"></a><span class="co">/* During VACUUM */</span></span>
<span id="cb154-2"><a aria-hidden="true" href="#cb154-2" tabindex="-1"></a><span class="cf">for</span> each heap page<span class="op">:</span></span>
<span id="cb154-3"><a aria-hidden="true" href="#cb154-3" tabindex="-1"></a>    count free space</span>
<span id="cb154-4"><a aria-hidden="true" href="#cb154-4" tabindex="-1"></a>    RecordPageWithFreeSpace<span class="op">(</span>page_num<span class="op">,</span> free_space<span class="op">)</span></span></code></pre></div>
<p><strong>Truncating FSM:</strong></p>
<p>When VACUUM truncates empty pages from end of table:</p>
<div class="sourceCode" id="cb155"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb155-1"><a aria-hidden="true" href="#cb155-1" tabindex="-1"></a>FreeSpaceMapTruncateRel<span class="op">(</span>rel<span class="op">,</span> nblocks<span class="op">);</span></span></code></pre></div>
<p>Removes FSM entries for removed heap pages.</p>
<h3 data-number="3.9.7" id="fsm-visibility"><span class="header-section-number">3.9.7</span> FSM Visibility</h3>
<p><strong>pg_freespacemap extension:</strong></p>
<div class="sourceCode" id="cb156"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb156-1"><a aria-hidden="true" href="#cb156-1" tabindex="-1"></a><span class="kw">CREATE</span> EXTENSION pg_freespacemap;</span>
<span id="cb156-2"><a aria-hidden="true" href="#cb156-2" tabindex="-1"></a></span>
<span id="cb156-3"><a aria-hidden="true" href="#cb156-3" tabindex="-1"></a><span class="co">-- View free space in a table</span></span>
<span id="cb156-4"><a aria-hidden="true" href="#cb156-4" tabindex="-1"></a><span class="kw">SELECT</span> blkno, avail</span>
<span id="cb156-5"><a aria-hidden="true" href="#cb156-5" tabindex="-1"></a><span class="kw">FROM</span> pg_freespace(<span class="st">'tablename'</span>)</span>
<span id="cb156-6"><a aria-hidden="true" href="#cb156-6" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> blkno</span>
<span id="cb156-7"><a aria-hidden="true" href="#cb156-7" tabindex="-1"></a><span class="kw">LIMIT</span> <span class="dv">20</span>;</span>
<span id="cb156-8"><a aria-hidden="true" href="#cb156-8" tabindex="-1"></a></span>
<span id="cb156-9"><a aria-hidden="true" href="#cb156-9" tabindex="-1"></a><span class="co">-- Aggregate statistics</span></span>
<span id="cb156-10"><a aria-hidden="true" href="#cb156-10" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb156-11"><a aria-hidden="true" href="#cb156-11" tabindex="-1"></a>  <span class="cf">CASE</span></span>
<span id="cb156-12"><a aria-hidden="true" href="#cb156-12" tabindex="-1"></a>    <span class="cf">WHEN</span> avail <span class="op">=</span> <span class="dv">0</span> <span class="cf">THEN</span> <span class="st">'full'</span></span>
<span id="cb156-13"><a aria-hidden="true" href="#cb156-13" tabindex="-1"></a>    <span class="cf">WHEN</span> avail <span class="op">&lt;</span> <span class="dv">64</span> <span class="cf">THEN</span> <span class="st">'mostly full'</span></span>
<span id="cb156-14"><a aria-hidden="true" href="#cb156-14" tabindex="-1"></a>    <span class="cf">WHEN</span> avail <span class="op">&lt;</span> <span class="dv">128</span> <span class="cf">THEN</span> <span class="st">'half full'</span></span>
<span id="cb156-15"><a aria-hidden="true" href="#cb156-15" tabindex="-1"></a>    <span class="cf">ELSE</span> <span class="st">'mostly empty'</span></span>
<span id="cb156-16"><a aria-hidden="true" href="#cb156-16" tabindex="-1"></a>  <span class="cf">END</span> <span class="kw">AS</span> <span class="kw">category</span>,</span>
<span id="cb156-17"><a aria-hidden="true" href="#cb156-17" tabindex="-1"></a>  <span class="fu">count</span>(<span class="op">*</span>) <span class="kw">AS</span> pages</span>
<span id="cb156-18"><a aria-hidden="true" href="#cb156-18" tabindex="-1"></a><span class="kw">FROM</span> pg_freespace(<span class="st">'tablename'</span>)</span>
<span id="cb156-19"><a aria-hidden="true" href="#cb156-19" tabindex="-1"></a><span class="kw">GROUP</span> <span class="kw">BY</span> <span class="kw">category</span>;</span></code></pre></div>
<h3 data-number="3.9.8" id="fsm-and-table-bloat"><span class="header-section-number">3.9.8</span> FSM and Table Bloat</h3>
<p><strong>Scenario: High UPDATE rate</strong></p>
<pre><code>Initial:  Table has 1000 pages, all full
UPDATE:   Creates new tuple versions
          Dead tuples remain until VACUUM
VACUUM:   Reclaims space, updates FSM
INSERT:   Uses FSM to find pages with space (reuses existing pages)</code></pre>
<p><strong>Without proper VACUUM:</strong></p>
<pre><code>Dead tuples accumulate
FSM not updated ‚Üí INSERTs extend table
Table grows unnecessarily (bloat)</code></pre>
<p><strong>With regular VACUUM:</strong></p>
<pre><code>Dead space reclaimed
FSM updated with free space
INSERTs reuse existing pages
Table size stable</code></pre>
<h3 data-number="3.9.9" id="fsm-limitations"><span class="header-section-number">3.9.9</span> FSM Limitations</h3>
<p><strong>Lossy representation:</strong></p>
<ul>
<li>Only 256 categories for 8KB of space</li>
<li>Precision: ~32 bytes</li>
<li>May occasionally return page without enough space</li>
<li>Fallback: Extend table with new page</li>
</ul>
<p><strong>Not crash-safe independently:</strong></p>
<ul>
<li>FSM is a hint, not authoritative</li>
<li>Inconsistent FSM doesn‚Äôt cause corruption</li>
<li>Worst case: slightly inefficient space usage</li>
<li>VACUUM rebuilds accurate FSM</li>
</ul>
<p><strong>Manual FSM repair:</strong></p>
<p>If FSM becomes inaccurate:</p>
<div class="sourceCode" id="cb160"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb160-1"><a aria-hidden="true" href="#cb160-1" tabindex="-1"></a>VACUUM tablename;  <span class="co">-- Rebuilds FSM</span></span></code></pre></div>
<p>Or for all tables:</p>
<div class="sourceCode" id="cb161"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb161-1"><a aria-hidden="true" href="#cb161-1" tabindex="-1"></a>VACUUM;  <span class="co">-- Database-wide</span></span></code></pre></div>
<h3 data-number="3.9.10" id="fsm-performance-impact"><span class="header-section-number">3.9.10</span> FSM Performance Impact</h3>
<p><strong>Benefits:</strong></p>
<ul>
<li>O(log N) insertion vs O(N) without FSM</li>
<li>Reduces table growth</li>
<li>Enables efficient space reuse</li>
</ul>
<p><strong>Overhead:</strong></p>
<ul>
<li>Minimal: ~0.2% storage (1 byte per 4000 heap bytes)</li>
<li>FSM updates are cheap (just setting a byte)</li>
<li>Read during INSERT (1-2 FSM page reads)</li>
</ul>
<p><strong>Example: 100 GB table</strong></p>
<pre><code>Heap: 100 GB
FSM:  ~25 MB (0.025% overhead)
Visibility Map: ~12.5 MB

Total overhead: ~37.5 MB (0.0375%)</code></pre>
<h3 data-number="3.9.11" id="fsm-code-locations"><span class="header-section-number">3.9.11</span> FSM Code Locations</h3>
<p><strong>Core FSM functions</strong>
(<code>src/backend/storage/freespace/freespace.c</code>):</p>
<ul>
<li><code>GetPageWithFreeSpace</code>: Find page with free space</li>
<li><code>RecordPageWithFreeSpace</code>: Update FSM with page‚Äôs free
space</li>
<li><code>GetRecordedFreeSpace</code>: Query FSM for page‚Äôs free
space</li>
<li><code>FreeSpaceMapTruncateRel</code>: Truncate FSM</li>
<li><code>FreeSpaceMapVacuum</code>: VACUUM FSM itself</li>
</ul>
<p><strong>FSM tree operations</strong>
(<code>src/backend/storage/freespace/fsmpage.c</code>):</p>
<ul>
<li><code>fsm_search</code>: Search tree for page with space</li>
<li><code>fsm_set_avail</code>: Update tree with new free space
value</li>
<li><code>fsm_get_avail</code>: Read free space value</li>
</ul>
<h2 data-number="3.10" id="visibility-map"><span class="header-section-number">3.10</span> Visibility Map</h2>
<h3 data-number="3.10.1" id="overview-7"><span class="header-section-number">3.10.1</span> Overview</h3>
<p>The Visibility Map (VM) is a bitmap tracking which pages contain only
tuples that are visible to all transactions. Located in
<code>src/backend/access/heap/visibilitymap.c</code>, it serves two
critical purposes:</p>
<ol type="1">
<li><strong>Optimize VACUUM</strong>: Skip pages where all tuples are
visible</li>
<li><strong>Enable index-only scans</strong>: Avoid heap fetches when
possible</li>
</ol>
<p>The VM is stored in a separate fork:</p>
<pre><code>$PGDATA/base/&lt;database_oid&gt;/&lt;relation_oid&gt;_vm</code></pre>
<h3 data-number="3.10.2" id="structure"><span class="header-section-number">3.10.2</span> Structure</h3>
<p>The VM is a bitmap with 2 bits per heap page:</p>
<div class="sourceCode" id="cb164"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb164-1"><a aria-hidden="true" href="#cb164-1" tabindex="-1"></a><span class="pp">#define VISIBILITYMAP_ALL_VISIBLE   </span><span class="bn">0x01</span><span class="pp">  </span><span class="co">/* All tuples visible */</span></span>
<span id="cb164-2"><a aria-hidden="true" href="#cb164-2" tabindex="-1"></a><span class="pp">#define VISIBILITYMAP_ALL_FROZEN    </span><span class="bn">0x02</span><span class="pp">  </span><span class="co">/* All tuples frozen */</span></span></code></pre></div>
<p><strong>Bit meanings:</strong></p>
<ul>
<li><strong>ALL_VISIBLE</strong>: All tuples on page are visible to all
current and future transactions</li>
<li><strong>ALL_FROZEN</strong>: All tuples have been frozen (t_xmin
replaced with FrozenTransactionId)</li>
</ul>
<p><strong>Storage efficiency:</strong></p>
<pre><code>1 heap page (8 KB) ‚Üí 2 bits in VM
1 VM page (8 KB) ‚Üí tracks 32,768 heap pages (256 MB)

VM size ‚âà heap size / 32,768
Example: 100 GB table ‚Üí ~3.2 MB visibility map</code></pre>
<h3 data-number="3.10.3" id="when-pages-become-all-visible"><span class="header-section-number">3.10.3</span> When Pages Become
All-Visible</h3>
<p>A page can be marked all-visible when:</p>
<ol type="1">
<li>All tuples on page are visible to all transactions</li>
<li>No in-progress transactions when VACUUM runs</li>
<li>VACUUM has verified all tuples</li>
</ol>
<p><strong>Process:</strong></p>
<div class="sourceCode" id="cb166"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb166-1"><a aria-hidden="true" href="#cb166-1" tabindex="-1"></a><span class="co">/* During VACUUM */</span></span>
<span id="cb166-2"><a aria-hidden="true" href="#cb166-2" tabindex="-1"></a><span class="cf">for</span> each heap page<span class="op">:</span></span>
<span id="cb166-3"><a aria-hidden="true" href="#cb166-3" tabindex="-1"></a>    <span class="cf">if</span> all tuples visible to all transactions<span class="op">:</span></span>
<span id="cb166-4"><a aria-hidden="true" href="#cb166-4" tabindex="-1"></a>        visibilitymap_set<span class="op">(</span>rel<span class="op">,</span> page<span class="op">,</span> ALL_VISIBLE<span class="op">)</span></span></code></pre></div>
<h3 data-number="3.10.4" id="when-pages-become-not-all-visible"><span class="header-section-number">3.10.4</span> When Pages Become Not
All-Visible</h3>
<p>The bit is cleared when:</p>
<ol type="1">
<li>INSERT adds new tuple (not yet visible to all)</li>
<li>UPDATE modifies tuple (creates new version)</li>
<li>DELETE marks tuple dead</li>
</ol>
<p><strong>Implementation:</strong></p>
<div class="sourceCode" id="cb167"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb167-1"><a aria-hidden="true" href="#cb167-1" tabindex="-1"></a><span class="co">/* During INSERT/UPDATE/DELETE */</span></span>
<span id="cb167-2"><a aria-hidden="true" href="#cb167-2" tabindex="-1"></a>visibilitymap_clear<span class="op">(</span>rel<span class="op">,</span> page<span class="op">,</span> VISIBILITYMAP_ALL_VISIBLE<span class="op">);</span></span></code></pre></div>
<p>This must be WAL-logged for crash recovery.</p>
<h3 data-number="3.10.5" id="vacuum-optimization"><span class="header-section-number">3.10.5</span> VACUUM Optimization</h3>
<p><strong>Without visibility map:</strong></p>
<pre><code>VACUUM scans every page in table
Large table: hours of work</code></pre>
<p><strong>With visibility map:</strong></p>
<pre><code>VACUUM skips pages marked all-visible
Large mostly-static table: minutes instead of hours</code></pre>
<p><strong>Example:</strong></p>
<div class="sourceCode" id="cb170"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb170-1"><a aria-hidden="true" href="#cb170-1" tabindex="-1"></a><span class="co">-- Table with 100M rows, 99% unchanging</span></span>
<span id="cb170-2"><a aria-hidden="true" href="#cb170-2" tabindex="-1"></a>VACUUM tablename;</span>
<span id="cb170-3"><a aria-hidden="true" href="#cb170-3" tabindex="-1"></a></span>
<span id="cb170-4"><a aria-hidden="true" href="#cb170-4" tabindex="-1"></a><span class="co">-- Without VM: Scan 100M rows</span></span>
<span id="cb170-5"><a aria-hidden="true" href="#cb170-5" tabindex="-1"></a><span class="co">-- With VM: Scan only ~1M changed rows</span></span>
<span id="cb170-6"><a aria-hidden="true" href="#cb170-6" tabindex="-1"></a><span class="co">-- Speedup: 100x</span></span></code></pre></div>
<p><strong>VACUUM strategies:</strong></p>
<div class="sourceCode" id="cb171"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb171-1"><a aria-hidden="true" href="#cb171-1" tabindex="-1"></a><span class="co">-- Regular VACUUM: skips all-visible pages</span></span>
<span id="cb171-2"><a aria-hidden="true" href="#cb171-2" tabindex="-1"></a>VACUUM tablename;</span>
<span id="cb171-3"><a aria-hidden="true" href="#cb171-3" tabindex="-1"></a></span>
<span id="cb171-4"><a aria-hidden="true" href="#cb171-4" tabindex="-1"></a><span class="co">-- Aggressive VACUUM: scans all pages (for freezing)</span></span>
<span id="cb171-5"><a aria-hidden="true" href="#cb171-5" tabindex="-1"></a>VACUUM (FREEZE) tablename;</span>
<span id="cb171-6"><a aria-hidden="true" href="#cb171-6" tabindex="-1"></a></span>
<span id="cb171-7"><a aria-hidden="true" href="#cb171-7" tabindex="-1"></a><span class="co">-- Autovacuum with freeze prevention</span></span>
<span id="cb171-8"><a aria-hidden="true" href="#cb171-8" tabindex="-1"></a><span class="co">-- Runs aggressive vacuum when table age approaches autovacuum_freeze_max_age</span></span></code></pre></div>
<h3 data-number="3.10.6" id="index-only-scans-1"><span class="header-section-number">3.10.6</span> Index-Only Scans</h3>
<p>The VM enables index-only scans:</p>
<p><strong>Scenario:</strong></p>
<div class="sourceCode" id="cb172"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb172-1"><a aria-hidden="true" href="#cb172-1" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_email <span class="kw">ON</span> users(email);</span>
<span id="cb172-2"><a aria-hidden="true" href="#cb172-2" tabindex="-1"></a><span class="kw">SELECT</span> email <span class="kw">FROM</span> users <span class="kw">WHERE</span> email <span class="kw">LIKE</span> <span class="st">'john%'</span>;</span></code></pre></div>
<p><strong>Without index-only scan:</strong></p>
<ol type="1">
<li>Scan index to find matching rows</li>
<li>For each row: Fetch heap tuple to check visibility</li>
<li>Return email value</li>
</ol>
<p><strong>With index-only scan:</strong></p>
<ol type="1">
<li>Scan index to find matching rows</li>
<li>For each row:
<ul>
<li>Check visibility map for page</li>
<li>If all-visible: Return value from index (no heap fetch!)</li>
<li>If not all-visible: Fetch heap tuple</li>
</ul></li>
</ol>
<p><strong>Performance impact:</strong></p>
<pre><code>Query: SELECT email FROM users WHERE email LIKE 'john%'

With heap fetches:    1000 index reads + 1000 random heap reads
Index-only scan:      1000 index reads only
Speedup:              ~2x (fewer I/O operations)</code></pre>
<p><strong>Requirements:</strong></p>
<ol type="1">
<li>All columns in SELECT/WHERE must be in index</li>
<li>Pages must be marked all-visible in VM</li>
</ol>
<p><strong>Monitoring:</strong></p>
<div class="sourceCode" id="cb174"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb174-1"><a aria-hidden="true" href="#cb174-1" tabindex="-1"></a><span class="kw">EXPLAIN</span> (<span class="kw">ANALYZE</span>, BUFFERS)</span>
<span id="cb174-2"><a aria-hidden="true" href="#cb174-2" tabindex="-1"></a><span class="kw">SELECT</span> email <span class="kw">FROM</span> users <span class="kw">WHERE</span> email <span class="kw">LIKE</span> <span class="st">'john%'</span>;</span>
<span id="cb174-3"><a aria-hidden="true" href="#cb174-3" tabindex="-1"></a></span>
<span id="cb174-4"><a aria-hidden="true" href="#cb174-4" tabindex="-1"></a><span class="co">-- Look for:</span></span>
<span id="cb174-5"><a aria-hidden="true" href="#cb174-5" tabindex="-1"></a><span class="co">-- Index Only Scan using idx_email</span></span>
<span id="cb174-6"><a aria-hidden="true" href="#cb174-6" tabindex="-1"></a><span class="co">-- Heap Fetches: 0  (ideal)</span></span>
<span id="cb174-7"><a aria-hidden="true" href="#cb174-7" tabindex="-1"></a><span class="co">-- Heap Fetches: 1000  (some pages not all-visible)</span></span></code></pre></div>
<h3 data-number="3.10.7" id="freezing-and-all-frozen-bit"><span class="header-section-number">3.10.7</span> Freezing and All-Frozen
Bit</h3>
<p><strong>Freezing</strong> prevents XID wraparound:</p>
<div class="sourceCode" id="cb175"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb175-1"><a aria-hidden="true" href="#cb175-1" tabindex="-1"></a><span class="co">/* Replace old t_xmin with FrozenTransactionId */</span></span>
<span id="cb175-2"><a aria-hidden="true" href="#cb175-2" tabindex="-1"></a><span class="cf">if</span> <span class="op">(</span>TransactionIdPrecedes<span class="op">(</span>tuple<span class="op">-&gt;</span>t_xmin<span class="op">,</span> oldest_safe_xid<span class="op">))</span></span>
<span id="cb175-3"><a aria-hidden="true" href="#cb175-3" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb175-4"><a aria-hidden="true" href="#cb175-4" tabindex="-1"></a>    tuple<span class="op">-&gt;</span>t_xmin <span class="op">=</span> FrozenTransactionId<span class="op">;</span></span>
<span id="cb175-5"><a aria-hidden="true" href="#cb175-5" tabindex="-1"></a>    visibilitymap_set<span class="op">(</span>rel<span class="op">,</span> page<span class="op">,</span> ALL_FROZEN<span class="op">);</span></span>
<span id="cb175-6"><a aria-hidden="true" href="#cb175-6" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>ALL_FROZEN advantages:</strong></p>
<ol type="1">
<li><strong>VACUUM can skip even for anti-wraparound</strong>: If all
pages are frozen, no wraparound risk</li>
<li><strong>Optimization</strong>: Frozen tuples don‚Äôt need visibility
checks</li>
</ol>
<p><strong>Configuration:</strong></p>
<pre><code>vacuum_freeze_min_age = 50000000       # Freeze tuples older than this
vacuum_freeze_table_age = 150000000   # Aggressive vacuum threshold
autovacuum_freeze_max_age = 200000000 # Force vacuum to prevent wraparound</code></pre>
<h3 data-number="3.10.8" id="visibility-map-monitoring"><span class="header-section-number">3.10.8</span> Visibility Map
Monitoring</h3>
<p><strong>pg_visibility extension:</strong></p>
<div class="sourceCode" id="cb177"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb177-1"><a aria-hidden="true" href="#cb177-1" tabindex="-1"></a><span class="kw">CREATE</span> EXTENSION pg_visibility;</span>
<span id="cb177-2"><a aria-hidden="true" href="#cb177-2" tabindex="-1"></a></span>
<span id="cb177-3"><a aria-hidden="true" href="#cb177-3" tabindex="-1"></a><span class="co">-- Check VM status</span></span>
<span id="cb177-4"><a aria-hidden="true" href="#cb177-4" tabindex="-1"></a><span class="kw">SELECT</span> blkno, all_visible, all_frozen</span>
<span id="cb177-5"><a aria-hidden="true" href="#cb177-5" tabindex="-1"></a><span class="kw">FROM</span> pg_visibility_map(<span class="st">'tablename'</span>)</span>
<span id="cb177-6"><a aria-hidden="true" href="#cb177-6" tabindex="-1"></a><span class="kw">LIMIT</span> <span class="dv">20</span>;</span>
<span id="cb177-7"><a aria-hidden="true" href="#cb177-7" tabindex="-1"></a></span>
<span id="cb177-8"><a aria-hidden="true" href="#cb177-8" tabindex="-1"></a><span class="co">-- Summary statistics</span></span>
<span id="cb177-9"><a aria-hidden="true" href="#cb177-9" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb177-10"><a aria-hidden="true" href="#cb177-10" tabindex="-1"></a>  <span class="fu">count</span>(<span class="op">*</span>) <span class="kw">FILTER</span> (<span class="kw">WHERE</span> all_visible) <span class="kw">AS</span> all_visible_pages,</span>
<span id="cb177-11"><a aria-hidden="true" href="#cb177-11" tabindex="-1"></a>  <span class="fu">count</span>(<span class="op">*</span>) <span class="kw">FILTER</span> (<span class="kw">WHERE</span> all_frozen) <span class="kw">AS</span> all_frozen_pages,</span>
<span id="cb177-12"><a aria-hidden="true" href="#cb177-12" tabindex="-1"></a>  <span class="fu">count</span>(<span class="op">*</span>) <span class="kw">AS</span> total_pages,</span>
<span id="cb177-13"><a aria-hidden="true" href="#cb177-13" tabindex="-1"></a>  <span class="fu">round</span>(<span class="fl">100.0</span> <span class="op">*</span> <span class="fu">count</span>(<span class="op">*</span>) <span class="kw">FILTER</span> (<span class="kw">WHERE</span> all_visible) <span class="op">/</span> <span class="fu">count</span>(<span class="op">*</span>), <span class="dv">1</span>)</span>
<span id="cb177-14"><a aria-hidden="true" href="#cb177-14" tabindex="-1"></a>    <span class="kw">AS</span> pct_visible</span>
<span id="cb177-15"><a aria-hidden="true" href="#cb177-15" tabindex="-1"></a><span class="kw">FROM</span> pg_visibility_map(<span class="st">'tablename'</span>);</span></code></pre></div>
<p><strong>Checking VM effectiveness:</strong></p>
<div class="sourceCode" id="cb178"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb178-1"><a aria-hidden="true" href="#cb178-1" tabindex="-1"></a><span class="co">-- Table with good VM coverage (mostly all-visible)</span></span>
<span id="cb178-2"><a aria-hidden="true" href="#cb178-2" tabindex="-1"></a><span class="kw">SELECT</span> relname, n_live_tup, n_dead_tup,</span>
<span id="cb178-3"><a aria-hidden="true" href="#cb178-3" tabindex="-1"></a>       last_vacuum, last_autovacuum</span>
<span id="cb178-4"><a aria-hidden="true" href="#cb178-4" tabindex="-1"></a><span class="kw">FROM</span> pg_stat_user_tables</span>
<span id="cb178-5"><a aria-hidden="true" href="#cb178-5" tabindex="-1"></a><span class="kw">WHERE</span> schemaname <span class="op">=</span> <span class="st">'public'</span></span>
<span id="cb178-6"><a aria-hidden="true" href="#cb178-6" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> n_live_tup <span class="kw">DESC</span>;</span>
<span id="cb178-7"><a aria-hidden="true" href="#cb178-7" tabindex="-1"></a></span>
<span id="cb178-8"><a aria-hidden="true" href="#cb178-8" tabindex="-1"></a><span class="co">-- If many dead tuples: VACUUM needed to set VM bits</span></span>
<span id="cb178-9"><a aria-hidden="true" href="#cb178-9" tabindex="-1"></a><span class="co">-- If recent vacuum: VM should have good coverage</span></span></code></pre></div>
<h3 data-number="3.10.9" id="vm-and-wal"><span class="header-section-number">3.10.9</span> VM and WAL</h3>
<p>VM updates are WAL-logged:</p>
<p><strong>Setting all-visible:</strong></p>
<div class="sourceCode" id="cb179"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb179-1"><a aria-hidden="true" href="#cb179-1" tabindex="-1"></a><span class="co">/* VACUUM marks page all-visible */</span></span>
<span id="cb179-2"><a aria-hidden="true" href="#cb179-2" tabindex="-1"></a>START_CRIT_SECTION<span class="op">();</span></span>
<span id="cb179-3"><a aria-hidden="true" href="#cb179-3" tabindex="-1"></a>visibilitymap_set<span class="op">(</span>rel<span class="op">,</span> page<span class="op">,</span> ALL_VISIBLE<span class="op">);</span></span>
<span id="cb179-4"><a aria-hidden="true" href="#cb179-4" tabindex="-1"></a><span class="co">/* WAL record written */</span></span>
<span id="cb179-5"><a aria-hidden="true" href="#cb179-5" tabindex="-1"></a>END_CRIT_SECTION<span class="op">();</span></span></code></pre></div>
<p><strong>Clearing all-visible:</strong></p>
<div class="sourceCode" id="cb180"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb180-1"><a aria-hidden="true" href="#cb180-1" tabindex="-1"></a><span class="co">/* INSERT/UPDATE/DELETE clears bit */</span></span>
<span id="cb180-2"><a aria-hidden="true" href="#cb180-2" tabindex="-1"></a>START_CRIT_SECTION<span class="op">();</span></span>
<span id="cb180-3"><a aria-hidden="true" href="#cb180-3" tabindex="-1"></a>visibilitymap_clear<span class="op">(</span>rel<span class="op">,</span> page<span class="op">,</span> ALL_VISIBLE<span class="op">);</span></span>
<span id="cb180-4"><a aria-hidden="true" href="#cb180-4" tabindex="-1"></a><span class="co">/* WAL record written */</span></span>
<span id="cb180-5"><a aria-hidden="true" href="#cb180-5" tabindex="-1"></a>END_CRIT_SECTION<span class="op">();</span></span></code></pre></div>
<p>This ensures VM is correctly recovered after crash.</p>
<h3 data-number="3.10.10" id="vm-file-format"><span class="header-section-number">3.10.10</span> VM File Format</h3>
<p>VM pages follow standard page layout:</p>
<div class="sourceCode" id="cb181"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb181-1"><a aria-hidden="true" href="#cb181-1" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span></span>
<span id="cb181-2"><a aria-hidden="true" href="#cb181-2" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb181-3"><a aria-hidden="true" href="#cb181-3" tabindex="-1"></a>    PageHeaderData pd<span class="op">;</span>  <span class="co">/* Standard page header */</span></span>
<span id="cb181-4"><a aria-hidden="true" href="#cb181-4" tabindex="-1"></a></span>
<span id="cb181-5"><a aria-hidden="true" href="#cb181-5" tabindex="-1"></a>    <span class="co">/* Bitmap data: 2 bits per heap page */</span></span>
<span id="cb181-6"><a aria-hidden="true" href="#cb181-6" tabindex="-1"></a>    uint8 bits<span class="op">[</span>FLEXIBLE_ARRAY_MEMBER<span class="op">];</span></span>
<span id="cb181-7"><a aria-hidden="true" href="#cb181-7" tabindex="-1"></a><span class="op">}</span> VMPageData<span class="op">;</span></span></code></pre></div>
<p>Each byte stores 4 heap pages (2 bits each):</p>
<pre><code>Byte:    [76][54][32][10]
         ‚Üë   ‚Üë   ‚Üë   ‚Üë
         Heap pages 3,2,1,0

Bits: [Frozen][Visible]</code></pre>
<h3 data-number="3.10.11" id="vm-performance-impact"><span class="header-section-number">3.10.11</span> VM Performance Impact</h3>
<p><strong>Benefits:</strong></p>
<ul>
<li><strong>VACUUM</strong>: Massive speedup (skip most pages on
read-heavy tables)</li>
<li><strong>Index-only scans</strong>: Avoid heap fetches (2x or more
speedup)</li>
<li><strong>Tiny overhead</strong>: 2 bits per 8KB page (0.003%
storage)</li>
</ul>
<p><strong>Costs:</strong></p>
<ul>
<li><strong>Minimal</strong>: VM updates are simple bit operations</li>
<li><strong>WAL overhead</strong>: Small WAL records for set/clear
operations</li>
<li><strong>Slight overhead on writes</strong>: Clear VM bit on
UPDATE/DELETE</li>
</ul>
<p><strong>Example: 100 GB table</strong></p>
<pre><code>Heap: 100 GB
VM:   ~3 MB (0.003% overhead)

Benefits:
- VACUUM: Hours ‚Üí Minutes
- Index-only scans: 2x faster
- Wraparound prevention</code></pre>
<h3 data-number="3.10.12" id="vm-corruption-recovery"><span class="header-section-number">3.10.12</span> VM Corruption Recovery</h3>
<p>VM is a hint structure - inconsistencies don‚Äôt corrupt data:</p>
<p><strong>Incorrect all-visible bit:</strong></p>
<ul>
<li><strong>Set but shouldn‚Äôt be</strong>: Index-only scan may return
wrong results</li>
<li><strong>Clear but should be set</strong>: Just inefficiency, no
corruption</li>
</ul>
<p><strong>Recovery:</strong></p>
<div class="sourceCode" id="cb184"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb184-1"><a aria-hidden="true" href="#cb184-1" tabindex="-1"></a><span class="co">-- Force VM rebuild</span></span>
<span id="cb184-2"><a aria-hidden="true" href="#cb184-2" tabindex="-1"></a>VACUUM tablename;</span>
<span id="cb184-3"><a aria-hidden="true" href="#cb184-3" tabindex="-1"></a></span>
<span id="cb184-4"><a aria-hidden="true" href="#cb184-4" tabindex="-1"></a><span class="co">-- Or for severe issues</span></span>
<span id="cb184-5"><a aria-hidden="true" href="#cb184-5" tabindex="-1"></a>REINDEX <span class="kw">TABLE</span> tablename;</span>
<span id="cb184-6"><a aria-hidden="true" href="#cb184-6" tabindex="-1"></a>VACUUM FREEZE tablename;</span></code></pre></div>
<p><strong>Prevention:</strong></p>
<ul>
<li>Keep <code>data_checksums</code> enabled</li>
<li>Regular backups</li>
<li>Monitor for I/O errors</li>
</ul>
<h2 data-number="3.11" id="toast"><span class="header-section-number">3.11</span> TOAST</h2>
<h3 data-number="3.11.1" id="overview-8"><span class="header-section-number">3.11.1</span> Overview</h3>
<p>TOAST (The Oversized-Attribute Storage Technique) is PostgreSQL‚Äôs
mechanism for storing large attribute values that don‚Äôt fit in a normal
page. Defined in <code>src/backend/access/common/toast*.c</code> and
<code>src/include/access/toast*.h</code>, TOAST transparently handles
values larger than ~2KB.</p>
<p>Without TOAST, PostgreSQL‚Äôs maximum tuple size would be limited by
the 8KB page size, severely restricting column values.</p>
<h3 data-number="3.11.2" id="the-problem-toast-solves"><span class="header-section-number">3.11.2</span> The Problem TOAST
Solves</h3>
<p><strong>Page size limitation:</strong></p>
<pre><code>Page size: 8192 bytes
Page header: ~24 bytes
Item pointers: ~4 bytes each
Tuple header: ~23 bytes
Maximum tuple size: ~8000 bytes

Problem: What about 100KB text column? 10MB bytea value?</code></pre>
<p><strong>TOAST solution:</strong></p>
<p>Large values stored externally in a TOAST table, with pointer in main
table.</p>
<h3 data-number="3.11.3" id="toast-strategies"><span class="header-section-number">3.11.3</span> TOAST Strategies</h3>
<p>PostgreSQL applies four storage strategies based on column type and
size:</p>
<div class="sourceCode" id="cb186"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb186-1"><a aria-hidden="true" href="#cb186-1" tabindex="-1"></a><span class="pp">#define TOAST_PLAIN_STORAGE       </span><span class="ch">'p'</span><span class="pp">  </span><span class="co">/* No TOAST, fixed-length */</span></span>
<span id="cb186-2"><a aria-hidden="true" href="#cb186-2" tabindex="-1"></a><span class="pp">#define TOAST_EXTERNAL_STORAGE    </span><span class="ch">'e'</span><span class="pp">  </span><span class="co">/* External storage, no compression */</span></span>
<span id="cb186-3"><a aria-hidden="true" href="#cb186-3" tabindex="-1"></a><span class="pp">#define TOAST_EXTENDED_STORAGE    </span><span class="ch">'x'</span><span class="pp">  </span><span class="co">/* External storage, compression allowed */</span></span>
<span id="cb186-4"><a aria-hidden="true" href="#cb186-4" tabindex="-1"></a><span class="pp">#define TOAST_MAIN_STORAGE        </span><span class="ch">'m'</span><span class="pp">  </span><span class="co">/* Inline, compression allowed */</span></span></code></pre></div>
<p><strong>Strategy details:</strong></p>
<p><strong>PLAIN</strong> (<code>p</code>): - Fixed-length types (int,
float, etc.) - Never compressed or moved to TOAST table - Always stored
inline</p>
<p><strong>EXTENDED</strong> (<code>x</code>) - default for most varlena
types: - Try compression first - If still large, move to TOAST table -
Used for: text, bytea, jsonb, arrays</p>
<p><strong>EXTERNAL</strong> (<code>e</code>): - Never compress - Move
to TOAST table if large - Used for large objects that compress poorly -
Example: already-compressed data</p>
<p><strong>MAIN</strong> (<code>m</code>): - Prefer inline storage - Try
compression - Move to TOAST table only as last resort - Used for:
shorter text columns that benefit from inline storage</p>
<h3 data-number="3.11.4" id="toast-threshold"><span class="header-section-number">3.11.4</span> TOAST Threshold</h3>
<p>Values are TOASTed when:</p>
<div class="sourceCode" id="cb187"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb187-1"><a aria-hidden="true" href="#cb187-1" tabindex="-1"></a><span class="pp">#define TOAST_TUPLE_THRESHOLD </span><span class="dv">2000</span><span class="pp">  </span><span class="co">/* ~2KB */</span></span></code></pre></div>
<p><strong>Process:</strong></p>
<ol type="1">
<li>Try to fit tuple in page</li>
<li>If tuple &gt; 2KB:
<ul>
<li>Try compressing EXTENDED columns</li>
<li>If still too large, move largest EXTENDED/EXTERNAL columns to TOAST
table</li>
<li>Repeat until tuple fits or all movable columns moved</li>
</ul></li>
</ol>
<h3 data-number="3.11.5" id="toast-table-structure"><span class="header-section-number">3.11.5</span> TOAST Table Structure</h3>
<p>Each table with TOASTable columns has a TOAST table:</p>
<pre><code>Main table: $PGDATA/base/&lt;db&gt;/&lt;relation_oid&gt;
TOAST table: $PGDATA/base/&lt;db&gt;/&lt;toast_relation_oid&gt;
TOAST index: $PGDATA/base/&lt;db&gt;/&lt;toast_index_oid&gt;</code></pre>
<p><strong>TOAST table schema:</strong></p>
<div class="sourceCode" id="cb189"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb189-1"><a aria-hidden="true" href="#cb189-1" tabindex="-1"></a>CREATE TABLE pg_toast<span class="op">.</span>pg_toast_<span class="op">&lt;</span>oid<span class="op">&gt;</span> <span class="op">(</span></span>
<span id="cb189-2"><a aria-hidden="true" href="#cb189-2" tabindex="-1"></a>    chunk_id    oid<span class="op">,</span>      <span class="co">/* Unique ID for this TOASTed value */</span></span>
<span id="cb189-3"><a aria-hidden="true" href="#cb189-3" tabindex="-1"></a>    chunk_seq   int4<span class="op">,</span>     <span class="co">/* Chunk sequence number (0, 1, 2, ...) */</span></span>
<span id="cb189-4"><a aria-hidden="true" href="#cb189-4" tabindex="-1"></a>    chunk_data  bytea     <span class="co">/* Actual data chunk (~2000 bytes) */</span></span>
<span id="cb189-5"><a aria-hidden="true" href="#cb189-5" tabindex="-1"></a><span class="op">);</span></span>
<span id="cb189-6"><a aria-hidden="true" href="#cb189-6" tabindex="-1"></a></span>
<span id="cb189-7"><a aria-hidden="true" href="#cb189-7" tabindex="-1"></a>CREATE INDEX pg_toast_<span class="op">&lt;</span>oid<span class="op">&gt;</span>_index ON pg_toast<span class="op">.</span>pg_toast_<span class="op">&lt;</span>oid<span class="op">&gt;</span></span>
<span id="cb189-8"><a aria-hidden="true" href="#cb189-8" tabindex="-1"></a>    <span class="op">(</span>chunk_id<span class="op">,</span> chunk_seq<span class="op">);</span></span></code></pre></div>
<p><strong>Example: Large text value</strong></p>
<pre><code>Main table:
+----+------------------------+
| id | description (TOAST ptr)|  ‚Üê Points to chunk_id in TOAST table
+----+------------------------+
| 1  | 0x12345678            |
+----+------------------------+

TOAST table (pg_toast.pg_toast_12345):
+-----------+-----------+----------------+
| chunk_id  | chunk_seq | chunk_data     |
+-----------+-----------+----------------+
| 12345678  |    0      | [2000 bytes]   |
| 12345678  |    1      | [2000 bytes]   |
| 12345678  |    2      | [1500 bytes]   |
+-----------+-----------+----------------+</code></pre>
<p>Total value size: 5500 bytes, stored in 3 chunks.</p>
<h3 data-number="3.11.6" id="toast-pointers"><span class="header-section-number">3.11.6</span> TOAST Pointers</h3>
<p>In-line TOAST pointer structure:</p>
<div class="sourceCode" id="cb191"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb191-1"><a aria-hidden="true" href="#cb191-1" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> varattrib_1b_e</span>
<span id="cb191-2"><a aria-hidden="true" href="#cb191-2" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb191-3"><a aria-hidden="true" href="#cb191-3" tabindex="-1"></a>    uint8 va_header<span class="op">;</span>        <span class="co">/* Header: 1 byte, indicates TOAST */</span></span>
<span id="cb191-4"><a aria-hidden="true" href="#cb191-4" tabindex="-1"></a>    uint8 va_tag<span class="op">;</span>           <span class="co">/* TOAST type */</span></span>
<span id="cb191-5"><a aria-hidden="true" href="#cb191-5" tabindex="-1"></a></span>
<span id="cb191-6"><a aria-hidden="true" href="#cb191-6" tabindex="-1"></a>    <span class="kw">union</span> <span class="op">{</span></span>
<span id="cb191-7"><a aria-hidden="true" href="#cb191-7" tabindex="-1"></a>        <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb191-8"><a aria-hidden="true" href="#cb191-8" tabindex="-1"></a>            int32 rawsize<span class="op">;</span>       <span class="co">/* Original uncompressed size */</span></span>
<span id="cb191-9"><a aria-hidden="true" href="#cb191-9" tabindex="-1"></a>            int32 extsize<span class="op">;</span>       <span class="co">/* External storage size */</span></span>
<span id="cb191-10"><a aria-hidden="true" href="#cb191-10" tabindex="-1"></a>            Oid   valueid<span class="op">;</span>       <span class="co">/* OID in TOAST table */</span></span>
<span id="cb191-11"><a aria-hidden="true" href="#cb191-11" tabindex="-1"></a>            Oid   toastrelid<span class="op">;</span>    <span class="co">/* TOAST table OID */</span></span>
<span id="cb191-12"><a aria-hidden="true" href="#cb191-12" tabindex="-1"></a>        <span class="op">}</span> indirect<span class="op">;</span></span>
<span id="cb191-13"><a aria-hidden="true" href="#cb191-13" tabindex="-1"></a></span>
<span id="cb191-14"><a aria-hidden="true" href="#cb191-14" tabindex="-1"></a>        <span class="co">/* Or for short compressed values stored inline: */</span></span>
<span id="cb191-15"><a aria-hidden="true" href="#cb191-15" tabindex="-1"></a>        uint8 data<span class="op">[</span>FLEXIBLE_ARRAY_MEMBER<span class="op">];</span>  <span class="co">/* Compressed data */</span></span>
<span id="cb191-16"><a aria-hidden="true" href="#cb191-16" tabindex="-1"></a>    <span class="op">}</span> va_data<span class="op">;</span></span>
<span id="cb191-17"><a aria-hidden="true" href="#cb191-17" tabindex="-1"></a><span class="op">}</span> varattrib_1b_e<span class="op">;</span></span></code></pre></div>
<p><strong>TOAST pointer types:</strong></p>
<ol type="1">
<li><strong>External uncompressed</strong>: Data in TOAST table, not
compressed</li>
<li><strong>External compressed</strong>: Data in TOAST table,
compressed</li>
<li><strong>Inline compressed</strong>: Compressed data stored inline
(&lt; ~2KB)</li>
<li><strong>Indirect</strong>: Pointer to data in another tuple
(rare)</li>
</ol>
<h3 data-number="3.11.7" id="compression"><span class="header-section-number">3.11.7</span> Compression</h3>
<p>TOAST uses <strong>pglz</strong> (PostgreSQL LZ) compression:</p>
<div class="sourceCode" id="cb192"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb192-1"><a aria-hidden="true" href="#cb192-1" tabindex="-1"></a><span class="co">/* Try to compress attribute */</span></span>
<span id="cb192-2"><a aria-hidden="true" href="#cb192-2" tabindex="-1"></a>int32 pglz_compress<span class="op">(</span><span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>source<span class="op">,</span> int32 slen<span class="op">,</span></span>
<span id="cb192-3"><a aria-hidden="true" href="#cb192-3" tabindex="-1"></a>                    <span class="dt">char</span> <span class="op">*</span>dest<span class="op">,</span> <span class="dt">const</span> PGLZ_Strategy <span class="op">*</span>strategy<span class="op">);</span></span></code></pre></div>
<p><strong>Compression decision:</strong></p>
<div class="sourceCode" id="cb193"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb193-1"><a aria-hidden="true" href="#cb193-1" tabindex="-1"></a><span class="pp">#define PGLZ_MIN_COMPRESS_RATIO  </span><span class="fl">0.75</span><span class="pp">  </span><span class="co">/* Must save at least 25% */</span></span>
<span id="cb193-2"><a aria-hidden="true" href="#cb193-2" tabindex="-1"></a></span>
<span id="cb193-3"><a aria-hidden="true" href="#cb193-3" tabindex="-1"></a><span class="cf">if</span> <span class="op">(</span>compressed_size <span class="op">&lt;</span> original_size <span class="op">*</span> <span class="fl">0.75</span><span class="op">)</span></span>
<span id="cb193-4"><a aria-hidden="true" href="#cb193-4" tabindex="-1"></a>    use compressed version</span>
<span id="cb193-5"><a aria-hidden="true" href="#cb193-5" tabindex="-1"></a><span class="cf">else</span></span>
<span id="cb193-6"><a aria-hidden="true" href="#cb193-6" tabindex="-1"></a>    use uncompressed version</span></code></pre></div>
<p><strong>Compression is applied to:</strong> - EXTENDED storage
columns - MAIN storage columns (if needed) - Skipped for EXTERNAL and
PLAIN</p>
<p><strong>Configuration:</strong></p>
<div class="sourceCode" id="cb194"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb194-1"><a aria-hidden="true" href="#cb194-1" tabindex="-1"></a><span class="co">-- Change storage strategy for a column</span></span>
<span id="cb194-2"><a aria-hidden="true" href="#cb194-2" tabindex="-1"></a><span class="kw">ALTER</span> <span class="kw">TABLE</span> mytable</span>
<span id="cb194-3"><a aria-hidden="true" href="#cb194-3" tabindex="-1"></a><span class="kw">ALTER</span> <span class="kw">COLUMN</span> description <span class="kw">SET</span> <span class="kw">STORAGE</span> EXTERNAL;  <span class="co">-- No compression</span></span>
<span id="cb194-4"><a aria-hidden="true" href="#cb194-4" tabindex="-1"></a></span>
<span id="cb194-5"><a aria-hidden="true" href="#cb194-5" tabindex="-1"></a><span class="kw">ALTER</span> <span class="kw">TABLE</span> mytable</span>
<span id="cb194-6"><a aria-hidden="true" href="#cb194-6" tabindex="-1"></a><span class="kw">ALTER</span> <span class="kw">COLUMN</span> <span class="kw">data</span> <span class="kw">SET</span> <span class="kw">STORAGE</span> MAIN;  <span class="co">-- Prefer inline</span></span></code></pre></div>
<h3 data-number="3.11.8" id="toast-operations"><span class="header-section-number">3.11.8</span> TOAST Operations</h3>
<p><strong>Insertion:</strong></p>
<div class="sourceCode" id="cb195"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb195-1"><a aria-hidden="true" href="#cb195-1" tabindex="-1"></a><span class="co">/* Insert large tuple */</span></span>
<span id="cb195-2"><a aria-hidden="true" href="#cb195-2" tabindex="-1"></a>heap_insert<span class="op">(</span>rel<span class="op">,</span> tuple<span class="op">,</span> <span class="op">...)</span></span>
<span id="cb195-3"><a aria-hidden="true" href="#cb195-3" tabindex="-1"></a>    ‚Üì</span>
<span id="cb195-4"><a aria-hidden="true" href="#cb195-4" tabindex="-1"></a>toast_insert_or_update<span class="op">(</span>rel<span class="op">,</span> tuple<span class="op">,</span> <span class="op">...)</span></span>
<span id="cb195-5"><a aria-hidden="true" href="#cb195-5" tabindex="-1"></a>    ‚Üì</span>
<span id="cb195-6"><a aria-hidden="true" href="#cb195-6" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>tuple too large<span class="op">)</span></span>
<span id="cb195-7"><a aria-hidden="true" href="#cb195-7" tabindex="-1"></a>        toast_compress_datum<span class="op">(...)</span>      <span class="co">/* Try compression */</span></span>
<span id="cb195-8"><a aria-hidden="true" href="#cb195-8" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>still too large<span class="op">)</span></span>
<span id="cb195-9"><a aria-hidden="true" href="#cb195-9" tabindex="-1"></a>            toast_save_datum<span class="op">(...)</span>      <span class="co">/* Move to TOAST table */</span></span></code></pre></div>
<p><strong>Retrieval:</strong></p>
<div class="sourceCode" id="cb196"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb196-1"><a aria-hidden="true" href="#cb196-1" tabindex="-1"></a><span class="co">/* Fetch attribute */</span></span>
<span id="cb196-2"><a aria-hidden="true" href="#cb196-2" tabindex="-1"></a>heap_getnext<span class="op">(...)</span></span>
<span id="cb196-3"><a aria-hidden="true" href="#cb196-3" tabindex="-1"></a>    ‚Üì</span>
<span id="cb196-4"><a aria-hidden="true" href="#cb196-4" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>attribute is TOASTed<span class="op">)</span></span>
<span id="cb196-5"><a aria-hidden="true" href="#cb196-5" tabindex="-1"></a>        toast_fetch_datum<span class="op">(...)</span></span>
<span id="cb196-6"><a aria-hidden="true" href="#cb196-6" tabindex="-1"></a>            ‚Üì</span>
<span id="cb196-7"><a aria-hidden="true" href="#cb196-7" tabindex="-1"></a>            Read TOAST chunks</span>
<span id="cb196-8"><a aria-hidden="true" href="#cb196-8" tabindex="-1"></a>            Decompress <span class="cf">if</span> needed</span>
<span id="cb196-9"><a aria-hidden="true" href="#cb196-9" tabindex="-1"></a>            Return assembled value</span></code></pre></div>
<p><strong>Update:</strong></p>
<div class="sourceCode" id="cb197"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb197-1"><a aria-hidden="true" href="#cb197-1" tabindex="-1"></a><span class="co">/* Update with TOASTed column */</span></span>
<span id="cb197-2"><a aria-hidden="true" href="#cb197-2" tabindex="-1"></a>heap_update<span class="op">(</span>rel<span class="op">,</span> oldtup<span class="op">,</span> newtup<span class="op">,</span> <span class="op">...)</span></span>
<span id="cb197-3"><a aria-hidden="true" href="#cb197-3" tabindex="-1"></a>    ‚Üì</span>
<span id="cb197-4"><a aria-hidden="true" href="#cb197-4" tabindex="-1"></a>    toast_insert_or_update<span class="op">(...)</span></span>
<span id="cb197-5"><a aria-hidden="true" href="#cb197-5" tabindex="-1"></a>        ‚Üì</span>
<span id="cb197-6"><a aria-hidden="true" href="#cb197-6" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>new value same as old<span class="op">)</span></span>
<span id="cb197-7"><a aria-hidden="true" href="#cb197-7" tabindex="-1"></a>            Reuse old TOAST pointer <span class="op">(</span>no copy<span class="op">!)</span></span>
<span id="cb197-8"><a aria-hidden="true" href="#cb197-8" tabindex="-1"></a>        <span class="cf">else</span></span>
<span id="cb197-9"><a aria-hidden="true" href="#cb197-9" tabindex="-1"></a>            Delete old TOAST chunks</span>
<span id="cb197-10"><a aria-hidden="true" href="#cb197-10" tabindex="-1"></a>            Insert new TOAST chunks</span></code></pre></div>
<p><strong>Delete:</strong></p>
<div class="sourceCode" id="cb198"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb198-1"><a aria-hidden="true" href="#cb198-1" tabindex="-1"></a><span class="co">/* Delete tuple with TOASTed values */</span></span>
<span id="cb198-2"><a aria-hidden="true" href="#cb198-2" tabindex="-1"></a>heap_delete<span class="op">(</span>rel<span class="op">,</span> tid<span class="op">,</span> <span class="op">...)</span></span>
<span id="cb198-3"><a aria-hidden="true" href="#cb198-3" tabindex="-1"></a>    ‚Üì</span>
<span id="cb198-4"><a aria-hidden="true" href="#cb198-4" tabindex="-1"></a>    <span class="op">(</span>TOAST chunks marked dead via dependency<span class="op">)</span></span>
<span id="cb198-5"><a aria-hidden="true" href="#cb198-5" tabindex="-1"></a>    ‚Üì</span>
<span id="cb198-6"><a aria-hidden="true" href="#cb198-6" tabindex="-1"></a>    VACUUM removes dead TOAST chunks</span></code></pre></div>
<h3 data-number="3.11.9" id="toast-and-vacuum"><span class="header-section-number">3.11.9</span> TOAST and VACUUM</h3>
<p>VACUUM cleans up orphaned TOAST chunks:</p>
<pre><code>1. VACUUM main table
2. Mark dead tuples' TOAST chunks as dead
3. VACUUM TOAST table
4. Reclaim space from dead chunks</code></pre>
<p><strong>TOAST table bloat:</strong></p>
<p>High UPDATE rate on TOASTed columns can cause TOAST bloat:</p>
<div class="sourceCode" id="cb200"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb200-1"><a aria-hidden="true" href="#cb200-1" tabindex="-1"></a><span class="co">-- Check TOAST table size</span></span>
<span id="cb200-2"><a aria-hidden="true" href="#cb200-2" tabindex="-1"></a><span class="kw">SELECT</span> relname,</span>
<span id="cb200-3"><a aria-hidden="true" href="#cb200-3" tabindex="-1"></a>       pg_size_pretty(pg_total_relation_size(<span class="kw">oid</span>)) <span class="kw">AS</span> total_size,</span>
<span id="cb200-4"><a aria-hidden="true" href="#cb200-4" tabindex="-1"></a>       pg_size_pretty(pg_relation_size(<span class="kw">oid</span>)) <span class="kw">AS</span> main_size,</span>
<span id="cb200-5"><a aria-hidden="true" href="#cb200-5" tabindex="-1"></a>       pg_size_pretty(pg_total_relation_size(reltoastrelid)) <span class="kw">AS</span> toast_size</span>
<span id="cb200-6"><a aria-hidden="true" href="#cb200-6" tabindex="-1"></a><span class="kw">FROM</span> pg_class</span>
<span id="cb200-7"><a aria-hidden="true" href="#cb200-7" tabindex="-1"></a><span class="kw">WHERE</span> relname <span class="op">=</span> <span class="st">'mytable'</span>;</span>
<span id="cb200-8"><a aria-hidden="true" href="#cb200-8" tabindex="-1"></a></span>
<span id="cb200-9"><a aria-hidden="true" href="#cb200-9" tabindex="-1"></a><span class="co">-- VACUUM both main and TOAST</span></span>
<span id="cb200-10"><a aria-hidden="true" href="#cb200-10" tabindex="-1"></a>VACUUM <span class="kw">ANALYZE</span> mytable;</span></code></pre></div>
<h3 data-number="3.11.10" id="toast-performance-implications"><span class="header-section-number">3.11.10</span> TOAST Performance
Implications</h3>
<p><strong>Advantages:</strong> - Enables large column values -
Automatic and transparent - Efficient compression saves space -
Unchanged values reuse TOAST pointers</p>
<p><strong>Costs:</strong> - Extra I/O for TOASTed column access -
Compression CPU overhead - TOAST table and index overhead - Potential
bloat with high UPDATE rate</p>
<p><strong>Performance tips:</strong></p>
<div class="sourceCode" id="cb201"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb201-1"><a aria-hidden="true" href="#cb201-1" tabindex="-1"></a><span class="co">-- Avoid fetching TOASTed columns unnecessarily</span></span>
<span id="cb201-2"><a aria-hidden="true" href="#cb201-2" tabindex="-1"></a><span class="kw">SELECT</span> <span class="kw">id</span>, small_column        <span class="co">-- Good: doesn't fetch large_text</span></span>
<span id="cb201-3"><a aria-hidden="true" href="#cb201-3" tabindex="-1"></a><span class="kw">FROM</span> mytable</span>
<span id="cb201-4"><a aria-hidden="true" href="#cb201-4" tabindex="-1"></a><span class="kw">WHERE</span> <span class="kw">id</span> <span class="op">=</span> <span class="dv">123</span>;</span>
<span id="cb201-5"><a aria-hidden="true" href="#cb201-5" tabindex="-1"></a></span>
<span id="cb201-6"><a aria-hidden="true" href="#cb201-6" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span>                       <span class="co">-- Bad: fetches all TOAST values</span></span>
<span id="cb201-7"><a aria-hidden="true" href="#cb201-7" tabindex="-1"></a><span class="kw">FROM</span> mytable</span>
<span id="cb201-8"><a aria-hidden="true" href="#cb201-8" tabindex="-1"></a><span class="kw">WHERE</span> <span class="kw">id</span> <span class="op">=</span> <span class="dv">123</span>;</span>
<span id="cb201-9"><a aria-hidden="true" href="#cb201-9" tabindex="-1"></a></span>
<span id="cb201-10"><a aria-hidden="true" href="#cb201-10" tabindex="-1"></a><span class="co">-- Use appropriate storage strategy</span></span>
<span id="cb201-11"><a aria-hidden="true" href="#cb201-11" tabindex="-1"></a><span class="kw">ALTER</span> <span class="kw">TABLE</span> logs</span>
<span id="cb201-12"><a aria-hidden="true" href="#cb201-12" tabindex="-1"></a><span class="kw">ALTER</span> <span class="kw">COLUMN</span> compressed_data <span class="kw">SET</span> <span class="kw">STORAGE</span> EXTERNAL;  <span class="co">-- Already compressed</span></span>
<span id="cb201-13"><a aria-hidden="true" href="#cb201-13" tabindex="-1"></a></span>
<span id="cb201-14"><a aria-hidden="true" href="#cb201-14" tabindex="-1"></a><span class="co">-- Consider splitting large columns to separate table</span></span>
<span id="cb201-15"><a aria-hidden="true" href="#cb201-15" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> documents (</span>
<span id="cb201-16"><a aria-hidden="true" href="#cb201-16" tabindex="-1"></a>    <span class="kw">id</span> serial <span class="kw">PRIMARY</span> <span class="kw">KEY</span>,</span>
<span id="cb201-17"><a aria-hidden="true" href="#cb201-17" tabindex="-1"></a>    title text,</span>
<span id="cb201-18"><a aria-hidden="true" href="#cb201-18" tabindex="-1"></a>    created_at <span class="dt">timestamp</span></span>
<span id="cb201-19"><a aria-hidden="true" href="#cb201-19" tabindex="-1"></a>);</span>
<span id="cb201-20"><a aria-hidden="true" href="#cb201-20" tabindex="-1"></a></span>
<span id="cb201-21"><a aria-hidden="true" href="#cb201-21" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> document_content (</span>
<span id="cb201-22"><a aria-hidden="true" href="#cb201-22" tabindex="-1"></a>    document_id <span class="dt">int</span> <span class="kw">PRIMARY</span> <span class="kw">KEY</span> <span class="kw">REFERENCES</span> documents(<span class="kw">id</span>),</span>
<span id="cb201-23"><a aria-hidden="true" href="#cb201-23" tabindex="-1"></a>    content text  <span class="co">-- Large, rarely accessed</span></span>
<span id="cb201-24"><a aria-hidden="true" href="#cb201-24" tabindex="-1"></a>);</span></code></pre></div>
<h3 data-number="3.11.11" id="toast-monitoring"><span class="header-section-number">3.11.11</span> TOAST Monitoring</h3>
<div class="sourceCode" id="cb202"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb202-1"><a aria-hidden="true" href="#cb202-1" tabindex="-1"></a><span class="co">-- Find tables with TOAST tables</span></span>
<span id="cb202-2"><a aria-hidden="true" href="#cb202-2" tabindex="-1"></a><span class="kw">SELECT</span> c.relname <span class="kw">AS</span> table_name,</span>
<span id="cb202-3"><a aria-hidden="true" href="#cb202-3" tabindex="-1"></a>       t.relname <span class="kw">AS</span> toast_table,</span>
<span id="cb202-4"><a aria-hidden="true" href="#cb202-4" tabindex="-1"></a>       pg_size_pretty(pg_relation_size(t.<span class="kw">oid</span>)) <span class="kw">AS</span> toast_size</span>
<span id="cb202-5"><a aria-hidden="true" href="#cb202-5" tabindex="-1"></a><span class="kw">FROM</span> pg_class c</span>
<span id="cb202-6"><a aria-hidden="true" href="#cb202-6" tabindex="-1"></a><span class="kw">LEFT</span> <span class="kw">JOIN</span> pg_class t <span class="kw">ON</span> c.reltoastrelid <span class="op">=</span> t.<span class="kw">oid</span></span>
<span id="cb202-7"><a aria-hidden="true" href="#cb202-7" tabindex="-1"></a><span class="kw">WHERE</span> c.relkind <span class="op">=</span> <span class="st">'r'</span></span>
<span id="cb202-8"><a aria-hidden="true" href="#cb202-8" tabindex="-1"></a>  <span class="kw">AND</span> t.relname <span class="kw">IS</span> <span class="kw">NOT</span> <span class="kw">NULL</span></span>
<span id="cb202-9"><a aria-hidden="true" href="#cb202-9" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> pg_relation_size(t.<span class="kw">oid</span>) <span class="kw">DESC</span>;</span>
<span id="cb202-10"><a aria-hidden="true" href="#cb202-10" tabindex="-1"></a></span>
<span id="cb202-11"><a aria-hidden="true" href="#cb202-11" tabindex="-1"></a><span class="co">-- Check TOAST statistics</span></span>
<span id="cb202-12"><a aria-hidden="true" href="#cb202-12" tabindex="-1"></a><span class="kw">SELECT</span> schemaname, relname, n_tup_ins, n_tup_upd, n_tup_del</span>
<span id="cb202-13"><a aria-hidden="true" href="#cb202-13" tabindex="-1"></a><span class="kw">FROM</span> pg_stat_user_tables</span>
<span id="cb202-14"><a aria-hidden="true" href="#cb202-14" tabindex="-1"></a><span class="kw">WHERE</span> relname <span class="kw">LIKE</span> <span class="st">'pg_toast%'</span></span>
<span id="cb202-15"><a aria-hidden="true" href="#cb202-15" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> n_tup_upd <span class="kw">DESC</span>;</span></code></pre></div>
<h3 data-number="3.11.12" id="toast-limitations"><span class="header-section-number">3.11.12</span> TOAST Limitations</h3>
<p><strong>Maximum value size:</strong></p>
<pre><code>Maximum TOAST value: 1GB
(due to 30-bit length field in varlena header)

For larger values: Use large objects (lo_*) API</code></pre>
<p><strong>Chunk size:</strong></p>
<div class="sourceCode" id="cb204"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb204-1"><a aria-hidden="true" href="#cb204-1" tabindex="-1"></a><span class="pp">#define TOAST_MAX_CHUNK_SIZE  </span><span class="dv">2000</span><span class="pp">  </span><span class="co">/* ~2KB per chunk */</span></span></code></pre></div>
<p>Retrieving 1GB value requires reading 500,000+ chunks (slow).</p>
<p><strong>Fixed overhead:</strong></p>
<p>Every TOASTed value incurs: - TOAST table storage - Index entry -
Multiple I/O operations</p>
<p>For small values (&lt; 2KB), overhead exceeds benefit.</p>
<h3 data-number="3.11.13" id="toast-and-logical-replication"><span class="header-section-number">3.11.13</span> TOAST and Logical
Replication</h3>
<p>TOAST values replicated efficiently:</p>
<pre><code>If TOAST pointer unchanged ‚Üí Send pointer only
If TOAST value changed ‚Üí Send full new value</code></pre>
<p>Logical replication protocols handle TOAST transparently.</p>
<h3 data-number="3.11.14" id="toast-code-locations"><span class="header-section-number">3.11.14</span> TOAST Code Locations</h3>
<p><strong>Core TOAST functions</strong>
(<code>src/backend/access/common/</code>):</p>
<ul>
<li><code>toast_insert_or_update</code>: Main entry point for
TOASTing</li>
<li><code>toast_flatten_tuple</code>: Expand all TOASTed attributes</li>
<li><code>toast_compress_datum</code>: Compress attribute</li>
<li><code>toast_save_datum</code>: Save to TOAST table</li>
<li><code>toast_fetch_datum</code>: Retrieve from TOAST table</li>
<li><code>toast_delete_datum</code>: Delete TOAST chunks</li>
</ul>
<h2 data-number="3.12" id="conclusion"><span class="header-section-number">3.12</span> Conclusion</h2>
<h3 data-number="3.12.1" id="summary"><span class="header-section-number">3.12.1</span> Summary</h3>
<p>The PostgreSQL storage layer is a sophisticated system that provides
reliability, performance, and flexibility through carefully designed
components working in concert:</p>
<ol type="1">
<li><p><strong>Page Structure</strong>: The 8KB slotted page design
provides efficient storage for variable-length tuples while maintaining
stable tuple identifiers through item pointer indirection.</p></li>
<li><p><strong>Buffer Manager</strong>: Multi-level caching with the
clock sweep algorithm, coordinated with WAL, ensures high performance
while maintaining crash safety.</p></li>
<li><p><strong>Heap Access Method</strong>: Unordered tuple storage with
support for MVCC, HOT updates, and tuple locking provides the foundation
for PostgreSQL‚Äôs default table storage.</p></li>
<li><p><strong>Write-Ahead Logging</strong>: The WAL-before-data
protocol guarantees crash recovery, enables point-in-time recovery, and
forms the basis for physical replication.</p></li>
<li><p><strong>MVCC</strong>: Multi-version concurrency control allows
readers and writers to operate without blocking each other, providing
high concurrency and multiple isolation levels.</p></li>
<li><p><strong>Index Access Methods</strong>: Six specialized index
types (B-tree, Hash, GiST, SP-GiST, GIN, BRIN) support diverse query
patterns and data types, from general-purpose B-trees to specialized GIN
indexes for full-text search.</p></li>
<li><p><strong>Free Space Map</strong>: Efficient tracking of available
space enables fast insertion and space reuse, preventing unnecessary
table growth.</p></li>
<li><p><strong>Visibility Map</strong>: Bitmap tracking of all-visible
pages dramatically accelerates VACUUM and enables index-only
scans.</p></li>
<li><p><strong>TOAST</strong>: Transparent handling of large attribute
values removes practical limits on column sizes while maintaining
reasonable performance.</p></li>
</ol>
<h3 data-number="3.12.2" id="architectural-principles"><span class="header-section-number">3.12.2</span> Architectural
Principles</h3>
<p>Several key principles unify these components:</p>
<p><strong>Reliability First</strong>: Every component prioritizes data
integrity and crash safety. WAL protects all modifications, checksums
detect corruption, and MVCC ensures consistent snapshots.</p>
<p><strong>Performance Through Design</strong>: Rather than relying
solely on raw speed, PostgreSQL achieves performance through intelligent
design: slotted pages enable HOT updates, the buffer manager transforms
random I/O into sequential writes, and the visibility map allows massive
VACUUM speedups.</p>
<p><strong>Extensibility</strong>: The access method API, custom index
types, and pluggable storage engines demonstrate PostgreSQL‚Äôs commitment
to extensibility without compromising core functionality.</p>
<p><strong>Transparency</strong>: Complex mechanisms like TOAST, MVCC,
and buffer management operate transparently to applications, simplifying
development while providing sophisticated features.</p>
<h3 data-number="3.12.3" id="performance-tuning-summary"><span class="header-section-number">3.12.3</span> Performance Tuning
Summary</h3>
<p>Key configuration parameters for storage layer performance:</p>
<pre><code># Buffer management
shared_buffers = 8GB              # 25% of RAM (up to 16GB)
effective_cache_size = 24GB       # Total cache (OS + PostgreSQL)

# WAL configuration
wal_buffers = 16MB
checkpoint_timeout = 15min
checkpoint_completion_target = 0.9
max_wal_size = 2GB

# VACUUM tuning
autovacuum = on
autovacuum_naptime = 1min
autovacuum_vacuum_scale_factor = 0.1
vacuum_cost_limit = 2000

# Table storage
default_fillfactor = 90           # For frequently updated tables</code></pre>
<h3 data-number="3.12.4" id="monitoring-essentials"><span class="header-section-number">3.12.4</span> Monitoring Essentials</h3>
<p>Critical metrics to monitor:</p>
<div class="sourceCode" id="cb207"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb207-1"><a aria-hidden="true" href="#cb207-1" tabindex="-1"></a><span class="co">-- Cache hit ratio (target &gt; 99%)</span></span>
<span id="cb207-2"><a aria-hidden="true" href="#cb207-2" tabindex="-1"></a><span class="kw">SELECT</span> <span class="fu">sum</span>(heap_blks_hit) <span class="op">/</span> <span class="fu">nullif</span>(<span class="fu">sum</span>(heap_blks_hit) <span class="op">+</span> <span class="fu">sum</span>(heap_blks_read), <span class="dv">0</span>)</span>
<span id="cb207-3"><a aria-hidden="true" href="#cb207-3" tabindex="-1"></a><span class="kw">FROM</span> pg_statio_user_tables;</span>
<span id="cb207-4"><a aria-hidden="true" href="#cb207-4" tabindex="-1"></a></span>
<span id="cb207-5"><a aria-hidden="true" href="#cb207-5" tabindex="-1"></a><span class="co">-- Table bloat</span></span>
<span id="cb207-6"><a aria-hidden="true" href="#cb207-6" tabindex="-1"></a><span class="kw">SELECT</span> schemaname, tablename, n_dead_tup,</span>
<span id="cb207-7"><a aria-hidden="true" href="#cb207-7" tabindex="-1"></a>       <span class="fu">round</span>(n_dead_tup:<span class="ch">:numeric</span> <span class="op">/</span> <span class="fu">nullif</span>(n_live_tup, <span class="dv">0</span>), <span class="dv">3</span>) <span class="kw">AS</span> dead_ratio</span>
<span id="cb207-8"><a aria-hidden="true" href="#cb207-8" tabindex="-1"></a><span class="kw">FROM</span> pg_stat_user_tables</span>
<span id="cb207-9"><a aria-hidden="true" href="#cb207-9" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> n_dead_tup <span class="kw">DESC</span>;</span>
<span id="cb207-10"><a aria-hidden="true" href="#cb207-10" tabindex="-1"></a></span>
<span id="cb207-11"><a aria-hidden="true" href="#cb207-11" tabindex="-1"></a><span class="co">-- WAL generation</span></span>
<span id="cb207-12"><a aria-hidden="true" href="#cb207-12" tabindex="-1"></a><span class="kw">SELECT</span> pg_size_pretty(wal_bytes) <span class="kw">FROM</span> pg_stat_wal;</span>
<span id="cb207-13"><a aria-hidden="true" href="#cb207-13" tabindex="-1"></a></span>
<span id="cb207-14"><a aria-hidden="true" href="#cb207-14" tabindex="-1"></a><span class="co">-- Index usage</span></span>
<span id="cb207-15"><a aria-hidden="true" href="#cb207-15" tabindex="-1"></a><span class="kw">SELECT</span> schemaname, tablename, indexname, idx_scan</span>
<span id="cb207-16"><a aria-hidden="true" href="#cb207-16" tabindex="-1"></a><span class="kw">FROM</span> pg_stat_user_indexes</span>
<span id="cb207-17"><a aria-hidden="true" href="#cb207-17" tabindex="-1"></a><span class="kw">WHERE</span> idx_scan <span class="op">=</span> <span class="dv">0</span> <span class="kw">AND</span> indexrelname !~ <span class="st">'^pg_'</span>;</span></code></pre></div>
<h3 data-number="3.12.5" id="looking-forward"><span class="header-section-number">3.12.5</span> Looking Forward</h3>
<p>The storage layer continues to evolve:</p>
<ul>
<li><strong>Pluggable Storage</strong>: PostgreSQL 12+ allows
alternative table storage methods</li>
<li><strong>Compression</strong>: Built-in table compression (PostgreSQL
14+)</li>
<li><strong>I/O Improvements</strong>: Direct I/O, asynchronous I/O
enhancements</li>
<li><strong>VACUUM Improvements</strong>: Faster and more efficient dead
tuple removal</li>
<li><strong>Index Enhancements</strong>: Deduplication, better BRIN
operator classes</li>
<li><strong>Sharding and Partitioning</strong>: Native table
partitioning improvements</li>
</ul>
<h3 data-number="3.12.6" id="cross-references"><span class="header-section-number">3.12.6</span> Cross-References</h3>
<p>Related chapters in this encyclopedia:</p>
<ul>
<li><strong>Chapter 3: Architecture Overview</strong> - How storage fits
into PostgreSQL‚Äôs overall architecture</li>
<li><strong>Chapter 5: Query Processing</strong> - How the query
executor uses the storage layer</li>
<li><strong>Chapter 6: Transactions</strong> - Transaction management
and MVCC implementation details</li>
<li><strong>Chapter 7: Replication</strong> - How WAL enables physical
and logical replication</li>
<li><strong>Chapter 10: Internals</strong> - Deep dives into specific
subsystems</li>
</ul>
<h3 data-number="3.12.7" id="further-reading"><span class="header-section-number">3.12.7</span> Further Reading</h3>
<p><strong>Source code files</strong>: -
<code>src/backend/storage/buffer/bufmgr.c</code> - Buffer manager (7,468
lines) - <code>src/backend/access/heap/heapam.c</code> - Heap access
method (9,337 lines) - <code>src/backend/access/transam/xlog.c</code> -
WAL implementation (9,584 lines) -
<code>src/backend/access/nbtree/nbtree.c</code> - B-tree implementation
- <code>src/backend/storage/freespace/freespace.c</code> - Free Space
Map - <code>src/backend/access/heap/visibilitymap.c</code> - Visibility
Map - <code>src/backend/access/common/toast*.c</code> - TOAST
implementation</p>
<p><strong>Documentation</strong>: - PostgreSQL Documentation: Chapter
73 (Database Physical Storage) - PostgreSQL Documentation: Chapter 30
(Reliability and the Write-Ahead Log) - PostgreSQL Wiki: Heap
Pageinspect - Source code comments (extensive and well-maintained)</p>
<p>The PostgreSQL storage layer represents decades of evolution,
incorporating lessons from both academic research and production
deployment at massive scale. Understanding these components provides
essential insight into how PostgreSQL achieves its combination of
reliability, performance, and functionality.</p>
<h1 data-number="4" id="postgresql-query-processing-pipeline"><span class="header-section-number">4</span> PostgreSQL Query Processing
Pipeline</h1>
<h2 data-number="4.1" id="table-of-contents-2"><span class="header-section-number">4.1</span> Table of Contents</h2>
<ol type="1">
<li><a href="#1-introduction">Introduction</a></li>
<li><a href="#2-the-parser">The Parser</a></li>
<li><a href="#3-the-rewriter">The Rewriter</a></li>
<li><a href="#4-the-planneroptimizer">The Planner/Optimizer</a></li>
<li><a href="#5-the-executor">The Executor</a></li>
<li><a href="#6-catalog-system-and-syscache">Catalog System and
Syscache</a></li>
<li><a href="#7-node-types-and-data-structures">Node Types and Data
Structures</a></li>
<li><a href="#8-join-algorithms">Join Algorithms</a></li>
<li><a href="#9-cost-model-and-parameters">Cost Model and
Parameters</a></li>
<li><a href="#10-expression-evaluation">Expression Evaluation</a></li>
<li><a href="#11-complete-query-example-walkthrough">Complete Query
Example Walkthrough</a></li>
</ol>
<hr/>
<h2 data-number="4.2" id="introduction-1"><span class="header-section-number">4.2</span> 1. Introduction</h2>
<p>PostgreSQL‚Äôs query processing system transforms SQL statements into
executable plans through a sophisticated four-stage pipeline:
<strong>parsing</strong>, <strong>rewriting</strong>,
<strong>planning/optimization</strong>, and <strong>execution</strong>.
This architecture represents decades of evolution in database query
processing, combining academic research with practical engineering to
deliver both correctness and performance.</p>
<h3 data-number="4.2.1" id="query-processing-overview"><span class="header-section-number">4.2.1</span> 1.1 Query Processing
Overview</h3>
<pre><code>SQL Text
    ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  1. PARSER      ‚îÇ  Lexical/syntactic analysis, semantic transformation
‚îÇ  gram.y (17,896 lines)        ‚îÇ
‚îÇ  scan.l         ‚îÇ  ‚Üí Parse Tree (RawStmt) ‚Üí Query Tree
‚îÇ  analyze.c      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
    ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  2. REWRITER    ‚îÇ  View expansion, rule application, RLS
‚îÇ  rewriteHandler.c (3,877 lines)           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚Üí Rewritten Query Tree(s)
    ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  3. PLANNER     ‚îÇ  Path generation, cost estimation, plan selection
‚îÇ  planner.c (7,341 lines)      ‚îÇ
‚îÇ  Cost estimation‚îÇ  ‚Üí PlannedStmt (Plan Tree)
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
    ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  4. EXECUTOR    ‚îÇ  Plan execution, tuple generation
‚îÇ  execMain.c (2,833 lines)     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚Üí Result Tuples</code></pre>
<h3 data-number="4.2.2" id="key-design-principles"><span class="header-section-number">4.2.2</span> 1.2 Key Design
Principles</h3>
<p><strong>Separation of Concerns</strong>: Each stage has a
well-defined responsibility and produces specific output structures for
the next stage.</p>
<p><strong>Extensibility</strong>: Hook functions at each stage allow
extensions to modify behavior without changing core code.</p>
<p><strong>Node-based Architecture</strong>: All data structures are
node types with uniform handling for copying, serialization, and
debugging.</p>
<p><strong>Cost-based Optimization</strong>: The planner evaluates
multiple execution strategies and selects the plan with the lowest
estimated cost.</p>
<hr/>
<h2 data-number="4.3" id="the-parser"><span class="header-section-number">4.3</span> 2. The Parser</h2>
<p>The parser transforms raw SQL text into a structured Query tree
through lexical analysis, syntactic parsing, and semantic analysis.</p>
<h3 data-number="4.3.1" id="parser-components"><span class="header-section-number">4.3.1</span> 2.1 Parser Components</h3>
<h4 data-number="4.3.1.1" id="lexer-scan.l"><span class="header-section-number">4.3.1.1</span> Lexer (scan.l)</h4>
<p><strong>Location</strong>:
<code>/home/user/postgres/src/backend/parser/scan.l</code></p>
<p>The lexer performs tokenization, converting raw SQL text into a
stream of tokens. Written using Flex (a lexical analyzer generator), it
handles:</p>
<ul>
<li><strong>Keywords</strong>: SELECT, FROM, WHERE, etc.</li>
<li><strong>Identifiers</strong>: Table names, column names (with
case-folding)</li>
<li><strong>Literals</strong>: Strings, numbers, bit strings</li>
<li><strong>Operators</strong>: =, &lt;, &gt;, ||, etc.</li>
<li><strong>Special characters</strong>: Parentheses, commas,
semicolons</li>
</ul>
<div class="sourceCode" id="cb209"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb209-1"><a aria-hidden="true" href="#cb209-1" tabindex="-1"></a><span class="co">/* Example token definitions from scan.l */</span></span>
<span id="cb209-2"><a aria-hidden="true" href="#cb209-2" tabindex="-1"></a></span>
<span id="cb209-3"><a aria-hidden="true" href="#cb209-3" tabindex="-1"></a><span class="op">{</span>self<span class="op">}</span>              <span class="op">{</span> <span class="cf">return</span> yytext<span class="op">[</span><span class="dv">0</span><span class="op">];</span> <span class="op">}</span></span>
<span id="cb209-4"><a aria-hidden="true" href="#cb209-4" tabindex="-1"></a><span class="op">{</span>operator<span class="op">}</span>          <span class="op">{</span> <span class="cf">return</span> process_operator<span class="op">(</span>yytext<span class="op">);</span> <span class="op">}</span></span>
<span id="cb209-5"><a aria-hidden="true" href="#cb209-5" tabindex="-1"></a><span class="op">{</span>integer<span class="op">}</span>           <span class="op">{</span> <span class="cf">return</span> process_integer_literal<span class="op">(</span>yytext<span class="op">);</span> <span class="op">}</span></span>
<span id="cb209-6"><a aria-hidden="true" href="#cb209-6" tabindex="-1"></a><span class="op">{</span>identifier<span class="op">}</span>        <span class="op">{</span> <span class="cf">return</span> process_identifier<span class="op">(</span>yytext<span class="op">);</span> <span class="op">}</span></span>
<span id="cb209-7"><a aria-hidden="true" href="#cb209-7" tabindex="-1"></a></span>
<span id="cb209-8"><a aria-hidden="true" href="#cb209-8" tabindex="-1"></a><span class="co">/* String literal handling */</span></span>
<span id="cb209-9"><a aria-hidden="true" href="#cb209-9" tabindex="-1"></a><span class="op">{</span>quote<span class="op">}</span>             <span class="op">{</span></span>
<span id="cb209-10"><a aria-hidden="true" href="#cb209-10" tabindex="-1"></a>    BEGIN<span class="op">(</span>xq<span class="op">);</span></span>
<span id="cb209-11"><a aria-hidden="true" href="#cb209-11" tabindex="-1"></a>    startlit<span class="op">();</span></span>
<span id="cb209-12"><a aria-hidden="true" href="#cb209-12" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h4 data-number="4.3.1.2" id="grammar-gram.y"><span class="header-section-number">4.3.1.2</span> Grammar (gram.y)</h4>
<p><strong>Location</strong>:
<code>/home/user/postgres/src/backend/parser/gram.y</code> (17,896
lines)</p>
<p>The grammar file defines SQL syntax using Bison (YACC-compatible
parser generator). It contains production rules for every SQL construct
PostgreSQL supports.</p>
<p><strong>Key Statistics</strong>: - <strong>17,896 lines</strong> of
grammar rules - Hundreds of non-terminals - Complete SQL:2016 standard
coverage plus PostgreSQL extensions</p>
<p><strong>Sample Production Rules</strong>:</p>
<div class="sourceCode" id="cb210"><pre class="sourceCode yacc"><code class="sourceCode yacc"><span id="cb210-1"><a aria-hidden="true" href="#cb210-1" tabindex="-1"></a><span class="co">/* Simple SELECT statement structure */</span></span>
<span id="cb210-2"><a aria-hidden="true" href="#cb210-2" tabindex="-1"></a>SelectStmt:</span>
<span id="cb210-3"><a aria-hidden="true" href="#cb210-3" tabindex="-1"></a>    select_no_parens            <span class="kw">%prec</span> UMINUS</span>
<span id="cb210-4"><a aria-hidden="true" href="#cb210-4" tabindex="-1"></a>    | select_with_parens        %prec UMINUS</span>
<span id="cb210-5"><a aria-hidden="true" href="#cb210-5" tabindex="-1"></a>    ;</span>
<span id="cb210-6"><a aria-hidden="true" href="#cb210-6" tabindex="-1"></a></span>
<span id="cb210-7"><a aria-hidden="true" href="#cb210-7" tabindex="-1"></a>select_no_parens:</span>
<span id="cb210-8"><a aria-hidden="true" href="#cb210-8" tabindex="-1"></a>    simple_select</span>
<span id="cb210-9"><a aria-hidden="true" href="#cb210-9" tabindex="-1"></a>    | select_clause sort_clause</span>
<span id="cb210-10"><a aria-hidden="true" href="#cb210-10" tabindex="-1"></a>    | select_clause opt_sort_clause for_locking_clause opt_select_limit</span>
<span id="cb210-11"><a aria-hidden="true" href="#cb210-11" tabindex="-1"></a>    | select_clause opt_sort_clause select_limit opt_for_locking_clause</span>
<span id="cb210-12"><a aria-hidden="true" href="#cb210-12" tabindex="-1"></a>    | with_clause select_clause</span>
<span id="cb210-13"><a aria-hidden="true" href="#cb210-13" tabindex="-1"></a>    ;</span>
<span id="cb210-14"><a aria-hidden="true" href="#cb210-14" tabindex="-1"></a></span>
<span id="cb210-15"><a aria-hidden="true" href="#cb210-15" tabindex="-1"></a>simple_select:</span>
<span id="cb210-16"><a aria-hidden="true" href="#cb210-16" tabindex="-1"></a>    SELECT opt_all_clause opt_target_list</span>
<span id="cb210-17"><a aria-hidden="true" href="#cb210-17" tabindex="-1"></a>        into_clause from_clause where_clause</span>
<span id="cb210-18"><a aria-hidden="true" href="#cb210-18" tabindex="-1"></a>        group_clause having_clause window_clause</span>
<span id="cb210-19"><a aria-hidden="true" href="#cb210-19" tabindex="-1"></a>        {</span>
<span id="cb210-20"><a aria-hidden="true" href="#cb210-20" tabindex="-1"></a>            SelectStmt *n = makeNode(SelectStmt);</span>
<span id="cb210-21"><a aria-hidden="true" href="#cb210-21" tabindex="-1"></a>            n-&gt;targetList = $3;</span>
<span id="cb210-22"><a aria-hidden="true" href="#cb210-22" tabindex="-1"></a>            n-&gt;intoClause = $4;</span>
<span id="cb210-23"><a aria-hidden="true" href="#cb210-23" tabindex="-1"></a>            n-&gt;fromClause = $5;</span>
<span id="cb210-24"><a aria-hidden="true" href="#cb210-24" tabindex="-1"></a>            n-&gt;whereClause = $6;</span>
<span id="cb210-25"><a aria-hidden="true" href="#cb210-25" tabindex="-1"></a>            n-&gt;groupClause = $7;</span>
<span id="cb210-26"><a aria-hidden="true" href="#cb210-26" tabindex="-1"></a>            n-&gt;havingClause = $8;</span>
<span id="cb210-27"><a aria-hidden="true" href="#cb210-27" tabindex="-1"></a>            n-&gt;windowClause = $9;</span>
<span id="cb210-28"><a aria-hidden="true" href="#cb210-28" tabindex="-1"></a>            $$ = (Node *) n;</span>
<span id="cb210-29"><a aria-hidden="true" href="#cb210-29" tabindex="-1"></a>        }</span>
<span id="cb210-30"><a aria-hidden="true" href="#cb210-30" tabindex="-1"></a>    ;</span>
<span id="cb210-31"><a aria-hidden="true" href="#cb210-31" tabindex="-1"></a></span>
<span id="cb210-32"><a aria-hidden="true" href="#cb210-32" tabindex="-1"></a><span class="co">/* JOIN syntax */</span></span>
<span id="cb210-33"><a aria-hidden="true" href="#cb210-33" tabindex="-1"></a>joined_table:</span>
<span id="cb210-34"><a aria-hidden="true" href="#cb210-34" tabindex="-1"></a>    '(' joined_table ')'</span>
<span id="cb210-35"><a aria-hidden="true" href="#cb210-35" tabindex="-1"></a>    | table_ref CROSS JOIN table_ref</span>
<span id="cb210-36"><a aria-hidden="true" href="#cb210-36" tabindex="-1"></a>    | table_ref join_type JOIN table_ref join_qual</span>
<span id="cb210-37"><a aria-hidden="true" href="#cb210-37" tabindex="-1"></a>    | table_ref JOIN table_ref join_qual</span>
<span id="cb210-38"><a aria-hidden="true" href="#cb210-38" tabindex="-1"></a>    | table_ref NATURAL join_type JOIN table_ref</span>
<span id="cb210-39"><a aria-hidden="true" href="#cb210-39" tabindex="-1"></a>    ;</span>
<span id="cb210-40"><a aria-hidden="true" href="#cb210-40" tabindex="-1"></a></span>
<span id="cb210-41"><a aria-hidden="true" href="#cb210-41" tabindex="-1"></a>join_type:</span>
<span id="cb210-42"><a aria-hidden="true" href="#cb210-42" tabindex="-1"></a>    FULL join_outer             { $$ = JOIN_FULL; }</span>
<span id="cb210-43"><a aria-hidden="true" href="#cb210-43" tabindex="-1"></a>    | LEFT join_outer           { $$ = JOIN_LEFT; }</span>
<span id="cb210-44"><a aria-hidden="true" href="#cb210-44" tabindex="-1"></a>    | RIGHT join_outer          { $$ = JOIN_RIGHT; }</span>
<span id="cb210-45"><a aria-hidden="true" href="#cb210-45" tabindex="-1"></a>    | INNER_P                   { $$ = JOIN_INNER; }</span>
<span id="cb210-46"><a aria-hidden="true" href="#cb210-46" tabindex="-1"></a>    ;</span></code></pre></div>
<h4 data-number="4.3.1.3" id="semantic-analysis-analyze.c"><span class="header-section-number">4.3.1.3</span> Semantic Analysis
(analyze.c)</h4>
<p><strong>Location</strong>:
<code>/home/user/postgres/src/backend/parser/analyze.c</code></p>
<p>The analyzer transforms the raw parse tree into a Query structure,
performing:</p>
<ol type="1">
<li><strong>Name Resolution</strong>: Resolving table/column
references</li>
<li><strong>Type Checking</strong>: Ensuring type compatibility</li>
<li><strong>Function Resolution</strong>: Finding matching function
signatures</li>
<li><strong>Subquery Processing</strong>: Handling nested queries</li>
<li><strong>Aggregate Validation</strong>: Checking aggregate usage
rules</li>
<li><strong>Constraint Checking</strong>: Validating NOT NULL, CHECK
constraints</li>
</ol>
<p><strong>Main Entry Point</strong> (<code>lines 114-145</code>):</p>
<div class="sourceCode" id="cb211"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb211-1"><a aria-hidden="true" href="#cb211-1" tabindex="-1"></a><span class="co">/*</span></span>
<span id="cb211-2"><a aria-hidden="true" href="#cb211-2" tabindex="-1"></a><span class="co"> * parse_analyze_fixedparams</span></span>
<span id="cb211-3"><a aria-hidden="true" href="#cb211-3" tabindex="-1"></a><span class="co"> *      Analyze a raw parse tree and transform it to Query form.</span></span>
<span id="cb211-4"><a aria-hidden="true" href="#cb211-4" tabindex="-1"></a><span class="co"> *</span></span>
<span id="cb211-5"><a aria-hidden="true" href="#cb211-5" tabindex="-1"></a><span class="co"> * Optionally, information about $n parameter types can be supplied.</span></span>
<span id="cb211-6"><a aria-hidden="true" href="#cb211-6" tabindex="-1"></a><span class="co"> * References to $n indexes not defined by paramTypes[] are disallowed.</span></span>
<span id="cb211-7"><a aria-hidden="true" href="#cb211-7" tabindex="-1"></a><span class="co"> *</span></span>
<span id="cb211-8"><a aria-hidden="true" href="#cb211-8" tabindex="-1"></a><span class="co"> * The result is a Query node.  Optimizable statements require considerable</span></span>
<span id="cb211-9"><a aria-hidden="true" href="#cb211-9" tabindex="-1"></a><span class="co"> * transformation, while utility-type statements are simply hung off</span></span>
<span id="cb211-10"><a aria-hidden="true" href="#cb211-10" tabindex="-1"></a><span class="co"> * a dummy CMD_UTILITY Query node.</span></span>
<span id="cb211-11"><a aria-hidden="true" href="#cb211-11" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb211-12"><a aria-hidden="true" href="#cb211-12" tabindex="-1"></a>Query <span class="op">*</span></span>
<span id="cb211-13"><a aria-hidden="true" href="#cb211-13" tabindex="-1"></a>parse_analyze_fixedparams<span class="op">(</span>RawStmt <span class="op">*</span>parseTree<span class="op">,</span> <span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>sourceText<span class="op">,</span></span>
<span id="cb211-14"><a aria-hidden="true" href="#cb211-14" tabindex="-1"></a>                          <span class="dt">const</span> Oid <span class="op">*</span>paramTypes<span class="op">,</span> <span class="dt">int</span> numParams<span class="op">,</span></span>
<span id="cb211-15"><a aria-hidden="true" href="#cb211-15" tabindex="-1"></a>                          QueryEnvironment <span class="op">*</span>queryEnv<span class="op">)</span></span>
<span id="cb211-16"><a aria-hidden="true" href="#cb211-16" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb211-17"><a aria-hidden="true" href="#cb211-17" tabindex="-1"></a>    ParseState <span class="op">*</span>pstate <span class="op">=</span> make_parsestate<span class="op">(</span>NULL<span class="op">);</span></span>
<span id="cb211-18"><a aria-hidden="true" href="#cb211-18" tabindex="-1"></a>    Query      <span class="op">*</span>query<span class="op">;</span></span>
<span id="cb211-19"><a aria-hidden="true" href="#cb211-19" tabindex="-1"></a>    JumbleState <span class="op">*</span>jstate <span class="op">=</span> NULL<span class="op">;</span></span>
<span id="cb211-20"><a aria-hidden="true" href="#cb211-20" tabindex="-1"></a></span>
<span id="cb211-21"><a aria-hidden="true" href="#cb211-21" tabindex="-1"></a>    Assert<span class="op">(</span>sourceText <span class="op">!=</span> NULL<span class="op">);</span> <span class="co">/* required as of 8.4 */</span></span>
<span id="cb211-22"><a aria-hidden="true" href="#cb211-22" tabindex="-1"></a></span>
<span id="cb211-23"><a aria-hidden="true" href="#cb211-23" tabindex="-1"></a>    pstate<span class="op">-&gt;</span>p_sourcetext <span class="op">=</span> sourceText<span class="op">;</span></span>
<span id="cb211-24"><a aria-hidden="true" href="#cb211-24" tabindex="-1"></a></span>
<span id="cb211-25"><a aria-hidden="true" href="#cb211-25" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>numParams <span class="op">&gt;</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb211-26"><a aria-hidden="true" href="#cb211-26" tabindex="-1"></a>        setup_parse_fixed_parameters<span class="op">(</span>pstate<span class="op">,</span> paramTypes<span class="op">,</span> numParams<span class="op">);</span></span>
<span id="cb211-27"><a aria-hidden="true" href="#cb211-27" tabindex="-1"></a></span>
<span id="cb211-28"><a aria-hidden="true" href="#cb211-28" tabindex="-1"></a>    pstate<span class="op">-&gt;</span>p_queryEnv <span class="op">=</span> queryEnv<span class="op">;</span></span>
<span id="cb211-29"><a aria-hidden="true" href="#cb211-29" tabindex="-1"></a></span>
<span id="cb211-30"><a aria-hidden="true" href="#cb211-30" tabindex="-1"></a>    query <span class="op">=</span> transformTopLevelStmt<span class="op">(</span>pstate<span class="op">,</span> parseTree<span class="op">);</span></span>
<span id="cb211-31"><a aria-hidden="true" href="#cb211-31" tabindex="-1"></a></span>
<span id="cb211-32"><a aria-hidden="true" href="#cb211-32" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>IsQueryIdEnabled<span class="op">())</span></span>
<span id="cb211-33"><a aria-hidden="true" href="#cb211-33" tabindex="-1"></a>        jstate <span class="op">=</span> JumbleQuery<span class="op">(</span>query<span class="op">);</span></span>
<span id="cb211-34"><a aria-hidden="true" href="#cb211-34" tabindex="-1"></a></span>
<span id="cb211-35"><a aria-hidden="true" href="#cb211-35" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>post_parse_analyze_hook<span class="op">)</span></span>
<span id="cb211-36"><a aria-hidden="true" href="#cb211-36" tabindex="-1"></a>        <span class="op">(*</span>post_parse_analyze_hook<span class="op">)</span> <span class="op">(</span>pstate<span class="op">,</span> query<span class="op">,</span> jstate<span class="op">);</span></span>
<span id="cb211-37"><a aria-hidden="true" href="#cb211-37" tabindex="-1"></a></span>
<span id="cb211-38"><a aria-hidden="true" href="#cb211-38" tabindex="-1"></a>    free_parsestate<span class="op">(</span>pstate<span class="op">);</span></span>
<span id="cb211-39"><a aria-hidden="true" href="#cb211-39" tabindex="-1"></a></span>
<span id="cb211-40"><a aria-hidden="true" href="#cb211-40" tabindex="-1"></a>    pgstat_report_query_id<span class="op">(</span>query<span class="op">-&gt;</span>queryId<span class="op">,</span> <span class="kw">false</span><span class="op">);</span></span>
<span id="cb211-41"><a aria-hidden="true" href="#cb211-41" tabindex="-1"></a></span>
<span id="cb211-42"><a aria-hidden="true" href="#cb211-42" tabindex="-1"></a>    <span class="cf">return</span> query<span class="op">;</span></span>
<span id="cb211-43"><a aria-hidden="true" href="#cb211-43" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 data-number="4.3.2" id="parse-tree-to-query-transformation"><span class="header-section-number">4.3.2</span> 2.2 Parse Tree to Query
Transformation</h3>
<p>The transformation process converts syntactic structures into
semantic ones:</p>
<p><strong>Example: Simple SELECT</strong></p>
<div class="sourceCode" id="cb212"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb212-1"><a aria-hidden="true" href="#cb212-1" tabindex="-1"></a><span class="kw">SELECT</span> name, salary <span class="kw">FROM</span> employees <span class="kw">WHERE</span> dept_id <span class="op">=</span> <span class="dv">10</span>;</span></code></pre></div>
<p><strong>RawStmt (Parse Tree)</strong>:</p>
<pre><code>SelectStmt {
    targetList: [
        ResTarget { name: "name" },
        ResTarget { name: "salary" }
    ],
    fromClause: [
        RangeVar { relname: "employees" }
    ],
    whereClause: A_Expr {
        kind: AEXPR_OP,
        name: "=",
        lexpr: ColumnRef { fields: ["dept_id"] },
        rexpr: A_Const { val: 10 }
    }
}</code></pre>
<p><strong>Query (Semantic Tree)</strong>:</p>
<pre><code>Query {
    commandType: CMD_SELECT,
    rtable: [
        RangeTblEntry {
            rtekind: RTE_RELATION,
            relid: &lt;OID of employees&gt;,
            relkind: RELKIND_RELATION,
            requiredPerms: ACL_SELECT
        }
    ],
    targetList: [
        TargetEntry {
            expr: Var { varno: 1, varattno: 1, vartype: TEXT },
            resname: "name"
        },
        TargetEntry {
            expr: Var { varno: 1, varattno: 2, vartype: NUMERIC },
            resname: "salary"
        }
    ],
    jointree: FromExpr {
        quals: OpExpr {
            opno: &lt;OID of int4eq&gt;,
            args: [
                Var { varno: 1, varattno: 3, vartype: INT4 },
                Const { consttype: INT4, constvalue: 10 }
            ]
        }
    }
}</code></pre>
<h3 data-number="4.3.3" id="parser-subsystems"><span class="header-section-number">4.3.3</span> 2.3 Parser Subsystems</h3>
<h4 data-number="4.3.3.1" id="type-resolution"><span class="header-section-number">4.3.3.1</span> Type Resolution</h4>
<p><strong>Location</strong>:
<code>/home/user/postgres/src/backend/parser/parse_type.c</code></p>
<p>Resolves type names to OIDs and validates type usage:</p>
<div class="sourceCode" id="cb215"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb215-1"><a aria-hidden="true" href="#cb215-1" tabindex="-1"></a><span class="co">/* Find a type by name */</span></span>
<span id="cb215-2"><a aria-hidden="true" href="#cb215-2" tabindex="-1"></a>Type</span>
<span id="cb215-3"><a aria-hidden="true" href="#cb215-3" tabindex="-1"></a>LookupTypeName<span class="op">(</span>ParseState <span class="op">*</span>pstate<span class="op">,</span> <span class="dt">const</span> TypeName <span class="op">*</span>typeName<span class="op">,</span></span>
<span id="cb215-4"><a aria-hidden="true" href="#cb215-4" tabindex="-1"></a>               int32 <span class="op">*</span>typmod_p<span class="op">,</span> <span class="dt">bool</span> missing_ok<span class="op">);</span></span>
<span id="cb215-5"><a aria-hidden="true" href="#cb215-5" tabindex="-1"></a></span>
<span id="cb215-6"><a aria-hidden="true" href="#cb215-6" tabindex="-1"></a><span class="co">/* Verify types are compatible */</span></span>
<span id="cb215-7"><a aria-hidden="true" href="#cb215-7" tabindex="-1"></a><span class="dt">void</span></span>
<span id="cb215-8"><a aria-hidden="true" href="#cb215-8" tabindex="-1"></a>check_can_coerce<span class="op">(</span>Oid inputTypeId<span class="op">,</span> Oid targetTypeId<span class="op">);</span></span></code></pre></div>
<h4 data-number="4.3.3.2" id="function-resolution"><span class="header-section-number">4.3.3.2</span> Function Resolution</h4>
<p><strong>Location</strong>:
<code>/home/user/postgres/src/backend/parser/parse_func.c</code></p>
<p>Handles function name resolution with overloading:</p>
<div class="sourceCode" id="cb216"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb216-1"><a aria-hidden="true" href="#cb216-1" tabindex="-1"></a><span class="co">/*</span></span>
<span id="cb216-2"><a aria-hidden="true" href="#cb216-2" tabindex="-1"></a><span class="co"> * func_select_candidate</span></span>
<span id="cb216-3"><a aria-hidden="true" href="#cb216-3" tabindex="-1"></a><span class="co"> *   Given the input argtype array, attempt to select the best candidate</span></span>
<span id="cb216-4"><a aria-hidden="true" href="#cb216-4" tabindex="-1"></a><span class="co"> *   function from the given list.</span></span>
<span id="cb216-5"><a aria-hidden="true" href="#cb216-5" tabindex="-1"></a><span class="co"> *</span></span>
<span id="cb216-6"><a aria-hidden="true" href="#cb216-6" tabindex="-1"></a><span class="co"> * Returns the index of the best candidate (0..ncandidates-1), or -1</span></span>
<span id="cb216-7"><a aria-hidden="true" href="#cb216-7" tabindex="-1"></a><span class="co"> * if no candidate can be selected.</span></span>
<span id="cb216-8"><a aria-hidden="true" href="#cb216-8" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb216-9"><a aria-hidden="true" href="#cb216-9" tabindex="-1"></a><span class="dt">static</span> <span class="dt">int</span></span>
<span id="cb216-10"><a aria-hidden="true" href="#cb216-10" tabindex="-1"></a>func_select_candidate<span class="op">(</span><span class="dt">int</span> nargs<span class="op">,</span></span>
<span id="cb216-11"><a aria-hidden="true" href="#cb216-11" tabindex="-1"></a>                     Oid <span class="op">*</span>input_typeids<span class="op">,</span></span>
<span id="cb216-12"><a aria-hidden="true" href="#cb216-12" tabindex="-1"></a>                     FuncCandidateList candidates<span class="op">);</span></span></code></pre></div>
<h4 data-number="4.3.3.3" id="aggregate-checking"><span class="header-section-number">4.3.3.3</span> Aggregate Checking</h4>
<p><strong>Location</strong>:
<code>/home/user/postgres/src/backend/parser/parse_agg.c</code></p>
<p>Validates aggregate function usage:</p>
<div class="sourceCode" id="cb217"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb217-1"><a aria-hidden="true" href="#cb217-1" tabindex="-1"></a><span class="co">/*</span></span>
<span id="cb217-2"><a aria-hidden="true" href="#cb217-2" tabindex="-1"></a><span class="co"> * parseCheckAggregates</span></span>
<span id="cb217-3"><a aria-hidden="true" href="#cb217-3" tabindex="-1"></a><span class="co"> *   Check for aggregates where they shouldn't be and improper grouping.</span></span>
<span id="cb217-4"><a aria-hidden="true" href="#cb217-4" tabindex="-1"></a><span class="co"> *</span></span>
<span id="cb217-5"><a aria-hidden="true" href="#cb217-5" tabindex="-1"></a><span class="co"> * This is a fairly complex operation because of the various special cases</span></span>
<span id="cb217-6"><a aria-hidden="true" href="#cb217-6" tabindex="-1"></a><span class="co"> * and because we must check the entire Query tree recursively.</span></span>
<span id="cb217-7"><a aria-hidden="true" href="#cb217-7" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb217-8"><a aria-hidden="true" href="#cb217-8" tabindex="-1"></a><span class="dt">void</span></span>
<span id="cb217-9"><a aria-hidden="true" href="#cb217-9" tabindex="-1"></a>parseCheckAggregates<span class="op">(</span>ParseState <span class="op">*</span>pstate<span class="op">,</span> Query <span class="op">*</span>qry<span class="op">);</span></span></code></pre></div>
<hr/>
<h2 data-number="4.4" id="the-rewriter"><span class="header-section-number">4.4</span> 3. The Rewriter</h2>
<p>The rewriter transforms Query trees by applying views, rules, and
row-level security policies. This stage can transform a single query
into multiple queries.</p>
<h3 data-number="4.4.1" id="rewriter-responsibilities"><span class="header-section-number">4.4.1</span> 3.1 Rewriter
Responsibilities</h3>
<p><strong>Location</strong>:
<code>/home/user/postgres/src/backend/rewrite/rewriteHandler.c</code>
(3,877 lines)</p>
<ol type="1">
<li><strong>View Expansion</strong>: Replace view references with
underlying queries</li>
<li><strong>Rule Application</strong>: Execute query rewrite rules</li>
<li><strong>Row-Level Security</strong>: Apply RLS policies</li>
<li><strong>Updatable View Handling</strong>: Transform view updates
into base table updates</li>
<li><strong>Inheritance Expansion</strong>: Expand inherited table
references</li>
</ol>
<h3 data-number="4.4.2" id="main-rewrite-entry-point"><span class="header-section-number">4.4.2</span> 3.2 Main Rewrite Entry
Point</h3>
<div class="sourceCode" id="cb218"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb218-1"><a aria-hidden="true" href="#cb218-1" tabindex="-1"></a><span class="co">/*</span></span>
<span id="cb218-2"><a aria-hidden="true" href="#cb218-2" tabindex="-1"></a><span class="co"> * QueryRewrite -</span></span>
<span id="cb218-3"><a aria-hidden="true" href="#cb218-3" tabindex="-1"></a><span class="co"> *    Primary entry point to the query rewriter.</span></span>
<span id="cb218-4"><a aria-hidden="true" href="#cb218-4" tabindex="-1"></a><span class="co"> *    Rewrite one query via query rewrite system, possibly returning 0</span></span>
<span id="cb218-5"><a aria-hidden="true" href="#cb218-5" tabindex="-1"></a><span class="co"> *    or multiple queries.</span></span>
<span id="cb218-6"><a aria-hidden="true" href="#cb218-6" tabindex="-1"></a><span class="co"> *</span></span>
<span id="cb218-7"><a aria-hidden="true" href="#cb218-7" tabindex="-1"></a><span class="co"> * </span><span class="al">NOTE</span><span class="co">: The code in QueryRewrite was formerly in pg_parse_and_rewrite(),</span></span>
<span id="cb218-8"><a aria-hidden="true" href="#cb218-8" tabindex="-1"></a><span class="co"> * and was split out to be called from plancache.c during plan invalidation.</span></span>
<span id="cb218-9"><a aria-hidden="true" href="#cb218-9" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb218-10"><a aria-hidden="true" href="#cb218-10" tabindex="-1"></a>List <span class="op">*</span></span>
<span id="cb218-11"><a aria-hidden="true" href="#cb218-11" tabindex="-1"></a>QueryRewrite<span class="op">(</span>Query <span class="op">*</span>parsetree<span class="op">)</span></span>
<span id="cb218-12"><a aria-hidden="true" href="#cb218-12" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb218-13"><a aria-hidden="true" href="#cb218-13" tabindex="-1"></a>    uint64      input_query_id <span class="op">=</span> parsetree<span class="op">-&gt;</span>queryId<span class="op">;</span></span>
<span id="cb218-14"><a aria-hidden="true" href="#cb218-14" tabindex="-1"></a>    List       <span class="op">*</span>querylist<span class="op">;</span></span>
<span id="cb218-15"><a aria-hidden="true" href="#cb218-15" tabindex="-1"></a>    List       <span class="op">*</span>results<span class="op">;</span></span>
<span id="cb218-16"><a aria-hidden="true" href="#cb218-16" tabindex="-1"></a>    ListCell   <span class="op">*</span>l<span class="op">;</span></span>
<span id="cb218-17"><a aria-hidden="true" href="#cb218-17" tabindex="-1"></a>    CmdType     orig_cmd <span class="op">=</span> parsetree<span class="op">-&gt;</span>commandType<span class="op">;</span></span>
<span id="cb218-18"><a aria-hidden="true" href="#cb218-18" tabindex="-1"></a>    <span class="dt">bool</span>        foundOriginalQuery <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb218-19"><a aria-hidden="true" href="#cb218-19" tabindex="-1"></a>    Query      <span class="op">*</span>lastInstead <span class="op">=</span> NULL<span class="op">;</span></span>
<span id="cb218-20"><a aria-hidden="true" href="#cb218-20" tabindex="-1"></a></span>
<span id="cb218-21"><a aria-hidden="true" href="#cb218-21" tabindex="-1"></a>    <span class="co">/*</span></span>
<span id="cb218-22"><a aria-hidden="true" href="#cb218-22" tabindex="-1"></a><span class="co">     * This function is only applied to top-level original queries</span></span>
<span id="cb218-23"><a aria-hidden="true" href="#cb218-23" tabindex="-1"></a><span class="co">     */</span></span>
<span id="cb218-24"><a aria-hidden="true" href="#cb218-24" tabindex="-1"></a>    Assert<span class="op">(</span>parsetree<span class="op">-&gt;</span>querySource <span class="op">==</span> QSRC_ORIGINAL<span class="op">);</span></span>
<span id="cb218-25"><a aria-hidden="true" href="#cb218-25" tabindex="-1"></a>    Assert<span class="op">(</span>parsetree<span class="op">-&gt;</span>canSetTag<span class="op">);</span></span>
<span id="cb218-26"><a aria-hidden="true" href="#cb218-26" tabindex="-1"></a></span>
<span id="cb218-27"><a aria-hidden="true" href="#cb218-27" tabindex="-1"></a>    <span class="co">/*</span></span>
<span id="cb218-28"><a aria-hidden="true" href="#cb218-28" tabindex="-1"></a><span class="co">     * Step 1</span></span>
<span id="cb218-29"><a aria-hidden="true" href="#cb218-29" tabindex="-1"></a><span class="co">     *</span></span>
<span id="cb218-30"><a aria-hidden="true" href="#cb218-30" tabindex="-1"></a><span class="co">     * Apply all non-SELECT rules possibly getting 0 or many queries</span></span>
<span id="cb218-31"><a aria-hidden="true" href="#cb218-31" tabindex="-1"></a><span class="co">     */</span></span>
<span id="cb218-32"><a aria-hidden="true" href="#cb218-32" tabindex="-1"></a>    querylist <span class="op">=</span> RewriteQuery<span class="op">(</span>parsetree<span class="op">,</span> NIL<span class="op">,</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb218-33"><a aria-hidden="true" href="#cb218-33" tabindex="-1"></a></span>
<span id="cb218-34"><a aria-hidden="true" href="#cb218-34" tabindex="-1"></a>    <span class="co">/* ... additional processing ... */</span></span>
<span id="cb218-35"><a aria-hidden="true" href="#cb218-35" tabindex="-1"></a></span>
<span id="cb218-36"><a aria-hidden="true" href="#cb218-36" tabindex="-1"></a>    <span class="cf">return</span> results<span class="op">;</span></span>
<span id="cb218-37"><a aria-hidden="true" href="#cb218-37" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 data-number="4.4.3" id="view-expansion"><span class="header-section-number">4.4.3</span> 3.3 View Expansion</h3>
<p>When a query references a view, the rewriter replaces it with the
view‚Äôs defining query.</p>
<p><strong>Example</strong>:</p>
<div class="sourceCode" id="cb219"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb219-1"><a aria-hidden="true" href="#cb219-1" tabindex="-1"></a><span class="co">-- View definition</span></span>
<span id="cb219-2"><a aria-hidden="true" href="#cb219-2" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">VIEW</span> high_earners <span class="kw">AS</span></span>
<span id="cb219-3"><a aria-hidden="true" href="#cb219-3" tabindex="-1"></a>    <span class="kw">SELECT</span> name, salary <span class="kw">FROM</span> employees <span class="kw">WHERE</span> salary <span class="op">&gt;</span> <span class="dv">100000</span>;</span>
<span id="cb219-4"><a aria-hidden="true" href="#cb219-4" tabindex="-1"></a></span>
<span id="cb219-5"><a aria-hidden="true" href="#cb219-5" tabindex="-1"></a><span class="co">-- Query</span></span>
<span id="cb219-6"><a aria-hidden="true" href="#cb219-6" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> high_earners <span class="kw">WHERE</span> dept_id <span class="op">=</span> <span class="dv">10</span>;</span></code></pre></div>
<p><strong>After Rewriting</strong>:</p>
<div class="sourceCode" id="cb220"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb220-1"><a aria-hidden="true" href="#cb220-1" tabindex="-1"></a><span class="kw">SELECT</span> name, salary</span>
<span id="cb220-2"><a aria-hidden="true" href="#cb220-2" tabindex="-1"></a><span class="kw">FROM</span> employees</span>
<span id="cb220-3"><a aria-hidden="true" href="#cb220-3" tabindex="-1"></a><span class="kw">WHERE</span> salary <span class="op">&gt;</span> <span class="dv">100000</span> <span class="kw">AND</span> dept_id <span class="op">=</span> <span class="dv">10</span>;</span></code></pre></div>
<p><strong>Implementation</strong> (fireRIRrules function):</p>
<div class="sourceCode" id="cb221"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb221-1"><a aria-hidden="true" href="#cb221-1" tabindex="-1"></a><span class="co">/*</span></span>
<span id="cb221-2"><a aria-hidden="true" href="#cb221-2" tabindex="-1"></a><span class="co"> * fireRIRrules -</span></span>
<span id="cb221-3"><a aria-hidden="true" href="#cb221-3" tabindex="-1"></a><span class="co"> *    Apply all Retrieve-Instead-Retrieve rules to the given querytree.</span></span>
<span id="cb221-4"><a aria-hidden="true" href="#cb221-4" tabindex="-1"></a><span class="co"> *</span></span>
<span id="cb221-5"><a aria-hidden="true" href="#cb221-5" tabindex="-1"></a><span class="co"> * This handles view expansion, including security barrier views.</span></span>
<span id="cb221-6"><a aria-hidden="true" href="#cb221-6" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb221-7"><a aria-hidden="true" href="#cb221-7" tabindex="-1"></a><span class="dt">static</span> Query <span class="op">*</span></span>
<span id="cb221-8"><a aria-hidden="true" href="#cb221-8" tabindex="-1"></a>fireRIRrules<span class="op">(</span>Query <span class="op">*</span>parsetree<span class="op">,</span> List <span class="op">*</span>activeRIRs<span class="op">)</span></span>
<span id="cb221-9"><a aria-hidden="true" href="#cb221-9" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb221-10"><a aria-hidden="true" href="#cb221-10" tabindex="-1"></a>    <span class="dt">int</span>         origResultRelation <span class="op">=</span> parsetree<span class="op">-&gt;</span>resultRelation<span class="op">;</span></span>
<span id="cb221-11"><a aria-hidden="true" href="#cb221-11" tabindex="-1"></a>    <span class="dt">int</span>         rt_index<span class="op">;</span></span>
<span id="cb221-12"><a aria-hidden="true" href="#cb221-12" tabindex="-1"></a>    ListCell   <span class="op">*</span>lc<span class="op">;</span></span>
<span id="cb221-13"><a aria-hidden="true" href="#cb221-13" tabindex="-1"></a></span>
<span id="cb221-14"><a aria-hidden="true" href="#cb221-14" tabindex="-1"></a>    <span class="co">/*</span></span>
<span id="cb221-15"><a aria-hidden="true" href="#cb221-15" tabindex="-1"></a><span class="co">     * Process each RTE (Range Table Entry) in the query.</span></span>
<span id="cb221-16"><a aria-hidden="true" href="#cb221-16" tabindex="-1"></a><span class="co">     * For each RTE that references a relation, check if there's an</span></span>
<span id="cb221-17"><a aria-hidden="true" href="#cb221-17" tabindex="-1"></a><span class="co">     * ON SELECT rule that needs to be applied.</span></span>
<span id="cb221-18"><a aria-hidden="true" href="#cb221-18" tabindex="-1"></a><span class="co">     */</span></span>
<span id="cb221-19"><a aria-hidden="true" href="#cb221-19" tabindex="-1"></a>    rt_index <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb221-20"><a aria-hidden="true" href="#cb221-20" tabindex="-1"></a>    foreach<span class="op">(</span>lc<span class="op">,</span> parsetree<span class="op">-&gt;</span>rtable<span class="op">)</span></span>
<span id="cb221-21"><a aria-hidden="true" href="#cb221-21" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb221-22"><a aria-hidden="true" href="#cb221-22" tabindex="-1"></a>        RangeTblEntry <span class="op">*</span>rte <span class="op">=</span> <span class="op">(</span>RangeTblEntry <span class="op">*)</span> lfirst<span class="op">(</span>lc<span class="op">);</span></span>
<span id="cb221-23"><a aria-hidden="true" href="#cb221-23" tabindex="-1"></a>        Relation    rel<span class="op">;</span></span>
<span id="cb221-24"><a aria-hidden="true" href="#cb221-24" tabindex="-1"></a>        List       <span class="op">*</span>locks<span class="op">;</span></span>
<span id="cb221-25"><a aria-hidden="true" href="#cb221-25" tabindex="-1"></a>        RuleLock   <span class="op">*</span>rules<span class="op">;</span></span>
<span id="cb221-26"><a aria-hidden="true" href="#cb221-26" tabindex="-1"></a>        RewriteRule <span class="op">*</span>rule<span class="op">;</span></span>
<span id="cb221-27"><a aria-hidden="true" href="#cb221-27" tabindex="-1"></a>        <span class="dt">int</span>         i<span class="op">;</span></span>
<span id="cb221-28"><a aria-hidden="true" href="#cb221-28" tabindex="-1"></a></span>
<span id="cb221-29"><a aria-hidden="true" href="#cb221-29" tabindex="-1"></a>        <span class="op">++</span>rt_index<span class="op">;</span></span>
<span id="cb221-30"><a aria-hidden="true" href="#cb221-30" tabindex="-1"></a></span>
<span id="cb221-31"><a aria-hidden="true" href="#cb221-31" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>rte<span class="op">-&gt;</span>rtekind <span class="op">!=</span> RTE_RELATION<span class="op">)</span></span>
<span id="cb221-32"><a aria-hidden="true" href="#cb221-32" tabindex="-1"></a>            <span class="cf">continue</span><span class="op">;</span></span>
<span id="cb221-33"><a aria-hidden="true" href="#cb221-33" tabindex="-1"></a></span>
<span id="cb221-34"><a aria-hidden="true" href="#cb221-34" tabindex="-1"></a>        <span class="co">/* Get the relation and its rules */</span></span>
<span id="cb221-35"><a aria-hidden="true" href="#cb221-35" tabindex="-1"></a>        rel <span class="op">=</span> table_open<span class="op">(</span>rte<span class="op">-&gt;</span>relid<span class="op">,</span> NoLock<span class="op">);</span></span>
<span id="cb221-36"><a aria-hidden="true" href="#cb221-36" tabindex="-1"></a>        rules <span class="op">=</span> rel<span class="op">-&gt;</span>rd_rules<span class="op">;</span></span>
<span id="cb221-37"><a aria-hidden="true" href="#cb221-37" tabindex="-1"></a></span>
<span id="cb221-38"><a aria-hidden="true" href="#cb221-38" tabindex="-1"></a>        <span class="co">/* ... apply ON SELECT rules ... */</span></span>
<span id="cb221-39"><a aria-hidden="true" href="#cb221-39" tabindex="-1"></a></span>
<span id="cb221-40"><a aria-hidden="true" href="#cb221-40" tabindex="-1"></a>        table_close<span class="op">(</span>rel<span class="op">,</span> NoLock<span class="op">);</span></span>
<span id="cb221-41"><a aria-hidden="true" href="#cb221-41" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb221-42"><a aria-hidden="true" href="#cb221-42" tabindex="-1"></a></span>
<span id="cb221-43"><a aria-hidden="true" href="#cb221-43" tabindex="-1"></a>    <span class="cf">return</span> parsetree<span class="op">;</span></span>
<span id="cb221-44"><a aria-hidden="true" href="#cb221-44" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 data-number="4.4.4" id="row-level-security-rls"><span class="header-section-number">4.4.4</span> 3.4 Row-Level Security
(RLS)</h3>
<p><strong>Location</strong>:
<code>/home/user/postgres/src/backend/rewrite/rowsecurity.c</code></p>
<p>RLS adds additional WHERE clauses to enforce security policies:</p>
<div class="sourceCode" id="cb222"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb222-1"><a aria-hidden="true" href="#cb222-1" tabindex="-1"></a><span class="co">/*</span></span>
<span id="cb222-2"><a aria-hidden="true" href="#cb222-2" tabindex="-1"></a><span class="co"> * prepend_row_security_policies -</span></span>
<span id="cb222-3"><a aria-hidden="true" href="#cb222-3" tabindex="-1"></a><span class="co"> *    For a given query, add the row-level security quals</span></span>
<span id="cb222-4"><a aria-hidden="true" href="#cb222-4" tabindex="-1"></a><span class="co"> *</span></span>
<span id="cb222-5"><a aria-hidden="true" href="#cb222-5" tabindex="-1"></a><span class="co"> * New security barrier quals are added to the start of the relation's</span></span>
<span id="cb222-6"><a aria-hidden="true" href="#cb222-6" tabindex="-1"></a><span class="co"> * baserestrictinfo list. We want them to be evaluated first, before any</span></span>
<span id="cb222-7"><a aria-hidden="true" href="#cb222-7" tabindex="-1"></a><span class="co"> * user-supplied quals.</span></span>
<span id="cb222-8"><a aria-hidden="true" href="#cb222-8" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb222-9"><a aria-hidden="true" href="#cb222-9" tabindex="-1"></a><span class="dt">void</span></span>
<span id="cb222-10"><a aria-hidden="true" href="#cb222-10" tabindex="-1"></a>prepend_row_security_policies<span class="op">(</span>Query <span class="op">*</span>root<span class="op">,</span> RangeTblEntry <span class="op">*</span>rte<span class="op">,</span></span>
<span id="cb222-11"><a aria-hidden="true" href="#cb222-11" tabindex="-1"></a>                              <span class="dt">int</span> rt_index<span class="op">)</span></span>
<span id="cb222-12"><a aria-hidden="true" href="#cb222-12" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb222-13"><a aria-hidden="true" href="#cb222-13" tabindex="-1"></a>    Relation    rel<span class="op">;</span></span>
<span id="cb222-14"><a aria-hidden="true" href="#cb222-14" tabindex="-1"></a>    List       <span class="op">*</span>rowsec_policies<span class="op">;</span></span>
<span id="cb222-15"><a aria-hidden="true" href="#cb222-15" tabindex="-1"></a>    List       <span class="op">*</span>rowsec_exprs<span class="op">;</span></span>
<span id="cb222-16"><a aria-hidden="true" href="#cb222-16" tabindex="-1"></a>    ListCell   <span class="op">*</span>lc<span class="op">;</span></span>
<span id="cb222-17"><a aria-hidden="true" href="#cb222-17" tabindex="-1"></a></span>
<span id="cb222-18"><a aria-hidden="true" href="#cb222-18" tabindex="-1"></a>    <span class="co">/* ... RLS policy application ... */</span></span>
<span id="cb222-19"><a aria-hidden="true" href="#cb222-19" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>Example</strong>:</p>
<div class="sourceCode" id="cb223"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb223-1"><a aria-hidden="true" href="#cb223-1" tabindex="-1"></a><span class="co">-- Policy definition</span></span>
<span id="cb223-2"><a aria-hidden="true" href="#cb223-2" tabindex="-1"></a><span class="kw">CREATE</span> POLICY employee_policy <span class="kw">ON</span> employees</span>
<span id="cb223-3"><a aria-hidden="true" href="#cb223-3" tabindex="-1"></a>    <span class="kw">USING</span> (dept_id <span class="op">=</span> current_user_dept_id());</span>
<span id="cb223-4"><a aria-hidden="true" href="#cb223-4" tabindex="-1"></a></span>
<span id="cb223-5"><a aria-hidden="true" href="#cb223-5" tabindex="-1"></a><span class="co">-- User query</span></span>
<span id="cb223-6"><a aria-hidden="true" href="#cb223-6" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> employees;</span>
<span id="cb223-7"><a aria-hidden="true" href="#cb223-7" tabindex="-1"></a></span>
<span id="cb223-8"><a aria-hidden="true" href="#cb223-8" tabindex="-1"></a><span class="co">-- After RLS rewriting</span></span>
<span id="cb223-9"><a aria-hidden="true" href="#cb223-9" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> employees</span>
<span id="cb223-10"><a aria-hidden="true" href="#cb223-10" tabindex="-1"></a><span class="kw">WHERE</span> dept_id <span class="op">=</span> current_user_dept_id();</span></code></pre></div>
<h3 data-number="4.4.5" id="updatable-views"><span class="header-section-number">4.4.5</span> 3.5 Updatable Views</h3>
<p>The rewriter can transform INSERT/UPDATE/DELETE operations on views
into operations on base tables:</p>
<div class="sourceCode" id="cb224"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb224-1"><a aria-hidden="true" href="#cb224-1" tabindex="-1"></a><span class="co">/*</span></span>
<span id="cb224-2"><a aria-hidden="true" href="#cb224-2" tabindex="-1"></a><span class="co"> * rewriteTargetListIU -</span></span>
<span id="cb224-3"><a aria-hidden="true" href="#cb224-3" tabindex="-1"></a><span class="co"> *    Rewrite the target list for INSERT and UPDATE queries</span></span>
<span id="cb224-4"><a aria-hidden="true" href="#cb224-4" tabindex="-1"></a><span class="co"> *</span></span>
<span id="cb224-5"><a aria-hidden="true" href="#cb224-5" tabindex="-1"></a><span class="co"> * This handles the translation from the view's columns to the</span></span>
<span id="cb224-6"><a aria-hidden="true" href="#cb224-6" tabindex="-1"></a><span class="co"> * underlying table's columns.</span></span>
<span id="cb224-7"><a aria-hidden="true" href="#cb224-7" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb224-8"><a aria-hidden="true" href="#cb224-8" tabindex="-1"></a><span class="dt">static</span> List <span class="op">*</span></span>
<span id="cb224-9"><a aria-hidden="true" href="#cb224-9" tabindex="-1"></a>rewriteTargetListIU<span class="op">(</span>List <span class="op">*</span>targetList<span class="op">,</span></span>
<span id="cb224-10"><a aria-hidden="true" href="#cb224-10" tabindex="-1"></a>                   CmdType commandType<span class="op">,</span></span>
<span id="cb224-11"><a aria-hidden="true" href="#cb224-11" tabindex="-1"></a>                   OverridingKind override<span class="op">,</span></span>
<span id="cb224-12"><a aria-hidden="true" href="#cb224-12" tabindex="-1"></a>                   Relation target_relation<span class="op">,</span></span>
<span id="cb224-13"><a aria-hidden="true" href="#cb224-13" tabindex="-1"></a>                   RangeTblEntry <span class="op">*</span>values_rte<span class="op">,</span></span>
<span id="cb224-14"><a aria-hidden="true" href="#cb224-14" tabindex="-1"></a>                   <span class="dt">int</span> values_rte_index<span class="op">,</span></span>
<span id="cb224-15"><a aria-hidden="true" href="#cb224-15" tabindex="-1"></a>                   Bitmapset <span class="op">**</span>unused_values_attrnos<span class="op">)</span></span>
<span id="cb224-16"><a aria-hidden="true" href="#cb224-16" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb224-17"><a aria-hidden="true" href="#cb224-17" tabindex="-1"></a>    <span class="co">/* Transform view column references to base table references */</span></span>
<span id="cb224-18"><a aria-hidden="true" href="#cb224-18" tabindex="-1"></a>    <span class="co">/* Handle DEFAULT values, column ordering, etc. */</span></span>
<span id="cb224-19"><a aria-hidden="true" href="#cb224-19" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<hr/>
<h2 data-number="4.5" id="the-planneroptimizer"><span class="header-section-number">4.5</span> 4. The Planner/Optimizer</h2>
<p>The planner takes a Query tree and produces an optimal execution plan
(PlannedStmt). This is the most complex component of the query
processing pipeline.</p>
<h3 data-number="4.5.1" id="planner-architecture"><span class="header-section-number">4.5.1</span> 4.1 Planner Architecture</h3>
<p><strong>Location</strong>:
<code>/home/user/postgres/src/backend/optimizer/plan/planner.c</code>
(7,341 lines)</p>
<p>The planner operates in several phases:</p>
<pre><code>Query Tree
    ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Preprocessing           ‚îÇ  ‚Ä¢ Simplify expressions
‚îÇ                          ‚îÇ  ‚Ä¢ Pull up subqueries
‚îÇ                          ‚îÇ  ‚Ä¢ Flatten JOIN trees
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚Ä¢ Detect equivalence classes
    ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Path Generation         ‚îÇ  ‚Ä¢ Sequential scans
‚îÇ                          ‚îÇ  ‚Ä¢ Index scans
‚îÇ                          ‚îÇ  ‚Ä¢ Join methods
‚îÇ                          ‚îÇ  ‚Ä¢ Parallel plans
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
    ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Cost Estimation         ‚îÇ  ‚Ä¢ I/O costs
‚îÇ                          ‚îÇ  ‚Ä¢ CPU costs
‚îÇ                          ‚îÇ  ‚Ä¢ Selectivity estimation
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
    ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Plan Selection          ‚îÇ  ‚Ä¢ Choose cheapest path
‚îÇ                          ‚îÇ  ‚Ä¢ Create Plan nodes
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
    ‚Üì
PlannedStmt</code></pre>
<h3 data-number="4.5.2" id="main-planner-entry-point"><span class="header-section-number">4.5.2</span> 4.2 Main Planner Entry
Point</h3>
<div class="sourceCode" id="cb226"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb226-1"><a aria-hidden="true" href="#cb226-1" tabindex="-1"></a><span class="co">/*</span></span>
<span id="cb226-2"><a aria-hidden="true" href="#cb226-2" tabindex="-1"></a><span class="co"> * planner</span></span>
<span id="cb226-3"><a aria-hidden="true" href="#cb226-3" tabindex="-1"></a><span class="co"> *   Main entry point for query optimizer.</span></span>
<span id="cb226-4"><a aria-hidden="true" href="#cb226-4" tabindex="-1"></a><span class="co"> *</span></span>
<span id="cb226-5"><a aria-hidden="true" href="#cb226-5" tabindex="-1"></a><span class="co"> * This function generates an execution plan for a Query.</span></span>
<span id="cb226-6"><a aria-hidden="true" href="#cb226-6" tabindex="-1"></a><span class="co"> * The actual work is handed off to subquery_planner, which may recurse</span></span>
<span id="cb226-7"><a aria-hidden="true" href="#cb226-7" tabindex="-1"></a><span class="co"> * for subqueries.</span></span>
<span id="cb226-8"><a aria-hidden="true" href="#cb226-8" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb226-9"><a aria-hidden="true" href="#cb226-9" tabindex="-1"></a>PlannedStmt <span class="op">*</span></span>
<span id="cb226-10"><a aria-hidden="true" href="#cb226-10" tabindex="-1"></a>planner<span class="op">(</span>Query <span class="op">*</span>parse<span class="op">,</span> <span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>query_string<span class="op">,</span> <span class="dt">int</span> cursorOptions<span class="op">,</span></span>
<span id="cb226-11"><a aria-hidden="true" href="#cb226-11" tabindex="-1"></a>        ParamListInfo boundParams<span class="op">)</span></span>
<span id="cb226-12"><a aria-hidden="true" href="#cb226-12" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb226-13"><a aria-hidden="true" href="#cb226-13" tabindex="-1"></a>    PlannedStmt <span class="op">*</span>result<span class="op">;</span></span>
<span id="cb226-14"><a aria-hidden="true" href="#cb226-14" tabindex="-1"></a>    PlannerGlobal <span class="op">*</span>glob<span class="op">;</span></span>
<span id="cb226-15"><a aria-hidden="true" href="#cb226-15" tabindex="-1"></a>    <span class="dt">double</span>      tuple_fraction<span class="op">;</span></span>
<span id="cb226-16"><a aria-hidden="true" href="#cb226-16" tabindex="-1"></a>    PlannerInfo <span class="op">*</span>root<span class="op">;</span></span>
<span id="cb226-17"><a aria-hidden="true" href="#cb226-17" tabindex="-1"></a>    RelOptInfo <span class="op">*</span>final_rel<span class="op">;</span></span>
<span id="cb226-18"><a aria-hidden="true" href="#cb226-18" tabindex="-1"></a>    Path       <span class="op">*</span>best_path<span class="op">;</span></span>
<span id="cb226-19"><a aria-hidden="true" href="#cb226-19" tabindex="-1"></a>    Plan       <span class="op">*</span>top_plan<span class="op">;</span></span>
<span id="cb226-20"><a aria-hidden="true" href="#cb226-20" tabindex="-1"></a>    ListCell   <span class="op">*</span>lp<span class="op">,</span></span>
<span id="cb226-21"><a aria-hidden="true" href="#cb226-21" tabindex="-1"></a>               <span class="op">*</span>lr<span class="op">;</span></span>
<span id="cb226-22"><a aria-hidden="true" href="#cb226-22" tabindex="-1"></a></span>
<span id="cb226-23"><a aria-hidden="true" href="#cb226-23" tabindex="-1"></a>    <span class="co">/*</span></span>
<span id="cb226-24"><a aria-hidden="true" href="#cb226-24" tabindex="-1"></a><span class="co">     * Set up global state for this planner invocation.  This includes</span></span>
<span id="cb226-25"><a aria-hidden="true" href="#cb226-25" tabindex="-1"></a><span class="co">     * information about available parameter values and the global</span></span>
<span id="cb226-26"><a aria-hidden="true" href="#cb226-26" tabindex="-1"></a><span class="co">     * list of subqueries.</span></span>
<span id="cb226-27"><a aria-hidden="true" href="#cb226-27" tabindex="-1"></a><span class="co">     */</span></span>
<span id="cb226-28"><a aria-hidden="true" href="#cb226-28" tabindex="-1"></a>    glob <span class="op">=</span> makeNode<span class="op">(</span>PlannerGlobal<span class="op">);</span></span>
<span id="cb226-29"><a aria-hidden="true" href="#cb226-29" tabindex="-1"></a>    glob<span class="op">-&gt;</span>boundParams <span class="op">=</span> boundParams<span class="op">;</span></span>
<span id="cb226-30"><a aria-hidden="true" href="#cb226-30" tabindex="-1"></a>    glob<span class="op">-&gt;</span>subplans <span class="op">=</span> NIL<span class="op">;</span></span>
<span id="cb226-31"><a aria-hidden="true" href="#cb226-31" tabindex="-1"></a>    glob<span class="op">-&gt;</span>subroots <span class="op">=</span> NIL<span class="op">;</span></span>
<span id="cb226-32"><a aria-hidden="true" href="#cb226-32" tabindex="-1"></a>    glob<span class="op">-&gt;</span>rewindPlanIDs <span class="op">=</span> NULL<span class="op">;</span></span>
<span id="cb226-33"><a aria-hidden="true" href="#cb226-33" tabindex="-1"></a>    glob<span class="op">-&gt;</span>finalrtable <span class="op">=</span> NIL<span class="op">;</span></span>
<span id="cb226-34"><a aria-hidden="true" href="#cb226-34" tabindex="-1"></a>    glob<span class="op">-&gt;</span>finalrteperminfos <span class="op">=</span> NIL<span class="op">;</span></span>
<span id="cb226-35"><a aria-hidden="true" href="#cb226-35" tabindex="-1"></a>    glob<span class="op">-&gt;</span>finalrowmarks <span class="op">=</span> NIL<span class="op">;</span></span>
<span id="cb226-36"><a aria-hidden="true" href="#cb226-36" tabindex="-1"></a>    glob<span class="op">-&gt;</span>resultRelations <span class="op">=</span> NIL<span class="op">;</span></span>
<span id="cb226-37"><a aria-hidden="true" href="#cb226-37" tabindex="-1"></a>    glob<span class="op">-&gt;</span>appendRelations <span class="op">=</span> NIL<span class="op">;</span></span>
<span id="cb226-38"><a aria-hidden="true" href="#cb226-38" tabindex="-1"></a>    glob<span class="op">-&gt;</span>relationOids <span class="op">=</span> NIL<span class="op">;</span></span>
<span id="cb226-39"><a aria-hidden="true" href="#cb226-39" tabindex="-1"></a>    glob<span class="op">-&gt;</span>invalItems <span class="op">=</span> NIL<span class="op">;</span></span>
<span id="cb226-40"><a aria-hidden="true" href="#cb226-40" tabindex="-1"></a>    glob<span class="op">-&gt;</span>paramExecTypes <span class="op">=</span> NIL<span class="op">;</span></span>
<span id="cb226-41"><a aria-hidden="true" href="#cb226-41" tabindex="-1"></a>    glob<span class="op">-&gt;</span>lastPHId <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb226-42"><a aria-hidden="true" href="#cb226-42" tabindex="-1"></a>    glob<span class="op">-&gt;</span>lastRowMarkId <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb226-43"><a aria-hidden="true" href="#cb226-43" tabindex="-1"></a>    glob<span class="op">-&gt;</span>lastPlanNodeId <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb226-44"><a aria-hidden="true" href="#cb226-44" tabindex="-1"></a>    glob<span class="op">-&gt;</span>transientPlan <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb226-45"><a aria-hidden="true" href="#cb226-45" tabindex="-1"></a>    glob<span class="op">-&gt;</span>dependsOnRole <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb226-46"><a aria-hidden="true" href="#cb226-46" tabindex="-1"></a></span>
<span id="cb226-47"><a aria-hidden="true" href="#cb226-47" tabindex="-1"></a>    <span class="co">/* Determine fraction of plan expected to be retrieved */</span></span>
<span id="cb226-48"><a aria-hidden="true" href="#cb226-48" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>cursorOptions <span class="op">&amp;</span> CURSOR_OPT_FAST_PLAN<span class="op">)</span></span>
<span id="cb226-49"><a aria-hidden="true" href="#cb226-49" tabindex="-1"></a>        tuple_fraction <span class="op">=</span> cursor_tuple_fraction<span class="op">;</span></span>
<span id="cb226-50"><a aria-hidden="true" href="#cb226-50" tabindex="-1"></a>    <span class="cf">else</span></span>
<span id="cb226-51"><a aria-hidden="true" href="#cb226-51" tabindex="-1"></a>        tuple_fraction <span class="op">=</span> <span class="fl">0.0</span><span class="op">;</span>    <span class="co">/* fetch all tuples */</span></span>
<span id="cb226-52"><a aria-hidden="true" href="#cb226-52" tabindex="-1"></a></span>
<span id="cb226-53"><a aria-hidden="true" href="#cb226-53" tabindex="-1"></a>    <span class="co">/* Set up PlannerInfo data structure for this Query */</span></span>
<span id="cb226-54"><a aria-hidden="true" href="#cb226-54" tabindex="-1"></a>    root <span class="op">=</span> subquery_planner<span class="op">(</span>glob<span class="op">,</span> parse<span class="op">,</span></span>
<span id="cb226-55"><a aria-hidden="true" href="#cb226-55" tabindex="-1"></a>                           NULL<span class="op">,</span></span>
<span id="cb226-56"><a aria-hidden="true" href="#cb226-56" tabindex="-1"></a>                           <span class="kw">false</span><span class="op">,</span> tuple_fraction<span class="op">);</span></span>
<span id="cb226-57"><a aria-hidden="true" href="#cb226-57" tabindex="-1"></a></span>
<span id="cb226-58"><a aria-hidden="true" href="#cb226-58" tabindex="-1"></a>    <span class="co">/* Select best Path and turn it into a Plan */</span></span>
<span id="cb226-59"><a aria-hidden="true" href="#cb226-59" tabindex="-1"></a>    final_rel <span class="op">=</span> fetch_upper_rel<span class="op">(</span>root<span class="op">,</span> UPPERREL_FINAL<span class="op">,</span> NULL<span class="op">);</span></span>
<span id="cb226-60"><a aria-hidden="true" href="#cb226-60" tabindex="-1"></a>    best_path <span class="op">=</span> get_cheapest_fractional_path<span class="op">(</span>final_rel<span class="op">,</span> tuple_fraction<span class="op">);</span></span>
<span id="cb226-61"><a aria-hidden="true" href="#cb226-61" tabindex="-1"></a></span>
<span id="cb226-62"><a aria-hidden="true" href="#cb226-62" tabindex="-1"></a>    top_plan <span class="op">=</span> create_plan<span class="op">(</span>root<span class="op">,</span> best_path<span class="op">);</span></span>
<span id="cb226-63"><a aria-hidden="true" href="#cb226-63" tabindex="-1"></a></span>
<span id="cb226-64"><a aria-hidden="true" href="#cb226-64" tabindex="-1"></a>    <span class="co">/* ... finalize PlannedStmt ... */</span></span>
<span id="cb226-65"><a aria-hidden="true" href="#cb226-65" tabindex="-1"></a></span>
<span id="cb226-66"><a aria-hidden="true" href="#cb226-66" tabindex="-1"></a>    <span class="cf">return</span> result<span class="op">;</span></span>
<span id="cb226-67"><a aria-hidden="true" href="#cb226-67" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 data-number="4.5.3" id="path-generation"><span class="header-section-number">4.5.3</span> 4.3 Path Generation</h3>
<p>The planner generates multiple alternative ‚Äúpaths‚Äù (execution
strategies) for each relation and join:</p>
<h4 data-number="4.5.3.1" id="sequential-scan-path"><span class="header-section-number">4.5.3.1</span> Sequential Scan Path</h4>
<div class="sourceCode" id="cb227"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb227-1"><a aria-hidden="true" href="#cb227-1" tabindex="-1"></a><span class="co">/*</span></span>
<span id="cb227-2"><a aria-hidden="true" href="#cb227-2" tabindex="-1"></a><span class="co"> * create_seqscan_path</span></span>
<span id="cb227-3"><a aria-hidden="true" href="#cb227-3" tabindex="-1"></a><span class="co"> *    Creates a path corresponding to a sequential scan</span></span>
<span id="cb227-4"><a aria-hidden="true" href="#cb227-4" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb227-5"><a aria-hidden="true" href="#cb227-5" tabindex="-1"></a>Path <span class="op">*</span></span>
<span id="cb227-6"><a aria-hidden="true" href="#cb227-6" tabindex="-1"></a>create_seqscan_path<span class="op">(</span>PlannerInfo <span class="op">*</span>root<span class="op">,</span> RelOptInfo <span class="op">*</span>rel<span class="op">,</span></span>
<span id="cb227-7"><a aria-hidden="true" href="#cb227-7" tabindex="-1"></a>                   Relids required_outer<span class="op">,</span> <span class="dt">int</span> parallel_workers<span class="op">)</span></span>
<span id="cb227-8"><a aria-hidden="true" href="#cb227-8" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb227-9"><a aria-hidden="true" href="#cb227-9" tabindex="-1"></a>    Path       <span class="op">*</span>pathnode <span class="op">=</span> makeNode<span class="op">(</span>Path<span class="op">);</span></span>
<span id="cb227-10"><a aria-hidden="true" href="#cb227-10" tabindex="-1"></a></span>
<span id="cb227-11"><a aria-hidden="true" href="#cb227-11" tabindex="-1"></a>    pathnode<span class="op">-&gt;</span>pathtype <span class="op">=</span> T_SeqScan<span class="op">;</span></span>
<span id="cb227-12"><a aria-hidden="true" href="#cb227-12" tabindex="-1"></a>    pathnode<span class="op">-&gt;</span>parent <span class="op">=</span> rel<span class="op">;</span></span>
<span id="cb227-13"><a aria-hidden="true" href="#cb227-13" tabindex="-1"></a>    pathnode<span class="op">-&gt;</span>pathtarget <span class="op">=</span> rel<span class="op">-&gt;</span>reltarget<span class="op">;</span></span>
<span id="cb227-14"><a aria-hidden="true" href="#cb227-14" tabindex="-1"></a>    pathnode<span class="op">-&gt;</span>param_info <span class="op">=</span> get_baserel_parampathinfo<span class="op">(</span>root<span class="op">,</span> rel<span class="op">,</span></span>
<span id="cb227-15"><a aria-hidden="true" href="#cb227-15" tabindex="-1"></a>                                                     required_outer<span class="op">);</span></span>
<span id="cb227-16"><a aria-hidden="true" href="#cb227-16" tabindex="-1"></a>    pathnode<span class="op">-&gt;</span>parallel_aware <span class="op">=</span> <span class="op">(</span>parallel_workers <span class="op">&gt;</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb227-17"><a aria-hidden="true" href="#cb227-17" tabindex="-1"></a>    pathnode<span class="op">-&gt;</span>parallel_safe <span class="op">=</span> rel<span class="op">-&gt;</span>consider_parallel<span class="op">;</span></span>
<span id="cb227-18"><a aria-hidden="true" href="#cb227-18" tabindex="-1"></a>    pathnode<span class="op">-&gt;</span>parallel_workers <span class="op">=</span> parallel_workers<span class="op">;</span></span>
<span id="cb227-19"><a aria-hidden="true" href="#cb227-19" tabindex="-1"></a>    pathnode<span class="op">-&gt;</span>pathkeys <span class="op">=</span> NIL<span class="op">;</span>   <span class="co">/* seqscan has unordered result */</span></span>
<span id="cb227-20"><a aria-hidden="true" href="#cb227-20" tabindex="-1"></a></span>
<span id="cb227-21"><a aria-hidden="true" href="#cb227-21" tabindex="-1"></a>    cost_seqscan<span class="op">(</span>pathnode<span class="op">,</span> root<span class="op">,</span> rel<span class="op">,</span> pathnode<span class="op">-&gt;</span>param_info<span class="op">);</span></span>
<span id="cb227-22"><a aria-hidden="true" href="#cb227-22" tabindex="-1"></a></span>
<span id="cb227-23"><a aria-hidden="true" href="#cb227-23" tabindex="-1"></a>    <span class="cf">return</span> pathnode<span class="op">;</span></span>
<span id="cb227-24"><a aria-hidden="true" href="#cb227-24" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h4 data-number="4.5.3.2" id="index-scan-path"><span class="header-section-number">4.5.3.2</span> Index Scan Path</h4>
<div class="sourceCode" id="cb228"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb228-1"><a aria-hidden="true" href="#cb228-1" tabindex="-1"></a><span class="co">/*</span></span>
<span id="cb228-2"><a aria-hidden="true" href="#cb228-2" tabindex="-1"></a><span class="co"> * create_index_path</span></span>
<span id="cb228-3"><a aria-hidden="true" href="#cb228-3" tabindex="-1"></a><span class="co"> *    Creates a path node for an index scan.</span></span>
<span id="cb228-4"><a aria-hidden="true" href="#cb228-4" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb228-5"><a aria-hidden="true" href="#cb228-5" tabindex="-1"></a>IndexPath <span class="op">*</span></span>
<span id="cb228-6"><a aria-hidden="true" href="#cb228-6" tabindex="-1"></a>create_index_path<span class="op">(</span>PlannerInfo <span class="op">*</span>root<span class="op">,</span></span>
<span id="cb228-7"><a aria-hidden="true" href="#cb228-7" tabindex="-1"></a>                 IndexOptInfo <span class="op">*</span>index<span class="op">,</span></span>
<span id="cb228-8"><a aria-hidden="true" href="#cb228-8" tabindex="-1"></a>                 List <span class="op">*</span>indexclauses<span class="op">,</span></span>
<span id="cb228-9"><a aria-hidden="true" href="#cb228-9" tabindex="-1"></a>                 List <span class="op">*</span>indexorderbys<span class="op">,</span></span>
<span id="cb228-10"><a aria-hidden="true" href="#cb228-10" tabindex="-1"></a>                 List <span class="op">*</span>indexorderbycols<span class="op">,</span></span>
<span id="cb228-11"><a aria-hidden="true" href="#cb228-11" tabindex="-1"></a>                 List <span class="op">*</span>pathkeys<span class="op">,</span></span>
<span id="cb228-12"><a aria-hidden="true" href="#cb228-12" tabindex="-1"></a>                 ScanDirection indexscandir<span class="op">,</span></span>
<span id="cb228-13"><a aria-hidden="true" href="#cb228-13" tabindex="-1"></a>                 <span class="dt">bool</span> indexonly<span class="op">,</span></span>
<span id="cb228-14"><a aria-hidden="true" href="#cb228-14" tabindex="-1"></a>                 Relids required_outer<span class="op">,</span></span>
<span id="cb228-15"><a aria-hidden="true" href="#cb228-15" tabindex="-1"></a>                 <span class="dt">double</span> loop_count<span class="op">,</span></span>
<span id="cb228-16"><a aria-hidden="true" href="#cb228-16" tabindex="-1"></a>                 <span class="dt">bool</span> partial_path<span class="op">)</span></span>
<span id="cb228-17"><a aria-hidden="true" href="#cb228-17" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb228-18"><a aria-hidden="true" href="#cb228-18" tabindex="-1"></a>    IndexPath  <span class="op">*</span>pathnode <span class="op">=</span> makeNode<span class="op">(</span>IndexPath<span class="op">);</span></span>
<span id="cb228-19"><a aria-hidden="true" href="#cb228-19" tabindex="-1"></a>    RelOptInfo <span class="op">*</span>rel <span class="op">=</span> index<span class="op">-&gt;</span>rel<span class="op">;</span></span>
<span id="cb228-20"><a aria-hidden="true" href="#cb228-20" tabindex="-1"></a></span>
<span id="cb228-21"><a aria-hidden="true" href="#cb228-21" tabindex="-1"></a>    pathnode<span class="op">-&gt;</span>path<span class="op">.</span>pathtype <span class="op">=</span> indexonly <span class="op">?</span> T_IndexOnlyScan <span class="op">:</span> T_IndexScan<span class="op">;</span></span>
<span id="cb228-22"><a aria-hidden="true" href="#cb228-22" tabindex="-1"></a>    pathnode<span class="op">-&gt;</span>path<span class="op">.</span>parent <span class="op">=</span> rel<span class="op">;</span></span>
<span id="cb228-23"><a aria-hidden="true" href="#cb228-23" tabindex="-1"></a>    pathnode<span class="op">-&gt;</span>path<span class="op">.</span>pathtarget <span class="op">=</span> rel<span class="op">-&gt;</span>reltarget<span class="op">;</span></span>
<span id="cb228-24"><a aria-hidden="true" href="#cb228-24" tabindex="-1"></a>    pathnode<span class="op">-&gt;</span>path<span class="op">.</span>param_info <span class="op">=</span> get_baserel_parampathinfo<span class="op">(</span>root<span class="op">,</span> rel<span class="op">,</span></span>
<span id="cb228-25"><a aria-hidden="true" href="#cb228-25" tabindex="-1"></a>                                                          required_outer<span class="op">);</span></span>
<span id="cb228-26"><a aria-hidden="true" href="#cb228-26" tabindex="-1"></a>    pathnode<span class="op">-&gt;</span>path<span class="op">.</span>parallel_aware <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb228-27"><a aria-hidden="true" href="#cb228-27" tabindex="-1"></a>    pathnode<span class="op">-&gt;</span>path<span class="op">.</span>parallel_safe <span class="op">=</span> rel<span class="op">-&gt;</span>consider_parallel<span class="op">;</span></span>
<span id="cb228-28"><a aria-hidden="true" href="#cb228-28" tabindex="-1"></a>    pathnode<span class="op">-&gt;</span>path<span class="op">.</span>parallel_workers <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb228-29"><a aria-hidden="true" href="#cb228-29" tabindex="-1"></a>    pathnode<span class="op">-&gt;</span>path<span class="op">.</span>pathkeys <span class="op">=</span> pathkeys<span class="op">;</span></span>
<span id="cb228-30"><a aria-hidden="true" href="#cb228-30" tabindex="-1"></a></span>
<span id="cb228-31"><a aria-hidden="true" href="#cb228-31" tabindex="-1"></a>    pathnode<span class="op">-&gt;</span>indexinfo <span class="op">=</span> index<span class="op">;</span></span>
<span id="cb228-32"><a aria-hidden="true" href="#cb228-32" tabindex="-1"></a>    pathnode<span class="op">-&gt;</span>indexclauses <span class="op">=</span> indexclauses<span class="op">;</span></span>
<span id="cb228-33"><a aria-hidden="true" href="#cb228-33" tabindex="-1"></a>    pathnode<span class="op">-&gt;</span>indexorderbys <span class="op">=</span> indexorderbys<span class="op">;</span></span>
<span id="cb228-34"><a aria-hidden="true" href="#cb228-34" tabindex="-1"></a>    pathnode<span class="op">-&gt;</span>indexorderbycols <span class="op">=</span> indexorderbycols<span class="op">;</span></span>
<span id="cb228-35"><a aria-hidden="true" href="#cb228-35" tabindex="-1"></a>    pathnode<span class="op">-&gt;</span>indexscandir <span class="op">=</span> indexscandir<span class="op">;</span></span>
<span id="cb228-36"><a aria-hidden="true" href="#cb228-36" tabindex="-1"></a></span>
<span id="cb228-37"><a aria-hidden="true" href="#cb228-37" tabindex="-1"></a>    cost_index<span class="op">(</span>pathnode<span class="op">,</span> root<span class="op">,</span> loop_count<span class="op">,</span> partial_path<span class="op">);</span></span>
<span id="cb228-38"><a aria-hidden="true" href="#cb228-38" tabindex="-1"></a></span>
<span id="cb228-39"><a aria-hidden="true" href="#cb228-39" tabindex="-1"></a>    <span class="cf">return</span> pathnode<span class="op">;</span></span>
<span id="cb228-40"><a aria-hidden="true" href="#cb228-40" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 data-number="4.5.4" id="join-planning"><span class="header-section-number">4.5.4</span> 4.4 Join Planning</h3>
<p>The planner considers multiple join orders and methods:</p>
<p><strong>Dynamic Programming Approach</strong> (for small numbers of
relations):</p>
<div class="sourceCode" id="cb229"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb229-1"><a aria-hidden="true" href="#cb229-1" tabindex="-1"></a><span class="co">/*</span></span>
<span id="cb229-2"><a aria-hidden="true" href="#cb229-2" tabindex="-1"></a><span class="co"> * standard_join_search</span></span>
<span id="cb229-3"><a aria-hidden="true" href="#cb229-3" tabindex="-1"></a><span class="co"> *    Find possible joinpaths for a query by successively finding ways</span></span>
<span id="cb229-4"><a aria-hidden="true" href="#cb229-4" tabindex="-1"></a><span class="co"> *    to join component relations into join relations.</span></span>
<span id="cb229-5"><a aria-hidden="true" href="#cb229-5" tabindex="-1"></a><span class="co"> *</span></span>
<span id="cb229-6"><a aria-hidden="true" href="#cb229-6" tabindex="-1"></a><span class="co"> * We use a dynamic programming approach: for each subset of relations,</span></span>
<span id="cb229-7"><a aria-hidden="true" href="#cb229-7" tabindex="-1"></a><span class="co"> * we find the cheapest way to join them, building up from smaller to</span></span>
<span id="cb229-8"><a aria-hidden="true" href="#cb229-8" tabindex="-1"></a><span class="co"> * larger subsets.  At each level we consider all ways to split the</span></span>
<span id="cb229-9"><a aria-hidden="true" href="#cb229-9" tabindex="-1"></a><span class="co"> * subset into two parts and join them.</span></span>
<span id="cb229-10"><a aria-hidden="true" href="#cb229-10" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb229-11"><a aria-hidden="true" href="#cb229-11" tabindex="-1"></a>RelOptInfo <span class="op">*</span></span>
<span id="cb229-12"><a aria-hidden="true" href="#cb229-12" tabindex="-1"></a>standard_join_search<span class="op">(</span>PlannerInfo <span class="op">*</span>root<span class="op">,</span> <span class="dt">int</span> levels_needed<span class="op">,</span></span>
<span id="cb229-13"><a aria-hidden="true" href="#cb229-13" tabindex="-1"></a>                    List <span class="op">*</span>initial_rels<span class="op">)</span></span>
<span id="cb229-14"><a aria-hidden="true" href="#cb229-14" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb229-15"><a aria-hidden="true" href="#cb229-15" tabindex="-1"></a>    <span class="dt">int</span>         lev<span class="op">;</span></span>
<span id="cb229-16"><a aria-hidden="true" href="#cb229-16" tabindex="-1"></a>    RelOptInfo <span class="op">*</span>rel<span class="op">;</span></span>
<span id="cb229-17"><a aria-hidden="true" href="#cb229-17" tabindex="-1"></a></span>
<span id="cb229-18"><a aria-hidden="true" href="#cb229-18" tabindex="-1"></a>    <span class="co">/*</span></span>
<span id="cb229-19"><a aria-hidden="true" href="#cb229-19" tabindex="-1"></a><span class="co">     * This function would normally be called with levels_needed equal to</span></span>
<span id="cb229-20"><a aria-hidden="true" href="#cb229-20" tabindex="-1"></a><span class="co">     * the number of relations in the query.  The initial_rels list should</span></span>
<span id="cb229-21"><a aria-hidden="true" href="#cb229-21" tabindex="-1"></a><span class="co">     * contain a RelOptInfo for each individual relation in the query.</span></span>
<span id="cb229-22"><a aria-hidden="true" href="#cb229-22" tabindex="-1"></a><span class="co">     */</span></span>
<span id="cb229-23"><a aria-hidden="true" href="#cb229-23" tabindex="-1"></a></span>
<span id="cb229-24"><a aria-hidden="true" href="#cb229-24" tabindex="-1"></a>    <span class="co">/*</span></span>
<span id="cb229-25"><a aria-hidden="true" href="#cb229-25" tabindex="-1"></a><span class="co">     * For each level from 2 to levels_needed, build all possible</span></span>
<span id="cb229-26"><a aria-hidden="true" href="#cb229-26" tabindex="-1"></a><span class="co">     * join combinations.</span></span>
<span id="cb229-27"><a aria-hidden="true" href="#cb229-27" tabindex="-1"></a><span class="co">     */</span></span>
<span id="cb229-28"><a aria-hidden="true" href="#cb229-28" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span>lev <span class="op">=</span> <span class="dv">2</span><span class="op">;</span> lev <span class="op">&lt;=</span> levels_needed<span class="op">;</span> lev<span class="op">++)</span></span>
<span id="cb229-29"><a aria-hidden="true" href="#cb229-29" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb229-30"><a aria-hidden="true" href="#cb229-30" tabindex="-1"></a>        ListCell   <span class="op">*</span>lc<span class="op">;</span></span>
<span id="cb229-31"><a aria-hidden="true" href="#cb229-31" tabindex="-1"></a></span>
<span id="cb229-32"><a aria-hidden="true" href="#cb229-32" tabindex="-1"></a>        <span class="co">/*</span></span>
<span id="cb229-33"><a aria-hidden="true" href="#cb229-33" tabindex="-1"></a><span class="co">         * Consider all ways to partition each subset of size lev</span></span>
<span id="cb229-34"><a aria-hidden="true" href="#cb229-34" tabindex="-1"></a><span class="co">         * into two smaller subsets and join them.</span></span>
<span id="cb229-35"><a aria-hidden="true" href="#cb229-35" tabindex="-1"></a><span class="co">         */</span></span>
<span id="cb229-36"><a aria-hidden="true" href="#cb229-36" tabindex="-1"></a>        foreach<span class="op">(</span>lc<span class="op">,</span> root<span class="op">-&gt;</span>join_rel_level<span class="op">[</span>lev<span class="op">])</span></span>
<span id="cb229-37"><a aria-hidden="true" href="#cb229-37" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb229-38"><a aria-hidden="true" href="#cb229-38" tabindex="-1"></a>            rel <span class="op">=</span> <span class="op">(</span>RelOptInfo <span class="op">*)</span> lfirst<span class="op">(</span>lc<span class="op">);</span></span>
<span id="cb229-39"><a aria-hidden="true" href="#cb229-39" tabindex="-1"></a></span>
<span id="cb229-40"><a aria-hidden="true" href="#cb229-40" tabindex="-1"></a>            <span class="co">/* Try all possible join methods for this combination */</span></span>
<span id="cb229-41"><a aria-hidden="true" href="#cb229-41" tabindex="-1"></a>            <span class="co">/* ... */</span></span>
<span id="cb229-42"><a aria-hidden="true" href="#cb229-42" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb229-43"><a aria-hidden="true" href="#cb229-43" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb229-44"><a aria-hidden="true" href="#cb229-44" tabindex="-1"></a></span>
<span id="cb229-45"><a aria-hidden="true" href="#cb229-45" tabindex="-1"></a>    <span class="co">/* Return the final join relation representing all tables */</span></span>
<span id="cb229-46"><a aria-hidden="true" href="#cb229-46" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>levels_needed <span class="op">==</span> <span class="dv">1</span><span class="op">)</span></span>
<span id="cb229-47"><a aria-hidden="true" href="#cb229-47" tabindex="-1"></a>        <span class="cf">return</span> <span class="op">(</span>RelOptInfo <span class="op">*)</span> linitial<span class="op">(</span>initial_rels<span class="op">);</span></span>
<span id="cb229-48"><a aria-hidden="true" href="#cb229-48" tabindex="-1"></a>    <span class="cf">else</span></span>
<span id="cb229-49"><a aria-hidden="true" href="#cb229-49" tabindex="-1"></a>        <span class="cf">return</span> <span class="op">(</span>RelOptInfo <span class="op">*)</span> linitial<span class="op">(</span>root<span class="op">-&gt;</span>join_rel_level<span class="op">[</span>levels_needed<span class="op">]);</span></span>
<span id="cb229-50"><a aria-hidden="true" href="#cb229-50" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>Genetic Query Optimization</strong> (for large numbers of
relations):</p>
<p>When joining many tables (typically &gt; 12), the planner switches to
a genetic algorithm approach:</p>
<div class="sourceCode" id="cb230"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb230-1"><a aria-hidden="true" href="#cb230-1" tabindex="-1"></a><span class="co">/*</span></span>
<span id="cb230-2"><a aria-hidden="true" href="#cb230-2" tabindex="-1"></a><span class="co"> * geqo</span></span>
<span id="cb230-3"><a aria-hidden="true" href="#cb230-3" tabindex="-1"></a><span class="co"> *    Genetic Query Optimizer</span></span>
<span id="cb230-4"><a aria-hidden="true" href="#cb230-4" tabindex="-1"></a><span class="co"> *</span></span>
<span id="cb230-5"><a aria-hidden="true" href="#cb230-5" tabindex="-1"></a><span class="co"> * For queries with many relations, exhaustive search becomes impractical.</span></span>
<span id="cb230-6"><a aria-hidden="true" href="#cb230-6" tabindex="-1"></a><span class="co"> * GEQO uses a genetic algorithm to search for good join orders.</span></span>
<span id="cb230-7"><a aria-hidden="true" href="#cb230-7" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb230-8"><a aria-hidden="true" href="#cb230-8" tabindex="-1"></a>RelOptInfo <span class="op">*</span></span>
<span id="cb230-9"><a aria-hidden="true" href="#cb230-9" tabindex="-1"></a>geqo<span class="op">(</span>PlannerInfo <span class="op">*</span>root<span class="op">,</span> <span class="dt">int</span> number_of_rels<span class="op">,</span> List <span class="op">*</span>initial_rels<span class="op">)</span></span>
<span id="cb230-10"><a aria-hidden="true" href="#cb230-10" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb230-11"><a aria-hidden="true" href="#cb230-11" tabindex="-1"></a>    GeqoPrivateData private<span class="op">;</span></span>
<span id="cb230-12"><a aria-hidden="true" href="#cb230-12" tabindex="-1"></a>    <span class="dt">int</span>         generation<span class="op">;</span></span>
<span id="cb230-13"><a aria-hidden="true" href="#cb230-13" tabindex="-1"></a>    Chromosome <span class="op">*</span>momma<span class="op">;</span></span>
<span id="cb230-14"><a aria-hidden="true" href="#cb230-14" tabindex="-1"></a>    Chromosome <span class="op">*</span>daddy<span class="op">;</span></span>
<span id="cb230-15"><a aria-hidden="true" href="#cb230-15" tabindex="-1"></a></span>
<span id="cb230-16"><a aria-hidden="true" href="#cb230-16" tabindex="-1"></a>    <span class="co">/* Initialize population with random join orders */</span></span>
<span id="cb230-17"><a aria-hidden="true" href="#cb230-17" tabindex="-1"></a>    <span class="co">/* ... */</span></span>
<span id="cb230-18"><a aria-hidden="true" href="#cb230-18" tabindex="-1"></a></span>
<span id="cb230-19"><a aria-hidden="true" href="#cb230-19" tabindex="-1"></a>    <span class="co">/* Evolve population over multiple generations */</span></span>
<span id="cb230-20"><a aria-hidden="true" href="#cb230-20" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span>generation <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> generation <span class="op">&lt;</span> number_generations<span class="op">;</span> generation<span class="op">++)</span></span>
<span id="cb230-21"><a aria-hidden="true" href="#cb230-21" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb230-22"><a aria-hidden="true" href="#cb230-22" tabindex="-1"></a>        <span class="co">/* Select parents based on fitness (cost) */</span></span>
<span id="cb230-23"><a aria-hidden="true" href="#cb230-23" tabindex="-1"></a>        momma <span class="op">=</span> geqo_selection<span class="op">(&amp;</span>private<span class="op">);</span></span>
<span id="cb230-24"><a aria-hidden="true" href="#cb230-24" tabindex="-1"></a>        daddy <span class="op">=</span> geqo_selection<span class="op">(&amp;</span>private<span class="op">);</span></span>
<span id="cb230-25"><a aria-hidden="true" href="#cb230-25" tabindex="-1"></a></span>
<span id="cb230-26"><a aria-hidden="true" href="#cb230-26" tabindex="-1"></a>        <span class="co">/* Create offspring through crossover */</span></span>
<span id="cb230-27"><a aria-hidden="true" href="#cb230-27" tabindex="-1"></a>        offspring <span class="op">=</span> gimme_edge_table<span class="op">(</span>momma<span class="op">,</span> daddy<span class="op">);</span></span>
<span id="cb230-28"><a aria-hidden="true" href="#cb230-28" tabindex="-1"></a></span>
<span id="cb230-29"><a aria-hidden="true" href="#cb230-29" tabindex="-1"></a>        <span class="co">/* Apply mutation */</span></span>
<span id="cb230-30"><a aria-hidden="true" href="#cb230-30" tabindex="-1"></a>        <span class="co">/* ... */</span></span>
<span id="cb230-31"><a aria-hidden="true" href="#cb230-31" tabindex="-1"></a></span>
<span id="cb230-32"><a aria-hidden="true" href="#cb230-32" tabindex="-1"></a>        <span class="co">/* Replace worst individual if offspring is better */</span></span>
<span id="cb230-33"><a aria-hidden="true" href="#cb230-33" tabindex="-1"></a>        <span class="co">/* ... */</span></span>
<span id="cb230-34"><a aria-hidden="true" href="#cb230-34" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb230-35"><a aria-hidden="true" href="#cb230-35" tabindex="-1"></a></span>
<span id="cb230-36"><a aria-hidden="true" href="#cb230-36" tabindex="-1"></a>    <span class="co">/* Build plan from best chromosome */</span></span>
<span id="cb230-37"><a aria-hidden="true" href="#cb230-37" tabindex="-1"></a>    <span class="co">/* ... */</span></span>
<span id="cb230-38"><a aria-hidden="true" href="#cb230-38" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<hr/>
<h2 data-number="4.6" id="the-executor"><span class="header-section-number">4.6</span> 5. The Executor</h2>
<p>The executor takes a PlannedStmt and executes it, producing result
tuples.</p>
<h3 data-number="4.6.1" id="executor-architecture"><span class="header-section-number">4.6.1</span> 5.1 Executor
Architecture</h3>
<p><strong>Location</strong>:
<code>/home/user/postgres/src/backend/executor/execMain.c</code> (2,833
lines)</p>
<p>The executor uses a <strong>Volcano-style iterator model</strong>
where each plan node implements:</p>
<ul>
<li><code>ExecInit*</code> - Initialize the node</li>
<li><code>ExecProc*</code> - Get next tuple</li>
<li><code>ExecEnd*</code> - Clean up the node</li>
</ul>
<h3 data-number="4.6.2" id="executor-lifecycle"><span class="header-section-number">4.6.2</span> 5.2 Executor Lifecycle</h3>
<div class="sourceCode" id="cb231"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb231-1"><a aria-hidden="true" href="#cb231-1" tabindex="-1"></a><span class="co">/*</span></span>
<span id="cb231-2"><a aria-hidden="true" href="#cb231-2" tabindex="-1"></a><span class="co"> * Executor Interface:</span></span>
<span id="cb231-3"><a aria-hidden="true" href="#cb231-3" tabindex="-1"></a><span class="co"> *</span></span>
<span id="cb231-4"><a aria-hidden="true" href="#cb231-4" tabindex="-1"></a><span class="co"> * ExecutorStart()  - Initialize for execution</span></span>
<span id="cb231-5"><a aria-hidden="true" href="#cb231-5" tabindex="-1"></a><span class="co"> * ExecutorRun()    - Execute the query</span></span>
<span id="cb231-6"><a aria-hidden="true" href="#cb231-6" tabindex="-1"></a><span class="co"> * ExecutorFinish() - Complete execution (trigger AFTER triggers, etc.)</span></span>
<span id="cb231-7"><a aria-hidden="true" href="#cb231-7" tabindex="-1"></a><span class="co"> * ExecutorEnd()    - Shut down and clean up</span></span>
<span id="cb231-8"><a aria-hidden="true" href="#cb231-8" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb231-9"><a aria-hidden="true" href="#cb231-9" tabindex="-1"></a></span>
<span id="cb231-10"><a aria-hidden="true" href="#cb231-10" tabindex="-1"></a><span class="co">/* Main execution function */</span></span>
<span id="cb231-11"><a aria-hidden="true" href="#cb231-11" tabindex="-1"></a><span class="dt">void</span></span>
<span id="cb231-12"><a aria-hidden="true" href="#cb231-12" tabindex="-1"></a>ExecutorStart<span class="op">(</span>QueryDesc <span class="op">*</span>queryDesc<span class="op">,</span> <span class="dt">int</span> eflags<span class="op">)</span></span>
<span id="cb231-13"><a aria-hidden="true" href="#cb231-13" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb231-14"><a aria-hidden="true" href="#cb231-14" tabindex="-1"></a>    pgstat_report_query_id<span class="op">(</span>queryDesc<span class="op">-&gt;</span>plannedstmt<span class="op">-&gt;</span>queryId<span class="op">,</span> <span class="kw">false</span><span class="op">);</span></span>
<span id="cb231-15"><a aria-hidden="true" href="#cb231-15" tabindex="-1"></a></span>
<span id="cb231-16"><a aria-hidden="true" href="#cb231-16" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>ExecutorStart_hook<span class="op">)</span></span>
<span id="cb231-17"><a aria-hidden="true" href="#cb231-17" tabindex="-1"></a>        <span class="op">(*</span>ExecutorStart_hook<span class="op">)</span> <span class="op">(</span>queryDesc<span class="op">,</span> eflags<span class="op">);</span></span>
<span id="cb231-18"><a aria-hidden="true" href="#cb231-18" tabindex="-1"></a>    <span class="cf">else</span></span>
<span id="cb231-19"><a aria-hidden="true" href="#cb231-19" tabindex="-1"></a>        standard_ExecutorStart<span class="op">(</span>queryDesc<span class="op">,</span> eflags<span class="op">);</span></span>
<span id="cb231-20"><a aria-hidden="true" href="#cb231-20" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb231-21"><a aria-hidden="true" href="#cb231-21" tabindex="-1"></a></span>
<span id="cb231-22"><a aria-hidden="true" href="#cb231-22" tabindex="-1"></a><span class="dt">void</span></span>
<span id="cb231-23"><a aria-hidden="true" href="#cb231-23" tabindex="-1"></a>standard_ExecutorStart<span class="op">(</span>QueryDesc <span class="op">*</span>queryDesc<span class="op">,</span> <span class="dt">int</span> eflags<span class="op">)</span></span>
<span id="cb231-24"><a aria-hidden="true" href="#cb231-24" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb231-25"><a aria-hidden="true" href="#cb231-25" tabindex="-1"></a>    EState     <span class="op">*</span>estate<span class="op">;</span></span>
<span id="cb231-26"><a aria-hidden="true" href="#cb231-26" tabindex="-1"></a>    MemoryContext oldcontext<span class="op">;</span></span>
<span id="cb231-27"><a aria-hidden="true" href="#cb231-27" tabindex="-1"></a></span>
<span id="cb231-28"><a aria-hidden="true" href="#cb231-28" tabindex="-1"></a>    <span class="co">/* sanity checks: queryDesc must not be started already */</span></span>
<span id="cb231-29"><a aria-hidden="true" href="#cb231-29" tabindex="-1"></a>    Assert<span class="op">(</span>queryDesc <span class="op">!=</span> NULL<span class="op">);</span></span>
<span id="cb231-30"><a aria-hidden="true" href="#cb231-30" tabindex="-1"></a>    Assert<span class="op">(</span>queryDesc<span class="op">-&gt;</span>estate <span class="op">==</span> NULL<span class="op">);</span></span>
<span id="cb231-31"><a aria-hidden="true" href="#cb231-31" tabindex="-1"></a></span>
<span id="cb231-32"><a aria-hidden="true" href="#cb231-32" tabindex="-1"></a>    <span class="co">/*</span></span>
<span id="cb231-33"><a aria-hidden="true" href="#cb231-33" tabindex="-1"></a><span class="co">     * Create the per-query execution state (EState).</span></span>
<span id="cb231-34"><a aria-hidden="true" href="#cb231-34" tabindex="-1"></a><span class="co">     * This includes a memory context for per-query data.</span></span>
<span id="cb231-35"><a aria-hidden="true" href="#cb231-35" tabindex="-1"></a><span class="co">     */</span></span>
<span id="cb231-36"><a aria-hidden="true" href="#cb231-36" tabindex="-1"></a>    estate <span class="op">=</span> CreateExecutorState<span class="op">();</span></span>
<span id="cb231-37"><a aria-hidden="true" href="#cb231-37" tabindex="-1"></a>    queryDesc<span class="op">-&gt;</span>estate <span class="op">=</span> estate<span class="op">;</span></span>
<span id="cb231-38"><a aria-hidden="true" href="#cb231-38" tabindex="-1"></a></span>
<span id="cb231-39"><a aria-hidden="true" href="#cb231-39" tabindex="-1"></a>    oldcontext <span class="op">=</span> MemoryContextSwitchTo<span class="op">(</span>estate<span class="op">-&gt;</span>es_query_cxt<span class="op">);</span></span>
<span id="cb231-40"><a aria-hidden="true" href="#cb231-40" tabindex="-1"></a></span>
<span id="cb231-41"><a aria-hidden="true" href="#cb231-41" tabindex="-1"></a>    <span class="co">/* Initialize estate fields */</span></span>
<span id="cb231-42"><a aria-hidden="true" href="#cb231-42" tabindex="-1"></a>    estate<span class="op">-&gt;</span>es_param_list_info <span class="op">=</span> queryDesc<span class="op">-&gt;</span>params<span class="op">;</span></span>
<span id="cb231-43"><a aria-hidden="true" href="#cb231-43" tabindex="-1"></a>    estate<span class="op">-&gt;</span>es_param_exec_vals <span class="op">=</span> NULL<span class="op">;</span></span>
<span id="cb231-44"><a aria-hidden="true" href="#cb231-44" tabindex="-1"></a></span>
<span id="cb231-45"><a aria-hidden="true" href="#cb231-45" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>queryDesc<span class="op">-&gt;</span>plannedstmt<span class="op">-&gt;</span>nParamExec <span class="op">&gt;</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb231-46"><a aria-hidden="true" href="#cb231-46" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb231-47"><a aria-hidden="true" href="#cb231-47" tabindex="-1"></a>        estate<span class="op">-&gt;</span>es_param_exec_vals <span class="op">=</span> <span class="op">(</span>ParamExecData <span class="op">*)</span></span>
<span id="cb231-48"><a aria-hidden="true" href="#cb231-48" tabindex="-1"></a>            palloc0<span class="op">(</span>queryDesc<span class="op">-&gt;</span>plannedstmt<span class="op">-&gt;</span>nParamExec <span class="op">*</span></span>
<span id="cb231-49"><a aria-hidden="true" href="#cb231-49" tabindex="-1"></a>                   <span class="kw">sizeof</span><span class="op">(</span>ParamExecData<span class="op">));</span></span>
<span id="cb231-50"><a aria-hidden="true" href="#cb231-50" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb231-51"><a aria-hidden="true" href="#cb231-51" tabindex="-1"></a></span>
<span id="cb231-52"><a aria-hidden="true" href="#cb231-52" tabindex="-1"></a>    <span class="co">/* Set up connection to tuple receiver */</span></span>
<span id="cb231-53"><a aria-hidden="true" href="#cb231-53" tabindex="-1"></a>    estate<span class="op">-&gt;</span>es_processed <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb231-54"><a aria-hidden="true" href="#cb231-54" tabindex="-1"></a>    estate<span class="op">-&gt;</span>es_top_eflags <span class="op">=</span> eflags<span class="op">;</span></span>
<span id="cb231-55"><a aria-hidden="true" href="#cb231-55" tabindex="-1"></a>    estate<span class="op">-&gt;</span>es_instrument <span class="op">=</span> queryDesc<span class="op">-&gt;</span>instrument_options<span class="op">;</span></span>
<span id="cb231-56"><a aria-hidden="true" href="#cb231-56" tabindex="-1"></a></span>
<span id="cb231-57"><a aria-hidden="true" href="#cb231-57" tabindex="-1"></a>    <span class="co">/*</span></span>
<span id="cb231-58"><a aria-hidden="true" href="#cb231-58" tabindex="-1"></a><span class="co">     * Initialize the plan state tree</span></span>
<span id="cb231-59"><a aria-hidden="true" href="#cb231-59" tabindex="-1"></a><span class="co">     */</span></span>
<span id="cb231-60"><a aria-hidden="true" href="#cb231-60" tabindex="-1"></a>    InitPlan<span class="op">(</span>queryDesc<span class="op">,</span> eflags<span class="op">);</span></span>
<span id="cb231-61"><a aria-hidden="true" href="#cb231-61" tabindex="-1"></a></span>
<span id="cb231-62"><a aria-hidden="true" href="#cb231-62" tabindex="-1"></a>    MemoryContextSwitchTo<span class="op">(</span>oldcontext<span class="op">);</span></span>
<span id="cb231-63"><a aria-hidden="true" href="#cb231-63" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 data-number="4.6.3" id="tuple-processing-model"><span class="header-section-number">4.6.3</span> 5.3 Tuple Processing
Model</h3>
<p><strong>ExecutorRun</strong> - Main execution loop:</p>
<div class="sourceCode" id="cb232"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb232-1"><a aria-hidden="true" href="#cb232-1" tabindex="-1"></a><span class="dt">void</span></span>
<span id="cb232-2"><a aria-hidden="true" href="#cb232-2" tabindex="-1"></a>ExecutorRun<span class="op">(</span>QueryDesc <span class="op">*</span>queryDesc<span class="op">,</span></span>
<span id="cb232-3"><a aria-hidden="true" href="#cb232-3" tabindex="-1"></a>           ScanDirection direction<span class="op">,</span> uint64 count<span class="op">,</span></span>
<span id="cb232-4"><a aria-hidden="true" href="#cb232-4" tabindex="-1"></a>           <span class="dt">bool</span> execute_once<span class="op">)</span></span>
<span id="cb232-5"><a aria-hidden="true" href="#cb232-5" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb232-6"><a aria-hidden="true" href="#cb232-6" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>ExecutorRun_hook<span class="op">)</span></span>
<span id="cb232-7"><a aria-hidden="true" href="#cb232-7" tabindex="-1"></a>        <span class="op">(*</span>ExecutorRun_hook<span class="op">)</span> <span class="op">(</span>queryDesc<span class="op">,</span> direction<span class="op">,</span> count<span class="op">,</span> execute_once<span class="op">);</span></span>
<span id="cb232-8"><a aria-hidden="true" href="#cb232-8" tabindex="-1"></a>    <span class="cf">else</span></span>
<span id="cb232-9"><a aria-hidden="true" href="#cb232-9" tabindex="-1"></a>        standard_ExecutorRun<span class="op">(</span>queryDesc<span class="op">,</span> direction<span class="op">,</span> count<span class="op">,</span> execute_once<span class="op">);</span></span>
<span id="cb232-10"><a aria-hidden="true" href="#cb232-10" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb232-11"><a aria-hidden="true" href="#cb232-11" tabindex="-1"></a></span>
<span id="cb232-12"><a aria-hidden="true" href="#cb232-12" tabindex="-1"></a><span class="dt">void</span></span>
<span id="cb232-13"><a aria-hidden="true" href="#cb232-13" tabindex="-1"></a>standard_ExecutorRun<span class="op">(</span>QueryDesc <span class="op">*</span>queryDesc<span class="op">,</span></span>
<span id="cb232-14"><a aria-hidden="true" href="#cb232-14" tabindex="-1"></a>                    ScanDirection direction<span class="op">,</span> uint64 count<span class="op">,</span></span>
<span id="cb232-15"><a aria-hidden="true" href="#cb232-15" tabindex="-1"></a>                    <span class="dt">bool</span> execute_once<span class="op">)</span></span>
<span id="cb232-16"><a aria-hidden="true" href="#cb232-16" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb232-17"><a aria-hidden="true" href="#cb232-17" tabindex="-1"></a>    EState     <span class="op">*</span>estate<span class="op">;</span></span>
<span id="cb232-18"><a aria-hidden="true" href="#cb232-18" tabindex="-1"></a>    CmdType     operation<span class="op">;</span></span>
<span id="cb232-19"><a aria-hidden="true" href="#cb232-19" tabindex="-1"></a>    DestReceiver <span class="op">*</span>dest<span class="op">;</span></span>
<span id="cb232-20"><a aria-hidden="true" href="#cb232-20" tabindex="-1"></a>    <span class="dt">bool</span>        sendTuples<span class="op">;</span></span>
<span id="cb232-21"><a aria-hidden="true" href="#cb232-21" tabindex="-1"></a>    MemoryContext oldcontext<span class="op">;</span></span>
<span id="cb232-22"><a aria-hidden="true" href="#cb232-22" tabindex="-1"></a></span>
<span id="cb232-23"><a aria-hidden="true" href="#cb232-23" tabindex="-1"></a>    <span class="co">/* sanity checks */</span></span>
<span id="cb232-24"><a aria-hidden="true" href="#cb232-24" tabindex="-1"></a>    Assert<span class="op">(</span>queryDesc <span class="op">!=</span> NULL<span class="op">);</span></span>
<span id="cb232-25"><a aria-hidden="true" href="#cb232-25" tabindex="-1"></a></span>
<span id="cb232-26"><a aria-hidden="true" href="#cb232-26" tabindex="-1"></a>    estate <span class="op">=</span> queryDesc<span class="op">-&gt;</span>estate<span class="op">;</span></span>
<span id="cb232-27"><a aria-hidden="true" href="#cb232-27" tabindex="-1"></a>    Assert<span class="op">(</span>estate <span class="op">!=</span> NULL<span class="op">);</span></span>
<span id="cb232-28"><a aria-hidden="true" href="#cb232-28" tabindex="-1"></a>    Assert<span class="op">(!(</span>estate<span class="op">-&gt;</span>es_top_eflags <span class="op">&amp;</span> EXEC_FLAG_EXPLAIN_ONLY<span class="op">));</span></span>
<span id="cb232-29"><a aria-hidden="true" href="#cb232-29" tabindex="-1"></a></span>
<span id="cb232-30"><a aria-hidden="true" href="#cb232-30" tabindex="-1"></a>    <span class="co">/* Switch into per-query memory context */</span></span>
<span id="cb232-31"><a aria-hidden="true" href="#cb232-31" tabindex="-1"></a>    oldcontext <span class="op">=</span> MemoryContextSwitchTo<span class="op">(</span>estate<span class="op">-&gt;</span>es_query_cxt<span class="op">);</span></span>
<span id="cb232-32"><a aria-hidden="true" href="#cb232-32" tabindex="-1"></a></span>
<span id="cb232-33"><a aria-hidden="true" href="#cb232-33" tabindex="-1"></a>    <span class="co">/* Extract necessary info from queryDesc */</span></span>
<span id="cb232-34"><a aria-hidden="true" href="#cb232-34" tabindex="-1"></a>    operation <span class="op">=</span> queryDesc<span class="op">-&gt;</span>operation<span class="op">;</span></span>
<span id="cb232-35"><a aria-hidden="true" href="#cb232-35" tabindex="-1"></a>    dest <span class="op">=</span> queryDesc<span class="op">-&gt;</span>dest<span class="op">;</span></span>
<span id="cb232-36"><a aria-hidden="true" href="#cb232-36" tabindex="-1"></a></span>
<span id="cb232-37"><a aria-hidden="true" href="#cb232-37" tabindex="-1"></a>    <span class="co">/*</span></span>
<span id="cb232-38"><a aria-hidden="true" href="#cb232-38" tabindex="-1"></a><span class="co">     * ExecutePlan processes the plan tree and generates result tuples</span></span>
<span id="cb232-39"><a aria-hidden="true" href="#cb232-39" tabindex="-1"></a><span class="co">     */</span></span>
<span id="cb232-40"><a aria-hidden="true" href="#cb232-40" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>queryDesc<span class="op">-&gt;</span>plannedstmt<span class="op">-&gt;</span>utilityStmt <span class="op">==</span> NULL<span class="op">)</span></span>
<span id="cb232-41"><a aria-hidden="true" href="#cb232-41" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb232-42"><a aria-hidden="true" href="#cb232-42" tabindex="-1"></a>        sendTuples <span class="op">=</span> <span class="op">(</span>operation <span class="op">==</span> CMD_SELECT <span class="op">||</span></span>
<span id="cb232-43"><a aria-hidden="true" href="#cb232-43" tabindex="-1"></a>                     queryDesc<span class="op">-&gt;</span>plannedstmt<span class="op">-&gt;</span>hasReturning<span class="op">);</span></span>
<span id="cb232-44"><a aria-hidden="true" href="#cb232-44" tabindex="-1"></a></span>
<span id="cb232-45"><a aria-hidden="true" href="#cb232-45" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>sendTuples<span class="op">)</span></span>
<span id="cb232-46"><a aria-hidden="true" href="#cb232-46" tabindex="-1"></a>            dest<span class="op">-&gt;</span>rStartup<span class="op">(</span>dest<span class="op">,</span> operation<span class="op">,</span> queryDesc<span class="op">-&gt;</span>tupDesc<span class="op">);</span></span>
<span id="cb232-47"><a aria-hidden="true" href="#cb232-47" tabindex="-1"></a></span>
<span id="cb232-48"><a aria-hidden="true" href="#cb232-48" tabindex="-1"></a>        ExecutePlan<span class="op">(</span>estate<span class="op">,</span></span>
<span id="cb232-49"><a aria-hidden="true" href="#cb232-49" tabindex="-1"></a>                   queryDesc<span class="op">-&gt;</span>planstate<span class="op">,</span></span>
<span id="cb232-50"><a aria-hidden="true" href="#cb232-50" tabindex="-1"></a>                   queryDesc<span class="op">-&gt;</span>plannedstmt<span class="op">-&gt;</span>parallelModeNeeded<span class="op">,</span></span>
<span id="cb232-51"><a aria-hidden="true" href="#cb232-51" tabindex="-1"></a>                   operation<span class="op">,</span></span>
<span id="cb232-52"><a aria-hidden="true" href="#cb232-52" tabindex="-1"></a>                   sendTuples<span class="op">,</span></span>
<span id="cb232-53"><a aria-hidden="true" href="#cb232-53" tabindex="-1"></a>                   count<span class="op">,</span></span>
<span id="cb232-54"><a aria-hidden="true" href="#cb232-54" tabindex="-1"></a>                   direction<span class="op">,</span></span>
<span id="cb232-55"><a aria-hidden="true" href="#cb232-55" tabindex="-1"></a>                   dest<span class="op">,</span></span>
<span id="cb232-56"><a aria-hidden="true" href="#cb232-56" tabindex="-1"></a>                   execute_once<span class="op">);</span></span>
<span id="cb232-57"><a aria-hidden="true" href="#cb232-57" tabindex="-1"></a></span>
<span id="cb232-58"><a aria-hidden="true" href="#cb232-58" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>sendTuples<span class="op">)</span></span>
<span id="cb232-59"><a aria-hidden="true" href="#cb232-59" tabindex="-1"></a>            dest<span class="op">-&gt;</span>rShutdown<span class="op">(</span>dest<span class="op">);</span></span>
<span id="cb232-60"><a aria-hidden="true" href="#cb232-60" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb232-61"><a aria-hidden="true" href="#cb232-61" tabindex="-1"></a></span>
<span id="cb232-62"><a aria-hidden="true" href="#cb232-62" tabindex="-1"></a>    MemoryContextSwitchTo<span class="op">(</span>oldcontext<span class="op">);</span></span>
<span id="cb232-63"><a aria-hidden="true" href="#cb232-63" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>ExecutePlan</strong> - Inner execution loop:</p>
<div class="sourceCode" id="cb233"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb233-1"><a aria-hidden="true" href="#cb233-1" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span></span>
<span id="cb233-2"><a aria-hidden="true" href="#cb233-2" tabindex="-1"></a>ExecutePlan<span class="op">(</span>EState <span class="op">*</span>estate<span class="op">,</span></span>
<span id="cb233-3"><a aria-hidden="true" href="#cb233-3" tabindex="-1"></a>           PlanState <span class="op">*</span>planstate<span class="op">,</span></span>
<span id="cb233-4"><a aria-hidden="true" href="#cb233-4" tabindex="-1"></a>           <span class="dt">bool</span> use_parallel_mode<span class="op">,</span></span>
<span id="cb233-5"><a aria-hidden="true" href="#cb233-5" tabindex="-1"></a>           CmdType operation<span class="op">,</span></span>
<span id="cb233-6"><a aria-hidden="true" href="#cb233-6" tabindex="-1"></a>           <span class="dt">bool</span> sendTuples<span class="op">,</span></span>
<span id="cb233-7"><a aria-hidden="true" href="#cb233-7" tabindex="-1"></a>           uint64 numberTuples<span class="op">,</span></span>
<span id="cb233-8"><a aria-hidden="true" href="#cb233-8" tabindex="-1"></a>           ScanDirection direction<span class="op">,</span></span>
<span id="cb233-9"><a aria-hidden="true" href="#cb233-9" tabindex="-1"></a>           DestReceiver <span class="op">*</span>dest<span class="op">,</span></span>
<span id="cb233-10"><a aria-hidden="true" href="#cb233-10" tabindex="-1"></a>           <span class="dt">bool</span> execute_once<span class="op">)</span></span>
<span id="cb233-11"><a aria-hidden="true" href="#cb233-11" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb233-12"><a aria-hidden="true" href="#cb233-12" tabindex="-1"></a>    TupleTableSlot <span class="op">*</span>slot<span class="op">;</span></span>
<span id="cb233-13"><a aria-hidden="true" href="#cb233-13" tabindex="-1"></a>    uint64      current_tuple_count<span class="op">;</span></span>
<span id="cb233-14"><a aria-hidden="true" href="#cb233-14" tabindex="-1"></a></span>
<span id="cb233-15"><a aria-hidden="true" href="#cb233-15" tabindex="-1"></a>    <span class="co">/* Initialize local variables */</span></span>
<span id="cb233-16"><a aria-hidden="true" href="#cb233-16" tabindex="-1"></a>    current_tuple_count <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb233-17"><a aria-hidden="true" href="#cb233-17" tabindex="-1"></a></span>
<span id="cb233-18"><a aria-hidden="true" href="#cb233-18" tabindex="-1"></a>    <span class="co">/*</span></span>
<span id="cb233-19"><a aria-hidden="true" href="#cb233-19" tabindex="-1"></a><span class="co">     * Main execution loop: repeatedly call ExecProcNode to get tuples</span></span>
<span id="cb233-20"><a aria-hidden="true" href="#cb233-20" tabindex="-1"></a><span class="co">     */</span></span>
<span id="cb233-21"><a aria-hidden="true" href="#cb233-21" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(;;)</span></span>
<span id="cb233-22"><a aria-hidden="true" href="#cb233-22" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb233-23"><a aria-hidden="true" href="#cb233-23" tabindex="-1"></a>        <span class="co">/* Reset per-tuple memory context */</span></span>
<span id="cb233-24"><a aria-hidden="true" href="#cb233-24" tabindex="-1"></a>        ResetPerTupleExprContext<span class="op">(</span>estate<span class="op">);</span></span>
<span id="cb233-25"><a aria-hidden="true" href="#cb233-25" tabindex="-1"></a></span>
<span id="cb233-26"><a aria-hidden="true" href="#cb233-26" tabindex="-1"></a>        <span class="co">/* Get next tuple from plan */</span></span>
<span id="cb233-27"><a aria-hidden="true" href="#cb233-27" tabindex="-1"></a>        slot <span class="op">=</span> ExecProcNode<span class="op">(</span>planstate<span class="op">);</span></span>
<span id="cb233-28"><a aria-hidden="true" href="#cb233-28" tabindex="-1"></a></span>
<span id="cb233-29"><a aria-hidden="true" href="#cb233-29" tabindex="-1"></a>        <span class="co">/* If no more tuples, we're done */</span></span>
<span id="cb233-30"><a aria-hidden="true" href="#cb233-30" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>TupIsNull<span class="op">(</span>slot<span class="op">))</span></span>
<span id="cb233-31"><a aria-hidden="true" href="#cb233-31" tabindex="-1"></a>            <span class="cf">break</span><span class="op">;</span></span>
<span id="cb233-32"><a aria-hidden="true" href="#cb233-32" tabindex="-1"></a></span>
<span id="cb233-33"><a aria-hidden="true" href="#cb233-33" tabindex="-1"></a>        <span class="co">/* Send tuple to destination */</span></span>
<span id="cb233-34"><a aria-hidden="true" href="#cb233-34" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>sendTuples<span class="op">)</span></span>
<span id="cb233-35"><a aria-hidden="true" href="#cb233-35" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb233-36"><a aria-hidden="true" href="#cb233-36" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(!</span>dest<span class="op">-&gt;</span>receiveSlot<span class="op">(</span>slot<span class="op">,</span> dest<span class="op">))</span></span>
<span id="cb233-37"><a aria-hidden="true" href="#cb233-37" tabindex="-1"></a>                <span class="cf">break</span><span class="op">;</span></span>
<span id="cb233-38"><a aria-hidden="true" href="#cb233-38" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb233-39"><a aria-hidden="true" href="#cb233-39" tabindex="-1"></a></span>
<span id="cb233-40"><a aria-hidden="true" href="#cb233-40" tabindex="-1"></a>        <span class="co">/* Count the tuple */</span></span>
<span id="cb233-41"><a aria-hidden="true" href="#cb233-41" tabindex="-1"></a>        current_tuple_count<span class="op">++;</span></span>
<span id="cb233-42"><a aria-hidden="true" href="#cb233-42" tabindex="-1"></a>        estate<span class="op">-&gt;</span>es_processed<span class="op">++;</span></span>
<span id="cb233-43"><a aria-hidden="true" href="#cb233-43" tabindex="-1"></a></span>
<span id="cb233-44"><a aria-hidden="true" href="#cb233-44" tabindex="-1"></a>        <span class="co">/* Check if we've processed enough tuples */</span></span>
<span id="cb233-45"><a aria-hidden="true" href="#cb233-45" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>numberTuples <span class="op">&amp;&amp;</span> numberTuples <span class="op">==</span> current_tuple_count<span class="op">)</span></span>
<span id="cb233-46"><a aria-hidden="true" href="#cb233-46" tabindex="-1"></a>            <span class="cf">break</span><span class="op">;</span></span>
<span id="cb233-47"><a aria-hidden="true" href="#cb233-47" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb233-48"><a aria-hidden="true" href="#cb233-48" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 data-number="4.6.4" id="plan-node-execution"><span class="header-section-number">4.6.4</span> 5.4 Plan Node Execution</h3>
<p>Each plan node type has its own execution function. Example -
Sequential Scan:</p>
<p><strong>Location</strong>:
<code>/home/user/postgres/src/backend/executor/nodeSeqscan.c</code></p>
<div class="sourceCode" id="cb234"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb234-1"><a aria-hidden="true" href="#cb234-1" tabindex="-1"></a><span class="co">/* ----------------------------------------------------------------</span></span>
<span id="cb234-2"><a aria-hidden="true" href="#cb234-2" tabindex="-1"></a><span class="co"> *      ExecSeqScan(node)</span></span>
<span id="cb234-3"><a aria-hidden="true" href="#cb234-3" tabindex="-1"></a><span class="co"> *</span></span>
<span id="cb234-4"><a aria-hidden="true" href="#cb234-4" tabindex="-1"></a><span class="co"> *      Scans the relation sequentially and returns the next qualifying</span></span>
<span id="cb234-5"><a aria-hidden="true" href="#cb234-5" tabindex="-1"></a><span class="co"> *      tuple.</span></span>
<span id="cb234-6"><a aria-hidden="true" href="#cb234-6" tabindex="-1"></a><span class="co"> *      We call the ExecScan() routine and pass it the appropriate</span></span>
<span id="cb234-7"><a aria-hidden="true" href="#cb234-7" tabindex="-1"></a><span class="co"> *      access method functions.</span></span>
<span id="cb234-8"><a aria-hidden="true" href="#cb234-8" tabindex="-1"></a><span class="co"> * ----------------------------------------------------------------</span></span>
<span id="cb234-9"><a aria-hidden="true" href="#cb234-9" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb234-10"><a aria-hidden="true" href="#cb234-10" tabindex="-1"></a><span class="dt">static</span> TupleTableSlot <span class="op">*</span></span>
<span id="cb234-11"><a aria-hidden="true" href="#cb234-11" tabindex="-1"></a>ExecSeqScan<span class="op">(</span>PlanState <span class="op">*</span>pstate<span class="op">)</span></span>
<span id="cb234-12"><a aria-hidden="true" href="#cb234-12" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb234-13"><a aria-hidden="true" href="#cb234-13" tabindex="-1"></a>    SeqScanState <span class="op">*</span>node <span class="op">=</span> castNode<span class="op">(</span>SeqScanState<span class="op">,</span> pstate<span class="op">);</span></span>
<span id="cb234-14"><a aria-hidden="true" href="#cb234-14" tabindex="-1"></a></span>
<span id="cb234-15"><a aria-hidden="true" href="#cb234-15" tabindex="-1"></a>    <span class="cf">return</span> ExecScan<span class="op">(&amp;</span>node<span class="op">-&gt;</span>ss<span class="op">,</span></span>
<span id="cb234-16"><a aria-hidden="true" href="#cb234-16" tabindex="-1"></a>                   <span class="op">(</span>ExecScanAccessMtd<span class="op">)</span> SeqNext<span class="op">,</span></span>
<span id="cb234-17"><a aria-hidden="true" href="#cb234-17" tabindex="-1"></a>                   <span class="op">(</span>ExecScanRecheckMtd<span class="op">)</span> SeqRecheck<span class="op">);</span></span>
<span id="cb234-18"><a aria-hidden="true" href="#cb234-18" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb234-19"><a aria-hidden="true" href="#cb234-19" tabindex="-1"></a></span>
<span id="cb234-20"><a aria-hidden="true" href="#cb234-20" tabindex="-1"></a><span class="co">/* ----------------------------------------------------------------</span></span>
<span id="cb234-21"><a aria-hidden="true" href="#cb234-21" tabindex="-1"></a><span class="co"> *      SeqNext</span></span>
<span id="cb234-22"><a aria-hidden="true" href="#cb234-22" tabindex="-1"></a><span class="co"> *</span></span>
<span id="cb234-23"><a aria-hidden="true" href="#cb234-23" tabindex="-1"></a><span class="co"> *      This is a workhorse for ExecSeqScan</span></span>
<span id="cb234-24"><a aria-hidden="true" href="#cb234-24" tabindex="-1"></a><span class="co"> * ----------------------------------------------------------------</span></span>
<span id="cb234-25"><a aria-hidden="true" href="#cb234-25" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb234-26"><a aria-hidden="true" href="#cb234-26" tabindex="-1"></a><span class="dt">static</span> TupleTableSlot <span class="op">*</span></span>
<span id="cb234-27"><a aria-hidden="true" href="#cb234-27" tabindex="-1"></a>SeqNext<span class="op">(</span>SeqScanState <span class="op">*</span>node<span class="op">)</span></span>
<span id="cb234-28"><a aria-hidden="true" href="#cb234-28" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb234-29"><a aria-hidden="true" href="#cb234-29" tabindex="-1"></a>    HeapScanDesc scandesc<span class="op">;</span></span>
<span id="cb234-30"><a aria-hidden="true" href="#cb234-30" tabindex="-1"></a>    TableScanDesc scan<span class="op">;</span></span>
<span id="cb234-31"><a aria-hidden="true" href="#cb234-31" tabindex="-1"></a>    EState     <span class="op">*</span>estate<span class="op">;</span></span>
<span id="cb234-32"><a aria-hidden="true" href="#cb234-32" tabindex="-1"></a>    ScanDirection direction<span class="op">;</span></span>
<span id="cb234-33"><a aria-hidden="true" href="#cb234-33" tabindex="-1"></a>    TupleTableSlot <span class="op">*</span>slot<span class="op">;</span></span>
<span id="cb234-34"><a aria-hidden="true" href="#cb234-34" tabindex="-1"></a></span>
<span id="cb234-35"><a aria-hidden="true" href="#cb234-35" tabindex="-1"></a>    <span class="co">/* Get information from the estate and scan state */</span></span>
<span id="cb234-36"><a aria-hidden="true" href="#cb234-36" tabindex="-1"></a>    scandesc <span class="op">=</span> node<span class="op">-&gt;</span>ss<span class="op">.</span>ss_currentScanDesc<span class="op">;</span></span>
<span id="cb234-37"><a aria-hidden="true" href="#cb234-37" tabindex="-1"></a>    estate <span class="op">=</span> node<span class="op">-&gt;</span>ss<span class="op">.</span>ps<span class="op">.</span>state<span class="op">;</span></span>
<span id="cb234-38"><a aria-hidden="true" href="#cb234-38" tabindex="-1"></a>    direction <span class="op">=</span> estate<span class="op">-&gt;</span>es_direction<span class="op">;</span></span>
<span id="cb234-39"><a aria-hidden="true" href="#cb234-39" tabindex="-1"></a>    slot <span class="op">=</span> node<span class="op">-&gt;</span>ss<span class="op">.</span>ss_ScanTupleSlot<span class="op">;</span></span>
<span id="cb234-40"><a aria-hidden="true" href="#cb234-40" tabindex="-1"></a></span>
<span id="cb234-41"><a aria-hidden="true" href="#cb234-41" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>scandesc <span class="op">==</span> NULL<span class="op">)</span></span>
<span id="cb234-42"><a aria-hidden="true" href="#cb234-42" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb234-43"><a aria-hidden="true" href="#cb234-43" tabindex="-1"></a>        <span class="co">/* First call - open the scan */</span></span>
<span id="cb234-44"><a aria-hidden="true" href="#cb234-44" tabindex="-1"></a>        scandesc <span class="op">=</span> table_beginscan<span class="op">(</span>node<span class="op">-&gt;</span>ss<span class="op">.</span>ss_currentRelation<span class="op">,</span></span>
<span id="cb234-45"><a aria-hidden="true" href="#cb234-45" tabindex="-1"></a>                                  estate<span class="op">-&gt;</span>es_snapshot<span class="op">,</span></span>
<span id="cb234-46"><a aria-hidden="true" href="#cb234-46" tabindex="-1"></a>                                  <span class="dv">0</span><span class="op">,</span> NULL<span class="op">);</span></span>
<span id="cb234-47"><a aria-hidden="true" href="#cb234-47" tabindex="-1"></a>        node<span class="op">-&gt;</span>ss<span class="op">.</span>ss_currentScanDesc <span class="op">=</span> scandesc<span class="op">;</span></span>
<span id="cb234-48"><a aria-hidden="true" href="#cb234-48" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb234-49"><a aria-hidden="true" href="#cb234-49" tabindex="-1"></a></span>
<span id="cb234-50"><a aria-hidden="true" href="#cb234-50" tabindex="-1"></a>    <span class="co">/* Get the next tuple from the table */</span></span>
<span id="cb234-51"><a aria-hidden="true" href="#cb234-51" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>table_scan_getnextslot<span class="op">(</span>scandesc<span class="op">,</span> direction<span class="op">,</span> slot<span class="op">))</span></span>
<span id="cb234-52"><a aria-hidden="true" href="#cb234-52" tabindex="-1"></a>        <span class="cf">return</span> slot<span class="op">;</span></span>
<span id="cb234-53"><a aria-hidden="true" href="#cb234-53" tabindex="-1"></a></span>
<span id="cb234-54"><a aria-hidden="true" href="#cb234-54" tabindex="-1"></a>    <span class="cf">return</span> NULL<span class="op">;</span>  <span class="co">/* No more tuples */</span></span>
<span id="cb234-55"><a aria-hidden="true" href="#cb234-55" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<hr/>
<h2 data-number="4.7" id="catalog-system-and-syscache"><span class="header-section-number">4.7</span> 6. Catalog System and
Syscache</h2>
<p>The catalog system stores metadata about database objects. The
syscache provides high-speed cached access to catalog tuples.</p>
<h3 data-number="4.7.1" id="system-catalogs"><span class="header-section-number">4.7.1</span> 6.1 System Catalogs</h3>
<p>PostgreSQL stores all metadata in regular tables (the system
catalogs):</p>
<ul>
<li><strong>pg_class</strong> - Tables, indexes, views, sequences</li>
<li><strong>pg_attribute</strong> - Columns of tables</li>
<li><strong>pg_type</strong> - Data types</li>
<li><strong>pg_proc</strong> - Functions and procedures</li>
<li><strong>pg_index</strong> - Index definitions</li>
<li><strong>pg_operator</strong> - Operators</li>
<li><strong>pg_am</strong> - Access methods</li>
</ul>
<p><strong>Example Catalog Query</strong>:</p>
<div class="sourceCode" id="cb235"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb235-1"><a aria-hidden="true" href="#cb235-1" tabindex="-1"></a><span class="co">-- Find all columns of a table</span></span>
<span id="cb235-2"><a aria-hidden="true" href="#cb235-2" tabindex="-1"></a><span class="kw">SELECT</span> attname, atttypid, attnotnull</span>
<span id="cb235-3"><a aria-hidden="true" href="#cb235-3" tabindex="-1"></a><span class="kw">FROM</span> pg_attribute</span>
<span id="cb235-4"><a aria-hidden="true" href="#cb235-4" tabindex="-1"></a><span class="kw">WHERE</span> attrelid <span class="op">=</span> <span class="st">'employees'</span>:<span class="ch">:regclass</span></span>
<span id="cb235-5"><a aria-hidden="true" href="#cb235-5" tabindex="-1"></a>  <span class="kw">AND</span> attnum <span class="op">&gt;</span> <span class="dv">0</span></span>
<span id="cb235-6"><a aria-hidden="true" href="#cb235-6" tabindex="-1"></a>  <span class="kw">AND</span> <span class="kw">NOT</span> attisdropped</span>
<span id="cb235-7"><a aria-hidden="true" href="#cb235-7" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> attnum;</span></code></pre></div>
<h3 data-number="4.7.2" id="syscache-architecture"><span class="header-section-number">4.7.2</span> 6.2 Syscache
Architecture</h3>
<p><strong>Location</strong>:
<code>/home/user/postgres/src/backend/utils/cache/syscache.c</code></p>
<p>The syscache provides cached access to frequently-accessed catalog
tuples:</p>
<div class="sourceCode" id="cb236"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb236-1"><a aria-hidden="true" href="#cb236-1" tabindex="-1"></a><span class="co">/*</span></span>
<span id="cb236-2"><a aria-hidden="true" href="#cb236-2" tabindex="-1"></a><span class="co"> * SearchSysCache</span></span>
<span id="cb236-3"><a aria-hidden="true" href="#cb236-3" tabindex="-1"></a><span class="co"> *    A layer on top of SearchCatCache that does the initialization and</span></span>
<span id="cb236-4"><a aria-hidden="true" href="#cb236-4" tabindex="-1"></a><span class="co"> *    key-setting for you.</span></span>
<span id="cb236-5"><a aria-hidden="true" href="#cb236-5" tabindex="-1"></a><span class="co"> *</span></span>
<span id="cb236-6"><a aria-hidden="true" href="#cb236-6" tabindex="-1"></a><span class="co"> * Returns the cache copy of the tuple if one is found, NULL if not.</span></span>
<span id="cb236-7"><a aria-hidden="true" href="#cb236-7" tabindex="-1"></a><span class="co"> * The tuple is the 'cache' copy and must not be modified!</span></span>
<span id="cb236-8"><a aria-hidden="true" href="#cb236-8" tabindex="-1"></a><span class="co"> *</span></span>
<span id="cb236-9"><a aria-hidden="true" href="#cb236-9" tabindex="-1"></a><span class="co"> * When done with a tuple, call ReleaseSysCache().</span></span>
<span id="cb236-10"><a aria-hidden="true" href="#cb236-10" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb236-11"><a aria-hidden="true" href="#cb236-11" tabindex="-1"></a>HeapTuple</span>
<span id="cb236-12"><a aria-hidden="true" href="#cb236-12" tabindex="-1"></a>SearchSysCache1<span class="op">(</span><span class="dt">int</span> cacheId<span class="op">,</span> Datum key1<span class="op">)</span></span>
<span id="cb236-13"><a aria-hidden="true" href="#cb236-13" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb236-14"><a aria-hidden="true" href="#cb236-14" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>cacheId <span class="op">&lt;</span> <span class="dv">0</span> <span class="op">||</span> cacheId <span class="op">&gt;=</span> SysCacheSize <span class="op">||</span></span>
<span id="cb236-15"><a aria-hidden="true" href="#cb236-15" tabindex="-1"></a>        <span class="op">!</span>PointerIsValid<span class="op">(</span>SysCache<span class="op">[</span>cacheId<span class="op">]))</span></span>
<span id="cb236-16"><a aria-hidden="true" href="#cb236-16" tabindex="-1"></a>        elog<span class="op">(</span>ERROR<span class="op">,</span> <span class="st">"invalid cache ID: </span><span class="sc">%d</span><span class="st">"</span><span class="op">,</span> cacheId<span class="op">);</span></span>
<span id="cb236-17"><a aria-hidden="true" href="#cb236-17" tabindex="-1"></a></span>
<span id="cb236-18"><a aria-hidden="true" href="#cb236-18" tabindex="-1"></a>    <span class="cf">return</span> SearchCatCache1<span class="op">(</span>SysCache<span class="op">[</span>cacheId<span class="op">],</span> key1<span class="op">);</span></span>
<span id="cb236-19"><a aria-hidden="true" href="#cb236-19" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb236-20"><a aria-hidden="true" href="#cb236-20" tabindex="-1"></a></span>
<span id="cb236-21"><a aria-hidden="true" href="#cb236-21" tabindex="-1"></a>HeapTuple</span>
<span id="cb236-22"><a aria-hidden="true" href="#cb236-22" tabindex="-1"></a>SearchSysCache2<span class="op">(</span><span class="dt">int</span> cacheId<span class="op">,</span> Datum key1<span class="op">,</span> Datum key2<span class="op">)</span></span>
<span id="cb236-23"><a aria-hidden="true" href="#cb236-23" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb236-24"><a aria-hidden="true" href="#cb236-24" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>cacheId <span class="op">&lt;</span> <span class="dv">0</span> <span class="op">||</span> cacheId <span class="op">&gt;=</span> SysCacheSize <span class="op">||</span></span>
<span id="cb236-25"><a aria-hidden="true" href="#cb236-25" tabindex="-1"></a>        <span class="op">!</span>PointerIsValid<span class="op">(</span>SysCache<span class="op">[</span>cacheId<span class="op">]))</span></span>
<span id="cb236-26"><a aria-hidden="true" href="#cb236-26" tabindex="-1"></a>        elog<span class="op">(</span>ERROR<span class="op">,</span> <span class="st">"invalid cache ID: </span><span class="sc">%d</span><span class="st">"</span><span class="op">,</span> cacheId<span class="op">);</span></span>
<span id="cb236-27"><a aria-hidden="true" href="#cb236-27" tabindex="-1"></a></span>
<span id="cb236-28"><a aria-hidden="true" href="#cb236-28" tabindex="-1"></a>    <span class="cf">return</span> SearchCatCache2<span class="op">(</span>SysCache<span class="op">[</span>cacheId<span class="op">],</span> key1<span class="op">,</span> key2<span class="op">);</span></span>
<span id="cb236-29"><a aria-hidden="true" href="#cb236-29" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb236-30"><a aria-hidden="true" href="#cb236-30" tabindex="-1"></a></span>
<span id="cb236-31"><a aria-hidden="true" href="#cb236-31" tabindex="-1"></a><span class="co">/* ... similar for SearchSysCache3, SearchSysCache4 ... */</span></span>
<span id="cb236-32"><a aria-hidden="true" href="#cb236-32" tabindex="-1"></a></span>
<span id="cb236-33"><a aria-hidden="true" href="#cb236-33" tabindex="-1"></a><span class="co">/*</span></span>
<span id="cb236-34"><a aria-hidden="true" href="#cb236-34" tabindex="-1"></a><span class="co"> * ReleaseSysCache</span></span>
<span id="cb236-35"><a aria-hidden="true" href="#cb236-35" tabindex="-1"></a><span class="co"> *    Release previously-fetched syscache tuple</span></span>
<span id="cb236-36"><a aria-hidden="true" href="#cb236-36" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb236-37"><a aria-hidden="true" href="#cb236-37" tabindex="-1"></a><span class="dt">void</span></span>
<span id="cb236-38"><a aria-hidden="true" href="#cb236-38" tabindex="-1"></a>ReleaseSysCache<span class="op">(</span>HeapTuple tuple<span class="op">)</span></span>
<span id="cb236-39"><a aria-hidden="true" href="#cb236-39" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb236-40"><a aria-hidden="true" href="#cb236-40" tabindex="-1"></a>    ReleaseCatCache<span class="op">(</span>tuple<span class="op">);</span></span>
<span id="cb236-41"><a aria-hidden="true" href="#cb236-41" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>Common Syscache IDs</strong>:</p>
<div class="sourceCode" id="cb237"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb237-1"><a aria-hidden="true" href="#cb237-1" tabindex="-1"></a><span class="pp">#define AGGFNOID        </span><span class="dv">0</span></span>
<span id="cb237-2"><a aria-hidden="true" href="#cb237-2" tabindex="-1"></a><span class="pp">#define AMNAME          </span><span class="dv">1</span></span>
<span id="cb237-3"><a aria-hidden="true" href="#cb237-3" tabindex="-1"></a><span class="pp">#define AMOID           </span><span class="dv">2</span></span>
<span id="cb237-4"><a aria-hidden="true" href="#cb237-4" tabindex="-1"></a><span class="pp">#define ATTNAME         </span><span class="dv">3</span></span>
<span id="cb237-5"><a aria-hidden="true" href="#cb237-5" tabindex="-1"></a><span class="pp">#define ATTNUM          </span><span class="dv">4</span></span>
<span id="cb237-6"><a aria-hidden="true" href="#cb237-6" tabindex="-1"></a><span class="pp">#define AUTHMEMMEMROLE  </span><span class="dv">5</span></span>
<span id="cb237-7"><a aria-hidden="true" href="#cb237-7" tabindex="-1"></a><span class="pp">#define AUTHMEMROLEMEM  </span><span class="dv">6</span></span>
<span id="cb237-8"><a aria-hidden="true" href="#cb237-8" tabindex="-1"></a><span class="pp">#define AUTHNAME        </span><span class="dv">7</span></span>
<span id="cb237-9"><a aria-hidden="true" href="#cb237-9" tabindex="-1"></a><span class="pp">#define AUTHOID         </span><span class="dv">8</span></span>
<span id="cb237-10"><a aria-hidden="true" href="#cb237-10" tabindex="-1"></a><span class="pp">#define CLAAMNAMENSP    </span><span class="dv">9</span></span>
<span id="cb237-11"><a aria-hidden="true" href="#cb237-11" tabindex="-1"></a><span class="pp">#define CLAOID          </span><span class="dv">10</span></span>
<span id="cb237-12"><a aria-hidden="true" href="#cb237-12" tabindex="-1"></a><span class="co">/* ... 90+ total cache IDs ... */</span></span>
<span id="cb237-13"><a aria-hidden="true" href="#cb237-13" tabindex="-1"></a><span class="pp">#define TYPEOID         </span><span class="dv">77</span></span>
<span id="cb237-14"><a aria-hidden="true" href="#cb237-14" tabindex="-1"></a><span class="pp">#define RELNAMENSP      </span><span class="dv">35</span></span>
<span id="cb237-15"><a aria-hidden="true" href="#cb237-15" tabindex="-1"></a><span class="pp">#define RELOID          </span><span class="dv">36</span></span></code></pre></div>
<p><strong>Usage Example</strong>:</p>
<div class="sourceCode" id="cb238"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb238-1"><a aria-hidden="true" href="#cb238-1" tabindex="-1"></a><span class="co">/* Look up a type by OID */</span></span>
<span id="cb238-2"><a aria-hidden="true" href="#cb238-2" tabindex="-1"></a>HeapTuple</span>
<span id="cb238-3"><a aria-hidden="true" href="#cb238-3" tabindex="-1"></a>get_type_tuple<span class="op">(</span>Oid typid<span class="op">)</span></span>
<span id="cb238-4"><a aria-hidden="true" href="#cb238-4" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb238-5"><a aria-hidden="true" href="#cb238-5" tabindex="-1"></a>    HeapTuple   tp<span class="op">;</span></span>
<span id="cb238-6"><a aria-hidden="true" href="#cb238-6" tabindex="-1"></a></span>
<span id="cb238-7"><a aria-hidden="true" href="#cb238-7" tabindex="-1"></a>    tp <span class="op">=</span> SearchSysCache1<span class="op">(</span>TYPEOID<span class="op">,</span> ObjectIdGetDatum<span class="op">(</span>typid<span class="op">));</span></span>
<span id="cb238-8"><a aria-hidden="true" href="#cb238-8" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(!</span>HeapTupleIsValid<span class="op">(</span>tp<span class="op">))</span></span>
<span id="cb238-9"><a aria-hidden="true" href="#cb238-9" tabindex="-1"></a>        elog<span class="op">(</span>ERROR<span class="op">,</span> <span class="st">"cache lookup failed for type </span><span class="sc">%u</span><span class="st">"</span><span class="op">,</span> typid<span class="op">);</span></span>
<span id="cb238-10"><a aria-hidden="true" href="#cb238-10" tabindex="-1"></a></span>
<span id="cb238-11"><a aria-hidden="true" href="#cb238-11" tabindex="-1"></a>    <span class="cf">return</span> tp<span class="op">;</span></span>
<span id="cb238-12"><a aria-hidden="true" href="#cb238-12" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 data-number="4.7.3" id="relcache"><span class="header-section-number">4.7.3</span> 6.3 Relcache</h3>
<p><strong>Location</strong>:
<code>/home/user/postgres/src/backend/utils/cache/relcache.c</code></p>
<p>The relation cache stores detailed information about relations
(tables, indexes):</p>
<div class="sourceCode" id="cb239"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb239-1"><a aria-hidden="true" href="#cb239-1" tabindex="-1"></a><span class="co">/*</span></span>
<span id="cb239-2"><a aria-hidden="true" href="#cb239-2" tabindex="-1"></a><span class="co"> * RelationIdGetRelation</span></span>
<span id="cb239-3"><a aria-hidden="true" href="#cb239-3" tabindex="-1"></a><span class="co"> *    Lookup a relation by OID.  This is a convenience routine that</span></span>
<span id="cb239-4"><a aria-hidden="true" href="#cb239-4" tabindex="-1"></a><span class="co"> *    opens the relation and returns a Relation pointer.</span></span>
<span id="cb239-5"><a aria-hidden="true" href="#cb239-5" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb239-6"><a aria-hidden="true" href="#cb239-6" tabindex="-1"></a>Relation</span>
<span id="cb239-7"><a aria-hidden="true" href="#cb239-7" tabindex="-1"></a>RelationIdGetRelation<span class="op">(</span>Oid relationId<span class="op">)</span></span>
<span id="cb239-8"><a aria-hidden="true" href="#cb239-8" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb239-9"><a aria-hidden="true" href="#cb239-9" tabindex="-1"></a>    Relation    rd<span class="op">;</span></span>
<span id="cb239-10"><a aria-hidden="true" href="#cb239-10" tabindex="-1"></a></span>
<span id="cb239-11"><a aria-hidden="true" href="#cb239-11" tabindex="-1"></a>    <span class="co">/* Check the relcache */</span></span>
<span id="cb239-12"><a aria-hidden="true" href="#cb239-12" tabindex="-1"></a>    RelationIdCacheLookup<span class="op">(</span>relationId<span class="op">,</span> rd<span class="op">);</span></span>
<span id="cb239-13"><a aria-hidden="true" href="#cb239-13" tabindex="-1"></a></span>
<span id="cb239-14"><a aria-hidden="true" href="#cb239-14" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>RelationIsValid<span class="op">(</span>rd<span class="op">))</span></span>
<span id="cb239-15"><a aria-hidden="true" href="#cb239-15" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb239-16"><a aria-hidden="true" href="#cb239-16" tabindex="-1"></a>        <span class="co">/* We have a cache hit - bump the refcount */</span></span>
<span id="cb239-17"><a aria-hidden="true" href="#cb239-17" tabindex="-1"></a>        RelationIncrementReferenceCount<span class="op">(</span>rd<span class="op">);</span></span>
<span id="cb239-18"><a aria-hidden="true" href="#cb239-18" tabindex="-1"></a>        <span class="cf">return</span> rd<span class="op">;</span></span>
<span id="cb239-19"><a aria-hidden="true" href="#cb239-19" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb239-20"><a aria-hidden="true" href="#cb239-20" tabindex="-1"></a></span>
<span id="cb239-21"><a aria-hidden="true" href="#cb239-21" tabindex="-1"></a>    <span class="co">/* No cache hit - need to load the relation descriptor */</span></span>
<span id="cb239-22"><a aria-hidden="true" href="#cb239-22" tabindex="-1"></a>    rd <span class="op">=</span> RelationBuildDesc<span class="op">(</span>relationId<span class="op">,</span> <span class="kw">true</span><span class="op">);</span></span>
<span id="cb239-23"><a aria-hidden="true" href="#cb239-23" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>RelationIsValid<span class="op">(</span>rd<span class="op">))</span></span>
<span id="cb239-24"><a aria-hidden="true" href="#cb239-24" tabindex="-1"></a>        RelationIncrementReferenceCount<span class="op">(</span>rd<span class="op">);</span></span>
<span id="cb239-25"><a aria-hidden="true" href="#cb239-25" tabindex="-1"></a></span>
<span id="cb239-26"><a aria-hidden="true" href="#cb239-26" tabindex="-1"></a>    <span class="cf">return</span> rd<span class="op">;</span></span>
<span id="cb239-27"><a aria-hidden="true" href="#cb239-27" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<hr/>
<h2 data-number="4.8" id="node-types-and-data-structures"><span class="header-section-number">4.8</span> 7. Node Types and Data
Structures</h2>
<p>PostgreSQL uses a type-tagged node system for all parse, plan, and
execution structures.</p>
<h3 data-number="4.8.1" id="query-node"><span class="header-section-number">4.8.1</span> 7.1 Query Node</h3>
<p><strong>Location</strong>:
<code>/home/user/postgres/src/include/nodes/parsenodes.h</code> (lines
116-200)</p>
<div class="sourceCode" id="cb240"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb240-1"><a aria-hidden="true" href="#cb240-1" tabindex="-1"></a><span class="co">/*</span></span>
<span id="cb240-2"><a aria-hidden="true" href="#cb240-2" tabindex="-1"></a><span class="co"> * Query -</span></span>
<span id="cb240-3"><a aria-hidden="true" href="#cb240-3" tabindex="-1"></a><span class="co"> *   Parse analysis turns all statements into a Query tree</span></span>
<span id="cb240-4"><a aria-hidden="true" href="#cb240-4" tabindex="-1"></a><span class="co"> *   for further processing by the rewriter and planner.</span></span>
<span id="cb240-5"><a aria-hidden="true" href="#cb240-5" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb240-6"><a aria-hidden="true" href="#cb240-6" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> Query</span>
<span id="cb240-7"><a aria-hidden="true" href="#cb240-7" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb240-8"><a aria-hidden="true" href="#cb240-8" tabindex="-1"></a>    NodeTag     type<span class="op">;</span></span>
<span id="cb240-9"><a aria-hidden="true" href="#cb240-9" tabindex="-1"></a></span>
<span id="cb240-10"><a aria-hidden="true" href="#cb240-10" tabindex="-1"></a>    CmdType     commandType<span class="op">;</span>    <span class="co">/* select|insert|update|delete|merge|utility */</span></span>
<span id="cb240-11"><a aria-hidden="true" href="#cb240-11" tabindex="-1"></a></span>
<span id="cb240-12"><a aria-hidden="true" href="#cb240-12" tabindex="-1"></a>    QuerySource querySource<span class="op">;</span>    <span class="co">/* where did I come from? */</span></span>
<span id="cb240-13"><a aria-hidden="true" href="#cb240-13" tabindex="-1"></a></span>
<span id="cb240-14"><a aria-hidden="true" href="#cb240-14" tabindex="-1"></a>    int64       queryId<span class="op">;</span>        <span class="co">/* query identifier */</span></span>
<span id="cb240-15"><a aria-hidden="true" href="#cb240-15" tabindex="-1"></a></span>
<span id="cb240-16"><a aria-hidden="true" href="#cb240-16" tabindex="-1"></a>    <span class="dt">bool</span>        canSetTag<span class="op">;</span>      <span class="co">/* do I set the command result tag? */</span></span>
<span id="cb240-17"><a aria-hidden="true" href="#cb240-17" tabindex="-1"></a></span>
<span id="cb240-18"><a aria-hidden="true" href="#cb240-18" tabindex="-1"></a>    Node       <span class="op">*</span>utilityStmt<span class="op">;</span>    <span class="co">/* non-null if commandType == CMD_UTILITY */</span></span>
<span id="cb240-19"><a aria-hidden="true" href="#cb240-19" tabindex="-1"></a></span>
<span id="cb240-20"><a aria-hidden="true" href="#cb240-20" tabindex="-1"></a>    <span class="dt">int</span>         resultRelation<span class="op">;</span> <span class="co">/* rtable index of target for INSERT/UPDATE/DELETE */</span></span>
<span id="cb240-21"><a aria-hidden="true" href="#cb240-21" tabindex="-1"></a></span>
<span id="cb240-22"><a aria-hidden="true" href="#cb240-22" tabindex="-1"></a>    <span class="co">/* Flags indicating presence of various constructs */</span></span>
<span id="cb240-23"><a aria-hidden="true" href="#cb240-23" tabindex="-1"></a>    <span class="dt">bool</span>        hasAggs<span class="op">;</span>        <span class="co">/* has aggregates in tlist or havingQual */</span></span>
<span id="cb240-24"><a aria-hidden="true" href="#cb240-24" tabindex="-1"></a>    <span class="dt">bool</span>        hasWindowFuncs<span class="op">;</span> <span class="co">/* has window functions in tlist */</span></span>
<span id="cb240-25"><a aria-hidden="true" href="#cb240-25" tabindex="-1"></a>    <span class="dt">bool</span>        hasTargetSRFs<span class="op">;</span>  <span class="co">/* has set-returning functions in tlist */</span></span>
<span id="cb240-26"><a aria-hidden="true" href="#cb240-26" tabindex="-1"></a>    <span class="dt">bool</span>        hasSubLinks<span class="op">;</span>    <span class="co">/* has subquery SubLink */</span></span>
<span id="cb240-27"><a aria-hidden="true" href="#cb240-27" tabindex="-1"></a>    <span class="dt">bool</span>        hasDistinctOn<span class="op">;</span>  <span class="co">/* distinctClause is from DISTINCT ON */</span></span>
<span id="cb240-28"><a aria-hidden="true" href="#cb240-28" tabindex="-1"></a>    <span class="dt">bool</span>        hasRecursive<span class="op">;</span>   <span class="co">/* WITH RECURSIVE was specified */</span></span>
<span id="cb240-29"><a aria-hidden="true" href="#cb240-29" tabindex="-1"></a>    <span class="dt">bool</span>        hasModifyingCTE<span class="op">;</span><span class="co">/* has INSERT/UPDATE/DELETE in WITH */</span></span>
<span id="cb240-30"><a aria-hidden="true" href="#cb240-30" tabindex="-1"></a>    <span class="dt">bool</span>        hasForUpdate<span class="op">;</span>   <span class="co">/* FOR [KEY] UPDATE/SHARE was specified */</span></span>
<span id="cb240-31"><a aria-hidden="true" href="#cb240-31" tabindex="-1"></a>    <span class="dt">bool</span>        hasRowSecurity<span class="op">;</span> <span class="co">/* rewriter has applied some RLS policy */</span></span>
<span id="cb240-32"><a aria-hidden="true" href="#cb240-32" tabindex="-1"></a></span>
<span id="cb240-33"><a aria-hidden="true" href="#cb240-33" tabindex="-1"></a>    List       <span class="op">*</span>cteList<span class="op">;</span>        <span class="co">/* WITH list (of CommonTableExpr's) */</span></span>
<span id="cb240-34"><a aria-hidden="true" href="#cb240-34" tabindex="-1"></a></span>
<span id="cb240-35"><a aria-hidden="true" href="#cb240-35" tabindex="-1"></a>    List       <span class="op">*</span>rtable<span class="op">;</span>         <span class="co">/* list of range table entries */</span></span>
<span id="cb240-36"><a aria-hidden="true" href="#cb240-36" tabindex="-1"></a>    List       <span class="op">*</span>rteperminfos<span class="op">;</span>   <span class="co">/* list of RTEPermissionInfo nodes */</span></span>
<span id="cb240-37"><a aria-hidden="true" href="#cb240-37" tabindex="-1"></a>    FromExpr   <span class="op">*</span>jointree<span class="op">;</span>       <span class="co">/* table join tree (FROM and WHERE clauses) */</span></span>
<span id="cb240-38"><a aria-hidden="true" href="#cb240-38" tabindex="-1"></a></span>
<span id="cb240-39"><a aria-hidden="true" href="#cb240-39" tabindex="-1"></a>    List       <span class="op">*</span>targetList<span class="op">;</span>     <span class="co">/* target list (of TargetEntry) */</span></span>
<span id="cb240-40"><a aria-hidden="true" href="#cb240-40" tabindex="-1"></a></span>
<span id="cb240-41"><a aria-hidden="true" href="#cb240-41" tabindex="-1"></a>    OverridingKind override<span class="op">;</span>    <span class="co">/* OVERRIDING clause */</span></span>
<span id="cb240-42"><a aria-hidden="true" href="#cb240-42" tabindex="-1"></a></span>
<span id="cb240-43"><a aria-hidden="true" href="#cb240-43" tabindex="-1"></a>    OnConflictExpr <span class="op">*</span>onConflict<span class="op">;</span> <span class="co">/* ON CONFLICT DO [NOTHING | UPDATE] */</span></span>
<span id="cb240-44"><a aria-hidden="true" href="#cb240-44" tabindex="-1"></a></span>
<span id="cb240-45"><a aria-hidden="true" href="#cb240-45" tabindex="-1"></a>    List       <span class="op">*</span>returningList<span class="op">;</span>  <span class="co">/* return-values list (of TargetEntry) */</span></span>
<span id="cb240-46"><a aria-hidden="true" href="#cb240-46" tabindex="-1"></a></span>
<span id="cb240-47"><a aria-hidden="true" href="#cb240-47" tabindex="-1"></a>    List       <span class="op">*</span>groupClause<span class="op">;</span>    <span class="co">/* a list of SortGroupClause's */</span></span>
<span id="cb240-48"><a aria-hidden="true" href="#cb240-48" tabindex="-1"></a>    <span class="dt">bool</span>        groupDistinct<span class="op">;</span>  <span class="co">/* is the group by clause distinct? */</span></span>
<span id="cb240-49"><a aria-hidden="true" href="#cb240-49" tabindex="-1"></a></span>
<span id="cb240-50"><a aria-hidden="true" href="#cb240-50" tabindex="-1"></a>    List       <span class="op">*</span>groupingSets<span class="op">;</span>   <span class="co">/* a list of GroupingSet's if present */</span></span>
<span id="cb240-51"><a aria-hidden="true" href="#cb240-51" tabindex="-1"></a></span>
<span id="cb240-52"><a aria-hidden="true" href="#cb240-52" tabindex="-1"></a>    Node       <span class="op">*</span>havingQual<span class="op">;</span>     <span class="co">/* qualifications applied to groups */</span></span>
<span id="cb240-53"><a aria-hidden="true" href="#cb240-53" tabindex="-1"></a></span>
<span id="cb240-54"><a aria-hidden="true" href="#cb240-54" tabindex="-1"></a>    List       <span class="op">*</span>windowClause<span class="op">;</span>   <span class="co">/* a list of WindowClause's */</span></span>
<span id="cb240-55"><a aria-hidden="true" href="#cb240-55" tabindex="-1"></a></span>
<span id="cb240-56"><a aria-hidden="true" href="#cb240-56" tabindex="-1"></a>    List       <span class="op">*</span>distinctClause<span class="op">;</span> <span class="co">/* a list of SortGroupClause's */</span></span>
<span id="cb240-57"><a aria-hidden="true" href="#cb240-57" tabindex="-1"></a></span>
<span id="cb240-58"><a aria-hidden="true" href="#cb240-58" tabindex="-1"></a>    List       <span class="op">*</span>sortClause<span class="op">;</span>     <span class="co">/* a list of SortGroupClause's */</span></span>
<span id="cb240-59"><a aria-hidden="true" href="#cb240-59" tabindex="-1"></a></span>
<span id="cb240-60"><a aria-hidden="true" href="#cb240-60" tabindex="-1"></a>    Node       <span class="op">*</span>limitOffset<span class="op">;</span>    <span class="co">/* # of result tuples to skip (int8 expr) */</span></span>
<span id="cb240-61"><a aria-hidden="true" href="#cb240-61" tabindex="-1"></a>    Node       <span class="op">*</span>limitCount<span class="op">;</span>     <span class="co">/* # of result tuples to return (int8 expr) */</span></span>
<span id="cb240-62"><a aria-hidden="true" href="#cb240-62" tabindex="-1"></a>    LimitOption limitOption<span class="op">;</span>    <span class="co">/* limit type */</span></span>
<span id="cb240-63"><a aria-hidden="true" href="#cb240-63" tabindex="-1"></a></span>
<span id="cb240-64"><a aria-hidden="true" href="#cb240-64" tabindex="-1"></a>    List       <span class="op">*</span>rowMarks<span class="op">;</span>       <span class="co">/* a list of RowMarkClause's */</span></span>
<span id="cb240-65"><a aria-hidden="true" href="#cb240-65" tabindex="-1"></a></span>
<span id="cb240-66"><a aria-hidden="true" href="#cb240-66" tabindex="-1"></a>    Node       <span class="op">*</span>setOperations<span class="op">;</span>  <span class="co">/* set-operation tree if this is top level of</span></span>
<span id="cb240-67"><a aria-hidden="true" href="#cb240-67" tabindex="-1"></a><span class="co">                                 * a UNION/INTERSECT/EXCEPT query */</span></span>
<span id="cb240-68"><a aria-hidden="true" href="#cb240-68" tabindex="-1"></a></span>
<span id="cb240-69"><a aria-hidden="true" href="#cb240-69" tabindex="-1"></a>    List       <span class="op">*</span>constraintDeps<span class="op">;</span> <span class="co">/* a list of pg_constraint OIDs */</span></span>
<span id="cb240-70"><a aria-hidden="true" href="#cb240-70" tabindex="-1"></a></span>
<span id="cb240-71"><a aria-hidden="true" href="#cb240-71" tabindex="-1"></a>    List       <span class="op">*</span>withCheckOptions<span class="op">;</span>   <span class="co">/* a list of WithCheckOption's */</span></span>
<span id="cb240-72"><a aria-hidden="true" href="#cb240-72" tabindex="-1"></a></span>
<span id="cb240-73"><a aria-hidden="true" href="#cb240-73" tabindex="-1"></a>    <span class="dt">int</span>         stmt_location<span class="op">;</span>  <span class="co">/* start location, or -1 if unknown */</span></span>
<span id="cb240-74"><a aria-hidden="true" href="#cb240-74" tabindex="-1"></a>    <span class="dt">int</span>         stmt_len<span class="op">;</span>       <span class="co">/* length in bytes; 0 means "rest of string" */</span></span>
<span id="cb240-75"><a aria-hidden="true" href="#cb240-75" tabindex="-1"></a><span class="op">}</span> Query<span class="op">;</span></span></code></pre></div>
<h3 data-number="4.8.2" id="plan-node"><span class="header-section-number">4.8.2</span> 7.2 Plan Node</h3>
<p><strong>Location</strong>:
<code>/home/user/postgres/src/include/nodes/plannodes.h</code> (lines
184-220)</p>
<div class="sourceCode" id="cb241"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb241-1"><a aria-hidden="true" href="#cb241-1" tabindex="-1"></a><span class="co">/*</span></span>
<span id="cb241-2"><a aria-hidden="true" href="#cb241-2" tabindex="-1"></a><span class="co"> * Plan node</span></span>
<span id="cb241-3"><a aria-hidden="true" href="#cb241-3" tabindex="-1"></a><span class="co"> *</span></span>
<span id="cb241-4"><a aria-hidden="true" href="#cb241-4" tabindex="-1"></a><span class="co"> * All plan nodes "derive" from the Plan structure by having the</span></span>
<span id="cb241-5"><a aria-hidden="true" href="#cb241-5" tabindex="-1"></a><span class="co"> * Plan structure as the first field.</span></span>
<span id="cb241-6"><a aria-hidden="true" href="#cb241-6" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb241-7"><a aria-hidden="true" href="#cb241-7" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> Plan</span>
<span id="cb241-8"><a aria-hidden="true" href="#cb241-8" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb241-9"><a aria-hidden="true" href="#cb241-9" tabindex="-1"></a>    NodeTag     type<span class="op">;</span></span>
<span id="cb241-10"><a aria-hidden="true" href="#cb241-10" tabindex="-1"></a></span>
<span id="cb241-11"><a aria-hidden="true" href="#cb241-11" tabindex="-1"></a>    <span class="co">/*</span></span>
<span id="cb241-12"><a aria-hidden="true" href="#cb241-12" tabindex="-1"></a><span class="co">     * Estimated execution costs for plan (see costsize.c for more info)</span></span>
<span id="cb241-13"><a aria-hidden="true" href="#cb241-13" tabindex="-1"></a><span class="co">     */</span></span>
<span id="cb241-14"><a aria-hidden="true" href="#cb241-14" tabindex="-1"></a>    <span class="dt">int</span>         disabled_nodes<span class="op">;</span> <span class="co">/* count of disabled nodes */</span></span>
<span id="cb241-15"><a aria-hidden="true" href="#cb241-15" tabindex="-1"></a>    Cost        startup_cost<span class="op">;</span>   <span class="co">/* cost expended before fetching any tuples */</span></span>
<span id="cb241-16"><a aria-hidden="true" href="#cb241-16" tabindex="-1"></a>    Cost        total_cost<span class="op">;</span>     <span class="co">/* total cost (assuming all tuples fetched) */</span></span>
<span id="cb241-17"><a aria-hidden="true" href="#cb241-17" tabindex="-1"></a></span>
<span id="cb241-18"><a aria-hidden="true" href="#cb241-18" tabindex="-1"></a>    <span class="co">/*</span></span>
<span id="cb241-19"><a aria-hidden="true" href="#cb241-19" tabindex="-1"></a><span class="co">     * Planner's estimate of result size</span></span>
<span id="cb241-20"><a aria-hidden="true" href="#cb241-20" tabindex="-1"></a><span class="co">     */</span></span>
<span id="cb241-21"><a aria-hidden="true" href="#cb241-21" tabindex="-1"></a>    <span class="dt">double</span>      plan_rows<span class="op">;</span>      <span class="co">/* number of rows plan is expected to emit */</span></span>
<span id="cb241-22"><a aria-hidden="true" href="#cb241-22" tabindex="-1"></a>    <span class="dt">int</span>         plan_width<span class="op">;</span>     <span class="co">/* average row width in bytes */</span></span>
<span id="cb241-23"><a aria-hidden="true" href="#cb241-23" tabindex="-1"></a></span>
<span id="cb241-24"><a aria-hidden="true" href="#cb241-24" tabindex="-1"></a>    <span class="co">/*</span></span>
<span id="cb241-25"><a aria-hidden="true" href="#cb241-25" tabindex="-1"></a><span class="co">     * Information for parallel query</span></span>
<span id="cb241-26"><a aria-hidden="true" href="#cb241-26" tabindex="-1"></a><span class="co">     */</span></span>
<span id="cb241-27"><a aria-hidden="true" href="#cb241-27" tabindex="-1"></a>    <span class="dt">bool</span>        parallel_aware<span class="op">;</span> <span class="co">/* engage parallel-aware logic? */</span></span>
<span id="cb241-28"><a aria-hidden="true" href="#cb241-28" tabindex="-1"></a>    <span class="dt">bool</span>        parallel_safe<span class="op">;</span>  <span class="co">/* OK to use as part of parallel plan? */</span></span>
<span id="cb241-29"><a aria-hidden="true" href="#cb241-29" tabindex="-1"></a></span>
<span id="cb241-30"><a aria-hidden="true" href="#cb241-30" tabindex="-1"></a>    <span class="co">/*</span></span>
<span id="cb241-31"><a aria-hidden="true" href="#cb241-31" tabindex="-1"></a><span class="co">     * Common structural data for all Plan types.</span></span>
<span id="cb241-32"><a aria-hidden="true" href="#cb241-32" tabindex="-1"></a><span class="co">     */</span></span>
<span id="cb241-33"><a aria-hidden="true" href="#cb241-33" tabindex="-1"></a>    <span class="dt">int</span>         plan_node_id<span class="op">;</span>   <span class="co">/* unique across entire final plan tree */</span></span>
<span id="cb241-34"><a aria-hidden="true" href="#cb241-34" tabindex="-1"></a>    List       <span class="op">*</span>targetlist<span class="op">;</span>     <span class="co">/* target list to be computed at this node */</span></span>
<span id="cb241-35"><a aria-hidden="true" href="#cb241-35" tabindex="-1"></a>    List       <span class="op">*</span>qual<span class="op">;</span>           <span class="co">/* implicitly-ANDed qual conditions */</span></span>
<span id="cb241-36"><a aria-hidden="true" href="#cb241-36" tabindex="-1"></a>    <span class="kw">struct</span> Plan <span class="op">*</span>lefttree<span class="op">;</span>      <span class="co">/* input plan tree(s) */</span></span>
<span id="cb241-37"><a aria-hidden="true" href="#cb241-37" tabindex="-1"></a>    <span class="kw">struct</span> Plan <span class="op">*</span>righttree<span class="op">;</span></span>
<span id="cb241-38"><a aria-hidden="true" href="#cb241-38" tabindex="-1"></a>    List       <span class="op">*</span>initPlan<span class="op">;</span>       <span class="co">/* Init SubPlan nodes (un-correlated expr subselects) */</span></span>
<span id="cb241-39"><a aria-hidden="true" href="#cb241-39" tabindex="-1"></a></span>
<span id="cb241-40"><a aria-hidden="true" href="#cb241-40" tabindex="-1"></a>    <span class="co">/*</span></span>
<span id="cb241-41"><a aria-hidden="true" href="#cb241-41" tabindex="-1"></a><span class="co">     * Information for management of parameter-change-driven rescanning</span></span>
<span id="cb241-42"><a aria-hidden="true" href="#cb241-42" tabindex="-1"></a><span class="co">     */</span></span>
<span id="cb241-43"><a aria-hidden="true" href="#cb241-43" tabindex="-1"></a>    Bitmapset  <span class="op">*</span>extParam<span class="op">;</span>       <span class="co">/* indices of _all_ ext params in plan */</span></span>
<span id="cb241-44"><a aria-hidden="true" href="#cb241-44" tabindex="-1"></a>    Bitmapset  <span class="op">*</span>allParam<span class="op">;</span>       <span class="co">/* indices of all ext+exec params in plan */</span></span>
<span id="cb241-45"><a aria-hidden="true" href="#cb241-45" tabindex="-1"></a><span class="op">}</span> Plan<span class="op">;</span></span></code></pre></div>
<h3 data-number="4.8.3" id="planstate-node"><span class="header-section-number">4.8.3</span> 7.3 PlanState Node</h3>
<p><strong>Location</strong>:
<code>/home/user/postgres/src/include/nodes/execnodes.h</code> (lines
1095-1150)</p>
<div class="sourceCode" id="cb242"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb242-1"><a aria-hidden="true" href="#cb242-1" tabindex="-1"></a><span class="co">/* ----------------</span></span>
<span id="cb242-2"><a aria-hidden="true" href="#cb242-2" tabindex="-1"></a><span class="co"> *  PlanState node</span></span>
<span id="cb242-3"><a aria-hidden="true" href="#cb242-3" tabindex="-1"></a><span class="co"> *</span></span>
<span id="cb242-4"><a aria-hidden="true" href="#cb242-4" tabindex="-1"></a><span class="co"> * We never actually instantiate any PlanState nodes; this is just the common</span></span>
<span id="cb242-5"><a aria-hidden="true" href="#cb242-5" tabindex="-1"></a><span class="co"> * abstract superclass for all PlanState-type nodes.</span></span>
<span id="cb242-6"><a aria-hidden="true" href="#cb242-6" tabindex="-1"></a><span class="co"> * ----------------</span></span>
<span id="cb242-7"><a aria-hidden="true" href="#cb242-7" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb242-8"><a aria-hidden="true" href="#cb242-8" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> PlanState</span>
<span id="cb242-9"><a aria-hidden="true" href="#cb242-9" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb242-10"><a aria-hidden="true" href="#cb242-10" tabindex="-1"></a>    NodeTag     type<span class="op">;</span></span>
<span id="cb242-11"><a aria-hidden="true" href="#cb242-11" tabindex="-1"></a></span>
<span id="cb242-12"><a aria-hidden="true" href="#cb242-12" tabindex="-1"></a>    Plan       <span class="op">*</span>plan<span class="op">;</span>           <span class="co">/* associated Plan node */</span></span>
<span id="cb242-13"><a aria-hidden="true" href="#cb242-13" tabindex="-1"></a></span>
<span id="cb242-14"><a aria-hidden="true" href="#cb242-14" tabindex="-1"></a>    EState     <span class="op">*</span>state<span class="op">;</span>          <span class="co">/* executor state node */</span></span>
<span id="cb242-15"><a aria-hidden="true" href="#cb242-15" tabindex="-1"></a></span>
<span id="cb242-16"><a aria-hidden="true" href="#cb242-16" tabindex="-1"></a>    ExecProcNodeMtd ExecProcNode<span class="op">;</span>   <span class="co">/* function to fetch next tuple */</span></span>
<span id="cb242-17"><a aria-hidden="true" href="#cb242-17" tabindex="-1"></a>    ExecProcNodeMtd ExecProcNodeReal<span class="op">;</span></span>
<span id="cb242-18"><a aria-hidden="true" href="#cb242-18" tabindex="-1"></a></span>
<span id="cb242-19"><a aria-hidden="true" href="#cb242-19" tabindex="-1"></a>    Instrumentation <span class="op">*</span>instrument<span class="op">;</span>    <span class="co">/* Optional runtime stats for this node */</span></span>
<span id="cb242-20"><a aria-hidden="true" href="#cb242-20" tabindex="-1"></a>    WorkerInstrumentation <span class="op">*</span>worker_instrument<span class="op">;</span>   <span class="co">/* per-worker instrumentation */</span></span>
<span id="cb242-21"><a aria-hidden="true" href="#cb242-21" tabindex="-1"></a></span>
<span id="cb242-22"><a aria-hidden="true" href="#cb242-22" tabindex="-1"></a>    <span class="co">/* Per-worker JIT instrumentation */</span></span>
<span id="cb242-23"><a aria-hidden="true" href="#cb242-23" tabindex="-1"></a>    <span class="kw">struct</span> SharedJitInstrumentation <span class="op">*</span>worker_jit_instrument<span class="op">;</span></span>
<span id="cb242-24"><a aria-hidden="true" href="#cb242-24" tabindex="-1"></a></span>
<span id="cb242-25"><a aria-hidden="true" href="#cb242-25" tabindex="-1"></a>    <span class="co">/* Identify node for EXPLAIN */</span></span>
<span id="cb242-26"><a aria-hidden="true" href="#cb242-26" tabindex="-1"></a>    <span class="dt">char</span>       <span class="op">*</span>nodename<span class="op">;</span></span>
<span id="cb242-27"><a aria-hidden="true" href="#cb242-27" tabindex="-1"></a></span>
<span id="cb242-28"><a aria-hidden="true" href="#cb242-28" tabindex="-1"></a>    <span class="co">/*</span></span>
<span id="cb242-29"><a aria-hidden="true" href="#cb242-29" tabindex="-1"></a><span class="co">     * Common structural data for all Plan types.</span></span>
<span id="cb242-30"><a aria-hidden="true" href="#cb242-30" tabindex="-1"></a><span class="co">     */</span></span>
<span id="cb242-31"><a aria-hidden="true" href="#cb242-31" tabindex="-1"></a>    ExprState  <span class="op">*</span>qual<span class="op">;</span>           <span class="co">/* boolean qual condition */</span></span>
<span id="cb242-32"><a aria-hidden="true" href="#cb242-32" tabindex="-1"></a>    <span class="kw">struct</span> PlanState <span class="op">*</span>lefttree<span class="op">;</span> <span class="co">/* input plan tree(s) */</span></span>
<span id="cb242-33"><a aria-hidden="true" href="#cb242-33" tabindex="-1"></a>    <span class="kw">struct</span> PlanState <span class="op">*</span>righttree<span class="op">;</span></span>
<span id="cb242-34"><a aria-hidden="true" href="#cb242-34" tabindex="-1"></a></span>
<span id="cb242-35"><a aria-hidden="true" href="#cb242-35" tabindex="-1"></a>    List       <span class="op">*</span>initPlan<span class="op">;</span>       <span class="co">/* Init SubPlanState nodes */</span></span>
<span id="cb242-36"><a aria-hidden="true" href="#cb242-36" tabindex="-1"></a></span>
<span id="cb242-37"><a aria-hidden="true" href="#cb242-37" tabindex="-1"></a>    List       <span class="op">*</span>subPlan<span class="op">;</span>        <span class="co">/* SubPlanState nodes in my expressions */</span></span>
<span id="cb242-38"><a aria-hidden="true" href="#cb242-38" tabindex="-1"></a></span>
<span id="cb242-39"><a aria-hidden="true" href="#cb242-39" tabindex="-1"></a>    <span class="co">/*</span></span>
<span id="cb242-40"><a aria-hidden="true" href="#cb242-40" tabindex="-1"></a><span class="co">     * State for management of parameter-change-driven rescanning</span></span>
<span id="cb242-41"><a aria-hidden="true" href="#cb242-41" tabindex="-1"></a><span class="co">     */</span></span>
<span id="cb242-42"><a aria-hidden="true" href="#cb242-42" tabindex="-1"></a>    Bitmapset  <span class="op">*</span>chgParam<span class="op">;</span>       <span class="co">/* set of IDs of changed Params */</span></span>
<span id="cb242-43"><a aria-hidden="true" href="#cb242-43" tabindex="-1"></a></span>
<span id="cb242-44"><a aria-hidden="true" href="#cb242-44" tabindex="-1"></a>    <span class="co">/*</span></span>
<span id="cb242-45"><a aria-hidden="true" href="#cb242-45" tabindex="-1"></a><span class="co">     * Tuple table for this plan node</span></span>
<span id="cb242-46"><a aria-hidden="true" href="#cb242-46" tabindex="-1"></a><span class="co">     */</span></span>
<span id="cb242-47"><a aria-hidden="true" href="#cb242-47" tabindex="-1"></a>    TupleTableSlot <span class="op">*</span>ps_ResultTupleSlot<span class="op">;</span></span>
<span id="cb242-48"><a aria-hidden="true" href="#cb242-48" tabindex="-1"></a></span>
<span id="cb242-49"><a aria-hidden="true" href="#cb242-49" tabindex="-1"></a>    <span class="co">/*</span></span>
<span id="cb242-50"><a aria-hidden="true" href="#cb242-50" tabindex="-1"></a><span class="co">     * Tuple descriptor for the result tuples</span></span>
<span id="cb242-51"><a aria-hidden="true" href="#cb242-51" tabindex="-1"></a><span class="co">     */</span></span>
<span id="cb242-52"><a aria-hidden="true" href="#cb242-52" tabindex="-1"></a>    TupleDesc   ps_ResultTupleDesc<span class="op">;</span></span>
<span id="cb242-53"><a aria-hidden="true" href="#cb242-53" tabindex="-1"></a></span>
<span id="cb242-54"><a aria-hidden="true" href="#cb242-54" tabindex="-1"></a>    <span class="co">/* Slot for storing projection result */</span></span>
<span id="cb242-55"><a aria-hidden="true" href="#cb242-55" tabindex="-1"></a>    TupleTableSlot <span class="op">*</span>ps_ProjInfo<span class="op">;</span></span>
<span id="cb242-56"><a aria-hidden="true" href="#cb242-56" tabindex="-1"></a></span>
<span id="cb242-57"><a aria-hidden="true" href="#cb242-57" tabindex="-1"></a>    <span class="co">/*</span></span>
<span id="cb242-58"><a aria-hidden="true" href="#cb242-58" tabindex="-1"></a><span class="co">     * Node's current tuple, if it's a scan node</span></span>
<span id="cb242-59"><a aria-hidden="true" href="#cb242-59" tabindex="-1"></a><span class="co">     */</span></span>
<span id="cb242-60"><a aria-hidden="true" href="#cb242-60" tabindex="-1"></a>    <span class="dt">bool</span>        scandesc_created<span class="op">;</span>   <span class="co">/* scanstate has created scan descriptor */</span></span>
<span id="cb242-61"><a aria-hidden="true" href="#cb242-61" tabindex="-1"></a>    <span class="dt">bool</span>        scanops_inited<span class="op">;</span>     <span class="co">/* scanops have been inited */</span></span>
<span id="cb242-62"><a aria-hidden="true" href="#cb242-62" tabindex="-1"></a><span class="op">}</span> PlanState<span class="op">;</span></span></code></pre></div>
<h3 data-number="4.8.4" id="specialized-plan-nodes"><span class="header-section-number">4.8.4</span> 7.4 Specialized Plan
Nodes</h3>
<p><strong>Sequential Scan</strong>:</p>
<div class="sourceCode" id="cb243"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb243-1"><a aria-hidden="true" href="#cb243-1" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> SeqScan</span>
<span id="cb243-2"><a aria-hidden="true" href="#cb243-2" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb243-3"><a aria-hidden="true" href="#cb243-3" tabindex="-1"></a>    Scan        scan<span class="op">;</span></span>
<span id="cb243-4"><a aria-hidden="true" href="#cb243-4" tabindex="-1"></a><span class="op">}</span> SeqScan<span class="op">;</span></span></code></pre></div>
<p><strong>Index Scan</strong>:</p>
<div class="sourceCode" id="cb244"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb244-1"><a aria-hidden="true" href="#cb244-1" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> IndexScan</span>
<span id="cb244-2"><a aria-hidden="true" href="#cb244-2" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb244-3"><a aria-hidden="true" href="#cb244-3" tabindex="-1"></a>    Scan        scan<span class="op">;</span></span>
<span id="cb244-4"><a aria-hidden="true" href="#cb244-4" tabindex="-1"></a>    Oid         indexid<span class="op">;</span>        <span class="co">/* OID of index to scan */</span></span>
<span id="cb244-5"><a aria-hidden="true" href="#cb244-5" tabindex="-1"></a>    List       <span class="op">*</span>indexqual<span class="op">;</span>      <span class="co">/* list of index quals (usually OpExprs) */</span></span>
<span id="cb244-6"><a aria-hidden="true" href="#cb244-6" tabindex="-1"></a>    List       <span class="op">*</span>indexqualorig<span class="op">;</span>  <span class="co">/* the same in original form */</span></span>
<span id="cb244-7"><a aria-hidden="true" href="#cb244-7" tabindex="-1"></a>    List       <span class="op">*</span>indexorderby<span class="op">;</span>   <span class="co">/* list of index ORDER BY exprs */</span></span>
<span id="cb244-8"><a aria-hidden="true" href="#cb244-8" tabindex="-1"></a>    List       <span class="op">*</span>indexorderbyorig<span class="op">;</span></span>
<span id="cb244-9"><a aria-hidden="true" href="#cb244-9" tabindex="-1"></a>    List       <span class="op">*</span>indexorderbyops<span class="op">;</span><span class="co">/* OIDs of sort ops for ORDER BY exprs */</span></span>
<span id="cb244-10"><a aria-hidden="true" href="#cb244-10" tabindex="-1"></a>    ScanDirection indexorderdir<span class="op">;</span><span class="co">/* forward or backward */</span></span>
<span id="cb244-11"><a aria-hidden="true" href="#cb244-11" tabindex="-1"></a><span class="op">}</span> IndexScan<span class="op">;</span></span></code></pre></div>
<p><strong>Nested Loop Join</strong>:</p>
<div class="sourceCode" id="cb245"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb245-1"><a aria-hidden="true" href="#cb245-1" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> NestLoop</span>
<span id="cb245-2"><a aria-hidden="true" href="#cb245-2" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb245-3"><a aria-hidden="true" href="#cb245-3" tabindex="-1"></a>    Join        join<span class="op">;</span></span>
<span id="cb245-4"><a aria-hidden="true" href="#cb245-4" tabindex="-1"></a>    List       <span class="op">*</span>nestParams<span class="op">;</span>     <span class="co">/* list of NestLoopParam nodes */</span></span>
<span id="cb245-5"><a aria-hidden="true" href="#cb245-5" tabindex="-1"></a><span class="op">}</span> NestLoop<span class="op">;</span></span>
<span id="cb245-6"><a aria-hidden="true" href="#cb245-6" tabindex="-1"></a></span>
<span id="cb245-7"><a aria-hidden="true" href="#cb245-7" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> NestLoopParam</span>
<span id="cb245-8"><a aria-hidden="true" href="#cb245-8" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb245-9"><a aria-hidden="true" href="#cb245-9" tabindex="-1"></a>    NodeTag     type<span class="op">;</span></span>
<span id="cb245-10"><a aria-hidden="true" href="#cb245-10" tabindex="-1"></a>    <span class="dt">int</span>         paramno<span class="op">;</span>        <span class="co">/* number of the PARAM_EXEC Param to set */</span></span>
<span id="cb245-11"><a aria-hidden="true" href="#cb245-11" tabindex="-1"></a>    Var        <span class="op">*</span>paramval<span class="op">;</span>       <span class="co">/* outer-relation Var to assign to Param */</span></span>
<span id="cb245-12"><a aria-hidden="true" href="#cb245-12" tabindex="-1"></a><span class="op">}</span> NestLoopParam<span class="op">;</span></span></code></pre></div>
<hr/>
<h2 data-number="4.9" id="join-algorithms"><span class="header-section-number">4.9</span> 8. Join Algorithms</h2>
<p>PostgreSQL implements three fundamental join algorithms, each optimal
for different scenarios.</p>
<h3 data-number="4.9.1" id="nested-loop-join"><span class="header-section-number">4.9.1</span> 8.1 Nested Loop Join</h3>
<p><strong>Best for</strong>: Small inner relation, or when join has
very high selectivity</p>
<p><strong>Algorithm</strong>:</p>
<pre><code>For each row R in outer relation:
    For each row S in inner relation:
        If join_condition(R, S):
            Output combined row</code></pre>
<p><strong>Implementation</strong>:
<code>/home/user/postgres/src/backend/executor/nodeNestloop.c</code></p>
<div class="sourceCode" id="cb247"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb247-1"><a aria-hidden="true" href="#cb247-1" tabindex="-1"></a><span class="co">/* ----------------------------------------------------------------</span></span>
<span id="cb247-2"><a aria-hidden="true" href="#cb247-2" tabindex="-1"></a><span class="co"> *   ExecNestLoop(node)</span></span>
<span id="cb247-3"><a aria-hidden="true" href="#cb247-3" tabindex="-1"></a><span class="co"> *</span></span>
<span id="cb247-4"><a aria-hidden="true" href="#cb247-4" tabindex="-1"></a><span class="co"> * Returns a tuple from nested loop join or NULL if done.</span></span>
<span id="cb247-5"><a aria-hidden="true" href="#cb247-5" tabindex="-1"></a><span class="co"> * ----------------------------------------------------------------</span></span>
<span id="cb247-6"><a aria-hidden="true" href="#cb247-6" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb247-7"><a aria-hidden="true" href="#cb247-7" tabindex="-1"></a><span class="dt">static</span> TupleTableSlot <span class="op">*</span></span>
<span id="cb247-8"><a aria-hidden="true" href="#cb247-8" tabindex="-1"></a>ExecNestLoop<span class="op">(</span>PlanState <span class="op">*</span>pstate<span class="op">)</span></span>
<span id="cb247-9"><a aria-hidden="true" href="#cb247-9" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb247-10"><a aria-hidden="true" href="#cb247-10" tabindex="-1"></a>    NestLoopState <span class="op">*</span>node <span class="op">=</span> castNode<span class="op">(</span>NestLoopState<span class="op">,</span> pstate<span class="op">);</span></span>
<span id="cb247-11"><a aria-hidden="true" href="#cb247-11" tabindex="-1"></a>    NestLoop   <span class="op">*</span>nl<span class="op">;</span></span>
<span id="cb247-12"><a aria-hidden="true" href="#cb247-12" tabindex="-1"></a>    PlanState  <span class="op">*</span>innerPlan<span class="op">;</span></span>
<span id="cb247-13"><a aria-hidden="true" href="#cb247-13" tabindex="-1"></a>    PlanState  <span class="op">*</span>outerPlan<span class="op">;</span></span>
<span id="cb247-14"><a aria-hidden="true" href="#cb247-14" tabindex="-1"></a>    TupleTableSlot <span class="op">*</span>outerTupleSlot<span class="op">;</span></span>
<span id="cb247-15"><a aria-hidden="true" href="#cb247-15" tabindex="-1"></a>    TupleTableSlot <span class="op">*</span>innerTupleSlot<span class="op">;</span></span>
<span id="cb247-16"><a aria-hidden="true" href="#cb247-16" tabindex="-1"></a>    ExprState  <span class="op">*</span>joinqual<span class="op">;</span></span>
<span id="cb247-17"><a aria-hidden="true" href="#cb247-17" tabindex="-1"></a>    ExprState  <span class="op">*</span>otherqual<span class="op">;</span></span>
<span id="cb247-18"><a aria-hidden="true" href="#cb247-18" tabindex="-1"></a>    ExprContext <span class="op">*</span>econtext<span class="op">;</span></span>
<span id="cb247-19"><a aria-hidden="true" href="#cb247-19" tabindex="-1"></a>    ListCell   <span class="op">*</span>lc<span class="op">;</span></span>
<span id="cb247-20"><a aria-hidden="true" href="#cb247-20" tabindex="-1"></a></span>
<span id="cb247-21"><a aria-hidden="true" href="#cb247-21" tabindex="-1"></a>    <span class="co">/* Get information from the node */</span></span>
<span id="cb247-22"><a aria-hidden="true" href="#cb247-22" tabindex="-1"></a>    nl <span class="op">=</span> <span class="op">(</span>NestLoop <span class="op">*)</span> node<span class="op">-&gt;</span>js<span class="op">.</span>ps<span class="op">.</span>plan<span class="op">;</span></span>
<span id="cb247-23"><a aria-hidden="true" href="#cb247-23" tabindex="-1"></a>    joinqual <span class="op">=</span> node<span class="op">-&gt;</span>js<span class="op">.</span>joinqual<span class="op">;</span></span>
<span id="cb247-24"><a aria-hidden="true" href="#cb247-24" tabindex="-1"></a>    otherqual <span class="op">=</span> node<span class="op">-&gt;</span>js<span class="op">.</span>ps<span class="op">.</span>qual<span class="op">;</span></span>
<span id="cb247-25"><a aria-hidden="true" href="#cb247-25" tabindex="-1"></a>    outerPlan <span class="op">=</span> outerPlanState<span class="op">(</span>node<span class="op">);</span></span>
<span id="cb247-26"><a aria-hidden="true" href="#cb247-26" tabindex="-1"></a>    innerPlan <span class="op">=</span> innerPlanState<span class="op">(</span>node<span class="op">);</span></span>
<span id="cb247-27"><a aria-hidden="true" href="#cb247-27" tabindex="-1"></a>    econtext <span class="op">=</span> node<span class="op">-&gt;</span>js<span class="op">.</span>ps<span class="op">.</span>ps_ExprContext<span class="op">;</span></span>
<span id="cb247-28"><a aria-hidden="true" href="#cb247-28" tabindex="-1"></a></span>
<span id="cb247-29"><a aria-hidden="true" href="#cb247-29" tabindex="-1"></a>    <span class="co">/* Reset per-tuple memory context to free expression results */</span></span>
<span id="cb247-30"><a aria-hidden="true" href="#cb247-30" tabindex="-1"></a>    ResetExprContext<span class="op">(</span>econtext<span class="op">);</span></span>
<span id="cb247-31"><a aria-hidden="true" href="#cb247-31" tabindex="-1"></a></span>
<span id="cb247-32"><a aria-hidden="true" href="#cb247-32" tabindex="-1"></a>    <span class="co">/*</span></span>
<span id="cb247-33"><a aria-hidden="true" href="#cb247-33" tabindex="-1"></a><span class="co">     * If we don't have an outer tuple, get the next one</span></span>
<span id="cb247-34"><a aria-hidden="true" href="#cb247-34" tabindex="-1"></a><span class="co">     */</span></span>
<span id="cb247-35"><a aria-hidden="true" href="#cb247-35" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>node<span class="op">-&gt;</span>nl_NeedNewOuter<span class="op">)</span></span>
<span id="cb247-36"><a aria-hidden="true" href="#cb247-36" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb247-37"><a aria-hidden="true" href="#cb247-37" tabindex="-1"></a>        outerTupleSlot <span class="op">=</span> ExecProcNode<span class="op">(</span>outerPlan<span class="op">);</span></span>
<span id="cb247-38"><a aria-hidden="true" href="#cb247-38" tabindex="-1"></a></span>
<span id="cb247-39"><a aria-hidden="true" href="#cb247-39" tabindex="-1"></a>        <span class="co">/* No more outer tuples means we're done */</span></span>
<span id="cb247-40"><a aria-hidden="true" href="#cb247-40" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>TupIsNull<span class="op">(</span>outerTupleSlot<span class="op">))</span></span>
<span id="cb247-41"><a aria-hidden="true" href="#cb247-41" tabindex="-1"></a>            <span class="cf">return</span> NULL<span class="op">;</span></span>
<span id="cb247-42"><a aria-hidden="true" href="#cb247-42" tabindex="-1"></a></span>
<span id="cb247-43"><a aria-hidden="true" href="#cb247-43" tabindex="-1"></a>        econtext<span class="op">-&gt;</span>ecxt_outertuple <span class="op">=</span> outerTupleSlot<span class="op">;</span></span>
<span id="cb247-44"><a aria-hidden="true" href="#cb247-44" tabindex="-1"></a>        node<span class="op">-&gt;</span>nl_NeedNewOuter <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb247-45"><a aria-hidden="true" href="#cb247-45" tabindex="-1"></a>        node<span class="op">-&gt;</span>nl_MatchedOuter <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb247-46"><a aria-hidden="true" href="#cb247-46" tabindex="-1"></a></span>
<span id="cb247-47"><a aria-hidden="true" href="#cb247-47" tabindex="-1"></a>        <span class="co">/*</span></span>
<span id="cb247-48"><a aria-hidden="true" href="#cb247-48" tabindex="-1"></a><span class="co">         * Set nestloop parameters from outer tuple</span></span>
<span id="cb247-49"><a aria-hidden="true" href="#cb247-49" tabindex="-1"></a><span class="co">         */</span></span>
<span id="cb247-50"><a aria-hidden="true" href="#cb247-50" tabindex="-1"></a>        foreach<span class="op">(</span>lc<span class="op">,</span> nl<span class="op">-&gt;</span>nestParams<span class="op">)</span></span>
<span id="cb247-51"><a aria-hidden="true" href="#cb247-51" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb247-52"><a aria-hidden="true" href="#cb247-52" tabindex="-1"></a>            NestLoopParam <span class="op">*</span>nlp <span class="op">=</span> <span class="op">(</span>NestLoopParam <span class="op">*)</span> lfirst<span class="op">(</span>lc<span class="op">);</span></span>
<span id="cb247-53"><a aria-hidden="true" href="#cb247-53" tabindex="-1"></a>            <span class="dt">int</span>         paramno <span class="op">=</span> nlp<span class="op">-&gt;</span>paramno<span class="op">;</span></span>
<span id="cb247-54"><a aria-hidden="true" href="#cb247-54" tabindex="-1"></a>            ParamExecData <span class="op">*</span>prm<span class="op">;</span></span>
<span id="cb247-55"><a aria-hidden="true" href="#cb247-55" tabindex="-1"></a></span>
<span id="cb247-56"><a aria-hidden="true" href="#cb247-56" tabindex="-1"></a>            prm <span class="op">=</span> <span class="op">&amp;(</span>econtext<span class="op">-&gt;</span>ecxt_param_exec_vals<span class="op">[</span>paramno<span class="op">]);</span></span>
<span id="cb247-57"><a aria-hidden="true" href="#cb247-57" tabindex="-1"></a>            <span class="co">/* Get value from outer tuple */</span></span>
<span id="cb247-58"><a aria-hidden="true" href="#cb247-58" tabindex="-1"></a>            prm<span class="op">-&gt;</span>value <span class="op">=</span> ExecEvalExpr<span class="op">(</span>nlp<span class="op">-&gt;</span>paramval<span class="op">,</span> econtext<span class="op">,</span></span>
<span id="cb247-59"><a aria-hidden="true" href="#cb247-59" tabindex="-1"></a>                                     <span class="op">&amp;(</span>prm<span class="op">-&gt;</span>isnull<span class="op">));</span></span>
<span id="cb247-60"><a aria-hidden="true" href="#cb247-60" tabindex="-1"></a>            innerPlan<span class="op">-&gt;</span>chgParam <span class="op">=</span> bms_add_member<span class="op">(</span>innerPlan<span class="op">-&gt;</span>chgParam<span class="op">,</span></span>
<span id="cb247-61"><a aria-hidden="true" href="#cb247-61" tabindex="-1"></a>                                                paramno<span class="op">);</span></span>
<span id="cb247-62"><a aria-hidden="true" href="#cb247-62" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb247-63"><a aria-hidden="true" href="#cb247-63" tabindex="-1"></a></span>
<span id="cb247-64"><a aria-hidden="true" href="#cb247-64" tabindex="-1"></a>        <span class="co">/* Rescan inner plan for new outer tuple */</span></span>
<span id="cb247-65"><a aria-hidden="true" href="#cb247-65" tabindex="-1"></a>        ExecReScan<span class="op">(</span>innerPlan<span class="op">);</span></span>
<span id="cb247-66"><a aria-hidden="true" href="#cb247-66" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb247-67"><a aria-hidden="true" href="#cb247-67" tabindex="-1"></a></span>
<span id="cb247-68"><a aria-hidden="true" href="#cb247-68" tabindex="-1"></a>    <span class="co">/*</span></span>
<span id="cb247-69"><a aria-hidden="true" href="#cb247-69" tabindex="-1"></a><span class="co">     * Main loop: fetch tuples from inner side and test join condition</span></span>
<span id="cb247-70"><a aria-hidden="true" href="#cb247-70" tabindex="-1"></a><span class="co">     */</span></span>
<span id="cb247-71"><a aria-hidden="true" href="#cb247-71" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(;;)</span></span>
<span id="cb247-72"><a aria-hidden="true" href="#cb247-72" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb247-73"><a aria-hidden="true" href="#cb247-73" tabindex="-1"></a>        <span class="co">/* Get next inner tuple */</span></span>
<span id="cb247-74"><a aria-hidden="true" href="#cb247-74" tabindex="-1"></a>        innerTupleSlot <span class="op">=</span> ExecProcNode<span class="op">(</span>innerPlan<span class="op">);</span></span>
<span id="cb247-75"><a aria-hidden="true" href="#cb247-75" tabindex="-1"></a></span>
<span id="cb247-76"><a aria-hidden="true" href="#cb247-76" tabindex="-1"></a>        <span class="co">/* No more inner tuples for this outer tuple */</span></span>
<span id="cb247-77"><a aria-hidden="true" href="#cb247-77" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>TupIsNull<span class="op">(</span>innerTupleSlot<span class="op">))</span></span>
<span id="cb247-78"><a aria-hidden="true" href="#cb247-78" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb247-79"><a aria-hidden="true" href="#cb247-79" tabindex="-1"></a>            node<span class="op">-&gt;</span>nl_NeedNewOuter <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb247-80"><a aria-hidden="true" href="#cb247-80" tabindex="-1"></a></span>
<span id="cb247-81"><a aria-hidden="true" href="#cb247-81" tabindex="-1"></a>            <span class="co">/* Handle outer join */</span></span>
<span id="cb247-82"><a aria-hidden="true" href="#cb247-82" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(!</span>node<span class="op">-&gt;</span>nl_MatchedOuter <span class="op">&amp;&amp;</span></span>
<span id="cb247-83"><a aria-hidden="true" href="#cb247-83" tabindex="-1"></a>                <span class="op">(</span>node<span class="op">-&gt;</span>js<span class="op">.</span>jointype <span class="op">==</span> JOIN_LEFT <span class="op">||</span></span>
<span id="cb247-84"><a aria-hidden="true" href="#cb247-84" tabindex="-1"></a>                 node<span class="op">-&gt;</span>js<span class="op">.</span>jointype <span class="op">==</span> JOIN_ANTI<span class="op">))</span></span>
<span id="cb247-85"><a aria-hidden="true" href="#cb247-85" tabindex="-1"></a>            <span class="op">{</span></span>
<span id="cb247-86"><a aria-hidden="true" href="#cb247-86" tabindex="-1"></a>                <span class="co">/* Emit null-extended tuple */</span></span>
<span id="cb247-87"><a aria-hidden="true" href="#cb247-87" tabindex="-1"></a>                <span class="co">/* ... */</span></span>
<span id="cb247-88"><a aria-hidden="true" href="#cb247-88" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb247-89"><a aria-hidden="true" href="#cb247-89" tabindex="-1"></a></span>
<span id="cb247-90"><a aria-hidden="true" href="#cb247-90" tabindex="-1"></a>            <span class="co">/* Get next outer tuple */</span></span>
<span id="cb247-91"><a aria-hidden="true" href="#cb247-91" tabindex="-1"></a>            outerTupleSlot <span class="op">=</span> ExecProcNode<span class="op">(</span>outerPlan<span class="op">);</span></span>
<span id="cb247-92"><a aria-hidden="true" href="#cb247-92" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>TupIsNull<span class="op">(</span>outerTupleSlot<span class="op">))</span></span>
<span id="cb247-93"><a aria-hidden="true" href="#cb247-93" tabindex="-1"></a>                <span class="cf">return</span> NULL<span class="op">;</span></span>
<span id="cb247-94"><a aria-hidden="true" href="#cb247-94" tabindex="-1"></a></span>
<span id="cb247-95"><a aria-hidden="true" href="#cb247-95" tabindex="-1"></a>            econtext<span class="op">-&gt;</span>ecxt_outertuple <span class="op">=</span> outerTupleSlot<span class="op">;</span></span>
<span id="cb247-96"><a aria-hidden="true" href="#cb247-96" tabindex="-1"></a>            node<span class="op">-&gt;</span>nl_MatchedOuter <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb247-97"><a aria-hidden="true" href="#cb247-97" tabindex="-1"></a></span>
<span id="cb247-98"><a aria-hidden="true" href="#cb247-98" tabindex="-1"></a>            <span class="co">/* Rescan inner plan */</span></span>
<span id="cb247-99"><a aria-hidden="true" href="#cb247-99" tabindex="-1"></a>            ExecReScan<span class="op">(</span>innerPlan<span class="op">);</span></span>
<span id="cb247-100"><a aria-hidden="true" href="#cb247-100" tabindex="-1"></a>            <span class="cf">continue</span><span class="op">;</span></span>
<span id="cb247-101"><a aria-hidden="true" href="#cb247-101" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb247-102"><a aria-hidden="true" href="#cb247-102" tabindex="-1"></a></span>
<span id="cb247-103"><a aria-hidden="true" href="#cb247-103" tabindex="-1"></a>        <span class="co">/* Test the join condition */</span></span>
<span id="cb247-104"><a aria-hidden="true" href="#cb247-104" tabindex="-1"></a>        econtext<span class="op">-&gt;</span>ecxt_innertuple <span class="op">=</span> innerTupleSlot<span class="op">;</span></span>
<span id="cb247-105"><a aria-hidden="true" href="#cb247-105" tabindex="-1"></a></span>
<span id="cb247-106"><a aria-hidden="true" href="#cb247-106" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>ExecQual<span class="op">(</span>joinqual<span class="op">,</span> econtext<span class="op">))</span></span>
<span id="cb247-107"><a aria-hidden="true" href="#cb247-107" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb247-108"><a aria-hidden="true" href="#cb247-108" tabindex="-1"></a>            node<span class="op">-&gt;</span>nl_MatchedOuter <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb247-109"><a aria-hidden="true" href="#cb247-109" tabindex="-1"></a></span>
<span id="cb247-110"><a aria-hidden="true" href="#cb247-110" tabindex="-1"></a>            <span class="co">/* Test additional quals */</span></span>
<span id="cb247-111"><a aria-hidden="true" href="#cb247-111" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>otherqual <span class="op">==</span> NULL <span class="op">||</span> ExecQual<span class="op">(</span>otherqual<span class="op">,</span> econtext<span class="op">))</span></span>
<span id="cb247-112"><a aria-hidden="true" href="#cb247-112" tabindex="-1"></a>            <span class="op">{</span></span>
<span id="cb247-113"><a aria-hidden="true" href="#cb247-113" tabindex="-1"></a>                <span class="co">/* We have a match! */</span></span>
<span id="cb247-114"><a aria-hidden="true" href="#cb247-114" tabindex="-1"></a>                <span class="cf">return</span> ExecProject<span class="op">(</span>node<span class="op">-&gt;</span>js<span class="op">.</span>ps<span class="op">.</span>ps_ProjInfo<span class="op">);</span></span>
<span id="cb247-115"><a aria-hidden="true" href="#cb247-115" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb247-116"><a aria-hidden="true" href="#cb247-116" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb247-117"><a aria-hidden="true" href="#cb247-117" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb247-118"><a aria-hidden="true" href="#cb247-118" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>Complexity</strong>: O(N √ó M) where N = outer rows, M = inner
rows</p>
<h3 data-number="4.9.2" id="hash-join"><span class="header-section-number">4.9.2</span> 8.2 Hash Join</h3>
<p><strong>Best for</strong>: Large relations with equijoin
conditions</p>
<p><strong>Algorithm</strong>:</p>
<pre><code>Build Phase:
    Create hash table from inner relation

Probe Phase:
    For each row R in outer relation:
        Hash R's join key
        Lookup matching rows in hash table
        Output matches</code></pre>
<p><strong>Implementation</strong>:
<code>/home/user/postgres/src/backend/executor/nodeHashjoin.c</code></p>
<div class="sourceCode" id="cb249"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb249-1"><a aria-hidden="true" href="#cb249-1" tabindex="-1"></a><span class="co">/* ----------------------------------------------------------------</span></span>
<span id="cb249-2"><a aria-hidden="true" href="#cb249-2" tabindex="-1"></a><span class="co"> *   ExecHashJoin</span></span>
<span id="cb249-3"><a aria-hidden="true" href="#cb249-3" tabindex="-1"></a><span class="co"> *</span></span>
<span id="cb249-4"><a aria-hidden="true" href="#cb249-4" tabindex="-1"></a><span class="co"> * Parallel-aware hash join executor entry point.</span></span>
<span id="cb249-5"><a aria-hidden="true" href="#cb249-5" tabindex="-1"></a><span class="co"> * ----------------------------------------------------------------</span></span>
<span id="cb249-6"><a aria-hidden="true" href="#cb249-6" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb249-7"><a aria-hidden="true" href="#cb249-7" tabindex="-1"></a><span class="dt">static</span> TupleTableSlot <span class="op">*</span></span>
<span id="cb249-8"><a aria-hidden="true" href="#cb249-8" tabindex="-1"></a>ExecHashJoin<span class="op">(</span>PlanState <span class="op">*</span>pstate<span class="op">)</span></span>
<span id="cb249-9"><a aria-hidden="true" href="#cb249-9" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb249-10"><a aria-hidden="true" href="#cb249-10" tabindex="-1"></a>    HashJoinState <span class="op">*</span>node <span class="op">=</span> castNode<span class="op">(</span>HashJoinState<span class="op">,</span> pstate<span class="op">);</span></span>
<span id="cb249-11"><a aria-hidden="true" href="#cb249-11" tabindex="-1"></a>    PlanState  <span class="op">*</span>outerPlan<span class="op">;</span></span>
<span id="cb249-12"><a aria-hidden="true" href="#cb249-12" tabindex="-1"></a>    HashState  <span class="op">*</span>hashNode<span class="op">;</span></span>
<span id="cb249-13"><a aria-hidden="true" href="#cb249-13" tabindex="-1"></a>    ExprState  <span class="op">*</span>joinqual<span class="op">;</span></span>
<span id="cb249-14"><a aria-hidden="true" href="#cb249-14" tabindex="-1"></a>    ExprState  <span class="op">*</span>otherqual<span class="op">;</span></span>
<span id="cb249-15"><a aria-hidden="true" href="#cb249-15" tabindex="-1"></a>    ExprContext <span class="op">*</span>econtext<span class="op">;</span></span>
<span id="cb249-16"><a aria-hidden="true" href="#cb249-16" tabindex="-1"></a>    HashJoinTable hashtable<span class="op">;</span></span>
<span id="cb249-17"><a aria-hidden="true" href="#cb249-17" tabindex="-1"></a>    TupleTableSlot <span class="op">*</span>outerTupleSlot<span class="op">;</span></span>
<span id="cb249-18"><a aria-hidden="true" href="#cb249-18" tabindex="-1"></a>    uint32      hashvalue<span class="op">;</span></span>
<span id="cb249-19"><a aria-hidden="true" href="#cb249-19" tabindex="-1"></a>    <span class="dt">int</span>         batchno<span class="op">;</span></span>
<span id="cb249-20"><a aria-hidden="true" href="#cb249-20" tabindex="-1"></a></span>
<span id="cb249-21"><a aria-hidden="true" href="#cb249-21" tabindex="-1"></a>    <span class="co">/* Get state from node */</span></span>
<span id="cb249-22"><a aria-hidden="true" href="#cb249-22" tabindex="-1"></a>    joinqual <span class="op">=</span> node<span class="op">-&gt;</span>js<span class="op">.</span>joinqual<span class="op">;</span></span>
<span id="cb249-23"><a aria-hidden="true" href="#cb249-23" tabindex="-1"></a>    otherqual <span class="op">=</span> node<span class="op">-&gt;</span>js<span class="op">.</span>ps<span class="op">.</span>qual<span class="op">;</span></span>
<span id="cb249-24"><a aria-hidden="true" href="#cb249-24" tabindex="-1"></a>    hashNode <span class="op">=</span> <span class="op">(</span>HashState <span class="op">*)</span> innerPlanState<span class="op">(</span>node<span class="op">);</span></span>
<span id="cb249-25"><a aria-hidden="true" href="#cb249-25" tabindex="-1"></a>    outerPlan <span class="op">=</span> outerPlanState<span class="op">(</span>node<span class="op">);</span></span>
<span id="cb249-26"><a aria-hidden="true" href="#cb249-26" tabindex="-1"></a>    hashtable <span class="op">=</span> node<span class="op">-&gt;</span>hj_HashTable<span class="op">;</span></span>
<span id="cb249-27"><a aria-hidden="true" href="#cb249-27" tabindex="-1"></a>    econtext <span class="op">=</span> node<span class="op">-&gt;</span>js<span class="op">.</span>ps<span class="op">.</span>ps_ExprContext<span class="op">;</span></span>
<span id="cb249-28"><a aria-hidden="true" href="#cb249-28" tabindex="-1"></a></span>
<span id="cb249-29"><a aria-hidden="true" href="#cb249-29" tabindex="-1"></a>    <span class="co">/* Reset per-tuple memory context */</span></span>
<span id="cb249-30"><a aria-hidden="true" href="#cb249-30" tabindex="-1"></a>    ResetExprContext<span class="op">(</span>econtext<span class="op">);</span></span>
<span id="cb249-31"><a aria-hidden="true" href="#cb249-31" tabindex="-1"></a></span>
<span id="cb249-32"><a aria-hidden="true" href="#cb249-32" tabindex="-1"></a>    <span class="co">/*</span></span>
<span id="cb249-33"><a aria-hidden="true" href="#cb249-33" tabindex="-1"></a><span class="co">     * If we're doing a right/full outer join, we need to track</span></span>
<span id="cb249-34"><a aria-hidden="true" href="#cb249-34" tabindex="-1"></a><span class="co">     * which inner tuples have been matched</span></span>
<span id="cb249-35"><a aria-hidden="true" href="#cb249-35" tabindex="-1"></a><span class="co">     */</span></span>
<span id="cb249-36"><a aria-hidden="true" href="#cb249-36" tabindex="-1"></a></span>
<span id="cb249-37"><a aria-hidden="true" href="#cb249-37" tabindex="-1"></a>    <span class="co">/* Main execution loop */</span></span>
<span id="cb249-38"><a aria-hidden="true" href="#cb249-38" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(;;)</span></span>
<span id="cb249-39"><a aria-hidden="true" href="#cb249-39" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb249-40"><a aria-hidden="true" href="#cb249-40" tabindex="-1"></a>        <span class="cf">switch</span> <span class="op">(</span>node<span class="op">-&gt;</span>hj_JoinState<span class="op">)</span></span>
<span id="cb249-41"><a aria-hidden="true" href="#cb249-41" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb249-42"><a aria-hidden="true" href="#cb249-42" tabindex="-1"></a>            <span class="cf">case</span> HJ_BUILD_HASHTABLE<span class="op">:</span></span>
<span id="cb249-43"><a aria-hidden="true" href="#cb249-43" tabindex="-1"></a>                <span class="co">/* Build the hash table from inner relation */</span></span>
<span id="cb249-44"><a aria-hidden="true" href="#cb249-44" tabindex="-1"></a>                hashtable <span class="op">=</span> ExecHashTableCreate<span class="op">(</span>hashNode<span class="op">,</span></span>
<span id="cb249-45"><a aria-hidden="true" href="#cb249-45" tabindex="-1"></a>                                               node<span class="op">-&gt;</span>hj_HashOperators<span class="op">,</span></span>
<span id="cb249-46"><a aria-hidden="true" href="#cb249-46" tabindex="-1"></a>                                               HJ_FILL_OUTER<span class="op">(</span>node<span class="op">));</span></span>
<span id="cb249-47"><a aria-hidden="true" href="#cb249-47" tabindex="-1"></a>                node<span class="op">-&gt;</span>hj_HashTable <span class="op">=</span> hashtable<span class="op">;</span></span>
<span id="cb249-48"><a aria-hidden="true" href="#cb249-48" tabindex="-1"></a></span>
<span id="cb249-49"><a aria-hidden="true" href="#cb249-49" tabindex="-1"></a>                <span class="co">/* Execute inner plan to populate hash table */</span></span>
<span id="cb249-50"><a aria-hidden="true" href="#cb249-50" tabindex="-1"></a>                <span class="co">/* ... */</span></span>
<span id="cb249-51"><a aria-hidden="true" href="#cb249-51" tabindex="-1"></a></span>
<span id="cb249-52"><a aria-hidden="true" href="#cb249-52" tabindex="-1"></a>                node<span class="op">-&gt;</span>hj_JoinState <span class="op">=</span> HJ_NEED_NEW_OUTER<span class="op">;</span></span>
<span id="cb249-53"><a aria-hidden="true" href="#cb249-53" tabindex="-1"></a>                <span class="co">/* FALL THRU */</span></span>
<span id="cb249-54"><a aria-hidden="true" href="#cb249-54" tabindex="-1"></a></span>
<span id="cb249-55"><a aria-hidden="true" href="#cb249-55" tabindex="-1"></a>            <span class="cf">case</span> HJ_NEED_NEW_OUTER<span class="op">:</span></span>
<span id="cb249-56"><a aria-hidden="true" href="#cb249-56" tabindex="-1"></a>                <span class="co">/* Get next outer tuple */</span></span>
<span id="cb249-57"><a aria-hidden="true" href="#cb249-57" tabindex="-1"></a>                outerTupleSlot <span class="op">=</span> ExecProcNode<span class="op">(</span>outerPlan<span class="op">);</span></span>
<span id="cb249-58"><a aria-hidden="true" href="#cb249-58" tabindex="-1"></a>                <span class="cf">if</span> <span class="op">(</span>TupIsNull<span class="op">(</span>outerTupleSlot<span class="op">))</span></span>
<span id="cb249-59"><a aria-hidden="true" href="#cb249-59" tabindex="-1"></a>                <span class="op">{</span></span>
<span id="cb249-60"><a aria-hidden="true" href="#cb249-60" tabindex="-1"></a>                    <span class="co">/* No more outer tuples */</span></span>
<span id="cb249-61"><a aria-hidden="true" href="#cb249-61" tabindex="-1"></a>                    node<span class="op">-&gt;</span>hj_JoinState <span class="op">=</span> HJ_NEED_NEW_BATCH<span class="op">;</span></span>
<span id="cb249-62"><a aria-hidden="true" href="#cb249-62" tabindex="-1"></a>                    <span class="cf">continue</span><span class="op">;</span></span>
<span id="cb249-63"><a aria-hidden="true" href="#cb249-63" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb249-64"><a aria-hidden="true" href="#cb249-64" tabindex="-1"></a></span>
<span id="cb249-65"><a aria-hidden="true" href="#cb249-65" tabindex="-1"></a>                econtext<span class="op">-&gt;</span>ecxt_outertuple <span class="op">=</span> outerTupleSlot<span class="op">;</span></span>
<span id="cb249-66"><a aria-hidden="true" href="#cb249-66" tabindex="-1"></a></span>
<span id="cb249-67"><a aria-hidden="true" href="#cb249-67" tabindex="-1"></a>                <span class="co">/* Compute hash value for outer tuple */</span></span>
<span id="cb249-68"><a aria-hidden="true" href="#cb249-68" tabindex="-1"></a>                <span class="cf">if</span> <span class="op">(</span>HJ_FILL_INNER<span class="op">(</span>node<span class="op">))</span></span>
<span id="cb249-69"><a aria-hidden="true" href="#cb249-69" tabindex="-1"></a>                    node<span class="op">-&gt;</span>hj_MatchedOuter <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb249-70"><a aria-hidden="true" href="#cb249-70" tabindex="-1"></a></span>
<span id="cb249-71"><a aria-hidden="true" href="#cb249-71" tabindex="-1"></a>                hashvalue <span class="op">=</span> ExecHashGetHashValue<span class="op">(</span>hashtable<span class="op">,</span></span>
<span id="cb249-72"><a aria-hidden="true" href="#cb249-72" tabindex="-1"></a>                                                econtext<span class="op">,</span></span>
<span id="cb249-73"><a aria-hidden="true" href="#cb249-73" tabindex="-1"></a>                                                node<span class="op">-&gt;</span>hj_OuterHashKeys<span class="op">);</span></span>
<span id="cb249-74"><a aria-hidden="true" href="#cb249-74" tabindex="-1"></a></span>
<span id="cb249-75"><a aria-hidden="true" href="#cb249-75" tabindex="-1"></a>                node<span class="op">-&gt;</span>hj_CurHashValue <span class="op">=</span> hashvalue<span class="op">;</span></span>
<span id="cb249-76"><a aria-hidden="true" href="#cb249-76" tabindex="-1"></a>                node<span class="op">-&gt;</span>hj_CurBucketNo <span class="op">=</span> ExecHashGetBucketAndBatch<span class="op">(</span>hashtable<span class="op">,</span></span>
<span id="cb249-77"><a aria-hidden="true" href="#cb249-77" tabindex="-1"></a>                                                                hashvalue<span class="op">,</span></span>
<span id="cb249-78"><a aria-hidden="true" href="#cb249-78" tabindex="-1"></a>                                                                <span class="op">&amp;</span>batchno<span class="op">,</span></span>
<span id="cb249-79"><a aria-hidden="true" href="#cb249-79" tabindex="-1"></a>                                                                <span class="op">&amp;</span>node<span class="op">-&gt;</span>hj_CurSkewBucketNo<span class="op">);</span></span>
<span id="cb249-80"><a aria-hidden="true" href="#cb249-80" tabindex="-1"></a>                node<span class="op">-&gt;</span>hj_CurTuple <span class="op">=</span> NULL<span class="op">;</span></span>
<span id="cb249-81"><a aria-hidden="true" href="#cb249-81" tabindex="-1"></a>                node<span class="op">-&gt;</span>hj_JoinState <span class="op">=</span> HJ_SCAN_BUCKET<span class="op">;</span></span>
<span id="cb249-82"><a aria-hidden="true" href="#cb249-82" tabindex="-1"></a>                <span class="co">/* FALL THRU */</span></span>
<span id="cb249-83"><a aria-hidden="true" href="#cb249-83" tabindex="-1"></a></span>
<span id="cb249-84"><a aria-hidden="true" href="#cb249-84" tabindex="-1"></a>            <span class="cf">case</span> HJ_SCAN_BUCKET<span class="op">:</span></span>
<span id="cb249-85"><a aria-hidden="true" href="#cb249-85" tabindex="-1"></a>                <span class="co">/* Scan hash bucket for matches */</span></span>
<span id="cb249-86"><a aria-hidden="true" href="#cb249-86" tabindex="-1"></a>                <span class="cf">for</span> <span class="op">(;;)</span></span>
<span id="cb249-87"><a aria-hidden="true" href="#cb249-87" tabindex="-1"></a>                <span class="op">{</span></span>
<span id="cb249-88"><a aria-hidden="true" href="#cb249-88" tabindex="-1"></a>                    <span class="cf">if</span> <span class="op">(</span>node<span class="op">-&gt;</span>hj_CurTuple <span class="op">==</span> NULL<span class="op">)</span></span>
<span id="cb249-89"><a aria-hidden="true" href="#cb249-89" tabindex="-1"></a>                    <span class="op">{</span></span>
<span id="cb249-90"><a aria-hidden="true" href="#cb249-90" tabindex="-1"></a>                        <span class="co">/* Get first/next tuple from bucket */</span></span>
<span id="cb249-91"><a aria-hidden="true" href="#cb249-91" tabindex="-1"></a>                        node<span class="op">-&gt;</span>hj_CurTuple <span class="op">=</span> ExecScanHashBucket<span class="op">(</span>node<span class="op">,</span></span>
<span id="cb249-92"><a aria-hidden="true" href="#cb249-92" tabindex="-1"></a>                                                              econtext<span class="op">);</span></span>
<span id="cb249-93"><a aria-hidden="true" href="#cb249-93" tabindex="-1"></a>                        <span class="cf">if</span> <span class="op">(</span>node<span class="op">-&gt;</span>hj_CurTuple <span class="op">==</span> NULL<span class="op">)</span></span>
<span id="cb249-94"><a aria-hidden="true" href="#cb249-94" tabindex="-1"></a>                        <span class="op">{</span></span>
<span id="cb249-95"><a aria-hidden="true" href="#cb249-95" tabindex="-1"></a>                            <span class="co">/* No more tuples in bucket */</span></span>
<span id="cb249-96"><a aria-hidden="true" href="#cb249-96" tabindex="-1"></a>                            node<span class="op">-&gt;</span>hj_JoinState <span class="op">=</span> HJ_NEED_NEW_OUTER<span class="op">;</span></span>
<span id="cb249-97"><a aria-hidden="true" href="#cb249-97" tabindex="-1"></a>                            <span class="cf">break</span><span class="op">;</span></span>
<span id="cb249-98"><a aria-hidden="true" href="#cb249-98" tabindex="-1"></a>                        <span class="op">}</span></span>
<span id="cb249-99"><a aria-hidden="true" href="#cb249-99" tabindex="-1"></a>                    <span class="op">}</span></span>
<span id="cb249-100"><a aria-hidden="true" href="#cb249-100" tabindex="-1"></a></span>
<span id="cb249-101"><a aria-hidden="true" href="#cb249-101" tabindex="-1"></a>                    <span class="co">/* Test join condition */</span></span>
<span id="cb249-102"><a aria-hidden="true" href="#cb249-102" tabindex="-1"></a>                    <span class="cf">if</span> <span class="op">(</span>joinqual <span class="op">==</span> NULL <span class="op">||</span> ExecQual<span class="op">(</span>joinqual<span class="op">,</span> econtext<span class="op">))</span></span>
<span id="cb249-103"><a aria-hidden="true" href="#cb249-103" tabindex="-1"></a>                    <span class="op">{</span></span>
<span id="cb249-104"><a aria-hidden="true" href="#cb249-104" tabindex="-1"></a>                        node<span class="op">-&gt;</span>hj_MatchedOuter <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb249-105"><a aria-hidden="true" href="#cb249-105" tabindex="-1"></a></span>
<span id="cb249-106"><a aria-hidden="true" href="#cb249-106" tabindex="-1"></a>                        <span class="co">/* Test additional quals */</span></span>
<span id="cb249-107"><a aria-hidden="true" href="#cb249-107" tabindex="-1"></a>                        <span class="cf">if</span> <span class="op">(</span>otherqual <span class="op">==</span> NULL <span class="op">||</span> ExecQual<span class="op">(</span>otherqual<span class="op">,</span> econtext<span class="op">))</span></span>
<span id="cb249-108"><a aria-hidden="true" href="#cb249-108" tabindex="-1"></a>                        <span class="op">{</span></span>
<span id="cb249-109"><a aria-hidden="true" href="#cb249-109" tabindex="-1"></a>                            <span class="co">/* Found a match! */</span></span>
<span id="cb249-110"><a aria-hidden="true" href="#cb249-110" tabindex="-1"></a>                            <span class="cf">return</span> ExecProject<span class="op">(</span>node<span class="op">-&gt;</span>js<span class="op">.</span>ps<span class="op">.</span>ps_ProjInfo<span class="op">);</span></span>
<span id="cb249-111"><a aria-hidden="true" href="#cb249-111" tabindex="-1"></a>                        <span class="op">}</span></span>
<span id="cb249-112"><a aria-hidden="true" href="#cb249-112" tabindex="-1"></a>                    <span class="op">}</span></span>
<span id="cb249-113"><a aria-hidden="true" href="#cb249-113" tabindex="-1"></a></span>
<span id="cb249-114"><a aria-hidden="true" href="#cb249-114" tabindex="-1"></a>                    <span class="co">/* Try next tuple in bucket */</span></span>
<span id="cb249-115"><a aria-hidden="true" href="#cb249-115" tabindex="-1"></a>                    node<span class="op">-&gt;</span>hj_CurTuple <span class="op">=</span> NULL<span class="op">;</span></span>
<span id="cb249-116"><a aria-hidden="true" href="#cb249-116" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb249-117"><a aria-hidden="true" href="#cb249-117" tabindex="-1"></a>                <span class="cf">break</span><span class="op">;</span></span>
<span id="cb249-118"><a aria-hidden="true" href="#cb249-118" tabindex="-1"></a></span>
<span id="cb249-119"><a aria-hidden="true" href="#cb249-119" tabindex="-1"></a>            <span class="cf">case</span> HJ_NEED_NEW_BATCH<span class="op">:</span></span>
<span id="cb249-120"><a aria-hidden="true" href="#cb249-120" tabindex="-1"></a>                <span class="co">/* Handle additional batches for large datasets */</span></span>
<span id="cb249-121"><a aria-hidden="true" href="#cb249-121" tabindex="-1"></a>                <span class="co">/* ... */</span></span>
<span id="cb249-122"><a aria-hidden="true" href="#cb249-122" tabindex="-1"></a>                <span class="cf">return</span> NULL<span class="op">;</span></span>
<span id="cb249-123"><a aria-hidden="true" href="#cb249-123" tabindex="-1"></a></span>
<span id="cb249-124"><a aria-hidden="true" href="#cb249-124" tabindex="-1"></a>            <span class="cf">default</span><span class="op">:</span></span>
<span id="cb249-125"><a aria-hidden="true" href="#cb249-125" tabindex="-1"></a>                elog<span class="op">(</span>ERROR<span class="op">,</span> <span class="st">"unrecognized hashjoin state: </span><span class="sc">%d</span><span class="st">"</span><span class="op">,</span></span>
<span id="cb249-126"><a aria-hidden="true" href="#cb249-126" tabindex="-1"></a>                     <span class="op">(</span><span class="dt">int</span><span class="op">)</span> node<span class="op">-&gt;</span>hj_JoinState<span class="op">);</span></span>
<span id="cb249-127"><a aria-hidden="true" href="#cb249-127" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb249-128"><a aria-hidden="true" href="#cb249-128" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb249-129"><a aria-hidden="true" href="#cb249-129" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>Complexity</strong>: O(N + M) average case (with good hash
function)</p>
<p><strong>Space</strong>: O(M) for hash table</p>
<h3 data-number="4.9.3" id="merge-join"><span class="header-section-number">4.9.3</span> 8.3 Merge Join</h3>
<p><strong>Best for</strong>: Both inputs already sorted on join key, or
sort would be beneficial for other reasons</p>
<p><strong>Algorithm</strong>:</p>
<pre><code>Sort both relations on join key (if not already sorted)

Scan both relations in parallel:
    If left.key &lt; right.key:
        Advance left
    Else if left.key &gt; right.key:
        Advance right
    Else:  /* Keys match */
        Output all matching combinations
        Advance both when done with this key value</code></pre>
<p><strong>Data Structure</strong> (from plannodes.h, lines
1014-1040):</p>
<div class="sourceCode" id="cb251"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb251-1"><a aria-hidden="true" href="#cb251-1" tabindex="-1"></a><span class="co">/* ----------------</span></span>
<span id="cb251-2"><a aria-hidden="true" href="#cb251-2" tabindex="-1"></a><span class="co"> *   merge join node</span></span>
<span id="cb251-3"><a aria-hidden="true" href="#cb251-3" tabindex="-1"></a><span class="co"> *</span></span>
<span id="cb251-4"><a aria-hidden="true" href="#cb251-4" tabindex="-1"></a><span class="co"> * The expected ordering of each mergeable column is described by a btree</span></span>
<span id="cb251-5"><a aria-hidden="true" href="#cb251-5" tabindex="-1"></a><span class="co"> * opfamily OID, a collation OID, a direction (BTLessStrategyNumber or</span></span>
<span id="cb251-6"><a aria-hidden="true" href="#cb251-6" tabindex="-1"></a><span class="co"> * BTGreaterStrategyNumber) and a nulls-first flag.</span></span>
<span id="cb251-7"><a aria-hidden="true" href="#cb251-7" tabindex="-1"></a><span class="co"> * ----------------</span></span>
<span id="cb251-8"><a aria-hidden="true" href="#cb251-8" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb251-9"><a aria-hidden="true" href="#cb251-9" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> MergeJoin</span>
<span id="cb251-10"><a aria-hidden="true" href="#cb251-10" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb251-11"><a aria-hidden="true" href="#cb251-11" tabindex="-1"></a>    Join        join<span class="op">;</span></span>
<span id="cb251-12"><a aria-hidden="true" href="#cb251-12" tabindex="-1"></a></span>
<span id="cb251-13"><a aria-hidden="true" href="#cb251-13" tabindex="-1"></a>    <span class="dt">bool</span>        skip_mark_restore<span class="op">;</span> <span class="co">/* Can we skip mark/restore calls? */</span></span>
<span id="cb251-14"><a aria-hidden="true" href="#cb251-14" tabindex="-1"></a></span>
<span id="cb251-15"><a aria-hidden="true" href="#cb251-15" tabindex="-1"></a>    List       <span class="op">*</span>mergeclauses<span class="op">;</span>   <span class="co">/* mergeclauses as expression trees */</span></span>
<span id="cb251-16"><a aria-hidden="true" href="#cb251-16" tabindex="-1"></a></span>
<span id="cb251-17"><a aria-hidden="true" href="#cb251-17" tabindex="-1"></a>    <span class="co">/* these are arrays, but have the same length as the mergeclauses list: */</span></span>
<span id="cb251-18"><a aria-hidden="true" href="#cb251-18" tabindex="-1"></a></span>
<span id="cb251-19"><a aria-hidden="true" href="#cb251-19" tabindex="-1"></a>    Oid        <span class="op">*</span>mergeFamilies<span class="op">;</span>  <span class="co">/* per-clause OIDs of btree opfamilies */</span></span>
<span id="cb251-20"><a aria-hidden="true" href="#cb251-20" tabindex="-1"></a>    Oid        <span class="op">*</span>mergeCollations<span class="op">;</span><span class="co">/* per-clause OIDs of collations */</span></span>
<span id="cb251-21"><a aria-hidden="true" href="#cb251-21" tabindex="-1"></a>    <span class="dt">int</span>        <span class="op">*</span>mergeStrategies<span class="op">;</span><span class="co">/* per-clause ordering (ASC or DESC) */</span></span>
<span id="cb251-22"><a aria-hidden="true" href="#cb251-22" tabindex="-1"></a>    <span class="dt">bool</span>       <span class="op">*</span>mergeNullsFirst<span class="op">;</span><span class="co">/* per-clause nulls ordering */</span></span>
<span id="cb251-23"><a aria-hidden="true" href="#cb251-23" tabindex="-1"></a><span class="op">}</span> MergeJoin<span class="op">;</span></span></code></pre></div>
<p><strong>Implementation</strong>:
<code>/home/user/postgres/src/backend/executor/nodeMergejoin.c</code></p>
<p><strong>Complexity</strong>: O(N log N + M log M) if sorting needed,
O(N + M) if pre-sorted</p>
<hr/>
<h2 data-number="4.10" id="cost-model-and-parameters"><span class="header-section-number">4.10</span> 9. Cost Model and
Parameters</h2>
<p>PostgreSQL‚Äôs cost-based optimizer estimates the cost of each plan
using a parameterized cost model.</p>
<h3 data-number="4.10.1" id="cost-parameters"><span class="header-section-number">4.10.1</span> 9.1 Cost Parameters</h3>
<p><strong>Location</strong>:
<code>/home/user/postgres/src/backend/optimizer/path/costsize.c</code>
(lines 130-134)</p>
<div class="sourceCode" id="cb252"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb252-1"><a aria-hidden="true" href="#cb252-1" tabindex="-1"></a><span class="co">/* GUC cost parameters */</span></span>
<span id="cb252-2"><a aria-hidden="true" href="#cb252-2" tabindex="-1"></a><span class="dt">double</span>      seq_page_cost <span class="op">=</span> DEFAULT_SEQ_PAGE_COST<span class="op">;</span>         <span class="co">/* 1.0 */</span></span>
<span id="cb252-3"><a aria-hidden="true" href="#cb252-3" tabindex="-1"></a><span class="dt">double</span>      random_page_cost <span class="op">=</span> DEFAULT_RANDOM_PAGE_COST<span class="op">;</span>   <span class="co">/* 4.0 */</span></span>
<span id="cb252-4"><a aria-hidden="true" href="#cb252-4" tabindex="-1"></a><span class="dt">double</span>      cpu_tuple_cost <span class="op">=</span> DEFAULT_CPU_TUPLE_COST<span class="op">;</span>       <span class="co">/* 0.01 */</span></span>
<span id="cb252-5"><a aria-hidden="true" href="#cb252-5" tabindex="-1"></a><span class="dt">double</span>      cpu_index_tuple_cost <span class="op">=</span> DEFAULT_CPU_INDEX_TUPLE_COST<span class="op">;</span>   <span class="co">/* 0.005 */</span></span>
<span id="cb252-6"><a aria-hidden="true" href="#cb252-6" tabindex="-1"></a><span class="dt">double</span>      cpu_operator_cost <span class="op">=</span> DEFAULT_CPU_OPERATOR_COST<span class="op">;</span> <span class="co">/* 0.0025 */</span></span>
<span id="cb252-7"><a aria-hidden="true" href="#cb252-7" tabindex="-1"></a><span class="dt">double</span>      parallel_tuple_cost <span class="op">=</span> DEFAULT_PARALLEL_TUPLE_COST<span class="op">;</span>     <span class="co">/* 0.1 */</span></span>
<span id="cb252-8"><a aria-hidden="true" href="#cb252-8" tabindex="-1"></a><span class="dt">double</span>      parallel_setup_cost <span class="op">=</span> DEFAULT_PARALLEL_SETUP_COST<span class="op">;</span>     <span class="co">/* 1000.0 */</span></span></code></pre></div>
<p><strong>Parameter Meanings</strong>:</p>
<ul>
<li><strong>seq_page_cost</strong>: Cost of a sequential page fetch
(default: 1.0)</li>
<li><strong>random_page_cost</strong>: Cost of a non-sequential page
fetch (default: 4.0)</li>
<li><strong>cpu_tuple_cost</strong>: Cost to process one tuple (default:
0.01)</li>
<li><strong>cpu_index_tuple_cost</strong>: Cost to process one index
entry (default: 0.005)</li>
<li><strong>cpu_operator_cost</strong>: Cost to execute an
operator/function (default: 0.0025)</li>
</ul>
<h3 data-number="4.10.2" id="sequential-scan-costing"><span class="header-section-number">4.10.2</span> 9.2 Sequential Scan
Costing</h3>
<p><strong>From costsize.c (lines 260-310)</strong>:</p>
<div class="sourceCode" id="cb253"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb253-1"><a aria-hidden="true" href="#cb253-1" tabindex="-1"></a><span class="co">/*</span></span>
<span id="cb253-2"><a aria-hidden="true" href="#cb253-2" tabindex="-1"></a><span class="co"> * cost_seqscan</span></span>
<span id="cb253-3"><a aria-hidden="true" href="#cb253-3" tabindex="-1"></a><span class="co"> *   Determines and returns the cost of scanning a relation sequentially.</span></span>
<span id="cb253-4"><a aria-hidden="true" href="#cb253-4" tabindex="-1"></a><span class="co"> *</span></span>
<span id="cb253-5"><a aria-hidden="true" href="#cb253-5" tabindex="-1"></a><span class="co"> * 'baserel' is the relation to be scanned</span></span>
<span id="cb253-6"><a aria-hidden="true" href="#cb253-6" tabindex="-1"></a><span class="co"> * 'param_info' is the ParamPathInfo if this is a parameterized path, else NULL</span></span>
<span id="cb253-7"><a aria-hidden="true" href="#cb253-7" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb253-8"><a aria-hidden="true" href="#cb253-8" tabindex="-1"></a><span class="dt">void</span></span>
<span id="cb253-9"><a aria-hidden="true" href="#cb253-9" tabindex="-1"></a>cost_seqscan<span class="op">(</span>Path <span class="op">*</span>path<span class="op">,</span> PlannerInfo <span class="op">*</span>root<span class="op">,</span></span>
<span id="cb253-10"><a aria-hidden="true" href="#cb253-10" tabindex="-1"></a>            RelOptInfo <span class="op">*</span>baserel<span class="op">,</span> ParamPathInfo <span class="op">*</span>param_info<span class="op">)</span></span>
<span id="cb253-11"><a aria-hidden="true" href="#cb253-11" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb253-12"><a aria-hidden="true" href="#cb253-12" tabindex="-1"></a>    Cost        startup_cost <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb253-13"><a aria-hidden="true" href="#cb253-13" tabindex="-1"></a>    Cost        cpu_run_cost<span class="op">;</span></span>
<span id="cb253-14"><a aria-hidden="true" href="#cb253-14" tabindex="-1"></a>    Cost        disk_run_cost<span class="op">;</span></span>
<span id="cb253-15"><a aria-hidden="true" href="#cb253-15" tabindex="-1"></a>    <span class="dt">double</span>      spc_seq_page_cost<span class="op">;</span></span>
<span id="cb253-16"><a aria-hidden="true" href="#cb253-16" tabindex="-1"></a>    QualCost    qpqual_cost<span class="op">;</span></span>
<span id="cb253-17"><a aria-hidden="true" href="#cb253-17" tabindex="-1"></a>    Cost        cpu_per_tuple<span class="op">;</span></span>
<span id="cb253-18"><a aria-hidden="true" href="#cb253-18" tabindex="-1"></a></span>
<span id="cb253-19"><a aria-hidden="true" href="#cb253-19" tabindex="-1"></a>    <span class="co">/* Should only be applied to base relations */</span></span>
<span id="cb253-20"><a aria-hidden="true" href="#cb253-20" tabindex="-1"></a>    Assert<span class="op">(</span>baserel<span class="op">-&gt;</span>relid <span class="op">&gt;</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb253-21"><a aria-hidden="true" href="#cb253-21" tabindex="-1"></a>    Assert<span class="op">(</span>baserel<span class="op">-&gt;</span>rtekind <span class="op">==</span> RTE_RELATION<span class="op">);</span></span>
<span id="cb253-22"><a aria-hidden="true" href="#cb253-22" tabindex="-1"></a></span>
<span id="cb253-23"><a aria-hidden="true" href="#cb253-23" tabindex="-1"></a>    <span class="co">/* Mark the path with the correct row estimate */</span></span>
<span id="cb253-24"><a aria-hidden="true" href="#cb253-24" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>param_info<span class="op">)</span></span>
<span id="cb253-25"><a aria-hidden="true" href="#cb253-25" tabindex="-1"></a>        path<span class="op">-&gt;</span>rows <span class="op">=</span> param_info<span class="op">-&gt;</span>ppi_rows<span class="op">;</span></span>
<span id="cb253-26"><a aria-hidden="true" href="#cb253-26" tabindex="-1"></a>    <span class="cf">else</span></span>
<span id="cb253-27"><a aria-hidden="true" href="#cb253-27" tabindex="-1"></a>        path<span class="op">-&gt;</span>rows <span class="op">=</span> baserel<span class="op">-&gt;</span>rows<span class="op">;</span></span>
<span id="cb253-28"><a aria-hidden="true" href="#cb253-28" tabindex="-1"></a></span>
<span id="cb253-29"><a aria-hidden="true" href="#cb253-29" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(!</span>enable_seqscan<span class="op">)</span></span>
<span id="cb253-30"><a aria-hidden="true" href="#cb253-30" tabindex="-1"></a>        startup_cost <span class="op">+=</span> disable_cost<span class="op">;</span></span>
<span id="cb253-31"><a aria-hidden="true" href="#cb253-31" tabindex="-1"></a></span>
<span id="cb253-32"><a aria-hidden="true" href="#cb253-32" tabindex="-1"></a>    <span class="co">/* Get tablespace-specific page cost */</span></span>
<span id="cb253-33"><a aria-hidden="true" href="#cb253-33" tabindex="-1"></a>    get_tablespace_page_costs<span class="op">(</span>baserel<span class="op">-&gt;</span>reltablespace<span class="op">,</span></span>
<span id="cb253-34"><a aria-hidden="true" href="#cb253-34" tabindex="-1"></a>                             NULL<span class="op">,</span></span>
<span id="cb253-35"><a aria-hidden="true" href="#cb253-35" tabindex="-1"></a>                             <span class="op">&amp;</span>spc_seq_page_cost<span class="op">);</span></span>
<span id="cb253-36"><a aria-hidden="true" href="#cb253-36" tabindex="-1"></a></span>
<span id="cb253-37"><a aria-hidden="true" href="#cb253-37" tabindex="-1"></a>    <span class="co">/*</span></span>
<span id="cb253-38"><a aria-hidden="true" href="#cb253-38" tabindex="-1"></a><span class="co">     * Disk cost: pages √ó cost per sequential page</span></span>
<span id="cb253-39"><a aria-hidden="true" href="#cb253-39" tabindex="-1"></a><span class="co">     */</span></span>
<span id="cb253-40"><a aria-hidden="true" href="#cb253-40" tabindex="-1"></a>    disk_run_cost <span class="op">=</span> spc_seq_page_cost <span class="op">*</span> baserel<span class="op">-&gt;</span>pages<span class="op">;</span></span>
<span id="cb253-41"><a aria-hidden="true" href="#cb253-41" tabindex="-1"></a></span>
<span id="cb253-42"><a aria-hidden="true" href="#cb253-42" tabindex="-1"></a>    <span class="co">/* CPU cost: tuples √ó (base cost + qual evaluation cost) */</span></span>
<span id="cb253-43"><a aria-hidden="true" href="#cb253-43" tabindex="-1"></a>    get_restriction_qual_cost<span class="op">(</span>root<span class="op">,</span> baserel<span class="op">,</span> param_info<span class="op">,</span> <span class="op">&amp;</span>qpqual_cost<span class="op">);</span></span>
<span id="cb253-44"><a aria-hidden="true" href="#cb253-44" tabindex="-1"></a></span>
<span id="cb253-45"><a aria-hidden="true" href="#cb253-45" tabindex="-1"></a>    startup_cost <span class="op">+=</span> qpqual_cost<span class="op">.</span>startup<span class="op">;</span></span>
<span id="cb253-46"><a aria-hidden="true" href="#cb253-46" tabindex="-1"></a>    cpu_per_tuple <span class="op">=</span> cpu_tuple_cost <span class="op">+</span> qpqual_cost<span class="op">.</span>per_tuple<span class="op">;</span></span>
<span id="cb253-47"><a aria-hidden="true" href="#cb253-47" tabindex="-1"></a>    cpu_run_cost <span class="op">=</span> cpu_per_tuple <span class="op">*</span> baserel<span class="op">-&gt;</span>tuples<span class="op">;</span></span>
<span id="cb253-48"><a aria-hidden="true" href="#cb253-48" tabindex="-1"></a></span>
<span id="cb253-49"><a aria-hidden="true" href="#cb253-49" tabindex="-1"></a>    <span class="co">/* Total cost */</span></span>
<span id="cb253-50"><a aria-hidden="true" href="#cb253-50" tabindex="-1"></a>    path<span class="op">-&gt;</span>startup_cost <span class="op">=</span> startup_cost<span class="op">;</span></span>
<span id="cb253-51"><a aria-hidden="true" href="#cb253-51" tabindex="-1"></a>    path<span class="op">-&gt;</span>total_cost <span class="op">=</span> startup_cost <span class="op">+</span> cpu_run_cost <span class="op">+</span> disk_run_cost<span class="op">;</span></span>
<span id="cb253-52"><a aria-hidden="true" href="#cb253-52" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>Formula</strong>:</p>
<pre><code>Startup Cost = qual_startup_cost
Total Cost = startup_cost +
             (pages √ó seq_page_cost) +
             (tuples √ó (cpu_tuple_cost + qual_per_tuple_cost))</code></pre>
<h3 data-number="4.10.3" id="index-scan-costing"><span class="header-section-number">4.10.3</span> 9.3 Index Scan Costing</h3>
<div class="sourceCode" id="cb255"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb255-1"><a aria-hidden="true" href="#cb255-1" tabindex="-1"></a><span class="co">/*</span></span>
<span id="cb255-2"><a aria-hidden="true" href="#cb255-2" tabindex="-1"></a><span class="co"> * cost_index</span></span>
<span id="cb255-3"><a aria-hidden="true" href="#cb255-3" tabindex="-1"></a><span class="co"> *   Determines and returns the cost of scanning a relation using an index.</span></span>
<span id="cb255-4"><a aria-hidden="true" href="#cb255-4" tabindex="-1"></a><span class="co"> *</span></span>
<span id="cb255-5"><a aria-hidden="true" href="#cb255-5" tabindex="-1"></a><span class="co"> * 'path' describes the indexscan under consideration, and is complete</span></span>
<span id="cb255-6"><a aria-hidden="true" href="#cb255-6" tabindex="-1"></a><span class="co"> *       except for the fields to be set by this routine</span></span>
<span id="cb255-7"><a aria-hidden="true" href="#cb255-7" tabindex="-1"></a><span class="co"> * 'loop_count' is the number of repetitions of the indexscan to factor into</span></span>
<span id="cb255-8"><a aria-hidden="true" href="#cb255-8" tabindex="-1"></a><span class="co"> *       estimates of caching behavior</span></span>
<span id="cb255-9"><a aria-hidden="true" href="#cb255-9" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb255-10"><a aria-hidden="true" href="#cb255-10" tabindex="-1"></a><span class="dt">void</span></span>
<span id="cb255-11"><a aria-hidden="true" href="#cb255-11" tabindex="-1"></a>cost_index<span class="op">(</span>IndexPath <span class="op">*</span>path<span class="op">,</span> PlannerInfo <span class="op">*</span>root<span class="op">,</span> <span class="dt">double</span> loop_count<span class="op">,</span></span>
<span id="cb255-12"><a aria-hidden="true" href="#cb255-12" tabindex="-1"></a>          <span class="dt">bool</span> partial_path<span class="op">)</span></span>
<span id="cb255-13"><a aria-hidden="true" href="#cb255-13" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb255-14"><a aria-hidden="true" href="#cb255-14" tabindex="-1"></a>    IndexOptInfo <span class="op">*</span>index <span class="op">=</span> path<span class="op">-&gt;</span>indexinfo<span class="op">;</span></span>
<span id="cb255-15"><a aria-hidden="true" href="#cb255-15" tabindex="-1"></a>    RelOptInfo <span class="op">*</span>baserel <span class="op">=</span> index<span class="op">-&gt;</span>rel<span class="op">;</span></span>
<span id="cb255-16"><a aria-hidden="true" href="#cb255-16" tabindex="-1"></a>    List       <span class="op">*</span>qpquals<span class="op">;</span></span>
<span id="cb255-17"><a aria-hidden="true" href="#cb255-17" tabindex="-1"></a>    Cost        startup_cost <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb255-18"><a aria-hidden="true" href="#cb255-18" tabindex="-1"></a>    Cost        run_cost <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb255-19"><a aria-hidden="true" href="#cb255-19" tabindex="-1"></a>    Cost        cpu_run_cost <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb255-20"><a aria-hidden="true" href="#cb255-20" tabindex="-1"></a>    Cost        indexStartupCost<span class="op">;</span></span>
<span id="cb255-21"><a aria-hidden="true" href="#cb255-21" tabindex="-1"></a>    Cost        indexTotalCost<span class="op">;</span></span>
<span id="cb255-22"><a aria-hidden="true" href="#cb255-22" tabindex="-1"></a>    Selectivity indexSelectivity<span class="op">;</span></span>
<span id="cb255-23"><a aria-hidden="true" href="#cb255-23" tabindex="-1"></a>    <span class="dt">double</span>      indexCorrelation<span class="op">;</span></span>
<span id="cb255-24"><a aria-hidden="true" href="#cb255-24" tabindex="-1"></a>    <span class="dt">double</span>      csquared<span class="op">;</span></span>
<span id="cb255-25"><a aria-hidden="true" href="#cb255-25" tabindex="-1"></a>    <span class="dt">double</span>      spc_random_page_cost<span class="op">;</span></span>
<span id="cb255-26"><a aria-hidden="true" href="#cb255-26" tabindex="-1"></a>    Cost        min_IO_cost<span class="op">,</span></span>
<span id="cb255-27"><a aria-hidden="true" href="#cb255-27" tabindex="-1"></a>                max_IO_cost<span class="op">;</span></span>
<span id="cb255-28"><a aria-hidden="true" href="#cb255-28" tabindex="-1"></a>    QualCost    qpqual_cost<span class="op">;</span></span>
<span id="cb255-29"><a aria-hidden="true" href="#cb255-29" tabindex="-1"></a>    Cost        cpu_per_tuple<span class="op">;</span></span>
<span id="cb255-30"><a aria-hidden="true" href="#cb255-30" tabindex="-1"></a>    <span class="dt">double</span>      tuples_fetched<span class="op">;</span></span>
<span id="cb255-31"><a aria-hidden="true" href="#cb255-31" tabindex="-1"></a>    <span class="dt">double</span>      pages_fetched<span class="op">;</span></span>
<span id="cb255-32"><a aria-hidden="true" href="#cb255-32" tabindex="-1"></a></span>
<span id="cb255-33"><a aria-hidden="true" href="#cb255-33" tabindex="-1"></a>    <span class="co">/* ... complex index cost calculation ... */</span></span>
<span id="cb255-34"><a aria-hidden="true" href="#cb255-34" tabindex="-1"></a></span>
<span id="cb255-35"><a aria-hidden="true" href="#cb255-35" tabindex="-1"></a>    <span class="co">/*</span></span>
<span id="cb255-36"><a aria-hidden="true" href="#cb255-36" tabindex="-1"></a><span class="co">     * Estimate number of main-table pages fetched</span></span>
<span id="cb255-37"><a aria-hidden="true" href="#cb255-37" tabindex="-1"></a><span class="co">     */</span></span>
<span id="cb255-38"><a aria-hidden="true" href="#cb255-38" tabindex="-1"></a>    tuples_fetched <span class="op">=</span> clamp_row_est<span class="op">(</span>indexSelectivity <span class="op">*</span> baserel<span class="op">-&gt;</span>tuples<span class="op">);</span></span>
<span id="cb255-39"><a aria-hidden="true" href="#cb255-39" tabindex="-1"></a></span>
<span id="cb255-40"><a aria-hidden="true" href="#cb255-40" tabindex="-1"></a>    <span class="co">/* Account for index correlation */</span></span>
<span id="cb255-41"><a aria-hidden="true" href="#cb255-41" tabindex="-1"></a>    pages_fetched <span class="op">=</span> index_pages_fetched<span class="op">(</span>tuples_fetched<span class="op">,</span></span>
<span id="cb255-42"><a aria-hidden="true" href="#cb255-42" tabindex="-1"></a>                                       baserel<span class="op">-&gt;</span>pages<span class="op">,</span></span>
<span id="cb255-43"><a aria-hidden="true" href="#cb255-43" tabindex="-1"></a>                                       <span class="op">(</span><span class="dt">double</span><span class="op">)</span> index<span class="op">-&gt;</span>pages<span class="op">,</span></span>
<span id="cb255-44"><a aria-hidden="true" href="#cb255-44" tabindex="-1"></a>                                       root<span class="op">);</span></span>
<span id="cb255-45"><a aria-hidden="true" href="#cb255-45" tabindex="-1"></a></span>
<span id="cb255-46"><a aria-hidden="true" href="#cb255-46" tabindex="-1"></a>    <span class="co">/*</span></span>
<span id="cb255-47"><a aria-hidden="true" href="#cb255-47" tabindex="-1"></a><span class="co">     * Random access is more expensive than sequential</span></span>
<span id="cb255-48"><a aria-hidden="true" href="#cb255-48" tabindex="-1"></a><span class="co">     */</span></span>
<span id="cb255-49"><a aria-hidden="true" href="#cb255-49" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>loop_count <span class="op">&gt;</span> <span class="dv">1</span><span class="op">)</span></span>
<span id="cb255-50"><a aria-hidden="true" href="#cb255-50" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb255-51"><a aria-hidden="true" href="#cb255-51" tabindex="-1"></a>        <span class="co">/* Multiple iterations - assume some caching */</span></span>
<span id="cb255-52"><a aria-hidden="true" href="#cb255-52" tabindex="-1"></a>        pages_fetched <span class="op">=</span> index_pages_fetched<span class="op">(</span>tuples_fetched<span class="op">,</span></span>
<span id="cb255-53"><a aria-hidden="true" href="#cb255-53" tabindex="-1"></a>                                           baserel<span class="op">-&gt;</span>pages<span class="op">,</span></span>
<span id="cb255-54"><a aria-hidden="true" href="#cb255-54" tabindex="-1"></a>                                           <span class="op">(</span><span class="dt">double</span><span class="op">)</span> index<span class="op">-&gt;</span>pages<span class="op">,</span></span>
<span id="cb255-55"><a aria-hidden="true" href="#cb255-55" tabindex="-1"></a>                                           root<span class="op">);</span></span>
<span id="cb255-56"><a aria-hidden="true" href="#cb255-56" tabindex="-1"></a>        <span class="co">/* Adjust for caching */</span></span>
<span id="cb255-57"><a aria-hidden="true" href="#cb255-57" tabindex="-1"></a>        pages_fetched <span class="op">=</span> pages_fetched <span class="op">*</span> sqrt<span class="op">(</span>loop_count<span class="op">);</span></span>
<span id="cb255-58"><a aria-hidden="true" href="#cb255-58" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb255-59"><a aria-hidden="true" href="#cb255-59" tabindex="-1"></a></span>
<span id="cb255-60"><a aria-hidden="true" href="#cb255-60" tabindex="-1"></a>    <span class="co">/* I/O cost */</span></span>
<span id="cb255-61"><a aria-hidden="true" href="#cb255-61" tabindex="-1"></a>    run_cost <span class="op">+=</span> pages_fetched <span class="op">*</span> spc_random_page_cost<span class="op">;</span></span>
<span id="cb255-62"><a aria-hidden="true" href="#cb255-62" tabindex="-1"></a></span>
<span id="cb255-63"><a aria-hidden="true" href="#cb255-63" tabindex="-1"></a>    <span class="co">/* CPU cost */</span></span>
<span id="cb255-64"><a aria-hidden="true" href="#cb255-64" tabindex="-1"></a>    cpu_per_tuple <span class="op">=</span> cpu_tuple_cost <span class="op">+</span> qpqual_cost<span class="op">.</span>per_tuple<span class="op">;</span></span>
<span id="cb255-65"><a aria-hidden="true" href="#cb255-65" tabindex="-1"></a>    run_cost <span class="op">+=</span> cpu_per_tuple <span class="op">*</span> tuples_fetched<span class="op">;</span></span>
<span id="cb255-66"><a aria-hidden="true" href="#cb255-66" tabindex="-1"></a></span>
<span id="cb255-67"><a aria-hidden="true" href="#cb255-67" tabindex="-1"></a>    path<span class="op">-&gt;</span>path<span class="op">.</span>startup_cost <span class="op">=</span> startup_cost<span class="op">;</span></span>
<span id="cb255-68"><a aria-hidden="true" href="#cb255-68" tabindex="-1"></a>    path<span class="op">-&gt;</span>path<span class="op">.</span>total_cost <span class="op">=</span> startup_cost <span class="op">+</span> run_cost<span class="op">;</span></span>
<span id="cb255-69"><a aria-hidden="true" href="#cb255-69" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 data-number="4.10.4" id="join-costing"><span class="header-section-number">4.10.4</span> 9.4 Join Costing</h3>
<p><strong>Nested Loop</strong>:</p>
<pre><code>Cost = outer_cost +
       (outer_rows √ó inner_cost) +
       (outer_rows √ó inner_rows √ó cpu_tuple_cost)</code></pre>
<p><strong>Hash Join</strong>:</p>
<pre><code>Cost = outer_cost +
       inner_cost +
       (hash_build_cost) +
       (outer_rows √ó cpu_operator_cost) +  /* hash probe */
       (matched_rows √ó cpu_tuple_cost)      /* join processing */</code></pre>
<p><strong>Merge Join</strong>:</p>
<pre><code>Cost = outer_sort_cost +
       inner_sort_cost +
       (outer_rows + inner_rows) √ó cpu_operator_cost  /* merge */</code></pre>
<h3 data-number="4.10.5" id="selectivity-estimation"><span class="header-section-number">4.10.5</span> 9.5 Selectivity
Estimation</h3>
<p>The optimizer estimates what fraction of rows satisfy a
condition:</p>
<div class="sourceCode" id="cb259"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb259-1"><a aria-hidden="true" href="#cb259-1" tabindex="-1"></a><span class="co">/*</span></span>
<span id="cb259-2"><a aria-hidden="true" href="#cb259-2" tabindex="-1"></a><span class="co"> * clauselist_selectivity -</span></span>
<span id="cb259-3"><a aria-hidden="true" href="#cb259-3" tabindex="-1"></a><span class="co"> *   Compute the selectivity of an implicitly-ANDed list of boolean</span></span>
<span id="cb259-4"><a aria-hidden="true" href="#cb259-4" tabindex="-1"></a><span class="co"> *   expression clauses.  The list can be empty, in which case 1.0</span></span>
<span id="cb259-5"><a aria-hidden="true" href="#cb259-5" tabindex="-1"></a><span class="co"> *   should be returned.</span></span>
<span id="cb259-6"><a aria-hidden="true" href="#cb259-6" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb259-7"><a aria-hidden="true" href="#cb259-7" tabindex="-1"></a>Selectivity</span>
<span id="cb259-8"><a aria-hidden="true" href="#cb259-8" tabindex="-1"></a>clauselist_selectivity<span class="op">(</span>PlannerInfo <span class="op">*</span>root<span class="op">,</span></span>
<span id="cb259-9"><a aria-hidden="true" href="#cb259-9" tabindex="-1"></a>                      List <span class="op">*</span>clauses<span class="op">,</span></span>
<span id="cb259-10"><a aria-hidden="true" href="#cb259-10" tabindex="-1"></a>                      <span class="dt">int</span> varRelid<span class="op">,</span></span>
<span id="cb259-11"><a aria-hidden="true" href="#cb259-11" tabindex="-1"></a>                      JoinType jointype<span class="op">,</span></span>
<span id="cb259-12"><a aria-hidden="true" href="#cb259-12" tabindex="-1"></a>                      SpecialJoinInfo <span class="op">*</span>sjinfo<span class="op">)</span></span>
<span id="cb259-13"><a aria-hidden="true" href="#cb259-13" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb259-14"><a aria-hidden="true" href="#cb259-14" tabindex="-1"></a>    Selectivity s1 <span class="op">=</span> <span class="fl">1.0</span><span class="op">;</span></span>
<span id="cb259-15"><a aria-hidden="true" href="#cb259-15" tabindex="-1"></a>    ListCell   <span class="op">*</span>l<span class="op">;</span></span>
<span id="cb259-16"><a aria-hidden="true" href="#cb259-16" tabindex="-1"></a></span>
<span id="cb259-17"><a aria-hidden="true" href="#cb259-17" tabindex="-1"></a>    foreach<span class="op">(</span>l<span class="op">,</span> clauses<span class="op">)</span></span>
<span id="cb259-18"><a aria-hidden="true" href="#cb259-18" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb259-19"><a aria-hidden="true" href="#cb259-19" tabindex="-1"></a>        Node       <span class="op">*</span>clause <span class="op">=</span> <span class="op">(</span>Node <span class="op">*)</span> lfirst<span class="op">(</span>l<span class="op">);</span></span>
<span id="cb259-20"><a aria-hidden="true" href="#cb259-20" tabindex="-1"></a>        Selectivity s2<span class="op">;</span></span>
<span id="cb259-21"><a aria-hidden="true" href="#cb259-21" tabindex="-1"></a></span>
<span id="cb259-22"><a aria-hidden="true" href="#cb259-22" tabindex="-1"></a>        <span class="co">/* Estimate selectivity of this clause */</span></span>
<span id="cb259-23"><a aria-hidden="true" href="#cb259-23" tabindex="-1"></a>        s2 <span class="op">=</span> clause_selectivity<span class="op">(</span>root<span class="op">,</span> clause<span class="op">,</span> varRelid<span class="op">,</span> jointype<span class="op">,</span> sjinfo<span class="op">);</span></span>
<span id="cb259-24"><a aria-hidden="true" href="#cb259-24" tabindex="-1"></a></span>
<span id="cb259-25"><a aria-hidden="true" href="#cb259-25" tabindex="-1"></a>        <span class="co">/* Combine estimates (assumes independence) */</span></span>
<span id="cb259-26"><a aria-hidden="true" href="#cb259-26" tabindex="-1"></a>        s1 <span class="op">=</span> s1 <span class="op">*</span> s2<span class="op">;</span></span>
<span id="cb259-27"><a aria-hidden="true" href="#cb259-27" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb259-28"><a aria-hidden="true" href="#cb259-28" tabindex="-1"></a></span>
<span id="cb259-29"><a aria-hidden="true" href="#cb259-29" tabindex="-1"></a>    <span class="cf">return</span> s1<span class="op">;</span></span>
<span id="cb259-30"><a aria-hidden="true" href="#cb259-30" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>Common Selectivity Estimates</strong>: -
<code>col = constant</code>: 1 / n_distinct(col) -
<code>col &gt; constant</code>: Depends on histogram -
<code>col IS NULL</code>: null_frac statistic -
<code>col LIKE 'prefix%'</code>: Pattern-based estimate</p>
<hr/>
<h2 data-number="4.11" id="expression-evaluation"><span class="header-section-number">4.11</span> 10. Expression Evaluation</h2>
<p>PostgreSQL compiles expressions into a bytecode-like format for
efficient evaluation.</p>
<h3 data-number="4.11.1" id="exprstate-structure"><span class="header-section-number">4.11.1</span> 10.1 ExprState
Structure</h3>
<p><strong>Location</strong>:
<code>/home/user/postgres/src/include/nodes/execnodes.h</code> (lines
83-147)</p>
<div class="sourceCode" id="cb260"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb260-1"><a aria-hidden="true" href="#cb260-1" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> ExprState</span>
<span id="cb260-2"><a aria-hidden="true" href="#cb260-2" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb260-3"><a aria-hidden="true" href="#cb260-3" tabindex="-1"></a>    NodeTag     type<span class="op">;</span></span>
<span id="cb260-4"><a aria-hidden="true" href="#cb260-4" tabindex="-1"></a></span>
<span id="cb260-5"><a aria-hidden="true" href="#cb260-5" tabindex="-1"></a>    uint8       flags<span class="op">;</span>          <span class="co">/* bitmask of EEO_FLAG_* bits */</span></span>
<span id="cb260-6"><a aria-hidden="true" href="#cb260-6" tabindex="-1"></a></span>
<span id="cb260-7"><a aria-hidden="true" href="#cb260-7" tabindex="-1"></a>    <span class="dt">bool</span>        resnull<span class="op">;</span>        <span class="co">/* current null flag for result */</span></span>
<span id="cb260-8"><a aria-hidden="true" href="#cb260-8" tabindex="-1"></a>    Datum       resvalue<span class="op">;</span>       <span class="co">/* current value for result */</span></span>
<span id="cb260-9"><a aria-hidden="true" href="#cb260-9" tabindex="-1"></a></span>
<span id="cb260-10"><a aria-hidden="true" href="#cb260-10" tabindex="-1"></a>    TupleTableSlot <span class="op">*</span>resultslot<span class="op">;</span> <span class="co">/* slot for result if projecting a tuple */</span></span>
<span id="cb260-11"><a aria-hidden="true" href="#cb260-11" tabindex="-1"></a></span>
<span id="cb260-12"><a aria-hidden="true" href="#cb260-12" tabindex="-1"></a>    <span class="kw">struct</span> ExprEvalStep <span class="op">*</span>steps<span class="op">;</span> <span class="co">/* array of execution steps */</span></span>
<span id="cb260-13"><a aria-hidden="true" href="#cb260-13" tabindex="-1"></a></span>
<span id="cb260-14"><a aria-hidden="true" href="#cb260-14" tabindex="-1"></a>    ExprStateEvalFunc evalfunc<span class="op">;</span> <span class="co">/* function to actually evaluate expression */</span></span>
<span id="cb260-15"><a aria-hidden="true" href="#cb260-15" tabindex="-1"></a></span>
<span id="cb260-16"><a aria-hidden="true" href="#cb260-16" tabindex="-1"></a>    Expr       <span class="op">*</span>expr<span class="op">;</span>           <span class="co">/* original expression tree (for debugging) */</span></span>
<span id="cb260-17"><a aria-hidden="true" href="#cb260-17" tabindex="-1"></a></span>
<span id="cb260-18"><a aria-hidden="true" href="#cb260-18" tabindex="-1"></a>    <span class="dt">void</span>       <span class="op">*</span>evalfunc_private<span class="op">;</span>   <span class="co">/* private state for evalfunc */</span></span>
<span id="cb260-19"><a aria-hidden="true" href="#cb260-19" tabindex="-1"></a></span>
<span id="cb260-20"><a aria-hidden="true" href="#cb260-20" tabindex="-1"></a>    <span class="co">/* Fields used during compilation */</span></span>
<span id="cb260-21"><a aria-hidden="true" href="#cb260-21" tabindex="-1"></a>    <span class="dt">int</span>         steps_len<span class="op">;</span>      <span class="co">/* number of steps currently */</span></span>
<span id="cb260-22"><a aria-hidden="true" href="#cb260-22" tabindex="-1"></a>    <span class="dt">int</span>         steps_alloc<span class="op">;</span>    <span class="co">/* allocated length of steps array */</span></span>
<span id="cb260-23"><a aria-hidden="true" href="#cb260-23" tabindex="-1"></a></span>
<span id="cb260-24"><a aria-hidden="true" href="#cb260-24" tabindex="-1"></a>    PlanState  <span class="op">*</span>parent<span class="op">;</span>         <span class="co">/* parent PlanState node, if any */</span></span>
<span id="cb260-25"><a aria-hidden="true" href="#cb260-25" tabindex="-1"></a>    ParamListInfo ext_params<span class="op">;</span>   <span class="co">/* for compiling PARAM_EXTERN nodes */</span></span>
<span id="cb260-26"><a aria-hidden="true" href="#cb260-26" tabindex="-1"></a></span>
<span id="cb260-27"><a aria-hidden="true" href="#cb260-27" tabindex="-1"></a>    Datum      <span class="op">*</span>innermost_caseval<span class="op">;</span></span>
<span id="cb260-28"><a aria-hidden="true" href="#cb260-28" tabindex="-1"></a>    <span class="dt">bool</span>       <span class="op">*</span>innermost_casenull<span class="op">;</span></span>
<span id="cb260-29"><a aria-hidden="true" href="#cb260-29" tabindex="-1"></a></span>
<span id="cb260-30"><a aria-hidden="true" href="#cb260-30" tabindex="-1"></a>    Datum      <span class="op">*</span>innermost_domainval<span class="op">;</span></span>
<span id="cb260-31"><a aria-hidden="true" href="#cb260-31" tabindex="-1"></a>    <span class="dt">bool</span>       <span class="op">*</span>innermost_domainnull<span class="op">;</span></span>
<span id="cb260-32"><a aria-hidden="true" href="#cb260-32" tabindex="-1"></a><span class="op">}</span> ExprState<span class="op">;</span></span></code></pre></div>
<h3 data-number="4.11.2" id="expression-compilation"><span class="header-section-number">4.11.2</span> 10.2 Expression
Compilation</h3>
<p><strong>Location</strong>:
<code>/home/user/postgres/src/backend/executor/execExpr.c</code></p>
<div class="sourceCode" id="cb261"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb261-1"><a aria-hidden="true" href="#cb261-1" tabindex="-1"></a><span class="co">/*</span></span>
<span id="cb261-2"><a aria-hidden="true" href="#cb261-2" tabindex="-1"></a><span class="co"> * ExecInitExpr: prepare an expression tree for execution</span></span>
<span id="cb261-3"><a aria-hidden="true" href="#cb261-3" tabindex="-1"></a><span class="co"> *</span></span>
<span id="cb261-4"><a aria-hidden="true" href="#cb261-4" tabindex="-1"></a><span class="co"> * This function builds an ExprState tree describing the computation</span></span>
<span id="cb261-5"><a aria-hidden="true" href="#cb261-5" tabindex="-1"></a><span class="co"> * that needs to be performed for the given Expr node tree.</span></span>
<span id="cb261-6"><a aria-hidden="true" href="#cb261-6" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb261-7"><a aria-hidden="true" href="#cb261-7" tabindex="-1"></a>ExprState <span class="op">*</span></span>
<span id="cb261-8"><a aria-hidden="true" href="#cb261-8" tabindex="-1"></a>ExecInitExpr<span class="op">(</span>Expr <span class="op">*</span>node<span class="op">,</span> PlanState <span class="op">*</span>parent<span class="op">)</span></span>
<span id="cb261-9"><a aria-hidden="true" href="#cb261-9" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb261-10"><a aria-hidden="true" href="#cb261-10" tabindex="-1"></a>    ExprState  <span class="op">*</span>state<span class="op">;</span></span>
<span id="cb261-11"><a aria-hidden="true" href="#cb261-11" tabindex="-1"></a>    ExprEvalStep scratch <span class="op">=</span> <span class="op">{</span><span class="dv">0</span><span class="op">};</span></span>
<span id="cb261-12"><a aria-hidden="true" href="#cb261-12" tabindex="-1"></a></span>
<span id="cb261-13"><a aria-hidden="true" href="#cb261-13" tabindex="-1"></a>    <span class="co">/* Allocate ExprState */</span></span>
<span id="cb261-14"><a aria-hidden="true" href="#cb261-14" tabindex="-1"></a>    state <span class="op">=</span> makeNode<span class="op">(</span>ExprState<span class="op">);</span></span>
<span id="cb261-15"><a aria-hidden="true" href="#cb261-15" tabindex="-1"></a>    state<span class="op">-&gt;</span>expr <span class="op">=</span> node<span class="op">;</span></span>
<span id="cb261-16"><a aria-hidden="true" href="#cb261-16" tabindex="-1"></a>    state<span class="op">-&gt;</span>parent <span class="op">=</span> parent<span class="op">;</span></span>
<span id="cb261-17"><a aria-hidden="true" href="#cb261-17" tabindex="-1"></a>    state<span class="op">-&gt;</span>ext_params <span class="op">=</span> NULL<span class="op">;</span></span>
<span id="cb261-18"><a aria-hidden="true" href="#cb261-18" tabindex="-1"></a></span>
<span id="cb261-19"><a aria-hidden="true" href="#cb261-19" tabindex="-1"></a>    <span class="co">/* Initialize step array */</span></span>
<span id="cb261-20"><a aria-hidden="true" href="#cb261-20" tabindex="-1"></a>    state<span class="op">-&gt;</span>steps_len <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb261-21"><a aria-hidden="true" href="#cb261-21" tabindex="-1"></a>    state<span class="op">-&gt;</span>steps_alloc <span class="op">=</span> <span class="dv">16</span><span class="op">;</span></span>
<span id="cb261-22"><a aria-hidden="true" href="#cb261-22" tabindex="-1"></a>    state<span class="op">-&gt;</span>steps <span class="op">=</span> palloc<span class="op">(</span>state<span class="op">-&gt;</span>steps_alloc <span class="op">*</span> <span class="kw">sizeof</span><span class="op">(</span>ExprEvalStep<span class="op">));</span></span>
<span id="cb261-23"><a aria-hidden="true" href="#cb261-23" tabindex="-1"></a></span>
<span id="cb261-24"><a aria-hidden="true" href="#cb261-24" tabindex="-1"></a>    <span class="co">/* Compile expression into steps */</span></span>
<span id="cb261-25"><a aria-hidden="true" href="#cb261-25" tabindex="-1"></a>    ExecInitExprRec<span class="op">(</span>node<span class="op">,</span> state<span class="op">,</span> <span class="op">&amp;</span>state<span class="op">-&gt;</span>resvalue<span class="op">,</span> <span class="op">&amp;</span>state<span class="op">-&gt;</span>resnull<span class="op">);</span></span>
<span id="cb261-26"><a aria-hidden="true" href="#cb261-26" tabindex="-1"></a></span>
<span id="cb261-27"><a aria-hidden="true" href="#cb261-27" tabindex="-1"></a>    <span class="co">/* Add final step */</span></span>
<span id="cb261-28"><a aria-hidden="true" href="#cb261-28" tabindex="-1"></a>    scratch<span class="op">.</span>opcode <span class="op">=</span> EEOP_DONE<span class="op">;</span></span>
<span id="cb261-29"><a aria-hidden="true" href="#cb261-29" tabindex="-1"></a>    ExprEvalPushStep<span class="op">(</span>state<span class="op">,</span> <span class="op">&amp;</span>scratch<span class="op">);</span></span>
<span id="cb261-30"><a aria-hidden="true" href="#cb261-30" tabindex="-1"></a></span>
<span id="cb261-31"><a aria-hidden="true" href="#cb261-31" tabindex="-1"></a>    <span class="co">/* Set evaluation function */</span></span>
<span id="cb261-32"><a aria-hidden="true" href="#cb261-32" tabindex="-1"></a>    ExecReadyExpr<span class="op">(</span>state<span class="op">);</span></span>
<span id="cb261-33"><a aria-hidden="true" href="#cb261-33" tabindex="-1"></a></span>
<span id="cb261-34"><a aria-hidden="true" href="#cb261-34" tabindex="-1"></a>    <span class="cf">return</span> state<span class="op">;</span></span>
<span id="cb261-35"><a aria-hidden="true" href="#cb261-35" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 data-number="4.11.3" id="expression-steps"><span class="header-section-number">4.11.3</span> 10.3 Expression Steps</h3>
<p>Expressions are compiled into a sequence of steps:</p>
<div class="sourceCode" id="cb262"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb262-1"><a aria-hidden="true" href="#cb262-1" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">enum</span> ExprEvalOp</span>
<span id="cb262-2"><a aria-hidden="true" href="#cb262-2" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb262-3"><a aria-hidden="true" href="#cb262-3" tabindex="-1"></a>    <span class="co">/* Entire expression has been evaluated */</span></span>
<span id="cb262-4"><a aria-hidden="true" href="#cb262-4" tabindex="-1"></a>    EEOP_DONE<span class="op">,</span></span>
<span id="cb262-5"><a aria-hidden="true" href="#cb262-5" tabindex="-1"></a></span>
<span id="cb262-6"><a aria-hidden="true" href="#cb262-6" tabindex="-1"></a>    <span class="co">/* Push a NULL onto the stack */</span></span>
<span id="cb262-7"><a aria-hidden="true" href="#cb262-7" tabindex="-1"></a>    EEOP_CONST<span class="op">,</span></span>
<span id="cb262-8"><a aria-hidden="true" href="#cb262-8" tabindex="-1"></a></span>
<span id="cb262-9"><a aria-hidden="true" href="#cb262-9" tabindex="-1"></a>    <span class="co">/* Fetch a parameter value */</span></span>
<span id="cb262-10"><a aria-hidden="true" href="#cb262-10" tabindex="-1"></a>    EEOP_PARAM_EXTERN<span class="op">,</span></span>
<span id="cb262-11"><a aria-hidden="true" href="#cb262-11" tabindex="-1"></a>    EEOP_PARAM_EXEC<span class="op">,</span></span>
<span id="cb262-12"><a aria-hidden="true" href="#cb262-12" tabindex="-1"></a></span>
<span id="cb262-13"><a aria-hidden="true" href="#cb262-13" tabindex="-1"></a>    <span class="co">/* Fetch a column from a tuple */</span></span>
<span id="cb262-14"><a aria-hidden="true" href="#cb262-14" tabindex="-1"></a>    EEOP_SCAN_FETCHSOME<span class="op">,</span></span>
<span id="cb262-15"><a aria-hidden="true" href="#cb262-15" tabindex="-1"></a>    EEOP_SCAN_VAR<span class="op">,</span></span>
<span id="cb262-16"><a aria-hidden="true" href="#cb262-16" tabindex="-1"></a>    EEOP_INNER_VAR<span class="op">,</span></span>
<span id="cb262-17"><a aria-hidden="true" href="#cb262-17" tabindex="-1"></a>    EEOP_OUTER_VAR<span class="op">,</span></span>
<span id="cb262-18"><a aria-hidden="true" href="#cb262-18" tabindex="-1"></a></span>
<span id="cb262-19"><a aria-hidden="true" href="#cb262-19" tabindex="-1"></a>    <span class="co">/* Evaluate a function call */</span></span>
<span id="cb262-20"><a aria-hidden="true" href="#cb262-20" tabindex="-1"></a>    EEOP_FUNCEXPR<span class="op">,</span></span>
<span id="cb262-21"><a aria-hidden="true" href="#cb262-21" tabindex="-1"></a>    EEOP_FUNCEXPR_STRICT<span class="op">,</span></span>
<span id="cb262-22"><a aria-hidden="true" href="#cb262-22" tabindex="-1"></a></span>
<span id="cb262-23"><a aria-hidden="true" href="#cb262-23" tabindex="-1"></a>    <span class="co">/* Boolean operators */</span></span>
<span id="cb262-24"><a aria-hidden="true" href="#cb262-24" tabindex="-1"></a>    EEOP_BOOL_AND_STEP_FIRST<span class="op">,</span></span>
<span id="cb262-25"><a aria-hidden="true" href="#cb262-25" tabindex="-1"></a>    EEOP_BOOL_AND_STEP<span class="op">,</span></span>
<span id="cb262-26"><a aria-hidden="true" href="#cb262-26" tabindex="-1"></a>    EEOP_BOOL_OR_STEP_FIRST<span class="op">,</span></span>
<span id="cb262-27"><a aria-hidden="true" href="#cb262-27" tabindex="-1"></a>    EEOP_BOOL_OR_STEP<span class="op">,</span></span>
<span id="cb262-28"><a aria-hidden="true" href="#cb262-28" tabindex="-1"></a>    EEOP_BOOL_NOT_STEP<span class="op">,</span></span>
<span id="cb262-29"><a aria-hidden="true" href="#cb262-29" tabindex="-1"></a></span>
<span id="cb262-30"><a aria-hidden="true" href="#cb262-30" tabindex="-1"></a>    <span class="co">/* Operators */</span></span>
<span id="cb262-31"><a aria-hidden="true" href="#cb262-31" tabindex="-1"></a>    EEOP_QUAL<span class="op">,</span></span>
<span id="cb262-32"><a aria-hidden="true" href="#cb262-32" tabindex="-1"></a>    EEOP_JUMP<span class="op">,</span></span>
<span id="cb262-33"><a aria-hidden="true" href="#cb262-33" tabindex="-1"></a>    EEOP_JUMP_IF_NULL<span class="op">,</span></span>
<span id="cb262-34"><a aria-hidden="true" href="#cb262-34" tabindex="-1"></a>    EEOP_JUMP_IF_NOT_NULL<span class="op">,</span></span>
<span id="cb262-35"><a aria-hidden="true" href="#cb262-35" tabindex="-1"></a>    EEOP_JUMP_IF_NOT_TRUE<span class="op">,</span></span>
<span id="cb262-36"><a aria-hidden="true" href="#cb262-36" tabindex="-1"></a></span>
<span id="cb262-37"><a aria-hidden="true" href="#cb262-37" tabindex="-1"></a>    <span class="co">/* Aggregates */</span></span>
<span id="cb262-38"><a aria-hidden="true" href="#cb262-38" tabindex="-1"></a>    EEOP_AGG_STRICT_DESERIALIZE<span class="op">,</span></span>
<span id="cb262-39"><a aria-hidden="true" href="#cb262-39" tabindex="-1"></a>    EEOP_AGG_DESERIALIZE<span class="op">,</span></span>
<span id="cb262-40"><a aria-hidden="true" href="#cb262-40" tabindex="-1"></a>    EEOP_AGG_STRICT_INPUT_CHECK_ARGS<span class="op">,</span></span>
<span id="cb262-41"><a aria-hidden="true" href="#cb262-41" tabindex="-1"></a>    EEOP_AGG_STRICT_INPUT_CHECK_NULLS<span class="op">,</span></span>
<span id="cb262-42"><a aria-hidden="true" href="#cb262-42" tabindex="-1"></a></span>
<span id="cb262-43"><a aria-hidden="true" href="#cb262-43" tabindex="-1"></a>    <span class="co">/* ... many more opcodes ... */</span></span>
<span id="cb262-44"><a aria-hidden="true" href="#cb262-44" tabindex="-1"></a><span class="op">}</span> ExprEvalOp<span class="op">;</span></span></code></pre></div>
<h3 data-number="4.11.4" id="jit-compilation"><span class="header-section-number">4.11.4</span> 10.4 JIT Compilation</h3>
<p>For frequently-executed expressions, PostgreSQL can use LLVM for JIT
compilation:</p>
<div class="sourceCode" id="cb263"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb263-1"><a aria-hidden="true" href="#cb263-1" tabindex="-1"></a><span class="co">/*</span></span>
<span id="cb263-2"><a aria-hidden="true" href="#cb263-2" tabindex="-1"></a><span class="co"> * llvm_compile_expr -</span></span>
<span id="cb263-3"><a aria-hidden="true" href="#cb263-3" tabindex="-1"></a><span class="co"> *   JIT compile an expression</span></span>
<span id="cb263-4"><a aria-hidden="true" href="#cb263-4" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb263-5"><a aria-hidden="true" href="#cb263-5" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span></span>
<span id="cb263-6"><a aria-hidden="true" href="#cb263-6" tabindex="-1"></a>llvm_compile_expr<span class="op">(</span>ExprState <span class="op">*</span>state<span class="op">)</span></span>
<span id="cb263-7"><a aria-hidden="true" href="#cb263-7" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb263-8"><a aria-hidden="true" href="#cb263-8" tabindex="-1"></a>    PlanState  <span class="op">*</span>parent <span class="op">=</span> state<span class="op">-&gt;</span>parent<span class="op">;</span></span>
<span id="cb263-9"><a aria-hidden="true" href="#cb263-9" tabindex="-1"></a>    LLVMJitContext <span class="op">*</span>context<span class="op">;</span></span>
<span id="cb263-10"><a aria-hidden="true" href="#cb263-10" tabindex="-1"></a>    LLVMModuleRef mod<span class="op">;</span></span>
<span id="cb263-11"><a aria-hidden="true" href="#cb263-11" tabindex="-1"></a>    <span class="dt">char</span>       <span class="op">*</span>funcname<span class="op">;</span></span>
<span id="cb263-12"><a aria-hidden="true" href="#cb263-12" tabindex="-1"></a></span>
<span id="cb263-13"><a aria-hidden="true" href="#cb263-13" tabindex="-1"></a>    <span class="co">/* Initialize LLVM context */</span></span>
<span id="cb263-14"><a aria-hidden="true" href="#cb263-14" tabindex="-1"></a>    context <span class="op">=</span> llvm_create_context<span class="op">(</span>parent<span class="op">-&gt;</span>state<span class="op">-&gt;</span>es_jit_flags<span class="op">);</span></span>
<span id="cb263-15"><a aria-hidden="true" href="#cb263-15" tabindex="-1"></a></span>
<span id="cb263-16"><a aria-hidden="true" href="#cb263-16" tabindex="-1"></a>    <span class="co">/* Create LLVM module for this expression */</span></span>
<span id="cb263-17"><a aria-hidden="true" href="#cb263-17" tabindex="-1"></a>    mod <span class="op">=</span> llvm_mutable_module<span class="op">(</span>context<span class="op">);</span></span>
<span id="cb263-18"><a aria-hidden="true" href="#cb263-18" tabindex="-1"></a></span>
<span id="cb263-19"><a aria-hidden="true" href="#cb263-19" tabindex="-1"></a>    <span class="co">/* Compile each step into LLVM IR */</span></span>
<span id="cb263-20"><a aria-hidden="true" href="#cb263-20" tabindex="-1"></a>    <span class="co">/* ... */</span></span>
<span id="cb263-21"><a aria-hidden="true" href="#cb263-21" tabindex="-1"></a></span>
<span id="cb263-22"><a aria-hidden="true" href="#cb263-22" tabindex="-1"></a>    <span class="co">/* Optimize and finalize */</span></span>
<span id="cb263-23"><a aria-hidden="true" href="#cb263-23" tabindex="-1"></a>    llvm_optimize_module<span class="op">(</span>context<span class="op">,</span> mod<span class="op">);</span></span>
<span id="cb263-24"><a aria-hidden="true" href="#cb263-24" tabindex="-1"></a></span>
<span id="cb263-25"><a aria-hidden="true" href="#cb263-25" tabindex="-1"></a>    <span class="co">/* Replace interpreted eval function with JIT-compiled version */</span></span>
<span id="cb263-26"><a aria-hidden="true" href="#cb263-26" tabindex="-1"></a>    state<span class="op">-&gt;</span>evalfunc <span class="op">=</span> <span class="op">(</span>ExprStateEvalFunc<span class="op">)</span> llvm_get_function<span class="op">(</span>context<span class="op">,</span> funcname<span class="op">);</span></span>
<span id="cb263-27"><a aria-hidden="true" href="#cb263-27" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<hr/>
<h2 data-number="4.12" id="complete-query-example-walkthrough"><span class="header-section-number">4.12</span> 11. Complete Query Example
Walkthrough</h2>
<p>Let‚Äôs walk through the complete processing of a moderately complex
query:</p>
<h3 data-number="4.12.1" id="example-query"><span class="header-section-number">4.12.1</span> 11.1 Example Query</h3>
<div class="sourceCode" id="cb264"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb264-1"><a aria-hidden="true" href="#cb264-1" tabindex="-1"></a><span class="kw">SELECT</span> e.name, e.salary, d.dept_name</span>
<span id="cb264-2"><a aria-hidden="true" href="#cb264-2" tabindex="-1"></a><span class="kw">FROM</span> employees e</span>
<span id="cb264-3"><a aria-hidden="true" href="#cb264-3" tabindex="-1"></a><span class="kw">JOIN</span> departments d <span class="kw">ON</span> e.dept_id <span class="op">=</span> d.dept_id</span>
<span id="cb264-4"><a aria-hidden="true" href="#cb264-4" tabindex="-1"></a><span class="kw">WHERE</span> e.salary <span class="op">&gt;</span> <span class="dv">50000</span></span>
<span id="cb264-5"><a aria-hidden="true" href="#cb264-5" tabindex="-1"></a>  <span class="kw">AND</span> d.location <span class="op">=</span> <span class="st">'New York'</span></span>
<span id="cb264-6"><a aria-hidden="true" href="#cb264-6" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> e.salary <span class="kw">DESC</span></span>
<span id="cb264-7"><a aria-hidden="true" href="#cb264-7" tabindex="-1"></a><span class="kw">LIMIT</span> <span class="dv">10</span>;</span></code></pre></div>
<h3 data-number="4.12.2" id="stage-1-parsing"><span class="header-section-number">4.12.2</span> 11.2 Stage 1: Parsing</h3>
<p><strong>Input</strong>: SQL text string</p>
<p><strong>Lexer Output</strong> (token stream):</p>
<pre><code>SELECT, IDENT(e), DOT, IDENT(name), COMMA,
IDENT(e), DOT, IDENT(salary), COMMA,
IDENT(d), DOT, IDENT(dept_name),
FROM, IDENT(employees), IDENT(e),
JOIN, IDENT(departments), IDENT(d),
ON, IDENT(e), DOT, IDENT(dept_id), EQUALS, IDENT(d), DOT, IDENT(dept_id),
WHERE, IDENT(e), DOT, IDENT(salary), GREATER, ICONST(50000),
AND, IDENT(d), DOT, IDENT(location), EQUALS, SCONST('New York'),
ORDER, BY, IDENT(e), DOT, IDENT(salary), DESC,
LIMIT, ICONST(10), SEMICOLON</code></pre>
<p><strong>Parser Output</strong> (SelectStmt):</p>
<pre><code>SelectStmt {
    targetList: [
        ResTarget { val: ColumnRef([e, name]) },
        ResTarget { val: ColumnRef([e, salary]) },
        ResTarget { val: ColumnRef([d, dept_name]) }
    ],
    fromClause: [
        JoinExpr {
            jointype: JOIN_INNER,
            larg: RangeVar { relname: "employees", alias: "e" },
            rarg: RangeVar { relname: "departments", alias: "d" },
            quals: A_Expr {
                kind: AEXPR_OP,
                name: "=",
                lexpr: ColumnRef([e, dept_id]),
                rexpr: ColumnRef([d, dept_id])
            }
        }
    ],
    whereClause: BoolExpr {
        boolop: AND_EXPR,
        args: [
            A_Expr { /* e.salary &gt; 50000 */ },
            A_Expr { /* d.location = 'New York' */ }
        ]
    },
    sortClause: [
        SortBy { node: ColumnRef([e, salary]), sortby_dir: DESC }
    ],
    limitCount: A_Const { val: 10 }
}</code></pre>
<p><strong>Analyzer Output</strong> (Query):</p>
<div class="sourceCode" id="cb267"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb267-1"><a aria-hidden="true" href="#cb267-1" tabindex="-1"></a>Query <span class="op">{</span></span>
<span id="cb267-2"><a aria-hidden="true" href="#cb267-2" tabindex="-1"></a>    commandType<span class="op">:</span> CMD_SELECT<span class="op">,</span></span>
<span id="cb267-3"><a aria-hidden="true" href="#cb267-3" tabindex="-1"></a></span>
<span id="cb267-4"><a aria-hidden="true" href="#cb267-4" tabindex="-1"></a>    rtable<span class="op">:</span> <span class="op">[</span></span>
<span id="cb267-5"><a aria-hidden="true" href="#cb267-5" tabindex="-1"></a>        RangeTblEntry <span class="op">{</span>  <span class="co">/* #1: employees */</span></span>
<span id="cb267-6"><a aria-hidden="true" href="#cb267-6" tabindex="-1"></a>            rtekind<span class="op">:</span> RTE_RELATION<span class="op">,</span></span>
<span id="cb267-7"><a aria-hidden="true" href="#cb267-7" tabindex="-1"></a>            relid<span class="op">:</span> <span class="op">&lt;</span>OID of employees<span class="op">&gt;,</span></span>
<span id="cb267-8"><a aria-hidden="true" href="#cb267-8" tabindex="-1"></a>            alias<span class="op">:</span> <span class="st">"e"</span><span class="op">,</span></span>
<span id="cb267-9"><a aria-hidden="true" href="#cb267-9" tabindex="-1"></a>            requiredPerms<span class="op">:</span> ACL_SELECT</span>
<span id="cb267-10"><a aria-hidden="true" href="#cb267-10" tabindex="-1"></a>        <span class="op">},</span></span>
<span id="cb267-11"><a aria-hidden="true" href="#cb267-11" tabindex="-1"></a>        RangeTblEntry <span class="op">{</span>  <span class="co">/* #2: departments */</span></span>
<span id="cb267-12"><a aria-hidden="true" href="#cb267-12" tabindex="-1"></a>            rtekind<span class="op">:</span> RTE_RELATION<span class="op">,</span></span>
<span id="cb267-13"><a aria-hidden="true" href="#cb267-13" tabindex="-1"></a>            relid<span class="op">:</span> <span class="op">&lt;</span>OID of departments<span class="op">&gt;,</span></span>
<span id="cb267-14"><a aria-hidden="true" href="#cb267-14" tabindex="-1"></a>            alias<span class="op">:</span> <span class="st">"d"</span><span class="op">,</span></span>
<span id="cb267-15"><a aria-hidden="true" href="#cb267-15" tabindex="-1"></a>            requiredPerms<span class="op">:</span> ACL_SELECT</span>
<span id="cb267-16"><a aria-hidden="true" href="#cb267-16" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb267-17"><a aria-hidden="true" href="#cb267-17" tabindex="-1"></a>    <span class="op">],</span></span>
<span id="cb267-18"><a aria-hidden="true" href="#cb267-18" tabindex="-1"></a></span>
<span id="cb267-19"><a aria-hidden="true" href="#cb267-19" tabindex="-1"></a>    jointree<span class="op">:</span> FromExpr <span class="op">{</span></span>
<span id="cb267-20"><a aria-hidden="true" href="#cb267-20" tabindex="-1"></a>        fromlist<span class="op">:</span> <span class="op">[</span></span>
<span id="cb267-21"><a aria-hidden="true" href="#cb267-21" tabindex="-1"></a>            JoinExpr <span class="op">{</span></span>
<span id="cb267-22"><a aria-hidden="true" href="#cb267-22" tabindex="-1"></a>                jointype<span class="op">:</span> JOIN_INNER<span class="op">,</span></span>
<span id="cb267-23"><a aria-hidden="true" href="#cb267-23" tabindex="-1"></a>                larg<span class="op">:</span> RangeTblRef <span class="op">{</span> rtindex<span class="op">:</span> <span class="dv">1</span> <span class="op">},</span>  <span class="co">/* employees */</span></span>
<span id="cb267-24"><a aria-hidden="true" href="#cb267-24" tabindex="-1"></a>                rarg<span class="op">:</span> RangeTblRef <span class="op">{</span> rtindex<span class="op">:</span> <span class="dv">2</span> <span class="op">},</span>  <span class="co">/* departments */</span></span>
<span id="cb267-25"><a aria-hidden="true" href="#cb267-25" tabindex="-1"></a>                quals<span class="op">:</span> OpExpr <span class="op">{</span></span>
<span id="cb267-26"><a aria-hidden="true" href="#cb267-26" tabindex="-1"></a>                    opno<span class="op">:</span> <span class="op">&lt;</span>OID of int4eq<span class="op">&gt;,</span></span>
<span id="cb267-27"><a aria-hidden="true" href="#cb267-27" tabindex="-1"></a>                    args<span class="op">:</span> <span class="op">[</span></span>
<span id="cb267-28"><a aria-hidden="true" href="#cb267-28" tabindex="-1"></a>                        Var <span class="op">{</span> varno<span class="op">:</span> <span class="dv">1</span><span class="op">,</span> varattno<span class="op">:</span> <span class="dv">3</span> <span class="op">},</span>  <span class="co">/* e.dept_id */</span></span>
<span id="cb267-29"><a aria-hidden="true" href="#cb267-29" tabindex="-1"></a>                        Var <span class="op">{</span> varno<span class="op">:</span> <span class="dv">2</span><span class="op">,</span> varattno<span class="op">:</span> <span class="dv">1</span> <span class="op">}</span>   <span class="co">/* d.dept_id */</span></span>
<span id="cb267-30"><a aria-hidden="true" href="#cb267-30" tabindex="-1"></a>                    <span class="op">]</span></span>
<span id="cb267-31"><a aria-hidden="true" href="#cb267-31" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb267-32"><a aria-hidden="true" href="#cb267-32" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb267-33"><a aria-hidden="true" href="#cb267-33" tabindex="-1"></a>        <span class="op">],</span></span>
<span id="cb267-34"><a aria-hidden="true" href="#cb267-34" tabindex="-1"></a>        quals<span class="op">:</span> BoolExpr <span class="op">{</span></span>
<span id="cb267-35"><a aria-hidden="true" href="#cb267-35" tabindex="-1"></a>            boolop<span class="op">:</span> AND_EXPR<span class="op">,</span></span>
<span id="cb267-36"><a aria-hidden="true" href="#cb267-36" tabindex="-1"></a>            args<span class="op">:</span> <span class="op">[</span></span>
<span id="cb267-37"><a aria-hidden="true" href="#cb267-37" tabindex="-1"></a>                OpExpr <span class="op">{</span>  <span class="co">/* e.salary &gt; 50000 */</span></span>
<span id="cb267-38"><a aria-hidden="true" href="#cb267-38" tabindex="-1"></a>                    opno<span class="op">:</span> <span class="op">&lt;</span>OID of int4gt<span class="op">&gt;,</span></span>
<span id="cb267-39"><a aria-hidden="true" href="#cb267-39" tabindex="-1"></a>                    args<span class="op">:</span> <span class="op">[</span></span>
<span id="cb267-40"><a aria-hidden="true" href="#cb267-40" tabindex="-1"></a>                        Var <span class="op">{</span> varno<span class="op">:</span> <span class="dv">1</span><span class="op">,</span> varattno<span class="op">:</span> <span class="dv">2</span> <span class="op">},</span></span>
<span id="cb267-41"><a aria-hidden="true" href="#cb267-41" tabindex="-1"></a>                        Const <span class="op">{</span> consttype<span class="op">:</span> INT4<span class="op">,</span> constvalue<span class="op">:</span> <span class="dv">50000</span> <span class="op">}</span></span>
<span id="cb267-42"><a aria-hidden="true" href="#cb267-42" tabindex="-1"></a>                    <span class="op">]</span></span>
<span id="cb267-43"><a aria-hidden="true" href="#cb267-43" tabindex="-1"></a>                <span class="op">},</span></span>
<span id="cb267-44"><a aria-hidden="true" href="#cb267-44" tabindex="-1"></a>                OpExpr <span class="op">{</span>  <span class="co">/* d.location = 'New York' */</span></span>
<span id="cb267-45"><a aria-hidden="true" href="#cb267-45" tabindex="-1"></a>                    opno<span class="op">:</span> <span class="op">&lt;</span>OID of texteq<span class="op">&gt;,</span></span>
<span id="cb267-46"><a aria-hidden="true" href="#cb267-46" tabindex="-1"></a>                    args<span class="op">:</span> <span class="op">[</span></span>
<span id="cb267-47"><a aria-hidden="true" href="#cb267-47" tabindex="-1"></a>                        Var <span class="op">{</span> varno<span class="op">:</span> <span class="dv">2</span><span class="op">,</span> varattno<span class="op">:</span> <span class="dv">3</span> <span class="op">},</span></span>
<span id="cb267-48"><a aria-hidden="true" href="#cb267-48" tabindex="-1"></a>                        Const <span class="op">{</span> consttype<span class="op">:</span> TEXT<span class="op">,</span> constvalue<span class="op">:</span> <span class="st">"New York"</span> <span class="op">}</span></span>
<span id="cb267-49"><a aria-hidden="true" href="#cb267-49" tabindex="-1"></a>                    <span class="op">]</span></span>
<span id="cb267-50"><a aria-hidden="true" href="#cb267-50" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb267-51"><a aria-hidden="true" href="#cb267-51" tabindex="-1"></a>            <span class="op">]</span></span>
<span id="cb267-52"><a aria-hidden="true" href="#cb267-52" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb267-53"><a aria-hidden="true" href="#cb267-53" tabindex="-1"></a>    <span class="op">},</span></span>
<span id="cb267-54"><a aria-hidden="true" href="#cb267-54" tabindex="-1"></a></span>
<span id="cb267-55"><a aria-hidden="true" href="#cb267-55" tabindex="-1"></a>    targetList<span class="op">:</span> <span class="op">[</span></span>
<span id="cb267-56"><a aria-hidden="true" href="#cb267-56" tabindex="-1"></a>        TargetEntry <span class="op">{</span></span>
<span id="cb267-57"><a aria-hidden="true" href="#cb267-57" tabindex="-1"></a>            expr<span class="op">:</span> Var <span class="op">{</span> varno<span class="op">:</span> <span class="dv">1</span><span class="op">,</span> varattno<span class="op">:</span> <span class="dv">1</span><span class="op">,</span> vartype<span class="op">:</span> TEXT <span class="op">},</span></span>
<span id="cb267-58"><a aria-hidden="true" href="#cb267-58" tabindex="-1"></a>            resname<span class="op">:</span> <span class="st">"name"</span></span>
<span id="cb267-59"><a aria-hidden="true" href="#cb267-59" tabindex="-1"></a>        <span class="op">},</span></span>
<span id="cb267-60"><a aria-hidden="true" href="#cb267-60" tabindex="-1"></a>        TargetEntry <span class="op">{</span></span>
<span id="cb267-61"><a aria-hidden="true" href="#cb267-61" tabindex="-1"></a>            expr<span class="op">:</span> Var <span class="op">{</span> varno<span class="op">:</span> <span class="dv">1</span><span class="op">,</span> varattno<span class="op">:</span> <span class="dv">2</span><span class="op">,</span> vartype<span class="op">:</span> INT4 <span class="op">},</span></span>
<span id="cb267-62"><a aria-hidden="true" href="#cb267-62" tabindex="-1"></a>            resname<span class="op">:</span> <span class="st">"salary"</span></span>
<span id="cb267-63"><a aria-hidden="true" href="#cb267-63" tabindex="-1"></a>        <span class="op">},</span></span>
<span id="cb267-64"><a aria-hidden="true" href="#cb267-64" tabindex="-1"></a>        TargetEntry <span class="op">{</span></span>
<span id="cb267-65"><a aria-hidden="true" href="#cb267-65" tabindex="-1"></a>            expr<span class="op">:</span> Var <span class="op">{</span> varno<span class="op">:</span> <span class="dv">2</span><span class="op">,</span> varattno<span class="op">:</span> <span class="dv">2</span><span class="op">,</span> vartype<span class="op">:</span> TEXT <span class="op">},</span></span>
<span id="cb267-66"><a aria-hidden="true" href="#cb267-66" tabindex="-1"></a>            resname<span class="op">:</span> <span class="st">"dept_name"</span></span>
<span id="cb267-67"><a aria-hidden="true" href="#cb267-67" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb267-68"><a aria-hidden="true" href="#cb267-68" tabindex="-1"></a>    <span class="op">],</span></span>
<span id="cb267-69"><a aria-hidden="true" href="#cb267-69" tabindex="-1"></a></span>
<span id="cb267-70"><a aria-hidden="true" href="#cb267-70" tabindex="-1"></a>    sortClause<span class="op">:</span> <span class="op">[</span></span>
<span id="cb267-71"><a aria-hidden="true" href="#cb267-71" tabindex="-1"></a>        SortGroupClause <span class="op">{</span></span>
<span id="cb267-72"><a aria-hidden="true" href="#cb267-72" tabindex="-1"></a>            tleSortGroupRef<span class="op">:</span> <span class="dv">2</span><span class="op">,</span>  <span class="co">/* salary */</span></span>
<span id="cb267-73"><a aria-hidden="true" href="#cb267-73" tabindex="-1"></a>            sortop<span class="op">:</span> <span class="op">&lt;</span>OID of int4gt<span class="op">&gt;,</span>  <span class="co">/* DESC */</span></span>
<span id="cb267-74"><a aria-hidden="true" href="#cb267-74" tabindex="-1"></a>            nulls_first<span class="op">:</span> <span class="kw">false</span></span>
<span id="cb267-75"><a aria-hidden="true" href="#cb267-75" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb267-76"><a aria-hidden="true" href="#cb267-76" tabindex="-1"></a>    <span class="op">],</span></span>
<span id="cb267-77"><a aria-hidden="true" href="#cb267-77" tabindex="-1"></a></span>
<span id="cb267-78"><a aria-hidden="true" href="#cb267-78" tabindex="-1"></a>    limitCount<span class="op">:</span> Const <span class="op">{</span> consttype<span class="op">:</span> INT8<span class="op">,</span> constvalue<span class="op">:</span> <span class="dv">10</span> <span class="op">}</span></span>
<span id="cb267-79"><a aria-hidden="true" href="#cb267-79" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 data-number="4.12.3" id="stage-2-rewriting"><span class="header-section-number">4.12.3</span> 11.3 Stage 2: Rewriting</h3>
<p>In this case, no views or rules are involved, so the rewriter passes
the query through unchanged (after checking for any applicable RLS
policies).</p>
<h3 data-number="4.12.4" id="stage-3-planning"><span class="header-section-number">4.12.4</span> 11.4 Stage 3: Planning</h3>
<p><strong>Planner generates multiple paths</strong>:</p>
<p><strong>Path 1: Hash Join</strong></p>
<pre><code>Limit (10 rows)
  ‚Üí Sort (salary DESC)
    ‚Üí Hash Join (e.dept_id = d.dept_id)
      ‚îú‚îÄ Seq Scan on employees
      ‚îÇ  Filter: salary &gt; 50000
      ‚îÇ  Cost: 0..1000, Rows: 5000
      ‚îî‚îÄ Hash
        ‚îî‚îÄ Seq Scan on departments
           Filter: location = 'New York'
           Cost: 0..100, Rows: 5</code></pre>
<p><strong>Cost Calculation</strong>:</p>
<pre><code>Employees Seq Scan:
  - Pages: 100, Tuples: 10000
  - Cost = 100 √ó 1.0 + 10000 √ó 0.01 = 200
  - After filter (50%): 5000 rows

Departments Seq Scan:
  - Pages: 10, Tuples: 50
  - Cost = 10 √ó 1.0 + 50 √ó 0.01 = 10.5
  - After filter (10%): 5 rows

Hash Build:
  - Cost = 5 √ó 0.01 = 0.05

Hash Join:
  - Probe cost: 5000 √ó 0.0025 = 12.5
  - Match processing: ~100 matches √ó 0.01 = 1
  - Total: 200 + 10.5 + 0.05 + 12.5 + 1 = 224.05

Sort:
  - 100 rows √ó log(100) √ó 0.01 = ~6.64

Limit:
  - Negligible

Total: ~230.69</code></pre>
<p><strong>Path 2: Index Nested Loop</strong> (if index exists on
departments.location):</p>
<pre><code>Limit (10 rows)
  ‚Üí Sort (salary DESC)
    ‚Üí Nested Loop
      ‚îú‚îÄ Index Scan on departments using dept_location_idx
      ‚îÇ  Index Cond: location = 'New York'
      ‚îÇ  Cost: 0..20, Rows: 5
      ‚îî‚îÄ Index Scan on employees using emp_dept_idx
         Index Cond: dept_id = d.dept_id
         Filter: salary &gt; 50000
         Cost: 0..50 per loop, Rows: 20</code></pre>
<p><strong>Planner selects best path</strong> (assume Hash Join is
cheaper)</p>
<p><strong>Final PlannedStmt</strong>:</p>
<div class="sourceCode" id="cb271"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb271-1"><a aria-hidden="true" href="#cb271-1" tabindex="-1"></a>PlannedStmt <span class="op">{</span></span>
<span id="cb271-2"><a aria-hidden="true" href="#cb271-2" tabindex="-1"></a>    commandType<span class="op">:</span> CMD_SELECT<span class="op">,</span></span>
<span id="cb271-3"><a aria-hidden="true" href="#cb271-3" tabindex="-1"></a>    planTree<span class="op">:</span> Limit <span class="op">{</span></span>
<span id="cb271-4"><a aria-hidden="true" href="#cb271-4" tabindex="-1"></a>        plan<span class="op">:</span> <span class="op">{</span></span>
<span id="cb271-5"><a aria-hidden="true" href="#cb271-5" tabindex="-1"></a>            startup_cost<span class="op">:</span> <span class="fl">224.05</span><span class="op">,</span></span>
<span id="cb271-6"><a aria-hidden="true" href="#cb271-6" tabindex="-1"></a>            total_cost<span class="op">:</span> <span class="fl">230.69</span><span class="op">,</span></span>
<span id="cb271-7"><a aria-hidden="true" href="#cb271-7" tabindex="-1"></a>            plan_rows<span class="op">:</span> <span class="dv">10</span><span class="op">,</span></span>
<span id="cb271-8"><a aria-hidden="true" href="#cb271-8" tabindex="-1"></a>            plan_width<span class="op">:</span> <span class="dv">44</span></span>
<span id="cb271-9"><a aria-hidden="true" href="#cb271-9" tabindex="-1"></a>        <span class="op">},</span></span>
<span id="cb271-10"><a aria-hidden="true" href="#cb271-10" tabindex="-1"></a>        limitCount<span class="op">:</span> Const <span class="op">{</span> value<span class="op">:</span> <span class="dv">10</span> <span class="op">},</span></span>
<span id="cb271-11"><a aria-hidden="true" href="#cb271-11" tabindex="-1"></a>        lefttree<span class="op">:</span> Sort <span class="op">{</span></span>
<span id="cb271-12"><a aria-hidden="true" href="#cb271-12" tabindex="-1"></a>            plan<span class="op">:</span> <span class="op">{</span></span>
<span id="cb271-13"><a aria-hidden="true" href="#cb271-13" tabindex="-1"></a>                startup_cost<span class="op">:</span> <span class="fl">224.05</span><span class="op">,</span></span>
<span id="cb271-14"><a aria-hidden="true" href="#cb271-14" tabindex="-1"></a>                total_cost<span class="op">:</span> <span class="fl">230.64</span><span class="op">,</span></span>
<span id="cb271-15"><a aria-hidden="true" href="#cb271-15" tabindex="-1"></a>                plan_rows<span class="op">:</span> <span class="dv">100</span><span class="op">,</span></span>
<span id="cb271-16"><a aria-hidden="true" href="#cb271-16" tabindex="-1"></a>                plan_width<span class="op">:</span> <span class="dv">44</span></span>
<span id="cb271-17"><a aria-hidden="true" href="#cb271-17" tabindex="-1"></a>            <span class="op">},</span></span>
<span id="cb271-18"><a aria-hidden="true" href="#cb271-18" tabindex="-1"></a>            sortColIdx<span class="op">:</span> <span class="op">[</span><span class="dv">2</span><span class="op">],</span>  <span class="co">/* salary column */</span></span>
<span id="cb271-19"><a aria-hidden="true" href="#cb271-19" tabindex="-1"></a>            sortOperators<span class="op">:</span> <span class="op">[&lt;</span>OID of int4gt<span class="op">&gt;],</span></span>
<span id="cb271-20"><a aria-hidden="true" href="#cb271-20" tabindex="-1"></a>            lefttree<span class="op">:</span> HashJoin <span class="op">{</span></span>
<span id="cb271-21"><a aria-hidden="true" href="#cb271-21" tabindex="-1"></a>                plan<span class="op">:</span> <span class="op">{</span></span>
<span id="cb271-22"><a aria-hidden="true" href="#cb271-22" tabindex="-1"></a>                    startup_cost<span class="op">:</span> <span class="fl">10.55</span><span class="op">,</span></span>
<span id="cb271-23"><a aria-hidden="true" href="#cb271-23" tabindex="-1"></a>                    total_cost<span class="op">:</span> <span class="fl">224.05</span><span class="op">,</span></span>
<span id="cb271-24"><a aria-hidden="true" href="#cb271-24" tabindex="-1"></a>                    plan_rows<span class="op">:</span> <span class="dv">100</span><span class="op">,</span></span>
<span id="cb271-25"><a aria-hidden="true" href="#cb271-25" tabindex="-1"></a>                    plan_width<span class="op">:</span> <span class="dv">44</span></span>
<span id="cb271-26"><a aria-hidden="true" href="#cb271-26" tabindex="-1"></a>                <span class="op">},</span></span>
<span id="cb271-27"><a aria-hidden="true" href="#cb271-27" tabindex="-1"></a>                hashclauses<span class="op">:</span> <span class="op">[</span></span>
<span id="cb271-28"><a aria-hidden="true" href="#cb271-28" tabindex="-1"></a>                    OpExpr <span class="op">{</span></span>
<span id="cb271-29"><a aria-hidden="true" href="#cb271-29" tabindex="-1"></a>                        opno<span class="op">:</span> <span class="op">&lt;</span>OID of int4eq<span class="op">&gt;,</span></span>
<span id="cb271-30"><a aria-hidden="true" href="#cb271-30" tabindex="-1"></a>                        args<span class="op">:</span> <span class="op">[</span>Var<span class="op">(</span><span class="dv">1</span><span class="op">,</span><span class="dv">3</span><span class="op">),</span> Var<span class="op">(</span><span class="dv">2</span><span class="op">,</span><span class="dv">1</span><span class="op">)]</span></span>
<span id="cb271-31"><a aria-hidden="true" href="#cb271-31" tabindex="-1"></a>                    <span class="op">}</span></span>
<span id="cb271-32"><a aria-hidden="true" href="#cb271-32" tabindex="-1"></a>                <span class="op">],</span></span>
<span id="cb271-33"><a aria-hidden="true" href="#cb271-33" tabindex="-1"></a>                lefttree<span class="op">:</span> SeqScan <span class="op">{</span>  <span class="co">/* employees */</span></span>
<span id="cb271-34"><a aria-hidden="true" href="#cb271-34" tabindex="-1"></a>                    plan<span class="op">:</span> <span class="op">{</span></span>
<span id="cb271-35"><a aria-hidden="true" href="#cb271-35" tabindex="-1"></a>                        startup_cost<span class="op">:</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb271-36"><a aria-hidden="true" href="#cb271-36" tabindex="-1"></a>                        total_cost<span class="op">:</span> <span class="dv">200</span><span class="op">,</span></span>
<span id="cb271-37"><a aria-hidden="true" href="#cb271-37" tabindex="-1"></a>                        plan_rows<span class="op">:</span> <span class="dv">5000</span><span class="op">,</span></span>
<span id="cb271-38"><a aria-hidden="true" href="#cb271-38" tabindex="-1"></a>                        plan_width<span class="op">:</span> <span class="dv">36</span></span>
<span id="cb271-39"><a aria-hidden="true" href="#cb271-39" tabindex="-1"></a>                    <span class="op">},</span></span>
<span id="cb271-40"><a aria-hidden="true" href="#cb271-40" tabindex="-1"></a>                    scanrelid<span class="op">:</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb271-41"><a aria-hidden="true" href="#cb271-41" tabindex="-1"></a>                    qual<span class="op">:</span> <span class="op">[</span></span>
<span id="cb271-42"><a aria-hidden="true" href="#cb271-42" tabindex="-1"></a>                        OpExpr <span class="op">{</span> <span class="co">/* salary &gt; 50000 */</span> <span class="op">}</span></span>
<span id="cb271-43"><a aria-hidden="true" href="#cb271-43" tabindex="-1"></a>                    <span class="op">]</span></span>
<span id="cb271-44"><a aria-hidden="true" href="#cb271-44" tabindex="-1"></a>                <span class="op">},</span></span>
<span id="cb271-45"><a aria-hidden="true" href="#cb271-45" tabindex="-1"></a>                righttree<span class="op">:</span> Hash <span class="op">{</span></span>
<span id="cb271-46"><a aria-hidden="true" href="#cb271-46" tabindex="-1"></a>                    plan<span class="op">:</span> <span class="op">{</span></span>
<span id="cb271-47"><a aria-hidden="true" href="#cb271-47" tabindex="-1"></a>                        startup_cost<span class="op">:</span> <span class="fl">10.5</span><span class="op">,</span></span>
<span id="cb271-48"><a aria-hidden="true" href="#cb271-48" tabindex="-1"></a>                        total_cost<span class="op">:</span> <span class="fl">10.5</span><span class="op">,</span></span>
<span id="cb271-49"><a aria-hidden="true" href="#cb271-49" tabindex="-1"></a>                        plan_rows<span class="op">:</span> <span class="dv">5</span><span class="op">,</span></span>
<span id="cb271-50"><a aria-hidden="true" href="#cb271-50" tabindex="-1"></a>                        plan_width<span class="op">:</span> <span class="dv">12</span></span>
<span id="cb271-51"><a aria-hidden="true" href="#cb271-51" tabindex="-1"></a>                    <span class="op">},</span></span>
<span id="cb271-52"><a aria-hidden="true" href="#cb271-52" tabindex="-1"></a>                    lefttree<span class="op">:</span> SeqScan <span class="op">{</span>  <span class="co">/* departments */</span></span>
<span id="cb271-53"><a aria-hidden="true" href="#cb271-53" tabindex="-1"></a>                        plan<span class="op">:</span> <span class="op">{</span></span>
<span id="cb271-54"><a aria-hidden="true" href="#cb271-54" tabindex="-1"></a>                            startup_cost<span class="op">:</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb271-55"><a aria-hidden="true" href="#cb271-55" tabindex="-1"></a>                            total_cost<span class="op">:</span> <span class="fl">10.5</span><span class="op">,</span></span>
<span id="cb271-56"><a aria-hidden="true" href="#cb271-56" tabindex="-1"></a>                            plan_rows<span class="op">:</span> <span class="dv">5</span><span class="op">,</span></span>
<span id="cb271-57"><a aria-hidden="true" href="#cb271-57" tabindex="-1"></a>                            plan_width<span class="op">:</span> <span class="dv">12</span></span>
<span id="cb271-58"><a aria-hidden="true" href="#cb271-58" tabindex="-1"></a>                        <span class="op">},</span></span>
<span id="cb271-59"><a aria-hidden="true" href="#cb271-59" tabindex="-1"></a>                        scanrelid<span class="op">:</span> <span class="dv">2</span><span class="op">,</span></span>
<span id="cb271-60"><a aria-hidden="true" href="#cb271-60" tabindex="-1"></a>                        qual<span class="op">:</span> <span class="op">[</span></span>
<span id="cb271-61"><a aria-hidden="true" href="#cb271-61" tabindex="-1"></a>                            OpExpr <span class="op">{</span> <span class="co">/* location = 'New York' */</span> <span class="op">}</span></span>
<span id="cb271-62"><a aria-hidden="true" href="#cb271-62" tabindex="-1"></a>                        <span class="op">]</span></span>
<span id="cb271-63"><a aria-hidden="true" href="#cb271-63" tabindex="-1"></a>                    <span class="op">}</span></span>
<span id="cb271-64"><a aria-hidden="true" href="#cb271-64" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb271-65"><a aria-hidden="true" href="#cb271-65" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb271-66"><a aria-hidden="true" href="#cb271-66" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb271-67"><a aria-hidden="true" href="#cb271-67" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb271-68"><a aria-hidden="true" href="#cb271-68" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 data-number="4.12.5" id="stage-4-execution"><span class="header-section-number">4.12.5</span> 11.5 Stage 4: Execution</h3>
<p><strong>ExecutorStart</strong> initializes the plan tree:</p>
<pre><code>LimitState
  ‚îî‚îÄ SortState
    ‚îî‚îÄ HashJoinState
      ‚îú‚îÄ SeqScanState (employees)
      ‚îî‚îÄ HashState
        ‚îî‚îÄ SeqScanState (departments)</code></pre>
<p><strong>ExecutorRun</strong> executes the plan:</p>
<ol type="1">
<li><strong>Initialize Hash Table</strong>:
<ul>
<li>SeqScan on departments with filter</li>
<li>Insert matching rows (location = ‚ÄòNew York‚Äô) into hash table</li>
<li>Result: 5 rows in hash table</li>
</ul></li>
<li><strong>Probe Phase</strong>:
<ul>
<li>SeqScan on employees with filter (salary &gt; 50000)</li>
<li>For each row, hash dept_id and probe hash table</li>
<li>Emit joined rows (~100 rows)</li>
</ul></li>
<li><strong>Sort</strong>:
<ul>
<li>Collect all joined rows</li>
<li>Sort by salary DESC</li>
<li>Result: 100 sorted rows</li>
</ul></li>
<li><strong>Limit</strong>:
<ul>
<li>Return first 10 rows</li>
<li>Stop execution</li>
</ul></li>
</ol>
<p><strong>Final Result</strong> (10 tuples):</p>
<pre><code>  name    | salary  | dept_name
----------+---------+-----------
 Alice    | 120000  | Engineering
 Bob      | 115000  | Engineering
 Charlie  | 110000  | Engineering
 ...</code></pre>
<h3 data-number="4.12.6" id="performance-monitoring"><span class="header-section-number">4.12.6</span> 11.6 Performance
Monitoring</h3>
<p><strong>EXPLAIN ANALYZE output</strong>:</p>
<div class="sourceCode" id="cb274"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb274-1"><a aria-hidden="true" href="#cb274-1" tabindex="-1"></a><span class="kw">EXPLAIN</span> (<span class="kw">ANALYZE</span>, BUFFERS)</span>
<span id="cb274-2"><a aria-hidden="true" href="#cb274-2" tabindex="-1"></a><span class="kw">SELECT</span> e.name, e.salary, d.dept_name</span>
<span id="cb274-3"><a aria-hidden="true" href="#cb274-3" tabindex="-1"></a><span class="kw">FROM</span> employees e</span>
<span id="cb274-4"><a aria-hidden="true" href="#cb274-4" tabindex="-1"></a><span class="kw">JOIN</span> departments d <span class="kw">ON</span> e.dept_id <span class="op">=</span> d.dept_id</span>
<span id="cb274-5"><a aria-hidden="true" href="#cb274-5" tabindex="-1"></a><span class="kw">WHERE</span> e.salary <span class="op">&gt;</span> <span class="dv">50000</span></span>
<span id="cb274-6"><a aria-hidden="true" href="#cb274-6" tabindex="-1"></a>  <span class="kw">AND</span> d.location <span class="op">=</span> <span class="st">'New York'</span></span>
<span id="cb274-7"><a aria-hidden="true" href="#cb274-7" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> e.salary <span class="kw">DESC</span></span>
<span id="cb274-8"><a aria-hidden="true" href="#cb274-8" tabindex="-1"></a><span class="kw">LIMIT</span> <span class="dv">10</span>;</span></code></pre></div>
<p><strong>Output</strong>:</p>
<pre><code>Limit  (cost=224.05..230.69 rows=10 width=44)
       (actual time=5.234..5.248 rows=10 loops=1)
  Buffers: shared hit=115
  -&gt;  Sort  (cost=224.05..230.64 rows=100 width=44)
            (actual time=5.232..5.234 rows=10 loops=1)
        Sort Key: e.salary DESC
        Sort Method: top-N heapsort  Memory: 26kB
        Buffers: shared hit=115
        -&gt;  Hash Join  (cost=10.55..224.05 rows=100 width=44)
                      (actual time=0.087..4.892 rows=95 loops=1)
              Hash Cond: (e.dept_id = d.dept_id)
              Buffers: shared hit=115
              -&gt;  Seq Scan on employees e  (cost=0.00..200.00 rows=5000 width=36)
                                          (actual time=0.012..3.456 rows=4987 loops=1)
                    Filter: (salary &gt; 50000)
                    Rows Removed by Filter: 5013
                    Buffers: shared hit=100
              -&gt;  Hash  (cost=10.50..10.50 rows=5 width=12)
                       (actual time=0.067..0.068 rows=5 loops=1)
                    Buckets: 1024  Batches: 1  Memory Usage: 9kB
                    Buffers: shared hit=15
                    -&gt;  Seq Scan on departments d  (cost=0.00..10.50 rows=5 width=12)
                                                   (actual time=0.008..0.062 rows=5 loops=1)
                          Filter: (location = 'New York'::text)
                          Rows Removed by Filter: 45
                          Buffers: shared hit=15
Planning Time: 0.543 ms
Execution Time: 5.298 ms</code></pre>
<hr/>
<h2 data-number="4.13" id="conclusion-1"><span class="header-section-number">4.13</span> Conclusion</h2>
<p>PostgreSQL‚Äôs query processing pipeline represents a sophisticated
implementation of decades of database research. The four-stage
architecture‚Äîparsing, rewriting, planning, and execution‚Äîprovides both
flexibility and performance:</p>
<ul>
<li><strong>Parser</strong> ensures SQL correctness and transforms text
into structured data</li>
<li><strong>Rewriter</strong> applies views, rules, and security
policies transparently</li>
<li><strong>Planner</strong> evaluates multiple execution strategies and
selects the optimal one</li>
<li><strong>Executor</strong> efficiently generates result tuples using
iterator-based processing</li>
</ul>
<p>The cost-based optimizer, with its parameterized cost model and
comprehensive path generation, enables PostgreSQL to handle complex
queries efficiently across diverse workloads and data distributions.</p>
<p>Understanding this pipeline is essential for: - <strong>Query
optimization</strong>: Writing queries that can be optimized effectively
- <strong>Performance tuning</strong>: Adjusting cost parameters and
creating appropriate indexes - <strong>Extension development</strong>:
Adding new operators, functions, or access methods -
<strong>Troubleshooting</strong>: Diagnosing query performance
issues</p>
<p>The query processing system continues to evolve, with recent
additions including parallel query execution, JIT compilation for
expressions, and improved join algorithms, ensuring PostgreSQL remains
competitive with modern database systems while maintaining its
commitment to standards compliance and extensibility.</p>
<h1 data-number="5" id="chapter-3-transaction-management"><span class="header-section-number">5</span> Chapter 3: Transaction
Management</h1>
<h2 data-number="5.1" id="overview-9"><span class="header-section-number">5.1</span> Overview</h2>
<p>PostgreSQL‚Äôs transaction management system is a sophisticated
infrastructure that ensures data consistency, isolation, and durability
while supporting high concurrency. At its core, the system implements
ACID properties through a combination of Multi-Version Concurrency
Control (MVCC), a hierarchical locking system, and Write-Ahead Logging
(WAL).</p>
<p>The transaction system is primarily implemented in: -
<code>src/backend/access/transam/xact.c</code> - Core transaction
management - <code>src/backend/storage/lmgr/</code> - Lock management
subsystem - <code>src/backend/access/transam/clog.c</code> - Commit log
- <code>src/backend/storage/ipc/procarray.c</code> - Process array
management</p>
<h2 data-number="5.2" id="acid-properties-implementation"><span class="header-section-number">5.2</span> 1. ACID Properties
Implementation</h2>
<h3 data-number="5.2.1" id="atomicity"><span class="header-section-number">5.2.1</span> 1.1 Atomicity</h3>
<p>Atomicity ensures that transactions are all-or-nothing. PostgreSQL
implements atomicity through:</p>
<p><strong>Write-Ahead Logging (WAL)</strong>: All changes are logged
before being applied to data pages. On abort, the system simply doesn‚Äôt
replay the changes. On crash recovery, incomplete transactions are
rolled back.</p>
<p><strong>Transaction State Tracking</strong>: Each transaction
maintains state in shared memory through the PGPROC structure and tracks
all modified resources.</p>
<h3 data-number="5.2.2" id="consistency"><span class="header-section-number">5.2.2</span> 1.2 Consistency</h3>
<p>Consistency is enforced through: - Constraint checking at appropriate
times during transaction execution - Deferred constraint validation
(when requested) - Trigger execution to maintain application-level
invariants</p>
<h3 data-number="5.2.3" id="isolation"><span class="header-section-number">5.2.3</span> 1.3 Isolation</h3>
<p>Isolation is implemented through MVCC and four standard SQL isolation
levels: - <strong>READ UNCOMMITTED</strong> (treated as READ COMMITTED
in PostgreSQL) - <strong>READ COMMITTED</strong> (default) -
<strong>REPEATABLE READ</strong> - <strong>SERIALIZABLE</strong> (with
Serializable Snapshot Isolation)</p>
<p>Defined in <code>src/include/access/xact.h:36-39</code>:</p>
<div class="sourceCode" id="cb276"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb276-1"><a aria-hidden="true" href="#cb276-1" tabindex="-1"></a><span class="pp">#define XACT_READ_UNCOMMITTED   </span><span class="dv">0</span></span>
<span id="cb276-2"><a aria-hidden="true" href="#cb276-2" tabindex="-1"></a><span class="pp">#define XACT_READ_COMMITTED     </span><span class="dv">1</span></span>
<span id="cb276-3"><a aria-hidden="true" href="#cb276-3" tabindex="-1"></a><span class="pp">#define XACT_REPEATABLE_READ    </span><span class="dv">2</span></span>
<span id="cb276-4"><a aria-hidden="true" href="#cb276-4" tabindex="-1"></a><span class="pp">#define XACT_SERIALIZABLE       </span><span class="dv">3</span></span></code></pre></div>
<h3 data-number="5.2.4" id="durability"><span class="header-section-number">5.2.4</span> 1.4 Durability</h3>
<p>Durability is guaranteed through: - <strong>WAL</strong>: Changes are
written to durable storage before commit acknowledgment -
<strong>Synchronous commit levels</strong>: Configurable via
<code>synchronous_commit</code> GUC - <strong>Checkpointing</strong>:
Periodic flushing of dirty pages to disk</p>
<p>The synchronous commit levels
(<code>src/include/access/xact.h:69-78</code>):</p>
<div class="sourceCode" id="cb277"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb277-1"><a aria-hidden="true" href="#cb277-1" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">enum</span> <span class="op">{</span></span>
<span id="cb277-2"><a aria-hidden="true" href="#cb277-2" tabindex="-1"></a>    SYNCHRONOUS_COMMIT_OFF<span class="op">,</span>              <span class="co">/* asynchronous commit */</span></span>
<span id="cb277-3"><a aria-hidden="true" href="#cb277-3" tabindex="-1"></a>    SYNCHRONOUS_COMMIT_LOCAL_FLUSH<span class="op">,</span>      <span class="co">/* wait for local flush only */</span></span>
<span id="cb277-4"><a aria-hidden="true" href="#cb277-4" tabindex="-1"></a>    SYNCHRONOUS_COMMIT_REMOTE_WRITE<span class="op">,</span>     <span class="co">/* wait for local flush and remote write */</span></span>
<span id="cb277-5"><a aria-hidden="true" href="#cb277-5" tabindex="-1"></a>    SYNCHRONOUS_COMMIT_REMOTE_FLUSH<span class="op">,</span>     <span class="co">/* wait for local and remote flush */</span></span>
<span id="cb277-6"><a aria-hidden="true" href="#cb277-6" tabindex="-1"></a>    SYNCHRONOUS_COMMIT_REMOTE_APPLY<span class="op">,</span>     <span class="co">/* wait for local/remote flush and apply */</span></span>
<span id="cb277-7"><a aria-hidden="true" href="#cb277-7" tabindex="-1"></a><span class="op">}</span> SyncCommitLevel<span class="op">;</span></span></code></pre></div>
<h2 data-number="5.3" id="multi-version-concurrency-control-mvcc"><span class="header-section-number">5.3</span> 2. Multi-Version Concurrency
Control (MVCC)</h2>
<h3 data-number="5.3.1" id="overview-10"><span class="header-section-number">5.3.1</span> 2.1 Overview</h3>
<p>MVCC allows readers to access data without blocking writers and vice
versa. Each transaction sees a consistent snapshot of the database as it
existed at the start of the transaction (or statement, depending on
isolation level).</p>
<h3 data-number="5.3.2" id="transaction-ids-xids"><span class="header-section-number">5.3.2</span> 2.2 Transaction IDs
(XIDs)</h3>
<p>Transaction IDs are 32-bit unsigned integers defined in
<code>src/include/access/transam.h:31-35</code>:</p>
<div class="sourceCode" id="cb278"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb278-1"><a aria-hidden="true" href="#cb278-1" tabindex="-1"></a><span class="pp">#define InvalidTransactionId        </span><span class="op">((</span><span class="pp">TransactionId</span><span class="op">)</span><span class="pp"> </span><span class="dv">0</span><span class="op">)</span></span>
<span id="cb278-2"><a aria-hidden="true" href="#cb278-2" tabindex="-1"></a><span class="pp">#define BootstrapTransactionId      </span><span class="op">((</span><span class="pp">TransactionId</span><span class="op">)</span><span class="pp"> </span><span class="dv">1</span><span class="op">)</span></span>
<span id="cb278-3"><a aria-hidden="true" href="#cb278-3" tabindex="-1"></a><span class="pp">#define FrozenTransactionId         </span><span class="op">((</span><span class="pp">TransactionId</span><span class="op">)</span><span class="pp"> </span><span class="dv">2</span><span class="op">)</span></span>
<span id="cb278-4"><a aria-hidden="true" href="#cb278-4" tabindex="-1"></a><span class="pp">#define FirstNormalTransactionId    </span><span class="op">((</span><span class="pp">TransactionId</span><span class="op">)</span><span class="pp"> </span><span class="dv">3</span><span class="op">)</span></span>
<span id="cb278-5"><a aria-hidden="true" href="#cb278-5" tabindex="-1"></a><span class="pp">#define MaxTransactionId            </span><span class="op">((</span><span class="pp">TransactionId</span><span class="op">)</span><span class="pp"> </span><span class="bn">0xFFFFFFFF</span><span class="op">)</span></span></code></pre></div>
<p><strong>FullTransactionId</strong>: To handle XID wraparound,
PostgreSQL internally uses 64-bit transaction IDs that combine a 32-bit
epoch with the 32-bit XID
(<code>src/include/access/transam.h:65-68</code>):</p>
<div class="sourceCode" id="cb279"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb279-1"><a aria-hidden="true" href="#cb279-1" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> FullTransactionId <span class="op">{</span></span>
<span id="cb279-2"><a aria-hidden="true" href="#cb279-2" tabindex="-1"></a>    uint64  value<span class="op">;</span>  <span class="co">/* epoch in upper 32 bits, xid in lower 32 bits */</span></span>
<span id="cb279-3"><a aria-hidden="true" href="#cb279-3" tabindex="-1"></a><span class="op">}</span> FullTransactionId<span class="op">;</span></span></code></pre></div>
<h3 data-number="5.3.3" id="snapshotdata-structure"><span class="header-section-number">5.3.3</span> 2.3 SnapshotData
Structure</h3>
<p>Snapshots determine which tuple versions are visible to a
transaction. The core snapshot structure is defined in
<code>src/include/utils/snapshot.h:138-210</code>:</p>
<div class="sourceCode" id="cb280"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb280-1"><a aria-hidden="true" href="#cb280-1" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> SnapshotData <span class="op">{</span></span>
<span id="cb280-2"><a aria-hidden="true" href="#cb280-2" tabindex="-1"></a>    SnapshotType snapshot_type<span class="op">;</span>  <span class="co">/* type of snapshot */</span></span>
<span id="cb280-3"><a aria-hidden="true" href="#cb280-3" tabindex="-1"></a></span>
<span id="cb280-4"><a aria-hidden="true" href="#cb280-4" tabindex="-1"></a>    <span class="co">/* MVCC snapshot fields */</span></span>
<span id="cb280-5"><a aria-hidden="true" href="#cb280-5" tabindex="-1"></a>    TransactionId xmin<span class="op">;</span>          <span class="co">/* all XID &lt; xmin are visible to me */</span></span>
<span id="cb280-6"><a aria-hidden="true" href="#cb280-6" tabindex="-1"></a>    TransactionId xmax<span class="op">;</span>          <span class="co">/* all XID &gt;= xmax are invisible to me */</span></span>
<span id="cb280-7"><a aria-hidden="true" href="#cb280-7" tabindex="-1"></a></span>
<span id="cb280-8"><a aria-hidden="true" href="#cb280-8" tabindex="-1"></a>    <span class="co">/* Array of in-progress transaction IDs */</span></span>
<span id="cb280-9"><a aria-hidden="true" href="#cb280-9" tabindex="-1"></a>    TransactionId <span class="op">*</span>xip<span class="op">;</span></span>
<span id="cb280-10"><a aria-hidden="true" href="#cb280-10" tabindex="-1"></a>    uint32        xcnt<span class="op">;</span>          <span class="co">/* # of xact ids in xip[] */</span></span>
<span id="cb280-11"><a aria-hidden="true" href="#cb280-11" tabindex="-1"></a></span>
<span id="cb280-12"><a aria-hidden="true" href="#cb280-12" tabindex="-1"></a>    <span class="co">/* Array of in-progress subtransaction IDs */</span></span>
<span id="cb280-13"><a aria-hidden="true" href="#cb280-13" tabindex="-1"></a>    TransactionId <span class="op">*</span>subxip<span class="op">;</span></span>
<span id="cb280-14"><a aria-hidden="true" href="#cb280-14" tabindex="-1"></a>    int32         subxcnt<span class="op">;</span>       <span class="co">/* # of xact ids in subxip[] */</span></span>
<span id="cb280-15"><a aria-hidden="true" href="#cb280-15" tabindex="-1"></a>    <span class="dt">bool</span>          suboverflowed<span class="op">;</span> <span class="co">/* has the subxip array overflowed? */</span></span>
<span id="cb280-16"><a aria-hidden="true" href="#cb280-16" tabindex="-1"></a></span>
<span id="cb280-17"><a aria-hidden="true" href="#cb280-17" tabindex="-1"></a>    <span class="dt">bool</span>          takenDuringRecovery<span class="op">;</span>  <span class="co">/* recovery-shaped snapshot? */</span></span>
<span id="cb280-18"><a aria-hidden="true" href="#cb280-18" tabindex="-1"></a>    <span class="dt">bool</span>          copied<span class="op">;</span>               <span class="co">/* false if it's a static snapshot */</span></span>
<span id="cb280-19"><a aria-hidden="true" href="#cb280-19" tabindex="-1"></a></span>
<span id="cb280-20"><a aria-hidden="true" href="#cb280-20" tabindex="-1"></a>    CommandId     curcid<span class="op">;</span>        <span class="co">/* in my xact, CID &lt; curcid are visible */</span></span>
<span id="cb280-21"><a aria-hidden="true" href="#cb280-21" tabindex="-1"></a></span>
<span id="cb280-22"><a aria-hidden="true" href="#cb280-22" tabindex="-1"></a>    <span class="co">/* For HeapTupleSatisfiesDirty */</span></span>
<span id="cb280-23"><a aria-hidden="true" href="#cb280-23" tabindex="-1"></a>    uint32        speculativeToken<span class="op">;</span></span>
<span id="cb280-24"><a aria-hidden="true" href="#cb280-24" tabindex="-1"></a></span>
<span id="cb280-25"><a aria-hidden="true" href="#cb280-25" tabindex="-1"></a>    <span class="co">/* For SNAPSHOT_NON_VACUUMABLE */</span></span>
<span id="cb280-26"><a aria-hidden="true" href="#cb280-26" tabindex="-1"></a>    <span class="kw">struct</span> GlobalVisState <span class="op">*</span>vistest<span class="op">;</span></span>
<span id="cb280-27"><a aria-hidden="true" href="#cb280-27" tabindex="-1"></a></span>
<span id="cb280-28"><a aria-hidden="true" href="#cb280-28" tabindex="-1"></a>    <span class="co">/* Reference counting for snapshot management */</span></span>
<span id="cb280-29"><a aria-hidden="true" href="#cb280-29" tabindex="-1"></a>    uint32        active_count<span class="op">;</span>  <span class="co">/* refcount on ActiveSnapshot stack */</span></span>
<span id="cb280-30"><a aria-hidden="true" href="#cb280-30" tabindex="-1"></a>    uint32        regd_count<span class="op">;</span>    <span class="co">/* refcount on RegisteredSnapshots */</span></span>
<span id="cb280-31"><a aria-hidden="true" href="#cb280-31" tabindex="-1"></a>    pairingheap_node ph_node<span class="op">;</span>    <span class="co">/* link in RegisteredSnapshots heap */</span></span>
<span id="cb280-32"><a aria-hidden="true" href="#cb280-32" tabindex="-1"></a></span>
<span id="cb280-33"><a aria-hidden="true" href="#cb280-33" tabindex="-1"></a>    <span class="co">/* Transaction completion count for snapshot optimization */</span></span>
<span id="cb280-34"><a aria-hidden="true" href="#cb280-34" tabindex="-1"></a>    uint64        snapXactCompletionCount<span class="op">;</span></span>
<span id="cb280-35"><a aria-hidden="true" href="#cb280-35" tabindex="-1"></a><span class="op">}</span> SnapshotData<span class="op">;</span></span></code></pre></div>
<h3 data-number="5.3.4" id="snapshot-types"><span class="header-section-number">5.3.4</span> 2.4 Snapshot Types</h3>
<p>PostgreSQL supports multiple snapshot types
(<code>src/include/utils/snapshot.h:31-115</code>):</p>
<ul>
<li><strong>SNAPSHOT_MVCC</strong>: Standard MVCC snapshot for
transaction isolation</li>
<li><strong>SNAPSHOT_SELF</strong>: See own uncommitted changes</li>
<li><strong>SNAPSHOT_ANY</strong>: See all tuples regardless of
visibility</li>
<li><strong>SNAPSHOT_TOAST</strong>: Special snapshot for TOAST
data</li>
<li><strong>SNAPSHOT_DIRTY</strong>: See uncommitted changes from other
transactions</li>
<li><strong>SNAPSHOT_HISTORIC_MVCC</strong>: For logical decoding</li>
<li><strong>SNAPSHOT_NON_VACUUMABLE</strong>: For determining
vacuumability</li>
</ul>
<h3 data-number="5.3.5" id="visibility-determination"><span class="header-section-number">5.3.5</span> 2.5 Visibility
Determination</h3>
<p>Tuple visibility is determined by comparing the tuple‚Äôs
<code>xmin</code> (inserting XID) and <code>xmax</code> (deleting XID)
against the snapshot:</p>
<ol type="1">
<li>If <code>xmin &gt;= xmax</code>, the tuple was inserted but not yet
committed when snapshot was taken ‚Üí invisible</li>
<li>If <code>xmin</code> is in the snapshot‚Äôs <code>xip</code> array ‚Üí
in-progress ‚Üí invisible</li>
<li>If <code>xmax</code> is committed and <code>xmax &lt; xmax</code> ‚Üí
deleted ‚Üí invisible</li>
<li>Otherwise ‚Üí visible</li>
</ol>
<p>The logic is implemented in
<code>src/backend/access/heap/heapam_visibility.c</code>.</p>
<h3 data-number="5.3.6" id="snapshot-acquisition"><span class="header-section-number">5.3.6</span> 2.6 Snapshot Acquisition</h3>
<p>Snapshots are acquired through <code>GetSnapshotData()</code> in
<code>src/backend/storage/ipc/procarray.c</code>. The function:</p>
<ol type="1">
<li>Acquires <code>ProcArrayLock</code> in shared mode</li>
<li>Records current <code>nextXid</code> as snapshot‚Äôs
<code>xmax</code></li>
<li>Scans the process array to collect in-progress XIDs</li>
<li>Determines oldest in-progress XID as snapshot‚Äôs
<code>xmin</code></li>
<li>Releases the lock</li>
</ol>
<h2 data-number="5.4" id="process-control-structure-pgproc"><span class="header-section-number">5.4</span> 3. Process Control Structure
(PGPROC)</h2>
<p>Each backend maintains a PGPROC structure in shared memory. This is
the central data structure for transaction and lock management, defined
in <code>src/include/storage/proc.h:184-330</code>:</p>
<div class="sourceCode" id="cb281"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb281-1"><a aria-hidden="true" href="#cb281-1" tabindex="-1"></a><span class="kw">struct</span> PGPROC <span class="op">{</span></span>
<span id="cb281-2"><a aria-hidden="true" href="#cb281-2" tabindex="-1"></a>    dlist_node    links<span class="op">;</span>              <span class="co">/* list link if process is in a list */</span></span>
<span id="cb281-3"><a aria-hidden="true" href="#cb281-3" tabindex="-1"></a>    dlist_head   <span class="op">*</span>procgloballist<span class="op">;</span>     <span class="co">/* procglobal list that owns this PGPROC */</span></span>
<span id="cb281-4"><a aria-hidden="true" href="#cb281-4" tabindex="-1"></a></span>
<span id="cb281-5"><a aria-hidden="true" href="#cb281-5" tabindex="-1"></a>    PGSemaphore   sem<span class="op">;</span>                <span class="co">/* ONE semaphore to sleep on */</span></span>
<span id="cb281-6"><a aria-hidden="true" href="#cb281-6" tabindex="-1"></a>    ProcWaitStatus waitStatus<span class="op">;</span></span>
<span id="cb281-7"><a aria-hidden="true" href="#cb281-7" tabindex="-1"></a>    Latch         procLatch<span class="op">;</span>          <span class="co">/* generic latch for process */</span></span>
<span id="cb281-8"><a aria-hidden="true" href="#cb281-8" tabindex="-1"></a></span>
<span id="cb281-9"><a aria-hidden="true" href="#cb281-9" tabindex="-1"></a>    <span class="co">/* Transaction ID information */</span></span>
<span id="cb281-10"><a aria-hidden="true" href="#cb281-10" tabindex="-1"></a>    TransactionId xid<span class="op">;</span>                <span class="co">/* current top-level XID, or InvalidTransactionId */</span></span>
<span id="cb281-11"><a aria-hidden="true" href="#cb281-11" tabindex="-1"></a>    TransactionId xmin<span class="op">;</span>               <span class="co">/* minimal running XID when we started */</span></span>
<span id="cb281-12"><a aria-hidden="true" href="#cb281-12" tabindex="-1"></a></span>
<span id="cb281-13"><a aria-hidden="true" href="#cb281-13" tabindex="-1"></a>    <span class="dt">int</span>           pid<span class="op">;</span>                <span class="co">/* Backend's process ID; 0 if prepared xact */</span></span>
<span id="cb281-14"><a aria-hidden="true" href="#cb281-14" tabindex="-1"></a>    <span class="dt">int</span>           pgxactoff<span class="op">;</span>          <span class="co">/* offset into ProcGlobal arrays */</span></span>
<span id="cb281-15"><a aria-hidden="true" href="#cb281-15" tabindex="-1"></a></span>
<span id="cb281-16"><a aria-hidden="true" href="#cb281-16" tabindex="-1"></a>    <span class="co">/* Virtual transaction ID */</span></span>
<span id="cb281-17"><a aria-hidden="true" href="#cb281-17" tabindex="-1"></a>    <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb281-18"><a aria-hidden="true" href="#cb281-18" tabindex="-1"></a>        ProcNumber        procNumber<span class="op">;</span></span>
<span id="cb281-19"><a aria-hidden="true" href="#cb281-19" tabindex="-1"></a>        LocalTransactionId lxid<span class="op">;</span></span>
<span id="cb281-20"><a aria-hidden="true" href="#cb281-20" tabindex="-1"></a>    <span class="op">}</span> vxid<span class="op">;</span></span>
<span id="cb281-21"><a aria-hidden="true" href="#cb281-21" tabindex="-1"></a></span>
<span id="cb281-22"><a aria-hidden="true" href="#cb281-22" tabindex="-1"></a>    <span class="co">/* Database and role */</span></span>
<span id="cb281-23"><a aria-hidden="true" href="#cb281-23" tabindex="-1"></a>    Oid           databaseId<span class="op">;</span></span>
<span id="cb281-24"><a aria-hidden="true" href="#cb281-24" tabindex="-1"></a>    Oid           roleId<span class="op">;</span></span>
<span id="cb281-25"><a aria-hidden="true" href="#cb281-25" tabindex="-1"></a>    Oid           tempNamespaceId<span class="op">;</span></span>
<span id="cb281-26"><a aria-hidden="true" href="#cb281-26" tabindex="-1"></a></span>
<span id="cb281-27"><a aria-hidden="true" href="#cb281-27" tabindex="-1"></a>    <span class="dt">bool</span>          isRegularBackend<span class="op">;</span></span>
<span id="cb281-28"><a aria-hidden="true" href="#cb281-28" tabindex="-1"></a>    <span class="dt">bool</span>          recoveryConflictPending<span class="op">;</span></span>
<span id="cb281-29"><a aria-hidden="true" href="#cb281-29" tabindex="-1"></a></span>
<span id="cb281-30"><a aria-hidden="true" href="#cb281-30" tabindex="-1"></a>    <span class="co">/* LWLock waiting info */</span></span>
<span id="cb281-31"><a aria-hidden="true" href="#cb281-31" tabindex="-1"></a>    uint8         lwWaiting<span class="op">;</span>          <span class="co">/* see LWLockWaitState */</span></span>
<span id="cb281-32"><a aria-hidden="true" href="#cb281-32" tabindex="-1"></a>    uint8         lwWaitMode<span class="op">;</span>         <span class="co">/* lwlock mode being waited for */</span></span>
<span id="cb281-33"><a aria-hidden="true" href="#cb281-33" tabindex="-1"></a>    proclist_node lwWaitLink<span class="op">;</span></span>
<span id="cb281-34"><a aria-hidden="true" href="#cb281-34" tabindex="-1"></a></span>
<span id="cb281-35"><a aria-hidden="true" href="#cb281-35" tabindex="-1"></a>    <span class="co">/* Condition variable support */</span></span>
<span id="cb281-36"><a aria-hidden="true" href="#cb281-36" tabindex="-1"></a>    proclist_node cvWaitLink<span class="op">;</span></span>
<span id="cb281-37"><a aria-hidden="true" href="#cb281-37" tabindex="-1"></a></span>
<span id="cb281-38"><a aria-hidden="true" href="#cb281-38" tabindex="-1"></a>    <span class="co">/* Heavyweight lock waiting info */</span></span>
<span id="cb281-39"><a aria-hidden="true" href="#cb281-39" tabindex="-1"></a>    LOCK         <span class="op">*</span>waitLock<span class="op">;</span>           <span class="co">/* Lock object we're sleeping on */</span></span>
<span id="cb281-40"><a aria-hidden="true" href="#cb281-40" tabindex="-1"></a>    PROCLOCK     <span class="op">*</span>waitProcLock<span class="op">;</span>       <span class="co">/* Per-holder info for awaited lock */</span></span>
<span id="cb281-41"><a aria-hidden="true" href="#cb281-41" tabindex="-1"></a>    LOCKMODE      waitLockMode<span class="op">;</span>       <span class="co">/* type of lock we're waiting for */</span></span>
<span id="cb281-42"><a aria-hidden="true" href="#cb281-42" tabindex="-1"></a>    LOCKMASK      heldLocks<span class="op">;</span>          <span class="co">/* bitmask for lock types already held */</span></span>
<span id="cb281-43"><a aria-hidden="true" href="#cb281-43" tabindex="-1"></a>    pg_atomic_uint64 waitStart<span class="op">;</span>       <span class="co">/* time wait started */</span></span>
<span id="cb281-44"><a aria-hidden="true" href="#cb281-44" tabindex="-1"></a></span>
<span id="cb281-45"><a aria-hidden="true" href="#cb281-45" tabindex="-1"></a>    <span class="dt">int</span>           delayChkptFlags<span class="op">;</span>    <span class="co">/* for DELAY_CHKPT_* flags */</span></span>
<span id="cb281-46"><a aria-hidden="true" href="#cb281-46" tabindex="-1"></a>    uint8         statusFlags<span class="op">;</span>        <span class="co">/* PROC_* flags */</span></span>
<span id="cb281-47"><a aria-hidden="true" href="#cb281-47" tabindex="-1"></a></span>
<span id="cb281-48"><a aria-hidden="true" href="#cb281-48" tabindex="-1"></a>    <span class="co">/* Synchronous replication support */</span></span>
<span id="cb281-49"><a aria-hidden="true" href="#cb281-49" tabindex="-1"></a>    XLogRecPtr    waitLSN<span class="op">;</span>            <span class="co">/* waiting for this LSN or higher */</span></span>
<span id="cb281-50"><a aria-hidden="true" href="#cb281-50" tabindex="-1"></a>    <span class="dt">int</span>           syncRepState<span class="op">;</span></span>
<span id="cb281-51"><a aria-hidden="true" href="#cb281-51" tabindex="-1"></a>    dlist_node    syncRepLinks<span class="op">;</span></span>
<span id="cb281-52"><a aria-hidden="true" href="#cb281-52" tabindex="-1"></a></span>
<span id="cb281-53"><a aria-hidden="true" href="#cb281-53" tabindex="-1"></a>    <span class="co">/* Lock lists by partition */</span></span>
<span id="cb281-54"><a aria-hidden="true" href="#cb281-54" tabindex="-1"></a>    dlist_head    myProcLocks<span class="op">[</span>NUM_LOCK_PARTITIONS<span class="op">];</span></span>
<span id="cb281-55"><a aria-hidden="true" href="#cb281-55" tabindex="-1"></a></span>
<span id="cb281-56"><a aria-hidden="true" href="#cb281-56" tabindex="-1"></a>    <span class="co">/* Subtransaction cache */</span></span>
<span id="cb281-57"><a aria-hidden="true" href="#cb281-57" tabindex="-1"></a>    XidCacheStatus subxidStatus<span class="op">;</span></span>
<span id="cb281-58"><a aria-hidden="true" href="#cb281-58" tabindex="-1"></a>    <span class="kw">struct</span> XidCache subxids<span class="op">;</span>          <span class="co">/* cache for subtransaction XIDs */</span></span>
<span id="cb281-59"><a aria-hidden="true" href="#cb281-59" tabindex="-1"></a></span>
<span id="cb281-60"><a aria-hidden="true" href="#cb281-60" tabindex="-1"></a>    <span class="co">/* Group XID clearing support */</span></span>
<span id="cb281-61"><a aria-hidden="true" href="#cb281-61" tabindex="-1"></a>    <span class="dt">bool</span>          procArrayGroupMember<span class="op">;</span></span>
<span id="cb281-62"><a aria-hidden="true" href="#cb281-62" tabindex="-1"></a>    pg_atomic_uint32 procArrayGroupNext<span class="op">;</span></span>
<span id="cb281-63"><a aria-hidden="true" href="#cb281-63" tabindex="-1"></a>    TransactionId procArrayGroupMemberXid<span class="op">;</span></span>
<span id="cb281-64"><a aria-hidden="true" href="#cb281-64" tabindex="-1"></a></span>
<span id="cb281-65"><a aria-hidden="true" href="#cb281-65" tabindex="-1"></a>    uint32        wait_event_info<span class="op">;</span></span>
<span id="cb281-66"><a aria-hidden="true" href="#cb281-66" tabindex="-1"></a></span>
<span id="cb281-67"><a aria-hidden="true" href="#cb281-67" tabindex="-1"></a>    <span class="co">/* CLOG group update support */</span></span>
<span id="cb281-68"><a aria-hidden="true" href="#cb281-68" tabindex="-1"></a>    <span class="dt">bool</span>          clogGroupMember<span class="op">;</span></span>
<span id="cb281-69"><a aria-hidden="true" href="#cb281-69" tabindex="-1"></a>    pg_atomic_uint32 clogGroupNext<span class="op">;</span></span>
<span id="cb281-70"><a aria-hidden="true" href="#cb281-70" tabindex="-1"></a>    TransactionId clogGroupMemberXid<span class="op">;</span></span>
<span id="cb281-71"><a aria-hidden="true" href="#cb281-71" tabindex="-1"></a>    XidStatus     clogGroupMemberXidStatus<span class="op">;</span></span>
<span id="cb281-72"><a aria-hidden="true" href="#cb281-72" tabindex="-1"></a>    int64         clogGroupMemberPage<span class="op">;</span></span>
<span id="cb281-73"><a aria-hidden="true" href="#cb281-73" tabindex="-1"></a>    XLogRecPtr    clogGroupMemberLsn<span class="op">;</span></span>
<span id="cb281-74"><a aria-hidden="true" href="#cb281-74" tabindex="-1"></a></span>
<span id="cb281-75"><a aria-hidden="true" href="#cb281-75" tabindex="-1"></a>    <span class="co">/* Fast-path lock management */</span></span>
<span id="cb281-76"><a aria-hidden="true" href="#cb281-76" tabindex="-1"></a>    LWLock        fpInfoLock<span class="op">;</span></span>
<span id="cb281-77"><a aria-hidden="true" href="#cb281-77" tabindex="-1"></a>    uint64       <span class="op">*</span>fpLockBits<span class="op">;</span></span>
<span id="cb281-78"><a aria-hidden="true" href="#cb281-78" tabindex="-1"></a>    Oid          <span class="op">*</span>fpRelId<span class="op">;</span></span>
<span id="cb281-79"><a aria-hidden="true" href="#cb281-79" tabindex="-1"></a>    <span class="dt">bool</span>          fpVXIDLock<span class="op">;</span></span>
<span id="cb281-80"><a aria-hidden="true" href="#cb281-80" tabindex="-1"></a>    LocalTransactionId fpLocalTransactionId<span class="op">;</span></span>
<span id="cb281-81"><a aria-hidden="true" href="#cb281-81" tabindex="-1"></a></span>
<span id="cb281-82"><a aria-hidden="true" href="#cb281-82" tabindex="-1"></a>    <span class="co">/* Lock group support */</span></span>
<span id="cb281-83"><a aria-hidden="true" href="#cb281-83" tabindex="-1"></a>    PGPROC       <span class="op">*</span>lockGroupLeader<span class="op">;</span></span>
<span id="cb281-84"><a aria-hidden="true" href="#cb281-84" tabindex="-1"></a>    dlist_head    lockGroupMembers<span class="op">;</span></span>
<span id="cb281-85"><a aria-hidden="true" href="#cb281-85" tabindex="-1"></a>    dlist_node    lockGroupLink<span class="op">;</span></span>
<span id="cb281-86"><a aria-hidden="true" href="#cb281-86" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<h3 data-number="5.4.1" id="proc_hdr-and-dense-arrays"><span class="header-section-number">5.4.1</span> 3.1 PROC_HDR and Dense
Arrays</h3>
<p>The global ProcGlobal structure maintains dense arrays that mirror
frequently-accessed PGPROC fields for better cache performance
(<code>src/include/storage/proc.h:391-437</code>):</p>
<div class="sourceCode" id="cb282"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb282-1"><a aria-hidden="true" href="#cb282-1" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> PROC_HDR <span class="op">{</span></span>
<span id="cb282-2"><a aria-hidden="true" href="#cb282-2" tabindex="-1"></a>    PGPROC       <span class="op">*</span>allProcs<span class="op">;</span>           <span class="co">/* Array of all PGPROC structures */</span></span>
<span id="cb282-3"><a aria-hidden="true" href="#cb282-3" tabindex="-1"></a>    TransactionId <span class="op">*</span>xids<span class="op">;</span>              <span class="co">/* Mirrored PGPROC.xid array */</span></span>
<span id="cb282-4"><a aria-hidden="true" href="#cb282-4" tabindex="-1"></a>    XidCacheStatus <span class="op">*</span>subxidStates<span class="op">;</span>     <span class="co">/* Mirrored PGPROC.subxidStatus */</span></span>
<span id="cb282-5"><a aria-hidden="true" href="#cb282-5" tabindex="-1"></a>    uint8        <span class="op">*</span>statusFlags<span class="op">;</span>        <span class="co">/* Mirrored PGPROC.statusFlags */</span></span>
<span id="cb282-6"><a aria-hidden="true" href="#cb282-6" tabindex="-1"></a></span>
<span id="cb282-7"><a aria-hidden="true" href="#cb282-7" tabindex="-1"></a>    uint32        allProcCount<span class="op">;</span></span>
<span id="cb282-8"><a aria-hidden="true" href="#cb282-8" tabindex="-1"></a>    dlist_head    freeProcs<span class="op">;</span></span>
<span id="cb282-9"><a aria-hidden="true" href="#cb282-9" tabindex="-1"></a>    dlist_head    autovacFreeProcs<span class="op">;</span></span>
<span id="cb282-10"><a aria-hidden="true" href="#cb282-10" tabindex="-1"></a>    dlist_head    bgworkerFreeProcs<span class="op">;</span></span>
<span id="cb282-11"><a aria-hidden="true" href="#cb282-11" tabindex="-1"></a>    dlist_head    walsenderFreeProcs<span class="op">;</span></span>
<span id="cb282-12"><a aria-hidden="true" href="#cb282-12" tabindex="-1"></a></span>
<span id="cb282-13"><a aria-hidden="true" href="#cb282-13" tabindex="-1"></a>    pg_atomic_uint32 procArrayGroupFirst<span class="op">;</span></span>
<span id="cb282-14"><a aria-hidden="true" href="#cb282-14" tabindex="-1"></a>    pg_atomic_uint32 clogGroupFirst<span class="op">;</span></span>
<span id="cb282-15"><a aria-hidden="true" href="#cb282-15" tabindex="-1"></a></span>
<span id="cb282-16"><a aria-hidden="true" href="#cb282-16" tabindex="-1"></a>    ProcNumber    walwriterProc<span class="op">;</span></span>
<span id="cb282-17"><a aria-hidden="true" href="#cb282-17" tabindex="-1"></a>    ProcNumber    checkpointerProc<span class="op">;</span></span>
<span id="cb282-18"><a aria-hidden="true" href="#cb282-18" tabindex="-1"></a></span>
<span id="cb282-19"><a aria-hidden="true" href="#cb282-19" tabindex="-1"></a>    <span class="dt">int</span>           spins_per_delay<span class="op">;</span></span>
<span id="cb282-20"><a aria-hidden="true" href="#cb282-20" tabindex="-1"></a>    <span class="dt">int</span>           startupBufferPinWaitBufId<span class="op">;</span></span>
<span id="cb282-21"><a aria-hidden="true" href="#cb282-21" tabindex="-1"></a><span class="op">}</span> PROC_HDR<span class="op">;</span></span></code></pre></div>
<h2 data-number="5.5" id="locking-system"><span class="header-section-number">5.5</span> 4. Locking System</h2>
<p>PostgreSQL implements a three-tier locking hierarchy to balance
performance and functionality.</p>
<h3 data-number="5.5.1" id="spinlocks"><span class="header-section-number">5.5.1</span> 4.1 Spinlocks</h3>
<p><strong>Purpose</strong>: Very short-term locks for protecting simple
shared memory structures.</p>
<p><strong>Implementation</strong>: Hardware atomic test-and-set
instructions (when available) or semaphore-based fallback.</p>
<p><strong>File</strong>: <code>src/include/storage/s_lock.h</code>,
<code>src/backend/storage/lmgr/s_lock.c</code></p>
<p><strong>Characteristics</strong>: - Busy-wait (no sleep) - No
deadlock detection - No automatic release on error - Hold time: ~tens of
instructions - Timeout: ~60 seconds (error condition)</p>
<p><strong>Usage</strong>: Protecting simple counters, linked list
manipulations, and as building blocks for LWLocks.</p>
<p><strong>Type definition</strong>
(<code>src/include/storage/spin.h</code>):</p>
<div class="sourceCode" id="cb283"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb283-1"><a aria-hidden="true" href="#cb283-1" tabindex="-1"></a><span class="kw">typedef</span> <span class="dt">volatile</span> slock_t<span class="op">;</span>  <span class="co">/* platform-specific atomic type */</span></span></code></pre></div>
<p><strong>Never use spinlocks for</strong>: - Operations requiring
kernel calls - Long computations - Anything that might error out</p>
<h3 data-number="5.5.2" id="lightweight-locks-lwlocks"><span class="header-section-number">5.5.2</span> 4.2 Lightweight Locks
(LWLocks)</h3>
<p><strong>Purpose</strong>: Efficient locks for shared memory data
structures with read/write access patterns.</p>
<p><strong>File</strong>:
<code>src/backend/storage/lmgr/lwlock.c</code>,
<code>src/include/storage/lwlock.h</code></p>
<p><strong>Structure</strong>
(<code>src/include/storage/lwlock.h:41-50</code>):</p>
<div class="sourceCode" id="cb284"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb284-1"><a aria-hidden="true" href="#cb284-1" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> LWLock <span class="op">{</span></span>
<span id="cb284-2"><a aria-hidden="true" href="#cb284-2" tabindex="-1"></a>    uint16        tranche<span class="op">;</span>        <span class="co">/* tranche ID */</span></span>
<span id="cb284-3"><a aria-hidden="true" href="#cb284-3" tabindex="-1"></a>    pg_atomic_uint32 state<span class="op">;</span>       <span class="co">/* state of exclusive/nonexclusive lockers */</span></span>
<span id="cb284-4"><a aria-hidden="true" href="#cb284-4" tabindex="-1"></a>    proclist_head waiters<span class="op">;</span>        <span class="co">/* list of waiting PGPROCs */</span></span>
<span id="cb284-5"><a aria-hidden="true" href="#cb284-5" tabindex="-1"></a><span class="pp">#ifdef LOCK_DEBUG</span></span>
<span id="cb284-6"><a aria-hidden="true" href="#cb284-6" tabindex="-1"></a>    pg_atomic_uint32 nwaiters<span class="op">;</span></span>
<span id="cb284-7"><a aria-hidden="true" href="#cb284-7" tabindex="-1"></a>    <span class="kw">struct</span> PGPROC <span class="op">*</span>owner<span class="op">;</span></span>
<span id="cb284-8"><a aria-hidden="true" href="#cb284-8" tabindex="-1"></a><span class="pp">#endif</span></span>
<span id="cb284-9"><a aria-hidden="true" href="#cb284-9" tabindex="-1"></a><span class="op">}</span> LWLock<span class="op">;</span></span></code></pre></div>
<p><strong>Lock Modes</strong>
(<code>src/include/storage/lwlock.h:110-117</code>):</p>
<div class="sourceCode" id="cb285"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb285-1"><a aria-hidden="true" href="#cb285-1" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">enum</span> LWLockMode <span class="op">{</span></span>
<span id="cb285-2"><a aria-hidden="true" href="#cb285-2" tabindex="-1"></a>    LW_EXCLUSIVE<span class="op">,</span>           <span class="co">/* Exclusive access */</span></span>
<span id="cb285-3"><a aria-hidden="true" href="#cb285-3" tabindex="-1"></a>    LW_SHARED<span class="op">,</span>              <span class="co">/* Shared (read) access */</span></span>
<span id="cb285-4"><a aria-hidden="true" href="#cb285-4" tabindex="-1"></a>    LW_WAIT_UNTIL_FREE<span class="op">,</span>     <span class="co">/* Wait until lock becomes free */</span></span>
<span id="cb285-5"><a aria-hidden="true" href="#cb285-5" tabindex="-1"></a><span class="op">}</span> LWLockMode<span class="op">;</span></span></code></pre></div>
<p><strong>Characteristics</strong>: - Support shared and exclusive
modes - FIFO wait queue (fair scheduling) - Automatic release on error
(elog recovery) - Block on semaphore when contended (no busy-wait) - No
deadlock detection - Fast when uncontended (~dozens of instructions)</p>
<p><strong>Key LWLocks</strong>: - <code>ProcArrayLock</code>: Protects
process array and snapshot acquisition - <code>XidGenLock</code>:
Protects XID generation - <code>WALInsertLock</code>: Controls WAL
buffer insertion - <code>LockMgrLocks</code>: 16 partitioned locks for
heavyweight lock tables - <code>BufferMappingLocks</code>: 128
partitioned locks for buffer pool hash table</p>
<p><strong>Array Layout</strong>
(<code>src/include/storage/lwlock.h:101-108</code>):</p>
<div class="sourceCode" id="cb286"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb286-1"><a aria-hidden="true" href="#cb286-1" tabindex="-1"></a><span class="pp">#define NUM_BUFFER_PARTITIONS  </span><span class="dv">128</span></span>
<span id="cb286-2"><a aria-hidden="true" href="#cb286-2" tabindex="-1"></a><span class="pp">#define NUM_LOCK_PARTITIONS  </span><span class="dv">16</span></span>
<span id="cb286-3"><a aria-hidden="true" href="#cb286-3" tabindex="-1"></a><span class="pp">#define NUM_PREDICATELOCK_PARTITIONS  </span><span class="dv">16</span></span>
<span id="cb286-4"><a aria-hidden="true" href="#cb286-4" tabindex="-1"></a></span>
<span id="cb286-5"><a aria-hidden="true" href="#cb286-5" tabindex="-1"></a><span class="pp">#define BUFFER_MAPPING_LWLOCK_OFFSET    NUM_INDIVIDUAL_LWLOCKS</span></span>
<span id="cb286-6"><a aria-hidden="true" href="#cb286-6" tabindex="-1"></a><span class="pp">#define LOCK_MANAGER_LWLOCK_OFFSET      </span><span class="op">(</span><span class="pp">BUFFER_MAPPING_LWLOCK_OFFSET </span><span class="op">+</span><span class="pp"> </span><span class="dv">128</span><span class="op">)</span></span>
<span id="cb286-7"><a aria-hidden="true" href="#cb286-7" tabindex="-1"></a><span class="pp">#define PREDICATELOCK_MANAGER_LWLOCK_OFFSET </span><span class="op">(</span>LOCK_MANAGER_LWLOCK_OFFSET<span class="pp"> </span><span class="op">+</span><span class="pp"> </span><span class="dv">16</span><span class="op">)</span></span>
<span id="cb286-8"><a aria-hidden="true" href="#cb286-8" tabindex="-1"></a><span class="pp">#define NUM_FIXED_LWLOCKS               </span><span class="op">(</span><span class="pp">PREDICATELOCK_MANAGER_LWLOCK_OFFSET </span><span class="op">+</span><span class="pp"> </span><span class="dv">16</span><span class="op">)</span></span></code></pre></div>
<h3 data-number="5.5.3" id="heavyweight-locks-regular-locks"><span class="header-section-number">5.5.3</span> 4.3 Heavyweight Locks
(Regular Locks)</h3>
<p><strong>Purpose</strong>: Table-driven lock system with deadlock
detection for user-visible objects.</p>
<p><strong>Files</strong>: -
<code>src/backend/storage/lmgr/lock.c</code> - Core lock manager -
<code>src/backend/storage/lmgr/lmgr.c</code> - High-level interface -
<code>src/backend/storage/lmgr/deadlock.c</code> - Deadlock
detection</p>
<h4 data-number="5.5.3.1" id="lock-structure"><span class="header-section-number">5.5.3.1</span> 4.3.1 Lock Structure</h4>
<p>The LOCK structure represents a lockable object
(<code>src/include/storage/lock.h:310-324</code>):</p>
<div class="sourceCode" id="cb287"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb287-1"><a aria-hidden="true" href="#cb287-1" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> LOCK <span class="op">{</span></span>
<span id="cb287-2"><a aria-hidden="true" href="#cb287-2" tabindex="-1"></a>    <span class="co">/* hash key */</span></span>
<span id="cb287-3"><a aria-hidden="true" href="#cb287-3" tabindex="-1"></a>    LOCKTAG       tag<span class="op">;</span>              <span class="co">/* unique identifier of lockable object */</span></span>
<span id="cb287-4"><a aria-hidden="true" href="#cb287-4" tabindex="-1"></a></span>
<span id="cb287-5"><a aria-hidden="true" href="#cb287-5" tabindex="-1"></a>    <span class="co">/* data */</span></span>
<span id="cb287-6"><a aria-hidden="true" href="#cb287-6" tabindex="-1"></a>    LOCKMASK      grantMask<span class="op">;</span>        <span class="co">/* bitmask for lock types already granted */</span></span>
<span id="cb287-7"><a aria-hidden="true" href="#cb287-7" tabindex="-1"></a>    LOCKMASK      waitMask<span class="op">;</span>         <span class="co">/* bitmask for lock types awaited */</span></span>
<span id="cb287-8"><a aria-hidden="true" href="#cb287-8" tabindex="-1"></a>    dlist_head    procLocks<span class="op">;</span>        <span class="co">/* list of PROCLOCK objects */</span></span>
<span id="cb287-9"><a aria-hidden="true" href="#cb287-9" tabindex="-1"></a>    dclist_head   waitProcs<span class="op">;</span>        <span class="co">/* list of waiting PGPROC objects */</span></span>
<span id="cb287-10"><a aria-hidden="true" href="#cb287-10" tabindex="-1"></a>    <span class="dt">int</span>           requested<span class="op">[</span>MAX_LOCKMODES<span class="op">];</span>  <span class="co">/* counts of requested locks */</span></span>
<span id="cb287-11"><a aria-hidden="true" href="#cb287-11" tabindex="-1"></a>    <span class="dt">int</span>           nRequested<span class="op">;</span>       <span class="co">/* total of requested[] */</span></span>
<span id="cb287-12"><a aria-hidden="true" href="#cb287-12" tabindex="-1"></a>    <span class="dt">int</span>           granted<span class="op">[</span>MAX_LOCKMODES<span class="op">];</span>    <span class="co">/* counts of granted locks */</span></span>
<span id="cb287-13"><a aria-hidden="true" href="#cb287-13" tabindex="-1"></a>    <span class="dt">int</span>           nGranted<span class="op">;</span>         <span class="co">/* total of granted[] */</span></span>
<span id="cb287-14"><a aria-hidden="true" href="#cb287-14" tabindex="-1"></a><span class="op">}</span> LOCK<span class="op">;</span></span></code></pre></div>
<h4 data-number="5.5.3.2" id="locktag-structure"><span class="header-section-number">5.5.3.2</span> 4.3.2 LOCKTAG
Structure</h4>
<p>LOCKTAG uniquely identifies a lockable object
(<code>src/include/storage/lock.h:166-174</code>):</p>
<div class="sourceCode" id="cb288"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb288-1"><a aria-hidden="true" href="#cb288-1" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> LOCKTAG <span class="op">{</span></span>
<span id="cb288-2"><a aria-hidden="true" href="#cb288-2" tabindex="-1"></a>    uint32  locktag_field1<span class="op">;</span>      <span class="co">/* e.g., database OID */</span></span>
<span id="cb288-3"><a aria-hidden="true" href="#cb288-3" tabindex="-1"></a>    uint32  locktag_field2<span class="op">;</span>      <span class="co">/* e.g., relation OID */</span></span>
<span id="cb288-4"><a aria-hidden="true" href="#cb288-4" tabindex="-1"></a>    uint32  locktag_field3<span class="op">;</span>      <span class="co">/* e.g., block number */</span></span>
<span id="cb288-5"><a aria-hidden="true" href="#cb288-5" tabindex="-1"></a>    uint16  locktag_field4<span class="op">;</span>      <span class="co">/* e.g., tuple offset */</span></span>
<span id="cb288-6"><a aria-hidden="true" href="#cb288-6" tabindex="-1"></a>    uint8   locktag_type<span class="op">;</span>        <span class="co">/* see LockTagType enum */</span></span>
<span id="cb288-7"><a aria-hidden="true" href="#cb288-7" tabindex="-1"></a>    uint8   locktag_lockmethodid<span class="op">;</span>  <span class="co">/* lockmethod indicator */</span></span>
<span id="cb288-8"><a aria-hidden="true" href="#cb288-8" tabindex="-1"></a><span class="op">}</span> LOCKTAG<span class="op">;</span></span></code></pre></div>
<p><strong>Lock Tag Types</strong>
(<code>src/include/storage/lock.h:137-152</code>): -
<code>LOCKTAG_RELATION</code> - Whole relation -
<code>LOCKTAG_RELATION_EXTEND</code> - Right to extend a relation -
<code>LOCKTAG_DATABASE_FROZEN_IDS</code> - Database‚Äôs datfrozenxid -
<code>LOCKTAG_PAGE</code> - One page of a relation -
<code>LOCKTAG_TUPLE</code> - One physical tuple -
<code>LOCKTAG_TRANSACTION</code> - Transaction (for waiting) -
<code>LOCKTAG_VIRTUALTRANSACTION</code> - Virtual transaction -
<code>LOCKTAG_SPECULATIVE_TOKEN</code> - Speculative insertion -
<code>LOCKTAG_OBJECT</code> - Non-relation database object -
<code>LOCKTAG_ADVISORY</code> - Advisory user locks</p>
<h4 data-number="5.5.3.3" id="proclock-structure"><span class="header-section-number">5.5.3.3</span> 4.3.3 PROCLOCK
Structure</h4>
<p>PROCLOCK represents a specific backend‚Äôs hold/wait on a lock
(<code>src/include/storage/lock.h:371-382</code>):</p>
<div class="sourceCode" id="cb289"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb289-1"><a aria-hidden="true" href="#cb289-1" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> PROCLOCK <span class="op">{</span></span>
<span id="cb289-2"><a aria-hidden="true" href="#cb289-2" tabindex="-1"></a>    <span class="co">/* tag */</span></span>
<span id="cb289-3"><a aria-hidden="true" href="#cb289-3" tabindex="-1"></a>    PROCLOCKTAG   tag<span class="op">;</span>            <span class="co">/* unique identifier */</span></span>
<span id="cb289-4"><a aria-hidden="true" href="#cb289-4" tabindex="-1"></a></span>
<span id="cb289-5"><a aria-hidden="true" href="#cb289-5" tabindex="-1"></a>    <span class="co">/* data */</span></span>
<span id="cb289-6"><a aria-hidden="true" href="#cb289-6" tabindex="-1"></a>    PGPROC       <span class="op">*</span>groupLeader<span class="op">;</span>    <span class="co">/* proc's lock group leader, or proc itself */</span></span>
<span id="cb289-7"><a aria-hidden="true" href="#cb289-7" tabindex="-1"></a>    LOCKMASK      holdMask<span class="op">;</span>       <span class="co">/* bitmask for lock types currently held */</span></span>
<span id="cb289-8"><a aria-hidden="true" href="#cb289-8" tabindex="-1"></a>    LOCKMASK      releaseMask<span class="op">;</span>    <span class="co">/* bitmask for lock types to be released */</span></span>
<span id="cb289-9"><a aria-hidden="true" href="#cb289-9" tabindex="-1"></a>    dlist_node    lockLink<span class="op">;</span>       <span class="co">/* list link in LOCK's list of proclocks */</span></span>
<span id="cb289-10"><a aria-hidden="true" href="#cb289-10" tabindex="-1"></a>    dlist_node    procLink<span class="op">;</span>       <span class="co">/* list link in PGPROC's list of proclocks */</span></span>
<span id="cb289-11"><a aria-hidden="true" href="#cb289-11" tabindex="-1"></a><span class="op">}</span> PROCLOCK<span class="op">;</span></span></code></pre></div>
<h4 data-number="5.5.3.4" id="lock-modes"><span class="header-section-number">5.5.3.4</span> 4.3.4 Lock Modes</h4>
<p>PostgreSQL supports 8 lock modes with different conflict semantics
(<code>src/backend/storage/lmgr/lock.c:65-119</code>):</p>
<div class="sourceCode" id="cb290"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb290-1"><a aria-hidden="true" href="#cb290-1" tabindex="-1"></a><span class="co">/* Lock mode enumeration (in lockdefs.h) */</span></span>
<span id="cb290-2"><a aria-hidden="true" href="#cb290-2" tabindex="-1"></a><span class="pp">#define NoLock                      </span><span class="dv">0</span></span>
<span id="cb290-3"><a aria-hidden="true" href="#cb290-3" tabindex="-1"></a><span class="pp">#define AccessShareLock             </span><span class="dv">1</span><span class="pp">  </span><span class="co">/* SELECT */</span></span>
<span id="cb290-4"><a aria-hidden="true" href="#cb290-4" tabindex="-1"></a><span class="pp">#define RowShareLock                </span><span class="dv">2</span><span class="pp">  </span><span class="co">/* SELECT FOR UPDATE/SHARE */</span></span>
<span id="cb290-5"><a aria-hidden="true" href="#cb290-5" tabindex="-1"></a><span class="pp">#define RowExclusiveLock            </span><span class="dv">3</span><span class="pp">  </span><span class="co">/* UPDATE, DELETE, INSERT */</span></span>
<span id="cb290-6"><a aria-hidden="true" href="#cb290-6" tabindex="-1"></a><span class="pp">#define ShareUpdateExclusiveLock    </span><span class="dv">4</span><span class="pp">  </span><span class="co">/* VACUUM, CREATE INDEX CONCURRENTLY */</span></span>
<span id="cb290-7"><a aria-hidden="true" href="#cb290-7" tabindex="-1"></a><span class="pp">#define ShareLock                   </span><span class="dv">5</span><span class="pp">  </span><span class="co">/* CREATE INDEX */</span></span>
<span id="cb290-8"><a aria-hidden="true" href="#cb290-8" tabindex="-1"></a><span class="pp">#define ShareRowExclusiveLock       </span><span class="dv">6</span><span class="pp">  </span><span class="co">/* Rare, like CREATE TRIGGER */</span></span>
<span id="cb290-9"><a aria-hidden="true" href="#cb290-9" tabindex="-1"></a><span class="pp">#define ExclusiveLock               </span><span class="dv">7</span><span class="pp">  </span><span class="co">/* Blocks all but AccessShareLock */</span></span>
<span id="cb290-10"><a aria-hidden="true" href="#cb290-10" tabindex="-1"></a><span class="pp">#define AccessExclusiveLock         </span><span class="dv">8</span><span class="pp">  </span><span class="co">/* ALTER TABLE, DROP TABLE, TRUNCATE */</span></span></code></pre></div>
<h4 data-number="5.5.3.5" id="lock-compatibility-matrix"><span class="header-section-number">5.5.3.5</span> 4.3.5 Lock Compatibility
Matrix</h4>
<p>The conflict table defines which lock modes conflict
(<code>src/backend/storage/lmgr/lock.c:65-105</code>):</p>
<pre><code>                          Current Lock Mode Held
Requested   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
Lock Mode   ‚îÇ AS  RS  RE  SUE  SH  SRE  EX  AE ‚îÇ
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
AS          ‚îÇ  ‚úì   ‚úì   ‚úì   ‚úì   ‚úì   ‚úì   ‚úì   ‚úó  ‚îÇ  AccessShare
RS          ‚îÇ  ‚úì   ‚úì   ‚úì   ‚úì   ‚úì   ‚úì   ‚úó   ‚úó  ‚îÇ  RowShare
RE          ‚îÇ  ‚úì   ‚úì   ‚úì   ‚úì   ‚úó   ‚úó   ‚úó   ‚úó  ‚îÇ  RowExclusive
SUE         ‚îÇ  ‚úì   ‚úì   ‚úì   ‚úó   ‚úó   ‚úó   ‚úó   ‚úó  ‚îÇ  ShareUpdateExclusive
SH          ‚îÇ  ‚úì   ‚úì   ‚úó   ‚úó   ‚úì   ‚úó   ‚úó   ‚úó  ‚îÇ  Share
SRE         ‚îÇ  ‚úì   ‚úì   ‚úó   ‚úó   ‚úó   ‚úó   ‚úó   ‚úó  ‚îÇ  ShareRowExclusive
EX          ‚îÇ  ‚úì   ‚úó   ‚úó   ‚úó   ‚úó   ‚úó   ‚úó   ‚úó  ‚îÇ  Exclusive
AE          ‚îÇ  ‚úó   ‚úó   ‚úó   ‚úó   ‚úó   ‚úó   ‚úó   ‚úó  ‚îÇ  AccessExclusive
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
‚úì = Compatible (no conflict)
‚úó = Conflicts (must wait)</code></pre>
<p>The actual implementation
(<code>src/backend/storage/lmgr/lock.c:65-105</code>):</p>
<div class="sourceCode" id="cb292"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb292-1"><a aria-hidden="true" href="#cb292-1" tabindex="-1"></a><span class="dt">static</span> <span class="dt">const</span> LOCKMASK LockConflicts<span class="op">[]</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb292-2"><a aria-hidden="true" href="#cb292-2" tabindex="-1"></a>    <span class="dv">0</span><span class="op">,</span>  <span class="co">/* NoLock */</span></span>
<span id="cb292-3"><a aria-hidden="true" href="#cb292-3" tabindex="-1"></a></span>
<span id="cb292-4"><a aria-hidden="true" href="#cb292-4" tabindex="-1"></a>    <span class="co">/* AccessShareLock */</span></span>
<span id="cb292-5"><a aria-hidden="true" href="#cb292-5" tabindex="-1"></a>    LOCKBIT_ON<span class="op">(</span>AccessExclusiveLock<span class="op">),</span></span>
<span id="cb292-6"><a aria-hidden="true" href="#cb292-6" tabindex="-1"></a></span>
<span id="cb292-7"><a aria-hidden="true" href="#cb292-7" tabindex="-1"></a>    <span class="co">/* RowShareLock */</span></span>
<span id="cb292-8"><a aria-hidden="true" href="#cb292-8" tabindex="-1"></a>    LOCKBIT_ON<span class="op">(</span>ExclusiveLock<span class="op">)</span> <span class="op">|</span> LOCKBIT_ON<span class="op">(</span>AccessExclusiveLock<span class="op">),</span></span>
<span id="cb292-9"><a aria-hidden="true" href="#cb292-9" tabindex="-1"></a></span>
<span id="cb292-10"><a aria-hidden="true" href="#cb292-10" tabindex="-1"></a>    <span class="co">/* RowExclusiveLock */</span></span>
<span id="cb292-11"><a aria-hidden="true" href="#cb292-11" tabindex="-1"></a>    LOCKBIT_ON<span class="op">(</span>ShareLock<span class="op">)</span> <span class="op">|</span> LOCKBIT_ON<span class="op">(</span>ShareRowExclusiveLock<span class="op">)</span> <span class="op">|</span></span>
<span id="cb292-12"><a aria-hidden="true" href="#cb292-12" tabindex="-1"></a>    LOCKBIT_ON<span class="op">(</span>ExclusiveLock<span class="op">)</span> <span class="op">|</span> LOCKBIT_ON<span class="op">(</span>AccessExclusiveLock<span class="op">),</span></span>
<span id="cb292-13"><a aria-hidden="true" href="#cb292-13" tabindex="-1"></a></span>
<span id="cb292-14"><a aria-hidden="true" href="#cb292-14" tabindex="-1"></a>    <span class="co">/* ShareUpdateExclusiveLock */</span></span>
<span id="cb292-15"><a aria-hidden="true" href="#cb292-15" tabindex="-1"></a>    LOCKBIT_ON<span class="op">(</span>ShareUpdateExclusiveLock<span class="op">)</span> <span class="op">|</span></span>
<span id="cb292-16"><a aria-hidden="true" href="#cb292-16" tabindex="-1"></a>    LOCKBIT_ON<span class="op">(</span>ShareLock<span class="op">)</span> <span class="op">|</span> LOCKBIT_ON<span class="op">(</span>ShareRowExclusiveLock<span class="op">)</span> <span class="op">|</span></span>
<span id="cb292-17"><a aria-hidden="true" href="#cb292-17" tabindex="-1"></a>    LOCKBIT_ON<span class="op">(</span>ExclusiveLock<span class="op">)</span> <span class="op">|</span> LOCKBIT_ON<span class="op">(</span>AccessExclusiveLock<span class="op">),</span></span>
<span id="cb292-18"><a aria-hidden="true" href="#cb292-18" tabindex="-1"></a></span>
<span id="cb292-19"><a aria-hidden="true" href="#cb292-19" tabindex="-1"></a>    <span class="co">/* ShareLock */</span></span>
<span id="cb292-20"><a aria-hidden="true" href="#cb292-20" tabindex="-1"></a>    LOCKBIT_ON<span class="op">(</span>RowExclusiveLock<span class="op">)</span> <span class="op">|</span> LOCKBIT_ON<span class="op">(</span>ShareUpdateExclusiveLock<span class="op">)</span> <span class="op">|</span></span>
<span id="cb292-21"><a aria-hidden="true" href="#cb292-21" tabindex="-1"></a>    LOCKBIT_ON<span class="op">(</span>ShareRowExclusiveLock<span class="op">)</span> <span class="op">|</span></span>
<span id="cb292-22"><a aria-hidden="true" href="#cb292-22" tabindex="-1"></a>    LOCKBIT_ON<span class="op">(</span>ExclusiveLock<span class="op">)</span> <span class="op">|</span> LOCKBIT_ON<span class="op">(</span>AccessExclusiveLock<span class="op">),</span></span>
<span id="cb292-23"><a aria-hidden="true" href="#cb292-23" tabindex="-1"></a></span>
<span id="cb292-24"><a aria-hidden="true" href="#cb292-24" tabindex="-1"></a>    <span class="co">/* ShareRowExclusiveLock */</span></span>
<span id="cb292-25"><a aria-hidden="true" href="#cb292-25" tabindex="-1"></a>    LOCKBIT_ON<span class="op">(</span>RowExclusiveLock<span class="op">)</span> <span class="op">|</span> LOCKBIT_ON<span class="op">(</span>ShareUpdateExclusiveLock<span class="op">)</span> <span class="op">|</span></span>
<span id="cb292-26"><a aria-hidden="true" href="#cb292-26" tabindex="-1"></a>    LOCKBIT_ON<span class="op">(</span>ShareLock<span class="op">)</span> <span class="op">|</span> LOCKBIT_ON<span class="op">(</span>ShareRowExclusiveLock<span class="op">)</span> <span class="op">|</span></span>
<span id="cb292-27"><a aria-hidden="true" href="#cb292-27" tabindex="-1"></a>    LOCKBIT_ON<span class="op">(</span>ExclusiveLock<span class="op">)</span> <span class="op">|</span> LOCKBIT_ON<span class="op">(</span>AccessExclusiveLock<span class="op">),</span></span>
<span id="cb292-28"><a aria-hidden="true" href="#cb292-28" tabindex="-1"></a></span>
<span id="cb292-29"><a aria-hidden="true" href="#cb292-29" tabindex="-1"></a>    <span class="co">/* ExclusiveLock */</span></span>
<span id="cb292-30"><a aria-hidden="true" href="#cb292-30" tabindex="-1"></a>    LOCKBIT_ON<span class="op">(</span>RowShareLock<span class="op">)</span> <span class="op">|</span></span>
<span id="cb292-31"><a aria-hidden="true" href="#cb292-31" tabindex="-1"></a>    LOCKBIT_ON<span class="op">(</span>RowExclusiveLock<span class="op">)</span> <span class="op">|</span> LOCKBIT_ON<span class="op">(</span>ShareUpdateExclusiveLock<span class="op">)</span> <span class="op">|</span></span>
<span id="cb292-32"><a aria-hidden="true" href="#cb292-32" tabindex="-1"></a>    LOCKBIT_ON<span class="op">(</span>ShareLock<span class="op">)</span> <span class="op">|</span> LOCKBIT_ON<span class="op">(</span>ShareRowExclusiveLock<span class="op">)</span> <span class="op">|</span></span>
<span id="cb292-33"><a aria-hidden="true" href="#cb292-33" tabindex="-1"></a>    LOCKBIT_ON<span class="op">(</span>ExclusiveLock<span class="op">)</span> <span class="op">|</span> LOCKBIT_ON<span class="op">(</span>AccessExclusiveLock<span class="op">),</span></span>
<span id="cb292-34"><a aria-hidden="true" href="#cb292-34" tabindex="-1"></a></span>
<span id="cb292-35"><a aria-hidden="true" href="#cb292-35" tabindex="-1"></a>    <span class="co">/* AccessExclusiveLock */</span></span>
<span id="cb292-36"><a aria-hidden="true" href="#cb292-36" tabindex="-1"></a>    LOCKBIT_ON<span class="op">(</span>AccessShareLock<span class="op">)</span> <span class="op">|</span> LOCKBIT_ON<span class="op">(</span>RowShareLock<span class="op">)</span> <span class="op">|</span></span>
<span id="cb292-37"><a aria-hidden="true" href="#cb292-37" tabindex="-1"></a>    LOCKBIT_ON<span class="op">(</span>RowExclusiveLock<span class="op">)</span> <span class="op">|</span> LOCKBIT_ON<span class="op">(</span>ShareUpdateExclusiveLock<span class="op">)</span> <span class="op">|</span></span>
<span id="cb292-38"><a aria-hidden="true" href="#cb292-38" tabindex="-1"></a>    LOCKBIT_ON<span class="op">(</span>ShareLock<span class="op">)</span> <span class="op">|</span> LOCKBIT_ON<span class="op">(</span>ShareRowExclusiveLock<span class="op">)</span> <span class="op">|</span></span>
<span id="cb292-39"><a aria-hidden="true" href="#cb292-39" tabindex="-1"></a>    LOCKBIT_ON<span class="op">(</span>ExclusiveLock<span class="op">)</span> <span class="op">|</span> LOCKBIT_ON<span class="op">(</span>AccessExclusiveLock<span class="op">)</span></span>
<span id="cb292-40"><a aria-hidden="true" href="#cb292-40" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<h4 data-number="5.5.3.6" id="fast-path-locking"><span class="header-section-number">5.5.3.6</span> 4.3.6 Fast-Path
Locking</h4>
<p>To reduce contention on lock manager structures, PostgreSQL
implements a fast-path for weak locks on relations
(<code>src/backend/storage/lmgr/README</code>, line 71-76):</p>
<p><strong>Eligible locks</strong>: - Use DEFAULT lock method - Lock
database relations (not shared relations) - Are ‚Äúweak‚Äù locks:
AccessShareLock, RowShareLock, or RowExclusiveLock - Can quickly verify
no conflicting locks exist</p>
<p><strong>Storage</strong>: Locks stored in PGPROC structure‚Äôs
fast-path arrays rather than shared hash tables.</p>
<p><strong>Limits</strong>: Configurable via
<code>max_locks_per_transaction</code>, up to 1024 groups √ó 16
slots/group.</p>
<h4 data-number="5.5.3.7" id="lock-acquisition-process"><span class="header-section-number">5.5.3.7</span> 4.3.7 Lock Acquisition
Process</h4>
<p>When acquiring a heavyweight lock (<code>LockAcquire()</code> in
<code>src/backend/storage/lmgr/lock.c</code>):</p>
<ol type="1">
<li><strong>Check fast-path</strong>: If eligible, try to acquire via
fast-path</li>
<li><strong>Hash the LOCKTAG</strong>: Compute hash to determine
partition</li>
<li><strong>Acquire partition LWLock</strong>: Lock the appropriate
partition</li>
<li><strong>Check local lock table</strong>: See if already holding this
lock locally</li>
<li><strong>Check shared LOCK table</strong>: Look up or create LOCK
object</li>
<li><strong>Check conflicts</strong>: Compare requested mode against
grantMask</li>
<li><strong>If no conflict</strong>:
<ul>
<li>Increment grant counts</li>
<li>Add to PROCLOCK (if needed)</li>
<li>Update masks</li>
<li>Return success</li>
</ul></li>
<li><strong>If conflict</strong>:
<ul>
<li>Add to wait queue</li>
<li>Release partition LWLock</li>
<li>Sleep on semaphore</li>
<li>Wake up when granted or deadlock detected</li>
</ul></li>
</ol>
<h2 data-number="5.6" id="deadlock-detection"><span class="header-section-number">5.6</span> 5. Deadlock Detection</h2>
<p><strong>File</strong>:
<code>src/backend/storage/lmgr/deadlock.c</code></p>
<h3 data-number="5.6.1" id="algorithm"><span class="header-section-number">5.6.1</span> 5.1 Algorithm</h3>
<p>PostgreSQL uses a <strong>depth-first search</strong> algorithm to
detect cycles in the wait-for graph.</p>
<p><strong>Trigger</strong>: Deadlock detection runs after
<code>deadlock_timeout</code> milliseconds (default: 1 second) of
waiting for a lock.</p>
<p><strong>Wait-for Graph</strong>: - Nodes: Processes (PGPROC) - Edges:
Process A ‚Üí Process B if A is waiting for a lock held by B</p>
<h3 data-number="5.6.2" id="detection-process"><span class="header-section-number">5.6.2</span> 5.2 Detection Process</h3>
<p>The <code>DeadLockCheck()</code> function
(<code>src/backend/storage/lmgr/deadlock.c</code>):</p>
<ol type="1">
<li><strong>Build wait-for graph</strong>: Scan lock tables to identify
all wait relationships</li>
<li><strong>Depth-first search</strong>: Starting from the waiting
process, follow edges</li>
<li><strong>Cycle detection</strong>: If we encounter a previously
visited process, we have a cycle</li>
<li><strong>Victim selection</strong>: Choose the process with the least
work done (lowest XID)</li>
<li><strong>Resolution</strong>: Send error to victim process to abort
its transaction</li>
</ol>
<p><strong>States</strong>
(<code>src/include/storage/lock.h:509-518</code>):</p>
<div class="sourceCode" id="cb293"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb293-1"><a aria-hidden="true" href="#cb293-1" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">enum</span> <span class="op">{</span></span>
<span id="cb293-2"><a aria-hidden="true" href="#cb293-2" tabindex="-1"></a>    DS_NOT_YET_CHECKED<span class="op">,</span>           <span class="co">/* no deadlock check has run yet */</span></span>
<span id="cb293-3"><a aria-hidden="true" href="#cb293-3" tabindex="-1"></a>    DS_NO_DEADLOCK<span class="op">,</span>               <span class="co">/* no deadlock detected */</span></span>
<span id="cb293-4"><a aria-hidden="true" href="#cb293-4" tabindex="-1"></a>    DS_SOFT_DEADLOCK<span class="op">,</span>             <span class="co">/* deadlock avoided by queue rearrangement */</span></span>
<span id="cb293-5"><a aria-hidden="true" href="#cb293-5" tabindex="-1"></a>    DS_HARD_DEADLOCK<span class="op">,</span>             <span class="co">/* deadlock, no way out but ERROR */</span></span>
<span id="cb293-6"><a aria-hidden="true" href="#cb293-6" tabindex="-1"></a>    DS_BLOCKED_BY_AUTOVACUUM<span class="op">,</span>     <span class="co">/* blocked by autovacuum worker */</span></span>
<span id="cb293-7"><a aria-hidden="true" href="#cb293-7" tabindex="-1"></a><span class="op">}</span> DeadLockState<span class="op">;</span></span></code></pre></div>
<h3 data-number="5.6.3" id="soft-deadlocks"><span class="header-section-number">5.6.3</span> 5.3 Soft Deadlocks</h3>
<p>Sometimes processes can be reordered in the wait queue to avoid a
deadlock without aborting any transaction. This is a ‚Äúsoft
deadlock.‚Äù</p>
<h3 data-number="5.6.4" id="timeout-strategy"><span class="header-section-number">5.6.4</span> 5.4 Timeout Strategy</h3>
<p>The <code>deadlock_timeout</code> delay serves two purposes: 1. Avoid
expensive deadlock checks for short lock waits 2. Allow time for locks
to be released naturally</p>
<h2 data-number="5.7" id="transaction-id-management-and-wraparound"><span class="header-section-number">5.7</span> 6. Transaction ID Management
and Wraparound</h2>
<h3 data-number="5.7.1" id="the-wraparound-problem"><span class="header-section-number">5.7.1</span> 6.1 The Wraparound
Problem</h3>
<p>With 32-bit XIDs, PostgreSQL can only represent ~4 billion
transactions before wraparound. The system uses modulo-2¬≥¬≤ arithmetic
for XID comparisons, which creates a 2-billion transaction window.</p>
<p><strong>The Crisis Point</strong>: Without intervention, old tuples
(with XIDs billions in the past) would suddenly appear to be in the
future after wraparound.</p>
<h3 data-number="5.7.2" id="transamvariables-structure"><span class="header-section-number">5.7.2</span> 6.2 TransamVariables
Structure</h3>
<p>Global transaction state is tracked in
<code>TransamVariablesData</code>
(<code>src/include/access/transam.h:209-255</code>):</p>
<div class="sourceCode" id="cb294"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb294-1"><a aria-hidden="true" href="#cb294-1" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> TransamVariablesData <span class="op">{</span></span>
<span id="cb294-2"><a aria-hidden="true" href="#cb294-2" tabindex="-1"></a>    <span class="co">/* Protected by OidGenLock */</span></span>
<span id="cb294-3"><a aria-hidden="true" href="#cb294-3" tabindex="-1"></a>    Oid           nextOid<span class="op">;</span></span>
<span id="cb294-4"><a aria-hidden="true" href="#cb294-4" tabindex="-1"></a>    uint32        oidCount<span class="op">;</span></span>
<span id="cb294-5"><a aria-hidden="true" href="#cb294-5" tabindex="-1"></a></span>
<span id="cb294-6"><a aria-hidden="true" href="#cb294-6" tabindex="-1"></a>    <span class="co">/* Protected by XidGenLock */</span></span>
<span id="cb294-7"><a aria-hidden="true" href="#cb294-7" tabindex="-1"></a>    FullTransactionId nextXid<span class="op">;</span>      <span class="co">/* next XID to assign */</span></span>
<span id="cb294-8"><a aria-hidden="true" href="#cb294-8" tabindex="-1"></a>    TransactionId oldestXid<span class="op">;</span>        <span class="co">/* cluster-wide minimum datfrozenxid */</span></span>
<span id="cb294-9"><a aria-hidden="true" href="#cb294-9" tabindex="-1"></a>    TransactionId xidVacLimit<span class="op">;</span>      <span class="co">/* start forcing autovacuums here */</span></span>
<span id="cb294-10"><a aria-hidden="true" href="#cb294-10" tabindex="-1"></a>    TransactionId xidWarnLimit<span class="op">;</span>     <span class="co">/* start complaining here */</span></span>
<span id="cb294-11"><a aria-hidden="true" href="#cb294-11" tabindex="-1"></a>    TransactionId xidStopLimit<span class="op">;</span>     <span class="co">/* refuse to advance nextXid beyond here */</span></span>
<span id="cb294-12"><a aria-hidden="true" href="#cb294-12" tabindex="-1"></a>    TransactionId xidWrapLimit<span class="op">;</span>     <span class="co">/* where the world ends */</span></span>
<span id="cb294-13"><a aria-hidden="true" href="#cb294-13" tabindex="-1"></a>    Oid           oldestXidDB<span class="op">;</span>      <span class="co">/* database with minimum datfrozenxid */</span></span>
<span id="cb294-14"><a aria-hidden="true" href="#cb294-14" tabindex="-1"></a></span>
<span id="cb294-15"><a aria-hidden="true" href="#cb294-15" tabindex="-1"></a>    <span class="co">/* Protected by CommitTsLock */</span></span>
<span id="cb294-16"><a aria-hidden="true" href="#cb294-16" tabindex="-1"></a>    TransactionId oldestCommitTsXid<span class="op">;</span></span>
<span id="cb294-17"><a aria-hidden="true" href="#cb294-17" tabindex="-1"></a>    TransactionId newestCommitTsXid<span class="op">;</span></span>
<span id="cb294-18"><a aria-hidden="true" href="#cb294-18" tabindex="-1"></a></span>
<span id="cb294-19"><a aria-hidden="true" href="#cb294-19" tabindex="-1"></a>    <span class="co">/* Protected by ProcArrayLock */</span></span>
<span id="cb294-20"><a aria-hidden="true" href="#cb294-20" tabindex="-1"></a>    FullTransactionId latestCompletedXid<span class="op">;</span></span>
<span id="cb294-21"><a aria-hidden="true" href="#cb294-21" tabindex="-1"></a>    uint64        xactCompletionCount<span class="op">;</span></span>
<span id="cb294-22"><a aria-hidden="true" href="#cb294-22" tabindex="-1"></a></span>
<span id="cb294-23"><a aria-hidden="true" href="#cb294-23" tabindex="-1"></a>    <span class="co">/* Protected by XactTruncationLock */</span></span>
<span id="cb294-24"><a aria-hidden="true" href="#cb294-24" tabindex="-1"></a>    TransactionId oldestClogXid<span class="op">;</span>    <span class="co">/* oldest it's safe to look up in clog */</span></span>
<span id="cb294-25"><a aria-hidden="true" href="#cb294-25" tabindex="-1"></a><span class="op">}</span> TransamVariablesData<span class="op">;</span></span></code></pre></div>
<h3 data-number="5.7.3" id="freezing"><span class="header-section-number">5.7.3</span> 6.3 Freezing</h3>
<p><strong>Freezing</strong> is the process of replacing old XIDs with
<code>FrozenTransactionId</code> (2), marking them as always
visible.</p>
<p><strong>When it happens</strong>: - During VACUUM when tuple‚Äôs
<code>xmin</code> age exceeds <code>vacuum_freeze_min_age</code>
(default: 50M) - During aggressive VACUUM (forced by wraparound
concerns) - Always when <code>xmin</code> age exceeds
<code>vacuum_freeze_table_age</code> (default: 150M)</p>
<p><strong>Mechanism</strong>: 1. VACUUM scans table pages 2. For each
tuple with old <code>xmin</code>: - Set <code>xmin</code> to
<code>FrozenTransactionId</code> - Mark page dirty - WAL-log the change
3. Update table‚Äôs <code>relfrozenxid</code> in <code>pg_class</code> 4.
Update database‚Äôs <code>datfrozenxid</code> in
<code>pg_database</code></p>
<h3 data-number="5.7.4" id="wraparound-protection"><span class="header-section-number">5.7.4</span> 6.4 Wraparound
Protection</h3>
<p><strong>Thresholds</strong> (measured in XIDs from
<code>oldestXid</code>):</p>
<ul>
<li><strong>xidVacLimit</strong> (~200M from <code>oldestXid</code>):
Start forcing autovacuum</li>
<li><strong>xidWarnLimit</strong> (~10M later): Begin warning in
logs</li>
<li><strong>xidStopLimit</strong> (~3M before wraparound): Refuse new
XIDs except for vacuum</li>
<li><strong>xidWrapLimit</strong>: Absolute wraparound point (shutdown
prevention)</li>
</ul>
<p><strong>Emergency Mode</strong>: When <code>xidStopLimit</code> is
reached, the system enters a mode where only superusers can execute
commands, and only for vacuum operations.</p>
<h3 data-number="5.7.5" id="multixact-ids"><span class="header-section-number">5.7.5</span> 6.5 MultiXact IDs</h3>
<p>For tuple locking (e.g., <code>SELECT FOR SHARE</code>), PostgreSQL
uses MultiXact IDs to represent multiple lockers. These also wrap around
and require freezing, managed similarly to regular XIDs.</p>
<p><strong>Files</strong>: -
<code>src/backend/access/transam/multixact.c</code> -
<code>src/include/access/multixact.h</code></p>
<h2 data-number="5.8" id="transaction-commit-and-abort"><span class="header-section-number">5.8</span> 7. Transaction Commit and
Abort</h2>
<h3 data-number="5.8.1" id="commit-processing"><span class="header-section-number">5.8.1</span> 7.1 Commit Processing</h3>
<p>The commit path (<code>CommitTransaction()</code> in
<code>src/backend/access/transam/xact.c</code>):</p>
<ol type="1">
<li><strong>Pre-commit phase</strong>:
<ul>
<li>Fire pre-commit callbacks</li>
<li>Write WAL for any pending operations</li>
<li>Prepare two-phase commit (if applicable)</li>
</ul></li>
<li><strong>Write commit record</strong>:
<ul>
<li>Create <code>xl_xact_commit</code> WAL record with:
<ul>
<li>Transaction timestamp</li>
<li>Dropped relations (to be unlinked)</li>
<li>Invalidation messages</li>
<li>Subtransaction XIDs</li>
<li>Other metadata</li>
</ul></li>
<li>Insert into WAL buffers</li>
<li>Flush to disk (if synchronous commit)</li>
</ul></li>
<li><strong>Update CLOG</strong>:
<ul>
<li>Mark transaction as committed in commit log</li>
<li>Use group commit optimization when possible</li>
</ul></li>
<li><strong>Post-commit cleanup</strong>:
<ul>
<li>Fire commit callbacks</li>
<li>Release locks</li>
<li>Clean up resource owners</li>
<li>Update stats</li>
<li>Clear transaction state</li>
</ul></li>
</ol>
<h3 data-number="5.8.2" id="commit-record-structure"><span class="header-section-number">5.8.2</span> 7.2 Commit Record
Structure</h3>
<p>From <code>src/include/access/xact.h:219-300</code>:</p>
<div class="sourceCode" id="cb295"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb295-1"><a aria-hidden="true" href="#cb295-1" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> xl_xact_commit <span class="op">{</span></span>
<span id="cb295-2"><a aria-hidden="true" href="#cb295-2" tabindex="-1"></a>    TimestampTz xact_time<span class="op">;</span>           <span class="co">/* time of commit */</span></span>
<span id="cb295-3"><a aria-hidden="true" href="#cb295-3" tabindex="-1"></a>    uint32      xinfo<span class="op">;</span>               <span class="co">/* info flags */</span></span>
<span id="cb295-4"><a aria-hidden="true" href="#cb295-4" tabindex="-1"></a>    <span class="co">/* Additional fields appended based on xinfo flags:</span></span>
<span id="cb295-5"><a aria-hidden="true" href="#cb295-5" tabindex="-1"></a><span class="co">     * - xl_xact_dbinfo (if XACT_XINFO_HAS_DBINFO)</span></span>
<span id="cb295-6"><a aria-hidden="true" href="#cb295-6" tabindex="-1"></a><span class="co">     * - xl_xact_subxacts (if XACT_XINFO_HAS_SUBXACTS)</span></span>
<span id="cb295-7"><a aria-hidden="true" href="#cb295-7" tabindex="-1"></a><span class="co">     * - xl_xact_relfilelocators (if XACT_XINFO_HAS_RELFILELOCATORS)</span></span>
<span id="cb295-8"><a aria-hidden="true" href="#cb295-8" tabindex="-1"></a><span class="co">     * - invalidation messages (if XACT_XINFO_HAS_INVALS)</span></span>
<span id="cb295-9"><a aria-hidden="true" href="#cb295-9" tabindex="-1"></a><span class="co">     * - shared inval messages (if XACT_XINFO_HAS_INVALS)</span></span>
<span id="cb295-10"><a aria-hidden="true" href="#cb295-10" tabindex="-1"></a><span class="co">     * - xl_xact_twophase (if XACT_XINFO_HAS_TWOPHASE)</span></span>
<span id="cb295-11"><a aria-hidden="true" href="#cb295-11" tabindex="-1"></a><span class="co">     * - xl_xact_origin (if XACT_XINFO_HAS_ORIGIN)</span></span>
<span id="cb295-12"><a aria-hidden="true" href="#cb295-12" tabindex="-1"></a><span class="co">     */</span></span>
<span id="cb295-13"><a aria-hidden="true" href="#cb295-13" tabindex="-1"></a><span class="op">}</span> xl_xact_commit<span class="op">;</span></span></code></pre></div>
<h3 data-number="5.8.3" id="abort-processing"><span class="header-section-number">5.8.3</span> 7.3 Abort Processing</h3>
<p>The abort path (<code>AbortTransaction()</code> in
<code>src/backend/access/transam/xact.c</code>):</p>
<ol type="1">
<li><strong>Cleanup phase</strong>:
<ul>
<li>Undo any incomplete operations</li>
<li>Close cursors</li>
<li>Abort subtransactions</li>
</ul></li>
<li><strong>Write abort record</strong>:
<ul>
<li>Create <code>xl_xact_abort</code> WAL record</li>
<li>Insert into WAL (async, no flush required)</li>
</ul></li>
<li><strong>Update CLOG</strong>:
<ul>
<li>Mark transaction as aborted</li>
<li>Mark subtransactions as aborted</li>
</ul></li>
<li><strong>Release resources</strong>:
<ul>
<li>Release all locks</li>
<li>Clean up memory contexts</li>
<li>Reset buffer pins</li>
<li>Fire abort callbacks</li>
</ul></li>
<li><strong>Reset state</strong>:
<ul>
<li>Clear transaction ID</li>
<li>Reset command counter</li>
<li>Clean up temporary tables</li>
</ul></li>
</ol>
<h3 data-number="5.8.4" id="commit-log-clog"><span class="header-section-number">5.8.4</span> 7.4 Commit Log (CLOG)</h3>
<p><strong>File</strong>:
<code>src/backend/access/transam/clog.c</code></p>
<p>The commit log is a SLRU (Simple Least-Recently-Used) buffer cache
that tracks transaction status.</p>
<p><strong>Status Values</strong>:</p>
<div class="sourceCode" id="cb296"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb296-1"><a aria-hidden="true" href="#cb296-1" tabindex="-1"></a><span class="pp">#define TRANSACTION_STATUS_IN_PROGRESS   </span><span class="bn">0x00</span></span>
<span id="cb296-2"><a aria-hidden="true" href="#cb296-2" tabindex="-1"></a><span class="pp">#define TRANSACTION_STATUS_COMMITTED     </span><span class="bn">0x01</span></span>
<span id="cb296-3"><a aria-hidden="true" href="#cb296-3" tabindex="-1"></a><span class="pp">#define TRANSACTION_STATUS_ABORTED       </span><span class="bn">0x02</span></span>
<span id="cb296-4"><a aria-hidden="true" href="#cb296-4" tabindex="-1"></a><span class="pp">#define TRANSACTION_STATUS_SUB_COMMITTED </span><span class="bn">0x03</span></span></code></pre></div>
<p><strong>Storage</strong>: 2 bits per transaction, organized in 8KB
pages (~32K transactions per page)</p>
<p><strong>Location</strong>: <code>$PGDATA/pg_xact/</code> (renamed
from <code>pg_clog</code> in PostgreSQL 10)</p>
<h3 data-number="5.8.5" id="subtransactions-1"><span class="header-section-number">5.8.5</span> 7.5 Subtransactions</h3>
<p>Subtransactions (savepoints) maintain their own XIDs and can be
independently rolled back.</p>
<p><strong>Nesting</strong>: Up to 64 levels supported</p>
<p><strong>XID Assignment</strong>: Subtransactions receive XIDs only if
they modify database state</p>
<p><strong>Commit/Abort</strong>: - Subtransaction commit merges state
into parent - Subtransaction abort reverts just that subtransaction‚Äôs
changes - Top transaction abort cascades to all subtransactions</p>
<p><strong>Caching</strong>: Up to 64 subtransaction XIDs cached in
PGPROC‚Äôs <code>subxids</code> array</p>
<h2 data-number="5.9" id="two-phase-commit-2pc"><span class="header-section-number">5.9</span> 8. Two-Phase Commit (2PC)</h2>
<p><strong>Files</strong>: -
<code>src/backend/access/transam/twophase.c</code> -
<code>src/include/access/twophase.h</code></p>
<h3 data-number="5.9.1" id="overview-11"><span class="header-section-number">5.9.1</span> 8.1 Overview</h3>
<p>Two-phase commit enables atomic commits across multiple resource
managers (typically distributed databases).</p>
<p><strong>Phases</strong>: 1. <strong>Prepare</strong>: Coordinator
asks all participants to prepare 2. <strong>Commit/Abort</strong>:
Coordinator tells all participants to commit or abort</p>
<h3 data-number="5.9.2" id="prepared-transactions"><span class="header-section-number">5.9.2</span> 8.2 Prepared
Transactions</h3>
<p><strong>Command</strong>: <code>PREPARE TRANSACTION 'gid'</code></p>
<p>Where <code>gid</code> is a globally unique identifier (max 200
characters).</p>
<p><strong>Prepare Process</strong>: 1. Validate transaction can be
prepared: - No temp tables accessed - No serialization failures - Within
<code>max_prepared_xacts</code> limit</p>
<ol start="2" type="1">
<li>Write prepare record to WAL:
<ul>
<li>Transaction‚Äôs locks</li>
<li>Modified files</li>
<li>Prepared timestamp</li>
<li>GID</li>
</ul></li>
<li>Create dummy PGPROC:
<ul>
<li>Represents prepared transaction</li>
<li>Holds its locks</li>
<li>Appears in pg_prepared_xacts</li>
</ul></li>
<li>Keep state file:
<ul>
<li>Location: <code>$PGDATA/pg_twophase/</code></li>
<li>Survives crashes</li>
<li>Used for recovery</li>
</ul></li>
</ol>
<h3 data-number="5.9.3" id="commitabort-prepared"><span class="header-section-number">5.9.3</span> 8.3 Commit/Abort
Prepared</h3>
<p><strong>Commit</strong>: <code>COMMIT PREPARED 'gid'</code> 1. Look
up prepared transaction 2. Write commit record 3. Update CLOG 4. Release
locks 5. Remove state file</p>
<p><strong>Abort</strong>: <code>ROLLBACK PREPARED 'gid'</code> 1. Look
up prepared transaction 2. Write abort record 3. Update CLOG 4. Release
locks 5. Remove state file</p>
<h3 data-number="5.9.4" id="recovery-of-prepared-transactions"><span class="header-section-number">5.9.4</span> 8.4 Recovery of Prepared
Transactions</h3>
<p>On crash recovery: 1. Read state files from <code>pg_twophase/</code>
2. Recreate dummy PGPROCs 3. Re-acquire their locks 4. Wait for explicit
COMMIT/ROLLBACK PREPARED</p>
<h3 data-number="5.9.5" id="limitations-and-caveats"><span class="header-section-number">5.9.5</span> 8.5 Limitations and
Caveats</h3>
<ul>
<li>Prepared transactions hold locks indefinitely</li>
<li>Can cause wraparound issues if not resolved</li>
<li>GID must be unique across the cluster</li>
<li><code>max_prepared_xacts</code> must be set &gt; 0</li>
<li>Cannot prepare if transaction accessed temp objects</li>
</ul>
<h2 data-number="5.10" id="isolation-levels-1"><span class="header-section-number">5.10</span> 9. Isolation Levels</h2>
<p>PostgreSQL implements four SQL standard isolation levels, though READ
UNCOMMITTED is treated as READ COMMITTED.</p>
<h3 data-number="5.10.1" id="read-committed"><span class="header-section-number">5.10.1</span> 9.1 READ COMMITTED</h3>
<p><strong>Default level</strong>: Yes</p>
<p><strong>Snapshot Scope</strong>: Per-statement</p>
<p><strong>Mechanism</strong>: - New snapshot acquired at start of each
statement - Sees all committed changes before statement start -
Different statements in same transaction may see different data</p>
<p><strong>Anomalies Prevented</strong>: - Dirty reads (reading
uncommitted data)</p>
<p><strong>Anomalies Permitted</strong>: - Non-repeatable reads -
Phantom reads - Serialization anomalies</p>
<p><strong>Implementation</strong>:</p>
<div class="sourceCode" id="cb297"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb297-1"><a aria-hidden="true" href="#cb297-1" tabindex="-1"></a><span class="cf">if</span> <span class="op">(</span>XactIsoLevel <span class="op">&gt;=</span> XACT_REPEATABLE_READ<span class="op">)</span></span>
<span id="cb297-2"><a aria-hidden="true" href="#cb297-2" tabindex="-1"></a>    <span class="co">/* Use transaction snapshot */</span></span>
<span id="cb297-3"><a aria-hidden="true" href="#cb297-3" tabindex="-1"></a><span class="cf">else</span></span>
<span id="cb297-4"><a aria-hidden="true" href="#cb297-4" tabindex="-1"></a>    <span class="co">/* Acquire new snapshot for each statement */</span></span></code></pre></div>
<h3 data-number="5.10.2" id="repeatable-read"><span class="header-section-number">5.10.2</span> 9.2 REPEATABLE READ</h3>
<p><strong>Snapshot Scope</strong>: Per-transaction</p>
<p><strong>Mechanism</strong>: - Single snapshot acquired at first
statement of transaction - All statements see same consistent view -
Can‚Äôt see changes committed after transaction start</p>
<p><strong>Anomalies Prevented</strong>: - Dirty reads - Non-repeatable
reads - Phantom reads (PostgreSQL-specific, stronger than standard)</p>
<p><strong>Anomalies Permitted</strong>: - Serialization anomalies</p>
<p><strong>Implementation</strong>:</p>
<div class="sourceCode" id="cb298"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb298-1"><a aria-hidden="true" href="#cb298-1" tabindex="-1"></a><span class="cf">if</span> <span class="op">(</span>IsolationUsesXactSnapshot<span class="op">())</span> <span class="op">{</span></span>
<span id="cb298-2"><a aria-hidden="true" href="#cb298-2" tabindex="-1"></a>    <span class="co">/* Use transaction snapshot for all statements */</span></span>
<span id="cb298-3"><a aria-hidden="true" href="#cb298-3" tabindex="-1"></a>    snapshot <span class="op">=</span> GetTransactionSnapshot<span class="op">();</span></span>
<span id="cb298-4"><a aria-hidden="true" href="#cb298-4" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>Update Behavior</strong>: - If row updated by concurrent
transaction, wait for it to commit/abort - If committed: raise
serialization error - If aborted: proceed with update</p>
<h3 data-number="5.10.3" id="serializable"><span class="header-section-number">5.10.3</span> 9.3 SERIALIZABLE</h3>
<p><strong>Snapshot Scope</strong>: Per-transaction (plus predicate
locking)</p>
<p><strong>Mechanism</strong>: Serializable Snapshot Isolation (SSI) -
Uses REPEATABLE READ snapshot - Plus predicate locks to detect dangerous
structures - Monitors read/write dependencies between transactions</p>
<p><strong>Anomalies Prevented</strong>: - All anomalies (guaranteed
serializable execution)</p>
<p><strong>Implementation</strong>: See Section 9.4</p>
<h3 data-number="5.10.4" id="serializable-snapshot-isolation-ssi-1"><span class="header-section-number">5.10.4</span> 9.4 Serializable Snapshot
Isolation (SSI)</h3>
<p><strong>Files</strong>: -
<code>src/backend/storage/lmgr/predicate.c</code> -
<code>src/backend/storage/lmgr/README-SSI</code> -
<code>src/include/storage/predicate.h</code></p>
<h4 data-number="5.10.4.1" id="theory"><span class="header-section-number">5.10.4.1</span> 9.4.1 Theory</h4>
<p>SSI prevents serialization anomalies by detecting dangerous patterns
in the dependency graph between transactions.</p>
<p><strong>Dependency Types</strong>: - <strong>rw-dependency</strong>
(read-write): T1 reads, T2 writes the same data -
<strong>wr-dependency</strong> (write-read): T1 writes, T2 reads the
same data - <strong>ww-dependency</strong> (write-write): T1 and T2 both
write the same data</p>
<p><strong>Dangerous Structure</strong>: A cycle in the serialization
graph containing at least two rw-dependencies with consecutive
edges.</p>
<p><strong>Detection</strong>: If T1 ‚Üí T2 ‚Üí T3 ‚Üí T1 and at least two
edges are rw-dependencies, abort one transaction.</p>
<h4 data-number="5.10.4.2" id="predicate-locks"><span class="header-section-number">5.10.4.2</span> 9.4.2 Predicate Locks</h4>
<p>Unlike heavyweight locks, predicate locks don‚Äôt block‚Äîthey only track
read patterns.</p>
<p><strong>Lock Granularity</strong>: - Tuple-level - Page-level (if too
many tuple locks) - Relation-level (if too many page locks)</p>
<p><strong>Lock Promotion</strong>: Automatically promoted to coarser
granularity to limit memory usage.</p>
<p><strong>SIRead Locks</strong>: Special locks that track what was
read</p>
<p><strong>Structure</strong> (conceptual):</p>
<div class="sourceCode" id="cb299"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb299-1"><a aria-hidden="true" href="#cb299-1" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> SERIALIZABLEXACT <span class="op">{</span></span>
<span id="cb299-2"><a aria-hidden="true" href="#cb299-2" tabindex="-1"></a>    VirtualTransactionId vxid<span class="op">;</span></span>
<span id="cb299-3"><a aria-hidden="true" href="#cb299-3" tabindex="-1"></a>    <span class="co">/* Lists of predicates read/written */</span></span>
<span id="cb299-4"><a aria-hidden="true" href="#cb299-4" tabindex="-1"></a>    <span class="co">/* Lists of conflicts (rw-dependencies) */</span></span>
<span id="cb299-5"><a aria-hidden="true" href="#cb299-5" tabindex="-1"></a>    <span class="co">/* Flags indicating dangerous structures */</span></span>
<span id="cb299-6"><a aria-hidden="true" href="#cb299-6" tabindex="-1"></a><span class="op">}</span> SERIALIZABLEXACT<span class="op">;</span></span></code></pre></div>
<h4 data-number="5.10.4.3" id="conflict-detection"><span class="header-section-number">5.10.4.3</span> 9.4.3 Conflict
Detection</h4>
<p><strong>On Write</strong>: 1. Check if any concurrent transaction
read this data 2. If yes, create rw-conflict edge 3. Check for dangerous
structure 4. If found, mark transaction for abort</p>
<p><strong>On Commit</strong>: 1. Check if transaction is part of
dangerous structure 2. If yes, abort with serialization failure 3.
Otherwise, commit and cleanup predicate locks</p>
<p><strong>On Read</strong>: 1. Record predicate lock on read data 2.
Check if any concurrent transaction wrote this data 3. Create
wr-conflict edge if needed</p>
<h4 data-number="5.10.4.4" id="safe-snapshots"><span class="header-section-number">5.10.4.4</span> 9.4.4 Safe Snapshots</h4>
<p>A transaction can commit safely if: 1. No older active transaction
exists, OR 2. It‚Äôs marked as ‚Äúsafe‚Äù (no dangerous structures
possible)</p>
<p><strong>Optimization</strong>: ‚ÄúDeferrable‚Äù read-only transactions
wait for a safe snapshot before starting, guaranteeing no serialization
failures.</p>
<h4 data-number="5.10.4.5" id="performance-considerations-1"><span class="header-section-number">5.10.4.5</span> 9.4.5 Performance
Considerations</h4>
<p><strong>Costs</strong>: - Extra shared memory for predicate locks -
CPU overhead for conflict detection - Possible serialization failures
requiring retry</p>
<p><strong>Best Practices</strong>: - Use SERIALIZABLE only when
necessary - Keep transactions short - Use DEFERRABLE for read-only
transactions - Retry on serialization failures</p>
<h4 data-number="5.10.4.6" id="configuration"><span class="header-section-number">5.10.4.6</span> 9.4.6 Configuration</h4>
<p><strong>GUC Variables</strong>: -
<code>max_pred_locks_per_transaction</code>: Memory for predicate locks
(default: 64) - <code>max_pred_locks_per_relation</code>: Triggers
promotion to relation lock (default: -2, auto) -
<code>max_pred_locks_per_page</code>: Triggers promotion to page lock
(default: 2)</p>
<h2 data-number="5.11" id="subtransaction-management"><span class="header-section-number">5.11</span> 10. Subtransaction
Management</h2>
<h3 data-number="5.11.1" id="savepoints"><span class="header-section-number">5.11.1</span> 10.1 Savepoints</h3>
<p><strong>SQL Command</strong>: <code>SAVEPOINT name</code></p>
<p><strong>Purpose</strong>: Create a named point within a transaction
to which you can roll back.</p>
<p><strong>Implementation</strong>: - Each savepoint starts a new
subtransaction - Receives own SubTransactionId - May receive XID if it
modifies data - Tracks resource ownership separately</p>
<h3 data-number="5.11.2" id="subtransaction-stack"><span class="header-section-number">5.11.2</span> 10.2 Subtransaction
Stack</h3>
<p>Subtransactions are organized in a tree:</p>
<pre><code>TopTransaction (XID = 1000)
‚îú‚îÄ‚îÄ Subtransaction 1 (SubXid = 1)
‚îÇ   ‚îú‚îÄ‚îÄ Subtransaction 2 (SubXid = 2, XID = 1001)
‚îÇ   ‚îî‚îÄ‚îÄ Subtransaction 3 (SubXid = 3)
‚îî‚îÄ‚îÄ Subtransaction 4 (SubXid = 4, XID = 1002)</code></pre>
<p><strong>Current State</strong>: Tracked in
<code>TopTransactionStateData</code> in
<code>src/backend/access/transam/xact.c</code></p>
<h3 data-number="5.11.3" id="xid-assignment-to-subtransactions"><span class="header-section-number">5.11.3</span> 10.3 XID Assignment to
Subtransactions</h3>
<p>Subtransactions receive XIDs only if they: - Modify database tables -
Create temp tables - Acquire certain types of locks</p>
<p><strong>Optimization</strong>: Read-only subtransactions don‚Äôt get
XIDs</p>
<h3 data-number="5.11.4" id="subtransaction-cache"><span class="header-section-number">5.11.4</span> 10.4 Subtransaction
Cache</h3>
<p>Each backend caches up to 64 subtransaction XIDs in
<code>PGPROC.subxids</code> array.</p>
<p><strong>Overflow</strong>: - Set
<code>subxidStatus.overflowed = true</code> - Must consult
<code>pg_subtrans</code> for remaining subXIDs - Performance impact on
visibility checks</p>
<h3 data-number="5.11.5" id="commitabort-behavior"><span class="header-section-number">5.11.5</span> 10.5 Commit/Abort
Behavior</h3>
<p><strong>RELEASE SAVEPOINT</strong>: Merges subtransaction into parent
- Resources transferred to parent - Locks retained - Memory contexts
merged</p>
<p><strong>ROLLBACK TO SAVEPOINT</strong>: Reverts subtransaction -
Releases resources - Keeps locks (they were acquired by parent or
earlier subtransactions) - Restarts subtransaction at savepoint</p>
<p><strong>Top Transaction Abort</strong>: Cascades to all
subtransactions</p>
<h2 data-number="5.12" id="transaction-state-tracking"><span class="header-section-number">5.12</span> 11. Transaction State
Tracking</h2>
<h3 data-number="5.12.1" id="transaction-state-machine"><span class="header-section-number">5.12.1</span> 11.1 Transaction State
Machine</h3>
<p>Transactions progress through states defined in
<code>TransState</code> enum:</p>
<div class="sourceCode" id="cb301"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb301-1"><a aria-hidden="true" href="#cb301-1" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">enum</span> TransState <span class="op">{</span></span>
<span id="cb301-2"><a aria-hidden="true" href="#cb301-2" tabindex="-1"></a>    TRANS_DEFAULT<span class="op">,</span>      <span class="co">/* Not in transaction */</span></span>
<span id="cb301-3"><a aria-hidden="true" href="#cb301-3" tabindex="-1"></a>    TRANS_START<span class="op">,</span>        <span class="co">/* Starting transaction */</span></span>
<span id="cb301-4"><a aria-hidden="true" href="#cb301-4" tabindex="-1"></a>    TRANS_INPROGRESS<span class="op">,</span>   <span class="co">/* Inside valid transaction */</span></span>
<span id="cb301-5"><a aria-hidden="true" href="#cb301-5" tabindex="-1"></a>    TRANS_COMMIT<span class="op">,</span>       <span class="co">/* Commit in progress */</span></span>
<span id="cb301-6"><a aria-hidden="true" href="#cb301-6" tabindex="-1"></a>    TRANS_ABORT<span class="op">,</span>        <span class="co">/* Abort in progress */</span></span>
<span id="cb301-7"><a aria-hidden="true" href="#cb301-7" tabindex="-1"></a>    TRANS_PREPARE<span class="op">,</span>      <span class="co">/* Prepare in progress */</span></span>
<span id="cb301-8"><a aria-hidden="true" href="#cb301-8" tabindex="-1"></a><span class="op">}</span> TransState<span class="op">;</span></span></code></pre></div>
<h3 data-number="5.12.2" id="transaction-flags"><span class="header-section-number">5.12.2</span> 11.2 Transaction Flags</h3>
<p>Various flags track transaction properties
(<code>src/include/access/xact.h:97-122</code>):</p>
<div class="sourceCode" id="cb302"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb302-1"><a aria-hidden="true" href="#cb302-1" tabindex="-1"></a><span class="pp">#define XACT_FLAGS_ACCESSEDTEMPNAMESPACE     </span><span class="op">(</span><span class="dv">1</span><span class="bu">U</span><span class="pp"> </span><span class="op">&lt;&lt;</span><span class="pp"> </span><span class="dv">0</span><span class="op">)</span><span class="pp">  </span><span class="co">/* Used temp objects */</span></span>
<span id="cb302-2"><a aria-hidden="true" href="#cb302-2" tabindex="-1"></a><span class="pp">#define XACT_FLAGS_ACQUIREDACCESSEXCLUSIVELOCK </span><span class="op">(</span><span class="dv">1</span><span class="bu">U</span><span class="pp"> </span><span class="op">&lt;&lt;</span><span class="pp"> </span><span class="dv">1</span><span class="op">)</span><span class="pp"> </span><span class="co">/* Held AEL */</span></span>
<span id="cb302-3"><a aria-hidden="true" href="#cb302-3" tabindex="-1"></a><span class="pp">#define XACT_FLAGS_NEEDIMMEDIATECOMMIT       </span><span class="op">(</span><span class="dv">1</span><span class="bu">U</span><span class="pp"> </span><span class="op">&lt;&lt;</span><span class="pp"> </span><span class="dv">2</span><span class="op">)</span><span class="pp">  </span><span class="co">/* e.g., CREATE DATABASE */</span></span>
<span id="cb302-4"><a aria-hidden="true" href="#cb302-4" tabindex="-1"></a><span class="pp">#define XACT_FLAGS_PIPELINING                </span><span class="op">(</span><span class="dv">1</span><span class="bu">U</span><span class="pp"> </span><span class="op">&lt;&lt;</span><span class="pp"> </span><span class="dv">3</span><span class="op">)</span><span class="pp">  </span><span class="co">/* Extended protocol pipeline */</span></span></code></pre></div>
<h3 data-number="5.12.3" id="command-counter"><span class="header-section-number">5.12.3</span> 11.3 Command Counter</h3>
<p><strong>CommandId</strong>: Sequence number within a transaction,
incremented for each SQL command.</p>
<p><strong>Purpose</strong>: Distinguish tuples modified by different
commands in same transaction.</p>
<p><strong>Implementation</strong>: - <code>currentCommandId</code> in
transaction state - Stored in tuple‚Äôs <code>t_cid</code> field (command
ID) - Used by <code>HeapTupleSatisfiesSelf()</code> for
intra-transaction visibility</p>
<h2 data-number="5.13" id="group-commit-optimization"><span class="header-section-number">5.13</span> 12. Group Commit
Optimization</h2>
<h3 data-number="5.13.1" id="wal-insert-locks"><span class="header-section-number">5.13.1</span> 12.1 WAL Insert Locks</h3>
<p>Multiple backends can insert WAL records concurrently using multiple
<code>WALInsertLocks</code>.</p>
<p><strong>Count</strong>: Configurable, typically 8</p>
<p><strong>Process</strong>: 1. Backend acquires one of N WAL insert
locks 2. Reserves space in WAL buffer 3. Copies record to buffer 4.
Releases insert lock</p>
<h3 data-number="5.13.2" id="clog-group-update"><span class="header-section-number">5.13.2</span> 12.2 CLOG Group Update</h3>
<p>Instead of each backend individually updating CLOG, backends form
groups:</p>
<p><strong>Leader</strong>: First backend to reach commit point
<strong>Members</strong>: Backends that arrive during leader‚Äôs
processing</p>
<p><strong>Process</strong>: 1. Backend adds itself to group via
<code>procArrayGroupFirst</code> 2. Leader takes all members‚Äô XIDs 3.
Leader updates CLOG for entire group 4. Leader wakes up all members 5.
Members return to their clients</p>
<p><strong>Benefit</strong>: Amortizes expensive CLOG I/O across
multiple transactions</p>
<p><strong>File</strong>: <code>src/backend/access/transam/clog.c</code>
- <code>TransactionIdSetPageStatusInternal()</code></p>
<h2 data-number="5.14" id="performance-considerations-2"><span class="header-section-number">5.14</span> 13. Performance
Considerations</h2>
<h3 data-number="5.14.1" id="lock-contention"><span class="header-section-number">5.14.1</span> 13.1 Lock Contention</h3>
<p><strong>Hot Locks</strong>: - <code>ProcArrayLock</code>: Snapshot
acquisition, XID assignment - <code>WALInsertLocks</code>: WAL record
insertion - <code>CLogControlLock</code>: CLOG updates - Buffer mapping
locks: Buffer pool hash table</p>
<p><strong>Mitigation Strategies</strong>: - Partitioning (lock hash
tables, buffer mappings) - Group operations (group commit, group XID
clear) - Lock-free algorithms (atomic operations) - Fast-path
locking</p>
<h3 data-number="5.14.2" id="transaction-id-consumption"><span class="header-section-number">5.14.2</span> 13.2 Transaction ID
Consumption</h3>
<p><strong>Problem</strong>: Applications doing many small transactions
consume XIDs rapidly</p>
<p><strong>Monitoring</strong>:</p>
<div class="sourceCode" id="cb303"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb303-1"><a aria-hidden="true" href="#cb303-1" tabindex="-1"></a><span class="kw">SELECT</span> age(datfrozenxid) <span class="kw">FROM</span> pg_database <span class="kw">WHERE</span> datname <span class="op">=</span> <span class="st">'postgres'</span>;</span></code></pre></div>
<p><strong>Mitigation</strong>: - Regular vacuuming (aggressive when
near limits) - Batch operations into larger transactions - Use
subtransactions sparingly</p>
<h3 data-number="5.14.3" id="snapshot-scalability"><span class="header-section-number">5.14.3</span> 13.3 Snapshot
Scalability</h3>
<p><strong>Issue</strong>: <code>GetSnapshotData()</code> must scan
entire process array</p>
<p><strong>Cost</strong>: O(max_connections) per snapshot</p>
<p><strong>Optimizations</strong>: - Dense arrays (PROC_HDR) for better
cache locality - <code>xactCompletionCount</code> to reuse snapshots
when no transactions completed - <code>GlobalVisState</code> for
computing visibility horizons</p>
<h3 data-number="5.14.4" id="long-running-transactions"><span class="header-section-number">5.14.4</span> 13.4 Long-Running
Transactions</h3>
<p><strong>Problems</strong>: - Block VACUUM from cleaning dead tuples
(hold back xmin horizon) - Consume snapshot memory (large
<code>xip</code> arrays) - Increase risk of wraparound - Hold locks for
extended periods</p>
<p><strong>Detection</strong>:</p>
<div class="sourceCode" id="cb304"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb304-1"><a aria-hidden="true" href="#cb304-1" tabindex="-1"></a><span class="kw">SELECT</span> pid, xact_start, state, <span class="kw">query</span></span>
<span id="cb304-2"><a aria-hidden="true" href="#cb304-2" tabindex="-1"></a><span class="kw">FROM</span> pg_stat_activity</span>
<span id="cb304-3"><a aria-hidden="true" href="#cb304-3" tabindex="-1"></a><span class="kw">WHERE</span> xact_start <span class="op">&lt;</span> now() <span class="op">-</span> <span class="dt">interval</span> <span class="st">'1 hour'</span></span>
<span id="cb304-4"><a aria-hidden="true" href="#cb304-4" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> xact_start;</span></code></pre></div>
<h2 data-number="5.15" id="debugging-and-monitoring"><span class="header-section-number">5.15</span> 14. Debugging and
Monitoring</h2>
<h3 data-number="5.15.1" id="lock-monitoring"><span class="header-section-number">5.15.1</span> 14.1 Lock Monitoring</h3>
<p><strong>System Views</strong>: - <code>pg_locks</code>: Current locks
held/awaited - <code>pg_stat_activity</code>: Backend status including
wait events - <code>pg_blocking_pids(pid)</code>: PIDs blocking a given
backend</p>
<p><strong>Lock Wait Events</strong>: - <code>Lock:relation</code>,
<code>Lock:tuple</code>, etc. - <code>LWLock:ProcArray</code>,
<code>LWLock:WALInsert</code>, etc.</p>
<h3 data-number="5.15.2" id="transaction-information"><span class="header-section-number">5.15.2</span> 14.2 Transaction
Information</h3>
<p><strong>Functions</strong>: - <code>txid_current()</code>: Current
transaction ID (64-bit) - <code>pg_current_xact_id()</code>: Full
transaction ID - <code>pg_snapshot_xmin(pg_current_snapshot())</code>:
Snapshot xmin - <code>age(xid)</code>: Age in transactions</p>
<p><strong>Views</strong>: - <code>pg_stat_activity</code>: Current
transaction state - <code>pg_prepared_xacts</code>: Prepared
transactions - <code>pg_stat_database</code>: Transaction counts,
conflicts</p>
<h3 data-number="5.15.3" id="deadlock-logging"><span class="header-section-number">5.15.3</span> 14.3 Deadlock Logging</h3>
<p><strong>Configuration</strong>:</p>
<pre><code>log_lock_waits = on          # Log long lock waits
deadlock_timeout = 1s        # Time before deadlock check
log_statement = 'all'        # Log all statements (for debugging)</code></pre>
<p><strong>Log Output</strong>: Contains wait-for graph and victim
selection.</p>
<h3 data-number="5.15.4" id="trace-flags"><span class="header-section-number">5.15.4</span> 14.4 Trace Flags</h3>
<p><strong>Compile-time Debug Options</strong> (in
<code>src/include/storage/lock.h</code>):</p>
<div class="sourceCode" id="cb306"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb306-1"><a aria-hidden="true" href="#cb306-1" tabindex="-1"></a><span class="pp">#ifdef LOCK_DEBUG</span></span>
<span id="cb306-2"><a aria-hidden="true" href="#cb306-2" tabindex="-1"></a><span class="kw">extern</span> <span class="dt">int</span> Trace_lock_oidmin<span class="op">;</span></span>
<span id="cb306-3"><a aria-hidden="true" href="#cb306-3" tabindex="-1"></a><span class="kw">extern</span> <span class="dt">bool</span> Trace_locks<span class="op">;</span></span>
<span id="cb306-4"><a aria-hidden="true" href="#cb306-4" tabindex="-1"></a><span class="kw">extern</span> <span class="dt">bool</span> Trace_userlocks<span class="op">;</span></span>
<span id="cb306-5"><a aria-hidden="true" href="#cb306-5" tabindex="-1"></a><span class="kw">extern</span> <span class="dt">int</span> Trace_lock_table<span class="op">;</span></span>
<span id="cb306-6"><a aria-hidden="true" href="#cb306-6" tabindex="-1"></a><span class="kw">extern</span> <span class="dt">bool</span> Debug_deadlocks<span class="op">;</span></span>
<span id="cb306-7"><a aria-hidden="true" href="#cb306-7" tabindex="-1"></a><span class="pp">#endif</span></span></code></pre></div>
<p>Enable with: <code>CFLAGS="-DLOCK_DEBUG" ./configure</code></p>
<h2 data-number="5.16" id="notable-source-code-locations"><span class="header-section-number">5.16</span> 15. Notable Source Code
Locations</h2>
<h3 data-number="5.16.1" id="core-transaction-files"><span class="header-section-number">5.16.1</span> 15.1 Core Transaction
Files</h3>
<table>
<colgroup>
<col style="width: 20%"/>
<col style="width: 30%"/>
<col style="width: 50%"/>
</colgroup>
<thead>
<tr>
<th>File</th>
<th>Purpose</th>
<th>Key Functions</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>src/backend/access/transam/xact.c</code></td>
<td>Transaction management</td>
<td><code>StartTransaction()</code>, <code>CommitTransaction()</code>,
<code>AbortTransaction()</code></td>
</tr>
<tr>
<td><code>src/backend/access/transam/varsup.c</code></td>
<td>XID/OID generation</td>
<td><code>GetNewTransactionId()</code>,
<code>GetNewObjectId()</code></td>
</tr>
<tr>
<td><code>src/backend/access/transam/clog.c</code></td>
<td>Commit log</td>
<td><code>TransactionIdSetTreeStatus()</code>,
<code>TransactionIdGetStatus()</code></td>
</tr>
<tr>
<td><code>src/backend/access/transam/twophase.c</code></td>
<td>Two-phase commit</td>
<td><code>PrepareTransaction()</code>,
<code>FinishPreparedTransaction()</code></td>
</tr>
<tr>
<td><code>src/backend/access/transam/subtrans.c</code></td>
<td>Subtransaction tracking</td>
<td><code>SubTransSetParent()</code>,
<code>SubTransGetParent()</code></td>
</tr>
</tbody>
</table>
<h3 data-number="5.16.2" id="lock-manager-files"><span class="header-section-number">5.16.2</span> 15.2 Lock Manager Files</h3>
<table>
<colgroup>
<col style="width: 20%"/>
<col style="width: 30%"/>
<col style="width: 50%"/>
</colgroup>
<thead>
<tr>
<th>File</th>
<th>Purpose</th>
<th>Key Functions</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>src/backend/storage/lmgr/lock.c</code></td>
<td>Heavyweight locks</td>
<td><code>LockAcquire()</code>, <code>LockRelease()</code>,
<code>GrantLock()</code></td>
</tr>
<tr>
<td><code>src/backend/storage/lmgr/lmgr.c</code></td>
<td>Lock manager API</td>
<td><code>LockRelation()</code>, <code>UnlockRelation()</code></td>
</tr>
<tr>
<td><code>src/backend/storage/lmgr/deadlock.c</code></td>
<td>Deadlock detection</td>
<td><code>DeadLockCheck()</code>, <code>DeadLockReport()</code></td>
</tr>
<tr>
<td><code>src/backend/storage/lmgr/lwlock.c</code></td>
<td>Lightweight locks</td>
<td><code>LWLockAcquire()</code>, <code>LWLockRelease()</code></td>
</tr>
<tr>
<td><code>src/backend/storage/lmgr/s_lock.c</code></td>
<td>Spinlocks</td>
<td><code>s_lock()</code>, platform-specific code</td>
</tr>
<tr>
<td><code>src/backend/storage/lmgr/proc.c</code></td>
<td>Process/wait queues</td>
<td><code>ProcSleep()</code>, <code>ProcWakeup()</code></td>
</tr>
<tr>
<td><code>src/backend/storage/lmgr/predicate.c</code></td>
<td>SSI implementation</td>
<td><code>PredicateLockTuple()</code>,
<code>CheckForSerializableConflictOut()</code></td>
</tr>
</tbody>
</table>
<h3 data-number="5.16.3" id="snapshot-and-visibility"><span class="header-section-number">5.16.3</span> 15.3 Snapshot and
Visibility</h3>
<table>
<colgroup>
<col style="width: 20%"/>
<col style="width: 30%"/>
<col style="width: 50%"/>
</colgroup>
<thead>
<tr>
<th>File</th>
<th>Purpose</th>
<th>Key Functions</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>src/backend/storage/ipc/procarray.c</code></td>
<td>Process array</td>
<td><code>GetSnapshotData()</code>, <code>ProcArrayAdd()</code></td>
</tr>
<tr>
<td><code>src/backend/utils/time/snapmgr.c</code></td>
<td>Snapshot management</td>
<td><code>RegisterSnapshot()</code>,
<code>GetTransactionSnapshot()</code></td>
</tr>
<tr>
<td><code>src/backend/access/heap/heapam_visibility.c</code></td>
<td>Tuple visibility</td>
<td><code>HeapTupleSatisfiesMVCC()</code>,
<code>HeapTupleSatisfiesUpdate()</code></td>
</tr>
</tbody>
</table>
<h3 data-number="5.16.4" id="key-header-files"><span class="header-section-number">5.16.4</span> 15.4 Key Header Files</h3>
<table>
<colgroup>
<col style="width: 37%"/>
<col style="width: 62%"/>
</colgroup>
<thead>
<tr>
<th>File</th>
<th>Contents</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>src/include/access/xact.h</code></td>
<td>Transaction state, isolation levels, commit record formats</td>
</tr>
<tr>
<td><code>src/include/access/transam.h</code></td>
<td>XID definitions, TransamVariables</td>
</tr>
<tr>
<td><code>src/include/storage/proc.h</code></td>
<td>PGPROC structure, PROC_HDR</td>
</tr>
<tr>
<td><code>src/include/storage/lock.h</code></td>
<td>LOCK, PROCLOCK, LOCKTAG structures, lock modes</td>
</tr>
<tr>
<td><code>src/include/storage/lwlock.h</code></td>
<td>LWLock structure, modes</td>
</tr>
<tr>
<td><code>src/include/utils/snapshot.h</code></td>
<td>SnapshotData structure, snapshot types</td>
</tr>
</tbody>
</table>
<h2 data-number="5.17" id="wal-records-for-transactions"><span class="header-section-number">5.17</span> 16. WAL Records for
Transactions</h2>
<p>Transaction state changes are logged to WAL for crash recovery.</p>
<h3 data-number="5.17.1" id="transaction-wal-record-types"><span class="header-section-number">5.17.1</span> 16.1 Transaction WAL Record
Types</h3>
<p>Defined in <code>src/include/access/xact.h:170-178</code>:</p>
<div class="sourceCode" id="cb307"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb307-1"><a aria-hidden="true" href="#cb307-1" tabindex="-1"></a><span class="pp">#define XLOG_XACT_COMMIT            </span><span class="bn">0x00</span></span>
<span id="cb307-2"><a aria-hidden="true" href="#cb307-2" tabindex="-1"></a><span class="pp">#define XLOG_XACT_PREPARE           </span><span class="bn">0x10</span></span>
<span id="cb307-3"><a aria-hidden="true" href="#cb307-3" tabindex="-1"></a><span class="pp">#define XLOG_XACT_ABORT             </span><span class="bn">0x20</span></span>
<span id="cb307-4"><a aria-hidden="true" href="#cb307-4" tabindex="-1"></a><span class="pp">#define XLOG_XACT_COMMIT_PREPARED   </span><span class="bn">0x30</span></span>
<span id="cb307-5"><a aria-hidden="true" href="#cb307-5" tabindex="-1"></a><span class="pp">#define XLOG_XACT_ABORT_PREPARED    </span><span class="bn">0x40</span></span>
<span id="cb307-6"><a aria-hidden="true" href="#cb307-6" tabindex="-1"></a><span class="pp">#define XLOG_XACT_ASSIGNMENT        </span><span class="bn">0x50</span><span class="pp">  </span><span class="co">/* Assign XIDs to subtransactions */</span></span>
<span id="cb307-7"><a aria-hidden="true" href="#cb307-7" tabindex="-1"></a><span class="pp">#define XLOG_XACT_INVALIDATIONS     </span><span class="bn">0x60</span></span></code></pre></div>
<h3 data-number="5.17.2" id="commit-record-contents"><span class="header-section-number">5.17.2</span> 16.2 Commit Record
Contents</h3>
<p>A commit record can include (flags in <code>xinfo</code> field): -
<code>XACT_XINFO_HAS_DBINFO</code>: Database and tablespace OIDs -
<code>XACT_XINFO_HAS_SUBXACTS</code>: Array of subtransaction XIDs -
<code>XACT_XINFO_HAS_RELFILELOCATORS</code>: Relations to be deleted -
<code>XACT_XINFO_HAS_INVALS</code>: Invalidation messages for system
caches - <code>XACT_XINFO_HAS_TWOPHASE</code>: Two-phase commit state -
<code>XACT_XINFO_HAS_ORIGIN</code>: Replication origin info -
<code>XACT_XINFO_HAS_AE_LOCKS</code>: Access Exclusive locks held -
<code>XACT_XINFO_HAS_GID</code>: Global transaction ID</p>
<h3 data-number="5.17.3" id="recovery"><span class="header-section-number">5.17.3</span> 16.3 Recovery</h3>
<p>During crash recovery
(<code>src/backend/access/transam/xlog.c</code>):</p>
<ol type="1">
<li><strong>Read WAL</strong> from last checkpoint</li>
<li><strong>Replay records</strong>:
<ul>
<li>Commit records ‚Üí mark in CLOG as committed</li>
<li>Abort records ‚Üí mark in CLOG as aborted</li>
<li>Prepare records ‚Üí recreate prepared transactions</li>
</ul></li>
<li><strong>Undo phase</strong>: Abort any transactions in-progress at
crash</li>
<li><strong>Cleanup</strong>: Remove temporary files, reset transaction
state</li>
</ol>
<h2 data-number="5.18" id="advanced-topics"><span class="header-section-number">5.18</span> 17. Advanced Topics</h2>
<h3 data-number="5.18.1" id="parallel-query-and-transactions"><span class="header-section-number">5.18.1</span> 17.1 Parallel Query and
Transactions</h3>
<p>Parallel workers inherit transaction state but: - Cannot start
subtransactions - Cannot access catalogs (in some contexts) - Share
parent‚Äôs XID but don‚Äôt modify transaction state - Coordinate through
shared memory and dynamic shared memory</p>
<h3 data-number="5.18.2" id="logical-replication-and-transaction-tracking"><span class="header-section-number">5.18.2</span> 17.2 Logical Replication and
Transaction Tracking</h3>
<p>Logical decoding requires: - Historic snapshots
(<code>SNAPSHOT_HISTORIC_MVCC</code>) - Replication slots to prevent WAL
removal - Transaction reassembly from WAL stream - Handling of
concurrent transactions</p>
<p><strong>File</strong>:
<code>src/backend/replication/logical/decode.c</code></p>
<h3 data-number="5.18.3" id="hot-standby-and-transaction-conflicts"><span class="header-section-number">5.18.3</span> 17.3 Hot Standby and
Transaction Conflicts</h3>
<p>On replicas, replay can conflict with queries: - <strong>Cleanup
conflicts</strong>: VACUUM removes tuples still visible to query -
<strong>Lock conflicts</strong>: Replay needs lock held by query -
<strong>Snapshot conflicts</strong>: Old snapshots block VACUUM
replay</p>
<p><strong>Resolution</strong>: - Cancel query (after
<code>max_standby_streaming_delay</code>) - Delay replay - Configure
<code>hot_standby_feedback</code></p>
<p><strong>File</strong>:
<code>src/backend/storage/ipc/standby.c</code></p>
<h3 data-number="5.18.4" id="prepared-transactions-and-replication"><span class="header-section-number">5.18.4</span> 17.4 Prepared Transactions
and Replication</h3>
<p>Prepared transactions require special handling: - Must exist on all
replicas before COMMIT PREPARED - Replayed during archive/streaming
recovery - Can span failover events</p>
<h2 data-number="5.19" id="common-pitfalls-and-best-practices"><span class="header-section-number">5.19</span> 18. Common Pitfalls and Best
Practices</h2>
<h3 data-number="5.19.1" id="pitfalls"><span class="header-section-number">5.19.1</span> 18.1 Pitfalls</h3>
<ol type="1">
<li><strong>Idle in Transaction</strong>: Holding transaction open
without activity
<ul>
<li>Blocks VACUUM</li>
<li>Holds locks</li>
<li>Consumes connection slot</li>
</ul></li>
<li><strong>Long Transactions</strong>:
<ul>
<li>Table bloat</li>
<li>Wraparound risk</li>
<li>Lock contention</li>
</ul></li>
<li><strong>Excessive Subtransactions</strong>:
<ul>
<li>PGPROC subxids cache overflow (&gt; 64)</li>
<li>Performance degradation</li>
<li>Every operation must check <code>pg_subtrans</code></li>
</ul></li>
<li><strong>Forgotten Prepared Transactions</strong>:
<ul>
<li>Locks held indefinitely</li>
<li>Wraparound danger</li>
<li>Resource leaks</li>
</ul></li>
<li><strong>Not Handling Serialization Failures</strong>:
<ul>
<li>SERIALIZABLE requires application retry logic</li>
<li>Can lead to user-visible errors</li>
</ul></li>
</ol>
<h3 data-number="5.19.2" id="best-practices"><span class="header-section-number">5.19.2</span> 18.2 Best Practices</h3>
<ol type="1">
<li><p><strong>Keep Transactions Short</strong>:</p>
<ul>
<li>Acquire locks late</li>
<li>Release early</li>
<li>Minimize work in transaction</li>
</ul></li>
<li><p><strong>Use Appropriate Isolation Level</strong>:</p>
<ul>
<li>READ COMMITTED for most workloads</li>
<li>REPEATABLE READ for consistent reporting</li>
<li>SERIALIZABLE only when needed</li>
</ul></li>
<li><p><strong>Monitor Transaction Age</strong>:</p>
<div class="sourceCode" id="cb308"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb308-1"><a aria-hidden="true" href="#cb308-1" tabindex="-1"></a><span class="kw">SELECT</span> datname, age(datfrozenxid)</span>
<span id="cb308-2"><a aria-hidden="true" href="#cb308-2" tabindex="-1"></a><span class="kw">FROM</span> pg_database</span>
<span id="cb308-3"><a aria-hidden="true" href="#cb308-3" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> age(datfrozenxid) <span class="kw">DESC</span>;</span></code></pre></div></li>
<li><p><strong>Handle Serialization Failures</strong>:</p>
<div class="sourceCode" id="cb309"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb309-1"><a aria-hidden="true" href="#cb309-1" tabindex="-1"></a><span class="cf">while</span> <span class="va">True</span>:</span>
<span id="cb309-2"><a aria-hidden="true" href="#cb309-2" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb309-3"><a aria-hidden="true" href="#cb309-3" tabindex="-1"></a>        <span class="co"># Transaction logic</span></span>
<span id="cb309-4"><a aria-hidden="true" href="#cb309-4" tabindex="-1"></a>        <span class="cf">break</span></span>
<span id="cb309-5"><a aria-hidden="true" href="#cb309-5" tabindex="-1"></a>    <span class="cf">except</span> SerializationError:</span>
<span id="cb309-6"><a aria-hidden="true" href="#cb309-6" tabindex="-1"></a>        <span class="co"># Retry with exponential backoff</span></span>
<span id="cb309-7"><a aria-hidden="true" href="#cb309-7" tabindex="-1"></a>        time.sleep(retry_delay)</span></code></pre></div></li>
<li><p><strong>Vacuum Regularly</strong>:</p>
<ul>
<li>Ensure autovacuum is running</li>
<li>Tune <code>autovacuum_vacuum_cost_limit</code></li>
<li>Manual VACUUM for critical tables</li>
</ul></li>
<li><p><strong>Set Appropriate Timeouts</strong>:</p>
<div class="sourceCode" id="cb310"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb310-1"><a aria-hidden="true" href="#cb310-1" tabindex="-1"></a><span class="kw">SET</span> statement_timeout <span class="op">=</span> <span class="st">'30s'</span>;</span>
<span id="cb310-2"><a aria-hidden="true" href="#cb310-2" tabindex="-1"></a><span class="kw">SET</span> idle_in_transaction_session_timeout <span class="op">=</span> <span class="st">'5min'</span>;</span></code></pre></div></li>
</ol>
<h2 data-number="5.20" id="future-directions"><span class="header-section-number">5.20</span> 19. Future Directions</h2>
<h3 data-number="5.20.1" id="ongoing-work"><span class="header-section-number">5.20.1</span> 19.1 Ongoing Work</h3>
<ul>
<li><strong>64-bit XIDs</strong>: Eliminate wraparound concerns
entirely</li>
<li><strong>Improved SSI performance</strong>: Reduce overhead of
serializable transactions</li>
<li><strong>Better subtransaction handling</strong>: Reduce cache
overflow impact</li>
<li><strong>Enhanced monitoring</strong>: More visibility into
transaction internals</li>
</ul>
<h3 data-number="5.20.2" id="research-areas"><span class="header-section-number">5.20.2</span> 19.2 Research Areas</h3>
<ul>
<li>Lock-free data structures for hot paths</li>
<li>Improved deadlock prevention (vs.¬†detection)</li>
<li>Better integration with storage engines</li>
<li>Optimistic concurrency control alternatives</li>
</ul>
<h2 data-number="5.21" id="conclusion-2"><span class="header-section-number">5.21</span> Conclusion</h2>
<p>PostgreSQL‚Äôs transaction management system represents decades of
refinement in database concurrency control. The combination of MVCC,
hierarchical locking, and sophisticated snapshot isolation provides both
high performance and strong consistency guarantees. Understanding these
mechanisms is essential for:</p>
<ul>
<li><strong>Database Developers</strong>: Implementing new features
correctly</li>
<li><strong>Application Developers</strong>: Choosing appropriate
isolation levels and handling conflicts</li>
<li><strong>DBAs</strong>: Monitoring, tuning, and troubleshooting
production systems</li>
<li><strong>Contributors</strong>: Extending and optimizing the
system</li>
</ul>
<p>The modular design, with clear separation between spinlocks, LWLocks,
and heavyweight locks, and the elegant MVCC implementation based on
snapshots and visibility rules, demonstrates the careful engineering
that makes PostgreSQL a robust and scalable database system.</p>
<h2 data-number="5.22" id="references"><span class="header-section-number">5.22</span> References</h2>
<ol type="1">
<li><strong>Source Code Documentation</strong>:
<ul>
<li><code>src/backend/storage/lmgr/README</code> - Locking system
overview</li>
<li><code>src/backend/storage/lmgr/README-SSI</code> - Serializable
Snapshot Isolation</li>
<li><code>src/backend/access/transam/README</code> - Transaction
system</li>
</ul></li>
<li><strong>Academic Papers</strong>:
<ul>
<li>‚ÄúSerializable Snapshot Isolation in PostgreSQL‚Äù - Fekete et al.</li>
<li>‚ÄúA Critique of ANSI SQL Isolation Levels‚Äù - Berenson et al.</li>
</ul></li>
<li><strong>PostgreSQL Documentation</strong>:
<ul>
<li>Chapter 13: Concurrency Control</li>
<li>Chapter 30: Reliability and the Write-Ahead Log</li>
</ul></li>
<li><strong>Key Files</strong> (for reference):
<ul>
<li>Transaction:
<code>src/backend/access/transam/xact.c:1-6000</code></li>
<li>Locking: <code>src/backend/storage/lmgr/lock.c:1-4500</code></li>
<li>Snapshots:
<code>src/backend/storage/ipc/procarray.c:1-5000</code></li>
<li>SSI: <code>src/backend/storage/lmgr/predicate.c:1-5000</code></li>
</ul></li>
</ol>
<h1 data-number="6" id="chapter-4-replication-and-recovery-systems"><span class="header-section-number">6</span> Chapter 4: Replication and
Recovery Systems</h1>
<h2 data-number="6.1" id="overview-12"><span class="header-section-number">6.1</span> Overview</h2>
<p>PostgreSQL‚Äôs replication and recovery systems form the foundation of
high availability, disaster recovery, and data protection in modern
database deployments. These systems enable databases to maintain
multiple synchronized copies, recover from failures, and provide
continuous availability through sophisticated Write-Ahead Log (WAL)
based mechanisms.</p>
<p>This chapter explores the architectural components, algorithms, and
data structures that implement PostgreSQL‚Äôs replication capabilities,
from low-level WAL streaming to high-level logical replication, along
with comprehensive recovery mechanisms including crash recovery,
Point-In-Time Recovery (PITR), and hot standby operations.</p>
<hr/>
<h2 data-number="6.2" id="wal-based-streaming-replication"><span class="header-section-number">6.2</span> 1. WAL-Based Streaming
Replication</h2>
<h3 data-number="6.2.1" id="architecture-overview"><span class="header-section-number">6.2.1</span> 1.1 Architecture
Overview</h3>
<p>Streaming replication in PostgreSQL operates through a
producer-consumer model where a primary server (the WAL sender) streams
Write-Ahead Log records to one or more standby servers (WAL receivers).
This architecture provides real-time replication with minimal latency
and supports both synchronous and asynchronous replication modes.</p>
<p>The core components are: - <strong>WalSender</strong>: Process on the
primary that streams WAL data - <strong>WalReceiver</strong>: Process on
the standby that receives WAL data - <strong>Replication Slots</strong>:
Persistent markers tracking replication progress - <strong>WAL
Archive</strong>: Optional persistent WAL storage for disaster
recovery</p>
<h3 data-number="6.2.2" id="walsender-architecture"><span class="header-section-number">6.2.2</span> 1.2 WalSender
Architecture</h3>
<p>The WalSender process manages outbound replication connections. Each
replication connection has a dedicated WalSender process that reads WAL
from the primary‚Äôs WAL buffers or files and transmits it to
standbys.</p>
<p><strong>WalSnd Structure</strong>
(<code>src/include/replication/walsender_private.h:41-79</code>):</p>
<div class="sourceCode" id="cb311"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb311-1"><a aria-hidden="true" href="#cb311-1" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> WalSnd</span>
<span id="cb311-2"><a aria-hidden="true" href="#cb311-2" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb311-3"><a aria-hidden="true" href="#cb311-3" tabindex="-1"></a>    pid_t       pid<span class="op">;</span>            <span class="co">/* this walsender's PID, or 0 if not active */</span></span>
<span id="cb311-4"><a aria-hidden="true" href="#cb311-4" tabindex="-1"></a></span>
<span id="cb311-5"><a aria-hidden="true" href="#cb311-5" tabindex="-1"></a>    WalSndState state<span class="op">;</span>          <span class="co">/* this walsender's state */</span></span>
<span id="cb311-6"><a aria-hidden="true" href="#cb311-6" tabindex="-1"></a>    XLogRecPtr  sentPtr<span class="op">;</span>        <span class="co">/* WAL has been sent up to this point */</span></span>
<span id="cb311-7"><a aria-hidden="true" href="#cb311-7" tabindex="-1"></a>    <span class="dt">bool</span>        needreload<span class="op">;</span>     <span class="co">/* does currently-open file need to be reloaded? */</span></span>
<span id="cb311-8"><a aria-hidden="true" href="#cb311-8" tabindex="-1"></a></span>
<span id="cb311-9"><a aria-hidden="true" href="#cb311-9" tabindex="-1"></a>    <span class="co">/*</span></span>
<span id="cb311-10"><a aria-hidden="true" href="#cb311-10" tabindex="-1"></a><span class="co">     * The xlog locations that have been written, flushed, and applied by</span></span>
<span id="cb311-11"><a aria-hidden="true" href="#cb311-11" tabindex="-1"></a><span class="co">     * standby-side. These may be invalid if the standby-side has not offered</span></span>
<span id="cb311-12"><a aria-hidden="true" href="#cb311-12" tabindex="-1"></a><span class="co">     * values yet.</span></span>
<span id="cb311-13"><a aria-hidden="true" href="#cb311-13" tabindex="-1"></a><span class="co">     */</span></span>
<span id="cb311-14"><a aria-hidden="true" href="#cb311-14" tabindex="-1"></a>    XLogRecPtr  write<span class="op">;</span></span>
<span id="cb311-15"><a aria-hidden="true" href="#cb311-15" tabindex="-1"></a>    XLogRecPtr  flush<span class="op">;</span></span>
<span id="cb311-16"><a aria-hidden="true" href="#cb311-16" tabindex="-1"></a>    XLogRecPtr  apply<span class="op">;</span></span>
<span id="cb311-17"><a aria-hidden="true" href="#cb311-17" tabindex="-1"></a></span>
<span id="cb311-18"><a aria-hidden="true" href="#cb311-18" tabindex="-1"></a>    <span class="co">/* Measured lag times, or -1 for unknown/none. */</span></span>
<span id="cb311-19"><a aria-hidden="true" href="#cb311-19" tabindex="-1"></a>    TimeOffset  writeLag<span class="op">;</span></span>
<span id="cb311-20"><a aria-hidden="true" href="#cb311-20" tabindex="-1"></a>    TimeOffset  flushLag<span class="op">;</span></span>
<span id="cb311-21"><a aria-hidden="true" href="#cb311-21" tabindex="-1"></a>    TimeOffset  applyLag<span class="op">;</span></span>
<span id="cb311-22"><a aria-hidden="true" href="#cb311-22" tabindex="-1"></a></span>
<span id="cb311-23"><a aria-hidden="true" href="#cb311-23" tabindex="-1"></a>    <span class="co">/*</span></span>
<span id="cb311-24"><a aria-hidden="true" href="#cb311-24" tabindex="-1"></a><span class="co">     * The priority order of the standby managed by this WALSender, as listed</span></span>
<span id="cb311-25"><a aria-hidden="true" href="#cb311-25" tabindex="-1"></a><span class="co">     * in synchronous_standby_names, or 0 if not-listed.</span></span>
<span id="cb311-26"><a aria-hidden="true" href="#cb311-26" tabindex="-1"></a><span class="co">     */</span></span>
<span id="cb311-27"><a aria-hidden="true" href="#cb311-27" tabindex="-1"></a>    <span class="dt">int</span>         sync_standby_priority<span class="op">;</span></span>
<span id="cb311-28"><a aria-hidden="true" href="#cb311-28" tabindex="-1"></a></span>
<span id="cb311-29"><a aria-hidden="true" href="#cb311-29" tabindex="-1"></a>    <span class="co">/* Protects shared variables in this structure. */</span></span>
<span id="cb311-30"><a aria-hidden="true" href="#cb311-30" tabindex="-1"></a>    slock_t     mutex<span class="op">;</span></span>
<span id="cb311-31"><a aria-hidden="true" href="#cb311-31" tabindex="-1"></a></span>
<span id="cb311-32"><a aria-hidden="true" href="#cb311-32" tabindex="-1"></a>    <span class="co">/*</span></span>
<span id="cb311-33"><a aria-hidden="true" href="#cb311-33" tabindex="-1"></a><span class="co">     * Timestamp of the last message received from standby.</span></span>
<span id="cb311-34"><a aria-hidden="true" href="#cb311-34" tabindex="-1"></a><span class="co">     */</span></span>
<span id="cb311-35"><a aria-hidden="true" href="#cb311-35" tabindex="-1"></a>    TimestampTz replyTime<span class="op">;</span></span>
<span id="cb311-36"><a aria-hidden="true" href="#cb311-36" tabindex="-1"></a></span>
<span id="cb311-37"><a aria-hidden="true" href="#cb311-37" tabindex="-1"></a>    ReplicationKind kind<span class="op">;</span></span>
<span id="cb311-38"><a aria-hidden="true" href="#cb311-38" tabindex="-1"></a><span class="op">}</span> WalSnd<span class="op">;</span></span></code></pre></div>
<p>The <code>WalSnd</code> structure tracks critical replication
state:</p>
<ul>
<li><strong>Progress Tracking</strong>: <code>sentPtr</code>,
<code>write</code>, <code>flush</code>, and <code>apply</code> track WAL
propagation through the pipeline</li>
<li><strong>Lag Monitoring</strong>: <code>writeLag</code>,
<code>flushLag</code>, and <code>applyLag</code> measure replication
delay at each stage</li>
<li><strong>Synchronous Replication</strong>:
<code>sync_standby_priority</code> determines which standbys participate
in synchronous commits</li>
<li><strong>Concurrency Control</strong>: <code>mutex</code> spinlock
protects concurrent access to shared state</li>
</ul>
<p><strong>WalSender States</strong>
(<code>src/include/replication/walsender_private.h:24-31</code>):</p>
<div class="sourceCode" id="cb312"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb312-1"><a aria-hidden="true" href="#cb312-1" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">enum</span> WalSndState</span>
<span id="cb312-2"><a aria-hidden="true" href="#cb312-2" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb312-3"><a aria-hidden="true" href="#cb312-3" tabindex="-1"></a>    WALSNDSTATE_STARTUP <span class="op">=</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb312-4"><a aria-hidden="true" href="#cb312-4" tabindex="-1"></a>    WALSNDSTATE_BACKUP<span class="op">,</span></span>
<span id="cb312-5"><a aria-hidden="true" href="#cb312-5" tabindex="-1"></a>    WALSNDSTATE_CATCHUP<span class="op">,</span></span>
<span id="cb312-6"><a aria-hidden="true" href="#cb312-6" tabindex="-1"></a>    WALSNDSTATE_STREAMING<span class="op">,</span></span>
<span id="cb312-7"><a aria-hidden="true" href="#cb312-7" tabindex="-1"></a>    WALSNDSTATE_STOPPING<span class="op">,</span></span>
<span id="cb312-8"><a aria-hidden="true" href="#cb312-8" tabindex="-1"></a><span class="op">}</span> WalSndState<span class="op">;</span></span></code></pre></div>
<p>State transitions: 1. <strong>STARTUP</strong>: Initial state,
establishing connection 2. <strong>BACKUP</strong>: Transferring base
backup (pg_basebackup) 3. <strong>CATCHUP</strong>: Sending historical
WAL to bring standby up to date 4. <strong>STREAMING</strong>: Normal
streaming replication mode 5. <strong>STOPPING</strong>: Graceful
shutdown in progress</p>
<h3 data-number="6.2.3" id="walreceiver-architecture"><span class="header-section-number">6.2.3</span> 1.3 WalReceiver
Architecture</h3>
<p>The WalReceiver is a background process on standby servers that
connects to the primary‚Äôs WalSender, receives WAL data, and writes it to
local WAL files for replay by the startup process.</p>
<p><strong>WalRcvData Structure</strong>
(<code>src/include/replication/walreceiver.h:57-163</code>):</p>
<div class="sourceCode" id="cb313"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb313-1"><a aria-hidden="true" href="#cb313-1" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span></span>
<span id="cb313-2"><a aria-hidden="true" href="#cb313-2" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb313-3"><a aria-hidden="true" href="#cb313-3" tabindex="-1"></a>    <span class="co">/*</span></span>
<span id="cb313-4"><a aria-hidden="true" href="#cb313-4" tabindex="-1"></a><span class="co">     * Currently active walreceiver process's proc number and PID.</span></span>
<span id="cb313-5"><a aria-hidden="true" href="#cb313-5" tabindex="-1"></a><span class="co">     */</span></span>
<span id="cb313-6"><a aria-hidden="true" href="#cb313-6" tabindex="-1"></a>    ProcNumber  procno<span class="op">;</span></span>
<span id="cb313-7"><a aria-hidden="true" href="#cb313-7" tabindex="-1"></a>    pid_t       pid<span class="op">;</span></span>
<span id="cb313-8"><a aria-hidden="true" href="#cb313-8" tabindex="-1"></a></span>
<span id="cb313-9"><a aria-hidden="true" href="#cb313-9" tabindex="-1"></a>    <span class="co">/* Its current state */</span></span>
<span id="cb313-10"><a aria-hidden="true" href="#cb313-10" tabindex="-1"></a>    WalRcvState walRcvState<span class="op">;</span></span>
<span id="cb313-11"><a aria-hidden="true" href="#cb313-11" tabindex="-1"></a>    ConditionVariable walRcvStoppedCV<span class="op">;</span></span>
<span id="cb313-12"><a aria-hidden="true" href="#cb313-12" tabindex="-1"></a></span>
<span id="cb313-13"><a aria-hidden="true" href="#cb313-13" tabindex="-1"></a>    <span class="co">/* Its start time */</span></span>
<span id="cb313-14"><a aria-hidden="true" href="#cb313-14" tabindex="-1"></a>    pg_time_t   startTime<span class="op">;</span></span>
<span id="cb313-15"><a aria-hidden="true" href="#cb313-15" tabindex="-1"></a></span>
<span id="cb313-16"><a aria-hidden="true" href="#cb313-16" tabindex="-1"></a>    <span class="co">/*</span></span>
<span id="cb313-17"><a aria-hidden="true" href="#cb313-17" tabindex="-1"></a><span class="co">     * receiveStart and receiveStartTLI indicate the first byte position and</span></span>
<span id="cb313-18"><a aria-hidden="true" href="#cb313-18" tabindex="-1"></a><span class="co">     * timeline that will be received.</span></span>
<span id="cb313-19"><a aria-hidden="true" href="#cb313-19" tabindex="-1"></a><span class="co">     */</span></span>
<span id="cb313-20"><a aria-hidden="true" href="#cb313-20" tabindex="-1"></a>    XLogRecPtr  receiveStart<span class="op">;</span></span>
<span id="cb313-21"><a aria-hidden="true" href="#cb313-21" tabindex="-1"></a>    TimeLineID  receiveStartTLI<span class="op">;</span></span>
<span id="cb313-22"><a aria-hidden="true" href="#cb313-22" tabindex="-1"></a></span>
<span id="cb313-23"><a aria-hidden="true" href="#cb313-23" tabindex="-1"></a>    <span class="co">/*</span></span>
<span id="cb313-24"><a aria-hidden="true" href="#cb313-24" tabindex="-1"></a><span class="co">     * flushedUpto-1 is the last byte position that has already been received,</span></span>
<span id="cb313-25"><a aria-hidden="true" href="#cb313-25" tabindex="-1"></a><span class="co">     * and receivedTLI is the timeline it came from.</span></span>
<span id="cb313-26"><a aria-hidden="true" href="#cb313-26" tabindex="-1"></a><span class="co">     */</span></span>
<span id="cb313-27"><a aria-hidden="true" href="#cb313-27" tabindex="-1"></a>    XLogRecPtr  flushedUpto<span class="op">;</span></span>
<span id="cb313-28"><a aria-hidden="true" href="#cb313-28" tabindex="-1"></a>    TimeLineID  receivedTLI<span class="op">;</span></span>
<span id="cb313-29"><a aria-hidden="true" href="#cb313-29" tabindex="-1"></a></span>
<span id="cb313-30"><a aria-hidden="true" href="#cb313-30" tabindex="-1"></a>    <span class="co">/*</span></span>
<span id="cb313-31"><a aria-hidden="true" href="#cb313-31" tabindex="-1"></a><span class="co">     * latestChunkStart is the starting byte position of the current "batch"</span></span>
<span id="cb313-32"><a aria-hidden="true" href="#cb313-32" tabindex="-1"></a><span class="co">     * of received WAL.</span></span>
<span id="cb313-33"><a aria-hidden="true" href="#cb313-33" tabindex="-1"></a><span class="co">     */</span></span>
<span id="cb313-34"><a aria-hidden="true" href="#cb313-34" tabindex="-1"></a>    XLogRecPtr  latestChunkStart<span class="op">;</span></span>
<span id="cb313-35"><a aria-hidden="true" href="#cb313-35" tabindex="-1"></a></span>
<span id="cb313-36"><a aria-hidden="true" href="#cb313-36" tabindex="-1"></a>    <span class="co">/* Time of send and receive of any message received. */</span></span>
<span id="cb313-37"><a aria-hidden="true" href="#cb313-37" tabindex="-1"></a>    TimestampTz lastMsgSendTime<span class="op">;</span></span>
<span id="cb313-38"><a aria-hidden="true" href="#cb313-38" tabindex="-1"></a>    TimestampTz lastMsgReceiptTime<span class="op">;</span></span>
<span id="cb313-39"><a aria-hidden="true" href="#cb313-39" tabindex="-1"></a></span>
<span id="cb313-40"><a aria-hidden="true" href="#cb313-40" tabindex="-1"></a>    <span class="co">/* Latest reported end of WAL on the sender */</span></span>
<span id="cb313-41"><a aria-hidden="true" href="#cb313-41" tabindex="-1"></a>    XLogRecPtr  latestWalEnd<span class="op">;</span></span>
<span id="cb313-42"><a aria-hidden="true" href="#cb313-42" tabindex="-1"></a>    TimestampTz latestWalEndTime<span class="op">;</span></span>
<span id="cb313-43"><a aria-hidden="true" href="#cb313-43" tabindex="-1"></a></span>
<span id="cb313-44"><a aria-hidden="true" href="#cb313-44" tabindex="-1"></a>    <span class="co">/* connection string; initially set to connect to the primary */</span></span>
<span id="cb313-45"><a aria-hidden="true" href="#cb313-45" tabindex="-1"></a>    <span class="dt">char</span>        conninfo<span class="op">[</span>MAXCONNINFO<span class="op">];</span></span>
<span id="cb313-46"><a aria-hidden="true" href="#cb313-46" tabindex="-1"></a></span>
<span id="cb313-47"><a aria-hidden="true" href="#cb313-47" tabindex="-1"></a>    <span class="co">/* Host name and port number of the active replication connection. */</span></span>
<span id="cb313-48"><a aria-hidden="true" href="#cb313-48" tabindex="-1"></a>    <span class="dt">char</span>        sender_host<span class="op">[</span>NI_MAXHOST<span class="op">];</span></span>
<span id="cb313-49"><a aria-hidden="true" href="#cb313-49" tabindex="-1"></a>    <span class="dt">int</span>         sender_port<span class="op">;</span></span>
<span id="cb313-50"><a aria-hidden="true" href="#cb313-50" tabindex="-1"></a></span>
<span id="cb313-51"><a aria-hidden="true" href="#cb313-51" tabindex="-1"></a>    <span class="co">/* replication slot name */</span></span>
<span id="cb313-52"><a aria-hidden="true" href="#cb313-52" tabindex="-1"></a>    <span class="dt">char</span>        slotname<span class="op">[</span>NAMEDATALEN<span class="op">];</span></span>
<span id="cb313-53"><a aria-hidden="true" href="#cb313-53" tabindex="-1"></a></span>
<span id="cb313-54"><a aria-hidden="true" href="#cb313-54" tabindex="-1"></a>    <span class="co">/* If it's a temporary replication slot */</span></span>
<span id="cb313-55"><a aria-hidden="true" href="#cb313-55" tabindex="-1"></a>    <span class="dt">bool</span>        is_temp_slot<span class="op">;</span></span>
<span id="cb313-56"><a aria-hidden="true" href="#cb313-56" tabindex="-1"></a></span>
<span id="cb313-57"><a aria-hidden="true" href="#cb313-57" tabindex="-1"></a>    <span class="dt">bool</span>        ready_to_display<span class="op">;</span></span>
<span id="cb313-58"><a aria-hidden="true" href="#cb313-58" tabindex="-1"></a></span>
<span id="cb313-59"><a aria-hidden="true" href="#cb313-59" tabindex="-1"></a>    slock_t     mutex<span class="op">;</span>          <span class="co">/* locks shared variables shown above */</span></span>
<span id="cb313-60"><a aria-hidden="true" href="#cb313-60" tabindex="-1"></a></span>
<span id="cb313-61"><a aria-hidden="true" href="#cb313-61" tabindex="-1"></a>    <span class="co">/*</span></span>
<span id="cb313-62"><a aria-hidden="true" href="#cb313-62" tabindex="-1"></a><span class="co">     * Like flushedUpto, but advanced after writing and before flushing,</span></span>
<span id="cb313-63"><a aria-hidden="true" href="#cb313-63" tabindex="-1"></a><span class="co">     * without the need to acquire the spin lock.</span></span>
<span id="cb313-64"><a aria-hidden="true" href="#cb313-64" tabindex="-1"></a><span class="co">     */</span></span>
<span id="cb313-65"><a aria-hidden="true" href="#cb313-65" tabindex="-1"></a>    pg_atomic_uint64 writtenUpto<span class="op">;</span></span>
<span id="cb313-66"><a aria-hidden="true" href="#cb313-66" tabindex="-1"></a></span>
<span id="cb313-67"><a aria-hidden="true" href="#cb313-67" tabindex="-1"></a>    <span class="dt">sig_atomic_t</span> force_reply<span class="op">;</span>   <span class="co">/* used as a bool */</span></span>
<span id="cb313-68"><a aria-hidden="true" href="#cb313-68" tabindex="-1"></a><span class="op">}</span> WalRcvData<span class="op">;</span></span></code></pre></div>
<p><strong>WalReceiver States</strong>
(<code>src/include/replication/walreceiver.h:45-54</code>):</p>
<div class="sourceCode" id="cb314"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb314-1"><a aria-hidden="true" href="#cb314-1" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">enum</span></span>
<span id="cb314-2"><a aria-hidden="true" href="#cb314-2" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb314-3"><a aria-hidden="true" href="#cb314-3" tabindex="-1"></a>    WALRCV_STOPPED<span class="op">,</span>             <span class="co">/* stopped and mustn't start up again */</span></span>
<span id="cb314-4"><a aria-hidden="true" href="#cb314-4" tabindex="-1"></a>    WALRCV_STARTING<span class="op">,</span>            <span class="co">/* launched, but the process hasn't initialized yet */</span></span>
<span id="cb314-5"><a aria-hidden="true" href="#cb314-5" tabindex="-1"></a>    WALRCV_STREAMING<span class="op">,</span>           <span class="co">/* walreceiver is streaming */</span></span>
<span id="cb314-6"><a aria-hidden="true" href="#cb314-6" tabindex="-1"></a>    WALRCV_WAITING<span class="op">,</span>             <span class="co">/* stopped streaming, waiting for orders */</span></span>
<span id="cb314-7"><a aria-hidden="true" href="#cb314-7" tabindex="-1"></a>    WALRCV_RESTARTING<span class="op">,</span>          <span class="co">/* asked to restart streaming */</span></span>
<span id="cb314-8"><a aria-hidden="true" href="#cb314-8" tabindex="-1"></a>    WALRCV_STOPPING<span class="op">,</span>            <span class="co">/* requested to stop, but still running */</span></span>
<span id="cb314-9"><a aria-hidden="true" href="#cb314-9" tabindex="-1"></a><span class="op">}</span> WalRcvState<span class="op">;</span></span></code></pre></div>
<h3 data-number="6.2.4" id="replication-protocol-flow"><span class="header-section-number">6.2.4</span> 1.4 Replication Protocol
Flow</h3>
<p>The replication protocol implements a streaming COPY protocol with
feedback:</p>
<ol type="1">
<li><strong>Connection Establishment</strong>: Standby connects to
primary with <code>replication=true</code></li>
<li><strong>Slot Identification</strong>: Standby specifies replication
slot (optional but recommended)</li>
<li><strong>Start Position Negotiation</strong>: Standby sends
<code>START_REPLICATION</code> with desired LSN</li>
<li><strong>WAL Streaming</strong>: Primary sends WAL records in
CopyData messages</li>
<li><strong>Standby Feedback</strong>: Standby sends periodic status
updates with <code>write</code>, <code>flush</code>, <code>apply</code>
positions</li>
<li><strong>Flow Control</strong>: Primary uses feedback to manage WAL
retention and synchronous commits</li>
</ol>
<p><strong>Stream Options</strong>
(<code>src/include/replication/walreceiver.h:167-192</code>):</p>
<div class="sourceCode" id="cb315"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb315-1"><a aria-hidden="true" href="#cb315-1" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span></span>
<span id="cb315-2"><a aria-hidden="true" href="#cb315-2" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb315-3"><a aria-hidden="true" href="#cb315-3" tabindex="-1"></a>    <span class="dt">bool</span>        logical<span class="op">;</span>        <span class="co">/* True if logical replication, false if physical */</span></span>
<span id="cb315-4"><a aria-hidden="true" href="#cb315-4" tabindex="-1"></a>    <span class="dt">char</span>       <span class="op">*</span>slotname<span class="op">;</span>       <span class="co">/* Name of the replication slot or NULL */</span></span>
<span id="cb315-5"><a aria-hidden="true" href="#cb315-5" tabindex="-1"></a>    XLogRecPtr  startpoint<span class="op">;</span>     <span class="co">/* LSN of starting point */</span></span>
<span id="cb315-6"><a aria-hidden="true" href="#cb315-6" tabindex="-1"></a></span>
<span id="cb315-7"><a aria-hidden="true" href="#cb315-7" tabindex="-1"></a>    <span class="kw">union</span></span>
<span id="cb315-8"><a aria-hidden="true" href="#cb315-8" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb315-9"><a aria-hidden="true" href="#cb315-9" tabindex="-1"></a>        <span class="kw">struct</span></span>
<span id="cb315-10"><a aria-hidden="true" href="#cb315-10" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb315-11"><a aria-hidden="true" href="#cb315-11" tabindex="-1"></a>            TimeLineID  startpointTLI<span class="op">;</span>  <span class="co">/* Starting timeline */</span></span>
<span id="cb315-12"><a aria-hidden="true" href="#cb315-12" tabindex="-1"></a>        <span class="op">}</span>           physical<span class="op">;</span></span>
<span id="cb315-13"><a aria-hidden="true" href="#cb315-13" tabindex="-1"></a>        <span class="kw">struct</span></span>
<span id="cb315-14"><a aria-hidden="true" href="#cb315-14" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb315-15"><a aria-hidden="true" href="#cb315-15" tabindex="-1"></a>            uint32      proto_version<span class="op">;</span>  <span class="co">/* Logical protocol version */</span></span>
<span id="cb315-16"><a aria-hidden="true" href="#cb315-16" tabindex="-1"></a>            List       <span class="op">*</span>publication_names<span class="op">;</span></span>
<span id="cb315-17"><a aria-hidden="true" href="#cb315-17" tabindex="-1"></a>            <span class="dt">bool</span>        binary<span class="op">;</span>         <span class="co">/* Ask publisher to use binary */</span></span>
<span id="cb315-18"><a aria-hidden="true" href="#cb315-18" tabindex="-1"></a>            <span class="dt">char</span>       <span class="op">*</span>streaming_str<span class="op">;</span>  <span class="co">/* Streaming of large transactions */</span></span>
<span id="cb315-19"><a aria-hidden="true" href="#cb315-19" tabindex="-1"></a>            <span class="dt">bool</span>        twophase<span class="op">;</span>       <span class="co">/* Two-phase transactions */</span></span>
<span id="cb315-20"><a aria-hidden="true" href="#cb315-20" tabindex="-1"></a>            <span class="dt">char</span>       <span class="op">*</span>origin<span class="op">;</span>         <span class="co">/* Publish data from specified origin */</span></span>
<span id="cb315-21"><a aria-hidden="true" href="#cb315-21" tabindex="-1"></a>        <span class="op">}</span>           logical<span class="op">;</span></span>
<span id="cb315-22"><a aria-hidden="true" href="#cb315-22" tabindex="-1"></a>    <span class="op">}</span>           proto<span class="op">;</span></span>
<span id="cb315-23"><a aria-hidden="true" href="#cb315-23" tabindex="-1"></a><span class="op">}</span> WalRcvStreamOptions<span class="op">;</span></span></code></pre></div>
<hr/>
<h2 data-number="6.3" id="logical-replication-and-logical-decoding"><span class="header-section-number">6.3</span> 2. Logical Replication and
Logical Decoding</h2>
<h3 data-number="6.3.1" id="logical-replication-overview"><span class="header-section-number">6.3.1</span> 2.1 Logical Replication
Overview</h3>
<p>Logical replication decodes WAL records into logical change events
(INSERT, UPDATE, DELETE) that can be selectively replicated to
subscribers. Unlike physical replication which replicates exact
byte-level changes, logical replication operates at the table/row level
and supports:</p>
<ul>
<li><strong>Selective Replication</strong>: Replicate specific tables or
databases</li>
<li><strong>Version Independence</strong>: Different PostgreSQL versions
can replicate</li>
<li><strong>Data Transformation</strong>: Subscribers can have different
schemas, indexes, or constraints</li>
<li><strong>Multi-Master Capabilities</strong>: Bidirectional
replication configurations</li>
</ul>
<h3 data-number="6.3.2" id="logicaldecodingcontext"><span class="header-section-number">6.3.2</span> 2.2
LogicalDecodingContext</h3>
<p>The <code>LogicalDecodingContext</code> is the central coordinator
for logical decoding operations.</p>
<p><strong>Structure Definition</strong>
(<code>src/include/replication/logical.h:33-115</code>):</p>
<div class="sourceCode" id="cb316"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb316-1"><a aria-hidden="true" href="#cb316-1" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> LogicalDecodingContext</span>
<span id="cb316-2"><a aria-hidden="true" href="#cb316-2" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb316-3"><a aria-hidden="true" href="#cb316-3" tabindex="-1"></a>    <span class="co">/* memory context this is all allocated in */</span></span>
<span id="cb316-4"><a aria-hidden="true" href="#cb316-4" tabindex="-1"></a>    MemoryContext context<span class="op">;</span></span>
<span id="cb316-5"><a aria-hidden="true" href="#cb316-5" tabindex="-1"></a></span>
<span id="cb316-6"><a aria-hidden="true" href="#cb316-6" tabindex="-1"></a>    <span class="co">/* The associated replication slot */</span></span>
<span id="cb316-7"><a aria-hidden="true" href="#cb316-7" tabindex="-1"></a>    ReplicationSlot <span class="op">*</span>slot<span class="op">;</span></span>
<span id="cb316-8"><a aria-hidden="true" href="#cb316-8" tabindex="-1"></a></span>
<span id="cb316-9"><a aria-hidden="true" href="#cb316-9" tabindex="-1"></a>    <span class="co">/* infrastructure pieces for decoding */</span></span>
<span id="cb316-10"><a aria-hidden="true" href="#cb316-10" tabindex="-1"></a>    XLogReaderState <span class="op">*</span>reader<span class="op">;</span></span>
<span id="cb316-11"><a aria-hidden="true" href="#cb316-11" tabindex="-1"></a>    <span class="kw">struct</span> ReorderBuffer <span class="op">*</span>reorder<span class="op">;</span></span>
<span id="cb316-12"><a aria-hidden="true" href="#cb316-12" tabindex="-1"></a>    <span class="kw">struct</span> SnapBuild <span class="op">*</span>snapshot_builder<span class="op">;</span></span>
<span id="cb316-13"><a aria-hidden="true" href="#cb316-13" tabindex="-1"></a></span>
<span id="cb316-14"><a aria-hidden="true" href="#cb316-14" tabindex="-1"></a>    <span class="co">/*</span></span>
<span id="cb316-15"><a aria-hidden="true" href="#cb316-15" tabindex="-1"></a><span class="co">     * Marks the logical decoding context as fast forward decoding one.</span></span>
<span id="cb316-16"><a aria-hidden="true" href="#cb316-16" tabindex="-1"></a><span class="co">     */</span></span>
<span id="cb316-17"><a aria-hidden="true" href="#cb316-17" tabindex="-1"></a>    <span class="dt">bool</span>        fast_forward<span class="op">;</span></span>
<span id="cb316-18"><a aria-hidden="true" href="#cb316-18" tabindex="-1"></a></span>
<span id="cb316-19"><a aria-hidden="true" href="#cb316-19" tabindex="-1"></a>    OutputPluginCallbacks callbacks<span class="op">;</span></span>
<span id="cb316-20"><a aria-hidden="true" href="#cb316-20" tabindex="-1"></a>    OutputPluginOptions options<span class="op">;</span></span>
<span id="cb316-21"><a aria-hidden="true" href="#cb316-21" tabindex="-1"></a></span>
<span id="cb316-22"><a aria-hidden="true" href="#cb316-22" tabindex="-1"></a>    <span class="co">/* User specified options */</span></span>
<span id="cb316-23"><a aria-hidden="true" href="#cb316-23" tabindex="-1"></a>    List       <span class="op">*</span>output_plugin_options<span class="op">;</span></span>
<span id="cb316-24"><a aria-hidden="true" href="#cb316-24" tabindex="-1"></a></span>
<span id="cb316-25"><a aria-hidden="true" href="#cb316-25" tabindex="-1"></a>    <span class="co">/* User-Provided callback for writing/streaming out data. */</span></span>
<span id="cb316-26"><a aria-hidden="true" href="#cb316-26" tabindex="-1"></a>    LogicalOutputPluginWriterPrepareWrite prepare_write<span class="op">;</span></span>
<span id="cb316-27"><a aria-hidden="true" href="#cb316-27" tabindex="-1"></a>    LogicalOutputPluginWriterWrite write<span class="op">;</span></span>
<span id="cb316-28"><a aria-hidden="true" href="#cb316-28" tabindex="-1"></a>    LogicalOutputPluginWriterUpdateProgress update_progress<span class="op">;</span></span>
<span id="cb316-29"><a aria-hidden="true" href="#cb316-29" tabindex="-1"></a></span>
<span id="cb316-30"><a aria-hidden="true" href="#cb316-30" tabindex="-1"></a>    <span class="co">/* Output buffer. */</span></span>
<span id="cb316-31"><a aria-hidden="true" href="#cb316-31" tabindex="-1"></a>    StringInfo  out<span class="op">;</span></span>
<span id="cb316-32"><a aria-hidden="true" href="#cb316-32" tabindex="-1"></a></span>
<span id="cb316-33"><a aria-hidden="true" href="#cb316-33" tabindex="-1"></a>    <span class="co">/* Private data pointer of the output plugin. */</span></span>
<span id="cb316-34"><a aria-hidden="true" href="#cb316-34" tabindex="-1"></a>    <span class="dt">void</span>       <span class="op">*</span>output_plugin_private<span class="op">;</span></span>
<span id="cb316-35"><a aria-hidden="true" href="#cb316-35" tabindex="-1"></a></span>
<span id="cb316-36"><a aria-hidden="true" href="#cb316-36" tabindex="-1"></a>    <span class="co">/* Private data pointer for the data writer. */</span></span>
<span id="cb316-37"><a aria-hidden="true" href="#cb316-37" tabindex="-1"></a>    <span class="dt">void</span>       <span class="op">*</span>output_writer_private<span class="op">;</span></span>
<span id="cb316-38"><a aria-hidden="true" href="#cb316-38" tabindex="-1"></a></span>
<span id="cb316-39"><a aria-hidden="true" href="#cb316-39" tabindex="-1"></a>    <span class="co">/* Does the output plugin support streaming, and is it enabled? */</span></span>
<span id="cb316-40"><a aria-hidden="true" href="#cb316-40" tabindex="-1"></a>    <span class="dt">bool</span>        streaming<span class="op">;</span></span>
<span id="cb316-41"><a aria-hidden="true" href="#cb316-41" tabindex="-1"></a></span>
<span id="cb316-42"><a aria-hidden="true" href="#cb316-42" tabindex="-1"></a>    <span class="co">/* Does the output plugin support two-phase decoding, and is it enabled? */</span></span>
<span id="cb316-43"><a aria-hidden="true" href="#cb316-43" tabindex="-1"></a>    <span class="dt">bool</span>        twophase<span class="op">;</span></span>
<span id="cb316-44"><a aria-hidden="true" href="#cb316-44" tabindex="-1"></a></span>
<span id="cb316-45"><a aria-hidden="true" href="#cb316-45" tabindex="-1"></a>    <span class="co">/* Is two-phase option given by output plugin? */</span></span>
<span id="cb316-46"><a aria-hidden="true" href="#cb316-46" tabindex="-1"></a>    <span class="dt">bool</span>        twophase_opt_given<span class="op">;</span></span>
<span id="cb316-47"><a aria-hidden="true" href="#cb316-47" tabindex="-1"></a></span>
<span id="cb316-48"><a aria-hidden="true" href="#cb316-48" tabindex="-1"></a>    <span class="co">/* State for writing output. */</span></span>
<span id="cb316-49"><a aria-hidden="true" href="#cb316-49" tabindex="-1"></a>    <span class="dt">bool</span>        accept_writes<span class="op">;</span></span>
<span id="cb316-50"><a aria-hidden="true" href="#cb316-50" tabindex="-1"></a>    <span class="dt">bool</span>        prepared_write<span class="op">;</span></span>
<span id="cb316-51"><a aria-hidden="true" href="#cb316-51" tabindex="-1"></a>    XLogRecPtr  write_location<span class="op">;</span></span>
<span id="cb316-52"><a aria-hidden="true" href="#cb316-52" tabindex="-1"></a>    TransactionId write_xid<span class="op">;</span></span>
<span id="cb316-53"><a aria-hidden="true" href="#cb316-53" tabindex="-1"></a>    <span class="dt">bool</span>        end_xact<span class="op">;</span></span>
<span id="cb316-54"><a aria-hidden="true" href="#cb316-54" tabindex="-1"></a></span>
<span id="cb316-55"><a aria-hidden="true" href="#cb316-55" tabindex="-1"></a>    <span class="co">/* Do we need to process any change in fast_forward mode? */</span></span>
<span id="cb316-56"><a aria-hidden="true" href="#cb316-56" tabindex="-1"></a>    <span class="dt">bool</span>        processing_required<span class="op">;</span></span>
<span id="cb316-57"><a aria-hidden="true" href="#cb316-57" tabindex="-1"></a><span class="op">}</span> LogicalDecodingContext<span class="op">;</span></span></code></pre></div>
<p>Key components:</p>
<ul>
<li><strong>ReorderBuffer</strong>: Assembles concurrent transactions
into commit order</li>
<li><strong>SnapBuild</strong>: Builds consistent snapshots for
decoding</li>
<li><strong>XLogReaderState</strong>: Reads and parses WAL records</li>
<li><strong>Output Plugin</strong>: Formats decoded changes for
transmission</li>
</ul>
<h3 data-number="6.3.3" id="reorderbuffer-transaction-reassembly"><span class="header-section-number">6.3.3</span> 2.3 ReorderBuffer:
Transaction Reassembly</h3>
<p>The ReorderBuffer is a sophisticated component that solves a critical
problem in logical decoding: WAL records from concurrent transactions
are interleaved, but subscribers need changes in transaction commit
order.</p>
<p><strong>ReorderBuffer Change Types</strong>
(<code>src/include/replication/reorderbuffer.h:50-64</code>):</p>
<div class="sourceCode" id="cb317"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb317-1"><a aria-hidden="true" href="#cb317-1" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">enum</span> ReorderBufferChangeType</span>
<span id="cb317-2"><a aria-hidden="true" href="#cb317-2" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb317-3"><a aria-hidden="true" href="#cb317-3" tabindex="-1"></a>    REORDER_BUFFER_CHANGE_INSERT<span class="op">,</span></span>
<span id="cb317-4"><a aria-hidden="true" href="#cb317-4" tabindex="-1"></a>    REORDER_BUFFER_CHANGE_UPDATE<span class="op">,</span></span>
<span id="cb317-5"><a aria-hidden="true" href="#cb317-5" tabindex="-1"></a>    REORDER_BUFFER_CHANGE_DELETE<span class="op">,</span></span>
<span id="cb317-6"><a aria-hidden="true" href="#cb317-6" tabindex="-1"></a>    REORDER_BUFFER_CHANGE_MESSAGE<span class="op">,</span></span>
<span id="cb317-7"><a aria-hidden="true" href="#cb317-7" tabindex="-1"></a>    REORDER_BUFFER_CHANGE_INVALIDATION<span class="op">,</span></span>
<span id="cb317-8"><a aria-hidden="true" href="#cb317-8" tabindex="-1"></a>    REORDER_BUFFER_CHANGE_INTERNAL_SNAPSHOT<span class="op">,</span></span>
<span id="cb317-9"><a aria-hidden="true" href="#cb317-9" tabindex="-1"></a>    REORDER_BUFFER_CHANGE_INTERNAL_COMMAND_ID<span class="op">,</span></span>
<span id="cb317-10"><a aria-hidden="true" href="#cb317-10" tabindex="-1"></a>    REORDER_BUFFER_CHANGE_INTERNAL_TUPLECID<span class="op">,</span></span>
<span id="cb317-11"><a aria-hidden="true" href="#cb317-11" tabindex="-1"></a>    REORDER_BUFFER_CHANGE_INTERNAL_SPEC_INSERT<span class="op">,</span></span>
<span id="cb317-12"><a aria-hidden="true" href="#cb317-12" tabindex="-1"></a>    REORDER_BUFFER_CHANGE_INTERNAL_SPEC_CONFIRM<span class="op">,</span></span>
<span id="cb317-13"><a aria-hidden="true" href="#cb317-13" tabindex="-1"></a>    REORDER_BUFFER_CHANGE_INTERNAL_SPEC_ABORT<span class="op">,</span></span>
<span id="cb317-14"><a aria-hidden="true" href="#cb317-14" tabindex="-1"></a>    REORDER_BUFFER_CHANGE_TRUNCATE<span class="op">,</span></span>
<span id="cb317-15"><a aria-hidden="true" href="#cb317-15" tabindex="-1"></a><span class="op">}</span> ReorderBufferChangeType<span class="op">;</span></span></code></pre></div>
<p><strong>ReorderBuffer Change Structure</strong>
(<code>src/include/replication/reorderbuffer.h:76-150</code>):</p>
<div class="sourceCode" id="cb318"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb318-1"><a aria-hidden="true" href="#cb318-1" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> ReorderBufferChange</span>
<span id="cb318-2"><a aria-hidden="true" href="#cb318-2" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb318-3"><a aria-hidden="true" href="#cb318-3" tabindex="-1"></a>    XLogRecPtr  lsn<span class="op">;</span></span>
<span id="cb318-4"><a aria-hidden="true" href="#cb318-4" tabindex="-1"></a></span>
<span id="cb318-5"><a aria-hidden="true" href="#cb318-5" tabindex="-1"></a>    <span class="co">/* The type of change. */</span></span>
<span id="cb318-6"><a aria-hidden="true" href="#cb318-6" tabindex="-1"></a>    ReorderBufferChangeType action<span class="op">;</span></span>
<span id="cb318-7"><a aria-hidden="true" href="#cb318-7" tabindex="-1"></a></span>
<span id="cb318-8"><a aria-hidden="true" href="#cb318-8" tabindex="-1"></a>    <span class="co">/* Transaction this change belongs to. */</span></span>
<span id="cb318-9"><a aria-hidden="true" href="#cb318-9" tabindex="-1"></a>    <span class="kw">struct</span> ReorderBufferTXN <span class="op">*</span>txn<span class="op">;</span></span>
<span id="cb318-10"><a aria-hidden="true" href="#cb318-10" tabindex="-1"></a></span>
<span id="cb318-11"><a aria-hidden="true" href="#cb318-11" tabindex="-1"></a>    RepOriginId origin_id<span class="op">;</span></span>
<span id="cb318-12"><a aria-hidden="true" href="#cb318-12" tabindex="-1"></a></span>
<span id="cb318-13"><a aria-hidden="true" href="#cb318-13" tabindex="-1"></a>    <span class="kw">union</span></span>
<span id="cb318-14"><a aria-hidden="true" href="#cb318-14" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb318-15"><a aria-hidden="true" href="#cb318-15" tabindex="-1"></a>        <span class="co">/* Old, new tuples when action == *_INSERT|UPDATE|DELETE */</span></span>
<span id="cb318-16"><a aria-hidden="true" href="#cb318-16" tabindex="-1"></a>        <span class="kw">struct</span></span>
<span id="cb318-17"><a aria-hidden="true" href="#cb318-17" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb318-18"><a aria-hidden="true" href="#cb318-18" tabindex="-1"></a>            RelFileLocator rlocator<span class="op">;</span></span>
<span id="cb318-19"><a aria-hidden="true" href="#cb318-19" tabindex="-1"></a>            <span class="dt">bool</span>        clear_toast_afterwards<span class="op">;</span></span>
<span id="cb318-20"><a aria-hidden="true" href="#cb318-20" tabindex="-1"></a>            HeapTuple   oldtuple<span class="op">;</span>   <span class="co">/* valid for DELETE || UPDATE */</span></span>
<span id="cb318-21"><a aria-hidden="true" href="#cb318-21" tabindex="-1"></a>            HeapTuple   newtuple<span class="op">;</span>   <span class="co">/* valid for INSERT || UPDATE */</span></span>
<span id="cb318-22"><a aria-hidden="true" href="#cb318-22" tabindex="-1"></a>        <span class="op">}</span>           tp<span class="op">;</span></span>
<span id="cb318-23"><a aria-hidden="true" href="#cb318-23" tabindex="-1"></a></span>
<span id="cb318-24"><a aria-hidden="true" href="#cb318-24" tabindex="-1"></a>        <span class="co">/* Truncate data */</span></span>
<span id="cb318-25"><a aria-hidden="true" href="#cb318-25" tabindex="-1"></a>        <span class="kw">struct</span></span>
<span id="cb318-26"><a aria-hidden="true" href="#cb318-26" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb318-27"><a aria-hidden="true" href="#cb318-27" tabindex="-1"></a>            Size        nrelids<span class="op">;</span></span>
<span id="cb318-28"><a aria-hidden="true" href="#cb318-28" tabindex="-1"></a>            <span class="dt">bool</span>        cascade<span class="op">;</span></span>
<span id="cb318-29"><a aria-hidden="true" href="#cb318-29" tabindex="-1"></a>            <span class="dt">bool</span>        restart_seqs<span class="op">;</span></span>
<span id="cb318-30"><a aria-hidden="true" href="#cb318-30" tabindex="-1"></a>            Oid        <span class="op">*</span>relids<span class="op">;</span></span>
<span id="cb318-31"><a aria-hidden="true" href="#cb318-31" tabindex="-1"></a>        <span class="op">}</span>           truncate<span class="op">;</span></span>
<span id="cb318-32"><a aria-hidden="true" href="#cb318-32" tabindex="-1"></a></span>
<span id="cb318-33"><a aria-hidden="true" href="#cb318-33" tabindex="-1"></a>        <span class="co">/* Message with arbitrary data. */</span></span>
<span id="cb318-34"><a aria-hidden="true" href="#cb318-34" tabindex="-1"></a>        <span class="kw">struct</span></span>
<span id="cb318-35"><a aria-hidden="true" href="#cb318-35" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb318-36"><a aria-hidden="true" href="#cb318-36" tabindex="-1"></a>            <span class="dt">char</span>       <span class="op">*</span>prefix<span class="op">;</span></span>
<span id="cb318-37"><a aria-hidden="true" href="#cb318-37" tabindex="-1"></a>            Size        message_size<span class="op">;</span></span>
<span id="cb318-38"><a aria-hidden="true" href="#cb318-38" tabindex="-1"></a>            <span class="dt">char</span>       <span class="op">*</span>message<span class="op">;</span></span>
<span id="cb318-39"><a aria-hidden="true" href="#cb318-39" tabindex="-1"></a>        <span class="op">}</span>           msg<span class="op">;</span></span>
<span id="cb318-40"><a aria-hidden="true" href="#cb318-40" tabindex="-1"></a></span>
<span id="cb318-41"><a aria-hidden="true" href="#cb318-41" tabindex="-1"></a>        <span class="co">/* New snapshot for catalog changes */</span></span>
<span id="cb318-42"><a aria-hidden="true" href="#cb318-42" tabindex="-1"></a>        Snapshot    snapshot<span class="op">;</span></span>
<span id="cb318-43"><a aria-hidden="true" href="#cb318-43" tabindex="-1"></a></span>
<span id="cb318-44"><a aria-hidden="true" href="#cb318-44" tabindex="-1"></a>        <span class="co">/* New command id for existing snapshot */</span></span>
<span id="cb318-45"><a aria-hidden="true" href="#cb318-45" tabindex="-1"></a>        CommandId   command_id<span class="op">;</span></span>
<span id="cb318-46"><a aria-hidden="true" href="#cb318-46" tabindex="-1"></a></span>
<span id="cb318-47"><a aria-hidden="true" href="#cb318-47" tabindex="-1"></a>        <span class="co">/* Catalog tuple metadata */</span></span>
<span id="cb318-48"><a aria-hidden="true" href="#cb318-48" tabindex="-1"></a>        <span class="kw">struct</span></span>
<span id="cb318-49"><a aria-hidden="true" href="#cb318-49" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb318-50"><a aria-hidden="true" href="#cb318-50" tabindex="-1"></a>            RelFileLocator locator<span class="op">;</span></span>
<span id="cb318-51"><a aria-hidden="true" href="#cb318-51" tabindex="-1"></a>            ItemPointerData tid<span class="op">;</span></span>
<span id="cb318-52"><a aria-hidden="true" href="#cb318-52" tabindex="-1"></a>            CommandId   cmin<span class="op">;</span></span>
<span id="cb318-53"><a aria-hidden="true" href="#cb318-53" tabindex="-1"></a>            CommandId   cmax<span class="op">;</span></span>
<span id="cb318-54"><a aria-hidden="true" href="#cb318-54" tabindex="-1"></a>            CommandId   combocid<span class="op">;</span></span>
<span id="cb318-55"><a aria-hidden="true" href="#cb318-55" tabindex="-1"></a>        <span class="op">}</span>           tuplecid<span class="op">;</span></span>
<span id="cb318-56"><a aria-hidden="true" href="#cb318-56" tabindex="-1"></a>    <span class="op">};</span></span>
<span id="cb318-57"><a aria-hidden="true" href="#cb318-57" tabindex="-1"></a><span class="op">}</span> ReorderBufferChange<span class="op">;</span></span></code></pre></div>
<p><strong>Algorithm</strong>:</p>
<ol type="1">
<li><strong>WAL Scanning</strong>: Read WAL records sequentially</li>
<li><strong>Transaction Buffering</strong>: Group changes by
TransactionId</li>
<li><strong>Memory Management</strong>: Spill large transactions to disk
when exceeding <code>logical_decoding_work_mem</code></li>
<li><strong>Commit Ordering</strong>: When transaction commits, replay
all its changes in order</li>
<li><strong>Snapshot Application</strong>: Use historical snapshots to
determine tuple visibility</li>
</ol>
<h3 data-number="6.3.4" id="output-plugins"><span class="header-section-number">6.3.4</span> 2.4 Output Plugins</h3>
<p>Output plugins transform decoded changes into wire format. PostgreSQL
provides <code>pgoutput</code> for native logical replication, and the
plugin API allows custom formats.</p>
<p><strong>Plugin Interface</strong>: - <code>startup_cb</code>:
Initialize plugin state - <code>begin_cb</code>: Transaction begin -
<code>change_cb</code>: Individual row change (INSERT/UPDATE/DELETE) -
<code>commit_cb</code>: Transaction commit - <code>message_cb</code>:
Logical decoding messages - <code>shutdown_cb</code>: Cleanup</p>
<hr/>
<h2 data-number="6.4" id="replication-slots"><span class="header-section-number">6.4</span> 3. Replication Slots</h2>
<h3 data-number="6.4.1" id="purpose-and-design"><span class="header-section-number">6.4.1</span> 3.1 Purpose and Design</h3>
<p>Replication slots provide persistence and feedback for replication
connections. They solve two critical problems:</p>
<ol type="1">
<li><strong>WAL Retention</strong>: Prevent WAL removal while standby is
disconnected</li>
<li><strong>Position Tracking</strong>: Remember replication position
across reconnections</li>
</ol>
<p><strong>Replication Slot Persistency</strong>
(<code>src/include/replication/slot.h:43-48</code>):</p>
<div class="sourceCode" id="cb319"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb319-1"><a aria-hidden="true" href="#cb319-1" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">enum</span> ReplicationSlotPersistency</span>
<span id="cb319-2"><a aria-hidden="true" href="#cb319-2" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb319-3"><a aria-hidden="true" href="#cb319-3" tabindex="-1"></a>    RS_PERSISTENT<span class="op">,</span>      <span class="co">/* Crash-safe, survives restarts */</span></span>
<span id="cb319-4"><a aria-hidden="true" href="#cb319-4" tabindex="-1"></a>    RS_EPHEMERAL<span class="op">,</span>       <span class="co">/* Temporary during slot creation */</span></span>
<span id="cb319-5"><a aria-hidden="true" href="#cb319-5" tabindex="-1"></a>    RS_TEMPORARY<span class="op">,</span>       <span class="co">/* Session-scoped, dropped on disconnect */</span></span>
<span id="cb319-6"><a aria-hidden="true" href="#cb319-6" tabindex="-1"></a><span class="op">}</span> ReplicationSlotPersistency<span class="op">;</span></span></code></pre></div>
<h3 data-number="6.4.2" id="replicationslot-data-structure"><span class="header-section-number">6.4.2</span> 3.2 ReplicationSlot Data
Structure</h3>
<p><strong>Persistent Data</strong>
(<code>src/include/replication/slot.h:77-144</code>):</p>
<div class="sourceCode" id="cb320"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb320-1"><a aria-hidden="true" href="#cb320-1" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> ReplicationSlotPersistentData</span>
<span id="cb320-2"><a aria-hidden="true" href="#cb320-2" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb320-3"><a aria-hidden="true" href="#cb320-3" tabindex="-1"></a>    <span class="co">/* The slot's identifier */</span></span>
<span id="cb320-4"><a aria-hidden="true" href="#cb320-4" tabindex="-1"></a>    NameData    name<span class="op">;</span></span>
<span id="cb320-5"><a aria-hidden="true" href="#cb320-5" tabindex="-1"></a></span>
<span id="cb320-6"><a aria-hidden="true" href="#cb320-6" tabindex="-1"></a>    <span class="co">/* database the slot is active on */</span></span>
<span id="cb320-7"><a aria-hidden="true" href="#cb320-7" tabindex="-1"></a>    Oid         database<span class="op">;</span></span>
<span id="cb320-8"><a aria-hidden="true" href="#cb320-8" tabindex="-1"></a></span>
<span id="cb320-9"><a aria-hidden="true" href="#cb320-9" tabindex="-1"></a>    <span class="co">/* The slot's behaviour when being dropped */</span></span>
<span id="cb320-10"><a aria-hidden="true" href="#cb320-10" tabindex="-1"></a>    ReplicationSlotPersistency persistency<span class="op">;</span></span>
<span id="cb320-11"><a aria-hidden="true" href="#cb320-11" tabindex="-1"></a></span>
<span id="cb320-12"><a aria-hidden="true" href="#cb320-12" tabindex="-1"></a>    <span class="co">/*</span></span>
<span id="cb320-13"><a aria-hidden="true" href="#cb320-13" tabindex="-1"></a><span class="co">     * xmin horizon for data</span></span>
<span id="cb320-14"><a aria-hidden="true" href="#cb320-14" tabindex="-1"></a><span class="co">     * NB: This may represent a value that hasn't been written to disk yet</span></span>
<span id="cb320-15"><a aria-hidden="true" href="#cb320-15" tabindex="-1"></a><span class="co">     */</span></span>
<span id="cb320-16"><a aria-hidden="true" href="#cb320-16" tabindex="-1"></a>    TransactionId xmin<span class="op">;</span></span>
<span id="cb320-17"><a aria-hidden="true" href="#cb320-17" tabindex="-1"></a></span>
<span id="cb320-18"><a aria-hidden="true" href="#cb320-18" tabindex="-1"></a>    <span class="co">/*</span></span>
<span id="cb320-19"><a aria-hidden="true" href="#cb320-19" tabindex="-1"></a><span class="co">     * xmin horizon for catalog tuples</span></span>
<span id="cb320-20"><a aria-hidden="true" href="#cb320-20" tabindex="-1"></a><span class="co">     */</span></span>
<span id="cb320-21"><a aria-hidden="true" href="#cb320-21" tabindex="-1"></a>    TransactionId catalog_xmin<span class="op">;</span></span>
<span id="cb320-22"><a aria-hidden="true" href="#cb320-22" tabindex="-1"></a></span>
<span id="cb320-23"><a aria-hidden="true" href="#cb320-23" tabindex="-1"></a>    <span class="co">/* oldest LSN that might be required by this replication slot */</span></span>
<span id="cb320-24"><a aria-hidden="true" href="#cb320-24" tabindex="-1"></a>    XLogRecPtr  restart_lsn<span class="op">;</span></span>
<span id="cb320-25"><a aria-hidden="true" href="#cb320-25" tabindex="-1"></a></span>
<span id="cb320-26"><a aria-hidden="true" href="#cb320-26" tabindex="-1"></a>    <span class="co">/* RS_INVAL_NONE if valid, or the reason for invalidation */</span></span>
<span id="cb320-27"><a aria-hidden="true" href="#cb320-27" tabindex="-1"></a>    ReplicationSlotInvalidationCause invalidated<span class="op">;</span></span>
<span id="cb320-28"><a aria-hidden="true" href="#cb320-28" tabindex="-1"></a></span>
<span id="cb320-29"><a aria-hidden="true" href="#cb320-29" tabindex="-1"></a>    <span class="co">/*</span></span>
<span id="cb320-30"><a aria-hidden="true" href="#cb320-30" tabindex="-1"></a><span class="co">     * Oldest LSN that the client has acked receipt for.</span></span>
<span id="cb320-31"><a aria-hidden="true" href="#cb320-31" tabindex="-1"></a><span class="co">     */</span></span>
<span id="cb320-32"><a aria-hidden="true" href="#cb320-32" tabindex="-1"></a>    XLogRecPtr  confirmed_flush<span class="op">;</span></span>
<span id="cb320-33"><a aria-hidden="true" href="#cb320-33" tabindex="-1"></a></span>
<span id="cb320-34"><a aria-hidden="true" href="#cb320-34" tabindex="-1"></a>    <span class="co">/* LSN at which we enabled two_phase commit */</span></span>
<span id="cb320-35"><a aria-hidden="true" href="#cb320-35" tabindex="-1"></a>    XLogRecPtr  two_phase_at<span class="op">;</span></span>
<span id="cb320-36"><a aria-hidden="true" href="#cb320-36" tabindex="-1"></a></span>
<span id="cb320-37"><a aria-hidden="true" href="#cb320-37" tabindex="-1"></a>    <span class="co">/* Allow decoding of prepared transactions? */</span></span>
<span id="cb320-38"><a aria-hidden="true" href="#cb320-38" tabindex="-1"></a>    <span class="dt">bool</span>        two_phase<span class="op">;</span></span>
<span id="cb320-39"><a aria-hidden="true" href="#cb320-39" tabindex="-1"></a></span>
<span id="cb320-40"><a aria-hidden="true" href="#cb320-40" tabindex="-1"></a>    <span class="co">/* plugin name */</span></span>
<span id="cb320-41"><a aria-hidden="true" href="#cb320-41" tabindex="-1"></a>    NameData    plugin<span class="op">;</span></span>
<span id="cb320-42"><a aria-hidden="true" href="#cb320-42" tabindex="-1"></a></span>
<span id="cb320-43"><a aria-hidden="true" href="#cb320-43" tabindex="-1"></a>    <span class="co">/* Was this slot synchronized from the primary server? */</span></span>
<span id="cb320-44"><a aria-hidden="true" href="#cb320-44" tabindex="-1"></a>    <span class="dt">bool</span>        synced<span class="op">;</span></span>
<span id="cb320-45"><a aria-hidden="true" href="#cb320-45" tabindex="-1"></a></span>
<span id="cb320-46"><a aria-hidden="true" href="#cb320-46" tabindex="-1"></a>    <span class="co">/* Is this a failover slot (sync candidate for standbys)? */</span></span>
<span id="cb320-47"><a aria-hidden="true" href="#cb320-47" tabindex="-1"></a>    <span class="dt">bool</span>        failover<span class="op">;</span></span>
<span id="cb320-48"><a aria-hidden="true" href="#cb320-48" tabindex="-1"></a><span class="op">}</span> ReplicationSlotPersistentData<span class="op">;</span></span></code></pre></div>
<p><strong>In-Memory Slot Structure</strong>
(<code>src/include/replication/slot.h:162-252</code>):</p>
<div class="sourceCode" id="cb321"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb321-1"><a aria-hidden="true" href="#cb321-1" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> ReplicationSlot</span>
<span id="cb321-2"><a aria-hidden="true" href="#cb321-2" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb321-3"><a aria-hidden="true" href="#cb321-3" tabindex="-1"></a>    <span class="co">/* lock, on same cacheline as effective_xmin */</span></span>
<span id="cb321-4"><a aria-hidden="true" href="#cb321-4" tabindex="-1"></a>    slock_t     mutex<span class="op">;</span></span>
<span id="cb321-5"><a aria-hidden="true" href="#cb321-5" tabindex="-1"></a></span>
<span id="cb321-6"><a aria-hidden="true" href="#cb321-6" tabindex="-1"></a>    <span class="co">/* is this slot defined */</span></span>
<span id="cb321-7"><a aria-hidden="true" href="#cb321-7" tabindex="-1"></a>    <span class="dt">bool</span>        in_use<span class="op">;</span></span>
<span id="cb321-8"><a aria-hidden="true" href="#cb321-8" tabindex="-1"></a></span>
<span id="cb321-9"><a aria-hidden="true" href="#cb321-9" tabindex="-1"></a>    <span class="co">/* Who is streaming out changes for this slot? */</span></span>
<span id="cb321-10"><a aria-hidden="true" href="#cb321-10" tabindex="-1"></a>    pid_t       active_pid<span class="op">;</span></span>
<span id="cb321-11"><a aria-hidden="true" href="#cb321-11" tabindex="-1"></a></span>
<span id="cb321-12"><a aria-hidden="true" href="#cb321-12" tabindex="-1"></a>    <span class="co">/* any outstanding modifications? */</span></span>
<span id="cb321-13"><a aria-hidden="true" href="#cb321-13" tabindex="-1"></a>    <span class="dt">bool</span>        just_dirtied<span class="op">;</span></span>
<span id="cb321-14"><a aria-hidden="true" href="#cb321-14" tabindex="-1"></a>    <span class="dt">bool</span>        dirty<span class="op">;</span></span>
<span id="cb321-15"><a aria-hidden="true" href="#cb321-15" tabindex="-1"></a></span>
<span id="cb321-16"><a aria-hidden="true" href="#cb321-16" tabindex="-1"></a>    <span class="co">/*</span></span>
<span id="cb321-17"><a aria-hidden="true" href="#cb321-17" tabindex="-1"></a><span class="co">     * For logical decoding, this represents the latest xmin that has</span></span>
<span id="cb321-18"><a aria-hidden="true" href="#cb321-18" tabindex="-1"></a><span class="co">     * actually been written to disk. For streaming replication, it's</span></span>
<span id="cb321-19"><a aria-hidden="true" href="#cb321-19" tabindex="-1"></a><span class="co">     * just the same as the persistent value.</span></span>
<span id="cb321-20"><a aria-hidden="true" href="#cb321-20" tabindex="-1"></a><span class="co">     */</span></span>
<span id="cb321-21"><a aria-hidden="true" href="#cb321-21" tabindex="-1"></a>    TransactionId effective_xmin<span class="op">;</span></span>
<span id="cb321-22"><a aria-hidden="true" href="#cb321-22" tabindex="-1"></a>    TransactionId effective_catalog_xmin<span class="op">;</span></span>
<span id="cb321-23"><a aria-hidden="true" href="#cb321-23" tabindex="-1"></a></span>
<span id="cb321-24"><a aria-hidden="true" href="#cb321-24" tabindex="-1"></a>    <span class="co">/* data surviving shutdowns and crashes */</span></span>
<span id="cb321-25"><a aria-hidden="true" href="#cb321-25" tabindex="-1"></a>    ReplicationSlotPersistentData data<span class="op">;</span></span>
<span id="cb321-26"><a aria-hidden="true" href="#cb321-26" tabindex="-1"></a></span>
<span id="cb321-27"><a aria-hidden="true" href="#cb321-27" tabindex="-1"></a>    <span class="co">/* is somebody performing io on this slot? */</span></span>
<span id="cb321-28"><a aria-hidden="true" href="#cb321-28" tabindex="-1"></a>    LWLock      io_in_progress_lock<span class="op">;</span></span>
<span id="cb321-29"><a aria-hidden="true" href="#cb321-29" tabindex="-1"></a></span>
<span id="cb321-30"><a aria-hidden="true" href="#cb321-30" tabindex="-1"></a>    <span class="co">/* Condition variable signaled when active_pid changes */</span></span>
<span id="cb321-31"><a aria-hidden="true" href="#cb321-31" tabindex="-1"></a>    ConditionVariable active_cv<span class="op">;</span></span>
<span id="cb321-32"><a aria-hidden="true" href="#cb321-32" tabindex="-1"></a></span>
<span id="cb321-33"><a aria-hidden="true" href="#cb321-33" tabindex="-1"></a>    <span class="co">/* Logical slot specific fields */</span></span>
<span id="cb321-34"><a aria-hidden="true" href="#cb321-34" tabindex="-1"></a>    TransactionId candidate_catalog_xmin<span class="op">;</span></span>
<span id="cb321-35"><a aria-hidden="true" href="#cb321-35" tabindex="-1"></a>    XLogRecPtr  candidate_xmin_lsn<span class="op">;</span></span>
<span id="cb321-36"><a aria-hidden="true" href="#cb321-36" tabindex="-1"></a>    XLogRecPtr  candidate_restart_valid<span class="op">;</span></span>
<span id="cb321-37"><a aria-hidden="true" href="#cb321-37" tabindex="-1"></a>    XLogRecPtr  candidate_restart_lsn<span class="op">;</span></span>
<span id="cb321-38"><a aria-hidden="true" href="#cb321-38" tabindex="-1"></a></span>
<span id="cb321-39"><a aria-hidden="true" href="#cb321-39" tabindex="-1"></a>    <span class="co">/* Last confirmed_flush LSN flushed to disk */</span></span>
<span id="cb321-40"><a aria-hidden="true" href="#cb321-40" tabindex="-1"></a>    XLogRecPtr  last_saved_confirmed_flush<span class="op">;</span></span>
<span id="cb321-41"><a aria-hidden="true" href="#cb321-41" tabindex="-1"></a></span>
<span id="cb321-42"><a aria-hidden="true" href="#cb321-42" tabindex="-1"></a>    <span class="co">/* Time when the slot became inactive */</span></span>
<span id="cb321-43"><a aria-hidden="true" href="#cb321-43" tabindex="-1"></a>    TimestampTz inactive_since<span class="op">;</span></span>
<span id="cb321-44"><a aria-hidden="true" href="#cb321-44" tabindex="-1"></a></span>
<span id="cb321-45"><a aria-hidden="true" href="#cb321-45" tabindex="-1"></a>    <span class="co">/* Latest restart_lsn that has been flushed to disk */</span></span>
<span id="cb321-46"><a aria-hidden="true" href="#cb321-46" tabindex="-1"></a>    XLogRecPtr  last_saved_restart_lsn<span class="op">;</span></span>
<span id="cb321-47"><a aria-hidden="true" href="#cb321-47" tabindex="-1"></a><span class="op">}</span> ReplicationSlot<span class="op">;</span></span></code></pre></div>
<h3 data-number="6.4.3" id="slot-invalidation"><span class="header-section-number">6.4.3</span> 3.3 Slot Invalidation</h3>
<p>Replication slots can be invalidated for several reasons to prevent
unbounded WAL accumulation:</p>
<p><strong>Invalidation Causes</strong>
(<code>src/include/replication/slot.h:58-69</code>):</p>
<div class="sourceCode" id="cb322"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb322-1"><a aria-hidden="true" href="#cb322-1" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">enum</span> ReplicationSlotInvalidationCause</span>
<span id="cb322-2"><a aria-hidden="true" href="#cb322-2" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb322-3"><a aria-hidden="true" href="#cb322-3" tabindex="-1"></a>    RS_INVAL_NONE <span class="op">=</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb322-4"><a aria-hidden="true" href="#cb322-4" tabindex="-1"></a>    <span class="co">/* required WAL has been removed */</span></span>
<span id="cb322-5"><a aria-hidden="true" href="#cb322-5" tabindex="-1"></a>    RS_INVAL_WAL_REMOVED <span class="op">=</span> <span class="op">(</span><span class="dv">1</span> <span class="op">&lt;&lt;</span> <span class="dv">0</span><span class="op">),</span></span>
<span id="cb322-6"><a aria-hidden="true" href="#cb322-6" tabindex="-1"></a>    <span class="co">/* required rows have been removed */</span></span>
<span id="cb322-7"><a aria-hidden="true" href="#cb322-7" tabindex="-1"></a>    RS_INVAL_HORIZON <span class="op">=</span> <span class="op">(</span><span class="dv">1</span> <span class="op">&lt;&lt;</span> <span class="dv">1</span><span class="op">),</span></span>
<span id="cb322-8"><a aria-hidden="true" href="#cb322-8" tabindex="-1"></a>    <span class="co">/* wal_level insufficient for slot */</span></span>
<span id="cb322-9"><a aria-hidden="true" href="#cb322-9" tabindex="-1"></a>    RS_INVAL_WAL_LEVEL <span class="op">=</span> <span class="op">(</span><span class="dv">1</span> <span class="op">&lt;&lt;</span> <span class="dv">2</span><span class="op">),</span></span>
<span id="cb322-10"><a aria-hidden="true" href="#cb322-10" tabindex="-1"></a>    <span class="co">/* idle slot timeout has occurred */</span></span>
<span id="cb322-11"><a aria-hidden="true" href="#cb322-11" tabindex="-1"></a>    RS_INVAL_IDLE_TIMEOUT <span class="op">=</span> <span class="op">(</span><span class="dv">1</span> <span class="op">&lt;&lt;</span> <span class="dv">3</span><span class="op">),</span></span>
<span id="cb322-12"><a aria-hidden="true" href="#cb322-12" tabindex="-1"></a><span class="op">}</span> ReplicationSlotInvalidationCause<span class="op">;</span></span></code></pre></div>
<p><strong>Protection Mechanisms</strong>:</p>
<ul>
<li><code>max_slot_wal_keep_size</code>: Limit WAL retention per
slot</li>
<li><code>wal_keep_size</code>: Global minimum WAL retention</li>
<li><code>idle_replication_slot_timeout</code>: Invalidate inactive
slots</li>
<li>Catalog xmin: Prevent vacuum from removing needed tuples</li>
</ul>
<hr/>
<h2 data-number="6.5" id="hot-standby-implementation"><span class="header-section-number">6.5</span> 4. Hot Standby
Implementation</h2>
<h3 data-number="6.5.1" id="hot-standby-architecture"><span class="header-section-number">6.5.1</span> 4.1 Hot Standby
Architecture</h3>
<p>Hot Standby enables read-only queries on standby servers during WAL
replay. This requires sophisticated conflict resolution between recovery
and active queries.</p>
<p><strong>Key Components</strong>:</p>
<ol type="1">
<li><strong>Startup Process</strong>: Replays WAL records</li>
<li><strong>Standby Snapshot Manager</strong>: Maintains consistent
snapshots for queries</li>
<li><strong>Conflict Resolution</strong>: Handles conflicts between
recovery and queries</li>
<li><strong>Feedback Mechanism</strong>: Informs primary about standby‚Äôs
snapshot requirements</li>
</ol>
<h3 data-number="6.5.2" id="wal-replay-during-hot-standby"><span class="header-section-number">6.5.2</span> 4.2 WAL Replay During Hot
Standby</h3>
<p>The startup process replays WAL while managing concurrent
queries:</p>
<p><strong>Recovery States</strong>
(<code>src/include/access/xlog.h:89-94</code>):</p>
<div class="sourceCode" id="cb323"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb323-1"><a aria-hidden="true" href="#cb323-1" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">enum</span> RecoveryState</span>
<span id="cb323-2"><a aria-hidden="true" href="#cb323-2" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb323-3"><a aria-hidden="true" href="#cb323-3" tabindex="-1"></a>    RECOVERY_STATE_CRASH <span class="op">=</span> <span class="dv">0</span><span class="op">,</span>   <span class="co">/* crash recovery */</span></span>
<span id="cb323-4"><a aria-hidden="true" href="#cb323-4" tabindex="-1"></a>    RECOVERY_STATE_ARCHIVE<span class="op">,</span>     <span class="co">/* archive recovery */</span></span>
<span id="cb323-5"><a aria-hidden="true" href="#cb323-5" tabindex="-1"></a>    RECOVERY_STATE_DONE<span class="op">,</span>        <span class="co">/* currently in production */</span></span>
<span id="cb323-6"><a aria-hidden="true" href="#cb323-6" tabindex="-1"></a><span class="op">}</span> RecoveryState<span class="op">;</span></span></code></pre></div>
<p><strong>Conflict Types</strong>:</p>
<ol type="1">
<li><strong>Snapshot Conflicts</strong>: Recovery removes tuples still
visible to standby queries</li>
<li><strong>Tablespace Conflicts</strong>: Recovery drops tablespace
with active connections</li>
<li><strong>Database Conflicts</strong>: Recovery drops database with
active connections</li>
<li><strong>Lock Conflicts</strong>: Recovery acquires locks conflicting
with query locks</li>
<li><strong>Buffer Pin Conflicts</strong>: Recovery needs to modify
pinned buffers</li>
<li><strong>Startup Deadlock</strong>: Recovery blocked by query holding
needed locks</li>
</ol>
<h3 data-number="6.5.3" id="hot-standby-feedback"><span class="header-section-number">6.5.3</span> 4.3 Hot Standby Feedback</h3>
<p>Standby servers can send feedback to the primary about their oldest
running transaction, preventing the primary from removing tuples still
needed by standby queries.</p>
<p><strong>Configuration</strong>:</p>
<div class="sourceCode" id="cb324"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb324-1"><a aria-hidden="true" href="#cb324-1" tabindex="-1"></a><span class="co">-- On standby</span></span>
<span id="cb324-2"><a aria-hidden="true" href="#cb324-2" tabindex="-1"></a>hot_standby_feedback <span class="op">=</span> <span class="kw">on</span></span></code></pre></div>
<p><strong>Mechanism</strong>: 1. Standby calculates its global xmin
from all active snapshots 2. WalReceiver sends xmin in status messages
to WalSender 3. Primary‚Äôs GetOldestActiveTransactionId() considers
standby xmin 4. Vacuum and HOT cleanup respect standby‚Äôs visibility
requirements</p>
<p><strong>Trade-offs</strong>: - <strong>Benefit</strong>: Prevents
query cancellations on standby - <strong>Cost</strong>: Primary bloat
increases to accommodate standby queries -
<strong>Recommendation</strong>: Use for critical read workloads,
monitor primary bloat</p>
<hr/>
<h2 data-number="6.6" id="point-in-time-recovery-pitr"><span class="header-section-number">6.6</span> 5. Point-In-Time Recovery
(PITR)</h2>
<h3 data-number="6.6.1" id="pitr-overview"><span class="header-section-number">6.6.1</span> 5.1 PITR Overview</h3>
<p>Point-In-Time Recovery allows restoring a database to any point in
its WAL history, enabling recovery from logical errors (dropped tables,
bad updates) rather than just hardware failures.</p>
<p><strong>Recovery Target Types</strong>
(<code>src/include/access/xlogrecovery.h:23-31</code>):</p>
<div class="sourceCode" id="cb325"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb325-1"><a aria-hidden="true" href="#cb325-1" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">enum</span></span>
<span id="cb325-2"><a aria-hidden="true" href="#cb325-2" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb325-3"><a aria-hidden="true" href="#cb325-3" tabindex="-1"></a>    RECOVERY_TARGET_UNSET<span class="op">,</span>      <span class="co">/* No specific target, recover to end of WAL */</span></span>
<span id="cb325-4"><a aria-hidden="true" href="#cb325-4" tabindex="-1"></a>    RECOVERY_TARGET_XID<span class="op">,</span>        <span class="co">/* Recover to specific transaction ID */</span></span>
<span id="cb325-5"><a aria-hidden="true" href="#cb325-5" tabindex="-1"></a>    RECOVERY_TARGET_TIME<span class="op">,</span>       <span class="co">/* Recover to specific timestamp */</span></span>
<span id="cb325-6"><a aria-hidden="true" href="#cb325-6" tabindex="-1"></a>    RECOVERY_TARGET_NAME<span class="op">,</span>       <span class="co">/* Recover to named restore point */</span></span>
<span id="cb325-7"><a aria-hidden="true" href="#cb325-7" tabindex="-1"></a>    RECOVERY_TARGET_LSN<span class="op">,</span>        <span class="co">/* Recover to specific LSN */</span></span>
<span id="cb325-8"><a aria-hidden="true" href="#cb325-8" tabindex="-1"></a>    RECOVERY_TARGET_IMMEDIATE<span class="op">,</span>  <span class="co">/* Stop at consistency point */</span></span>
<span id="cb325-9"><a aria-hidden="true" href="#cb325-9" tabindex="-1"></a><span class="op">}</span> RecoveryTargetType<span class="op">;</span></span></code></pre></div>
<p><strong>Recovery Target Actions</strong>
(<code>src/include/access/xlogrecovery.h:46-51</code>):</p>
<div class="sourceCode" id="cb326"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb326-1"><a aria-hidden="true" href="#cb326-1" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">enum</span></span>
<span id="cb326-2"><a aria-hidden="true" href="#cb326-2" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb326-3"><a aria-hidden="true" href="#cb326-3" tabindex="-1"></a>    RECOVERY_TARGET_ACTION_PAUSE<span class="op">,</span>       <span class="co">/* Pause at target */</span></span>
<span id="cb326-4"><a aria-hidden="true" href="#cb326-4" tabindex="-1"></a>    RECOVERY_TARGET_ACTION_PROMOTE<span class="op">,</span>     <span class="co">/* Promote to primary at target */</span></span>
<span id="cb326-5"><a aria-hidden="true" href="#cb326-5" tabindex="-1"></a>    RECOVERY_TARGET_ACTION_SHUTDOWN<span class="op">,</span>    <span class="co">/* Shutdown at target */</span></span>
<span id="cb326-6"><a aria-hidden="true" href="#cb326-6" tabindex="-1"></a><span class="op">}</span> RecoveryTargetAction<span class="op">;</span></span></code></pre></div>
<h3 data-number="6.6.2" id="pitr-configuration"><span class="header-section-number">6.6.2</span> 5.2 PITR Configuration</h3>
<p><strong>postgresql.conf settings</strong>:</p>
<div class="sourceCode" id="cb327"><pre class="sourceCode ini"><code class="sourceCode ini"><span id="cb327-1"><a aria-hidden="true" href="#cb327-1" tabindex="-1"></a><span class="co"># Recovery target</span></span>
<span id="cb327-2"><a aria-hidden="true" href="#cb327-2" tabindex="-1"></a><span class="dt">recovery_target </span><span class="ot">=</span><span class="st"> 'immediate'                    # Or unset for full recovery</span></span>
<span id="cb327-3"><a aria-hidden="true" href="#cb327-3" tabindex="-1"></a><span class="dt">recovery_target_time </span><span class="ot">=</span><span class="st"> '2025-01-15 14:30:00'    # Timestamp target</span></span>
<span id="cb327-4"><a aria-hidden="true" href="#cb327-4" tabindex="-1"></a><span class="dt">recovery_target_xid </span><span class="ot">=</span><span class="st"> '12345678'                 # Transaction ID target</span></span>
<span id="cb327-5"><a aria-hidden="true" href="#cb327-5" tabindex="-1"></a><span class="dt">recovery_target_lsn </span><span class="ot">=</span><span class="st"> '0/3000000'               # LSN target</span></span>
<span id="cb327-6"><a aria-hidden="true" href="#cb327-6" tabindex="-1"></a><span class="dt">recovery_target_name </span><span class="ot">=</span><span class="st"> 'before_bad_update'       # Named restore point</span></span>
<span id="cb327-7"><a aria-hidden="true" href="#cb327-7" tabindex="-1"></a><span class="dt">recovery_target_inclusive </span><span class="ot">=</span><span class="st"> true                 # Include target transaction?</span></span>
<span id="cb327-8"><a aria-hidden="true" href="#cb327-8" tabindex="-1"></a></span>
<span id="cb327-9"><a aria-hidden="true" href="#cb327-9" tabindex="-1"></a><span class="co"># Recovery behavior</span></span>
<span id="cb327-10"><a aria-hidden="true" href="#cb327-10" tabindex="-1"></a><span class="dt">recovery_target_action </span><span class="ot">=</span><span class="st"> 'promote'              # pause | promote | shutdown</span></span>
<span id="cb327-11"><a aria-hidden="true" href="#cb327-11" tabindex="-1"></a><span class="dt">recovery_target_timeline </span><span class="ot">=</span><span class="st"> 'latest'             # Timeline to recover</span></span>
<span id="cb327-12"><a aria-hidden="true" href="#cb327-12" tabindex="-1"></a></span>
<span id="cb327-13"><a aria-hidden="true" href="#cb327-13" tabindex="-1"></a><span class="co"># WAL archive access</span></span>
<span id="cb327-14"><a aria-hidden="true" href="#cb327-14" tabindex="-1"></a><span class="dt">restore_command </span><span class="ot">=</span><span class="st"> 'cp /archive/%f %p'           # Command to fetch archived WAL</span></span>
<span id="cb327-15"><a aria-hidden="true" href="#cb327-15" tabindex="-1"></a><span class="dt">recovery_end_command </span><span class="ot">=</span><span class="st"> '/usr/local/bin/cleanup' # Run after recovery completes</span></span></code></pre></div>
<h3 data-number="6.6.3" id="creating-restore-points"><span class="header-section-number">6.6.3</span> 5.3 Creating Restore
Points</h3>
<p>Applications can create named restore points for predictable recovery
targets:</p>
<div class="sourceCode" id="cb328"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb328-1"><a aria-hidden="true" href="#cb328-1" tabindex="-1"></a><span class="co">-- Create a named restore point</span></span>
<span id="cb328-2"><a aria-hidden="true" href="#cb328-2" tabindex="-1"></a><span class="kw">SELECT</span> pg_create_restore_point(<span class="st">'before_schema_migration'</span>);</span>
<span id="cb328-3"><a aria-hidden="true" href="#cb328-3" tabindex="-1"></a></span>
<span id="cb328-4"><a aria-hidden="true" href="#cb328-4" tabindex="-1"></a><span class="co">-- In recovery, specify:</span></span>
<span id="cb328-5"><a aria-hidden="true" href="#cb328-5" tabindex="-1"></a><span class="co">-- recovery_target_name = 'before_schema_migration'</span></span></code></pre></div>
<h3 data-number="6.6.4" id="timeline-management"><span class="header-section-number">6.6.4</span> 5.4 Timeline Management</h3>
<p>Every PITR recovery creates a new timeline, preventing accidental
replay of WAL from the original timeline:</p>
<p><strong>Timeline Workflow</strong>:</p>
<ol type="1">
<li><strong>Initial Timeline</strong>: Database starts on timeline
1</li>
<li><strong>PITR Recovery</strong>: Recovery to specific point creates
timeline 2</li>
<li><strong>History File</strong>: <code>00000002.history</code> records
timeline branching</li>
<li><strong>New WAL</strong>: Post-recovery WAL written to timeline 2
files</li>
<li><strong>Cascade Recovery</strong>: Can recover from timeline 2 to
create timeline 3</li>
</ol>
<p><strong>Timeline History File Format</strong>:</p>
<pre><code># Timeline history file for timeline 2
# Created by recovery ending at 2025-01-15 14:30:00
1       0/3000000       "Recovery from transaction ID 12345678"</code></pre>
<hr/>
<h2 data-number="6.7" id="crash-recovery-and-checkpoints"><span class="header-section-number">6.7</span> 6. Crash Recovery and
Checkpoints</h2>
<h3 data-number="6.7.1" id="crash-recovery-mechanism"><span class="header-section-number">6.7.1</span> 6.1 Crash Recovery
Mechanism</h3>
<p>Crash recovery restores database consistency after an unexpected
shutdown by replaying WAL from the last checkpoint to the end of
WAL.</p>
<p><strong>Recovery Workflow</strong>:</p>
<ol type="1">
<li><strong>Locate Checkpoint</strong>: Read <code>pg_control</code> to
find last checkpoint location</li>
<li><strong>Read Checkpoint Record</strong>: Parse checkpoint record
from WAL</li>
<li><strong>Determine Redo Point</strong>: Set recovery starting point
(checkpoint‚Äôs redo LSN)</li>
<li><strong>Replay WAL</strong>: Apply all WAL records from redo point
to end of valid WAL</li>
<li><strong>Consistency Point</strong>: Mark database consistent when
sufficient WAL replayed</li>
<li><strong>End Recovery</strong>: Create new checkpoint and transition
to normal operation</li>
</ol>
<p><strong>StartupXLOG Entry Point</strong>
(<code>src/backend/access/transam/xlogrecovery.c</code>):</p>
<p>The startup process‚Äôs main function coordinates the entire recovery
sequence, handling checkpoint location, WAL reading, record application,
and transition to normal operation.</p>
<h3 data-number="6.7.2" id="checkpoint-algorithm"><span class="header-section-number">6.7.2</span> 6.2 Checkpoint Algorithm</h3>
<p>Checkpoints are the foundation of crash recovery, establishing
consistent on-disk states that limit WAL replay requirements.</p>
<p><strong>CreateCheckPoint Function</strong>
(<code>src/backend/access/transam/xlog.c:6961</code>):</p>
<p>The checkpoint algorithm proceeds in seven distinct phases:</p>
<p><strong>Phase 1: Preparation</strong></p>
<pre><code>1. Determine if shutdown checkpoint (CHECKPOINT_IS_SHUTDOWN flag)
2. Validate not in recovery (except for CHECKPOINT_END_OF_RECOVERY)
3. Initialize checkpoint statistics structure
4. Call SyncPreCheckpoint() for storage manager preparation</code></pre>
<p><strong>Phase 2: Determine REDO Point</strong></p>
<pre><code>5. Enter critical section
6. If shutdown checkpoint:
   - Wait for all transactions to complete
   - Set redo point to current insert position
7. If online checkpoint:
   - Set redo point to last checkpoint's redo point or earlier
8. Collect list of virtual transaction IDs for waiting</code></pre>
<p><strong>Phase 3: Update Shared Memory</strong></p>
<pre><code>9. Update checkpoint record in memory:
   - redo: LSN to start recovery from
   - ThisTimeLineID: Current timeline
   - PrevTimeLineID: Previous timeline
   - fullPageWrites: Whether full page writes are enabled
   - nextXid: Next transaction ID to assign
   - nextOid: Next OID to assign
   - nextMulti: Next MultiXactId
   - oldestXid: Oldest transaction ID still visible
   - oldestActiveXid: Oldest transaction ID still running</code></pre>
<p><strong>Phase 4: Write Checkpoint Record</strong></p>
<pre><code>10. Construct checkpoint WAL record
11. XLogInsert() writes checkpoint record to WAL
12. Update pg_control with checkpoint location
13. XLogFlush() ensures checkpoint record is durable</code></pre>
<p><strong>Phase 5: Buffer and SLRU Checkpoint</strong></p>
<pre><code>14. Exit critical section
15. CheckPointGuts() flushes:
    - All dirty shared buffers to disk
    - CLOG (transaction status) buffers
    - SUBTRANS (subtransaction) buffers
    - MultiXact buffers
    - Other SLRU structures
16. Record buffer statistics (buffers written)</code></pre>
<p><strong>Phase 6: Sync All Files</strong></p>
<pre><code>17. CheckPointTwoPhase() - flush two-phase state files
18. CheckPointReplicationSlots() - save replication slot state
19. CheckPointSnapBuild() - save snapshot builder state
20. CheckPointLogicalRewriteHeap() - sync logical rewrite state
21. SyncPostCheckpoint() - fsync all pending file operations</code></pre>
<p><strong>Phase 7: Cleanup and Statistics</strong></p>
<pre><code>22. Remove old WAL files (RemoveOldXlogFiles):
    - Keep WAL required by replication slots
    - Keep WAL required by max_wal_size
    - Keep WAL required by wal_keep_size
23. Recycle WAL segments for future use
24. Update checkpoint statistics:
    - Checkpoint completion time
    - Number of buffers written
    - Number of segments added/removed/recycled
25. Log checkpoint completion if log_checkpoints=on</code></pre>
<p><strong>Checkpoint Statistics</strong>
(<code>src/include/access/xlog.h:160-181</code>):</p>
<div class="sourceCode" id="cb337"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb337-1"><a aria-hidden="true" href="#cb337-1" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> CheckpointStatsData</span>
<span id="cb337-2"><a aria-hidden="true" href="#cb337-2" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb337-3"><a aria-hidden="true" href="#cb337-3" tabindex="-1"></a>    TimestampTz ckpt_start_t<span class="op">;</span>       <span class="co">/* start of checkpoint */</span></span>
<span id="cb337-4"><a aria-hidden="true" href="#cb337-4" tabindex="-1"></a>    TimestampTz ckpt_write_t<span class="op">;</span>       <span class="co">/* start of flushing buffers */</span></span>
<span id="cb337-5"><a aria-hidden="true" href="#cb337-5" tabindex="-1"></a>    TimestampTz ckpt_sync_t<span class="op">;</span>        <span class="co">/* start of fsyncs */</span></span>
<span id="cb337-6"><a aria-hidden="true" href="#cb337-6" tabindex="-1"></a>    TimestampTz ckpt_sync_end_t<span class="op">;</span>    <span class="co">/* end of fsyncs */</span></span>
<span id="cb337-7"><a aria-hidden="true" href="#cb337-7" tabindex="-1"></a>    TimestampTz ckpt_end_t<span class="op">;</span>         <span class="co">/* end of checkpoint */</span></span>
<span id="cb337-8"><a aria-hidden="true" href="#cb337-8" tabindex="-1"></a></span>
<span id="cb337-9"><a aria-hidden="true" href="#cb337-9" tabindex="-1"></a>    <span class="dt">int</span>         ckpt_bufs_written<span class="op">;</span>  <span class="co">/* # of buffers written */</span></span>
<span id="cb337-10"><a aria-hidden="true" href="#cb337-10" tabindex="-1"></a>    <span class="dt">int</span>         ckpt_slru_written<span class="op">;</span>  <span class="co">/* # of SLRU buffers written */</span></span>
<span id="cb337-11"><a aria-hidden="true" href="#cb337-11" tabindex="-1"></a></span>
<span id="cb337-12"><a aria-hidden="true" href="#cb337-12" tabindex="-1"></a>    <span class="dt">int</span>         ckpt_segs_added<span class="op">;</span>    <span class="co">/* # of new xlog segments created */</span></span>
<span id="cb337-13"><a aria-hidden="true" href="#cb337-13" tabindex="-1"></a>    <span class="dt">int</span>         ckpt_segs_removed<span class="op">;</span>  <span class="co">/* # of xlog segments deleted */</span></span>
<span id="cb337-14"><a aria-hidden="true" href="#cb337-14" tabindex="-1"></a>    <span class="dt">int</span>         ckpt_segs_recycled<span class="op">;</span> <span class="co">/* # of xlog segments recycled */</span></span>
<span id="cb337-15"><a aria-hidden="true" href="#cb337-15" tabindex="-1"></a></span>
<span id="cb337-16"><a aria-hidden="true" href="#cb337-16" tabindex="-1"></a>    <span class="dt">int</span>         ckpt_sync_rels<span class="op">;</span>     <span class="co">/* # of relations synced */</span></span>
<span id="cb337-17"><a aria-hidden="true" href="#cb337-17" tabindex="-1"></a>    uint64      ckpt_longest_sync<span class="op">;</span>  <span class="co">/* Longest sync for one relation */</span></span>
<span id="cb337-18"><a aria-hidden="true" href="#cb337-18" tabindex="-1"></a>    uint64      ckpt_agg_sync_time<span class="op">;</span> <span class="co">/* Sum of all individual sync times */</span></span>
<span id="cb337-19"><a aria-hidden="true" href="#cb337-19" tabindex="-1"></a><span class="op">}</span> CheckpointStatsData<span class="op">;</span></span></code></pre></div>
<h3 data-number="6.7.3" id="checkpoint-scheduling"><span class="header-section-number">6.7.3</span> 6.3 Checkpoint
Scheduling</h3>
<p>PostgreSQL uses multiple strategies to trigger checkpoints:</p>
<p><strong>Checkpoint Triggers</strong>:</p>
<ol type="1">
<li><strong>Time-Based</strong>: <code>checkpoint_timeout</code>
(default: 5 minutes)</li>
<li><strong>WAL-Based</strong>: <code>max_wal_size</code> exceeded
(default: 1GB)</li>
<li><strong>Explicit</strong>: <code>CHECKPOINT</code> SQL command</li>
<li><strong>Shutdown</strong>: Server shutdown or restart</li>
<li><strong>Archive</strong>: Before switching to new WAL segment if
archiving</li>
</ol>
<p><strong>Checkpoint Request Flags</strong>
(<code>src/include/access/xlog.h:139-150</code>):</p>
<div class="sourceCode" id="cb338"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb338-1"><a aria-hidden="true" href="#cb338-1" tabindex="-1"></a><span class="co">/* These directly affect the behavior of CreateCheckPoint */</span></span>
<span id="cb338-2"><a aria-hidden="true" href="#cb338-2" tabindex="-1"></a><span class="pp">#define CHECKPOINT_IS_SHUTDOWN      </span><span class="bn">0x0001</span><span class="pp">  </span><span class="co">/* Checkpoint is for shutdown */</span></span>
<span id="cb338-3"><a aria-hidden="true" href="#cb338-3" tabindex="-1"></a><span class="pp">#define CHECKPOINT_END_OF_RECOVERY  </span><span class="bn">0x0002</span><span class="pp">  </span><span class="co">/* End of WAL recovery */</span></span>
<span id="cb338-4"><a aria-hidden="true" href="#cb338-4" tabindex="-1"></a><span class="pp">#define CHECKPOINT_FAST             </span><span class="bn">0x0004</span><span class="pp">  </span><span class="co">/* Do it without delays */</span></span>
<span id="cb338-5"><a aria-hidden="true" href="#cb338-5" tabindex="-1"></a><span class="pp">#define CHECKPOINT_FORCE            </span><span class="bn">0x0008</span><span class="pp">  </span><span class="co">/* Force even if no activity */</span></span>
<span id="cb338-6"><a aria-hidden="true" href="#cb338-6" tabindex="-1"></a><span class="pp">#define CHECKPOINT_FLUSH_UNLOGGED   </span><span class="bn">0x0010</span><span class="pp">  </span><span class="co">/* Flush unlogged tables */</span></span>
<span id="cb338-7"><a aria-hidden="true" href="#cb338-7" tabindex="-1"></a></span>
<span id="cb338-8"><a aria-hidden="true" href="#cb338-8" tabindex="-1"></a><span class="co">/* These are important to RequestCheckpoint */</span></span>
<span id="cb338-9"><a aria-hidden="true" href="#cb338-9" tabindex="-1"></a><span class="pp">#define CHECKPOINT_WAIT             </span><span class="bn">0x0020</span><span class="pp">  </span><span class="co">/* Wait for completion */</span></span>
<span id="cb338-10"><a aria-hidden="true" href="#cb338-10" tabindex="-1"></a><span class="pp">#define CHECKPOINT_REQUESTED        </span><span class="bn">0x0040</span><span class="pp">  </span><span class="co">/* Checkpoint request made */</span></span>
<span id="cb338-11"><a aria-hidden="true" href="#cb338-11" tabindex="-1"></a></span>
<span id="cb338-12"><a aria-hidden="true" href="#cb338-12" tabindex="-1"></a><span class="co">/* These indicate the cause of a checkpoint request */</span></span>
<span id="cb338-13"><a aria-hidden="true" href="#cb338-13" tabindex="-1"></a><span class="pp">#define CHECKPOINT_CAUSE_XLOG       </span><span class="bn">0x0080</span><span class="pp">  </span><span class="co">/* XLOG consumption */</span></span>
<span id="cb338-14"><a aria-hidden="true" href="#cb338-14" tabindex="-1"></a><span class="pp">#define CHECKPOINT_CAUSE_TIME       </span><span class="bn">0x0100</span><span class="pp">  </span><span class="co">/* Elapsed time */</span></span></code></pre></div>
<h3 data-number="6.7.4" id="checkpoint-tuning"><span class="header-section-number">6.7.4</span> 6.4 Checkpoint Tuning</h3>
<p>Optimal checkpoint configuration balances recovery time against I/O
impact:</p>
<p><strong>Key Parameters</strong>:</p>
<div class="sourceCode" id="cb339"><pre class="sourceCode ini"><code class="sourceCode ini"><span id="cb339-1"><a aria-hidden="true" href="#cb339-1" tabindex="-1"></a><span class="co"># Checkpoint frequency</span></span>
<span id="cb339-2"><a aria-hidden="true" href="#cb339-2" tabindex="-1"></a><span class="dt">checkpoint_timeout </span><span class="ot">=</span><span class="st"> 15min          # Time-based checkpoint interval</span></span>
<span id="cb339-3"><a aria-hidden="true" href="#cb339-3" tabindex="-1"></a><span class="dt">max_wal_size </span><span class="ot">=</span><span class="st"> 4GB                  # WAL size trigger (soft limit)</span></span>
<span id="cb339-4"><a aria-hidden="true" href="#cb339-4" tabindex="-1"></a><span class="dt">min_wal_size </span><span class="ot">=</span><span class="st"> 1GB                  # Minimum WAL to keep</span></span>
<span id="cb339-5"><a aria-hidden="true" href="#cb339-5" tabindex="-1"></a></span>
<span id="cb339-6"><a aria-hidden="true" href="#cb339-6" tabindex="-1"></a><span class="co"># Checkpoint spreading</span></span>
<span id="cb339-7"><a aria-hidden="true" href="#cb339-7" tabindex="-1"></a><span class="dt">checkpoint_completion_target </span><span class="ot">=</span><span class="st"> 0.9  # Spread checkpoint over 90% of interval</span></span>
<span id="cb339-8"><a aria-hidden="true" href="#cb339-8" tabindex="-1"></a></span>
<span id="cb339-9"><a aria-hidden="true" href="#cb339-9" tabindex="-1"></a><span class="co"># WAL segment management</span></span>
<span id="cb339-10"><a aria-hidden="true" href="#cb339-10" tabindex="-1"></a><span class="dt">wal_keep_size </span><span class="ot">=</span><span class="st"> 1GB                 # WAL to keep for replication</span></span>
<span id="cb339-11"><a aria-hidden="true" href="#cb339-11" tabindex="-1"></a><span class="dt">max_slot_wal_keep_size </span><span class="ot">=</span><span class="st"> 10GB       # Per-slot WAL limit</span></span>
<span id="cb339-12"><a aria-hidden="true" href="#cb339-12" tabindex="-1"></a></span>
<span id="cb339-13"><a aria-hidden="true" href="#cb339-13" tabindex="-1"></a><span class="co"># Logging</span></span>
<span id="cb339-14"><a aria-hidden="true" href="#cb339-14" tabindex="-1"></a><span class="dt">log_checkpoints </span><span class="ot">=</span><span class="st"> on                # Log checkpoint statistics</span></span></code></pre></div>
<p><strong>Tuning Strategy</strong>:</p>
<ol type="1">
<li><strong>For Fast Recovery</strong>: Shorter
<code>checkpoint_timeout</code>, smaller <code>max_wal_size</code>
<ul>
<li>Reduces WAL replay time</li>
<li>Increases checkpoint overhead</li>
</ul></li>
<li><strong>For Performance</strong>: Longer
<code>checkpoint_timeout</code>, larger <code>max_wal_size</code>
<ul>
<li>Reduces checkpoint I/O impact</li>
<li>Increases recovery time</li>
</ul></li>
<li><strong>For Smooth I/O</strong>:
<code>checkpoint_completion_target</code> near 0.9
<ul>
<li>Spreads checkpoint writes over time</li>
<li>Reduces I/O spikes</li>
</ul></li>
</ol>
<p><strong>Monitoring</strong>:</p>
<div class="sourceCode" id="cb340"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb340-1"><a aria-hidden="true" href="#cb340-1" tabindex="-1"></a><span class="co">-- Check checkpoint statistics</span></span>
<span id="cb340-2"><a aria-hidden="true" href="#cb340-2" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> pg_stat_bgwriter;</span>
<span id="cb340-3"><a aria-hidden="true" href="#cb340-3" tabindex="-1"></a></span>
<span id="cb340-4"><a aria-hidden="true" href="#cb340-4" tabindex="-1"></a><span class="co">-- Monitor checkpoint timing</span></span>
<span id="cb340-5"><a aria-hidden="true" href="#cb340-5" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb340-6"><a aria-hidden="true" href="#cb340-6" tabindex="-1"></a>    checkpoint_lsn,</span>
<span id="cb340-7"><a aria-hidden="true" href="#cb340-7" tabindex="-1"></a>    redo_lsn,</span>
<span id="cb340-8"><a aria-hidden="true" href="#cb340-8" tabindex="-1"></a>    checkpoint_time,</span>
<span id="cb340-9"><a aria-hidden="true" href="#cb340-9" tabindex="-1"></a>    redo_wal_file</span>
<span id="cb340-10"><a aria-hidden="true" href="#cb340-10" tabindex="-1"></a><span class="kw">FROM</span> pg_control_checkpoint();</span>
<span id="cb340-11"><a aria-hidden="true" href="#cb340-11" tabindex="-1"></a></span>
<span id="cb340-12"><a aria-hidden="true" href="#cb340-12" tabindex="-1"></a><span class="co">-- View current WAL position</span></span>
<span id="cb340-13"><a aria-hidden="true" href="#cb340-13" tabindex="-1"></a><span class="kw">SELECT</span> pg_current_wal_lsn();</span>
<span id="cb340-14"><a aria-hidden="true" href="#cb340-14" tabindex="-1"></a></span>
<span id="cb340-15"><a aria-hidden="true" href="#cb340-15" tabindex="-1"></a><span class="co">-- Calculate WAL generation rate</span></span>
<span id="cb340-16"><a aria-hidden="true" href="#cb340-16" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb340-17"><a aria-hidden="true" href="#cb340-17" tabindex="-1"></a>    (pg_wal_lsn_diff(pg_current_wal_lsn(), <span class="st">'0/0'</span>) <span class="op">/</span></span>
<span id="cb340-18"><a aria-hidden="true" href="#cb340-18" tabindex="-1"></a>     <span class="fu">EXTRACT</span>(EPOCH <span class="kw">FROM</span> (now() <span class="op">-</span> pg_postmaster_start_time()))) <span class="op">/</span> <span class="dv">1024</span> <span class="op">/</span> <span class="dv">1024</span></span>
<span id="cb340-19"><a aria-hidden="true" href="#cb340-19" tabindex="-1"></a>    <span class="kw">AS</span> mb_per_second;</span></code></pre></div>
<hr/>
<h2 data-number="6.8" id="pg_basebackup-integration"><span class="header-section-number">6.8</span> 7. pg_basebackup
Integration</h2>
<h3 data-number="6.8.1" id="pg_basebackup-overview"><span class="header-section-number">6.8.1</span> 7.1 pg_basebackup
Overview</h3>
<p><code>pg_basebackup</code> is PostgreSQL‚Äôs built-in tool for creating
base backups of running clusters. It integrates deeply with the
replication infrastructure to produce consistent backups without
blocking normal operations.</p>
<p><strong>Location</strong>:
<code>/home/user/postgres/src/bin/pg_basebackup/</code></p>
<p><strong>Key Features</strong>: - Non-blocking online backup -
Streaming or archive-based WAL inclusion - Progress reporting -
Compression support (gzip, lz4, zstd) - Verification capabilities -
Direct tar or plain format output</p>
<h3 data-number="6.8.2" id="backup-protocol"><span class="header-section-number">6.8.2</span> 7.2 Backup Protocol</h3>
<p><code>pg_basebackup</code> uses the replication protocol with
backup-specific commands:</p>
<p><strong>Backup Workflow</strong>:</p>
<ol type="1">
<li><strong>Connection</strong>: Connect to primary with
<code>replication=database</code> or <code>replication=true</code></li>
<li><strong>Slot Creation</strong> (optional): Create temporary or
permanent replication slot</li>
<li><strong>Backup Start</strong>: Issue <code>BASE_BACKUP</code>
replication command</li>
<li><strong>Label Recording</strong>: Server creates
<code>backup_label</code> with start position</li>
<li><strong>File Transfer</strong>: Receive base directory contents via
COPY protocol</li>
<li><strong>Tablespace Transfer</strong>: Receive each tablespace
separately</li>
<li><strong>WAL Streaming</strong>: Concurrently stream WAL to ensure
consistency</li>
<li><strong>Backup End</strong>: Receive <code>backup_label</code> and
tablespace map</li>
<li><strong>Slot Cleanup</strong>: Drop temporary slot if used</li>
</ol>
<p><strong>BASE_BACKUP Command Syntax</strong>:</p>
<pre><code>BASE_BACKUP [ LABEL 'label' ]
            [ PROGRESS ]
            [ FAST ]
            [ WAL ]
            [ NOWAIT ]
            [ MAX_RATE rate ]
            [ TABLESPACE_MAP ]
            [ VERIFY_CHECKSUMS ]</code></pre>
<h3 data-number="6.8.3" id="wal-streaming-during-backup"><span class="header-section-number">6.8.3</span> 7.3 WAL Streaming During
Backup</h3>
<p>To ensure backup consistency, all WAL generated during the backup
must be captured:</p>
<p><strong>Method 1: Integrated WAL Streaming</strong> (default with
<code>-X stream</code>): - Spawns parallel connection to stream WAL -
Stores WAL in backup‚Äôs <code>pg_wal</code> directory - Backup is
self-contained and immediately usable</p>
<p><strong>Method 2: Fetch After Backup</strong> (with
<code>-X fetch</code>): - Waits for WAL archiving after backup completes
- Retrieves archived WAL segments - Requires functional WAL
archiving</p>
<p><strong>Method 3: Manual WAL Management</strong> (with
<code>-X none</code>): - Relies on separate WAL archiving - Restore
requires <code>restore_command</code> configuration - Smallest backup
size (no WAL included)</p>
<h3 data-number="6.8.4" id="backup-label-and-tablespace-map"><span class="header-section-number">6.8.4</span> 7.4 Backup Label and
Tablespace Map</h3>
<p><strong>backup_label File</strong>:</p>
<pre><code>START WAL LOCATION: 0/3000028 (file 000000010000000000000003)
CHECKPOINT LOCATION: 0/3000060
BACKUP METHOD: streamed
BACKUP FROM: primary
START TIME: 2025-01-15 14:30:00 UTC
LABEL: Weekly backup
START TIMELINE: 1</code></pre>
<p>The <code>backup_label</code> file is critical for recovery - it
tells the startup process: - Where to begin WAL replay (START WAL
LOCATION) - Not to use normal checkpoint-based recovery - What backup
method was used</p>
<p><strong>tablespace_map File</strong>:</p>
<pre><code>16384 /var/lib/pgsql/tablespaces/fast_ssd
16385 /var/lib/pgsql/tablespaces/archive_disk</code></pre>
<p>Maps tablespace OIDs to their locations, enabling restore to
different paths.</p>
<h3 data-number="6.8.5" id="replication-slot-integration"><span class="header-section-number">6.8.5</span> 7.5 Replication Slot
Integration</h3>
<p>Using replication slots with pg_basebackup prevents WAL removal
during long backups:</p>
<div class="sourceCode" id="cb344"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb344-1"><a aria-hidden="true" href="#cb344-1" tabindex="-1"></a><span class="co"># Create backup with permanent slot</span></span>
<span id="cb344-2"><a aria-hidden="true" href="#cb344-2" tabindex="-1"></a><span class="ex">pg_basebackup</span> <span class="at">-D</span> /backup <span class="at">-X</span> stream <span class="at">-S</span> backup_slot <span class="at">-C</span></span>
<span id="cb344-3"><a aria-hidden="true" href="#cb344-3" tabindex="-1"></a></span>
<span id="cb344-4"><a aria-hidden="true" href="#cb344-4" tabindex="-1"></a><span class="co"># Use existing slot</span></span>
<span id="cb344-5"><a aria-hidden="true" href="#cb344-5" tabindex="-1"></a><span class="ex">pg_basebackup</span> <span class="at">-D</span> /backup <span class="at">-X</span> stream <span class="at">-S</span> existing_slot</span>
<span id="cb344-6"><a aria-hidden="true" href="#cb344-6" tabindex="-1"></a></span>
<span id="cb344-7"><a aria-hidden="true" href="#cb344-7" tabindex="-1"></a><span class="co"># Create temporary slot (auto-dropped after backup)</span></span>
<span id="cb344-8"><a aria-hidden="true" href="#cb344-8" tabindex="-1"></a><span class="ex">pg_basebackup</span> <span class="at">-D</span> /backup <span class="at">-X</span> stream <span class="at">-C</span> <span class="at">--slot</span> temp_backup_slot</span></code></pre></div>
<p><strong>Benefits</strong>: - Guarantees WAL availability during
backup - Essential for slow backups or network interruptions - Enables
backup verification without time pressure</p>
<p><strong>Risks</strong>: - Unused slots prevent WAL recycling - Can
cause disk space exhaustion on primary - Must monitor and drop abandoned
slots</p>
<h3 data-number="6.8.6" id="backup-verification"><span class="header-section-number">6.8.6</span> 7.6 Backup Verification</h3>
<p>PostgreSQL 13+ includes backup manifest verification:</p>
<div class="sourceCode" id="cb345"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb345-1"><a aria-hidden="true" href="#cb345-1" tabindex="-1"></a><span class="co"># Create backup with manifest</span></span>
<span id="cb345-2"><a aria-hidden="true" href="#cb345-2" tabindex="-1"></a><span class="ex">pg_basebackup</span> <span class="at">-D</span> /backup <span class="at">--manifest-checksums</span><span class="op">=</span>SHA256</span>
<span id="cb345-3"><a aria-hidden="true" href="#cb345-3" tabindex="-1"></a></span>
<span id="cb345-4"><a aria-hidden="true" href="#cb345-4" tabindex="-1"></a><span class="co"># Verify backup integrity</span></span>
<span id="cb345-5"><a aria-hidden="true" href="#cb345-5" tabindex="-1"></a><span class="ex">pg_verifybackup</span> /backup</span></code></pre></div>
<p><strong>Manifest Contents</strong>: - File list with sizes and
modification times - Checksums (CRC32C, SHA224, SHA256, SHA384, SHA512)
- WAL range required for recovery - Backup timeline</p>
<hr/>
<h2 data-number="6.9" id="advanced-replication-topics"><span class="header-section-number">6.9</span> 8. Advanced Replication
Topics</h2>
<h3 data-number="6.9.1" id="synchronous-replication"><span class="header-section-number">6.9.1</span> 8.1 Synchronous
Replication</h3>
<p>Synchronous replication provides zero data loss by waiting for
standby confirmation before commit:</p>
<p><strong>Configuration</strong>:</p>
<div class="sourceCode" id="cb346"><pre class="sourceCode ini"><code class="sourceCode ini"><span id="cb346-1"><a aria-hidden="true" href="#cb346-1" tabindex="-1"></a><span class="co"># On primary</span></span>
<span id="cb346-2"><a aria-hidden="true" href="#cb346-2" tabindex="-1"></a><span class="dt">synchronous_standby_names </span><span class="ot">=</span><span class="st"> 'FIRST 2 (standby1, standby2, standby3)'</span></span>
<span id="cb346-3"><a aria-hidden="true" href="#cb346-3" tabindex="-1"></a><span class="dt">synchronous_commit </span><span class="ot">=</span><span class="st"> on  # Per session or globally</span></span></code></pre></div>
<p><strong>Synchronous Commit Levels</strong>: - <code>off</code>: No
wait for WAL write (fastest, data loss risk) - <code>local</code>: Wait
for local WAL flush only - <code>remote_write</code>: Wait for standby
WAL write (not flush) - <code>remote_apply</code>: Wait for standby WAL
application (no read lag) - <code>on</code>: Wait for standby WAL flush
(default synchronous)</p>
<p><strong>Quorum Commit</strong>:</p>
<div class="sourceCode" id="cb347"><pre class="sourceCode ini"><code class="sourceCode ini"><span id="cb347-1"><a aria-hidden="true" href="#cb347-1" tabindex="-1"></a><span class="co"># Wait for ANY 2 of 4 standbys</span></span>
<span id="cb347-2"><a aria-hidden="true" href="#cb347-2" tabindex="-1"></a><span class="dt">synchronous_standby_names </span><span class="ot">=</span><span class="st"> 'ANY 2 (s1, s2, s3, s4)'</span></span>
<span id="cb347-3"><a aria-hidden="true" href="#cb347-3" tabindex="-1"></a></span>
<span id="cb347-4"><a aria-hidden="true" href="#cb347-4" tabindex="-1"></a><span class="co"># Wait for FIRST 1 (prioritized)</span></span>
<span id="cb347-5"><a aria-hidden="true" href="#cb347-5" tabindex="-1"></a><span class="dt">synchronous_standby_names </span><span class="ot">=</span><span class="st"> 'FIRST 1 (s1, s2, s3)'</span></span></code></pre></div>
<h3 data-number="6.9.2" id="cascading-replication"><span class="header-section-number">6.9.2</span> 8.2 Cascading
Replication</h3>
<p>Standbys can serve as primary for downstream standbys, creating
replication hierarchies:</p>
<p><strong>Architecture</strong>:</p>
<pre><code>Primary ‚Üí Standby A ‚Üí Standby A1
               ‚Üì
          Standby A2</code></pre>
<p><strong>Configuration on Standby A</strong>:</p>
<div class="sourceCode" id="cb349"><pre class="sourceCode ini"><code class="sourceCode ini"><span id="cb349-1"><a aria-hidden="true" href="#cb349-1" tabindex="-1"></a><span class="co"># Enable accepting replication connections</span></span>
<span id="cb349-2"><a aria-hidden="true" href="#cb349-2" tabindex="-1"></a><span class="dt">hot_standby </span><span class="ot">=</span><span class="st"> </span><span class="kw">on</span></span>
<span id="cb349-3"><a aria-hidden="true" href="#cb349-3" tabindex="-1"></a><span class="dt">max_wal_senders </span><span class="ot">=</span><span class="st"> </span><span class="dv">5</span></span></code></pre></div>
<p><strong>Benefits</strong>: - Reduces primary load - Geographic
distribution - Network efficiency (local cascading)</p>
<p><strong>Considerations</strong>: - Increased replication lag down the
chain - Middle node failure impacts downstream - Monitoring
complexity</p>
<h3 data-number="6.9.3" id="delayed-replication"><span class="header-section-number">6.9.3</span> 8.3 Delayed Replication</h3>
<p>Intentional replication delay protects against logical errors:</p>
<div class="sourceCode" id="cb350"><pre class="sourceCode ini"><code class="sourceCode ini"><span id="cb350-1"><a aria-hidden="true" href="#cb350-1" tabindex="-1"></a><span class="co"># On standby</span></span>
<span id="cb350-2"><a aria-hidden="true" href="#cb350-2" tabindex="-1"></a><span class="dt">recovery_min_apply_delay </span><span class="ot">=</span><span class="st"> '4h'</span></span></code></pre></div>
<p><strong>Use Case</strong>: Protection against accidental data
corruption or deletion - Corrupted data replicates to standby after 4
hours - Within delay window, can promote delayed standby with
uncorrupted data - Acts as ‚Äútime machine‚Äù for disaster recovery</p>
<h3 data-number="6.9.4" id="bi-directional-replication"><span class="header-section-number">6.9.4</span> 8.4 Bi-Directional
Replication</h3>
<p>Logical replication enables bidirectional replication for
multi-master scenarios:</p>
<p><strong>Setup</strong>:</p>
<div class="sourceCode" id="cb351"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb351-1"><a aria-hidden="true" href="#cb351-1" tabindex="-1"></a><span class="co">-- On node1</span></span>
<span id="cb351-2"><a aria-hidden="true" href="#cb351-2" tabindex="-1"></a><span class="kw">CREATE</span> PUBLICATION node1_pub <span class="cf">FOR</span> <span class="kw">ALL</span> <span class="kw">TABLES</span>;</span>
<span id="cb351-3"><a aria-hidden="true" href="#cb351-3" tabindex="-1"></a></span>
<span id="cb351-4"><a aria-hidden="true" href="#cb351-4" tabindex="-1"></a><span class="co">-- On node2</span></span>
<span id="cb351-5"><a aria-hidden="true" href="#cb351-5" tabindex="-1"></a><span class="kw">CREATE</span> PUBLICATION node2_pub <span class="cf">FOR</span> <span class="kw">ALL</span> <span class="kw">TABLES</span>;</span>
<span id="cb351-6"><a aria-hidden="true" href="#cb351-6" tabindex="-1"></a><span class="kw">CREATE</span> SUBSCRIPTION node2_sub</span>
<span id="cb351-7"><a aria-hidden="true" href="#cb351-7" tabindex="-1"></a>    CONNECTION <span class="st">'host=node1 dbname=mydb'</span></span>
<span id="cb351-8"><a aria-hidden="true" href="#cb351-8" tabindex="-1"></a>    PUBLICATION node1_pub</span>
<span id="cb351-9"><a aria-hidden="true" href="#cb351-9" tabindex="-1"></a>    <span class="kw">WITH</span> (origin <span class="op">=</span> <span class="kw">none</span>);  <span class="co">-- Prevent replication loops</span></span>
<span id="cb351-10"><a aria-hidden="true" href="#cb351-10" tabindex="-1"></a></span>
<span id="cb351-11"><a aria-hidden="true" href="#cb351-11" tabindex="-1"></a><span class="co">-- On node1</span></span>
<span id="cb351-12"><a aria-hidden="true" href="#cb351-12" tabindex="-1"></a><span class="kw">CREATE</span> SUBSCRIPTION node1_sub</span>
<span id="cb351-13"><a aria-hidden="true" href="#cb351-13" tabindex="-1"></a>    CONNECTION <span class="st">'host=node2 dbname=mydb'</span></span>
<span id="cb351-14"><a aria-hidden="true" href="#cb351-14" tabindex="-1"></a>    PUBLICATION node2_pub</span>
<span id="cb351-15"><a aria-hidden="true" href="#cb351-15" tabindex="-1"></a>    <span class="kw">WITH</span> (origin <span class="op">=</span> <span class="kw">none</span>);</span></code></pre></div>
<p><strong>Conflict Resolution</strong>: - PostgreSQL uses ‚Äúlast update
wins‚Äù by commit timestamp - No automatic conflict detection -
application must ensure - Consider using <code>origin</code> parameter
to track data source</p>
<hr/>
<h2 data-number="6.10" id="monitoring-and-diagnostics"><span class="header-section-number">6.10</span> 9. Monitoring and
Diagnostics</h2>
<h3 data-number="6.10.1" id="replication-monitoring-views"><span class="header-section-number">6.10.1</span> 9.1 Replication Monitoring
Views</h3>
<p><strong>pg_stat_replication</strong>: WalSender status from
primary</p>
<div class="sourceCode" id="cb352"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb352-1"><a aria-hidden="true" href="#cb352-1" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb352-2"><a aria-hidden="true" href="#cb352-2" tabindex="-1"></a>    application_name,</span>
<span id="cb352-3"><a aria-hidden="true" href="#cb352-3" tabindex="-1"></a>    client_addr,</span>
<span id="cb352-4"><a aria-hidden="true" href="#cb352-4" tabindex="-1"></a>    state,</span>
<span id="cb352-5"><a aria-hidden="true" href="#cb352-5" tabindex="-1"></a>    sync_state,</span>
<span id="cb352-6"><a aria-hidden="true" href="#cb352-6" tabindex="-1"></a>    sent_lsn,</span>
<span id="cb352-7"><a aria-hidden="true" href="#cb352-7" tabindex="-1"></a>    write_lsn,</span>
<span id="cb352-8"><a aria-hidden="true" href="#cb352-8" tabindex="-1"></a>    flush_lsn,</span>
<span id="cb352-9"><a aria-hidden="true" href="#cb352-9" tabindex="-1"></a>    replay_lsn,</span>
<span id="cb352-10"><a aria-hidden="true" href="#cb352-10" tabindex="-1"></a>    write_lag,</span>
<span id="cb352-11"><a aria-hidden="true" href="#cb352-11" tabindex="-1"></a>    flush_lag,</span>
<span id="cb352-12"><a aria-hidden="true" href="#cb352-12" tabindex="-1"></a>    replay_lag</span>
<span id="cb352-13"><a aria-hidden="true" href="#cb352-13" tabindex="-1"></a><span class="kw">FROM</span> pg_stat_replication;</span></code></pre></div>
<p><strong>pg_stat_wal_receiver</strong>: WalReceiver status on
standby</p>
<div class="sourceCode" id="cb353"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb353-1"><a aria-hidden="true" href="#cb353-1" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb353-2"><a aria-hidden="true" href="#cb353-2" tabindex="-1"></a>    status,</span>
<span id="cb353-3"><a aria-hidden="true" href="#cb353-3" tabindex="-1"></a>    receive_start_lsn,</span>
<span id="cb353-4"><a aria-hidden="true" href="#cb353-4" tabindex="-1"></a>    receive_start_tli,</span>
<span id="cb353-5"><a aria-hidden="true" href="#cb353-5" tabindex="-1"></a>    written_lsn,</span>
<span id="cb353-6"><a aria-hidden="true" href="#cb353-6" tabindex="-1"></a>    flushed_lsn,</span>
<span id="cb353-7"><a aria-hidden="true" href="#cb353-7" tabindex="-1"></a>    received_tli,</span>
<span id="cb353-8"><a aria-hidden="true" href="#cb353-8" tabindex="-1"></a>    last_msg_send_time,</span>
<span id="cb353-9"><a aria-hidden="true" href="#cb353-9" tabindex="-1"></a>    last_msg_receipt_time,</span>
<span id="cb353-10"><a aria-hidden="true" href="#cb353-10" tabindex="-1"></a>    latest_end_lsn,</span>
<span id="cb353-11"><a aria-hidden="true" href="#cb353-11" tabindex="-1"></a>    latest_end_time</span>
<span id="cb353-12"><a aria-hidden="true" href="#cb353-12" tabindex="-1"></a><span class="kw">FROM</span> pg_stat_wal_receiver;</span></code></pre></div>
<p><strong>pg_replication_slots</strong>: Replication slot status</p>
<div class="sourceCode" id="cb354"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb354-1"><a aria-hidden="true" href="#cb354-1" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb354-2"><a aria-hidden="true" href="#cb354-2" tabindex="-1"></a>    slot_name,</span>
<span id="cb354-3"><a aria-hidden="true" href="#cb354-3" tabindex="-1"></a>    plugin,</span>
<span id="cb354-4"><a aria-hidden="true" href="#cb354-4" tabindex="-1"></a>    slot_type,</span>
<span id="cb354-5"><a aria-hidden="true" href="#cb354-5" tabindex="-1"></a>    <span class="kw">database</span>,</span>
<span id="cb354-6"><a aria-hidden="true" href="#cb354-6" tabindex="-1"></a>    active,</span>
<span id="cb354-7"><a aria-hidden="true" href="#cb354-7" tabindex="-1"></a>    restart_lsn,</span>
<span id="cb354-8"><a aria-hidden="true" href="#cb354-8" tabindex="-1"></a>    confirmed_flush_lsn,</span>
<span id="cb354-9"><a aria-hidden="true" href="#cb354-9" tabindex="-1"></a>    wal_status,</span>
<span id="cb354-10"><a aria-hidden="true" href="#cb354-10" tabindex="-1"></a>    safe_wal_size</span>
<span id="cb354-11"><a aria-hidden="true" href="#cb354-11" tabindex="-1"></a><span class="kw">FROM</span> pg_replication_slots;</span></code></pre></div>
<h3 data-number="6.10.2" id="lag-monitoring"><span class="header-section-number">6.10.2</span> 9.2 Lag Monitoring</h3>
<p><strong>Byte Lag on Primary</strong>:</p>
<div class="sourceCode" id="cb355"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb355-1"><a aria-hidden="true" href="#cb355-1" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb355-2"><a aria-hidden="true" href="#cb355-2" tabindex="-1"></a>    application_name,</span>
<span id="cb355-3"><a aria-hidden="true" href="#cb355-3" tabindex="-1"></a>    client_addr,</span>
<span id="cb355-4"><a aria-hidden="true" href="#cb355-4" tabindex="-1"></a>    pg_wal_lsn_diff(sent_lsn, replay_lsn) <span class="kw">AS</span> byte_lag,</span>
<span id="cb355-5"><a aria-hidden="true" href="#cb355-5" tabindex="-1"></a>    replay_lag</span>
<span id="cb355-6"><a aria-hidden="true" href="#cb355-6" tabindex="-1"></a><span class="kw">FROM</span> pg_stat_replication;</span></code></pre></div>
<p><strong>Replay Position on Standby</strong>:</p>
<div class="sourceCode" id="cb356"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb356-1"><a aria-hidden="true" href="#cb356-1" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb356-2"><a aria-hidden="true" href="#cb356-2" tabindex="-1"></a>    pg_last_wal_receive_lsn() <span class="kw">AS</span> receive_lsn,</span>
<span id="cb356-3"><a aria-hidden="true" href="#cb356-3" tabindex="-1"></a>    pg_last_wal_replay_lsn() <span class="kw">AS</span> replay_lsn,</span>
<span id="cb356-4"><a aria-hidden="true" href="#cb356-4" tabindex="-1"></a>    pg_wal_lsn_diff(</span>
<span id="cb356-5"><a aria-hidden="true" href="#cb356-5" tabindex="-1"></a>        pg_last_wal_receive_lsn(),</span>
<span id="cb356-6"><a aria-hidden="true" href="#cb356-6" tabindex="-1"></a>        pg_last_wal_replay_lsn()</span>
<span id="cb356-7"><a aria-hidden="true" href="#cb356-7" tabindex="-1"></a>    ) <span class="kw">AS</span> replay_lag_bytes;</span></code></pre></div>
<p><strong>Time-Based Lag</strong>:</p>
<div class="sourceCode" id="cb357"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb357-1"><a aria-hidden="true" href="#cb357-1" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb357-2"><a aria-hidden="true" href="#cb357-2" tabindex="-1"></a>    now() <span class="op">-</span> pg_last_xact_replay_timestamp() <span class="kw">AS</span> replication_lag_time;</span></code></pre></div>
<h3 data-number="6.10.3" id="wal-generation-monitoring"><span class="header-section-number">6.10.3</span> 9.3 WAL Generation
Monitoring</h3>
<div class="sourceCode" id="cb358"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb358-1"><a aria-hidden="true" href="#cb358-1" tabindex="-1"></a><span class="co">-- Current WAL insert position</span></span>
<span id="cb358-2"><a aria-hidden="true" href="#cb358-2" tabindex="-1"></a><span class="kw">SELECT</span> pg_current_wal_lsn();</span>
<span id="cb358-3"><a aria-hidden="true" href="#cb358-3" tabindex="-1"></a></span>
<span id="cb358-4"><a aria-hidden="true" href="#cb358-4" tabindex="-1"></a><span class="co">-- WAL generation rate</span></span>
<span id="cb358-5"><a aria-hidden="true" href="#cb358-5" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb358-6"><a aria-hidden="true" href="#cb358-6" tabindex="-1"></a>    (pg_wal_lsn_diff(pg_current_wal_lsn(), <span class="st">'0/0'</span>) <span class="op">/</span></span>
<span id="cb358-7"><a aria-hidden="true" href="#cb358-7" tabindex="-1"></a>     <span class="fu">EXTRACT</span>(EPOCH <span class="kw">FROM</span> (now() <span class="op">-</span> pg_postmaster_start_time())))</span>
<span id="cb358-8"><a aria-hidden="true" href="#cb358-8" tabindex="-1"></a>    <span class="kw">AS</span> wal_bytes_per_second;</span>
<span id="cb358-9"><a aria-hidden="true" href="#cb358-9" tabindex="-1"></a></span>
<span id="cb358-10"><a aria-hidden="true" href="#cb358-10" tabindex="-1"></a><span class="co">-- Checkpoint statistics</span></span>
<span id="cb358-11"><a aria-hidden="true" href="#cb358-11" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> pg_stat_bgwriter;</span>
<span id="cb358-12"><a aria-hidden="true" href="#cb358-12" tabindex="-1"></a></span>
<span id="cb358-13"><a aria-hidden="true" href="#cb358-13" tabindex="-1"></a><span class="co">-- WAL archiving status</span></span>
<span id="cb358-14"><a aria-hidden="true" href="#cb358-14" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> pg_stat_archiver;</span></code></pre></div>
<h3 data-number="6.10.4" id="diagnostic-queries"><span class="header-section-number">6.10.4</span> 9.4 Diagnostic Queries</h3>
<p><strong>Check if in recovery</strong>:</p>
<div class="sourceCode" id="cb359"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb359-1"><a aria-hidden="true" href="#cb359-1" tabindex="-1"></a><span class="kw">SELECT</span> pg_is_in_recovery();</span></code></pre></div>
<p><strong>Current recovery timeline</strong>:</p>
<div class="sourceCode" id="cb360"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb360-1"><a aria-hidden="true" href="#cb360-1" tabindex="-1"></a><span class="kw">SELECT</span> timeline_id, redo_lsn <span class="kw">FROM</span> pg_control_checkpoint();</span></code></pre></div>
<p><strong>Oldest replication slot holding WAL</strong>:</p>
<div class="sourceCode" id="cb361"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb361-1"><a aria-hidden="true" href="#cb361-1" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb361-2"><a aria-hidden="true" href="#cb361-2" tabindex="-1"></a>    slot_name,</span>
<span id="cb361-3"><a aria-hidden="true" href="#cb361-3" tabindex="-1"></a>    restart_lsn,</span>
<span id="cb361-4"><a aria-hidden="true" href="#cb361-4" tabindex="-1"></a>    pg_wal_lsn_diff(pg_current_wal_lsn(), restart_lsn) <span class="kw">AS</span> lag_bytes</span>
<span id="cb361-5"><a aria-hidden="true" href="#cb361-5" tabindex="-1"></a><span class="kw">FROM</span> pg_replication_slots</span>
<span id="cb361-6"><a aria-hidden="true" href="#cb361-6" tabindex="-1"></a><span class="kw">WHERE</span> restart_lsn <span class="kw">IS</span> <span class="kw">NOT</span> <span class="kw">NULL</span></span>
<span id="cb361-7"><a aria-hidden="true" href="#cb361-7" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> restart_lsn</span>
<span id="cb361-8"><a aria-hidden="true" href="#cb361-8" tabindex="-1"></a><span class="kw">LIMIT</span> <span class="dv">1</span>;</span></code></pre></div>
<p><strong>Replication slot disk usage</strong>:</p>
<div class="sourceCode" id="cb362"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb362-1"><a aria-hidden="true" href="#cb362-1" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb362-2"><a aria-hidden="true" href="#cb362-2" tabindex="-1"></a>    slot_name,</span>
<span id="cb362-3"><a aria-hidden="true" href="#cb362-3" tabindex="-1"></a>    wal_status,</span>
<span id="cb362-4"><a aria-hidden="true" href="#cb362-4" tabindex="-1"></a>    safe_wal_size <span class="op">/</span> <span class="dv">1024</span> <span class="op">/</span> <span class="dv">1024</span> <span class="kw">AS</span> safe_wal_mb</span>
<span id="cb362-5"><a aria-hidden="true" href="#cb362-5" tabindex="-1"></a><span class="kw">FROM</span> pg_replication_slots;</span></code></pre></div>
<hr/>
<h2 data-number="6.11" id="common-replication-patterns"><span class="header-section-number">6.11</span> 10. Common Replication
Patterns</h2>
<h3 data-number="6.11.1" id="primary-standby-active-passive"><span class="header-section-number">6.11.1</span> 10.1 Primary-Standby
(Active-Passive)</h3>
<p><strong>Purpose</strong>: High availability with automatic
failover</p>
<p><strong>Setup</strong>:</p>
<div class="sourceCode" id="cb363"><pre class="sourceCode ini"><code class="sourceCode ini"><span id="cb363-1"><a aria-hidden="true" href="#cb363-1" tabindex="-1"></a><span class="co"># Primary</span></span>
<span id="cb363-2"><a aria-hidden="true" href="#cb363-2" tabindex="-1"></a><span class="dt">wal_level </span><span class="ot">=</span><span class="st"> replica</span></span>
<span id="cb363-3"><a aria-hidden="true" href="#cb363-3" tabindex="-1"></a><span class="dt">max_wal_senders </span><span class="ot">=</span><span class="st"> </span><span class="dv">5</span></span>
<span id="cb363-4"><a aria-hidden="true" href="#cb363-4" tabindex="-1"></a><span class="dt">wal_keep_size </span><span class="ot">=</span><span class="st"> </span><span class="dv">1024</span></span>
<span id="cb363-5"><a aria-hidden="true" href="#cb363-5" tabindex="-1"></a></span>
<span id="cb363-6"><a aria-hidden="true" href="#cb363-6" tabindex="-1"></a><span class="co"># Standby</span></span>
<span id="cb363-7"><a aria-hidden="true" href="#cb363-7" tabindex="-1"></a><span class="dt">primary_conninfo </span><span class="ot">=</span><span class="st"> 'host=primary port=5432 user=replication'</span></span>
<span id="cb363-8"><a aria-hidden="true" href="#cb363-8" tabindex="-1"></a><span class="dt">primary_slot_name </span><span class="ot">=</span><span class="st"> 'standby1_slot'</span></span>
<span id="cb363-9"><a aria-hidden="true" href="#cb363-9" tabindex="-1"></a><span class="dt">hot_standby </span><span class="ot">=</span><span class="st"> </span><span class="kw">on</span></span></code></pre></div>
<p><strong>Failover Process</strong>: 1. Verify primary is down 2. On
standby: <code>pg_ctl promote</code> or create <code>promote</code>
signal file 3. Reconfigure application to new primary 4. (Optional)
Rebuild old primary as new standby</p>
<h3 data-number="6.11.2" id="primary-with-multiple-standbys"><span class="header-section-number">6.11.2</span> 10.2 Primary with Multiple
Standbys</h3>
<p><strong>Purpose</strong>: Load balancing read queries, geographic
distribution</p>
<p><strong>Setup</strong>:</p>
<div class="sourceCode" id="cb364"><pre class="sourceCode ini"><code class="sourceCode ini"><span id="cb364-1"><a aria-hidden="true" href="#cb364-1" tabindex="-1"></a><span class="co"># Primary</span></span>
<span id="cb364-2"><a aria-hidden="true" href="#cb364-2" tabindex="-1"></a><span class="dt">max_wal_senders </span><span class="ot">=</span><span class="st"> </span><span class="dv">10</span></span>
<span id="cb364-3"><a aria-hidden="true" href="#cb364-3" tabindex="-1"></a><span class="dt">synchronous_standby_names </span><span class="ot">=</span><span class="st"> 'FIRST 1 (standby_local, standby_remote)'</span></span>
<span id="cb364-4"><a aria-hidden="true" href="#cb364-4" tabindex="-1"></a></span>
<span id="cb364-5"><a aria-hidden="true" href="#cb364-5" tabindex="-1"></a><span class="co"># Standby configs differ only in:</span></span>
<span id="cb364-6"><a aria-hidden="true" href="#cb364-6" tabindex="-1"></a><span class="dt">primary_slot_name </span><span class="ot">=</span><span class="st"> 'standby1_slot'  # Unique per standby</span></span></code></pre></div>
<h3 data-number="6.11.3" id="logical-replication-for-upgrades"><span class="header-section-number">6.11.3</span> 10.3 Logical Replication for
Upgrades</h3>
<p><strong>Purpose</strong>: Zero-downtime major version upgrade</p>
<p><strong>Workflow</strong>: 1. Set up new version cluster 2. Create
publication on old version 3. Create subscription on new version 4. Wait
for sync completion 5. Switch applications to new version 6.
Decommission old version</p>
<p><strong>Setup</strong>:</p>
<div class="sourceCode" id="cb365"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb365-1"><a aria-hidden="true" href="#cb365-1" tabindex="-1"></a><span class="co">-- On old cluster (e.g., PG 14)</span></span>
<span id="cb365-2"><a aria-hidden="true" href="#cb365-2" tabindex="-1"></a><span class="kw">CREATE</span> PUBLICATION upgrade_pub <span class="cf">FOR</span> <span class="kw">ALL</span> <span class="kw">TABLES</span>;</span>
<span id="cb365-3"><a aria-hidden="true" href="#cb365-3" tabindex="-1"></a></span>
<span id="cb365-4"><a aria-hidden="true" href="#cb365-4" tabindex="-1"></a><span class="co">-- On new cluster (e.g., PG 16)</span></span>
<span id="cb365-5"><a aria-hidden="true" href="#cb365-5" tabindex="-1"></a><span class="kw">CREATE</span> SUBSCRIPTION upgrade_sub</span>
<span id="cb365-6"><a aria-hidden="true" href="#cb365-6" tabindex="-1"></a>    CONNECTION <span class="st">'host=old_cluster port=5432 dbname=mydb'</span></span>
<span id="cb365-7"><a aria-hidden="true" href="#cb365-7" tabindex="-1"></a>    PUBLICATION upgrade_pub;</span>
<span id="cb365-8"><a aria-hidden="true" href="#cb365-8" tabindex="-1"></a></span>
<span id="cb365-9"><a aria-hidden="true" href="#cb365-9" tabindex="-1"></a><span class="co">-- Monitor sync status</span></span>
<span id="cb365-10"><a aria-hidden="true" href="#cb365-10" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> pg_subscription;</span>
<span id="cb365-11"><a aria-hidden="true" href="#cb365-11" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> pg_stat_subscription;</span></code></pre></div>
<h3 data-number="6.11.4" id="multi-region-active-active"><span class="header-section-number">6.11.4</span> 10.4 Multi-Region
Active-Active</h3>
<p><strong>Purpose</strong>: Local writes with global consistency</p>
<p><strong>Architecture</strong>: Logical replication between regions
with application-level conflict avoidance</p>
<p><strong>Setup Principle</strong>:</p>
<div class="sourceCode" id="cb366"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb366-1"><a aria-hidden="true" href="#cb366-1" tabindex="-1"></a><span class="co">-- Region A handles customers A-M</span></span>
<span id="cb366-2"><a aria-hidden="true" href="#cb366-2" tabindex="-1"></a><span class="co">-- Region B handles customers N-Z</span></span>
<span id="cb366-3"><a aria-hidden="true" href="#cb366-3" tabindex="-1"></a><span class="co">-- Each region publishes its partition</span></span>
<span id="cb366-4"><a aria-hidden="true" href="#cb366-4" tabindex="-1"></a><span class="co">-- Each region subscribes to other region's publication</span></span>
<span id="cb366-5"><a aria-hidden="true" href="#cb366-5" tabindex="-1"></a><span class="co">-- Application routes writes to owning region</span></span></code></pre></div>
<hr/>
<h2 data-number="6.12" id="troubleshooting"><span class="header-section-number">6.12</span> 11. Troubleshooting</h2>
<h3 data-number="6.12.1" id="replication-lag-investigation"><span class="header-section-number">6.12.1</span> 11.1 Replication Lag
Investigation</h3>
<p><strong>Symptom</strong>: Standby falls behind primary</p>
<p><strong>Diagnostic Steps</strong>:</p>
<div class="sourceCode" id="cb367"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb367-1"><a aria-hidden="true" href="#cb367-1" tabindex="-1"></a><span class="co">-- 1. Check lag metrics</span></span>
<span id="cb367-2"><a aria-hidden="true" href="#cb367-2" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> pg_stat_replication;</span>
<span id="cb367-3"><a aria-hidden="true" href="#cb367-3" tabindex="-1"></a></span>
<span id="cb367-4"><a aria-hidden="true" href="#cb367-4" tabindex="-1"></a><span class="co">-- 2. Check for long-running transactions on primary</span></span>
<span id="cb367-5"><a aria-hidden="true" href="#cb367-5" tabindex="-1"></a><span class="kw">SELECT</span> pid, now() <span class="op">-</span> xact_start <span class="kw">AS</span> duration, state, <span class="kw">query</span></span>
<span id="cb367-6"><a aria-hidden="true" href="#cb367-6" tabindex="-1"></a><span class="kw">FROM</span> pg_stat_activity</span>
<span id="cb367-7"><a aria-hidden="true" href="#cb367-7" tabindex="-1"></a><span class="kw">WHERE</span> state <span class="op">=</span> <span class="st">'active'</span> <span class="kw">AND</span> xact_start <span class="op">&lt;</span> now() <span class="op">-</span> <span class="dt">interval</span> <span class="st">'1 hour'</span>;</span>
<span id="cb367-8"><a aria-hidden="true" href="#cb367-8" tabindex="-1"></a></span>
<span id="cb367-9"><a aria-hidden="true" href="#cb367-9" tabindex="-1"></a><span class="co">-- 3. Check for hot standby conflicts</span></span>
<span id="cb367-10"><a aria-hidden="true" href="#cb367-10" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> pg_stat_database_conflicts;</span>
<span id="cb367-11"><a aria-hidden="true" href="#cb367-11" tabindex="-1"></a></span>
<span id="cb367-12"><a aria-hidden="true" href="#cb367-12" tabindex="-1"></a><span class="co">-- 4. Check WAL generation rate</span></span>
<span id="cb367-13"><a aria-hidden="true" href="#cb367-13" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb367-14"><a aria-hidden="true" href="#cb367-14" tabindex="-1"></a>    (pg_wal_lsn_diff(pg_current_wal_lsn(), <span class="st">'0/0'</span>) <span class="op">/</span></span>
<span id="cb367-15"><a aria-hidden="true" href="#cb367-15" tabindex="-1"></a>     <span class="fu">EXTRACT</span>(EPOCH <span class="kw">FROM</span> (now() <span class="op">-</span> pg_postmaster_start_time()))) <span class="op">/</span> <span class="dv">1024</span> <span class="op">/</span> <span class="dv">1024</span></span>
<span id="cb367-16"><a aria-hidden="true" href="#cb367-16" tabindex="-1"></a>    <span class="kw">AS</span> mb_per_second;</span>
<span id="cb367-17"><a aria-hidden="true" href="#cb367-17" tabindex="-1"></a></span>
<span id="cb367-18"><a aria-hidden="true" href="#cb367-18" tabindex="-1"></a><span class="co">-- 5. Check standby system resources (CPU, IO, network)</span></span>
<span id="cb367-19"><a aria-hidden="true" href="#cb367-19" tabindex="-1"></a><span class="co">-- Use OS tools: iostat, vmstat, iftop</span></span></code></pre></div>
<p><strong>Common Causes</strong>: - Network bandwidth saturation -
Standby I/O bottleneck (slow storage) - Large transactions on primary -
Hot standby conflicts - Standby resource exhaustion</p>
<h3 data-number="6.12.2" id="replication-slot-issues"><span class="header-section-number">6.12.2</span> 11.2 Replication Slot
Issues</h3>
<p><strong>Symptom</strong>: Disk space exhaustion from WAL
accumulation</p>
<p><strong>Diagnostic</strong>:</p>
<div class="sourceCode" id="cb368"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb368-1"><a aria-hidden="true" href="#cb368-1" tabindex="-1"></a><span class="co">-- Check slot WAL retention</span></span>
<span id="cb368-2"><a aria-hidden="true" href="#cb368-2" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb368-3"><a aria-hidden="true" href="#cb368-3" tabindex="-1"></a>    slot_name,</span>
<span id="cb368-4"><a aria-hidden="true" href="#cb368-4" tabindex="-1"></a>    active,</span>
<span id="cb368-5"><a aria-hidden="true" href="#cb368-5" tabindex="-1"></a>    wal_status,</span>
<span id="cb368-6"><a aria-hidden="true" href="#cb368-6" tabindex="-1"></a>    pg_wal_lsn_diff(pg_current_wal_lsn(), restart_lsn) <span class="op">/</span> <span class="dv">1024</span> <span class="op">/</span> <span class="dv">1024</span> <span class="kw">AS</span> mb_behind</span>
<span id="cb368-7"><a aria-hidden="true" href="#cb368-7" tabindex="-1"></a><span class="kw">FROM</span> pg_replication_slots</span>
<span id="cb368-8"><a aria-hidden="true" href="#cb368-8" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> restart_lsn;</span></code></pre></div>
<p><strong>Resolution</strong>:</p>
<div class="sourceCode" id="cb369"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb369-1"><a aria-hidden="true" href="#cb369-1" tabindex="-1"></a><span class="co">-- 1. Identify problematic slot</span></span>
<span id="cb369-2"><a aria-hidden="true" href="#cb369-2" tabindex="-1"></a><span class="co">-- (Inactive slot with large mb_behind)</span></span>
<span id="cb369-3"><a aria-hidden="true" href="#cb369-3" tabindex="-1"></a></span>
<span id="cb369-4"><a aria-hidden="true" href="#cb369-4" tabindex="-1"></a><span class="co">-- 2. If slot is truly abandoned, drop it:</span></span>
<span id="cb369-5"><a aria-hidden="true" href="#cb369-5" tabindex="-1"></a><span class="kw">SELECT</span> pg_drop_replication_slot(<span class="st">'abandoned_slot'</span>);</span>
<span id="cb369-6"><a aria-hidden="true" href="#cb369-6" tabindex="-1"></a></span>
<span id="cb369-7"><a aria-hidden="true" href="#cb369-7" tabindex="-1"></a><span class="co">-- 3. If slot is for valid standby that's disconnected:</span></span>
<span id="cb369-8"><a aria-hidden="true" href="#cb369-8" tabindex="-1"></a><span class="co">--    - Fix standby connectivity</span></span>
<span id="cb369-9"><a aria-hidden="true" href="#cb369-9" tabindex="-1"></a><span class="co">--    - If catch-up impossible, rebuild standby with pg_basebackup</span></span>
<span id="cb369-10"><a aria-hidden="true" href="#cb369-10" tabindex="-1"></a><span class="co">--    - Then recreate/reuse slot</span></span></code></pre></div>
<h3 data-number="6.12.3" id="hot-standby-query-conflicts"><span class="header-section-number">6.12.3</span> 11.3 Hot Standby Query
Conflicts</h3>
<p><strong>Symptom</strong>: Queries on standby canceled with ‚Äúconflict
with recovery‚Äù</p>
<p><strong>Check conflict statistics</strong>:</p>
<div class="sourceCode" id="cb370"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb370-1"><a aria-hidden="true" href="#cb370-1" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> pg_stat_database_conflicts;</span></code></pre></div>
<p><strong>Resolution Options</strong>:</p>
<ol type="1">
<li><strong>Enable hot_standby_feedback</strong>:</li>
</ol>
<div class="sourceCode" id="cb371"><pre class="sourceCode ini"><code class="sourceCode ini"><span id="cb371-1"><a aria-hidden="true" href="#cb371-1" tabindex="-1"></a><span class="co"># On standby</span></span>
<span id="cb371-2"><a aria-hidden="true" href="#cb371-2" tabindex="-1"></a><span class="dt">hot_standby_feedback </span><span class="ot">=</span><span class="st"> </span><span class="kw">on</span></span></code></pre></div>
<p>Pro: Prevents conflicts Con: Primary bloat</p>
<ol start="2" type="1">
<li><strong>Increase max_standby_streaming_delay</strong>:</li>
</ol>
<div class="sourceCode" id="cb372"><pre class="sourceCode ini"><code class="sourceCode ini"><span id="cb372-1"><a aria-hidden="true" href="#cb372-1" tabindex="-1"></a><span class="co"># On standby</span></span>
<span id="cb372-2"><a aria-hidden="true" href="#cb372-2" tabindex="-1"></a><span class="dt">max_standby_streaming_delay </span><span class="ot">=</span><span class="st"> 600s  # Default: 30s</span></span></code></pre></div>
<p>Pro: Gives queries more time Con: Increases replication lag</p>
<ol start="3" type="1">
<li><strong>Use delayed standby for reporting</strong>:</li>
</ol>
<div class="sourceCode" id="cb373"><pre class="sourceCode ini"><code class="sourceCode ini"><span id="cb373-1"><a aria-hidden="true" href="#cb373-1" tabindex="-1"></a><span class="dt">recovery_min_apply_delay </span><span class="ot">=</span><span class="st"> '1h'</span></span></code></pre></div>
<p>Pro: Conflict-free reporting Con: Stale data</p>
<h3 data-number="6.12.4" id="logical-replication-issues"><span class="header-section-number">6.12.4</span> 11.4 Logical Replication
Issues</h3>
<p><strong>Symptom</strong>: Subscription falls behind or fails</p>
<p><strong>Diagnostic</strong>:</p>
<div class="sourceCode" id="cb374"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb374-1"><a aria-hidden="true" href="#cb374-1" tabindex="-1"></a><span class="co">-- Check subscription status</span></span>
<span id="cb374-2"><a aria-hidden="true" href="#cb374-2" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> pg_stat_subscription;</span>
<span id="cb374-3"><a aria-hidden="true" href="#cb374-3" tabindex="-1"></a></span>
<span id="cb374-4"><a aria-hidden="true" href="#cb374-4" tabindex="-1"></a><span class="co">-- Check replication slot on publisher</span></span>
<span id="cb374-5"><a aria-hidden="true" href="#cb374-5" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> pg_replication_slots <span class="kw">WHERE</span> slot_name <span class="op">=</span> <span class="st">'subscription_slot'</span>;</span>
<span id="cb374-6"><a aria-hidden="true" href="#cb374-6" tabindex="-1"></a></span>
<span id="cb374-7"><a aria-hidden="true" href="#cb374-7" tabindex="-1"></a><span class="co">-- Check for errors in subscriber logs</span></span>
<span id="cb374-8"><a aria-hidden="true" href="#cb374-8" tabindex="-1"></a><span class="co">-- Look for: constraint violations, schema mismatches, permission errors</span></span></code></pre></div>
<p><strong>Common Issues</strong>:</p>
<ol type="1">
<li><strong>Schema Mismatch</strong>: Subscriber table definition
differs from publisher
<ul>
<li>Solution: Ensure compatible schemas, use
<code>ALTER SUBSCRIPTION REFRESH PUBLICATION</code></li>
</ul></li>
<li><strong>Constraint Violations</strong>: Unique constraint on
subscriber violated by replicated data
<ul>
<li>Solution: Fix data on subscriber, or disable constraint during
initial sync</li>
</ul></li>
<li><strong>Permission Errors</strong>: Subscription user lacks
necessary privileges
<ul>
<li>Solution:
<code>GRANT SELECT ON ALL TABLES IN SCHEMA public TO replication_user</code></li>
</ul></li>
</ol>
<hr/>
<h2 data-number="6.13" id="performance-optimization"><span class="header-section-number">6.13</span> 12. Performance
Optimization</h2>
<h3 data-number="6.13.1" id="wal-configuration-tuning"><span class="header-section-number">6.13.1</span> 12.1 WAL Configuration
Tuning</h3>
<div class="sourceCode" id="cb375"><pre class="sourceCode ini"><code class="sourceCode ini"><span id="cb375-1"><a aria-hidden="true" href="#cb375-1" tabindex="-1"></a><span class="co"># Increase WAL buffers for high-write workloads</span></span>
<span id="cb375-2"><a aria-hidden="true" href="#cb375-2" tabindex="-1"></a><span class="dt">wal_buffers </span><span class="ot">=</span><span class="st"> 16MB                  # Default: -1 (auto)</span></span>
<span id="cb375-3"><a aria-hidden="true" href="#cb375-3" tabindex="-1"></a></span>
<span id="cb375-4"><a aria-hidden="true" href="#cb375-4" tabindex="-1"></a><span class="co"># Batch WAL writes for better throughput</span></span>
<span id="cb375-5"><a aria-hidden="true" href="#cb375-5" tabindex="-1"></a><span class="dt">commit_delay </span><span class="ot">=</span><span class="st"> 10                   # microseconds to delay commit</span></span>
<span id="cb375-6"><a aria-hidden="true" href="#cb375-6" tabindex="-1"></a><span class="dt">commit_siblings </span><span class="ot">=</span><span class="st"> 5                 # require this many concurrent commits</span></span>
<span id="cb375-7"><a aria-hidden="true" href="#cb375-7" tabindex="-1"></a></span>
<span id="cb375-8"><a aria-hidden="true" href="#cb375-8" tabindex="-1"></a><span class="co"># Disable full page writes if on crash-safe storage (carefully!)</span></span>
<span id="cb375-9"><a aria-hidden="true" href="#cb375-9" tabindex="-1"></a><span class="dt">full_page_writes </span><span class="ot">=</span><span class="st"> on               # Usually keep enabled</span></span>
<span id="cb375-10"><a aria-hidden="true" href="#cb375-10" tabindex="-1"></a></span>
<span id="cb375-11"><a aria-hidden="true" href="#cb375-11" tabindex="-1"></a><span class="co"># Enable WAL compression for network-bound replication</span></span>
<span id="cb375-12"><a aria-hidden="true" href="#cb375-12" tabindex="-1"></a><span class="dt">wal_compression </span><span class="ot">=</span><span class="st"> lz4               # none | pglz | lz4 | zstd</span></span></code></pre></div>
<h3 data-number="6.13.2" id="replication-performance"><span class="header-section-number">6.13.2</span> 12.2 Replication
Performance</h3>
<div class="sourceCode" id="cb376"><pre class="sourceCode ini"><code class="sourceCode ini"><span id="cb376-1"><a aria-hidden="true" href="#cb376-1" tabindex="-1"></a><span class="co"># Increase max_wal_senders for many standbys</span></span>
<span id="cb376-2"><a aria-hidden="true" href="#cb376-2" tabindex="-1"></a><span class="dt">max_wal_senders </span><span class="ot">=</span><span class="st"> 10                # Usually 2x number of standbys</span></span>
<span id="cb376-3"><a aria-hidden="true" href="#cb376-3" tabindex="-1"></a></span>
<span id="cb376-4"><a aria-hidden="true" href="#cb376-4" tabindex="-1"></a><span class="co"># Increase wal_sender_timeout to handle slow networks</span></span>
<span id="cb376-5"><a aria-hidden="true" href="#cb376-5" tabindex="-1"></a><span class="dt">wal_sender_timeout </span><span class="ot">=</span><span class="st"> 60s            # Default: 60s</span></span>
<span id="cb376-6"><a aria-hidden="true" href="#cb376-6" tabindex="-1"></a></span>
<span id="cb376-7"><a aria-hidden="true" href="#cb376-7" tabindex="-1"></a><span class="co"># On standby, increase apply performance</span></span>
<span id="cb376-8"><a aria-hidden="true" href="#cb376-8" tabindex="-1"></a><span class="dt">max_parallel_maintenance_workers </span><span class="ot">=</span><span class="st"> </span><span class="dv">4</span></span>
<span id="cb376-9"><a aria-hidden="true" href="#cb376-9" tabindex="-1"></a><span class="dt">max_parallel_workers </span><span class="ot">=</span><span class="st"> </span><span class="dv">8</span></span></code></pre></div>
<h3 data-number="6.13.3" id="checkpoint-tuning-for-replication"><span class="header-section-number">6.13.3</span> 12.3 Checkpoint Tuning for
Replication</h3>
<div class="sourceCode" id="cb377"><pre class="sourceCode ini"><code class="sourceCode ini"><span id="cb377-1"><a aria-hidden="true" href="#cb377-1" tabindex="-1"></a><span class="co"># Larger checkpoints reduce frequency, improve throughput</span></span>
<span id="cb377-2"><a aria-hidden="true" href="#cb377-2" tabindex="-1"></a><span class="dt">max_wal_size </span><span class="ot">=</span><span class="st"> 8GB                  # Soft limit</span></span>
<span id="cb377-3"><a aria-hidden="true" href="#cb377-3" tabindex="-1"></a><span class="dt">checkpoint_timeout </span><span class="ot">=</span><span class="st"> 30min          # Time-based trigger</span></span>
<span id="cb377-4"><a aria-hidden="true" href="#cb377-4" tabindex="-1"></a></span>
<span id="cb377-5"><a aria-hidden="true" href="#cb377-5" tabindex="-1"></a><span class="co"># Spread checkpoint I/O</span></span>
<span id="cb377-6"><a aria-hidden="true" href="#cb377-6" tabindex="-1"></a><span class="dt">checkpoint_completion_target </span><span class="ot">=</span><span class="st"> 0.9  # Spread over 90% of timeout</span></span>
<span id="cb377-7"><a aria-hidden="true" href="#cb377-7" tabindex="-1"></a></span>
<span id="cb377-8"><a aria-hidden="true" href="#cb377-8" tabindex="-1"></a><span class="co"># Monitor checkpoint performance</span></span>
<span id="cb377-9"><a aria-hidden="true" href="#cb377-9" tabindex="-1"></a><span class="dt">log_checkpoints </span><span class="ot">=</span><span class="st"> </span><span class="kw">on</span></span></code></pre></div>
<hr/>
<h2 data-number="6.14" id="security-considerations"><span class="header-section-number">6.14</span> 13. Security
Considerations</h2>
<h3 data-number="6.14.1" id="replication-authentication"><span class="header-section-number">6.14.1</span> 13.1 Replication
Authentication</h3>
<p><strong>pg_hba.conf Configuration</strong>:</p>
<pre><code># TYPE  DATABASE        USER            ADDRESS                 METHOD

# Allow replication from trusted standby
host    replication     replicator      192.168.1.10/32         scram-sha-256

# Require SSL for remote replication
hostssl replication     replicator      10.0.0.0/8              scram-sha-256

# Local replication for backup
local   replication     backup_user                             peer</code></pre>
<p><strong>Create Replication User</strong>:</p>
<div class="sourceCode" id="cb379"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb379-1"><a aria-hidden="true" href="#cb379-1" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">ROLE</span> replicator <span class="kw">WITH</span></span>
<span id="cb379-2"><a aria-hidden="true" href="#cb379-2" tabindex="-1"></a>    LOGIN</span>
<span id="cb379-3"><a aria-hidden="true" href="#cb379-3" tabindex="-1"></a>    REPLICATION</span>
<span id="cb379-4"><a aria-hidden="true" href="#cb379-4" tabindex="-1"></a>    <span class="kw">PASSWORD</span> <span class="st">'secure_password'</span>;</span></code></pre></div>
<h3 data-number="6.14.2" id="ssltls-for-replication"><span class="header-section-number">6.14.2</span> 13.2 SSL/TLS for
Replication</h3>
<p><strong>On Primary</strong>:</p>
<div class="sourceCode" id="cb380"><pre class="sourceCode ini"><code class="sourceCode ini"><span id="cb380-1"><a aria-hidden="true" href="#cb380-1" tabindex="-1"></a><span class="dt">ssl </span><span class="ot">=</span><span class="st"> </span><span class="kw">on</span></span>
<span id="cb380-2"><a aria-hidden="true" href="#cb380-2" tabindex="-1"></a><span class="dt">ssl_cert_file </span><span class="ot">=</span><span class="st"> '/etc/ssl/certs/server.crt'</span></span>
<span id="cb380-3"><a aria-hidden="true" href="#cb380-3" tabindex="-1"></a><span class="dt">ssl_key_file </span><span class="ot">=</span><span class="st"> '/etc/ssl/private/server.key'</span></span>
<span id="cb380-4"><a aria-hidden="true" href="#cb380-4" tabindex="-1"></a><span class="dt">ssl_ca_file </span><span class="ot">=</span><span class="st"> '/etc/ssl/certs/ca.crt'</span></span></code></pre></div>
<p><strong>On Standby</strong>:</p>
<div class="sourceCode" id="cb381"><pre class="sourceCode ini"><code class="sourceCode ini"><span id="cb381-1"><a aria-hidden="true" href="#cb381-1" tabindex="-1"></a><span class="dt">primary_conninfo </span><span class="ot">=</span><span class="st"> 'host=primary port=5432 user=replicator sslmode=verify-full sslrootcert=/etc/ssl/certs/ca.crt'</span></span></code></pre></div>
<p><strong>SSL Modes</strong>: - <code>disable</code>: No SSL -
<code>allow</code>: Try SSL, fall back to unencrypted -
<code>prefer</code>: Prefer SSL, fall back to unencrypted -
<code>require</code>: Require SSL, any certificate -
<code>verify-ca</code>: Require SSL, verify CA -
<code>verify-full</code>: Require SSL, verify CA and hostname</p>
<hr/>
<h2 data-number="6.15" id="future-directions-1"><span class="header-section-number">6.15</span> 14. Future Directions</h2>
<h3 data-number="6.15.1" id="ongoing-developments"><span class="header-section-number">6.15.1</span> 14.1 Ongoing
Developments</h3>
<p><strong>Logical Replication Enhancements</strong>: - DDL replication
support - Sequence replication improvements - Conflict detection and
resolution - Bi-directional replication improvements</p>
<p><strong>Physical Replication Features</strong>: - Faster catchup
algorithms - Improved synchronous replication performance - Better
compression algorithms</p>
<p><strong>Backup and Recovery</strong>: - Incremental backup support -
Faster backup and restore - Built-in backup verification - Block-level
incremental backups</p>
<h3 data-number="6.15.2" id="postgresql-17-features"><span class="header-section-number">6.15.2</span> 14.2 PostgreSQL 17+
Features</h3>
<p>Recent PostgreSQL versions introduced: - <strong>Logical replication
of sequences</strong>: Replicate sequence state - <strong>Failover
slots</strong>: Automatic slot creation on promoted standby -
<strong>Improved streaming large transactions</strong>: Better memory
management - <strong>Enhanced pg_basebackup</strong>: Better progress
reporting, verification</p>
<hr/>
<h2 data-number="6.16" id="summary-1"><span class="header-section-number">6.16</span> 15. Summary</h2>
<p>PostgreSQL‚Äôs replication and recovery systems provide comprehensive
solutions for high availability, disaster recovery, and data
protection:</p>
<p><strong>Streaming Replication</strong>: - WAL-based physical
replication with minimal lag - WalSender/WalReceiver architecture for
efficient streaming - Synchronous and asynchronous modes for different
guarantees</p>
<p><strong>Logical Replication</strong>: - Table-level selective
replication - Cross-version compatibility - LogicalDecodingContext and
ReorderBuffer for transaction reassembly</p>
<p><strong>Replication Slots</strong>: - Persistent replication position
tracking - WAL retention guarantees - Protection mechanisms against
unbounded growth</p>
<p><strong>Hot Standby</strong>: - Read-only queries during recovery -
Conflict resolution between recovery and queries - Feedback mechanisms
to reduce conflicts</p>
<p><strong>Recovery Mechanisms</strong>: - Crash recovery from last
checkpoint - Point-In-Time Recovery to specific targets - Seven-phase
checkpoint algorithm - Timeline management for recovery branches</p>
<p><strong>pg_basebackup</strong>: - Online backup without blocking -
Integrated WAL streaming - Replication slot integration - Backup
verification capabilities</p>
<p>These systems work together to provide robust, flexible replication
and recovery capabilities suitable for applications ranging from small
single-server deployments to large distributed systems with complex
topologies and stringent availability requirements.</p>
<hr/>
<h2 data-number="6.17" id="references-1"><span class="header-section-number">6.17</span> References</h2>
<p><strong>Source Code Locations</strong>: -
<code>/home/user/postgres/src/include/replication/</code> - Replication
headers - <code>/home/user/postgres/src/backend/replication/</code> -
Replication implementation -
<code>/home/user/postgres/src/backend/access/transam/xlog.c</code> - WAL
and checkpoint code -
<code>/home/user/postgres/src/backend/access/transam/xlogrecovery.c</code>
- Recovery implementation -
<code>/home/user/postgres/src/bin/pg_basebackup/</code> - Backup
tools</p>
<p><strong>Key Data Structures</strong>: - <code>WalSnd</code>
(<code>src/include/replication/walsender_private.h:41</code>) -
<code>WalRcvData</code>
(<code>src/include/replication/walreceiver.h:57</code>) -
<code>ReplicationSlot</code>
(<code>src/include/replication/slot.h:162</code>) -
<code>LogicalDecodingContext</code>
(<code>src/include/replication/logical.h:33</code>) -
<code>ReorderBuffer</code>
(<code>src/include/replication/reorderbuffer.h</code>)</p>
<p><strong>Related Chapters</strong>: - Chapter 1: WAL (Write-Ahead Log)
Architecture - Chapter 2: Storage Management - Chapter 3: Transaction
System - Chapter 5: Query Processing</p>
<hr/>
<p><em>PostgreSQL Encyclopedia - Chapter 4: Replication and Recovery
Systems</em> <em>Edition: PostgreSQL 17 Development (2025)</em></p>
<h1 data-number="7" id="chapter-5-process-architecture"><span class="header-section-number">7</span> Chapter 5: Process
Architecture</h1>
<h2 data-number="7.1" id="introduction-2"><span class="header-section-number">7.1</span> Introduction</h2>
<p>PostgreSQL employs a multi-process architecture rather than a
multi-threaded model, a fundamental design decision that has shaped its
reliability, security, and portability characteristics. This chapter
provides a comprehensive examination of PostgreSQL‚Äôs process model,
covering everything from the postmaster‚Äôs supervisory role to the
intricate details of backend process lifecycle management, inter-process
communication mechanisms, and the client/server protocol.</p>
<p>The process architecture consists of three primary categories: 1.
<strong>Postmaster</strong>: The main supervisor process that manages
all other processes 2. <strong>Backend processes</strong>: Processes
that handle client connections and queries 3. <strong>Auxiliary
processes</strong>: Background workers that perform system maintenance
tasks</p>
<p>This multi-process approach provides strong fault isolation‚Äîa crash
in one backend does not directly corrupt other backends or the
postmaster. Each process operates with its own memory space, and shared
state is managed explicitly through shared memory and well-defined IPC
mechanisms.</p>
<h2 data-number="7.2" id="the-process-model-philosophy"><span class="header-section-number">7.2</span> 1. The Process Model
Philosophy</h2>
<h3 data-number="7.2.1" id="why-multi-process-vs-multi-threading"><span class="header-section-number">7.2.1</span> 1.1 Why Multi-Process vs
Multi-Threading?</h3>
<p>PostgreSQL‚Äôs choice of a multi-process architecture over
multi-threading was deliberate and remains justified by several
factors:</p>
<p><strong>Fault Isolation</strong>: When a backend process crashes due
to a bug or assertion failure, only that process terminates. The
operating system ensures complete cleanup of process resources. In a
multi-threaded model, a single thread‚Äôs corruption could potentially
affect the entire server‚Äôs address space.</p>
<p><strong>Portability</strong>: In the early 1990s when PostgreSQL
(then Postgres95) was being developed, thread implementations varied
significantly across Unix platforms. POSIX threads were not yet
standardized, and thread support on Windows was entirely different. A
process-based model provided consistent behavior across all
platforms.</p>
<p><strong>Security</strong>: Process boundaries provide natural
security isolation. Each backend process can have different effective
privileges, and the kernel enforces memory protection between
processes.</p>
<p><strong>Simplicity</strong>: Programming with processes is often
simpler than thread programming. There‚Äôs no need for fine-grained
locking around every shared data structure, and stack-allocated
variables are naturally thread-local (process-local).</p>
<p><strong>Modern Considerations</strong>: While thread overhead has
decreased on modern systems, PostgreSQL‚Äôs architecture has evolved to
optimize the process model with connection pooling (external tools like
PgBouncer), prepared connections, and efficient process spawning.</p>
<h3 data-number="7.2.2" id="process-hierarchy"><span class="header-section-number">7.2.2</span> 1.2 Process Hierarchy</h3>
<pre><code>postmaster (PID 1234)
‚îú‚îÄ‚îÄ logger (syslogger)
‚îú‚îÄ‚îÄ checkpointer
‚îú‚îÄ‚îÄ background writer
‚îú‚îÄ‚îÄ walwriter
‚îú‚îÄ‚îÄ autovacuum launcher
‚îÇ   ‚îú‚îÄ‚îÄ autovacuum worker 1
‚îÇ   ‚îú‚îÄ‚îÄ autovacuum worker 2
‚îÇ   ‚îî‚îÄ‚îÄ autovacuum worker 3
‚îú‚îÄ‚îÄ archiver (if enabled)
‚îú‚îÄ‚îÄ stats collector
‚îú‚îÄ‚îÄ logical replication launcher
‚îÇ   ‚îú‚îÄ‚îÄ logical replication worker 1
‚îÇ   ‚îî‚îÄ‚îÄ logical replication worker 2
‚îú‚îÄ‚îÄ WAL sender 1 (streaming replication)
‚îú‚îÄ‚îÄ WAL sender 2 (streaming replication)
‚îú‚îÄ‚îÄ backend process (client 1)
‚îú‚îÄ‚îÄ backend process (client 2)
‚îú‚îÄ‚îÄ backend process (client 3)
‚îî‚îÄ‚îÄ parallel worker pool
    ‚îú‚îÄ‚îÄ parallel worker 1
    ‚îú‚îÄ‚îÄ parallel worker 2
    ‚îî‚îÄ‚îÄ parallel worker 3</code></pre>
<p>All processes are children of the postmaster, which serves as the
supervisory process. The postmaster never directly touches shared
memory‚Äîthis isolation ensures that if shared memory becomes corrupted,
the postmaster can detect the problem and initiate recovery.</p>
<h2 data-number="7.3" id="the-postmaster-supervisor-and-guardian"><span class="header-section-number">7.3</span> 2. The Postmaster: Supervisor
and Guardian</h2>
<h3 data-number="7.3.1" id="role-and-responsibilities"><span class="header-section-number">7.3.1</span> 2.1 Role and
Responsibilities</h3>
<p>The postmaster (<code>src/backend/postmaster/postmaster.c</code>) is
the first PostgreSQL process started when the server begins. Its
responsibilities include:</p>
<ol type="1">
<li><strong>Initialization</strong>: Reading configuration files,
validating settings, creating shared memory</li>
<li><strong>Process Spawning</strong>: Launching auxiliary processes and
client backend processes</li>
<li><strong>Connection Management</strong>: Listening for client
connections, authenticating clients</li>
<li><strong>Supervision</strong>: Monitoring child processes, detecting
crashes, coordinating recovery</li>
<li><strong>Shutdown Coordination</strong>: Managing orderly shutdown or
emergency recovery</li>
<li><strong>Signal Handling</strong>: Responding to administrative
signals (SIGHUP, SIGTERM, etc.)</li>
</ol>
<h3 data-number="7.3.2" id="startup-sequence"><span class="header-section-number">7.3.2</span> 2.2 Startup Sequence</h3>
<p>When PostgreSQL starts, the postmaster performs the following
sequence:</p>
<div class="sourceCode" id="cb383"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb383-1"><a aria-hidden="true" href="#cb383-1" tabindex="-1"></a><span class="co">/* Simplified postmaster startup sequence */</span></span>
<span id="cb383-2"><a aria-hidden="true" href="#cb383-2" tabindex="-1"></a></span>
<span id="cb383-3"><a aria-hidden="true" href="#cb383-3" tabindex="-1"></a><span class="fl">1.</span> Parse command<span class="op">-</span>line arguments</span>
<span id="cb383-4"><a aria-hidden="true" href="#cb383-4" tabindex="-1"></a>   <span class="op">-</span> Data directory location <span class="op">(-</span>D<span class="op">)</span></span>
<span id="cb383-5"><a aria-hidden="true" href="#cb383-5" tabindex="-1"></a>   <span class="op">-</span> Configuration file overrides</span>
<span id="cb383-6"><a aria-hidden="true" href="#cb383-6" tabindex="-1"></a>   <span class="op">-</span> Port number <span class="op">(-</span>p<span class="op">)</span></span>
<span id="cb383-7"><a aria-hidden="true" href="#cb383-7" tabindex="-1"></a></span>
<span id="cb383-8"><a aria-hidden="true" href="#cb383-8" tabindex="-1"></a><span class="fl">2.</span> Read postgresql<span class="op">.</span>conf and postgresql<span class="op">.</span><span class="kw">auto</span><span class="op">.</span>conf</span>
<span id="cb383-9"><a aria-hidden="true" href="#cb383-9" tabindex="-1"></a>   <span class="op">-</span> Load all configuration parameters</span>
<span id="cb383-10"><a aria-hidden="true" href="#cb383-10" tabindex="-1"></a>   <span class="op">-</span> Validate settings</span>
<span id="cb383-11"><a aria-hidden="true" href="#cb383-11" tabindex="-1"></a></span>
<span id="cb383-12"><a aria-hidden="true" href="#cb383-12" tabindex="-1"></a><span class="fl">3.</span> Verify data directory</span>
<span id="cb383-13"><a aria-hidden="true" href="#cb383-13" tabindex="-1"></a>   <span class="op">-</span> Check <span class="cf">for</span> postmaster<span class="op">.</span>pid <span class="op">(</span>detect already<span class="op">-</span>running instance<span class="op">)</span></span>
<span id="cb383-14"><a aria-hidden="true" href="#cb383-14" tabindex="-1"></a>   <span class="op">-</span> Verify directory permissions</span>
<span id="cb383-15"><a aria-hidden="true" href="#cb383-15" tabindex="-1"></a>   <span class="op">-</span> Check PostgreSQL version compatibility</span>
<span id="cb383-16"><a aria-hidden="true" href="#cb383-16" tabindex="-1"></a></span>
<span id="cb383-17"><a aria-hidden="true" href="#cb383-17" tabindex="-1"></a><span class="fl">4.</span> Create and attach shared memory</span>
<span id="cb383-18"><a aria-hidden="true" href="#cb383-18" tabindex="-1"></a>   <span class="op">-</span> Calculate shared memory size requirements</span>
<span id="cb383-19"><a aria-hidden="true" href="#cb383-19" tabindex="-1"></a>   <span class="op">-</span> Create System V shared memory segments <span class="op">(</span>or mmap on some platforms<span class="op">)</span></span>
<span id="cb383-20"><a aria-hidden="true" href="#cb383-20" tabindex="-1"></a>   <span class="op">-</span> Initialize shared memory structures</span>
<span id="cb383-21"><a aria-hidden="true" href="#cb383-21" tabindex="-1"></a></span>
<span id="cb383-22"><a aria-hidden="true" href="#cb383-22" tabindex="-1"></a><span class="fl">5.</span> Load pg_hba<span class="op">.</span>conf and pg_ident<span class="op">.</span>conf</span>
<span id="cb383-23"><a aria-hidden="true" href="#cb383-23" tabindex="-1"></a>   <span class="op">-</span> Parse authentication rules</span>
<span id="cb383-24"><a aria-hidden="true" href="#cb383-24" tabindex="-1"></a>   <span class="op">-</span> Build in<span class="op">-</span>memory representation</span>
<span id="cb383-25"><a aria-hidden="true" href="#cb383-25" tabindex="-1"></a></span>
<span id="cb383-26"><a aria-hidden="true" href="#cb383-26" tabindex="-1"></a><span class="fl">6.</span> Open listen sockets</span>
<span id="cb383-27"><a aria-hidden="true" href="#cb383-27" tabindex="-1"></a>   <span class="op">-</span> Bind to configured addresses <span class="op">(</span>listen_addresses<span class="op">)</span></span>
<span id="cb383-28"><a aria-hidden="true" href="#cb383-28" tabindex="-1"></a>   <span class="op">-</span> Listen on configured port <span class="op">(</span><span class="cf">default</span> <span class="dv">5432</span><span class="op">)</span></span>
<span id="cb383-29"><a aria-hidden="true" href="#cb383-29" tabindex="-1"></a>   <span class="op">-</span> Handle Unix domain sockets</span>
<span id="cb383-30"><a aria-hidden="true" href="#cb383-30" tabindex="-1"></a></span>
<span id="cb383-31"><a aria-hidden="true" href="#cb383-31" tabindex="-1"></a><span class="fl">7.</span> Write postmaster<span class="op">.</span>pid file</span>
<span id="cb383-32"><a aria-hidden="true" href="#cb383-32" tabindex="-1"></a>   <span class="op">-</span> Record PID<span class="op">,</span> data directory<span class="op">,</span> port<span class="op">,</span> socket directory</span>
<span id="cb383-33"><a aria-hidden="true" href="#cb383-33" tabindex="-1"></a>   <span class="op">-</span> Used to detect running instance</span>
<span id="cb383-34"><a aria-hidden="true" href="#cb383-34" tabindex="-1"></a></span>
<span id="cb383-35"><a aria-hidden="true" href="#cb383-35" tabindex="-1"></a><span class="fl">8.</span> Start auxiliary processes</span>
<span id="cb383-36"><a aria-hidden="true" href="#cb383-36" tabindex="-1"></a>   <span class="op">-</span> logger <span class="op">(</span><span class="cf">if</span> logging_collector <span class="op">=</span> on<span class="op">)</span></span>
<span id="cb383-37"><a aria-hidden="true" href="#cb383-37" tabindex="-1"></a>   <span class="op">-</span> startup process <span class="op">(</span><span class="cf">for</span> crash recovery or archive recovery<span class="op">)</span></span>
<span id="cb383-38"><a aria-hidden="true" href="#cb383-38" tabindex="-1"></a>   <span class="op">-</span> After recovery completes<span class="op">:</span></span>
<span id="cb383-39"><a aria-hidden="true" href="#cb383-39" tabindex="-1"></a>     <span class="op">*</span> checkpointer</span>
<span id="cb383-40"><a aria-hidden="true" href="#cb383-40" tabindex="-1"></a>     <span class="op">*</span> background writer</span>
<span id="cb383-41"><a aria-hidden="true" href="#cb383-41" tabindex="-1"></a>     <span class="op">*</span> walwriter</span>
<span id="cb383-42"><a aria-hidden="true" href="#cb383-42" tabindex="-1"></a>     <span class="op">*</span> autovacuum launcher</span>
<span id="cb383-43"><a aria-hidden="true" href="#cb383-43" tabindex="-1"></a>     <span class="op">*</span> archiver <span class="op">(</span><span class="cf">if</span> archiving enabled<span class="op">)</span></span>
<span id="cb383-44"><a aria-hidden="true" href="#cb383-44" tabindex="-1"></a>     <span class="op">*</span> stats collector</span>
<span id="cb383-45"><a aria-hidden="true" href="#cb383-45" tabindex="-1"></a>     <span class="op">*</span> logical replication launcher</span>
<span id="cb383-46"><a aria-hidden="true" href="#cb383-46" tabindex="-1"></a></span>
<span id="cb383-47"><a aria-hidden="true" href="#cb383-47" tabindex="-1"></a><span class="fl">9.</span> Enter main event loop</span>
<span id="cb383-48"><a aria-hidden="true" href="#cb383-48" tabindex="-1"></a>   <span class="op">-</span> Accept client connections</span>
<span id="cb383-49"><a aria-hidden="true" href="#cb383-49" tabindex="-1"></a>   <span class="op">-</span> Monitor child processes</span>
<span id="cb383-50"><a aria-hidden="true" href="#cb383-50" tabindex="-1"></a>   <span class="op">-</span> Handle signals</span></code></pre></div>
<h3 data-number="7.3.3" id="the-postmaster-never-touches-shared-memory"><span class="header-section-number">7.3.3</span> 2.3 The Postmaster Never
Touches Shared Memory</h3>
<p>A critical architectural principle: <strong>after initialization, the
postmaster never reads or writes shared memory</strong>. This design
choice has important implications:</p>
<p><strong>Rationale</strong>: - If shared memory becomes corrupted (due
to a bug, hardware error, or malicious action), the postmaster remains
unaffected - The postmaster can detect that something is wrong (child
processes crashing) and initiate recovery - If the postmaster itself
accessed corrupted shared memory, it could crash, leaving no supervisor
to coordinate recovery</p>
<p><strong>Implementation</strong>:</p>
<div class="sourceCode" id="cb384"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb384-1"><a aria-hidden="true" href="#cb384-1" tabindex="-1"></a><span class="co">/* From src/backend/postmaster/postmaster.c */</span></span>
<span id="cb384-2"><a aria-hidden="true" href="#cb384-2" tabindex="-1"></a></span>
<span id="cb384-3"><a aria-hidden="true" href="#cb384-3" tabindex="-1"></a><span class="co">/*</span></span>
<span id="cb384-4"><a aria-hidden="true" href="#cb384-4" tabindex="-1"></a><span class="co"> * The postmaster never accesses shared memory after initialization.</span></span>
<span id="cb384-5"><a aria-hidden="true" href="#cb384-5" tabindex="-1"></a><span class="co"> * All communication with backends is done via:</span></span>
<span id="cb384-6"><a aria-hidden="true" href="#cb384-6" tabindex="-1"></a><span class="co"> * - Process signals (SIGUSR1, SIGUSR2, SIGTERM, etc.)</span></span>
<span id="cb384-7"><a aria-hidden="true" href="#cb384-7" tabindex="-1"></a><span class="co"> * - Exit status of child processes</span></span>
<span id="cb384-8"><a aria-hidden="true" href="#cb384-8" tabindex="-1"></a><span class="co"> * - Pipes for data transfer (e.g., statistics)</span></span>
<span id="cb384-9"><a aria-hidden="true" href="#cb384-9" tabindex="-1"></a><span class="co"> *</span></span>
<span id="cb384-10"><a aria-hidden="true" href="#cb384-10" tabindex="-1"></a><span class="co"> * This isolation ensures the postmaster can always detect and</span></span>
<span id="cb384-11"><a aria-hidden="true" href="#cb384-11" tabindex="-1"></a><span class="co"> * respond to backend crashes.</span></span>
<span id="cb384-12"><a aria-hidden="true" href="#cb384-12" tabindex="-1"></a><span class="co"> */</span></span></code></pre></div>
<p><strong>Communication Mechanisms</strong>: -
<strong>Signals</strong>: The postmaster sends signals to children
(SIGTERM for shutdown, SIGUSR1 for cache invalidation) - <strong>Exit
Status</strong>: The postmaster uses <code>waitpid()</code> to detect
child termination and exit codes - <strong>Pipes</strong>: Some
auxiliary processes (like stats collector) send data to the postmaster
via pipes</p>
<h3 data-number="7.3.4" id="process-spawning"><span class="header-section-number">7.3.4</span> 2.4 Process Spawning</h3>
<p>When a client connects, the postmaster performs the following
steps:</p>
<pre><code>Client Connection Flow:
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                          ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Client  ‚îÇ                          ‚îÇPostmaster ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îò                          ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
     ‚îÇ                                     ‚îÇ
     ‚îÇ 1. TCP connect to port 5432         ‚îÇ
     ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ&gt;‚îÇ
     ‚îÇ                                     ‚îÇ
     ‚îÇ                                     ‚îÇ 2. accept() connection
     ‚îÇ                                     ‚îÇ    - Get client address
     ‚îÇ                                     ‚îÇ    - Check connection limits
     ‚îÇ                                     ‚îÇ    - Create socket
     ‚îÇ                                     ‚îÇ
     ‚îÇ                                     ‚îÇ 3. fork() new backend
     ‚îÇ                                     ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
     ‚îÇ                                     ‚îÇ          ‚îÇ
     ‚îÇ                                     ‚îÇ    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
     ‚îÇ                                     ‚îÇ    ‚îÇ  Backend  ‚îÇ
     ‚îÇ&lt;‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§   Child   ‚îÇ
     ‚îÇ 4. Backend inherits socket          ‚îÇ    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
     ‚îÇ                                     ‚îÇ          ‚îÇ
     ‚îÇ                                     ‚îÇ          ‚îÇ 5. Authenticate
     ‚îÇ                                     ‚îÇ          ‚îÇ    - Check pg_hba.conf
     ‚îÇ&lt;‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§    - Verify credentials
     ‚îÇ 6. Send auth request (e.g., MD5)    ‚îÇ          ‚îÇ
     ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ&gt;‚îÇ
     ‚îÇ 7. Send password hash               ‚îÇ          ‚îÇ
     ‚îÇ                                     ‚îÇ          ‚îÇ 8. Verify password
     ‚îÇ&lt;‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
     ‚îÇ 9. Auth OK, Ready for Query         ‚îÇ          ‚îÇ
     ‚îÇ                                     ‚îÇ          ‚îÇ
     ‚îÇ                                     ‚îÇ          ‚îÇ 10. Enter main loop
     ‚îÇ 11. Query messages                  ‚îÇ          ‚îÇ     - Process queries
     ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ&gt;‚îÇ     - Execute commands
     ‚îÇ&lt;‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§     - Return results
     ‚îÇ 12. Results                         ‚îÇ          ‚îÇ</code></pre>
<p><strong>Key Code Path</strong>
(<code>src/backend/postmaster/postmaster.c</code>):</p>
<div class="sourceCode" id="cb386"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb386-1"><a aria-hidden="true" href="#cb386-1" tabindex="-1"></a><span class="co">/*</span></span>
<span id="cb386-2"><a aria-hidden="true" href="#cb386-2" tabindex="-1"></a><span class="co"> * BackendStartup -- connection setup and authentication</span></span>
<span id="cb386-3"><a aria-hidden="true" href="#cb386-3" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb386-4"><a aria-hidden="true" href="#cb386-4" tabindex="-1"></a><span class="dt">static</span> <span class="dt">int</span></span>
<span id="cb386-5"><a aria-hidden="true" href="#cb386-5" tabindex="-1"></a>BackendStartup<span class="op">(</span>Port <span class="op">*</span>port<span class="op">)</span></span>
<span id="cb386-6"><a aria-hidden="true" href="#cb386-6" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb386-7"><a aria-hidden="true" href="#cb386-7" tabindex="-1"></a>    Backend <span class="op">*</span>bn<span class="op">;</span></span>
<span id="cb386-8"><a aria-hidden="true" href="#cb386-8" tabindex="-1"></a></span>
<span id="cb386-9"><a aria-hidden="true" href="#cb386-9" tabindex="-1"></a>    <span class="co">/* Limit number of concurrent backends */</span></span>
<span id="cb386-10"><a aria-hidden="true" href="#cb386-10" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>CountChildren<span class="op">(</span>BACKEND_TYPE_NORMAL<span class="op">)</span> <span class="op">&gt;=</span> MaxBackends<span class="op">)</span></span>
<span id="cb386-11"><a aria-hidden="true" href="#cb386-11" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb386-12"><a aria-hidden="true" href="#cb386-12" tabindex="-1"></a>        ereport<span class="op">(</span>LOG<span class="op">,</span></span>
<span id="cb386-13"><a aria-hidden="true" href="#cb386-13" tabindex="-1"></a>                <span class="op">(</span>errcode<span class="op">(</span>ERRCODE_TOO_MANY_CONNECTIONS<span class="op">),</span></span>
<span id="cb386-14"><a aria-hidden="true" href="#cb386-14" tabindex="-1"></a>                 errmsg<span class="op">(</span><span class="st">"sorry, too many clients already"</span><span class="op">)));</span></span>
<span id="cb386-15"><a aria-hidden="true" href="#cb386-15" tabindex="-1"></a>        <span class="cf">return</span> STATUS_ERROR<span class="op">;</span></span>
<span id="cb386-16"><a aria-hidden="true" href="#cb386-16" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb386-17"><a aria-hidden="true" href="#cb386-17" tabindex="-1"></a></span>
<span id="cb386-18"><a aria-hidden="true" href="#cb386-18" tabindex="-1"></a>    <span class="co">/* Fork the backend process */</span></span>
<span id="cb386-19"><a aria-hidden="true" href="#cb386-19" tabindex="-1"></a>    bn <span class="op">=</span> <span class="op">(</span>Backend <span class="op">*)</span> malloc<span class="op">(</span><span class="kw">sizeof</span><span class="op">(</span>Backend<span class="op">));</span></span>
<span id="cb386-20"><a aria-hidden="true" href="#cb386-20" tabindex="-1"></a>    bn<span class="op">-&gt;</span>pid <span class="op">=</span> fork_process<span class="op">();</span></span>
<span id="cb386-21"><a aria-hidden="true" href="#cb386-21" tabindex="-1"></a></span>
<span id="cb386-22"><a aria-hidden="true" href="#cb386-22" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>bn<span class="op">-&gt;</span>pid <span class="op">==</span> <span class="dv">0</span><span class="op">)</span>  <span class="co">/* Child process */</span></span>
<span id="cb386-23"><a aria-hidden="true" href="#cb386-23" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb386-24"><a aria-hidden="true" href="#cb386-24" tabindex="-1"></a>        <span class="co">/* Close postmaster's sockets */</span></span>
<span id="cb386-25"><a aria-hidden="true" href="#cb386-25" tabindex="-1"></a>        ClosePostmasterPorts<span class="op">(</span><span class="kw">false</span><span class="op">);</span></span>
<span id="cb386-26"><a aria-hidden="true" href="#cb386-26" tabindex="-1"></a></span>
<span id="cb386-27"><a aria-hidden="true" href="#cb386-27" tabindex="-1"></a>        <span class="co">/* Perform authentication */</span></span>
<span id="cb386-28"><a aria-hidden="true" href="#cb386-28" tabindex="-1"></a>        InitPostgres<span class="op">(</span>port<span class="op">-&gt;</span>database_name<span class="op">,</span> port<span class="op">-&gt;</span>user_name<span class="op">);</span></span>
<span id="cb386-29"><a aria-hidden="true" href="#cb386-29" tabindex="-1"></a></span>
<span id="cb386-30"><a aria-hidden="true" href="#cb386-30" tabindex="-1"></a>        <span class="co">/* Enter main backend loop */</span></span>
<span id="cb386-31"><a aria-hidden="true" href="#cb386-31" tabindex="-1"></a>        PostgresMain<span class="op">(</span>port<span class="op">);</span></span>
<span id="cb386-32"><a aria-hidden="true" href="#cb386-32" tabindex="-1"></a></span>
<span id="cb386-33"><a aria-hidden="true" href="#cb386-33" tabindex="-1"></a>        <span class="co">/* Should not return */</span></span>
<span id="cb386-34"><a aria-hidden="true" href="#cb386-34" tabindex="-1"></a>        proc_exit<span class="op">(</span><span class="dv">0</span><span class="op">);</span></span>
<span id="cb386-35"><a aria-hidden="true" href="#cb386-35" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb386-36"><a aria-hidden="true" href="#cb386-36" tabindex="-1"></a></span>
<span id="cb386-37"><a aria-hidden="true" href="#cb386-37" tabindex="-1"></a>    <span class="co">/* Parent (postmaster) continues */</span></span>
<span id="cb386-38"><a aria-hidden="true" href="#cb386-38" tabindex="-1"></a>    <span class="cf">return</span> STATUS_OK<span class="op">;</span></span>
<span id="cb386-39"><a aria-hidden="true" href="#cb386-39" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 data-number="7.3.5" id="signal-handling"><span class="header-section-number">7.3.5</span> 2.5 Signal Handling</h3>
<p>The postmaster responds to various Unix signals:</p>
<table>
<colgroup>
<col style="width: 32%"/>
<col style="width: 32%"/>
<col style="width: 36%"/>
</colgroup>
<thead>
<tr>
<th>Signal</th>
<th>Action</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>SIGHUP</strong></td>
<td>Reload configuration</td>
<td>Re-reads <code>postgresql.conf</code>, <code>pg_hba.conf</code>, and
<code>pg_ident.conf</code>; signals all children to reload</td>
</tr>
<tr>
<td><strong>SIGTERM</strong></td>
<td>Smart Shutdown</td>
<td>Wait for all clients to disconnect, then shutdown</td>
</tr>
<tr>
<td><strong>SIGINT</strong></td>
<td>Fast Shutdown</td>
<td>Terminate all backends, then shutdown</td>
</tr>
<tr>
<td><strong>SIGQUIT</strong></td>
<td>Immediate Shutdown</td>
<td>Emergency shutdown without cleanup (like a crash)</td>
</tr>
<tr>
<td><strong>SIGUSR1</strong></td>
<td>Internal signaling</td>
<td>Used for inter-process communication (varies by recipient)</td>
</tr>
<tr>
<td><strong>SIGUSR2</strong></td>
<td>Internal signaling</td>
<td>Reserved for future use in some processes</td>
</tr>
<tr>
<td><strong>SIGCHLD</strong></td>
<td>Child process exit</td>
<td>Reap zombie processes, detect crashes</td>
</tr>
</tbody>
</table>
<p><strong>Signal Handler</strong>
(<code>src/backend/postmaster/postmaster.c</code>):</p>
<div class="sourceCode" id="cb387"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb387-1"><a aria-hidden="true" href="#cb387-1" tabindex="-1"></a><span class="co">/*</span></span>
<span id="cb387-2"><a aria-hidden="true" href="#cb387-2" tabindex="-1"></a><span class="co"> * sigusr1_handler -- handle SIGUSR1 from child processes</span></span>
<span id="cb387-3"><a aria-hidden="true" href="#cb387-3" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb387-4"><a aria-hidden="true" href="#cb387-4" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span></span>
<span id="cb387-5"><a aria-hidden="true" href="#cb387-5" tabindex="-1"></a>sigusr1_handler<span class="op">(</span>SIGNAL_ARGS<span class="op">)</span></span>
<span id="cb387-6"><a aria-hidden="true" href="#cb387-6" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb387-7"><a aria-hidden="true" href="#cb387-7" tabindex="-1"></a>    <span class="dt">int</span> save_errno <span class="op">=</span> errno<span class="op">;</span></span>
<span id="cb387-8"><a aria-hidden="true" href="#cb387-8" tabindex="-1"></a></span>
<span id="cb387-9"><a aria-hidden="true" href="#cb387-9" tabindex="-1"></a>    <span class="co">/* Don't process signals during critical sections */</span></span>
<span id="cb387-10"><a aria-hidden="true" href="#cb387-10" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>QueryCancelPending<span class="op">)</span></span>
<span id="cb387-11"><a aria-hidden="true" href="#cb387-11" tabindex="-1"></a>        QueryCancelHoldoffCount<span class="op">++;</span></span>
<span id="cb387-12"><a aria-hidden="true" href="#cb387-12" tabindex="-1"></a></span>
<span id="cb387-13"><a aria-hidden="true" href="#cb387-13" tabindex="-1"></a>    <span class="co">/* Set flag for main loop to check */</span></span>
<span id="cb387-14"><a aria-hidden="true" href="#cb387-14" tabindex="-1"></a>    got_SIGUSR1 <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb387-15"><a aria-hidden="true" href="#cb387-15" tabindex="-1"></a></span>
<span id="cb387-16"><a aria-hidden="true" href="#cb387-16" tabindex="-1"></a>    <span class="co">/* Wake up main loop if it's waiting */</span></span>
<span id="cb387-17"><a aria-hidden="true" href="#cb387-17" tabindex="-1"></a>    SetLatch<span class="op">(</span>MyLatch<span class="op">);</span></span>
<span id="cb387-18"><a aria-hidden="true" href="#cb387-18" tabindex="-1"></a></span>
<span id="cb387-19"><a aria-hidden="true" href="#cb387-19" tabindex="-1"></a>    errno <span class="op">=</span> save_errno<span class="op">;</span></span>
<span id="cb387-20"><a aria-hidden="true" href="#cb387-20" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2 data-number="7.4" id="backend-processes"><span class="header-section-number">7.4</span> 3. Backend Processes</h2>
<h3 data-number="7.4.1" id="backend-process-types"><span class="header-section-number">7.4.1</span> 3.1 Backend Process
Types</h3>
<p>PostgreSQL has 18 different backend process types, each serving a
specific role:</p>
<table>
<colgroup>
<col style="width: 24%"/>
<col style="width: 40%"/>
<col style="width: 36%"/>
</colgroup>
<thead>
<tr>
<th>Type</th>
<th>Constant</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Normal Backend</strong></td>
<td><code>B_BACKEND</code></td>
<td>Handles regular client queries</td>
</tr>
<tr>
<td><strong>Autovacuum Worker</strong></td>
<td><code>B_AUTOVAC_WORKER</code></td>
<td>Performs automatic vacuum and analyze</td>
</tr>
<tr>
<td><strong>Autovacuum Launcher</strong></td>
<td><code>B_AUTOVAC_LAUNCHER</code></td>
<td>Coordinates autovacuum workers</td>
</tr>
<tr>
<td><strong>WAL Sender</strong></td>
<td><code>B_WAL_SENDER</code></td>
<td>Streams WAL to replicas</td>
</tr>
<tr>
<td><strong>WAL Receiver</strong></td>
<td><code>B_WAL_RECEIVER</code></td>
<td>Receives WAL on replica</td>
</tr>
<tr>
<td><strong>WAL Writer</strong></td>
<td><code>B_WAL_WRITER</code></td>
<td>Flushes WAL buffers to disk</td>
</tr>
<tr>
<td><strong>Background Writer</strong></td>
<td><code>B_BG_WRITER</code></td>
<td>Writes dirty buffers to disk</td>
</tr>
<tr>
<td><strong>Checkpointer</strong></td>
<td><code>B_CHECKPOINTER</code></td>
<td>Coordinates checkpoints</td>
</tr>
<tr>
<td><strong>Startup Process</strong></td>
<td><code>B_STARTUP</code></td>
<td>Performs recovery on startup</td>
</tr>
<tr>
<td><strong>Archiver</strong></td>
<td><code>B_ARCHIVER</code></td>
<td>Archives completed WAL files</td>
</tr>
<tr>
<td><strong>Stats Collector</strong></td>
<td><code>B_STATS_COLLECTOR</code></td>
<td>Collects and stores statistics</td>
</tr>
<tr>
<td><strong>Logger</strong></td>
<td><code>B_LOGGER</code></td>
<td>Captures server log output</td>
</tr>
<tr>
<td><strong>Logical Launcher</strong></td>
<td><code>B_LOGICAL_LAUNCHER</code></td>
<td>Manages logical replication workers</td>
</tr>
<tr>
<td><strong>Logical Worker</strong></td>
<td><code>B_LOGICAL_WORKER</code></td>
<td>Applies logical replication changes</td>
</tr>
<tr>
<td><strong>Parallel Worker</strong></td>
<td><code>B_PARALLEL_WORKER</code></td>
<td>Executes parallel query operations</td>
</tr>
<tr>
<td><strong>Standalone Backend</strong></td>
<td><code>B_STANDALONE_BACKEND</code></td>
<td>Single-user mode (no postmaster)</td>
</tr>
<tr>
<td><strong>Background Worker</strong></td>
<td><code>B_BG_WORKER</code></td>
<td>Custom background workers (extensions)</td>
</tr>
<tr>
<td><strong>Slotsync Worker</strong></td>
<td><code>B_SLOTSYNC_WORKER</code></td>
<td>Synchronizes replication slots</td>
</tr>
</tbody>
</table>
<h3 data-number="7.4.2" id="backend-process-lifecycle"><span class="header-section-number">7.4.2</span> 3.2 Backend Process
Lifecycle</h3>
<p>A normal client backend goes through several phases during its
lifetime:</p>
<pre><code>Backend Lifecycle:
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 1. FORK                                                    ‚îÇ
‚îÇ    - Postmaster calls fork()                               ‚îÇ
‚îÇ    - Child process inherits file descriptors               ‚îÇ
‚îÇ    - Child closes postmaster-only descriptors              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
               ‚îÇ
               ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 2. INITIALIZATION                                          ‚îÇ
‚îÇ    - Set process title                                     ‚îÇ
‚îÇ    - Initialize random number generator                    ‚îÇ
‚îÇ    - Setup signal handlers                                 ‚îÇ
‚îÇ    - Attach to shared memory                               ‚îÇ
‚îÇ    - Create process latch                                  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
               ‚îÇ
               ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 3. AUTHENTICATION                                          ‚îÇ
‚îÇ    - Read startup packet from client                       ‚îÇ
‚îÇ    - Check pg_hba.conf rules                               ‚îÇ
‚îÇ    - Perform authentication (password, GSSAPI, etc.)       ‚îÇ
‚îÇ    - Verify database and role exist                        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
               ‚îÇ
               ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 4. INITIALIZATION COMPLETE                                 ‚îÇ
‚îÇ    - Load database-specific catalog info                   ‚îÇ
‚îÇ    - Initialize transaction state                          ‚îÇ
‚îÇ    - Setup memory contexts                                 ‚îÇ
‚îÇ    - Send ReadyForQuery message to client                  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
               ‚îÇ
               ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 5. MAIN LOOP (PostgresMain)                                ‚îÇ
‚îÇ    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê              ‚îÇ
‚îÇ    ‚îÇ Loop:                                  ‚îÇ              ‚îÇ
‚îÇ    ‚îÇ  - Wait for client message             ‚îÇ              ‚îÇ
‚îÇ    ‚îÇ  - Read message type                   ‚îÇ              ‚îÇ
‚îÇ    ‚îÇ  - Dispatch to handler                 ‚îÇ              ‚îÇ
‚îÇ    ‚îÇ    * 'Q': Simple query                 ‚îÇ              ‚îÇ
‚îÇ    ‚îÇ    * 'P': Parse                        ‚îÇ              ‚îÇ
‚îÇ    ‚îÇ    * 'B': Bind                         ‚îÇ              ‚îÇ
‚îÇ    ‚îÇ    * 'E': Execute                      ‚îÇ              ‚îÇ
‚îÇ    ‚îÇ    * 'D': Describe                     ‚îÇ              ‚îÇ
‚îÇ    ‚îÇ    * 'C': Close                        ‚îÇ              ‚îÇ
‚îÇ    ‚îÇ    * 'S': Sync                         ‚îÇ              ‚îÇ
‚îÇ    ‚îÇ    * 'X': Terminate                    ‚îÇ              ‚îÇ
‚îÇ    ‚îÇ  - Execute query                       ‚îÇ              ‚îÇ
‚îÇ    ‚îÇ  - Send results                        ‚îÇ              ‚îÇ
‚îÇ    ‚îÇ  - Send ReadyForQuery                  ‚îÇ              ‚îÇ
‚îÇ    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
               ‚îÇ
               ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 6. SHUTDOWN                                                ‚îÇ
‚îÇ    - Client sends Terminate message                        ‚îÇ
‚îÇ    - OR postmaster signals shutdown                        ‚îÇ
‚îÇ    - Close database connection                             ‚îÇ
‚îÇ    - Release locks                                         ‚îÇ
‚îÇ    - Flush pending output                                  ‚îÇ
‚îÇ    - Detach from shared memory                             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
               ‚îÇ
               ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 7. EXIT                                                    ‚îÇ
‚îÇ    - proc_exit() cleanup                                   ‚îÇ
‚îÇ    - Process terminates                                    ‚îÇ
‚îÇ    - Postmaster reaps zombie process                       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò</code></pre>
<h3 data-number="7.4.3" id="backend-state-machine"><span class="header-section-number">7.4.3</span> 3.3 Backend State
Machine</h3>
<p>Each backend maintains state information that determines what
operations it can perform. The state machine has 13 distinct states:</p>
<pre><code>Backend State Machine (src/include/tcop/tcopprot.h):

STATE_UNDEFINED
    ‚îÇ
    ‚îÇ Backend starts
    ‚îÇ
    ‚ñº
STATE_IDLE ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ                                   ‚îÇ
    ‚îÇ Receive query                     ‚îÇ Query complete
    ‚îÇ                                   ‚îÇ
    ‚ñº                                   ‚îÇ
STATE_RUNNING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
    ‚îÇ                                   ‚îÇ
    ‚îÇ Begin transaction                 ‚îÇ
    ‚îÇ                                   ‚îÇ
    ‚ñº                                   ‚îÇ
STATE_IDLE_IN_TRANSACTION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
    ‚îÇ                                   ‚îÇ
    ‚îÇ Execute in transaction            ‚îÇ
    ‚îÇ                                   ‚îÇ
    ‚ñº                                   ‚îÇ
STATE_RUNNING_IN_TRANSACTION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
    ‚îÇ                                   ‚îÇ
    ‚îÇ Error occurs                      ‚îÇ
    ‚îÇ                                   ‚îÇ
    ‚ñº                                   ‚îÇ
STATE_IDLE_IN_TRANSACTION_ABORTED ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
    ‚îÇ                                   ‚îÇ
    ‚îÇ ROLLBACK                          ‚îÇ
    ‚îÇ                                   ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

Additional specialized states:

STATE_FASTPATH
    - Using fastpath protocol for function calls

STATE_DISABLED
    - Backend is terminating, no new commands accepted

STATE_REPORTING
    - Sending error or notice messages

STATE_COPY_IN
    - Receiving COPY data from client

STATE_COPY_OUT
    - Sending COPY data to client

STATE_COPY_BOTH
    - Bidirectional COPY (for replication)

STATE_PREPARE
    - Preparing a transaction for two-phase commit

STATE_PORTAL_RUNNING
    - Executing a portal (cursor)</code></pre>
<p><strong>State Transitions</strong>
(<code>src/backend/tcop/postgres.c</code>):</p>
<div class="sourceCode" id="cb390"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb390-1"><a aria-hidden="true" href="#cb390-1" tabindex="-1"></a><span class="co">/* Backend state indicators */</span></span>
<span id="cb390-2"><a aria-hidden="true" href="#cb390-2" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">enum</span></span>
<span id="cb390-3"><a aria-hidden="true" href="#cb390-3" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb390-4"><a aria-hidden="true" href="#cb390-4" tabindex="-1"></a>    STATE_UNDEFINED<span class="op">,</span>              <span class="co">/* Bootstrap/initialization */</span></span>
<span id="cb390-5"><a aria-hidden="true" href="#cb390-5" tabindex="-1"></a>    STATE_IDLE<span class="op">,</span>                   <span class="co">/* Waiting for command */</span></span>
<span id="cb390-6"><a aria-hidden="true" href="#cb390-6" tabindex="-1"></a>    STATE_RUNNING<span class="op">,</span>                <span class="co">/* Executing query */</span></span>
<span id="cb390-7"><a aria-hidden="true" href="#cb390-7" tabindex="-1"></a>    STATE_IDLE_IN_TRANSACTION<span class="op">,</span>    <span class="co">/* In transaction, awaiting command */</span></span>
<span id="cb390-8"><a aria-hidden="true" href="#cb390-8" tabindex="-1"></a>    STATE_RUNNING_IN_TRANSACTION<span class="op">,</span> <span class="co">/* Executing query in transaction */</span></span>
<span id="cb390-9"><a aria-hidden="true" href="#cb390-9" tabindex="-1"></a>    STATE_IDLE_IN_TRANSACTION_ABORTED<span class="op">,</span> <span class="co">/* Transaction failed, awaiting ROLLBACK */</span></span>
<span id="cb390-10"><a aria-hidden="true" href="#cb390-10" tabindex="-1"></a>    STATE_FASTPATH<span class="op">,</span>               <span class="co">/* Executing fastpath function */</span></span>
<span id="cb390-11"><a aria-hidden="true" href="#cb390-11" tabindex="-1"></a>    STATE_DISABLED                <span class="co">/* Backend shutting down */</span></span>
<span id="cb390-12"><a aria-hidden="true" href="#cb390-12" tabindex="-1"></a><span class="op">}</span> BackendState<span class="op">;</span></span>
<span id="cb390-13"><a aria-hidden="true" href="#cb390-13" tabindex="-1"></a></span>
<span id="cb390-14"><a aria-hidden="true" href="#cb390-14" tabindex="-1"></a><span class="co">/* Change backend state and update ps display */</span></span>
<span id="cb390-15"><a aria-hidden="true" href="#cb390-15" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span></span>
<span id="cb390-16"><a aria-hidden="true" href="#cb390-16" tabindex="-1"></a>set_ps_display<span class="op">(</span><span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>activity<span class="op">)</span></span>
<span id="cb390-17"><a aria-hidden="true" href="#cb390-17" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb390-18"><a aria-hidden="true" href="#cb390-18" tabindex="-1"></a>    <span class="co">/* Update process title visible in ps/top */</span></span>
<span id="cb390-19"><a aria-hidden="true" href="#cb390-19" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>update_process_title<span class="op">)</span></span>
<span id="cb390-20"><a aria-hidden="true" href="#cb390-20" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb390-21"><a aria-hidden="true" href="#cb390-21" tabindex="-1"></a>        <span class="dt">char</span> <span class="op">*</span>display_string<span class="op">;</span></span>
<span id="cb390-22"><a aria-hidden="true" href="#cb390-22" tabindex="-1"></a></span>
<span id="cb390-23"><a aria-hidden="true" href="#cb390-23" tabindex="-1"></a>        display_string <span class="op">=</span> psprintf<span class="op">(</span><span class="st">"</span><span class="sc">%s</span><span class="st"> </span><span class="sc">%s</span><span class="st"> </span><span class="sc">%s</span><span class="st"> </span><span class="sc">%s</span><span class="st">"</span><span class="op">,</span></span>
<span id="cb390-24"><a aria-hidden="true" href="#cb390-24" tabindex="-1"></a>                                  MyProcPort<span class="op">-&gt;</span>user_name<span class="op">,</span></span>
<span id="cb390-25"><a aria-hidden="true" href="#cb390-25" tabindex="-1"></a>                                  MyProcPort<span class="op">-&gt;</span>database_name<span class="op">,</span></span>
<span id="cb390-26"><a aria-hidden="true" href="#cb390-26" tabindex="-1"></a>                                  get_backend_state_string<span class="op">(),</span></span>
<span id="cb390-27"><a aria-hidden="true" href="#cb390-27" tabindex="-1"></a>                                  activity<span class="op">);</span></span>
<span id="cb390-28"><a aria-hidden="true" href="#cb390-28" tabindex="-1"></a></span>
<span id="cb390-29"><a aria-hidden="true" href="#cb390-29" tabindex="-1"></a>        set_ps_display_string<span class="op">(</span>display_string<span class="op">);</span></span>
<span id="cb390-30"><a aria-hidden="true" href="#cb390-30" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb390-31"><a aria-hidden="true" href="#cb390-31" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 data-number="7.4.4" id="main-backend-loop"><span class="header-section-number">7.4.4</span> 3.4 Main Backend Loop</h3>
<p>The heart of a backend process is the <code>PostgresMain</code>
function:</p>
<div class="sourceCode" id="cb391"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb391-1"><a aria-hidden="true" href="#cb391-1" tabindex="-1"></a><span class="co">/* Simplified PostgresMain from src/backend/tcop/postgres.c */</span></span>
<span id="cb391-2"><a aria-hidden="true" href="#cb391-2" tabindex="-1"></a></span>
<span id="cb391-3"><a aria-hidden="true" href="#cb391-3" tabindex="-1"></a><span class="dt">void</span></span>
<span id="cb391-4"><a aria-hidden="true" href="#cb391-4" tabindex="-1"></a>PostgresMain<span class="op">(</span><span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>dbname<span class="op">,</span> <span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>username<span class="op">)</span></span>
<span id="cb391-5"><a aria-hidden="true" href="#cb391-5" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb391-6"><a aria-hidden="true" href="#cb391-6" tabindex="-1"></a>    sigjmp_buf  local_sigjmp_buf<span class="op">;</span></span>
<span id="cb391-7"><a aria-hidden="true" href="#cb391-7" tabindex="-1"></a></span>
<span id="cb391-8"><a aria-hidden="true" href="#cb391-8" tabindex="-1"></a>    <span class="co">/* Setup signal handlers */</span></span>
<span id="cb391-9"><a aria-hidden="true" href="#cb391-9" tabindex="-1"></a>    pqsignal<span class="op">(</span>SIGHUP<span class="op">,</span> PostgresSigHupHandler<span class="op">);</span></span>
<span id="cb391-10"><a aria-hidden="true" href="#cb391-10" tabindex="-1"></a>    pqsignal<span class="op">(</span>SIGINT<span class="op">,</span> StatementCancelHandler<span class="op">);</span></span>
<span id="cb391-11"><a aria-hidden="true" href="#cb391-11" tabindex="-1"></a>    pqsignal<span class="op">(</span>SIGTERM<span class="op">,</span> die<span class="op">);</span></span>
<span id="cb391-12"><a aria-hidden="true" href="#cb391-12" tabindex="-1"></a>    pqsignal<span class="op">(</span>SIGUSR1<span class="op">,</span> procsignal_sigusr1_handler<span class="op">);</span></span>
<span id="cb391-13"><a aria-hidden="true" href="#cb391-13" tabindex="-1"></a></span>
<span id="cb391-14"><a aria-hidden="true" href="#cb391-14" tabindex="-1"></a>    <span class="co">/* Initialize backend */</span></span>
<span id="cb391-15"><a aria-hidden="true" href="#cb391-15" tabindex="-1"></a>    InitPostgres<span class="op">(</span>dbname<span class="op">,</span> InvalidOid<span class="op">,</span> username<span class="op">,</span> InvalidOid<span class="op">,</span> NULL<span class="op">,</span> <span class="kw">false</span><span class="op">);</span></span>
<span id="cb391-16"><a aria-hidden="true" href="#cb391-16" tabindex="-1"></a></span>
<span id="cb391-17"><a aria-hidden="true" href="#cb391-17" tabindex="-1"></a>    <span class="co">/* Setup error recovery point */</span></span>
<span id="cb391-18"><a aria-hidden="true" href="#cb391-18" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>sigsetjmp<span class="op">(</span>local_sigjmp_buf<span class="op">,</span> <span class="dv">1</span><span class="op">)</span> <span class="op">!=</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb391-19"><a aria-hidden="true" href="#cb391-19" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb391-20"><a aria-hidden="true" href="#cb391-20" tabindex="-1"></a>        <span class="co">/* Error recovery: clean up and return to main loop */</span></span>
<span id="cb391-21"><a aria-hidden="true" href="#cb391-21" tabindex="-1"></a>        error_context_stack <span class="op">=</span> NULL<span class="op">;</span></span>
<span id="cb391-22"><a aria-hidden="true" href="#cb391-22" tabindex="-1"></a>        EmitErrorReport<span class="op">();</span></span>
<span id="cb391-23"><a aria-hidden="true" href="#cb391-23" tabindex="-1"></a>        FlushErrorState<span class="op">();</span></span>
<span id="cb391-24"><a aria-hidden="true" href="#cb391-24" tabindex="-1"></a>        AbortCurrentTransaction<span class="op">();</span></span>
<span id="cb391-25"><a aria-hidden="true" href="#cb391-25" tabindex="-1"></a>        MemoryContextSwitchTo<span class="op">(</span>TopMemoryContext<span class="op">);</span></span>
<span id="cb391-26"><a aria-hidden="true" href="#cb391-26" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb391-27"><a aria-hidden="true" href="#cb391-27" tabindex="-1"></a></span>
<span id="cb391-28"><a aria-hidden="true" href="#cb391-28" tabindex="-1"></a>    <span class="co">/* Send ready for query */</span></span>
<span id="cb391-29"><a aria-hidden="true" href="#cb391-29" tabindex="-1"></a>    ReadyForQuery<span class="op">(</span>DestRemote<span class="op">);</span></span>
<span id="cb391-30"><a aria-hidden="true" href="#cb391-30" tabindex="-1"></a></span>
<span id="cb391-31"><a aria-hidden="true" href="#cb391-31" tabindex="-1"></a>    <span class="co">/* Main message loop */</span></span>
<span id="cb391-32"><a aria-hidden="true" href="#cb391-32" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(;;)</span></span>
<span id="cb391-33"><a aria-hidden="true" href="#cb391-33" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb391-34"><a aria-hidden="true" href="#cb391-34" tabindex="-1"></a>        <span class="dt">int</span> firstchar<span class="op">;</span></span>
<span id="cb391-35"><a aria-hidden="true" href="#cb391-35" tabindex="-1"></a></span>
<span id="cb391-36"><a aria-hidden="true" href="#cb391-36" tabindex="-1"></a>        <span class="co">/* Release storage left over from prior query cycle */</span></span>
<span id="cb391-37"><a aria-hidden="true" href="#cb391-37" tabindex="-1"></a>        MemoryContextResetAndDeleteChildren<span class="op">(</span>MessageContext<span class="op">);</span></span>
<span id="cb391-38"><a aria-hidden="true" href="#cb391-38" tabindex="-1"></a></span>
<span id="cb391-39"><a aria-hidden="true" href="#cb391-39" tabindex="-1"></a>        <span class="co">/* Report idle status to stats collector */</span></span>
<span id="cb391-40"><a aria-hidden="true" href="#cb391-40" tabindex="-1"></a>        pgstat_report_activity<span class="op">(</span>STATE_IDLE<span class="op">,</span> NULL<span class="op">);</span></span>
<span id="cb391-41"><a aria-hidden="true" href="#cb391-41" tabindex="-1"></a></span>
<span id="cb391-42"><a aria-hidden="true" href="#cb391-42" tabindex="-1"></a>        <span class="co">/* Wait for client message */</span></span>
<span id="cb391-43"><a aria-hidden="true" href="#cb391-43" tabindex="-1"></a>        firstchar <span class="op">=</span> ReadCommand<span class="op">();</span></span>
<span id="cb391-44"><a aria-hidden="true" href="#cb391-44" tabindex="-1"></a></span>
<span id="cb391-45"><a aria-hidden="true" href="#cb391-45" tabindex="-1"></a>        <span class="cf">switch</span> <span class="op">(</span>firstchar<span class="op">)</span></span>
<span id="cb391-46"><a aria-hidden="true" href="#cb391-46" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb391-47"><a aria-hidden="true" href="#cb391-47" tabindex="-1"></a>            <span class="cf">case</span> <span class="ch">'Q'</span><span class="op">:</span>  <span class="co">/* Simple query */</span></span>
<span id="cb391-48"><a aria-hidden="true" href="#cb391-48" tabindex="-1"></a>                <span class="op">{</span></span>
<span id="cb391-49"><a aria-hidden="true" href="#cb391-49" tabindex="-1"></a>                    <span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>query_string<span class="op">;</span></span>
<span id="cb391-50"><a aria-hidden="true" href="#cb391-50" tabindex="-1"></a></span>
<span id="cb391-51"><a aria-hidden="true" href="#cb391-51" tabindex="-1"></a>                    query_string <span class="op">=</span> pq_getmsgstring<span class="op">();</span></span>
<span id="cb391-52"><a aria-hidden="true" href="#cb391-52" tabindex="-1"></a>                    pq_getmsgend<span class="op">();</span></span>
<span id="cb391-53"><a aria-hidden="true" href="#cb391-53" tabindex="-1"></a></span>
<span id="cb391-54"><a aria-hidden="true" href="#cb391-54" tabindex="-1"></a>                    exec_simple_query<span class="op">(</span>query_string<span class="op">);</span></span>
<span id="cb391-55"><a aria-hidden="true" href="#cb391-55" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb391-56"><a aria-hidden="true" href="#cb391-56" tabindex="-1"></a>                <span class="cf">break</span><span class="op">;</span></span>
<span id="cb391-57"><a aria-hidden="true" href="#cb391-57" tabindex="-1"></a></span>
<span id="cb391-58"><a aria-hidden="true" href="#cb391-58" tabindex="-1"></a>            <span class="cf">case</span> <span class="ch">'P'</span><span class="op">:</span>  <span class="co">/* Parse */</span></span>
<span id="cb391-59"><a aria-hidden="true" href="#cb391-59" tabindex="-1"></a>                exec_parse_message<span class="op">();</span></span>
<span id="cb391-60"><a aria-hidden="true" href="#cb391-60" tabindex="-1"></a>                <span class="cf">break</span><span class="op">;</span></span>
<span id="cb391-61"><a aria-hidden="true" href="#cb391-61" tabindex="-1"></a></span>
<span id="cb391-62"><a aria-hidden="true" href="#cb391-62" tabindex="-1"></a>            <span class="cf">case</span> <span class="ch">'B'</span><span class="op">:</span>  <span class="co">/* Bind */</span></span>
<span id="cb391-63"><a aria-hidden="true" href="#cb391-63" tabindex="-1"></a>                exec_bind_message<span class="op">();</span></span>
<span id="cb391-64"><a aria-hidden="true" href="#cb391-64" tabindex="-1"></a>                <span class="cf">break</span><span class="op">;</span></span>
<span id="cb391-65"><a aria-hidden="true" href="#cb391-65" tabindex="-1"></a></span>
<span id="cb391-66"><a aria-hidden="true" href="#cb391-66" tabindex="-1"></a>            <span class="cf">case</span> <span class="ch">'E'</span><span class="op">:</span>  <span class="co">/* Execute */</span></span>
<span id="cb391-67"><a aria-hidden="true" href="#cb391-67" tabindex="-1"></a>                exec_execute_message<span class="op">();</span></span>
<span id="cb391-68"><a aria-hidden="true" href="#cb391-68" tabindex="-1"></a>                <span class="cf">break</span><span class="op">;</span></span>
<span id="cb391-69"><a aria-hidden="true" href="#cb391-69" tabindex="-1"></a></span>
<span id="cb391-70"><a aria-hidden="true" href="#cb391-70" tabindex="-1"></a>            <span class="cf">case</span> <span class="ch">'D'</span><span class="op">:</span>  <span class="co">/* Describe */</span></span>
<span id="cb391-71"><a aria-hidden="true" href="#cb391-71" tabindex="-1"></a>                exec_describe_message<span class="op">();</span></span>
<span id="cb391-72"><a aria-hidden="true" href="#cb391-72" tabindex="-1"></a>                <span class="cf">break</span><span class="op">;</span></span>
<span id="cb391-73"><a aria-hidden="true" href="#cb391-73" tabindex="-1"></a></span>
<span id="cb391-74"><a aria-hidden="true" href="#cb391-74" tabindex="-1"></a>            <span class="cf">case</span> <span class="ch">'C'</span><span class="op">:</span>  <span class="co">/* Close */</span></span>
<span id="cb391-75"><a aria-hidden="true" href="#cb391-75" tabindex="-1"></a>                exec_close_message<span class="op">();</span></span>
<span id="cb391-76"><a aria-hidden="true" href="#cb391-76" tabindex="-1"></a>                <span class="cf">break</span><span class="op">;</span></span>
<span id="cb391-77"><a aria-hidden="true" href="#cb391-77" tabindex="-1"></a></span>
<span id="cb391-78"><a aria-hidden="true" href="#cb391-78" tabindex="-1"></a>            <span class="cf">case</span> <span class="ch">'S'</span><span class="op">:</span>  <span class="co">/* Sync */</span></span>
<span id="cb391-79"><a aria-hidden="true" href="#cb391-79" tabindex="-1"></a>                finish_xact_command<span class="op">();</span></span>
<span id="cb391-80"><a aria-hidden="true" href="#cb391-80" tabindex="-1"></a>                ReadyForQuery<span class="op">(</span>DestRemote<span class="op">);</span></span>
<span id="cb391-81"><a aria-hidden="true" href="#cb391-81" tabindex="-1"></a>                <span class="cf">break</span><span class="op">;</span></span>
<span id="cb391-82"><a aria-hidden="true" href="#cb391-82" tabindex="-1"></a></span>
<span id="cb391-83"><a aria-hidden="true" href="#cb391-83" tabindex="-1"></a>            <span class="cf">case</span> <span class="ch">'X'</span><span class="op">:</span>  <span class="co">/* Terminate */</span></span>
<span id="cb391-84"><a aria-hidden="true" href="#cb391-84" tabindex="-1"></a>                proc_exit<span class="op">(</span><span class="dv">0</span><span class="op">);</span></span>
<span id="cb391-85"><a aria-hidden="true" href="#cb391-85" tabindex="-1"></a>                <span class="cf">break</span><span class="op">;</span></span>
<span id="cb391-86"><a aria-hidden="true" href="#cb391-86" tabindex="-1"></a></span>
<span id="cb391-87"><a aria-hidden="true" href="#cb391-87" tabindex="-1"></a>            <span class="cf">default</span><span class="op">:</span></span>
<span id="cb391-88"><a aria-hidden="true" href="#cb391-88" tabindex="-1"></a>                ereport<span class="op">(</span>FATAL<span class="op">,</span></span>
<span id="cb391-89"><a aria-hidden="true" href="#cb391-89" tabindex="-1"></a>                        <span class="op">(</span>errcode<span class="op">(</span>ERRCODE_PROTOCOL_VIOLATION<span class="op">),</span></span>
<span id="cb391-90"><a aria-hidden="true" href="#cb391-90" tabindex="-1"></a>                         errmsg<span class="op">(</span><span class="st">"invalid frontend message type </span><span class="sc">%d</span><span class="st">"</span><span class="op">,</span></span>
<span id="cb391-91"><a aria-hidden="true" href="#cb391-91" tabindex="-1"></a>                                firstchar<span class="op">)));</span></span>
<span id="cb391-92"><a aria-hidden="true" href="#cb391-92" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb391-93"><a aria-hidden="true" href="#cb391-93" tabindex="-1"></a>    <span class="op">}</span> <span class="co">/* end of message loop */</span></span>
<span id="cb391-94"><a aria-hidden="true" href="#cb391-94" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2 data-number="7.5" id="auxiliary-processes"><span class="header-section-number">7.5</span> 4. Auxiliary Processes</h2>
<p>Auxiliary processes are system background workers that perform
essential maintenance and housekeeping tasks. Unlike client backends,
they do not serve client connections.</p>
<h3 data-number="7.5.1" id="background-writer-bgwriter"><span class="header-section-number">7.5.1</span> 4.1 Background Writer
(bgwriter)</h3>
<p><strong>Purpose</strong>: Gradually writes dirty buffers to disk to
reduce checkpoint I/O spikes.</p>
<p><strong>Location</strong>:
<code>src/backend/postmaster/bgwriter.c</code></p>
<p><strong>Algorithm</strong>:</p>
<pre><code>Loop forever:
    1. Sleep for bgwriter_delay milliseconds (default 200ms)
    2. Scan shared buffer pool
    3. Identify dirty buffers that are:
       - Not recently modified
       - Not pinned by any backend
    4. Write up to bgwriter_lru_maxpages buffers (default 100)
    5. If too many buffers written, sleep longer (adaptive)
    6. Update statistics</code></pre>
<p><strong>Configuration Parameters</strong>: -
<code>bgwriter_delay</code>: Time between rounds (default 200ms) -
<code>bgwriter_lru_maxpages</code>: Maximum buffers to write per round
(default 100) - <code>bgwriter_lru_multiplier</code>: Multiplier for
average recent usage (default 2.0)</p>
<p><strong>Key Code</strong>:</p>
<div class="sourceCode" id="cb393"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb393-1"><a aria-hidden="true" href="#cb393-1" tabindex="-1"></a><span class="co">/* Main loop of background writer process */</span></span>
<span id="cb393-2"><a aria-hidden="true" href="#cb393-2" tabindex="-1"></a><span class="dt">void</span></span>
<span id="cb393-3"><a aria-hidden="true" href="#cb393-3" tabindex="-1"></a>BackgroundWriterMain<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb393-4"><a aria-hidden="true" href="#cb393-4" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb393-5"><a aria-hidden="true" href="#cb393-5" tabindex="-1"></a>    sigjmp_buf local_sigjmp_buf<span class="op">;</span></span>
<span id="cb393-6"><a aria-hidden="true" href="#cb393-6" tabindex="-1"></a></span>
<span id="cb393-7"><a aria-hidden="true" href="#cb393-7" tabindex="-1"></a>    <span class="co">/* Identify as bgwriter process */</span></span>
<span id="cb393-8"><a aria-hidden="true" href="#cb393-8" tabindex="-1"></a>    MyBackendType <span class="op">=</span> B_BG_WRITER<span class="op">;</span></span>
<span id="cb393-9"><a aria-hidden="true" href="#cb393-9" tabindex="-1"></a></span>
<span id="cb393-10"><a aria-hidden="true" href="#cb393-10" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(;;)</span></span>
<span id="cb393-11"><a aria-hidden="true" href="#cb393-11" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb393-12"><a aria-hidden="true" href="#cb393-12" tabindex="-1"></a>        <span class="dt">long</span>    cur_timeout<span class="op">;</span></span>
<span id="cb393-13"><a aria-hidden="true" href="#cb393-13" tabindex="-1"></a>        <span class="dt">int</span>     rc<span class="op">;</span></span>
<span id="cb393-14"><a aria-hidden="true" href="#cb393-14" tabindex="-1"></a></span>
<span id="cb393-15"><a aria-hidden="true" href="#cb393-15" tabindex="-1"></a>        <span class="co">/* Clear any already-pending wakeups */</span></span>
<span id="cb393-16"><a aria-hidden="true" href="#cb393-16" tabindex="-1"></a>        ResetLatch<span class="op">(</span>MyLatch<span class="op">);</span></span>
<span id="cb393-17"><a aria-hidden="true" href="#cb393-17" tabindex="-1"></a></span>
<span id="cb393-18"><a aria-hidden="true" href="#cb393-18" tabindex="-1"></a>        <span class="co">/* Perform buffer writing */</span></span>
<span id="cb393-19"><a aria-hidden="true" href="#cb393-19" tabindex="-1"></a>        BgBufferSync<span class="op">();</span></span>
<span id="cb393-20"><a aria-hidden="true" href="#cb393-20" tabindex="-1"></a></span>
<span id="cb393-21"><a aria-hidden="true" href="#cb393-21" tabindex="-1"></a>        <span class="co">/* Sleep for bgwriter_delay, or until signaled */</span></span>
<span id="cb393-22"><a aria-hidden="true" href="#cb393-22" tabindex="-1"></a>        cur_timeout <span class="op">=</span> BgWriterDelay<span class="op">;</span></span>
<span id="cb393-23"><a aria-hidden="true" href="#cb393-23" tabindex="-1"></a>        rc <span class="op">=</span> WaitLatch<span class="op">(</span>MyLatch<span class="op">,</span></span>
<span id="cb393-24"><a aria-hidden="true" href="#cb393-24" tabindex="-1"></a>                      WL_LATCH_SET <span class="op">|</span> WL_TIMEOUT <span class="op">|</span> WL_POSTMASTER_DEATH<span class="op">,</span></span>
<span id="cb393-25"><a aria-hidden="true" href="#cb393-25" tabindex="-1"></a>                      cur_timeout<span class="op">,</span></span>
<span id="cb393-26"><a aria-hidden="true" href="#cb393-26" tabindex="-1"></a>                      WAIT_EVENT_BGWRITER_MAIN<span class="op">);</span></span>
<span id="cb393-27"><a aria-hidden="true" href="#cb393-27" tabindex="-1"></a></span>
<span id="cb393-28"><a aria-hidden="true" href="#cb393-28" tabindex="-1"></a>        <span class="co">/* Emergency bailout if postmaster died */</span></span>
<span id="cb393-29"><a aria-hidden="true" href="#cb393-29" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>rc <span class="op">&amp;</span> WL_POSTMASTER_DEATH<span class="op">)</span></span>
<span id="cb393-30"><a aria-hidden="true" href="#cb393-30" tabindex="-1"></a>            proc_exit<span class="op">(</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb393-31"><a aria-hidden="true" href="#cb393-31" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb393-32"><a aria-hidden="true" href="#cb393-32" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 data-number="7.5.2" id="checkpointer"><span class="header-section-number">7.5.2</span> 4.2 Checkpointer</h3>
<p><strong>Purpose</strong>: Performs checkpoints‚Äîflushes all dirty
buffers to disk and writes a checkpoint record to WAL.</p>
<p><strong>Location</strong>:
<code>src/backend/postmaster/checkpointer.c</code></p>
<p><strong>Checkpoint Process</strong>:</p>
<pre><code>Checkpoint Algorithm:
1. Wait for checkpoint trigger:
   - checkpoint_timeout expired (default 5 minutes)
   - WAL segments reached max_wal_size
   - Manual CHECKPOINT command
   - Database shutdown

2. Begin checkpoint:
   - Update checkpoint state in shared memory
   - Write checkpoint start record to WAL

3. Flush all dirty buffers:
   - Scan entire buffer pool
   - Write all dirty buffers to disk
   - Spread writes over checkpoint_completion_target period
   - Throttle I/O to avoid overwhelming disk

4. Flush WAL:
   - Ensure all WAL up to checkpoint is on disk

5. Update control file:
   - Write checkpoint location to pg_control
   - fsync control file

6. Cleanup:
   - Remove old WAL files (if not needed for archiving/replication)
   - Update statistics</code></pre>
<p><strong>Configuration Parameters</strong>: -
<code>checkpoint_timeout</code>: Maximum time between automatic
checkpoints (default 5min) - <code>max_wal_size</code>: Checkpoint
triggered when WAL exceeds this (default 1GB) -
<code>min_wal_size</code>: Keep at least this much WAL (default 80MB) -
<code>checkpoint_completion_target</code>: Fraction of interval to
spread checkpoint (default 0.9) - <code>checkpoint_warning</code>: Warn
if checkpoints happen closer than this (default 30s)</p>
<p><strong>Key Code</strong>:</p>
<div class="sourceCode" id="cb395"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb395-1"><a aria-hidden="true" href="#cb395-1" tabindex="-1"></a><span class="co">/* Perform a checkpoint */</span></span>
<span id="cb395-2"><a aria-hidden="true" href="#cb395-2" tabindex="-1"></a><span class="dt">void</span></span>
<span id="cb395-3"><a aria-hidden="true" href="#cb395-3" tabindex="-1"></a>CreateCheckPoint<span class="op">(</span><span class="dt">int</span> flags<span class="op">)</span></span>
<span id="cb395-4"><a aria-hidden="true" href="#cb395-4" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb395-5"><a aria-hidden="true" href="#cb395-5" tabindex="-1"></a>    CheckPoint  checkPoint<span class="op">;</span></span>
<span id="cb395-6"><a aria-hidden="true" href="#cb395-6" tabindex="-1"></a>    XLogRecPtr  recptr<span class="op">;</span></span>
<span id="cb395-7"><a aria-hidden="true" href="#cb395-7" tabindex="-1"></a></span>
<span id="cb395-8"><a aria-hidden="true" href="#cb395-8" tabindex="-1"></a>    <span class="co">/* Initialize checkpoint record */</span></span>
<span id="cb395-9"><a aria-hidden="true" href="#cb395-9" tabindex="-1"></a>    MemSet<span class="op">(&amp;</span>checkPoint<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>checkPoint<span class="op">));</span></span>
<span id="cb395-10"><a aria-hidden="true" href="#cb395-10" tabindex="-1"></a>    checkPoint<span class="op">.</span>time <span class="op">=</span> <span class="op">(</span>pg_time_t<span class="op">)</span> time<span class="op">(</span>NULL<span class="op">);</span></span>
<span id="cb395-11"><a aria-hidden="true" href="#cb395-11" tabindex="-1"></a></span>
<span id="cb395-12"><a aria-hidden="true" href="#cb395-12" tabindex="-1"></a>    <span class="co">/* Write checkpoint start WAL record */</span></span>
<span id="cb395-13"><a aria-hidden="true" href="#cb395-13" tabindex="-1"></a>    recptr <span class="op">=</span> XLogInsert<span class="op">(</span>RM_XLOG_ID<span class="op">,</span> XLOG_CHECKPOINT_ONLINE<span class="op">);</span></span>
<span id="cb395-14"><a aria-hidden="true" href="#cb395-14" tabindex="-1"></a></span>
<span id="cb395-15"><a aria-hidden="true" href="#cb395-15" tabindex="-1"></a>    <span class="co">/* Flush all dirty buffers to disk */</span></span>
<span id="cb395-16"><a aria-hidden="true" href="#cb395-16" tabindex="-1"></a>    CheckPointBuffers<span class="op">(</span>flags<span class="op">);</span></span>
<span id="cb395-17"><a aria-hidden="true" href="#cb395-17" tabindex="-1"></a></span>
<span id="cb395-18"><a aria-hidden="true" href="#cb395-18" tabindex="-1"></a>    <span class="co">/* Flush WAL to disk */</span></span>
<span id="cb395-19"><a aria-hidden="true" href="#cb395-19" tabindex="-1"></a>    XLogFlush<span class="op">(</span>recptr<span class="op">);</span></span>
<span id="cb395-20"><a aria-hidden="true" href="#cb395-20" tabindex="-1"></a></span>
<span id="cb395-21"><a aria-hidden="true" href="#cb395-21" tabindex="-1"></a>    <span class="co">/* Update control file with checkpoint location */</span></span>
<span id="cb395-22"><a aria-hidden="true" href="#cb395-22" tabindex="-1"></a>    UpdateControlFile<span class="op">();</span></span>
<span id="cb395-23"><a aria-hidden="true" href="#cb395-23" tabindex="-1"></a></span>
<span id="cb395-24"><a aria-hidden="true" href="#cb395-24" tabindex="-1"></a>    <span class="co">/* Cleanup old WAL files */</span></span>
<span id="cb395-25"><a aria-hidden="true" href="#cb395-25" tabindex="-1"></a>    RemoveOldXlogFiles<span class="op">();</span></span>
<span id="cb395-26"><a aria-hidden="true" href="#cb395-26" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 data-number="7.5.3" id="wal-writer"><span class="header-section-number">7.5.3</span> 4.3 WAL Writer</h3>
<p><strong>Purpose</strong>: Flushes WAL buffers to disk periodically,
independent of transaction commits.</p>
<p><strong>Location</strong>:
<code>src/backend/postmaster/walwriter.c</code></p>
<p><strong>Rationale</strong>: - Reduces latency for commits (WAL may
already be flushed) - Ensures WAL is persistent even if backend crashes
before commit - Provides more predictable I/O patterns</p>
<p><strong>Algorithm</strong>:</p>
<pre><code>Loop forever:
    1. Sleep for wal_writer_delay milliseconds (default 200ms)
    2. Check if there are unflushed WAL records
    3. If yes:
       - Call XLogBackgroundFlush()
       - Write unflushed WAL to disk
       - fsync WAL files
    4. Update statistics</code></pre>
<p><strong>Configuration</strong>: - <code>wal_writer_delay</code>: Time
between WAL flushes (default 200ms) -
<code>wal_writer_flush_after</code>: Amount of WAL to write before
flushing (default 1MB)</p>
<h3 data-number="7.5.4" id="autovacuum-launcher-and-workers"><span class="header-section-number">7.5.4</span> 4.4 Autovacuum Launcher and
Workers</h3>
<p><strong>Purpose</strong>: Automatically vacuum and analyze tables to
reclaim space and update statistics.</p>
<p><strong>Location</strong>:
<code>src/backend/postmaster/autovacuum.c</code></p>
<p><strong>Architecture</strong>:</p>
<pre><code>Autovacuum Launcher (single process)
    ‚îÇ
    ‚îÇ Monitors tables via statistics
    ‚îÇ Decides which tables need vacuuming
    ‚îÇ
    ‚îú‚îÄ‚îÄ‚îÄ Spawns Worker 1 ‚îÄ‚îÄ&gt; Vacuums table "users"
    ‚îú‚îÄ‚îÄ‚îÄ Spawns Worker 2 ‚îÄ‚îÄ&gt; Vacuums table "orders"
    ‚îî‚îÄ‚îÄ‚îÄ Spawns Worker 3 ‚îÄ‚îÄ&gt; Analyzes table "products"

    Maximum workers: autovacuum_max_workers (default 3)</code></pre>
<p><strong>Launcher Algorithm</strong>:</p>
<pre><code>Loop forever:
    1. Sleep for autovacuum_naptime (default 1 minute)
    2. Query statistics for each database:
       - Dead tuples count
       - Insert count (for analyze)
       - Last vacuum/analyze time
    3. For each database needing work:
       - Calculate priority (oldest, most dead tuples)
       - If worker slots available:
         * Fork autovacuum worker
         * Assign database and table
    4. Monitor worker processes
    5. Respect autovacuum_max_workers limit</code></pre>
<p><strong>Worker Process</strong>:</p>
<div class="sourceCode" id="cb399"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb399-1"><a aria-hidden="true" href="#cb399-1" tabindex="-1"></a><span class="co">/* Autovacuum worker main loop */</span></span>
<span id="cb399-2"><a aria-hidden="true" href="#cb399-2" tabindex="-1"></a><span class="dt">void</span></span>
<span id="cb399-3"><a aria-hidden="true" href="#cb399-3" tabindex="-1"></a>AutoVacWorkerMain<span class="op">(</span><span class="dt">int</span> argc<span class="op">,</span> <span class="dt">char</span> <span class="op">*</span>argv<span class="op">[])</span></span>
<span id="cb399-4"><a aria-hidden="true" href="#cb399-4" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb399-5"><a aria-hidden="true" href="#cb399-5" tabindex="-1"></a>    <span class="co">/* Connect to assigned database */</span></span>
<span id="cb399-6"><a aria-hidden="true" href="#cb399-6" tabindex="-1"></a>    InitPostgres<span class="op">(</span>dbname<span class="op">,</span> InvalidOid<span class="op">,</span> NULL<span class="op">,</span> InvalidOid<span class="op">,</span> NULL<span class="op">,</span> <span class="kw">false</span><span class="op">);</span></span>
<span id="cb399-7"><a aria-hidden="true" href="#cb399-7" tabindex="-1"></a></span>
<span id="cb399-8"><a aria-hidden="true" href="#cb399-8" tabindex="-1"></a>    <span class="co">/* Get list of tables to vacuum */</span></span>
<span id="cb399-9"><a aria-hidden="true" href="#cb399-9" tabindex="-1"></a>    table_oids <span class="op">=</span> get_tables_to_vacuum<span class="op">();</span></span>
<span id="cb399-10"><a aria-hidden="true" href="#cb399-10" tabindex="-1"></a></span>
<span id="cb399-11"><a aria-hidden="true" href="#cb399-11" tabindex="-1"></a>    <span class="co">/* Process each table */</span></span>
<span id="cb399-12"><a aria-hidden="true" href="#cb399-12" tabindex="-1"></a>    foreach<span class="op">(</span>lc<span class="op">,</span> table_oids<span class="op">)</span></span>
<span id="cb399-13"><a aria-hidden="true" href="#cb399-13" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb399-14"><a aria-hidden="true" href="#cb399-14" tabindex="-1"></a>        Oid relid <span class="op">=</span> lfirst_oid<span class="op">(</span>lc<span class="op">);</span></span>
<span id="cb399-15"><a aria-hidden="true" href="#cb399-15" tabindex="-1"></a></span>
<span id="cb399-16"><a aria-hidden="true" href="#cb399-16" tabindex="-1"></a>        <span class="co">/* Perform vacuum or analyze */</span></span>
<span id="cb399-17"><a aria-hidden="true" href="#cb399-17" tabindex="-1"></a>        vacuum_rel<span class="op">(</span>relid<span class="op">,</span> params<span class="op">);</span></span>
<span id="cb399-18"><a aria-hidden="true" href="#cb399-18" tabindex="-1"></a></span>
<span id="cb399-19"><a aria-hidden="true" href="#cb399-19" tabindex="-1"></a>        <span class="co">/* Check if we should exit (shutdown signal) */</span></span>
<span id="cb399-20"><a aria-hidden="true" href="#cb399-20" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>got_SIGTERM<span class="op">)</span></span>
<span id="cb399-21"><a aria-hidden="true" href="#cb399-21" tabindex="-1"></a>            <span class="cf">break</span><span class="op">;</span></span>
<span id="cb399-22"><a aria-hidden="true" href="#cb399-22" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb399-23"><a aria-hidden="true" href="#cb399-23" tabindex="-1"></a></span>
<span id="cb399-24"><a aria-hidden="true" href="#cb399-24" tabindex="-1"></a>    <span class="co">/* Exit worker */</span></span>
<span id="cb399-25"><a aria-hidden="true" href="#cb399-25" tabindex="-1"></a>    proc_exit<span class="op">(</span><span class="dv">0</span><span class="op">);</span></span>
<span id="cb399-26"><a aria-hidden="true" href="#cb399-26" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>Configuration</strong>: - <code>autovacuum</code>:
Enable/disable autovacuum (default on) -
<code>autovacuum_max_workers</code>: Maximum worker processes (default
3) - <code>autovacuum_naptime</code>: Time between launcher runs
(default 1min) - <code>autovacuum_vacuum_threshold</code>: Minimum
updates before vacuum (default 50) -
<code>autovacuum_analyze_threshold</code>: Minimum updates before
analyze (default 50) - <code>autovacuum_vacuum_scale_factor</code>:
Fraction of table size to add to threshold (default 0.2)</p>
<h3 data-number="7.5.5" id="wal-sender"><span class="header-section-number">7.5.5</span> 4.5 WAL Sender</h3>
<p><strong>Purpose</strong>: Streams write-ahead log to standby servers
for replication.</p>
<p><strong>Location</strong>:
<code>src/backend/replication/walsender.c</code></p>
<p><strong>Role</strong>: Each WAL sender process serves one standby
server, streaming WAL records as they are generated.</p>
<p><strong>Protocol</strong>:</p>
<pre><code>WAL Sender &lt;--&gt; WAL Receiver (on standby)

1. Standby connects with replication protocol
2. Standby sends start position (LSN)
3. WAL sender begins streaming from that position:

   Loop:
       - Wait for new WAL to be written
       - Read WAL records from WAL files
       - Send XLogData messages to standby
       - Receive standby feedback:
         * Write position (data written to disk)
         * Flush position (data fsynced)
         * Apply position (data replayed)
       - Update replication slot position
       - Sleep or wait for more WAL</code></pre>
<p><strong>Key Code</strong>:</p>
<div class="sourceCode" id="cb401"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb401-1"><a aria-hidden="true" href="#cb401-1" tabindex="-1"></a><span class="co">/* Main loop of WAL sender */</span></span>
<span id="cb401-2"><a aria-hidden="true" href="#cb401-2" tabindex="-1"></a><span class="dt">void</span></span>
<span id="cb401-3"><a aria-hidden="true" href="#cb401-3" tabindex="-1"></a>WalSndLoop<span class="op">(</span>WalSndSendDataCallback send_data<span class="op">)</span></span>
<span id="cb401-4"><a aria-hidden="true" href="#cb401-4" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb401-5"><a aria-hidden="true" href="#cb401-5" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(;;)</span></span>
<span id="cb401-6"><a aria-hidden="true" href="#cb401-6" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb401-7"><a aria-hidden="true" href="#cb401-7" tabindex="-1"></a>        <span class="co">/* Send any pending WAL */</span></span>
<span id="cb401-8"><a aria-hidden="true" href="#cb401-8" tabindex="-1"></a>        send_data<span class="op">();</span></span>
<span id="cb401-9"><a aria-hidden="true" href="#cb401-9" tabindex="-1"></a></span>
<span id="cb401-10"><a aria-hidden="true" href="#cb401-10" tabindex="-1"></a>        <span class="co">/* Wait for more WAL or standby feedback */</span></span>
<span id="cb401-11"><a aria-hidden="true" href="#cb401-11" tabindex="-1"></a>        WalSndWait<span class="op">(</span>WAITSOCKET_READABLE <span class="op">|</span> WAITSOCKET_WRITEABLE<span class="op">);</span></span>
<span id="cb401-12"><a aria-hidden="true" href="#cb401-12" tabindex="-1"></a></span>
<span id="cb401-13"><a aria-hidden="true" href="#cb401-13" tabindex="-1"></a>        <span class="co">/* Process any messages from standby */</span></span>
<span id="cb401-14"><a aria-hidden="true" href="#cb401-14" tabindex="-1"></a>        ProcessRepliesIfAny<span class="op">();</span></span>
<span id="cb401-15"><a aria-hidden="true" href="#cb401-15" tabindex="-1"></a></span>
<span id="cb401-16"><a aria-hidden="true" href="#cb401-16" tabindex="-1"></a>        <span class="co">/* Check for shutdown signal */</span></span>
<span id="cb401-17"><a aria-hidden="true" href="#cb401-17" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>got_SIGTERM<span class="op">)</span></span>
<span id="cb401-18"><a aria-hidden="true" href="#cb401-18" tabindex="-1"></a>            <span class="cf">break</span><span class="op">;</span></span>
<span id="cb401-19"><a aria-hidden="true" href="#cb401-19" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb401-20"><a aria-hidden="true" href="#cb401-20" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 data-number="7.5.6" id="wal-receiver-on-standby"><span class="header-section-number">7.5.6</span> 4.6 WAL Receiver (on
standby)</h3>
<p><strong>Purpose</strong>: Receives WAL from primary server and writes
it to local WAL files.</p>
<p><strong>Location</strong>:
<code>src/backend/replication/walreceiver.c</code></p>
<p><strong>Process</strong>:</p>
<pre><code>1. Connect to primary server
2. Request WAL streaming from current replay position
3. Receive XLogData messages
4. Write WAL records to local WAL files
5. Notify startup process (which replays WAL)
6. Send feedback to primary (write/flush/apply positions)</code></pre>
<h3 data-number="7.5.7" id="archiver"><span class="header-section-number">7.5.7</span> 4.7 Archiver</h3>
<p><strong>Purpose</strong>: Copies completed WAL files to archive
location for point-in-time recovery.</p>
<p><strong>Location</strong>:
<code>src/backend/postmaster/pgarch.c</code></p>
<p><strong>Algorithm</strong>:</p>
<pre><code>Loop forever:
    1. Sleep for archive_timeout or until signaled
    2. Check for completed WAL files:
       - Files marked as ready in archive_status/
    3. For each ready file:
       - Execute archive_command
       - If successful:
         * Mark file as .done
         * Delete .ready status file
       - If failed:
         * Retry with exponential backoff
         * Log warning after multiple failures
    4. Update statistics</code></pre>
<p><strong>Configuration</strong>: - <code>archive_mode</code>: Enable
archiving (default off) - <code>archive_command</code>: Shell command to
execute for each WAL file - <code>archive_timeout</code>: Force segment
switch after this time (default 0 = disabled)</p>
<p><strong>Example archive_command</strong>:</p>
<div class="sourceCode" id="cb404"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb404-1"><a aria-hidden="true" href="#cb404-1" tabindex="-1"></a><span class="co"># Copy to local directory</span></span>
<span id="cb404-2"><a aria-hidden="true" href="#cb404-2" tabindex="-1"></a><span class="ex">archive_command</span> = <span class="st">'cp %p /archive/%f'</span></span>
<span id="cb404-3"><a aria-hidden="true" href="#cb404-3" tabindex="-1"></a></span>
<span id="cb404-4"><a aria-hidden="true" href="#cb404-4" tabindex="-1"></a><span class="co"># Copy to remote server via rsync</span></span>
<span id="cb404-5"><a aria-hidden="true" href="#cb404-5" tabindex="-1"></a><span class="ex">archive_command</span> = <span class="st">'rsync -a %p backup-server:/archive/%f'</span></span>
<span id="cb404-6"><a aria-hidden="true" href="#cb404-6" tabindex="-1"></a></span>
<span id="cb404-7"><a aria-hidden="true" href="#cb404-7" tabindex="-1"></a><span class="co"># Use wal-g (backup tool)</span></span>
<span id="cb404-8"><a aria-hidden="true" href="#cb404-8" tabindex="-1"></a><span class="ex">archive_command</span> = <span class="st">'wal-g wal-push %p'</span></span></code></pre></div>
<h3 data-number="7.5.8" id="statistics-collector"><span class="header-section-number">7.5.8</span> 4.8 Statistics Collector</h3>
<p><strong>Purpose</strong>: Collects and aggregates database activity
statistics.</p>
<p><strong>Location</strong>:
<code>src/backend/postmaster/pgstat.c</code></p>
<p><strong>Architecture</strong>:</p>
<pre><code>Backends/Workers          Stats Collector
       ‚îÇ                         ‚îÇ
       ‚îÇ Send stats via UDP      ‚îÇ
       ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ&gt;‚îÇ
       ‚îÇ (or shared memory)      ‚îÇ
       ‚îÇ                         ‚îÇ
       ‚îÇ                    Aggregates:
       ‚îÇ                    - Table stats
       ‚îÇ                    - Index stats
       ‚îÇ                    - Function stats
       ‚îÇ                    - Database stats
       ‚îÇ                         ‚îÇ
       ‚îÇ                    Periodically writes
       ‚îÇ                    to stats files
       ‚îÇ                         ‚îÇ
       ‚îÇ Query pg_stat_* views   ‚îÇ
       ‚îÇ&lt;‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
       ‚îÇ Read from shared memory ‚îÇ</code></pre>
<p><strong>Statistics Types</strong>: - <strong>Database-level</strong>:
Connections, transactions, blocks read/hit -
<strong>Table-level</strong>: Scans, tuples inserted/updated/deleted,
dead tuples - <strong>Index-level</strong>: Scans, tuples read/fetched -
<strong>Function-level</strong>: Calls, total time, self time -
<strong>Replication</strong>: WAL sender status, replication lag</p>
<p><strong>Configuration</strong>: - <code>track_activities</code>:
Track currently executing commands (default on) -
<code>track_counts</code>: Collect table/index access statistics
(default on) - <code>track_functions</code>: Track function call
statistics (default none) - <code>track_io_timing</code>: Collect I/O
timing statistics (default off)</p>
<h3 data-number="7.5.9" id="logical-replication-launcher-and-workers"><span class="header-section-number">7.5.9</span> 4.9 Logical Replication
Launcher and Workers</h3>
<p><strong>Purpose</strong>: Manage logical replication subscriptions
and apply changes.</p>
<p><strong>Location</strong>:
<code>src/backend/replication/logical/launcher.c</code></p>
<p><strong>Architecture</strong>:</p>
<pre><code>Logical Replication Launcher
    ‚îÇ
    ‚îÇ Monitors pg_subscription catalog
    ‚îÇ Starts workers for active subscriptions
    ‚îÇ
    ‚îú‚îÄ‚îÄ‚îÄ Worker 1 ‚îÄ‚îÄ&gt; Subscription "sub1"
    ‚îÇ                 - Connects to publisher
    ‚îÇ                 - Receives logical changes
    ‚îÇ                 - Applies to local tables
    ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ Worker 2 ‚îÄ‚îÄ&gt; Subscription "sub2"
                      - Same as above</code></pre>
<p><strong>Worker Process</strong>: 1. Connect to publisher database 2.
Create replication slot on publisher 3. Start logical decoding from slot
position 4. Receive logical change records 5. Apply changes to local
tables (INSERT/UPDATE/DELETE) 6. Handle conflicts (based on conflict
resolution settings) 7. Track apply progress</p>
<h3 data-number="7.5.10" id="logger-syslogger"><span class="header-section-number">7.5.10</span> 4.10 Logger (syslogger)</h3>
<p><strong>Purpose</strong>: Collects log messages from all processes
and writes to log files.</p>
<p><strong>Location</strong>:
<code>src/backend/postmaster/syslogger.c</code></p>
<p><strong>Why Separate Process?</strong>: - Centralizes logging (one
process writes to log files) - Enables log rotation without interrupting
backends - Allows CSV format logs - Supports stderr capture</p>
<p><strong>Architecture</strong>:</p>
<pre><code>All Processes                Logger Process
     ‚îÇ                            ‚îÇ
     ‚îÇ Write to stderr            ‚îÇ
     ‚îÇ (pipe redirect)            ‚îÇ
     ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ&gt;‚îÇ
     ‚îÇ                            ‚îÇ
     ‚îÇ                       Receives messages
     ‚îÇ                       Formats as needed
     ‚îÇ                       Writes to log file
     ‚îÇ                       Rotates when needed
     ‚îÇ                            ‚îÇ
     ‚îÇ                       Log Files:
     ‚îÇ                       - postgresql-2025-11-19.log
     ‚îÇ                       - postgresql-2025-11-19.csv</code></pre>
<p><strong>Configuration</strong>: - <code>logging_collector</code>:
Enable logger process (default off) - <code>log_directory</code>:
Directory for log files (default log/) - <code>log_filename</code>:
Filename pattern (default postgresql-%Y-%m-%d_%H%M%S.log) -
<code>log_rotation_age</code>: Age to force log rotation (default 1d) -
<code>log_rotation_size</code>: Size to force log rotation (default
10MB) - <code>log_destination</code>: Output format (stderr, csvlog,
syslog)</p>
<h2 data-number="7.6" id="shared-memory-architecture"><span class="header-section-number">7.6</span> 5. Shared Memory
Architecture</h2>
<h3 data-number="7.6.1" id="shared-memory-overview"><span class="header-section-number">7.6.1</span> 5.1 Shared Memory
Overview</h3>
<p>Shared memory is the primary mechanism for sharing state between
PostgreSQL processes. All backends and auxiliary processes attach to the
same shared memory segments, enabling:</p>
<ul>
<li><strong>Shared buffer pool</strong>: Cached disk pages</li>
<li><strong>Lock tables</strong>: Transaction locks, tuple locks,
relation locks</li>
<li><strong>Process array</strong>: Information about all active
processes</li>
<li><strong>WAL buffers</strong>: Write-ahead log before writing to
disk</li>
<li><strong>SLRU buffers</strong>: Simple LRU caches (CLOG, subtrans,
multixact)</li>
</ul>
<p><strong>Creation</strong>: Postmaster creates shared memory during
startup. Size is calculated based on configuration parameters.</p>
<h3 data-number="7.6.2" id="shared-memory-layout"><span class="header-section-number">7.6.2</span> 5.2 Shared Memory Layout</h3>
<pre><code>Shared Memory Layout (conceptual):

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Shared Memory Header                                    ‚îÇ
‚îÇ - Magic number (version check)                          ‚îÇ
‚îÇ - Total size                                            ‚îÇ
‚îÇ - Segment offsets                                       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Shared Buffer Pool (shared_buffers)                    ‚îÇ
‚îÇ                                                         ‚îÇ
‚îÇ Array of BufferDesc (metadata):                        ‚îÇ
‚îÇ - Buffer tag (identifies which page)                   ‚îÇ
‚îÇ - State (IO in progress, dirty, valid, etc.)           ‚îÇ
‚îÇ - Usage count (for eviction policy)                    ‚îÇ
‚îÇ - Reference count (number of pins)                     ‚îÇ
‚îÇ - Lock (content lock, IO lock)                         ‚îÇ
‚îÇ                                                         ‚îÇ
‚îÇ Buffer data pages (8KB each):                          ‚îÇ
‚îÇ [Page 0][Page 1][Page 2]...[Page N]                    ‚îÇ
‚îÇ                                                         ‚îÇ
‚îÇ Default size: shared_buffers = 128MB                   ‚îÇ
‚îÇ Typical production: 25% of system RAM                  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ WAL Buffers (wal_buffers)                              ‚îÇ
‚îÇ                                                         ‚îÇ
‚îÇ Circular buffer for WAL records before disk write      ‚îÇ
‚îÇ - WAL insert locks (parallel WAL insertion)            ‚îÇ
‚îÇ - WAL insertion position                               ‚îÇ
‚îÇ - WAL flush position                                   ‚îÇ
‚îÇ                                                         ‚îÇ
‚îÇ Default: min(16MB, 1/32 of shared_buffers)             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Lock Tables                                            ‚îÇ
‚îÇ                                                         ‚îÇ
‚îÇ Lock hash table (max_locks_per_transaction):           ‚îÇ
‚îÇ - Regular locks (table, row, tuple)                    ‚îÇ
‚îÇ - Predicate locks (for serializable isolation)         ‚îÇ
‚îÇ                                                         ‚îÇ
‚îÇ Lock methods:                                          ‚îÇ
‚îÇ - AccessShareLock, RowShareLock, RowExclusiveLock,     ‚îÇ
‚îÇ   ShareUpdateExclusiveLock, ShareLock,                 ‚îÇ
‚îÇ   ShareRowExclusiveLock, ExclusiveLock,                ‚îÇ
‚îÇ   AccessExclusiveLock                                  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Process Array (PGPROC array)                           ‚îÇ
‚îÇ                                                         ‚îÇ
‚îÇ One entry per process slot:                            ‚îÇ
‚îÇ - Process ID                                           ‚îÇ
‚îÇ - Database OID                                         ‚îÇ
‚îÇ - Transaction ID                                       ‚îÇ
‚îÇ - Wait event information                               ‚îÇ
‚îÇ - Locks held                                           ‚îÇ
‚îÇ - Latch for signaling                                  ‚îÇ
‚îÇ - Semaphore for waiting                                ‚îÇ
‚îÇ                                                         ‚îÇ
‚îÇ Size: max_connections + autovacuum_max_workers + ...   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ SLRU Buffers (Simple LRU caches)                       ‚îÇ
‚îÇ                                                         ‚îÇ
‚îÇ - Transaction status (pg_xact)                         ‚îÇ
‚îÇ - Subtransactions (pg_subtrans)                        ‚îÇ
‚îÇ - MultiXact members (pg_multixact)                     ‚îÇ
‚îÇ - MultiXact offsets (pg_multixact)                     ‚îÇ
‚îÇ - Commit timestamps (pg_commit_ts)                     ‚îÇ
‚îÇ - Async notifications (pg_notify)                      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Other Shared Structures                                ‚îÇ
‚îÇ                                                         ‚îÇ
‚îÇ - Checkpointer state                                   ‚îÇ
‚îÇ - Background writer state                              ‚îÇ
‚îÇ - Autovacuum shared state                              ‚îÇ
‚îÇ - Replication slots                                    ‚îÇ
‚îÇ - Two-phase commit state                               ‚îÇ
‚îÇ - Prepared transactions                                ‚îÇ
‚îÇ - Parallel query DSM segments                          ‚îÇ
‚îÇ - Statistics (shared stats snapshots)                  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò</code></pre>
<h3 data-number="7.6.3" id="shared-memory-initialization"><span class="header-section-number">7.6.3</span> 5.3 Shared Memory
Initialization</h3>
<p><strong>Key Code</strong>
(<code>src/backend/storage/ipc/ipci.c</code>):</p>
<div class="sourceCode" id="cb409"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb409-1"><a aria-hidden="true" href="#cb409-1" tabindex="-1"></a><span class="co">/*</span></span>
<span id="cb409-2"><a aria-hidden="true" href="#cb409-2" tabindex="-1"></a><span class="co"> * CreateSharedMemoryAndSemaphores</span></span>
<span id="cb409-3"><a aria-hidden="true" href="#cb409-3" tabindex="-1"></a><span class="co"> * Creates and initializes shared memory and semaphores.</span></span>
<span id="cb409-4"><a aria-hidden="true" href="#cb409-4" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb409-5"><a aria-hidden="true" href="#cb409-5" tabindex="-1"></a><span class="dt">void</span></span>
<span id="cb409-6"><a aria-hidden="true" href="#cb409-6" tabindex="-1"></a>CreateSharedMemoryAndSemaphores<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb409-7"><a aria-hidden="true" href="#cb409-7" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb409-8"><a aria-hidden="true" href="#cb409-8" tabindex="-1"></a>    PGShmemHeader <span class="op">*</span>shim <span class="op">=</span> NULL<span class="op">;</span></span>
<span id="cb409-9"><a aria-hidden="true" href="#cb409-9" tabindex="-1"></a>    Size        size<span class="op">;</span></span>
<span id="cb409-10"><a aria-hidden="true" href="#cb409-10" tabindex="-1"></a></span>
<span id="cb409-11"><a aria-hidden="true" href="#cb409-11" tabindex="-1"></a>    <span class="co">/* Calculate total shared memory size */</span></span>
<span id="cb409-12"><a aria-hidden="true" href="#cb409-12" tabindex="-1"></a>    size <span class="op">=</span> CalculateShmemSize<span class="op">();</span></span>
<span id="cb409-13"><a aria-hidden="true" href="#cb409-13" tabindex="-1"></a></span>
<span id="cb409-14"><a aria-hidden="true" href="#cb409-14" tabindex="-1"></a>    elog<span class="op">(</span>DEBUG3<span class="op">,</span> <span class="st">"invoking IpcMemoryCreate(size=</span><span class="sc">%zu</span><span class="st">)"</span><span class="op">,</span> size<span class="op">);</span></span>
<span id="cb409-15"><a aria-hidden="true" href="#cb409-15" tabindex="-1"></a></span>
<span id="cb409-16"><a aria-hidden="true" href="#cb409-16" tabindex="-1"></a>    <span class="co">/* Create the shared memory segment */</span></span>
<span id="cb409-17"><a aria-hidden="true" href="#cb409-17" tabindex="-1"></a>    shim <span class="op">=</span> PGSharedMemoryCreate<span class="op">(</span>size<span class="op">,</span> <span class="op">&amp;</span>sharedMemoryHook<span class="op">);</span></span>
<span id="cb409-18"><a aria-hidden="true" href="#cb409-18" tabindex="-1"></a></span>
<span id="cb409-19"><a aria-hidden="true" href="#cb409-19" tabindex="-1"></a>    <span class="co">/* Initialize shared memory header */</span></span>
<span id="cb409-20"><a aria-hidden="true" href="#cb409-20" tabindex="-1"></a>    InitShmemAllocation<span class="op">(</span>shim<span class="op">);</span></span>
<span id="cb409-21"><a aria-hidden="true" href="#cb409-21" tabindex="-1"></a></span>
<span id="cb409-22"><a aria-hidden="true" href="#cb409-22" tabindex="-1"></a>    <span class="co">/*</span></span>
<span id="cb409-23"><a aria-hidden="true" href="#cb409-23" tabindex="-1"></a><span class="co">     * Initialize subsystem shared memory structures</span></span>
<span id="cb409-24"><a aria-hidden="true" href="#cb409-24" tabindex="-1"></a><span class="co">     */</span></span>
<span id="cb409-25"><a aria-hidden="true" href="#cb409-25" tabindex="-1"></a>    CreateSharedProcArray<span class="op">();</span>      <span class="co">/* Process array */</span></span>
<span id="cb409-26"><a aria-hidden="true" href="#cb409-26" tabindex="-1"></a>    CreateSharedBackendStatus<span class="op">();</span>  <span class="co">/* Backend status array */</span></span>
<span id="cb409-27"><a aria-hidden="true" href="#cb409-27" tabindex="-1"></a>    CreateSharedInvalidationState<span class="op">();</span> <span class="co">/* Cache invalidation */</span></span>
<span id="cb409-28"><a aria-hidden="true" href="#cb409-28" tabindex="-1"></a>    InitBufferPool<span class="op">();</span>             <span class="co">/* Shared buffer pool */</span></span>
<span id="cb409-29"><a aria-hidden="true" href="#cb409-29" tabindex="-1"></a>    InitWALBuffers<span class="op">();</span>             <span class="co">/* WAL buffers */</span></span>
<span id="cb409-30"><a aria-hidden="true" href="#cb409-30" tabindex="-1"></a>    InitLockTable<span class="op">();</span>              <span class="co">/* Lock tables */</span></span>
<span id="cb409-31"><a aria-hidden="true" href="#cb409-31" tabindex="-1"></a>    InitPredicateLocks<span class="op">();</span>         <span class="co">/* Predicate locks for SSI */</span></span>
<span id="cb409-32"><a aria-hidden="true" href="#cb409-32" tabindex="-1"></a>    InitSLRUBuffers<span class="op">();</span>            <span class="co">/* SLRU caches */</span></span>
<span id="cb409-33"><a aria-hidden="true" href="#cb409-33" tabindex="-1"></a>    InitReplicationSlots<span class="op">();</span>       <span class="co">/* Replication slots */</span></span>
<span id="cb409-34"><a aria-hidden="true" href="#cb409-34" tabindex="-1"></a>    InitTwoPhaseState<span class="op">();</span>          <span class="co">/* Prepared transactions */</span></span>
<span id="cb409-35"><a aria-hidden="true" href="#cb409-35" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 data-number="7.6.4" id="buffer-management"><span class="header-section-number">7.6.4</span> 5.4 Buffer Management</h3>
<p>The shared buffer pool is PostgreSQL‚Äôs most important shared memory
structure:</p>
<div class="sourceCode" id="cb410"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb410-1"><a aria-hidden="true" href="#cb410-1" tabindex="-1"></a><span class="co">/* Buffer descriptor (src/include/storage/buf_internals.h) */</span></span>
<span id="cb410-2"><a aria-hidden="true" href="#cb410-2" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> BufferDesc</span>
<span id="cb410-3"><a aria-hidden="true" href="#cb410-3" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb410-4"><a aria-hidden="true" href="#cb410-4" tabindex="-1"></a>    BufferTag   tag<span class="op">;</span>              <span class="co">/* ID of page cached in this buffer */</span></span>
<span id="cb410-5"><a aria-hidden="true" href="#cb410-5" tabindex="-1"></a>    <span class="dt">int</span>         buf_id<span class="op">;</span>           <span class="co">/* Buffer's index number (from 0) */</span></span>
<span id="cb410-6"><a aria-hidden="true" href="#cb410-6" tabindex="-1"></a></span>
<span id="cb410-7"><a aria-hidden="true" href="#cb410-7" tabindex="-1"></a>    <span class="co">/* State flags and reference count */</span></span>
<span id="cb410-8"><a aria-hidden="true" href="#cb410-8" tabindex="-1"></a>    pg_atomic_uint32 state<span class="op">;</span>       <span class="co">/* Atomic state word */</span></span>
<span id="cb410-9"><a aria-hidden="true" href="#cb410-9" tabindex="-1"></a></span>
<span id="cb410-10"><a aria-hidden="true" href="#cb410-10" tabindex="-1"></a>    <span class="dt">int</span>         wait_backend_pid<span class="op">;</span> <span class="co">/* Backend waiting for IO */</span></span>
<span id="cb410-11"><a aria-hidden="true" href="#cb410-11" tabindex="-1"></a></span>
<span id="cb410-12"><a aria-hidden="true" href="#cb410-12" tabindex="-1"></a>    slock_t     buf_hdr_lock<span class="op">;</span>     <span class="co">/* Spinlock for buffer header */</span></span>
<span id="cb410-13"><a aria-hidden="true" href="#cb410-13" tabindex="-1"></a></span>
<span id="cb410-14"><a aria-hidden="true" href="#cb410-14" tabindex="-1"></a>    <span class="dt">int</span>         freeNext<span class="op">;</span>         <span class="co">/* Link in freelist chain */</span></span>
<span id="cb410-15"><a aria-hidden="true" href="#cb410-15" tabindex="-1"></a></span>
<span id="cb410-16"><a aria-hidden="true" href="#cb410-16" tabindex="-1"></a><span class="op">}</span> BufferDesc<span class="op">;</span></span>
<span id="cb410-17"><a aria-hidden="true" href="#cb410-17" tabindex="-1"></a></span>
<span id="cb410-18"><a aria-hidden="true" href="#cb410-18" tabindex="-1"></a><span class="co">/* Buffer tag uniquely identifies a page */</span></span>
<span id="cb410-19"><a aria-hidden="true" href="#cb410-19" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> BufferTag</span>
<span id="cb410-20"><a aria-hidden="true" href="#cb410-20" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb410-21"><a aria-hidden="true" href="#cb410-21" tabindex="-1"></a>    RelFileNode rnode<span class="op">;</span>            <span class="co">/* Relation file node */</span></span>
<span id="cb410-22"><a aria-hidden="true" href="#cb410-22" tabindex="-1"></a>    ForkNumber  forkNum<span class="op">;</span>          <span class="co">/* Fork number (main, FSM, VM, etc.) */</span></span>
<span id="cb410-23"><a aria-hidden="true" href="#cb410-23" tabindex="-1"></a>    BlockNumber blockNum<span class="op">;</span>         <span class="co">/* Block number within relation */</span></span>
<span id="cb410-24"><a aria-hidden="true" href="#cb410-24" tabindex="-1"></a><span class="op">}</span> BufferTag<span class="op">;</span></span></code></pre></div>
<p><strong>Buffer States</strong> (encoded in atomic state word): -
<strong>BM_DIRTY</strong>: Page modified, needs write to disk -
<strong>BM_VALID</strong>: Page contains valid data -
<strong>BM_TAG_VALID</strong>: Buffer tag is valid -
<strong>BM_IO_IN_PROGRESS</strong>: I/O currently in progress -
<strong>BM_IO_ERROR</strong>: I/O error occurred -
<strong>BM_JUST_DIRTIED</strong>: Recently dirtied -
<strong>BM_PERMANENT</strong>: Permanent relation (not temp) -
<strong>BM_CHECKPOINT_NEEDED</strong>: Needs checkpoint</p>
<p><strong>Pin Count</strong>: Number of backends currently using the
buffer (prevents eviction)</p>
<p><strong>Usage Count</strong>: For clock-sweep eviction algorithm
(0-5)</p>
<h2 data-number="7.7" id="inter-process-communication-mechanisms"><span class="header-section-number">7.7</span> 6. Inter-Process Communication
Mechanisms</h2>
<h3 data-number="7.7.1" id="signals"><span class="header-section-number">7.7.1</span> 6.1 Signals</h3>
<p>PostgreSQL uses Unix signals extensively for process
communication:</p>
<p><strong>Signal Types</strong>:</p>
<table>
<colgroup>
<col style="width: 22%"/>
<col style="width: 52%"/>
<col style="width: 25%"/>
</colgroup>
<thead>
<tr>
<th>Signal</th>
<th>Sender ‚Üí Receiver</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>SIGUSR1</strong></td>
<td>Various ‚Üí Backend</td>
<td>Multi-purpose signal; action depends on flags in shared memory</td>
</tr>
<tr>
<td><strong>SIGUSR1</strong></td>
<td>Backend ‚Üí Postmaster</td>
<td>Backend ready to accept connections</td>
</tr>
<tr>
<td><strong>SIGTERM</strong></td>
<td>Postmaster ‚Üí All</td>
<td>Shutdown request (fast shutdown)</td>
</tr>
<tr>
<td><strong>SIGQUIT</strong></td>
<td>Postmaster ‚Üí All</td>
<td>Immediate shutdown (crash)</td>
</tr>
<tr>
<td><strong>SIGHUP</strong></td>
<td>Admin ‚Üí Postmaster</td>
<td>Reload configuration files</td>
</tr>
<tr>
<td><strong>SIGINT</strong></td>
<td>User ‚Üí Backend</td>
<td>Cancel current query</td>
</tr>
</tbody>
</table>
<p><strong>SIGUSR1 Uses</strong> (determined by flags in PGPROC
structure): - Cache invalidation messages available - Notify/listen
messages available - Parallel query worker should exit - Catchup
interrupt (for replication) - Recovery conflict - Notify for checkpoint
start</p>
<p><strong>Signal Handler Example</strong>:</p>
<div class="sourceCode" id="cb411"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb411-1"><a aria-hidden="true" href="#cb411-1" tabindex="-1"></a><span class="co">/* Backend SIGUSR1 handler (src/backend/tcop/postgres.c) */</span></span>
<span id="cb411-2"><a aria-hidden="true" href="#cb411-2" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span></span>
<span id="cb411-3"><a aria-hidden="true" href="#cb411-3" tabindex="-1"></a>procsignal_sigusr1_handler<span class="op">(</span>SIGNAL_ARGS<span class="op">)</span></span>
<span id="cb411-4"><a aria-hidden="true" href="#cb411-4" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb411-5"><a aria-hidden="true" href="#cb411-5" tabindex="-1"></a>    <span class="dt">int</span> save_errno <span class="op">=</span> errno<span class="op">;</span></span>
<span id="cb411-6"><a aria-hidden="true" href="#cb411-6" tabindex="-1"></a></span>
<span id="cb411-7"><a aria-hidden="true" href="#cb411-7" tabindex="-1"></a>    <span class="co">/* Don't do anything in critical section */</span></span>
<span id="cb411-8"><a aria-hidden="true" href="#cb411-8" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>InterruptHoldoffCount <span class="op">&gt;</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb411-9"><a aria-hidden="true" href="#cb411-9" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb411-10"><a aria-hidden="true" href="#cb411-10" tabindex="-1"></a>        InterruptPending <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb411-11"><a aria-hidden="true" href="#cb411-11" tabindex="-1"></a>        errno <span class="op">=</span> save_errno<span class="op">;</span></span>
<span id="cb411-12"><a aria-hidden="true" href="#cb411-12" tabindex="-1"></a>        <span class="cf">return</span><span class="op">;</span></span>
<span id="cb411-13"><a aria-hidden="true" href="#cb411-13" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb411-14"><a aria-hidden="true" href="#cb411-14" tabindex="-1"></a></span>
<span id="cb411-15"><a aria-hidden="true" href="#cb411-15" tabindex="-1"></a>    <span class="co">/* Check various flags to determine what to do */</span></span>
<span id="cb411-16"><a aria-hidden="true" href="#cb411-16" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>CheckProcSignal<span class="op">(</span>PROCSIG_CATCHUP_INTERRUPT<span class="op">))</span></span>
<span id="cb411-17"><a aria-hidden="true" href="#cb411-17" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb411-18"><a aria-hidden="true" href="#cb411-18" tabindex="-1"></a>        <span class="co">/* Handle catchup interrupt for replication */</span></span>
<span id="cb411-19"><a aria-hidden="true" href="#cb411-19" tabindex="-1"></a>        HandleCatchupInterrupt<span class="op">();</span></span>
<span id="cb411-20"><a aria-hidden="true" href="#cb411-20" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb411-21"><a aria-hidden="true" href="#cb411-21" tabindex="-1"></a></span>
<span id="cb411-22"><a aria-hidden="true" href="#cb411-22" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>CheckProcSignal<span class="op">(</span>PROCSIG_NOTIFY_INTERRUPT<span class="op">))</span></span>
<span id="cb411-23"><a aria-hidden="true" href="#cb411-23" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb411-24"><a aria-hidden="true" href="#cb411-24" tabindex="-1"></a>        <span class="co">/* Process NOTIFY messages */</span></span>
<span id="cb411-25"><a aria-hidden="true" href="#cb411-25" tabindex="-1"></a>        HandleNotifyInterrupt<span class="op">();</span></span>
<span id="cb411-26"><a aria-hidden="true" href="#cb411-26" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb411-27"><a aria-hidden="true" href="#cb411-27" tabindex="-1"></a></span>
<span id="cb411-28"><a aria-hidden="true" href="#cb411-28" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>CheckProcSignal<span class="op">(</span>PROCSIG_BARRIER<span class="op">))</span></span>
<span id="cb411-29"><a aria-hidden="true" href="#cb411-29" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb411-30"><a aria-hidden="true" href="#cb411-30" tabindex="-1"></a>        <span class="co">/* Process barrier event */</span></span>
<span id="cb411-31"><a aria-hidden="true" href="#cb411-31" tabindex="-1"></a>        ProcessBarrierPlaceholder<span class="op">();</span></span>
<span id="cb411-32"><a aria-hidden="true" href="#cb411-32" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb411-33"><a aria-hidden="true" href="#cb411-33" tabindex="-1"></a></span>
<span id="cb411-34"><a aria-hidden="true" href="#cb411-34" tabindex="-1"></a>    <span class="co">/* ... more checks ... */</span></span>
<span id="cb411-35"><a aria-hidden="true" href="#cb411-35" tabindex="-1"></a></span>
<span id="cb411-36"><a aria-hidden="true" href="#cb411-36" tabindex="-1"></a>    SetLatch<span class="op">(</span>MyLatch<span class="op">);</span></span>
<span id="cb411-37"><a aria-hidden="true" href="#cb411-37" tabindex="-1"></a>    errno <span class="op">=</span> save_errno<span class="op">;</span></span>
<span id="cb411-38"><a aria-hidden="true" href="#cb411-38" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 data-number="7.7.2" id="latches"><span class="header-section-number">7.7.2</span> 6.2 Latches</h3>
<p>Latches are a lightweight signaling mechanism that allows a process
to sleep until woken by another process or a timeout.</p>
<p><strong>Use Cases</strong>: - Backend waiting for I/O completion -
WAL sender waiting for new WAL or standby feedback - Background writer
waiting for next cycle - Backend waiting for lock</p>
<p><strong>API</strong>:</p>
<div class="sourceCode" id="cb412"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb412-1"><a aria-hidden="true" href="#cb412-1" tabindex="-1"></a><span class="co">/* Initialize a latch */</span></span>
<span id="cb412-2"><a aria-hidden="true" href="#cb412-2" tabindex="-1"></a><span class="dt">void</span> InitLatch<span class="op">(</span>Latch <span class="op">*</span>latch<span class="op">);</span></span>
<span id="cb412-3"><a aria-hidden="true" href="#cb412-3" tabindex="-1"></a></span>
<span id="cb412-4"><a aria-hidden="true" href="#cb412-4" tabindex="-1"></a><span class="co">/* Set (wake) a latch */</span></span>
<span id="cb412-5"><a aria-hidden="true" href="#cb412-5" tabindex="-1"></a><span class="dt">void</span> SetLatch<span class="op">(</span>Latch <span class="op">*</span>latch<span class="op">);</span></span>
<span id="cb412-6"><a aria-hidden="true" href="#cb412-6" tabindex="-1"></a></span>
<span id="cb412-7"><a aria-hidden="true" href="#cb412-7" tabindex="-1"></a><span class="co">/* Wait on a latch */</span></span>
<span id="cb412-8"><a aria-hidden="true" href="#cb412-8" tabindex="-1"></a><span class="dt">int</span> WaitLatch<span class="op">(</span>Latch <span class="op">*</span>latch<span class="op">,</span> <span class="dt">int</span> wakeEvents<span class="op">,</span> <span class="dt">long</span> timeout<span class="op">,</span></span>
<span id="cb412-9"><a aria-hidden="true" href="#cb412-9" tabindex="-1"></a>              uint32 wait_event_info<span class="op">);</span></span>
<span id="cb412-10"><a aria-hidden="true" href="#cb412-10" tabindex="-1"></a></span>
<span id="cb412-11"><a aria-hidden="true" href="#cb412-11" tabindex="-1"></a><span class="co">/* Reset latch to non-set state */</span></span>
<span id="cb412-12"><a aria-hidden="true" href="#cb412-12" tabindex="-1"></a><span class="dt">void</span> ResetLatch<span class="op">(</span>Latch <span class="op">*</span>latch<span class="op">);</span></span></code></pre></div>
<p><strong>Wait Events</strong>: - <code>WL_LATCH_SET</code>: Wake when
latch is set - <code>WL_SOCKET_READABLE</code>: Wake when socket is
readable - <code>WL_SOCKET_WRITEABLE</code>: Wake when socket is
writable - <code>WL_TIMEOUT</code>: Wake after timeout expires -
<code>WL_POSTMASTER_DEATH</code>: Wake if postmaster dies</p>
<p><strong>Example Usage</strong>:</p>
<div class="sourceCode" id="cb413"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb413-1"><a aria-hidden="true" href="#cb413-1" tabindex="-1"></a><span class="co">/* Wait for work or timeout */</span></span>
<span id="cb413-2"><a aria-hidden="true" href="#cb413-2" tabindex="-1"></a><span class="dt">int</span> rc<span class="op">;</span></span>
<span id="cb413-3"><a aria-hidden="true" href="#cb413-3" tabindex="-1"></a></span>
<span id="cb413-4"><a aria-hidden="true" href="#cb413-4" tabindex="-1"></a>rc <span class="op">=</span> WaitLatch<span class="op">(</span>MyLatch<span class="op">,</span></span>
<span id="cb413-5"><a aria-hidden="true" href="#cb413-5" tabindex="-1"></a>               WL_LATCH_SET <span class="op">|</span> WL_TIMEOUT <span class="op">|</span> WL_POSTMASTER_DEATH<span class="op">,</span></span>
<span id="cb413-6"><a aria-hidden="true" href="#cb413-6" tabindex="-1"></a>               BgWriterDelay<span class="op">,</span></span>
<span id="cb413-7"><a aria-hidden="true" href="#cb413-7" tabindex="-1"></a>               WAIT_EVENT_BGWRITER_MAIN<span class="op">);</span></span>
<span id="cb413-8"><a aria-hidden="true" href="#cb413-8" tabindex="-1"></a></span>
<span id="cb413-9"><a aria-hidden="true" href="#cb413-9" tabindex="-1"></a><span class="cf">if</span> <span class="op">(</span>rc <span class="op">&amp;</span> WL_POSTMASTER_DEATH<span class="op">)</span></span>
<span id="cb413-10"><a aria-hidden="true" href="#cb413-10" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb413-11"><a aria-hidden="true" href="#cb413-11" tabindex="-1"></a>    <span class="co">/* Postmaster died, emergency exit */</span></span>
<span id="cb413-12"><a aria-hidden="true" href="#cb413-12" tabindex="-1"></a>    proc_exit<span class="op">(</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb413-13"><a aria-hidden="true" href="#cb413-13" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb413-14"><a aria-hidden="true" href="#cb413-14" tabindex="-1"></a></span>
<span id="cb413-15"><a aria-hidden="true" href="#cb413-15" tabindex="-1"></a><span class="cf">if</span> <span class="op">(</span>rc <span class="op">&amp;</span> WL_LATCH_SET<span class="op">)</span></span>
<span id="cb413-16"><a aria-hidden="true" href="#cb413-16" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb413-17"><a aria-hidden="true" href="#cb413-17" tabindex="-1"></a>    <span class="co">/* Latch was set, we have work to do */</span></span>
<span id="cb413-18"><a aria-hidden="true" href="#cb413-18" tabindex="-1"></a>    ResetLatch<span class="op">(</span>MyLatch<span class="op">);</span></span>
<span id="cb413-19"><a aria-hidden="true" href="#cb413-19" tabindex="-1"></a>    <span class="co">/* ... do work ... */</span></span>
<span id="cb413-20"><a aria-hidden="true" href="#cb413-20" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb413-21"><a aria-hidden="true" href="#cb413-21" tabindex="-1"></a></span>
<span id="cb413-22"><a aria-hidden="true" href="#cb413-22" tabindex="-1"></a><span class="cf">if</span> <span class="op">(</span>rc <span class="op">&amp;</span> WL_TIMEOUT<span class="op">)</span></span>
<span id="cb413-23"><a aria-hidden="true" href="#cb413-23" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb413-24"><a aria-hidden="true" href="#cb413-24" tabindex="-1"></a>    <span class="co">/* Timeout expired, time for regular work cycle */</span></span>
<span id="cb413-25"><a aria-hidden="true" href="#cb413-25" tabindex="-1"></a>    <span class="co">/* ... do work ... */</span></span>
<span id="cb413-26"><a aria-hidden="true" href="#cb413-26" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 data-number="7.7.3" id="spinlocks-1"><span class="header-section-number">7.7.3</span> 6.3 Spinlocks</h3>
<p>Spinlocks are the lowest-level synchronization primitive, used to
protect very short critical sections in shared memory.</p>
<p><strong>Characteristics</strong>: - Very fast when uncontended -
Should be held for only a few instructions - Not safe to hold across any
operation that could sleep or error - Implemented using atomic CPU
instructions (e.g., test-and-set)</p>
<p><strong>Usage</strong>:</p>
<div class="sourceCode" id="cb414"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb414-1"><a aria-hidden="true" href="#cb414-1" tabindex="-1"></a><span class="co">/* Acquire spinlock */</span></span>
<span id="cb414-2"><a aria-hidden="true" href="#cb414-2" tabindex="-1"></a>SpinLockAcquire<span class="op">(&amp;</span>bufHdr<span class="op">-&gt;</span>buf_hdr_lock<span class="op">);</span></span>
<span id="cb414-3"><a aria-hidden="true" href="#cb414-3" tabindex="-1"></a></span>
<span id="cb414-4"><a aria-hidden="true" href="#cb414-4" tabindex="-1"></a><span class="co">/* Critical section - must be very short */</span></span>
<span id="cb414-5"><a aria-hidden="true" href="#cb414-5" tabindex="-1"></a>bufHdr<span class="op">-&gt;</span>refcount<span class="op">++;</span></span>
<span id="cb414-6"><a aria-hidden="true" href="#cb414-6" tabindex="-1"></a></span>
<span id="cb414-7"><a aria-hidden="true" href="#cb414-7" tabindex="-1"></a><span class="co">/* Release spinlock */</span></span>
<span id="cb414-8"><a aria-hidden="true" href="#cb414-8" tabindex="-1"></a>SpinLockRelease<span class="op">(&amp;</span>bufHdr<span class="op">-&gt;</span>buf_hdr_lock<span class="op">);</span></span></code></pre></div>
<p><strong>Guidelines</strong>: - Never hold spinlock across I/O
operation - Never hold spinlock across memory allocation - Never hold
spinlock when calling elog/ereport - Never acquire heavyweight lock
while holding spinlock - Keep critical section under ~100
instructions</p>
<h3 data-number="7.7.4" id="lightweight-locks-lwlocks-1"><span class="header-section-number">7.7.4</span> 6.4 Lightweight Locks
(LWLocks)</h3>
<p>LWLocks are used for short-to-medium duration locks on shared memory
structures.</p>
<p><strong>Characteristics</strong>: - Support shared (read) and
exclusive (write) modes - Processes sleep if lock is contended (unlike
spinlocks) - Safe to hold across operations that might error - More
overhead than spinlocks, less than heavyweight locks</p>
<p><strong>Common LWLocks</strong>: - <strong>BufMappingLock</strong>:
Protects buffer mapping table - <strong>LockMgrLock</strong>: Protects
lock manager hash tables - <strong>WALInsertLock</strong>: Protects WAL
insertion (multiple locks for parallelism) -
<strong>WALWriteLock</strong>: Serializes WAL writes to disk -
<strong>CheckpointerCommLock</strong>: Coordinates checkpoint process -
<strong>XidGenLock</strong>: Protects transaction ID generation</p>
<p><strong>API</strong>:</p>
<div class="sourceCode" id="cb415"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb415-1"><a aria-hidden="true" href="#cb415-1" tabindex="-1"></a><span class="co">/* Acquire LWLock in exclusive mode */</span></span>
<span id="cb415-2"><a aria-hidden="true" href="#cb415-2" tabindex="-1"></a>LWLockAcquire<span class="op">(</span>WALInsertLock<span class="op">,</span> LW_EXCLUSIVE<span class="op">);</span></span>
<span id="cb415-3"><a aria-hidden="true" href="#cb415-3" tabindex="-1"></a></span>
<span id="cb415-4"><a aria-hidden="true" href="#cb415-4" tabindex="-1"></a><span class="co">/* Critical section */</span></span>
<span id="cb415-5"><a aria-hidden="true" href="#cb415-5" tabindex="-1"></a><span class="co">/* ... modify WAL buffers ... */</span></span>
<span id="cb415-6"><a aria-hidden="true" href="#cb415-6" tabindex="-1"></a></span>
<span id="cb415-7"><a aria-hidden="true" href="#cb415-7" tabindex="-1"></a><span class="co">/* Release LWLock */</span></span>
<span id="cb415-8"><a aria-hidden="true" href="#cb415-8" tabindex="-1"></a>LWLockRelease<span class="op">(</span>WALInsertLock<span class="op">);</span></span>
<span id="cb415-9"><a aria-hidden="true" href="#cb415-9" tabindex="-1"></a></span>
<span id="cb415-10"><a aria-hidden="true" href="#cb415-10" tabindex="-1"></a><span class="co">/* Acquire in shared mode */</span></span>
<span id="cb415-11"><a aria-hidden="true" href="#cb415-11" tabindex="-1"></a>LWLockAcquire<span class="op">(</span>BufMappingLock<span class="op">,</span> LW_SHARED<span class="op">);</span></span>
<span id="cb415-12"><a aria-hidden="true" href="#cb415-12" tabindex="-1"></a><span class="co">/* ... read buffer mapping ... */</span></span>
<span id="cb415-13"><a aria-hidden="true" href="#cb415-13" tabindex="-1"></a>LWLockRelease<span class="op">(</span>BufMappingLock<span class="op">);</span></span></code></pre></div>
<h3 data-number="7.7.5" id="heavyweight-locks"><span class="header-section-number">7.7.5</span> 6.5 Heavyweight Locks</h3>
<p>Heavyweight locks (also called ‚Äúregular locks‚Äù) are used for database
objects like tables, rows, and transactions.</p>
<p><strong>Lock Modes</strong> (in order of increasing
restrictiveness):</p>
<ol type="1">
<li><strong>AccessShareLock</strong>: SELECT</li>
<li><strong>RowShareLock</strong>: SELECT FOR UPDATE/SHARE</li>
<li><strong>RowExclusiveLock</strong>: INSERT, UPDATE, DELETE</li>
<li><strong>ShareUpdateExclusiveLock</strong>: VACUUM, ANALYZE, CREATE
INDEX CONCURRENTLY</li>
<li><strong>ShareLock</strong>: CREATE INDEX</li>
<li><strong>ShareRowExclusiveLock</strong>: (rarely used)</li>
<li><strong>ExclusiveLock</strong>: REFRESH MATERIALIZED VIEW
CONCURRENTLY</li>
<li><strong>AccessExclusiveLock</strong>: ALTER TABLE, DROP TABLE,
TRUNCATE, VACUUM FULL</li>
</ol>
<p><strong>Lock Compatibility Matrix</strong>:</p>
<pre><code>         AS  RS  RE  SUE  S  SRE  E  AE
AS       ‚úì   ‚úì   ‚úì   ‚úì    ‚úì   ‚úì   ‚úì   ‚úó
RS       ‚úì   ‚úì   ‚úì   ‚úì    ‚úì   ‚úì   ‚úó   ‚úó
RE       ‚úì   ‚úì   ‚úì   ‚úì    ‚úó   ‚úó   ‚úó   ‚úó
SUE      ‚úì   ‚úì   ‚úì   ‚úó    ‚úó   ‚úó   ‚úó   ‚úó
S        ‚úì   ‚úì   ‚úó   ‚úó    ‚úì   ‚úó   ‚úó   ‚úó
SRE      ‚úì   ‚úì   ‚úó   ‚úó    ‚úó   ‚úó   ‚úó   ‚úó
E        ‚úì   ‚úó   ‚úó   ‚úó    ‚úó   ‚úó   ‚úó   ‚úó
AE       ‚úó   ‚úó   ‚úó   ‚úó    ‚úó   ‚úó   ‚úó   ‚úó

‚úì = Compatible (locks can coexist)
‚úó = Conflicts (one must wait)</code></pre>
<h3 data-number="7.7.6" id="wait-events"><span class="header-section-number">7.7.6</span> 6.6 Wait Events</h3>
<p>Wait events allow monitoring what each backend is waiting for.
Visible in <code>pg_stat_activity.wait_event</code> and
<code>pg_stat_activity.wait_event_type</code>.</p>
<p><strong>Wait Event Types</strong>:</p>
<ul>
<li><strong>Activity</strong>: Idle, idle in transaction</li>
<li><strong>BufferPin</strong>: Waiting for buffer pin</li>
<li><strong>Client</strong>: Waiting for client to send/receive
data</li>
<li><strong>Extension</strong>: Waiting in extension code</li>
<li><strong>IO</strong>: Waiting for I/O operation</li>
<li><strong>IPC</strong>: Waiting for another process</li>
<li><strong>Lock</strong>: Waiting for heavyweight lock</li>
<li><strong>LWLock</strong>: Waiting for lightweight lock</li>
<li><strong>Timeout</strong>: Waiting for timeout to expire</li>
</ul>
<p><strong>Common Wait Events</strong>:</p>
<div class="sourceCode" id="cb417"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb417-1"><a aria-hidden="true" href="#cb417-1" tabindex="-1"></a><span class="co">-- View current waits</span></span>
<span id="cb417-2"><a aria-hidden="true" href="#cb417-2" tabindex="-1"></a><span class="kw">SELECT</span> pid, wait_event_type, wait_event, <span class="kw">query</span></span>
<span id="cb417-3"><a aria-hidden="true" href="#cb417-3" tabindex="-1"></a><span class="kw">FROM</span> pg_stat_activity</span>
<span id="cb417-4"><a aria-hidden="true" href="#cb417-4" tabindex="-1"></a><span class="kw">WHERE</span> wait_event <span class="kw">IS</span> <span class="kw">NOT</span> <span class="kw">NULL</span>;</span>
<span id="cb417-5"><a aria-hidden="true" href="#cb417-5" tabindex="-1"></a></span>
<span id="cb417-6"><a aria-hidden="true" href="#cb417-6" tabindex="-1"></a><span class="co">-- Example output:</span></span>
<span id="cb417-7"><a aria-hidden="true" href="#cb417-7" tabindex="-1"></a>  pid  | wait_event_type |     wait_event      | <span class="kw">query</span></span>
<span id="cb417-8"><a aria-hidden="true" href="#cb417-8" tabindex="-1"></a><span class="co">-------+-----------------+---------------------+----------------</span></span>
<span id="cb417-9"><a aria-hidden="true" href="#cb417-9" tabindex="-1"></a>  <span class="dv">1234</span> | IO              | DataFileRead        | <span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span><span class="op">..</span>.</span>
<span id="cb417-10"><a aria-hidden="true" href="#cb417-10" tabindex="-1"></a>  <span class="dv">1235</span> | <span class="kw">Lock</span>            | relation            | <span class="kw">ALTER</span> <span class="kw">TABLE</span><span class="op">..</span>.</span>
<span id="cb417-11"><a aria-hidden="true" href="#cb417-11" tabindex="-1"></a>  <span class="dv">1236</span> | Client          | ClientRead          | <span class="op">&lt;</span>idle<span class="op">&gt;</span></span>
<span id="cb417-12"><a aria-hidden="true" href="#cb417-12" tabindex="-1"></a>  <span class="dv">1237</span> | LWLock          | WALInsertLock       | <span class="kw">INSERT</span> <span class="kw">INTO</span><span class="op">..</span>.</span></code></pre></div>
<h2 data-number="7.8" id="clientserver-protocol"><span class="header-section-number">7.8</span> 7. Client/Server Protocol</h2>
<h3 data-number="7.8.1" id="connection-establishment"><span class="header-section-number">7.8.1</span> 7.1 Connection
Establishment</h3>
<p>The PostgreSQL client/server protocol operates over TCP/IP or Unix
domain sockets:</p>
<pre><code>Connection Establishment:

Client                                    Server (Backend)
  ‚îÇ                                            ‚îÇ
  ‚îÇ 1. TCP connect to port 5432                ‚îÇ
  ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ&gt;‚îÇ
  ‚îÇ                                            ‚îÇ
  ‚îÇ 2. Send SSLRequest (optional)              ‚îÇ
  ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ&gt;‚îÇ
  ‚îÇ&lt;‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
  ‚îÇ 3. Response: 'S' (SSL) or 'N' (no SSL)     ‚îÇ
  ‚îÇ                                            ‚îÇ
  ‚îÇ [If SSL accepted, perform TLS handshake]   ‚îÇ
  ‚îÇ                                            ‚îÇ
  ‚îÇ 4. Send StartupMessage                     ‚îÇ
  ‚îÇ    - Protocol version (3.0)                ‚îÇ
  ‚îÇ    - user=username                         ‚îÇ
  ‚îÇ    - database=dbname                       ‚îÇ
  ‚îÇ    - application_name=...                  ‚îÇ
  ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ&gt;‚îÇ
  ‚îÇ                                            ‚îÇ
  ‚îÇ                                            ‚îÇ 5. Check pg_hba.conf
  ‚îÇ                                            ‚îÇ    Determine auth method
  ‚îÇ                                            ‚îÇ
  ‚îÇ&lt;‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
  ‚îÇ 6. AuthenticationRequest                   ‚îÇ
  ‚îÇ    - AuthenticationOk (trust)              ‚îÇ
  ‚îÇ    - AuthenticationCleartextPassword       ‚îÇ
  ‚îÇ    - AuthenticationMD5Password             ‚îÇ
  ‚îÇ    - AuthenticationSASL                    ‚îÇ
  ‚îÇ    - etc.                                  ‚îÇ
  ‚îÇ                                            ‚îÇ
  ‚îÇ 7. PasswordMessage (if needed)             ‚îÇ
  ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ&gt;‚îÇ
  ‚îÇ                                            ‚îÇ
  ‚îÇ                                            ‚îÇ 8. Verify password
  ‚îÇ                                            ‚îÇ
  ‚îÇ&lt;‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
  ‚îÇ 9. AuthenticationOk                        ‚îÇ
  ‚îÇ                                            ‚îÇ
  ‚îÇ&lt;‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
  ‚îÇ 10. ParameterStatus messages               ‚îÇ
  ‚îÇ     - server_version                       ‚îÇ
  ‚îÇ     - server_encoding                      ‚îÇ
  ‚îÇ     - client_encoding                      ‚îÇ
  ‚îÇ     - etc.                                 ‚îÇ
  ‚îÇ                                            ‚îÇ
  ‚îÇ&lt;‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
  ‚îÇ 11. BackendKeyData                         ‚îÇ
  ‚îÇ     - Process ID                           ‚îÇ
  ‚îÇ     - Secret key (for cancel requests)     ‚îÇ
  ‚îÇ                                            ‚îÇ
  ‚îÇ&lt;‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
  ‚îÇ 12. ReadyForQuery                          ‚îÇ
  ‚îÇ     - Transaction status: 'I' (idle)       ‚îÇ
  ‚îÇ                                            ‚îÇ
  ‚îÇ [Connection established, ready for queries]‚îÇ</code></pre>
<h3 data-number="7.8.2" id="message-format"><span class="header-section-number">7.8.2</span> 7.2 Message Format</h3>
<p>All messages after startup follow this format:</p>
<pre><code>‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Type (1B)  ‚îÇ Length (4B)  ‚îÇ Message Data (variable) ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

Type: Single character identifying message type
Length: Int32 - total length including length field itself
Data: Message-specific data</code></pre>
<h3 data-number="7.8.3" id="message-types"><span class="header-section-number">7.8.3</span> 7.3 Message Types</h3>
<p><strong>Client ‚Üí Server</strong>:</p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Name</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>‚ÄòQ‚Äô</strong></td>
<td>Query</td>
<td>Simple query (SQL string)</td>
</tr>
<tr>
<td><strong>‚ÄòP‚Äô</strong></td>
<td>Parse</td>
<td>Parse prepared statement</td>
</tr>
<tr>
<td><strong>‚ÄòB‚Äô</strong></td>
<td>Bind</td>
<td>Bind parameters to statement</td>
</tr>
<tr>
<td><strong>‚ÄòE‚Äô</strong></td>
<td>Execute</td>
<td>Execute portal</td>
</tr>
<tr>
<td><strong>‚ÄòD‚Äô</strong></td>
<td>Describe</td>
<td>Describe statement or portal</td>
</tr>
<tr>
<td><strong>‚ÄòC‚Äô</strong></td>
<td>Close</td>
<td>Close statement or portal</td>
</tr>
<tr>
<td><strong>‚ÄòS‚Äô</strong></td>
<td>Sync</td>
<td>Synchronize extended query</td>
</tr>
<tr>
<td><strong>‚ÄòX‚Äô</strong></td>
<td>Terminate</td>
<td>Close connection</td>
</tr>
<tr>
<td><strong>‚ÄòF‚Äô</strong></td>
<td>FunctionCall</td>
<td>Call function (fastpath)</td>
</tr>
<tr>
<td><strong>‚Äòd‚Äô</strong></td>
<td>CopyData</td>
<td>COPY data stream</td>
</tr>
<tr>
<td><strong>‚Äòc‚Äô</strong></td>
<td>CopyDone</td>
<td>COPY complete</td>
</tr>
<tr>
<td><strong>‚Äòf‚Äô</strong></td>
<td>CopyFail</td>
<td>COPY failed</td>
</tr>
</tbody>
</table>
<p><strong>Server ‚Üí Client</strong>:</p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Name</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>‚ÄòR‚Äô</strong></td>
<td>Authentication</td>
<td>Authentication request/response</td>
</tr>
<tr>
<td><strong>‚ÄòK‚Äô</strong></td>
<td>BackendKeyData</td>
<td>Cancel key data</td>
</tr>
<tr>
<td><strong>‚ÄòS‚Äô</strong></td>
<td>ParameterStatus</td>
<td>Runtime parameter status</td>
</tr>
<tr>
<td><strong>‚ÄòZ‚Äô</strong></td>
<td>ReadyForQuery</td>
<td>Ready for new query</td>
</tr>
<tr>
<td><strong>‚ÄòT‚Äô</strong></td>
<td>RowDescription</td>
<td>Row column descriptions</td>
</tr>
<tr>
<td><strong>‚ÄòD‚Äô</strong></td>
<td>DataRow</td>
<td>Row data</td>
</tr>
<tr>
<td><strong>‚ÄòC‚Äô</strong></td>
<td>CommandComplete</td>
<td>Query completed</td>
</tr>
<tr>
<td><strong>‚ÄòE‚Äô</strong></td>
<td>ErrorResponse</td>
<td>Error occurred</td>
</tr>
<tr>
<td><strong>‚ÄòN‚Äô</strong></td>
<td>NoticeResponse</td>
<td>Notice message</td>
</tr>
<tr>
<td><strong>‚Äò1‚Äô</strong></td>
<td>ParseComplete</td>
<td>Parse completed</td>
</tr>
<tr>
<td><strong>‚Äò2‚Äô</strong></td>
<td>BindComplete</td>
<td>Bind completed</td>
</tr>
<tr>
<td><strong>‚Äò3‚Äô</strong></td>
<td>CloseComplete</td>
<td>Close completed</td>
</tr>
<tr>
<td><strong>‚ÄòI‚Äô</strong></td>
<td>EmptyQueryResponse</td>
<td>Empty query</td>
</tr>
<tr>
<td><strong>‚Äòs‚Äô</strong></td>
<td>PortalSuspended</td>
<td>Portal suspended (partial results)</td>
</tr>
<tr>
<td><strong>‚Äòn‚Äô</strong></td>
<td>NoData</td>
<td>No data returned</td>
</tr>
<tr>
<td><strong>‚ÄòA‚Äô</strong></td>
<td>NotificationResponse</td>
<td>Asynchronous notification</td>
</tr>
<tr>
<td><strong>‚Äòd‚Äô</strong></td>
<td>CopyData</td>
<td>COPY data stream</td>
</tr>
<tr>
<td><strong>‚Äòc‚Äô</strong></td>
<td>CopyDone</td>
<td>COPY complete</td>
</tr>
<tr>
<td><strong>‚ÄòG‚Äô</strong></td>
<td>CopyInResponse</td>
<td>Ready for COPY IN</td>
</tr>
<tr>
<td><strong>‚ÄòH‚Äô</strong></td>
<td>CopyOutResponse</td>
<td>Starting COPY OUT</td>
</tr>
</tbody>
</table>
<h3 data-number="7.8.4" id="simple-query-protocol"><span class="header-section-number">7.8.4</span> 7.4 Simple Query
Protocol</h3>
<p>The simple query protocol is used for single SQL statements:</p>
<pre><code>Client                                    Server
  ‚îÇ                                            ‚îÇ
  ‚îÇ Query('Q')                                 ‚îÇ
  ‚îÇ "SELECT * FROM users WHERE id = 1"         ‚îÇ
  ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ&gt;‚îÇ
  ‚îÇ                                            ‚îÇ
  ‚îÇ                                            ‚îÇ Parse query
  ‚îÇ                                            ‚îÇ Plan query
  ‚îÇ                                            ‚îÇ Execute query
  ‚îÇ                                            ‚îÇ
  ‚îÇ&lt;‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
  ‚îÇ RowDescription('T')                        ‚îÇ
  ‚îÇ - Field count: 3                           ‚îÇ
  ‚îÇ - Field 1: "id", type=23 (int4)            ‚îÇ
  ‚îÇ - Field 2: "name", type=25 (text)          ‚îÇ
  ‚îÇ - Field 3: "email", type=25 (text)         ‚îÇ
  ‚îÇ                                            ‚îÇ
  ‚îÇ&lt;‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
  ‚îÇ DataRow('D')                               ‚îÇ
  ‚îÇ - Field count: 3                           ‚îÇ
  ‚îÇ - Value 1: "1"                             ‚îÇ
  ‚îÇ - Value 2: "Alice"                         ‚îÇ
  ‚îÇ - Value 3: "alice@example.com"             ‚îÇ
  ‚îÇ                                            ‚îÇ
  ‚îÇ&lt;‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
  ‚îÇ CommandComplete('C')                       ‚îÇ
  ‚îÇ "SELECT 1"                                 ‚îÇ
  ‚îÇ                                            ‚îÇ
  ‚îÇ&lt;‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
  ‚îÇ ReadyForQuery('Z')                         ‚îÇ
  ‚îÇ Status: 'I' (idle)                         ‚îÇ</code></pre>
<p><strong>Code Flow</strong>:</p>
<div class="sourceCode" id="cb421"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb421-1"><a aria-hidden="true" href="#cb421-1" tabindex="-1"></a><span class="co">/* exec_simple_query from src/backend/tcop/postgres.c */</span></span>
<span id="cb421-2"><a aria-hidden="true" href="#cb421-2" tabindex="-1"></a><span class="dt">void</span></span>
<span id="cb421-3"><a aria-hidden="true" href="#cb421-3" tabindex="-1"></a>exec_simple_query<span class="op">(</span><span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>query_string<span class="op">)</span></span>
<span id="cb421-4"><a aria-hidden="true" href="#cb421-4" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb421-5"><a aria-hidden="true" href="#cb421-5" tabindex="-1"></a>    <span class="co">/* Start transaction if not already in one */</span></span>
<span id="cb421-6"><a aria-hidden="true" href="#cb421-6" tabindex="-1"></a>    start_xact_command<span class="op">();</span></span>
<span id="cb421-7"><a aria-hidden="true" href="#cb421-7" tabindex="-1"></a></span>
<span id="cb421-8"><a aria-hidden="true" href="#cb421-8" tabindex="-1"></a>    <span class="co">/* Parse the query */</span></span>
<span id="cb421-9"><a aria-hidden="true" href="#cb421-9" tabindex="-1"></a>    parsetree_list <span class="op">=</span> pg_parse_query<span class="op">(</span>query_string<span class="op">);</span></span>
<span id="cb421-10"><a aria-hidden="true" href="#cb421-10" tabindex="-1"></a></span>
<span id="cb421-11"><a aria-hidden="true" href="#cb421-11" tabindex="-1"></a>    <span class="co">/* For each statement in the query string */</span></span>
<span id="cb421-12"><a aria-hidden="true" href="#cb421-12" tabindex="-1"></a>    foreach<span class="op">(</span>parsetree_item<span class="op">,</span> parsetree_list<span class="op">)</span></span>
<span id="cb421-13"><a aria-hidden="true" href="#cb421-13" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb421-14"><a aria-hidden="true" href="#cb421-14" tabindex="-1"></a>        RawStmt <span class="op">*</span>parsetree <span class="op">=</span> lfirst_node<span class="op">(</span>RawStmt<span class="op">,</span> parsetree_item<span class="op">);</span></span>
<span id="cb421-15"><a aria-hidden="true" href="#cb421-15" tabindex="-1"></a></span>
<span id="cb421-16"><a aria-hidden="true" href="#cb421-16" tabindex="-1"></a>        <span class="co">/* Analyze and rewrite */</span></span>
<span id="cb421-17"><a aria-hidden="true" href="#cb421-17" tabindex="-1"></a>        querytree_list <span class="op">=</span> pg_analyze_and_rewrite<span class="op">(</span>parsetree<span class="op">,</span> <span class="op">...);</span></span>
<span id="cb421-18"><a aria-hidden="true" href="#cb421-18" tabindex="-1"></a></span>
<span id="cb421-19"><a aria-hidden="true" href="#cb421-19" tabindex="-1"></a>        <span class="co">/* Plan and execute */</span></span>
<span id="cb421-20"><a aria-hidden="true" href="#cb421-20" tabindex="-1"></a>        foreach<span class="op">(</span>querytree_item<span class="op">,</span> querytree_list<span class="op">)</span></span>
<span id="cb421-21"><a aria-hidden="true" href="#cb421-21" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb421-22"><a aria-hidden="true" href="#cb421-22" tabindex="-1"></a>            Query <span class="op">*</span>querytree <span class="op">=</span> lfirst_node<span class="op">(</span>Query<span class="op">,</span> querytree_item<span class="op">);</span></span>
<span id="cb421-23"><a aria-hidden="true" href="#cb421-23" tabindex="-1"></a>            PlannedStmt <span class="op">*</span>plan<span class="op">;</span></span>
<span id="cb421-24"><a aria-hidden="true" href="#cb421-24" tabindex="-1"></a></span>
<span id="cb421-25"><a aria-hidden="true" href="#cb421-25" tabindex="-1"></a>            <span class="co">/* Create execution plan */</span></span>
<span id="cb421-26"><a aria-hidden="true" href="#cb421-26" tabindex="-1"></a>            plan <span class="op">=</span> pg_plan_query<span class="op">(</span>querytree<span class="op">,</span> <span class="op">...);</span></span>
<span id="cb421-27"><a aria-hidden="true" href="#cb421-27" tabindex="-1"></a></span>
<span id="cb421-28"><a aria-hidden="true" href="#cb421-28" tabindex="-1"></a>            <span class="co">/* Execute plan */</span></span>
<span id="cb421-29"><a aria-hidden="true" href="#cb421-29" tabindex="-1"></a>            portal <span class="op">=</span> CreatePortal<span class="op">(...);</span></span>
<span id="cb421-30"><a aria-hidden="true" href="#cb421-30" tabindex="-1"></a>            PortalDefineQuery<span class="op">(</span>portal<span class="op">,</span> <span class="op">...);</span></span>
<span id="cb421-31"><a aria-hidden="true" href="#cb421-31" tabindex="-1"></a>            PortalStart<span class="op">(</span>portal<span class="op">,</span> <span class="op">...);</span></span>
<span id="cb421-32"><a aria-hidden="true" href="#cb421-32" tabindex="-1"></a></span>
<span id="cb421-33"><a aria-hidden="true" href="#cb421-33" tabindex="-1"></a>            <span class="co">/* Fetch all rows and send to client */</span></span>
<span id="cb421-34"><a aria-hidden="true" href="#cb421-34" tabindex="-1"></a>            PortalRun<span class="op">(</span>portal<span class="op">,</span> FETCH_ALL<span class="op">,</span> <span class="op">...);</span></span>
<span id="cb421-35"><a aria-hidden="true" href="#cb421-35" tabindex="-1"></a></span>
<span id="cb421-36"><a aria-hidden="true" href="#cb421-36" tabindex="-1"></a>            <span class="co">/* Send CommandComplete */</span></span>
<span id="cb421-37"><a aria-hidden="true" href="#cb421-37" tabindex="-1"></a>            EndCommand<span class="op">(</span>completionTag<span class="op">,</span> DestRemote<span class="op">);</span></span>
<span id="cb421-38"><a aria-hidden="true" href="#cb421-38" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb421-39"><a aria-hidden="true" href="#cb421-39" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb421-40"><a aria-hidden="true" href="#cb421-40" tabindex="-1"></a></span>
<span id="cb421-41"><a aria-hidden="true" href="#cb421-41" tabindex="-1"></a>    <span class="co">/* Commit transaction */</span></span>
<span id="cb421-42"><a aria-hidden="true" href="#cb421-42" tabindex="-1"></a>    finish_xact_command<span class="op">();</span></span>
<span id="cb421-43"><a aria-hidden="true" href="#cb421-43" tabindex="-1"></a></span>
<span id="cb421-44"><a aria-hidden="true" href="#cb421-44" tabindex="-1"></a>    <span class="co">/* Send ReadyForQuery */</span></span>
<span id="cb421-45"><a aria-hidden="true" href="#cb421-45" tabindex="-1"></a>    ReadyForQuery<span class="op">(</span>DestRemote<span class="op">);</span></span>
<span id="cb421-46"><a aria-hidden="true" href="#cb421-46" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 data-number="7.8.5" id="extended-query-protocol"><span class="header-section-number">7.8.5</span> 7.5 Extended Query
Protocol</h3>
<p>The extended query protocol allows prepared statements, parameterized
queries, and retrieving results in chunks:</p>
<pre><code>Client                                    Server
  ‚îÇ                                            ‚îÇ
  ‚îÇ Parse('P')                                 ‚îÇ
  ‚îÇ - Statement name: "S1"                     ‚îÇ
  ‚îÇ - Query: "SELECT * FROM users WHERE id=$1" ‚îÇ
  ‚îÇ - Parameter types: [int4]                  ‚îÇ
  ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ&gt;‚îÇ
  ‚îÇ                                            ‚îÇ Parse query
  ‚îÇ                                            ‚îÇ Save prepared statement
  ‚îÇ&lt;‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
  ‚îÇ ParseComplete('1')                         ‚îÇ
  ‚îÇ                                            ‚îÇ
  ‚îÇ Bind('B')                                  ‚îÇ
  ‚îÇ - Portal name: ""                          ‚îÇ
  ‚îÇ - Statement name: "S1"                     ‚îÇ
  ‚îÇ - Parameter values: [42]                   ‚îÇ
  ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ&gt;‚îÇ
  ‚îÇ                                            ‚îÇ Bind parameters
  ‚îÇ&lt;‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
  ‚îÇ BindComplete('2')                          ‚îÇ
  ‚îÇ                                            ‚îÇ
  ‚îÇ Describe('D')                              ‚îÇ
  ‚îÇ - Type: 'P' (portal)                       ‚îÇ
  ‚îÇ - Name: ""                                 ‚îÇ
  ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ&gt;‚îÇ
  ‚îÇ&lt;‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
  ‚îÇ RowDescription('T')                        ‚îÇ
  ‚îÇ [field descriptions]                       ‚îÇ
  ‚îÇ                                            ‚îÇ
  ‚îÇ Execute('E')                               ‚îÇ
  ‚îÇ - Portal name: ""                          ‚îÇ
  ‚îÇ - Max rows: 0 (all)                        ‚îÇ
  ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ&gt;‚îÇ
  ‚îÇ                                            ‚îÇ Execute portal
  ‚îÇ&lt;‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
  ‚îÇ DataRow('D') ... DataRow('D')              ‚îÇ
  ‚îÇ&lt;‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
  ‚îÇ CommandComplete('C')                       ‚îÇ
  ‚îÇ                                            ‚îÇ
  ‚îÇ Sync('S')                                  ‚îÇ
  ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ&gt;‚îÇ
  ‚îÇ&lt;‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
  ‚îÇ ReadyForQuery('Z')                         ‚îÇ</code></pre>
<p><strong>Advantages of Extended Protocol</strong>: -
<strong>Parameterization</strong>: Prevents SQL injection, enables plan
reuse - <strong>Type Safety</strong>: Server knows parameter types in
advance - <strong>Partial Results</strong>: Can fetch N rows at a time
(cursors) - <strong>Binary Format</strong>: Can transfer data in binary
(more efficient) - <strong>Pipelining</strong>: Can send multiple
messages before reading responses</p>
<h2 data-number="7.9" id="authentication"><span class="header-section-number">7.9</span> 8. Authentication</h2>
<h3 data-number="7.9.1" id="pg_hba.conf-rules"><span class="header-section-number">7.9.1</span> 8.1 pg_hba.conf Rules</h3>
<p>Authentication is controlled by <code>pg_hba.conf</code> (host-based
authentication):</p>
<pre><code># TYPE  DATABASE    USER        ADDRESS         METHOD

# Local connections (Unix socket)
local   all         postgres                    trust
local   all         all                         peer

# IPv4 local connections
host    all         all         127.0.0.1/32    scram-sha-256
host    all         all         10.0.0.0/8      md5

# IPv6 local connections
host    all         all         ::1/128         scram-sha-256

# Replication connections
host    replication replicator  10.0.0.0/8      scram-sha-256

# Specific database/user combinations
host    production  webapp      192.168.1.0/24  scram-sha-256
host    analytics   analyst     192.168.2.0/24  ldap</code></pre>
<p><strong>Fields</strong>: 1. <strong>TYPE</strong>: Connection type
(local, host, hostssl, hostnossl) 2. <strong>DATABASE</strong>: Which
database(s) the rule applies to 3. <strong>USER</strong>: Which user(s)
the rule applies to 4. <strong>ADDRESS</strong>: Client IP address range
(for host connections) 5. <strong>METHOD</strong>: Authentication method
to use</p>
<h3 data-number="7.9.2" id="authentication-methods"><span class="header-section-number">7.9.2</span> 8.2 Authentication
Methods</h3>
<table>
<colgroup>
<col style="width: 19%"/>
<col style="width: 31%"/>
<col style="width: 24%"/>
<col style="width: 24%"/>
</colgroup>
<thead>
<tr>
<th>Method</th>
<th>Description</th>
<th>Security</th>
<th>Use Case</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>trust</strong></td>
<td>No authentication</td>
<td>None</td>
<td>Development only</td>
</tr>
<tr>
<td><strong>reject</strong></td>
<td>Reject connection</td>
<td>N/A</td>
<td>Explicitly block access</td>
</tr>
<tr>
<td><strong>scram-sha-256</strong></td>
<td>SCRAM-SHA-256 challenge</td>
<td>Strong</td>
<td><strong>Recommended for production</strong></td>
</tr>
<tr>
<td><strong>md5</strong></td>
<td>MD5 password hash</td>
<td>Medium</td>
<td>Legacy (deprecated)</td>
</tr>
<tr>
<td><strong>password</strong></td>
<td>Plaintext password</td>
<td>Weak</td>
<td>Never use over network</td>
</tr>
<tr>
<td><strong>peer</strong></td>
<td>OS username match</td>
<td>Medium</td>
<td>Local connections only</td>
</tr>
<tr>
<td><strong>ident</strong></td>
<td>Remote ident server</td>
<td>Weak</td>
<td>Legacy systems</td>
</tr>
<tr>
<td><strong>gss</strong></td>
<td>GSSAPI/Kerberos</td>
<td>Strong</td>
<td>Enterprise environments</td>
</tr>
<tr>
<td><strong>sspi</strong></td>
<td>Windows SSPI</td>
<td>Strong</td>
<td>Windows Active Directory</td>
</tr>
<tr>
<td><strong>ldap</strong></td>
<td>LDAP server</td>
<td>Medium</td>
<td>Centralized auth</td>
</tr>
<tr>
<td><strong>radius</strong></td>
<td>RADIUS server</td>
<td>Medium</td>
<td>Network access control</td>
</tr>
<tr>
<td><strong>cert</strong></td>
<td>SSL client certificate</td>
<td>Strong</td>
<td>Certificate-based auth</td>
</tr>
<tr>
<td><strong>pam</strong></td>
<td>PAM (Pluggable Auth)</td>
<td>Varies</td>
<td>System authentication</td>
</tr>
</tbody>
</table>
<h3 data-number="7.9.3" id="scram-sha-256-authentication-flow"><span class="header-section-number">7.9.3</span> 8.3 SCRAM-SHA-256
Authentication Flow</h3>
<p>SCRAM (Salted Challenge Response Authentication Mechanism) is the
most secure password-based method:</p>
<pre><code>Client                                    Server
  ‚îÇ                                            ‚îÇ
  ‚îÇ 1. StartupMessage                          ‚îÇ
  ‚îÇ    user=alice, database=mydb               ‚îÇ
  ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ&gt;‚îÇ
  ‚îÇ                                            ‚îÇ
  ‚îÇ                                            ‚îÇ Check pg_hba.conf
  ‚îÇ                                            ‚îÇ Method: scram-sha-256
  ‚îÇ                                            ‚îÇ
  ‚îÇ&lt;‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
  ‚îÇ 2. AuthenticationSASL                      ‚îÇ
  ‚îÇ    Mechanisms: [SCRAM-SHA-256]             ‚îÇ
  ‚îÇ                                            ‚îÇ
  ‚îÇ 3. SASLInitialResponse                     ‚îÇ
  ‚îÇ    Selected: SCRAM-SHA-256                 ‚îÇ
  ‚îÇ    Client nonce: &lt;random&gt;                  ‚îÇ
  ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ&gt;‚îÇ
  ‚îÇ                                            ‚îÇ
  ‚îÇ                                            ‚îÇ Generate server nonce
  ‚îÇ                                            ‚îÇ Get stored password hash
  ‚îÇ                                            ‚îÇ
  ‚îÇ&lt;‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
  ‚îÇ 4. AuthenticationSASLContinue              ‚îÇ
  ‚îÇ    Server nonce: &lt;random&gt;                  ‚îÇ
  ‚îÇ    Salt: &lt;from stored password&gt;            ‚îÇ
  ‚îÇ    Iterations: 4096                        ‚îÇ
  ‚îÇ                                            ‚îÇ
  ‚îÇ Derive key from password                   ‚îÇ
  ‚îÇ Create client proof                        ‚îÇ
  ‚îÇ                                            ‚îÇ
  ‚îÇ 5. SASLResponse                            ‚îÇ
  ‚îÇ    Client proof: &lt;proof&gt;                   ‚îÇ
  ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ&gt;‚îÇ
  ‚îÇ                                            ‚îÇ
  ‚îÇ                                            ‚îÇ Verify client proof
  ‚îÇ                                            ‚îÇ Generate server signature
  ‚îÇ                                            ‚îÇ
  ‚îÇ&lt;‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
  ‚îÇ 6. AuthenticationSASLFinal                 ‚îÇ
  ‚îÇ    Server signature: &lt;signature&gt;           ‚îÇ
  ‚îÇ                                            ‚îÇ
  ‚îÇ Verify server signature                    ‚îÇ
  ‚îÇ                                            ‚îÇ
  ‚îÇ&lt;‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
  ‚îÇ 7. AuthenticationOk                        ‚îÇ
  ‚îÇ                                            ‚îÇ
  ‚îÇ [Continue with connection setup]           ‚îÇ</code></pre>
<p><strong>Password Storage</strong> (in
<code>pg_authid.rolpassword</code>):</p>
<pre><code>SCRAM-SHA-256$&lt;iterations&gt;:&lt;salt&gt;$&lt;StoredKey&gt;:&lt;ServerKey&gt;</code></pre>
<p><strong>Security Properties</strong>: - Password never sent over
network - Salt prevents rainbow table attacks - Iterations (4096) make
brute force expensive - Server proves it knows password (mutual
authentication) - Resistant to replay attacks (nonces)</p>
<h3 data-number="7.9.4" id="ssltls-encryption"><span class="header-section-number">7.9.4</span> 8.4 SSL/TLS Encryption</h3>
<p>PostgreSQL supports SSL/TLS for encrypted connections:</p>
<p><strong>Server Configuration</strong>
(<code>postgresql.conf</code>):</p>
<div class="sourceCode" id="cb426"><pre class="sourceCode ini"><code class="sourceCode ini"><span id="cb426-1"><a aria-hidden="true" href="#cb426-1" tabindex="-1"></a><span class="dt">ssl </span><span class="ot">=</span><span class="st"> </span><span class="kw">on</span></span>
<span id="cb426-2"><a aria-hidden="true" href="#cb426-2" tabindex="-1"></a><span class="dt">ssl_cert_file </span><span class="ot">=</span><span class="st"> 'server.crt'</span></span>
<span id="cb426-3"><a aria-hidden="true" href="#cb426-3" tabindex="-1"></a><span class="dt">ssl_key_file </span><span class="ot">=</span><span class="st"> 'server.key'</span></span>
<span id="cb426-4"><a aria-hidden="true" href="#cb426-4" tabindex="-1"></a><span class="dt">ssl_ca_file </span><span class="ot">=</span><span class="st"> 'root.crt'           # For client certificate verification</span></span>
<span id="cb426-5"><a aria-hidden="true" href="#cb426-5" tabindex="-1"></a><span class="dt">ssl_crl_file </span><span class="ot">=</span><span class="st"> 'root.crl'          # Certificate revocation list</span></span>
<span id="cb426-6"><a aria-hidden="true" href="#cb426-6" tabindex="-1"></a></span>
<span id="cb426-7"><a aria-hidden="true" href="#cb426-7" tabindex="-1"></a><span class="co"># Cipher configuration</span></span>
<span id="cb426-8"><a aria-hidden="true" href="#cb426-8" tabindex="-1"></a><span class="dt">ssl_ciphers </span><span class="ot">=</span><span class="st"> 'HIGH:MEDIUM:+3DES:!aNULL'</span></span>
<span id="cb426-9"><a aria-hidden="true" href="#cb426-9" tabindex="-1"></a><span class="dt">ssl_prefer_server_ciphers </span><span class="ot">=</span><span class="st"> </span><span class="kw">on</span></span>
<span id="cb426-10"><a aria-hidden="true" href="#cb426-10" tabindex="-1"></a><span class="dt">ssl_min_protocol_version </span><span class="ot">=</span><span class="st"> 'TLSv1.2'</span></span></code></pre></div>
<p><strong>Client Connection</strong>:</p>
<div class="sourceCode" id="cb427"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb427-1"><a aria-hidden="true" href="#cb427-1" tabindex="-1"></a><span class="co"># Require SSL</span></span>
<span id="cb427-2"><a aria-hidden="true" href="#cb427-2" tabindex="-1"></a><span class="ex">psql</span> <span class="st">"host=db.example.com sslmode=require dbname=mydb user=alice"</span></span>
<span id="cb427-3"><a aria-hidden="true" href="#cb427-3" tabindex="-1"></a></span>
<span id="cb427-4"><a aria-hidden="true" href="#cb427-4" tabindex="-1"></a><span class="co"># Verify server certificate</span></span>
<span id="cb427-5"><a aria-hidden="true" href="#cb427-5" tabindex="-1"></a><span class="ex">psql</span> <span class="st">"host=db.example.com sslmode=verify-full sslrootcert=root.crt dbname=mydb user=alice"</span></span>
<span id="cb427-6"><a aria-hidden="true" href="#cb427-6" tabindex="-1"></a></span>
<span id="cb427-7"><a aria-hidden="true" href="#cb427-7" tabindex="-1"></a><span class="co"># Client certificate authentication</span></span>
<span id="cb427-8"><a aria-hidden="true" href="#cb427-8" tabindex="-1"></a><span class="ex">psql</span> <span class="st">"host=db.example.com sslcert=client.crt sslkey=client.key dbname=mydb user=alice"</span></span></code></pre></div>
<p><strong>SSL Modes</strong>: - <code>disable</code>: No SSL -
<code>allow</code>: Try SSL, fall back to plain - <code>prefer</code>:
Try SSL first (default) - <code>require</code>: Require SSL (don‚Äôt
verify certificate) - <code>verify-ca</code>: Require SSL, verify CA -
<code>verify-full</code>: Require SSL, verify CA and hostname</p>
<h2 data-number="7.10" id="shutdown-modes"><span class="header-section-number">7.10</span> 9. Shutdown Modes</h2>
<p>PostgreSQL supports three shutdown modes, each with different
tradeoffs between speed and safety.</p>
<h3 data-number="7.10.1" id="smart-shutdown-sigterm"><span class="header-section-number">7.10.1</span> 9.1 Smart Shutdown
(SIGTERM)</h3>
<p><strong>Command</strong>: <code>pg_ctl stop -m smart</code> or
<code>kill -TERM &lt;postmaster_pid&gt;</code></p>
<p><strong>Behavior</strong>: 1. Postmaster stops accepting new
connections 2. Existing client sessions continue normally 3. Waits for
all clients to disconnect 4. Once all clients disconnected: - Performs
checkpoint - Shuts down auxiliary processes - Exits cleanly</p>
<p><strong>Use Case</strong>: Graceful shutdown when you can wait for
clients</p>
<p><strong>Sequence</strong>:</p>
<pre><code>1. Postmaster receives SIGTERM
2. Postmaster stops listening on sockets
3. Postmaster waits for all backends to exit
   [Could wait indefinitely if client doesn't disconnect]
4. Postmaster signals auxiliary processes to shutdown
5. Checkpointer performs final checkpoint
6. All processes exit
7. Postmaster exits</code></pre>
<p><strong>Process State</strong>:</p>
<div class="sourceCode" id="cb429"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb429-1"><a aria-hidden="true" href="#cb429-1" tabindex="-1"></a><span class="co"># During smart shutdown</span></span>
<span id="cb429-2"><a aria-hidden="true" href="#cb429-2" tabindex="-1"></a><span class="ex">$</span> ps aux <span class="kw">|</span> <span class="fu">grep</span> postgres</span>
<span id="cb429-3"><a aria-hidden="true" href="#cb429-3" tabindex="-1"></a><span class="ex">postgres</span>  1234  postmaster <span class="er">(</span><span class="ex">shutting</span> down<span class="kw">)</span></span>
<span id="cb429-4"><a aria-hidden="true" href="#cb429-4" tabindex="-1"></a><span class="ex">postgres</span>  1235  postgres: alice mydb [waiting for clients]</span>
<span id="cb429-5"><a aria-hidden="true" href="#cb429-5" tabindex="-1"></a><span class="ex">postgres</span>  1236  postgres: bob testdb [waiting for clients]</span></code></pre></div>
<h3 data-number="7.10.2" id="fast-shutdown-sigint"><span class="header-section-number">7.10.2</span> 9.2 Fast Shutdown
(SIGINT)</h3>
<p><strong>Command</strong>: <code>pg_ctl stop -m fast</code> or
<code>kill -INT &lt;postmaster_pid&gt;</code></p>
<p><strong>Behavior</strong>: 1. Postmaster stops accepting new
connections 2. Sends SIGTERM to all backends (disconnects clients) 3.
Waits for backends to exit cleanly 4. Performs checkpoint 5. Shuts down
cleanly</p>
<p><strong>Use Case</strong>: <strong>Standard shutdown method</strong>
- fast but safe</p>
<p><strong>Sequence</strong>:</p>
<pre><code>1. Postmaster receives SIGINT
2. Postmaster stops listening on sockets
3. Postmaster sends SIGTERM to all child processes
4. Backends:
   - Abort current transactions
   - Close client connections
   - Release resources
   - Exit
5. Checkpointer performs final checkpoint
6. All auxiliary processes shutdown
7. Postmaster exits</code></pre>
<p><strong>Client Experience</strong>:</p>
<pre><code>mydb=&gt; SELECT * FROM large_table;
FATAL:  terminating connection due to administrator command
server closed the connection unexpectedly</code></pre>
<h3 data-number="7.10.3" id="immediate-shutdown-sigquit"><span class="header-section-number">7.10.3</span> 9.3 Immediate Shutdown
(SIGQUIT)</h3>
<p><strong>Command</strong>: <code>pg_ctl stop -m immediate</code> or
<code>kill -QUIT &lt;postmaster_pid&gt;</code></p>
<p><strong>Behavior</strong>: 1. Postmaster sends SIGQUIT to all
children 2. All processes exit immediately without cleanup 3. No
checkpoint performed 4. <strong>Requires crash recovery on next
startup</strong></p>
<p><strong>Use Case</strong>: Emergency only‚Äîsystem is unresponsive or
corrupted</p>
<p><strong>Sequence</strong>:</p>
<pre><code>1. Postmaster receives SIGQUIT
2. Postmaster sends SIGQUIT to all children
3. All processes exit immediately
4. Postmaster exits
5. No checkpoint, no cleanup
6. Next startup will perform crash recovery</code></pre>
<p><strong>Warning</strong>: Immediate shutdown is equivalent to a
crash. Use only when: - Database is hung and not responding - Corruption
suspected - System is shutting down and you can‚Äôt wait - Testing crash
recovery procedures</p>
<p><strong>Recovery After Immediate Shutdown</strong>:</p>
<pre><code>$ pg_ctl start
waiting for server to start....
LOG:  database system was interrupted; last known up at 2025-11-19 10:30:15 UTC
LOG:  database system was not properly shut down; automatic recovery in progress
LOG:  redo starts at 0/1234568
LOG:  invalid record length at 0/1234890: wanted 24, got 0
LOG:  redo done at 0/1234850
LOG:  checkpoint starting: end-of-recovery immediate
LOG:  checkpoint complete: wrote 42 buffers (0.3%); 0 WAL file(s) added, 0 removed, 1 recycled
LOG:  database system is ready to accept connections</code></pre>
<h3 data-number="7.10.4" id="shutdown-comparison"><span class="header-section-number">7.10.4</span> 9.4 Shutdown Comparison</h3>
<table>
<thead>
<tr>
<th>Aspect</th>
<th>Smart</th>
<th>Fast</th>
<th>Immediate</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>New connections</strong></td>
<td>Rejected</td>
<td>Rejected</td>
<td>N/A (instant exit)</td>
</tr>
<tr>
<td><strong>Existing sessions</strong></td>
<td>Continue</td>
<td>Terminated</td>
<td>Terminated</td>
</tr>
<tr>
<td><strong>Wait for clients</strong></td>
<td>Yes</td>
<td>No</td>
<td>No</td>
</tr>
<tr>
<td><strong>Checkpoint</strong></td>
<td>Yes</td>
<td>Yes</td>
<td>No</td>
</tr>
<tr>
<td><strong>Recovery needed</strong></td>
<td>No</td>
<td>No</td>
<td><strong>Yes</strong></td>
</tr>
<tr>
<td><strong>Speed</strong></td>
<td>Slow (indefinite)</td>
<td>Fast (seconds)</td>
<td>Instant</td>
</tr>
<tr>
<td><strong>Safety</strong></td>
<td>Safest</td>
<td>Safe</td>
<td>Unsafe</td>
</tr>
<tr>
<td><strong>Recommended use</strong></td>
<td>Maintenance</td>
<td><strong>Standard</strong></td>
<td>Emergency only</td>
</tr>
</tbody>
</table>
<h2 data-number="7.11" id="process-state-diagrams"><span class="header-section-number">7.11</span> 10. Process State
Diagrams</h2>
<h3 data-number="7.11.1" id="complete-backend-state-machine"><span class="header-section-number">7.11.1</span> 10.1 Complete Backend State
Machine</h3>
<pre><code>Backend Process Lifecycle State Machine:

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  NOT_STARTED    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚îÇ fork()
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   FORKED        ‚îÇ  Process created, initializing
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚îÇ Setup signal handlers, attach shared memory
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ AUTHENTICATING  ‚îÇ  Reading startup packet, checking pg_hba.conf
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚îÇ Authentication success
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ INITIALIZING    ‚îÇ  Loading database, initializing subsystems
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚îÇ Send ReadyForQuery
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ      IDLE       ‚îÇ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                           ‚îÇ
         ‚îÇ                                    ‚îÇ
         ‚îÇ Receive Query                      ‚îÇ
         ‚îÇ                                    ‚îÇ
         ‚ñº                                    ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                           ‚îÇ
‚îÇ    RUNNING      ‚îÇ  Executing query          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                           ‚îÇ
         ‚îÇ                                    ‚îÇ
         ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫ Query complete ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
         ‚îÇ                                    ‚îÇ
         ‚îÇ BEGIN                              ‚îÇ
         ‚îÇ                                    ‚îÇ
         ‚ñº                                    ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                   ‚îÇ
‚îÇ IDLE_IN_TRANSACTION     ‚îÇ                   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                   ‚îÇ
         ‚îÇ                                    ‚îÇ
         ‚îÇ Execute statement                  ‚îÇ
         ‚îÇ                                    ‚îÇ
         ‚ñº                                    ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                 ‚îÇ
‚îÇ RUNNING_IN_TRANSACTION    ‚îÇ                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                 ‚îÇ
         ‚îÇ                                    ‚îÇ
         ‚îú‚îÄ‚îÄ‚ñ∫ Statement OK ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
         ‚îÇ                                    ‚îÇ
         ‚îÇ Error                              ‚îÇ
         ‚îÇ                                    ‚îÇ
         ‚ñº                                    ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê          ‚îÇ
‚îÇ IDLE_IN_TRANSACTION_ABORTED      ‚îÇ          ‚îÇ
‚îÇ (must ROLLBACK)                  ‚îÇ          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò          ‚îÇ
         ‚îÇ                                    ‚îÇ
         ‚îÇ ROLLBACK                           ‚îÇ
         ‚îÇ                                    ‚îÇ
         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

Additional States:

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  FASTPATH       ‚îÇ  Executing function via fastpath protocol
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  COPY_IN        ‚îÇ  Receiving COPY data from client
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  COPY_OUT       ‚îÇ  Sending COPY data to client
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  COPY_BOTH      ‚îÇ  Bidirectional COPY (replication)
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ PORTAL_RUNNING  ‚îÇ  Executing portal (cursor)
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   DISABLED      ‚îÇ  Backend shutting down, no new commands
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   TERMINATED    ‚îÇ  Process exited
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò</code></pre>
<h3 data-number="7.11.2" id="postmaster-state-machine"><span class="header-section-number">7.11.2</span> 10.2 Postmaster State
Machine</h3>
<pre><code>Postmaster Lifecycle:

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   STARTUP    ‚îÇ  Reading config, creating shared memory
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚îÇ Initialization complete
       ‚îÇ
       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   RECOVERY   ‚îÇ  Startup process performing crash/archive recovery
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚îÇ Recovery complete
       ‚îÇ
       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   RUNNING    ‚îÇ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  Normal operation
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                ‚îÇ
       ‚îÇ                        ‚îÇ
       ‚îÇ Receive SIGHUP         ‚îÇ
       ‚îÇ                        ‚îÇ
       ‚ñº                        ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                ‚îÇ
‚îÇ   RELOADING  ‚îÇ  Re-reading config, signaling children
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                ‚îÇ
       ‚îÇ                        ‚îÇ
       ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

From RUNNING:

       ‚îÇ Receive SIGTERM (smart)
       ‚îÇ
       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ SMART_SHUTDOWN   ‚îÇ  Waiting for clients to disconnect
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚îÇ All clients gone
       ‚îÇ
       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   CHECKPOINTING  ‚îÇ  Final checkpoint
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   SHUTDOWN       ‚îÇ  Stopping all processes
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ     EXITED       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

From RUNNING:

       ‚îÇ Receive SIGINT (fast)
       ‚îÇ
       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  FAST_SHUTDOWN   ‚îÇ  Terminating all backends
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚îÇ All backends terminated
       ‚îÇ
       ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫ CHECKPOINTING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫ SHUTDOWN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫ EXITED

From RUNNING:

       ‚îÇ Receive SIGQUIT (immediate)
       ‚îÇ
       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇIMMEDIATE_SHUTDOWN‚îÇ  Killing all processes
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚îÇ (no checkpoint)
       ‚îÇ
       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ     EXITED       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

From RUNNING:

       ‚îÇ Backend crash detected
       ‚îÇ
       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ CRASH_RECOVERY   ‚îÇ  Emergency: kill all backends, restart
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚îÇ All backends terminated
       ‚îÇ
       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   RECOVERY       ‚îÇ  Startup process performs crash recovery
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚îÇ Recovery complete
       ‚îÇ
       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ    RUNNING       ‚îÇ  Back to normal operation
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò</code></pre>
<h2 data-number="7.12" id="implementation-details"><span class="header-section-number">7.12</span> 11. Implementation
Details</h2>
<h3 data-number="7.12.1" id="key-source-files"><span class="header-section-number">7.12.1</span> 11.1 Key Source Files</h3>
<p><strong>Postmaster and Process Management</strong>: -
<code>src/backend/postmaster/postmaster.c</code>: Main postmaster code -
<code>src/backend/postmaster/fork_process.c</code>: Process forking -
<code>src/backend/postmaster/bgwriter.c</code>: Background writer -
<code>src/backend/postmaster/checkpointer.c</code>: Checkpointer process
- <code>src/backend/postmaster/walwriter.c</code>: WAL writer -
<code>src/backend/postmaster/autovacuum.c</code>: Autovacuum
launcher/workers - <code>src/backend/postmaster/pgarch.c</code>:
Archiver process - <code>src/backend/postmaster/pgstat.c</code>:
Statistics collector - <code>src/backend/postmaster/syslogger.c</code>:
Logging process</p>
<p><strong>Backend Execution</strong>: -
<code>src/backend/tcop/postgres.c</code>: Main backend loop
(PostgresMain) - <code>src/backend/tcop/pquery.c</code>: Portal and
query execution - <code>src/backend/tcop/utility.c</code>: Utility
command execution</p>
<p><strong>Client/Server Protocol</strong>: -
<code>src/backend/libpq/pqcomm.c</code>: Communication functions -
<code>src/backend/libpq/pqformat.c</code>: Message formatting -
<code>src/backend/libpq/auth.c</code>: Authentication -
<code>src/backend/libpq/hba.c</code>: pg_hba.conf parsing -
<code>src/interfaces/libpq/</code>: Client library</p>
<p><strong>Shared Memory</strong>: -
<code>src/backend/storage/ipc/ipci.c</code>: Shared memory
initialization - <code>src/backend/storage/ipc/shmem.c</code>: Shared
memory management - <code>src/backend/storage/buffer/buf_init.c</code>:
Buffer pool initialization -
<code>src/backend/storage/buffer/bufmgr.c</code>: Buffer management</p>
<p><strong>IPC Mechanisms</strong>: -
<code>src/backend/storage/ipc/latch.c</code>: Latch implementation -
<code>src/backend/storage/ipc/procsignal.c</code>: Process signaling -
<code>src/backend/storage/lmgr/spin.c</code>: Spinlocks -
<code>src/backend/storage/lmgr/lwlock.c</code>: Lightweight locks -
<code>src/backend/storage/lmgr/lock.c</code>: Heavyweight locks</p>
<p><strong>Replication</strong>: -
<code>src/backend/replication/walsender.c</code>: WAL sender -
<code>src/backend/replication/walreceiver.c</code>: WAL receiver -
<code>src/backend/replication/logical/launcher.c</code>: Logical
replication</p>
<h3 data-number="7.12.2" id="key-data-structures"><span class="header-section-number">7.12.2</span> 11.2 Key Data
Structures</h3>
<p><strong>PGPROC</strong> - Represents a process in shared memory:</p>
<div class="sourceCode" id="cb436"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb436-1"><a aria-hidden="true" href="#cb436-1" tabindex="-1"></a><span class="co">/* src/include/storage/proc.h */</span></span>
<span id="cb436-2"><a aria-hidden="true" href="#cb436-2" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> PGPROC</span>
<span id="cb436-3"><a aria-hidden="true" href="#cb436-3" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb436-4"><a aria-hidden="true" href="#cb436-4" tabindex="-1"></a>    <span class="co">/* Process identification */</span></span>
<span id="cb436-5"><a aria-hidden="true" href="#cb436-5" tabindex="-1"></a>    <span class="dt">int</span>         pgprocno<span class="op">;</span>         <span class="co">/* Index in PGPROC array */</span></span>
<span id="cb436-6"><a aria-hidden="true" href="#cb436-6" tabindex="-1"></a></span>
<span id="cb436-7"><a aria-hidden="true" href="#cb436-7" tabindex="-1"></a>    <span class="co">/* Transaction info */</span></span>
<span id="cb436-8"><a aria-hidden="true" href="#cb436-8" tabindex="-1"></a>    TransactionId xid<span class="op">;</span>            <span class="co">/* Transaction ID (if running) */</span></span>
<span id="cb436-9"><a aria-hidden="true" href="#cb436-9" tabindex="-1"></a>    TransactionId xmin<span class="op">;</span>           <span class="co">/* Minimum XID in snapshot */</span></span>
<span id="cb436-10"><a aria-hidden="true" href="#cb436-10" tabindex="-1"></a></span>
<span id="cb436-11"><a aria-hidden="true" href="#cb436-11" tabindex="-1"></a>    <span class="co">/* Lock management */</span></span>
<span id="cb436-12"><a aria-hidden="true" href="#cb436-12" tabindex="-1"></a>    LOCK_METHOD lockMethodTable<span class="op">;</span>  <span class="co">/* Lock method for this proc */</span></span>
<span id="cb436-13"><a aria-hidden="true" href="#cb436-13" tabindex="-1"></a>    LOCKMASK    heldLocks<span class="op">;</span>        <span class="co">/* Bitmask of lock types held */</span></span>
<span id="cb436-14"><a aria-hidden="true" href="#cb436-14" tabindex="-1"></a>    SHM_QUEUE   myProcLocks<span class="op">[</span>NUM_LOCK_PARTITIONS<span class="op">];</span> <span class="co">/* Locks held */</span></span>
<span id="cb436-15"><a aria-hidden="true" href="#cb436-15" tabindex="-1"></a></span>
<span id="cb436-16"><a aria-hidden="true" href="#cb436-16" tabindex="-1"></a>    <span class="co">/* Wait information */</span></span>
<span id="cb436-17"><a aria-hidden="true" href="#cb436-17" tabindex="-1"></a>    WaitEventSet <span class="op">*</span>waitEventSet<span class="op">;</span>   <span class="co">/* What we're waiting for */</span></span>
<span id="cb436-18"><a aria-hidden="true" href="#cb436-18" tabindex="-1"></a>    uint32      wait_event_info<span class="op">;</span>  <span class="co">/* Wait event details */</span></span>
<span id="cb436-19"><a aria-hidden="true" href="#cb436-19" tabindex="-1"></a></span>
<span id="cb436-20"><a aria-hidden="true" href="#cb436-20" tabindex="-1"></a>    <span class="co">/* Signaling */</span></span>
<span id="cb436-21"><a aria-hidden="true" href="#cb436-21" tabindex="-1"></a>    Latch       procLatch<span class="op">;</span>        <span class="co">/* For waking up process */</span></span>
<span id="cb436-22"><a aria-hidden="true" href="#cb436-22" tabindex="-1"></a></span>
<span id="cb436-23"><a aria-hidden="true" href="#cb436-23" tabindex="-1"></a>    <span class="co">/* Process metadata */</span></span>
<span id="cb436-24"><a aria-hidden="true" href="#cb436-24" tabindex="-1"></a>    Oid         databaseId<span class="op">;</span>       <span class="co">/* Database OID */</span></span>
<span id="cb436-25"><a aria-hidden="true" href="#cb436-25" tabindex="-1"></a>    Oid         roleId<span class="op">;</span>           <span class="co">/* Role OID */</span></span>
<span id="cb436-26"><a aria-hidden="true" href="#cb436-26" tabindex="-1"></a>    <span class="dt">bool</span>        isBackgroundWorker<span class="op">;</span></span>
<span id="cb436-27"><a aria-hidden="true" href="#cb436-27" tabindex="-1"></a></span>
<span id="cb436-28"><a aria-hidden="true" href="#cb436-28" tabindex="-1"></a>    <span class="co">/* Miscellaneous */</span></span>
<span id="cb436-29"><a aria-hidden="true" href="#cb436-29" tabindex="-1"></a>    <span class="dt">int</span>         pgxactoff<span class="op">;</span>        <span class="co">/* Offset in ProcGlobal-&gt;allProcs */</span></span>
<span id="cb436-30"><a aria-hidden="true" href="#cb436-30" tabindex="-1"></a>    BackendId   backendId<span class="op">;</span>        <span class="co">/* Backend ID (1..MaxBackends) */</span></span>
<span id="cb436-31"><a aria-hidden="true" href="#cb436-31" tabindex="-1"></a><span class="op">}</span> PGPROC<span class="op">;</span></span></code></pre></div>
<p><strong>Port</strong> - Connection information:</p>
<div class="sourceCode" id="cb437"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb437-1"><a aria-hidden="true" href="#cb437-1" tabindex="-1"></a><span class="co">/* src/include/libpq/libpq-be.h */</span></span>
<span id="cb437-2"><a aria-hidden="true" href="#cb437-2" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> Port</span>
<span id="cb437-3"><a aria-hidden="true" href="#cb437-3" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb437-4"><a aria-hidden="true" href="#cb437-4" tabindex="-1"></a>    <span class="co">/* Socket and address */</span></span>
<span id="cb437-5"><a aria-hidden="true" href="#cb437-5" tabindex="-1"></a>    pgsocket    sock<span class="op">;</span>             <span class="co">/* Socket file descriptor */</span></span>
<span id="cb437-6"><a aria-hidden="true" href="#cb437-6" tabindex="-1"></a>    SockAddr    laddr<span class="op">;</span>            <span class="co">/* Local address */</span></span>
<span id="cb437-7"><a aria-hidden="true" href="#cb437-7" tabindex="-1"></a>    SockAddr    raddr<span class="op">;</span>            <span class="co">/* Remote address */</span></span>
<span id="cb437-8"><a aria-hidden="true" href="#cb437-8" tabindex="-1"></a></span>
<span id="cb437-9"><a aria-hidden="true" href="#cb437-9" tabindex="-1"></a>    <span class="co">/* Connection metadata */</span></span>
<span id="cb437-10"><a aria-hidden="true" href="#cb437-10" tabindex="-1"></a>    <span class="dt">char</span>        <span class="op">*</span>remote_host<span class="op">;</span>     <span class="co">/* Hostname of client */</span></span>
<span id="cb437-11"><a aria-hidden="true" href="#cb437-11" tabindex="-1"></a>    <span class="dt">char</span>        <span class="op">*</span>remote_hostname<span class="op">;</span> <span class="co">/* Reverse DNS lookup result */</span></span>
<span id="cb437-12"><a aria-hidden="true" href="#cb437-12" tabindex="-1"></a>    <span class="dt">char</span>        <span class="op">*</span>remote_port<span class="op">;</span>     <span class="co">/* Port on client */</span></span>
<span id="cb437-13"><a aria-hidden="true" href="#cb437-13" tabindex="-1"></a></span>
<span id="cb437-14"><a aria-hidden="true" href="#cb437-14" tabindex="-1"></a>    <span class="co">/* Authentication */</span></span>
<span id="cb437-15"><a aria-hidden="true" href="#cb437-15" tabindex="-1"></a>    <span class="dt">char</span>        <span class="op">*</span>database_name<span class="op">;</span>   <span class="co">/* Database requested */</span></span>
<span id="cb437-16"><a aria-hidden="true" href="#cb437-16" tabindex="-1"></a>    <span class="dt">char</span>        <span class="op">*</span>user_name<span class="op">;</span>       <span class="co">/* User name */</span></span>
<span id="cb437-17"><a aria-hidden="true" href="#cb437-17" tabindex="-1"></a>    <span class="dt">char</span>        <span class="op">*</span>cmdline_options<span class="op">;</span> <span class="co">/* Command-line options */</span></span>
<span id="cb437-18"><a aria-hidden="true" href="#cb437-18" tabindex="-1"></a></span>
<span id="cb437-19"><a aria-hidden="true" href="#cb437-19" tabindex="-1"></a>    <span class="co">/* SSL */</span></span>
<span id="cb437-20"><a aria-hidden="true" href="#cb437-20" tabindex="-1"></a>    <span class="dt">void</span>        <span class="op">*</span>ssl<span class="op">;</span>             <span class="co">/* SSL structure (if SSL) */</span></span>
<span id="cb437-21"><a aria-hidden="true" href="#cb437-21" tabindex="-1"></a>    <span class="dt">bool</span>        ssl_in_use<span class="op">;</span>       <span class="co">/* SSL connection active */</span></span>
<span id="cb437-22"><a aria-hidden="true" href="#cb437-22" tabindex="-1"></a></span>
<span id="cb437-23"><a aria-hidden="true" href="#cb437-23" tabindex="-1"></a>    <span class="co">/* GSSAPI */</span></span>
<span id="cb437-24"><a aria-hidden="true" href="#cb437-24" tabindex="-1"></a>    <span class="dt">void</span>        <span class="op">*</span>gss<span class="op">;</span>             <span class="co">/* GSSAPI structure */</span></span>
<span id="cb437-25"><a aria-hidden="true" href="#cb437-25" tabindex="-1"></a></span>
<span id="cb437-26"><a aria-hidden="true" href="#cb437-26" tabindex="-1"></a>    <span class="co">/* Protocol version */</span></span>
<span id="cb437-27"><a aria-hidden="true" href="#cb437-27" tabindex="-1"></a>    ProtocolVersion proto<span class="op">;</span>        <span class="co">/* FE/BE protocol version */</span></span>
<span id="cb437-28"><a aria-hidden="true" href="#cb437-28" tabindex="-1"></a></span>
<span id="cb437-29"><a aria-hidden="true" href="#cb437-29" tabindex="-1"></a>    <span class="co">/* pg_hba match */</span></span>
<span id="cb437-30"><a aria-hidden="true" href="#cb437-30" tabindex="-1"></a>    HbaLine     <span class="op">*</span>hba<span class="op">;</span>             <span class="co">/* Matched pg_hba.conf line */</span></span>
<span id="cb437-31"><a aria-hidden="true" href="#cb437-31" tabindex="-1"></a><span class="op">}</span> Port<span class="op">;</span></span></code></pre></div>
<p><strong>BufferDesc</strong> - Buffer pool entry:</p>
<div class="sourceCode" id="cb438"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb438-1"><a aria-hidden="true" href="#cb438-1" tabindex="-1"></a><span class="co">/* src/include/storage/buf_internals.h */</span></span>
<span id="cb438-2"><a aria-hidden="true" href="#cb438-2" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> BufferDesc</span>
<span id="cb438-3"><a aria-hidden="true" href="#cb438-3" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb438-4"><a aria-hidden="true" href="#cb438-4" tabindex="-1"></a>    BufferTag   tag<span class="op">;</span>              <span class="co">/* ID of page in buffer */</span></span>
<span id="cb438-5"><a aria-hidden="true" href="#cb438-5" tabindex="-1"></a>    <span class="dt">int</span>         buf_id<span class="op">;</span>           <span class="co">/* Buffer index (0..NBuffers-1) */</span></span>
<span id="cb438-6"><a aria-hidden="true" href="#cb438-6" tabindex="-1"></a></span>
<span id="cb438-7"><a aria-hidden="true" href="#cb438-7" tabindex="-1"></a>    <span class="co">/* State and reference count (atomic) */</span></span>
<span id="cb438-8"><a aria-hidden="true" href="#cb438-8" tabindex="-1"></a>    pg_atomic_uint32 state<span class="op">;</span></span>
<span id="cb438-9"><a aria-hidden="true" href="#cb438-9" tabindex="-1"></a></span>
<span id="cb438-10"><a aria-hidden="true" href="#cb438-10" tabindex="-1"></a>    <span class="co">/* Waiting processes */</span></span>
<span id="cb438-11"><a aria-hidden="true" href="#cb438-11" tabindex="-1"></a>    <span class="dt">int</span>         wait_backend_pid<span class="op">;</span></span>
<span id="cb438-12"><a aria-hidden="true" href="#cb438-12" tabindex="-1"></a></span>
<span id="cb438-13"><a aria-hidden="true" href="#cb438-13" tabindex="-1"></a>    <span class="co">/* Header spinlock */</span></span>
<span id="cb438-14"><a aria-hidden="true" href="#cb438-14" tabindex="-1"></a>    slock_t     buf_hdr_lock<span class="op">;</span></span>
<span id="cb438-15"><a aria-hidden="true" href="#cb438-15" tabindex="-1"></a></span>
<span id="cb438-16"><a aria-hidden="true" href="#cb438-16" tabindex="-1"></a>    <span class="co">/* Free list link */</span></span>
<span id="cb438-17"><a aria-hidden="true" href="#cb438-17" tabindex="-1"></a>    <span class="dt">int</span>         freeNext<span class="op">;</span></span>
<span id="cb438-18"><a aria-hidden="true" href="#cb438-18" tabindex="-1"></a><span class="op">}</span> BufferDesc<span class="op">;</span></span></code></pre></div>
<h3 data-number="7.12.3" id="process-title-ps-display"><span class="header-section-number">7.12.3</span> 11.3 Process Title (ps
Display)</h3>
<p>PostgreSQL sets descriptive process titles visible in <code>ps</code>
and <code>top</code>:</p>
<div class="sourceCode" id="cb439"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb439-1"><a aria-hidden="true" href="#cb439-1" tabindex="-1"></a><span class="ex">$</span> ps aux <span class="kw">|</span> <span class="fu">grep</span> postgres</span>
<span id="cb439-2"><a aria-hidden="true" href="#cb439-2" tabindex="-1"></a><span class="ex">postgres</span>  1234  postmaster <span class="at">-D</span> /var/lib/pgsql/data</span>
<span id="cb439-3"><a aria-hidden="true" href="#cb439-3" tabindex="-1"></a><span class="ex">postgres</span>  1235  postgres: checkpointer</span>
<span id="cb439-4"><a aria-hidden="true" href="#cb439-4" tabindex="-1"></a><span class="ex">postgres</span>  1236  postgres: background writer</span>
<span id="cb439-5"><a aria-hidden="true" href="#cb439-5" tabindex="-1"></a><span class="ex">postgres</span>  1237  postgres: walwriter</span>
<span id="cb439-6"><a aria-hidden="true" href="#cb439-6" tabindex="-1"></a><span class="ex">postgres</span>  1238  postgres: autovacuum launcher</span>
<span id="cb439-7"><a aria-hidden="true" href="#cb439-7" tabindex="-1"></a><span class="ex">postgres</span>  1239  postgres: archiver</span>
<span id="cb439-8"><a aria-hidden="true" href="#cb439-8" tabindex="-1"></a><span class="ex">postgres</span>  1240  postgres: stats collector</span>
<span id="cb439-9"><a aria-hidden="true" href="#cb439-9" tabindex="-1"></a><span class="ex">postgres</span>  1241  postgres: logical replication launcher</span>
<span id="cb439-10"><a aria-hidden="true" href="#cb439-10" tabindex="-1"></a><span class="ex">postgres</span>  1242  postgres: alice mydb <span class="pp">[</span><span class="ss">local</span><span class="pp">]</span> idle</span>
<span id="cb439-11"><a aria-hidden="true" href="#cb439-11" tabindex="-1"></a><span class="ex">postgres</span>  1243  postgres: bob testdb 192.168.1.100<span class="er">(</span><span class="ex">54321</span><span class="kw">)</span> <span class="ex">SELECT</span></span>
<span id="cb439-12"><a aria-hidden="true" href="#cb439-12" tabindex="-1"></a><span class="ex">postgres</span>  1244  postgres: carol analytics 10.0.0.5<span class="er">(</span><span class="ex">12345</span><span class="kw">)</span> <span class="ex">idle</span> in transaction</span>
<span id="cb439-13"><a aria-hidden="true" href="#cb439-13" tabindex="-1"></a><span class="ex">postgres</span>  1245  postgres: autovacuum worker process mydb</span>
<span id="cb439-14"><a aria-hidden="true" href="#cb439-14" tabindex="-1"></a><span class="ex">postgres</span>  1246  postgres: walsender replicator 10.0.0.10<span class="er">(</span><span class="ex">5433</span><span class="kw">)</span> <span class="ex">streaming</span> 0/12345678</span></code></pre></div>
<p><strong>Format</strong>:
<code>postgres: &lt;user&gt; &lt;database&gt; &lt;host&gt; &lt;state&gt; [query]</code></p>
<p><strong>Code</strong>:</p>
<div class="sourceCode" id="cb440"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb440-1"><a aria-hidden="true" href="#cb440-1" tabindex="-1"></a><span class="co">/* src/backend/utils/misc/ps_status.c */</span></span>
<span id="cb440-2"><a aria-hidden="true" href="#cb440-2" tabindex="-1"></a><span class="dt">void</span></span>
<span id="cb440-3"><a aria-hidden="true" href="#cb440-3" tabindex="-1"></a>set_ps_display<span class="op">(</span><span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>activity<span class="op">)</span></span>
<span id="cb440-4"><a aria-hidden="true" href="#cb440-4" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb440-5"><a aria-hidden="true" href="#cb440-5" tabindex="-1"></a>    <span class="dt">char</span> <span class="op">*</span>display_buffer<span class="op">;</span></span>
<span id="cb440-6"><a aria-hidden="true" href="#cb440-6" tabindex="-1"></a></span>
<span id="cb440-7"><a aria-hidden="true" href="#cb440-7" tabindex="-1"></a>    <span class="co">/* Build display string */</span></span>
<span id="cb440-8"><a aria-hidden="true" href="#cb440-8" tabindex="-1"></a>    display_buffer <span class="op">=</span> psprintf<span class="op">(</span><span class="st">"postgres: </span><span class="sc">%s</span><span class="st"> </span><span class="sc">%s</span><span class="st"> </span><span class="sc">%s</span><span class="st"> </span><span class="sc">%s</span><span class="st">"</span><span class="op">,</span></span>
<span id="cb440-9"><a aria-hidden="true" href="#cb440-9" tabindex="-1"></a>                              MyProcPort<span class="op">-&gt;</span>user_name<span class="op">,</span></span>
<span id="cb440-10"><a aria-hidden="true" href="#cb440-10" tabindex="-1"></a>                              MyProcPort<span class="op">-&gt;</span>database_name<span class="op">,</span></span>
<span id="cb440-11"><a aria-hidden="true" href="#cb440-11" tabindex="-1"></a>                              get_backend_state_string<span class="op">(),</span></span>
<span id="cb440-12"><a aria-hidden="true" href="#cb440-12" tabindex="-1"></a>                              activity<span class="op">);</span></span>
<span id="cb440-13"><a aria-hidden="true" href="#cb440-13" tabindex="-1"></a></span>
<span id="cb440-14"><a aria-hidden="true" href="#cb440-14" tabindex="-1"></a>    <span class="co">/* Set process title (platform-specific) */</span></span>
<span id="cb440-15"><a aria-hidden="true" href="#cb440-15" tabindex="-1"></a>    setproctitle<span class="op">(</span><span class="st">"</span><span class="sc">%s</span><span class="st">"</span><span class="op">,</span> display_buffer<span class="op">);</span></span>
<span id="cb440-16"><a aria-hidden="true" href="#cb440-16" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2 data-number="7.13" id="cross-references-and-related-topics"><span class="header-section-number">7.13</span> 12. Cross-References and
Related Topics</h2>
<h3 data-number="7.13.1" id="related-encyclopedia-chapters"><span class="header-section-number">7.13.1</span> Related Encyclopedia
Chapters</h3>
<ul>
<li><strong>Chapter 3: Architecture Overview</strong>: High-level system
architecture and component interaction</li>
<li><strong>Chapter 4: Storage Management</strong>: How processes
interact with disk storage, buffer management</li>
<li><strong>Chapter 6: Transaction Management</strong>: MVCC,
transaction ID assignment, locking mechanisms</li>
<li><strong>Chapter 7: Write-Ahead Logging</strong>: WAL generation, WAL
sender/receiver protocols</li>
<li><strong>Chapter 8: Replication</strong>: Physical and logical
replication process architecture</li>
<li><strong>Chapter 10: Query Processing</strong>: Backend query
execution, parallel query workers</li>
<li><strong>Chapter 11: Concurrency Control</strong>: Lock management,
deadlock detection, isolation levels</li>
<li><strong>Chapter 15: Connection Pooling</strong>: External tools
(PgBouncer, pgpool) for process management</li>
</ul>
<h3 data-number="7.13.2" id="key-system-views"><span class="header-section-number">7.13.2</span> Key System Views</h3>
<p>Monitor process activity using these system views:</p>
<div class="sourceCode" id="cb441"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb441-1"><a aria-hidden="true" href="#cb441-1" tabindex="-1"></a><span class="co">-- Active processes</span></span>
<span id="cb441-2"><a aria-hidden="true" href="#cb441-2" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> pg_stat_activity;</span>
<span id="cb441-3"><a aria-hidden="true" href="#cb441-3" tabindex="-1"></a></span>
<span id="cb441-4"><a aria-hidden="true" href="#cb441-4" tabindex="-1"></a><span class="co">-- Replication status</span></span>
<span id="cb441-5"><a aria-hidden="true" href="#cb441-5" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> pg_stat_replication;</span>
<span id="cb441-6"><a aria-hidden="true" href="#cb441-6" tabindex="-1"></a></span>
<span id="cb441-7"><a aria-hidden="true" href="#cb441-7" tabindex="-1"></a><span class="co">-- WAL receiver status (on standby)</span></span>
<span id="cb441-8"><a aria-hidden="true" href="#cb441-8" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> pg_stat_wal_receiver;</span>
<span id="cb441-9"><a aria-hidden="true" href="#cb441-9" tabindex="-1"></a></span>
<span id="cb441-10"><a aria-hidden="true" href="#cb441-10" tabindex="-1"></a><span class="co">-- Background writer statistics</span></span>
<span id="cb441-11"><a aria-hidden="true" href="#cb441-11" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> pg_stat_bgwriter;</span>
<span id="cb441-12"><a aria-hidden="true" href="#cb441-12" tabindex="-1"></a></span>
<span id="cb441-13"><a aria-hidden="true" href="#cb441-13" tabindex="-1"></a><span class="co">-- Archiver statistics</span></span>
<span id="cb441-14"><a aria-hidden="true" href="#cb441-14" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> pg_stat_archiver;</span>
<span id="cb441-15"><a aria-hidden="true" href="#cb441-15" tabindex="-1"></a></span>
<span id="cb441-16"><a aria-hidden="true" href="#cb441-16" tabindex="-1"></a><span class="co">-- Current process information</span></span>
<span id="cb441-17"><a aria-hidden="true" href="#cb441-17" tabindex="-1"></a><span class="kw">SELECT</span> pg_backend_pid();              <span class="co">-- My backend PID</span></span>
<span id="cb441-18"><a aria-hidden="true" href="#cb441-18" tabindex="-1"></a><span class="kw">SELECT</span> pg_postmaster_start_time();    <span class="co">-- When postmaster started</span></span>
<span id="cb441-19"><a aria-hidden="true" href="#cb441-19" tabindex="-1"></a><span class="kw">SELECT</span> pg_conf_load_time();           <span class="co">-- Last config reload</span></span>
<span id="cb441-20"><a aria-hidden="true" href="#cb441-20" tabindex="-1"></a></span>
<span id="cb441-21"><a aria-hidden="true" href="#cb441-21" tabindex="-1"></a><span class="co">-- Cancel or terminate backends</span></span>
<span id="cb441-22"><a aria-hidden="true" href="#cb441-22" tabindex="-1"></a><span class="kw">SELECT</span> pg_cancel_backend(pid);        <span class="co">-- Cancel query</span></span>
<span id="cb441-23"><a aria-hidden="true" href="#cb441-23" tabindex="-1"></a><span class="kw">SELECT</span> pg_terminate_backend(pid);     <span class="co">-- Terminate connection</span></span></code></pre></div>
<h3 data-number="7.13.3" id="performance-tuning-1"><span class="header-section-number">7.13.3</span> Performance Tuning</h3>
<p>Key configuration parameters affecting process behavior:</p>
<div class="sourceCode" id="cb442"><pre class="sourceCode ini"><code class="sourceCode ini"><span id="cb442-1"><a aria-hidden="true" href="#cb442-1" tabindex="-1"></a><span class="co"># Connection and authentication</span></span>
<span id="cb442-2"><a aria-hidden="true" href="#cb442-2" tabindex="-1"></a><span class="dt">max_connections </span><span class="ot">=</span><span class="st"> </span><span class="dv">100</span></span>
<span id="cb442-3"><a aria-hidden="true" href="#cb442-3" tabindex="-1"></a><span class="dt">superuser_reserved_connections </span><span class="ot">=</span><span class="st"> </span><span class="dv">3</span></span>
<span id="cb442-4"><a aria-hidden="true" href="#cb442-4" tabindex="-1"></a><span class="dt">listen_addresses </span><span class="ot">=</span><span class="st"> '*'</span></span>
<span id="cb442-5"><a aria-hidden="true" href="#cb442-5" tabindex="-1"></a><span class="dt">port </span><span class="ot">=</span><span class="st"> </span><span class="dv">5432</span></span>
<span id="cb442-6"><a aria-hidden="true" href="#cb442-6" tabindex="-1"></a></span>
<span id="cb442-7"><a aria-hidden="true" href="#cb442-7" tabindex="-1"></a><span class="co"># Resource usage (per backend)</span></span>
<span id="cb442-8"><a aria-hidden="true" href="#cb442-8" tabindex="-1"></a><span class="dt">work_mem </span><span class="ot">=</span><span class="st"> 4MB                    # Per-operation memory</span></span>
<span id="cb442-9"><a aria-hidden="true" href="#cb442-9" tabindex="-1"></a><span class="dt">maintenance_work_mem </span><span class="ot">=</span><span class="st"> 64MB       # Vacuum, CREATE INDEX memory</span></span>
<span id="cb442-10"><a aria-hidden="true" href="#cb442-10" tabindex="-1"></a><span class="dt">temp_buffers </span><span class="ot">=</span><span class="st"> 8MB                # Temp table buffers</span></span>
<span id="cb442-11"><a aria-hidden="true" href="#cb442-11" tabindex="-1"></a></span>
<span id="cb442-12"><a aria-hidden="true" href="#cb442-12" tabindex="-1"></a><span class="co"># Background writer</span></span>
<span id="cb442-13"><a aria-hidden="true" href="#cb442-13" tabindex="-1"></a><span class="dt">bgwriter_delay </span><span class="ot">=</span><span class="st"> 200ms</span></span>
<span id="cb442-14"><a aria-hidden="true" href="#cb442-14" tabindex="-1"></a><span class="dt">bgwriter_lru_maxpages </span><span class="ot">=</span><span class="st"> </span><span class="dv">100</span></span>
<span id="cb442-15"><a aria-hidden="true" href="#cb442-15" tabindex="-1"></a><span class="dt">bgwriter_lru_multiplier </span><span class="ot">=</span><span class="st"> </span><span class="fl">2.0</span></span>
<span id="cb442-16"><a aria-hidden="true" href="#cb442-16" tabindex="-1"></a></span>
<span id="cb442-17"><a aria-hidden="true" href="#cb442-17" tabindex="-1"></a><span class="co"># Checkpointing</span></span>
<span id="cb442-18"><a aria-hidden="true" href="#cb442-18" tabindex="-1"></a><span class="dt">checkpoint_timeout </span><span class="ot">=</span><span class="st"> 5min</span></span>
<span id="cb442-19"><a aria-hidden="true" href="#cb442-19" tabindex="-1"></a><span class="dt">max_wal_size </span><span class="ot">=</span><span class="st"> 1GB</span></span>
<span id="cb442-20"><a aria-hidden="true" href="#cb442-20" tabindex="-1"></a><span class="dt">checkpoint_completion_target </span><span class="ot">=</span><span class="st"> </span><span class="fl">0.9</span></span>
<span id="cb442-21"><a aria-hidden="true" href="#cb442-21" tabindex="-1"></a></span>
<span id="cb442-22"><a aria-hidden="true" href="#cb442-22" tabindex="-1"></a><span class="co"># Autovacuum</span></span>
<span id="cb442-23"><a aria-hidden="true" href="#cb442-23" tabindex="-1"></a><span class="dt">autovacuum </span><span class="ot">=</span><span class="st"> </span><span class="kw">on</span></span>
<span id="cb442-24"><a aria-hidden="true" href="#cb442-24" tabindex="-1"></a><span class="dt">autovacuum_max_workers </span><span class="ot">=</span><span class="st"> </span><span class="dv">3</span></span>
<span id="cb442-25"><a aria-hidden="true" href="#cb442-25" tabindex="-1"></a><span class="dt">autovacuum_naptime </span><span class="ot">=</span><span class="st"> 1min</span></span>
<span id="cb442-26"><a aria-hidden="true" href="#cb442-26" tabindex="-1"></a></span>
<span id="cb442-27"><a aria-hidden="true" href="#cb442-27" tabindex="-1"></a><span class="co"># WAL writer</span></span>
<span id="cb442-28"><a aria-hidden="true" href="#cb442-28" tabindex="-1"></a><span class="dt">wal_writer_delay </span><span class="ot">=</span><span class="st"> 200ms</span></span>
<span id="cb442-29"><a aria-hidden="true" href="#cb442-29" tabindex="-1"></a><span class="dt">wal_writer_flush_after </span><span class="ot">=</span><span class="st"> 1MB</span></span>
<span id="cb442-30"><a aria-hidden="true" href="#cb442-30" tabindex="-1"></a></span>
<span id="cb442-31"><a aria-hidden="true" href="#cb442-31" tabindex="-1"></a><span class="co"># Parallel query</span></span>
<span id="cb442-32"><a aria-hidden="true" href="#cb442-32" tabindex="-1"></a><span class="dt">max_parallel_workers_per_gather </span><span class="ot">=</span><span class="st"> </span><span class="dv">2</span></span>
<span id="cb442-33"><a aria-hidden="true" href="#cb442-33" tabindex="-1"></a><span class="dt">max_parallel_workers </span><span class="ot">=</span><span class="st"> </span><span class="dv">8</span></span>
<span id="cb442-34"><a aria-hidden="true" href="#cb442-34" tabindex="-1"></a><span class="dt">parallel_setup_cost </span><span class="ot">=</span><span class="st"> </span><span class="dv">1000</span></span>
<span id="cb442-35"><a aria-hidden="true" href="#cb442-35" tabindex="-1"></a><span class="dt">parallel_tuple_cost </span><span class="ot">=</span><span class="st"> </span><span class="fl">0.1</span></span></code></pre></div>
<h2 data-number="7.14" id="conclusion-3"><span class="header-section-number">7.14</span> Conclusion</h2>
<p>PostgreSQL‚Äôs multi-process architecture is a carefully designed
system that provides robust fault isolation, security, and portability.
The postmaster serves as a supervisor that never touches shared memory,
ensuring it can always detect and recover from backend crashes. Backend
processes follow a well-defined lifecycle and state machine, handling
client queries through a sophisticated protocol. Auxiliary processes
perform essential maintenance tasks, from checkpointing to autovacuum to
WAL archiving.</p>
<p>The shared memory architecture enables efficient communication
between processes while maintaining strong isolation boundaries. Various
IPC mechanisms‚Äîsignals, latches, spinlocks, LWLocks, and heavyweight
locks‚Äîprovide the necessary coordination and synchronization. The
client/server protocol supports both simple and extended query modes,
enabling everything from basic SQL queries to complex prepared
statements and bulk data transfer.</p>
<p>Understanding this process architecture is fundamental to
administering, tuning, and developing with PostgreSQL. It explains
observable behavior like connection limits, process listings, and
shutdown modes. It also provides the foundation for understanding more
advanced topics like replication, parallel query execution, and high
availability.</p>
<hr/>
<p><strong>See Also</strong>: - PostgreSQL Documentation: <a href="https://www.postgresql.org/docs/current/server-processes.html">Server
Processes</a> - PostgreSQL Documentation: <a href="https://www.postgresql.org/docs/current/protocol.html">Client/Server
Protocol</a> - PostgreSQL Source:
<code>src/backend/postmaster/README</code> - PostgreSQL Source:
<code>src/backend/tcop/README</code></p>
<h1 data-number="8" id="chapter-6-extension-system"><span class="header-section-number">8</span> Chapter 6: Extension System</h1>
<h2 data-number="8.1" id="overview-13"><span class="header-section-number">8.1</span> Overview</h2>
<p>PostgreSQL‚Äôs extension system represents one of the database‚Äôs most
powerful architectural features, enabling developers to augment core
functionality without modifying the server codebase. This extensibility
framework encompasses multiple interconnected subsystems: the function
manager (fmgr), procedural language handlers, foreign data wrappers,
custom access methods, a comprehensive hooks system, and the PGXS build
infrastructure. Together, these components enable PostgreSQL to serve as
a platform for innovation, supporting everything from new data types and
operators to alternative storage engines and query optimization
strategies.</p>
<p>The extension mechanism achieves several critical design goals:
binary compatibility across PostgreSQL versions (via ABI validation),
transactional semantics for extension installation, dependency tracking
between database objects, and clean upgrade paths. Extensions can
introduce new SQL data types, functions, operators, index access
methods, procedural languages, foreign data wrappers, custom aggregates,
table access methods, and background workers‚Äîessentially any
functionality that the core database provides.</p>
<h2 data-number="8.2" id="extension-infrastructure"><span class="header-section-number">8.2</span> Extension Infrastructure</h2>
<h3 data-number="8.2.1" id="extension-control-files"><span class="header-section-number">8.2.1</span> Extension Control Files</h3>
<p>Every extension is defined by a control file (<code>.control</code>)
that describes its metadata, dependencies, and installation parameters.
These files reside in <code>$SHAREDIR/extension/</code> and follow a
simple key-value format:</p>
<pre><code># hstore.control
comment = 'data type for storing sets of (key, value) pairs'
default_version = '1.8'
module_pathname = '$libdir/hstore'
relocatable = true
trusted = true</code></pre>
<p><strong>Control File Parameters:</strong></p>
<ul>
<li><code>comment</code>: Human-readable description displayed in
<code>\dx</code></li>
<li><code>default_version</code>: Version installed by default with
<code>CREATE EXTENSION</code></li>
<li><code>module_pathname</code>: Path to shared library, with
<code>$libdir</code> as placeholder</li>
<li><code>relocatable</code>: Whether extension schema can be changed
via <code>ALTER EXTENSION ... SET SCHEMA</code></li>
<li><code>trusted</code>: Whether extension can be installed by
non-superusers (PostgreSQL 13+)</li>
<li><code>requires</code>: List of prerequisite extensions</li>
<li><code>superuser</code>: Whether installation requires superuser
privileges (deprecated, use <code>trusted</code>)</li>
<li><code>schema</code>: Fixed schema name if not relocatable</li>
<li><code>encoding</code>: Required database encoding</li>
</ul>
<p>The <code>module_pathname</code> uses <code>$libdir</code> as a
substitution variable, resolved to PostgreSQL‚Äôs library directory at
runtime. This enables extensions to work across different installation
layouts.</p>
<h3 data-number="8.2.2" id="extension-sql-scripts"><span class="header-section-number">8.2.2</span> Extension SQL Scripts</h3>
<p>Extensions define their objects through SQL scripts named
<code>extension--version.sql</code> or
<code>extension--oldver--newver.sql</code> (for upgrades). These scripts
contain standard SQL DDL statements:</p>
<div class="sourceCode" id="cb444"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb444-1"><a aria-hidden="true" href="#cb444-1" tabindex="-1"></a><span class="co">/* hstore--1.4.sql */</span></span>
<span id="cb444-2"><a aria-hidden="true" href="#cb444-2" tabindex="-1"></a></span>
<span id="cb444-3"><a aria-hidden="true" href="#cb444-3" tabindex="-1"></a><span class="co">-- Prevent direct loading</span></span>
<span id="cb444-4"><a aria-hidden="true" href="#cb444-4" tabindex="-1"></a>\echo <span class="kw">Use</span> <span class="ot">"CREATE EXTENSION hstore"</span> <span class="kw">to</span> load this <span class="kw">file</span>. \quit</span>
<span id="cb444-5"><a aria-hidden="true" href="#cb444-5" tabindex="-1"></a></span>
<span id="cb444-6"><a aria-hidden="true" href="#cb444-6" tabindex="-1"></a><span class="co">-- Define the data type</span></span>
<span id="cb444-7"><a aria-hidden="true" href="#cb444-7" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TYPE</span> hstore;</span>
<span id="cb444-8"><a aria-hidden="true" href="#cb444-8" tabindex="-1"></a></span>
<span id="cb444-9"><a aria-hidden="true" href="#cb444-9" tabindex="-1"></a><span class="co">-- Input/output functions</span></span>
<span id="cb444-10"><a aria-hidden="true" href="#cb444-10" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">FUNCTION</span> hstore_in(cstring)</span>
<span id="cb444-11"><a aria-hidden="true" href="#cb444-11" tabindex="-1"></a>RETURNS hstore</span>
<span id="cb444-12"><a aria-hidden="true" href="#cb444-12" tabindex="-1"></a><span class="kw">AS</span> <span class="st">'MODULE_PATHNAME'</span></span>
<span id="cb444-13"><a aria-hidden="true" href="#cb444-13" tabindex="-1"></a>LANGUAGE C STRICT IMMUTABLE <span class="kw">PARALLEL</span> SAFE;</span>
<span id="cb444-14"><a aria-hidden="true" href="#cb444-14" tabindex="-1"></a></span>
<span id="cb444-15"><a aria-hidden="true" href="#cb444-15" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">FUNCTION</span> hstore_out(hstore)</span>
<span id="cb444-16"><a aria-hidden="true" href="#cb444-16" tabindex="-1"></a>RETURNS cstring</span>
<span id="cb444-17"><a aria-hidden="true" href="#cb444-17" tabindex="-1"></a><span class="kw">AS</span> <span class="st">'MODULE_PATHNAME'</span></span>
<span id="cb444-18"><a aria-hidden="true" href="#cb444-18" tabindex="-1"></a>LANGUAGE C STRICT IMMUTABLE <span class="kw">PARALLEL</span> SAFE;</span>
<span id="cb444-19"><a aria-hidden="true" href="#cb444-19" tabindex="-1"></a></span>
<span id="cb444-20"><a aria-hidden="true" href="#cb444-20" tabindex="-1"></a><span class="co">-- Complete type definition</span></span>
<span id="cb444-21"><a aria-hidden="true" href="#cb444-21" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TYPE</span> hstore (</span>
<span id="cb444-22"><a aria-hidden="true" href="#cb444-22" tabindex="-1"></a>    INTERNALLENGTH <span class="op">=</span> <span class="op">-</span><span class="dv">1</span>,</span>
<span id="cb444-23"><a aria-hidden="true" href="#cb444-23" tabindex="-1"></a>    INPUT <span class="op">=</span> hstore_in,</span>
<span id="cb444-24"><a aria-hidden="true" href="#cb444-24" tabindex="-1"></a>    OUTPUT <span class="op">=</span> hstore_out,</span>
<span id="cb444-25"><a aria-hidden="true" href="#cb444-25" tabindex="-1"></a>    RECEIVE <span class="op">=</span> hstore_recv,</span>
<span id="cb444-26"><a aria-hidden="true" href="#cb444-26" tabindex="-1"></a>    SEND <span class="op">=</span> hstore_send,</span>
<span id="cb444-27"><a aria-hidden="true" href="#cb444-27" tabindex="-1"></a>    <span class="kw">STORAGE</span> <span class="op">=</span> extended</span>
<span id="cb444-28"><a aria-hidden="true" href="#cb444-28" tabindex="-1"></a>);</span>
<span id="cb444-29"><a aria-hidden="true" href="#cb444-29" tabindex="-1"></a></span>
<span id="cb444-30"><a aria-hidden="true" href="#cb444-30" tabindex="-1"></a><span class="co">-- Operators</span></span>
<span id="cb444-31"><a aria-hidden="true" href="#cb444-31" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">FUNCTION</span> fetchval(hstore, text)</span>
<span id="cb444-32"><a aria-hidden="true" href="#cb444-32" tabindex="-1"></a>RETURNS text</span>
<span id="cb444-33"><a aria-hidden="true" href="#cb444-33" tabindex="-1"></a><span class="kw">AS</span> <span class="st">'MODULE_PATHNAME'</span>, <span class="st">'hstore_fetchval'</span></span>
<span id="cb444-34"><a aria-hidden="true" href="#cb444-34" tabindex="-1"></a>LANGUAGE C STRICT IMMUTABLE <span class="kw">PARALLEL</span> SAFE;</span>
<span id="cb444-35"><a aria-hidden="true" href="#cb444-35" tabindex="-1"></a></span>
<span id="cb444-36"><a aria-hidden="true" href="#cb444-36" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">OPERATOR</span> <span class="op">-&gt;</span> (</span>
<span id="cb444-37"><a aria-hidden="true" href="#cb444-37" tabindex="-1"></a>    LEFTARG <span class="op">=</span> hstore,</span>
<span id="cb444-38"><a aria-hidden="true" href="#cb444-38" tabindex="-1"></a>    RIGHTARG <span class="op">=</span> text,</span>
<span id="cb444-39"><a aria-hidden="true" href="#cb444-39" tabindex="-1"></a>    <span class="kw">PROCEDURE</span> <span class="op">=</span> fetchval</span>
<span id="cb444-40"><a aria-hidden="true" href="#cb444-40" tabindex="-1"></a>);</span></code></pre></div>
<p>The <code>MODULE_PATHNAME</code> placeholder is replaced with the
<code>module_pathname</code> from the control file. Extension scripts
execute within a transaction, ensuring atomic installation.</p>
<h3 data-number="8.2.3" id="extension-installation-and-upgrade"><span class="header-section-number">8.2.3</span> Extension Installation and
Upgrade</h3>
<p>When <code>CREATE EXTENSION</code> executes, PostgreSQL:</p>
<ol type="1">
<li>Validates control file and checks dependencies</li>
<li>Creates entry in <code>pg_extension</code> catalog</li>
<li>Sets <code>creating_extension</code> flag and
<code>CurrentExtensionObject</code></li>
<li>Executes extension script within transaction</li>
<li>Records dependencies for all created objects</li>
</ol>
<p><strong>Dependency Management:</strong></p>
<p>During extension script execution,
<code>recordDependencyOnCurrentExtension()</code> automatically
registers dependencies between the extension and created objects. This
enables:</p>
<ul>
<li>Cascading deletion: <code>DROP EXTENSION</code> removes all member
objects</li>
<li>Upgrade tracking: Objects can be modified during
<code>ALTER EXTENSION UPDATE</code></li>
<li>Membership changes: <code>ALTER EXTENSION ADD/DROP</code> manages
object associations</li>
</ul>
<p><strong>Upgrade Paths:</strong></p>
<p>Extensions support version upgrades through migration scripts:</p>
<pre><code>hstore--1.7--1.8.sql    # Direct upgrade from 1.7 to 1.8
hstore--1.6--1.7.sql    # Chained upgrade: 1.6‚Üí1.7‚Üí1.8</code></pre>
<p>The <code>ALTER EXTENSION extension UPDATE</code> command finds the
shortest path through available upgrade scripts, applying them
sequentially within a single transaction.</p>
<h2 data-number="8.3" id="function-manager-fmgr"><span class="header-section-number">8.3</span> Function Manager (fmgr)</h2>
<p>The function manager provides the runtime infrastructure for calling
PostgreSQL functions, supporting multiple calling conventions, dynamic
library loading, and version compatibility checking.</p>
<h3 data-number="8.3.1" id="function-call-interface"><span class="header-section-number">8.3.1</span> Function Call Interface</h3>
<p>PostgreSQL functions use the ‚Äúversion-1‚Äù calling convention,
characterized by two critical structures: <code>FmgrInfo</code>
(function metadata) and <code>FunctionCallInfoBaseData</code> (call
parameters).</p>
<p><strong>FmgrInfo Structure:</strong></p>
<div class="sourceCode" id="cb446"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb446-1"><a aria-hidden="true" href="#cb446-1" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> FmgrInfo</span>
<span id="cb446-2"><a aria-hidden="true" href="#cb446-2" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb446-3"><a aria-hidden="true" href="#cb446-3" tabindex="-1"></a>    PGFunction  fn_addr<span class="op">;</span>        <span class="co">/* Pointer to function or handler */</span></span>
<span id="cb446-4"><a aria-hidden="true" href="#cb446-4" tabindex="-1"></a>    Oid         fn_oid<span class="op">;</span>         <span class="co">/* OID of function (not handler) */</span></span>
<span id="cb446-5"><a aria-hidden="true" href="#cb446-5" tabindex="-1"></a>    <span class="dt">short</span>       fn_nargs<span class="op">;</span>       <span class="co">/* Number of input arguments (0..FUNC_MAX_ARGS) */</span></span>
<span id="cb446-6"><a aria-hidden="true" href="#cb446-6" tabindex="-1"></a>    <span class="dt">bool</span>        fn_strict<span class="op">;</span>      <span class="co">/* NULL input ‚Üí NULL output? */</span></span>
<span id="cb446-7"><a aria-hidden="true" href="#cb446-7" tabindex="-1"></a>    <span class="dt">bool</span>        fn_retset<span class="op">;</span>      <span class="co">/* Function returns set? */</span></span>
<span id="cb446-8"><a aria-hidden="true" href="#cb446-8" tabindex="-1"></a>    <span class="dt">unsigned</span> <span class="dt">char</span> fn_stats<span class="op">;</span>     <span class="co">/* Statistics collection level */</span></span>
<span id="cb446-9"><a aria-hidden="true" href="#cb446-9" tabindex="-1"></a>    <span class="dt">void</span>       <span class="op">*</span>fn_extra<span class="op">;</span>       <span class="co">/* Handler-specific state */</span></span>
<span id="cb446-10"><a aria-hidden="true" href="#cb446-10" tabindex="-1"></a>    MemoryContext fn_mcxt<span class="op">;</span>      <span class="co">/* Memory context for fn_extra */</span></span>
<span id="cb446-11"><a aria-hidden="true" href="#cb446-11" tabindex="-1"></a>    Node       <span class="op">*</span>fn_expr<span class="op">;</span>        <span class="co">/* Parse tree of call (for optimization) */</span></span>
<span id="cb446-12"><a aria-hidden="true" href="#cb446-12" tabindex="-1"></a><span class="op">}</span> FmgrInfo<span class="op">;</span></span></code></pre></div>
<p>The <code>fn_extra</code> field enables function handlers to cache
state across calls‚Äîcritical for procedural languages that compile
function bodies to bytecode or for index support functions that maintain
search state.</p>
<p><strong>FunctionCallInfoBaseData Structure:</strong></p>
<div class="sourceCode" id="cb447"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb447-1"><a aria-hidden="true" href="#cb447-1" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> FunctionCallInfoBaseData</span>
<span id="cb447-2"><a aria-hidden="true" href="#cb447-2" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb447-3"><a aria-hidden="true" href="#cb447-3" tabindex="-1"></a>    FmgrInfo   <span class="op">*</span>flinfo<span class="op">;</span>         <span class="co">/* Lookup info for this call */</span></span>
<span id="cb447-4"><a aria-hidden="true" href="#cb447-4" tabindex="-1"></a>    Node       <span class="op">*</span>context<span class="op">;</span>        <span class="co">/* Context node (e.g., ExprContext) */</span></span>
<span id="cb447-5"><a aria-hidden="true" href="#cb447-5" tabindex="-1"></a>    Node       <span class="op">*</span>resultinfo<span class="op">;</span>     <span class="co">/* Extra result info (for set-returning functions) */</span></span>
<span id="cb447-6"><a aria-hidden="true" href="#cb447-6" tabindex="-1"></a>    Oid         fncollation<span class="op">;</span>    <span class="co">/* Collation for function to use */</span></span>
<span id="cb447-7"><a aria-hidden="true" href="#cb447-7" tabindex="-1"></a>    <span class="dt">bool</span>        isnull<span class="op">;</span>         <span class="co">/* Function sets true if result is NULL */</span></span>
<span id="cb447-8"><a aria-hidden="true" href="#cb447-8" tabindex="-1"></a>    <span class="dt">short</span>       nargs<span class="op">;</span>          <span class="co">/* Number of arguments actually passed */</span></span>
<span id="cb447-9"><a aria-hidden="true" href="#cb447-9" tabindex="-1"></a>    NullableDatum args<span class="op">[</span>FLEXIBLE_ARRAY_MEMBER<span class="op">];</span></span>
<span id="cb447-10"><a aria-hidden="true" href="#cb447-10" tabindex="-1"></a><span class="op">}</span> FunctionCallInfoBaseData<span class="op">;</span></span></code></pre></div>
<p>The flexible array member <code>args[]</code> contains actual
argument values with null flags. This structure must be allocated with
sufficient space, typically using the <code>LOCAL_FCINFO</code> macro
for stack allocation.</p>
<h3 data-number="8.3.2" id="writing-c-functions"><span class="header-section-number">8.3.2</span> Writing C Functions</h3>
<p>Extensions define C functions using the standard pattern:</p>
<div class="sourceCode" id="cb448"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb448-1"><a aria-hidden="true" href="#cb448-1" tabindex="-1"></a><span class="pp">#include </span><span class="im">"postgres.h"</span></span>
<span id="cb448-2"><a aria-hidden="true" href="#cb448-2" tabindex="-1"></a><span class="pp">#include </span><span class="im">"fmgr.h"</span></span>
<span id="cb448-3"><a aria-hidden="true" href="#cb448-3" tabindex="-1"></a></span>
<span id="cb448-4"><a aria-hidden="true" href="#cb448-4" tabindex="-1"></a>PG_MODULE_MAGIC<span class="op">;</span></span>
<span id="cb448-5"><a aria-hidden="true" href="#cb448-5" tabindex="-1"></a></span>
<span id="cb448-6"><a aria-hidden="true" href="#cb448-6" tabindex="-1"></a>PG_FUNCTION_INFO_V1<span class="op">(</span>my_function<span class="op">);</span></span>
<span id="cb448-7"><a aria-hidden="true" href="#cb448-7" tabindex="-1"></a></span>
<span id="cb448-8"><a aria-hidden="true" href="#cb448-8" tabindex="-1"></a>Datum</span>
<span id="cb448-9"><a aria-hidden="true" href="#cb448-9" tabindex="-1"></a>my_function<span class="op">(</span>PG_FUNCTION_ARGS<span class="op">)</span></span>
<span id="cb448-10"><a aria-hidden="true" href="#cb448-10" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb448-11"><a aria-hidden="true" href="#cb448-11" tabindex="-1"></a>    int32   arg1 <span class="op">=</span> PG_GETARG_INT32<span class="op">(</span><span class="dv">0</span><span class="op">);</span></span>
<span id="cb448-12"><a aria-hidden="true" href="#cb448-12" tabindex="-1"></a>    text   <span class="op">*</span>arg2 <span class="op">=</span> PG_GETARG_TEXT_PP<span class="op">(</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb448-13"><a aria-hidden="true" href="#cb448-13" tabindex="-1"></a></span>
<span id="cb448-14"><a aria-hidden="true" href="#cb448-14" tabindex="-1"></a>    <span class="co">/* Check for NULL if not STRICT */</span></span>
<span id="cb448-15"><a aria-hidden="true" href="#cb448-15" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>PG_ARGISNULL<span class="op">(</span><span class="dv">0</span><span class="op">))</span></span>
<span id="cb448-16"><a aria-hidden="true" href="#cb448-16" tabindex="-1"></a>        PG_RETURN_NULL<span class="op">();</span></span>
<span id="cb448-17"><a aria-hidden="true" href="#cb448-17" tabindex="-1"></a></span>
<span id="cb448-18"><a aria-hidden="true" href="#cb448-18" tabindex="-1"></a>    <span class="co">/* Function logic */</span></span>
<span id="cb448-19"><a aria-hidden="true" href="#cb448-19" tabindex="-1"></a>    int32 result <span class="op">=</span> arg1 <span class="op">*</span> <span class="dv">42</span><span class="op">;</span></span>
<span id="cb448-20"><a aria-hidden="true" href="#cb448-20" tabindex="-1"></a></span>
<span id="cb448-21"><a aria-hidden="true" href="#cb448-21" tabindex="-1"></a>    PG_RETURN_INT32<span class="op">(</span>result<span class="op">);</span></span>
<span id="cb448-22"><a aria-hidden="true" href="#cb448-22" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>Key Macros:</strong></p>
<ul>
<li><code>PG_MODULE_MAGIC</code>: Required version validation</li>
<li><code>PG_FUNCTION_INFO_V1(funcname)</code>: Declares version-1
calling convention</li>
<li><code>PG_FUNCTION_ARGS</code>: Standard parameter declaration</li>
<li><code>PG_GETARG_xxx(n)</code>: Retrieve argument n of type xxx</li>
<li><code>PG_ARGISNULL(n)</code>: Check if argument n is NULL</li>
<li><code>PG_RETURN_xxx(val)</code>: Return value of type xxx</li>
<li><code>PG_RETURN_NULL()</code>: Return NULL</li>
</ul>
<h3 data-number="8.3.3" id="module-validation"><span class="header-section-number">8.3.3</span> Module Validation</h3>
<p>The <code>PG_MODULE_MAGIC</code> macro embeds ABI compatibility
information:</p>
<div class="sourceCode" id="cb449"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb449-1"><a aria-hidden="true" href="#cb449-1" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span></span>
<span id="cb449-2"><a aria-hidden="true" href="#cb449-2" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb449-3"><a aria-hidden="true" href="#cb449-3" tabindex="-1"></a>    <span class="dt">int</span>         version<span class="op">;</span>        <span class="co">/* PostgreSQL major version */</span></span>
<span id="cb449-4"><a aria-hidden="true" href="#cb449-4" tabindex="-1"></a>    <span class="dt">int</span>         funcmaxargs<span class="op">;</span>    <span class="co">/* FUNC_MAX_ARGS */</span></span>
<span id="cb449-5"><a aria-hidden="true" href="#cb449-5" tabindex="-1"></a>    <span class="dt">int</span>         indexmaxkeys<span class="op">;</span>   <span class="co">/* INDEX_MAX_KEYS */</span></span>
<span id="cb449-6"><a aria-hidden="true" href="#cb449-6" tabindex="-1"></a>    <span class="dt">int</span>         namedatalen<span class="op">;</span>    <span class="co">/* NAMEDATALEN */</span></span>
<span id="cb449-7"><a aria-hidden="true" href="#cb449-7" tabindex="-1"></a>    <span class="dt">int</span>         float8byval<span class="op">;</span>    <span class="co">/* FLOAT8PASSBYVAL */</span></span>
<span id="cb449-8"><a aria-hidden="true" href="#cb449-8" tabindex="-1"></a>    <span class="dt">char</span>        abi_extra<span class="op">[</span><span class="dv">32</span><span class="op">];</span>  <span class="co">/* Custom ABI fields */</span></span>
<span id="cb449-9"><a aria-hidden="true" href="#cb449-9" tabindex="-1"></a><span class="op">}</span> Pg_abi_values<span class="op">;</span></span>
<span id="cb449-10"><a aria-hidden="true" href="#cb449-10" tabindex="-1"></a></span>
<span id="cb449-11"><a aria-hidden="true" href="#cb449-11" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span></span>
<span id="cb449-12"><a aria-hidden="true" href="#cb449-12" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb449-13"><a aria-hidden="true" href="#cb449-13" tabindex="-1"></a>    <span class="dt">int</span>             len<span class="op">;</span>        <span class="co">/* sizeof(this struct) */</span></span>
<span id="cb449-14"><a aria-hidden="true" href="#cb449-14" tabindex="-1"></a>    Pg_abi_values   abi_fields<span class="op">;</span></span>
<span id="cb449-15"><a aria-hidden="true" href="#cb449-15" tabindex="-1"></a>    <span class="dt">const</span> <span class="dt">char</span>     <span class="op">*</span>name<span class="op">;</span>       <span class="co">/* Optional module name */</span></span>
<span id="cb449-16"><a aria-hidden="true" href="#cb449-16" tabindex="-1"></a>    <span class="dt">const</span> <span class="dt">char</span>     <span class="op">*</span>version<span class="op">;</span>    <span class="co">/* Optional module version */</span></span>
<span id="cb449-17"><a aria-hidden="true" href="#cb449-17" tabindex="-1"></a><span class="op">}</span> Pg_magic_struct<span class="op">;</span></span></code></pre></div>
<p>When PostgreSQL loads a shared library, it calls
<code>Pg_magic_func()</code> to retrieve this structure and validates
ABI compatibility. Mismatches (e.g., different <code>NAMEDATALEN</code>)
result in load errors, preventing subtle corruption.</p>
<h3 data-number="8.3.4" id="function-manager-hooks"><span class="header-section-number">8.3.4</span> Function Manager Hooks</h3>
<p>Extensions can intercept function calls for security or
instrumentation:</p>
<div class="sourceCode" id="cb450"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb450-1"><a aria-hidden="true" href="#cb450-1" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">enum</span> FmgrHookEventType</span>
<span id="cb450-2"><a aria-hidden="true" href="#cb450-2" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb450-3"><a aria-hidden="true" href="#cb450-3" tabindex="-1"></a>    FHET_START<span class="op">,</span>     <span class="co">/* Before function execution */</span></span>
<span id="cb450-4"><a aria-hidden="true" href="#cb450-4" tabindex="-1"></a>    FHET_END<span class="op">,</span>       <span class="co">/* After successful execution */</span></span>
<span id="cb450-5"><a aria-hidden="true" href="#cb450-5" tabindex="-1"></a>    FHET_ABORT<span class="op">,</span>     <span class="co">/* After error/abort */</span></span>
<span id="cb450-6"><a aria-hidden="true" href="#cb450-6" tabindex="-1"></a><span class="op">}</span> FmgrHookEventType<span class="op">;</span></span>
<span id="cb450-7"><a aria-hidden="true" href="#cb450-7" tabindex="-1"></a></span>
<span id="cb450-8"><a aria-hidden="true" href="#cb450-8" tabindex="-1"></a><span class="kw">typedef</span> <span class="dt">bool</span> <span class="op">(*</span>needs_fmgr_hook_type<span class="op">)</span> <span class="op">(</span>Oid fn_oid<span class="op">);</span></span>
<span id="cb450-9"><a aria-hidden="true" href="#cb450-9" tabindex="-1"></a><span class="kw">typedef</span> <span class="dt">void</span> <span class="op">(*</span>fmgr_hook_type<span class="op">)</span> <span class="op">(</span>FmgrHookEventType event<span class="op">,</span></span>
<span id="cb450-10"><a aria-hidden="true" href="#cb450-10" tabindex="-1"></a>                                FmgrInfo <span class="op">*</span>flinfo<span class="op">,</span> Datum <span class="op">*</span>arg<span class="op">);</span></span>
<span id="cb450-11"><a aria-hidden="true" href="#cb450-11" tabindex="-1"></a></span>
<span id="cb450-12"><a aria-hidden="true" href="#cb450-12" tabindex="-1"></a><span class="kw">extern</span> PGDLLIMPORT needs_fmgr_hook_type needs_fmgr_hook<span class="op">;</span></span>
<span id="cb450-13"><a aria-hidden="true" href="#cb450-13" tabindex="-1"></a><span class="kw">extern</span> PGDLLIMPORT fmgr_hook_type fmgr_hook<span class="op">;</span></span></code></pre></div>
<p>Security extensions use these hooks to enforce additional privilege
checks or audit function invocations.</p>
<h2 data-number="8.4" id="procedural-languages"><span class="header-section-number">8.4</span> Procedural Languages</h2>
<p>PostgreSQL supports multiple procedural languages through a
handler-based architecture. Each language implements a handler function
that compiles and executes function bodies written in that language.</p>
<h3 data-number="8.4.1" id="language-handler-interface"><span class="header-section-number">8.4.1</span> Language Handler
Interface</h3>
<p>Procedural language handlers are standard PostgreSQL functions with
signature:</p>
<div class="sourceCode" id="cb451"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb451-1"><a aria-hidden="true" href="#cb451-1" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">FUNCTION</span> plpgsql_call_handler()</span>
<span id="cb451-2"><a aria-hidden="true" href="#cb451-2" tabindex="-1"></a>RETURNS language_handler</span>
<span id="cb451-3"><a aria-hidden="true" href="#cb451-3" tabindex="-1"></a><span class="kw">AS</span> <span class="st">'$libdir/plpgsql'</span>, <span class="st">'plpgsql_call_handler'</span></span>
<span id="cb451-4"><a aria-hidden="true" href="#cb451-4" tabindex="-1"></a>LANGUAGE C;</span></code></pre></div>
<p>The handler receives <code>FunctionCallInfo</code> containing: -
Function OID in <code>flinfo-&gt;fn_oid</code> - Function arguments in
<code>fcinfo-&gt;args[]</code> - Context information in
<code>fcinfo-&gt;context</code></p>
<p>The handler must: 1. Retrieve function source from
<code>pg_proc.prosrc</code> 2. Compile or interpret the function body 3.
Execute with provided arguments 4. Return result as
<code>Datum</code></p>
<h3 data-number="8.4.2" id="plpgsql"><span class="header-section-number">8.4.2</span> PL/pgSQL</h3>
<p>PL/pgSQL is PostgreSQL‚Äôs native procedural language, providing
SQL-like syntax with control structures:</p>
<div class="sourceCode" id="cb452"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb452-1"><a aria-hidden="true" href="#cb452-1" tabindex="-1"></a><span class="co">/* pl_handler.c - PL/pgSQL initialization */</span></span>
<span id="cb452-2"><a aria-hidden="true" href="#cb452-2" tabindex="-1"></a></span>
<span id="cb452-3"><a aria-hidden="true" href="#cb452-3" tabindex="-1"></a>PG_MODULE_MAGIC_EXT<span class="op">(</span></span>
<span id="cb452-4"><a aria-hidden="true" href="#cb452-4" tabindex="-1"></a>    <span class="op">.</span>name <span class="op">=</span> <span class="st">"plpgsql"</span><span class="op">,</span></span>
<span id="cb452-5"><a aria-hidden="true" href="#cb452-5" tabindex="-1"></a>    <span class="op">.</span>version <span class="op">=</span> PG_VERSION</span>
<span id="cb452-6"><a aria-hidden="true" href="#cb452-6" tabindex="-1"></a><span class="op">);</span></span>
<span id="cb452-7"><a aria-hidden="true" href="#cb452-7" tabindex="-1"></a></span>
<span id="cb452-8"><a aria-hidden="true" href="#cb452-8" tabindex="-1"></a><span class="dt">void</span></span>
<span id="cb452-9"><a aria-hidden="true" href="#cb452-9" tabindex="-1"></a>_PG_init<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb452-10"><a aria-hidden="true" href="#cb452-10" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb452-11"><a aria-hidden="true" href="#cb452-11" tabindex="-1"></a>    <span class="co">/* Define custom GUC variables */</span></span>
<span id="cb452-12"><a aria-hidden="true" href="#cb452-12" tabindex="-1"></a>    DefineCustomEnumVariable<span class="op">(</span><span class="st">"plpgsql.variable_conflict"</span><span class="op">,</span></span>
<span id="cb452-13"><a aria-hidden="true" href="#cb452-13" tabindex="-1"></a>                            <span class="st">"Resolve name conflicts between variables and columns"</span><span class="op">,</span></span>
<span id="cb452-14"><a aria-hidden="true" href="#cb452-14" tabindex="-1"></a>                            NULL<span class="op">,</span></span>
<span id="cb452-15"><a aria-hidden="true" href="#cb452-15" tabindex="-1"></a>                            <span class="op">&amp;</span>plpgsql_variable_conflict<span class="op">,</span></span>
<span id="cb452-16"><a aria-hidden="true" href="#cb452-16" tabindex="-1"></a>                            PLPGSQL_RESOLVE_ERROR<span class="op">,</span></span>
<span id="cb452-17"><a aria-hidden="true" href="#cb452-17" tabindex="-1"></a>                            variable_conflict_options<span class="op">,</span></span>
<span id="cb452-18"><a aria-hidden="true" href="#cb452-18" tabindex="-1"></a>                            PGC_SUSET<span class="op">,</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb452-19"><a aria-hidden="true" href="#cb452-19" tabindex="-1"></a>                            NULL<span class="op">,</span> NULL<span class="op">,</span> NULL<span class="op">);</span></span>
<span id="cb452-20"><a aria-hidden="true" href="#cb452-20" tabindex="-1"></a></span>
<span id="cb452-21"><a aria-hidden="true" href="#cb452-21" tabindex="-1"></a>    <span class="co">/* Register hooks for plugins */</span></span>
<span id="cb452-22"><a aria-hidden="true" href="#cb452-22" tabindex="-1"></a>    plpgsql_plugin_ptr <span class="op">=</span> <span class="op">(</span>PLpgSQL_plugin <span class="op">**)</span></span>
<span id="cb452-23"><a aria-hidden="true" href="#cb452-23" tabindex="-1"></a>        find_rendezvous_variable<span class="op">(</span><span class="st">"PLpgSQL_plugin"</span><span class="op">);</span></span>
<span id="cb452-24"><a aria-hidden="true" href="#cb452-24" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>PL/pgSQL Architecture:</strong></p>
<ol type="1">
<li><strong>Parser</strong>: Converts function source to abstract syntax
tree (AST)</li>
<li><strong>Executor</strong>: Interprets AST, executing statements
sequentially</li>
<li><strong>Expression Evaluator</strong>: Compiles SQL expressions to
executable form</li>
<li><strong>Exception Handler</strong>: Manages EXCEPTION blocks with
savepoints</li>
</ol>
<p>PL/pgSQL caches compiled function representations in
<code>fn_extra</code>, avoiding repeated parsing for frequently called
functions.</p>
<h3 data-number="8.4.3" id="plpython-plperl-pltcl"><span class="header-section-number">8.4.3</span> PL/Python, PL/Perl,
PL/Tcl</h3>
<p>These languages embed external interpreters:</p>
<p><strong>PL/Python:</strong> - Embeds Python interpreter (Python 3) -
Converts PostgreSQL types to Python objects and vice versa - Supports
<code>plpython3u</code> (untrusted, full Python API) and
<code>plpython3</code> (trusted, restricted) - Enables import of Python
modules</p>
<p><strong>PL/Perl:</strong> - Embeds Perl interpreter - Provides
<code>plperl</code> (trusted, Safe compartment) and <code>plperlu</code>
(untrusted) - Supports Perl modules and CPAN libraries in untrusted
mode</p>
<p><strong>PL/Tcl:</strong> - Embeds Tcl interpreter - Provides
<code>pltcl</code> (trusted, restricted commands) and
<code>pltclu</code> (untrusted) - Enables Tcl packages and
extensions</p>
<p>All external languages face similar challenges: - Type conversion
between database and language type systems - Memory management across
language boundaries - Error handling and exception translation -
Security isolation in trusted variants</p>
<h3 data-number="8.4.4" id="language-handler-example-pattern"><span class="header-section-number">8.4.4</span> Language Handler Example
Pattern</h3>
<div class="sourceCode" id="cb453"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb453-1"><a aria-hidden="true" href="#cb453-1" tabindex="-1"></a>Datum</span>
<span id="cb453-2"><a aria-hidden="true" href="#cb453-2" tabindex="-1"></a>language_call_handler<span class="op">(</span>PG_FUNCTION_ARGS<span class="op">)</span></span>
<span id="cb453-3"><a aria-hidden="true" href="#cb453-3" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb453-4"><a aria-hidden="true" href="#cb453-4" tabindex="-1"></a>    Oid         funcoid <span class="op">=</span> fcinfo<span class="op">-&gt;</span>flinfo<span class="op">-&gt;</span>fn_oid<span class="op">;</span></span>
<span id="cb453-5"><a aria-hidden="true" href="#cb453-5" tabindex="-1"></a>    HeapTuple   proctup<span class="op">;</span></span>
<span id="cb453-6"><a aria-hidden="true" href="#cb453-6" tabindex="-1"></a>    Form_pg_proc procstruct<span class="op">;</span></span>
<span id="cb453-7"><a aria-hidden="true" href="#cb453-7" tabindex="-1"></a>    <span class="dt">char</span>       <span class="op">*</span>source<span class="op">;</span></span>
<span id="cb453-8"><a aria-hidden="true" href="#cb453-8" tabindex="-1"></a>    Datum       retval<span class="op">;</span></span>
<span id="cb453-9"><a aria-hidden="true" href="#cb453-9" tabindex="-1"></a></span>
<span id="cb453-10"><a aria-hidden="true" href="#cb453-10" tabindex="-1"></a>    <span class="co">/* Look up function in pg_proc */</span></span>
<span id="cb453-11"><a aria-hidden="true" href="#cb453-11" tabindex="-1"></a>    proctup <span class="op">=</span> SearchSysCache1<span class="op">(</span>PROCOID<span class="op">,</span> ObjectIdGetDatum<span class="op">(</span>funcoid<span class="op">));</span></span>
<span id="cb453-12"><a aria-hidden="true" href="#cb453-12" tabindex="-1"></a>    procstruct <span class="op">=</span> <span class="op">(</span>Form_pg_proc<span class="op">)</span> GETSTRUCT<span class="op">(</span>proctup<span class="op">);</span></span>
<span id="cb453-13"><a aria-hidden="true" href="#cb453-13" tabindex="-1"></a></span>
<span id="cb453-14"><a aria-hidden="true" href="#cb453-14" tabindex="-1"></a>    <span class="co">/* Get function source */</span></span>
<span id="cb453-15"><a aria-hidden="true" href="#cb453-15" tabindex="-1"></a>    source <span class="op">=</span> TextDatumGetCString<span class="op">(&amp;</span>procstruct<span class="op">-&gt;</span>prosrc<span class="op">);</span></span>
<span id="cb453-16"><a aria-hidden="true" href="#cb453-16" tabindex="-1"></a></span>
<span id="cb453-17"><a aria-hidden="true" href="#cb453-17" tabindex="-1"></a>    <span class="co">/* Check if compiled version cached */</span></span>
<span id="cb453-18"><a aria-hidden="true" href="#cb453-18" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>fcinfo<span class="op">-&gt;</span>flinfo<span class="op">-&gt;</span>fn_extra <span class="op">==</span> NULL<span class="op">)</span></span>
<span id="cb453-19"><a aria-hidden="true" href="#cb453-19" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb453-20"><a aria-hidden="true" href="#cb453-20" tabindex="-1"></a>        <span class="co">/* Compile function */</span></span>
<span id="cb453-21"><a aria-hidden="true" href="#cb453-21" tabindex="-1"></a>        fcinfo<span class="op">-&gt;</span>flinfo<span class="op">-&gt;</span>fn_extra <span class="op">=</span> compile_function<span class="op">(</span>source<span class="op">);</span></span>
<span id="cb453-22"><a aria-hidden="true" href="#cb453-22" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb453-23"><a aria-hidden="true" href="#cb453-23" tabindex="-1"></a></span>
<span id="cb453-24"><a aria-hidden="true" href="#cb453-24" tabindex="-1"></a>    <span class="co">/* Execute */</span></span>
<span id="cb453-25"><a aria-hidden="true" href="#cb453-25" tabindex="-1"></a>    retval <span class="op">=</span> execute_function<span class="op">(</span>fcinfo<span class="op">-&gt;</span>flinfo<span class="op">-&gt;</span>fn_extra<span class="op">,</span> fcinfo<span class="op">);</span></span>
<span id="cb453-26"><a aria-hidden="true" href="#cb453-26" tabindex="-1"></a></span>
<span id="cb453-27"><a aria-hidden="true" href="#cb453-27" tabindex="-1"></a>    ReleaseSysCache<span class="op">(</span>proctup<span class="op">);</span></span>
<span id="cb453-28"><a aria-hidden="true" href="#cb453-28" tabindex="-1"></a>    <span class="cf">return</span> retval<span class="op">;</span></span>
<span id="cb453-29"><a aria-hidden="true" href="#cb453-29" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2 data-number="8.5" id="foreign-data-wrappers"><span class="header-section-number">8.5</span> Foreign Data Wrappers</h2>
<p>Foreign Data Wrappers (FDWs) enable PostgreSQL to query external data
sources as if they were local tables, implementing the SQL/MED
(Management of External Data) standard.</p>
<h3 data-number="8.5.1" id="fdw-api-architecture"><span class="header-section-number">8.5.1</span> FDW API Architecture</h3>
<p>FDWs implement the <code>FdwRoutine</code> structure, providing
callbacks for query planning and execution:</p>
<div class="sourceCode" id="cb454"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb454-1"><a aria-hidden="true" href="#cb454-1" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> FdwRoutine</span>
<span id="cb454-2"><a aria-hidden="true" href="#cb454-2" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb454-3"><a aria-hidden="true" href="#cb454-3" tabindex="-1"></a>    NodeTag     type<span class="op">;</span></span>
<span id="cb454-4"><a aria-hidden="true" href="#cb454-4" tabindex="-1"></a></span>
<span id="cb454-5"><a aria-hidden="true" href="#cb454-5" tabindex="-1"></a>    <span class="co">/* Planning functions */</span></span>
<span id="cb454-6"><a aria-hidden="true" href="#cb454-6" tabindex="-1"></a>    GetForeignRelSize_function GetForeignRelSize<span class="op">;</span></span>
<span id="cb454-7"><a aria-hidden="true" href="#cb454-7" tabindex="-1"></a>    GetForeignPaths_function GetForeignPaths<span class="op">;</span></span>
<span id="cb454-8"><a aria-hidden="true" href="#cb454-8" tabindex="-1"></a>    GetForeignPlan_function GetForeignPlan<span class="op">;</span></span>
<span id="cb454-9"><a aria-hidden="true" href="#cb454-9" tabindex="-1"></a></span>
<span id="cb454-10"><a aria-hidden="true" href="#cb454-10" tabindex="-1"></a>    <span class="co">/* Execution functions */</span></span>
<span id="cb454-11"><a aria-hidden="true" href="#cb454-11" tabindex="-1"></a>    BeginForeignScan_function BeginForeignScan<span class="op">;</span></span>
<span id="cb454-12"><a aria-hidden="true" href="#cb454-12" tabindex="-1"></a>    IterateForeignScan_function IterateForeignScan<span class="op">;</span></span>
<span id="cb454-13"><a aria-hidden="true" href="#cb454-13" tabindex="-1"></a>    ReScanForeignScan_function ReScanForeignScan<span class="op">;</span></span>
<span id="cb454-14"><a aria-hidden="true" href="#cb454-14" tabindex="-1"></a>    EndForeignScan_function EndForeignScan<span class="op">;</span></span>
<span id="cb454-15"><a aria-hidden="true" href="#cb454-15" tabindex="-1"></a></span>
<span id="cb454-16"><a aria-hidden="true" href="#cb454-16" tabindex="-1"></a>    <span class="co">/* Optional: DML operations */</span></span>
<span id="cb454-17"><a aria-hidden="true" href="#cb454-17" tabindex="-1"></a>    PlanForeignModify_function PlanForeignModify<span class="op">;</span></span>
<span id="cb454-18"><a aria-hidden="true" href="#cb454-18" tabindex="-1"></a>    BeginForeignModify_function BeginForeignModify<span class="op">;</span></span>
<span id="cb454-19"><a aria-hidden="true" href="#cb454-19" tabindex="-1"></a>    ExecForeignInsert_function ExecForeignInsert<span class="op">;</span></span>
<span id="cb454-20"><a aria-hidden="true" href="#cb454-20" tabindex="-1"></a>    ExecForeignUpdate_function ExecForeignUpdate<span class="op">;</span></span>
<span id="cb454-21"><a aria-hidden="true" href="#cb454-21" tabindex="-1"></a>    ExecForeignDelete_function ExecForeignDelete<span class="op">;</span></span>
<span id="cb454-22"><a aria-hidden="true" href="#cb454-22" tabindex="-1"></a>    EndForeignModify_function EndForeignModify<span class="op">;</span></span>
<span id="cb454-23"><a aria-hidden="true" href="#cb454-23" tabindex="-1"></a></span>
<span id="cb454-24"><a aria-hidden="true" href="#cb454-24" tabindex="-1"></a>    <span class="co">/* Optional: JOIN pushdown */</span></span>
<span id="cb454-25"><a aria-hidden="true" href="#cb454-25" tabindex="-1"></a>    GetForeignJoinPaths_function GetForeignJoinPaths<span class="op">;</span></span>
<span id="cb454-26"><a aria-hidden="true" href="#cb454-26" tabindex="-1"></a></span>
<span id="cb454-27"><a aria-hidden="true" href="#cb454-27" tabindex="-1"></a>    <span class="co">/* Optional: Aggregate pushdown */</span></span>
<span id="cb454-28"><a aria-hidden="true" href="#cb454-28" tabindex="-1"></a>    GetForeignUpperPaths_function GetForeignUpperPaths<span class="op">;</span></span>
<span id="cb454-29"><a aria-hidden="true" href="#cb454-29" tabindex="-1"></a></span>
<span id="cb454-30"><a aria-hidden="true" href="#cb454-30" tabindex="-1"></a>    <span class="co">/* Optional: EXPLAIN support */</span></span>
<span id="cb454-31"><a aria-hidden="true" href="#cb454-31" tabindex="-1"></a>    ExplainForeignScan_function ExplainForeignScan<span class="op">;</span></span>
<span id="cb454-32"><a aria-hidden="true" href="#cb454-32" tabindex="-1"></a></span>
<span id="cb454-33"><a aria-hidden="true" href="#cb454-33" tabindex="-1"></a>    <span class="co">/* Optional: ANALYZE support */</span></span>
<span id="cb454-34"><a aria-hidden="true" href="#cb454-34" tabindex="-1"></a>    AnalyzeForeignTable_function AnalyzeForeignTable<span class="op">;</span></span>
<span id="cb454-35"><a aria-hidden="true" href="#cb454-35" tabindex="-1"></a></span>
<span id="cb454-36"><a aria-hidden="true" href="#cb454-36" tabindex="-1"></a>    <span class="co">/* Optional: Parallel execution */</span></span>
<span id="cb454-37"><a aria-hidden="true" href="#cb454-37" tabindex="-1"></a>    IsForeignScanParallelSafe_function IsForeignScanParallelSafe<span class="op">;</span></span>
<span id="cb454-38"><a aria-hidden="true" href="#cb454-38" tabindex="-1"></a>    EstimateDSMForeignScan_function EstimateDSMForeignScan<span class="op">;</span></span>
<span id="cb454-39"><a aria-hidden="true" href="#cb454-39" tabindex="-1"></a>    InitializeDSMForeignScan_function InitializeDSMForeignScan<span class="op">;</span></span>
<span id="cb454-40"><a aria-hidden="true" href="#cb454-40" tabindex="-1"></a>    InitializeWorkerForeignScan_function InitializeWorkerForeignScan<span class="op">;</span></span>
<span id="cb454-41"><a aria-hidden="true" href="#cb454-41" tabindex="-1"></a></span>
<span id="cb454-42"><a aria-hidden="true" href="#cb454-42" tabindex="-1"></a>    <span class="co">/* Optional: Asynchronous execution */</span></span>
<span id="cb454-43"><a aria-hidden="true" href="#cb454-43" tabindex="-1"></a>    IsForeignPathAsyncCapable_function IsForeignPathAsyncCapable<span class="op">;</span></span>
<span id="cb454-44"><a aria-hidden="true" href="#cb454-44" tabindex="-1"></a>    ForeignAsyncRequest_function ForeignAsyncRequest<span class="op">;</span></span>
<span id="cb454-45"><a aria-hidden="true" href="#cb454-45" tabindex="-1"></a>    ForeignAsyncConfigureWait_function ForeignAsyncConfigureWait<span class="op">;</span></span>
<span id="cb454-46"><a aria-hidden="true" href="#cb454-46" tabindex="-1"></a>    ForeignAsyncNotify_function ForeignAsyncNotify<span class="op">;</span></span>
<span id="cb454-47"><a aria-hidden="true" href="#cb454-47" tabindex="-1"></a><span class="op">}</span> FdwRoutine<span class="op">;</span></span></code></pre></div>
<h3 data-number="8.5.2" id="fdw-handler-function"><span class="header-section-number">8.5.2</span> FDW Handler Function</h3>
<p>FDWs provide a handler that returns <code>FdwRoutine</code>:</p>
<div class="sourceCode" id="cb455"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb455-1"><a aria-hidden="true" href="#cb455-1" tabindex="-1"></a>PG_FUNCTION_INFO_V1<span class="op">(</span>file_fdw_handler<span class="op">);</span></span>
<span id="cb455-2"><a aria-hidden="true" href="#cb455-2" tabindex="-1"></a></span>
<span id="cb455-3"><a aria-hidden="true" href="#cb455-3" tabindex="-1"></a>Datum</span>
<span id="cb455-4"><a aria-hidden="true" href="#cb455-4" tabindex="-1"></a>file_fdw_handler<span class="op">(</span>PG_FUNCTION_ARGS<span class="op">)</span></span>
<span id="cb455-5"><a aria-hidden="true" href="#cb455-5" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb455-6"><a aria-hidden="true" href="#cb455-6" tabindex="-1"></a>    FdwRoutine <span class="op">*</span>routine <span class="op">=</span> makeNode<span class="op">(</span>FdwRoutine<span class="op">);</span></span>
<span id="cb455-7"><a aria-hidden="true" href="#cb455-7" tabindex="-1"></a></span>
<span id="cb455-8"><a aria-hidden="true" href="#cb455-8" tabindex="-1"></a>    <span class="co">/* Required planning functions */</span></span>
<span id="cb455-9"><a aria-hidden="true" href="#cb455-9" tabindex="-1"></a>    routine<span class="op">-&gt;</span>GetForeignRelSize <span class="op">=</span> fileGetForeignRelSize<span class="op">;</span></span>
<span id="cb455-10"><a aria-hidden="true" href="#cb455-10" tabindex="-1"></a>    routine<span class="op">-&gt;</span>GetForeignPaths <span class="op">=</span> fileGetForeignPaths<span class="op">;</span></span>
<span id="cb455-11"><a aria-hidden="true" href="#cb455-11" tabindex="-1"></a>    routine<span class="op">-&gt;</span>GetForeignPlan <span class="op">=</span> fileGetForeignPlan<span class="op">;</span></span>
<span id="cb455-12"><a aria-hidden="true" href="#cb455-12" tabindex="-1"></a></span>
<span id="cb455-13"><a aria-hidden="true" href="#cb455-13" tabindex="-1"></a>    <span class="co">/* Required execution functions */</span></span>
<span id="cb455-14"><a aria-hidden="true" href="#cb455-14" tabindex="-1"></a>    routine<span class="op">-&gt;</span>BeginForeignScan <span class="op">=</span> fileBeginForeignScan<span class="op">;</span></span>
<span id="cb455-15"><a aria-hidden="true" href="#cb455-15" tabindex="-1"></a>    routine<span class="op">-&gt;</span>IterateForeignScan <span class="op">=</span> fileIterateForeignScan<span class="op">;</span></span>
<span id="cb455-16"><a aria-hidden="true" href="#cb455-16" tabindex="-1"></a>    routine<span class="op">-&gt;</span>ReScanForeignScan <span class="op">=</span> fileReScanForeignScan<span class="op">;</span></span>
<span id="cb455-17"><a aria-hidden="true" href="#cb455-17" tabindex="-1"></a>    routine<span class="op">-&gt;</span>EndForeignScan <span class="op">=</span> fileEndForeignScan<span class="op">;</span></span>
<span id="cb455-18"><a aria-hidden="true" href="#cb455-18" tabindex="-1"></a></span>
<span id="cb455-19"><a aria-hidden="true" href="#cb455-19" tabindex="-1"></a>    <span class="co">/* Optional features */</span></span>
<span id="cb455-20"><a aria-hidden="true" href="#cb455-20" tabindex="-1"></a>    routine<span class="op">-&gt;</span>ExplainForeignScan <span class="op">=</span> fileExplainForeignScan<span class="op">;</span></span>
<span id="cb455-21"><a aria-hidden="true" href="#cb455-21" tabindex="-1"></a>    routine<span class="op">-&gt;</span>AnalyzeForeignTable <span class="op">=</span> fileAnalyzeForeignTable<span class="op">;</span></span>
<span id="cb455-22"><a aria-hidden="true" href="#cb455-22" tabindex="-1"></a></span>
<span id="cb455-23"><a aria-hidden="true" href="#cb455-23" tabindex="-1"></a>    PG_RETURN_POINTER<span class="op">(</span>routine<span class="op">);</span></span>
<span id="cb455-24"><a aria-hidden="true" href="#cb455-24" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 data-number="8.5.3" id="file_fdw-example"><span class="header-section-number">8.5.3</span> file_fdw Example</h3>
<p>The <code>file_fdw</code> extension reads CSV and text files as
foreign tables:</p>
<div class="sourceCode" id="cb456"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb456-1"><a aria-hidden="true" href="#cb456-1" tabindex="-1"></a><span class="co">/* Planning: estimate relation size */</span></span>
<span id="cb456-2"><a aria-hidden="true" href="#cb456-2" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span></span>
<span id="cb456-3"><a aria-hidden="true" href="#cb456-3" tabindex="-1"></a>fileGetForeignRelSize<span class="op">(</span>PlannerInfo <span class="op">*</span>root<span class="op">,</span></span>
<span id="cb456-4"><a aria-hidden="true" href="#cb456-4" tabindex="-1"></a>                     RelOptInfo <span class="op">*</span>baserel<span class="op">,</span></span>
<span id="cb456-5"><a aria-hidden="true" href="#cb456-5" tabindex="-1"></a>                     Oid foreigntableid<span class="op">)</span></span>
<span id="cb456-6"><a aria-hidden="true" href="#cb456-6" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb456-7"><a aria-hidden="true" href="#cb456-7" tabindex="-1"></a>    FileFdwPlanState <span class="op">*</span>fdw_private<span class="op">;</span></span>
<span id="cb456-8"><a aria-hidden="true" href="#cb456-8" tabindex="-1"></a></span>
<span id="cb456-9"><a aria-hidden="true" href="#cb456-9" tabindex="-1"></a>    fdw_private <span class="op">=</span> <span class="op">(</span>FileFdwPlanState <span class="op">*)</span> palloc<span class="op">(</span><span class="kw">sizeof</span><span class="op">(</span>FileFdwPlanState<span class="op">));</span></span>
<span id="cb456-10"><a aria-hidden="true" href="#cb456-10" tabindex="-1"></a></span>
<span id="cb456-11"><a aria-hidden="true" href="#cb456-11" tabindex="-1"></a>    <span class="co">/* Get filename and options from foreign table options */</span></span>
<span id="cb456-12"><a aria-hidden="true" href="#cb456-12" tabindex="-1"></a>    fileGetOptions<span class="op">(</span>foreigntableid<span class="op">,</span> <span class="op">&amp;</span>fdw_private<span class="op">-&gt;</span>filename<span class="op">,</span></span>
<span id="cb456-13"><a aria-hidden="true" href="#cb456-13" tabindex="-1"></a>                  <span class="op">&amp;</span>fdw_private<span class="op">-&gt;</span>is_program<span class="op">,</span> <span class="op">&amp;</span>fdw_private<span class="op">-&gt;</span>options<span class="op">);</span></span>
<span id="cb456-14"><a aria-hidden="true" href="#cb456-14" tabindex="-1"></a></span>
<span id="cb456-15"><a aria-hidden="true" href="#cb456-15" tabindex="-1"></a>    <span class="co">/* Estimate file size */</span></span>
<span id="cb456-16"><a aria-hidden="true" href="#cb456-16" tabindex="-1"></a>    estimate_size<span class="op">(</span>root<span class="op">,</span> baserel<span class="op">,</span> fdw_private<span class="op">);</span></span>
<span id="cb456-17"><a aria-hidden="true" href="#cb456-17" tabindex="-1"></a></span>
<span id="cb456-18"><a aria-hidden="true" href="#cb456-18" tabindex="-1"></a>    baserel<span class="op">-&gt;</span>fdw_private <span class="op">=</span> fdw_private<span class="op">;</span></span>
<span id="cb456-19"><a aria-hidden="true" href="#cb456-19" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb456-20"><a aria-hidden="true" href="#cb456-20" tabindex="-1"></a></span>
<span id="cb456-21"><a aria-hidden="true" href="#cb456-21" tabindex="-1"></a><span class="co">/* Planning: generate access paths */</span></span>
<span id="cb456-22"><a aria-hidden="true" href="#cb456-22" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span></span>
<span id="cb456-23"><a aria-hidden="true" href="#cb456-23" tabindex="-1"></a>fileGetForeignPaths<span class="op">(</span>PlannerInfo <span class="op">*</span>root<span class="op">,</span></span>
<span id="cb456-24"><a aria-hidden="true" href="#cb456-24" tabindex="-1"></a>                   RelOptInfo <span class="op">*</span>baserel<span class="op">,</span></span>
<span id="cb456-25"><a aria-hidden="true" href="#cb456-25" tabindex="-1"></a>                   Oid foreigntableid<span class="op">)</span></span>
<span id="cb456-26"><a aria-hidden="true" href="#cb456-26" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb456-27"><a aria-hidden="true" href="#cb456-27" tabindex="-1"></a>    FileFdwPlanState <span class="op">*</span>fdw_private <span class="op">=</span> baserel<span class="op">-&gt;</span>fdw_private<span class="op">;</span></span>
<span id="cb456-28"><a aria-hidden="true" href="#cb456-28" tabindex="-1"></a>    Cost        startup_cost<span class="op">;</span></span>
<span id="cb456-29"><a aria-hidden="true" href="#cb456-29" tabindex="-1"></a>    Cost        total_cost<span class="op">;</span></span>
<span id="cb456-30"><a aria-hidden="true" href="#cb456-30" tabindex="-1"></a></span>
<span id="cb456-31"><a aria-hidden="true" href="#cb456-31" tabindex="-1"></a>    <span class="co">/* Calculate costs */</span></span>
<span id="cb456-32"><a aria-hidden="true" href="#cb456-32" tabindex="-1"></a>    estimate_costs<span class="op">(</span>root<span class="op">,</span> baserel<span class="op">,</span> fdw_private<span class="op">,</span></span>
<span id="cb456-33"><a aria-hidden="true" href="#cb456-33" tabindex="-1"></a>                  <span class="op">&amp;</span>startup_cost<span class="op">,</span> <span class="op">&amp;</span>total_cost<span class="op">);</span></span>
<span id="cb456-34"><a aria-hidden="true" href="#cb456-34" tabindex="-1"></a></span>
<span id="cb456-35"><a aria-hidden="true" href="#cb456-35" tabindex="-1"></a>    <span class="co">/* Create foreign path */</span></span>
<span id="cb456-36"><a aria-hidden="true" href="#cb456-36" tabindex="-1"></a>    add_path<span class="op">(</span>baserel<span class="op">,</span> <span class="op">(</span>Path <span class="op">*)</span></span>
<span id="cb456-37"><a aria-hidden="true" href="#cb456-37" tabindex="-1"></a>             create_foreignscan_path<span class="op">(</span>root<span class="op">,</span> baserel<span class="op">,</span></span>
<span id="cb456-38"><a aria-hidden="true" href="#cb456-38" tabindex="-1"></a>                                   NULL<span class="op">,</span>    <span class="co">/* default pathtarget */</span></span>
<span id="cb456-39"><a aria-hidden="true" href="#cb456-39" tabindex="-1"></a>                                   baserel<span class="op">-&gt;</span>rows<span class="op">,</span></span>
<span id="cb456-40"><a aria-hidden="true" href="#cb456-40" tabindex="-1"></a>                                   startup_cost<span class="op">,</span></span>
<span id="cb456-41"><a aria-hidden="true" href="#cb456-41" tabindex="-1"></a>                                   total_cost<span class="op">,</span></span>
<span id="cb456-42"><a aria-hidden="true" href="#cb456-42" tabindex="-1"></a>                                   NIL<span class="op">,</span>     <span class="co">/* no pathkeys */</span></span>
<span id="cb456-43"><a aria-hidden="true" href="#cb456-43" tabindex="-1"></a>                                   NULL<span class="op">,</span>    <span class="co">/* no outer rel */</span></span>
<span id="cb456-44"><a aria-hidden="true" href="#cb456-44" tabindex="-1"></a>                                   NULL<span class="op">,</span>    <span class="co">/* no extra plan */</span></span>
<span id="cb456-45"><a aria-hidden="true" href="#cb456-45" tabindex="-1"></a>                                   NIL<span class="op">));</span>   <span class="co">/* no fdw_private */</span></span>
<span id="cb456-46"><a aria-hidden="true" href="#cb456-46" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb456-47"><a aria-hidden="true" href="#cb456-47" tabindex="-1"></a></span>
<span id="cb456-48"><a aria-hidden="true" href="#cb456-48" tabindex="-1"></a><span class="co">/* Execution: start scan */</span></span>
<span id="cb456-49"><a aria-hidden="true" href="#cb456-49" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span></span>
<span id="cb456-50"><a aria-hidden="true" href="#cb456-50" tabindex="-1"></a>fileBeginForeignScan<span class="op">(</span>ForeignScanState <span class="op">*</span>node<span class="op">,</span> <span class="dt">int</span> eflags<span class="op">)</span></span>
<span id="cb456-51"><a aria-hidden="true" href="#cb456-51" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb456-52"><a aria-hidden="true" href="#cb456-52" tabindex="-1"></a>    FileFdwExecutionState <span class="op">*</span>festate<span class="op">;</span></span>
<span id="cb456-53"><a aria-hidden="true" href="#cb456-53" tabindex="-1"></a></span>
<span id="cb456-54"><a aria-hidden="true" href="#cb456-54" tabindex="-1"></a>    festate <span class="op">=</span> <span class="op">(</span>FileFdwExecutionState <span class="op">*)</span> palloc<span class="op">(</span><span class="kw">sizeof</span><span class="op">(</span>FileFdwExecutionState<span class="op">));</span></span>
<span id="cb456-55"><a aria-hidden="true" href="#cb456-55" tabindex="-1"></a></span>
<span id="cb456-56"><a aria-hidden="true" href="#cb456-56" tabindex="-1"></a>    <span class="co">/* Get filename and options */</span></span>
<span id="cb456-57"><a aria-hidden="true" href="#cb456-57" tabindex="-1"></a>    fileGetOptions<span class="op">(</span>RelationGetRelid<span class="op">(</span>node<span class="op">-&gt;</span>ss<span class="op">.</span>ss_currentRelation<span class="op">),</span></span>
<span id="cb456-58"><a aria-hidden="true" href="#cb456-58" tabindex="-1"></a>                  <span class="op">&amp;</span>festate<span class="op">-&gt;</span>filename<span class="op">,</span> <span class="op">&amp;</span>festate<span class="op">-&gt;</span>is_program<span class="op">,</span></span>
<span id="cb456-59"><a aria-hidden="true" href="#cb456-59" tabindex="-1"></a>                  <span class="op">&amp;</span>festate<span class="op">-&gt;</span>options<span class="op">);</span></span>
<span id="cb456-60"><a aria-hidden="true" href="#cb456-60" tabindex="-1"></a></span>
<span id="cb456-61"><a aria-hidden="true" href="#cb456-61" tabindex="-1"></a>    <span class="co">/* Open file and initialize COPY state */</span></span>
<span id="cb456-62"><a aria-hidden="true" href="#cb456-62" tabindex="-1"></a>    festate<span class="op">-&gt;</span>cstate <span class="op">=</span> BeginCopyFrom<span class="op">(</span>node<span class="op">-&gt;</span>ss<span class="op">.</span>ss_currentRelation<span class="op">,</span></span>
<span id="cb456-63"><a aria-hidden="true" href="#cb456-63" tabindex="-1"></a>                                   festate<span class="op">-&gt;</span>filename<span class="op">,</span></span>
<span id="cb456-64"><a aria-hidden="true" href="#cb456-64" tabindex="-1"></a>                                   festate<span class="op">-&gt;</span>is_program<span class="op">,</span></span>
<span id="cb456-65"><a aria-hidden="true" href="#cb456-65" tabindex="-1"></a>                                   festate<span class="op">-&gt;</span>options<span class="op">);</span></span>
<span id="cb456-66"><a aria-hidden="true" href="#cb456-66" tabindex="-1"></a></span>
<span id="cb456-67"><a aria-hidden="true" href="#cb456-67" tabindex="-1"></a>    node<span class="op">-&gt;</span>fdw_state <span class="op">=</span> festate<span class="op">;</span></span>
<span id="cb456-68"><a aria-hidden="true" href="#cb456-68" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb456-69"><a aria-hidden="true" href="#cb456-69" tabindex="-1"></a></span>
<span id="cb456-70"><a aria-hidden="true" href="#cb456-70" tabindex="-1"></a><span class="co">/* Execution: fetch next tuple */</span></span>
<span id="cb456-71"><a aria-hidden="true" href="#cb456-71" tabindex="-1"></a><span class="dt">static</span> TupleTableSlot <span class="op">*</span></span>
<span id="cb456-72"><a aria-hidden="true" href="#cb456-72" tabindex="-1"></a>fileIterateForeignScan<span class="op">(</span>ForeignScanState <span class="op">*</span>node<span class="op">)</span></span>
<span id="cb456-73"><a aria-hidden="true" href="#cb456-73" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb456-74"><a aria-hidden="true" href="#cb456-74" tabindex="-1"></a>    FileFdwExecutionState <span class="op">*</span>festate <span class="op">=</span> node<span class="op">-&gt;</span>fdw_state<span class="op">;</span></span>
<span id="cb456-75"><a aria-hidden="true" href="#cb456-75" tabindex="-1"></a>    TupleTableSlot <span class="op">*</span>slot <span class="op">=</span> node<span class="op">-&gt;</span>ss<span class="op">.</span>ss_ScanTupleSlot<span class="op">;</span></span>
<span id="cb456-76"><a aria-hidden="true" href="#cb456-76" tabindex="-1"></a>    <span class="dt">bool</span>        found<span class="op">;</span></span>
<span id="cb456-77"><a aria-hidden="true" href="#cb456-77" tabindex="-1"></a></span>
<span id="cb456-78"><a aria-hidden="true" href="#cb456-78" tabindex="-1"></a>    <span class="co">/* Read next line from file */</span></span>
<span id="cb456-79"><a aria-hidden="true" href="#cb456-79" tabindex="-1"></a>    found <span class="op">=</span> NextCopyFrom<span class="op">(</span>festate<span class="op">-&gt;</span>cstate<span class="op">,</span> NULL<span class="op">,</span></span>
<span id="cb456-80"><a aria-hidden="true" href="#cb456-80" tabindex="-1"></a>                        slot<span class="op">-&gt;</span>tts_values<span class="op">,</span> slot<span class="op">-&gt;</span>tts_isnull<span class="op">);</span></span>
<span id="cb456-81"><a aria-hidden="true" href="#cb456-81" tabindex="-1"></a></span>
<span id="cb456-82"><a aria-hidden="true" href="#cb456-82" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>found<span class="op">)</span></span>
<span id="cb456-83"><a aria-hidden="true" href="#cb456-83" tabindex="-1"></a>        ExecStoreVirtualTuple<span class="op">(</span>slot<span class="op">);</span></span>
<span id="cb456-84"><a aria-hidden="true" href="#cb456-84" tabindex="-1"></a>    <span class="cf">else</span></span>
<span id="cb456-85"><a aria-hidden="true" href="#cb456-85" tabindex="-1"></a>        ExecClearTuple<span class="op">(</span>slot<span class="op">);</span></span>
<span id="cb456-86"><a aria-hidden="true" href="#cb456-86" tabindex="-1"></a></span>
<span id="cb456-87"><a aria-hidden="true" href="#cb456-87" tabindex="-1"></a>    <span class="cf">return</span> slot<span class="op">;</span></span>
<span id="cb456-88"><a aria-hidden="true" href="#cb456-88" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>FDW Usage:</strong></p>
<div class="sourceCode" id="cb457"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb457-1"><a aria-hidden="true" href="#cb457-1" tabindex="-1"></a><span class="co">-- Create FDW and server</span></span>
<span id="cb457-2"><a aria-hidden="true" href="#cb457-2" tabindex="-1"></a><span class="kw">CREATE</span> EXTENSION file_fdw;</span>
<span id="cb457-3"><a aria-hidden="true" href="#cb457-3" tabindex="-1"></a></span>
<span id="cb457-4"><a aria-hidden="true" href="#cb457-4" tabindex="-1"></a><span class="kw">CREATE</span> SERVER files <span class="kw">FOREIGN</span> <span class="kw">DATA</span> WRAPPER file_fdw;</span>
<span id="cb457-5"><a aria-hidden="true" href="#cb457-5" tabindex="-1"></a></span>
<span id="cb457-6"><a aria-hidden="true" href="#cb457-6" tabindex="-1"></a><span class="co">-- Create foreign table</span></span>
<span id="cb457-7"><a aria-hidden="true" href="#cb457-7" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">FOREIGN</span> <span class="kw">TABLE</span> sales_data (</span>
<span id="cb457-8"><a aria-hidden="true" href="#cb457-8" tabindex="-1"></a>    <span class="dt">date</span>        <span class="dt">date</span>,</span>
<span id="cb457-9"><a aria-hidden="true" href="#cb457-9" tabindex="-1"></a>    product_id  <span class="dt">int</span>,</span>
<span id="cb457-10"><a aria-hidden="true" href="#cb457-10" tabindex="-1"></a>    quantity    <span class="dt">int</span>,</span>
<span id="cb457-11"><a aria-hidden="true" href="#cb457-11" tabindex="-1"></a>    price       <span class="dt">numeric</span>(<span class="dv">10</span>,<span class="dv">2</span>)</span>
<span id="cb457-12"><a aria-hidden="true" href="#cb457-12" tabindex="-1"></a>) SERVER files</span>
<span id="cb457-13"><a aria-hidden="true" href="#cb457-13" tabindex="-1"></a>OPTIONS (filename <span class="st">'/data/sales.csv'</span>, format <span class="st">'csv'</span>, <span class="kw">header</span> <span class="st">'true'</span>);</span>
<span id="cb457-14"><a aria-hidden="true" href="#cb457-14" tabindex="-1"></a></span>
<span id="cb457-15"><a aria-hidden="true" href="#cb457-15" tabindex="-1"></a><span class="co">-- Query foreign table</span></span>
<span id="cb457-16"><a aria-hidden="true" href="#cb457-16" tabindex="-1"></a><span class="kw">SELECT</span> product_id, <span class="fu">sum</span>(quantity <span class="op">*</span> price) <span class="kw">AS</span> revenue</span>
<span id="cb457-17"><a aria-hidden="true" href="#cb457-17" tabindex="-1"></a><span class="kw">FROM</span> sales_data</span>
<span id="cb457-18"><a aria-hidden="true" href="#cb457-18" tabindex="-1"></a><span class="kw">WHERE</span> <span class="dt">date</span> <span class="op">&gt;=</span> <span class="st">'2024-01-01'</span></span>
<span id="cb457-19"><a aria-hidden="true" href="#cb457-19" tabindex="-1"></a><span class="kw">GROUP</span> <span class="kw">BY</span> product_id;</span></code></pre></div>
<h2 data-number="8.6" id="custom-operators-and-index-access-methods"><span class="header-section-number">8.6</span> Custom Operators and Index
Access Methods</h2>
<p>Extensions can define custom operators and index access methods to
support new data types and query patterns.</p>
<h3 data-number="8.6.1" id="custom-operators"><span class="header-section-number">8.6.1</span> Custom Operators</h3>
<p>Operators are defined by linking SQL operators to C functions:</p>
<div class="sourceCode" id="cb458"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb458-1"><a aria-hidden="true" href="#cb458-1" tabindex="-1"></a><span class="co">-- Define operator function</span></span>
<span id="cb458-2"><a aria-hidden="true" href="#cb458-2" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">FUNCTION</span> hstore_contains(hstore, hstore)</span>
<span id="cb458-3"><a aria-hidden="true" href="#cb458-3" tabindex="-1"></a>RETURNS <span class="dt">boolean</span></span>
<span id="cb458-4"><a aria-hidden="true" href="#cb458-4" tabindex="-1"></a><span class="kw">AS</span> <span class="st">'MODULE_PATHNAME'</span>, <span class="st">'hstore_contains'</span></span>
<span id="cb458-5"><a aria-hidden="true" href="#cb458-5" tabindex="-1"></a>LANGUAGE C STRICT IMMUTABLE;</span>
<span id="cb458-6"><a aria-hidden="true" href="#cb458-6" tabindex="-1"></a></span>
<span id="cb458-7"><a aria-hidden="true" href="#cb458-7" tabindex="-1"></a><span class="co">-- Define operator</span></span>
<span id="cb458-8"><a aria-hidden="true" href="#cb458-8" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">OPERATOR</span> @<span class="op">&gt;</span> (</span>
<span id="cb458-9"><a aria-hidden="true" href="#cb458-9" tabindex="-1"></a>    LEFTARG <span class="op">=</span> hstore,</span>
<span id="cb458-10"><a aria-hidden="true" href="#cb458-10" tabindex="-1"></a>    RIGHTARG <span class="op">=</span> hstore,</span>
<span id="cb458-11"><a aria-hidden="true" href="#cb458-11" tabindex="-1"></a>    <span class="kw">PROCEDURE</span> <span class="op">=</span> hstore_contains,</span>
<span id="cb458-12"><a aria-hidden="true" href="#cb458-12" tabindex="-1"></a>    COMMUTATOR <span class="op">=</span> <span class="st">'&lt;@'</span>,</span>
<span id="cb458-13"><a aria-hidden="true" href="#cb458-13" tabindex="-1"></a>    <span class="kw">RESTRICT</span> <span class="op">=</span> contsel,</span>
<span id="cb458-14"><a aria-hidden="true" href="#cb458-14" tabindex="-1"></a>    <span class="kw">JOIN</span> <span class="op">=</span> contjoinsel</span>
<span id="cb458-15"><a aria-hidden="true" href="#cb458-15" tabindex="-1"></a>);</span>
<span id="cb458-16"><a aria-hidden="true" href="#cb458-16" tabindex="-1"></a></span>
<span id="cb458-17"><a aria-hidden="true" href="#cb458-17" tabindex="-1"></a><span class="co">-- Create operator class for indexing</span></span>
<span id="cb458-18"><a aria-hidden="true" href="#cb458-18" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">OPERATOR</span> <span class="kw">CLASS</span> hstore_ops</span>
<span id="cb458-19"><a aria-hidden="true" href="#cb458-19" tabindex="-1"></a><span class="kw">DEFAULT</span> <span class="cf">FOR</span> <span class="kw">TYPE</span> hstore <span class="kw">USING</span> gist <span class="kw">AS</span></span>
<span id="cb458-20"><a aria-hidden="true" href="#cb458-20" tabindex="-1"></a>    <span class="kw">OPERATOR</span> <span class="dv">1</span>  @<span class="op">&gt;</span>,</span>
<span id="cb458-21"><a aria-hidden="true" href="#cb458-21" tabindex="-1"></a>    <span class="kw">OPERATOR</span> <span class="dv">2</span>  <span class="op">&lt;</span>@,</span>
<span id="cb458-22"><a aria-hidden="true" href="#cb458-22" tabindex="-1"></a>    <span class="kw">OPERATOR</span> <span class="dv">3</span>  <span class="op">=</span>,</span>
<span id="cb458-23"><a aria-hidden="true" href="#cb458-23" tabindex="-1"></a>    <span class="kw">FUNCTION</span> <span class="dv">1</span>  hstore_consistent(internal, hstore, int4, <span class="kw">oid</span>, internal),</span>
<span id="cb458-24"><a aria-hidden="true" href="#cb458-24" tabindex="-1"></a>    <span class="kw">FUNCTION</span> <span class="dv">2</span>  hstore_union(internal, internal),</span>
<span id="cb458-25"><a aria-hidden="true" href="#cb458-25" tabindex="-1"></a>    <span class="kw">FUNCTION</span> <span class="dv">3</span>  hstore_compress(internal),</span>
<span id="cb458-26"><a aria-hidden="true" href="#cb458-26" tabindex="-1"></a>    <span class="kw">FUNCTION</span> <span class="dv">4</span>  hstore_decompress(internal),</span>
<span id="cb458-27"><a aria-hidden="true" href="#cb458-27" tabindex="-1"></a>    <span class="kw">FUNCTION</span> <span class="dv">5</span>  hstore_penalty(internal, internal, internal);</span></code></pre></div>
<p>The <code>RESTRICT</code> and <code>JOIN</code> clauses specify
selectivity estimation functions, enabling the planner to cost queries
using the operator.</p>
<h3 data-number="8.6.2" id="index-access-method-api"><span class="header-section-number">8.6.2</span> Index Access Method API</h3>
<p>Custom index access methods implement the <code>IndexAmRoutine</code>
interface:</p>
<div class="sourceCode" id="cb459"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb459-1"><a aria-hidden="true" href="#cb459-1" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> IndexAmRoutine</span>
<span id="cb459-2"><a aria-hidden="true" href="#cb459-2" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb459-3"><a aria-hidden="true" href="#cb459-3" tabindex="-1"></a>    NodeTag     type<span class="op">;</span></span>
<span id="cb459-4"><a aria-hidden="true" href="#cb459-4" tabindex="-1"></a></span>
<span id="cb459-5"><a aria-hidden="true" href="#cb459-5" tabindex="-1"></a>    <span class="co">/* AM properties */</span></span>
<span id="cb459-6"><a aria-hidden="true" href="#cb459-6" tabindex="-1"></a>    uint16      amstrategies<span class="op">;</span>       <span class="co">/* Number of operator strategies */</span></span>
<span id="cb459-7"><a aria-hidden="true" href="#cb459-7" tabindex="-1"></a>    uint16      amsupport<span class="op">;</span>          <span class="co">/* Number of support functions */</span></span>
<span id="cb459-8"><a aria-hidden="true" href="#cb459-8" tabindex="-1"></a>    uint16      amoptsprocnum<span class="op">;</span>      <span class="co">/* Options support function number */</span></span>
<span id="cb459-9"><a aria-hidden="true" href="#cb459-9" tabindex="-1"></a>    <span class="dt">bool</span>        amcanorder<span class="op">;</span>         <span class="co">/* Can return ordered results? */</span></span>
<span id="cb459-10"><a aria-hidden="true" href="#cb459-10" tabindex="-1"></a>    <span class="dt">bool</span>        amcanorderbyop<span class="op">;</span>     <span class="co">/* Can order by operator result? */</span></span>
<span id="cb459-11"><a aria-hidden="true" href="#cb459-11" tabindex="-1"></a>    <span class="dt">bool</span>        amcanbackward<span class="op">;</span>      <span class="co">/* Supports backward scanning? */</span></span>
<span id="cb459-12"><a aria-hidden="true" href="#cb459-12" tabindex="-1"></a>    <span class="dt">bool</span>        amcanunique<span class="op">;</span>        <span class="co">/* Supports unique indexes? */</span></span>
<span id="cb459-13"><a aria-hidden="true" href="#cb459-13" tabindex="-1"></a>    <span class="dt">bool</span>        amcanmulticol<span class="op">;</span>      <span class="co">/* Supports multi-column indexes? */</span></span>
<span id="cb459-14"><a aria-hidden="true" href="#cb459-14" tabindex="-1"></a>    <span class="dt">bool</span>        amoptionalkey<span class="op">;</span>      <span class="co">/* Optional first column constraint? */</span></span>
<span id="cb459-15"><a aria-hidden="true" href="#cb459-15" tabindex="-1"></a>    <span class="dt">bool</span>        amsearcharray<span class="op">;</span>      <span class="co">/* Handles ScalarArrayOpExpr? */</span></span>
<span id="cb459-16"><a aria-hidden="true" href="#cb459-16" tabindex="-1"></a>    <span class="dt">bool</span>        amsearchnulls<span class="op">;</span>      <span class="co">/* Handles IS NULL/IS NOT NULL? */</span></span>
<span id="cb459-17"><a aria-hidden="true" href="#cb459-17" tabindex="-1"></a>    <span class="dt">bool</span>        amclusterable<span class="op">;</span>      <span class="co">/* Can table be clustered on index? */</span></span>
<span id="cb459-18"><a aria-hidden="true" href="#cb459-18" tabindex="-1"></a>    <span class="dt">bool</span>        amcanparallel<span class="op">;</span>      <span class="co">/* Supports parallel scan? */</span></span>
<span id="cb459-19"><a aria-hidden="true" href="#cb459-19" tabindex="-1"></a>    Oid         amkeytype<span class="op">;</span>          <span class="co">/* Index key data type (or InvalidOid) */</span></span>
<span id="cb459-20"><a aria-hidden="true" href="#cb459-20" tabindex="-1"></a></span>
<span id="cb459-21"><a aria-hidden="true" href="#cb459-21" tabindex="-1"></a>    <span class="co">/* Interface functions */</span></span>
<span id="cb459-22"><a aria-hidden="true" href="#cb459-22" tabindex="-1"></a>    ambuild_function ambuild<span class="op">;</span></span>
<span id="cb459-23"><a aria-hidden="true" href="#cb459-23" tabindex="-1"></a>    ambuildempty_function ambuildempty<span class="op">;</span></span>
<span id="cb459-24"><a aria-hidden="true" href="#cb459-24" tabindex="-1"></a>    aminsert_function aminsert<span class="op">;</span></span>
<span id="cb459-25"><a aria-hidden="true" href="#cb459-25" tabindex="-1"></a>    ambulkdelete_function ambulkdelete<span class="op">;</span></span>
<span id="cb459-26"><a aria-hidden="true" href="#cb459-26" tabindex="-1"></a>    amvacuumcleanup_function amvacuumcleanup<span class="op">;</span></span>
<span id="cb459-27"><a aria-hidden="true" href="#cb459-27" tabindex="-1"></a>    amcostestimate_function amcostestimate<span class="op">;</span></span>
<span id="cb459-28"><a aria-hidden="true" href="#cb459-28" tabindex="-1"></a>    amoptions_function amoptions<span class="op">;</span></span>
<span id="cb459-29"><a aria-hidden="true" href="#cb459-29" tabindex="-1"></a>    amvalidate_function amvalidate<span class="op">;</span></span>
<span id="cb459-30"><a aria-hidden="true" href="#cb459-30" tabindex="-1"></a>    ambeginscan_function ambeginscan<span class="op">;</span></span>
<span id="cb459-31"><a aria-hidden="true" href="#cb459-31" tabindex="-1"></a>    amrescan_function amrescan<span class="op">;</span></span>
<span id="cb459-32"><a aria-hidden="true" href="#cb459-32" tabindex="-1"></a>    amgettuple_function amgettuple<span class="op">;</span></span>
<span id="cb459-33"><a aria-hidden="true" href="#cb459-33" tabindex="-1"></a>    amgetbitmap_function amgetbitmap<span class="op">;</span></span>
<span id="cb459-34"><a aria-hidden="true" href="#cb459-34" tabindex="-1"></a>    amendscan_function amendscan<span class="op">;</span></span>
<span id="cb459-35"><a aria-hidden="true" href="#cb459-35" tabindex="-1"></a></span>
<span id="cb459-36"><a aria-hidden="true" href="#cb459-36" tabindex="-1"></a>    <span class="co">/* Optional functions */</span></span>
<span id="cb459-37"><a aria-hidden="true" href="#cb459-37" tabindex="-1"></a>    ammarkpos_function ammarkpos<span class="op">;</span></span>
<span id="cb459-38"><a aria-hidden="true" href="#cb459-38" tabindex="-1"></a>    amrestrpos_function amrestrpos<span class="op">;</span></span>
<span id="cb459-39"><a aria-hidden="true" href="#cb459-39" tabindex="-1"></a>    amestimateparallelscan_function amestimateparallelscan<span class="op">;</span></span>
<span id="cb459-40"><a aria-hidden="true" href="#cb459-40" tabindex="-1"></a>    aminitparallelscan_function aminitparallelscan<span class="op">;</span></span>
<span id="cb459-41"><a aria-hidden="true" href="#cb459-41" tabindex="-1"></a><span class="op">}</span> IndexAmRoutine<span class="op">;</span></span></code></pre></div>
<h3 data-number="8.6.3" id="bloom-filter-index-example"><span class="header-section-number">8.6.3</span> Bloom Filter Index
Example</h3>
<p>The <code>bloom</code> extension implements probabilistic
indexing:</p>
<div class="sourceCode" id="cb460"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb460-1"><a aria-hidden="true" href="#cb460-1" tabindex="-1"></a>Datum</span>
<span id="cb460-2"><a aria-hidden="true" href="#cb460-2" tabindex="-1"></a>blhandler<span class="op">(</span>PG_FUNCTION_ARGS<span class="op">)</span></span>
<span id="cb460-3"><a aria-hidden="true" href="#cb460-3" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb460-4"><a aria-hidden="true" href="#cb460-4" tabindex="-1"></a>    IndexAmRoutine <span class="op">*</span>amroutine <span class="op">=</span> makeNode<span class="op">(</span>IndexAmRoutine<span class="op">);</span></span>
<span id="cb460-5"><a aria-hidden="true" href="#cb460-5" tabindex="-1"></a></span>
<span id="cb460-6"><a aria-hidden="true" href="#cb460-6" tabindex="-1"></a>    <span class="co">/* Set AM properties */</span></span>
<span id="cb460-7"><a aria-hidden="true" href="#cb460-7" tabindex="-1"></a>    amroutine<span class="op">-&gt;</span>amstrategies <span class="op">=</span> BLOOM_NSTRATEGIES<span class="op">;</span></span>
<span id="cb460-8"><a aria-hidden="true" href="#cb460-8" tabindex="-1"></a>    amroutine<span class="op">-&gt;</span>amsupport <span class="op">=</span> BLOOM_NPROC<span class="op">;</span></span>
<span id="cb460-9"><a aria-hidden="true" href="#cb460-9" tabindex="-1"></a>    amroutine<span class="op">-&gt;</span>amcanorder <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb460-10"><a aria-hidden="true" href="#cb460-10" tabindex="-1"></a>    amroutine<span class="op">-&gt;</span>amcanunique <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb460-11"><a aria-hidden="true" href="#cb460-11" tabindex="-1"></a>    amroutine<span class="op">-&gt;</span>amcanmulticol <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb460-12"><a aria-hidden="true" href="#cb460-12" tabindex="-1"></a>    amroutine<span class="op">-&gt;</span>amoptionalkey <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb460-13"><a aria-hidden="true" href="#cb460-13" tabindex="-1"></a>    amroutine<span class="op">-&gt;</span>amsearcharray <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb460-14"><a aria-hidden="true" href="#cb460-14" tabindex="-1"></a>    amroutine<span class="op">-&gt;</span>amsearchnulls <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb460-15"><a aria-hidden="true" href="#cb460-15" tabindex="-1"></a>    amroutine<span class="op">-&gt;</span>amclusterable <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb460-16"><a aria-hidden="true" href="#cb460-16" tabindex="-1"></a>    amroutine<span class="op">-&gt;</span>amcanparallel <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb460-17"><a aria-hidden="true" href="#cb460-17" tabindex="-1"></a></span>
<span id="cb460-18"><a aria-hidden="true" href="#cb460-18" tabindex="-1"></a>    <span class="co">/* Set interface functions */</span></span>
<span id="cb460-19"><a aria-hidden="true" href="#cb460-19" tabindex="-1"></a>    amroutine<span class="op">-&gt;</span>ambuild <span class="op">=</span> blbuild<span class="op">;</span></span>
<span id="cb460-20"><a aria-hidden="true" href="#cb460-20" tabindex="-1"></a>    amroutine<span class="op">-&gt;</span>ambuildempty <span class="op">=</span> blbuildempty<span class="op">;</span></span>
<span id="cb460-21"><a aria-hidden="true" href="#cb460-21" tabindex="-1"></a>    amroutine<span class="op">-&gt;</span>aminsert <span class="op">=</span> blinsert<span class="op">;</span></span>
<span id="cb460-22"><a aria-hidden="true" href="#cb460-22" tabindex="-1"></a>    amroutine<span class="op">-&gt;</span>ambulkdelete <span class="op">=</span> blbulkdelete<span class="op">;</span></span>
<span id="cb460-23"><a aria-hidden="true" href="#cb460-23" tabindex="-1"></a>    amroutine<span class="op">-&gt;</span>amvacuumcleanup <span class="op">=</span> blvacuumcleanup<span class="op">;</span></span>
<span id="cb460-24"><a aria-hidden="true" href="#cb460-24" tabindex="-1"></a>    amroutine<span class="op">-&gt;</span>amcostestimate <span class="op">=</span> blcostestimate<span class="op">;</span></span>
<span id="cb460-25"><a aria-hidden="true" href="#cb460-25" tabindex="-1"></a>    amroutine<span class="op">-&gt;</span>amoptions <span class="op">=</span> bloptions<span class="op">;</span></span>
<span id="cb460-26"><a aria-hidden="true" href="#cb460-26" tabindex="-1"></a>    amroutine<span class="op">-&gt;</span>amvalidate <span class="op">=</span> blvalidate<span class="op">;</span></span>
<span id="cb460-27"><a aria-hidden="true" href="#cb460-27" tabindex="-1"></a>    amroutine<span class="op">-&gt;</span>ambeginscan <span class="op">=</span> blbeginscan<span class="op">;</span></span>
<span id="cb460-28"><a aria-hidden="true" href="#cb460-28" tabindex="-1"></a>    amroutine<span class="op">-&gt;</span>amrescan <span class="op">=</span> blrescan<span class="op">;</span></span>
<span id="cb460-29"><a aria-hidden="true" href="#cb460-29" tabindex="-1"></a>    amroutine<span class="op">-&gt;</span>amgettuple <span class="op">=</span> NULL<span class="op">;</span>       <span class="co">/* Bitmap scan only */</span></span>
<span id="cb460-30"><a aria-hidden="true" href="#cb460-30" tabindex="-1"></a>    amroutine<span class="op">-&gt;</span>amgetbitmap <span class="op">=</span> blgetbitmap<span class="op">;</span></span>
<span id="cb460-31"><a aria-hidden="true" href="#cb460-31" tabindex="-1"></a>    amroutine<span class="op">-&gt;</span>amendscan <span class="op">=</span> blendscan<span class="op">;</span></span>
<span id="cb460-32"><a aria-hidden="true" href="#cb460-32" tabindex="-1"></a></span>
<span id="cb460-33"><a aria-hidden="true" href="#cb460-33" tabindex="-1"></a>    PG_RETURN_POINTER<span class="op">(</span>amroutine<span class="op">);</span></span>
<span id="cb460-34"><a aria-hidden="true" href="#cb460-34" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb460-35"><a aria-hidden="true" href="#cb460-35" tabindex="-1"></a></span>
<span id="cb460-36"><a aria-hidden="true" href="#cb460-36" tabindex="-1"></a><span class="co">/* Module initialization */</span></span>
<span id="cb460-37"><a aria-hidden="true" href="#cb460-37" tabindex="-1"></a><span class="dt">void</span></span>
<span id="cb460-38"><a aria-hidden="true" href="#cb460-38" tabindex="-1"></a>_PG_init<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb460-39"><a aria-hidden="true" href="#cb460-39" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb460-40"><a aria-hidden="true" href="#cb460-40" tabindex="-1"></a>    bl_relopt_kind <span class="op">=</span> add_reloption_kind<span class="op">();</span></span>
<span id="cb460-41"><a aria-hidden="true" href="#cb460-41" tabindex="-1"></a></span>
<span id="cb460-42"><a aria-hidden="true" href="#cb460-42" tabindex="-1"></a>    <span class="co">/* Define index options */</span></span>
<span id="cb460-43"><a aria-hidden="true" href="#cb460-43" tabindex="-1"></a>    add_int_reloption<span class="op">(</span>bl_relopt_kind<span class="op">,</span> <span class="st">"length"</span><span class="op">,</span></span>
<span id="cb460-44"><a aria-hidden="true" href="#cb460-44" tabindex="-1"></a>                     <span class="st">"Length of signature in bits"</span><span class="op">,</span></span>
<span id="cb460-45"><a aria-hidden="true" href="#cb460-45" tabindex="-1"></a>                     DEFAULT_BLOOM_LENGTH<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> MAX_BLOOM_LENGTH<span class="op">,</span></span>
<span id="cb460-46"><a aria-hidden="true" href="#cb460-46" tabindex="-1"></a>                     AccessExclusiveLock<span class="op">);</span></span>
<span id="cb460-47"><a aria-hidden="true" href="#cb460-47" tabindex="-1"></a></span>
<span id="cb460-48"><a aria-hidden="true" href="#cb460-48" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span>i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> INDEX_MAX_KEYS<span class="op">;</span> i<span class="op">++)</span></span>
<span id="cb460-49"><a aria-hidden="true" href="#cb460-49" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb460-50"><a aria-hidden="true" href="#cb460-50" tabindex="-1"></a>        snprintf<span class="op">(</span>buf<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>buf<span class="op">),</span> <span class="st">"col</span><span class="sc">%d</span><span class="st">"</span><span class="op">,</span> i <span class="op">+</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb460-51"><a aria-hidden="true" href="#cb460-51" tabindex="-1"></a>        add_int_reloption<span class="op">(</span>bl_relopt_kind<span class="op">,</span> buf<span class="op">,</span></span>
<span id="cb460-52"><a aria-hidden="true" href="#cb460-52" tabindex="-1"></a>                         <span class="st">"Number of bits for index column"</span><span class="op">,</span></span>
<span id="cb460-53"><a aria-hidden="true" href="#cb460-53" tabindex="-1"></a>                         DEFAULT_BLOOM_BITS<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> MAX_BLOOM_BITS<span class="op">,</span></span>
<span id="cb460-54"><a aria-hidden="true" href="#cb460-54" tabindex="-1"></a>                         AccessExclusiveLock<span class="op">);</span></span>
<span id="cb460-55"><a aria-hidden="true" href="#cb460-55" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb460-56"><a aria-hidden="true" href="#cb460-56" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>Bloom Index Usage:</strong></p>
<div class="sourceCode" id="cb461"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb461-1"><a aria-hidden="true" href="#cb461-1" tabindex="-1"></a><span class="kw">CREATE</span> EXTENSION bloom;</span>
<span id="cb461-2"><a aria-hidden="true" href="#cb461-2" tabindex="-1"></a></span>
<span id="cb461-3"><a aria-hidden="true" href="#cb461-3" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_multi <span class="kw">ON</span> <span class="kw">table</span> <span class="kw">USING</span> bloom (col1, col2, col3)</span>
<span id="cb461-4"><a aria-hidden="true" href="#cb461-4" tabindex="-1"></a>    <span class="kw">WITH</span> (<span class="fu">length</span><span class="op">=</span><span class="dv">80</span>, col1<span class="op">=</span><span class="dv">2</span>, col2<span class="op">=</span><span class="dv">2</span>, col3<span class="op">=</span><span class="dv">4</span>);</span></code></pre></div>
<h2 data-number="8.7" id="postgresql-hooks-system"><span class="header-section-number">8.7</span> PostgreSQL Hooks System</h2>
<p>PostgreSQL provides over 50 extension points (hooks) enabling
extensions to intercept and modify core behavior without patching the
source code. Hooks follow a consistent pattern: global function pointers
that extensions can set to their own implementations.</p>
<h3 data-number="8.7.1" id="hook-architecture-pattern"><span class="header-section-number">8.7.1</span> Hook Architecture
Pattern</h3>
<div class="sourceCode" id="cb462"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb462-1"><a aria-hidden="true" href="#cb462-1" tabindex="-1"></a><span class="co">/* Hook type definition */</span></span>
<span id="cb462-2"><a aria-hidden="true" href="#cb462-2" tabindex="-1"></a><span class="kw">typedef</span> <span class="dt">void</span> <span class="op">(*</span>ExecutorStart_hook_type<span class="op">)</span> <span class="op">(</span>QueryDesc <span class="op">*</span>queryDesc<span class="op">,</span> <span class="dt">int</span> eflags<span class="op">);</span></span>
<span id="cb462-3"><a aria-hidden="true" href="#cb462-3" tabindex="-1"></a></span>
<span id="cb462-4"><a aria-hidden="true" href="#cb462-4" tabindex="-1"></a><span class="co">/* Hook variable (initialized to NULL) */</span></span>
<span id="cb462-5"><a aria-hidden="true" href="#cb462-5" tabindex="-1"></a><span class="kw">extern</span> PGDLLIMPORT ExecutorStart_hook_type ExecutorStart_hook<span class="op">;</span></span>
<span id="cb462-6"><a aria-hidden="true" href="#cb462-6" tabindex="-1"></a></span>
<span id="cb462-7"><a aria-hidden="true" href="#cb462-7" tabindex="-1"></a><span class="co">/* Core code checks and calls hook */</span></span>
<span id="cb462-8"><a aria-hidden="true" href="#cb462-8" tabindex="-1"></a><span class="dt">void</span></span>
<span id="cb462-9"><a aria-hidden="true" href="#cb462-9" tabindex="-1"></a>standard_ExecutorStart<span class="op">(</span>QueryDesc <span class="op">*</span>queryDesc<span class="op">,</span> <span class="dt">int</span> eflags<span class="op">)</span></span>
<span id="cb462-10"><a aria-hidden="true" href="#cb462-10" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb462-11"><a aria-hidden="true" href="#cb462-11" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>ExecutorStart_hook<span class="op">)</span></span>
<span id="cb462-12"><a aria-hidden="true" href="#cb462-12" tabindex="-1"></a>        <span class="op">(*</span>ExecutorStart_hook<span class="op">)</span> <span class="op">(</span>queryDesc<span class="op">,</span> eflags<span class="op">);</span></span>
<span id="cb462-13"><a aria-hidden="true" href="#cb462-13" tabindex="-1"></a>    <span class="cf">else</span></span>
<span id="cb462-14"><a aria-hidden="true" href="#cb462-14" tabindex="-1"></a>        standard_ExecutorStart_internal<span class="op">(</span>queryDesc<span class="op">,</span> eflags<span class="op">);</span></span>
<span id="cb462-15"><a aria-hidden="true" href="#cb462-15" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 data-number="8.7.2" id="hook-categories"><span class="header-section-number">8.7.2</span> Hook Categories</h3>
<p><strong>1. Query Planning and Execution Hooks:</strong></p>
<div class="sourceCode" id="cb463"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb463-1"><a aria-hidden="true" href="#cb463-1" tabindex="-1"></a><span class="co">/* Planner hooks */</span></span>
<span id="cb463-2"><a aria-hidden="true" href="#cb463-2" tabindex="-1"></a><span class="kw">extern</span> PGDLLIMPORT planner_hook_type planner_hook<span class="op">;</span></span>
<span id="cb463-3"><a aria-hidden="true" href="#cb463-3" tabindex="-1"></a><span class="kw">extern</span> PGDLLIMPORT planner_setup_hook_type planner_setup_hook<span class="op">;</span></span>
<span id="cb463-4"><a aria-hidden="true" href="#cb463-4" tabindex="-1"></a><span class="kw">extern</span> PGDLLIMPORT planner_shutdown_hook_type planner_shutdown_hook<span class="op">;</span></span>
<span id="cb463-5"><a aria-hidden="true" href="#cb463-5" tabindex="-1"></a><span class="kw">extern</span> PGDLLIMPORT create_upper_paths_hook_type create_upper_paths_hook<span class="op">;</span></span>
<span id="cb463-6"><a aria-hidden="true" href="#cb463-6" tabindex="-1"></a><span class="kw">extern</span> PGDLLIMPORT set_rel_pathlist_hook_type set_rel_pathlist_hook<span class="op">;</span></span>
<span id="cb463-7"><a aria-hidden="true" href="#cb463-7" tabindex="-1"></a><span class="kw">extern</span> PGDLLIMPORT set_join_pathlist_hook_type set_join_pathlist_hook<span class="op">;</span></span>
<span id="cb463-8"><a aria-hidden="true" href="#cb463-8" tabindex="-1"></a><span class="kw">extern</span> PGDLLIMPORT join_search_hook_type join_search_hook<span class="op">;</span></span>
<span id="cb463-9"><a aria-hidden="true" href="#cb463-9" tabindex="-1"></a></span>
<span id="cb463-10"><a aria-hidden="true" href="#cb463-10" tabindex="-1"></a><span class="co">/* Executor hooks */</span></span>
<span id="cb463-11"><a aria-hidden="true" href="#cb463-11" tabindex="-1"></a><span class="kw">extern</span> PGDLLIMPORT ExecutorStart_hook_type ExecutorStart_hook<span class="op">;</span></span>
<span id="cb463-12"><a aria-hidden="true" href="#cb463-12" tabindex="-1"></a><span class="kw">extern</span> PGDLLIMPORT ExecutorRun_hook_type ExecutorRun_hook<span class="op">;</span></span>
<span id="cb463-13"><a aria-hidden="true" href="#cb463-13" tabindex="-1"></a><span class="kw">extern</span> PGDLLIMPORT ExecutorFinish_hook_type ExecutorFinish_hook<span class="op">;</span></span>
<span id="cb463-14"><a aria-hidden="true" href="#cb463-14" tabindex="-1"></a><span class="kw">extern</span> PGDLLIMPORT ExecutorEnd_hook_type ExecutorEnd_hook<span class="op">;</span></span>
<span id="cb463-15"><a aria-hidden="true" href="#cb463-15" tabindex="-1"></a><span class="kw">extern</span> PGDLLIMPORT ExecutorCheckPerms_hook_type ExecutorCheckPerms_hook<span class="op">;</span></span></code></pre></div>
<p><strong>2. Utility Command Hooks:</strong></p>
<div class="sourceCode" id="cb464"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb464-1"><a aria-hidden="true" href="#cb464-1" tabindex="-1"></a><span class="kw">extern</span> PGDLLIMPORT ProcessUtility_hook_type ProcessUtility_hook<span class="op">;</span></span>
<span id="cb464-2"><a aria-hidden="true" href="#cb464-2" tabindex="-1"></a><span class="kw">extern</span> PGDLLIMPORT post_parse_analyze_hook_type post_parse_analyze_hook<span class="op">;</span></span></code></pre></div>
<p><strong>3. Explain Hooks:</strong></p>
<div class="sourceCode" id="cb465"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb465-1"><a aria-hidden="true" href="#cb465-1" tabindex="-1"></a><span class="kw">extern</span> PGDLLIMPORT ExplainOneQuery_hook_type ExplainOneQuery_hook<span class="op">;</span></span>
<span id="cb465-2"><a aria-hidden="true" href="#cb465-2" tabindex="-1"></a><span class="kw">extern</span> PGDLLIMPORT explain_per_plan_hook_type explain_per_plan_hook<span class="op">;</span></span>
<span id="cb465-3"><a aria-hidden="true" href="#cb465-3" tabindex="-1"></a><span class="kw">extern</span> PGDLLIMPORT explain_per_node_hook_type explain_per_node_hook<span class="op">;</span></span>
<span id="cb465-4"><a aria-hidden="true" href="#cb465-4" tabindex="-1"></a><span class="kw">extern</span> PGDLLIMPORT explain_get_index_name_hook_type explain_get_index_name_hook<span class="op">;</span></span>
<span id="cb465-5"><a aria-hidden="true" href="#cb465-5" tabindex="-1"></a><span class="kw">extern</span> PGDLLIMPORT explain_validate_options_hook_type explain_validate_options_hook<span class="op">;</span></span></code></pre></div>
<p><strong>4. Optimizer Statistic Hooks:</strong></p>
<div class="sourceCode" id="cb466"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb466-1"><a aria-hidden="true" href="#cb466-1" tabindex="-1"></a><span class="kw">extern</span> PGDLLIMPORT get_relation_stats_hook_type get_relation_stats_hook<span class="op">;</span></span>
<span id="cb466-2"><a aria-hidden="true" href="#cb466-2" tabindex="-1"></a><span class="kw">extern</span> PGDLLIMPORT get_index_stats_hook_type get_index_stats_hook<span class="op">;</span></span>
<span id="cb466-3"><a aria-hidden="true" href="#cb466-3" tabindex="-1"></a><span class="kw">extern</span> PGDLLIMPORT get_relation_info_hook_type get_relation_info_hook<span class="op">;</span></span>
<span id="cb466-4"><a aria-hidden="true" href="#cb466-4" tabindex="-1"></a><span class="kw">extern</span> PGDLLIMPORT get_attavgwidth_hook_type get_attavgwidth_hook<span class="op">;</span></span></code></pre></div>
<p><strong>5. Authentication and Security Hooks:</strong></p>
<div class="sourceCode" id="cb467"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb467-1"><a aria-hidden="true" href="#cb467-1" tabindex="-1"></a><span class="kw">extern</span> PGDLLIMPORT ClientAuthentication_hook_type ClientAuthentication_hook<span class="op">;</span></span>
<span id="cb467-2"><a aria-hidden="true" href="#cb467-2" tabindex="-1"></a><span class="kw">extern</span> PGDLLIMPORT auth_password_hook_type ldap_password_hook<span class="op">;</span></span>
<span id="cb467-3"><a aria-hidden="true" href="#cb467-3" tabindex="-1"></a><span class="kw">extern</span> PGDLLIMPORT check_password_hook_type check_password_hook<span class="op">;</span></span></code></pre></div>
<p><strong>6. Object Access Hooks:</strong></p>
<div class="sourceCode" id="cb468"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb468-1"><a aria-hidden="true" href="#cb468-1" tabindex="-1"></a><span class="kw">extern</span> PGDLLIMPORT object_access_hook_type object_access_hook<span class="op">;</span></span>
<span id="cb468-2"><a aria-hidden="true" href="#cb468-2" tabindex="-1"></a><span class="kw">extern</span> PGDLLIMPORT object_access_hook_type_str object_access_hook_str<span class="op">;</span></span></code></pre></div>
<p><strong>7. Memory Management Hooks:</strong></p>
<div class="sourceCode" id="cb469"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb469-1"><a aria-hidden="true" href="#cb469-1" tabindex="-1"></a><span class="kw">extern</span> PGDLLIMPORT shmem_request_hook_type shmem_request_hook<span class="op">;</span></span>
<span id="cb469-2"><a aria-hidden="true" href="#cb469-2" tabindex="-1"></a><span class="kw">extern</span> PGDLLIMPORT shmem_startup_hook_type shmem_startup_hook<span class="op">;</span></span></code></pre></div>
<p><strong>8. Logging Hooks:</strong></p>
<div class="sourceCode" id="cb470"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb470-1"><a aria-hidden="true" href="#cb470-1" tabindex="-1"></a><span class="kw">extern</span> PGDLLIMPORT emit_log_hook_type emit_log_hook<span class="op">;</span></span></code></pre></div>
<p><strong>9. Row Security Hooks:</strong></p>
<div class="sourceCode" id="cb471"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb471-1"><a aria-hidden="true" href="#cb471-1" tabindex="-1"></a><span class="kw">extern</span> PGDLLIMPORT row_security_policy_hook_type row_security_policy_hook_permissive<span class="op">;</span></span>
<span id="cb471-2"><a aria-hidden="true" href="#cb471-2" tabindex="-1"></a><span class="kw">extern</span> PGDLLIMPORT row_security_policy_hook_type row_security_policy_hook_restrictive<span class="op">;</span></span></code></pre></div>
<h3 data-number="8.7.3" id="hook-implementation-example-auto_explain"><span class="header-section-number">8.7.3</span> Hook Implementation Example:
auto_explain</h3>
<p>The <code>auto_explain</code> extension demonstrates hook usage for
automatic query plan logging:</p>
<div class="sourceCode" id="cb472"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb472-1"><a aria-hidden="true" href="#cb472-1" tabindex="-1"></a>PG_MODULE_MAGIC_EXT<span class="op">(</span></span>
<span id="cb472-2"><a aria-hidden="true" href="#cb472-2" tabindex="-1"></a>    <span class="op">.</span>name <span class="op">=</span> <span class="st">"auto_explain"</span><span class="op">,</span></span>
<span id="cb472-3"><a aria-hidden="true" href="#cb472-3" tabindex="-1"></a>    <span class="op">.</span>version <span class="op">=</span> PG_VERSION</span>
<span id="cb472-4"><a aria-hidden="true" href="#cb472-4" tabindex="-1"></a><span class="op">);</span></span>
<span id="cb472-5"><a aria-hidden="true" href="#cb472-5" tabindex="-1"></a></span>
<span id="cb472-6"><a aria-hidden="true" href="#cb472-6" tabindex="-1"></a><span class="co">/* GUC variables */</span></span>
<span id="cb472-7"><a aria-hidden="true" href="#cb472-7" tabindex="-1"></a><span class="dt">static</span> <span class="dt">int</span> auto_explain_log_min_duration <span class="op">=</span> <span class="op">-</span><span class="dv">1</span><span class="op">;</span></span>
<span id="cb472-8"><a aria-hidden="true" href="#cb472-8" tabindex="-1"></a><span class="dt">static</span> <span class="dt">bool</span> auto_explain_log_analyze <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb472-9"><a aria-hidden="true" href="#cb472-9" tabindex="-1"></a><span class="dt">static</span> <span class="dt">bool</span> auto_explain_log_verbose <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb472-10"><a aria-hidden="true" href="#cb472-10" tabindex="-1"></a><span class="dt">static</span> <span class="dt">bool</span> auto_explain_log_buffers <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb472-11"><a aria-hidden="true" href="#cb472-11" tabindex="-1"></a><span class="dt">static</span> <span class="dt">bool</span> auto_explain_log_timing <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb472-12"><a aria-hidden="true" href="#cb472-12" tabindex="-1"></a></span>
<span id="cb472-13"><a aria-hidden="true" href="#cb472-13" tabindex="-1"></a><span class="co">/* Saved hook values for chaining */</span></span>
<span id="cb472-14"><a aria-hidden="true" href="#cb472-14" tabindex="-1"></a><span class="dt">static</span> ExecutorStart_hook_type prev_ExecutorStart <span class="op">=</span> NULL<span class="op">;</span></span>
<span id="cb472-15"><a aria-hidden="true" href="#cb472-15" tabindex="-1"></a><span class="dt">static</span> ExecutorRun_hook_type prev_ExecutorRun <span class="op">=</span> NULL<span class="op">;</span></span>
<span id="cb472-16"><a aria-hidden="true" href="#cb472-16" tabindex="-1"></a><span class="dt">static</span> ExecutorFinish_hook_type prev_ExecutorFinish <span class="op">=</span> NULL<span class="op">;</span></span>
<span id="cb472-17"><a aria-hidden="true" href="#cb472-17" tabindex="-1"></a><span class="dt">static</span> ExecutorEnd_hook_type prev_ExecutorEnd <span class="op">=</span> NULL<span class="op">;</span></span>
<span id="cb472-18"><a aria-hidden="true" href="#cb472-18" tabindex="-1"></a></span>
<span id="cb472-19"><a aria-hidden="true" href="#cb472-19" tabindex="-1"></a><span class="co">/* Module load callback */</span></span>
<span id="cb472-20"><a aria-hidden="true" href="#cb472-20" tabindex="-1"></a><span class="dt">void</span></span>
<span id="cb472-21"><a aria-hidden="true" href="#cb472-21" tabindex="-1"></a>_PG_init<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb472-22"><a aria-hidden="true" href="#cb472-22" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb472-23"><a aria-hidden="true" href="#cb472-23" tabindex="-1"></a>    <span class="co">/* Define custom GUC variables */</span></span>
<span id="cb472-24"><a aria-hidden="true" href="#cb472-24" tabindex="-1"></a>    DefineCustomIntVariable<span class="op">(</span><span class="st">"auto_explain.log_min_duration"</span><span class="op">,</span></span>
<span id="cb472-25"><a aria-hidden="true" href="#cb472-25" tabindex="-1"></a>                          <span class="st">"Minimum execution time to log"</span><span class="op">,</span></span>
<span id="cb472-26"><a aria-hidden="true" href="#cb472-26" tabindex="-1"></a>                          <span class="st">"Zero logs all queries, -1 disables"</span><span class="op">,</span></span>
<span id="cb472-27"><a aria-hidden="true" href="#cb472-27" tabindex="-1"></a>                          <span class="op">&amp;</span>auto_explain_log_min_duration<span class="op">,</span></span>
<span id="cb472-28"><a aria-hidden="true" href="#cb472-28" tabindex="-1"></a>                          <span class="op">-</span><span class="dv">1</span><span class="op">,</span> <span class="op">-</span><span class="dv">1</span><span class="op">,</span> INT_MAX<span class="op">,</span></span>
<span id="cb472-29"><a aria-hidden="true" href="#cb472-29" tabindex="-1"></a>                          PGC_SUSET<span class="op">,</span> GUC_UNIT_MS<span class="op">,</span></span>
<span id="cb472-30"><a aria-hidden="true" href="#cb472-30" tabindex="-1"></a>                          NULL<span class="op">,</span> NULL<span class="op">,</span> NULL<span class="op">);</span></span>
<span id="cb472-31"><a aria-hidden="true" href="#cb472-31" tabindex="-1"></a></span>
<span id="cb472-32"><a aria-hidden="true" href="#cb472-32" tabindex="-1"></a>    DefineCustomBoolVariable<span class="op">(</span><span class="st">"auto_explain.log_analyze"</span><span class="op">,</span></span>
<span id="cb472-33"><a aria-hidden="true" href="#cb472-33" tabindex="-1"></a>                           <span class="st">"Use EXPLAIN ANALYZE for plan logging"</span><span class="op">,</span></span>
<span id="cb472-34"><a aria-hidden="true" href="#cb472-34" tabindex="-1"></a>                           NULL<span class="op">,</span></span>
<span id="cb472-35"><a aria-hidden="true" href="#cb472-35" tabindex="-1"></a>                           <span class="op">&amp;</span>auto_explain_log_analyze<span class="op">,</span></span>
<span id="cb472-36"><a aria-hidden="true" href="#cb472-36" tabindex="-1"></a>                           <span class="kw">false</span><span class="op">,</span> PGC_SUSET<span class="op">,</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb472-37"><a aria-hidden="true" href="#cb472-37" tabindex="-1"></a>                           NULL<span class="op">,</span> NULL<span class="op">,</span> NULL<span class="op">);</span></span>
<span id="cb472-38"><a aria-hidden="true" href="#cb472-38" tabindex="-1"></a></span>
<span id="cb472-39"><a aria-hidden="true" href="#cb472-39" tabindex="-1"></a>    <span class="co">/* Install hooks (save previous values for chaining) */</span></span>
<span id="cb472-40"><a aria-hidden="true" href="#cb472-40" tabindex="-1"></a>    prev_ExecutorStart <span class="op">=</span> ExecutorStart_hook<span class="op">;</span></span>
<span id="cb472-41"><a aria-hidden="true" href="#cb472-41" tabindex="-1"></a>    ExecutorStart_hook <span class="op">=</span> explain_ExecutorStart<span class="op">;</span></span>
<span id="cb472-42"><a aria-hidden="true" href="#cb472-42" tabindex="-1"></a></span>
<span id="cb472-43"><a aria-hidden="true" href="#cb472-43" tabindex="-1"></a>    prev_ExecutorRun <span class="op">=</span> ExecutorRun_hook<span class="op">;</span></span>
<span id="cb472-44"><a aria-hidden="true" href="#cb472-44" tabindex="-1"></a>    ExecutorRun_hook <span class="op">=</span> explain_ExecutorRun<span class="op">;</span></span>
<span id="cb472-45"><a aria-hidden="true" href="#cb472-45" tabindex="-1"></a></span>
<span id="cb472-46"><a aria-hidden="true" href="#cb472-46" tabindex="-1"></a>    prev_ExecutorFinish <span class="op">=</span> ExecutorFinish_hook<span class="op">;</span></span>
<span id="cb472-47"><a aria-hidden="true" href="#cb472-47" tabindex="-1"></a>    ExecutorFinish_hook <span class="op">=</span> explain_ExecutorFinish<span class="op">;</span></span>
<span id="cb472-48"><a aria-hidden="true" href="#cb472-48" tabindex="-1"></a></span>
<span id="cb472-49"><a aria-hidden="true" href="#cb472-49" tabindex="-1"></a>    prev_ExecutorEnd <span class="op">=</span> ExecutorEnd_hook<span class="op">;</span></span>
<span id="cb472-50"><a aria-hidden="true" href="#cb472-50" tabindex="-1"></a>    ExecutorEnd_hook <span class="op">=</span> explain_ExecutorEnd<span class="op">;</span></span>
<span id="cb472-51"><a aria-hidden="true" href="#cb472-51" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb472-52"><a aria-hidden="true" href="#cb472-52" tabindex="-1"></a></span>
<span id="cb472-53"><a aria-hidden="true" href="#cb472-53" tabindex="-1"></a><span class="co">/* Hook implementation: start execution */</span></span>
<span id="cb472-54"><a aria-hidden="true" href="#cb472-54" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span></span>
<span id="cb472-55"><a aria-hidden="true" href="#cb472-55" tabindex="-1"></a>explain_ExecutorStart<span class="op">(</span>QueryDesc <span class="op">*</span>queryDesc<span class="op">,</span> <span class="dt">int</span> eflags<span class="op">)</span></span>
<span id="cb472-56"><a aria-hidden="true" href="#cb472-56" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb472-57"><a aria-hidden="true" href="#cb472-57" tabindex="-1"></a>    <span class="co">/* Determine if we should instrument this query */</span></span>
<span id="cb472-58"><a aria-hidden="true" href="#cb472-58" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>auto_explain_enabled<span class="op">())</span></span>
<span id="cb472-59"><a aria-hidden="true" href="#cb472-59" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb472-60"><a aria-hidden="true" href="#cb472-60" tabindex="-1"></a>        <span class="co">/* Request timing instrumentation if ANALYZE enabled */</span></span>
<span id="cb472-61"><a aria-hidden="true" href="#cb472-61" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>auto_explain_log_analyze <span class="op">&amp;&amp;</span> <span class="op">(</span>eflags <span class="op">&amp;</span> EXEC_FLAG_EXPLAIN_ONLY<span class="op">)</span> <span class="op">==</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb472-62"><a aria-hidden="true" href="#cb472-62" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb472-63"><a aria-hidden="true" href="#cb472-63" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>auto_explain_log_timing<span class="op">)</span></span>
<span id="cb472-64"><a aria-hidden="true" href="#cb472-64" tabindex="-1"></a>                queryDesc<span class="op">-&gt;</span>instrument_options <span class="op">|=</span> INSTRUMENT_TIMER<span class="op">;</span></span>
<span id="cb472-65"><a aria-hidden="true" href="#cb472-65" tabindex="-1"></a>            <span class="cf">else</span></span>
<span id="cb472-66"><a aria-hidden="true" href="#cb472-66" tabindex="-1"></a>                queryDesc<span class="op">-&gt;</span>instrument_options <span class="op">|=</span> INSTRUMENT_ROWS<span class="op">;</span></span>
<span id="cb472-67"><a aria-hidden="true" href="#cb472-67" tabindex="-1"></a></span>
<span id="cb472-68"><a aria-hidden="true" href="#cb472-68" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>auto_explain_log_buffers<span class="op">)</span></span>
<span id="cb472-69"><a aria-hidden="true" href="#cb472-69" tabindex="-1"></a>                queryDesc<span class="op">-&gt;</span>instrument_options <span class="op">|=</span> INSTRUMENT_BUFFERS<span class="op">;</span></span>
<span id="cb472-70"><a aria-hidden="true" href="#cb472-70" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb472-71"><a aria-hidden="true" href="#cb472-71" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb472-72"><a aria-hidden="true" href="#cb472-72" tabindex="-1"></a></span>
<span id="cb472-73"><a aria-hidden="true" href="#cb472-73" tabindex="-1"></a>    <span class="co">/* Call previous hook or standard function */</span></span>
<span id="cb472-74"><a aria-hidden="true" href="#cb472-74" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>prev_ExecutorStart<span class="op">)</span></span>
<span id="cb472-75"><a aria-hidden="true" href="#cb472-75" tabindex="-1"></a>        prev_ExecutorStart<span class="op">(</span>queryDesc<span class="op">,</span> eflags<span class="op">);</span></span>
<span id="cb472-76"><a aria-hidden="true" href="#cb472-76" tabindex="-1"></a>    <span class="cf">else</span></span>
<span id="cb472-77"><a aria-hidden="true" href="#cb472-77" tabindex="-1"></a>        standard_ExecutorStart<span class="op">(</span>queryDesc<span class="op">,</span> eflags<span class="op">);</span></span>
<span id="cb472-78"><a aria-hidden="true" href="#cb472-78" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb472-79"><a aria-hidden="true" href="#cb472-79" tabindex="-1"></a></span>
<span id="cb472-80"><a aria-hidden="true" href="#cb472-80" tabindex="-1"></a><span class="co">/* Hook implementation: end execution */</span></span>
<span id="cb472-81"><a aria-hidden="true" href="#cb472-81" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span></span>
<span id="cb472-82"><a aria-hidden="true" href="#cb472-82" tabindex="-1"></a>explain_ExecutorEnd<span class="op">(</span>QueryDesc <span class="op">*</span>queryDesc<span class="op">)</span></span>
<span id="cb472-83"><a aria-hidden="true" href="#cb472-83" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb472-84"><a aria-hidden="true" href="#cb472-84" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>auto_explain_enabled<span class="op">()</span> <span class="op">&amp;&amp;</span> queryDesc<span class="op">-&gt;</span>totaltime<span class="op">)</span></span>
<span id="cb472-85"><a aria-hidden="true" href="#cb472-85" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb472-86"><a aria-hidden="true" href="#cb472-86" tabindex="-1"></a>        <span class="dt">double</span> msec <span class="op">=</span> queryDesc<span class="op">-&gt;</span>totaltime<span class="op">-&gt;</span>total <span class="op">*</span> <span class="fl">1000.0</span><span class="op">;</span></span>
<span id="cb472-87"><a aria-hidden="true" href="#cb472-87" tabindex="-1"></a></span>
<span id="cb472-88"><a aria-hidden="true" href="#cb472-88" tabindex="-1"></a>        <span class="co">/* Log if query exceeded threshold */</span></span>
<span id="cb472-89"><a aria-hidden="true" href="#cb472-89" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>msec <span class="op">&gt;=</span> auto_explain_log_min_duration<span class="op">)</span></span>
<span id="cb472-90"><a aria-hidden="true" href="#cb472-90" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb472-91"><a aria-hidden="true" href="#cb472-91" tabindex="-1"></a>            ExplainState <span class="op">*</span>es <span class="op">=</span> NewExplainState<span class="op">();</span></span>
<span id="cb472-92"><a aria-hidden="true" href="#cb472-92" tabindex="-1"></a></span>
<span id="cb472-93"><a aria-hidden="true" href="#cb472-93" tabindex="-1"></a>            es<span class="op">-&gt;</span>analyze <span class="op">=</span> auto_explain_log_analyze<span class="op">;</span></span>
<span id="cb472-94"><a aria-hidden="true" href="#cb472-94" tabindex="-1"></a>            es<span class="op">-&gt;</span>verbose <span class="op">=</span> auto_explain_log_verbose<span class="op">;</span></span>
<span id="cb472-95"><a aria-hidden="true" href="#cb472-95" tabindex="-1"></a>            es<span class="op">-&gt;</span>buffers <span class="op">=</span> auto_explain_log_buffers<span class="op">;</span></span>
<span id="cb472-96"><a aria-hidden="true" href="#cb472-96" tabindex="-1"></a>            es<span class="op">-&gt;</span>timing <span class="op">=</span> auto_explain_log_timing<span class="op">;</span></span>
<span id="cb472-97"><a aria-hidden="true" href="#cb472-97" tabindex="-1"></a>            es<span class="op">-&gt;</span>format <span class="op">=</span> auto_explain_log_format<span class="op">;</span></span>
<span id="cb472-98"><a aria-hidden="true" href="#cb472-98" tabindex="-1"></a></span>
<span id="cb472-99"><a aria-hidden="true" href="#cb472-99" tabindex="-1"></a>            ExplainBeginOutput<span class="op">(</span>es<span class="op">);</span></span>
<span id="cb472-100"><a aria-hidden="true" href="#cb472-100" tabindex="-1"></a>            ExplainPrintPlan<span class="op">(</span>es<span class="op">,</span> queryDesc<span class="op">);</span></span>
<span id="cb472-101"><a aria-hidden="true" href="#cb472-101" tabindex="-1"></a>            ExplainEndOutput<span class="op">(</span>es<span class="op">);</span></span>
<span id="cb472-102"><a aria-hidden="true" href="#cb472-102" tabindex="-1"></a></span>
<span id="cb472-103"><a aria-hidden="true" href="#cb472-103" tabindex="-1"></a>            ereport<span class="op">(</span>auto_explain_log_level<span class="op">,</span></span>
<span id="cb472-104"><a aria-hidden="true" href="#cb472-104" tabindex="-1"></a>                   <span class="op">(</span>errmsg<span class="op">(</span><span class="st">"duration: </span><span class="sc">%.3f</span><span class="st"> ms  plan:</span><span class="sc">\n%s</span><span class="st">"</span><span class="op">,</span></span>
<span id="cb472-105"><a aria-hidden="true" href="#cb472-105" tabindex="-1"></a>                          msec<span class="op">,</span> es<span class="op">-&gt;</span>str<span class="op">-&gt;</span>data<span class="op">),</span></span>
<span id="cb472-106"><a aria-hidden="true" href="#cb472-106" tabindex="-1"></a>                   errhidestmt<span class="op">(</span><span class="kw">true</span><span class="op">)));</span></span>
<span id="cb472-107"><a aria-hidden="true" href="#cb472-107" tabindex="-1"></a></span>
<span id="cb472-108"><a aria-hidden="true" href="#cb472-108" tabindex="-1"></a>            pfree<span class="op">(</span>es<span class="op">-&gt;</span>str<span class="op">-&gt;</span>data<span class="op">);</span></span>
<span id="cb472-109"><a aria-hidden="true" href="#cb472-109" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb472-110"><a aria-hidden="true" href="#cb472-110" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb472-111"><a aria-hidden="true" href="#cb472-111" tabindex="-1"></a></span>
<span id="cb472-112"><a aria-hidden="true" href="#cb472-112" tabindex="-1"></a>    <span class="co">/* Call previous hook or standard function */</span></span>
<span id="cb472-113"><a aria-hidden="true" href="#cb472-113" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>prev_ExecutorEnd<span class="op">)</span></span>
<span id="cb472-114"><a aria-hidden="true" href="#cb472-114" tabindex="-1"></a>        prev_ExecutorEnd<span class="op">(</span>queryDesc<span class="op">);</span></span>
<span id="cb472-115"><a aria-hidden="true" href="#cb472-115" tabindex="-1"></a>    <span class="cf">else</span></span>
<span id="cb472-116"><a aria-hidden="true" href="#cb472-116" tabindex="-1"></a>        standard_ExecutorEnd<span class="op">(</span>queryDesc<span class="op">);</span></span>
<span id="cb472-117"><a aria-hidden="true" href="#cb472-117" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>Hook Chaining Best Practices:</strong></p>
<ol type="1">
<li>Save previous hook value before installing your hook</li>
<li>Call previous hook (if not NULL) or standard implementation</li>
<li>Install hooks in <code>_PG_init()</code></li>
<li>Consider whether to call previous hook before or after your
logic</li>
<li>Handle errors gracefully to avoid breaking the hook chain</li>
</ol>
<h2 data-number="8.8" id="contrib-modules"><span class="header-section-number">8.8</span> Contrib Modules</h2>
<p>PostgreSQL includes over 40 contributed extensions in the
<code>contrib/</code> directory, demonstrating various extension
capabilities.</p>
<h3 data-number="8.8.1" id="hstore-key-value-store"><span class="header-section-number">8.8.1</span> hstore: Key-Value Store</h3>
<p><code>hstore</code> provides a data type for storing key-value
pairs:</p>
<div class="sourceCode" id="cb473"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb473-1"><a aria-hidden="true" href="#cb473-1" tabindex="-1"></a><span class="kw">CREATE</span> EXTENSION hstore;</span>
<span id="cb473-2"><a aria-hidden="true" href="#cb473-2" tabindex="-1"></a></span>
<span id="cb473-3"><a aria-hidden="true" href="#cb473-3" tabindex="-1"></a><span class="co">-- Create table with hstore column</span></span>
<span id="cb473-4"><a aria-hidden="true" href="#cb473-4" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> products (</span>
<span id="cb473-5"><a aria-hidden="true" href="#cb473-5" tabindex="-1"></a>    <span class="kw">id</span> serial <span class="kw">PRIMARY</span> <span class="kw">KEY</span>,</span>
<span id="cb473-6"><a aria-hidden="true" href="#cb473-6" tabindex="-1"></a>    name text,</span>
<span id="cb473-7"><a aria-hidden="true" href="#cb473-7" tabindex="-1"></a>    <span class="kw">attributes</span> hstore</span>
<span id="cb473-8"><a aria-hidden="true" href="#cb473-8" tabindex="-1"></a>);</span>
<span id="cb473-9"><a aria-hidden="true" href="#cb473-9" tabindex="-1"></a></span>
<span id="cb473-10"><a aria-hidden="true" href="#cb473-10" tabindex="-1"></a><span class="co">-- Insert data</span></span>
<span id="cb473-11"><a aria-hidden="true" href="#cb473-11" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> products (name, <span class="kw">attributes</span>) <span class="kw">VALUES</span></span>
<span id="cb473-12"><a aria-hidden="true" href="#cb473-12" tabindex="-1"></a>    (<span class="st">'Laptop'</span>, <span class="st">'brand=&gt;Dell, ram=&gt;16GB, storage=&gt;512GB SSD'</span>),</span>
<span id="cb473-13"><a aria-hidden="true" href="#cb473-13" tabindex="-1"></a>    (<span class="st">'Phone'</span>, <span class="st">'brand=&gt;Samsung, screen=&gt;6.5", battery=&gt;4500mAh'</span>);</span>
<span id="cb473-14"><a aria-hidden="true" href="#cb473-14" tabindex="-1"></a></span>
<span id="cb473-15"><a aria-hidden="true" href="#cb473-15" tabindex="-1"></a><span class="co">-- Query using operators</span></span>
<span id="cb473-16"><a aria-hidden="true" href="#cb473-16" tabindex="-1"></a><span class="kw">SELECT</span> name <span class="kw">FROM</span> products</span>
<span id="cb473-17"><a aria-hidden="true" href="#cb473-17" tabindex="-1"></a><span class="kw">WHERE</span> <span class="kw">attributes</span> @<span class="op">&gt;</span> <span class="st">'brand=&gt;Dell'</span>;</span>
<span id="cb473-18"><a aria-hidden="true" href="#cb473-18" tabindex="-1"></a></span>
<span id="cb473-19"><a aria-hidden="true" href="#cb473-19" tabindex="-1"></a><span class="kw">SELECT</span> name, <span class="kw">attributes</span><span class="op">-&gt;</span><span class="st">'brand'</span> <span class="kw">AS</span> brand</span>
<span id="cb473-20"><a aria-hidden="true" href="#cb473-20" tabindex="-1"></a><span class="kw">FROM</span> products;</span>
<span id="cb473-21"><a aria-hidden="true" href="#cb473-21" tabindex="-1"></a></span>
<span id="cb473-22"><a aria-hidden="true" href="#cb473-22" tabindex="-1"></a><span class="co">-- Create GIN index for fast containment queries</span></span>
<span id="cb473-23"><a aria-hidden="true" href="#cb473-23" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_attributes <span class="kw">ON</span> products <span class="kw">USING</span> gin(<span class="kw">attributes</span>);</span></code></pre></div>
<p><strong>Implementation Highlights:</strong></p>
<ul>
<li>Custom data type with binary storage format</li>
<li>Operators: <code>-&gt;</code> (get value), <code>@&gt;</code>
(contains), <code>?</code> (key exists)</li>
<li>GIN and GiST index support for efficient querying</li>
<li>Conversion functions to/from JSON, arrays, records</li>
</ul>
<h3 data-number="8.8.2" id="bloom-bloom-filter-index"><span class="header-section-number">8.8.2</span> bloom: Bloom Filter
Index</h3>
<p>Bloom filters provide space-efficient probabilistic indexing:</p>
<div class="sourceCode" id="cb474"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb474-1"><a aria-hidden="true" href="#cb474-1" tabindex="-1"></a><span class="kw">CREATE</span> EXTENSION bloom;</span>
<span id="cb474-2"><a aria-hidden="true" href="#cb474-2" tabindex="-1"></a></span>
<span id="cb474-3"><a aria-hidden="true" href="#cb474-3" tabindex="-1"></a><span class="co">-- Create index with custom parameters</span></span>
<span id="cb474-4"><a aria-hidden="true" href="#cb474-4" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_bloom <span class="kw">ON</span> large_table</span>
<span id="cb474-5"><a aria-hidden="true" href="#cb474-5" tabindex="-1"></a><span class="kw">USING</span> bloom (col1, col2, col3, col4)</span>
<span id="cb474-6"><a aria-hidden="true" href="#cb474-6" tabindex="-1"></a><span class="kw">WITH</span> (<span class="fu">length</span><span class="op">=</span><span class="dv">80</span>, col1<span class="op">=</span><span class="dv">2</span>, col2<span class="op">=</span><span class="dv">2</span>, col3<span class="op">=</span><span class="dv">2</span>, col4<span class="op">=</span><span class="dv">2</span>);</span>
<span id="cb474-7"><a aria-hidden="true" href="#cb474-7" tabindex="-1"></a></span>
<span id="cb474-8"><a aria-hidden="true" href="#cb474-8" tabindex="-1"></a><span class="co">-- Queries benefit from multi-column filtering</span></span>
<span id="cb474-9"><a aria-hidden="true" href="#cb474-9" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> large_table</span>
<span id="cb474-10"><a aria-hidden="true" href="#cb474-10" tabindex="-1"></a><span class="kw">WHERE</span> col1 <span class="op">=</span> <span class="st">'val1'</span> <span class="kw">AND</span> col2 <span class="op">=</span> <span class="st">'val2'</span> <span class="kw">AND</span> col4 <span class="op">=</span> <span class="st">'val4'</span>;</span></code></pre></div>
<p><strong>Characteristics:</strong></p>
<ul>
<li>False positives possible, no false negatives</li>
<li>Smaller than B-tree for multi-column indexes</li>
<li>Bitmap index scan only (no index-only scans)</li>
<li>Configurable bloom filter length and hash functions per column</li>
</ul>
<h3 data-number="8.8.3" id="auto_explain-automatic-plan-logging"><span class="header-section-number">8.8.3</span> auto_explain: Automatic Plan
Logging</h3>
<p>Logs execution plans for slow queries automatically:</p>
<div class="sourceCode" id="cb475"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb475-1"><a aria-hidden="true" href="#cb475-1" tabindex="-1"></a><span class="co">-- Load extension</span></span>
<span id="cb475-2"><a aria-hidden="true" href="#cb475-2" tabindex="-1"></a>LOAD <span class="st">'auto_explain'</span>;</span>
<span id="cb475-3"><a aria-hidden="true" href="#cb475-3" tabindex="-1"></a></span>
<span id="cb475-4"><a aria-hidden="true" href="#cb475-4" tabindex="-1"></a><span class="co">-- Configure via GUC parameters</span></span>
<span id="cb475-5"><a aria-hidden="true" href="#cb475-5" tabindex="-1"></a><span class="kw">SET</span> auto_explain.log_min_duration <span class="op">=</span> <span class="dv">1000</span>;  <span class="co">-- Log queries &gt; 1s</span></span>
<span id="cb475-6"><a aria-hidden="true" href="#cb475-6" tabindex="-1"></a><span class="kw">SET</span> auto_explain.log_analyze <span class="op">=</span> <span class="kw">true</span>;       <span class="co">-- Include actual row counts</span></span>
<span id="cb475-7"><a aria-hidden="true" href="#cb475-7" tabindex="-1"></a><span class="kw">SET</span> auto_explain.log_buffers <span class="op">=</span> <span class="kw">true</span>;       <span class="co">-- Include buffer statistics</span></span>
<span id="cb475-8"><a aria-hidden="true" href="#cb475-8" tabindex="-1"></a><span class="kw">SET</span> auto_explain.log_timing <span class="op">=</span> <span class="kw">true</span>;        <span class="co">-- Include timing info</span></span>
<span id="cb475-9"><a aria-hidden="true" href="#cb475-9" tabindex="-1"></a><span class="kw">SET</span> auto_explain.log_verbose <span class="op">=</span> <span class="kw">true</span>;       <span class="co">-- EXPLAIN VERBOSE</span></span>
<span id="cb475-10"><a aria-hidden="true" href="#cb475-10" tabindex="-1"></a><span class="kw">SET</span> auto_explain.log_format <span class="op">=</span> <span class="st">'json'</span>;      <span class="co">-- JSON output</span></span>
<span id="cb475-11"><a aria-hidden="true" href="#cb475-11" tabindex="-1"></a></span>
<span id="cb475-12"><a aria-hidden="true" href="#cb475-12" tabindex="-1"></a><span class="co">-- Slow queries automatically logged</span></span>
<span id="cb475-13"><a aria-hidden="true" href="#cb475-13" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> large_table <span class="kw">WHERE</span> condition;</span></code></pre></div>
<p><strong>Implementation:</strong></p>
<ul>
<li>Uses ExecutorStart/Run/Finish/End hooks</li>
<li>Measures query execution time</li>
<li>Generates EXPLAIN output if threshold exceeded</li>
<li>Supports nested statements, sampling, parameter logging</li>
</ul>
<h3 data-number="8.8.4" id="additional-notable-contrib-modules"><span class="header-section-number">8.8.4</span> Additional Notable Contrib
Modules</h3>
<p><strong>pgcrypto</strong>: Cryptographic functions</p>
<div class="sourceCode" id="cb476"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb476-1"><a aria-hidden="true" href="#cb476-1" tabindex="-1"></a><span class="kw">CREATE</span> EXTENSION pgcrypto;</span>
<span id="cb476-2"><a aria-hidden="true" href="#cb476-2" tabindex="-1"></a><span class="kw">SELECT</span> digest(<span class="st">'password'</span>, <span class="st">'sha256'</span>);</span>
<span id="cb476-3"><a aria-hidden="true" href="#cb476-3" tabindex="-1"></a><span class="kw">SELECT</span> pgp_sym_encrypt(<span class="st">'secret data'</span>, <span class="st">'key'</span>);</span></code></pre></div>
<p><strong>pg_stat_statements</strong>: Query statistics collector</p>
<div class="sourceCode" id="cb477"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb477-1"><a aria-hidden="true" href="#cb477-1" tabindex="-1"></a><span class="kw">CREATE</span> EXTENSION pg_stat_statements;</span>
<span id="cb477-2"><a aria-hidden="true" href="#cb477-2" tabindex="-1"></a><span class="kw">SELECT</span> <span class="kw">query</span>, calls, total_exec_time, mean_exec_time</span>
<span id="cb477-3"><a aria-hidden="true" href="#cb477-3" tabindex="-1"></a><span class="kw">FROM</span> pg_stat_statements</span>
<span id="cb477-4"><a aria-hidden="true" href="#cb477-4" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> total_exec_time <span class="kw">DESC</span> <span class="kw">LIMIT</span> <span class="dv">10</span>;</span></code></pre></div>
<p><strong>pg_trgm</strong>: Trigram matching for fuzzy string
search</p>
<div class="sourceCode" id="cb478"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb478-1"><a aria-hidden="true" href="#cb478-1" tabindex="-1"></a><span class="kw">CREATE</span> EXTENSION pg_trgm;</span>
<span id="cb478-2"><a aria-hidden="true" href="#cb478-2" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_name_trgm <span class="kw">ON</span> users <span class="kw">USING</span> gin(name gin_trgm_ops);</span>
<span id="cb478-3"><a aria-hidden="true" href="#cb478-3" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> users <span class="kw">WHERE</span> name % <span class="st">'John'</span>;  <span class="co">-- Similarity search</span></span></code></pre></div>
<p><strong>ltree</strong>: Hierarchical tree labels</p>
<div class="sourceCode" id="cb479"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb479-1"><a aria-hidden="true" href="#cb479-1" tabindex="-1"></a><span class="kw">CREATE</span> EXTENSION ltree;</span>
<span id="cb479-2"><a aria-hidden="true" href="#cb479-2" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> categories (path ltree);</span>
<span id="cb479-3"><a aria-hidden="true" href="#cb479-3" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> categories <span class="kw">VALUES</span> (<span class="st">'Electronics.Computers.Laptops'</span>);</span>
<span id="cb479-4"><a aria-hidden="true" href="#cb479-4" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> categories <span class="kw">WHERE</span> path <span class="op">&lt;</span>@ <span class="st">'Electronics'</span>;</span></code></pre></div>
<p><strong>postgres_fdw</strong>: Query remote PostgreSQL servers</p>
<div class="sourceCode" id="cb480"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb480-1"><a aria-hidden="true" href="#cb480-1" tabindex="-1"></a><span class="kw">CREATE</span> EXTENSION postgres_fdw;</span>
<span id="cb480-2"><a aria-hidden="true" href="#cb480-2" tabindex="-1"></a><span class="kw">CREATE</span> SERVER remote_db <span class="kw">FOREIGN</span> <span class="kw">DATA</span> WRAPPER postgres_fdw</span>
<span id="cb480-3"><a aria-hidden="true" href="#cb480-3" tabindex="-1"></a>    OPTIONS (host <span class="st">'remote.example.com'</span>, dbname <span class="st">'production'</span>);</span>
<span id="cb480-4"><a aria-hidden="true" href="#cb480-4" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> foreign_table <span class="kw">WHERE</span> <span class="kw">id</span> <span class="op">&gt;</span> <span class="dv">1000</span>;</span></code></pre></div>
<h2 data-number="8.9" id="pgxs-build-infrastructure"><span class="header-section-number">8.9</span> PGXS Build Infrastructure</h2>
<p>PGXS (PostgreSQL Extension Building Infrastructure) provides a
standardized build system for extensions, enabling compilation against
installed PostgreSQL without access to the full source tree.</p>
<h3 data-number="8.9.1" id="pgxs-makefile-structure"><span class="header-section-number">8.9.1</span> PGXS Makefile Structure</h3>
<p>Extensions use a simple Makefile that includes PGXS:</p>
<div class="sourceCode" id="cb481"><pre class="sourceCode makefile"><code class="sourceCode makefile"><span id="cb481-1"><a aria-hidden="true" href="#cb481-1" tabindex="-1"></a><span class="co"># Makefile for myextension</span></span>
<span id="cb481-2"><a aria-hidden="true" href="#cb481-2" tabindex="-1"></a></span>
<span id="cb481-3"><a aria-hidden="true" href="#cb481-3" tabindex="-1"></a><span class="dt">MODULE_big</span> <span class="ch">=</span><span class="st"> myextension</span></span>
<span id="cb481-4"><a aria-hidden="true" href="#cb481-4" tabindex="-1"></a><span class="dt">OBJS</span> <span class="ch">=</span><span class="st"> myextension.o utils.o parser.o</span></span>
<span id="cb481-5"><a aria-hidden="true" href="#cb481-5" tabindex="-1"></a></span>
<span id="cb481-6"><a aria-hidden="true" href="#cb481-6" tabindex="-1"></a><span class="dt">EXTENSION</span> <span class="ch">=</span><span class="st"> myextension</span></span>
<span id="cb481-7"><a aria-hidden="true" href="#cb481-7" tabindex="-1"></a><span class="dt">DATA</span> <span class="ch">=</span><span class="st"> myextension--1.0.sql myextension--1.0--1.1.sql</span></span>
<span id="cb481-8"><a aria-hidden="true" href="#cb481-8" tabindex="-1"></a><span class="dt">DOCS</span> <span class="ch">=</span><span class="st"> README.myextension</span></span>
<span id="cb481-9"><a aria-hidden="true" href="#cb481-9" tabindex="-1"></a><span class="dt">REGRESS</span> <span class="ch">=</span><span class="st"> myextension_tests</span></span>
<span id="cb481-10"><a aria-hidden="true" href="#cb481-10" tabindex="-1"></a></span>
<span id="cb481-11"><a aria-hidden="true" href="#cb481-11" tabindex="-1"></a><span class="dt">PG_CONFIG</span> <span class="ch">=</span><span class="st"> pg_config</span></span>
<span id="cb481-12"><a aria-hidden="true" href="#cb481-12" tabindex="-1"></a><span class="dt">PGXS</span> <span class="ch">:=</span><span class="st"> </span><span class="ch">$(</span><span class="kw">shell</span><span class="st"> </span><span class="ch">$(</span><span class="dt">PG_CONFIG</span><span class="ch">)</span><span class="st"> --pgxs</span><span class="ch">)</span></span>
<span id="cb481-13"><a aria-hidden="true" href="#cb481-13" tabindex="-1"></a><span class="kw">include</span> <span class="ch">$(</span><span class="dt">PGXS</span><span class="ch">)</span></span></code></pre></div>
<h3 data-number="8.9.2" id="pgxs-variables"><span class="header-section-number">8.9.2</span> PGXS Variables</h3>
<p><strong>Build Target Variables:</strong></p>
<ul>
<li><code>MODULE_big</code>: Single shared library built from multiple
object files (specify in <code>OBJS</code>)</li>
<li><code>MODULES</code>: List of shared libraries, each built from a
single source file</li>
<li><code>PROGRAM</code>: Executable program built from object files
(specify in <code>OBJS</code>)</li>
<li><code>OBJS</code>: Object files to link (for <code>MODULE_big</code>
or <code>PROGRAM</code>)</li>
</ul>
<p><strong>Installation Variables:</strong></p>
<ul>
<li><code>EXTENSION</code>: Extension name (implies
<code>.control</code> file exists)</li>
<li><code>MODULEDIR</code>: Installation subdirectory (default:
<code>extension</code> if <code>EXTENSION</code> set, else
<code>contrib</code>)</li>
<li><code>DATA</code>: Files to install in
<code>$PREFIX/share/$MODULEDIR</code></li>
<li><code>DATA_built</code>: Generated files to install (built before
installation)</li>
<li><code>DOCS</code>: Documentation files to install in
<code>$PREFIX/doc/$MODULEDIR</code></li>
<li><code>SCRIPTS</code>: Scripts to install in
<code>$PREFIX/bin</code></li>
<li><code>SCRIPTS_built</code>: Generated scripts to install</li>
</ul>
<p><strong>Header Installation:</strong></p>
<ul>
<li><code>HEADERS</code>: Header files to install in
<code>$(includedir_server)/$MODULEDIR/$MODULE_big</code></li>
<li><code>HEADERS_built</code>: Generated headers to install</li>
</ul>
<p><strong>Testing Variables:</strong></p>
<ul>
<li><code>REGRESS</code>: List of regression test cases (without
<code>.sql</code> suffix)</li>
<li><code>REGRESS_OPTS</code>: Additional options for
<code>pg_regress</code></li>
<li><code>ISOLATION</code>: Isolation test cases</li>
<li><code>ISOLATION_OPTS</code>: Additional options for
<code>pg_isolation_regress</code></li>
<li><code>TAP_TESTS</code>: Enable TAP test framework</li>
</ul>
<p><strong>Compilation Variables:</strong></p>
<ul>
<li><code>PG_CPPFLAGS</code>: Prepended to <code>CPPFLAGS</code></li>
<li><code>PG_CFLAGS</code>: Appended to <code>CFLAGS</code></li>
<li><code>PG_CXXFLAGS</code>: Appended to <code>CXXFLAGS</code></li>
<li><code>PG_LDFLAGS</code>: Prepended to <code>LDFLAGS</code></li>
<li><code>PG_LIBS</code>: Added to program link line</li>
<li><code>SHLIB_LINK</code>: Added to shared library link line</li>
</ul>
<h3 data-number="8.9.3" id="pgxs-build-targets"><span class="header-section-number">8.9.3</span> PGXS Build Targets</h3>
<div class="sourceCode" id="cb482"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb482-1"><a aria-hidden="true" href="#cb482-1" tabindex="-1"></a><span class="co"># Build extension</span></span>
<span id="cb482-2"><a aria-hidden="true" href="#cb482-2" tabindex="-1"></a><span class="fu">make</span></span>
<span id="cb482-3"><a aria-hidden="true" href="#cb482-3" tabindex="-1"></a></span>
<span id="cb482-4"><a aria-hidden="true" href="#cb482-4" tabindex="-1"></a><span class="co"># Install extension files</span></span>
<span id="cb482-5"><a aria-hidden="true" href="#cb482-5" tabindex="-1"></a><span class="fu">make</span> install</span>
<span id="cb482-6"><a aria-hidden="true" href="#cb482-6" tabindex="-1"></a></span>
<span id="cb482-7"><a aria-hidden="true" href="#cb482-7" tabindex="-1"></a><span class="co"># Uninstall extension</span></span>
<span id="cb482-8"><a aria-hidden="true" href="#cb482-8" tabindex="-1"></a><span class="fu">make</span> uninstall</span>
<span id="cb482-9"><a aria-hidden="true" href="#cb482-9" tabindex="-1"></a></span>
<span id="cb482-10"><a aria-hidden="true" href="#cb482-10" tabindex="-1"></a><span class="co"># Clean build artifacts</span></span>
<span id="cb482-11"><a aria-hidden="true" href="#cb482-11" tabindex="-1"></a><span class="fu">make</span> clean</span>
<span id="cb482-12"><a aria-hidden="true" href="#cb482-12" tabindex="-1"></a></span>
<span id="cb482-13"><a aria-hidden="true" href="#cb482-13" tabindex="-1"></a><span class="co"># Run regression tests against installed PostgreSQL</span></span>
<span id="cb482-14"><a aria-hidden="true" href="#cb482-14" tabindex="-1"></a><span class="fu">make</span> installcheck</span>
<span id="cb482-15"><a aria-hidden="true" href="#cb482-15" tabindex="-1"></a></span>
<span id="cb482-16"><a aria-hidden="true" href="#cb482-16" tabindex="-1"></a><span class="co"># Package distribution tarball</span></span>
<span id="cb482-17"><a aria-hidden="true" href="#cb482-17" tabindex="-1"></a><span class="fu">make</span> dist</span></code></pre></div>
<h3 data-number="8.9.4" id="complete-extension-example"><span class="header-section-number">8.9.4</span> Complete Extension
Example</h3>
<p><strong>Directory Structure:</strong></p>
<pre><code>myextension/
‚îú‚îÄ‚îÄ Makefile
‚îú‚îÄ‚îÄ myextension.control
‚îú‚îÄ‚îÄ myextension--1.0.sql
‚îú‚îÄ‚îÄ myextension--1.0--1.1.sql
‚îú‚îÄ‚îÄ myextension.c
‚îú‚îÄ‚îÄ myextension.h
‚îú‚îÄ‚îÄ README.md
‚îú‚îÄ‚îÄ sql/
‚îÇ   ‚îî‚îÄ‚îÄ myextension.sql
‚îî‚îÄ‚îÄ expected/
    ‚îî‚îÄ‚îÄ myextension.out</code></pre>
<p><strong>Makefile:</strong></p>
<div class="sourceCode" id="cb484"><pre class="sourceCode makefile"><code class="sourceCode makefile"><span id="cb484-1"><a aria-hidden="true" href="#cb484-1" tabindex="-1"></a><span class="co"># myextension/Makefile</span></span>
<span id="cb484-2"><a aria-hidden="true" href="#cb484-2" tabindex="-1"></a></span>
<span id="cb484-3"><a aria-hidden="true" href="#cb484-3" tabindex="-1"></a><span class="dt">MODULE_big</span> <span class="ch">=</span><span class="st"> myextension</span></span>
<span id="cb484-4"><a aria-hidden="true" href="#cb484-4" tabindex="-1"></a><span class="dt">OBJS</span> <span class="ch">=</span><span class="st"> myextension.o</span></span>
<span id="cb484-5"><a aria-hidden="true" href="#cb484-5" tabindex="-1"></a></span>
<span id="cb484-6"><a aria-hidden="true" href="#cb484-6" tabindex="-1"></a><span class="dt">EXTENSION</span> <span class="ch">=</span><span class="st"> myextension</span></span>
<span id="cb484-7"><a aria-hidden="true" href="#cb484-7" tabindex="-1"></a><span class="dt">DATA</span> <span class="ch">=</span><span class="st"> myextension--1.0.sql myextension--1.0--1.1.sql</span></span>
<span id="cb484-8"><a aria-hidden="true" href="#cb484-8" tabindex="-1"></a><span class="dt">DOCS</span> <span class="ch">=</span><span class="st"> README.md</span></span>
<span id="cb484-9"><a aria-hidden="true" href="#cb484-9" tabindex="-1"></a></span>
<span id="cb484-10"><a aria-hidden="true" href="#cb484-10" tabindex="-1"></a><span class="dt">REGRESS</span> <span class="ch">=</span><span class="st"> myextension</span></span>
<span id="cb484-11"><a aria-hidden="true" href="#cb484-11" tabindex="-1"></a><span class="dt">REGRESS_OPTS</span> <span class="ch">=</span><span class="st"> --inputdir=sql --outputdir=sql</span></span>
<span id="cb484-12"><a aria-hidden="true" href="#cb484-12" tabindex="-1"></a></span>
<span id="cb484-13"><a aria-hidden="true" href="#cb484-13" tabindex="-1"></a><span class="dt">PG_CPPFLAGS</span> <span class="ch">=</span><span class="st"> -I</span><span class="ch">$(</span><span class="dt">srcdir</span><span class="ch">)</span></span>
<span id="cb484-14"><a aria-hidden="true" href="#cb484-14" tabindex="-1"></a><span class="dt">SHLIB_LINK</span> <span class="ch">=</span><span class="st"> -lm</span></span>
<span id="cb484-15"><a aria-hidden="true" href="#cb484-15" tabindex="-1"></a></span>
<span id="cb484-16"><a aria-hidden="true" href="#cb484-16" tabindex="-1"></a><span class="dt">PG_CONFIG</span> <span class="ch">=</span><span class="st"> pg_config</span></span>
<span id="cb484-17"><a aria-hidden="true" href="#cb484-17" tabindex="-1"></a><span class="dt">PGXS</span> <span class="ch">:=</span><span class="st"> </span><span class="ch">$(</span><span class="kw">shell</span><span class="st"> </span><span class="ch">$(</span><span class="dt">PG_CONFIG</span><span class="ch">)</span><span class="st"> --pgxs</span><span class="ch">)</span></span>
<span id="cb484-18"><a aria-hidden="true" href="#cb484-18" tabindex="-1"></a><span class="kw">include</span> <span class="ch">$(</span><span class="dt">PGXS</span><span class="ch">)</span></span></code></pre></div>
<p><strong>myextension.control:</strong></p>
<pre><code># myextension extension
comment = 'Example extension demonstrating PGXS'
default_version = '1.0'
module_pathname = '$libdir/myextension'
relocatable = true
trusted = false
requires = 'hstore'</code></pre>
<p><strong>myextension.c:</strong></p>
<div class="sourceCode" id="cb486"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb486-1"><a aria-hidden="true" href="#cb486-1" tabindex="-1"></a><span class="pp">#include </span><span class="im">"postgres.h"</span></span>
<span id="cb486-2"><a aria-hidden="true" href="#cb486-2" tabindex="-1"></a><span class="pp">#include </span><span class="im">"fmgr.h"</span></span>
<span id="cb486-3"><a aria-hidden="true" href="#cb486-3" tabindex="-1"></a><span class="pp">#include </span><span class="im">"utils/builtins.h"</span></span>
<span id="cb486-4"><a aria-hidden="true" href="#cb486-4" tabindex="-1"></a></span>
<span id="cb486-5"><a aria-hidden="true" href="#cb486-5" tabindex="-1"></a>PG_MODULE_MAGIC_EXT<span class="op">(</span></span>
<span id="cb486-6"><a aria-hidden="true" href="#cb486-6" tabindex="-1"></a>    <span class="op">.</span>name <span class="op">=</span> <span class="st">"myextension"</span><span class="op">,</span></span>
<span id="cb486-7"><a aria-hidden="true" href="#cb486-7" tabindex="-1"></a>    <span class="op">.</span>version <span class="op">=</span> PG_VERSION</span>
<span id="cb486-8"><a aria-hidden="true" href="#cb486-8" tabindex="-1"></a><span class="op">);</span></span>
<span id="cb486-9"><a aria-hidden="true" href="#cb486-9" tabindex="-1"></a></span>
<span id="cb486-10"><a aria-hidden="true" href="#cb486-10" tabindex="-1"></a><span class="dt">void</span> _PG_init<span class="op">(</span><span class="dt">void</span><span class="op">);</span></span>
<span id="cb486-11"><a aria-hidden="true" href="#cb486-11" tabindex="-1"></a><span class="dt">void</span> _PG_fini<span class="op">(</span><span class="dt">void</span><span class="op">);</span></span>
<span id="cb486-12"><a aria-hidden="true" href="#cb486-12" tabindex="-1"></a></span>
<span id="cb486-13"><a aria-hidden="true" href="#cb486-13" tabindex="-1"></a>PG_FUNCTION_INFO_V1<span class="op">(</span>my_function<span class="op">);</span></span>
<span id="cb486-14"><a aria-hidden="true" href="#cb486-14" tabindex="-1"></a></span>
<span id="cb486-15"><a aria-hidden="true" href="#cb486-15" tabindex="-1"></a><span class="dt">void</span></span>
<span id="cb486-16"><a aria-hidden="true" href="#cb486-16" tabindex="-1"></a>_PG_init<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb486-17"><a aria-hidden="true" href="#cb486-17" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb486-18"><a aria-hidden="true" href="#cb486-18" tabindex="-1"></a>    <span class="co">/* Extension initialization */</span></span>
<span id="cb486-19"><a aria-hidden="true" href="#cb486-19" tabindex="-1"></a>    elog<span class="op">(</span>LOG<span class="op">,</span> <span class="st">"myextension loaded"</span><span class="op">);</span></span>
<span id="cb486-20"><a aria-hidden="true" href="#cb486-20" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb486-21"><a aria-hidden="true" href="#cb486-21" tabindex="-1"></a></span>
<span id="cb486-22"><a aria-hidden="true" href="#cb486-22" tabindex="-1"></a><span class="dt">void</span></span>
<span id="cb486-23"><a aria-hidden="true" href="#cb486-23" tabindex="-1"></a>_PG_fini<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb486-24"><a aria-hidden="true" href="#cb486-24" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb486-25"><a aria-hidden="true" href="#cb486-25" tabindex="-1"></a>    <span class="co">/* Extension cleanup */</span></span>
<span id="cb486-26"><a aria-hidden="true" href="#cb486-26" tabindex="-1"></a>    elog<span class="op">(</span>LOG<span class="op">,</span> <span class="st">"myextension unloaded"</span><span class="op">);</span></span>
<span id="cb486-27"><a aria-hidden="true" href="#cb486-27" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb486-28"><a aria-hidden="true" href="#cb486-28" tabindex="-1"></a></span>
<span id="cb486-29"><a aria-hidden="true" href="#cb486-29" tabindex="-1"></a>Datum</span>
<span id="cb486-30"><a aria-hidden="true" href="#cb486-30" tabindex="-1"></a>my_function<span class="op">(</span>PG_FUNCTION_ARGS<span class="op">)</span></span>
<span id="cb486-31"><a aria-hidden="true" href="#cb486-31" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb486-32"><a aria-hidden="true" href="#cb486-32" tabindex="-1"></a>    int32 arg <span class="op">=</span> PG_GETARG_INT32<span class="op">(</span><span class="dv">0</span><span class="op">);</span></span>
<span id="cb486-33"><a aria-hidden="true" href="#cb486-33" tabindex="-1"></a>    int32 result <span class="op">=</span> arg <span class="op">*</span> <span class="dv">2</span><span class="op">;</span></span>
<span id="cb486-34"><a aria-hidden="true" href="#cb486-34" tabindex="-1"></a>    PG_RETURN_INT32<span class="op">(</span>result<span class="op">);</span></span>
<span id="cb486-35"><a aria-hidden="true" href="#cb486-35" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>myextension‚Äì1.0.sql:</strong></p>
<div class="sourceCode" id="cb487"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb487-1"><a aria-hidden="true" href="#cb487-1" tabindex="-1"></a><span class="co">/* myextension--1.0.sql */</span></span>
<span id="cb487-2"><a aria-hidden="true" href="#cb487-2" tabindex="-1"></a></span>
<span id="cb487-3"><a aria-hidden="true" href="#cb487-3" tabindex="-1"></a>\echo <span class="kw">Use</span> <span class="ot">"CREATE EXTENSION myextension"</span> <span class="kw">to</span> load this <span class="kw">file</span>. \quit</span>
<span id="cb487-4"><a aria-hidden="true" href="#cb487-4" tabindex="-1"></a></span>
<span id="cb487-5"><a aria-hidden="true" href="#cb487-5" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">FUNCTION</span> my_function(<span class="dt">integer</span>)</span>
<span id="cb487-6"><a aria-hidden="true" href="#cb487-6" tabindex="-1"></a>RETURNS <span class="dt">integer</span></span>
<span id="cb487-7"><a aria-hidden="true" href="#cb487-7" tabindex="-1"></a><span class="kw">AS</span> <span class="st">'MODULE_PATHNAME'</span>, <span class="st">'my_function'</span></span>
<span id="cb487-8"><a aria-hidden="true" href="#cb487-8" tabindex="-1"></a>LANGUAGE C STRICT IMMUTABLE <span class="kw">PARALLEL</span> SAFE;</span>
<span id="cb487-9"><a aria-hidden="true" href="#cb487-9" tabindex="-1"></a></span>
<span id="cb487-10"><a aria-hidden="true" href="#cb487-10" tabindex="-1"></a><span class="kw">CREATE</span> AGGREGATE my_aggregate(<span class="dt">integer</span>) (</span>
<span id="cb487-11"><a aria-hidden="true" href="#cb487-11" tabindex="-1"></a>    SFUNC <span class="op">=</span> int4pl,</span>
<span id="cb487-12"><a aria-hidden="true" href="#cb487-12" tabindex="-1"></a>    STYPE <span class="op">=</span> <span class="dt">integer</span>,</span>
<span id="cb487-13"><a aria-hidden="true" href="#cb487-13" tabindex="-1"></a>    INITCOND <span class="op">=</span> <span class="st">'0'</span></span>
<span id="cb487-14"><a aria-hidden="true" href="#cb487-14" tabindex="-1"></a>);</span></code></pre></div>
<p><strong>Build and Install:</strong></p>
<div class="sourceCode" id="cb488"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb488-1"><a aria-hidden="true" href="#cb488-1" tabindex="-1"></a><span class="co"># Build extension</span></span>
<span id="cb488-2"><a aria-hidden="true" href="#cb488-2" tabindex="-1"></a><span class="fu">make</span></span>
<span id="cb488-3"><a aria-hidden="true" href="#cb488-3" tabindex="-1"></a></span>
<span id="cb488-4"><a aria-hidden="true" href="#cb488-4" tabindex="-1"></a><span class="co"># Install system-wide</span></span>
<span id="cb488-5"><a aria-hidden="true" href="#cb488-5" tabindex="-1"></a><span class="fu">sudo</span> make install</span>
<span id="cb488-6"><a aria-hidden="true" href="#cb488-6" tabindex="-1"></a></span>
<span id="cb488-7"><a aria-hidden="true" href="#cb488-7" tabindex="-1"></a><span class="co"># Run regression tests</span></span>
<span id="cb488-8"><a aria-hidden="true" href="#cb488-8" tabindex="-1"></a><span class="fu">make</span> installcheck</span>
<span id="cb488-9"><a aria-hidden="true" href="#cb488-9" tabindex="-1"></a></span>
<span id="cb488-10"><a aria-hidden="true" href="#cb488-10" tabindex="-1"></a><span class="co"># Install in database</span></span>
<span id="cb488-11"><a aria-hidden="true" href="#cb488-11" tabindex="-1"></a><span class="ex">psql</span> <span class="at">-d</span> mydb <span class="at">-c</span> <span class="st">"CREATE EXTENSION myextension;"</span></span></code></pre></div>
<h3 data-number="8.9.5" id="pgxs-advanced-features"><span class="header-section-number">8.9.5</span> PGXS Advanced Features</h3>
<p><strong>Conditional Compilation:</strong></p>
<div class="sourceCode" id="cb489"><pre class="sourceCode makefile"><code class="sourceCode makefile"><span id="cb489-1"><a aria-hidden="true" href="#cb489-1" tabindex="-1"></a><span class="co"># Check PostgreSQL version</span></span>
<span id="cb489-2"><a aria-hidden="true" href="#cb489-2" tabindex="-1"></a><span class="dt">PGVER</span> <span class="ch">:=</span><span class="st"> </span><span class="ch">$(</span><span class="kw">shell</span><span class="st"> </span><span class="ch">$(</span><span class="dt">PG_CONFIG</span><span class="ch">)</span><span class="st"> --version | sed 's/^PostgreSQL //' | sed 's/\..*//'</span><span class="ch">)</span></span>
<span id="cb489-3"><a aria-hidden="true" href="#cb489-3" tabindex="-1"></a></span>
<span id="cb489-4"><a aria-hidden="true" href="#cb489-4" tabindex="-1"></a><span class="cf">ifeq</span> (<span class="ch">$(</span><span class="kw">shell</span><span class="st"> test </span><span class="ch">$(</span><span class="dt">PGVER</span><span class="ch">)</span><span class="st"> -ge 15; echo </span><span class="ch">$$</span><span class="st">?</span><span class="ch">)</span>, 0)</span>
<span id="cb489-5"><a aria-hidden="true" href="#cb489-5" tabindex="-1"></a>    <span class="dt">PG_CPPFLAGS</span> <span class="ch">+=</span><span class="st"> -DHAVE_PG15_FEATURES</span></span>
<span id="cb489-6"><a aria-hidden="true" href="#cb489-6" tabindex="-1"></a><span class="cf">endif</span></span></code></pre></div>
<p><strong>Custom Rules:</strong></p>
<div class="sourceCode" id="cb490"><pre class="sourceCode makefile"><code class="sourceCode makefile"><span id="cb490-1"><a aria-hidden="true" href="#cb490-1" tabindex="-1"></a><span class="co"># Generate header from template</span></span>
<span id="cb490-2"><a aria-hidden="true" href="#cb490-2" tabindex="-1"></a><span class="dv">myextension.h:</span><span class="dt"> myextension.h.in</span></span>
<span id="cb490-3"><a aria-hidden="true" href="#cb490-3" tabindex="-1"></a><span class="er">    </span>sed <span class="st">'s/@VERSION@/1.0/'</span> <span class="ch">$&lt;</span> &gt; <span class="ch">$@</span></span>
<span id="cb490-4"><a aria-hidden="true" href="#cb490-4" tabindex="-1"></a></span>
<span id="cb490-5"><a aria-hidden="true" href="#cb490-5" tabindex="-1"></a><span class="co"># Ensure header exists before compilation</span></span>
<span id="cb490-6"><a aria-hidden="true" href="#cb490-6" tabindex="-1"></a><span class="dv">myextension.o:</span><span class="dt"> myextension.h</span></span></code></pre></div>
<p><strong>Cross-Platform Support:</strong></p>
<p>PGXS automatically handles platform-specific details: - Shared
library extensions (<code>.so</code>, <code>.dll</code>,
<code>.dylib</code>) - Compiler flags for position-independent code -
Link flags for shared libraries - Installation paths</p>
<p><strong>Out-of-Tree Builds:</strong></p>
<div class="sourceCode" id="cb491"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb491-1"><a aria-hidden="true" href="#cb491-1" tabindex="-1"></a><span class="co"># Build in separate directory</span></span>
<span id="cb491-2"><a aria-hidden="true" href="#cb491-2" tabindex="-1"></a><span class="fu">mkdir</span> build <span class="kw">&amp;&amp;</span> <span class="bu">cd</span> build</span>
<span id="cb491-3"><a aria-hidden="true" href="#cb491-3" tabindex="-1"></a><span class="fu">make</span> <span class="at">-f</span> ../Makefile VPATH=..</span></code></pre></div>
<h2 data-number="8.10" id="extension-development-best-practices"><span class="header-section-number">8.10</span> Extension Development Best
Practices</h2>
<h3 data-number="8.10.1" id="version-management"><span class="header-section-number">8.10.1</span> Version Management</h3>
<ol type="1">
<li><strong>Semantic Versioning</strong>: Use
<code>MAJOR.MINOR.PATCH</code> versioning</li>
<li><strong>Upgrade Scripts</strong>: Provide migration paths between
versions</li>
<li><strong>Minimal Upgrades</strong>: Make upgrade scripts as light as
possible</li>
<li><strong>Testing</strong>: Test upgrade paths from all previous
versions</li>
</ol>
<h3 data-number="8.10.2" id="dependency-management"><span class="header-section-number">8.10.2</span> Dependency Management</h3>
<div class="sourceCode" id="cb492"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb492-1"><a aria-hidden="true" href="#cb492-1" tabindex="-1"></a><span class="co">-- Specify dependencies in control file</span></span>
<span id="cb492-2"><a aria-hidden="true" href="#cb492-2" tabindex="-1"></a>requires <span class="op">=</span> <span class="st">'hstore, postgis &gt;= 3.0'</span></span>
<span id="cb492-3"><a aria-hidden="true" href="#cb492-3" tabindex="-1"></a></span>
<span id="cb492-4"><a aria-hidden="true" href="#cb492-4" tabindex="-1"></a><span class="co">-- Use conditional loading in scripts</span></span>
<span id="cb492-5"><a aria-hidden="true" href="#cb492-5" tabindex="-1"></a>DO $$</span>
<span id="cb492-6"><a aria-hidden="true" href="#cb492-6" tabindex="-1"></a><span class="cf">BEGIN</span></span>
<span id="cb492-7"><a aria-hidden="true" href="#cb492-7" tabindex="-1"></a>    <span class="cf">IF</span> <span class="kw">NOT</span> <span class="kw">EXISTS</span> (<span class="kw">SELECT</span> <span class="dv">1</span> <span class="kw">FROM</span> pg_extension <span class="kw">WHERE</span> extname <span class="op">=</span> <span class="st">'hstore'</span>) <span class="cf">THEN</span></span>
<span id="cb492-8"><a aria-hidden="true" href="#cb492-8" tabindex="-1"></a>        RAISE <span class="kw">EXCEPTION</span> <span class="st">'hstore extension required'</span>;</span>
<span id="cb492-9"><a aria-hidden="true" href="#cb492-9" tabindex="-1"></a>    <span class="cf">END</span> <span class="cf">IF</span>;</span>
<span id="cb492-10"><a aria-hidden="true" href="#cb492-10" tabindex="-1"></a><span class="cf">END</span></span>
<span id="cb492-11"><a aria-hidden="true" href="#cb492-11" tabindex="-1"></a>$$;</span></code></pre></div>
<h3 data-number="8.10.3" id="memory-management"><span class="header-section-number">8.10.3</span> Memory Management</h3>
<div class="sourceCode" id="cb493"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb493-1"><a aria-hidden="true" href="#cb493-1" tabindex="-1"></a><span class="co">/* Use appropriate memory contexts */</span></span>
<span id="cb493-2"><a aria-hidden="true" href="#cb493-2" tabindex="-1"></a>MemoryContext oldcontext <span class="op">=</span> MemoryContextSwitchTo<span class="op">(</span>fcinfo<span class="op">-&gt;</span>flinfo<span class="op">-&gt;</span>fn_mcxt<span class="op">);</span></span>
<span id="cb493-3"><a aria-hidden="true" href="#cb493-3" tabindex="-1"></a>state <span class="op">=</span> palloc<span class="op">(</span><span class="kw">sizeof</span><span class="op">(</span>MyState<span class="op">));</span></span>
<span id="cb493-4"><a aria-hidden="true" href="#cb493-4" tabindex="-1"></a>MemoryContextSwitchTo<span class="op">(</span>oldcontext<span class="op">);</span></span>
<span id="cb493-5"><a aria-hidden="true" href="#cb493-5" tabindex="-1"></a></span>
<span id="cb493-6"><a aria-hidden="true" href="#cb493-6" tabindex="-1"></a><span class="co">/* Clean up temporary allocations */</span></span>
<span id="cb493-7"><a aria-hidden="true" href="#cb493-7" tabindex="-1"></a>MemoryContext tmpcontext <span class="op">=</span> AllocSetContextCreate<span class="op">(</span>CurrentMemoryContext<span class="op">,</span></span>
<span id="cb493-8"><a aria-hidden="true" href="#cb493-8" tabindex="-1"></a>                                                 <span class="st">"myextension temp"</span><span class="op">,</span></span>
<span id="cb493-9"><a aria-hidden="true" href="#cb493-9" tabindex="-1"></a>                                                 ALLOCSET_DEFAULT_SIZES<span class="op">);</span></span>
<span id="cb493-10"><a aria-hidden="true" href="#cb493-10" tabindex="-1"></a>MemoryContext oldcontext <span class="op">=</span> MemoryContextSwitchTo<span class="op">(</span>tmpcontext<span class="op">);</span></span>
<span id="cb493-11"><a aria-hidden="true" href="#cb493-11" tabindex="-1"></a><span class="co">/* ... temporary allocations ... */</span></span>
<span id="cb493-12"><a aria-hidden="true" href="#cb493-12" tabindex="-1"></a>MemoryContextSwitchTo<span class="op">(</span>oldcontext<span class="op">);</span></span>
<span id="cb493-13"><a aria-hidden="true" href="#cb493-13" tabindex="-1"></a>MemoryContextDelete<span class="op">(</span>tmpcontext<span class="op">);</span></span></code></pre></div>
<h3 data-number="8.10.4" id="error-handling"><span class="header-section-number">8.10.4</span> Error Handling</h3>
<div class="sourceCode" id="cb494"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb494-1"><a aria-hidden="true" href="#cb494-1" tabindex="-1"></a><span class="co">/* Use PostgreSQL error reporting */</span></span>
<span id="cb494-2"><a aria-hidden="true" href="#cb494-2" tabindex="-1"></a><span class="cf">if</span> <span class="op">(</span>invalid_input<span class="op">)</span></span>
<span id="cb494-3"><a aria-hidden="true" href="#cb494-3" tabindex="-1"></a>    ereport<span class="op">(</span>ERROR<span class="op">,</span></span>
<span id="cb494-4"><a aria-hidden="true" href="#cb494-4" tabindex="-1"></a>           <span class="op">(</span>errcode<span class="op">(</span>ERRCODE_INVALID_PARAMETER_VALUE<span class="op">),</span></span>
<span id="cb494-5"><a aria-hidden="true" href="#cb494-5" tabindex="-1"></a>            errmsg<span class="op">(</span><span class="st">"invalid input value"</span><span class="op">),</span></span>
<span id="cb494-6"><a aria-hidden="true" href="#cb494-6" tabindex="-1"></a>            errdetail<span class="op">(</span><span class="st">"Value must be positive"</span><span class="op">),</span></span>
<span id="cb494-7"><a aria-hidden="true" href="#cb494-7" tabindex="-1"></a>            errhint<span class="op">(</span><span class="st">"Try using absolute value"</span><span class="op">)));</span></span>
<span id="cb494-8"><a aria-hidden="true" href="#cb494-8" tabindex="-1"></a></span>
<span id="cb494-9"><a aria-hidden="true" href="#cb494-9" tabindex="-1"></a><span class="co">/* Use PG_TRY/PG_CATCH for cleanup */</span></span>
<span id="cb494-10"><a aria-hidden="true" href="#cb494-10" tabindex="-1"></a>PG_TRY<span class="op">();</span></span>
<span id="cb494-11"><a aria-hidden="true" href="#cb494-11" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb494-12"><a aria-hidden="true" href="#cb494-12" tabindex="-1"></a>    result <span class="op">=</span> risky_operation<span class="op">();</span></span>
<span id="cb494-13"><a aria-hidden="true" href="#cb494-13" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb494-14"><a aria-hidden="true" href="#cb494-14" tabindex="-1"></a>PG_CATCH<span class="op">();</span></span>
<span id="cb494-15"><a aria-hidden="true" href="#cb494-15" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb494-16"><a aria-hidden="true" href="#cb494-16" tabindex="-1"></a>    cleanup_resources<span class="op">();</span></span>
<span id="cb494-17"><a aria-hidden="true" href="#cb494-17" tabindex="-1"></a>    PG_RE_THROW<span class="op">();</span></span>
<span id="cb494-18"><a aria-hidden="true" href="#cb494-18" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb494-19"><a aria-hidden="true" href="#cb494-19" tabindex="-1"></a>PG_END_TRY<span class="op">();</span></span></code></pre></div>
<h3 data-number="8.10.5" id="security-considerations-1"><span class="header-section-number">8.10.5</span> Security Considerations</h3>
<ol type="1">
<li><strong>Input Validation</strong>: Always validate user input</li>
<li><strong>SQL Injection</strong>: Use
<code>SPI_execute_with_args()</code> with parameters</li>
<li><strong>Privilege Escalation</strong>: Mark functions
<code>SECURITY DEFINER</code> carefully</li>
<li><strong>Trusted Extensions</strong>: Make extensions installable by
non-superusers when safe</li>
<li><strong>Resource Limits</strong>: Implement safeguards against
excessive resource consumption</li>
</ol>
<h3 data-number="8.10.6" id="performance-optimization-1"><span class="header-section-number">8.10.6</span> Performance
Optimization</h3>
<div class="sourceCode" id="cb495"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb495-1"><a aria-hidden="true" href="#cb495-1" tabindex="-1"></a><span class="co">/* Cache function lookups */</span></span>
<span id="cb495-2"><a aria-hidden="true" href="#cb495-2" tabindex="-1"></a><span class="cf">if</span> <span class="op">(</span>fcinfo<span class="op">-&gt;</span>flinfo<span class="op">-&gt;</span>fn_extra <span class="op">==</span> NULL<span class="op">)</span></span>
<span id="cb495-3"><a aria-hidden="true" href="#cb495-3" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb495-4"><a aria-hidden="true" href="#cb495-4" tabindex="-1"></a>    fmgr_info_cxt<span class="op">(</span>helper_oid<span class="op">,</span> <span class="op">&amp;</span>helper_finfo<span class="op">,</span> fcinfo<span class="op">-&gt;</span>flinfo<span class="op">-&gt;</span>fn_mcxt<span class="op">);</span></span>
<span id="cb495-5"><a aria-hidden="true" href="#cb495-5" tabindex="-1"></a>    fcinfo<span class="op">-&gt;</span>flinfo<span class="op">-&gt;</span>fn_extra <span class="op">=</span> MemoryContextAlloc<span class="op">(</span>fcinfo<span class="op">-&gt;</span>flinfo<span class="op">-&gt;</span>fn_mcxt<span class="op">,</span></span>
<span id="cb495-6"><a aria-hidden="true" href="#cb495-6" tabindex="-1"></a>                                                  <span class="kw">sizeof</span><span class="op">(</span>FmgrInfo<span class="op">));</span></span>
<span id="cb495-7"><a aria-hidden="true" href="#cb495-7" tabindex="-1"></a>    memcpy<span class="op">(</span>fcinfo<span class="op">-&gt;</span>flinfo<span class="op">-&gt;</span>fn_extra<span class="op">,</span> <span class="op">&amp;</span>helper_finfo<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>FmgrInfo<span class="op">));</span></span>
<span id="cb495-8"><a aria-hidden="true" href="#cb495-8" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb495-9"><a aria-hidden="true" href="#cb495-9" tabindex="-1"></a></span>
<span id="cb495-10"><a aria-hidden="true" href="#cb495-10" tabindex="-1"></a><span class="co">/* Avoid repeated detoasting */</span></span>
<span id="cb495-11"><a aria-hidden="true" href="#cb495-11" tabindex="-1"></a><span class="kw">struct</span> varlena <span class="op">*</span>datum <span class="op">=</span> PG_GETARG_VARLENA_PP<span class="op">(</span><span class="dv">0</span><span class="op">);</span></span>
<span id="cb495-12"><a aria-hidden="true" href="#cb495-12" tabindex="-1"></a><span class="co">/* Use datum multiple times without re-detoasting */</span></span>
<span id="cb495-13"><a aria-hidden="true" href="#cb495-13" tabindex="-1"></a>PG_FREE_IF_COPY<span class="op">(</span>datum<span class="op">,</span> <span class="dv">0</span><span class="op">);</span></span></code></pre></div>
<h3 data-number="8.10.7" id="documentation"><span class="header-section-number">8.10.7</span> Documentation</h3>
<ol type="1">
<li><strong>README</strong>: Installation, configuration, usage
examples</li>
<li><strong>SQL Comments</strong>: Document functions and types</li>
<li><strong>Regression Tests</strong>: Serve as usage examples</li>
<li><strong>CHANGELOG</strong>: Document changes between versions</li>
</ol>
<h2 data-number="8.11" id="conclusion-4"><span class="header-section-number">8.11</span> Conclusion</h2>
<p>PostgreSQL‚Äôs extension system represents a sophisticated framework
for database extensibility, enabling developers to add functionality
ranging from simple utility functions to complex subsystems like
procedural languages and storage engines. The architecture‚Äôs key
strengths‚Äîclean API boundaries, version compatibility enforcement,
transactional semantics, and comprehensive hooking mechanisms‚Äîhave
enabled PostgreSQL‚Äôs evolution into a platform supporting diverse
workloads: time-series data (TimescaleDB), analytics (Citus), vector
search (pgvector), and specialized domains.</p>
<p>The function manager provides type-safe, efficient calling
conventions; procedural languages enable server-side logic in familiar
programming languages; foreign data wrappers virtualize external data
sources; custom access methods optimize specialized workloads; the hooks
system enables non-invasive behavior modification; and PGXS standardizes
the build process. Together, these components create an ecosystem where
third-party extensions can achieve integration depth comparable to core
features.</p>
<p>As PostgreSQL continues evolving, the extension system adapts to
support new capabilities: table access methods for pluggable storage,
parallel query execution for extensions, asynchronous I/O for foreign
data wrappers, and incremental materialized view maintenance. This
extensibility ensures PostgreSQL remains adaptable to emerging
requirements while maintaining backward compatibility‚Äîa testament to its
architectural foundations.</p>
<h1 data-number="9" id="chapter-7-postgresql-utility-programs"><span class="header-section-number">9</span> Chapter 7: PostgreSQL Utility
Programs</h1>
<h2 data-number="9.1" id="introduction-3"><span class="header-section-number">9.1</span> Introduction</h2>
<p>PostgreSQL provides a comprehensive suite of command-line utilities
that facilitate database administration, maintenance, backup and
recovery, diagnostics, and performance testing. These utilities are
client-side programs that interact with PostgreSQL server instances or
data directories to perform specialized tasks. Understanding these tools
is essential for effective PostgreSQL administration and
development.</p>
<p>The utilities can be categorized into several functional groups:</p>
<ul>
<li><strong>Backup and Restore Tools</strong>: Logical and physical
backup solutions</li>
<li><strong>Interactive Terminals</strong>: SQL client interfaces</li>
<li><strong>Cluster Management</strong>: Database cluster initialization
and server control</li>
<li><strong>Maintenance Tools</strong>: Routine database maintenance
operations</li>
<li><strong>Administrative Tools</strong>: Major administrative
operations and upgrades</li>
<li><strong>Diagnostic Tools</strong>: Troubleshooting and verification
utilities</li>
<li><strong>Benchmarking Tools</strong>: Performance testing and
workload simulation</li>
<li><strong>Convenience Tools</strong>: Database and user creation
shortcuts</li>
</ul>
<p>All utilities are located in the PostgreSQL installation‚Äôs
<code>bin/</code> directory and share common infrastructure including
connection handling, logging, and command-line parsing.</p>
<h2 data-number="9.2" id="backup-and-restore-utilities"><span class="header-section-number">9.2</span> 1. Backup and Restore
Utilities</h2>
<h3 data-number="9.2.1" id="pg_dump---logical-backup"><span class="header-section-number">9.2.1</span> 1.1 pg_dump - Logical
Backup</h3>
<p><strong>Purpose</strong>: <code>pg_dump</code> extracts a PostgreSQL
database into a script file or archive file containing SQL commands to
reconstruct the database.</p>
<p><strong>Architecture</strong>: The utility operates as a regular
PostgreSQL client, querying system catalogs to extract schema and data
information. It runs in a transaction snapshot mode to ensure
consistency.</p>
<p><strong>Key Source Files</strong>: -
<code>src/bin/pg_dump/pg_dump.c</code> - Main program logic -
<code>src/bin/pg_dump/pg_dump.h</code> - Core data structures -
<code>src/bin/pg_dump/pg_backup_archiver.c</code> - Archive format
handler - <code>src/bin/pg_dump/pg_backup_db.c</code> - Database
connection management - <code>src/bin/pg_dump/common.c</code> - Shared
utility functions</p>
<p><strong>Main Features</strong>:</p>
<ol type="1">
<li><strong>Multiple Output Formats</strong>:
<ul>
<li>Plain SQL text (default)</li>
<li>Custom compressed archive (most flexible)</li>
<li>Directory format (parallel dump/restore)</li>
<li>Tar archive format</li>
</ul></li>
<li><strong>Selective Dumping</strong>:
<ul>
<li>Specific tables, schemas, or databases</li>
<li>Schema-only or data-only dumps</li>
<li>Exclude patterns and object filtering</li>
<li>Filter files for complex selection criteria</li>
</ul></li>
<li><strong>Parallel Processing</strong>:
<ul>
<li>Multiple worker processes for directory format</li>
<li>Significant speedup for large databases</li>
<li>Controlled via <code>-j</code> option</li>
</ul></li>
<li><strong>Transaction Consistency</strong>:
<ul>
<li>Uses REPEATABLE READ transaction isolation</li>
<li>Acquires ACCESS SHARE locks on dumped tables</li>
<li>Captures consistent snapshot via
<code>pg_export_snapshot()</code></li>
</ul></li>
</ol>
<p><strong>Implementation Details</strong>:</p>
<p>The dump process follows these phases:</p>
<div class="sourceCode" id="cb496"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb496-1"><a aria-hidden="true" href="#cb496-1" tabindex="-1"></a><span class="co">// Simplified pg_dump flow from pg_dump.c</span></span>
<span id="cb496-2"><a aria-hidden="true" href="#cb496-2" tabindex="-1"></a><span class="fl">1.</span> setup_connection<span class="op">()</span>      <span class="co">// Connect and set transaction snapshot</span></span>
<span id="cb496-3"><a aria-hidden="true" href="#cb496-3" tabindex="-1"></a><span class="fl">2.</span> getSchemaData<span class="op">()</span>         <span class="co">// Read catalog and build dependency graph</span></span>
<span id="cb496-4"><a aria-hidden="true" href="#cb496-4" tabindex="-1"></a><span class="fl">3.</span> sortDumpableObjects<span class="op">()</span>   <span class="co">// Topological sort for restore order</span></span>
<span id="cb496-5"><a aria-hidden="true" href="#cb496-5" tabindex="-1"></a><span class="fl">4.</span> dumpDumpableObject<span class="op">()</span>    <span class="co">// Output each object definition</span></span></code></pre></div>
<p>Key transaction handling from source:</p>
<div class="sourceCode" id="cb497"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb497-1"><a aria-hidden="true" href="#cb497-1" tabindex="-1"></a><span class="co">/*</span></span>
<span id="cb497-2"><a aria-hidden="true" href="#cb497-2" tabindex="-1"></a><span class="co"> * Note that pg_dump runs in a transaction-snapshot mode transaction,</span></span>
<span id="cb497-3"><a aria-hidden="true" href="#cb497-3" tabindex="-1"></a><span class="co"> * so it sees a consistent snapshot of the database including system</span></span>
<span id="cb497-4"><a aria-hidden="true" href="#cb497-4" tabindex="-1"></a><span class="co"> * catalogs. However, it relies in part on various specialized backend</span></span>
<span id="cb497-5"><a aria-hidden="true" href="#cb497-5" tabindex="-1"></a><span class="co"> * functions like pg_get_indexdef(), and those things tend to look at</span></span>
<span id="cb497-6"><a aria-hidden="true" href="#cb497-6" tabindex="-1"></a><span class="co"> * the currently committed state.</span></span>
<span id="cb497-7"><a aria-hidden="true" href="#cb497-7" tabindex="-1"></a><span class="co"> */</span></span></code></pre></div>
<p><strong>Usage Examples</strong>:</p>
<div class="sourceCode" id="cb498"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb498-1"><a aria-hidden="true" href="#cb498-1" tabindex="-1"></a><span class="co"># Dump entire database to plain SQL</span></span>
<span id="cb498-2"><a aria-hidden="true" href="#cb498-2" tabindex="-1"></a><span class="ex">pg_dump</span> mydb <span class="op">&gt;</span> backup.sql</span>
<span id="cb498-3"><a aria-hidden="true" href="#cb498-3" tabindex="-1"></a></span>
<span id="cb498-4"><a aria-hidden="true" href="#cb498-4" tabindex="-1"></a><span class="co"># Custom format with compression</span></span>
<span id="cb498-5"><a aria-hidden="true" href="#cb498-5" tabindex="-1"></a><span class="ex">pg_dump</span> <span class="at">-Fc</span> <span class="at">-Z9</span> mydb <span class="op">&gt;</span> backup.dump</span>
<span id="cb498-6"><a aria-hidden="true" href="#cb498-6" tabindex="-1"></a></span>
<span id="cb498-7"><a aria-hidden="true" href="#cb498-7" tabindex="-1"></a><span class="co"># Directory format with parallel dump</span></span>
<span id="cb498-8"><a aria-hidden="true" href="#cb498-8" tabindex="-1"></a><span class="ex">pg_dump</span> <span class="at">-Fd</span> <span class="at">-j</span> 4 mydb <span class="at">-f</span> backup_dir/</span>
<span id="cb498-9"><a aria-hidden="true" href="#cb498-9" tabindex="-1"></a></span>
<span id="cb498-10"><a aria-hidden="true" href="#cb498-10" tabindex="-1"></a><span class="co"># Schema only (no data)</span></span>
<span id="cb498-11"><a aria-hidden="true" href="#cb498-11" tabindex="-1"></a><span class="ex">pg_dump</span> <span class="at">--schema-only</span> mydb <span class="op">&gt;</span> schema.sql</span>
<span id="cb498-12"><a aria-hidden="true" href="#cb498-12" tabindex="-1"></a></span>
<span id="cb498-13"><a aria-hidden="true" href="#cb498-13" tabindex="-1"></a><span class="co"># Specific tables with verbose output</span></span>
<span id="cb498-14"><a aria-hidden="true" href="#cb498-14" tabindex="-1"></a><span class="ex">pg_dump</span> <span class="at">-t</span> <span class="st">'sales_*'</span> <span class="at">-t</span> customers <span class="at">-v</span> mydb <span class="op">&gt;</span> partial.sql</span>
<span id="cb498-15"><a aria-hidden="true" href="#cb498-15" tabindex="-1"></a></span>
<span id="cb498-16"><a aria-hidden="true" href="#cb498-16" tabindex="-1"></a><span class="co"># Exclude specific schemas</span></span>
<span id="cb498-17"><a aria-hidden="true" href="#cb498-17" tabindex="-1"></a><span class="ex">pg_dump</span> <span class="at">--exclude-schema</span><span class="op">=</span>temp <span class="at">--exclude-schema</span><span class="op">=</span>staging mydb <span class="op">&gt;</span> prod.sql</span></code></pre></div>
<p><strong>Backend Integration</strong>: - Uses libpq for all server
communication - Relies on backend functions:
<code>pg_get_indexdef()</code>, <code>pg_get_constraintdef()</code>,
<code>pg_get_functiondef()</code>, etc. - Queries system catalogs:
<code>pg_class</code>, <code>pg_attribute</code>,
<code>pg_constraint</code>, <code>pg_index</code>, etc.</p>
<h3 data-number="9.2.2" id="pg_restore---logical-restore"><span class="header-section-number">9.2.2</span> 1.2 pg_restore - Logical
Restore</h3>
<p><strong>Purpose</strong>: <code>pg_restore</code> restores a
PostgreSQL database from an archive created by pg_dump in non-plain-text
format.</p>
<p><strong>Key Source Files</strong>: -
<code>src/bin/pg_dump/pg_restore.c</code> - Main restoration logic -
<code>src/bin/pg_dump/pg_backup_archiver.c</code> - Archive reading -
<code>src/bin/pg_dump/pg_backup_custom.c</code> - Custom format handler
- <code>src/bin/pg_dump/pg_backup_directory.c</code> - Directory format
handler</p>
<p><strong>Main Features</strong>:</p>
<ol type="1">
<li><strong>Flexible Restoration</strong>:
<ul>
<li>Restore entire archive or specific objects</li>
<li>Schema-only or data-only restore</li>
<li>Create database or restore into existing one</li>
</ul></li>
<li><strong>Parallel Restore</strong>:
<ul>
<li>Multiple parallel jobs (<code>-j</code> option)</li>
<li>Works with custom and directory formats</li>
<li>Respects object dependencies</li>
</ul></li>
<li><strong>Table of Contents (TOC) Manipulation</strong>:
<ul>
<li>List archive contents (<code>-l</code>)</li>
<li>Selective restore via TOC file editing</li>
<li>Reordering capabilities</li>
</ul></li>
</ol>
<p><strong>Basic Process</strong> (from source comments):</p>
<div class="sourceCode" id="cb499"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb499-1"><a aria-hidden="true" href="#cb499-1" tabindex="-1"></a><span class="co">/*</span></span>
<span id="cb499-2"><a aria-hidden="true" href="#cb499-2" tabindex="-1"></a><span class="co"> * Basic process in a restore operation is:</span></span>
<span id="cb499-3"><a aria-hidden="true" href="#cb499-3" tabindex="-1"></a><span class="co"> *</span></span>
<span id="cb499-4"><a aria-hidden="true" href="#cb499-4" tabindex="-1"></a><span class="co"> *  Open the Archive and read the TOC.</span></span>
<span id="cb499-5"><a aria-hidden="true" href="#cb499-5" tabindex="-1"></a><span class="co"> *  Set flags in TOC entries, and *maybe* reorder them.</span></span>
<span id="cb499-6"><a aria-hidden="true" href="#cb499-6" tabindex="-1"></a><span class="co"> *  Generate script to stdout</span></span>
<span id="cb499-7"><a aria-hidden="true" href="#cb499-7" tabindex="-1"></a><span class="co"> *  Exit</span></span>
<span id="cb499-8"><a aria-hidden="true" href="#cb499-8" tabindex="-1"></a><span class="co"> */</span></span></code></pre></div>
<p><strong>Usage Examples</strong>:</p>
<div class="sourceCode" id="cb500"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb500-1"><a aria-hidden="true" href="#cb500-1" tabindex="-1"></a><span class="co"># Restore entire database</span></span>
<span id="cb500-2"><a aria-hidden="true" href="#cb500-2" tabindex="-1"></a><span class="ex">pg_restore</span> <span class="at">-d</span> newdb backup.dump</span>
<span id="cb500-3"><a aria-hidden="true" href="#cb500-3" tabindex="-1"></a></span>
<span id="cb500-4"><a aria-hidden="true" href="#cb500-4" tabindex="-1"></a><span class="co"># List contents of archive</span></span>
<span id="cb500-5"><a aria-hidden="true" href="#cb500-5" tabindex="-1"></a><span class="ex">pg_restore</span> <span class="at">-l</span> backup.dump <span class="op">&gt;</span> toc.list</span>
<span id="cb500-6"><a aria-hidden="true" href="#cb500-6" tabindex="-1"></a></span>
<span id="cb500-7"><a aria-hidden="true" href="#cb500-7" tabindex="-1"></a><span class="co"># Restore with parallel jobs</span></span>
<span id="cb500-8"><a aria-hidden="true" href="#cb500-8" tabindex="-1"></a><span class="ex">pg_restore</span> <span class="at">-j</span> 4 <span class="at">-d</span> mydb backup_dir/</span>
<span id="cb500-9"><a aria-hidden="true" href="#cb500-9" tabindex="-1"></a></span>
<span id="cb500-10"><a aria-hidden="true" href="#cb500-10" tabindex="-1"></a><span class="co"># Restore only specific schema</span></span>
<span id="cb500-11"><a aria-hidden="true" href="#cb500-11" tabindex="-1"></a><span class="ex">pg_restore</span> <span class="at">-n</span> public <span class="at">-d</span> mydb backup.dump</span>
<span id="cb500-12"><a aria-hidden="true" href="#cb500-12" tabindex="-1"></a></span>
<span id="cb500-13"><a aria-hidden="true" href="#cb500-13" tabindex="-1"></a><span class="co"># Restore data only (schema must exist)</span></span>
<span id="cb500-14"><a aria-hidden="true" href="#cb500-14" tabindex="-1"></a><span class="ex">pg_restore</span> <span class="at">--data-only</span> <span class="at">-d</span> mydb backup.dump</span>
<span id="cb500-15"><a aria-hidden="true" href="#cb500-15" tabindex="-1"></a></span>
<span id="cb500-16"><a aria-hidden="true" href="#cb500-16" tabindex="-1"></a><span class="co"># Clean database before restore</span></span>
<span id="cb500-17"><a aria-hidden="true" href="#cb500-17" tabindex="-1"></a><span class="ex">pg_restore</span> <span class="at">-c</span> <span class="at">-d</span> mydb backup.dump</span></code></pre></div>
<h3 data-number="9.2.3" id="pg_basebackup---physical-backup"><span class="header-section-number">9.2.3</span> 1.3 pg_basebackup - Physical
Backup</h3>
<p><strong>Purpose</strong>: <code>pg_basebackup</code> takes a base
backup of a running PostgreSQL cluster using the streaming replication
protocol.</p>
<p><strong>Key Source Files</strong>: -
<code>src/bin/pg_basebackup/pg_basebackup.c</code> - Main program -
<code>src/bin/pg_basebackup/streamutil.c</code> - Streaming replication
utilities - <code>src/bin/pg_basebackup/receivelog.c</code> - WAL
receiving - <code>src/bin/pg_basebackup/walmethods.c</code> - WAL
writing methods</p>
<p><strong>Main Features</strong>:</p>
<ol type="1">
<li><strong>Physical Backup</strong>:
<ul>
<li>Exact copy of data directory</li>
<li>Includes all databases in cluster</li>
<li>Point-in-time recovery capable</li>
</ul></li>
<li><strong>Streaming Methods</strong>:
<ul>
<li>Plain format (direct file copy)</li>
<li>Tar format (compressed archives)</li>
<li>Server-side or client-side compression</li>
</ul></li>
<li><strong>WAL Streaming</strong>:
<ul>
<li>Concurrent WAL archiving during backup</li>
<li>Ensures backup consistency</li>
<li><code>-X stream</code> or <code>-X fetch</code> modes</li>
</ul></li>
<li><strong>Progress Reporting</strong>:
<ul>
<li>Real-time progress indicators</li>
<li>Estimated completion time</li>
<li>Backup manifest generation (v13+)</li>
</ul></li>
</ol>
<p><strong>Version Compatibility</strong> (from source):</p>
<div class="sourceCode" id="cb501"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb501-1"><a aria-hidden="true" href="#cb501-1" tabindex="-1"></a><span class="co">/*</span></span>
<span id="cb501-2"><a aria-hidden="true" href="#cb501-2" tabindex="-1"></a><span class="co"> * pg_xlog has been renamed to pg_wal in version 10.</span></span>
<span id="cb501-3"><a aria-hidden="true" href="#cb501-3" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb501-4"><a aria-hidden="true" href="#cb501-4" tabindex="-1"></a><span class="pp">#define MINIMUM_VERSION_FOR_PG_WAL  </span><span class="dv">100000</span></span>
<span id="cb501-5"><a aria-hidden="true" href="#cb501-5" tabindex="-1"></a></span>
<span id="cb501-6"><a aria-hidden="true" href="#cb501-6" tabindex="-1"></a><span class="co">/*</span></span>
<span id="cb501-7"><a aria-hidden="true" href="#cb501-7" tabindex="-1"></a><span class="co"> * Temporary replication slots are supported from version 10.</span></span>
<span id="cb501-8"><a aria-hidden="true" href="#cb501-8" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb501-9"><a aria-hidden="true" href="#cb501-9" tabindex="-1"></a><span class="pp">#define MINIMUM_VERSION_FOR_TEMP_SLOTS </span><span class="dv">100000</span></span>
<span id="cb501-10"><a aria-hidden="true" href="#cb501-10" tabindex="-1"></a></span>
<span id="cb501-11"><a aria-hidden="true" href="#cb501-11" tabindex="-1"></a><span class="co">/*</span></span>
<span id="cb501-12"><a aria-hidden="true" href="#cb501-12" tabindex="-1"></a><span class="co"> * Backup manifests are supported from version 13.</span></span>
<span id="cb501-13"><a aria-hidden="true" href="#cb501-13" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb501-14"><a aria-hidden="true" href="#cb501-14" tabindex="-1"></a><span class="pp">#define MINIMUM_VERSION_FOR_MANIFESTS  </span><span class="dv">130000</span></span></code></pre></div>
<p><strong>Usage Examples</strong>:</p>
<div class="sourceCode" id="cb502"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb502-1"><a aria-hidden="true" href="#cb502-1" tabindex="-1"></a><span class="co"># Basic backup to directory</span></span>
<span id="cb502-2"><a aria-hidden="true" href="#cb502-2" tabindex="-1"></a><span class="ex">pg_basebackup</span> <span class="at">-D</span> /backup/pgdata <span class="at">-P</span></span>
<span id="cb502-3"><a aria-hidden="true" href="#cb502-3" tabindex="-1"></a></span>
<span id="cb502-4"><a aria-hidden="true" href="#cb502-4" tabindex="-1"></a><span class="co"># Compressed tar format with WAL</span></span>
<span id="cb502-5"><a aria-hidden="true" href="#cb502-5" tabindex="-1"></a><span class="ex">pg_basebackup</span> <span class="at">-D</span> /backup <span class="at">-Ft</span> <span class="at">-z</span> <span class="at">-X</span> stream <span class="at">-P</span></span>
<span id="cb502-6"><a aria-hidden="true" href="#cb502-6" tabindex="-1"></a></span>
<span id="cb502-7"><a aria-hidden="true" href="#cb502-7" tabindex="-1"></a><span class="co"># Backup with specific compression</span></span>
<span id="cb502-8"><a aria-hidden="true" href="#cb502-8" tabindex="-1"></a><span class="ex">pg_basebackup</span> <span class="at">-D</span> /backup <span class="at">-Ft</span> <span class="at">--compress</span><span class="op">=</span>gzip:9 <span class="at">-X</span> stream</span>
<span id="cb502-9"><a aria-hidden="true" href="#cb502-9" tabindex="-1"></a></span>
<span id="cb502-10"><a aria-hidden="true" href="#cb502-10" tabindex="-1"></a><span class="co"># Use replication slot</span></span>
<span id="cb502-11"><a aria-hidden="true" href="#cb502-11" tabindex="-1"></a><span class="ex">pg_basebackup</span> <span class="at">-D</span> /backup <span class="at">-S</span> myslot <span class="at">-X</span> stream <span class="at">-P</span></span>
<span id="cb502-12"><a aria-hidden="true" href="#cb502-12" tabindex="-1"></a></span>
<span id="cb502-13"><a aria-hidden="true" href="#cb502-13" tabindex="-1"></a><span class="co"># Server-side compression (v15+)</span></span>
<span id="cb502-14"><a aria-hidden="true" href="#cb502-14" tabindex="-1"></a><span class="ex">pg_basebackup</span> <span class="at">-D</span> /backup <span class="at">--compress</span><span class="op">=</span>server-gzip:5 <span class="at">-X</span> stream</span>
<span id="cb502-15"><a aria-hidden="true" href="#cb502-15" tabindex="-1"></a></span>
<span id="cb502-16"><a aria-hidden="true" href="#cb502-16" tabindex="-1"></a><span class="co"># Generate backup manifest</span></span>
<span id="cb502-17"><a aria-hidden="true" href="#cb502-17" tabindex="-1"></a><span class="ex">pg_basebackup</span> <span class="at">-D</span> /backup <span class="at">--manifest-checksums</span><span class="op">=</span>SHA256 <span class="at">-P</span></span></code></pre></div>
<p><strong>Backend Integration</strong>: - Uses replication protocol
(<code>BASE_BACKUP</code> command) - Connects to server with
<code>replication=1</code> connection string - Backend code:
<code>src/backend/replication/basebackup.c</code> - Requires
<code>pg_read_all_settings</code> or superuser privilege</p>
<h3 data-number="9.2.4" id="pg_verifybackup---backup-verification"><span class="header-section-number">9.2.4</span> 1.4 pg_verifybackup - Backup
Verification</h3>
<p><strong>Purpose</strong>: Verifies the integrity of a base backup
against its manifest file.</p>
<p><strong>Key Source Files</strong>: -
<code>src/bin/pg_verifybackup/pg_verifybackup.c</code> - Main
verification logic -
<code>src/bin/pg_verifybackup/parse_manifest.c</code> - Manifest
parsing</p>
<p><strong>Main Features</strong>: - Checksum verification of all files
- Detection of missing or extra files - WAL consistency checking -
Support for tar and plain format backups</p>
<p><strong>Usage Example</strong>:</p>
<div class="sourceCode" id="cb503"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb503-1"><a aria-hidden="true" href="#cb503-1" tabindex="-1"></a><span class="co"># Verify backup directory</span></span>
<span id="cb503-2"><a aria-hidden="true" href="#cb503-2" tabindex="-1"></a><span class="ex">pg_verifybackup</span> /backup/pgdata</span>
<span id="cb503-3"><a aria-hidden="true" href="#cb503-3" tabindex="-1"></a></span>
<span id="cb503-4"><a aria-hidden="true" href="#cb503-4" tabindex="-1"></a><span class="co"># Verify with quiet output</span></span>
<span id="cb503-5"><a aria-hidden="true" href="#cb503-5" tabindex="-1"></a><span class="ex">pg_verifybackup</span> <span class="at">-q</span> /backup/pgdata</span>
<span id="cb503-6"><a aria-hidden="true" href="#cb503-6" tabindex="-1"></a></span>
<span id="cb503-7"><a aria-hidden="true" href="#cb503-7" tabindex="-1"></a><span class="co"># Verify and ignore specific files</span></span>
<span id="cb503-8"><a aria-hidden="true" href="#cb503-8" tabindex="-1"></a><span class="ex">pg_verifybackup</span> <span class="at">-e</span> <span class="st">'postgresql.auto.conf'</span> /backup/pgdata</span></code></pre></div>
<h2 data-number="9.3" id="interactive-terminal---psql"><span class="header-section-number">9.3</span> 2. Interactive Terminal -
psql</h2>
<h3 data-number="9.3.1" id="overview-14"><span class="header-section-number">9.3.1</span> 2.1 Overview</h3>
<p><strong>Purpose</strong>: <code>psql</code> is PostgreSQL‚Äôs
interactive terminal, providing a command-line interface for executing
SQL queries, managing database objects, and performing administrative
tasks.</p>
<p><strong>Key Source Files</strong>: -
<code>src/bin/psql/command.c</code> (6,560 lines) - Backslash command
processing - <code>src/bin/psql/describe.c</code> (7,392 lines) - Object
description commands - <code>src/bin/psql/common.c</code> - Query
execution and result display -
<code>src/bin/psql/tab-complete.in.c</code> - Tab completion logic -
<code>src/bin/psql/input.c</code> - Input handling and readline
integration - <code>src/bin/psql/mainloop.c</code> - Main REPL loop -
<code>src/bin/psql/startup.c</code> - Initialization and startup -
<code>src/bin/psql/variables.c</code> - Variable management -
<code>src/bin/psql/help.c</code> - Help system</p>
<h3 data-number="9.3.2" id="architecture-1"><span class="header-section-number">9.3.2</span> 2.2 Architecture</h3>
<p><strong>Command Processing</strong>:</p>
<div class="sourceCode" id="cb504"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb504-1"><a aria-hidden="true" href="#cb504-1" tabindex="-1"></a><span class="co">// From command.c - command dispatch</span></span>
<span id="cb504-2"><a aria-hidden="true" href="#cb504-2" tabindex="-1"></a><span class="dt">static</span> backslashResult exec_command<span class="op">(</span><span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>cmd<span class="op">,</span></span>
<span id="cb504-3"><a aria-hidden="true" href="#cb504-3" tabindex="-1"></a>                                    PsqlScanState scan_state<span class="op">,</span></span>
<span id="cb504-4"><a aria-hidden="true" href="#cb504-4" tabindex="-1"></a>                                    ConditionalStack cstack<span class="op">,</span></span>
<span id="cb504-5"><a aria-hidden="true" href="#cb504-5" tabindex="-1"></a>                                    PQExpBuffer query_buf<span class="op">,</span></span>
<span id="cb504-6"><a aria-hidden="true" href="#cb504-6" tabindex="-1"></a>                                    PQExpBuffer previous_buf<span class="op">);</span></span></code></pre></div>
<p>psql distinguishes between: - <strong>SQL commands</strong>: Sent
directly to server - <strong>Meta-commands</strong>: Backslash commands
processed locally (80+ commands) - <strong>psql variables</strong>:
Client-side configuration and scripting</p>
<h3 data-number="9.3.3" id="major-command-categories"><span class="header-section-number">9.3.3</span> 2.3 Major Command
Categories</h3>
<p><strong>Connection Commands</strong>: - <code>\c[onnect]</code> -
Connect to different database/server - <code>\conninfo</code> - Display
connection information - <code>\password</code> - Change user
password</p>
<p><strong>Description Commands</strong> (<code>\d</code> family): -
<code>\d[S+]</code> - List tables, views, sequences - <code>\dt</code> -
List tables only - <code>\di</code> - List indexes - <code>\dv</code> -
List views - <code>\df</code> - List functions - <code>\dn</code> - List
schemas - <code>\du</code> - List roles - <code>\l</code> - List
databases - <code>\dx</code> - List extensions -
<code>\d+ tablename</code> - Detailed table description</p>
<p><strong>Query Execution Commands</strong>: - <code>\g</code> -
Execute query - <code>\gx</code> - Execute query with expanded output -
<code>\gset</code> - Execute query and store results in variables -
<code>\watch</code> - Execute query repeatedly</p>
<p><strong>Output Formatting</strong>: - <code>\x</code> - Toggle
expanded output - <code>\pset</code> - Set output options (format,
border, pager) - <code>\t</code> - Tuples-only mode (no headers) -
<code>\a</code> - Toggle aligned/unaligned output - <code>\H</code> -
HTML output format - <code>\o filename</code> - Redirect output to
file</p>
<p><strong>Import/Export</strong>: - <code>\copy</code> - Client-side
COPY (similar to SQL COPY) - <code>\i filename</code> - Execute commands
from file - <code>\ir filename</code> - Execute commands from file
(relative path) - <code>\o</code> - Redirect query output</p>
<p><strong>Editing Commands</strong>: - <code>\e</code> - Edit query
buffer in external editor - <code>\ef</code> - Edit function definition
- <code>\ev</code> - Edit view definition - <code>\p</code> - Print
current query buffer</p>
<p><strong>Information Commands</strong>: - <code>\l</code> - List
databases - <code>\encoding</code> - Show/set client encoding -
<code>\timing</code> - Toggle timing of commands -
<code>\set</code>/<code>\unset</code> - Set/unset psql variables</p>
<p><strong>Transaction Control</strong>: - <code>\begin</code> - Begin
transaction - <code>\commit</code> - Commit transaction -
<code>\rollback</code> - Rollback transaction</p>
<p><strong>Scripting Commands</strong>: - <code>\if</code>,
<code>\elif</code>, <code>\else</code>, <code>\endif</code> -
Conditional execution - <code>\set</code>/<code>\unset</code> - Variable
assignment - <code>\echo</code> - Print to stdout - <code>\qecho</code>
- Print to query output - <code>\warn</code> - Print warning message -
<code>\gset</code> - Store query results in variables -
<code>\include</code> - Include another file</p>
<p><strong>Pipeline Commands</strong> (protocol-level pipelining): -
<code>\startpipeline</code> - Start pipeline mode -
<code>\endpipeline</code> - End pipeline mode - <code>\sync</code> -
Pipeline sync point</p>
<h3 data-number="9.3.4" id="advanced-features"><span class="header-section-number">9.3.4</span> 2.4 Advanced Features</h3>
<p><strong>Tab Completion</strong>: - SQL keyword completion - Object
name completion (tables, columns, functions) - Context-aware suggestions
- Implemented in <code>tab-complete.in.c</code> using readline
library</p>
<p><strong>Variables and Interpolation</strong>:</p>
<div class="sourceCode" id="cb505"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb505-1"><a aria-hidden="true" href="#cb505-1" tabindex="-1"></a><span class="co">-- Set variable</span></span>
<span id="cb505-2"><a aria-hidden="true" href="#cb505-2" tabindex="-1"></a>\<span class="kw">set</span> myvar <span class="st">'value'</span></span>
<span id="cb505-3"><a aria-hidden="true" href="#cb505-3" tabindex="-1"></a></span>
<span id="cb505-4"><a aria-hidden="true" href="#cb505-4" tabindex="-1"></a><span class="co">-- Use in query</span></span>
<span id="cb505-5"><a aria-hidden="true" href="#cb505-5" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> <span class="ch">:myvar</span>;</span>
<span id="cb505-6"><a aria-hidden="true" href="#cb505-6" tabindex="-1"></a></span>
<span id="cb505-7"><a aria-hidden="true" href="#cb505-7" tabindex="-1"></a><span class="co">-- Conditional execution</span></span>
<span id="cb505-8"><a aria-hidden="true" href="#cb505-8" tabindex="-1"></a>\<span class="cf">if</span> <span class="ch">:myvar</span></span>
<span id="cb505-9"><a aria-hidden="true" href="#cb505-9" tabindex="-1"></a>  <span class="kw">SELECT</span> <span class="st">'variable is set'</span>;</span>
<span id="cb505-10"><a aria-hidden="true" href="#cb505-10" tabindex="-1"></a>\endif</span></code></pre></div>
<p><strong>Special Variables</strong>: - <code>AUTOCOMMIT</code> -
Auto-commit mode - <code>ECHO</code> - Echo executed queries -
<code>HISTFILE</code> - Command history file -
<code>ON_ERROR_STOP</code> - Stop on errors (important for scripts) -
<code>PROMPT1/2/3</code> - Customize prompts - <code>VERBOSITY</code> -
Error message verbosity</p>
<p><strong>Crosstab Reports</strong>:</p>
<div class="sourceCode" id="cb506"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb506-1"><a aria-hidden="true" href="#cb506-1" tabindex="-1"></a><span class="co">-- \crosstabview for pivot-style reports</span></span>
<span id="cb506-2"><a aria-hidden="true" href="#cb506-2" tabindex="-1"></a><span class="kw">SELECT</span> <span class="dt">year</span>, quarter, sales <span class="kw">FROM</span> <span class="kw">data</span> \crosstabview</span></code></pre></div>
<h3 data-number="9.3.5" id="usage-examples"><span class="header-section-number">9.3.5</span> 2.5 Usage Examples</h3>
<div class="sourceCode" id="cb507"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb507-1"><a aria-hidden="true" href="#cb507-1" tabindex="-1"></a><span class="co"># Connect to database</span></span>
<span id="cb507-2"><a aria-hidden="true" href="#cb507-2" tabindex="-1"></a><span class="ex">psql</span> <span class="at">-h</span> localhost <span class="at">-U</span> myuser <span class="at">-d</span> mydb</span>
<span id="cb507-3"><a aria-hidden="true" href="#cb507-3" tabindex="-1"></a></span>
<span id="cb507-4"><a aria-hidden="true" href="#cb507-4" tabindex="-1"></a><span class="co"># Execute single command</span></span>
<span id="cb507-5"><a aria-hidden="true" href="#cb507-5" tabindex="-1"></a><span class="ex">psql</span> <span class="at">-c</span> <span class="st">"SELECT version();"</span> mydb</span>
<span id="cb507-6"><a aria-hidden="true" href="#cb507-6" tabindex="-1"></a></span>
<span id="cb507-7"><a aria-hidden="true" href="#cb507-7" tabindex="-1"></a><span class="co"># Execute script</span></span>
<span id="cb507-8"><a aria-hidden="true" href="#cb507-8" tabindex="-1"></a><span class="ex">psql</span> <span class="at">-f</span> setup.sql mydb</span>
<span id="cb507-9"><a aria-hidden="true" href="#cb507-9" tabindex="-1"></a></span>
<span id="cb507-10"><a aria-hidden="true" href="#cb507-10" tabindex="-1"></a><span class="co"># Variable substitution</span></span>
<span id="cb507-11"><a aria-hidden="true" href="#cb507-11" tabindex="-1"></a><span class="ex">psql</span> <span class="at">-v</span> tablename=users <span class="at">-f</span> query.sql</span>
<span id="cb507-12"><a aria-hidden="true" href="#cb507-12" tabindex="-1"></a></span>
<span id="cb507-13"><a aria-hidden="true" href="#cb507-13" tabindex="-1"></a><span class="co"># CSV output</span></span>
<span id="cb507-14"><a aria-hidden="true" href="#cb507-14" tabindex="-1"></a><span class="ex">psql</span> <span class="at">-c</span> <span class="st">"SELECT * FROM users"</span> <span class="at">--csv</span> mydb <span class="op">&gt;</span> users.csv</span>
<span id="cb507-15"><a aria-hidden="true" href="#cb507-15" tabindex="-1"></a></span>
<span id="cb507-16"><a aria-hidden="true" href="#cb507-16" tabindex="-1"></a><span class="co"># Tuples-only output (scripting)</span></span>
<span id="cb507-17"><a aria-hidden="true" href="#cb507-17" tabindex="-1"></a><span class="ex">psql</span> <span class="at">-t</span> <span class="at">-c</span> <span class="st">"SELECT id FROM users"</span> mydb</span></code></pre></div>
<p><strong>Interactive Session</strong>:</p>
<div class="sourceCode" id="cb508"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb508-1"><a aria-hidden="true" href="#cb508-1" tabindex="-1"></a><span class="co">-- List all tables with details</span></span>
<span id="cb508-2"><a aria-hidden="true" href="#cb508-2" tabindex="-1"></a>\dt<span class="op">+</span></span>
<span id="cb508-3"><a aria-hidden="true" href="#cb508-3" tabindex="-1"></a></span>
<span id="cb508-4"><a aria-hidden="true" href="#cb508-4" tabindex="-1"></a><span class="co">-- Describe specific table</span></span>
<span id="cb508-5"><a aria-hidden="true" href="#cb508-5" tabindex="-1"></a>\d<span class="op">+</span> users</span>
<span id="cb508-6"><a aria-hidden="true" href="#cb508-6" tabindex="-1"></a></span>
<span id="cb508-7"><a aria-hidden="true" href="#cb508-7" tabindex="-1"></a><span class="co">-- Toggle expanded output</span></span>
<span id="cb508-8"><a aria-hidden="true" href="#cb508-8" tabindex="-1"></a>\x</span>
<span id="cb508-9"><a aria-hidden="true" href="#cb508-9" tabindex="-1"></a></span>
<span id="cb508-10"><a aria-hidden="true" href="#cb508-10" tabindex="-1"></a><span class="co">-- Execute query with timing</span></span>
<span id="cb508-11"><a aria-hidden="true" href="#cb508-11" tabindex="-1"></a>\timing <span class="kw">on</span></span>
<span id="cb508-12"><a aria-hidden="true" href="#cb508-12" tabindex="-1"></a><span class="kw">SELECT</span> <span class="fu">COUNT</span>(<span class="op">*</span>) <span class="kw">FROM</span> large_table;</span>
<span id="cb508-13"><a aria-hidden="true" href="#cb508-13" tabindex="-1"></a></span>
<span id="cb508-14"><a aria-hidden="true" href="#cb508-14" tabindex="-1"></a><span class="co">-- Edit query in $EDITOR</span></span>
<span id="cb508-15"><a aria-hidden="true" href="#cb508-15" tabindex="-1"></a>\e</span>
<span id="cb508-16"><a aria-hidden="true" href="#cb508-16" tabindex="-1"></a></span>
<span id="cb508-17"><a aria-hidden="true" href="#cb508-17" tabindex="-1"></a><span class="co">-- Save query results to file</span></span>
<span id="cb508-18"><a aria-hidden="true" href="#cb508-18" tabindex="-1"></a>\o results.txt</span>
<span id="cb508-19"><a aria-hidden="true" href="#cb508-19" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> <span class="kw">data</span>;</span>
<span id="cb508-20"><a aria-hidden="true" href="#cb508-20" tabindex="-1"></a>\o</span>
<span id="cb508-21"><a aria-hidden="true" href="#cb508-21" tabindex="-1"></a></span>
<span id="cb508-22"><a aria-hidden="true" href="#cb508-22" tabindex="-1"></a><span class="co">-- Watch query (refresh every 2 seconds)</span></span>
<span id="cb508-23"><a aria-hidden="true" href="#cb508-23" tabindex="-1"></a><span class="kw">SELECT</span> <span class="fu">COUNT</span>(<span class="op">*</span>) <span class="kw">FROM</span> active_sessions \watch <span class="dv">2</span></span></code></pre></div>
<h3 data-number="9.3.6" id="backend-integration"><span class="header-section-number">9.3.6</span> 2.6 Backend Integration</h3>
<p>psql uses libpq exclusively for all server communication: - Single
connection per session - Synchronous query execution (with exception of
<code>\watch</code>) - Protocol-level features: prepared statements,
COPY protocol, pipeline mode - Meta-commands query system catalogs to
generate descriptions</p>
<h2 data-number="9.4" id="cluster-management"><span class="header-section-number">9.4</span> 3. Cluster Management</h2>
<h3 data-number="9.4.1" id="initdb---database-cluster-initialization"><span class="header-section-number">9.4.1</span> 3.1 initdb - Database Cluster
Initialization</h3>
<p><strong>Purpose</strong>: <code>initdb</code> creates a new
PostgreSQL database cluster (a collection of databases managed by a
single server instance).</p>
<p><strong>Key Source Files</strong>: -
<code>src/bin/initdb/initdb.c</code> - Complete initialization logic -
Embeds <code>postgres.bki</code> - System catalog bootstrap data - Uses
shared <code>findtimezone.c</code> for timezone detection</p>
<p><strong>Architecture</strong>:</p>
<p>From source comments:</p>
<div class="sourceCode" id="cb509"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb509-1"><a aria-hidden="true" href="#cb509-1" tabindex="-1"></a><span class="co">/*</span></span>
<span id="cb509-2"><a aria-hidden="true" href="#cb509-2" tabindex="-1"></a><span class="co"> * initdb creates (initializes) a PostgreSQL database cluster (site,</span></span>
<span id="cb509-3"><a aria-hidden="true" href="#cb509-3" tabindex="-1"></a><span class="co"> * instance, installation, whatever).  A database cluster is a</span></span>
<span id="cb509-4"><a aria-hidden="true" href="#cb509-4" tabindex="-1"></a><span class="co"> * collection of PostgreSQL databases all managed by the same server.</span></span>
<span id="cb509-5"><a aria-hidden="true" href="#cb509-5" tabindex="-1"></a><span class="co"> *</span></span>
<span id="cb509-6"><a aria-hidden="true" href="#cb509-6" tabindex="-1"></a><span class="co"> * To create the database cluster, we create the directory that contains</span></span>
<span id="cb509-7"><a aria-hidden="true" href="#cb509-7" tabindex="-1"></a><span class="co"> * all its data, create the files that hold the global tables, create</span></span>
<span id="cb509-8"><a aria-hidden="true" href="#cb509-8" tabindex="-1"></a><span class="co"> * a few other control files for it, and create three databases: the</span></span>
<span id="cb509-9"><a aria-hidden="true" href="#cb509-9" tabindex="-1"></a><span class="co"> * template databases "template0" and "template1", and a default user</span></span>
<span id="cb509-10"><a aria-hidden="true" href="#cb509-10" tabindex="-1"></a><span class="co"> * database "postgres".</span></span>
<span id="cb509-11"><a aria-hidden="true" href="#cb509-11" tabindex="-1"></a><span class="co"> *</span></span>
<span id="cb509-12"><a aria-hidden="true" href="#cb509-12" tabindex="-1"></a><span class="co"> * The template databases are ordinary PostgreSQL databases.  template0</span></span>
<span id="cb509-13"><a aria-hidden="true" href="#cb509-13" tabindex="-1"></a><span class="co"> * is never supposed to change after initdb, whereas template1 can be</span></span>
<span id="cb509-14"><a aria-hidden="true" href="#cb509-14" tabindex="-1"></a><span class="co"> * changed to add site-local standard data.  Either one can be copied</span></span>
<span id="cb509-15"><a aria-hidden="true" href="#cb509-15" tabindex="-1"></a><span class="co"> * to produce a new database.</span></span>
<span id="cb509-16"><a aria-hidden="true" href="#cb509-16" tabindex="-1"></a><span class="co"> */</span></span></code></pre></div>
<p><strong>Initialization Process</strong>:</p>
<ol type="1">
<li><strong>Bootstrap Phase</strong>:
<ul>
<li>Run postgres in bootstrap mode</li>
<li>Load <code>postgres.bki</code> to create system catalogs</li>
<li>Create template1 database</li>
</ul></li>
<li><strong>Post-Bootstrap Phase</strong>:
<ul>
<li>Execute SQL scripts to populate catalogs</li>
<li>Install procedural languages</li>
<li>Create information_schema</li>
<li>Set up system views</li>
</ul></li>
<li><strong>Template Database Creation</strong>:
<ul>
<li>Copy template1 to create template0</li>
<li>Create default ‚Äúpostgres‚Äù database</li>
<li>Freeze template0 (make read-only template)</li>
</ul></li>
</ol>
<p><strong>Main Features</strong>:</p>
<ol type="1">
<li><strong>Authentication Configuration</strong>:
<ul>
<li>Support for various auth methods (trust, md5, scram-sha-256, peer,
ident)</li>
<li>Configurable via <code>--auth</code>, <code>--auth-host</code>,
<code>--auth-local</code></li>
<li>Generates <code>pg_hba.conf</code></li>
</ul></li>
<li><strong>Locale and Encoding</strong>:
<ul>
<li>Database locale (<code>--locale</code>)</li>
<li>Character encoding (<code>--encoding</code>)</li>
<li>ICU locale support (<code>--icu-locale</code>)</li>
<li>Collation settings</li>
</ul></li>
<li><strong>Data Checksums</strong>:
<ul>
<li>Optional page-level checksums (<code>--data-checksums</code>)</li>
<li>Cannot be changed after initialization</li>
</ul></li>
<li><strong>WAL Configuration</strong>:
<ul>
<li>WAL segment size (<code>--wal-segsize</code>, default 16MB)</li>
<li>Set at initialization, cannot change without rebuild</li>
</ul></li>
</ol>
<p><strong>Usage Examples</strong>:</p>
<div class="sourceCode" id="cb510"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb510-1"><a aria-hidden="true" href="#cb510-1" tabindex="-1"></a><span class="co"># Basic initialization</span></span>
<span id="cb510-2"><a aria-hidden="true" href="#cb510-2" tabindex="-1"></a><span class="ex">initdb</span> <span class="at">-D</span> /var/lib/postgresql/data</span>
<span id="cb510-3"><a aria-hidden="true" href="#cb510-3" tabindex="-1"></a></span>
<span id="cb510-4"><a aria-hidden="true" href="#cb510-4" tabindex="-1"></a><span class="co"># With specific encoding and locale</span></span>
<span id="cb510-5"><a aria-hidden="true" href="#cb510-5" tabindex="-1"></a><span class="ex">initdb</span> <span class="at">-D</span> /data/pgdata <span class="at">--encoding</span><span class="op">=</span>UTF8 <span class="at">--locale</span><span class="op">=</span>en_US.UTF-8</span>
<span id="cb510-6"><a aria-hidden="true" href="#cb510-6" tabindex="-1"></a></span>
<span id="cb510-7"><a aria-hidden="true" href="#cb510-7" tabindex="-1"></a><span class="co"># Enable data checksums</span></span>
<span id="cb510-8"><a aria-hidden="true" href="#cb510-8" tabindex="-1"></a><span class="ex">initdb</span> <span class="at">-D</span> /data/pgdata <span class="at">--data-checksums</span></span>
<span id="cb510-9"><a aria-hidden="true" href="#cb510-9" tabindex="-1"></a></span>
<span id="cb510-10"><a aria-hidden="true" href="#cb510-10" tabindex="-1"></a><span class="co"># Custom WAL segment size (must be power of 2)</span></span>
<span id="cb510-11"><a aria-hidden="true" href="#cb510-11" tabindex="-1"></a><span class="ex">initdb</span> <span class="at">-D</span> /data/pgdata <span class="at">--wal-segsize</span><span class="op">=</span>32</span>
<span id="cb510-12"><a aria-hidden="true" href="#cb510-12" tabindex="-1"></a></span>
<span id="cb510-13"><a aria-hidden="true" href="#cb510-13" tabindex="-1"></a><span class="co"># Specific authentication</span></span>
<span id="cb510-14"><a aria-hidden="true" href="#cb510-14" tabindex="-1"></a><span class="ex">initdb</span> <span class="at">-D</span> /data/pgdata <span class="at">--auth</span><span class="op">=</span>scram-sha-256 <span class="at">--auth-host</span><span class="op">=</span>scram-sha-256</span>
<span id="cb510-15"><a aria-hidden="true" href="#cb510-15" tabindex="-1"></a></span>
<span id="cb510-16"><a aria-hidden="true" href="#cb510-16" tabindex="-1"></a><span class="co"># With ICU locale</span></span>
<span id="cb510-17"><a aria-hidden="true" href="#cb510-17" tabindex="-1"></a><span class="ex">initdb</span> <span class="at">-D</span> /data/pgdata <span class="at">--locale-provider</span><span class="op">=</span>icu <span class="at">--icu-locale</span><span class="op">=</span>en-US</span>
<span id="cb510-18"><a aria-hidden="true" href="#cb510-18" tabindex="-1"></a></span>
<span id="cb510-19"><a aria-hidden="true" href="#cb510-19" tabindex="-1"></a><span class="co"># Specify superuser</span></span>
<span id="cb510-20"><a aria-hidden="true" href="#cb510-20" tabindex="-1"></a><span class="ex">initdb</span> <span class="at">-D</span> /data/pgdata <span class="at">-U</span> postgres</span></code></pre></div>
<p><strong>Generated Directory Structure</strong>:</p>
<pre><code>pgdata/
‚îú‚îÄ‚îÄ base/           # Per-database subdirectories
‚îú‚îÄ‚îÄ global/         # Cluster-wide tables
‚îú‚îÄ‚îÄ pg_wal/         # WAL files
‚îú‚îÄ‚îÄ pg_xact/        # Transaction status
‚îú‚îÄ‚îÄ pg_multixact/   # MultiXact data
‚îú‚îÄ‚îÄ pg_commit_ts/   # Commit timestamps
‚îú‚îÄ‚îÄ pg_stat/        # Statistics
‚îú‚îÄ‚îÄ pg_tblspc/      # Tablespace links
‚îú‚îÄ‚îÄ postgresql.conf # Main configuration
‚îú‚îÄ‚îÄ pg_hba.conf    # Host-based authentication
‚îú‚îÄ‚îÄ pg_ident.conf  # User name mapping
‚îî‚îÄ‚îÄ PG_VERSION     # Version file</code></pre>
<h3 data-number="9.4.2" id="pg_ctl---postgresql-server-control"><span class="header-section-number">9.4.2</span> 3.2 pg_ctl - PostgreSQL
Server Control</h3>
<p><strong>Purpose</strong>: <code>pg_ctl</code> is a utility to start,
stop, restart, reload, and check the status of a PostgreSQL server.</p>
<p><strong>Key Source Files</strong>: -
<code>src/bin/pg_ctl/pg_ctl.c</code> - All control operations</p>
<p><strong>Architecture</strong>:</p>
<p><strong>Shutdown Modes</strong> (from source):</p>
<div class="sourceCode" id="cb512"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb512-1"><a aria-hidden="true" href="#cb512-1" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">enum</span></span>
<span id="cb512-2"><a aria-hidden="true" href="#cb512-2" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb512-3"><a aria-hidden="true" href="#cb512-3" tabindex="-1"></a>    SMART_MODE<span class="op">,</span>      <span class="co">// Wait for clients to disconnect</span></span>
<span id="cb512-4"><a aria-hidden="true" href="#cb512-4" tabindex="-1"></a>    FAST_MODE<span class="op">,</span>       <span class="co">// Disconnect clients, rollback transactions</span></span>
<span id="cb512-5"><a aria-hidden="true" href="#cb512-5" tabindex="-1"></a>    IMMEDIATE_MODE<span class="op">,</span>  <span class="co">// Abort without clean shutdown (requires crash recovery)</span></span>
<span id="cb512-6"><a aria-hidden="true" href="#cb512-6" tabindex="-1"></a><span class="op">}</span> ShutdownMode<span class="op">;</span></span></code></pre></div>
<p><strong>Commands</strong>:</p>
<div class="sourceCode" id="cb513"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb513-1"><a aria-hidden="true" href="#cb513-1" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">enum</span></span>
<span id="cb513-2"><a aria-hidden="true" href="#cb513-2" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb513-3"><a aria-hidden="true" href="#cb513-3" tabindex="-1"></a>    NO_COMMAND <span class="op">=</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb513-4"><a aria-hidden="true" href="#cb513-4" tabindex="-1"></a>    INIT_COMMAND<span class="op">,</span>       <span class="co">// Run initdb</span></span>
<span id="cb513-5"><a aria-hidden="true" href="#cb513-5" tabindex="-1"></a>    START_COMMAND<span class="op">,</span>      <span class="co">// Start server</span></span>
<span id="cb513-6"><a aria-hidden="true" href="#cb513-6" tabindex="-1"></a>    STOP_COMMAND<span class="op">,</span>       <span class="co">// Stop server</span></span>
<span id="cb513-7"><a aria-hidden="true" href="#cb513-7" tabindex="-1"></a>    RESTART_COMMAND<span class="op">,</span>    <span class="co">// Stop and start</span></span>
<span id="cb513-8"><a aria-hidden="true" href="#cb513-8" tabindex="-1"></a>    RELOAD_COMMAND<span class="op">,</span>     <span class="co">// SIGHUP (reload config)</span></span>
<span id="cb513-9"><a aria-hidden="true" href="#cb513-9" tabindex="-1"></a>    STATUS_COMMAND<span class="op">,</span>     <span class="co">// Check status</span></span>
<span id="cb513-10"><a aria-hidden="true" href="#cb513-10" tabindex="-1"></a>    PROMOTE_COMMAND<span class="op">,</span>    <span class="co">// Promote standby to primary</span></span>
<span id="cb513-11"><a aria-hidden="true" href="#cb513-11" tabindex="-1"></a>    LOGROTATE_COMMAND<span class="op">,</span>  <span class="co">// Rotate log file</span></span>
<span id="cb513-12"><a aria-hidden="true" href="#cb513-12" tabindex="-1"></a>    KILL_COMMAND<span class="op">,</span>       <span class="co">// Send signal to server</span></span>
<span id="cb513-13"><a aria-hidden="true" href="#cb513-13" tabindex="-1"></a><span class="op">}</span> CtlCommand<span class="op">;</span></span></code></pre></div>
<p><strong>Main Features</strong>:</p>
<ol type="1">
<li><strong>Server Lifecycle</strong>:
<ul>
<li>Start server with optional wait for readiness</li>
<li>Stop server with configurable shutdown mode</li>
<li>Restart server (stop + start)</li>
<li>Reload configuration without restart</li>
</ul></li>
<li><strong>Status Monitoring</strong>:
<ul>
<li>Check if server is running</li>
<li>Wait for server startup/shutdown</li>
<li>Configurable timeout</li>
</ul></li>
<li><strong>Promotion</strong>:
<ul>
<li>Promote standby server to primary</li>
<li>Creates <code>promote</code> trigger file</li>
</ul></li>
<li><strong>Log Management</strong>:
<ul>
<li>Specify log file location</li>
<li>Log rotation support</li>
</ul></li>
</ol>
<p><strong>Usage Examples</strong>:</p>
<div class="sourceCode" id="cb514"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb514-1"><a aria-hidden="true" href="#cb514-1" tabindex="-1"></a><span class="co"># Start PostgreSQL server</span></span>
<span id="cb514-2"><a aria-hidden="true" href="#cb514-2" tabindex="-1"></a><span class="ex">pg_ctl</span> <span class="at">-D</span> /var/lib/postgresql/data start</span>
<span id="cb514-3"><a aria-hidden="true" href="#cb514-3" tabindex="-1"></a></span>
<span id="cb514-4"><a aria-hidden="true" href="#cb514-4" tabindex="-1"></a><span class="co"># Start with specific log file</span></span>
<span id="cb514-5"><a aria-hidden="true" href="#cb514-5" tabindex="-1"></a><span class="ex">pg_ctl</span> <span class="at">-D</span> /data/pgdata <span class="at">-l</span> /var/log/postgresql.log start</span>
<span id="cb514-6"><a aria-hidden="true" href="#cb514-6" tabindex="-1"></a></span>
<span id="cb514-7"><a aria-hidden="true" href="#cb514-7" tabindex="-1"></a><span class="co"># Stop server (fast mode - default)</span></span>
<span id="cb514-8"><a aria-hidden="true" href="#cb514-8" tabindex="-1"></a><span class="ex">pg_ctl</span> <span class="at">-D</span> /data/pgdata stop</span>
<span id="cb514-9"><a aria-hidden="true" href="#cb514-9" tabindex="-1"></a></span>
<span id="cb514-10"><a aria-hidden="true" href="#cb514-10" tabindex="-1"></a><span class="co"># Stop with smart shutdown (wait for clients)</span></span>
<span id="cb514-11"><a aria-hidden="true" href="#cb514-11" tabindex="-1"></a><span class="ex">pg_ctl</span> <span class="at">-D</span> /data/pgdata stop <span class="at">-m</span> smart</span>
<span id="cb514-12"><a aria-hidden="true" href="#cb514-12" tabindex="-1"></a></span>
<span id="cb514-13"><a aria-hidden="true" href="#cb514-13" tabindex="-1"></a><span class="co"># Stop immediately (may require crash recovery)</span></span>
<span id="cb514-14"><a aria-hidden="true" href="#cb514-14" tabindex="-1"></a><span class="ex">pg_ctl</span> <span class="at">-D</span> /data/pgdata stop <span class="at">-m</span> immediate</span>
<span id="cb514-15"><a aria-hidden="true" href="#cb514-15" tabindex="-1"></a></span>
<span id="cb514-16"><a aria-hidden="true" href="#cb514-16" tabindex="-1"></a><span class="co"># Restart server</span></span>
<span id="cb514-17"><a aria-hidden="true" href="#cb514-17" tabindex="-1"></a><span class="ex">pg_ctl</span> <span class="at">-D</span> /data/pgdata restart</span>
<span id="cb514-18"><a aria-hidden="true" href="#cb514-18" tabindex="-1"></a></span>
<span id="cb514-19"><a aria-hidden="true" href="#cb514-19" tabindex="-1"></a><span class="co"># Reload configuration</span></span>
<span id="cb514-20"><a aria-hidden="true" href="#cb514-20" tabindex="-1"></a><span class="ex">pg_ctl</span> <span class="at">-D</span> /data/pgdata reload</span>
<span id="cb514-21"><a aria-hidden="true" href="#cb514-21" tabindex="-1"></a></span>
<span id="cb514-22"><a aria-hidden="true" href="#cb514-22" tabindex="-1"></a><span class="co"># Check status</span></span>
<span id="cb514-23"><a aria-hidden="true" href="#cb514-23" tabindex="-1"></a><span class="ex">pg_ctl</span> <span class="at">-D</span> /data/pgdata status</span>
<span id="cb514-24"><a aria-hidden="true" href="#cb514-24" tabindex="-1"></a></span>
<span id="cb514-25"><a aria-hidden="true" href="#cb514-25" tabindex="-1"></a><span class="co"># Promote standby to primary</span></span>
<span id="cb514-26"><a aria-hidden="true" href="#cb514-26" tabindex="-1"></a><span class="ex">pg_ctl</span> <span class="at">-D</span> /data/pgdata promote</span>
<span id="cb514-27"><a aria-hidden="true" href="#cb514-27" tabindex="-1"></a></span>
<span id="cb514-28"><a aria-hidden="true" href="#cb514-28" tabindex="-1"></a><span class="co"># Start and wait for server ready (30 second timeout)</span></span>
<span id="cb514-29"><a aria-hidden="true" href="#cb514-29" tabindex="-1"></a><span class="ex">pg_ctl</span> <span class="at">-D</span> /data/pgdata <span class="at">-w</span> <span class="at">-t</span> 30 start</span>
<span id="cb514-30"><a aria-hidden="true" href="#cb514-30" tabindex="-1"></a></span>
<span id="cb514-31"><a aria-hidden="true" href="#cb514-31" tabindex="-1"></a><span class="co"># Rotate log file</span></span>
<span id="cb514-32"><a aria-hidden="true" href="#cb514-32" tabindex="-1"></a><span class="ex">pg_ctl</span> <span class="at">-D</span> /data/pgdata logrotate</span></code></pre></div>
<p><strong>Platform-Specific Features</strong>: -
<strong>Unix/Linux</strong>: Uses signals (SIGTERM, SIGINT, SIGQUIT) -
<strong>Windows</strong>: Service registration and management</p>
<p><strong>Integration with Backend</strong>: - Reads
<code>postmaster.pid</code> for process information - Reads
<code>pg_control</code> for cluster state - Creates trigger files for
promotion - Sends SIGHUP for configuration reload</p>
<h2 data-number="9.5" id="maintenance-tools"><span class="header-section-number">9.5</span> 4. Maintenance Tools</h2>
<p>PostgreSQL provides client-side wrappers around SQL maintenance
commands for convenient administration.</p>
<h3 data-number="9.5.1" id="vacuumdb---vacuum-database"><span class="header-section-number">9.5.1</span> 4.1 vacuumdb - Vacuum
Database</h3>
<p><strong>Purpose</strong>: Wrapper around the SQL <code>VACUUM</code>
command for reclaiming storage and updating statistics.</p>
<p><strong>Key Source Files</strong>: -
<code>src/bin/scripts/vacuumdb.c</code> - Main program -
<code>src/bin/scripts/vacuuming.c</code> - Vacuum operation logic -
<code>src/bin/scripts/vacuuming.h</code> - Shared definitions</p>
<p><strong>Main Features</strong>:</p>
<ol type="1">
<li><strong>Vacuum Operations</strong>:
<ul>
<li>Standard vacuum (reclaim space)</li>
<li>Full vacuum (reclaim and compact)</li>
<li>Analyze (update statistics)</li>
<li>Analyze-only (no vacuuming)</li>
</ul></li>
<li><strong>Parallel Processing</strong>:
<ul>
<li>Multiple parallel workers (<code>-j</code> option)</li>
<li>Per-table or per-database parallelization</li>
</ul></li>
<li><strong>Advanced Options</strong>:
<ul>
<li>Freeze tuples (aggressive freezing)</li>
<li>Skip locked tables</li>
<li>Disable page skipping</li>
<li>Index cleanup control</li>
<li>Process main/toast selectively</li>
</ul></li>
</ol>
<p><strong>Usage Examples</strong>:</p>
<div class="sourceCode" id="cb515"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb515-1"><a aria-hidden="true" href="#cb515-1" tabindex="-1"></a><span class="co"># Vacuum entire database</span></span>
<span id="cb515-2"><a aria-hidden="true" href="#cb515-2" tabindex="-1"></a><span class="ex">vacuumdb</span> mydb</span>
<span id="cb515-3"><a aria-hidden="true" href="#cb515-3" tabindex="-1"></a></span>
<span id="cb515-4"><a aria-hidden="true" href="#cb515-4" tabindex="-1"></a><span class="co"># Vacuum and analyze</span></span>
<span id="cb515-5"><a aria-hidden="true" href="#cb515-5" tabindex="-1"></a><span class="ex">vacuumdb</span> <span class="at">-z</span> mydb</span>
<span id="cb515-6"><a aria-hidden="true" href="#cb515-6" tabindex="-1"></a></span>
<span id="cb515-7"><a aria-hidden="true" href="#cb515-7" tabindex="-1"></a><span class="co"># Analyze only</span></span>
<span id="cb515-8"><a aria-hidden="true" href="#cb515-8" tabindex="-1"></a><span class="ex">vacuumdb</span> <span class="at">-Z</span> mydb</span>
<span id="cb515-9"><a aria-hidden="true" href="#cb515-9" tabindex="-1"></a></span>
<span id="cb515-10"><a aria-hidden="true" href="#cb515-10" tabindex="-1"></a><span class="co"># Full vacuum</span></span>
<span id="cb515-11"><a aria-hidden="true" href="#cb515-11" tabindex="-1"></a><span class="ex">vacuumdb</span> <span class="at">--full</span> mydb</span>
<span id="cb515-12"><a aria-hidden="true" href="#cb515-12" tabindex="-1"></a></span>
<span id="cb515-13"><a aria-hidden="true" href="#cb515-13" tabindex="-1"></a><span class="co"># All databases</span></span>
<span id="cb515-14"><a aria-hidden="true" href="#cb515-14" tabindex="-1"></a><span class="ex">vacuumdb</span> <span class="at">-a</span></span>
<span id="cb515-15"><a aria-hidden="true" href="#cb515-15" tabindex="-1"></a></span>
<span id="cb515-16"><a aria-hidden="true" href="#cb515-16" tabindex="-1"></a><span class="co"># Specific tables with parallel workers</span></span>
<span id="cb515-17"><a aria-hidden="true" href="#cb515-17" tabindex="-1"></a><span class="ex">vacuumdb</span> <span class="at">-t</span> users <span class="at">-t</span> orders <span class="at">-j</span> 4 mydb</span>
<span id="cb515-18"><a aria-hidden="true" href="#cb515-18" tabindex="-1"></a></span>
<span id="cb515-19"><a aria-hidden="true" href="#cb515-19" tabindex="-1"></a><span class="co"># Verbose output</span></span>
<span id="cb515-20"><a aria-hidden="true" href="#cb515-20" tabindex="-1"></a><span class="ex">vacuumdb</span> <span class="at">-v</span> mydb</span>
<span id="cb515-21"><a aria-hidden="true" href="#cb515-21" tabindex="-1"></a></span>
<span id="cb515-22"><a aria-hidden="true" href="#cb515-22" tabindex="-1"></a><span class="co"># Freeze tuples (aggressive)</span></span>
<span id="cb515-23"><a aria-hidden="true" href="#cb515-23" tabindex="-1"></a><span class="ex">vacuumdb</span> <span class="at">--freeze</span> mydb</span>
<span id="cb515-24"><a aria-hidden="true" href="#cb515-24" tabindex="-1"></a></span>
<span id="cb515-25"><a aria-hidden="true" href="#cb515-25" tabindex="-1"></a><span class="co"># Skip locked tables</span></span>
<span id="cb515-26"><a aria-hidden="true" href="#cb515-26" tabindex="-1"></a><span class="ex">vacuumdb</span> <span class="at">--skip-locked</span> <span class="at">-a</span></span>
<span id="cb515-27"><a aria-hidden="true" href="#cb515-27" tabindex="-1"></a></span>
<span id="cb515-28"><a aria-hidden="true" href="#cb515-28" tabindex="-1"></a><span class="co"># Minimum XID age threshold</span></span>
<span id="cb515-29"><a aria-hidden="true" href="#cb515-29" tabindex="-1"></a><span class="ex">vacuumdb</span> <span class="at">--min-xid-age</span> 1000000 mydb</span>
<span id="cb515-30"><a aria-hidden="true" href="#cb515-30" tabindex="-1"></a></span>
<span id="cb515-31"><a aria-hidden="true" href="#cb515-31" tabindex="-1"></a><span class="co"># Analyze in stages (for minimal disruption)</span></span>
<span id="cb515-32"><a aria-hidden="true" href="#cb515-32" tabindex="-1"></a><span class="ex">vacuumdb</span> <span class="at">--analyze-in-stages</span> mydb</span>
<span id="cb515-33"><a aria-hidden="true" href="#cb515-33" tabindex="-1"></a></span>
<span id="cb515-34"><a aria-hidden="true" href="#cb515-34" tabindex="-1"></a><span class="co"># Disable index cleanup</span></span>
<span id="cb515-35"><a aria-hidden="true" href="#cb515-35" tabindex="-1"></a><span class="ex">vacuumdb</span> <span class="at">--no-index-cleanup</span> mydb</span>
<span id="cb515-36"><a aria-hidden="true" href="#cb515-36" tabindex="-1"></a></span>
<span id="cb515-37"><a aria-hidden="true" href="#cb515-37" tabindex="-1"></a><span class="co"># Specific schema</span></span>
<span id="cb515-38"><a aria-hidden="true" href="#cb515-38" tabindex="-1"></a><span class="ex">vacuumdb</span> <span class="at">-n</span> public mydb</span>
<span id="cb515-39"><a aria-hidden="true" href="#cb515-39" tabindex="-1"></a></span>
<span id="cb515-40"><a aria-hidden="true" href="#cb515-40" tabindex="-1"></a><span class="co"># Exclude schema</span></span>
<span id="cb515-41"><a aria-hidden="true" href="#cb515-41" tabindex="-1"></a><span class="ex">vacuumdb</span> <span class="at">-N</span> temp mydb</span></code></pre></div>
<p><strong>Backend Integration</strong>: - Executes SQL
<code>VACUUM</code> statements via libpq - Can use multiple database
connections for parallelism - Backend implementation:
<code>src/backend/commands/vacuum.c</code></p>
<h3 data-number="9.5.2" id="reindexdb---rebuild-indexes"><span class="header-section-number">9.5.2</span> 4.2 reindexdb - Rebuild
Indexes</h3>
<p><strong>Purpose</strong>: Wrapper around the SQL <code>REINDEX</code>
command for rebuilding indexes.</p>
<p><strong>Key Source Files</strong>: -
<code>src/bin/scripts/reindexdb.c</code> - Main logic</p>
<p><strong>Main Features</strong>:</p>
<ol type="1">
<li><strong>Reindex Targets</strong>:
<ul>
<li>Entire database</li>
<li>Specific schemas</li>
<li>Specific tables</li>
<li>Specific indexes</li>
<li>System catalogs only</li>
</ul></li>
<li><strong>Parallel Reindexing</strong>:
<ul>
<li>Multiple parallel connections</li>
<li>Table-level parallelism</li>
</ul></li>
<li><strong>Concurrent Reindex</strong>:
<ul>
<li>CONCURRENTLY option (minimal locking)</li>
<li>Safe for production systems</li>
</ul></li>
</ol>
<p><strong>Usage Examples</strong>:</p>
<div class="sourceCode" id="cb516"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb516-1"><a aria-hidden="true" href="#cb516-1" tabindex="-1"></a><span class="co"># Reindex entire database</span></span>
<span id="cb516-2"><a aria-hidden="true" href="#cb516-2" tabindex="-1"></a><span class="ex">reindexdb</span> mydb</span>
<span id="cb516-3"><a aria-hidden="true" href="#cb516-3" tabindex="-1"></a></span>
<span id="cb516-4"><a aria-hidden="true" href="#cb516-4" tabindex="-1"></a><span class="co"># Reindex system catalogs</span></span>
<span id="cb516-5"><a aria-hidden="true" href="#cb516-5" tabindex="-1"></a><span class="ex">reindexdb</span> <span class="at">--system</span> mydb</span>
<span id="cb516-6"><a aria-hidden="true" href="#cb516-6" tabindex="-1"></a></span>
<span id="cb516-7"><a aria-hidden="true" href="#cb516-7" tabindex="-1"></a><span class="co"># Reindex specific table</span></span>
<span id="cb516-8"><a aria-hidden="true" href="#cb516-8" tabindex="-1"></a><span class="ex">reindexdb</span> <span class="at">-t</span> users mydb</span>
<span id="cb516-9"><a aria-hidden="true" href="#cb516-9" tabindex="-1"></a></span>
<span id="cb516-10"><a aria-hidden="true" href="#cb516-10" tabindex="-1"></a><span class="co"># Reindex specific index</span></span>
<span id="cb516-11"><a aria-hidden="true" href="#cb516-11" tabindex="-1"></a><span class="ex">reindexdb</span> <span class="at">-i</span> users_pkey mydb</span>
<span id="cb516-12"><a aria-hidden="true" href="#cb516-12" tabindex="-1"></a></span>
<span id="cb516-13"><a aria-hidden="true" href="#cb516-13" tabindex="-1"></a><span class="co"># Concurrent reindex (minimal locking)</span></span>
<span id="cb516-14"><a aria-hidden="true" href="#cb516-14" tabindex="-1"></a><span class="ex">reindexdb</span> <span class="at">--concurrently</span> <span class="at">-t</span> large_table mydb</span>
<span id="cb516-15"><a aria-hidden="true" href="#cb516-15" tabindex="-1"></a></span>
<span id="cb516-16"><a aria-hidden="true" href="#cb516-16" tabindex="-1"></a><span class="co"># All databases</span></span>
<span id="cb516-17"><a aria-hidden="true" href="#cb516-17" tabindex="-1"></a><span class="ex">reindexdb</span> <span class="at">-a</span></span>
<span id="cb516-18"><a aria-hidden="true" href="#cb516-18" tabindex="-1"></a></span>
<span id="cb516-19"><a aria-hidden="true" href="#cb516-19" tabindex="-1"></a><span class="co"># Parallel reindex</span></span>
<span id="cb516-20"><a aria-hidden="true" href="#cb516-20" tabindex="-1"></a><span class="ex">reindexdb</span> <span class="at">-j</span> 4 mydb</span>
<span id="cb516-21"><a aria-hidden="true" href="#cb516-21" tabindex="-1"></a></span>
<span id="cb516-22"><a aria-hidden="true" href="#cb516-22" tabindex="-1"></a><span class="co"># Specific schema</span></span>
<span id="cb516-23"><a aria-hidden="true" href="#cb516-23" tabindex="-1"></a><span class="ex">reindexdb</span> <span class="at">-S</span> public mydb</span>
<span id="cb516-24"><a aria-hidden="true" href="#cb516-24" tabindex="-1"></a></span>
<span id="cb516-25"><a aria-hidden="true" href="#cb516-25" tabindex="-1"></a><span class="co"># With tablespace relocation</span></span>
<span id="cb516-26"><a aria-hidden="true" href="#cb516-26" tabindex="-1"></a><span class="ex">reindexdb</span> <span class="at">--tablespace</span> fast_ssd <span class="at">-t</span> hot_table mydb</span></code></pre></div>
<h3 data-number="9.5.3" id="clusterdb---cluster-tables"><span class="header-section-number">9.5.3</span> 4.3 clusterdb - Cluster
Tables</h3>
<p><strong>Purpose</strong>: Wrapper around the SQL <code>CLUSTER</code>
command for reordering table data based on an index.</p>
<p><strong>Key Source Files</strong>: -
<code>src/bin/scripts/clusterdb.c</code> - Implementation</p>
<p><strong>Main Features</strong>:</p>
<ol type="1">
<li><strong>Table Clustering</strong>:
<ul>
<li>Reorder table data to match index order</li>
<li>Improves sequential scan performance</li>
<li>Requires table rewrite</li>
</ul></li>
<li><strong>Selective Clustering</strong>:
<ul>
<li>Specific tables only</li>
<li>All previously clustered tables</li>
<li>Entire database</li>
</ul></li>
</ol>
<p><strong>Usage Examples</strong>:</p>
<div class="sourceCode" id="cb517"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb517-1"><a aria-hidden="true" href="#cb517-1" tabindex="-1"></a><span class="co"># Cluster entire database</span></span>
<span id="cb517-2"><a aria-hidden="true" href="#cb517-2" tabindex="-1"></a><span class="ex">clusterdb</span> mydb</span>
<span id="cb517-3"><a aria-hidden="true" href="#cb517-3" tabindex="-1"></a></span>
<span id="cb517-4"><a aria-hidden="true" href="#cb517-4" tabindex="-1"></a><span class="co"># Cluster specific table</span></span>
<span id="cb517-5"><a aria-hidden="true" href="#cb517-5" tabindex="-1"></a><span class="ex">clusterdb</span> <span class="at">-t</span> users mydb</span>
<span id="cb517-6"><a aria-hidden="true" href="#cb517-6" tabindex="-1"></a></span>
<span id="cb517-7"><a aria-hidden="true" href="#cb517-7" tabindex="-1"></a><span class="co"># Cluster multiple tables</span></span>
<span id="cb517-8"><a aria-hidden="true" href="#cb517-8" tabindex="-1"></a><span class="ex">clusterdb</span> <span class="at">-t</span> users <span class="at">-t</span> orders mydb</span>
<span id="cb517-9"><a aria-hidden="true" href="#cb517-9" tabindex="-1"></a></span>
<span id="cb517-10"><a aria-hidden="true" href="#cb517-10" tabindex="-1"></a><span class="co"># All databases</span></span>
<span id="cb517-11"><a aria-hidden="true" href="#cb517-11" tabindex="-1"></a><span class="ex">clusterdb</span> <span class="at">-a</span></span>
<span id="cb517-12"><a aria-hidden="true" href="#cb517-12" tabindex="-1"></a></span>
<span id="cb517-13"><a aria-hidden="true" href="#cb517-13" tabindex="-1"></a><span class="co"># Verbose output</span></span>
<span id="cb517-14"><a aria-hidden="true" href="#cb517-14" tabindex="-1"></a><span class="ex">clusterdb</span> <span class="at">-v</span> mydb</span></code></pre></div>
<h3 data-number="9.5.4" id="convenience-databaseuser-management-tools"><span class="header-section-number">9.5.4</span> 4.4 Convenience Database/User
Management Tools</h3>
<p><strong>createdb</strong> - Create a database:</p>
<div class="sourceCode" id="cb518"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb518-1"><a aria-hidden="true" href="#cb518-1" tabindex="-1"></a><span class="co"># Create database</span></span>
<span id="cb518-2"><a aria-hidden="true" href="#cb518-2" tabindex="-1"></a><span class="ex">createdb</span> newdb</span>
<span id="cb518-3"><a aria-hidden="true" href="#cb518-3" tabindex="-1"></a></span>
<span id="cb518-4"><a aria-hidden="true" href="#cb518-4" tabindex="-1"></a><span class="co"># With owner and template</span></span>
<span id="cb518-5"><a aria-hidden="true" href="#cb518-5" tabindex="-1"></a><span class="ex">createdb</span> <span class="at">-O</span> owner <span class="at">-T</span> template0 newdb</span>
<span id="cb518-6"><a aria-hidden="true" href="#cb518-6" tabindex="-1"></a></span>
<span id="cb518-7"><a aria-hidden="true" href="#cb518-7" tabindex="-1"></a><span class="co"># With encoding and locale</span></span>
<span id="cb518-8"><a aria-hidden="true" href="#cb518-8" tabindex="-1"></a><span class="ex">createdb</span> <span class="at">-E</span> UTF8 <span class="at">-l</span> en_US.UTF-8 newdb</span></code></pre></div>
<p><strong>dropdb</strong> - Remove a database:</p>
<div class="sourceCode" id="cb519"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb519-1"><a aria-hidden="true" href="#cb519-1" tabindex="-1"></a><span class="co"># Drop database</span></span>
<span id="cb519-2"><a aria-hidden="true" href="#cb519-2" tabindex="-1"></a><span class="ex">dropdb</span> olddb</span>
<span id="cb519-3"><a aria-hidden="true" href="#cb519-3" tabindex="-1"></a></span>
<span id="cb519-4"><a aria-hidden="true" href="#cb519-4" tabindex="-1"></a><span class="co"># With confirmation prompt</span></span>
<span id="cb519-5"><a aria-hidden="true" href="#cb519-5" tabindex="-1"></a><span class="ex">dropdb</span> <span class="at">-i</span> olddb</span>
<span id="cb519-6"><a aria-hidden="true" href="#cb519-6" tabindex="-1"></a></span>
<span id="cb519-7"><a aria-hidden="true" href="#cb519-7" tabindex="-1"></a><span class="co"># Force drop (disconnect users)</span></span>
<span id="cb519-8"><a aria-hidden="true" href="#cb519-8" tabindex="-1"></a><span class="ex">dropdb</span> <span class="at">--force</span> olddb</span></code></pre></div>
<p><strong>createuser</strong> - Create a role:</p>
<div class="sourceCode" id="cb520"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb520-1"><a aria-hidden="true" href="#cb520-1" tabindex="-1"></a><span class="co"># Create user</span></span>
<span id="cb520-2"><a aria-hidden="true" href="#cb520-2" tabindex="-1"></a><span class="ex">createuser</span> newuser</span>
<span id="cb520-3"><a aria-hidden="true" href="#cb520-3" tabindex="-1"></a></span>
<span id="cb520-4"><a aria-hidden="true" href="#cb520-4" tabindex="-1"></a><span class="co"># Create superuser</span></span>
<span id="cb520-5"><a aria-hidden="true" href="#cb520-5" tabindex="-1"></a><span class="ex">createuser</span> <span class="at">-s</span> admin</span>
<span id="cb520-6"><a aria-hidden="true" href="#cb520-6" tabindex="-1"></a></span>
<span id="cb520-7"><a aria-hidden="true" href="#cb520-7" tabindex="-1"></a><span class="co"># Create user with login and password prompt</span></span>
<span id="cb520-8"><a aria-hidden="true" href="#cb520-8" tabindex="-1"></a><span class="ex">createuser</span> <span class="at">-l</span> <span class="at">-P</span> appuser</span>
<span id="cb520-9"><a aria-hidden="true" href="#cb520-9" tabindex="-1"></a></span>
<span id="cb520-10"><a aria-hidden="true" href="#cb520-10" tabindex="-1"></a><span class="co"># Create role with specific privileges</span></span>
<span id="cb520-11"><a aria-hidden="true" href="#cb520-11" tabindex="-1"></a><span class="ex">createuser</span> <span class="at">-d</span> <span class="at">-r</span> <span class="at">-l</span> dbadmin</span></code></pre></div>
<p><strong>dropuser</strong> - Remove a role:</p>
<div class="sourceCode" id="cb521"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb521-1"><a aria-hidden="true" href="#cb521-1" tabindex="-1"></a><span class="co"># Drop user</span></span>
<span id="cb521-2"><a aria-hidden="true" href="#cb521-2" tabindex="-1"></a><span class="ex">dropuser</span> olduser</span>
<span id="cb521-3"><a aria-hidden="true" href="#cb521-3" tabindex="-1"></a></span>
<span id="cb521-4"><a aria-hidden="true" href="#cb521-4" tabindex="-1"></a><span class="co"># With confirmation</span></span>
<span id="cb521-5"><a aria-hidden="true" href="#cb521-5" tabindex="-1"></a><span class="ex">dropuser</span> <span class="at">-i</span> olduser</span></code></pre></div>
<p><strong>pg_isready</strong> - Check server availability:</p>
<div class="sourceCode" id="cb522"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb522-1"><a aria-hidden="true" href="#cb522-1" tabindex="-1"></a><span class="co"># Check local server</span></span>
<span id="cb522-2"><a aria-hidden="true" href="#cb522-2" tabindex="-1"></a><span class="ex">pg_isready</span></span>
<span id="cb522-3"><a aria-hidden="true" href="#cb522-3" tabindex="-1"></a></span>
<span id="cb522-4"><a aria-hidden="true" href="#cb522-4" tabindex="-1"></a><span class="co"># Check remote server</span></span>
<span id="cb522-5"><a aria-hidden="true" href="#cb522-5" tabindex="-1"></a><span class="ex">pg_isready</span> <span class="at">-h</span> db.example.com <span class="at">-p</span> 5432</span>
<span id="cb522-6"><a aria-hidden="true" href="#cb522-6" tabindex="-1"></a></span>
<span id="cb522-7"><a aria-hidden="true" href="#cb522-7" tabindex="-1"></a><span class="co"># Use in scripts (exit code indicates status)</span></span>
<span id="cb522-8"><a aria-hidden="true" href="#cb522-8" tabindex="-1"></a><span class="cf">if</span> <span class="ex">pg_isready</span> <span class="at">-q</span><span class="kw">;</span> <span class="cf">then</span></span>
<span id="cb522-9"><a aria-hidden="true" href="#cb522-9" tabindex="-1"></a>  <span class="bu">echo</span> <span class="st">"Server ready"</span></span>
<span id="cb522-10"><a aria-hidden="true" href="#cb522-10" tabindex="-1"></a><span class="cf">fi</span></span></code></pre></div>
<h2 data-number="9.6" id="administrative-tools"><span class="header-section-number">9.6</span> 5. Administrative Tools</h2>
<h3 data-number="9.6.1" id="pg_upgrade---in-place-major-version-upgrade"><span class="header-section-number">9.6.1</span> 5.1 pg_upgrade - In-Place
Major Version Upgrade</h3>
<p><strong>Purpose</strong>: <code>pg_upgrade</code> upgrades a
PostgreSQL cluster to a new major version without dumping and reloading
data.</p>
<p><strong>Key Source Files</strong>: -
<code>src/bin/pg_upgrade/pg_upgrade.c</code> - Main upgrade logic -
<code>src/bin/pg_upgrade/check.c</code> - Pre-upgrade checks -
<code>src/bin/pg_upgrade/relfilenode.c</code> - File layout management -
<code>src/bin/pg_upgrade/tablespace.c</code> - Tablespace handling -
<code>src/bin/pg_upgrade/version.c</code> - Version-specific handling -
<code>src/bin/pg_upgrade/pg_upgrade.h</code> - Data structures</p>
<p><strong>Architecture</strong>:</p>
<p>From source comments:</p>
<div class="sourceCode" id="cb523"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb523-1"><a aria-hidden="true" href="#cb523-1" tabindex="-1"></a><span class="co">/*</span></span>
<span id="cb523-2"><a aria-hidden="true" href="#cb523-2" tabindex="-1"></a><span class="co"> * To simplify the upgrade process, we force certain system values to be</span></span>
<span id="cb523-3"><a aria-hidden="true" href="#cb523-3" tabindex="-1"></a><span class="co"> * identical between old and new clusters:</span></span>
<span id="cb523-4"><a aria-hidden="true" href="#cb523-4" tabindex="-1"></a><span class="co"> *</span></span>
<span id="cb523-5"><a aria-hidden="true" href="#cb523-5" tabindex="-1"></a><span class="co"> * We control all assignments of pg_class.oid (and relfilenode) so toast</span></span>
<span id="cb523-6"><a aria-hidden="true" href="#cb523-6" tabindex="-1"></a><span class="co"> * oids are the same between old and new clusters.  This is important</span></span>
<span id="cb523-7"><a aria-hidden="true" href="#cb523-7" tabindex="-1"></a><span class="co"> * because toast oids are stored as toast pointers in user tables.</span></span>
<span id="cb523-8"><a aria-hidden="true" href="#cb523-8" tabindex="-1"></a><span class="co"> *</span></span>
<span id="cb523-9"><a aria-hidden="true" href="#cb523-9" tabindex="-1"></a><span class="co"> * We control assignments of pg_class.relfilenode because we want the</span></span>
<span id="cb523-10"><a aria-hidden="true" href="#cb523-10" tabindex="-1"></a><span class="co"> * filenames to match between the old and new cluster.</span></span>
<span id="cb523-11"><a aria-hidden="true" href="#cb523-11" tabindex="-1"></a><span class="co"> *</span></span>
<span id="cb523-12"><a aria-hidden="true" href="#cb523-12" tabindex="-1"></a><span class="co"> * We control assignment of pg_type.oid, pg_enum.oid, pg_authid.oid,</span></span>
<span id="cb523-13"><a aria-hidden="true" href="#cb523-13" tabindex="-1"></a><span class="co"> * and pg_database.oid for data consistency.</span></span>
<span id="cb523-14"><a aria-hidden="true" href="#cb523-14" tabindex="-1"></a><span class="co"> */</span></span></code></pre></div>
<p><strong>Upgrade Process</strong>:</p>
<ol type="1">
<li><strong>Pre-flight Checks</strong>:
<ul>
<li>Verify both clusters are valid</li>
<li>Check version compatibility</li>
<li>Verify no incompatible features</li>
<li>Check disk space availability</li>
</ul></li>
<li><strong>Schema Migration</strong>:
<ul>
<li>Dump old cluster schema with pg_dump</li>
<li>Create new cluster with initdb</li>
<li>Restore schema in new cluster</li>
<li>Preserve OIDs for critical objects</li>
</ul></li>
<li><strong>Data Migration</strong>:
<ul>
<li><strong>Link mode</strong> (<code>--link</code>): Hard links to
existing files (fast, but irreversible)</li>
<li><strong>Copy mode</strong> (default): Copy all data files
(safe)</li>
<li><strong>Clone mode</strong> (<code>--clone</code>): Copy-on-write
cloning on supported filesystems</li>
</ul></li>
<li><strong>Post-upgrade</strong>:
<ul>
<li>Update system catalogs</li>
<li>Generate optimizer statistics</li>
<li>Optional analyze script generation</li>
</ul></li>
</ol>
<p><strong>Main Features</strong>:</p>
<ol type="1">
<li><strong>Multiple Transfer Modes</strong>:
<ul>
<li>Copy (safest, slowest)</li>
<li>Link (fastest, irreversible)</li>
<li>Clone (best of both, requires filesystem support)</li>
</ul></li>
<li><strong>Parallel Processing</strong>:
<ul>
<li>Multiple jobs for schema dump/restore</li>
<li>Controlled via <code>-j</code> option</li>
</ul></li>
<li><strong>Safety Checks</strong>:
<ul>
<li>Extensive pre-upgrade validation</li>
<li>Rollback capability (except in link mode)</li>
<li>Detailed logging</li>
</ul></li>
</ol>
<p><strong>Usage Examples</strong>:</p>
<div class="sourceCode" id="cb524"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb524-1"><a aria-hidden="true" href="#cb524-1" tabindex="-1"></a><span class="co"># Check compatibility (dry run)</span></span>
<span id="cb524-2"><a aria-hidden="true" href="#cb524-2" tabindex="-1"></a><span class="ex">pg_upgrade</span> <span class="dt">\</span></span>
<span id="cb524-3"><a aria-hidden="true" href="#cb524-3" tabindex="-1"></a>  <span class="at">-b</span> /usr/lib/postgresql/14/bin <span class="dt">\</span></span>
<span id="cb524-4"><a aria-hidden="true" href="#cb524-4" tabindex="-1"></a>  <span class="at">-B</span> /usr/lib/postgresql/15/bin <span class="dt">\</span></span>
<span id="cb524-5"><a aria-hidden="true" href="#cb524-5" tabindex="-1"></a>  <span class="at">-d</span> /var/lib/postgresql/14/data <span class="dt">\</span></span>
<span id="cb524-6"><a aria-hidden="true" href="#cb524-6" tabindex="-1"></a>  <span class="at">-D</span> /var/lib/postgresql/15/data <span class="dt">\</span></span>
<span id="cb524-7"><a aria-hidden="true" href="#cb524-7" tabindex="-1"></a>  <span class="at">--check</span></span>
<span id="cb524-8"><a aria-hidden="true" href="#cb524-8" tabindex="-1"></a></span>
<span id="cb524-9"><a aria-hidden="true" href="#cb524-9" tabindex="-1"></a><span class="co"># Perform upgrade with link mode</span></span>
<span id="cb524-10"><a aria-hidden="true" href="#cb524-10" tabindex="-1"></a><span class="ex">pg_upgrade</span> <span class="dt">\</span></span>
<span id="cb524-11"><a aria-hidden="true" href="#cb524-11" tabindex="-1"></a>  <span class="at">-b</span> /usr/lib/postgresql/14/bin <span class="dt">\</span></span>
<span id="cb524-12"><a aria-hidden="true" href="#cb524-12" tabindex="-1"></a>  <span class="at">-B</span> /usr/lib/postgresql/15/bin <span class="dt">\</span></span>
<span id="cb524-13"><a aria-hidden="true" href="#cb524-13" tabindex="-1"></a>  <span class="at">-d</span> /var/lib/postgresql/14/data <span class="dt">\</span></span>
<span id="cb524-14"><a aria-hidden="true" href="#cb524-14" tabindex="-1"></a>  <span class="at">-D</span> /var/lib/postgresql/15/data <span class="dt">\</span></span>
<span id="cb524-15"><a aria-hidden="true" href="#cb524-15" tabindex="-1"></a>  <span class="at">--link</span></span>
<span id="cb524-16"><a aria-hidden="true" href="#cb524-16" tabindex="-1"></a></span>
<span id="cb524-17"><a aria-hidden="true" href="#cb524-17" tabindex="-1"></a><span class="co"># Upgrade with parallel jobs</span></span>
<span id="cb524-18"><a aria-hidden="true" href="#cb524-18" tabindex="-1"></a><span class="ex">pg_upgrade</span> <span class="dt">\</span></span>
<span id="cb524-19"><a aria-hidden="true" href="#cb524-19" tabindex="-1"></a>  <span class="at">-b</span> /old/bin <span class="dt">\</span></span>
<span id="cb524-20"><a aria-hidden="true" href="#cb524-20" tabindex="-1"></a>  <span class="at">-B</span> /new/bin <span class="dt">\</span></span>
<span id="cb524-21"><a aria-hidden="true" href="#cb524-21" tabindex="-1"></a>  <span class="at">-d</span> /old/data <span class="dt">\</span></span>
<span id="cb524-22"><a aria-hidden="true" href="#cb524-22" tabindex="-1"></a>  <span class="at">-D</span> /new/data <span class="dt">\</span></span>
<span id="cb524-23"><a aria-hidden="true" href="#cb524-23" tabindex="-1"></a>  <span class="at">-j</span> 4</span>
<span id="cb524-24"><a aria-hidden="true" href="#cb524-24" tabindex="-1"></a></span>
<span id="cb524-25"><a aria-hidden="true" href="#cb524-25" tabindex="-1"></a><span class="co"># Clone mode (requires supporting filesystem)</span></span>
<span id="cb524-26"><a aria-hidden="true" href="#cb524-26" tabindex="-1"></a><span class="ex">pg_upgrade</span> <span class="dt">\</span></span>
<span id="cb524-27"><a aria-hidden="true" href="#cb524-27" tabindex="-1"></a>  <span class="at">-b</span> /old/bin <span class="dt">\</span></span>
<span id="cb524-28"><a aria-hidden="true" href="#cb524-28" tabindex="-1"></a>  <span class="at">-B</span> /new/bin <span class="dt">\</span></span>
<span id="cb524-29"><a aria-hidden="true" href="#cb524-29" tabindex="-1"></a>  <span class="at">-d</span> /old/data <span class="dt">\</span></span>
<span id="cb524-30"><a aria-hidden="true" href="#cb524-30" tabindex="-1"></a>  <span class="at">-D</span> /new/data <span class="dt">\</span></span>
<span id="cb524-31"><a aria-hidden="true" href="#cb524-31" tabindex="-1"></a>  <span class="at">--clone</span></span>
<span id="cb524-32"><a aria-hidden="true" href="#cb524-32" tabindex="-1"></a></span>
<span id="cb524-33"><a aria-hidden="true" href="#cb524-33" tabindex="-1"></a><span class="co"># With specific user and port</span></span>
<span id="cb524-34"><a aria-hidden="true" href="#cb524-34" tabindex="-1"></a><span class="ex">pg_upgrade</span> <span class="dt">\</span></span>
<span id="cb524-35"><a aria-hidden="true" href="#cb524-35" tabindex="-1"></a>  <span class="at">-b</span> /old/bin <span class="at">-B</span> /new/bin <span class="dt">\</span></span>
<span id="cb524-36"><a aria-hidden="true" href="#cb524-36" tabindex="-1"></a>  <span class="at">-d</span> /old/data <span class="at">-D</span> /new/data <span class="dt">\</span></span>
<span id="cb524-37"><a aria-hidden="true" href="#cb524-37" tabindex="-1"></a>  <span class="at">-U</span> postgres <span class="dt">\</span></span>
<span id="cb524-38"><a aria-hidden="true" href="#cb524-38" tabindex="-1"></a>  <span class="at">-p</span> 5432 <span class="at">-P</span> 5433</span></code></pre></div>
<p><strong>Post-Upgrade Steps</strong>:</p>
<div class="sourceCode" id="cb525"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb525-1"><a aria-hidden="true" href="#cb525-1" tabindex="-1"></a><span class="co"># Run the generated analysis script</span></span>
<span id="cb525-2"><a aria-hidden="true" href="#cb525-2" tabindex="-1"></a><span class="ex">./analyze_new_cluster.sh</span></span>
<span id="cb525-3"><a aria-hidden="true" href="#cb525-3" tabindex="-1"></a></span>
<span id="cb525-4"><a aria-hidden="true" href="#cb525-4" tabindex="-1"></a><span class="co"># Start new cluster</span></span>
<span id="cb525-5"><a aria-hidden="true" href="#cb525-5" tabindex="-1"></a><span class="ex">pg_ctl</span> <span class="at">-D</span> /new/data start</span>
<span id="cb525-6"><a aria-hidden="true" href="#cb525-6" tabindex="-1"></a></span>
<span id="cb525-7"><a aria-hidden="true" href="#cb525-7" tabindex="-1"></a><span class="co"># After verification, remove old cluster</span></span>
<span id="cb525-8"><a aria-hidden="true" href="#cb525-8" tabindex="-1"></a><span class="ex">./delete_old_cluster.sh</span></span></code></pre></div>
<h3 data-number="9.6.2" id="pg_resetwal---reset-write-ahead-log"><span class="header-section-number">9.6.2</span> 5.2 pg_resetwal - Reset
Write-Ahead Log</h3>
<p><strong>Purpose</strong>: <code>pg_resetwal</code> clears the WAL and
optionally resets transaction log status. This is a last-resort recovery
tool for corrupted clusters.</p>
<p><strong>Key Source Files</strong>: -
<code>src/bin/pg_resetwal/pg_resetwal.c</code> - Complete
implementation</p>
<p><strong>Architecture</strong>:</p>
<p>From source comments:</p>
<div class="sourceCode" id="cb526"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb526-1"><a aria-hidden="true" href="#cb526-1" tabindex="-1"></a><span class="co">/*</span></span>
<span id="cb526-2"><a aria-hidden="true" href="#cb526-2" tabindex="-1"></a><span class="co"> * The theory of operation is fairly simple:</span></span>
<span id="cb526-3"><a aria-hidden="true" href="#cb526-3" tabindex="-1"></a><span class="co"> *  1. Read the existing pg_control (which will include the last</span></span>
<span id="cb526-4"><a aria-hidden="true" href="#cb526-4" tabindex="-1"></a><span class="co"> *     checkpoint record).</span></span>
<span id="cb526-5"><a aria-hidden="true" href="#cb526-5" tabindex="-1"></a><span class="co"> *  2. If pg_control is corrupt, attempt to intuit reasonable values,</span></span>
<span id="cb526-6"><a aria-hidden="true" href="#cb526-6" tabindex="-1"></a><span class="co"> *     by scanning the old xlog if necessary.</span></span>
<span id="cb526-7"><a aria-hidden="true" href="#cb526-7" tabindex="-1"></a><span class="co"> *  3. Modify pg_control to reflect a "shutdown" state with a checkpoint</span></span>
<span id="cb526-8"><a aria-hidden="true" href="#cb526-8" tabindex="-1"></a><span class="co"> *     record at the start of xlog.</span></span>
<span id="cb526-9"><a aria-hidden="true" href="#cb526-9" tabindex="-1"></a><span class="co"> *  4. Flush the existing xlog files and write a new segment with</span></span>
<span id="cb526-10"><a aria-hidden="true" href="#cb526-10" tabindex="-1"></a><span class="co"> *     just a checkpoint record in it.  The new segment is positioned</span></span>
<span id="cb526-11"><a aria-hidden="true" href="#cb526-11" tabindex="-1"></a><span class="co"> *     just past the end of the old xlog, so that existing LSNs in</span></span>
<span id="cb526-12"><a aria-hidden="true" href="#cb526-12" tabindex="-1"></a><span class="co"> *     data pages will appear to be "in the past".</span></span>
<span id="cb526-13"><a aria-hidden="true" href="#cb526-13" tabindex="-1"></a><span class="co"> */</span></span></code></pre></div>
<p><strong>WARNING</strong>: This tool can cause <strong>irreversible
data loss</strong>. Only use when: - Cluster cannot start due to
corrupted WAL - All other recovery options exhausted - Data loss is
acceptable vs.¬†total cluster loss</p>
<p><strong>Main Features</strong>:</p>
<ol type="1">
<li><strong>WAL Reset</strong>:
<ul>
<li>Clear existing WAL files</li>
<li>Create new clean WAL segment</li>
<li>Reset transaction IDs</li>
</ul></li>
<li><strong>Manual Control Override</strong>:
<ul>
<li>Set next transaction ID (<code>-x</code>)</li>
<li>Set next OID (<code>-o</code>)</li>
<li>Set next multixact ID (<code>-m</code>)</li>
<li>Set WAL segment size</li>
</ul></li>
<li><strong>Force Options</strong>:
<ul>
<li>Force operation even with running server (dangerous)</li>
<li>Override safety checks</li>
</ul></li>
</ol>
<p><strong>Usage Examples</strong>:</p>
<div class="sourceCode" id="cb527"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb527-1"><a aria-hidden="true" href="#cb527-1" tabindex="-1"></a><span class="co"># Basic WAL reset (interactive confirmation)</span></span>
<span id="cb527-2"><a aria-hidden="true" href="#cb527-2" tabindex="-1"></a><span class="ex">pg_resetwal</span> /var/lib/postgresql/data</span>
<span id="cb527-3"><a aria-hidden="true" href="#cb527-3" tabindex="-1"></a></span>
<span id="cb527-4"><a aria-hidden="true" href="#cb527-4" tabindex="-1"></a><span class="co"># Non-interactive mode</span></span>
<span id="cb527-5"><a aria-hidden="true" href="#cb527-5" tabindex="-1"></a><span class="ex">pg_resetwal</span> <span class="at">-f</span> /var/lib/postgresql/data</span>
<span id="cb527-6"><a aria-hidden="true" href="#cb527-6" tabindex="-1"></a></span>
<span id="cb527-7"><a aria-hidden="true" href="#cb527-7" tabindex="-1"></a><span class="co"># Dry run (show values, no changes)</span></span>
<span id="cb527-8"><a aria-hidden="true" href="#cb527-8" tabindex="-1"></a><span class="ex">pg_resetwal</span> <span class="at">-n</span> /var/lib/postgresql/data</span>
<span id="cb527-9"><a aria-hidden="true" href="#cb527-9" tabindex="-1"></a></span>
<span id="cb527-10"><a aria-hidden="true" href="#cb527-10" tabindex="-1"></a><span class="co"># Set specific transaction ID</span></span>
<span id="cb527-11"><a aria-hidden="true" href="#cb527-11" tabindex="-1"></a><span class="ex">pg_resetwal</span> <span class="at">-x</span> 1000000 /var/lib/postgresql/data</span>
<span id="cb527-12"><a aria-hidden="true" href="#cb527-12" tabindex="-1"></a></span>
<span id="cb527-13"><a aria-hidden="true" href="#cb527-13" tabindex="-1"></a><span class="co"># Set specific OID</span></span>
<span id="cb527-14"><a aria-hidden="true" href="#cb527-14" tabindex="-1"></a><span class="ex">pg_resetwal</span> <span class="at">-o</span> 100000 /var/lib/postgresql/data</span>
<span id="cb527-15"><a aria-hidden="true" href="#cb527-15" tabindex="-1"></a></span>
<span id="cb527-16"><a aria-hidden="true" href="#cb527-16" tabindex="-1"></a><span class="co"># Set specific multixact ID</span></span>
<span id="cb527-17"><a aria-hidden="true" href="#cb527-17" tabindex="-1"></a><span class="ex">pg_resetwal</span> <span class="at">-m</span> 1000 /var/lib/postgresql/data</span>
<span id="cb527-18"><a aria-hidden="true" href="#cb527-18" tabindex="-1"></a></span>
<span id="cb527-19"><a aria-hidden="true" href="#cb527-19" tabindex="-1"></a><span class="co"># Set WAL segment size (dangerous, must match data directory)</span></span>
<span id="cb527-20"><a aria-hidden="true" href="#cb527-20" tabindex="-1"></a><span class="ex">pg_resetwal</span> <span class="at">--wal-segsize</span><span class="op">=</span>32 /var/lib/postgresql/data</span></code></pre></div>
<p><strong>Recovery Scenario</strong>:</p>
<div class="sourceCode" id="cb528"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb528-1"><a aria-hidden="true" href="#cb528-1" tabindex="-1"></a><span class="co"># 1. Stop server</span></span>
<span id="cb528-2"><a aria-hidden="true" href="#cb528-2" tabindex="-1"></a><span class="ex">pg_ctl</span> <span class="at">-D</span> /data stop <span class="at">-m</span> immediate</span>
<span id="cb528-3"><a aria-hidden="true" href="#cb528-3" tabindex="-1"></a></span>
<span id="cb528-4"><a aria-hidden="true" href="#cb528-4" tabindex="-1"></a><span class="co"># 2. Backup data directory</span></span>
<span id="cb528-5"><a aria-hidden="true" href="#cb528-5" tabindex="-1"></a><span class="fu">cp</span> <span class="at">-a</span> /data /data.backup</span>
<span id="cb528-6"><a aria-hidden="true" href="#cb528-6" tabindex="-1"></a></span>
<span id="cb528-7"><a aria-hidden="true" href="#cb528-7" tabindex="-1"></a><span class="co"># 3. Attempt reset (dry run first)</span></span>
<span id="cb528-8"><a aria-hidden="true" href="#cb528-8" tabindex="-1"></a><span class="ex">pg_resetwal</span> <span class="at">-n</span> /data</span>
<span id="cb528-9"><a aria-hidden="true" href="#cb528-9" tabindex="-1"></a></span>
<span id="cb528-10"><a aria-hidden="true" href="#cb528-10" tabindex="-1"></a><span class="co"># 4. Perform actual reset</span></span>
<span id="cb528-11"><a aria-hidden="true" href="#cb528-11" tabindex="-1"></a><span class="ex">pg_resetwal</span> <span class="at">-f</span> /data</span>
<span id="cb528-12"><a aria-hidden="true" href="#cb528-12" tabindex="-1"></a></span>
<span id="cb528-13"><a aria-hidden="true" href="#cb528-13" tabindex="-1"></a><span class="co"># 5. Start server and check for corruption</span></span>
<span id="cb528-14"><a aria-hidden="true" href="#cb528-14" tabindex="-1"></a><span class="ex">pg_ctl</span> <span class="at">-D</span> /data start</span>
<span id="cb528-15"><a aria-hidden="true" href="#cb528-15" tabindex="-1"></a><span class="ex">psql</span> <span class="at">-c</span> <span class="st">"SELECT * FROM pg_database"</span></span>
<span id="cb528-16"><a aria-hidden="true" href="#cb528-16" tabindex="-1"></a></span>
<span id="cb528-17"><a aria-hidden="true" href="#cb528-17" tabindex="-1"></a><span class="co"># 6. Perform consistency checks</span></span>
<span id="cb528-18"><a aria-hidden="true" href="#cb528-18" tabindex="-1"></a><span class="co"># Use pg_amcheck or manual queries to verify data integrity</span></span></code></pre></div>
<h3 data-number="9.6.3" id="pg_rewind---synchronize-data-directory-with-another-cluster"><span class="header-section-number">9.6.3</span> 5.3 pg_rewind - Synchronize
Data Directory with Another Cluster</h3>
<p><strong>Purpose</strong>: <code>pg_rewind</code> synchronizes a
PostgreSQL data directory with another copy of the same cluster after
they have diverged (e.g., after failover).</p>
<p><strong>Key Source Files</strong>: -
<code>src/bin/pg_rewind/pg_rewind.c</code> - Main synchronization logic
- <code>src/bin/pg_rewind/filemap.c</code> - File change tracking -
<code>src/bin/pg_rewind/parsexlog.c</code> - WAL parsing -
<code>src/bin/pg_rewind/file_ops.c</code> - File operations -
<code>src/bin/pg_rewind/rewind_source.c</code> - Source cluster
access</p>
<p><strong>Architecture</strong>:</p>
<p>The utility synchronizes a data directory by: 1. Finding the common
ancestor timeline 2. Parsing WAL to identify changed blocks 3. Copying
only changed data from source cluster 4. Creating backup label for
recovery</p>
<p><strong>Use Cases</strong>: - Failed primary rejoining after failover
- Standby resynchronization after timeline divergence - Alternative to
rebuilding from backup</p>
<p><strong>Main Features</strong>:</p>
<ol type="1">
<li><strong>Source Options</strong>:
<ul>
<li>Local data directory (<code>--source-pgdata</code>)</li>
<li>Remote server via connection (<code>--source-server</code>)</li>
</ul></li>
<li><strong>Efficient Synchronization</strong>:
<ul>
<li>Only copies changed blocks</li>
<li>Uses WAL parsing to identify differences</li>
<li>Much faster than full rebuild</li>
</ul></li>
<li><strong>Safety Features</strong>:
<ul>
<li>Dry-run mode (<code>--dry-run</code>)</li>
<li>Progress reporting</li>
<li>Comprehensive checks</li>
</ul></li>
</ol>
<p><strong>Requirements</strong>: - Target cluster must be shut down
cleanly - Source and target must share common history -
<code>wal_log_hints=on</code> or data checksums enabled - Or
full_page_writes=on with WAL retention</p>
<p><strong>Usage Examples</strong>:</p>
<div class="sourceCode" id="cb529"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb529-1"><a aria-hidden="true" href="#cb529-1" tabindex="-1"></a><span class="co"># Rewind from local source</span></span>
<span id="cb529-2"><a aria-hidden="true" href="#cb529-2" tabindex="-1"></a><span class="ex">pg_rewind</span> <span class="dt">\</span></span>
<span id="cb529-3"><a aria-hidden="true" href="#cb529-3" tabindex="-1"></a>  <span class="at">--target-pgdata</span><span class="op">=</span>/var/lib/postgresql/data <span class="dt">\</span></span>
<span id="cb529-4"><a aria-hidden="true" href="#cb529-4" tabindex="-1"></a>  <span class="at">--source-pgdata</span><span class="op">=</span>/mnt/primary/data</span>
<span id="cb529-5"><a aria-hidden="true" href="#cb529-5" tabindex="-1"></a></span>
<span id="cb529-6"><a aria-hidden="true" href="#cb529-6" tabindex="-1"></a><span class="co"># Rewind from remote source</span></span>
<span id="cb529-7"><a aria-hidden="true" href="#cb529-7" tabindex="-1"></a><span class="ex">pg_rewind</span> <span class="dt">\</span></span>
<span id="cb529-8"><a aria-hidden="true" href="#cb529-8" tabindex="-1"></a>  <span class="at">--target-pgdata</span><span class="op">=</span>/var/lib/postgresql/data <span class="dt">\</span></span>
<span id="cb529-9"><a aria-hidden="true" href="#cb529-9" tabindex="-1"></a>  <span class="at">--source-server</span><span class="op">=</span><span class="st">'host=primary port=5432 user=postgres'</span></span>
<span id="cb529-10"><a aria-hidden="true" href="#cb529-10" tabindex="-1"></a></span>
<span id="cb529-11"><a aria-hidden="true" href="#cb529-11" tabindex="-1"></a><span class="co"># Dry run (show what would be done)</span></span>
<span id="cb529-12"><a aria-hidden="true" href="#cb529-12" tabindex="-1"></a><span class="ex">pg_rewind</span> <span class="dt">\</span></span>
<span id="cb529-13"><a aria-hidden="true" href="#cb529-13" tabindex="-1"></a>  <span class="at">--target-pgdata</span><span class="op">=</span>/var/lib/postgresql/data <span class="dt">\</span></span>
<span id="cb529-14"><a aria-hidden="true" href="#cb529-14" tabindex="-1"></a>  <span class="at">--source-server</span><span class="op">=</span><span class="st">'host=primary port=5432'</span> <span class="dt">\</span></span>
<span id="cb529-15"><a aria-hidden="true" href="#cb529-15" tabindex="-1"></a>  <span class="at">--dry-run</span></span>
<span id="cb529-16"><a aria-hidden="true" href="#cb529-16" tabindex="-1"></a></span>
<span id="cb529-17"><a aria-hidden="true" href="#cb529-17" tabindex="-1"></a><span class="co"># With progress reporting</span></span>
<span id="cb529-18"><a aria-hidden="true" href="#cb529-18" tabindex="-1"></a><span class="ex">pg_rewind</span> <span class="dt">\</span></span>
<span id="cb529-19"><a aria-hidden="true" href="#cb529-19" tabindex="-1"></a>  <span class="at">--target-pgdata</span><span class="op">=</span>/var/lib/postgresql/data <span class="dt">\</span></span>
<span id="cb529-20"><a aria-hidden="true" href="#cb529-20" tabindex="-1"></a>  <span class="at">--source-server</span><span class="op">=</span><span class="st">'host=primary port=5432'</span> <span class="dt">\</span></span>
<span id="cb529-21"><a aria-hidden="true" href="#cb529-21" tabindex="-1"></a>  <span class="at">--progress</span></span>
<span id="cb529-22"><a aria-hidden="true" href="#cb529-22" tabindex="-1"></a></span>
<span id="cb529-23"><a aria-hidden="true" href="#cb529-23" tabindex="-1"></a><span class="co"># Debug mode (verbose output)</span></span>
<span id="cb529-24"><a aria-hidden="true" href="#cb529-24" tabindex="-1"></a><span class="ex">pg_rewind</span> <span class="dt">\</span></span>
<span id="cb529-25"><a aria-hidden="true" href="#cb529-25" tabindex="-1"></a>  <span class="at">--target-pgdata</span><span class="op">=</span>/var/lib/postgresql/data <span class="dt">\</span></span>
<span id="cb529-26"><a aria-hidden="true" href="#cb529-26" tabindex="-1"></a>  <span class="at">--source-server</span><span class="op">=</span><span class="st">'host=primary port=5432'</span> <span class="dt">\</span></span>
<span id="cb529-27"><a aria-hidden="true" href="#cb529-27" tabindex="-1"></a>  <span class="at">--debug</span></span>
<span id="cb529-28"><a aria-hidden="true" href="#cb529-28" tabindex="-1"></a></span>
<span id="cb529-29"><a aria-hidden="true" href="#cb529-29" tabindex="-1"></a><span class="co"># With custom configuration file</span></span>
<span id="cb529-30"><a aria-hidden="true" href="#cb529-30" tabindex="-1"></a><span class="ex">pg_rewind</span> <span class="dt">\</span></span>
<span id="cb529-31"><a aria-hidden="true" href="#cb529-31" tabindex="-1"></a>  <span class="at">--target-pgdata</span><span class="op">=</span>/var/lib/postgresql/data <span class="dt">\</span></span>
<span id="cb529-32"><a aria-hidden="true" href="#cb529-32" tabindex="-1"></a>  <span class="at">--source-server</span><span class="op">=</span><span class="st">'host=primary port=5432'</span> <span class="dt">\</span></span>
<span id="cb529-33"><a aria-hidden="true" href="#cb529-33" tabindex="-1"></a>  <span class="at">--config-file</span><span class="op">=</span>/etc/postgresql/postgresql.conf</span></code></pre></div>
<p><strong>Typical Failover Recovery Scenario</strong>:</p>
<div class="sourceCode" id="cb530"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb530-1"><a aria-hidden="true" href="#cb530-1" tabindex="-1"></a><span class="co"># 1. Old primary has failed over, new primary is active</span></span>
<span id="cb530-2"><a aria-hidden="true" href="#cb530-2" tabindex="-1"></a><span class="co"># 2. Stop old primary</span></span>
<span id="cb530-3"><a aria-hidden="true" href="#cb530-3" tabindex="-1"></a><span class="ex">pg_ctl</span> <span class="at">-D</span> /old-primary/data stop <span class="at">-m</span> fast</span>
<span id="cb530-4"><a aria-hidden="true" href="#cb530-4" tabindex="-1"></a></span>
<span id="cb530-5"><a aria-hidden="true" href="#cb530-5" tabindex="-1"></a><span class="co"># 3. Rewind old primary to match new primary</span></span>
<span id="cb530-6"><a aria-hidden="true" href="#cb530-6" tabindex="-1"></a><span class="ex">pg_rewind</span> <span class="dt">\</span></span>
<span id="cb530-7"><a aria-hidden="true" href="#cb530-7" tabindex="-1"></a>  <span class="at">--target-pgdata</span><span class="op">=</span>/old-primary/data <span class="dt">\</span></span>
<span id="cb530-8"><a aria-hidden="true" href="#cb530-8" tabindex="-1"></a>  <span class="at">--source-server</span><span class="op">=</span><span class="st">'host=new-primary port=5432 user=replicator'</span></span>
<span id="cb530-9"><a aria-hidden="true" href="#cb530-9" tabindex="-1"></a></span>
<span id="cb530-10"><a aria-hidden="true" href="#cb530-10" tabindex="-1"></a><span class="co"># 4. Configure as standby</span></span>
<span id="cb530-11"><a aria-hidden="true" href="#cb530-11" tabindex="-1"></a><span class="fu">cat</span> <span class="op">&gt;</span> /old-primary/data/standby.signal <span class="op">&lt;&lt; EOF</span></span>
<span id="cb530-12"><a aria-hidden="true" href="#cb530-12" tabindex="-1"></a><span class="st"># This file indicates standby mode</span></span>
<span id="cb530-13"><a aria-hidden="true" href="#cb530-13" tabindex="-1"></a><span class="op">EOF</span></span>
<span id="cb530-14"><a aria-hidden="true" href="#cb530-14" tabindex="-1"></a></span>
<span id="cb530-15"><a aria-hidden="true" href="#cb530-15" tabindex="-1"></a><span class="co"># 5. Update connection info in postgresql.auto.conf</span></span>
<span id="cb530-16"><a aria-hidden="true" href="#cb530-16" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"primary_conninfo = 'host=new-primary port=5432'"</span> <span class="dt">\</span></span>
<span id="cb530-17"><a aria-hidden="true" href="#cb530-17" tabindex="-1"></a>  <span class="op">&gt;&gt;</span> /old-primary/data/postgresql.auto.conf</span>
<span id="cb530-18"><a aria-hidden="true" href="#cb530-18" tabindex="-1"></a></span>
<span id="cb530-19"><a aria-hidden="true" href="#cb530-19" tabindex="-1"></a><span class="co"># 6. Start as standby</span></span>
<span id="cb530-20"><a aria-hidden="true" href="#cb530-20" tabindex="-1"></a><span class="ex">pg_ctl</span> <span class="at">-D</span> /old-primary/data start</span></code></pre></div>
<h2 data-number="9.7" id="diagnostic-and-verification-tools"><span class="header-section-number">9.7</span> 6. Diagnostic and Verification
Tools</h2>
<h3 data-number="9.7.1" id="pg_waldump---wal-file-decoder"><span class="header-section-number">9.7.1</span> 6.1 pg_waldump - WAL File
Decoder</h3>
<p><strong>Purpose</strong>: <code>pg_waldump</code> reads and decodes
PostgreSQL Write-Ahead Log (WAL) files, displaying their contents in
human-readable format.</p>
<p><strong>Key Source Files</strong>: -
<code>src/bin/pg_waldump/pg_waldump.c</code> - Main decoder - Shares WAL
reading code with backend
(<code>src/backend/access/transam/xlogreader.c</code>)</p>
<p><strong>Main Features</strong>:</p>
<ol type="1">
<li><strong>WAL Inspection</strong>:
<ul>
<li>Display WAL record details</li>
<li>Filter by resource manager</li>
<li>Filter by transaction ID</li>
<li>Filter by relation</li>
</ul></li>
<li><strong>Statistics Mode</strong>:
<ul>
<li>Aggregate statistics per record type</li>
<li>Useful for understanding WAL volume</li>
</ul></li>
<li><strong>Full Page Image Extraction</strong>:
<ul>
<li>Save full page images to disk</li>
<li>Useful for recovery and forensics</li>
</ul></li>
<li><strong>Follow Mode</strong>:
<ul>
<li>Continuous monitoring of WAL (like tail -f)</li>
<li>Real-time WAL analysis</li>
</ul></li>
</ol>
<p><strong>Usage Examples</strong>:</p>
<div class="sourceCode" id="cb531"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb531-1"><a aria-hidden="true" href="#cb531-1" tabindex="-1"></a><span class="co"># Decode specific WAL file</span></span>
<span id="cb531-2"><a aria-hidden="true" href="#cb531-2" tabindex="-1"></a><span class="ex">pg_waldump</span> /var/lib/postgresql/data/pg_wal/000000010000000000000001</span>
<span id="cb531-3"><a aria-hidden="true" href="#cb531-3" tabindex="-1"></a></span>
<span id="cb531-4"><a aria-hidden="true" href="#cb531-4" tabindex="-1"></a><span class="co"># Decode range of WAL</span></span>
<span id="cb531-5"><a aria-hidden="true" href="#cb531-5" tabindex="-1"></a><span class="ex">pg_waldump</span> <span class="at">-s</span> 0/1000000 <span class="at">-e</span> 0/2000000 /data/pg_wal</span>
<span id="cb531-6"><a aria-hidden="true" href="#cb531-6" tabindex="-1"></a></span>
<span id="cb531-7"><a aria-hidden="true" href="#cb531-7" tabindex="-1"></a><span class="co"># Filter by transaction ID</span></span>
<span id="cb531-8"><a aria-hidden="true" href="#cb531-8" tabindex="-1"></a><span class="ex">pg_waldump</span> <span class="at">-x</span> 1234 /data/pg_wal</span>
<span id="cb531-9"><a aria-hidden="true" href="#cb531-9" tabindex="-1"></a></span>
<span id="cb531-10"><a aria-hidden="true" href="#cb531-10" tabindex="-1"></a><span class="co"># Filter by resource manager (e.g., Heap operations)</span></span>
<span id="cb531-11"><a aria-hidden="true" href="#cb531-11" tabindex="-1"></a><span class="ex">pg_waldump</span> <span class="at">-r</span> Heap /data/pg_wal</span>
<span id="cb531-12"><a aria-hidden="true" href="#cb531-12" tabindex="-1"></a></span>
<span id="cb531-13"><a aria-hidden="true" href="#cb531-13" tabindex="-1"></a><span class="co"># Statistics mode</span></span>
<span id="cb531-14"><a aria-hidden="true" href="#cb531-14" tabindex="-1"></a><span class="ex">pg_waldump</span> <span class="at">-z</span> /data/pg_wal/000000010000000000000001</span>
<span id="cb531-15"><a aria-hidden="true" href="#cb531-15" tabindex="-1"></a></span>
<span id="cb531-16"><a aria-hidden="true" href="#cb531-16" tabindex="-1"></a><span class="co"># Per-record statistics</span></span>
<span id="cb531-17"><a aria-hidden="true" href="#cb531-17" tabindex="-1"></a><span class="ex">pg_waldump</span> <span class="at">-z</span> <span class="at">--stats</span><span class="op">=</span>record /data/pg_wal</span>
<span id="cb531-18"><a aria-hidden="true" href="#cb531-18" tabindex="-1"></a></span>
<span id="cb531-19"><a aria-hidden="true" href="#cb531-19" tabindex="-1"></a><span class="co"># Extract full page images</span></span>
<span id="cb531-20"><a aria-hidden="true" href="#cb531-20" tabindex="-1"></a><span class="ex">pg_waldump</span> <span class="at">--save-fullpage</span><span class="op">=</span>/tmp/fpw /data/pg_wal</span>
<span id="cb531-21"><a aria-hidden="true" href="#cb531-21" tabindex="-1"></a></span>
<span id="cb531-22"><a aria-hidden="true" href="#cb531-22" tabindex="-1"></a><span class="co"># Follow mode (continuous)</span></span>
<span id="cb531-23"><a aria-hidden="true" href="#cb531-23" tabindex="-1"></a><span class="ex">pg_waldump</span> <span class="at">--follow</span> /data/pg_wal</span>
<span id="cb531-24"><a aria-hidden="true" href="#cb531-24" tabindex="-1"></a></span>
<span id="cb531-25"><a aria-hidden="true" href="#cb531-25" tabindex="-1"></a><span class="co"># Filter by relation</span></span>
<span id="cb531-26"><a aria-hidden="true" href="#cb531-26" tabindex="-1"></a><span class="ex">pg_waldump</span> <span class="at">--relation</span><span class="op">=</span>1663/16384/12345 /data/pg_wal</span>
<span id="cb531-27"><a aria-hidden="true" href="#cb531-27" tabindex="-1"></a></span>
<span id="cb531-28"><a aria-hidden="true" href="#cb531-28" tabindex="-1"></a><span class="co"># Filter by block number</span></span>
<span id="cb531-29"><a aria-hidden="true" href="#cb531-29" tabindex="-1"></a><span class="ex">pg_waldump</span> <span class="at">--block</span><span class="op">=</span>100 <span class="at">--relation</span><span class="op">=</span>1663/16384/12345 /data/pg_wal</span>
<span id="cb531-30"><a aria-hidden="true" href="#cb531-30" tabindex="-1"></a></span>
<span id="cb531-31"><a aria-hidden="true" href="#cb531-31" tabindex="-1"></a><span class="co"># Verbose output with full details</span></span>
<span id="cb531-32"><a aria-hidden="true" href="#cb531-32" tabindex="-1"></a><span class="ex">pg_waldump</span> <span class="at">-x</span> 1234 <span class="at">--bkp-details</span> /data/pg_wal</span></code></pre></div>
<p><strong>Output Interpretation</strong>:</p>
<pre><code>rmgr: Heap        len (rec/tot):     59/    59, tx:        742, lsn: 0/0151B3A8,
  prev 0/0151B370, desc: INSERT off 3 flags 0x00, blkref #0: rel 1663/16384/16385
  blk 0

Fields:
- rmgr: Resource manager (Heap, Btree, Transaction, etc.)
- len: Record length
- tx: Transaction ID
- lsn: Log Sequence Number
- prev: Previous record LSN
- desc: Operation description
- blkref: Block reference(s)</code></pre>
<h3 data-number="9.7.2" id="pg_amcheck---relation-corruption-detection"><span class="header-section-number">9.7.2</span> 6.2 pg_amcheck - Relation
Corruption Detection</h3>
<p><strong>Purpose</strong>: <code>pg_amcheck</code> detects corruption
in PostgreSQL database relations by checking heap tables and B-tree
indexes.</p>
<p><strong>Key Source Files</strong>: -
<code>src/bin/pg_amcheck/pg_amcheck.c</code> - Main checking logic -
Uses <code>amcheck</code> extension on backend:
<code>contrib/amcheck/</code></p>
<p><strong>Main Features</strong>:</p>
<ol type="1">
<li><strong>Corruption Detection</strong>:
<ul>
<li>Heap table corruption</li>
<li>B-tree index corruption</li>
<li>Cross-relation consistency</li>
</ul></li>
<li><strong>Flexible Targeting</strong>:
<ul>
<li>Entire database or cluster</li>
<li>Specific schemas, tables, indexes</li>
<li>Include/exclude patterns</li>
</ul></li>
<li><strong>Parallel Checking</strong>:
<ul>
<li>Multiple parallel connections</li>
<li>Faster verification of large databases</li>
</ul></li>
<li><strong>Extension Management</strong>:
<ul>
<li>Auto-install amcheck extension if needed</li>
<li>Configurable installation schema</li>
</ul></li>
</ol>
<p><strong>Usage Examples</strong>:</p>
<div class="sourceCode" id="cb533"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb533-1"><a aria-hidden="true" href="#cb533-1" tabindex="-1"></a><span class="co"># Check all databases</span></span>
<span id="cb533-2"><a aria-hidden="true" href="#cb533-2" tabindex="-1"></a><span class="ex">pg_amcheck</span> <span class="at">--all</span></span>
<span id="cb533-3"><a aria-hidden="true" href="#cb533-3" tabindex="-1"></a></span>
<span id="cb533-4"><a aria-hidden="true" href="#cb533-4" tabindex="-1"></a><span class="co"># Check specific database</span></span>
<span id="cb533-5"><a aria-hidden="true" href="#cb533-5" tabindex="-1"></a><span class="ex">pg_amcheck</span> mydb</span>
<span id="cb533-6"><a aria-hidden="true" href="#cb533-6" tabindex="-1"></a></span>
<span id="cb533-7"><a aria-hidden="true" href="#cb533-7" tabindex="-1"></a><span class="co"># Check all databases with progress</span></span>
<span id="cb533-8"><a aria-hidden="true" href="#cb533-8" tabindex="-1"></a><span class="ex">pg_amcheck</span> <span class="at">-a</span> <span class="at">--progress</span></span>
<span id="cb533-9"><a aria-hidden="true" href="#cb533-9" tabindex="-1"></a></span>
<span id="cb533-10"><a aria-hidden="true" href="#cb533-10" tabindex="-1"></a><span class="co"># Parallel checking</span></span>
<span id="cb533-11"><a aria-hidden="true" href="#cb533-11" tabindex="-1"></a><span class="ex">pg_amcheck</span> <span class="at">-a</span> <span class="at">-j</span> 4</span>
<span id="cb533-12"><a aria-hidden="true" href="#cb533-12" tabindex="-1"></a></span>
<span id="cb533-13"><a aria-hidden="true" href="#cb533-13" tabindex="-1"></a><span class="co"># Check specific table</span></span>
<span id="cb533-14"><a aria-hidden="true" href="#cb533-14" tabindex="-1"></a><span class="ex">pg_amcheck</span> <span class="at">-t</span> users mydb</span>
<span id="cb533-15"><a aria-hidden="true" href="#cb533-15" tabindex="-1"></a></span>
<span id="cb533-16"><a aria-hidden="true" href="#cb533-16" tabindex="-1"></a><span class="co"># Check all indexes</span></span>
<span id="cb533-17"><a aria-hidden="true" href="#cb533-17" tabindex="-1"></a><span class="ex">pg_amcheck</span> <span class="at">--checkunique</span> mydb</span>
<span id="cb533-18"><a aria-hidden="true" href="#cb533-18" tabindex="-1"></a></span>
<span id="cb533-19"><a aria-hidden="true" href="#cb533-19" tabindex="-1"></a><span class="co"># Exclude specific schemas</span></span>
<span id="cb533-20"><a aria-hidden="true" href="#cb533-20" tabindex="-1"></a><span class="ex">pg_amcheck</span> <span class="at">--exclude-schema</span><span class="op">=</span>temp <span class="at">-a</span></span>
<span id="cb533-21"><a aria-hidden="true" href="#cb533-21" tabindex="-1"></a></span>
<span id="cb533-22"><a aria-hidden="true" href="#cb533-22" tabindex="-1"></a><span class="co"># Install extension if missing</span></span>
<span id="cb533-23"><a aria-hidden="true" href="#cb533-23" tabindex="-1"></a><span class="ex">pg_amcheck</span> <span class="at">--install-missing</span> <span class="at">-a</span></span>
<span id="cb533-24"><a aria-hidden="true" href="#cb533-24" tabindex="-1"></a></span>
<span id="cb533-25"><a aria-hidden="true" href="#cb533-25" tabindex="-1"></a><span class="co"># Verbose output</span></span>
<span id="cb533-26"><a aria-hidden="true" href="#cb533-26" tabindex="-1"></a><span class="ex">pg_amcheck</span> <span class="at">-v</span> mydb</span>
<span id="cb533-27"><a aria-hidden="true" href="#cb533-27" tabindex="-1"></a></span>
<span id="cb533-28"><a aria-hidden="true" href="#cb533-28" tabindex="-1"></a><span class="co"># Heapallindexed check (thorough but slow)</span></span>
<span id="cb533-29"><a aria-hidden="true" href="#cb533-29" tabindex="-1"></a><span class="ex">pg_amcheck</span> <span class="at">--heapallindexed</span> mydb</span>
<span id="cb533-30"><a aria-hidden="true" href="#cb533-30" tabindex="-1"></a></span>
<span id="cb533-31"><a aria-hidden="true" href="#cb533-31" tabindex="-1"></a><span class="co"># Skip toast tables</span></span>
<span id="cb533-32"><a aria-hidden="true" href="#cb533-32" tabindex="-1"></a><span class="ex">pg_amcheck</span> <span class="at">--no-toast-check</span> mydb</span></code></pre></div>
<p><strong>Output Interpretation</strong>:</p>
<pre><code># No corruption found (good):
$ pg_amcheck mydb
# (exits with status 0, no output)

# Corruption found (bad):
$ pg_amcheck mydb
heap table "public.users", block 42, offset 3: invalid tuple length
btree index "public.users_pkey": block 10 is not properly initialized
# (exits with non-zero status)</code></pre>
<h3 data-number="9.7.3" id="pg_controldata---display-control-file-information"><span class="header-section-number">9.7.3</span> 6.3 pg_controldata - Display
Control File Information</h3>
<p><strong>Purpose</strong>: Displays the contents of the
<code>pg_control</code> file, which contains critical cluster state
information.</p>
<p><strong>Usage</strong>:</p>
<div class="sourceCode" id="cb535"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb535-1"><a aria-hidden="true" href="#cb535-1" tabindex="-1"></a><span class="co"># Display control information</span></span>
<span id="cb535-2"><a aria-hidden="true" href="#cb535-2" tabindex="-1"></a><span class="ex">pg_controldata</span> /var/lib/postgresql/data</span>
<span id="cb535-3"><a aria-hidden="true" href="#cb535-3" tabindex="-1"></a></span>
<span id="cb535-4"><a aria-hidden="true" href="#cb535-4" tabindex="-1"></a><span class="co"># Example output:</span></span>
<span id="cb535-5"><a aria-hidden="true" href="#cb535-5" tabindex="-1"></a><span class="ex">pg_control</span> version number:            1300</span>
<span id="cb535-6"><a aria-hidden="true" href="#cb535-6" tabindex="-1"></a><span class="ex">Catalog</span> version number:               202107181</span>
<span id="cb535-7"><a aria-hidden="true" href="#cb535-7" tabindex="-1"></a><span class="ex">Database</span> system identifier:           7012345678901234567</span>
<span id="cb535-8"><a aria-hidden="true" href="#cb535-8" tabindex="-1"></a><span class="ex">Database</span> cluster state:               in production</span>
<span id="cb535-9"><a aria-hidden="true" href="#cb535-9" tabindex="-1"></a><span class="ex">pg_control</span> last modified:             Mon Nov 18 10:30:45 2024</span>
<span id="cb535-10"><a aria-hidden="true" href="#cb535-10" tabindex="-1"></a><span class="ex">Latest</span> checkpoint location:           0/1A2B3C4D</span>
<span id="cb535-11"><a aria-hidden="true" href="#cb535-11" tabindex="-1"></a><span class="ex">Latest</span> checkpoint<span class="st">'s REDO location:    0/1A2B3C00</span></span>
<span id="cb535-12"><a aria-hidden="true" href="#cb535-12" tabindex="-1"></a><span class="st">Latest checkpoint'</span>s TimeLineID:       1</span>
<span id="cb535-13"><a aria-hidden="true" href="#cb535-13" tabindex="-1"></a><span class="ex">Latest</span> checkpoint<span class="st">'s NextXID:          0:1234567</span></span>
<span id="cb535-14"><a aria-hidden="true" href="#cb535-14" tabindex="-1"></a><span class="st">Latest checkpoint'</span>s NextOID:          24576</span></code></pre></div>
<h3 data-number="9.7.4" id="pg_checksums---enabledisableverify-data-checksums"><span class="header-section-number">9.7.4</span> 6.4 pg_checksums -
Enable/Disable/Verify Data Checksums</h3>
<p><strong>Purpose</strong>: Manage page-level checksums for data
integrity verification.</p>
<p><strong>Usage</strong>:</p>
<div class="sourceCode" id="cb536"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb536-1"><a aria-hidden="true" href="#cb536-1" tabindex="-1"></a><span class="co"># Enable checksums (cluster must be offline)</span></span>
<span id="cb536-2"><a aria-hidden="true" href="#cb536-2" tabindex="-1"></a><span class="ex">pg_checksums</span> <span class="at">--enable</span> <span class="at">-D</span> /var/lib/postgresql/data</span>
<span id="cb536-3"><a aria-hidden="true" href="#cb536-3" tabindex="-1"></a></span>
<span id="cb536-4"><a aria-hidden="true" href="#cb536-4" tabindex="-1"></a><span class="co"># Disable checksums</span></span>
<span id="cb536-5"><a aria-hidden="true" href="#cb536-5" tabindex="-1"></a><span class="ex">pg_checksums</span> <span class="at">--disable</span> <span class="at">-D</span> /var/lib/postgresql/data</span>
<span id="cb536-6"><a aria-hidden="true" href="#cb536-6" tabindex="-1"></a></span>
<span id="cb536-7"><a aria-hidden="true" href="#cb536-7" tabindex="-1"></a><span class="co"># Verify checksums</span></span>
<span id="cb536-8"><a aria-hidden="true" href="#cb536-8" tabindex="-1"></a><span class="ex">pg_checksums</span> <span class="at">--check</span> <span class="at">-D</span> /var/lib/postgresql/data</span>
<span id="cb536-9"><a aria-hidden="true" href="#cb536-9" tabindex="-1"></a></span>
<span id="cb536-10"><a aria-hidden="true" href="#cb536-10" tabindex="-1"></a><span class="co"># Verify with progress</span></span>
<span id="cb536-11"><a aria-hidden="true" href="#cb536-11" tabindex="-1"></a><span class="ex">pg_checksums</span> <span class="at">--check</span> <span class="at">--progress</span> <span class="at">-D</span> /var/lib/postgresql/data</span></code></pre></div>
<h3 data-number="9.7.5" id="other-diagnostic-tools"><span class="header-section-number">9.7.5</span> 6.5 Other Diagnostic
Tools</h3>
<p><strong>pg_test_fsync</strong> - Test filesystem sync
performance:</p>
<div class="sourceCode" id="cb537"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb537-1"><a aria-hidden="true" href="#cb537-1" tabindex="-1"></a><span class="co"># Benchmark fsync methods</span></span>
<span id="cb537-2"><a aria-hidden="true" href="#cb537-2" tabindex="-1"></a><span class="ex">pg_test_fsync</span></span>
<span id="cb537-3"><a aria-hidden="true" href="#cb537-3" tabindex="-1"></a></span>
<span id="cb537-4"><a aria-hidden="true" href="#cb537-4" tabindex="-1"></a><span class="co"># Output shows performance of different sync methods</span></span>
<span id="cb537-5"><a aria-hidden="true" href="#cb537-5" tabindex="-1"></a><span class="co"># Useful for optimizing wal_sync_method</span></span></code></pre></div>
<p><strong>pg_test_timing</strong> - Test timing overhead:</p>
<div class="sourceCode" id="cb538"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb538-1"><a aria-hidden="true" href="#cb538-1" tabindex="-1"></a><span class="co"># Measure timing call overhead</span></span>
<span id="cb538-2"><a aria-hidden="true" href="#cb538-2" tabindex="-1"></a><span class="ex">pg_test_timing</span></span>
<span id="cb538-3"><a aria-hidden="true" href="#cb538-3" tabindex="-1"></a></span>
<span id="cb538-4"><a aria-hidden="true" href="#cb538-4" tabindex="-1"></a><span class="co"># Useful for understanding EXPLAIN ANALYZE accuracy</span></span></code></pre></div>
<p><strong>pg_archivecleanup</strong> - Clean up WAL archives:</p>
<div class="sourceCode" id="cb539"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb539-1"><a aria-hidden="true" href="#cb539-1" tabindex="-1"></a><span class="co"># Remove old WAL files before specified segment</span></span>
<span id="cb539-2"><a aria-hidden="true" href="#cb539-2" tabindex="-1"></a><span class="ex">pg_archivecleanup</span> /archive/wal 000000010000000000000010</span>
<span id="cb539-3"><a aria-hidden="true" href="#cb539-3" tabindex="-1"></a></span>
<span id="cb539-4"><a aria-hidden="true" href="#cb539-4" tabindex="-1"></a><span class="co"># Dry run</span></span>
<span id="cb539-5"><a aria-hidden="true" href="#cb539-5" tabindex="-1"></a><span class="ex">pg_archivecleanup</span> <span class="at">-n</span> /archive/wal 000000010000000000000010</span></code></pre></div>
<p><strong>pg_config</strong> - Display PostgreSQL build
configuration:</p>
<div class="sourceCode" id="cb540"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb540-1"><a aria-hidden="true" href="#cb540-1" tabindex="-1"></a><span class="co"># Show all configuration</span></span>
<span id="cb540-2"><a aria-hidden="true" href="#cb540-2" tabindex="-1"></a><span class="ex">pg_config</span></span>
<span id="cb540-3"><a aria-hidden="true" href="#cb540-3" tabindex="-1"></a></span>
<span id="cb540-4"><a aria-hidden="true" href="#cb540-4" tabindex="-1"></a><span class="co"># Show specific value</span></span>
<span id="cb540-5"><a aria-hidden="true" href="#cb540-5" tabindex="-1"></a><span class="ex">pg_config</span> <span class="at">--includedir</span></span>
<span id="cb540-6"><a aria-hidden="true" href="#cb540-6" tabindex="-1"></a><span class="ex">pg_config</span> <span class="at">--libdir</span></span>
<span id="cb540-7"><a aria-hidden="true" href="#cb540-7" tabindex="-1"></a><span class="ex">pg_config</span> <span class="at">--configure</span></span></code></pre></div>
<h2 data-number="9.8" id="benchmarking---pgbench"><span class="header-section-number">9.8</span> 7. Benchmarking - pgbench</h2>
<h3 data-number="9.8.1" id="overview-15"><span class="header-section-number">9.8.1</span> 7.1 Overview</h3>
<p><strong>Purpose</strong>: <code>pgbench</code> is a benchmarking tool
for PostgreSQL, designed to run predefined or custom workloads and
measure database performance.</p>
<p><strong>Key Source Files</strong>: -
<code>src/bin/pgbench/pgbench.c</code> - Main benchmarking engine -
<code>src/bin/pgbench/pgbench.h</code> - Data structures -
<code>src/bin/pgbench/exprparse.y</code> - Expression parser for
scripts</p>
<p><strong>Architecture</strong>:</p>
<p>pgbench operates in two modes: 1. <strong>Initialization
mode</strong> (<code>-i</code>): Creates and populates benchmark tables
2. <strong>Benchmarking mode</strong> (default): Runs transactions and
measures performance</p>
<p><strong>Benchmark Tables</strong> (TPC-B inspired):</p>
<div class="sourceCode" id="cb541"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb541-1"><a aria-hidden="true" href="#cb541-1" tabindex="-1"></a>pgbench_accounts (<span class="dv">100</span>,<span class="dv">000</span> <span class="kw">rows</span> per scale)</span>
<span id="cb541-2"><a aria-hidden="true" href="#cb541-2" tabindex="-1"></a>pgbench_branches (<span class="dv">1</span> <span class="kw">row</span> per scale)</span>
<span id="cb541-3"><a aria-hidden="true" href="#cb541-3" tabindex="-1"></a>pgbench_tellers  (<span class="dv">10</span> <span class="kw">rows</span> per scale)</span>
<span id="cb541-4"><a aria-hidden="true" href="#cb541-4" tabindex="-1"></a>pgbench_history  (append<span class="op">-</span><span class="kw">only</span> <span class="kw">transaction</span> <span class="fu">log</span>)</span></code></pre></div>
<h3 data-number="9.8.2" id="main-features"><span class="header-section-number">9.8.2</span> 7.2 Main Features</h3>
<ol type="1">
<li><strong>Built-in Benchmarks</strong>:
<ul>
<li>TPC-B-like workload (default)</li>
<li>Simple update workload (<code>-S</code> for SELECT only)</li>
<li>Custom SQL scripts (<code>-f</code> option)</li>
</ul></li>
<li><strong>Workload Control</strong>:
<ul>
<li>Number of clients (<code>-c</code>)</li>
<li>Number of threads (<code>-j</code>)</li>
<li>Number of transactions (<code>-t</code>) or duration
(<code>-T</code>)</li>
<li>Connection mode (new connection per transaction)</li>
</ul></li>
<li><strong>Advanced Features</strong>:
<ul>
<li>Rate limiting (<code>--rate</code>)</li>
<li>Latency reporting (<code>--latency</code>)</li>
<li>Progress reporting (<code>--progress</code>)</li>
<li>Prepared statements</li>
<li>Pipeline mode (protocol-level pipelining)</li>
<li>Partitioned tables support</li>
</ul></li>
<li><strong>Custom Scripts</strong>:
<ul>
<li>Variable substitution</li>
<li>Random number generation</li>
<li>Conditional execution</li>
<li>Meta-commands for control flow</li>
</ul></li>
<li><strong>Statistical Reporting</strong>:
<ul>
<li>Transactions per second (TPS)</li>
<li>Latency (average, stddev)</li>
<li>Percentile latencies (median, 90th, 95th, 99th)</li>
<li>Per-statement latencies</li>
</ul></li>
</ol>
<h3 data-number="9.8.3" id="usage-examples-1"><span class="header-section-number">9.8.3</span> 7.3 Usage Examples</h3>
<p><strong>Basic Benchmarking</strong>:</p>
<div class="sourceCode" id="cb542"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb542-1"><a aria-hidden="true" href="#cb542-1" tabindex="-1"></a><span class="co"># Initialize with scale factor 10 (1M rows in pgbench_accounts)</span></span>
<span id="cb542-2"><a aria-hidden="true" href="#cb542-2" tabindex="-1"></a><span class="ex">pgbench</span> <span class="at">-i</span> <span class="at">-s</span> 10 mydb</span>
<span id="cb542-3"><a aria-hidden="true" href="#cb542-3" tabindex="-1"></a></span>
<span id="cb542-4"><a aria-hidden="true" href="#cb542-4" tabindex="-1"></a><span class="co"># Run default TPC-B benchmark (10 clients, 1000 transactions each)</span></span>
<span id="cb542-5"><a aria-hidden="true" href="#cb542-5" tabindex="-1"></a><span class="ex">pgbench</span> <span class="at">-c</span> 10 <span class="at">-t</span> 1000 mydb</span>
<span id="cb542-6"><a aria-hidden="true" href="#cb542-6" tabindex="-1"></a></span>
<span id="cb542-7"><a aria-hidden="true" href="#cb542-7" tabindex="-1"></a><span class="co"># Run for 60 seconds instead of fixed transactions</span></span>
<span id="cb542-8"><a aria-hidden="true" href="#cb542-8" tabindex="-1"></a><span class="ex">pgbench</span> <span class="at">-c</span> 10 <span class="at">-T</span> 60 mydb</span>
<span id="cb542-9"><a aria-hidden="true" href="#cb542-9" tabindex="-1"></a></span>
<span id="cb542-10"><a aria-hidden="true" href="#cb542-10" tabindex="-1"></a><span class="co"># Select-only workload</span></span>
<span id="cb542-11"><a aria-hidden="true" href="#cb542-11" tabindex="-1"></a><span class="ex">pgbench</span> <span class="at">-c</span> 10 <span class="at">-T</span> 60 <span class="at">-S</span> mydb</span>
<span id="cb542-12"><a aria-hidden="true" href="#cb542-12" tabindex="-1"></a></span>
<span id="cb542-13"><a aria-hidden="true" href="#cb542-13" tabindex="-1"></a><span class="co"># With progress reporting every 5 seconds</span></span>
<span id="cb542-14"><a aria-hidden="true" href="#cb542-14" tabindex="-1"></a><span class="ex">pgbench</span> <span class="at">-c</span> 10 <span class="at">-T</span> 60 <span class="at">--progress</span><span class="op">=</span>5 mydb</span>
<span id="cb542-15"><a aria-hidden="true" href="#cb542-15" tabindex="-1"></a></span>
<span id="cb542-16"><a aria-hidden="true" href="#cb542-16" tabindex="-1"></a><span class="co"># Multiple threads (for multicore systems)</span></span>
<span id="cb542-17"><a aria-hidden="true" href="#cb542-17" tabindex="-1"></a><span class="ex">pgbench</span> <span class="at">-c</span> 20 <span class="at">-j</span> 4 <span class="at">-T</span> 60 mydb</span></code></pre></div>
<p><strong>Advanced Options</strong>:</p>
<div class="sourceCode" id="cb543"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb543-1"><a aria-hidden="true" href="#cb543-1" tabindex="-1"></a><span class="co"># Detailed latency statistics</span></span>
<span id="cb543-2"><a aria-hidden="true" href="#cb543-2" tabindex="-1"></a><span class="ex">pgbench</span> <span class="at">-c</span> 10 <span class="at">-T</span> 60 <span class="at">--latency</span> mydb</span>
<span id="cb543-3"><a aria-hidden="true" href="#cb543-3" tabindex="-1"></a></span>
<span id="cb543-4"><a aria-hidden="true" href="#cb543-4" tabindex="-1"></a><span class="co"># With rate limiting (max 1000 TPS)</span></span>
<span id="cb543-5"><a aria-hidden="true" href="#cb543-5" tabindex="-1"></a><span class="ex">pgbench</span> <span class="at">-c</span> 10 <span class="at">-T</span> 60 <span class="at">--rate</span><span class="op">=</span>1000 mydb</span>
<span id="cb543-6"><a aria-hidden="true" href="#cb543-6" tabindex="-1"></a></span>
<span id="cb543-7"><a aria-hidden="true" href="#cb543-7" tabindex="-1"></a><span class="co"># Latency threshold (report slow transactions &gt; 100ms)</span></span>
<span id="cb543-8"><a aria-hidden="true" href="#cb543-8" tabindex="-1"></a><span class="ex">pgbench</span> <span class="at">-c</span> 10 <span class="at">-T</span> 60 <span class="at">--latency-limit</span><span class="op">=</span>100 mydb</span>
<span id="cb543-9"><a aria-hidden="true" href="#cb543-9" tabindex="-1"></a></span>
<span id="cb543-10"><a aria-hidden="true" href="#cb543-10" tabindex="-1"></a><span class="co"># Per-statement latencies</span></span>
<span id="cb543-11"><a aria-hidden="true" href="#cb543-11" tabindex="-1"></a><span class="ex">pgbench</span> <span class="at">-c</span> 10 <span class="at">-T</span> 60 <span class="at">--report-per-command</span> mydb</span>
<span id="cb543-12"><a aria-hidden="true" href="#cb543-12" tabindex="-1"></a></span>
<span id="cb543-13"><a aria-hidden="true" href="#cb543-13" tabindex="-1"></a><span class="co"># Connection overhead test (new connection per transaction)</span></span>
<span id="cb543-14"><a aria-hidden="true" href="#cb543-14" tabindex="-1"></a><span class="ex">pgbench</span> <span class="at">-c</span> 10 <span class="at">-t</span> 100 <span class="at">-C</span> mydb</span>
<span id="cb543-15"><a aria-hidden="true" href="#cb543-15" tabindex="-1"></a></span>
<span id="cb543-16"><a aria-hidden="true" href="#cb543-16" tabindex="-1"></a><span class="co"># Use prepared statements</span></span>
<span id="cb543-17"><a aria-hidden="true" href="#cb543-17" tabindex="-1"></a><span class="ex">pgbench</span> <span class="at">-c</span> 10 <span class="at">-T</span> 60 <span class="at">-M</span> prepared mydb</span>
<span id="cb543-18"><a aria-hidden="true" href="#cb543-18" tabindex="-1"></a></span>
<span id="cb543-19"><a aria-hidden="true" href="#cb543-19" tabindex="-1"></a><span class="co"># Protocol-level pipelining</span></span>
<span id="cb543-20"><a aria-hidden="true" href="#cb543-20" tabindex="-1"></a><span class="ex">pgbench</span> <span class="at">-c</span> 10 <span class="at">-T</span> 60 <span class="at">-M</span> pipeline mydb</span></code></pre></div>
<p><strong>Custom Scripts</strong>:</p>
<div class="sourceCode" id="cb544"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb544-1"><a aria-hidden="true" href="#cb544-1" tabindex="-1"></a><span class="co"># Create custom script file (bench.sql)</span></span>
<span id="cb544-2"><a aria-hidden="true" href="#cb544-2" tabindex="-1"></a><span class="fu">cat</span> <span class="op">&gt;</span> bench.sql <span class="op">&lt;&lt; 'EOF'</span></span>
<span id="cb544-3"><a aria-hidden="true" href="#cb544-3" tabindex="-1"></a><span class="st">\set aid random(1, 100000)</span></span>
<span id="cb544-4"><a aria-hidden="true" href="#cb544-4" tabindex="-1"></a><span class="st">SELECT abalance FROM pgbench_accounts WHERE aid = :aid;</span></span>
<span id="cb544-5"><a aria-hidden="true" href="#cb544-5" tabindex="-1"></a><span class="op">EOF</span></span>
<span id="cb544-6"><a aria-hidden="true" href="#cb544-6" tabindex="-1"></a></span>
<span id="cb544-7"><a aria-hidden="true" href="#cb544-7" tabindex="-1"></a><span class="co"># Run custom script</span></span>
<span id="cb544-8"><a aria-hidden="true" href="#cb544-8" tabindex="-1"></a><span class="ex">pgbench</span> <span class="at">-c</span> 10 <span class="at">-T</span> 60 <span class="at">-f</span> bench.sql mydb</span>
<span id="cb544-9"><a aria-hidden="true" href="#cb544-9" tabindex="-1"></a></span>
<span id="cb544-10"><a aria-hidden="true" href="#cb544-10" tabindex="-1"></a><span class="co"># Multiple scripts with weights</span></span>
<span id="cb544-11"><a aria-hidden="true" href="#cb544-11" tabindex="-1"></a><span class="ex">pgbench</span> <span class="at">-c</span> 10 <span class="at">-T</span> 60 <span class="at">-f</span> read.sql@5 <span class="at">-f</span> write.sql@1 mydb</span></code></pre></div>
<p><strong>Custom Script Features</strong>:</p>
<div class="sourceCode" id="cb545"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb545-1"><a aria-hidden="true" href="#cb545-1" tabindex="-1"></a><span class="co">-- Variable assignment</span></span>
<span id="cb545-2"><a aria-hidden="true" href="#cb545-2" tabindex="-1"></a>\<span class="kw">set</span> nbranches <span class="dv">10</span></span>
<span id="cb545-3"><a aria-hidden="true" href="#cb545-3" tabindex="-1"></a>\<span class="kw">set</span> ntellers <span class="dv">100</span></span>
<span id="cb545-4"><a aria-hidden="true" href="#cb545-4" tabindex="-1"></a>\<span class="kw">set</span> naccounts <span class="dv">100000</span></span>
<span id="cb545-5"><a aria-hidden="true" href="#cb545-5" tabindex="-1"></a></span>
<span id="cb545-6"><a aria-hidden="true" href="#cb545-6" tabindex="-1"></a><span class="co">-- Random values</span></span>
<span id="cb545-7"><a aria-hidden="true" href="#cb545-7" tabindex="-1"></a>\<span class="kw">set</span> aid <span class="kw">random</span>(<span class="dv">1</span>, <span class="ch">:naccounts</span>)</span>
<span id="cb545-8"><a aria-hidden="true" href="#cb545-8" tabindex="-1"></a>\<span class="kw">set</span> delta <span class="kw">random</span>(<span class="op">-</span><span class="dv">5000</span>, <span class="dv">5000</span>)</span>
<span id="cb545-9"><a aria-hidden="true" href="#cb545-9" tabindex="-1"></a></span>
<span id="cb545-10"><a aria-hidden="true" href="#cb545-10" tabindex="-1"></a><span class="co">-- Conditional execution</span></span>
<span id="cb545-11"><a aria-hidden="true" href="#cb545-11" tabindex="-1"></a>\<span class="cf">if</span> <span class="ch">:scale</span> <span class="op">&gt;=</span> <span class="dv">100</span></span>
<span id="cb545-12"><a aria-hidden="true" href="#cb545-12" tabindex="-1"></a>  <span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> large_table <span class="kw">WHERE</span> <span class="kw">id</span> <span class="op">=</span> <span class="ch">:aid</span>;</span>
<span id="cb545-13"><a aria-hidden="true" href="#cb545-13" tabindex="-1"></a>\<span class="cf">else</span></span>
<span id="cb545-14"><a aria-hidden="true" href="#cb545-14" tabindex="-1"></a>  <span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> small_table <span class="kw">WHERE</span> <span class="kw">id</span> <span class="op">=</span> <span class="ch">:aid</span>;</span>
<span id="cb545-15"><a aria-hidden="true" href="#cb545-15" tabindex="-1"></a>\endif</span>
<span id="cb545-16"><a aria-hidden="true" href="#cb545-16" tabindex="-1"></a></span>
<span id="cb545-17"><a aria-hidden="true" href="#cb545-17" tabindex="-1"></a><span class="co">-- Sleep (microseconds)</span></span>
<span id="cb545-18"><a aria-hidden="true" href="#cb545-18" tabindex="-1"></a>\sleep <span class="dv">1000</span> us</span>
<span id="cb545-19"><a aria-hidden="true" href="#cb545-19" tabindex="-1"></a></span>
<span id="cb545-20"><a aria-hidden="true" href="#cb545-20" tabindex="-1"></a><span class="co">-- Set variable from query result</span></span>
<span id="cb545-21"><a aria-hidden="true" href="#cb545-21" tabindex="-1"></a>\setshell hostname hostname</span></code></pre></div>
<p><strong>Initialization Options</strong>:</p>
<div class="sourceCode" id="cb546"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb546-1"><a aria-hidden="true" href="#cb546-1" tabindex="-1"></a><span class="co"># Initialize with foreign keys</span></span>
<span id="cb546-2"><a aria-hidden="true" href="#cb546-2" tabindex="-1"></a><span class="ex">pgbench</span> <span class="at">-i</span> <span class="at">--foreign-keys</span> mydb</span>
<span id="cb546-3"><a aria-hidden="true" href="#cb546-3" tabindex="-1"></a></span>
<span id="cb546-4"><a aria-hidden="true" href="#cb546-4" tabindex="-1"></a><span class="co"># Initialize with tablespaces</span></span>
<span id="cb546-5"><a aria-hidden="true" href="#cb546-5" tabindex="-1"></a><span class="ex">pgbench</span> <span class="at">-i</span> <span class="at">--tablespace</span><span class="op">=</span>fast_ssd mydb</span>
<span id="cb546-6"><a aria-hidden="true" href="#cb546-6" tabindex="-1"></a><span class="ex">pgbench</span> <span class="at">-i</span> <span class="at">--index-tablespace</span><span class="op">=</span>fast_ssd mydb</span>
<span id="cb546-7"><a aria-hidden="true" href="#cb546-7" tabindex="-1"></a></span>
<span id="cb546-8"><a aria-hidden="true" href="#cb546-8" tabindex="-1"></a><span class="co"># Initialize partitioned tables (v12+)</span></span>
<span id="cb546-9"><a aria-hidden="true" href="#cb546-9" tabindex="-1"></a><span class="ex">pgbench</span> <span class="at">-i</span> <span class="at">--partitions</span><span class="op">=</span>10 mydb</span>
<span id="cb546-10"><a aria-hidden="true" href="#cb546-10" tabindex="-1"></a></span>
<span id="cb546-11"><a aria-hidden="true" href="#cb546-11" tabindex="-1"></a><span class="co"># Initialize without vacuuming</span></span>
<span id="cb546-12"><a aria-hidden="true" href="#cb546-12" tabindex="-1"></a><span class="ex">pgbench</span> <span class="at">-i</span> <span class="at">--no-vacuum</span> mydb</span>
<span id="cb546-13"><a aria-hidden="true" href="#cb546-13" tabindex="-1"></a></span>
<span id="cb546-14"><a aria-hidden="true" href="#cb546-14" tabindex="-1"></a><span class="co"># Initialize only specific tables</span></span>
<span id="cb546-15"><a aria-hidden="true" href="#cb546-15" tabindex="-1"></a><span class="ex">pgbench</span> <span class="at">-i</span> <span class="at">--init-steps</span><span class="op">=</span>dtv mydb  <span class="co"># d=drop, t=create tables, v=vacuum</span></span></code></pre></div>
<h3 data-number="9.8.4" id="output-interpretation"><span class="header-section-number">9.8.4</span> 7.4 Output
Interpretation</h3>
<p><strong>Standard Output</strong>:</p>
<pre><code>starting vacuum...end.
transaction type: &lt;builtin: TPC-B (sort of)&gt;
scaling factor: 10
query mode: simple
number of clients: 10
number of threads: 1
number of transactions per client: 1000
number of transactions actually processed: 10000/10000
latency average = 15.844 ms
tps = 631.234567 (including connections establishing)
tps = 631.456789 (excluding connections establishing)</code></pre>
<p><strong>With Latency Details</strong> (<code>--latency</code>):</p>
<pre><code>...
latency average = 15.844 ms
latency stddev = 8.234 ms
tps = 631.234567 (including connections establishing)
tps = 631.456789 (excluding connections establishing)</code></pre>
<p><strong>With Progress</strong> (<code>--progress=5</code>):</p>
<pre><code>progress: 5.0 s, 645.2 tps, lat 15.484 ms stddev 7.823
progress: 10.0 s, 638.4 tps, lat 15.657 ms stddev 8.142
progress: 15.0 s, 651.8 tps, lat 15.342 ms stddev 7.654
...</code></pre>
<p><strong>Percentile Latencies</strong>:</p>
<pre><code>latency average = 15.844 ms
latency stddev = 8.234 ms
initial connection time = 12.345 ms
tps = 631.234567 (without initial connection time)

statement latencies in milliseconds:
         0.002  \set aid random(1, 100000 * :scale)
         0.001  \set bid random(1, 1 * :scale)
         0.001  \set tid random(1, 10 * :scale)
         0.001  \set delta random(-5000, 5000)
         0.153  BEGIN;
         0.245  UPDATE pgbench_accounts SET abalance = abalance + :delta WHERE aid = :aid;
         0.187  SELECT abalance FROM pgbench_accounts WHERE aid = :aid;
         0.231  UPDATE pgbench_tellers SET tbalance = tbalance + :delta WHERE tid = :tid;
         0.219  UPDATE pgbench_branches SET bbalance = bbalance + :delta WHERE bid = :bid;
         0.198  INSERT INTO pgbench_history (tid, bid, aid, delta, mtime) VALUES (:tid, :bid, :aid, :delta, CURRENT_TIMESTAMP);
        14.607  END;</code></pre>
<h3 data-number="9.8.5" id="backend-integration-1"><span class="header-section-number">9.8.5</span> 7.5 Backend Integration</h3>
<p>pgbench uses standard libpq for all database operations: - Can use
simple, extended, or prepared statement protocols - Supports pipeline
mode (PostgreSQL 14+) - Creates standard connection per client/thread -
No special backend support required</p>
<p><strong>Performance Considerations</strong>: - Scale factor
determines dataset size (scale 100 = 10M accounts ‚âà 1.5GB) - More
clients than CPU cores can show contention - Thread count should
typically match CPU cores - Rate limiting useful for steady-state
testing - Connection pooling (external) recommended for high client
counts</p>
<h2 data-number="9.9" id="utility-program-infrastructure"><span class="header-section-number">9.9</span> 8. Utility Program
Infrastructure</h2>
<h3 data-number="9.9.1" id="shared-components"><span class="header-section-number">9.9.1</span> 8.1 Shared Components</h3>
<p>All PostgreSQL utilities share common infrastructure located in:</p>
<p><strong>Frontend Utilities Library</strong>
(<code>src/fe_utils/</code>): - <code>option_utils.c</code> -
Command-line option parsing - <code>string_utils.c</code> - String
manipulation - <code>print.c</code> - Result formatting (used by psql) -
<code>connect.c</code> - Connection handling -
<code>parallel_slot.c</code> - Parallel execution framework -
<code>simple_list.c</code> - Simple list data structure -
<code>query_utils.c</code> - Query execution helpers</p>
<p><strong>Common Code</strong> (<code>src/common/</code>): -
<code>logging.c</code> - Unified logging framework -
<code>file_utils.c</code> - File operations -
<code>controldata_utils.c</code> - pg_control reading -
<code>fe_memutils.c</code> - Memory allocation wrappers -
<code>username.c</code> - Username detection -
<code>restricted_token.c</code> - Windows security</p>
<p><strong>LibPQ Integration</strong>: All utilities use libpq
(<code>src/interfaces/libpq/</code>) for server communication: -
Connection management - Query execution - Result processing - Error
handling - Protocol-level features (COPY, prepared statements, pipeline
mode)</p>
<h3 data-number="9.9.2" id="connection-handling-patterns"><span class="header-section-number">9.9.2</span> 8.2 Connection Handling
Patterns</h3>
<p><strong>Standard Connection Flow</strong>:</p>
<div class="sourceCode" id="cb551"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb551-1"><a aria-hidden="true" href="#cb551-1" tabindex="-1"></a><span class="co">// Typical connection pattern</span></span>
<span id="cb551-2"><a aria-hidden="true" href="#cb551-2" tabindex="-1"></a>PGconn <span class="op">*</span>conn <span class="op">=</span> PQconnectdb<span class="op">(</span>connstring<span class="op">);</span></span>
<span id="cb551-3"><a aria-hidden="true" href="#cb551-3" tabindex="-1"></a><span class="cf">if</span> <span class="op">(</span>PQstatus<span class="op">(</span>conn<span class="op">)</span> <span class="op">!=</span> CONNECTION_OK<span class="op">)</span> <span class="op">{</span></span>
<span id="cb551-4"><a aria-hidden="true" href="#cb551-4" tabindex="-1"></a>    fprintf<span class="op">(</span>stderr<span class="op">,</span> <span class="st">"Connection failed: </span><span class="sc">%s</span><span class="st">"</span><span class="op">,</span> PQerrorMessage<span class="op">(</span>conn<span class="op">));</span></span>
<span id="cb551-5"><a aria-hidden="true" href="#cb551-5" tabindex="-1"></a>    exit<span class="op">(</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb551-6"><a aria-hidden="true" href="#cb551-6" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb551-7"><a aria-hidden="true" href="#cb551-7" tabindex="-1"></a></span>
<span id="cb551-8"><a aria-hidden="true" href="#cb551-8" tabindex="-1"></a><span class="co">// Execute query</span></span>
<span id="cb551-9"><a aria-hidden="true" href="#cb551-9" tabindex="-1"></a>PGresult <span class="op">*</span>res <span class="op">=</span> PQexec<span class="op">(</span>conn<span class="op">,</span> <span class="st">"SELECT version()"</span><span class="op">);</span></span>
<span id="cb551-10"><a aria-hidden="true" href="#cb551-10" tabindex="-1"></a><span class="cf">if</span> <span class="op">(</span>PQresultStatus<span class="op">(</span>res<span class="op">)</span> <span class="op">!=</span> PGRES_TUPLES_OK<span class="op">)</span> <span class="op">{</span></span>
<span id="cb551-11"><a aria-hidden="true" href="#cb551-11" tabindex="-1"></a>    <span class="co">// Error handling</span></span>
<span id="cb551-12"><a aria-hidden="true" href="#cb551-12" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb551-13"><a aria-hidden="true" href="#cb551-13" tabindex="-1"></a></span>
<span id="cb551-14"><a aria-hidden="true" href="#cb551-14" tabindex="-1"></a><span class="co">// Process results</span></span>
<span id="cb551-15"><a aria-hidden="true" href="#cb551-15" tabindex="-1"></a><span class="co">// ...</span></span>
<span id="cb551-16"><a aria-hidden="true" href="#cb551-16" tabindex="-1"></a></span>
<span id="cb551-17"><a aria-hidden="true" href="#cb551-17" tabindex="-1"></a>PQclear<span class="op">(</span>res<span class="op">);</span></span>
<span id="cb551-18"><a aria-hidden="true" href="#cb551-18" tabindex="-1"></a>PQfinish<span class="op">(</span>conn<span class="op">);</span></span></code></pre></div>
<p><strong>Connection String Formats</strong>:</p>
<div class="sourceCode" id="cb552"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb552-1"><a aria-hidden="true" href="#cb552-1" tabindex="-1"></a><span class="co"># Keyword/value format</span></span>
<span id="cb552-2"><a aria-hidden="true" href="#cb552-2" tabindex="-1"></a><span class="st">"host=localhost port=5432 dbname=mydb user=postgres"</span></span>
<span id="cb552-3"><a aria-hidden="true" href="#cb552-3" tabindex="-1"></a></span>
<span id="cb552-4"><a aria-hidden="true" href="#cb552-4" tabindex="-1"></a><span class="co"># URI format</span></span>
<span id="cb552-5"><a aria-hidden="true" href="#cb552-5" tabindex="-1"></a><span class="st">"postgresql://postgres@localhost:5432/mydb"</span></span>
<span id="cb552-6"><a aria-hidden="true" href="#cb552-6" tabindex="-1"></a></span>
<span id="cb552-7"><a aria-hidden="true" href="#cb552-7" tabindex="-1"></a><span class="co"># With multiple hosts (failover)</span></span>
<span id="cb552-8"><a aria-hidden="true" href="#cb552-8" tabindex="-1"></a><span class="st">"host=primary,standby port=5432,5432 dbname=mydb"</span></span></code></pre></div>
<h3 data-number="9.9.3" id="logging-framework"><span class="header-section-number">9.9.3</span> 8.3 Logging Framework</h3>
<p>All modern utilities use the unified logging framework:</p>
<div class="sourceCode" id="cb553"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb553-1"><a aria-hidden="true" href="#cb553-1" tabindex="-1"></a><span class="pp">#include </span><span class="im">"common/logging.h"</span></span>
<span id="cb553-2"><a aria-hidden="true" href="#cb553-2" tabindex="-1"></a></span>
<span id="cb553-3"><a aria-hidden="true" href="#cb553-3" tabindex="-1"></a><span class="co">// Set program name</span></span>
<span id="cb553-4"><a aria-hidden="true" href="#cb553-4" tabindex="-1"></a>pg_logging_init<span class="op">(</span>argv<span class="op">[</span><span class="dv">0</span><span class="op">]);</span></span>
<span id="cb553-5"><a aria-hidden="true" href="#cb553-5" tabindex="-1"></a></span>
<span id="cb553-6"><a aria-hidden="true" href="#cb553-6" tabindex="-1"></a><span class="co">// Log messages at different levels</span></span>
<span id="cb553-7"><a aria-hidden="true" href="#cb553-7" tabindex="-1"></a>pg_log_error<span class="op">(</span><span class="st">"Connection failed"</span><span class="op">);</span></span>
<span id="cb553-8"><a aria-hidden="true" href="#cb553-8" tabindex="-1"></a>pg_log_warning<span class="op">(</span><span class="st">"Table not found, skipping"</span><span class="op">);</span></span>
<span id="cb553-9"><a aria-hidden="true" href="#cb553-9" tabindex="-1"></a>pg_log_info<span class="op">(</span><span class="st">"Processing 1000 tables"</span><span class="op">);</span></span>
<span id="cb553-10"><a aria-hidden="true" href="#cb553-10" tabindex="-1"></a>pg_log_debug<span class="op">(</span><span class="st">"Query: </span><span class="sc">%s</span><span class="st">"</span><span class="op">,</span> query<span class="op">);</span></span>
<span id="cb553-11"><a aria-hidden="true" href="#cb553-11" tabindex="-1"></a></span>
<span id="cb553-12"><a aria-hidden="true" href="#cb553-12" tabindex="-1"></a><span class="co">// Fatal error (logs and exits)</span></span>
<span id="cb553-13"><a aria-hidden="true" href="#cb553-13" tabindex="-1"></a>pg_fatal<span class="op">(</span><span class="st">"Cannot continue: </span><span class="sc">%s</span><span class="st">"</span><span class="op">,</span> reason<span class="op">);</span></span></code></pre></div>
<p><strong>Log Levels</strong>: - <code>PG_LOG_ERROR</code> - Errors
(non-fatal) - <code>PG_LOG_WARNING</code> - Warnings -
<code>PG_LOG_INFO</code> - Informational messages -
<code>PG_LOG_DEBUG</code> - Debug output - <code>PG_LOG_FATAL</code> -
Fatal errors (exit program)</p>
<h3 data-number="9.9.4" id="error-handling-conventions"><span class="header-section-number">9.9.4</span> 8.4 Error Handling
Conventions</h3>
<p><strong>Exit Codes</strong>: - <code>0</code> - Success -
<code>1</code> - General error - <code>2</code> - Connection error -
<code>3</code> - Script error (psql)</p>
<p><strong>Error Reporting</strong>: All utilities report errors to
stderr and provide meaningful messages including: - Context of the
operation - Specific error details - Suggested remediation when
possible</p>
<h2 data-number="9.10" id="platform-considerations"><span class="header-section-number">9.10</span> 9. Platform
Considerations</h2>
<h3 data-number="9.10.1" id="unixlinux"><span class="header-section-number">9.10.1</span> 9.1 Unix/Linux</h3>
<p><strong>Installation Paths</strong>: - Binaries:
<code>/usr/bin/</code> or <code>/usr/local/pgsql/bin/</code> -
Libraries: <code>/usr/lib/</code> or <code>/usr/local/pgsql/lib/</code>
- Data: Typically <code>/var/lib/postgresql/</code> or custom
location</p>
<p><strong>Signal Handling</strong>: - <code>SIGTERM</code> - Fast
shutdown - <code>SIGINT</code> - Fast shutdown (Ctrl+C) -
<code>SIGQUIT</code> - Immediate shutdown - <code>SIGHUP</code> - Reload
configuration</p>
<h3 data-number="9.10.2" id="windows"><span class="header-section-number">9.10.2</span> 9.2 Windows</h3>
<p><strong>Service Management</strong>:</p>
<div class="sourceCode" id="cb554"><pre class="sourceCode cmd"><code class="sourceCode dosbat"><span id="cb554-1"><a aria-hidden="true" href="#cb554-1" tabindex="-1"></a># Register as Windows service</span>
<span id="cb554-2"><a aria-hidden="true" href="#cb554-2" tabindex="-1"></a>pg_ctl register <span class="at">-N</span> <span class="st">"PostgreSQL"</span> <span class="at">-D</span> <span class="st">"C:\data"</span></span>
<span id="cb554-3"><a aria-hidden="true" href="#cb554-3" tabindex="-1"></a></span>
<span id="cb554-4"><a aria-hidden="true" href="#cb554-4" tabindex="-1"></a># Unregister service</span>
<span id="cb554-5"><a aria-hidden="true" href="#cb554-5" tabindex="-1"></a>pg_ctl unregister <span class="at">-N</span> <span class="st">"PostgreSQL"</span></span></code></pre></div>
<p><strong>Path Differences</strong>: - Binaries:
<code>C:\Program Files\PostgreSQL\15\bin\</code> - Data:
<code>C:\Program Files\PostgreSQL\15\data\</code> - Configuration: Same
directory as Unix but backslashes</p>
<p><strong>Authentication</strong>: - Supports Windows SSPI
authentication - Can run as Windows service account - Integrated Windows
authentication available</p>
<h2 data-number="9.11" id="best-practices-and-guidelines"><span class="header-section-number">9.11</span> 10. Best Practices and
Guidelines</h2>
<h3 data-number="9.11.1" id="backup-strategies"><span class="header-section-number">9.11.1</span> 10.1 Backup Strategies</h3>
<p><strong>Logical Backups (pg_dump)</strong>: - <strong>Use
for</strong>: Individual databases, partial backups, cross-version
compatibility - <strong>Pros</strong>: Portable, selective,
human-readable (plain format) - <strong>Cons</strong>: Slower, larger,
requires restore time</p>
<p><strong>Physical Backups (pg_basebackup)</strong>: - <strong>Use
for</strong>: Entire clusters, PITR, standby setup -
<strong>Pros</strong>: Fast, exact copy, streaming replication
compatible - <strong>Cons</strong>: Not portable, version-specific,
all-or-nothing</p>
<p><strong>Recommended Approach</strong>:</p>
<div class="sourceCode" id="cb555"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb555-1"><a aria-hidden="true" href="#cb555-1" tabindex="-1"></a><span class="co"># Daily basebackup for PITR</span></span>
<span id="cb555-2"><a aria-hidden="true" href="#cb555-2" tabindex="-1"></a><span class="ex">pg_basebackup</span> <span class="at">-D</span> /backup/<span class="va">$(</span><span class="fu">date</span> +%Y%m%d<span class="va">)</span> <span class="at">-Ft</span> <span class="at">-z</span> <span class="at">-X</span> stream</span>
<span id="cb555-3"><a aria-hidden="true" href="#cb555-3" tabindex="-1"></a></span>
<span id="cb555-4"><a aria-hidden="true" href="#cb555-4" tabindex="-1"></a><span class="co"># Weekly logical backup for portability</span></span>
<span id="cb555-5"><a aria-hidden="true" href="#cb555-5" tabindex="-1"></a><span class="ex">pg_dump</span> <span class="at">-Fc</span> mydb <span class="op">&gt;</span> /backup/weekly/mydb-<span class="va">$(</span><span class="fu">date</span> +%Y%m%d<span class="va">)</span>.dump</span>
<span id="cb555-6"><a aria-hidden="true" href="#cb555-6" tabindex="-1"></a></span>
<span id="cb555-7"><a aria-hidden="true" href="#cb555-7" tabindex="-1"></a><span class="co"># Keep WAL archives for point-in-time recovery</span></span>
<span id="cb555-8"><a aria-hidden="true" href="#cb555-8" tabindex="-1"></a><span class="co"># (configure archive_command in postgresql.conf)</span></span></code></pre></div>
<h3 data-number="9.11.2" id="maintenance-schedules"><span class="header-section-number">9.11.2</span> 10.2 Maintenance
Schedules</h3>
<p><strong>Regular Maintenance</strong>:</p>
<div class="sourceCode" id="cb556"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb556-1"><a aria-hidden="true" href="#cb556-1" tabindex="-1"></a><span class="co"># Daily: Vacuum and analyze</span></span>
<span id="cb556-2"><a aria-hidden="true" href="#cb556-2" tabindex="-1"></a><span class="ex">vacuumdb</span> <span class="at">-z</span> <span class="at">-a</span></span>
<span id="cb556-3"><a aria-hidden="true" href="#cb556-3" tabindex="-1"></a></span>
<span id="cb556-4"><a aria-hidden="true" href="#cb556-4" tabindex="-1"></a><span class="co"># Weekly: More aggressive vacuum</span></span>
<span id="cb556-5"><a aria-hidden="true" href="#cb556-5" tabindex="-1"></a><span class="ex">vacuumdb</span> <span class="at">--analyze-in-stages</span> <span class="at">-a</span></span>
<span id="cb556-6"><a aria-hidden="true" href="#cb556-6" tabindex="-1"></a></span>
<span id="cb556-7"><a aria-hidden="true" href="#cb556-7" tabindex="-1"></a><span class="co"># Monthly: Reindex critical indexes</span></span>
<span id="cb556-8"><a aria-hidden="true" href="#cb556-8" tabindex="-1"></a><span class="ex">reindexdb</span> <span class="at">--concurrently</span> <span class="at">-t</span> critical_table mydb</span>
<span id="cb556-9"><a aria-hidden="true" href="#cb556-9" tabindex="-1"></a></span>
<span id="cb556-10"><a aria-hidden="true" href="#cb556-10" tabindex="-1"></a><span class="co"># As needed: Cluster frequently accessed tables</span></span>
<span id="cb556-11"><a aria-hidden="true" href="#cb556-11" tabindex="-1"></a><span class="ex">clusterdb</span> <span class="at">-t</span> hot_table mydb</span></code></pre></div>
<p><strong>Monitoring</strong>:</p>
<div class="sourceCode" id="cb557"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb557-1"><a aria-hidden="true" href="#cb557-1" tabindex="-1"></a><span class="co"># Check server status</span></span>
<span id="cb557-2"><a aria-hidden="true" href="#cb557-2" tabindex="-1"></a><span class="ex">pg_isready</span> <span class="kw">&amp;&amp;</span> <span class="bu">echo</span> <span class="st">"Server ready"</span> <span class="kw">||</span> <span class="bu">echo</span> <span class="st">"Server down"</span></span>
<span id="cb557-3"><a aria-hidden="true" href="#cb557-3" tabindex="-1"></a></span>
<span id="cb557-4"><a aria-hidden="true" href="#cb557-4" tabindex="-1"></a><span class="co"># Monitor WAL usage</span></span>
<span id="cb557-5"><a aria-hidden="true" href="#cb557-5" tabindex="-1"></a><span class="ex">pg_waldump</span> <span class="at">--stats</span><span class="op">=</span>record /data/pg_wal/latest</span>
<span id="cb557-6"><a aria-hidden="true" href="#cb557-6" tabindex="-1"></a></span>
<span id="cb557-7"><a aria-hidden="true" href="#cb557-7" tabindex="-1"></a><span class="co"># Check for corruption</span></span>
<span id="cb557-8"><a aria-hidden="true" href="#cb557-8" tabindex="-1"></a><span class="ex">pg_amcheck</span> <span class="at">-a</span> <span class="at">--progress</span></span></code></pre></div>
<h3 data-number="9.11.3" id="performance-testing"><span class="header-section-number">9.11.3</span> 10.3 Performance
Testing</h3>
<p><strong>pgbench Best Practices</strong>:</p>
<div class="sourceCode" id="cb558"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb558-1"><a aria-hidden="true" href="#cb558-1" tabindex="-1"></a><span class="co"># 1. Size database appropriately (scale ‚âà 10√ó RAM for realistic test)</span></span>
<span id="cb558-2"><a aria-hidden="true" href="#cb558-2" tabindex="-1"></a><span class="ex">pgbench</span> <span class="at">-i</span> <span class="at">-s</span> 1000 testdb</span>
<span id="cb558-3"><a aria-hidden="true" href="#cb558-3" tabindex="-1"></a></span>
<span id="cb558-4"><a aria-hidden="true" href="#cb558-4" tabindex="-1"></a><span class="co"># 2. Warm up database</span></span>
<span id="cb558-5"><a aria-hidden="true" href="#cb558-5" tabindex="-1"></a><span class="ex">pgbench</span> <span class="at">-c</span> 10 <span class="at">-T</span> 60 <span class="at">-S</span> testdb</span>
<span id="cb558-6"><a aria-hidden="true" href="#cb558-6" tabindex="-1"></a></span>
<span id="cb558-7"><a aria-hidden="true" href="#cb558-7" tabindex="-1"></a><span class="co"># 3. Run actual benchmark with latency tracking</span></span>
<span id="cb558-8"><a aria-hidden="true" href="#cb558-8" tabindex="-1"></a><span class="ex">pgbench</span> <span class="at">-c</span> 50 <span class="at">-j</span> 8 <span class="at">-T</span> 600 <span class="at">--progress</span><span class="op">=</span>10 <span class="at">--latency</span> testdb</span>
<span id="cb558-9"><a aria-hidden="true" href="#cb558-9" tabindex="-1"></a></span>
<span id="cb558-10"><a aria-hidden="true" href="#cb558-10" tabindex="-1"></a><span class="co"># 4. Test different scenarios</span></span>
<span id="cb558-11"><a aria-hidden="true" href="#cb558-11" tabindex="-1"></a><span class="ex">pgbench</span> <span class="at">-c</span> 50 <span class="at">-T</span> 300 <span class="at">-S</span> testdb          <span class="co"># Read-heavy</span></span>
<span id="cb558-12"><a aria-hidden="true" href="#cb558-12" tabindex="-1"></a><span class="ex">pgbench</span> <span class="at">-c</span> 50 <span class="at">-T</span> 300 testdb             <span class="co"># Write-heavy</span></span>
<span id="cb558-13"><a aria-hidden="true" href="#cb558-13" tabindex="-1"></a><span class="ex">pgbench</span> <span class="at">-c</span> 50 <span class="at">-T</span> 300 <span class="at">-f</span> custom.sql testdb  <span class="co"># Custom workload</span></span></code></pre></div>
<h3 data-number="9.11.4" id="security-considerations-2"><span class="header-section-number">9.11.4</span> 10.4 Security
Considerations</h3>
<p><strong>Authentication</strong>:</p>
<div class="sourceCode" id="cb559"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb559-1"><a aria-hidden="true" href="#cb559-1" tabindex="-1"></a><span class="co"># Always use strong authentication in pg_hba.conf</span></span>
<span id="cb559-2"><a aria-hidden="true" href="#cb559-2" tabindex="-1"></a><span class="co"># Prefer scram-sha-256 over md5</span></span>
<span id="cb559-3"><a aria-hidden="true" href="#cb559-3" tabindex="-1"></a><span class="ex">initdb</span> <span class="at">--auth-host</span><span class="op">=</span>scram-sha-256 <span class="at">--auth-local</span><span class="op">=</span>peer <span class="at">-D</span> /data</span>
<span id="cb559-4"><a aria-hidden="true" href="#cb559-4" tabindex="-1"></a></span>
<span id="cb559-5"><a aria-hidden="true" href="#cb559-5" tabindex="-1"></a><span class="co"># Use connection service files to avoid passwords in scripts</span></span>
<span id="cb559-6"><a aria-hidden="true" href="#cb559-6" tabindex="-1"></a><span class="co"># ~/.pg_service.conf:</span></span>
<span id="cb559-7"><a aria-hidden="true" href="#cb559-7" tabindex="-1"></a><span class="co"># [production]</span></span>
<span id="cb559-8"><a aria-hidden="true" href="#cb559-8" tabindex="-1"></a><span class="co"># host=db.example.com</span></span>
<span id="cb559-9"><a aria-hidden="true" href="#cb559-9" tabindex="-1"></a><span class="co"># dbname=mydb</span></span>
<span id="cb559-10"><a aria-hidden="true" href="#cb559-10" tabindex="-1"></a><span class="co"># user=admin</span></span>
<span id="cb559-11"><a aria-hidden="true" href="#cb559-11" tabindex="-1"></a></span>
<span id="cb559-12"><a aria-hidden="true" href="#cb559-12" tabindex="-1"></a><span class="co"># Then: psql service=production</span></span></code></pre></div>
<p><strong>File Permissions</strong>: - Data directory must be owned by
postgres user - Mode 0700 (read/write/execute for owner only) -
Utilities enforce these restrictions</p>
<p><strong>Network Security</strong>:</p>
<div class="sourceCode" id="cb560"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb560-1"><a aria-hidden="true" href="#cb560-1" tabindex="-1"></a><span class="co"># Use SSL for remote connections</span></span>
<span id="cb560-2"><a aria-hidden="true" href="#cb560-2" tabindex="-1"></a><span class="ex">psql</span> <span class="st">"sslmode=require host=remote dbname=mydb"</span></span>
<span id="cb560-3"><a aria-hidden="true" href="#cb560-3" tabindex="-1"></a></span>
<span id="cb560-4"><a aria-hidden="true" href="#cb560-4" tabindex="-1"></a><span class="co"># Verify server certificate</span></span>
<span id="cb560-5"><a aria-hidden="true" href="#cb560-5" tabindex="-1"></a><span class="ex">psql</span> <span class="st">"sslmode=verify-full sslrootcert=/path/to/ca.crt host=remote dbname=mydb"</span></span></code></pre></div>
<h2 data-number="9.12" id="troubleshooting-common-issues"><span class="header-section-number">9.12</span> 11. Troubleshooting Common
Issues</h2>
<h3 data-number="9.12.1" id="connection-problems"><span class="header-section-number">9.12.1</span> 11.1 Connection
Problems</h3>
<p><strong>Issue</strong>: Cannot connect to server</p>
<div class="sourceCode" id="cb561"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb561-1"><a aria-hidden="true" href="#cb561-1" tabindex="-1"></a><span class="co"># Check if server is running</span></span>
<span id="cb561-2"><a aria-hidden="true" href="#cb561-2" tabindex="-1"></a><span class="ex">pg_isready</span> <span class="at">-h</span> localhost <span class="at">-p</span> 5432</span>
<span id="cb561-3"><a aria-hidden="true" href="#cb561-3" tabindex="-1"></a></span>
<span id="cb561-4"><a aria-hidden="true" href="#cb561-4" tabindex="-1"></a><span class="co"># Verify pg_hba.conf allows connection</span></span>
<span id="cb561-5"><a aria-hidden="true" href="#cb561-5" tabindex="-1"></a><span class="co"># Check PostgreSQL logs for authentication errors</span></span>
<span id="cb561-6"><a aria-hidden="true" href="#cb561-6" tabindex="-1"></a></span>
<span id="cb561-7"><a aria-hidden="true" href="#cb561-7" tabindex="-1"></a><span class="co"># Test with different authentication</span></span>
<span id="cb561-8"><a aria-hidden="true" href="#cb561-8" tabindex="-1"></a><span class="ex">psql</span> <span class="at">-h</span> localhost <span class="at">-U</span> postgres postgres</span></code></pre></div>
<p><strong>Issue</strong>: Too many connections</p>
<div class="sourceCode" id="cb562"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb562-1"><a aria-hidden="true" href="#cb562-1" tabindex="-1"></a><span class="co"># Check current connections</span></span>
<span id="cb562-2"><a aria-hidden="true" href="#cb562-2" tabindex="-1"></a><span class="ex">psql</span> <span class="at">-c</span> <span class="st">"SELECT count(*) FROM pg_stat_activity"</span></span>
<span id="cb562-3"><a aria-hidden="true" href="#cb562-3" tabindex="-1"></a></span>
<span id="cb562-4"><a aria-hidden="true" href="#cb562-4" tabindex="-1"></a><span class="co"># Adjust max_connections in postgresql.conf</span></span>
<span id="cb562-5"><a aria-hidden="true" href="#cb562-5" tabindex="-1"></a><span class="co"># Use connection pooling (pgBouncer, pgpool)</span></span></code></pre></div>
<h3 data-number="9.12.2" id="backuprestore-issues"><span class="header-section-number">9.12.2</span> 11.2 Backup/Restore
Issues</h3>
<p><strong>Issue</strong>: pg_dump fails with ‚Äúcache lookup failed‚Äù</p>
<div class="sourceCode" id="cb563"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb563-1"><a aria-hidden="true" href="#cb563-1" tabindex="-1"></a><span class="co"># Someone performed DDL during dump</span></span>
<span id="cb563-2"><a aria-hidden="true" href="#cb563-2" tabindex="-1"></a><span class="co"># Use --no-synchronized-snapshots (less safe) or</span></span>
<span id="cb563-3"><a aria-hidden="true" href="#cb563-3" tabindex="-1"></a><span class="co"># Ensure no concurrent DDL during backup window</span></span></code></pre></div>
<p><strong>Issue</strong>: pg_restore out of memory</p>
<div class="sourceCode" id="cb564"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb564-1"><a aria-hidden="true" href="#cb564-1" tabindex="-1"></a><span class="co"># Restore in smaller chunks</span></span>
<span id="cb564-2"><a aria-hidden="true" href="#cb564-2" tabindex="-1"></a><span class="ex">pg_restore</span> <span class="at">-l</span> backup.dump <span class="op">&gt;</span> toc.list</span>
<span id="cb564-3"><a aria-hidden="true" href="#cb564-3" tabindex="-1"></a><span class="co"># Edit toc.list to select subset</span></span>
<span id="cb564-4"><a aria-hidden="true" href="#cb564-4" tabindex="-1"></a><span class="ex">pg_restore</span> <span class="at">-L</span> toc.list <span class="at">-d</span> mydb backup.dump</span></code></pre></div>
<h3 data-number="9.12.3" id="performance-issues"><span class="header-section-number">9.12.3</span> 11.3 Performance Issues</h3>
<p><strong>Issue</strong>: pgbench shows low TPS</p>
<div class="sourceCode" id="cb565"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb565-1"><a aria-hidden="true" href="#cb565-1" tabindex="-1"></a><span class="co"># Check for I/O bottlenecks</span></span>
<span id="cb565-2"><a aria-hidden="true" href="#cb565-2" tabindex="-1"></a><span class="ex">pg_test_fsync</span></span>
<span id="cb565-3"><a aria-hidden="true" href="#cb565-3" tabindex="-1"></a></span>
<span id="cb565-4"><a aria-hidden="true" href="#cb565-4" tabindex="-1"></a><span class="co"># Tune PostgreSQL configuration</span></span>
<span id="cb565-5"><a aria-hidden="true" href="#cb565-5" tabindex="-1"></a><span class="co"># - shared_buffers (25% of RAM)</span></span>
<span id="cb565-6"><a aria-hidden="true" href="#cb565-6" tabindex="-1"></a><span class="co"># - effective_cache_size (50-75% of RAM)</span></span>
<span id="cb565-7"><a aria-hidden="true" href="#cb565-7" tabindex="-1"></a><span class="co"># - work_mem (RAM / max_connections / 2)</span></span>
<span id="cb565-8"><a aria-hidden="true" href="#cb565-8" tabindex="-1"></a></span>
<span id="cb565-9"><a aria-hidden="true" href="#cb565-9" tabindex="-1"></a><span class="co"># Monitor with pg_stat_statements</span></span>
<span id="cb565-10"><a aria-hidden="true" href="#cb565-10" tabindex="-1"></a><span class="ex">psql</span> <span class="at">-c</span> <span class="st">"CREATE EXTENSION pg_stat_statements"</span></span></code></pre></div>
<p><strong>Issue</strong>: Vacuum/analyze taking too long</p>
<div class="sourceCode" id="cb566"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb566-1"><a aria-hidden="true" href="#cb566-1" tabindex="-1"></a><span class="co"># Use parallel workers</span></span>
<span id="cb566-2"><a aria-hidden="true" href="#cb566-2" tabindex="-1"></a><span class="ex">vacuumdb</span> <span class="at">-j</span> 4 mydb</span>
<span id="cb566-3"><a aria-hidden="true" href="#cb566-3" tabindex="-1"></a></span>
<span id="cb566-4"><a aria-hidden="true" href="#cb566-4" tabindex="-1"></a><span class="co"># Check for long-running transactions (prevents vacuum)</span></span>
<span id="cb566-5"><a aria-hidden="true" href="#cb566-5" tabindex="-1"></a><span class="ex">psql</span> <span class="at">-c</span> <span class="st">"SELECT pid, state, age(clock_timestamp(), query_start)</span></span>
<span id="cb566-6"><a aria-hidden="true" href="#cb566-6" tabindex="-1"></a><span class="st">         FROM pg_stat_activity</span></span>
<span id="cb566-7"><a aria-hidden="true" href="#cb566-7" tabindex="-1"></a><span class="st">         WHERE state != 'idle'</span></span>
<span id="cb566-8"><a aria-hidden="true" href="#cb566-8" tabindex="-1"></a><span class="st">         ORDER BY age DESC"</span></span></code></pre></div>
<h2 data-number="9.13" id="future-directions-2"><span class="header-section-number">9.13</span> 12. Future Directions</h2>
<h3 data-number="9.13.1" id="recent-enhancements"><span class="header-section-number">9.13.1</span> 12.1 Recent
Enhancements</h3>
<p><strong>PostgreSQL 14</strong>: - Pipeline mode in libpq (supported
by psql, pgbench) - Compression in pg_basebackup
(<code>--compress=</code>) - pg_amcheck utility introduced</p>
<p><strong>PostgreSQL 15</strong>: - Server-side compression for
pg_basebackup - ICU collation improvements in initdb - Enhanced
pg_waldump filtering</p>
<p><strong>PostgreSQL 16</strong>: - Logical replication slot support in
pg_basebackup - Incremental backup support - Enhanced pg_stat_statements
in psql</p>
<h3 data-number="9.13.2" id="ongoing-development"><span class="header-section-number">9.13.2</span> 12.2 Ongoing
Development</h3>
<p><strong>Active Areas</strong>: - Incremental backup and restore -
Better parallel processing across utilities - Enhanced diagnostic
capabilities - Improved progress reporting - Cloud-native features</p>
<h2 data-number="9.14" id="conclusion-5"><span class="header-section-number">9.14</span> Conclusion</h2>
<p>PostgreSQL‚Äôs utility programs form a comprehensive ecosystem for
database administration, maintenance, and operations. From the powerful
psql interactive terminal to specialized tools like pg_waldump for WAL
analysis, each utility is designed to excel at specific tasks while
sharing common infrastructure.</p>
<p>Understanding these utilities is essential for: - <strong>Database
Administrators</strong>: Daily operations, backup/recovery,
troubleshooting - <strong>Developers</strong>: Testing, benchmarking,
database setup - <strong>DevOps Engineers</strong>: Automation,
monitoring, deployment - <strong>Database Reliability
Engineers</strong>: Disaster recovery, performance optimization</p>
<p>The utilities follow PostgreSQL‚Äôs philosophy of providing simple,
composable tools that do one thing well. They integrate seamlessly with
the backend through libpq and the PostgreSQL protocol, while remaining
independent enough to version and evolve separately.</p>
<p>Key takeaways: 1. <strong>Choose the right tool</strong>: Logical vs
physical backups, pg_upgrade vs dump/restore 2. <strong>Understand the
trade-offs</strong>: Speed vs safety, convenience vs control 3.
<strong>Leverage parallelism</strong>: Most modern utilities support
parallel operations 4. <strong>Practice safe operations</strong>: Use
dry-run modes, maintain backups, test in non-production 5.
<strong>Monitor and verify</strong>: Use diagnostic tools regularly,
verify backups, check for corruption</p>
<p>The PostgreSQL utility suite continues to evolve with each release,
adding new capabilities while maintaining backward compatibility and the
simplicity that makes them powerful tools for database
professionals.</p>
<h2 data-number="9.15" id="references-2"><span class="header-section-number">9.15</span> References</h2>
<p><strong>Source Code</strong>: - <code>src/bin/</code> - All utility
programs - <code>src/fe_utils/</code> - Frontend utilities library -
<code>src/common/</code> - Common code -
<code>src/interfaces/libpq/</code> - PostgreSQL client library</p>
<p><strong>Documentation</strong>: - PostgreSQL Documentation:
https://www.postgresql.org/docs/ - Client Applications reference -
Server Administration guide</p>
<p><strong>Related Backend Components</strong>: -
<code>src/backend/replication/basebackup.c</code> - pg_basebackup
backend - <code>src/backend/commands/vacuum.c</code> - VACUUM
implementation - <code>src/backend/postmaster/pgarch.c</code> - WAL
archiving - <code>src/backend/access/transam/xlog.c</code> - WAL
management</p>
<h1 data-number="10" id="chapter-8-historical-evolution-of-postgresql"><span class="header-section-number">10</span> Chapter 8: Historical Evolution
of PostgreSQL</h1>
<h2 data-number="10.1" id="from-berkeley-research-to-modern-enterprise-database"><span class="header-section-number">10.1</span> From Berkeley Research to
Modern Enterprise Database</h2>
<hr/>
<h2 data-number="10.2" id="introduction-4"><span class="header-section-number">10.2</span> Introduction</h2>
<p>PostgreSQL‚Äôs evolution from a university research project to the
world‚Äôs most advanced open source database spans nearly four decades.
This chapter documents how the codebase matured, how coding patterns
evolved, how performance improved, and how the community grew‚Äîall while
maintaining backward compatibility and data integrity as paramount
values.</p>
<p>Unlike many software projects that undergo complete rewrites,
PostgreSQL represents continuous evolution. The core architecture
established in the Berkeley POSTGRES era (1986-1994) remains
recognizable today, yet every subsystem has been refined, optimized, and
extended. This chapter tells the story of that evolution.</p>
<p><strong>Key Themes:</strong> - <strong>Incremental improvement over
revolution</strong>: No ‚Äúbig rewrites‚Äù - <strong>Performance through
refinement</strong>: Each version faster than the last -
<strong>Community-driven innovation</strong>: Features emerge from
real-world needs - <strong>Backward compatibility</strong>: Old
applications continue to work - <strong>Data integrity first</strong>:
Correctness before speed</p>
<hr/>
<h2 data-number="10.3" id="part-1-major-version-milestones"><span class="header-section-number">10.3</span> Part 1: Major Version
Milestones</h2>
<h3 data-number="10.3.1" id="the-version-numbering-history"><span class="header-section-number">10.3.1</span> The Version Numbering
History</h3>
<p>PostgreSQL‚Äôs version numbering tells a story:</p>
<p><strong>1986-1994</strong>: Berkeley POSTGRES versions 1.0 through
4.2 <strong>1995</strong>: Postgres95 version 0.01 through 1.x
<strong>1997-2016</strong>: PostgreSQL 6.0 through 9.6
(major.minor.patch) <strong>2017-present</strong>: PostgreSQL 10+
(major.patch) - Simplified numbering</p>
<p>The jump to version 6.0 in 1997 was deliberate‚Äîhonoring the Berkeley
heritage (versions 1-4.2) and Postgres95 era (~5.x).</p>
<p>Starting with version 10 (October 2017), PostgreSQL adopted simpler
numbering: major versions are 10, 11, 12, etc., with minor releases like
10.1, 10.2. This ended the confusing 9.6 ‚Üí 10 transition where users
wondered if 9.7 would come next.</p>
<hr/>
<h3 data-number="10.3.2" id="version-6.x-series-1997-1998-the-foundation"><span class="header-section-number">10.3.2</span> Version 6.x Series
(1997-1998): The Foundation</h3>
<p><strong>Release Date</strong>: January 29, 1997 (version 6.0)</p>
<p><strong>Significance</strong>: First official ‚ÄúPostgreSQL‚Äù release.
Established the project‚Äôs independence from Berkeley and marked the
transition to community-driven development.</p>
<p><strong>Key Features Introduced:</strong> - <strong>Multi-Version
Concurrency Control (MVCC)</strong> foundation - Non-blocking reads
established - Transaction isolation without read locks - Foundation for
all future concurrency work</p>
<ul>
<li><strong>SQL92 Compliance</strong> improvements
<ul>
<li>Subqueries fully supported</li>
<li>JOIN syntax modernized</li>
<li>Data type system expanded</li>
</ul></li>
<li><strong>Performance Infrastructure</strong>
<ul>
<li>Query optimizer cost-based planning</li>
<li>Statistics collection for planning</li>
<li>B-tree index improvements</li>
</ul></li>
</ul>
<p><strong>Architectural Decisions:</strong> - Process-per-connection
model established - Shared memory buffer cache architecture -
Write-ahead logging (WAL) groundwork laid</p>
<p><strong>Code Characteristics (1997-1998):</strong></p>
<div class="sourceCode" id="cb567"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb567-1"><a aria-hidden="true" href="#cb567-1" tabindex="-1"></a><span class="co">/* Typical memory allocation pattern from 6.x era */</span></span>
<span id="cb567-2"><a aria-hidden="true" href="#cb567-2" tabindex="-1"></a><span class="dt">char</span> <span class="op">*</span>ptr <span class="op">=</span> malloc<span class="op">(</span>size<span class="op">);</span></span>
<span id="cb567-3"><a aria-hidden="true" href="#cb567-3" tabindex="-1"></a><span class="cf">if</span> <span class="op">(!</span>ptr<span class="op">)</span></span>
<span id="cb567-4"><a aria-hidden="true" href="#cb567-4" tabindex="-1"></a>    elog<span class="op">(</span>ERROR<span class="op">,</span> <span class="st">"out of memory"</span><span class="op">);</span></span>
<span id="cb567-5"><a aria-hidden="true" href="#cb567-5" tabindex="-1"></a><span class="co">/* Use ptr */</span></span>
<span id="cb567-6"><a aria-hidden="true" href="#cb567-6" tabindex="-1"></a>free<span class="op">(</span>ptr<span class="op">);</span></span></code></pre></div>
<p>Simple, direct C code with manual memory management. Error handling
via <code>elog()</code> was already established.</p>
<p><strong>Community Context:</strong> - Mailing lists established
(pgsql-hackers, pgsql-general) - First CommitFests organized - ~20-30
regular contributors - Geographic distribution: primarily North America
and Europe</p>
<p><strong>Known Limitations:</strong> - No foreign keys yet - No outer
joins - Limited optimizer sophistication - No point-in-time recovery</p>
<p><strong>Database Sizes Supported:</strong> - Typical production
databases: 1-10 GB - Large databases: 50-100 GB - Hardware: Single-CPU
to 4-CPU systems with 128MB-1GB RAM</p>
<hr/>
<h3 data-number="10.3.3" id="version-7.x-series-2000-2004-enterprise-features"><span class="header-section-number">10.3.3</span> Version 7.x Series
(2000-2004): Enterprise Features</h3>
<p><strong>Release Date</strong>: May 8, 2000 (version 7.0)</p>
<p>The 7.x series transformed PostgreSQL from an interesting academic
database into a viable enterprise system.</p>
<h4 data-number="10.3.3.1" id="version-7.0-may-2000-foreign-keys-and-wal"><span class="header-section-number">10.3.3.1</span> Version 7.0 (May 2000):
Foreign Keys and WAL</h4>
<p><strong>Major Features:</strong> - <strong>Foreign Key
Constraints</strong> - Referential integrity finally supported -
CASCADE, SET NULL, SET DEFAULT actions - Made PostgreSQL suitable for
business applications</p>
<ul>
<li><strong>Write-Ahead Logging (WAL)</strong>
<ul>
<li>Crash recovery guaranteed</li>
<li>Foundation for replication (future versions)</li>
<li>Point-in-time recovery infrastructure</li>
<li>Location:
<code>/home/user/postgres/src/backend/access/transam/xlog.c</code>
(9,584 lines)</li>
</ul></li>
</ul>
<p><strong>WAL Implementation Insight:</strong></p>
<div class="sourceCode" id="cb568"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb568-1"><a aria-hidden="true" href="#cb568-1" tabindex="-1"></a><span class="co">/* From src/backend/access/transam/xlog.c</span></span>
<span id="cb568-2"><a aria-hidden="true" href="#cb568-2" tabindex="-1"></a><span class="co"> * Basic WAL record structure established in 7.0 */</span></span>
<span id="cb568-3"><a aria-hidden="true" href="#cb568-3" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> XLogRecord</span>
<span id="cb568-4"><a aria-hidden="true" href="#cb568-4" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb568-5"><a aria-hidden="true" href="#cb568-5" tabindex="-1"></a>    uint32      xl_tot_len<span class="op">;</span>    <span class="co">/* total len of entire record */</span></span>
<span id="cb568-6"><a aria-hidden="true" href="#cb568-6" tabindex="-1"></a>    TransactionId xl_xid<span class="op">;</span>      <span class="co">/* xact id */</span></span>
<span id="cb568-7"><a aria-hidden="true" href="#cb568-7" tabindex="-1"></a>    XLogRecPtr  xl_prev<span class="op">;</span>       <span class="co">/* ptr to previous record */</span></span>
<span id="cb568-8"><a aria-hidden="true" href="#cb568-8" tabindex="-1"></a>    uint8       xl_info<span class="op">;</span>       <span class="co">/* flag bits */</span></span>
<span id="cb568-9"><a aria-hidden="true" href="#cb568-9" tabindex="-1"></a>    RmgrId      xl_rmid<span class="op">;</span>       <span class="co">/* resource manager */</span></span>
<span id="cb568-10"><a aria-hidden="true" href="#cb568-10" tabindex="-1"></a>    <span class="co">/* ... */</span></span>
<span id="cb568-11"><a aria-hidden="true" href="#cb568-11" tabindex="-1"></a><span class="op">}</span> XLogRecord<span class="op">;</span></span></code></pre></div>
<p>This structure, established in 7.0, remains conceptually similar
today‚Äîa testament to good initial design.</p>
<ul>
<li><strong>Outer Joins</strong> (7.1, April 2001)
<ul>
<li>LEFT, RIGHT, FULL outer joins</li>
<li>SQL92 compliance improved</li>
<li>Complex query capabilities expanded</li>
</ul></li>
</ul>
<h4 data-number="10.3.3.2" id="version-7.2-february-2002-schemas"><span class="header-section-number">10.3.3.2</span> Version 7.2 (February
2002): Schemas</h4>
<p><strong>Revolutionary Feature: SQL Schemas</strong> - Namespaces for
database objects - <code>CREATE SCHEMA</code> command - Search path for
object resolution - Multi-tenant application support</p>
<p><strong>Impact:</strong> Before 7.2, all objects in a database shared
one namespace. After 7.2, applications could organize objects logically,
and hosting providers could support multiple clients in one
database.</p>
<h4 data-number="10.3.3.3" id="version-7.3-november-2002-protocol-v3"><span class="header-section-number">10.3.3.3</span> Version 7.3 (November
2002): Protocol V3</h4>
<p><strong>Wire Protocol Redesign:</strong> - Prepared statement
protocol - Binary data transfer - Better error reporting - Foundation
for modern drivers</p>
<p><strong>Coding Pattern Evolution:</strong></p>
<div class="sourceCode" id="cb569"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb569-1"><a aria-hidden="true" href="#cb569-1" tabindex="-1"></a><span class="co">/* 7.3 introduced better prepared statement handling */</span></span>
<span id="cb569-2"><a aria-hidden="true" href="#cb569-2" tabindex="-1"></a><span class="co">/* src/backend/tcop/postgres.c */</span></span>
<span id="cb569-3"><a aria-hidden="true" href="#cb569-3" tabindex="-1"></a><span class="dt">void</span> exec_parse_message<span class="op">(</span><span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>query_string<span class="op">,</span></span>
<span id="cb569-4"><a aria-hidden="true" href="#cb569-4" tabindex="-1"></a>                       <span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>stmt_name<span class="op">,</span></span>
<span id="cb569-5"><a aria-hidden="true" href="#cb569-5" tabindex="-1"></a>                       Oid <span class="op">*</span>paramTypes<span class="op">,</span></span>
<span id="cb569-6"><a aria-hidden="true" href="#cb569-6" tabindex="-1"></a>                       <span class="dt">int</span> numParams<span class="op">)</span></span>
<span id="cb569-7"><a aria-hidden="true" href="#cb569-7" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb569-8"><a aria-hidden="true" href="#cb569-8" tabindex="-1"></a>    <span class="co">/* Parse and save prepared statement */</span></span>
<span id="cb569-9"><a aria-hidden="true" href="#cb569-9" tabindex="-1"></a>    <span class="co">/* This interface still exists today */</span></span>
<span id="cb569-10"><a aria-hidden="true" href="#cb569-10" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h4 data-number="10.3.3.4" id="version-7.4-november-2003-optimizer-improvements"><span class="header-section-number">10.3.3.4</span> Version 7.4 (November
2003): Optimizer Improvements</h4>
<p><strong>Query Optimizer Enhancements:</strong> - Improved join order
selection - Better cost estimation - IN/EXISTS subquery optimization -
Function result caching</p>
<p><strong>Performance Impact:</strong> Queries with multiple joins
often 2-10x faster than 7.3. This version made PostgreSQL competitive
with commercial databases for complex analytical queries.</p>
<p><strong>Community Growth:</strong> - ~100 regular contributors -
First international PostgreSQL conferences - Commercial support
companies emerging (EnterpriseDB founded 2004)</p>
<hr/>
<h3 data-number="10.3.4" id="version-8.x-series-2005-2010-windows-and-maturity"><span class="header-section-number">10.3.4</span> Version 8.x Series
(2005-2010): Windows and Maturity</h3>
<h4 data-number="10.3.4.1" id="version-8.0-january-2005-the-windows-release"><span class="header-section-number">10.3.4.1</span> Version 8.0 (January
2005): The Windows Release</h4>
<p><strong>Transformational</strong>: Native Windows support without
Cygwin.</p>
<p><strong>Why This Mattered:</strong> - Windows Server 2003 dominated
enterprise market - Microsoft SQL Server‚Äôs primary competition - Opened
PostgreSQL to massive new user base</p>
<p><strong>Native Windows Port:</strong></p>
<div class="sourceCode" id="cb570"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb570-1"><a aria-hidden="true" href="#cb570-1" tabindex="-1"></a><span class="co">/* Platform-specific code isolation pattern established */</span></span>
<span id="cb570-2"><a aria-hidden="true" href="#cb570-2" tabindex="-1"></a><span class="co">/* src/port/win32.c - Windows-specific implementations */</span></span>
<span id="cb570-3"><a aria-hidden="true" href="#cb570-3" tabindex="-1"></a><span class="pp">#ifdef WIN32</span></span>
<span id="cb570-4"><a aria-hidden="true" href="#cb570-4" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;windows.h&gt;</span></span>
<span id="cb570-5"><a aria-hidden="true" href="#cb570-5" tabindex="-1"></a></span>
<span id="cb570-6"><a aria-hidden="true" href="#cb570-6" tabindex="-1"></a><span class="co">/* Windows equivalent of fork() - backend creation */</span></span>
<span id="cb570-7"><a aria-hidden="true" href="#cb570-7" tabindex="-1"></a>pid_t</span>
<span id="cb570-8"><a aria-hidden="true" href="#cb570-8" tabindex="-1"></a>pgwin32_forkexec<span class="op">(</span><span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>path<span class="op">,</span> <span class="dt">char</span> <span class="op">*</span>argv<span class="op">[])</span></span>
<span id="cb570-9"><a aria-hidden="true" href="#cb570-9" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb570-10"><a aria-hidden="true" href="#cb570-10" tabindex="-1"></a>    <span class="co">/* CreateProcess implementation */</span></span>
<span id="cb570-11"><a aria-hidden="true" href="#cb570-11" tabindex="-1"></a>    <span class="co">/* State serialization for Windows */</span></span>
<span id="cb570-12"><a aria-hidden="true" href="#cb570-12" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb570-13"><a aria-hidden="true" href="#cb570-13" tabindex="-1"></a><span class="pp">#endif</span></span></code></pre></div>
<p><strong>Other 8.0 Features:</strong> - <strong>Point-in-Time Recovery
(PITR)</strong> - WAL archiving - Recovery to specific timestamp -
Foundation for streaming replication</p>
<ul>
<li><strong>Tablespaces</strong>
<ul>
<li>Multiple storage locations</li>
<li>I/O load distribution</li>
<li>SSD/HDD hybrid storage support</li>
</ul></li>
<li><strong>Savepoints</strong>
<ul>
<li>Nested transaction control</li>
<li>Fine-grained error handling</li>
<li>Application framework integration</li>
</ul></li>
</ul>
<p><strong>Code Evolution Example:</strong></p>
<div class="sourceCode" id="cb571"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb571-1"><a aria-hidden="true" href="#cb571-1" tabindex="-1"></a><span class="co">/* Memory context pattern matured by 8.0 */</span></span>
<span id="cb571-2"><a aria-hidden="true" href="#cb571-2" tabindex="-1"></a><span class="co">/* src/backend/utils/mmgr/README describes the system */</span></span>
<span id="cb571-3"><a aria-hidden="true" href="#cb571-3" tabindex="-1"></a></span>
<span id="cb571-4"><a aria-hidden="true" href="#cb571-4" tabindex="-1"></a>MemoryContext old_context<span class="op">;</span></span>
<span id="cb571-5"><a aria-hidden="true" href="#cb571-5" tabindex="-1"></a></span>
<span id="cb571-6"><a aria-hidden="true" href="#cb571-6" tabindex="-1"></a><span class="co">/* Switch to longer-lived context */</span></span>
<span id="cb571-7"><a aria-hidden="true" href="#cb571-7" tabindex="-1"></a>old_context <span class="op">=</span> MemoryContextSwitchTo<span class="op">(</span>CurTransactionContext<span class="op">);</span></span>
<span id="cb571-8"><a aria-hidden="true" href="#cb571-8" tabindex="-1"></a></span>
<span id="cb571-9"><a aria-hidden="true" href="#cb571-9" tabindex="-1"></a><span class="co">/* Allocate memory that survives query end */</span></span>
<span id="cb571-10"><a aria-hidden="true" href="#cb571-10" tabindex="-1"></a>data <span class="op">=</span> palloc<span class="op">(</span>size<span class="op">);</span></span>
<span id="cb571-11"><a aria-hidden="true" href="#cb571-11" tabindex="-1"></a></span>
<span id="cb571-12"><a aria-hidden="true" href="#cb571-12" tabindex="-1"></a><span class="co">/* Restore previous context */</span></span>
<span id="cb571-13"><a aria-hidden="true" href="#cb571-13" tabindex="-1"></a>MemoryContextSwitchTo<span class="op">(</span>old_context<span class="op">);</span></span></code></pre></div>
<p>This memory management pattern became standard practice by 8.0.</p>
<h4 data-number="10.3.4.2" id="version-8.1-november-2005-two-phase-commit"><span class="header-section-number">10.3.4.2</span> Version 8.1 (November
2005): Two-Phase Commit</h4>
<p><strong>Distributed Transactions:</strong> - PREPARE TRANSACTION -
COMMIT PREPARED / ROLLBACK PREPARED - XA transaction protocol support -
Critical for enterprise application servers</p>
<p><strong>Bitmap Index Scans:</strong> - Multiple indexes combined - OR
clause optimization - Significant performance improvement for complex
WHERE clauses</p>
<h4 data-number="10.3.4.3" id="version-8.2-december-2006-gin-indexes"><span class="header-section-number">10.3.4.3</span> Version 8.2 (December
2006): GIN Indexes</h4>
<p><strong>Generalized Inverted Indexes:</strong> - Full-text search
acceleration - Array containment queries - JSONB indexing (future
versions) - Extensible to custom types</p>
<p><strong>Warm Standby:</strong> - Log shipping replication - Read-only
standby (not yet) - Disaster recovery without downtime</p>
<h4 data-number="10.3.4.4" id="version-8.3-february-2008-full-text-search-and-hot"><span class="header-section-number">10.3.4.4</span> Version 8.3 (February
2008): Full-Text Search and HOT</h4>
<p><strong>Full-Text Search Integrated:</strong> - <code>tsvector</code>
and <code>tsquery</code> data types - Multiple language support -
GIN/GiST index support - Previously required external module
(tsearch2)</p>
<p><strong>Heap-Only Tuples (HOT):</strong> One of PostgreSQL‚Äôs most
important optimizations.</p>
<p><strong>The Problem HOT Solved:</strong> MVCC creates new row
versions on UPDATE. If indexed columns unchanged, old indexes pointed to
old tuple versions, requiring index updates. For frequently-updated
tables, this caused severe bloat.</p>
<p><strong>HOT Solution:</strong></p>
<div class="sourceCode" id="cb572"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb572-1"><a aria-hidden="true" href="#cb572-1" tabindex="-1"></a><span class="co">/* From src/backend/access/heap/README.HOT</span></span>
<span id="cb572-2"><a aria-hidden="true" href="#cb572-2" tabindex="-1"></a><span class="co"> *</span></span>
<span id="cb572-3"><a aria-hidden="true" href="#cb572-3" tabindex="-1"></a><span class="co"> * If an UPDATE doesn't change indexed columns, new tuple version</span></span>
<span id="cb572-4"><a aria-hidden="true" href="#cb572-4" tabindex="-1"></a><span class="co"> * can be placed in same page and marked as "heap-only tuple".</span></span>
<span id="cb572-5"><a aria-hidden="true" href="#cb572-5" tabindex="-1"></a><span class="co"> * Old tuple stores pointer to new version.</span></span>
<span id="cb572-6"><a aria-hidden="true" href="#cb572-6" tabindex="-1"></a><span class="co"> * Index entries don't need updating!</span></span>
<span id="cb572-7"><a aria-hidden="true" href="#cb572-7" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb572-8"><a aria-hidden="true" href="#cb572-8" tabindex="-1"></a></span>
<span id="cb572-9"><a aria-hidden="true" href="#cb572-9" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> HeapTupleHeaderData</span>
<span id="cb572-10"><a aria-hidden="true" href="#cb572-10" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb572-11"><a aria-hidden="true" href="#cb572-11" tabindex="-1"></a>    <span class="co">/* ... */</span></span>
<span id="cb572-12"><a aria-hidden="true" href="#cb572-12" tabindex="-1"></a>    ItemPointerData t_ctid<span class="op">;</span>    <span class="co">/* Pointer to newer version or self */</span></span>
<span id="cb572-13"><a aria-hidden="true" href="#cb572-13" tabindex="-1"></a>    <span class="co">/* If this points to newer tuple on same page,</span></span>
<span id="cb572-14"><a aria-hidden="true" href="#cb572-14" tabindex="-1"></a><span class="co">     * and no indexed columns changed, it's a HOT chain */</span></span>
<span id="cb572-15"><a aria-hidden="true" href="#cb572-15" tabindex="-1"></a><span class="op">}</span> HeapTupleHeaderData<span class="op">;</span></span></code></pre></div>
<p><strong>HOT Impact:</strong> - 2-3x faster UPDATEs for non-indexed
columns - Massively reduced bloat - Less VACUUM pressure - One of the
most impactful performance improvements ever</p>
<p><strong>Enum Types:</strong> User-defined enumerated types with
ordering.</p>
<h4 data-number="10.3.4.5" id="version-8.4-july-2009-window-functions"><span class="header-section-number">10.3.4.5</span> Version 8.4 (July 2009):
Window Functions</h4>
<p><strong>SQL:2003 Window Functions:</strong></p>
<div class="sourceCode" id="cb573"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb573-1"><a aria-hidden="true" href="#cb573-1" tabindex="-1"></a><span class="co">-- Finally possible in 8.4!</span></span>
<span id="cb573-2"><a aria-hidden="true" href="#cb573-2" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb573-3"><a aria-hidden="true" href="#cb573-3" tabindex="-1"></a>    employee,</span>
<span id="cb573-4"><a aria-hidden="true" href="#cb573-4" tabindex="-1"></a>    salary,</span>
<span id="cb573-5"><a aria-hidden="true" href="#cb573-5" tabindex="-1"></a>    <span class="fu">RANK</span>() <span class="kw">OVER</span> (<span class="kw">ORDER</span> <span class="kw">BY</span> salary <span class="kw">DESC</span>) <span class="kw">as</span> <span class="fu">rank</span>,</span>
<span id="cb573-6"><a aria-hidden="true" href="#cb573-6" tabindex="-1"></a>    <span class="fu">AVG</span>(salary) <span class="kw">OVER</span> (<span class="kw">PARTITION</span> <span class="kw">BY</span> department) <span class="kw">as</span> dept_avg</span>
<span id="cb573-7"><a aria-hidden="true" href="#cb573-7" tabindex="-1"></a><span class="kw">FROM</span> employees;</span></code></pre></div>
<p><strong>Common Table Expressions (CTEs):</strong></p>
<div class="sourceCode" id="cb574"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb574-1"><a aria-hidden="true" href="#cb574-1" tabindex="-1"></a><span class="co">-- Recursive queries now possible</span></span>
<span id="cb574-2"><a aria-hidden="true" href="#cb574-2" tabindex="-1"></a><span class="kw">WITH</span> RECURSIVE employee_hierarchy <span class="kw">AS</span> (</span>
<span id="cb574-3"><a aria-hidden="true" href="#cb574-3" tabindex="-1"></a>    <span class="kw">SELECT</span> <span class="kw">id</span>, name, manager_id, <span class="dv">1</span> <span class="kw">as</span> <span class="kw">level</span></span>
<span id="cb574-4"><a aria-hidden="true" href="#cb574-4" tabindex="-1"></a>    <span class="kw">FROM</span> employees</span>
<span id="cb574-5"><a aria-hidden="true" href="#cb574-5" tabindex="-1"></a>    <span class="kw">WHERE</span> manager_id <span class="kw">IS</span> <span class="kw">NULL</span></span>
<span id="cb574-6"><a aria-hidden="true" href="#cb574-6" tabindex="-1"></a>  <span class="kw">UNION</span> <span class="kw">ALL</span></span>
<span id="cb574-7"><a aria-hidden="true" href="#cb574-7" tabindex="-1"></a>    <span class="kw">SELECT</span> e.<span class="kw">id</span>, e.name, e.manager_id, eh.<span class="kw">level</span> <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb574-8"><a aria-hidden="true" href="#cb574-8" tabindex="-1"></a>    <span class="kw">FROM</span> employees e</span>
<span id="cb574-9"><a aria-hidden="true" href="#cb574-9" tabindex="-1"></a>    <span class="kw">JOIN</span> employee_hierarchy eh <span class="kw">ON</span> e.manager_id <span class="op">=</span> eh.<span class="kw">id</span></span>
<span id="cb574-10"><a aria-hidden="true" href="#cb574-10" tabindex="-1"></a>)</span>
<span id="cb574-11"><a aria-hidden="true" href="#cb574-11" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> employee_hierarchy;</span></code></pre></div>
<p><strong>Why This Mattered:</strong> - Eliminated need for complex
self-joins - Made analytical queries practical - Enabled OLAP-style
reporting - Competitive with Oracle, SQL Server analytics</p>
<p><strong>Community Milestone:</strong> - PostgreSQL Conference (PGCon)
well-established - European PGDay conferences - First PostgreSQL users
at Fortune 500 companies - Estimated user base: 100,000+
installations</p>
<hr/>
<h3 data-number="10.3.5" id="version-9.x-series-2010-2016-replication-and-json"><span class="header-section-number">10.3.5</span> Version 9.x Series
(2010-2016): Replication and JSON</h3>
<h4 data-number="10.3.5.1" id="version-9.0-september-2010-hot-standby-and-streaming-replication"><span class="header-section-number">10.3.5.1</span> Version 9.0 (September
2010): Hot Standby and Streaming Replication</h4>
<p><strong>Game Changer for High Availability.</strong></p>
<p><strong>Hot Standby:</strong> - Read queries on standby servers -
Automatic failover capability - Load distribution for read-heavy
applications</p>
<p><strong>Streaming Replication:</strong></p>
<div class="sourceCode" id="cb575"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb575-1"><a aria-hidden="true" href="#cb575-1" tabindex="-1"></a><span class="co">/* src/backend/replication/walsender.c</span></span>
<span id="cb575-2"><a aria-hidden="true" href="#cb575-2" tabindex="-1"></a><span class="co"> * Introduced in 9.0 - streams WAL to standbys in real-time */</span></span>
<span id="cb575-3"><a aria-hidden="true" href="#cb575-3" tabindex="-1"></a></span>
<span id="cb575-4"><a aria-hidden="true" href="#cb575-4" tabindex="-1"></a><span class="dt">void</span></span>
<span id="cb575-5"><a aria-hidden="true" href="#cb575-5" tabindex="-1"></a>WalSndLoop<span class="op">(</span>WalSndSendDataCallback send_data<span class="op">)</span></span>
<span id="cb575-6"><a aria-hidden="true" href="#cb575-6" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb575-7"><a aria-hidden="true" href="#cb575-7" tabindex="-1"></a>    <span class="co">/* Continuously send WAL records to standby */</span></span>
<span id="cb575-8"><a aria-hidden="true" href="#cb575-8" tabindex="-1"></a>    <span class="cf">while</span> <span class="op">(!</span>got_STOPPING<span class="op">)</span></span>
<span id="cb575-9"><a aria-hidden="true" href="#cb575-9" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb575-10"><a aria-hidden="true" href="#cb575-10" tabindex="-1"></a>        <span class="co">/* Read WAL from disk or memory */</span></span>
<span id="cb575-11"><a aria-hidden="true" href="#cb575-11" tabindex="-1"></a>        <span class="co">/* Send to standby over TCP connection */</span></span>
<span id="cb575-12"><a aria-hidden="true" href="#cb575-12" tabindex="-1"></a>        <span class="co">/* Track confirmation of receipt */</span></span>
<span id="cb575-13"><a aria-hidden="true" href="#cb575-13" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb575-14"><a aria-hidden="true" href="#cb575-14" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>Architecture:</strong></p>
<pre><code>Primary Server
    |
    | WAL streaming (TCP)
    v
Standby Server(s)
    - Applies WAL continuously
    - Serves read-only queries
    - Can be promoted to primary</code></pre>
<p><strong>Impact:</strong> - No more custom replication triggers -
Simple setup compared to Slony, Bucardo - Became standard HA solution -
Cloud providers built on this (AWS RDS, etc.)</p>
<p><strong>Other 9.0 Features:</strong> - <code>VACUUM FULL</code>
rewritten (no longer locks for hours) - Anonymous code blocks
(<code>DO $$...$$</code>) - pg_upgrade for in-place upgrades</p>
<h4 data-number="10.3.5.2" id="version-9.1-september-2011-extensions-and-synchronous-replication"><span class="header-section-number">10.3.5.2</span> Version 9.1 (September
2011): Extensions and Synchronous Replication</h4>
<p><strong>Extension System:</strong></p>
<div class="sourceCode" id="cb577"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb577-1"><a aria-hidden="true" href="#cb577-1" tabindex="-1"></a><span class="kw">CREATE</span> EXTENSION hstore;</span>
<span id="cb577-2"><a aria-hidden="true" href="#cb577-2" tabindex="-1"></a><span class="kw">CREATE</span> EXTENSION pg_trgm;</span>
<span id="cb577-3"><a aria-hidden="true" href="#cb577-3" tabindex="-1"></a><span class="kw">CREATE</span> EXTENSION postgres_fdw;</span></code></pre></div>
<p><strong>Why Extensions Transformed PostgreSQL:</strong> - Clean
install/uninstall - Version management - Dependency tracking - Contrib
modules standardized - Third-party extensions flourished</p>
<p><strong>Extension Control File Example:</strong></p>
<pre><code># hstore.control
comment = 'data type for storing sets of (key, value) pairs'
default_version = '1.8'
module_pathname = '$libdir/hstore'
relocatable = true</code></pre>
<p><strong>Synchronous Replication:</strong> - <code>COMMIT</code> waits
for standby confirmation - Zero data loss failover -
<code>synchronous_standby_names</code> configuration</p>
<p><strong>Foreign Data Wrappers (FDW):</strong> - Query external data
sources - file_fdw, postgres_fdw built-in - Ecosystem of wrappers
emerged (MySQL, Oracle, MongoDB, etc.)</p>
<h4 data-number="10.3.5.3" id="version-9.2-september-2012-json-and-index-only-scans"><span class="header-section-number">10.3.5.3</span> Version 9.2 (September
2012): JSON and Index-Only Scans</h4>
<p><strong>JSON Data Type:</strong></p>
<div class="sourceCode" id="cb579"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb579-1"><a aria-hidden="true" href="#cb579-1" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> api_logs (</span>
<span id="cb579-2"><a aria-hidden="true" href="#cb579-2" tabindex="-1"></a>    <span class="kw">id</span> serial,</span>
<span id="cb579-3"><a aria-hidden="true" href="#cb579-3" tabindex="-1"></a>    request json,</span>
<span id="cb579-4"><a aria-hidden="true" href="#cb579-4" tabindex="-1"></a>    response json</span>
<span id="cb579-5"><a aria-hidden="true" href="#cb579-5" tabindex="-1"></a>);</span>
<span id="cb579-6"><a aria-hidden="true" href="#cb579-6" tabindex="-1"></a></span>
<span id="cb579-7"><a aria-hidden="true" href="#cb579-7" tabindex="-1"></a><span class="kw">SELECT</span> request<span class="op">-&gt;&gt;</span><span class="st">'user_id'</span> <span class="kw">FROM</span> api_logs;</span></code></pre></div>
<p>Not JSONB yet (that‚Äôs 9.4), but JSON support began here.</p>
<p><strong>Index-Only Scans:</strong> Revolutionary optimizer
improvement.</p>
<p><strong>The Problem:</strong> Traditionally, index scan ‚Üí fetch heap
tuple ‚Üí check visibility ‚Üí return data. For queries retrieving only
indexed columns, fetching heap tuple was wasteful.</p>
<p><strong>The Solution:</strong></p>
<div class="sourceCode" id="cb580"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb580-1"><a aria-hidden="true" href="#cb580-1" tabindex="-1"></a><span class="co">/* src/backend/access/heap/README.visibility-map</span></span>
<span id="cb580-2"><a aria-hidden="true" href="#cb580-2" tabindex="-1"></a><span class="co"> * Visibility map tracks pages with all tuples visible to all transactions.</span></span>
<span id="cb580-3"><a aria-hidden="true" href="#cb580-3" tabindex="-1"></a><span class="co"> * If page is all-visible, no heap fetch needed! */</span></span>
<span id="cb580-4"><a aria-hidden="true" href="#cb580-4" tabindex="-1"></a></span>
<span id="cb580-5"><a aria-hidden="true" href="#cb580-5" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> VisibilityMapData</span>
<span id="cb580-6"><a aria-hidden="true" href="#cb580-6" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb580-7"><a aria-hidden="true" href="#cb580-7" tabindex="-1"></a>    <span class="co">/* Bitmap: one bit per heap page */</span></span>
<span id="cb580-8"><a aria-hidden="true" href="#cb580-8" tabindex="-1"></a>    <span class="co">/* Set if all tuples on page are visible */</span></span>
<span id="cb580-9"><a aria-hidden="true" href="#cb580-9" tabindex="-1"></a><span class="op">}</span> VisibilityMapData<span class="op">;</span></span></code></pre></div>
<p><strong>Index-Only Scan in Action:</strong></p>
<div class="sourceCode" id="cb581"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb581-1"><a aria-hidden="true" href="#cb581-1" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_user_email <span class="kw">ON</span> users(email);</span>
<span id="cb581-2"><a aria-hidden="true" href="#cb581-2" tabindex="-1"></a>VACUUM <span class="kw">ANALYZE</span> users;  <span class="co">-- Sets visibility map bits</span></span>
<span id="cb581-3"><a aria-hidden="true" href="#cb581-3" tabindex="-1"></a></span>
<span id="cb581-4"><a aria-hidden="true" href="#cb581-4" tabindex="-1"></a><span class="co">-- This now scans only the index!</span></span>
<span id="cb581-5"><a aria-hidden="true" href="#cb581-5" tabindex="-1"></a><span class="kw">SELECT</span> email <span class="kw">FROM</span> users <span class="kw">WHERE</span> email <span class="kw">LIKE</span> <span class="st">'admin%'</span>;</span></code></pre></div>
<p><strong>Performance Impact:</strong> 10-100x faster for covering
index queries. Finally competitive with MySQL‚Äôs clustered indexes for
certain workloads.</p>
<p><strong>Cascading Replication:</strong></p>
<pre><code>Primary ‚Üí Standby1 ‚Üí Standby2
              ‚Üì
           Standby3</code></pre>
<p>Standbys can feed other standbys, reducing load on primary.</p>
<h4 data-number="10.3.5.4" id="version-9.3-september-2013-writable-fdws-and-background-workers"><span class="header-section-number">10.3.5.4</span> Version 9.3 (September
2013): Writable FDWs and Background Workers</h4>
<p><strong>Writable Foreign Data Wrappers:</strong> -
INSERT/UPDATE/DELETE on foreign tables - Distributed query foundation -
Sharding possibilities</p>
<p><strong>Custom Background Workers:</strong></p>
<div class="sourceCode" id="cb583"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb583-1"><a aria-hidden="true" href="#cb583-1" tabindex="-1"></a><span class="co">/* src/include/postmaster/bgworker.h</span></span>
<span id="cb583-2"><a aria-hidden="true" href="#cb583-2" tabindex="-1"></a><span class="co"> * Introduced 9.3 - custom long-running processes */</span></span>
<span id="cb583-3"><a aria-hidden="true" href="#cb583-3" tabindex="-1"></a></span>
<span id="cb583-4"><a aria-hidden="true" href="#cb583-4" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> BackgroundWorker</span>
<span id="cb583-5"><a aria-hidden="true" href="#cb583-5" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb583-6"><a aria-hidden="true" href="#cb583-6" tabindex="-1"></a>    <span class="dt">char</span>        bgw_name<span class="op">[</span>BGW_MAXLEN<span class="op">];</span></span>
<span id="cb583-7"><a aria-hidden="true" href="#cb583-7" tabindex="-1"></a>    <span class="dt">int</span>         bgw_flags<span class="op">;</span></span>
<span id="cb583-8"><a aria-hidden="true" href="#cb583-8" tabindex="-1"></a>    BgWorkerStartTime bgw_start_time<span class="op">;</span></span>
<span id="cb583-9"><a aria-hidden="true" href="#cb583-9" tabindex="-1"></a>    <span class="dt">int</span>         bgw_restart_time<span class="op">;</span></span>
<span id="cb583-10"><a aria-hidden="true" href="#cb583-10" tabindex="-1"></a>    <span class="dt">char</span>        bgw_library_name<span class="op">[</span>BGW_MAXLEN<span class="op">];</span></span>
<span id="cb583-11"><a aria-hidden="true" href="#cb583-11" tabindex="-1"></a>    <span class="dt">char</span>        bgw_function_name<span class="op">[</span>BGW_MAXLEN<span class="op">];</span></span>
<span id="cb583-12"><a aria-hidden="true" href="#cb583-12" tabindex="-1"></a>    <span class="co">/* ... */</span></span>
<span id="cb583-13"><a aria-hidden="true" href="#cb583-13" tabindex="-1"></a><span class="op">}</span> BackgroundWorker<span class="op">;</span></span></code></pre></div>
<p><strong>Use Cases:</strong> - Custom monitoring - Data replication -
Queue processing - Scheduled maintenance</p>
<p><strong>Materialized Views:</strong></p>
<div class="sourceCode" id="cb584"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb584-1"><a aria-hidden="true" href="#cb584-1" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">MATERIALIZED</span> <span class="kw">VIEW</span> sales_summary <span class="kw">AS</span></span>
<span id="cb584-2"><a aria-hidden="true" href="#cb584-2" tabindex="-1"></a><span class="kw">SELECT</span> region, <span class="fu">SUM</span>(amount)</span>
<span id="cb584-3"><a aria-hidden="true" href="#cb584-3" tabindex="-1"></a><span class="kw">FROM</span> sales</span>
<span id="cb584-4"><a aria-hidden="true" href="#cb584-4" tabindex="-1"></a><span class="kw">GROUP</span> <span class="kw">BY</span> region;</span>
<span id="cb584-5"><a aria-hidden="true" href="#cb584-5" tabindex="-1"></a></span>
<span id="cb584-6"><a aria-hidden="true" href="#cb584-6" tabindex="-1"></a><span class="kw">REFRESH</span> <span class="kw">MATERIALIZED</span> <span class="kw">VIEW</span> sales_summary;</span></code></pre></div>
<p>Pre-computed query results for expensive aggregations.</p>
<h4 data-number="10.3.5.5" id="version-9.4-december-2014-jsonb---the-killer-feature"><span class="header-section-number">10.3.5.5</span> Version 9.4 (December
2014): JSONB - The Killer Feature</h4>
<p><strong>Binary JSON (JSONB):</strong> The feature that made
PostgreSQL a serious NoSQL alternative.</p>
<p><strong>JSONB vs JSON:</strong> - <strong>JSON</strong>: Text
storage, exact representation preserved - <strong>JSONB</strong>: Binary
storage, decomposed, indexable, faster</p>
<p><strong>JSONB Capabilities:</strong></p>
<div class="sourceCode" id="cb585"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb585-1"><a aria-hidden="true" href="#cb585-1" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> products (</span>
<span id="cb585-2"><a aria-hidden="true" href="#cb585-2" tabindex="-1"></a>    <span class="kw">id</span> serial,</span>
<span id="cb585-3"><a aria-hidden="true" href="#cb585-3" tabindex="-1"></a>    <span class="kw">data</span> jsonb</span>
<span id="cb585-4"><a aria-hidden="true" href="#cb585-4" tabindex="-1"></a>);</span>
<span id="cb585-5"><a aria-hidden="true" href="#cb585-5" tabindex="-1"></a></span>
<span id="cb585-6"><a aria-hidden="true" href="#cb585-6" tabindex="-1"></a><span class="co">-- GIN index on JSONB</span></span>
<span id="cb585-7"><a aria-hidden="true" href="#cb585-7" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_product_data <span class="kw">ON</span> products <span class="kw">USING</span> GIN (<span class="kw">data</span>);</span>
<span id="cb585-8"><a aria-hidden="true" href="#cb585-8" tabindex="-1"></a></span>
<span id="cb585-9"><a aria-hidden="true" href="#cb585-9" tabindex="-1"></a><span class="co">-- Fast containment queries</span></span>
<span id="cb585-10"><a aria-hidden="true" href="#cb585-10" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> products</span>
<span id="cb585-11"><a aria-hidden="true" href="#cb585-11" tabindex="-1"></a><span class="kw">WHERE</span> <span class="kw">data</span> @<span class="op">&gt;</span> <span class="st">'{"category": "electronics"}'</span>;</span>
<span id="cb585-12"><a aria-hidden="true" href="#cb585-12" tabindex="-1"></a></span>
<span id="cb585-13"><a aria-hidden="true" href="#cb585-13" tabindex="-1"></a><span class="co">-- Path queries</span></span>
<span id="cb585-14"><a aria-hidden="true" href="#cb585-14" tabindex="-1"></a><span class="kw">SELECT</span> <span class="kw">data</span><span class="op">-&gt;</span><span class="st">'specs'</span><span class="op">-&gt;&gt;</span><span class="st">'cpu'</span> <span class="kw">FROM</span> products;</span>
<span id="cb585-15"><a aria-hidden="true" href="#cb585-15" tabindex="-1"></a></span>
<span id="cb585-16"><a aria-hidden="true" href="#cb585-16" tabindex="-1"></a><span class="co">-- Updates without rewriting entire JSON</span></span>
<span id="cb585-17"><a aria-hidden="true" href="#cb585-17" tabindex="-1"></a><span class="kw">UPDATE</span> products</span>
<span id="cb585-18"><a aria-hidden="true" href="#cb585-18" tabindex="-1"></a><span class="kw">SET</span> <span class="kw">data</span> <span class="op">=</span> jsonb_set(<span class="kw">data</span>, <span class="st">'{price}'</span>, <span class="st">'999.99'</span>)</span>
<span id="cb585-19"><a aria-hidden="true" href="#cb585-19" tabindex="-1"></a><span class="kw">WHERE</span> <span class="kw">id</span> <span class="op">=</span> <span class="dv">123</span>;</span></code></pre></div>
<p><strong>Why JSONB Was Revolutionary:</strong> - Schema flexibility +
relational power - Indexable semi-structured data - PostgreSQL could
replace MongoDB for many use cases - Enterprises could have ‚Äúone
database to rule them all‚Äù</p>
<p><strong>Implementation Insight:</strong></p>
<div class="sourceCode" id="cb586"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb586-1"><a aria-hidden="true" href="#cb586-1" tabindex="-1"></a><span class="co">/* src/include/utils/jsonb.h</span></span>
<span id="cb586-2"><a aria-hidden="true" href="#cb586-2" tabindex="-1"></a><span class="co"> * JSONB stored as binary tree structure */</span></span>
<span id="cb586-3"><a aria-hidden="true" href="#cb586-3" tabindex="-1"></a></span>
<span id="cb586-4"><a aria-hidden="true" href="#cb586-4" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> JsonbContainer</span>
<span id="cb586-5"><a aria-hidden="true" href="#cb586-5" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb586-6"><a aria-hidden="true" href="#cb586-6" tabindex="-1"></a>    uint32      header<span class="op">;</span>  <span class="co">/* Varlena header + JB flags */</span></span>
<span id="cb586-7"><a aria-hidden="true" href="#cb586-7" tabindex="-1"></a>    <span class="co">/*</span></span>
<span id="cb586-8"><a aria-hidden="true" href="#cb586-8" tabindex="-1"></a><span class="co">     * Followed by JEntry array (offsets to values)</span></span>
<span id="cb586-9"><a aria-hidden="true" href="#cb586-9" tabindex="-1"></a><span class="co">     * Then actual key/value data</span></span>
<span id="cb586-10"><a aria-hidden="true" href="#cb586-10" tabindex="-1"></a><span class="co">     * Allows fast random access and GIN indexing</span></span>
<span id="cb586-11"><a aria-hidden="true" href="#cb586-11" tabindex="-1"></a><span class="co">     */</span></span>
<span id="cb586-12"><a aria-hidden="true" href="#cb586-12" tabindex="-1"></a><span class="op">}</span> JsonbContainer<span class="op">;</span></span></code></pre></div>
<p><strong>Logical Replication Foundation:</strong> - Logical decoding
infrastructure - Plugin architecture - Foundation for 10.0‚Äôs native
logical replication</p>
<p><strong>Replication Slots:</strong> - Prevent WAL deletion while
standby disconnected - Named replication connections - Better
replication reliability</p>
<h4 data-number="10.3.5.6" id="version-9.5-january-2016-upsert-and-row-level-security"><span class="header-section-number">10.3.5.6</span> Version 9.5 (January
2016): UPSERT and Row-Level Security</h4>
<p><strong>INSERT ‚Ä¶ ON CONFLICT (UPSERT):</strong></p>
<div class="sourceCode" id="cb587"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb587-1"><a aria-hidden="true" href="#cb587-1" tabindex="-1"></a><span class="co">-- Finally! No more trigger hacks</span></span>
<span id="cb587-2"><a aria-hidden="true" href="#cb587-2" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> users (email, name)</span>
<span id="cb587-3"><a aria-hidden="true" href="#cb587-3" tabindex="-1"></a><span class="kw">VALUES</span> (<span class="st">'user@example.com'</span>, <span class="st">'John Doe'</span>)</span>
<span id="cb587-4"><a aria-hidden="true" href="#cb587-4" tabindex="-1"></a><span class="kw">ON</span> CONFLICT (email)</span>
<span id="cb587-5"><a aria-hidden="true" href="#cb587-5" tabindex="-1"></a>DO <span class="kw">UPDATE</span> <span class="kw">SET</span> name <span class="op">=</span> EXCLUDED.name;</span></code></pre></div>
<p><strong>Why This Took So Long:</strong> PostgreSQL‚Äôs MVCC makes
UPSERT complex. The implementation is sophisticated:</p>
<div class="sourceCode" id="cb588"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb588-1"><a aria-hidden="true" href="#cb588-1" tabindex="-1"></a><span class="co">/* src/backend/executor/nodeModifyTable.c</span></span>
<span id="cb588-2"><a aria-hidden="true" href="#cb588-2" tabindex="-1"></a><span class="co"> * Handles speculative insertion and conflict detection */</span></span>
<span id="cb588-3"><a aria-hidden="true" href="#cb588-3" tabindex="-1"></a></span>
<span id="cb588-4"><a aria-hidden="true" href="#cb588-4" tabindex="-1"></a><span class="co">/*</span></span>
<span id="cb588-5"><a aria-hidden="true" href="#cb588-5" tabindex="-1"></a><span class="co"> * 1. Speculatively insert tuple</span></span>
<span id="cb588-6"><a aria-hidden="true" href="#cb588-6" tabindex="-1"></a><span class="co"> * 2. Check constraints and unique indexes</span></span>
<span id="cb588-7"><a aria-hidden="true" href="#cb588-7" tabindex="-1"></a><span class="co"> * 3. If conflict: abort speculative insertion, do UPDATE</span></span>
<span id="cb588-8"><a aria-hidden="true" href="#cb588-8" tabindex="-1"></a><span class="co"> * 4. If no conflict: confirm insertion</span></span>
<span id="cb588-9"><a aria-hidden="true" href="#cb588-9" tabindex="-1"></a><span class="co"> * All while maintaining ACID properties!</span></span>
<span id="cb588-10"><a aria-hidden="true" href="#cb588-10" tabindex="-1"></a><span class="co"> */</span></span></code></pre></div>
<p><strong>Row-Level Security (RLS):</strong></p>
<div class="sourceCode" id="cb589"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb589-1"><a aria-hidden="true" href="#cb589-1" tabindex="-1"></a><span class="kw">CREATE</span> POLICY user_data_policy <span class="kw">ON</span> user_data</span>
<span id="cb589-2"><a aria-hidden="true" href="#cb589-2" tabindex="-1"></a>    <span class="kw">USING</span> (user_id <span class="op">=</span> current_user_id());</span>
<span id="cb589-3"><a aria-hidden="true" href="#cb589-3" tabindex="-1"></a></span>
<span id="cb589-4"><a aria-hidden="true" href="#cb589-4" tabindex="-1"></a><span class="kw">ALTER</span> <span class="kw">TABLE</span> user_data <span class="kw">ENABLE</span> <span class="kw">ROW</span> <span class="kw">LEVEL</span> SECURITY;</span>
<span id="cb589-5"><a aria-hidden="true" href="#cb589-5" tabindex="-1"></a></span>
<span id="cb589-6"><a aria-hidden="true" href="#cb589-6" tabindex="-1"></a><span class="co">-- Different users see different rows automatically</span></span></code></pre></div>
<p>Multi-tenant applications now secure at database level.</p>
<p><strong>BRIN Indexes:</strong> Block Range INdexes for huge tables
with correlated data.</p>
<div class="sourceCode" id="cb590"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb590-1"><a aria-hidden="true" href="#cb590-1" tabindex="-1"></a><span class="co">-- Perfect for time-series data</span></span>
<span id="cb590-2"><a aria-hidden="true" href="#cb590-2" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_logs_time <span class="kw">ON</span> logs <span class="kw">USING</span> BRIN (<span class="dt">timestamp</span>);</span>
<span id="cb590-3"><a aria-hidden="true" href="#cb590-3" tabindex="-1"></a></span>
<span id="cb590-4"><a aria-hidden="true" href="#cb590-4" tabindex="-1"></a><span class="co">-- Tiny index (1000x smaller than B-tree)</span></span>
<span id="cb590-5"><a aria-hidden="true" href="#cb590-5" tabindex="-1"></a><span class="co">-- Fast for range queries on correlated data</span></span></code></pre></div>
<p><strong>GROUPING SETS:</strong></p>
<div class="sourceCode" id="cb591"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb591-1"><a aria-hidden="true" href="#cb591-1" tabindex="-1"></a><span class="co">-- Multiple GROUP BY aggregations in one query</span></span>
<span id="cb591-2"><a aria-hidden="true" href="#cb591-2" tabindex="-1"></a><span class="kw">SELECT</span> region, product, <span class="fu">SUM</span>(sales)</span>
<span id="cb591-3"><a aria-hidden="true" href="#cb591-3" tabindex="-1"></a><span class="kw">FROM</span> sales_data</span>
<span id="cb591-4"><a aria-hidden="true" href="#cb591-4" tabindex="-1"></a><span class="kw">GROUP</span> <span class="kw">BY</span> <span class="fu">GROUPING</span> SETS (</span>
<span id="cb591-5"><a aria-hidden="true" href="#cb591-5" tabindex="-1"></a>    (region, product),</span>
<span id="cb591-6"><a aria-hidden="true" href="#cb591-6" tabindex="-1"></a>    (region),</span>
<span id="cb591-7"><a aria-hidden="true" href="#cb591-7" tabindex="-1"></a>    (product),</span>
<span id="cb591-8"><a aria-hidden="true" href="#cb591-8" tabindex="-1"></a>    ()</span>
<span id="cb591-9"><a aria-hidden="true" href="#cb591-9" tabindex="-1"></a>);</span></code></pre></div>
<p>OLAP capabilities approaching commercial databases.</p>
<h4 data-number="10.3.5.7" id="version-9.6-september-2016-parallel-query-execution"><span class="header-section-number">10.3.5.7</span> Version 9.6 (September
2016): Parallel Query Execution</h4>
<p><strong>The Beginning of Parallel Execution.</strong></p>
<p><strong>Parallel Sequential Scan:</strong></p>
<pre><code>Coordinator Backend
    ‚Üì (launches)
Worker Backend 1  Worker Backend 2  Worker Backend 3
    ‚Üì                 ‚Üì                 ‚Üì
  (scans pages     (scans pages     (scans pages
   0-1000)          1001-2000)       2001-3000)
    ‚Üì                 ‚Üì                 ‚Üì
Coordinator (gathers and combines results)</code></pre>
<p><strong>Parallel-Aware Executor Nodes:</strong> - Parallel Seq Scan -
Parallel Aggregate - Parallel Join (nested loop, hash)</p>
<p><strong>Implementation Framework:</strong></p>
<div class="sourceCode" id="cb593"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb593-1"><a aria-hidden="true" href="#cb593-1" tabindex="-1"></a><span class="co">/* src/backend/access/transam/README.parallel</span></span>
<span id="cb593-2"><a aria-hidden="true" href="#cb593-2" tabindex="-1"></a><span class="co"> * Infrastructure for parallel execution established in 9.6 */</span></span>
<span id="cb593-3"><a aria-hidden="true" href="#cb593-3" tabindex="-1"></a></span>
<span id="cb593-4"><a aria-hidden="true" href="#cb593-4" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> ParallelContext</span>
<span id="cb593-5"><a aria-hidden="true" href="#cb593-5" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb593-6"><a aria-hidden="true" href="#cb593-6" tabindex="-1"></a>    dsa_area   <span class="op">*</span>seg<span class="op">;</span>              <span class="co">/* Dynamic shared memory */</span></span>
<span id="cb593-7"><a aria-hidden="true" href="#cb593-7" tabindex="-1"></a>    <span class="dt">int</span>         nworkers<span class="op">;</span>         <span class="co">/* Number of workers */</span></span>
<span id="cb593-8"><a aria-hidden="true" href="#cb593-8" tabindex="-1"></a>    <span class="dt">int</span>         nworkers_launched<span class="op">;</span></span>
<span id="cb593-9"><a aria-hidden="true" href="#cb593-9" tabindex="-1"></a>    BackgroundWorkerHandle <span class="op">*</span>worker<span class="op">;</span></span>
<span id="cb593-10"><a aria-hidden="true" href="#cb593-10" tabindex="-1"></a>    <span class="co">/* State serialization for workers */</span></span>
<span id="cb593-11"><a aria-hidden="true" href="#cb593-11" tabindex="-1"></a><span class="op">}</span> ParallelContext<span class="op">;</span></span></code></pre></div>
<p><strong>Configuration:</strong></p>
<pre><code>max_parallel_workers_per_gather = 2  # Max workers per query
max_worker_processes = 8             # System-wide worker pool</code></pre>
<p><strong>Performance Impact:</strong> - 2-4x speedup on large table
scans (with 2-4 workers) - Linear scaling for CPU-bound queries -
Limited by I/O bandwidth in practice</p>
<p><strong>Future Foundation:</strong> 9.6‚Äôs parallel infrastructure
enabled massive improvements in 10, 11, 12, etc.</p>
<p><strong>Community Context (9.x era):</strong> - 200+ active
contributors - Worldwide conferences (US, Europe, Asia, South America) -
Cloud providers offering managed PostgreSQL - Fortune 100 companies
using PostgreSQL - Estimated installations: 1,000,000+</p>
<hr/>
<h3 data-number="10.3.6" id="version-10-october-2017-logical-replication-and-partitioning"><span class="header-section-number">10.3.6</span> Version 10 (October 2017):
Logical Replication and Partitioning</h3>
<p><strong>New Version Numbering</strong>: 10, not 9.7!</p>
<h4 data-number="10.3.6.1" id="declarative-partitioning"><span class="header-section-number">10.3.6.1</span> Declarative
Partitioning</h4>
<p><strong>Before 10</strong>: Table partitioning via inheritance +
triggers (complex, error-prone).</p>
<p><strong>With 10</strong>:</p>
<div class="sourceCode" id="cb595"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb595-1"><a aria-hidden="true" href="#cb595-1" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> measurements (</span>
<span id="cb595-2"><a aria-hidden="true" href="#cb595-2" tabindex="-1"></a>    city_id <span class="dt">int</span>,</span>
<span id="cb595-3"><a aria-hidden="true" href="#cb595-3" tabindex="-1"></a>    logdate <span class="dt">date</span>,</span>
<span id="cb595-4"><a aria-hidden="true" href="#cb595-4" tabindex="-1"></a>    temp <span class="dt">int</span></span>
<span id="cb595-5"><a aria-hidden="true" href="#cb595-5" tabindex="-1"></a>) <span class="kw">PARTITION</span> <span class="kw">BY</span> <span class="kw">RANGE</span> (logdate);</span>
<span id="cb595-6"><a aria-hidden="true" href="#cb595-6" tabindex="-1"></a></span>
<span id="cb595-7"><a aria-hidden="true" href="#cb595-7" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> measurements_y2024</span>
<span id="cb595-8"><a aria-hidden="true" href="#cb595-8" tabindex="-1"></a>    <span class="kw">PARTITION</span> <span class="kw">OF</span> measurements</span>
<span id="cb595-9"><a aria-hidden="true" href="#cb595-9" tabindex="-1"></a>    <span class="cf">FOR</span> <span class="kw">VALUES</span> <span class="kw">FROM</span> (<span class="st">'2024-01-01'</span>) <span class="kw">TO</span> (<span class="st">'2025-01-01'</span>);</span>
<span id="cb595-10"><a aria-hidden="true" href="#cb595-10" tabindex="-1"></a></span>
<span id="cb595-11"><a aria-hidden="true" href="#cb595-11" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> measurements_y2025</span>
<span id="cb595-12"><a aria-hidden="true" href="#cb595-12" tabindex="-1"></a>    <span class="kw">PARTITION</span> <span class="kw">OF</span> measurements</span>
<span id="cb595-13"><a aria-hidden="true" href="#cb595-13" tabindex="-1"></a>    <span class="cf">FOR</span> <span class="kw">VALUES</span> <span class="kw">FROM</span> (<span class="st">'2025-01-01'</span>) <span class="kw">TO</span> (<span class="st">'2026-01-01'</span>);</span></code></pre></div>
<p><strong>Under the Hood:</strong></p>
<div class="sourceCode" id="cb596"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb596-1"><a aria-hidden="true" href="#cb596-1" tabindex="-1"></a><span class="co">/* src/backend/catalog/partition.c</span></span>
<span id="cb596-2"><a aria-hidden="true" href="#cb596-2" tabindex="-1"></a><span class="co"> * Partition routing happens at executor level */</span></span>
<span id="cb596-3"><a aria-hidden="true" href="#cb596-3" tabindex="-1"></a></span>
<span id="cb596-4"><a aria-hidden="true" href="#cb596-4" tabindex="-1"></a><span class="co">/* Planner can:</span></span>
<span id="cb596-5"><a aria-hidden="true" href="#cb596-5" tabindex="-1"></a><span class="co"> * - Eliminate partitions (partition pruning)</span></span>
<span id="cb596-6"><a aria-hidden="true" href="#cb596-6" tabindex="-1"></a><span class="co"> * - Push predicates to partitions</span></span>
<span id="cb596-7"><a aria-hidden="true" href="#cb596-7" tabindex="-1"></a><span class="co"> * - Parallelize across partitions</span></span>
<span id="cb596-8"><a aria-hidden="true" href="#cb596-8" tabindex="-1"></a><span class="co"> */</span></span></code></pre></div>
<p><strong>Performance</strong>: 100-1000x faster partition pruning vs
inheritance method.</p>
<h4 data-number="10.3.6.2" id="logical-replication-publishsubscribe"><span class="header-section-number">10.3.6.2</span> Logical Replication
(Publish/Subscribe)</h4>
<p><strong>Revolutionary for distributed systems.</strong></p>
<p><strong>Publisher:</strong></p>
<div class="sourceCode" id="cb597"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb597-1"><a aria-hidden="true" href="#cb597-1" tabindex="-1"></a><span class="kw">CREATE</span> PUBLICATION my_publication</span>
<span id="cb597-2"><a aria-hidden="true" href="#cb597-2" tabindex="-1"></a><span class="cf">FOR</span> <span class="kw">TABLE</span> users, products;</span></code></pre></div>
<p><strong>Subscriber:</strong></p>
<div class="sourceCode" id="cb598"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb598-1"><a aria-hidden="true" href="#cb598-1" tabindex="-1"></a><span class="kw">CREATE</span> SUBSCRIPTION my_subscription</span>
<span id="cb598-2"><a aria-hidden="true" href="#cb598-2" tabindex="-1"></a>CONNECTION <span class="st">'host=primary dbname=mydb'</span></span>
<span id="cb598-3"><a aria-hidden="true" href="#cb598-3" tabindex="-1"></a>PUBLICATION my_publication;</span></code></pre></div>
<p><strong>Why This Matters:</strong> - Selective table replication -
Cross-version replication (10 ‚Üí 11, etc.) - Multi-master possibilities -
Database consolidation - Zero-downtime major upgrades</p>
<p><strong>Implementation:</strong></p>
<div class="sourceCode" id="cb599"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb599-1"><a aria-hidden="true" href="#cb599-1" tabindex="-1"></a><span class="co">/* src/backend/replication/logical/</span></span>
<span id="cb599-2"><a aria-hidden="true" href="#cb599-2" tabindex="-1"></a><span class="co"> * Logical decoding converts WAL to logical changes */</span></span>
<span id="cb599-3"><a aria-hidden="true" href="#cb599-3" tabindex="-1"></a></span>
<span id="cb599-4"><a aria-hidden="true" href="#cb599-4" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> ReorderBufferChange</span>
<span id="cb599-5"><a aria-hidden="true" href="#cb599-5" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb599-6"><a aria-hidden="true" href="#cb599-6" tabindex="-1"></a>    LogicalDecodingAction action<span class="op">;</span>  <span class="co">/* INSERT/UPDATE/DELETE */</span></span>
<span id="cb599-7"><a aria-hidden="true" href="#cb599-7" tabindex="-1"></a>    RelFileNode relnode<span class="op">;</span></span>
<span id="cb599-8"><a aria-hidden="true" href="#cb599-8" tabindex="-1"></a>    HeapTuple   oldtuple<span class="op">;</span>  <span class="co">/* For UPDATE/DELETE */</span></span>
<span id="cb599-9"><a aria-hidden="true" href="#cb599-9" tabindex="-1"></a>    HeapTuple   newtuple<span class="op">;</span>  <span class="co">/* For INSERT/UPDATE */</span></span>
<span id="cb599-10"><a aria-hidden="true" href="#cb599-10" tabindex="-1"></a><span class="op">}</span> ReorderBufferChange<span class="op">;</span></span></code></pre></div>
<p><strong>Other 10 Features:</strong> - <strong>Quorum-based
synchronous replication</strong>: Wait for N standbys -
<strong>SCRAM-SHA-256 authentication</strong>: Modern password hashing -
<strong>Better parallel query</strong>: More operations parallelized -
<strong>ICU collation support</strong>: Better internationalization</p>
<hr/>
<h3 data-number="10.3.7" id="version-11-october-2018-stored-procedures-and-jit"><span class="header-section-number">10.3.7</span> Version 11 (October 2018):
Stored Procedures and JIT</h3>
<h4 data-number="10.3.7.1" id="stored-procedures-with-transaction-control"><span class="header-section-number">10.3.7.1</span> Stored Procedures with
Transaction Control</h4>
<p><strong>Finally, Real Stored Procedures:</strong></p>
<div class="sourceCode" id="cb600"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb600-1"><a aria-hidden="true" href="#cb600-1" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">PROCEDURE</span> bulk_update()</span>
<span id="cb600-2"><a aria-hidden="true" href="#cb600-2" tabindex="-1"></a>LANGUAGE plpgsql</span>
<span id="cb600-3"><a aria-hidden="true" href="#cb600-3" tabindex="-1"></a><span class="kw">AS</span> $$</span>
<span id="cb600-4"><a aria-hidden="true" href="#cb600-4" tabindex="-1"></a><span class="cf">BEGIN</span></span>
<span id="cb600-5"><a aria-hidden="true" href="#cb600-5" tabindex="-1"></a>    <span class="kw">UPDATE</span> accounts <span class="kw">SET</span> balance <span class="op">=</span> balance <span class="op">*</span> <span class="fl">1.01</span>;</span>
<span id="cb600-6"><a aria-hidden="true" href="#cb600-6" tabindex="-1"></a>    <span class="kw">COMMIT</span>;</span>
<span id="cb600-7"><a aria-hidden="true" href="#cb600-7" tabindex="-1"></a></span>
<span id="cb600-8"><a aria-hidden="true" href="#cb600-8" tabindex="-1"></a>    <span class="kw">UPDATE</span> audit_log <span class="kw">SET</span> processed <span class="op">=</span> <span class="kw">true</span>;</span>
<span id="cb600-9"><a aria-hidden="true" href="#cb600-9" tabindex="-1"></a>    <span class="kw">COMMIT</span>;</span>
<span id="cb600-10"><a aria-hidden="true" href="#cb600-10" tabindex="-1"></a><span class="cf">END</span>;</span>
<span id="cb600-11"><a aria-hidden="true" href="#cb600-11" tabindex="-1"></a>$$;</span>
<span id="cb600-12"><a aria-hidden="true" href="#cb600-12" tabindex="-1"></a></span>
<span id="cb600-13"><a aria-hidden="true" href="#cb600-13" tabindex="-1"></a><span class="kw">CALL</span> bulk_update();</span></code></pre></div>
<p><strong>Functions vs Procedures:</strong> -
<strong>Functions</strong>: Return value, run in transaction of caller -
<strong>Procedures</strong>: No return value, can COMMIT/ROLLBACK
internally</p>
<p><strong>Use Cases:</strong> - Batch processing with periodic commits
- Long-running maintenance operations - ETL processes</p>
<h4 data-number="10.3.7.2" id="jit-compilation-via-llvm"><span class="header-section-number">10.3.7.2</span> JIT Compilation via
LLVM</h4>
<p><strong>Just-In-Time compilation for expression
evaluation.</strong></p>
<p><strong>The Problem:</strong> Expression evaluation in WHERE clauses,
computations, etc. used interpreted code.</p>
<p><strong>The Solution:</strong></p>
<div class="sourceCode" id="cb601"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb601-1"><a aria-hidden="true" href="#cb601-1" tabindex="-1"></a><span class="co">/* src/backend/jit/llvm/</span></span>
<span id="cb601-2"><a aria-hidden="true" href="#cb601-2" tabindex="-1"></a><span class="co"> * Compile frequently-executed expressions to machine code */</span></span>
<span id="cb601-3"><a aria-hidden="true" href="#cb601-3" tabindex="-1"></a></span>
<span id="cb601-4"><a aria-hidden="true" href="#cb601-4" tabindex="-1"></a><span class="co">/* Overhead:</span></span>
<span id="cb601-5"><a aria-hidden="true" href="#cb601-5" tabindex="-1"></a><span class="co"> * - Compilation takes time (milliseconds)</span></span>
<span id="cb601-6"><a aria-hidden="true" href="#cb601-6" tabindex="-1"></a><span class="co"> * - Worth it for queries scanning millions of rows</span></span>
<span id="cb601-7"><a aria-hidden="true" href="#cb601-7" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb601-8"><a aria-hidden="true" href="#cb601-8" tabindex="-1"></a></span>
<span id="cb601-9"><a aria-hidden="true" href="#cb601-9" tabindex="-1"></a><span class="co">/* Enable with:</span></span>
<span id="cb601-10"><a aria-hidden="true" href="#cb601-10" tabindex="-1"></a><span class="co"> * SET jit = on;</span></span>
<span id="cb601-11"><a aria-hidden="true" href="#cb601-11" tabindex="-1"></a><span class="co"> *</span></span>
<span id="cb601-12"><a aria-hidden="true" href="#cb601-12" tabindex="-1"></a><span class="co"> * Automatic for queries exceeding cost threshold</span></span>
<span id="cb601-13"><a aria-hidden="true" href="#cb601-13" tabindex="-1"></a><span class="co"> */</span></span></code></pre></div>
<p><strong>Performance Impact:</strong> - 2-5x faster for
expression-heavy queries on large datasets - Minimal benefit for OLTP
workloads - Big win for analytical queries</p>
<p><strong>Other 11 Features:</strong> - <strong>Covering indexes
(INCLUDE)</strong>: Non-key columns in index
<code>sql   CREATE INDEX idx_users ON users (email) INCLUDE (name, created_at);   -- Index-only scan can return name and created_at too!</code>
- <strong>Partition-wise join</strong>: Join partitioned tables in
parallel - <strong>Parallelism improvements</strong>: More operations
parallel</p>
<hr/>
<h3 data-number="10.3.8" id="version-12-october-2019-generated-columns-and-pluggable-storage"><span class="header-section-number">10.3.8</span> Version 12 (October 2019):
Generated Columns and Pluggable Storage</h3>
<h4 data-number="10.3.8.1" id="generated-columns"><span class="header-section-number">10.3.8.1</span> Generated Columns</h4>
<p><strong>Stored computed columns:</strong></p>
<div class="sourceCode" id="cb602"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb602-1"><a aria-hidden="true" href="#cb602-1" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> people (</span>
<span id="cb602-2"><a aria-hidden="true" href="#cb602-2" tabindex="-1"></a>    first_name text,</span>
<span id="cb602-3"><a aria-hidden="true" href="#cb602-3" tabindex="-1"></a>    last_name text,</span>
<span id="cb602-4"><a aria-hidden="true" href="#cb602-4" tabindex="-1"></a>    full_name text <span class="kw">GENERATED</span> ALWAYS <span class="kw">AS</span> (first_name <span class="op">||</span> <span class="st">' '</span> <span class="op">||</span> last_name) STORED</span>
<span id="cb602-5"><a aria-hidden="true" href="#cb602-5" tabindex="-1"></a>);</span>
<span id="cb602-6"><a aria-hidden="true" href="#cb602-6" tabindex="-1"></a></span>
<span id="cb602-7"><a aria-hidden="true" href="#cb602-7" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> people (first_name, last_name) <span class="kw">VALUES</span> (<span class="st">'John'</span>, <span class="st">'Doe'</span>);</span>
<span id="cb602-8"><a aria-hidden="true" href="#cb602-8" tabindex="-1"></a><span class="co">-- full_name automatically computed and stored</span></span></code></pre></div>
<p><strong>Use Cases:</strong> - Derived values - Indexable computed
expressions - Compatibility with other databases</p>
<h4 data-number="10.3.8.2" id="pluggable-table-storage"><span class="header-section-number">10.3.8.2</span> Pluggable Table
Storage</h4>
<p><strong>Abstraction of storage layer:</strong></p>
<div class="sourceCode" id="cb603"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb603-1"><a aria-hidden="true" href="#cb603-1" tabindex="-1"></a><span class="co">/* src/include/access/tableam.h</span></span>
<span id="cb603-2"><a aria-hidden="true" href="#cb603-2" tabindex="-1"></a><span class="co"> * Table Access Method API - allows custom storage engines */</span></span>
<span id="cb603-3"><a aria-hidden="true" href="#cb603-3" tabindex="-1"></a></span>
<span id="cb603-4"><a aria-hidden="true" href="#cb603-4" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> TableAmRoutine</span>
<span id="cb603-5"><a aria-hidden="true" href="#cb603-5" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb603-6"><a aria-hidden="true" href="#cb603-6" tabindex="-1"></a>    <span class="co">/* Scan operations */</span></span>
<span id="cb603-7"><a aria-hidden="true" href="#cb603-7" tabindex="-1"></a>    TableScanDescData <span class="op">*(*</span>scan_begin<span class="op">)(...);</span></span>
<span id="cb603-8"><a aria-hidden="true" href="#cb603-8" tabindex="-1"></a>    <span class="dt">bool</span> <span class="op">(*</span>scan_getnextslot<span class="op">)(...);</span></span>
<span id="cb603-9"><a aria-hidden="true" href="#cb603-9" tabindex="-1"></a></span>
<span id="cb603-10"><a aria-hidden="true" href="#cb603-10" tabindex="-1"></a>    <span class="co">/* Modify operations */</span></span>
<span id="cb603-11"><a aria-hidden="true" href="#cb603-11" tabindex="-1"></a>    <span class="dt">void</span> <span class="op">(*</span>tuple_insert<span class="op">)(...);</span></span>
<span id="cb603-12"><a aria-hidden="true" href="#cb603-12" tabindex="-1"></a>    <span class="dt">void</span> <span class="op">(*</span>tuple_update<span class="op">)(...);</span></span>
<span id="cb603-13"><a aria-hidden="true" href="#cb603-13" tabindex="-1"></a>    <span class="dt">void</span> <span class="op">(*</span>tuple_delete<span class="op">)(...);</span></span>
<span id="cb603-14"><a aria-hidden="true" href="#cb603-14" tabindex="-1"></a></span>
<span id="cb603-15"><a aria-hidden="true" href="#cb603-15" tabindex="-1"></a>    <span class="co">/* ... 40+ methods */</span></span>
<span id="cb603-16"><a aria-hidden="true" href="#cb603-16" tabindex="-1"></a><span class="op">}</span> TableAmRoutine<span class="op">;</span></span></code></pre></div>
<p><strong>Why This Matters:</strong> - Columnar storage engines
possible (Citus columnar, zedstore) - In-memory tables possible - Custom
compression strategies - Future-proofs PostgreSQL architecture</p>
<p><strong>Default</strong>: Heap storage (traditional PostgreSQL
storage).</p>
<p><strong>Other 12 Features:</strong> - <strong>JSON path
expressions</strong>: SQL/JSON standard queries
<code>sql   SELECT jsonb_path_query(data, '$.products[*] ? (@.price &gt; 100)');</code>
- <strong>CTE inlining</strong>: Common table expressions optimized -
<strong>REINDEX CONCURRENTLY</strong>: Rebuild indexes without blocking
- <strong>Partition improvements</strong>: Better pruning, foreign
keys</p>
<hr/>
<h3 data-number="10.3.9" id="version-13-september-2020-incremental-sorting-and-parallel-vacuum"><span class="header-section-number">10.3.9</span> Version 13 (September 2020):
Incremental Sorting and Parallel Vacuum</h3>
<h4 data-number="10.3.9.1" id="incremental-sorting"><span class="header-section-number">10.3.9.1</span> Incremental Sorting</h4>
<p><strong>Clever optimization for partially-sorted data.</strong></p>
<p><strong>Example:</strong></p>
<div class="sourceCode" id="cb604"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb604-1"><a aria-hidden="true" href="#cb604-1" tabindex="-1"></a><span class="co">-- Index on (region, product_id)</span></span>
<span id="cb604-2"><a aria-hidden="true" href="#cb604-2" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> sales</span>
<span id="cb604-3"><a aria-hidden="true" href="#cb604-3" tabindex="-1"></a><span class="kw">WHERE</span> region <span class="op">=</span> <span class="st">'US'</span></span>
<span id="cb604-4"><a aria-hidden="true" href="#cb604-4" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> region, product_id, sale_date;</span>
<span id="cb604-5"><a aria-hidden="true" href="#cb604-5" tabindex="-1"></a></span>
<span id="cb604-6"><a aria-hidden="true" href="#cb604-6" tabindex="-1"></a><span class="co">-- 13+ uses incremental sort:</span></span>
<span id="cb604-7"><a aria-hidden="true" href="#cb604-7" tabindex="-1"></a><span class="co">-- 1. Index provides region, product_id order</span></span>
<span id="cb604-8"><a aria-hidden="true" href="#cb604-8" tabindex="-1"></a><span class="co">-- 2. Incrementally sort by sale_date within each product_id group</span></span>
<span id="cb604-9"><a aria-hidden="true" href="#cb604-9" tabindex="-1"></a><span class="co">-- Much faster than full sort!</span></span></code></pre></div>
<p><strong>Implementation:</strong></p>
<div class="sourceCode" id="cb605"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb605-1"><a aria-hidden="true" href="#cb605-1" tabindex="-1"></a><span class="co">/* src/backend/executor/nodeIncrementalSort.c</span></span>
<span id="cb605-2"><a aria-hidden="true" href="#cb605-2" tabindex="-1"></a><span class="co"> * New executor node type added in 13 */</span></span>
<span id="cb605-3"><a aria-hidden="true" href="#cb605-3" tabindex="-1"></a></span>
<span id="cb605-4"><a aria-hidden="true" href="#cb605-4" tabindex="-1"></a><span class="co">/* Sorts batches as they arrive, maintaining overall order */</span></span></code></pre></div>
<h4 data-number="10.3.9.2" id="parallel-vacuum"><span class="header-section-number">10.3.9.2</span> Parallel Vacuum</h4>
<p><strong>VACUUM utilizes multiple CPU cores:</strong></p>
<pre><code>VACUUM workers:
  Worker 1: Processes indexes 1-3
  Worker 2: Processes indexes 4-6
  Worker 3: Processes indexes 7-9

Combined: 3x faster index cleanup</code></pre>
<p><strong>Configuration:</strong></p>
<pre><code>max_parallel_maintenance_workers = 4</code></pre>
<p><strong>Other 13 Features:</strong> - <strong>B-tree
deduplication</strong>: Indexes with many duplicates use less space -
<strong>Extended statistics improvements</strong>: Multi-column
statistics - <strong>Partition improvements</strong>: Logical
replication of partitioned tables</p>
<p><strong>COVID-19 Impact:</strong> - PGCon 2020 cancelled ‚Üí online -
Development continued uninterrupted (remote-friendly process) -
Community proved resilient</p>
<hr/>
<h3 data-number="10.3.10" id="version-14-september-2021-libpq-pipeline-mode"><span class="header-section-number">10.3.10</span> Version 14 (September
2021): Libpq Pipeline Mode</h3>
<h4 data-number="10.3.10.1" id="pipeline-mode-in-libpq"><span class="header-section-number">10.3.10.1</span> Pipeline Mode in
libpq</h4>
<p><strong>Batch multiple queries without waiting for
results:</strong></p>
<p><strong>Traditional</strong>:</p>
<pre><code>Client ‚Üí Server: Query 1
Client ‚Üê Server: Result 1  (network round-trip)
Client ‚Üí Server: Query 2
Client ‚Üê Server: Result 2  (network round-trip)</code></pre>
<p><strong>Pipeline Mode</strong>:</p>
<pre><code>Client ‚Üí Server: Query 1, Query 2, Query 3
Client ‚Üê Server: Result 1, Result 2, Result 3
(One network round-trip!)</code></pre>
<p><strong>Performance</strong>: 5-10x faster for high-latency
connections (cloud, geographic distribution).</p>
<p><strong>Other 14 Features:</strong> - <strong>Multirange
types</strong>:
<code>sql   SELECT int4multirange(int4range(1,5), int4range(10,20));   -- Represents discontinuous ranges</code>
- <strong>Subscripting for JSONB</strong>:
<code>data['key']['subkey']</code> syntax - <strong>Heavy workload
improvements</strong>: Better connection handling</p>
<hr/>
<h3 data-number="10.3.11" id="version-15-october-2022-merge-command"><span class="header-section-number">10.3.11</span> Version 15 (October 2022):
MERGE Command</h3>
<h4 data-number="10.3.11.1" id="sql-standard-merge"><span class="header-section-number">10.3.11.1</span> SQL Standard MERGE</h4>
<p><strong>Upsert on steroids:</strong></p>
<div class="sourceCode" id="cb610"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb610-1"><a aria-hidden="true" href="#cb610-1" tabindex="-1"></a><span class="kw">MERGE</span> <span class="kw">INTO</span> customer_account ca</span>
<span id="cb610-2"><a aria-hidden="true" href="#cb610-2" tabindex="-1"></a><span class="kw">USING</span> recent_transactions t</span>
<span id="cb610-3"><a aria-hidden="true" href="#cb610-3" tabindex="-1"></a><span class="kw">ON</span> ca.<span class="kw">id</span> <span class="op">=</span> t.customer_id</span>
<span id="cb610-4"><a aria-hidden="true" href="#cb610-4" tabindex="-1"></a><span class="cf">WHEN</span> MATCHED <span class="kw">AND</span> t.amount <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">THEN</span></span>
<span id="cb610-5"><a aria-hidden="true" href="#cb610-5" tabindex="-1"></a>    <span class="kw">UPDATE</span> <span class="kw">SET</span> balance <span class="op">=</span> balance <span class="op">+</span> t.amount</span>
<span id="cb610-6"><a aria-hidden="true" href="#cb610-6" tabindex="-1"></a><span class="cf">WHEN</span> MATCHED <span class="kw">AND</span> t.amount <span class="op">&lt;</span> <span class="dv">0</span> <span class="cf">THEN</span></span>
<span id="cb610-7"><a aria-hidden="true" href="#cb610-7" tabindex="-1"></a>    <span class="kw">UPDATE</span> <span class="kw">SET</span> balance <span class="op">=</span> balance <span class="op">+</span> t.amount, overdraft <span class="op">=</span> <span class="kw">true</span></span>
<span id="cb610-8"><a aria-hidden="true" href="#cb610-8" tabindex="-1"></a><span class="cf">WHEN</span> <span class="kw">NOT</span> MATCHED <span class="cf">THEN</span></span>
<span id="cb610-9"><a aria-hidden="true" href="#cb610-9" tabindex="-1"></a>    <span class="kw">INSERT</span> (<span class="kw">id</span>, balance) <span class="kw">VALUES</span> (t.customer_id, t.amount);</span></code></pre></div>
<p><strong>Use Cases:</strong> - Data warehouse ETL - Synchronization
operations - Complex conditional logic</p>
<p><strong>Other 15 Features:</strong> - <strong>Regular expression
improvements</strong>: Unicode property support - <strong>LZ4 and
Zstandard compression</strong>: Better WAL compression - <strong>Public
schema permissions change</strong>: Security improvement -
<strong>Archive library modules</strong>: Pluggable WAL archiving</p>
<p><strong>Community Context:</strong> - 300+ contributors per release
cycle - PostgreSQL Conference worldwide (US, Europe, India, Japan,
Russia, Brazil) - Major cloud providers: AWS RDS, Azure, Google Cloud
SQL - Enterprise adoption: Apple, Instagram, Reddit, Uber, Netflix</p>
<hr/>
<h3 data-number="10.3.12" id="version-16-september-2023-parallelism-and-logical-replication"><span class="header-section-number">10.3.12</span> Version 16 (September
2023): Parallelism and Logical Replication</h3>
<h4 data-number="10.3.12.1" id="more-parallel-operations"><span class="header-section-number">10.3.12.1</span> More Parallel
Operations</h4>
<p><strong>Parallel-aware:</strong> - FULL and RIGHT joins - UNION /
UNION ALL - String functions - Regular expressions</p>
<p><strong>Incremental Backups:</strong> - Track changed blocks - Faster
incremental backups - Better integration with backup tools</p>
<h4 data-number="10.3.12.2" id="logical-replication-improvements"><span class="header-section-number">10.3.12.2</span> Logical Replication
Improvements</h4>
<p><strong>Bidirectional logical replication:</strong> - Publish and
subscribe simultaneously - Multi-master configurations possible -
Conflict detection hooks</p>
<p><strong>Other 16 Features:</strong> - <strong>SQL/JSON
improvements</strong>: JSON_TABLE, JSON_ARRAY, etc. - <strong>pg_stat_io
view</strong>: I/O statistics per operation type - <strong>VACUUM
improvements</strong>: Better visibility map usage</p>
<hr/>
<h3 data-number="10.3.13" id="version-17-september-2024-latest-release"><span class="header-section-number">10.3.13</span> Version 17 (September
2024): Latest Release</h3>
<h4 data-number="10.3.13.1" id="merge-returning"><span class="header-section-number">10.3.13.1</span> MERGE RETURNING</h4>
<p><strong>Return data from MERGE operations:</strong></p>
<div class="sourceCode" id="cb611"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb611-1"><a aria-hidden="true" href="#cb611-1" tabindex="-1"></a><span class="kw">MERGE</span> <span class="kw">INTO</span> inventory i</span>
<span id="cb611-2"><a aria-hidden="true" href="#cb611-2" tabindex="-1"></a><span class="kw">USING</span> orders o <span class="kw">ON</span> i.product_id <span class="op">=</span> o.product_id</span>
<span id="cb611-3"><a aria-hidden="true" href="#cb611-3" tabindex="-1"></a><span class="cf">WHEN</span> MATCHED <span class="cf">THEN</span> <span class="kw">UPDATE</span> <span class="kw">SET</span> quantity <span class="op">=</span> quantity <span class="op">-</span> o.quantity</span>
<span id="cb611-4"><a aria-hidden="true" href="#cb611-4" tabindex="-1"></a><span class="kw">RETURNING</span> i.product_id, i.quantity;</span></code></pre></div>
<h4 data-number="10.3.13.2" id="incremental-backup-improvements"><span class="header-section-number">10.3.13.2</span> Incremental Backup
Improvements</h4>
<p><strong>Better change tracking:</strong> - Block-level change
tracking - Faster backup verification - Better integration with
pg_basebackup</p>
<p><strong>Other 17 Features:</strong> - <strong>VACUUM
improvements</strong>: Better cleanup of old XIDs - <strong>JSON
improvements</strong>: More functions and operators -
<strong>Performance improvements</strong>: Across multiple
subsystems</p>
<p><strong>Development Stats (2024):</strong> - 350+ contributors in 17
cycle - ~2,500 commits - 40+ major features - 200+ bug fixes</p>
<hr/>
<h2 data-number="10.4" id="part-2-coding-pattern-evolution"><span class="header-section-number">10.4</span> Part 2: Coding Pattern
Evolution</h2>
<h3 data-number="10.4.1" id="early-c-patterns-vs-modern-approaches"><span class="header-section-number">10.4.1</span> Early C Patterns vs Modern
Approaches</h3>
<h4 data-number="10.4.1.1" id="memory-management-evolution"><span class="header-section-number">10.4.1.1</span> Memory Management
Evolution</h4>
<p><strong>Early Pattern (6.x - 7.x era):</strong></p>
<div class="sourceCode" id="cb612"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb612-1"><a aria-hidden="true" href="#cb612-1" tabindex="-1"></a><span class="co">/* Manual memory management */</span></span>
<span id="cb612-2"><a aria-hidden="true" href="#cb612-2" tabindex="-1"></a><span class="dt">void</span> process_data<span class="op">(</span><span class="dt">char</span> <span class="op">*</span>input<span class="op">)</span></span>
<span id="cb612-3"><a aria-hidden="true" href="#cb612-3" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb612-4"><a aria-hidden="true" href="#cb612-4" tabindex="-1"></a>    <span class="dt">char</span> <span class="op">*</span>buffer <span class="op">=</span> malloc<span class="op">(</span><span class="dv">1024</span><span class="op">);</span></span>
<span id="cb612-5"><a aria-hidden="true" href="#cb612-5" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(!</span>buffer<span class="op">)</span></span>
<span id="cb612-6"><a aria-hidden="true" href="#cb612-6" tabindex="-1"></a>        elog<span class="op">(</span>ERROR<span class="op">,</span> <span class="st">"out of memory"</span><span class="op">);</span></span>
<span id="cb612-7"><a aria-hidden="true" href="#cb612-7" tabindex="-1"></a></span>
<span id="cb612-8"><a aria-hidden="true" href="#cb612-8" tabindex="-1"></a>    <span class="co">/* Process data */</span></span>
<span id="cb612-9"><a aria-hidden="true" href="#cb612-9" tabindex="-1"></a>    strcpy<span class="op">(</span>buffer<span class="op">,</span> input<span class="op">);</span></span>
<span id="cb612-10"><a aria-hidden="true" href="#cb612-10" tabindex="-1"></a></span>
<span id="cb612-11"><a aria-hidden="true" href="#cb612-11" tabindex="-1"></a>    <span class="co">/* Must remember to free */</span></span>
<span id="cb612-12"><a aria-hidden="true" href="#cb612-12" tabindex="-1"></a>    free<span class="op">(</span>buffer<span class="op">);</span></span>
<span id="cb612-13"><a aria-hidden="true" href="#cb612-13" tabindex="-1"></a>    <span class="co">/* If elog() called before free(), memory leaked! */</span></span>
<span id="cb612-14"><a aria-hidden="true" href="#cb612-14" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>Modern Pattern (8.x+ era):</strong></p>
<div class="sourceCode" id="cb613"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb613-1"><a aria-hidden="true" href="#cb613-1" tabindex="-1"></a><span class="co">/* Memory context pattern - automatic cleanup */</span></span>
<span id="cb613-2"><a aria-hidden="true" href="#cb613-2" tabindex="-1"></a><span class="co">/* From src/backend/utils/mmgr/README */</span></span>
<span id="cb613-3"><a aria-hidden="true" href="#cb613-3" tabindex="-1"></a></span>
<span id="cb613-4"><a aria-hidden="true" href="#cb613-4" tabindex="-1"></a><span class="dt">void</span> process_data<span class="op">(</span><span class="dt">char</span> <span class="op">*</span>input<span class="op">)</span></span>
<span id="cb613-5"><a aria-hidden="true" href="#cb613-5" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb613-6"><a aria-hidden="true" href="#cb613-6" tabindex="-1"></a>    MemoryContext old_context<span class="op">;</span></span>
<span id="cb613-7"><a aria-hidden="true" href="#cb613-7" tabindex="-1"></a>    <span class="dt">char</span> <span class="op">*</span>buffer<span class="op">;</span></span>
<span id="cb613-8"><a aria-hidden="true" href="#cb613-8" tabindex="-1"></a></span>
<span id="cb613-9"><a aria-hidden="true" href="#cb613-9" tabindex="-1"></a>    <span class="co">/* Create temporary context */</span></span>
<span id="cb613-10"><a aria-hidden="true" href="#cb613-10" tabindex="-1"></a>    MemoryContext temp_context <span class="op">=</span> AllocSetContextCreate<span class="op">(</span></span>
<span id="cb613-11"><a aria-hidden="true" href="#cb613-11" tabindex="-1"></a>        CurrentMemoryContext<span class="op">,</span></span>
<span id="cb613-12"><a aria-hidden="true" href="#cb613-12" tabindex="-1"></a>        <span class="st">"temporary processing"</span><span class="op">,</span></span>
<span id="cb613-13"><a aria-hidden="true" href="#cb613-13" tabindex="-1"></a>        ALLOCSET_DEFAULT_SIZES</span>
<span id="cb613-14"><a aria-hidden="true" href="#cb613-14" tabindex="-1"></a>    <span class="op">);</span></span>
<span id="cb613-15"><a aria-hidden="true" href="#cb613-15" tabindex="-1"></a></span>
<span id="cb613-16"><a aria-hidden="true" href="#cb613-16" tabindex="-1"></a>    old_context <span class="op">=</span> MemoryContextSwitchTo<span class="op">(</span>temp_context<span class="op">);</span></span>
<span id="cb613-17"><a aria-hidden="true" href="#cb613-17" tabindex="-1"></a></span>
<span id="cb613-18"><a aria-hidden="true" href="#cb613-18" tabindex="-1"></a>    <span class="co">/* Allocate in temporary context */</span></span>
<span id="cb613-19"><a aria-hidden="true" href="#cb613-19" tabindex="-1"></a>    buffer <span class="op">=</span> palloc<span class="op">(</span><span class="dv">1024</span><span class="op">);</span></span>
<span id="cb613-20"><a aria-hidden="true" href="#cb613-20" tabindex="-1"></a>    <span class="co">/* Process data */</span></span>
<span id="cb613-21"><a aria-hidden="true" href="#cb613-21" tabindex="-1"></a>    strcpy<span class="op">(</span>buffer<span class="op">,</span> input<span class="op">);</span></span>
<span id="cb613-22"><a aria-hidden="true" href="#cb613-22" tabindex="-1"></a></span>
<span id="cb613-23"><a aria-hidden="true" href="#cb613-23" tabindex="-1"></a>    <span class="co">/* Restore context */</span></span>
<span id="cb613-24"><a aria-hidden="true" href="#cb613-24" tabindex="-1"></a>    MemoryContextSwitchTo<span class="op">(</span>old_context<span class="op">);</span></span>
<span id="cb613-25"><a aria-hidden="true" href="#cb613-25" tabindex="-1"></a></span>
<span id="cb613-26"><a aria-hidden="true" href="#cb613-26" tabindex="-1"></a>    <span class="co">/* Delete context - automatic cleanup even if elog() called */</span></span>
<span id="cb613-27"><a aria-hidden="true" href="#cb613-27" tabindex="-1"></a>    MemoryContextDelete<span class="op">(</span>temp_context<span class="op">);</span></span>
<span id="cb613-28"><a aria-hidden="true" href="#cb613-28" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>Why Memory Contexts Won:</strong> 1. <strong>Automatic
cleanup on error</strong>: No leaks even with exceptions 2. <strong>Bulk
deallocation</strong>: Delete entire context instantly 3.
<strong>Hierarchy</strong>: Parent/child contexts for nested lifetimes
4. <strong>Performance</strong>: Faster than malloc/free for small
allocations</p>
<p><strong>Memory Context Types Evolution:</strong></p>
<p><strong>Original (pre-9.5):</strong> - <code>AllocSet</code>:
General-purpose allocator</p>
<p><strong>Added 9.5:</strong> - <code>Slab</code>: Fixed-size
allocations (faster)</p>
<p><strong>Added 10:</strong> - <code>Generation</code>: Append-only,
bulk reset (for tuple storage)</p>
<p><strong>Code locations:</strong> -
<code>/home/user/postgres/src/backend/utils/mmgr/aset.c</code> -
AllocSet implementation -
<code>/home/user/postgres/src/backend/utils/mmgr/slab.c</code> - Slab
allocator -
<code>/home/user/postgres/src/backend/utils/mmgr/generation.c</code> -
Generation context -
<code>/home/user/postgres/src/backend/utils/mmgr/README</code> - Design
overview</p>
<hr/>
<h4 data-number="10.4.1.2" id="error-handling-evolution"><span class="header-section-number">10.4.1.2</span> Error Handling
Evolution</h4>
<p><strong>Early Pattern (6.x):</strong></p>
<div class="sourceCode" id="cb614"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb614-1"><a aria-hidden="true" href="#cb614-1" tabindex="-1"></a><span class="dt">int</span> dangerous_operation<span class="op">()</span></span>
<span id="cb614-2"><a aria-hidden="true" href="#cb614-2" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb614-3"><a aria-hidden="true" href="#cb614-3" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>something_wrong<span class="op">)</span></span>
<span id="cb614-4"><a aria-hidden="true" href="#cb614-4" tabindex="-1"></a>        <span class="cf">return</span> <span class="op">-</span><span class="dv">1</span><span class="op">;</span>  <span class="co">/* Caller must check! */</span></span>
<span id="cb614-5"><a aria-hidden="true" href="#cb614-5" tabindex="-1"></a></span>
<span id="cb614-6"><a aria-hidden="true" href="#cb614-6" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>more_problems<span class="op">)</span></span>
<span id="cb614-7"><a aria-hidden="true" href="#cb614-7" tabindex="-1"></a>        <span class="cf">return</span> <span class="op">-</span><span class="dv">2</span><span class="op">;</span>  <span class="co">/* Different error codes */</span></span>
<span id="cb614-8"><a aria-hidden="true" href="#cb614-8" tabindex="-1"></a></span>
<span id="cb614-9"><a aria-hidden="true" href="#cb614-9" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span>  <span class="co">/* Success */</span></span>
<span id="cb614-10"><a aria-hidden="true" href="#cb614-10" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb614-11"><a aria-hidden="true" href="#cb614-11" tabindex="-1"></a></span>
<span id="cb614-12"><a aria-hidden="true" href="#cb614-12" tabindex="-1"></a><span class="co">/* Caller must handle all cases */</span></span>
<span id="cb614-13"><a aria-hidden="true" href="#cb614-13" tabindex="-1"></a><span class="cf">if</span> <span class="op">(</span>dangerous_operation<span class="op">()</span> <span class="op">!=</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb614-14"><a aria-hidden="true" href="#cb614-14" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb614-15"><a aria-hidden="true" href="#cb614-15" tabindex="-1"></a>    <span class="co">/* Handle error... but which one? */</span></span>
<span id="cb614-16"><a aria-hidden="true" href="#cb614-16" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>Modern Pattern (7.x+):</strong></p>
<div class="sourceCode" id="cb615"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb615-1"><a aria-hidden="true" href="#cb615-1" tabindex="-1"></a><span class="dt">void</span> dangerous_operation<span class="op">()</span></span>
<span id="cb615-2"><a aria-hidden="true" href="#cb615-2" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb615-3"><a aria-hidden="true" href="#cb615-3" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>something_wrong<span class="op">)</span></span>
<span id="cb615-4"><a aria-hidden="true" href="#cb615-4" tabindex="-1"></a>        ereport<span class="op">(</span>ERROR<span class="op">,</span></span>
<span id="cb615-5"><a aria-hidden="true" href="#cb615-5" tabindex="-1"></a>                <span class="op">(</span>errcode<span class="op">(</span>ERRCODE_DATA_EXCEPTION<span class="op">),</span></span>
<span id="cb615-6"><a aria-hidden="true" href="#cb615-6" tabindex="-1"></a>                 errmsg<span class="op">(</span><span class="st">"something went wrong"</span><span class="op">),</span></span>
<span id="cb615-7"><a aria-hidden="true" href="#cb615-7" tabindex="-1"></a>                 errdetail<span class="op">(</span><span class="st">"Specific details here"</span><span class="op">),</span></span>
<span id="cb615-8"><a aria-hidden="true" href="#cb615-8" tabindex="-1"></a>                 errhint<span class="op">(</span><span class="st">"Try doing X instead"</span><span class="op">)));</span></span>
<span id="cb615-9"><a aria-hidden="true" href="#cb615-9" tabindex="-1"></a></span>
<span id="cb615-10"><a aria-hidden="true" href="#cb615-10" tabindex="-1"></a>    <span class="co">/* No need to check return value -</span></span>
<span id="cb615-11"><a aria-hidden="true" href="#cb615-11" tabindex="-1"></a><span class="co">     * execution never continues past ERROR */</span></span>
<span id="cb615-12"><a aria-hidden="true" href="#cb615-12" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb615-13"><a aria-hidden="true" href="#cb615-13" tabindex="-1"></a></span>
<span id="cb615-14"><a aria-hidden="true" href="#cb615-14" tabindex="-1"></a><span class="co">/* Caller can use PG_TRY/PG_CATCH if recovery needed */</span></span>
<span id="cb615-15"><a aria-hidden="true" href="#cb615-15" tabindex="-1"></a>PG_TRY<span class="op">();</span></span>
<span id="cb615-16"><a aria-hidden="true" href="#cb615-16" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb615-17"><a aria-hidden="true" href="#cb615-17" tabindex="-1"></a>    dangerous_operation<span class="op">();</span></span>
<span id="cb615-18"><a aria-hidden="true" href="#cb615-18" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb615-19"><a aria-hidden="true" href="#cb615-19" tabindex="-1"></a>PG_CATCH<span class="op">();</span></span>
<span id="cb615-20"><a aria-hidden="true" href="#cb615-20" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb615-21"><a aria-hidden="true" href="#cb615-21" tabindex="-1"></a>    <span class="co">/* Handle error, clean up */</span></span>
<span id="cb615-22"><a aria-hidden="true" href="#cb615-22" tabindex="-1"></a>    FlushErrorState<span class="op">();</span></span>
<span id="cb615-23"><a aria-hidden="true" href="#cb615-23" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb615-24"><a aria-hidden="true" href="#cb615-24" tabindex="-1"></a>PG_END_TRY<span class="op">();</span></span></code></pre></div>
<p><strong>Why ereport() Won:</strong> 1. <strong>Exceptions via
longjmp</strong>: No need to propagate error codes 2. <strong>Structured
error info</strong>: Code, message, detail, hint 3. <strong>Automatic
resource cleanup</strong>: Via resource owners and memory contexts 4.
<strong>Client gets detailed errors</strong>: Better debugging</p>
<p><strong>Error Reporting Levels:</strong> - <code>DEBUG1-5</code>:
Development debugging - <code>LOG</code>: Server log messages -
<code>INFO</code>: Informational messages to client -
<code>NOTICE</code>: Non-error notifications - <code>WARNING</code>:
Warning messages - <code>ERROR</code>: Aborts current transaction -
<code>FATAL</code>: Aborts session - <code>PANIC</code>: Crashes entire
cluster (use very rarely!)</p>
<hr/>
<h4 data-number="10.4.1.3" id="locking-pattern-evolution"><span class="header-section-number">10.4.1.3</span> Locking Pattern
Evolution</h4>
<p><strong>Early Pattern (6.x-7.x):</strong></p>
<div class="sourceCode" id="cb616"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb616-1"><a aria-hidden="true" href="#cb616-1" tabindex="-1"></a><span class="co">/* Direct lock acquisition */</span></span>
<span id="cb616-2"><a aria-hidden="true" href="#cb616-2" tabindex="-1"></a><span class="dt">void</span> modify_relation<span class="op">(</span>Relation rel<span class="op">)</span></span>
<span id="cb616-3"><a aria-hidden="true" href="#cb616-3" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb616-4"><a aria-hidden="true" href="#cb616-4" tabindex="-1"></a>    LockRelation<span class="op">(</span>rel<span class="op">,</span> AccessExclusiveLock<span class="op">);</span></span>
<span id="cb616-5"><a aria-hidden="true" href="#cb616-5" tabindex="-1"></a></span>
<span id="cb616-6"><a aria-hidden="true" href="#cb616-6" tabindex="-1"></a>    <span class="co">/* Modify relation */</span></span>
<span id="cb616-7"><a aria-hidden="true" href="#cb616-7" tabindex="-1"></a></span>
<span id="cb616-8"><a aria-hidden="true" href="#cb616-8" tabindex="-1"></a>    UnlockRelation<span class="op">(</span>rel<span class="op">,</span> AccessExclusiveLock<span class="op">);</span></span>
<span id="cb616-9"><a aria-hidden="true" href="#cb616-9" tabindex="-1"></a>    <span class="co">/* Must manually unlock */</span></span>
<span id="cb616-10"><a aria-hidden="true" href="#cb616-10" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>Modern Pattern (8.x+):</strong></p>
<div class="sourceCode" id="cb617"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb617-1"><a aria-hidden="true" href="#cb617-1" tabindex="-1"></a><span class="co">/* Resource-managed locking */</span></span>
<span id="cb617-2"><a aria-hidden="true" href="#cb617-2" tabindex="-1"></a><span class="dt">void</span> modify_relation<span class="op">(</span>Relation rel<span class="op">)</span></span>
<span id="cb617-3"><a aria-hidden="true" href="#cb617-3" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb617-4"><a aria-hidden="true" href="#cb617-4" tabindex="-1"></a>    <span class="co">/* Lock acquired */</span></span>
<span id="cb617-5"><a aria-hidden="true" href="#cb617-5" tabindex="-1"></a>    LockRelation<span class="op">(</span>rel<span class="op">,</span> AccessExclusiveLock<span class="op">);</span></span>
<span id="cb617-6"><a aria-hidden="true" href="#cb617-6" tabindex="-1"></a></span>
<span id="cb617-7"><a aria-hidden="true" href="#cb617-7" tabindex="-1"></a>    <span class="co">/* Modify relation */</span></span>
<span id="cb617-8"><a aria-hidden="true" href="#cb617-8" tabindex="-1"></a></span>
<span id="cb617-9"><a aria-hidden="true" href="#cb617-9" tabindex="-1"></a>    <span class="co">/* Lock automatically released at transaction end</span></span>
<span id="cb617-10"><a aria-hidden="true" href="#cb617-10" tabindex="-1"></a><span class="co">     * Even if ereport(ERROR) called!</span></span>
<span id="cb617-11"><a aria-hidden="true" href="#cb617-11" tabindex="-1"></a><span class="co">     * No need to manually unlock in normal code */</span></span>
<span id="cb617-12"><a aria-hidden="true" href="#cb617-12" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb617-13"><a aria-hidden="true" href="#cb617-13" tabindex="-1"></a></span>
<span id="cb617-14"><a aria-hidden="true" href="#cb617-14" tabindex="-1"></a><span class="co">/* Manual unlock only for early release optimization */</span></span></code></pre></div>
<p><strong>Lock Granularity Evolution:</strong></p>
<p><strong>Version 6.x-7.x:</strong> - Table-level locks only - High
contention on popular tables</p>
<p><strong>Version 8.x:</strong> - Row-level locking matured - Multiple
lock modes (8 modes)</p>
<p><strong>Version 9.x:</strong> - Fast-path locking for simple cases -
Advisory locks for application coordination - Predicate locks for SSI
(Serializable Snapshot Isolation)</p>
<p><strong>Lock-Free Algorithms Introduction:</strong></p>
<p><strong>Version 9.5+</strong>: Atomic operations abstraction</p>
<div class="sourceCode" id="cb618"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb618-1"><a aria-hidden="true" href="#cb618-1" tabindex="-1"></a><span class="co">/* src/include/port/atomics.h</span></span>
<span id="cb618-2"><a aria-hidden="true" href="#cb618-2" tabindex="-1"></a><span class="co"> * Platform-independent atomic operations */</span></span>
<span id="cb618-3"><a aria-hidden="true" href="#cb618-3" tabindex="-1"></a></span>
<span id="cb618-4"><a aria-hidden="true" href="#cb618-4" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> pg_atomic_uint32</span>
<span id="cb618-5"><a aria-hidden="true" href="#cb618-5" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb618-6"><a aria-hidden="true" href="#cb618-6" tabindex="-1"></a>    <span class="dt">volatile</span> uint32 value<span class="op">;</span></span>
<span id="cb618-7"><a aria-hidden="true" href="#cb618-7" tabindex="-1"></a><span class="op">}</span> pg_atomic_uint32<span class="op">;</span></span>
<span id="cb618-8"><a aria-hidden="true" href="#cb618-8" tabindex="-1"></a></span>
<span id="cb618-9"><a aria-hidden="true" href="#cb618-9" tabindex="-1"></a><span class="co">/* Atomic increment - no lock needed! */</span></span>
<span id="cb618-10"><a aria-hidden="true" href="#cb618-10" tabindex="-1"></a>pg_atomic_fetch_add_u32<span class="op">(&amp;</span>variable<span class="op">,</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb618-11"><a aria-hidden="true" href="#cb618-11" tabindex="-1"></a></span>
<span id="cb618-12"><a aria-hidden="true" href="#cb618-12" tabindex="-1"></a><span class="co">/* Compare-and-swap */</span></span>
<span id="cb618-13"><a aria-hidden="true" href="#cb618-13" tabindex="-1"></a>pg_atomic_compare_exchange_u32<span class="op">(&amp;</span>variable<span class="op">,</span> <span class="op">&amp;</span>expected<span class="op">,</span> new_value<span class="op">);</span></span></code></pre></div>
<p><strong>Use Cases:</strong> - Statistics counters (pg_stat_*) -
Reference counting - Wait-free algorithms in specific hot paths</p>
<p><strong>Lock-Free Buffer Management (13+):</strong></p>
<div class="sourceCode" id="cb619"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb619-1"><a aria-hidden="true" href="#cb619-1" tabindex="-1"></a><span class="co">/* Buffer pin/unpin optimized with atomics</span></span>
<span id="cb619-2"><a aria-hidden="true" href="#cb619-2" tabindex="-1"></a><span class="co"> * Previously required LWLock for every pin/unpin</span></span>
<span id="cb619-3"><a aria-hidden="true" href="#cb619-3" tabindex="-1"></a><span class="co"> * Now uses atomic operations for fast path */</span></span>
<span id="cb619-4"><a aria-hidden="true" href="#cb619-4" tabindex="-1"></a></span>
<span id="cb619-5"><a aria-hidden="true" href="#cb619-5" tabindex="-1"></a><span class="co">/* src/backend/storage/buffer/bufmgr.c */</span></span>
<span id="cb619-6"><a aria-hidden="true" href="#cb619-6" tabindex="-1"></a>pg_atomic_fetch_add_u32<span class="op">(&amp;</span>buf<span class="op">-&gt;</span>refcount<span class="op">,</span> <span class="dv">1</span><span class="op">);</span>  <span class="co">/* Pin buffer */</span></span>
<span id="cb619-7"><a aria-hidden="true" href="#cb619-7" tabindex="-1"></a>pg_atomic_fetch_sub_u32<span class="op">(&amp;</span>buf<span class="op">-&gt;</span>refcount<span class="op">,</span> <span class="dv">1</span><span class="op">);</span>  <span class="co">/* Unpin buffer */</span></span></code></pre></div>
<hr/>
<h4 data-number="10.4.1.4" id="type-system-evolution"><span class="header-section-number">10.4.1.4</span> Type System Evolution</h4>
<p><strong>Early Pattern (6.x-7.x):</strong></p>
<div class="sourceCode" id="cb620"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb620-1"><a aria-hidden="true" href="#cb620-1" tabindex="-1"></a><span class="co">/* Built-in types hardcoded */</span></span>
<span id="cb620-2"><a aria-hidden="true" href="#cb620-2" tabindex="-1"></a><span class="cf">switch</span> <span class="op">(</span>typeid<span class="op">)</span></span>
<span id="cb620-3"><a aria-hidden="true" href="#cb620-3" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb620-4"><a aria-hidden="true" href="#cb620-4" tabindex="-1"></a>    <span class="cf">case</span> INT4OID<span class="op">:</span></span>
<span id="cb620-5"><a aria-hidden="true" href="#cb620-5" tabindex="-1"></a>        <span class="co">/* Handle integer */</span></span>
<span id="cb620-6"><a aria-hidden="true" href="#cb620-6" tabindex="-1"></a>        <span class="cf">break</span><span class="op">;</span></span>
<span id="cb620-7"><a aria-hidden="true" href="#cb620-7" tabindex="-1"></a>    <span class="cf">case</span> TEXTOID<span class="op">:</span></span>
<span id="cb620-8"><a aria-hidden="true" href="#cb620-8" tabindex="-1"></a>        <span class="co">/* Handle text */</span></span>
<span id="cb620-9"><a aria-hidden="true" href="#cb620-9" tabindex="-1"></a>        <span class="cf">break</span><span class="op">;</span></span>
<span id="cb620-10"><a aria-hidden="true" href="#cb620-10" tabindex="-1"></a>    <span class="co">/* Must modify code to add types */</span></span>
<span id="cb620-11"><a aria-hidden="true" href="#cb620-11" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>Modern Pattern (7.x+):</strong></p>
<div class="sourceCode" id="cb621"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb621-1"><a aria-hidden="true" href="#cb621-1" tabindex="-1"></a><span class="co">/* Type system driven by pg_type catalog */</span></span>
<span id="cb621-2"><a aria-hidden="true" href="#cb621-2" tabindex="-1"></a>HeapTuple typeTup <span class="op">=</span> SearchSysCache1<span class="op">(</span>TYPEOID<span class="op">,</span> ObjectIdGetDatum<span class="op">(</span>typeid<span class="op">));</span></span>
<span id="cb621-3"><a aria-hidden="true" href="#cb621-3" tabindex="-1"></a>Form_pg_type typeForm <span class="op">=</span> <span class="op">(</span>Form_pg_type<span class="op">)</span> GETSTRUCT<span class="op">(</span>typeTup<span class="op">);</span></span>
<span id="cb621-4"><a aria-hidden="true" href="#cb621-4" tabindex="-1"></a></span>
<span id="cb621-5"><a aria-hidden="true" href="#cb621-5" tabindex="-1"></a><span class="co">/* Call type's input/output/send/receive functions dynamically */</span></span>
<span id="cb621-6"><a aria-hidden="true" href="#cb621-6" tabindex="-1"></a>Datum result <span class="op">=</span> OidFunctionCall1<span class="op">(</span>typeForm<span class="op">-&gt;</span>typinput<span class="op">,</span> CStringGetDatum<span class="op">(</span>str<span class="op">));</span></span>
<span id="cb621-7"><a aria-hidden="true" href="#cb621-7" tabindex="-1"></a></span>
<span id="cb621-8"><a aria-hidden="true" href="#cb621-8" tabindex="-1"></a>ReleaseSysCache<span class="op">(</span>typeTup<span class="op">);</span></span></code></pre></div>
<p><strong>This Enables:</strong> - User-defined types - Extensions
adding types - Polymorphic functions - Type modifiers</p>
<p><strong>Extension Type Example (hstore):</strong></p>
<div class="sourceCode" id="cb622"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb622-1"><a aria-hidden="true" href="#cb622-1" tabindex="-1"></a><span class="kw">CREATE</span> EXTENSION hstore;</span>
<span id="cb622-2"><a aria-hidden="true" href="#cb622-2" tabindex="-1"></a></span>
<span id="cb622-3"><a aria-hidden="true" href="#cb622-3" tabindex="-1"></a><span class="co">-- New type available immediately!</span></span>
<span id="cb622-4"><a aria-hidden="true" href="#cb622-4" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> config (</span>
<span id="cb622-5"><a aria-hidden="true" href="#cb622-5" tabindex="-1"></a>    <span class="kw">id</span> serial,</span>
<span id="cb622-6"><a aria-hidden="true" href="#cb622-6" tabindex="-1"></a>    settings hstore</span>
<span id="cb622-7"><a aria-hidden="true" href="#cb622-7" tabindex="-1"></a>);</span>
<span id="cb622-8"><a aria-hidden="true" href="#cb622-8" tabindex="-1"></a></span>
<span id="cb622-9"><a aria-hidden="true" href="#cb622-9" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> config (settings) <span class="kw">VALUES</span> (<span class="st">'a=&gt;1,b=&gt;2'</span>:<span class="ch">:hstore</span>);</span></code></pre></div>
<p><strong>Implementation:</strong> -
<code>/home/user/postgres/contrib/hstore/hstore--1.8.sql</code> - Type
definition - <code>/home/user/postgres/contrib/hstore/hstore_io.c</code>
- I/O functions - Type registered in <code>pg_type</code> catalog</p>
<hr/>
<h3 data-number="10.4.2" id="parallel-query-evolution"><span class="header-section-number">10.4.2</span> Parallel Query
Evolution</h3>
<p>The introduction of parallel query represents one of the most
significant architectural changes in PostgreSQL history.</p>
<h4 data-number="10.4.2.1" id="pre-9.6-single-process-query-execution"><span class="header-section-number">10.4.2.1</span> Pre-9.6: Single-Process
Query Execution</h4>
<p><strong>Architecture:</strong></p>
<pre><code>Client Connection
    ‚Üì
Backend Process (single-threaded)
    - Parse
    - Plan
    - Execute
    - Return results</code></pre>
<p><strong>Limitation</strong>: Cannot utilize multiple CPU cores for a
single query.</p>
<h4 data-number="10.4.2.2" id="parallel-sequential-scan"><span class="header-section-number">10.4.2.2</span> 9.6: Parallel Sequential
Scan</h4>
<p><strong>First parallel operation:</strong> Sequential scans.</p>
<p><strong>Architecture:</strong></p>
<div class="sourceCode" id="cb624"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb624-1"><a aria-hidden="true" href="#cb624-1" tabindex="-1"></a><span class="co">/* src/backend/access/transam/README.parallel</span></span>
<span id="cb624-2"><a aria-hidden="true" href="#cb624-2" tabindex="-1"></a><span class="co"> * Parallel query infrastructure */</span></span>
<span id="cb624-3"><a aria-hidden="true" href="#cb624-3" tabindex="-1"></a></span>
<span id="cb624-4"><a aria-hidden="true" href="#cb624-4" tabindex="-1"></a><span class="co">/* Leader backend:</span></span>
<span id="cb624-5"><a aria-hidden="true" href="#cb624-5" tabindex="-1"></a><span class="co"> * 1. Creates dynamic shared memory segment</span></span>
<span id="cb624-6"><a aria-hidden="true" href="#cb624-6" tabindex="-1"></a><span class="co"> * 2. Launches worker processes</span></span>
<span id="cb624-7"><a aria-hidden="true" href="#cb624-7" tabindex="-1"></a><span class="co"> * 3. Distributes work (page ranges)</span></span>
<span id="cb624-8"><a aria-hidden="true" href="#cb624-8" tabindex="-1"></a><span class="co"> * 4. Gathers results</span></span>
<span id="cb624-9"><a aria-hidden="true" href="#cb624-9" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb624-10"><a aria-hidden="true" href="#cb624-10" tabindex="-1"></a></span>
<span id="cb624-11"><a aria-hidden="true" href="#cb624-11" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> ParallelContext</span>
<span id="cb624-12"><a aria-hidden="true" href="#cb624-12" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb624-13"><a aria-hidden="true" href="#cb624-13" tabindex="-1"></a>    dsa_area   <span class="op">*</span>seg<span class="op">;</span>              <span class="co">/* Dynamic shared memory */</span></span>
<span id="cb624-14"><a aria-hidden="true" href="#cb624-14" tabindex="-1"></a>    <span class="dt">int</span>         nworkers<span class="op">;</span></span>
<span id="cb624-15"><a aria-hidden="true" href="#cb624-15" tabindex="-1"></a>    BackgroundWorkerHandle <span class="op">*</span>worker<span class="op">;</span></span>
<span id="cb624-16"><a aria-hidden="true" href="#cb624-16" tabindex="-1"></a>    shm_toc    <span class="op">*</span>toc<span class="op">;</span>              <span class="co">/* Shared memory table of contents */</span></span>
<span id="cb624-17"><a aria-hidden="true" href="#cb624-17" tabindex="-1"></a><span class="op">}</span> ParallelContext<span class="op">;</span></span></code></pre></div>
<p><strong>Challenges Solved:</strong> 1. <strong>State
synchronization</strong>: Workers need same transaction snapshot, GUC
values, etc. 2. <strong>Error propagation</strong>: Worker errors
reported to leader 3. <strong>Dynamic shared memory</strong>: Allocated
per-query 4. <strong>Work distribution</strong>: Block-level page
assignment 5. <strong>Result gathering</strong>: Tuple queue from
workers to leader</p>
<p><strong>Code Pattern:</strong></p>
<div class="sourceCode" id="cb625"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb625-1"><a aria-hidden="true" href="#cb625-1" tabindex="-1"></a><span class="co">/* Simplified parallel seq scan pattern */</span></span>
<span id="cb625-2"><a aria-hidden="true" href="#cb625-2" tabindex="-1"></a></span>
<span id="cb625-3"><a aria-hidden="true" href="#cb625-3" tabindex="-1"></a><span class="co">/* Leader: */</span></span>
<span id="cb625-4"><a aria-hidden="true" href="#cb625-4" tabindex="-1"></a>EnterParallelMode<span class="op">();</span></span>
<span id="cb625-5"><a aria-hidden="true" href="#cb625-5" tabindex="-1"></a>ParallelContext <span class="op">*</span>pcxt <span class="op">=</span> CreateParallelContext<span class="op">(</span><span class="st">"postgres"</span><span class="op">,</span> <span class="st">"ParallelQueryMain"</span><span class="op">,</span> <span class="dv">2</span><span class="op">);</span></span>
<span id="cb625-6"><a aria-hidden="true" href="#cb625-6" tabindex="-1"></a>InitializeParallelDSM<span class="op">(</span>pcxt<span class="op">);</span></span>
<span id="cb625-7"><a aria-hidden="true" href="#cb625-7" tabindex="-1"></a>LaunchParallelWorkers<span class="op">(</span>pcxt<span class="op">);</span></span>
<span id="cb625-8"><a aria-hidden="true" href="#cb625-8" tabindex="-1"></a></span>
<span id="cb625-9"><a aria-hidden="true" href="#cb625-9" tabindex="-1"></a><span class="co">/* Leader and workers execute: */</span></span>
<span id="cb625-10"><a aria-hidden="true" href="#cb625-10" tabindex="-1"></a><span class="cf">while</span> <span class="op">(</span>more_pages<span class="op">)</span></span>
<span id="cb625-11"><a aria-hidden="true" href="#cb625-11" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb625-12"><a aria-hidden="true" href="#cb625-12" tabindex="-1"></a>    page <span class="op">=</span> get_next_page<span class="op">();</span>  <span class="co">/* Atomic assignment */</span></span>
<span id="cb625-13"><a aria-hidden="true" href="#cb625-13" tabindex="-1"></a>    scan_page<span class="op">(</span>page<span class="op">);</span></span>
<span id="cb625-14"><a aria-hidden="true" href="#cb625-14" tabindex="-1"></a>    send_tuples_to_leader<span class="op">(</span>page<span class="op">);</span></span>
<span id="cb625-15"><a aria-hidden="true" href="#cb625-15" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb625-16"><a aria-hidden="true" href="#cb625-16" tabindex="-1"></a></span>
<span id="cb625-17"><a aria-hidden="true" href="#cb625-17" tabindex="-1"></a><span class="co">/* Leader: */</span></span>
<span id="cb625-18"><a aria-hidden="true" href="#cb625-18" tabindex="-1"></a>WaitForParallelWorkersToFinish<span class="op">(</span>pcxt<span class="op">);</span></span>
<span id="cb625-19"><a aria-hidden="true" href="#cb625-19" tabindex="-1"></a>ExitParallelMode<span class="op">();</span></span></code></pre></div>
<h4 data-number="10.4.2.3" id="parallel-hash-join-aggregate-index-scan"><span class="header-section-number">10.4.2.3</span> 10-11: Parallel Hash Join,
Aggregate, Index Scan</h4>
<p><strong>10 added:</strong> - Parallel Hash Join - Parallel B-tree
Index Scan - Parallel Bitmap Heap Scan</p>
<p><strong>11 added:</strong> - Parallel Hash - Parallel Append -
Partition-wise join</p>
<p><strong>Growing Complexity:</strong></p>
<div class="sourceCode" id="cb626"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb626-1"><a aria-hidden="true" href="#cb626-1" tabindex="-1"></a><span class="co">/* Parallel hash join requires:</span></span>
<span id="cb626-2"><a aria-hidden="true" href="#cb626-2" tabindex="-1"></a><span class="co"> * 1. Shared hash table in dynamic shared memory</span></span>
<span id="cb626-3"><a aria-hidden="true" href="#cb626-3" tabindex="-1"></a><span class="co"> * 2. Synchronization barriers for build/probe phases</span></span>
<span id="cb626-4"><a aria-hidden="true" href="#cb626-4" tabindex="-1"></a><span class="co"> * 3. Work distribution for both build and probe</span></span>
<span id="cb626-5"><a aria-hidden="true" href="#cb626-5" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb626-6"><a aria-hidden="true" href="#cb626-6" tabindex="-1"></a></span>
<span id="cb626-7"><a aria-hidden="true" href="#cb626-7" tabindex="-1"></a><span class="co">/* src/backend/executor/nodeHashjoin.c */</span></span>
<span id="cb626-8"><a aria-hidden="true" href="#cb626-8" tabindex="-1"></a><span class="co">/* Each worker:</span></span>
<span id="cb626-9"><a aria-hidden="true" href="#cb626-9" tabindex="-1"></a><span class="co"> * - Builds portion of hash table</span></span>
<span id="cb626-10"><a aria-hidden="true" href="#cb626-10" tabindex="-1"></a><span class="co"> * - Waits at barrier until all done building</span></span>
<span id="cb626-11"><a aria-hidden="true" href="#cb626-11" tabindex="-1"></a><span class="co"> * - Probes hash table with its portion of outer relation</span></span>
<span id="cb626-12"><a aria-hidden="true" href="#cb626-12" tabindex="-1"></a><span class="co"> */</span></span></code></pre></div>
<h4 data-number="10.4.2.4" id="parallel-index-build-copy"><span class="header-section-number">10.4.2.4</span> 12-14: Parallel Index
Build, COPY</h4>
<p><strong>13 added:</strong> - Parallel VACUUM (already discussed)</p>
<p><strong>14 added:</strong> - Parallel refresh of materialized
views</p>
<p><strong>Growing Parallelism:</strong></p>
<div class="sourceCode" id="cb627"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb627-1"><a aria-hidden="true" href="#cb627-1" tabindex="-1"></a><span class="co">/* More and more operations become parallel-aware:</span></span>
<span id="cb627-2"><a aria-hidden="true" href="#cb627-2" tabindex="-1"></a><span class="co"> * - CREATE INDEX can use workers</span></span>
<span id="cb627-3"><a aria-hidden="true" href="#cb627-3" tabindex="-1"></a><span class="co"> * - VACUUM indexes in parallel</span></span>
<span id="cb627-4"><a aria-hidden="true" href="#cb627-4" tabindex="-1"></a><span class="co"> * - Aggregate functions in parallel</span></span>
<span id="cb627-5"><a aria-hidden="true" href="#cb627-5" tabindex="-1"></a><span class="co"> * - Window functions (limited)</span></span>
<span id="cb627-6"><a aria-hidden="true" href="#cb627-6" tabindex="-1"></a><span class="co"> */</span></span></code></pre></div>
<h4 data-number="10.4.2.5" id="pervasive-parallelism"><span class="header-section-number">10.4.2.5</span> 16-17: Pervasive
Parallelism</h4>
<p><strong>16+ parallelizes:</strong> - FULL and RIGHT outer joins -
UNION queries - More built-in functions - String operations</p>
<p><strong>Modern Pattern (17):</strong> Most major operations check:
‚ÄúCan this be parallelized?‚Äù</p>
<p><strong>Configuration Evolution:</strong></p>
<p><strong>9.6 (initial):</strong></p>
<pre><code>max_parallel_workers_per_gather = 2
max_worker_processes = 8</code></pre>
<p><strong>17 (current):</strong></p>
<pre><code>max_parallel_workers_per_gather = 8    # Can use more workers
max_parallel_workers = 24              # Total parallel workers
max_worker_processes = 24              # Total background workers
parallel_setup_cost = 1000             # Cost to start parallelism
parallel_tuple_cost = 0.1              # Cost per tuple in parallel
min_parallel_table_scan_size = 8MB     # Minimum table size</code></pre>
<p><strong>Planner Sophistication:</strong> The planner now considers: -
Cost of launching workers - Expected speedup - Available resources -
Table size - Operation types</p>
<hr/>
<h3 data-number="10.4.3" id="memory-management-improvements"><span class="header-section-number">10.4.3</span> Memory Management
Improvements</h3>
<h4 data-number="10.4.3.1" id="the-memory-context-system-maturity"><span class="header-section-number">10.4.3.1</span> The Memory Context System
Maturity</h4>
<p><strong>Purpose</strong>: Manage memory lifecycles matching
PostgreSQL‚Äôs operational phases.</p>
<p><strong>Standard Context Hierarchy (by 8.x):</strong></p>
<pre><code>TopMemoryContext (lifetime: server process)
    ‚îú‚îÄ ErrorContext (reset after error recovery)
    ‚îú‚îÄ PostmasterContext (postmaster-only data)
    ‚îî‚îÄ TopTransactionContext (lifetime: transaction)
        ‚îú‚îÄ CurTransactionContext (current subtransaction)
        ‚îÇ   ‚îú‚îÄ ExecutorState (query execution)
        ‚îÇ   ‚îÇ   ‚îî‚îÄ ExprContext (per-tuple evaluation)
        ‚îÇ   ‚îî‚îÄ Portal (cursor/prepared statement)
        ‚îî‚îÄ TopPortalContext (portals outliving transaction)</code></pre>
<p><strong>Automatic Cleanup:</strong> - End of query: Delete
ExecutorState context - End of transaction: Reset TopTransactionContext
- Error: ErrorContext preserved, others reset - Process exit: All memory
freed by OS</p>
<p><strong>Evolution Timeline:</strong></p>
<p><strong>7.x</strong>: Memory contexts established
<strong>8.x</strong>: Context callbacks added <strong>9.5</strong>: Slab
allocator for fixed-size chunks <strong>10</strong>: Generation context
for append-only workloads <strong>12+</strong>: Better accounting and
limits</p>
<p><strong>Modern Best Practice:</strong></p>
<div class="sourceCode" id="cb631"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb631-1"><a aria-hidden="true" href="#cb631-1" tabindex="-1"></a><span class="co">/* Create query-specific context */</span></span>
<span id="cb631-2"><a aria-hidden="true" href="#cb631-2" tabindex="-1"></a>MemoryContext query_context <span class="op">=</span> AllocSetContextCreate<span class="op">(</span></span>
<span id="cb631-3"><a aria-hidden="true" href="#cb631-3" tabindex="-1"></a>    CurrentMemoryContext<span class="op">,</span></span>
<span id="cb631-4"><a aria-hidden="true" href="#cb631-4" tabindex="-1"></a>    <span class="st">"MyQueryContext"</span><span class="op">,</span></span>
<span id="cb631-5"><a aria-hidden="true" href="#cb631-5" tabindex="-1"></a>    ALLOCSET_DEFAULT_SIZES</span>
<span id="cb631-6"><a aria-hidden="true" href="#cb631-6" tabindex="-1"></a><span class="op">);</span></span>
<span id="cb631-7"><a aria-hidden="true" href="#cb631-7" tabindex="-1"></a></span>
<span id="cb631-8"><a aria-hidden="true" href="#cb631-8" tabindex="-1"></a><span class="co">/* Switch to it */</span></span>
<span id="cb631-9"><a aria-hidden="true" href="#cb631-9" tabindex="-1"></a>MemoryContext oldcontext <span class="op">=</span> MemoryContextSwitchTo<span class="op">(</span>query_context<span class="op">);</span></span>
<span id="cb631-10"><a aria-hidden="true" href="#cb631-10" tabindex="-1"></a></span>
<span id="cb631-11"><a aria-hidden="true" href="#cb631-11" tabindex="-1"></a><span class="co">/* All allocations go into query_context */</span></span>
<span id="cb631-12"><a aria-hidden="true" href="#cb631-12" tabindex="-1"></a>result <span class="op">=</span> palloc<span class="op">(</span>size<span class="op">);</span></span>
<span id="cb631-13"><a aria-hidden="true" href="#cb631-13" tabindex="-1"></a></span>
<span id="cb631-14"><a aria-hidden="true" href="#cb631-14" tabindex="-1"></a><span class="co">/* Switch back */</span></span>
<span id="cb631-15"><a aria-hidden="true" href="#cb631-15" tabindex="-1"></a>MemoryContextSwitchTo<span class="op">(</span>oldcontext<span class="op">);</span></span>
<span id="cb631-16"><a aria-hidden="true" href="#cb631-16" tabindex="-1"></a></span>
<span id="cb631-17"><a aria-hidden="true" href="#cb631-17" tabindex="-1"></a><span class="co">/* Later: delete entire context at once */</span></span>
<span id="cb631-18"><a aria-hidden="true" href="#cb631-18" tabindex="-1"></a>MemoryContextDelete<span class="op">(</span>query_context<span class="op">);</span></span>
<span id="cb631-19"><a aria-hidden="true" href="#cb631-19" tabindex="-1"></a><span class="co">/* All memory freed, even if thousands of allocations */</span></span></code></pre></div>
<h4 data-number="10.4.3.2" id="buffer-management-evolution"><span class="header-section-number">10.4.3.2</span> Buffer Management
Evolution</h4>
<p><strong>Purpose</strong>: Manage shared buffer cache (PostgreSQL‚Äôs
main memory cache).</p>
<p><strong>Algorithm Evolution:</strong></p>
<p><strong>6.x-7.x: Simple LRU</strong></p>
<div class="sourceCode" id="cb632"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb632-1"><a aria-hidden="true" href="#cb632-1" tabindex="-1"></a><span class="co">/* Least Recently Used</span></span>
<span id="cb632-2"><a aria-hidden="true" href="#cb632-2" tabindex="-1"></a><span class="co"> * Problem: Sequential scans evict entire cache */</span></span></code></pre></div>
<p><strong>8.x: Clock Sweep (ARC-like)</strong></p>
<div class="sourceCode" id="cb633"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb633-1"><a aria-hidden="true" href="#cb633-1" tabindex="-1"></a><span class="co">/* src/backend/storage/buffer/freelist.c</span></span>
<span id="cb633-2"><a aria-hidden="true" href="#cb633-2" tabindex="-1"></a><span class="co"> * Clock sweep with usage count</span></span>
<span id="cb633-3"><a aria-hidden="true" href="#cb633-3" tabindex="-1"></a><span class="co"> * Each buffer has usage_count (0-5)</span></span>
<span id="cb633-4"><a aria-hidden="true" href="#cb633-4" tabindex="-1"></a><span class="co"> * On access: usage_count = 5</span></span>
<span id="cb633-5"><a aria-hidden="true" href="#cb633-5" tabindex="-1"></a><span class="co"> * Clock sweep: decrement usage_count, evict if 0</span></span>
<span id="cb633-6"><a aria-hidden="true" href="#cb633-6" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb633-7"><a aria-hidden="true" href="#cb633-7" tabindex="-1"></a></span>
<span id="cb633-8"><a aria-hidden="true" href="#cb633-8" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> BufferDesc</span>
<span id="cb633-9"><a aria-hidden="true" href="#cb633-9" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb633-10"><a aria-hidden="true" href="#cb633-10" tabindex="-1"></a>    BufferTag   tag<span class="op">;</span>          <span class="co">/* Identity of page */</span></span>
<span id="cb633-11"><a aria-hidden="true" href="#cb633-11" tabindex="-1"></a>    <span class="dt">int</span>         buf_id<span class="op">;</span></span>
<span id="cb633-12"><a aria-hidden="true" href="#cb633-12" tabindex="-1"></a>    pg_atomic_uint32 state<span class="op">;</span>   <span class="co">/* Flags and refcount */</span></span>
<span id="cb633-13"><a aria-hidden="true" href="#cb633-13" tabindex="-1"></a>    <span class="dt">int</span>         usage_count<span class="op">;</span>  <span class="co">/* For clock sweep */</span></span>
<span id="cb633-14"><a aria-hidden="true" href="#cb633-14" tabindex="-1"></a>    <span class="co">/* ... */</span></span>
<span id="cb633-15"><a aria-hidden="true" href="#cb633-15" tabindex="-1"></a><span class="op">}</span> BufferDesc<span class="op">;</span></span></code></pre></div>
<p><strong>Benefits:</strong> - Sequential scans don‚Äôt evict hot pages -
Frequently-accessed pages stay in cache - Better cache hit ratio</p>
<p><strong>9.x+: Ring Buffers</strong></p>
<div class="sourceCode" id="cb634"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb634-1"><a aria-hidden="true" href="#cb634-1" tabindex="-1"></a><span class="co">/* Large sequential scans use small "ring buffer"</span></span>
<span id="cb634-2"><a aria-hidden="true" href="#cb634-2" tabindex="-1"></a><span class="co"> * Don't pollute entire shared_buffers</span></span>
<span id="cb634-3"><a aria-hidden="true" href="#cb634-3" tabindex="-1"></a><span class="co"> *</span></span>
<span id="cb634-4"><a aria-hidden="true" href="#cb634-4" tabindex="-1"></a><span class="co"> * Scan allocates 256KB ring buffer (32 pages)</span></span>
<span id="cb634-5"><a aria-hidden="true" href="#cb634-5" tabindex="-1"></a><span class="co"> * Uses only those buffers, doesn't evict others</span></span>
<span id="cb634-6"><a aria-hidden="true" href="#cb634-6" tabindex="-1"></a><span class="co"> */</span></span></code></pre></div>
<p><strong>13+: Atomic Operations for Pin/Unpin</strong></p>
<div class="sourceCode" id="cb635"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb635-1"><a aria-hidden="true" href="#cb635-1" tabindex="-1"></a><span class="co">/* Previously: LWLock for every buffer pin/unpin</span></span>
<span id="cb635-2"><a aria-hidden="true" href="#cb635-2" tabindex="-1"></a><span class="co"> * Now: Atomic increment/decrement for refcount</span></span>
<span id="cb635-3"><a aria-hidden="true" href="#cb635-3" tabindex="-1"></a><span class="co"> *</span></span>
<span id="cb635-4"><a aria-hidden="true" href="#cb635-4" tabindex="-1"></a><span class="co"> * Massive performance improvement for buffer-intensive workloads</span></span>
<span id="cb635-5"><a aria-hidden="true" href="#cb635-5" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb635-6"><a aria-hidden="true" href="#cb635-6" tabindex="-1"></a></span>
<span id="cb635-7"><a aria-hidden="true" href="#cb635-7" tabindex="-1"></a><span class="co">/* Fast path (no lock!) */</span></span>
<span id="cb635-8"><a aria-hidden="true" href="#cb635-8" tabindex="-1"></a>pg_atomic_fetch_add_u32<span class="op">(&amp;</span>buf<span class="op">-&gt;</span>state<span class="op">,</span> <span class="dv">1</span><span class="op">);</span>  <span class="co">/* Pin */</span></span></code></pre></div>
<hr/>
<h3 data-number="10.4.4" id="error-handling-evolution-1"><span class="header-section-number">10.4.4</span> Error Handling
Evolution</h3>
<h4 data-number="10.4.4.1" id="resource-owners-8.x"><span class="header-section-number">10.4.4.1</span> Resource Owners
(8.x+)</h4>
<p><strong>Problem</strong>: When error occurs, how to clean up
resources?</p>
<p><strong>Solution</strong>: Resource owners track all resources.</p>
<div class="sourceCode" id="cb636"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb636-1"><a aria-hidden="true" href="#cb636-1" tabindex="-1"></a><span class="co">/* src/backend/utils/resowner/README */</span></span>
<span id="cb636-2"><a aria-hidden="true" href="#cb636-2" tabindex="-1"></a></span>
<span id="cb636-3"><a aria-hidden="true" href="#cb636-3" tabindex="-1"></a><span class="co">/* Resources tracked:</span></span>
<span id="cb636-4"><a aria-hidden="true" href="#cb636-4" tabindex="-1"></a><span class="co"> * - Buffer pins</span></span>
<span id="cb636-5"><a aria-hidden="true" href="#cb636-5" tabindex="-1"></a><span class="co"> * - Relation references</span></span>
<span id="cb636-6"><a aria-hidden="true" href="#cb636-6" tabindex="-1"></a><span class="co"> * - Tuple descriptors</span></span>
<span id="cb636-7"><a aria-hidden="true" href="#cb636-7" tabindex="-1"></a><span class="co"> * - Catcache entries</span></span>
<span id="cb636-8"><a aria-hidden="true" href="#cb636-8" tabindex="-1"></a><span class="co"> * - Plancache entries</span></span>
<span id="cb636-9"><a aria-hidden="true" href="#cb636-9" tabindex="-1"></a><span class="co"> * - Files</span></span>
<span id="cb636-10"><a aria-hidden="true" href="#cb636-10" tabindex="-1"></a><span class="co"> * - Many more</span></span>
<span id="cb636-11"><a aria-hidden="true" href="#cb636-11" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb636-12"><a aria-hidden="true" href="#cb636-12" tabindex="-1"></a></span>
<span id="cb636-13"><a aria-hidden="true" href="#cb636-13" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> ResourceOwnerData</span>
<span id="cb636-14"><a aria-hidden="true" href="#cb636-14" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb636-15"><a aria-hidden="true" href="#cb636-15" tabindex="-1"></a>    ResourceOwner parent<span class="op">;</span>      <span class="co">/* Parent owner */</span></span>
<span id="cb636-16"><a aria-hidden="true" href="#cb636-16" tabindex="-1"></a>    ResourceOwner firstchild<span class="op">;</span>  <span class="co">/* First child */</span></span>
<span id="cb636-17"><a aria-hidden="true" href="#cb636-17" tabindex="-1"></a>    <span class="co">/* Arrays of resources */</span></span>
<span id="cb636-18"><a aria-hidden="true" href="#cb636-18" tabindex="-1"></a>    Buffer     <span class="op">*</span>buffers<span class="op">;</span></span>
<span id="cb636-19"><a aria-hidden="true" href="#cb636-19" tabindex="-1"></a>    Relation   <span class="op">*</span>relations<span class="op">;</span></span>
<span id="cb636-20"><a aria-hidden="true" href="#cb636-20" tabindex="-1"></a>    <span class="co">/* ... */</span></span>
<span id="cb636-21"><a aria-hidden="true" href="#cb636-21" tabindex="-1"></a><span class="op">}</span> ResourceOwnerData<span class="op">;</span></span></code></pre></div>
<p><strong>Cleanup on Error:</strong></p>
<div class="sourceCode" id="cb637"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb637-1"><a aria-hidden="true" href="#cb637-1" tabindex="-1"></a><span class="co">/* When ERROR occurs:</span></span>
<span id="cb637-2"><a aria-hidden="true" href="#cb637-2" tabindex="-1"></a><span class="co"> * 1. Longjmp to error handler</span></span>
<span id="cb637-3"><a aria-hidden="true" href="#cb637-3" tabindex="-1"></a><span class="co"> * 2. Call ResourceOwnerRelease() for current owner</span></span>
<span id="cb637-4"><a aria-hidden="true" href="#cb637-4" tabindex="-1"></a><span class="co"> * 3. Automatically releases:</span></span>
<span id="cb637-5"><a aria-hidden="true" href="#cb637-5" tabindex="-1"></a><span class="co"> *    - Unpins all buffers</span></span>
<span id="cb637-6"><a aria-hidden="true" href="#cb637-6" tabindex="-1"></a><span class="co"> *    - Closes all relations</span></span>
<span id="cb637-7"><a aria-hidden="true" href="#cb637-7" tabindex="-1"></a><span class="co"> *    - Releases all locks</span></span>
<span id="cb637-8"><a aria-hidden="true" href="#cb637-8" tabindex="-1"></a><span class="co"> *    - Closes all files</span></span>
<span id="cb637-9"><a aria-hidden="true" href="#cb637-9" tabindex="-1"></a><span class="co"> * 4. Prevents resource leaks</span></span>
<span id="cb637-10"><a aria-hidden="true" href="#cb637-10" tabindex="-1"></a><span class="co"> */</span></span></code></pre></div>
<p><strong>Hierarchy Matches Contexts:</strong></p>
<pre><code>TopTransactionResourceOwner
    ‚îî‚îÄ CurrentResourceOwner (current subtransaction)
        ‚îî‚îÄ Portal resource owner</code></pre>
<h4 data-number="10.4.4.2" id="exception-handling-pattern"><span class="header-section-number">10.4.4.2</span> Exception Handling
Pattern</h4>
<p><strong>Modern PG_TRY Pattern:</strong></p>
<div class="sourceCode" id="cb639"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb639-1"><a aria-hidden="true" href="#cb639-1" tabindex="-1"></a>ResourceOwner oldowner <span class="op">=</span> CurrentResourceOwner<span class="op">;</span></span>
<span id="cb639-2"><a aria-hidden="true" href="#cb639-2" tabindex="-1"></a></span>
<span id="cb639-3"><a aria-hidden="true" href="#cb639-3" tabindex="-1"></a>PG_TRY<span class="op">();</span></span>
<span id="cb639-4"><a aria-hidden="true" href="#cb639-4" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb639-5"><a aria-hidden="true" href="#cb639-5" tabindex="-1"></a>    <span class="co">/* Create new resource owner for this operation */</span></span>
<span id="cb639-6"><a aria-hidden="true" href="#cb639-6" tabindex="-1"></a>    CurrentResourceOwner <span class="op">=</span> ResourceOwnerCreate<span class="op">(</span>oldowner<span class="op">,</span> <span class="st">"operation"</span><span class="op">);</span></span>
<span id="cb639-7"><a aria-hidden="true" href="#cb639-7" tabindex="-1"></a></span>
<span id="cb639-8"><a aria-hidden="true" href="#cb639-8" tabindex="-1"></a>    <span class="co">/* Do dangerous operation */</span></span>
<span id="cb639-9"><a aria-hidden="true" href="#cb639-9" tabindex="-1"></a>    dangerous_function<span class="op">();</span></span>
<span id="cb639-10"><a aria-hidden="true" href="#cb639-10" tabindex="-1"></a></span>
<span id="cb639-11"><a aria-hidden="true" href="#cb639-11" tabindex="-1"></a>    <span class="co">/* Commit resources */</span></span>
<span id="cb639-12"><a aria-hidden="true" href="#cb639-12" tabindex="-1"></a>    ResourceOwnerRelease<span class="op">(</span>CurrentResourceOwner<span class="op">,</span></span>
<span id="cb639-13"><a aria-hidden="true" href="#cb639-13" tabindex="-1"></a>                        RESOURCE_RELEASE_BEFORE_LOCKS<span class="op">,</span></span>
<span id="cb639-14"><a aria-hidden="true" href="#cb639-14" tabindex="-1"></a>                        <span class="kw">true</span><span class="op">,</span> <span class="kw">true</span><span class="op">);</span></span>
<span id="cb639-15"><a aria-hidden="true" href="#cb639-15" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb639-16"><a aria-hidden="true" href="#cb639-16" tabindex="-1"></a>PG_CATCH<span class="op">();</span></span>
<span id="cb639-17"><a aria-hidden="true" href="#cb639-17" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb639-18"><a aria-hidden="true" href="#cb639-18" tabindex="-1"></a>    <span class="co">/* Error occurred - rollback resources */</span></span>
<span id="cb639-19"><a aria-hidden="true" href="#cb639-19" tabindex="-1"></a>    ResourceOwnerRelease<span class="op">(</span>CurrentResourceOwner<span class="op">,</span></span>
<span id="cb639-20"><a aria-hidden="true" href="#cb639-20" tabindex="-1"></a>                        RESOURCE_RELEASE_ABORT<span class="op">,</span></span>
<span id="cb639-21"><a aria-hidden="true" href="#cb639-21" tabindex="-1"></a>                        <span class="kw">true</span><span class="op">,</span> <span class="kw">true</span><span class="op">);</span></span>
<span id="cb639-22"><a aria-hidden="true" href="#cb639-22" tabindex="-1"></a></span>
<span id="cb639-23"><a aria-hidden="true" href="#cb639-23" tabindex="-1"></a>    CurrentResourceOwner <span class="op">=</span> oldowner<span class="op">;</span></span>
<span id="cb639-24"><a aria-hidden="true" href="#cb639-24" tabindex="-1"></a>    PG_RE_THROW<span class="op">();</span></span>
<span id="cb639-25"><a aria-hidden="true" href="#cb639-25" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb639-26"><a aria-hidden="true" href="#cb639-26" tabindex="-1"></a>PG_END_TRY<span class="op">();</span></span>
<span id="cb639-27"><a aria-hidden="true" href="#cb639-27" tabindex="-1"></a></span>
<span id="cb639-28"><a aria-hidden="true" href="#cb639-28" tabindex="-1"></a>CurrentResourceOwner <span class="op">=</span> oldowner<span class="op">;</span></span></code></pre></div>
<p><strong>Why This Works:</strong> - Resources automatically cleaned up
- No leaks even in complex error scenarios - Composable (nested PG_TRY
blocks)</p>
<hr/>
<h2 data-number="10.5" id="part-3-performance-journey"><span class="header-section-number">10.5</span> Part 3: Performance
Journey</h2>
<h3 data-number="10.5.1" id="query-optimizer-improvements-over-time"><span class="header-section-number">10.5.1</span> Query Optimizer Improvements
Over Time</h3>
<h4 data-number="10.5.1.1" id="x-7.x-foundation"><span class="header-section-number">10.5.1.1</span> 6.x-7.x: Foundation</h4>
<p><strong>Cost-Based Optimization Established:</strong></p>
<div class="sourceCode" id="cb640"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb640-1"><a aria-hidden="true" href="#cb640-1" tabindex="-1"></a><span class="co">/* src/backend/optimizer/path/costsize.c</span></span>
<span id="cb640-2"><a aria-hidden="true" href="#cb640-2" tabindex="-1"></a><span class="co"> * Cost model estimates I/O and CPU costs */</span></span>
<span id="cb640-3"><a aria-hidden="true" href="#cb640-3" tabindex="-1"></a></span>
<span id="cb640-4"><a aria-hidden="true" href="#cb640-4" tabindex="-1"></a>Cost cost_seqscan<span class="op">(</span>num_pages<span class="op">,</span> num_tuples<span class="op">)</span> <span class="op">{</span></span>
<span id="cb640-5"><a aria-hidden="true" href="#cb640-5" tabindex="-1"></a>    <span class="cf">return</span> seq_page_cost <span class="op">*</span> num_pages <span class="op">+</span></span>
<span id="cb640-6"><a aria-hidden="true" href="#cb640-6" tabindex="-1"></a>           cpu_tuple_cost <span class="op">*</span> num_tuples<span class="op">;</span></span>
<span id="cb640-7"><a aria-hidden="true" href="#cb640-7" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb640-8"><a aria-hidden="true" href="#cb640-8" tabindex="-1"></a></span>
<span id="cb640-9"><a aria-hidden="true" href="#cb640-9" tabindex="-1"></a>Cost cost_index<span class="op">(</span>num_index_pages<span class="op">,</span> num_tuples<span class="op">,</span> selectivity<span class="op">)</span> <span class="op">{</span></span>
<span id="cb640-10"><a aria-hidden="true" href="#cb640-10" tabindex="-1"></a>    <span class="cf">return</span> random_page_cost <span class="op">*</span> num_index_pages <span class="op">+</span></span>
<span id="cb640-11"><a aria-hidden="true" href="#cb640-11" tabindex="-1"></a>           cpu_tuple_cost <span class="op">*</span> num_tuples <span class="op">*</span> selectivity<span class="op">;</span></span>
<span id="cb640-12"><a aria-hidden="true" href="#cb640-12" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>Join Strategies:</strong> - Nested Loop - Merge Join - Hash
Join (added 7.1)</p>
<p><strong>Limitations:</strong> - Poor multi-table join ordering - No
sophisticated statistics - Limited index usage</p>
<h4 data-number="10.5.1.2" id="x-statistics-and-multi-column-indexes"><span class="header-section-number">10.5.1.2</span> 8.x: Statistics and
Multi-Column Indexes</h4>
<p><strong>ANALYZE Improvements:</strong></p>
<div class="sourceCode" id="cb641"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb641-1"><a aria-hidden="true" href="#cb641-1" tabindex="-1"></a><span class="co">-- 8.x introduces better statistics collection</span></span>
<span id="cb641-2"><a aria-hidden="true" href="#cb641-2" tabindex="-1"></a><span class="kw">ANALYZE</span> table_name;</span>
<span id="cb641-3"><a aria-hidden="true" href="#cb641-3" tabindex="-1"></a></span>
<span id="cb641-4"><a aria-hidden="true" href="#cb641-4" tabindex="-1"></a><span class="co">-- Stores in pg_statistics:</span></span>
<span id="cb641-5"><a aria-hidden="true" href="#cb641-5" tabindex="-1"></a><span class="co">-- - Most common values (MCV)</span></span>
<span id="cb641-6"><a aria-hidden="true" href="#cb641-6" tabindex="-1"></a><span class="co">-- - Histogram of value distribution</span></span>
<span id="cb641-7"><a aria-hidden="true" href="#cb641-7" tabindex="-1"></a><span class="co">-- - Null fraction</span></span>
<span id="cb641-8"><a aria-hidden="true" href="#cb641-8" tabindex="-1"></a><span class="co">-- - Average width</span></span></code></pre></div>
<p><strong>Multi-Column Indexes:</strong></p>
<div class="sourceCode" id="cb642"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb642-1"><a aria-hidden="true" href="#cb642-1" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_user_region_age <span class="kw">ON</span> users(region, age);</span>
<span id="cb642-2"><a aria-hidden="true" href="#cb642-2" tabindex="-1"></a></span>
<span id="cb642-3"><a aria-hidden="true" href="#cb642-3" tabindex="-1"></a><span class="co">-- 8.4+ can use index for:</span></span>
<span id="cb642-4"><a aria-hidden="true" href="#cb642-4" tabindex="-1"></a><span class="co">-- WHERE region = 'US' AND age &gt; 25</span></span>
<span id="cb642-5"><a aria-hidden="true" href="#cb642-5" tabindex="-1"></a><span class="co">-- And partially for:</span></span>
<span id="cb642-6"><a aria-hidden="true" href="#cb642-6" tabindex="-1"></a><span class="co">-- WHERE region = 'US'  (uses first column)</span></span></code></pre></div>
<p><strong>Bitmap Scans (8.1):</strong></p>
<div class="sourceCode" id="cb643"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb643-1"><a aria-hidden="true" href="#cb643-1" tabindex="-1"></a><span class="co">-- Multiple indexes combined!</span></span>
<span id="cb643-2"><a aria-hidden="true" href="#cb643-2" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_region <span class="kw">ON</span> sales(region);</span>
<span id="cb643-3"><a aria-hidden="true" href="#cb643-3" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_amount <span class="kw">ON</span> sales(amount);</span>
<span id="cb643-4"><a aria-hidden="true" href="#cb643-4" tabindex="-1"></a></span>
<span id="cb643-5"><a aria-hidden="true" href="#cb643-5" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> sales</span>
<span id="cb643-6"><a aria-hidden="true" href="#cb643-6" tabindex="-1"></a><span class="kw">WHERE</span> region <span class="op">=</span> <span class="st">'US'</span> <span class="kw">AND</span> amount <span class="op">&gt;</span> <span class="dv">1000</span>;</span>
<span id="cb643-7"><a aria-hidden="true" href="#cb643-7" tabindex="-1"></a></span>
<span id="cb643-8"><a aria-hidden="true" href="#cb643-8" tabindex="-1"></a><span class="co">-- Plan: Bitmap Heap Scan</span></span>
<span id="cb643-9"><a aria-hidden="true" href="#cb643-9" tabindex="-1"></a><span class="co">--   Recheck Cond: (region = 'US') AND (amount &gt; 1000)</span></span>
<span id="cb643-10"><a aria-hidden="true" href="#cb643-10" tabindex="-1"></a><span class="co">--   -&gt; BitmapAnd</span></span>
<span id="cb643-11"><a aria-hidden="true" href="#cb643-11" tabindex="-1"></a><span class="co">--      -&gt; Bitmap Index Scan on idx_region</span></span>
<span id="cb643-12"><a aria-hidden="true" href="#cb643-12" tabindex="-1"></a><span class="co">--      -&gt; Bitmap Index Scan on idx_amount</span></span></code></pre></div>
<h4 data-number="10.5.1.3" id="x-index-only-scans-and-extended-statistics"><span class="header-section-number">10.5.1.3</span> 9.x: Index-Only Scans and
Extended Statistics</h4>
<p><strong>Index-Only Scans (9.2):</strong> Covered earlier - massive
improvement.</p>
<p><strong>Performance Impact Example:</strong></p>
<div class="sourceCode" id="cb644"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb644-1"><a aria-hidden="true" href="#cb644-1" tabindex="-1"></a><span class="co">-- Before 9.2:</span></span>
<span id="cb644-2"><a aria-hidden="true" href="#cb644-2" tabindex="-1"></a><span class="kw">EXPLAIN</span> <span class="kw">SELECT</span> email <span class="kw">FROM</span> users <span class="kw">WHERE</span> email <span class="kw">LIKE</span> <span class="st">'admin%'</span>;</span>
<span id="cb644-3"><a aria-hidden="true" href="#cb644-3" tabindex="-1"></a><span class="co">-- Index Scan on idx_email</span></span>
<span id="cb644-4"><a aria-hidden="true" href="#cb644-4" tabindex="-1"></a><span class="co">--   -&gt; Heap Fetches: 1000  (expensive!)</span></span>
<span id="cb644-5"><a aria-hidden="true" href="#cb644-5" tabindex="-1"></a></span>
<span id="cb644-6"><a aria-hidden="true" href="#cb644-6" tabindex="-1"></a><span class="co">-- After 9.2 (with visibility map):</span></span>
<span id="cb644-7"><a aria-hidden="true" href="#cb644-7" tabindex="-1"></a><span class="kw">EXPLAIN</span> <span class="kw">SELECT</span> email <span class="kw">FROM</span> users <span class="kw">WHERE</span> email <span class="kw">LIKE</span> <span class="st">'admin%'</span>;</span>
<span id="cb644-8"><a aria-hidden="true" href="#cb644-8" tabindex="-1"></a><span class="co">-- Index Only Scan on idx_email</span></span>
<span id="cb644-9"><a aria-hidden="true" href="#cb644-9" tabindex="-1"></a><span class="co">--   Heap Fetches: 0  (all from index!)</span></span></code></pre></div>
<p><strong>Extended Statistics (10+):</strong></p>
<div class="sourceCode" id="cb645"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb645-1"><a aria-hidden="true" href="#cb645-1" tabindex="-1"></a><span class="co">-- Handle correlated columns</span></span>
<span id="cb645-2"><a aria-hidden="true" href="#cb645-2" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">STATISTICS</span> city_zip_stats (dependencies)</span>
<span id="cb645-3"><a aria-hidden="true" href="#cb645-3" tabindex="-1"></a><span class="kw">ON</span> city, zipcode <span class="kw">FROM</span> addresses;</span>
<span id="cb645-4"><a aria-hidden="true" href="#cb645-4" tabindex="-1"></a></span>
<span id="cb645-5"><a aria-hidden="true" href="#cb645-5" tabindex="-1"></a><span class="kw">ANALYZE</span> addresses;</span>
<span id="cb645-6"><a aria-hidden="true" href="#cb645-6" tabindex="-1"></a></span>
<span id="cb645-7"><a aria-hidden="true" href="#cb645-7" tabindex="-1"></a><span class="co">-- Optimizer now knows city and zipcode are correlated</span></span>
<span id="cb645-8"><a aria-hidden="true" href="#cb645-8" tabindex="-1"></a><span class="co">-- Better estimates for queries like:</span></span>
<span id="cb645-9"><a aria-hidden="true" href="#cb645-9" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> addresses</span>
<span id="cb645-10"><a aria-hidden="true" href="#cb645-10" tabindex="-1"></a><span class="kw">WHERE</span> city <span class="op">=</span> <span class="st">'New York'</span> <span class="kw">AND</span> zipcode <span class="op">=</span> <span class="st">'10001'</span>;</span></code></pre></div>
<h4 data-number="10.5.1.4" id="partition-pruning-and-jit"><span class="header-section-number">10.5.1.4</span> 10-12: Partition Pruning
and JIT</h4>
<p><strong>Partition Pruning (11):</strong></p>
<div class="sourceCode" id="cb646"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb646-1"><a aria-hidden="true" href="#cb646-1" tabindex="-1"></a><span class="co">-- Table with 100 partitions (by date)</span></span>
<span id="cb646-2"><a aria-hidden="true" href="#cb646-2" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> measurements</span>
<span id="cb646-3"><a aria-hidden="true" href="#cb646-3" tabindex="-1"></a><span class="kw">WHERE</span> logdate <span class="op">=</span> <span class="st">'2024-11-15'</span>;</span>
<span id="cb646-4"><a aria-hidden="true" href="#cb646-4" tabindex="-1"></a></span>
<span id="cb646-5"><a aria-hidden="true" href="#cb646-5" tabindex="-1"></a><span class="co">-- Old: Scans all 100 partitions</span></span>
<span id="cb646-6"><a aria-hidden="true" href="#cb646-6" tabindex="-1"></a><span class="co">-- 11+: Scans only partition for 2024-11-15</span></span>
<span id="cb646-7"><a aria-hidden="true" href="#cb646-7" tabindex="-1"></a><span class="co">-- Result: 100x faster!</span></span></code></pre></div>
<p><strong>JIT Compilation (11):</strong></p>
<div class="sourceCode" id="cb647"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb647-1"><a aria-hidden="true" href="#cb647-1" tabindex="-1"></a><span class="kw">SET</span> jit <span class="op">=</span> <span class="kw">on</span>;</span>
<span id="cb647-2"><a aria-hidden="true" href="#cb647-2" tabindex="-1"></a></span>
<span id="cb647-3"><a aria-hidden="true" href="#cb647-3" tabindex="-1"></a><span class="co">-- Complex expression in WHERE:</span></span>
<span id="cb647-4"><a aria-hidden="true" href="#cb647-4" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> big_table</span>
<span id="cb647-5"><a aria-hidden="true" href="#cb647-5" tabindex="-1"></a><span class="kw">WHERE</span> (col1 <span class="op">*</span> <span class="fl">1.5</span> <span class="op">+</span> col2 <span class="op">/</span> <span class="fl">3.2</span>) <span class="op">&gt;</span> col3 <span class="kw">AND</span></span>
<span id="cb647-6"><a aria-hidden="true" href="#cb647-6" tabindex="-1"></a>      <span class="fu">sqrt</span>(col4) <span class="op">&lt;</span> <span class="fu">log</span>(col5 <span class="op">+</span> <span class="dv">1</span>);</span>
<span id="cb647-7"><a aria-hidden="true" href="#cb647-7" tabindex="-1"></a></span>
<span id="cb647-8"><a aria-hidden="true" href="#cb647-8" tabindex="-1"></a><span class="co">-- Without JIT: Interpreted evaluation ~1000 cycles/tuple</span></span>
<span id="cb647-9"><a aria-hidden="true" href="#cb647-9" tabindex="-1"></a><span class="co">-- With JIT: Compiled evaluation ~100 cycles/tuple</span></span>
<span id="cb647-10"><a aria-hidden="true" href="#cb647-10" tabindex="-1"></a><span class="co">-- On 100M row table: 10x faster!</span></span></code></pre></div>
<h4 data-number="10.5.1.5" id="incremental-sorting-and-memoization"><span class="header-section-number">10.5.1.5</span> 13-17: Incremental Sorting
and Memoization</h4>
<p><strong>Incremental Sort (13):</strong> Already covered - clever
optimization for partial order.</p>
<p><strong>Memoization (14):</strong></p>
<div class="sourceCode" id="cb648"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb648-1"><a aria-hidden="true" href="#cb648-1" tabindex="-1"></a><span class="co">-- Nested loop with expensive inner function</span></span>
<span id="cb648-2"><a aria-hidden="true" href="#cb648-2" tabindex="-1"></a><span class="kw">SELECT</span> o.<span class="op">*</span>, get_customer_details(o.customer_id)</span>
<span id="cb648-3"><a aria-hidden="true" href="#cb648-3" tabindex="-1"></a><span class="kw">FROM</span> orders o;</span>
<span id="cb648-4"><a aria-hidden="true" href="#cb648-4" tabindex="-1"></a></span>
<span id="cb648-5"><a aria-hidden="true" href="#cb648-5" tabindex="-1"></a><span class="co">-- Without memoization: Call function for every row</span></span>
<span id="cb648-6"><a aria-hidden="true" href="#cb648-6" tabindex="-1"></a><span class="co">-- With memoization: Cache results, reuse for same customer_id</span></span>
<span id="cb648-7"><a aria-hidden="true" href="#cb648-7" tabindex="-1"></a><span class="co">-- If 1000 orders, 100 customers: 10x fewer function calls</span></span></code></pre></div>
<p><strong>Modern Optimizer (17):</strong> - Considers 50+ execution
strategies - Evaluates hundreds of plans for complex queries - Uses
parallel execution when beneficial - Prunes partitions intelligently -
Uses indexes optimally - Considers JIT compilation cost</p>
<p><strong>Configuration Parameters (Evolution):</strong></p>
<pre><code># 6.x had ~5 optimizer settings
# 17 has ~30+ optimizer settings

effective_cache_size = 8GB      # Helps index vs seq scan choice
random_page_cost = 1.1          # SSD era (was 4.0 for HDDs)
cpu_tuple_cost = 0.01
jit_above_cost = 100000
enable_partitionwise_join = on</code></pre>
<hr/>
<h3 data-number="10.5.2" id="lock-contention-reduction"><span class="header-section-number">10.5.2</span> Lock Contention
Reduction</h3>
<h4 data-number="10.5.2.1" id="the-evolution-of-locking-efficiency"><span class="header-section-number">10.5.2.1</span> The Evolution of Locking
Efficiency</h4>
<p><strong>6.x-7.x: Basic Locking</strong> - Heavyweight locks for
everything - High contention on lock manager structures - Single lock
manager hash table</p>
<p><strong>8.x: Lock Manager Partitions</strong></p>
<div class="sourceCode" id="cb650"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb650-1"><a aria-hidden="true" href="#cb650-1" tabindex="-1"></a><span class="co">/* src/backend/storage/lmgr/lock.c</span></span>
<span id="cb650-2"><a aria-hidden="true" href="#cb650-2" tabindex="-1"></a><span class="co"> * Partition lock hash table to reduce contention */</span></span>
<span id="cb650-3"><a aria-hidden="true" href="#cb650-3" tabindex="-1"></a></span>
<span id="cb650-4"><a aria-hidden="true" href="#cb650-4" tabindex="-1"></a><span class="pp">#define LOG2_NUM_LOCK_PARTITIONS  </span><span class="dv">4</span></span>
<span id="cb650-5"><a aria-hidden="true" href="#cb650-5" tabindex="-1"></a><span class="pp">#define NUM_LOCK_PARTITIONS  </span><span class="op">(</span><span class="dv">1</span><span class="pp"> </span><span class="op">&lt;&lt;</span><span class="pp"> </span>LOG2_NUM_LOCK_PARTITIONS<span class="op">)</span><span class="pp">  </span><span class="co">/* 16 */</span></span>
<span id="cb650-6"><a aria-hidden="true" href="#cb650-6" tabindex="-1"></a></span>
<span id="cb650-7"><a aria-hidden="true" href="#cb650-7" tabindex="-1"></a><span class="co">/* Each partition has separate LWLock</span></span>
<span id="cb650-8"><a aria-hidden="true" href="#cb650-8" tabindex="-1"></a><span class="co"> * 16x less contention! */</span></span></code></pre></div>
<p><strong>9.2: Fast Path Locking</strong></p>
<div class="sourceCode" id="cb651"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb651-1"><a aria-hidden="true" href="#cb651-1" tabindex="-1"></a><span class="co">/* src/backend/storage/lmgr/README</span></span>
<span id="cb651-2"><a aria-hidden="true" href="#cb651-2" tabindex="-1"></a><span class="co"> * Fast path for common case: AccessShareLock on relations */</span></span>
<span id="cb651-3"><a aria-hidden="true" href="#cb651-3" tabindex="-1"></a></span>
<span id="cb651-4"><a aria-hidden="true" href="#cb651-4" tabindex="-1"></a><span class="co">/* Per-backend fast-path lock array</span></span>
<span id="cb651-5"><a aria-hidden="true" href="#cb651-5" tabindex="-1"></a><span class="co"> * No shared memory access for common locks!</span></span>
<span id="cb651-6"><a aria-hidden="true" href="#cb651-6" tabindex="-1"></a><span class="co"> *</span></span>
<span id="cb651-7"><a aria-hidden="true" href="#cb651-7" tabindex="-1"></a><span class="co"> * Conditions:</span></span>
<span id="cb651-8"><a aria-hidden="true" href="#cb651-8" tabindex="-1"></a><span class="co"> * 1. AccessShareLock, RowShareLock, or RowExclusiveLock</span></span>
<span id="cb651-9"><a aria-hidden="true" href="#cb651-9" tabindex="-1"></a><span class="co"> * 2. Database relation (not shared)</span></span>
<span id="cb651-10"><a aria-hidden="true" href="#cb651-10" tabindex="-1"></a><span class="co"> * 3. No conflicting locks possible</span></span>
<span id="cb651-11"><a aria-hidden="true" href="#cb651-11" tabindex="-1"></a><span class="co"> *</span></span>
<span id="cb651-12"><a aria-hidden="true" href="#cb651-12" tabindex="-1"></a><span class="co"> * Result: ~10x faster lock acquisition</span></span>
<span id="cb651-13"><a aria-hidden="true" href="#cb651-13" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb651-14"><a aria-hidden="true" href="#cb651-14" tabindex="-1"></a></span>
<span id="cb651-15"><a aria-hidden="true" href="#cb651-15" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> PGPROC</span>
<span id="cb651-16"><a aria-hidden="true" href="#cb651-16" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb651-17"><a aria-hidden="true" href="#cb651-17" tabindex="-1"></a>    <span class="co">/* ... */</span></span>
<span id="cb651-18"><a aria-hidden="true" href="#cb651-18" tabindex="-1"></a>    LWLock      fpInfoLock<span class="op">;</span>  <span class="co">/* Protects per-backend lock info */</span></span>
<span id="cb651-19"><a aria-hidden="true" href="#cb651-19" tabindex="-1"></a>    uint64      fpLockBits<span class="op">;</span>  <span class="co">/* Bitmap of held locks */</span></span>
<span id="cb651-20"><a aria-hidden="true" href="#cb651-20" tabindex="-1"></a>    Oid         fpRelId<span class="op">[</span>FP_LOCK_SLOTS_PER_BACKEND<span class="op">];</span>  <span class="co">/* 16 slots */</span></span>
<span id="cb651-21"><a aria-hidden="true" href="#cb651-21" tabindex="-1"></a>    <span class="co">/* ... */</span></span>
<span id="cb651-22"><a aria-hidden="true" href="#cb651-22" tabindex="-1"></a><span class="op">}</span> PGPROC<span class="op">;</span></span></code></pre></div>
<p><strong>Performance Impact:</strong></p>
<div class="sourceCode" id="cb652"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb652-1"><a aria-hidden="true" href="#cb652-1" tabindex="-1"></a><span class="co">-- Simple SELECT (acquires AccessShareLock):</span></span>
<span id="cb652-2"><a aria-hidden="true" href="#cb652-2" tabindex="-1"></a><span class="co">-- Before 9.2: Shared lock hash table access</span></span>
<span id="cb652-3"><a aria-hidden="true" href="#cb652-3" tabindex="-1"></a><span class="co">-- After 9.2: Per-backend array (no shared memory!)</span></span>
<span id="cb652-4"><a aria-hidden="true" href="#cb652-4" tabindex="-1"></a><span class="co">-- Result: 10,000+ locks/sec/core ‚Üí 100,000+ locks/sec/core</span></span></code></pre></div>
<p><strong>13+: Atomic Operations in Buffer Manager</strong></p>
<p>Already covered - buffer pin/unpin without locks.</p>
<p><strong>Modern Locking (17):</strong> - Fast-path for ~95% of locks -
Partitioned hash table for remaining 5% - Atomic operations where
possible - Deadlock detection optimized - Group locking for parallel
queries</p>
<p><strong>Performance Numbers:</strong> - <strong>6.x</strong>: ~1,000
transactions/sec (single core, simple queries) - <strong>9.2</strong>:
~10,000 transactions/sec (fast-path locking) - <strong>13</strong>:
~50,000 transactions/sec (atomic bufmgr) - <strong>17</strong>:
~100,000+ transactions/sec (cumulative optimizations)</p>
<p>(Numbers approximate, vary by workload and hardware)</p>
<hr/>
<h3 data-number="10.5.3" id="parallel-execution-introduction"><span class="header-section-number">10.5.3</span> Parallel Execution
Introduction</h3>
<p>Covered extensively in ‚ÄúParallel Query Evolution‚Äù section.</p>
<p><strong>Key Performance Milestones:</strong> - <strong>9.6</strong>:
2-4x speedup for large table scans - <strong>10</strong>: 2-4x speedup
for aggregations - <strong>11</strong>: 5-10x speedup for partition-wise
operations - <strong>16</strong>: Most operations parallelized,
near-linear scaling</p>
<hr/>
<h3 data-number="10.5.4" id="io-and-storage-optimizations"><span class="header-section-number">10.5.4</span> I/O and Storage
Optimizations</h3>
<h4 data-number="10.5.4.1" id="write-ahead-log-wal-optimization"><span class="header-section-number">10.5.4.1</span> Write-Ahead Log (WAL)
Optimization</h4>
<p><strong>7.0: WAL Introduced</strong> - Crash recovery - Foundation
for replication</p>
<p><strong>8.x: WAL Improvements</strong></p>
<div class="sourceCode" id="cb653"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb653-1"><a aria-hidden="true" href="#cb653-1" tabindex="-1"></a><span class="co">/* Full-page writes after checkpoint</span></span>
<span id="cb653-2"><a aria-hidden="true" href="#cb653-2" tabindex="-1"></a><span class="co"> * Prevents torn pages on crash */</span></span>
<span id="cb653-3"><a aria-hidden="true" href="#cb653-3" tabindex="-1"></a>full_page_writes <span class="op">=</span> on<span class="op">;</span></span>
<span id="cb653-4"><a aria-hidden="true" href="#cb653-4" tabindex="-1"></a></span>
<span id="cb653-5"><a aria-hidden="true" href="#cb653-5" tabindex="-1"></a><span class="co">/* WAL segments 16MB each</span></span>
<span id="cb653-6"><a aria-hidden="true" href="#cb653-6" tabindex="-1"></a><span class="co"> * Pre-allocated for performance */</span></span></code></pre></div>
<p><strong>9.x: WAL Compression</strong></p>
<div class="sourceCode" id="cb654"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb654-1"><a aria-hidden="true" href="#cb654-1" tabindex="-1"></a><span class="co">/* 9.5+ can compress full-page images */</span></span>
<span id="cb654-2"><a aria-hidden="true" href="#cb654-2" tabindex="-1"></a>wal_compression <span class="op">=</span> on<span class="op">;</span></span>
<span id="cb654-3"><a aria-hidden="true" href="#cb654-3" tabindex="-1"></a></span>
<span id="cb654-4"><a aria-hidden="true" href="#cb654-4" tabindex="-1"></a><span class="co">/* Reduces WAL volume 2-5x for update-heavy workloads */</span></span></code></pre></div>
<p><strong>13+: WAL Record Changes</strong></p>
<div class="sourceCode" id="cb655"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb655-1"><a aria-hidden="true" href="#cb655-1" tabindex="-1"></a><span class="co">/* Reduce WAL size for common operations</span></span>
<span id="cb655-2"><a aria-hidden="true" href="#cb655-2" tabindex="-1"></a><span class="co"> * Better compression</span></span>
<span id="cb655-3"><a aria-hidden="true" href="#cb655-3" tabindex="-1"></a><span class="co"> * Faster replication */</span></span></code></pre></div>
<p><strong>Modern WAL (17):</strong></p>
<pre><code>wal_level = replica                # Amount of info in WAL
max_wal_size = 1GB                 # Checkpoint distance
wal_compression = on               # Compress full-page writes
wal_buffers = 16MB                 # WAL buffer cache
checkpoint_completion_target = 0.9 # Spread checkpoints</code></pre>
<h4 data-number="10.5.4.2" id="toast-the-oversized-attribute-storage-technique"><span class="header-section-number">10.5.4.2</span> TOAST (The
Oversized-Attribute Storage Technique)</h4>
<p><strong>Purpose</strong>: Store large values out-of-line.</p>
<p><strong>7.1: TOAST Introduced</strong></p>
<div class="sourceCode" id="cb657"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb657-1"><a aria-hidden="true" href="#cb657-1" tabindex="-1"></a><span class="co">/* Values &gt;2KB stored in separate TOAST table</span></span>
<span id="cb657-2"><a aria-hidden="true" href="#cb657-2" tabindex="-1"></a><span class="co"> * Main tuple stores pointer */</span></span></code></pre></div>
<p><strong>8.3: TOAST Slicing</strong></p>
<div class="sourceCode" id="cb658"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb658-1"><a aria-hidden="true" href="#cb658-1" tabindex="-1"></a><span class="co">/* Can retrieve slices of large values</span></span>
<span id="cb658-2"><a aria-hidden="true" href="#cb658-2" tabindex="-1"></a><span class="co"> * Don't need to fetch entire 1GB text field</span></span>
<span id="cb658-3"><a aria-hidden="true" href="#cb658-3" tabindex="-1"></a><span class="co"> * if you only want substring(val, 1, 100) */</span></span></code></pre></div>
<p><strong>Modern TOAST (17):</strong></p>
<div class="sourceCode" id="cb659"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb659-1"><a aria-hidden="true" href="#cb659-1" tabindex="-1"></a><span class="co">-- Four compression strategies:</span></span>
<span id="cb659-2"><a aria-hidden="true" href="#cb659-2" tabindex="-1"></a><span class="co">-- PLAIN: No compression, no out-of-line</span></span>
<span id="cb659-3"><a aria-hidden="true" href="#cb659-3" tabindex="-1"></a><span class="co">-- EXTENDED: Compress, move out-of-line (default)</span></span>
<span id="cb659-4"><a aria-hidden="true" href="#cb659-4" tabindex="-1"></a><span class="co">-- EXTERNAL: No compression, move out-of-line</span></span>
<span id="cb659-5"><a aria-hidden="true" href="#cb659-5" tabindex="-1"></a><span class="co">-- MAIN: Compress, avoid out-of-line</span></span>
<span id="cb659-6"><a aria-hidden="true" href="#cb659-6" tabindex="-1"></a></span>
<span id="cb659-7"><a aria-hidden="true" href="#cb659-7" tabindex="-1"></a><span class="kw">ALTER</span> <span class="kw">TABLE</span> documents</span>
<span id="cb659-8"><a aria-hidden="true" href="#cb659-8" tabindex="-1"></a><span class="kw">ALTER</span> <span class="kw">COLUMN</span> content <span class="kw">SET</span> <span class="kw">STORAGE</span> EXTERNAL;</span></code></pre></div>
<h4 data-number="10.5.4.3" id="visibility-map-and-free-space-map"><span class="header-section-number">10.5.4.3</span> Visibility Map and Free
Space Map</h4>
<p><strong>8.4: Visibility Map Introduced</strong></p>
<div class="sourceCode" id="cb660"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb660-1"><a aria-hidden="true" href="#cb660-1" tabindex="-1"></a><span class="co">/* Bitmap: one bit per page</span></span>
<span id="cb660-2"><a aria-hidden="true" href="#cb660-2" tabindex="-1"></a><span class="co"> * Set if all tuples on page visible to all transactions</span></span>
<span id="cb660-3"><a aria-hidden="true" href="#cb660-3" tabindex="-1"></a><span class="co"> * Enables index-only scans</span></span>
<span id="cb660-4"><a aria-hidden="true" href="#cb660-4" tabindex="-1"></a><span class="co"> * Allows VACUUM to skip pages */</span></span></code></pre></div>
<p><strong>Performance Impact:</strong> - Index-only scans possible -
VACUUM 10-100x faster (skips all-visible pages)</p>
<p><strong>8.4: Free Space Map (FSM) Improved</strong></p>
<div class="sourceCode" id="cb661"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb661-1"><a aria-hidden="true" href="#cb661-1" tabindex="-1"></a><span class="co">/* Tracks free space per page</span></span>
<span id="cb661-2"><a aria-hidden="true" href="#cb661-2" tabindex="-1"></a><span class="co"> * Speeds up INSERT (finds page with space)</span></span>
<span id="cb661-3"><a aria-hidden="true" href="#cb661-3" tabindex="-1"></a><span class="co"> * Previously linear scan of table! */</span></span></code></pre></div>
<hr/>
<h3 data-number="10.5.5" id="hardware-adaptation"><span class="header-section-number">10.5.5</span> Hardware Adaptation</h3>
<h4 data-number="10.5.5.1" id="ssd-optimization"><span class="header-section-number">10.5.5.1</span> SSD Optimization</h4>
<p><strong>Traditional HDDs (pre-2010):</strong></p>
<pre><code>random_page_cost = 4.0   # Random I/O 4x slower than sequential</code></pre>
<p><strong>SSDs (2010+):</strong></p>
<pre><code>random_page_cost = 1.1   # Random I/O nearly as fast as sequential</code></pre>
<p><strong>Impact</strong>: Planner prefers index scans more often ‚Üí
better performance.</p>
<h4 data-number="10.5.5.2" id="multi-core-scaling"><span class="header-section-number">10.5.5.2</span> Multi-Core Scaling</h4>
<p><strong>6.x-9.5</strong>: One backend = one CPU core (for that
query)</p>
<p><strong>9.6+</strong>: One query can use multiple cores via parallel
workers</p>
<p><strong>Modern (17)</strong>: One query can use 8+ cores
efficiently</p>
<h4 data-number="10.5.5.3" id="numa-awareness"><span class="header-section-number">10.5.5.3</span> NUMA Awareness</h4>
<p><strong>13+</strong>: Better awareness of Non-Uniform Memory
Access</p>
<div class="sourceCode" id="cb664"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb664-1"><a aria-hidden="true" href="#cb664-1" tabindex="-1"></a><span class="co">/* Buffer allocation considers NUMA topology</span></span>
<span id="cb664-2"><a aria-hidden="true" href="#cb664-2" tabindex="-1"></a><span class="co"> * Reduces cross-socket memory access</span></span>
<span id="cb664-3"><a aria-hidden="true" href="#cb664-3" tabindex="-1"></a><span class="co"> * Improves performance on large multi-socket servers */</span></span></code></pre></div>
<hr/>
<h2 data-number="10.6" id="part-4-community-growth"><span class="header-section-number">10.6</span> Part 4: Community Growth</h2>
<h3 data-number="10.6.1" id="contributor-statistics-over-time"><span class="header-section-number">10.6.1</span> Contributor Statistics Over
Time</h3>
<h4 data-number="10.6.1.1" id="early-era-1996-2005"><span class="header-section-number">10.6.1.1</span> Early Era (1996-2005)</h4>
<p><strong>1996-2000 (Versions 6.x-7.0):</strong> - <strong>Core
contributors</strong>: ~10-15 - <strong>Geographic
distribution</strong>: USA (majority), Europe (growing) - <strong>Top
contributors</strong>: Bruce Momjian, Tom Lane, Jan Wieck, Vadim Mikheev
- <strong>Communication</strong>: Mailing lists (pgsql-hackers
established 1997) - <strong>Commits per year</strong>: ~500-1000</p>
<p><strong>2000-2005 (Versions 7.1-8.0):</strong> - <strong>Core
contributors</strong>: ~30-40 - <strong>New regions</strong>: Japan,
Australia - <strong>Companies</strong>: Red Hat, Command Prompt Inc. -
<strong>Commits per year</strong>: ~1500-2000 - <strong>Major
conferences</strong>: First PGCon (Ottawa, 2007 - planning started
earlier)</p>
<h4 data-number="10.6.1.2" id="growth-era-2005-2015"><span class="header-section-number">10.6.1.2</span> Growth Era
(2005-2015)</h4>
<p><strong>2005-2010 (Versions 8.1-9.0):</strong> - <strong>Active
contributors</strong>: ~100-150 - <strong>CommitFest system</strong>:
Established 2008 - <strong>Companies</strong>: EnterpriseDB,
2ndQuadrant, NTT, Fujitsu - <strong>Commits per year</strong>:
~2000-2500 - <strong>Conferences</strong>: PGCon, FOSDEM PGDay, PGConf
EU</p>
<p><strong>Key Milestone</strong>: 9.0 release (2010) with streaming
replication drove massive adoption.</p>
<p><strong>2010-2015 (Versions 9.1-9.5):</strong> - <strong>Active
contributors</strong>: ~200-250 - <strong>Geographic
distribution</strong>: Truly worldwide - North America: 30% - Europe:
40% - Asia: 20% - Other: 10% - <strong>Companies</strong>: AWS,
Microsoft, VMware, Citus Data - <strong>Commits per year</strong>:
~2500-3000 - <strong>Release cycle</strong>: Established annual major
release rhythm</p>
<h4 data-number="10.6.1.3" id="modern-era-2015-2025"><span class="header-section-number">10.6.1.3</span> Modern Era
(2015-2025)</h4>
<p><strong>2015-2020 (Versions 9.6-13):</strong> - <strong>Active
contributors</strong>: ~300-350 - <strong>CommitFests</strong>: 4-5 per
development cycle - <strong>Commits per year</strong>: ~3000-3500 -
<strong>Major features driven by</strong>: - Cloud providers (AWS RDS,
Azure, Google Cloud SQL) - Large users (Instagram, Apple, Uber, Netflix)
- Database companies (EnterpriseDB, Crunchy Data)</p>
<p><strong>2020-2025 (Versions 14-17):</strong> - <strong>Active
contributors</strong>: ~350-400 - <strong>Commits per year</strong>:
~3500-4000 - <strong>Geographic distribution</strong>: - Contributions
from 50+ countries - 24/7 development (global time zones) - Mailing list
discussions in all time zones</p>
<p><strong>Top Contributors (All-Time):</strong></p>
<p>Based on commit count and mailing list activity:</p>
<ol type="1">
<li><strong>Tom Lane</strong> - 15,000+ commits, 80,000+ mailing list
posts</li>
<li><strong>Bruce Momjian</strong> - 10,000+ commits, extensive
advocacy</li>
<li><strong>Alvaro Herrera</strong> - 5,000+ commits</li>
<li><strong>Peter Eisentraut</strong> - 4,000+ commits</li>
<li><strong>Robert Haas</strong> - 3,000+ commits</li>
<li><strong>Andres Freund</strong> - 2,000+ commits</li>
<li><strong>Michael Paquier</strong> - 2,000+ commits</li>
<li><strong>Thomas Munro</strong> - 1,500+ commits</li>
</ol>
<p><strong>Note</strong>: Commit count doesn‚Äôt tell full story - code
review, testing, documentation, and community support equally
valuable.</p>
<hr/>
<h3 data-number="10.6.2" id="corporate-participation-evolution"><span class="header-section-number">10.6.2</span> Corporate Participation
Evolution</h3>
<h4 data-number="10.6.2.1" id="independent-era-1996-2004"><span class="header-section-number">10.6.2.1</span> Independent Era
(1996-2004)</h4>
<p><strong>Characteristics:</strong> - University-based (Berkeley
heritage) - Individual contributors - Small consulting companies</p>
<p><strong>Companies:</strong> - Great Bridge (1999-2001) - Failed
attempt at commercial PostgreSQL - Red Hat (packaging, minimal
development)</p>
<h4 data-number="10.6.2.2" id="commercial-emergence-2004-2010"><span class="header-section-number">10.6.2.2</span> Commercial Emergence
(2004-2010)</h4>
<p><strong>EnterpriseDB (2004):</strong> - First major commercial
PostgreSQL company - Hired core contributors - Oracle compatibility
focus - Drove Windows port (8.0)</p>
<p><strong>Other Companies:</strong> - Command Prompt Inc.¬†(hosting,
support) - 2ndQuadrant (Postgres-XL, training) - NTT, Fujitsu (Japanese
market, features)</p>
<h4 data-number="10.6.2.3" id="cloud-era-2010-2020"><span class="header-section-number">10.6.2.3</span> Cloud Era (2010-2020)</h4>
<p><strong>AWS (Amazon RDS):</strong> - Launched RDS PostgreSQL 2010 -
Became largest PostgreSQL deployment - Aurora PostgreSQL (2017) -
proprietary storage layer - Contributed features (logical replication
improvements)</p>
<p><strong>Microsoft:</strong> - Azure Database for PostgreSQL (2017) -
Hyperscale (Citus) (2018, acquired Citus Data) - Windows support
improvements</p>
<p><strong>Google Cloud:</strong> - Cloud SQL PostgreSQL - AlloyDB
(2022) - PostgreSQL-compatible</p>
<h4 data-number="10.6.2.4" id="modern-ecosystem-2020-present"><span class="header-section-number">10.6.2.4</span> Modern Ecosystem
(2020-Present)</h4>
<p><strong>Core Team Employment Diversity:</strong></p>
<pre><code>EnterpriseDB (EDB):    2 members
Crunchy Data:          1 member
Microsoft:             1 member
Independent:           3 members</code></pre>
<p><strong>Policy</strong>: No single company can employ majority of
core team.</p>
<p><strong>Major Corporate Contributors (2024):</strong> -
<strong>EnterpriseDB (EDB)</strong>: 20+ developers, multiple committers
- <strong>Crunchy Data</strong>: 15+ developers, multiple committers -
<strong>Microsoft</strong>: 10+ developers (Citus team) -
<strong>AWS</strong>: Contributions to core, primarily Aurora divergence
- <strong>Google</strong>: Cloud SQL team, some core contributions -
<strong>Fujitsu</strong>: Ongoing contributions -
<strong>VMware</strong>: Postgres team (Greenplum heritage) -
<strong>Timescale</strong>: Time-series extension -
<strong>Supabase</strong>: Cloud platform, community building</p>
<p><strong>Startup Ecosystem:</strong> - 100+ companies offering
PostgreSQL services - Extension ecosystem (Citus, TimescaleDB, PostGIS,
etc.) - Cloud platforms (Supabase, Render, Railway, Neon)</p>
<hr/>
<h3 data-number="10.6.3" id="geographic-distribution"><span class="header-section-number">10.6.3</span> Geographic Distribution</h3>
<h4 data-number="10.6.3.1" id="historical-concentration"><span class="header-section-number">10.6.3.1</span> Historical
Concentration</h4>
<p><strong>1996-2005</strong>: - USA: 60% - Western Europe: 30% - Other:
10%</p>
<p><strong>2005-2015</strong>: - USA: 35% - Western Europe: 35% - Asia
(Japan, China, India): 20% - Other: 10%</p>
<p><strong>2015-2025</strong>: - USA: 25% - Western Europe: 30% - Asia:
25% - Eastern Europe: 10% - South America: 5% - Other: 5%</p>
<h4 data-number="10.6.3.2" id="regional-communities"><span class="header-section-number">10.6.3.2</span> Regional Communities</h4>
<p><strong>North America:</strong> - PGCon (Ottawa) - Premier developer
conference - PGConf US (New York, later various cities) - Strong user
groups (NYC, SF, Seattle, Toronto)</p>
<p><strong>Europe:</strong> - FOSDEM PGDay (Brussels) - Largest by
attendance - PGConf.EU (rotating cities) - Nordic PGDay - pgDay Paris,
UK, Germany, Russia</p>
<p><strong>Asia:</strong> - PGConf.Asia (rotating) - PGConf Japan
(Tokyo) - PGConf India - China PostgreSQL Conference</p>
<p><strong>South America:</strong> - PGConf Brasil - PGConf
Argentina</p>
<p><strong>Africa:</strong> - PGConf South Africa - Growing community in
Nigeria, Kenya</p>
<hr/>
<h3 data-number="10.6.4" id="development-process-refinements"><span class="header-section-number">10.6.4</span> Development Process
Refinements</h3>
<h4 data-number="10.6.4.1" id="commitfest-evolution"><span class="header-section-number">10.6.4.1</span> CommitFest Evolution</h4>
<p><strong>Pre-2008</strong>: Informal patch review
<strong>2008</strong>: First CommitFest organized <strong>2010</strong>:
CommitFest web application created <strong>2015</strong>: Refined
process with clear rules <strong>2020</strong>: Virtual CommitFests
during COVID-19</p>
<p><strong>Modern CommitFest Process:</strong> 1. <strong>Submission
phase</strong>: Contributors submit patches 2. <strong>Review
phase</strong>: Community reviews (1 month) 3. <strong>Commit
phase</strong>: Committers integrate approved patches 4.
<strong>Feedback</strong>: Patches marked: Committed, Returned with
Feedback, Rejected</p>
<p><strong>Stats (typical CommitFest):</strong> - ~100-150 patches
submitted - ~60-80 committed - ~30-40 returned for more work - ~10-20
rejected</p>
<h4 data-number="10.6.4.2" id="code-review-evolution"><span class="header-section-number">10.6.4.2</span> Code Review Evolution</h4>
<p><strong>Early (pre-2010):</strong> - Informal review on mailing lists
- High variability in review quality</p>
<p><strong>Modern (2020+):</strong> - Structured review process - Review
checklist: - Code quality - Performance impact - Test coverage -
Documentation - Backward compatibility - Security implications</p>
<p><strong>Mentorship:</strong> - Experienced contributors mentor
newcomers - ‚ÄúPatch Reviewer‚Äù role established - Documentation for new
contributors</p>
<hr/>
<h2 data-number="10.7" id="part-5-lessons-learned"><span class="header-section-number">10.7</span> Part 5: Lessons Learned</h2>
<h3 data-number="10.7.1" id="what-worked-well"><span class="header-section-number">10.7.1</span> What Worked Well</h3>
<h4 data-number="10.7.1.1" id="incremental-evolution-over-big-rewrites"><span class="header-section-number">10.7.1.1</span> 1. Incremental Evolution
Over Big Rewrites</h4>
<p><strong>Decision</strong>: Never rewrite from scratch.</p>
<p><strong>Rationale:</strong> - Preserve institutional knowledge -
Maintain stability - Backward compatibility - Reduce risk</p>
<p><strong>Examples:</strong> - <strong>Query executor</strong>: Evolved
from 6.x to 17, never rewritten - <strong>Buffer manager</strong>:
Incrementally optimized, core algorithm same - <strong>Parser</strong>:
Grammar grows, parser framework stable</p>
<p><strong>Lesson</strong>: ‚ÄúNever underestimate the cost of a rewrite,
never overestimate the benefit.‚Äù</p>
<p><strong>Counter-examples in other projects:</strong> - <strong>Perl
6</strong>: 15-year rewrite, community split - <strong>Python
3</strong>: Painful migration, finally succeeded after years -
<strong>Netscape</strong>: Rewrite killed company</p>
<p><strong>PostgreSQL avoided this trap.</strong></p>
<hr/>
<h4 data-number="10.7.1.2" id="consensus-driven-decision-making"><span class="header-section-number">10.7.1.2</span> 2. Consensus-Driven
Decision Making</h4>
<p><strong>How it works:</strong> 1. Proposal posted to pgsql-hackers 2.
Public discussion 3. Technical arguments evaluated 4. Rough consensus
emerges 5. Committer makes final call</p>
<p><strong>Why it works:</strong> - Best ideas win (not loudest voice) -
Diverse perspectives considered - Community buy-in - Documented
rationale (mailing list archives)</p>
<p><strong>Example: UPSERT Syntax Debate (9.5)</strong></p>
<p><strong>Proposed syntaxes:</strong></p>
<div class="sourceCode" id="cb666"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb666-1"><a aria-hidden="true" href="#cb666-1" tabindex="-1"></a><span class="co">-- Option 1: INSERT ... ON CONFLICT</span></span>
<span id="cb666-2"><a aria-hidden="true" href="#cb666-2" tabindex="-1"></a><span class="co">-- Option 2: MERGE (SQL standard)</span></span>
<span id="cb666-3"><a aria-hidden="true" href="#cb666-3" tabindex="-1"></a><span class="co">-- Option 3: REPLACE (MySQL-compatible)</span></span></code></pre></div>
<p><strong>Discussion</strong>: 200+ emails over 6 months</p>
<p><strong>Resolution</strong>: INSERT ‚Ä¶ ON CONFLICT chosen -
<strong>Rationale</strong>: - MySQL REPLACE has different semantics
(DELETE+INSERT) - MERGE too complex for simple upsert - ON CONFLICT
clear and PostgreSQL-idiomatic</p>
<p><strong>Lesson</strong>: Thorough debate produces better
decisions.</p>
<hr/>
<h4 data-number="10.7.1.3" id="data-integrity-as-paramount-value"><span class="header-section-number">10.7.1.3</span> 3. Data Integrity as
Paramount Value</h4>
<p><strong>Non-Negotiable Principles:</strong> - Correctness before
performance - ACID compliance always - No silent data corruption - Crash
safety guaranteed</p>
<p><strong>Examples:</strong></p>
<p><strong>Full Page Writes:</strong></p>
<div class="sourceCode" id="cb667"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb667-1"><a aria-hidden="true" href="#cb667-1" tabindex="-1"></a><span class="co">/* src/backend/access/transam/xlog.c</span></span>
<span id="cb667-2"><a aria-hidden="true" href="#cb667-2" tabindex="-1"></a><span class="co"> * After checkpoint, first modification of page writes entire page to WAL</span></span>
<span id="cb667-3"><a aria-hidden="true" href="#cb667-3" tabindex="-1"></a><span class="co"> * Why? Prevents torn pages on crash</span></span>
<span id="cb667-4"><a aria-hidden="true" href="#cb667-4" tabindex="-1"></a><span class="co"> * Cost? More WAL volume</span></span>
<span id="cb667-5"><a aria-hidden="true" href="#cb667-5" tabindex="-1"></a><span class="co"> * Benefit? Data integrity guaranteed</span></span>
<span id="cb667-6"><a aria-hidden="true" href="#cb667-6" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb667-7"><a aria-hidden="true" href="#cb667-7" tabindex="-1"></a>full_page_writes <span class="op">=</span> on<span class="op">;</span>  <span class="co">/* Cannot disable in production */</span></span></code></pre></div>
<p><strong>Checksums:</strong></p>
<div class="sourceCode" id="cb668"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb668-1"><a aria-hidden="true" href="#cb668-1" tabindex="-1"></a><span class="co">/* 9.3+ optional data checksums</span></span>
<span id="cb668-2"><a aria-hidden="true" href="#cb668-2" tabindex="-1"></a><span class="co"> * Detects corruption</span></span>
<span id="cb668-3"><a aria-hidden="true" href="#cb668-3" tabindex="-1"></a><span class="co"> * ~1-2% performance cost</span></span>
<span id="cb668-4"><a aria-hidden="true" href="#cb668-4" tabindex="-1"></a><span class="co"> * Many choose to enable: integrity &gt; speed */</span></span>
<span id="cb668-5"><a aria-hidden="true" href="#cb668-5" tabindex="-1"></a>data_checksums <span class="op">=</span> on<span class="op">;</span></span></code></pre></div>
<p><strong>Conservative Defaults:</strong></p>
<pre><code>synchronous_commit = on    # Wait for WAL to disk
fsync = on                 # Force writes to disk
wal_sync_method = fdatasync  # Reliable sync method</code></pre>
<p><strong>Contrast with MySQL:</strong> - MySQL InnoDB historically
defaulted to <code>innodb_flush_log_at_trx_commit = 1</code> (safe) -
But MyISAM had no crash recovery - PostgreSQL: all storage crash-safe,
no exceptions</p>
<p><strong>Lesson</strong>: Users trust PostgreSQL with critical data
because integrity never compromised.</p>
<hr/>
<h4 data-number="10.7.1.4" id="extensive-testing"><span class="header-section-number">10.7.1.4</span> 4. Extensive Testing</h4>
<p><strong>Test Infrastructure Evolution:</strong></p>
<p><strong>Regression Tests (6.x+):</strong></p>
<div class="sourceCode" id="cb670"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb670-1"><a aria-hidden="true" href="#cb670-1" tabindex="-1"></a><span class="fu">make</span> check  <span class="co"># Runs 200+ SQL regression tests</span></span></code></pre></div>
<p><strong>TAP Tests (9.4+):</strong></p>
<div class="sourceCode" id="cb671"><pre class="sourceCode perl"><code class="sourceCode perl"><span id="cb671-1"><a aria-hidden="true" href="#cb671-1" tabindex="-1"></a><span class="co"># Test Anything Protocol for complex scenarios</span></span>
<span id="cb671-2"><a aria-hidden="true" href="#cb671-2" tabindex="-1"></a><span class="co"># Test replication, recovery, etc.</span></span></code></pre></div>
<p><strong>Isolation Tests (9.1+):</strong></p>
<pre><code># Test concurrent transaction behavior
# Verify snapshot isolation, SSI</code></pre>
<p><strong>Modern Coverage (17):</strong> - 10,000+ test cases - 90%+
code coverage - Platform-specific tests (Windows, macOS, Linux, BSD) -
Performance regression tests</p>
<p><strong>Continuous Integration:</strong> - Buildfarm: 50+ machines
testing all platforms - Every commit tested - Failures reported within
hours</p>
<p><strong>Lesson</strong>: Comprehensive testing enables confident
refactoring.</p>
<hr/>
<h4 data-number="10.7.1.5" id="extensibility-as-core-feature"><span class="header-section-number">10.7.1.5</span> 5. Extensibility as Core
Feature</h4>
<p><strong>Design Philosophy</strong>: Make PostgreSQL a platform, not
just a database.</p>
<p><strong>Extension System (9.1+):</strong> - Clean install/uninstall -
Version management - Dependency tracking</p>
<p><strong>Success Stories:</strong></p>
<p><strong>PostGIS</strong>: Geographic information system</p>
<div class="sourceCode" id="cb673"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb673-1"><a aria-hidden="true" href="#cb673-1" tabindex="-1"></a><span class="kw">CREATE</span> EXTENSION postgis;</span>
<span id="cb673-2"><a aria-hidden="true" href="#cb673-2" tabindex="-1"></a></span>
<span id="cb673-3"><a aria-hidden="true" href="#cb673-3" tabindex="-1"></a><span class="co">-- Suddenly PostgreSQL is GIS database!</span></span>
<span id="cb673-4"><a aria-hidden="true" href="#cb673-4" tabindex="-1"></a><span class="kw">SELECT</span> ST_Distance(</span>
<span id="cb673-5"><a aria-hidden="true" href="#cb673-5" tabindex="-1"></a>    ST_GeomFromText(<span class="st">'POINT(-118.4 33.9)'</span>),  <span class="co">-- Los Angeles</span></span>
<span id="cb673-6"><a aria-hidden="true" href="#cb673-6" tabindex="-1"></a>    ST_GeomFromText(<span class="st">'POINT(-73.9 40.7)'</span>)    <span class="co">-- New York</span></span>
<span id="cb673-7"><a aria-hidden="true" href="#cb673-7" tabindex="-1"></a>);</span></code></pre></div>
<p><strong>TimescaleDB</strong>: Time-series database</p>
<div class="sourceCode" id="cb674"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb674-1"><a aria-hidden="true" href="#cb674-1" tabindex="-1"></a><span class="kw">CREATE</span> EXTENSION timescaledb;</span>
<span id="cb674-2"><a aria-hidden="true" href="#cb674-2" tabindex="-1"></a></span>
<span id="cb674-3"><a aria-hidden="true" href="#cb674-3" tabindex="-1"></a><span class="co">-- PostgreSQL becomes time-series database</span></span>
<span id="cb674-4"><a aria-hidden="true" href="#cb674-4" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> metrics (</span>
<span id="cb674-5"><a aria-hidden="true" href="#cb674-5" tabindex="-1"></a>    <span class="dt">time</span> TIMESTAMPTZ,</span>
<span id="cb674-6"><a aria-hidden="true" href="#cb674-6" tabindex="-1"></a>    <span class="fu">value</span> <span class="dt">DOUBLE</span> <span class="dt">PRECISION</span></span>
<span id="cb674-7"><a aria-hidden="true" href="#cb674-7" tabindex="-1"></a>);</span>
<span id="cb674-8"><a aria-hidden="true" href="#cb674-8" tabindex="-1"></a></span>
<span id="cb674-9"><a aria-hidden="true" href="#cb674-9" tabindex="-1"></a><span class="kw">SELECT</span> create_hypertable(<span class="st">'metrics'</span>, <span class="st">'time'</span>);</span></code></pre></div>
<p><strong>Citus</strong>: Distributed PostgreSQL</p>
<div class="sourceCode" id="cb675"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb675-1"><a aria-hidden="true" href="#cb675-1" tabindex="-1"></a><span class="kw">CREATE</span> EXTENSION citus;</span>
<span id="cb675-2"><a aria-hidden="true" href="#cb675-2" tabindex="-1"></a></span>
<span id="cb675-3"><a aria-hidden="true" href="#cb675-3" tabindex="-1"></a><span class="co">-- PostgreSQL becomes distributed database</span></span>
<span id="cb675-4"><a aria-hidden="true" href="#cb675-4" tabindex="-1"></a><span class="kw">SELECT</span> create_distributed_table(<span class="st">'events'</span>, <span class="st">'user_id'</span>);</span></code></pre></div>
<p><strong>Lesson</strong>: Extensibility created ecosystem, multiplied
PostgreSQL‚Äôs value.</p>
<hr/>
<h3 data-number="10.7.2" id="what-was-refactored"><span class="header-section-number">10.7.2</span> What Was Refactored</h3>
<h4 data-number="10.7.2.1" id="vacuum-full-rewrite-9.0"><span class="header-section-number">10.7.2.1</span> 1. VACUUM FULL Rewrite
(9.0)</h4>
<p><strong>Original VACUUM FULL (6.x-8.4):</strong></p>
<div class="sourceCode" id="cb676"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb676-1"><a aria-hidden="true" href="#cb676-1" tabindex="-1"></a><span class="co">/* Algorithm:</span></span>
<span id="cb676-2"><a aria-hidden="true" href="#cb676-2" tabindex="-1"></a><span class="co"> * 1. Acquire AccessExclusiveLock (blocks all access!)</span></span>
<span id="cb676-3"><a aria-hidden="true" href="#cb676-3" tabindex="-1"></a><span class="co"> * 2. Scan table, move tuples to front</span></span>
<span id="cb676-4"><a aria-hidden="true" href="#cb676-4" tabindex="-1"></a><span class="co"> * 3. Truncate file</span></span>
<span id="cb676-5"><a aria-hidden="true" href="#cb676-5" tabindex="-1"></a><span class="co"> *</span></span>
<span id="cb676-6"><a aria-hidden="true" href="#cb676-6" tabindex="-1"></a><span class="co"> * Problem:</span></span>
<span id="cb676-7"><a aria-hidden="true" href="#cb676-7" tabindex="-1"></a><span class="co"> * - Locks table for hours</span></span>
<span id="cb676-8"><a aria-hidden="true" href="#cb676-8" tabindex="-1"></a><span class="co"> * - Rewrites entire table in place</span></span>
<span id="cb676-9"><a aria-hidden="true" href="#cb676-9" tabindex="-1"></a><span class="co"> * - Risk of corruption if crash</span></span>
<span id="cb676-10"><a aria-hidden="true" href="#cb676-10" tabindex="-1"></a><span class="co"> */</span></span></code></pre></div>
<p><strong>New VACUUM FULL (9.0+):</strong></p>
<div class="sourceCode" id="cb677"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb677-1"><a aria-hidden="true" href="#cb677-1" tabindex="-1"></a><span class="co">/* Algorithm:</span></span>
<span id="cb677-2"><a aria-hidden="true" href="#cb677-2" tabindex="-1"></a><span class="co"> * 1. Create new table file</span></span>
<span id="cb677-3"><a aria-hidden="true" href="#cb677-3" tabindex="-1"></a><span class="co"> * 2. Copy live tuples to new file</span></span>
<span id="cb677-4"><a aria-hidden="true" href="#cb677-4" tabindex="-1"></a><span class="co"> * 3. Swap files</span></span>
<span id="cb677-5"><a aria-hidden="true" href="#cb677-5" tabindex="-1"></a><span class="co"> * 4. Drop old file</span></span>
<span id="cb677-6"><a aria-hidden="true" href="#cb677-6" tabindex="-1"></a><span class="co"> *</span></span>
<span id="cb677-7"><a aria-hidden="true" href="#cb677-7" tabindex="-1"></a><span class="co"> * Benefits:</span></span>
<span id="cb677-8"><a aria-hidden="true" href="#cb677-8" tabindex="-1"></a><span class="co"> * - Still locks table, but safer</span></span>
<span id="cb677-9"><a aria-hidden="true" href="#cb677-9" tabindex="-1"></a><span class="co"> * - Can be interrupted and restarted</span></span>
<span id="cb677-10"><a aria-hidden="true" href="#cb677-10" tabindex="-1"></a><span class="co"> * - No corruption on crash</span></span>
<span id="cb677-11"><a aria-hidden="true" href="#cb677-11" tabindex="-1"></a><span class="co"> */</span></span></code></pre></div>
<p><strong>Why Refactored:</strong> - Original implementation too risky
- Rare reports of corruption - Industry expectation: VACUUM shouldn‚Äôt
corrupt data</p>
<p><strong>Lesson</strong>: Safety improvements worth breaking
change.</p>
<hr/>
<h4 data-number="10.7.2.2" id="trigger-system-7.x-8.x"><span class="header-section-number">10.7.2.2</span> 2. Trigger System (7.x ‚Üí
8.x)</h4>
<p><strong>Original Triggers (6.x-7.x):</strong> - Limited functionality
- Poor performance - No row-level control</p>
<p><strong>Refactored Triggers (8.x+):</strong> - BEFORE/AFTER/INSTEAD
OF - Row-level and statement-level - WHEN clauses (9.0) - Transition
tables (10)</p>
<p><strong>Modern Trigger (10+):</strong></p>
<div class="sourceCode" id="cb678"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb678-1"><a aria-hidden="true" href="#cb678-1" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TRIGGER</span> audit_changes</span>
<span id="cb678-2"><a aria-hidden="true" href="#cb678-2" tabindex="-1"></a>    <span class="kw">AFTER</span> <span class="kw">UPDATE</span> <span class="kw">ON</span> accounts</span>
<span id="cb678-3"><a aria-hidden="true" href="#cb678-3" tabindex="-1"></a>    <span class="kw">REFERENCING</span> <span class="kw">OLD</span> <span class="kw">TABLE</span> <span class="kw">AS</span> old_accounts</span>
<span id="cb678-4"><a aria-hidden="true" href="#cb678-4" tabindex="-1"></a>                <span class="kw">NEW</span> <span class="kw">TABLE</span> <span class="kw">AS</span> new_accounts</span>
<span id="cb678-5"><a aria-hidden="true" href="#cb678-5" tabindex="-1"></a>    <span class="cf">FOR</span> <span class="kw">EACH</span> STATEMENT</span>
<span id="cb678-6"><a aria-hidden="true" href="#cb678-6" tabindex="-1"></a>    <span class="kw">EXECUTE</span> <span class="kw">FUNCTION</span> audit_account_changes();</span>
<span id="cb678-7"><a aria-hidden="true" href="#cb678-7" tabindex="-1"></a></span>
<span id="cb678-8"><a aria-hidden="true" href="#cb678-8" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">FUNCTION</span> audit_account_changes() RETURNS <span class="kw">trigger</span> <span class="kw">AS</span> $$</span>
<span id="cb678-9"><a aria-hidden="true" href="#cb678-9" tabindex="-1"></a><span class="cf">BEGIN</span></span>
<span id="cb678-10"><a aria-hidden="true" href="#cb678-10" tabindex="-1"></a>    <span class="kw">INSERT</span> <span class="kw">INTO</span> audit_log</span>
<span id="cb678-11"><a aria-hidden="true" href="#cb678-11" tabindex="-1"></a>    <span class="kw">SELECT</span> n.<span class="kw">id</span>, n.balance <span class="op">-</span> o.balance <span class="kw">AS</span> <span class="kw">change</span></span>
<span id="cb678-12"><a aria-hidden="true" href="#cb678-12" tabindex="-1"></a>    <span class="kw">FROM</span> new_accounts n</span>
<span id="cb678-13"><a aria-hidden="true" href="#cb678-13" tabindex="-1"></a>    <span class="kw">JOIN</span> old_accounts o <span class="kw">ON</span> n.<span class="kw">id</span> <span class="op">=</span> o.<span class="kw">id</span>;</span>
<span id="cb678-14"><a aria-hidden="true" href="#cb678-14" tabindex="-1"></a>    <span class="kw">RETURN</span> <span class="kw">NULL</span>;</span>
<span id="cb678-15"><a aria-hidden="true" href="#cb678-15" tabindex="-1"></a><span class="cf">END</span>;</span>
<span id="cb678-16"><a aria-hidden="true" href="#cb678-16" tabindex="-1"></a>$$ LANGUAGE plpgsql;</span></code></pre></div>
<p><strong>Lesson</strong>: Incrementally improved until
world-class.</p>
<hr/>
<h4 data-number="10.7.2.3" id="statistics-system-8.x-13"><span class="header-section-number">10.7.2.3</span> 3. Statistics System (8.x
‚Üí 13+)</h4>
<p><strong>Evolution:</strong></p>
<p><strong>8.x</strong>: Basic statistics (MCV, histogram)</p>
<p><strong>9.x</strong>: Per-column statistics, correlation</p>
<p><strong>10+</strong>: Extended statistics (multi-column)</p>
<div class="sourceCode" id="cb679"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb679-1"><a aria-hidden="true" href="#cb679-1" tabindex="-1"></a><span class="co">-- Optimizer understands column correlation</span></span>
<span id="cb679-2"><a aria-hidden="true" href="#cb679-2" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">STATISTICS</span> city_zip_stats (dependencies, ndistinct)</span>
<span id="cb679-3"><a aria-hidden="true" href="#cb679-3" tabindex="-1"></a><span class="kw">ON</span> city, zipcode <span class="kw">FROM</span> addresses;</span></code></pre></div>
<p><strong>13+</strong>: Better distinct estimates, functional
dependencies</p>
<p><strong>Why Continuously Refactored:</strong> - Query optimization
directly depends on statistics quality - Each improvement makes
optimizer smarter - Bad statistics ‚Üí bad plans ‚Üí slow queries</p>
<p><strong>Lesson</strong>: Core infrastructure deserves continuous
investment.</p>
<hr/>
<h3 data-number="10.7.3" id="design-decisions-that-stood-the-test-of-time"><span class="header-section-number">10.7.3</span> Design Decisions That Stood
the Test of Time</h3>
<h4 data-number="10.7.3.1" id="multi-version-concurrency-control-mvcc-1"><span class="header-section-number">10.7.3.1</span> 1. Multi-Version
Concurrency Control (MVCC)</h4>
<p><strong>Decision (6.0, 1997)</strong>: Use MVCC for transaction
isolation.</p>
<p><strong>Implementation:</strong> - Each row version has transaction
ID (xmin, xmax) - Transactions see snapshot of data - No locks for
reads</p>
<p><strong>Why It Stood the Test:</strong> - Readers never block writers
- Writers never block readers - Scales to high concurrency - Foundation
for all features (replication, parallelism, etc.)</p>
<p><strong>27 Years Later</strong>: Still core architecture, no
regrets.</p>
<p><strong>Lesson</strong>: Good fundamental decisions last decades.</p>
<hr/>
<h4 data-number="10.7.3.2" id="process-per-connection-model"><span class="header-section-number">10.7.3.2</span> 2. Process-Per-Connection
Model</h4>
<p><strong>Decision (6.x)</strong>: One OS process per client
connection.</p>
<p><strong>Alternatives Considered:</strong> - Thread-per-connection
(MySQL, SQL Server) - Single-process event loop (Redis)</p>
<p><strong>Why Process Model:</strong> - <strong>Isolation</strong>:
Crash in one backend doesn‚Äôt affect others -
<strong>Portability</strong>: Works on all Unix-like systems -
<strong>Simplicity</strong>: No complex thread synchronization -
<strong>Security</strong>: OS-level isolation</p>
<p><strong>Trade-offs:</strong> - <strong>Con</strong>: More memory per
connection (each process has overhead) - <strong>Con</strong>:
Connection startup slower (fork() cost) - <strong>Pro</strong>:
Rock-solid stability - <strong>Pro</strong>: Easy debugging (attach
debugger to process)</p>
<p><strong>Modern Mitigations:</strong> - Connection pooling (pgBouncer,
pgPool) - Thousands of connections practical with pooling</p>
<p><strong>Lesson</strong>: Simplicity and stability worth
trade-offs.</p>
<hr/>
<h4 data-number="10.7.3.3" id="catalog-system-pg_-tables"><span class="header-section-number">10.7.3.3</span> 3. Catalog System (pg_*
tables)</h4>
<p><strong>Decision (Berkeley era)</strong>: System catalog is itself
relational tables.</p>
<p><strong>Implementation:</strong></p>
<div class="sourceCode" id="cb680"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb680-1"><a aria-hidden="true" href="#cb680-1" tabindex="-1"></a><span class="co">-- System tables are just tables!</span></span>
<span id="cb680-2"><a aria-hidden="true" href="#cb680-2" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> pg_class <span class="kw">WHERE</span> relname <span class="op">=</span> <span class="st">'users'</span>;</span>
<span id="cb680-3"><a aria-hidden="true" href="#cb680-3" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> pg_attribute <span class="kw">WHERE</span> attrelid <span class="op">=</span> <span class="st">'users'</span>:<span class="ch">:regclass</span>;</span>
<span id="cb680-4"><a aria-hidden="true" href="#cb680-4" tabindex="-1"></a></span>
<span id="cb680-5"><a aria-hidden="true" href="#cb680-5" tabindex="-1"></a><span class="co">-- Even during bootstrap</span></span></code></pre></div>
<p><strong>Why Brilliant:</strong> - Query system metadata with SQL -
Introspection built-in - Extensibility natural (just add rows) - Tools
use same interface</p>
<p><strong>Examples:</strong></p>
<div class="sourceCode" id="cb681"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb681-1"><a aria-hidden="true" href="#cb681-1" tabindex="-1"></a><span class="co">-- List all indexes on a table</span></span>
<span id="cb681-2"><a aria-hidden="true" href="#cb681-2" tabindex="-1"></a><span class="kw">SELECT</span> indexname, indexdef</span>
<span id="cb681-3"><a aria-hidden="true" href="#cb681-3" tabindex="-1"></a><span class="kw">FROM</span> pg_indexes</span>
<span id="cb681-4"><a aria-hidden="true" href="#cb681-4" tabindex="-1"></a><span class="kw">WHERE</span> tablename <span class="op">=</span> <span class="st">'users'</span>;</span>
<span id="cb681-5"><a aria-hidden="true" href="#cb681-5" tabindex="-1"></a></span>
<span id="cb681-6"><a aria-hidden="true" href="#cb681-6" tabindex="-1"></a><span class="co">-- Find large tables</span></span>
<span id="cb681-7"><a aria-hidden="true" href="#cb681-7" tabindex="-1"></a><span class="kw">SELECT</span> schemaname, tablename, pg_size_pretty(pg_total_relation_size(schemaname<span class="op">||</span><span class="st">'.'</span><span class="op">||</span>tablename))</span>
<span id="cb681-8"><a aria-hidden="true" href="#cb681-8" tabindex="-1"></a><span class="kw">FROM</span> pg_tables</span>
<span id="cb681-9"><a aria-hidden="true" href="#cb681-9" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> pg_total_relation_size(schemaname<span class="op">||</span><span class="st">'.'</span><span class="op">||</span>tablename) <span class="kw">DESC</span></span>
<span id="cb681-10"><a aria-hidden="true" href="#cb681-10" tabindex="-1"></a><span class="kw">LIMIT</span> <span class="dv">10</span>;</span></code></pre></div>
<p><strong>Lesson</strong>: Dogfooding (using your own product) produces
better design.</p>
<hr/>
<h4 data-number="10.7.3.4" id="write-ahead-logging-wal"><span class="header-section-number">10.7.3.4</span> 4. Write-Ahead Logging
(WAL)</h4>
<p><strong>Decision (7.0, 2000)</strong>: All changes logged before
applied.</p>
<p><strong>Purpose:</strong> - Crash recovery - Replication -
Point-in-time recovery</p>
<p><strong>Why It Stood the Test:</strong> - Foundation for streaming
replication (9.0) - Foundation for logical replication (10) - Foundation
for hot standby (9.0) - Industry standard (now used by all major
databases)</p>
<p><strong>24 Years Later</strong>: Every major feature builds on
WAL.</p>
<p><strong>Lesson</strong>: Infrastructure decisions have long-term
consequences. Choose wisely.</p>
<hr/>
<h3 data-number="10.7.4" id="technical-debt-management"><span class="header-section-number">10.7.4</span> Technical Debt
Management</h3>
<h4 data-number="10.7.4.1" id="acknowledged-technical-debt"><span class="header-section-number">10.7.4.1</span> Acknowledged Technical
Debt</h4>
<p><strong>1. Tuple Format</strong></p>
<p><strong>Issue</strong>: Heap tuple header has 23 bytes overhead (out
of typical 40-byte row).</p>
<p><strong>Why Not Fixed:</strong> - Changing tuple format breaks
on-disk compatibility - Major version upgrade required - Risk vs.¬†reward
not justified</p>
<p><strong>Mitigation</strong>: - Columnar storage (via extensions) -
Compression (TOAST)</p>
<hr/>
<p><strong>2. System Catalogs</strong></p>
<p><strong>Issue</strong>: Bootstrap process complex, catalog system
intricate.</p>
<p><strong>Why Not Fixed:</strong> - ‚ÄúCathedral‚Äù of complexity, works
well - Any change risks breaking fundamental assumptions - Cost of
rewrite enormous</p>
<p><strong>Mitigation</strong>: - Incremental improvements - Better
documentation (BKI format documented)</p>
<hr/>
<p><strong>3. Parser (gram.y)</strong></p>
<p><strong>Issue</strong>: Parser file is 513,000 lines (generated),
complex grammar.</p>
<p><strong>Why Not Fixed:</strong> - SQL standard keeps growing -
Backward compatibility essential - Alternatives (hand-written parser)
not clearly better</p>
<p><strong>Mitigation</strong>: - Code generation from spec - Extensive
testing</p>
<hr/>
<h4 data-number="10.7.4.2" id="how-debt-is-managed"><span class="header-section-number">10.7.4.2</span> How Debt Is Managed</h4>
<p><strong>Strategies:</strong></p>
<p><strong>1. Incremental Refactoring</strong> - Small improvements each
release - Example: Query planner refactored over versions 7-12</p>
<p><strong>2. Abstraction Layers</strong> - Example: Pluggable storage
(12+) allows alternative storage - Doesn‚Äôt fix heap tuple format, but
allows bypassing it</p>
<p><strong>3. Feature Flags</strong> - New implementations coexist with
old - Example: Hash indexes (disabled until 10, then fixed)</p>
<p><strong>4. Deprecation Cycles</strong> - Announce deprecation ‚Üí
warning ‚Üí removal - Example: ‚Äúmoney‚Äù type (deprecated, still exists for
compatibility)</p>
<p><strong>5. Accept Some Debt</strong> - Not all debt needs fixing -
Cost/benefit analysis - ‚ÄúGood enough‚Äù is sometimes good enough</p>
<p><strong>Lesson</strong>: Perfect is the enemy of good. Manage debt,
don‚Äôt eliminate it.</p>
<hr/>
<h2 data-number="10.8" id="conclusion-38-years-of-evolution"><span class="header-section-number">10.8</span> Conclusion: 38 Years of
Evolution</h2>
<h3 data-number="10.8.1" id="the-big-picture"><span class="header-section-number">10.8.1</span> The Big Picture</h3>
<p>From Berkeley POSTGRES (1986) to PostgreSQL 17 (2024), the project
has:</p>
<p><strong>Technical Achievements:</strong> - Survived 38 years without
major rewrite - Grew from academic experiment to enterprise standard -
Maintained backward compatibility across 11 major versions (6‚Üí17) -
Performance improved 100-1000x (depending on workload) - Feature set
rivals/exceeds commercial databases</p>
<p><strong>Community Achievements:</strong> - Grew from ~5 developers to
400+ contributors - Worldwide community in 50+ countries - 100+
companies supporting/contributing - 1,000,000+ installations worldwide -
Thriving extension ecosystem</p>
<p><strong>Cultural Achievements:</strong> - Consensus-driven governance
works at scale - No single-company control - Meritocracy mostly achieved
- Open development process (all discussions public) - Knowledge
preserved (mailing list archives since 1997)</p>
<hr/>
<h3 data-number="10.8.2" id="key-themes-of-evolution"><span class="header-section-number">10.8.2</span> Key Themes of Evolution</h3>
<p><strong>1. Incremental Progress</strong> - No ‚Äúversion 2.0 rewrite‚Äù -
Each version builds on previous - Refactor, don‚Äôt replace</p>
<p><strong>2. Community Wisdom</strong> - Diverse perspectives produce
better decisions - Consensus takes time but produces stability - Public
discussion creates transparency</p>
<p><strong>3. Data Integrity First</strong> - Correctness never
compromised for performance - Users trust PostgreSQL with critical data
- Conservative defaults</p>
<p><strong>4. Extensibility Multiplies Value</strong> - Extension
ecosystem creates network effects - PostgreSQL becomes platform, not
just database</p>
<p><strong>5. Long-Term Thinking</strong> - Decisions made for 10-year
horizon - Backward compatibility valued - Stability attracts enterprise
users</p>
<hr/>
<h3 data-number="10.8.3" id="the-road-ahead"><span class="header-section-number">10.8.3</span> The Road Ahead</h3>
<p><strong>Trends (2025+):</strong></p>
<p><strong>1. Cloud-Native Features</strong> - Better object storage
integration - Separated storage/compute - Elastic scaling</p>
<p><strong>2. Continued Parallelism</strong> - More operations
parallelized - Better multi-core utilization - NUMA-aware algorithms</p>
<p><strong>3. AI/ML Integration</strong> - Vector databases (pgvector
extension) - In-database ML (PL/Python, PL/R) - Query optimization via
ML</p>
<p><strong>4. Distributed PostgreSQL</strong> - Better sharding (Citus,
others) - Cross-region replication - Geo-distribution</p>
<p><strong>5. Performance</strong> - JIT improvements - Better optimizer
- Lock-free algorithms</p>
<p><strong>6. Pluggable Everything</strong> - Pluggable storage (12+) -
Pluggable WAL archiving (15+) - More extension points</p>
<hr/>
<h3 data-number="10.8.4" id="reflections"><span class="header-section-number">10.8.4</span> Reflections</h3>
<p>PostgreSQL‚Äôs evolution demonstrates:</p>
<p><strong>Technical Excellence Matters</strong>: Code quality, testing,
and design pay dividends for decades.</p>
<p><strong>Community Beats Company</strong>: Open, consensus-driven
development produces stable, innovative software.</p>
<p><strong>Incrementalism Works</strong>: Steady progress beats big
rewrites.</p>
<p><strong>Integrity Builds Trust</strong>: Data correctness creates
loyal users.</p>
<p><strong>Extensibility Creates Ecosystems</strong>: Platform approach
multiplies value.</p>
<hr/>
<h2 data-number="10.9" id="further-reading-1"><span class="header-section-number">10.9</span> Further Reading</h2>
<p><strong>Academic Papers:</strong> - ‚ÄúThe Design of POSTGRES‚Äù
(Stonebraker &amp; Rowe, 1986) - ‚ÄúThe POSTGRES Next-Generation Database
Management System‚Äù (1991) - ‚ÄúSerializable Snapshot Isolation in
PostgreSQL‚Äù (VLDB 2012)</p>
<p><strong>Historical Resources:</strong> - Mailing list archives:
https://www.postgresql.org/list/ - Release notes:
https://www.postgresql.org/docs/release/ - Git history:
https://git.postgresql.org/</p>
<p><strong>Community Resources:</strong> - PostgreSQL Wiki:
https://wiki.postgresql.org - Planet PostgreSQL: Blog aggregator - PGCon
presentations: Years of technical talks</p>
<hr/>
<p><strong>File Locations Referenced:</strong></p>
<p>Core source files analyzed in this chapter: -
<code>/home/user/postgres/src/backend/access/transam/xlog.c</code> - WAL
implementation -
<code>/home/user/postgres/src/backend/utils/mmgr/README</code> - Memory
context design -
<code>/home/user/postgres/src/backend/storage/lmgr/README</code> -
Locking overview -
<code>/home/user/postgres/src/backend/access/transam/README.parallel</code>
- Parallel execution -
<code>/home/user/postgres/src/backend/storage/buffer/bufmgr.c</code> -
Buffer management -
<code>/home/user/postgres/src/backend/utils/resowner/README</code> -
Resource owners</p>
<hr/>
<p><em>This chapter represents the accumulated wisdom of thousands of
contributors over 38 years. The evolution continues.</em></p>
<h1 data-number="11" id="postgresql-build-system-and-portability-layer"><span class="header-section-number">11</span> PostgreSQL Build System and
Portability Layer</h1>
<h2 data-number="11.1" id="table-of-contents-3"><span class="header-section-number">11.1</span> Table of Contents</h2>
<ol type="1">
<li><a href="#autoconf-configure-build-system">Autoconf/Configure Build
System</a></li>
<li><a href="#meson-build-system">Meson Build System</a></li>
<li><a href="#portability-layer">Portability Layer (src/port/)</a></li>
<li><a href="#platform-specific-code">Platform-Specific Code</a></li>
<li><a href="#testing-infrastructure">Testing Infrastructure</a></li>
<li><a href="#code-generation-tools">Code Generation Tools</a></li>
<li><a href="#documentation-build-system">Documentation Build
System</a></li>
<li><a href="#development-practices">Development Practices and Coding
Standards</a></li>
</ol>
<hr/>
<h2 data-number="11.2" id="autoconfconfigure-build-system"><span class="header-section-number">11.2</span> 1. Autoconf/Configure Build
System</h2>
<h3 data-number="11.2.1" id="overview-16"><span class="header-section-number">11.2.1</span> Overview</h3>
<p>PostgreSQL uses GNU Autoconf for its traditional build system,
providing portable configuration across Unix-like platforms.</p>
<h3 data-number="11.2.2" id="key-files"><span class="header-section-number">11.2.2</span> Key Files</h3>
<h4 data-number="11.2.2.1" id="homeuserpostgresconfigure.ac"><span class="header-section-number">11.2.2.1</span>
/home/user/postgres/configure.ac</h4>
<p>The main autoconf configuration file that generates the configure
script.</p>
<p><strong>Lines 1-50: Basic Structure</strong></p>
<div class="sourceCode" id="cb682"><pre class="sourceCode m4"><code class="sourceCode m4"><span id="cb682-1"><a aria-hidden="true" href="#cb682-1" tabindex="-1"></a><span class="kw">dnl</span> Process this file with autoconf to produce a configure script.</span>
<span id="cb682-2"><a aria-hidden="true" href="#cb682-2" tabindex="-1"></a><span class="kw">dnl</span> configure.ac</span>
<span id="cb682-3"><a aria-hidden="true" href="#cb682-3" tabindex="-1"></a></span>
<span id="cb682-4"><a aria-hidden="true" href="#cb682-4" tabindex="-1"></a><span class="kw">dnl</span> Developers<span class="ch">,</span> please strive to achieve this order:</span>
<span id="cb682-5"><a aria-hidden="true" href="#cb682-5" tabindex="-1"></a><span class="kw">dnl</span></span>
<span id="cb682-6"><a aria-hidden="true" href="#cb682-6" tabindex="-1"></a><span class="kw">dnl</span> <span class="dv">0</span>. Initialization and options processing</span>
<span id="cb682-7"><a aria-hidden="true" href="#cb682-7" tabindex="-1"></a><span class="kw">dnl</span> <span class="dv">1</span>. Programs</span>
<span id="cb682-8"><a aria-hidden="true" href="#cb682-8" tabindex="-1"></a><span class="kw">dnl</span> <span class="dv">2</span>. Libraries</span>
<span id="cb682-9"><a aria-hidden="true" href="#cb682-9" tabindex="-1"></a><span class="kw">dnl</span> <span class="dv">3</span>. Header files</span>
<span id="cb682-10"><a aria-hidden="true" href="#cb682-10" tabindex="-1"></a><span class="kw">dnl</span> <span class="dv">4</span>. Types</span>
<span id="cb682-11"><a aria-hidden="true" href="#cb682-11" tabindex="-1"></a><span class="kw">dnl</span> <span class="dv">5</span>. Structures</span>
<span id="cb682-12"><a aria-hidden="true" href="#cb682-12" tabindex="-1"></a><span class="kw">dnl</span> <span class="dv">6</span>. Compiler characteristics</span>
<span id="cb682-13"><a aria-hidden="true" href="#cb682-13" tabindex="-1"></a><span class="kw">dnl</span> <span class="dv">7</span>. Functions<span class="ch">,</span> global variables</span>
<span id="cb682-14"><a aria-hidden="true" href="#cb682-14" tabindex="-1"></a><span class="kw">dnl</span> <span class="dv">8</span>. System services</span>
<span id="cb682-15"><a aria-hidden="true" href="#cb682-15" tabindex="-1"></a></span>
<span id="cb682-16"><a aria-hidden="true" href="#cb682-16" tabindex="-1"></a>AC_INIT<span class="ch">(</span>[PostgreSQL]<span class="ch">,</span> [<span class="dv">19</span>devel]<span class="ch">,</span> [pgsql<span class="ch">-</span>bugs@lists.postgresql.org]<span class="ch">,</span> []<span class="ch">,</span> [https:<span class="ch">//</span>www.postgresql.org<span class="ch">/</span>]<span class="ch">)</span></span>
<span id="cb682-17"><a aria-hidden="true" href="#cb682-17" tabindex="-1"></a></span>
<span id="cb682-18"><a aria-hidden="true" href="#cb682-18" tabindex="-1"></a><span class="co"># Requires autoconf version 2.69 exactly</span></span>
<span id="cb682-19"><a aria-hidden="true" href="#cb682-19" tabindex="-1"></a>m4_if<span class="ch">(</span><span class="kw">m4_defn</span><span class="ch">(</span>[m4_PACKAGE_VERSION]<span class="ch">),</span> [<span class="dv">2</span>.<span class="dv">69</span>]<span class="ch">,</span> []<span class="ch">,</span> </span>
<span id="cb682-20"><a aria-hidden="true" href="#cb682-20" tabindex="-1"></a>  [m4_fatal<span class="ch">(</span>[Autoconf version <span class="dv">2</span>.<span class="dv">69</span> is required.]<span class="ch">)</span>]<span class="ch">)</span></span>
<span id="cb682-21"><a aria-hidden="true" href="#cb682-21" tabindex="-1"></a></span>
<span id="cb682-22"><a aria-hidden="true" href="#cb682-22" tabindex="-1"></a>AC_COPYRIGHT<span class="ch">(</span>[Copyright <span class="ch">(</span>c<span class="ch">)</span> <span class="dv">1996</span><span class="ch">-</span><span class="dv">2025</span><span class="ch">,</span> PostgreSQL Global Development Group]<span class="ch">)</span></span>
<span id="cb682-23"><a aria-hidden="true" href="#cb682-23" tabindex="-1"></a>AC_CONFIG_SRCDIR<span class="ch">(</span>[src<span class="ch">/</span>backend<span class="ch">/</span>access<span class="ch">/</span>common<span class="ch">/</span>heaptuple.c]<span class="ch">)</span></span>
<span id="cb682-24"><a aria-hidden="true" href="#cb682-24" tabindex="-1"></a>AC_CONFIG_AUX_DIR<span class="ch">(</span>config<span class="ch">)</span></span>
<span id="cb682-25"><a aria-hidden="true" href="#cb682-25" tabindex="-1"></a>AC_PREFIX_DEFAULT<span class="ch">(/</span>usr<span class="ch">/</span>local<span class="ch">/</span>pgsql<span class="ch">)</span></span></code></pre></div>
<p><strong>Lines 64-96: Platform Template Selection</strong></p>
<div class="sourceCode" id="cb683"><pre class="sourceCode m4"><code class="sourceCode m4"><span id="cb683-1"><a aria-hidden="true" href="#cb683-1" tabindex="-1"></a><span class="co"># Platform-specific configuration templates</span></span>
<span id="cb683-2"><a aria-hidden="true" href="#cb683-2" tabindex="-1"></a>case $host_os in</span>
<span id="cb683-3"><a aria-hidden="true" href="#cb683-3" tabindex="-1"></a>  cygwin<span class="ch">*|</span>msys<span class="ch">*)</span> template<span class="ch">=</span>cygwin ;;</span>
<span id="cb683-4"><a aria-hidden="true" href="#cb683-4" tabindex="-1"></a>  darwin<span class="ch">*)</span> template<span class="ch">=</span>darwin ;;</span>
<span id="cb683-5"><a aria-hidden="true" href="#cb683-5" tabindex="-1"></a>  dragonfly<span class="ch">*)</span> template<span class="ch">=</span>netbsd ;;</span>
<span id="cb683-6"><a aria-hidden="true" href="#cb683-6" tabindex="-1"></a>  freebsd<span class="ch">*)</span> template<span class="ch">=</span>freebsd ;;</span>
<span id="cb683-7"><a aria-hidden="true" href="#cb683-7" tabindex="-1"></a>  linux<span class="ch">*|</span>gnu<span class="ch">*|</span>k<span class="ch">*</span>bsd<span class="ch">*-</span>gnu<span class="ch">)</span></span>
<span id="cb683-8"><a aria-hidden="true" href="#cb683-8" tabindex="-1"></a>             template<span class="ch">=</span>linux ;;</span>
<span id="cb683-9"><a aria-hidden="true" href="#cb683-9" tabindex="-1"></a>  mingw<span class="ch">*)</span> template<span class="ch">=</span>win32 ;;</span>
<span id="cb683-10"><a aria-hidden="true" href="#cb683-10" tabindex="-1"></a>  netbsd<span class="ch">*)</span> template<span class="ch">=</span>netbsd ;;</span>
<span id="cb683-11"><a aria-hidden="true" href="#cb683-11" tabindex="-1"></a>  openbsd<span class="ch">*)</span> template<span class="ch">=</span>openbsd ;;</span>
<span id="cb683-12"><a aria-hidden="true" href="#cb683-12" tabindex="-1"></a>  solaris<span class="ch">*)</span> template<span class="ch">=</span>solaris ;;</span>
<span id="cb683-13"><a aria-hidden="true" href="#cb683-13" tabindex="-1"></a>esac</span>
<span id="cb683-14"><a aria-hidden="true" href="#cb683-14" tabindex="-1"></a></span>
<span id="cb683-15"><a aria-hidden="true" href="#cb683-15" tabindex="-1"></a>PORTNAME<span class="ch">=</span>$template</span>
<span id="cb683-16"><a aria-hidden="true" href="#cb683-16" tabindex="-1"></a>AC_SUBST<span class="ch">(</span>PORTNAME<span class="ch">)</span></span>
<span id="cb683-17"><a aria-hidden="true" href="#cb683-17" tabindex="-1"></a></span>
<span id="cb683-18"><a aria-hidden="true" href="#cb683-18" tabindex="-1"></a><span class="co"># Default, works for most platforms, override in template file if needed</span></span>
<span id="cb683-19"><a aria-hidden="true" href="#cb683-19" tabindex="-1"></a>DLSUFFIX<span class="ch">=</span>".so"</span></code></pre></div>
<h3 data-number="11.2.3" id="platform-templates"><span class="header-section-number">11.2.3</span> Platform Templates</h3>
<p>Located in <code>/home/user/postgres/src/template/</code>, these
files contain platform-specific settings.</p>
<h4 data-number="11.2.3.1" id="linux-template-homeuserpostgressrctemplatelinux"><span class="header-section-number">11.2.3.1</span> Linux Template
(/home/user/postgres/src/template/linux)</h4>
<div class="sourceCode" id="cb684"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb684-1"><a aria-hidden="true" href="#cb684-1" tabindex="-1"></a><span class="co"># Prefer unnamed POSIX semaphores if available, unless user overrides choice</span></span>
<span id="cb684-2"><a aria-hidden="true" href="#cb684-2" tabindex="-1"></a><span class="cf">if</span> <span class="bu">test</span> x<span class="st">"</span><span class="va">$PREFERRED_SEMAPHORES</span><span class="st">"</span> = x<span class="st">""</span> <span class="kw">;</span> <span class="cf">then</span></span>
<span id="cb684-3"><a aria-hidden="true" href="#cb684-3" tabindex="-1"></a>  <span class="va">PREFERRED_SEMAPHORES</span><span class="op">=</span>UNNAMED_POSIX</span>
<span id="cb684-4"><a aria-hidden="true" href="#cb684-4" tabindex="-1"></a><span class="cf">fi</span></span>
<span id="cb684-5"><a aria-hidden="true" href="#cb684-5" tabindex="-1"></a></span>
<span id="cb684-6"><a aria-hidden="true" href="#cb684-6" tabindex="-1"></a><span class="co"># Force _GNU_SOURCE on; plperl is broken with Perl 5.8.0 otherwise</span></span>
<span id="cb684-7"><a aria-hidden="true" href="#cb684-7" tabindex="-1"></a><span class="co"># This is also required for ppoll(2), and perhaps other things</span></span>
<span id="cb684-8"><a aria-hidden="true" href="#cb684-8" tabindex="-1"></a><span class="va">CPPFLAGS</span><span class="op">=</span><span class="st">"</span><span class="va">$CPPFLAGS</span><span class="st"> -D_GNU_SOURCE"</span></span>
<span id="cb684-9"><a aria-hidden="true" href="#cb684-9" tabindex="-1"></a></span>
<span id="cb684-10"><a aria-hidden="true" href="#cb684-10" tabindex="-1"></a><span class="co"># Extra CFLAGS for code that will go into a shared library</span></span>
<span id="cb684-11"><a aria-hidden="true" href="#cb684-11" tabindex="-1"></a><span class="va">CFLAGS_SL</span><span class="op">=</span><span class="st">"-fPIC"</span></span>
<span id="cb684-12"><a aria-hidden="true" href="#cb684-12" tabindex="-1"></a></span>
<span id="cb684-13"><a aria-hidden="true" href="#cb684-13" tabindex="-1"></a><span class="co"># If --enable-profiling is specified, we need -DLINUX_PROFILE</span></span>
<span id="cb684-14"><a aria-hidden="true" href="#cb684-14" tabindex="-1"></a><span class="va">PLATFORM_PROFILE_FLAGS</span><span class="op">=</span><span class="st">"-DLINUX_PROFILE"</span></span></code></pre></div>
<h4 data-number="11.2.3.2" id="windows-template-homeuserpostgressrctemplatewin32"><span class="header-section-number">11.2.3.2</span> Windows Template
(/home/user/postgres/src/template/win32)</h4>
<div class="sourceCode" id="cb685"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb685-1"><a aria-hidden="true" href="#cb685-1" tabindex="-1"></a><span class="co"># define before including &lt;time.h&gt; for getting localtime_r() etc. on MinGW</span></span>
<span id="cb685-2"><a aria-hidden="true" href="#cb685-2" tabindex="-1"></a><span class="va">CPPFLAGS</span><span class="op">=</span><span class="st">"</span><span class="va">$CPPFLAGS</span><span class="st"> -D_POSIX_C_SOURCE"</span></span>
<span id="cb685-3"><a aria-hidden="true" href="#cb685-3" tabindex="-1"></a></span>
<span id="cb685-4"><a aria-hidden="true" href="#cb685-4" tabindex="-1"></a><span class="co"># Extra CFLAGS for code that will go into a shared library</span></span>
<span id="cb685-5"><a aria-hidden="true" href="#cb685-5" tabindex="-1"></a><span class="va">CFLAGS_SL</span><span class="op">=</span><span class="st">""</span></span>
<span id="cb685-6"><a aria-hidden="true" href="#cb685-6" tabindex="-1"></a></span>
<span id="cb685-7"><a aria-hidden="true" href="#cb685-7" tabindex="-1"></a><span class="co"># --allow-multiple-definition is required to link pg_dump</span></span>
<span id="cb685-8"><a aria-hidden="true" href="#cb685-8" tabindex="-1"></a><span class="co"># --disable-auto-import is to ensure we get MSVC-like linking behavior</span></span>
<span id="cb685-9"><a aria-hidden="true" href="#cb685-9" tabindex="-1"></a><span class="va">LDFLAGS</span><span class="op">=</span><span class="st">"</span><span class="va">$LDFLAGS</span><span class="st"> -Wl,--allow-multiple-definition -Wl,--disable-auto-import"</span></span>
<span id="cb685-10"><a aria-hidden="true" href="#cb685-10" tabindex="-1"></a></span>
<span id="cb685-11"><a aria-hidden="true" href="#cb685-11" tabindex="-1"></a><span class="va">DLSUFFIX</span><span class="op">=</span><span class="st">".dll"</span></span></code></pre></div>
<h3 data-number="11.2.4" id="top-level-makefile"><span class="header-section-number">11.2.4</span> Top-Level Makefile</h3>
<h4 data-number="11.2.4.1" id="homeuserpostgresgnumakefile.in"><span class="header-section-number">11.2.4.1</span>
/home/user/postgres/GNUmakefile.in</h4>
<p><strong>Lines 1-30: Basic Structure</strong></p>
<div class="sourceCode" id="cb686"><pre class="sourceCode makefile"><code class="sourceCode makefile"><span id="cb686-1"><a aria-hidden="true" href="#cb686-1" tabindex="-1"></a><span class="co"># PostgreSQL top level makefile</span></span>
<span id="cb686-2"><a aria-hidden="true" href="#cb686-2" tabindex="-1"></a><span class="co"># GNUmakefile.in</span></span>
<span id="cb686-3"><a aria-hidden="true" href="#cb686-3" tabindex="-1"></a></span>
<span id="cb686-4"><a aria-hidden="true" href="#cb686-4" tabindex="-1"></a><span class="dt">subdir</span> <span class="ch">=</span></span>
<span id="cb686-5"><a aria-hidden="true" href="#cb686-5" tabindex="-1"></a><span class="dt">top_builddir</span> <span class="ch">=</span><span class="st"> .</span></span>
<span id="cb686-6"><a aria-hidden="true" href="#cb686-6" tabindex="-1"></a><span class="kw">include</span> <span class="ch">$(</span><span class="dt">top_builddir</span><span class="ch">)</span>/src/Makefile.global</span>
<span id="cb686-7"><a aria-hidden="true" href="#cb686-7" tabindex="-1"></a></span>
<span id="cb686-8"><a aria-hidden="true" href="#cb686-8" tabindex="-1"></a><span class="ch">$(</span><span class="kw">call</span><span class="st"> recurse</span><span class="kw">,</span><span class="st">all install</span><span class="kw">,</span><span class="st">src config</span><span class="ch">)</span></span>
<span id="cb686-9"><a aria-hidden="true" href="#cb686-9" tabindex="-1"></a></span>
<span id="cb686-10"><a aria-hidden="true" href="#cb686-10" tabindex="-1"></a><span class="dv">docs:</span></span>
<span id="cb686-11"><a aria-hidden="true" href="#cb686-11" tabindex="-1"></a><span class="er">    </span><span class="ch">$(</span><span class="dt">MAKE</span><span class="ch">)</span> -C doc all</span>
<span id="cb686-12"><a aria-hidden="true" href="#cb686-12" tabindex="-1"></a></span>
<span id="cb686-13"><a aria-hidden="true" href="#cb686-13" tabindex="-1"></a><span class="ch">$(</span><span class="kw">call</span><span class="st"> recurse</span><span class="kw">,</span><span class="st">world</span><span class="kw">,</span><span class="st">doc src config contrib</span><span class="kw">,</span><span class="st">all</span><span class="ch">)</span></span>
<span id="cb686-14"><a aria-hidden="true" href="#cb686-14" tabindex="-1"></a></span>
<span id="cb686-15"><a aria-hidden="true" href="#cb686-15" tabindex="-1"></a><span class="co"># build src/ before contrib/</span></span>
<span id="cb686-16"><a aria-hidden="true" href="#cb686-16" tabindex="-1"></a><span class="dv">world-contrib-recurse:</span><span class="dt"> world-src-recurse</span></span>
<span id="cb686-17"><a aria-hidden="true" href="#cb686-17" tabindex="-1"></a></span>
<span id="cb686-18"><a aria-hidden="true" href="#cb686-18" tabindex="-1"></a><span class="ch">$(</span><span class="kw">call</span><span class="st"> recurse</span><span class="kw">,</span><span class="st">world-bin</span><span class="kw">,</span><span class="st">src config contrib</span><span class="kw">,</span><span class="st">all</span><span class="ch">)</span></span>
<span id="cb686-19"><a aria-hidden="true" href="#cb686-19" tabindex="-1"></a></span>
<span id="cb686-20"><a aria-hidden="true" href="#cb686-20" tabindex="-1"></a><span class="co"># build src/ before contrib/</span></span>
<span id="cb686-21"><a aria-hidden="true" href="#cb686-21" tabindex="-1"></a><span class="dv">world-bin-contrib-recurse:</span><span class="dt"> world-bin-src-recurse</span></span>
<span id="cb686-22"><a aria-hidden="true" href="#cb686-22" tabindex="-1"></a></span>
<span id="cb686-23"><a aria-hidden="true" href="#cb686-23" tabindex="-1"></a><span class="dv">html man:</span></span>
<span id="cb686-24"><a aria-hidden="true" href="#cb686-24" tabindex="-1"></a><span class="er">    </span><span class="ch">$(</span><span class="dt">MAKE</span><span class="ch">)</span> -C doc <span class="ch">$@</span></span>
<span id="cb686-25"><a aria-hidden="true" href="#cb686-25" tabindex="-1"></a></span>
<span id="cb686-26"><a aria-hidden="true" href="#cb686-26" tabindex="-1"></a><span class="dv">install-docs:</span></span>
<span id="cb686-27"><a aria-hidden="true" href="#cb686-27" tabindex="-1"></a><span class="er">    </span><span class="ch">$(</span><span class="dt">MAKE</span><span class="ch">)</span> -C doc install</span></code></pre></div>
<p><strong>Lines 66-75: Testing Targets</strong></p>
<div class="sourceCode" id="cb687"><pre class="sourceCode makefile"><code class="sourceCode makefile"><span id="cb687-1"><a aria-hidden="true" href="#cb687-1" tabindex="-1"></a><span class="dv">check-tests:</span><span class="dt"> | temp-install</span></span>
<span id="cb687-2"><a aria-hidden="true" href="#cb687-2" tabindex="-1"></a><span class="dv">check check-tests installcheck installcheck-parallel installcheck-tests:</span><span class="dt"> CHECKPREP_TOP</span><span class="ch">=</span><span class="st">src/test/regress</span></span>
<span id="cb687-3"><a aria-hidden="true" href="#cb687-3" tabindex="-1"></a><span class="dv">check check-tests installcheck installcheck-parallel installcheck-tests:</span><span class="dt"> submake-generated-headers</span></span>
<span id="cb687-4"><a aria-hidden="true" href="#cb687-4" tabindex="-1"></a><span class="er">    </span><span class="ch">$(</span><span class="dt">MAKE</span><span class="ch">)</span> -C src/test/regress <span class="ch">$@</span></span>
<span id="cb687-5"><a aria-hidden="true" href="#cb687-5" tabindex="-1"></a></span>
<span id="cb687-6"><a aria-hidden="true" href="#cb687-6" tabindex="-1"></a><span class="ch">$(</span><span class="kw">call</span><span class="st"> recurse</span><span class="kw">,</span><span class="st">check-world</span><span class="kw">,</span><span class="st">src/test src/pl src/interfaces contrib src/bin src/tools/pg_bsd_indent</span><span class="kw">,</span><span class="st">check</span><span class="ch">)</span></span>
<span id="cb687-7"><a aria-hidden="true" href="#cb687-7" tabindex="-1"></a><span class="ch">$(</span><span class="kw">call</span><span class="st"> recurse</span><span class="kw">,</span><span class="st">checkprep</span><span class="kw">,</span><span class="st">  src/test src/pl src/interfaces contrib src/bin</span><span class="ch">)</span></span>
<span id="cb687-8"><a aria-hidden="true" href="#cb687-8" tabindex="-1"></a></span>
<span id="cb687-9"><a aria-hidden="true" href="#cb687-9" tabindex="-1"></a><span class="ch">$(</span><span class="kw">call</span><span class="st"> recurse</span><span class="kw">,</span><span class="st">installcheck-world</span><span class="kw">,</span><span class="st">src/test src/pl src/interfaces contrib src/bin</span><span class="kw">,</span><span class="st">installcheck</span><span class="ch">)</span></span>
<span id="cb687-10"><a aria-hidden="true" href="#cb687-10" tabindex="-1"></a><span class="ch">$(</span><span class="kw">call</span><span class="st"> recurse</span><span class="kw">,</span><span class="st">install-tests</span><span class="kw">,</span><span class="st">src/test/regress</span><span class="kw">,</span><span class="st">install-tests</span><span class="ch">)</span></span></code></pre></div>
<h3 data-number="11.2.5" id="global-makefile-configuration"><span class="header-section-number">11.2.5</span> Global Makefile
Configuration</h3>
<h4 data-number="11.2.5.1" id="homeuserpostgressrcmakefile.global.in-lines-1-77"><span class="header-section-number">11.2.5.1</span>
/home/user/postgres/src/Makefile.global.in (Lines 1-77)</h4>
<div class="sourceCode" id="cb688"><pre class="sourceCode makefile"><code class="sourceCode makefile"><span id="cb688-1"><a aria-hidden="true" href="#cb688-1" tabindex="-1"></a><span class="co"># All PostgreSQL makefiles include this file and use the variables it sets</span></span>
<span id="cb688-2"><a aria-hidden="true" href="#cb688-2" tabindex="-1"></a></span>
<span id="cb688-3"><a aria-hidden="true" href="#cb688-3" tabindex="-1"></a><span class="dt">standard_targets</span> <span class="ch">=</span><span class="st"> all install installdirs uninstall clean distclean coverage check checkprep installcheck init-po update-po</span></span>
<span id="cb688-4"><a aria-hidden="true" href="#cb688-4" tabindex="-1"></a><span class="dt">standard_always_targets</span> <span class="ch">=</span><span class="st"> clean distclean</span></span>
<span id="cb688-5"><a aria-hidden="true" href="#cb688-5" tabindex="-1"></a></span>
<span id="cb688-6"><a aria-hidden="true" href="#cb688-6" tabindex="-1"></a><span class="ot">.PHONY:</span><span class="dt"> </span><span class="ch">$(</span><span class="dt">standard_targets</span><span class="ch">)</span><span class="dt"> maintainer-clean install-strip html man installcheck-parallel update-unicode</span></span>
<span id="cb688-7"><a aria-hidden="true" href="#cb688-7" tabindex="-1"></a></span>
<span id="cb688-8"><a aria-hidden="true" href="#cb688-8" tabindex="-1"></a><span class="co"># make `all' the default target</span></span>
<span id="cb688-9"><a aria-hidden="true" href="#cb688-9" tabindex="-1"></a><span class="dv">all:</span></span>
<span id="cb688-10"><a aria-hidden="true" href="#cb688-10" tabindex="-1"></a></span>
<span id="cb688-11"><a aria-hidden="true" href="#cb688-11" tabindex="-1"></a><span class="co"># Delete target files if the command fails</span></span>
<span id="cb688-12"><a aria-hidden="true" href="#cb688-12" tabindex="-1"></a><span class="ot">.DELETE_ON_ERROR:</span></span>
<span id="cb688-13"><a aria-hidden="true" href="#cb688-13" tabindex="-1"></a></span>
<span id="cb688-14"><a aria-hidden="true" href="#cb688-14" tabindex="-1"></a><span class="co"># Never delete any intermediate files automatically</span></span>
<span id="cb688-15"><a aria-hidden="true" href="#cb688-15" tabindex="-1"></a><span class="ot">.SECONDARY:</span></span>
<span id="cb688-16"><a aria-hidden="true" href="#cb688-16" tabindex="-1"></a></span>
<span id="cb688-17"><a aria-hidden="true" href="#cb688-17" tabindex="-1"></a><span class="co"># PostgreSQL version number</span></span>
<span id="cb688-18"><a aria-hidden="true" href="#cb688-18" tabindex="-1"></a><span class="dt">VERSION</span> <span class="ch">=</span><span class="st"> </span><span class="fl">@PACKAGE_VERSION@</span></span>
<span id="cb688-19"><a aria-hidden="true" href="#cb688-19" tabindex="-1"></a><span class="dt">MAJORVERSION</span> <span class="ch">=</span><span class="st"> </span><span class="fl">@PG_MAJORVERSION@</span></span>
<span id="cb688-20"><a aria-hidden="true" href="#cb688-20" tabindex="-1"></a><span class="dt">VERSION_NUM</span> <span class="ch">=</span><span class="st"> </span><span class="fl">@PG_VERSION_NUM@</span></span>
<span id="cb688-21"><a aria-hidden="true" href="#cb688-21" tabindex="-1"></a></span>
<span id="cb688-22"><a aria-hidden="true" href="#cb688-22" tabindex="-1"></a><span class="co"># VPATH build support</span></span>
<span id="cb688-23"><a aria-hidden="true" href="#cb688-23" tabindex="-1"></a><span class="dt">vpath_build</span> <span class="ch">=</span><span class="st"> </span><span class="fl">@vpath_build@</span></span>
<span id="cb688-24"><a aria-hidden="true" href="#cb688-24" tabindex="-1"></a><span class="dt">abs_top_builddir</span> <span class="ch">=</span><span class="st"> </span><span class="fl">@abs_top_builddir@</span></span>
<span id="cb688-25"><a aria-hidden="true" href="#cb688-25" tabindex="-1"></a><span class="dt">abs_top_srcdir</span> <span class="ch">=</span><span class="st"> </span><span class="fl">@abs_top_srcdir@</span></span>
<span id="cb688-26"><a aria-hidden="true" href="#cb688-26" tabindex="-1"></a></span>
<span id="cb688-27"><a aria-hidden="true" href="#cb688-27" tabindex="-1"></a><span class="cf">ifneq</span> (<span class="ch">$(</span><span class="dt">vpath_build</span><span class="ch">)</span>,yes)</span>
<span id="cb688-28"><a aria-hidden="true" href="#cb688-28" tabindex="-1"></a><span class="dt">top_srcdir</span> <span class="ch">=</span><span class="st"> </span><span class="ch">$(</span><span class="dt">top_builddir</span><span class="ch">)</span></span>
<span id="cb688-29"><a aria-hidden="true" href="#cb688-29" tabindex="-1"></a><span class="dt">srcdir</span> <span class="ch">=</span><span class="st"> .</span></span>
<span id="cb688-30"><a aria-hidden="true" href="#cb688-30" tabindex="-1"></a><span class="cf">else</span> <span class="co"># vpath_build = yes</span></span>
<span id="cb688-31"><a aria-hidden="true" href="#cb688-31" tabindex="-1"></a><span class="dt">top_srcdir</span> <span class="ch">=</span><span class="st"> </span><span class="ch">$(</span><span class="dt">abs_top_srcdir</span><span class="ch">)</span></span>
<span id="cb688-32"><a aria-hidden="true" href="#cb688-32" tabindex="-1"></a><span class="dt">srcdir</span> <span class="ch">=</span><span class="st"> </span><span class="ch">$(</span><span class="dt">top_srcdir</span><span class="ch">)</span><span class="st">/</span><span class="ch">$(</span><span class="dt">subdir</span><span class="ch">)</span></span>
<span id="cb688-33"><a aria-hidden="true" href="#cb688-33" tabindex="-1"></a><span class="dt">VPATH</span> <span class="ch">=</span><span class="st"> </span><span class="ch">$(</span><span class="dt">srcdir</span><span class="ch">)</span></span>
<span id="cb688-34"><a aria-hidden="true" href="#cb688-34" tabindex="-1"></a><span class="cf">endif</span></span></code></pre></div>
<h3 data-number="11.2.6" id="build-process-flow"><span class="header-section-number">11.2.6</span> Build Process Flow</h3>
<pre><code>1. ./configure
   ‚îú‚îÄ‚îÄ Detects system characteristics
   ‚îú‚îÄ‚îÄ Selects platform template
   ‚îú‚îÄ‚îÄ Tests for libraries/functions
   ‚îú‚îÄ‚îÄ Generates config.status
   ‚îî‚îÄ‚îÄ Creates GNUmakefile and src/Makefile.global

2. make (or make all)
   ‚îú‚îÄ‚îÄ Builds src/port (portability layer)
   ‚îú‚îÄ‚îÄ Builds src/common (shared code)
   ‚îú‚îÄ‚îÄ Builds src/backend (server)
   ‚îú‚îÄ‚îÄ Builds src/bin (client tools)
   ‚îî‚îÄ‚îÄ Builds src/interfaces (libpq)

3. make check
   ‚îú‚îÄ‚îÄ Builds test infrastructure
   ‚îú‚îÄ‚îÄ Initializes temporary database
   ‚îú‚îÄ‚îÄ Runs regression tests
   ‚îî‚îÄ‚îÄ Reports results

4. make install
   ‚îú‚îÄ‚îÄ Installs binaries to $(bindir)
   ‚îú‚îÄ‚îÄ Installs libraries to $(libdir)
   ‚îú‚îÄ‚îÄ Installs headers to $(includedir)
   ‚îî‚îÄ‚îÄ Installs data files to $(datadir)</code></pre>
<hr/>
<h2 data-number="11.3" id="meson-build-system"><span class="header-section-number">11.3</span> 2. Meson Build System</h2>
<h3 data-number="11.3.1" id="overview-17"><span class="header-section-number">11.3.1</span> Overview</h3>
<p>PostgreSQL introduced Meson as a modern alternative build system,
offering faster configuration and better cross-platform support.</p>
<h3 data-number="11.3.2" id="main-configuration-file"><span class="header-section-number">11.3.2</span> Main Configuration File</h3>
<h4 data-number="11.3.2.1" id="homeuserpostgresmeson.build-lines-1-200"><span class="header-section-number">11.3.2.1</span>
/home/user/postgres/meson.build (Lines 1-200)</h4>
<pre class="meson"><code># Entry point for building PostgreSQL with meson

project('postgresql',
  ['c'],
  version: '19devel',
  license: 'PostgreSQL',
  
  # Meson 0.57.2 minimum
  meson_version: '&gt;=0.57.2',
  default_options: [
    'warning_level=1',      # -Wall equivalent
    'b_pch=false',
    'buildtype=debugoptimized',  # -O2 + debug
    'prefix=/usr/local/pgsql',
  ]
)

###############################################################
# Basic prep
###############################################################

fs = import('fs')
pkgconfig = import('pkgconfig')

host_system = host_machine.system()
build_system = build_machine.system()
host_cpu = host_machine.cpu_family()

cc = meson.get_compiler('c')

not_found_dep = dependency('', required: false)
thread_dep = dependency('threads')
auto_features = get_option('auto_features')

###############################################################
# Safety first
###############################################################

# Refuse to build if source directory contains in-place build
errmsg_nonclean_base = '''
****
Non-clean source code directory detected.

To build with meson the source tree may not have an in-place, ./configure
style, build configured. You can have both meson and ./configure style builds
for the same source tree by building out-of-source / VPATH with
configure. Alternatively use a separate check out for meson based builds.
****'''

if fs.exists(meson.current_source_dir() / 'src' / 'include' / 'pg_config.h')
  errmsg_cleanup = 'To clean up, run make distclean in the source tree.'
  error(errmsg_nonclean_base.format(errmsg_cleanup))
endif

###############################################################
# Version and metadata
###############################################################

pg_version = meson.project_version()

if pg_version.endswith('devel')
  pg_version_arr = [pg_version.split('devel')[0], '0']
elif pg_version.contains('beta')
  pg_version_arr = [pg_version.split('beta')[0], '0']
elif pg_version.contains('rc')
  pg_version_arr = [pg_version.split('rc')[0], '0']
else
  pg_version_arr = pg_version.split('.')
endif

pg_version_major = pg_version_arr[0].to_int()
pg_version_minor = pg_version_arr[1].to_int()
pg_version_num = (pg_version_major * 10000) + pg_version_minor

cdata.set_quoted('PACKAGE_NAME', 'PostgreSQL')
cdata.set_quoted('PACKAGE_VERSION', pg_version)
cdata.set('PG_MAJORVERSION_NUM', pg_version_major)
cdata.set('PG_MINORVERSION_NUM', pg_version_minor)
cdata.set('PG_VERSION_NUM', pg_version_num)

###############################################################
# Platform-specific configuration
###############################################################

exesuffix = ''  # overridden below where necessary
dlsuffix = '.so'  # overridden below where necessary
library_path_var = 'LD_LIBRARY_PATH'

# Format of file to control exports from libraries
export_file_format = 'gnu'
export_file_suffix = 'list'
export_fmt = '-Wl,--version-script=@0@'

# Flags to add when linking a postgres extension
mod_link_args_fmt = []

memset_loop_limit = 1024

# Choice of shared memory and semaphore implementation
shmem_kind = 'sysv'
sema_kind = 'sysv'

# Map similar operating systems
if host_system == 'dragonfly'
  host_system = 'netbsd'
elif host_system == 'android'
  host_system = 'linux'
endif

portname = host_system</code></pre>
<h3 data-number="11.3.3" id="build-options"><span class="header-section-number">11.3.3</span> Build Options</h3>
<h4 data-number="11.3.3.1" id="homeuserpostgresmeson_options.txt"><span class="header-section-number">11.3.3.1</span>
/home/user/postgres/meson_options.txt</h4>
<pre class="meson"><code># Data layout influencing options
option('blocksize', type: 'combo',
  choices: ['1', '2', '4', '8', '16', '32'],
  value: '8',
  description: 'Relation block size, in kilobytes')

option('wal_blocksize', type: 'combo',
  choices: ['1', '2', '4', '8', '16', '32', '64'],
  value: '8',
  description: 'WAL block size, in kilobytes')

option('segsize', type: 'integer', value: 1,
  description: 'Segment size, in gigabytes')

# Developer options
option('cassert', type: 'boolean', value: false,
  description: 'Enable assertion checks (for debugging)')

option('tap_tests', type: 'feature', value: 'auto',
  description: 'Enable TAP tests')

# External dependencies
option('icu', type: 'feature', value: 'auto',
  description: 'ICU support')

option('ssl', type: 'combo', choices: ['auto', 'none', 'openssl'],
  value: 'auto',
  description: 'Use LIB for SSL/TLS support (openssl)')

option('zlib', type: 'feature', value: 'auto',
  description: 'Enable zlib')</code></pre>
<h3 data-number="11.3.4" id="backend-build-configuration"><span class="header-section-number">11.3.4</span> Backend Build
Configuration</h3>
<h4 data-number="11.3.4.1" id="homeuserpostgressrcbackendmeson.build-lines-1-150"><span class="header-section-number">11.3.4.1</span>
/home/user/postgres/src/backend/meson.build (Lines 1-150)</h4>
<pre class="meson"><code># Backend build configuration

backend_build_deps = [backend_code]
backend_sources = []
backend_link_with = [pgport_srv, common_srv]

generated_backend_sources = []
post_export_backend_sources = []

# Include all subdirectories
subdir('access')
subdir('archive')
subdir('bootstrap')
subdir('catalog')
subdir('commands')
subdir('executor')
# ... more subdirs ...

backend_link_args = []
backend_link_depends = []

# Build static library with all objects first
postgres_lib = static_library('postgres_lib',
  backend_sources + timezone_sources + generated_backend_sources,
  link_whole: backend_link_with,
  dependencies: backend_build_deps,
  c_pch: pch_postgres_h,
  kwargs: internal_lib_args,
)

# On MSVC, generate export definitions
if cc.get_id() == 'msvc'
  postgres_def = custom_target('postgres.def',
    command: [perl, files('../tools/msvc_gendef.pl'),
              '--arch', host_cpu,
              '--tempdir', '@PRIVATE_DIR@',
              '--deffile', '@OUTPUT@',
              '@INPUT@'],
    input: [postgres_lib, common_srv, pgport_srv],
    output: 'postgres.def',
    install: false,
  )
  
  backend_link_args += '/DEF:@0@'.format(postgres_def.full_path())
  backend_link_depends += postgres_def
endif

# DTrace probe support
if dtrace.found() and host_system != 'darwin'
  backend_input += custom_target(
    'probes.o',
    input: ['utils/probes.d', postgres_lib.extract_objects(backend_sources)],
    output: 'probes.o',
    command: [dtrace, '-C', '-G', '-o', '@OUTPUT@', '-s', '@INPUT@'],
  )
endif

# Build final postgres executable
postgres = executable('postgres',
  backend_input,
  sources: post_export_backend_sources,
  objects: backend_objs,
  link_args: backend_link_args,
  link_with: backend_link_with,
  link_depends: backend_link_depends,
  export_dynamic: true,
  implib: 'postgres',
  dependencies: backend_build_deps,
  kwargs: default_bin_args,
)</code></pre>
<h3 data-number="11.3.5" id="meson-build-process-flow"><span class="header-section-number">11.3.5</span> Meson Build Process
Flow</h3>
<pre><code>1. meson setup builddir
   ‚îú‚îÄ‚îÄ Detects compilers and tools
   ‚îú‚îÄ‚îÄ Tests system capabilities
   ‚îú‚îÄ‚îÄ Generates build.ninja
   ‚îî‚îÄ‚îÄ Creates compile_commands.json

2. meson compile -C builddir
   ‚îú‚îÄ‚îÄ Builds in parallel by default
   ‚îú‚îÄ‚îÄ Uses ninja backend
   ‚îú‚îÄ‚îÄ Tracks dependencies automatically
   ‚îî‚îÄ‚îÄ Rebuilds only what changed

3. meson test -C builddir
   ‚îú‚îÄ‚îÄ Runs all defined tests
   ‚îú‚îÄ‚îÄ Supports parallel test execution
   ‚îî‚îÄ‚îÄ Provides detailed test output

4. meson install -C builddir
   ‚îú‚îÄ‚îÄ Installs to configured prefix
   ‚îî‚îÄ‚îÄ Supports DESTDIR staging</code></pre>
<hr/>
<h2 data-number="11.4" id="portability-layer-srcport"><span class="header-section-number">11.4</span> 3. Portability Layer
(src/port/)</h2>
<h3 data-number="11.4.1" id="overview-18"><span class="header-section-number">11.4.1</span> Overview</h3>
<p>The portability layer (<code>libpgport</code>) provides
implementations of functions that may be missing or broken on various
platforms.</p>
<h3 data-number="11.4.2" id="purpose-and-architecture"><span class="header-section-number">11.4.2</span> Purpose and
Architecture</h3>
<h4 data-number="11.4.2.1" id="homeuserpostgressrcportreadme"><span class="header-section-number">11.4.2.1</span>
/home/user/postgres/src/port/README</h4>
<pre><code>libpgport
=========

libpgport must have special behavior. It supplies functions to both
libraries and applications. However, there are two complexities:

1) Libraries need to use object files that are compiled with exactly
   the same flags as the library. libpgport might not use the same flags,
   so it is necessary to recompile the object files for individual
   libraries.

2) For applications, we use -lpgport before -lpq, so the static files
   from libpgport are linked first. This avoids having applications
   dependent on symbols that are _used_ by libpq, but not intended to be
   exported by libpq.</code></pre>
<h3 data-number="11.4.3" id="key-portability-functions"><span class="header-section-number">11.4.3</span> Key Portability
Functions</h3>
<h4 data-number="11.4.3.1" id="random-number-generation"><span class="header-section-number">11.4.3.1</span> Random Number
Generation</h4>
<p><strong>/home/user/postgres/src/port/pg_strong_random.c (Lines
1-100)</strong></p>
<div class="sourceCode" id="cb695"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb695-1"><a aria-hidden="true" href="#cb695-1" tabindex="-1"></a><span class="co">/*</span></span>
<span id="cb695-2"><a aria-hidden="true" href="#cb695-2" tabindex="-1"></a><span class="co"> * pg_strong_random.c</span></span>
<span id="cb695-3"><a aria-hidden="true" href="#cb695-3" tabindex="-1"></a><span class="co"> *   generate a cryptographically secure random number</span></span>
<span id="cb695-4"><a aria-hidden="true" href="#cb695-4" tabindex="-1"></a><span class="co"> *</span></span>
<span id="cb695-5"><a aria-hidden="true" href="#cb695-5" tabindex="-1"></a><span class="co"> * Our definition of "strong" is that it's suitable for generating random</span></span>
<span id="cb695-6"><a aria-hidden="true" href="#cb695-6" tabindex="-1"></a><span class="co"> * salts and query cancellation keys, during authentication.</span></span>
<span id="cb695-7"><a aria-hidden="true" href="#cb695-7" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb695-8"><a aria-hidden="true" href="#cb695-8" tabindex="-1"></a></span>
<span id="cb695-9"><a aria-hidden="true" href="#cb695-9" tabindex="-1"></a><span class="co">/*</span></span>
<span id="cb695-10"><a aria-hidden="true" href="#cb695-10" tabindex="-1"></a><span class="co"> * We support a number of sources:</span></span>
<span id="cb695-11"><a aria-hidden="true" href="#cb695-11" tabindex="-1"></a><span class="co"> * 1. OpenSSL's RAND_bytes()</span></span>
<span id="cb695-12"><a aria-hidden="true" href="#cb695-12" tabindex="-1"></a><span class="co"> * 2. Windows' CryptGenRandom() function</span></span>
<span id="cb695-13"><a aria-hidden="true" href="#cb695-13" tabindex="-1"></a><span class="co"> * 3. /dev/urandom</span></span>
<span id="cb695-14"><a aria-hidden="true" href="#cb695-14" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb695-15"><a aria-hidden="true" href="#cb695-15" tabindex="-1"></a></span>
<span id="cb695-16"><a aria-hidden="true" href="#cb695-16" tabindex="-1"></a><span class="pp">#ifdef USE_OPENSSL</span></span>
<span id="cb695-17"><a aria-hidden="true" href="#cb695-17" tabindex="-1"></a></span>
<span id="cb695-18"><a aria-hidden="true" href="#cb695-18" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;openssl/rand.h&gt;</span></span>
<span id="cb695-19"><a aria-hidden="true" href="#cb695-19" tabindex="-1"></a></span>
<span id="cb695-20"><a aria-hidden="true" href="#cb695-20" tabindex="-1"></a><span class="dt">void</span></span>
<span id="cb695-21"><a aria-hidden="true" href="#cb695-21" tabindex="-1"></a>pg_strong_random_init<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb695-22"><a aria-hidden="true" href="#cb695-22" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb695-23"><a aria-hidden="true" href="#cb695-23" tabindex="-1"></a>    <span class="co">/* No initialization needed */</span></span>
<span id="cb695-24"><a aria-hidden="true" href="#cb695-24" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb695-25"><a aria-hidden="true" href="#cb695-25" tabindex="-1"></a></span>
<span id="cb695-26"><a aria-hidden="true" href="#cb695-26" tabindex="-1"></a><span class="dt">bool</span></span>
<span id="cb695-27"><a aria-hidden="true" href="#cb695-27" tabindex="-1"></a>pg_strong_random<span class="op">(</span><span class="dt">void</span> <span class="op">*</span>buf<span class="op">,</span> <span class="dt">size_t</span> len<span class="op">)</span></span>
<span id="cb695-28"><a aria-hidden="true" href="#cb695-28" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb695-29"><a aria-hidden="true" href="#cb695-29" tabindex="-1"></a>    <span class="dt">int</span> i<span class="op">;</span></span>
<span id="cb695-30"><a aria-hidden="true" href="#cb695-30" tabindex="-1"></a>    </span>
<span id="cb695-31"><a aria-hidden="true" href="#cb695-31" tabindex="-1"></a>    <span class="co">/*</span></span>
<span id="cb695-32"><a aria-hidden="true" href="#cb695-32" tabindex="-1"></a><span class="co">     * Check that OpenSSL's CSPRNG has been sufficiently seeded, and if not</span></span>
<span id="cb695-33"><a aria-hidden="true" href="#cb695-33" tabindex="-1"></a><span class="co">     * add more seed data using RAND_poll().</span></span>
<span id="cb695-34"><a aria-hidden="true" href="#cb695-34" tabindex="-1"></a><span class="co">     */</span></span>
<span id="cb695-35"><a aria-hidden="true" href="#cb695-35" tabindex="-1"></a>    <span class="pp">#define NUM_RAND_POLL_RETRIES </span><span class="dv">8</span></span>
<span id="cb695-36"><a aria-hidden="true" href="#cb695-36" tabindex="-1"></a>    </span>
<span id="cb695-37"><a aria-hidden="true" href="#cb695-37" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span>i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> NUM_RAND_POLL_RETRIES<span class="op">;</span> i<span class="op">++)</span></span>
<span id="cb695-38"><a aria-hidden="true" href="#cb695-38" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb695-39"><a aria-hidden="true" href="#cb695-39" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>RAND_status<span class="op">()</span> <span class="op">==</span> <span class="dv">1</span><span class="op">)</span></span>
<span id="cb695-40"><a aria-hidden="true" href="#cb695-40" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb695-41"><a aria-hidden="true" href="#cb695-41" tabindex="-1"></a>            <span class="co">/* The CSPRNG is sufficiently seeded */</span></span>
<span id="cb695-42"><a aria-hidden="true" href="#cb695-42" tabindex="-1"></a>            <span class="cf">break</span><span class="op">;</span></span>
<span id="cb695-43"><a aria-hidden="true" href="#cb695-43" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb695-44"><a aria-hidden="true" href="#cb695-44" tabindex="-1"></a>        </span>
<span id="cb695-45"><a aria-hidden="true" href="#cb695-45" tabindex="-1"></a>        RAND_poll<span class="op">();</span></span>
<span id="cb695-46"><a aria-hidden="true" href="#cb695-46" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb695-47"><a aria-hidden="true" href="#cb695-47" tabindex="-1"></a>    </span>
<span id="cb695-48"><a aria-hidden="true" href="#cb695-48" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>RAND_bytes<span class="op">(</span>buf<span class="op">,</span> len<span class="op">)</span> <span class="op">==</span> <span class="dv">1</span><span class="op">)</span></span>
<span id="cb695-49"><a aria-hidden="true" href="#cb695-49" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb695-50"><a aria-hidden="true" href="#cb695-50" tabindex="-1"></a>    <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb695-51"><a aria-hidden="true" href="#cb695-51" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb695-52"><a aria-hidden="true" href="#cb695-52" tabindex="-1"></a></span>
<span id="cb695-53"><a aria-hidden="true" href="#cb695-53" tabindex="-1"></a><span class="pp">#elif WIN32</span></span>
<span id="cb695-54"><a aria-hidden="true" href="#cb695-54" tabindex="-1"></a></span>
<span id="cb695-55"><a aria-hidden="true" href="#cb695-55" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;wincrypt.h&gt;</span></span>
<span id="cb695-56"><a aria-hidden="true" href="#cb695-56" tabindex="-1"></a></span>
<span id="cb695-57"><a aria-hidden="true" href="#cb695-57" tabindex="-1"></a><span class="co">/* Windows implementation using CryptGenRandom */</span></span>
<span id="cb695-58"><a aria-hidden="true" href="#cb695-58" tabindex="-1"></a><span class="co">/* ... */</span></span>
<span id="cb695-59"><a aria-hidden="true" href="#cb695-59" tabindex="-1"></a></span>
<span id="cb695-60"><a aria-hidden="true" href="#cb695-60" tabindex="-1"></a><span class="pp">#else </span><span class="co">/* !USE_OPENSSL &amp;&amp; !WIN32 */</span></span>
<span id="cb695-61"><a aria-hidden="true" href="#cb695-61" tabindex="-1"></a></span>
<span id="cb695-62"><a aria-hidden="true" href="#cb695-62" tabindex="-1"></a><span class="co">/* Unix implementation using /dev/urandom */</span></span>
<span id="cb695-63"><a aria-hidden="true" href="#cb695-63" tabindex="-1"></a><span class="co">/* ... */</span></span>
<span id="cb695-64"><a aria-hidden="true" href="#cb695-64" tabindex="-1"></a></span>
<span id="cb695-65"><a aria-hidden="true" href="#cb695-65" tabindex="-1"></a><span class="pp">#endif</span></span></code></pre></div>
<h4 data-number="11.4.3.2" id="windows-stat-implementation"><span class="header-section-number">11.4.3.2</span> Windows Stat
Implementation</h4>
<p><strong>/home/user/postgres/src/port/win32stat.c (Lines
1-80)</strong></p>
<div class="sourceCode" id="cb696"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb696-1"><a aria-hidden="true" href="#cb696-1" tabindex="-1"></a><span class="co">/*</span></span>
<span id="cb696-2"><a aria-hidden="true" href="#cb696-2" tabindex="-1"></a><span class="co"> * win32stat.c</span></span>
<span id="cb696-3"><a aria-hidden="true" href="#cb696-3" tabindex="-1"></a><span class="co"> *   Replacements for &lt;sys/stat.h&gt; functions using GetFileInformationByHandle</span></span>
<span id="cb696-4"><a aria-hidden="true" href="#cb696-4" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb696-5"><a aria-hidden="true" href="#cb696-5" tabindex="-1"></a></span>
<span id="cb696-6"><a aria-hidden="true" href="#cb696-6" tabindex="-1"></a><span class="pp">#include </span><span class="im">"c.h"</span></span>
<span id="cb696-7"><a aria-hidden="true" href="#cb696-7" tabindex="-1"></a><span class="pp">#include </span><span class="im">"port/win32ntdll.h"</span></span>
<span id="cb696-8"><a aria-hidden="true" href="#cb696-8" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;windows.h&gt;</span></span>
<span id="cb696-9"><a aria-hidden="true" href="#cb696-9" tabindex="-1"></a></span>
<span id="cb696-10"><a aria-hidden="true" href="#cb696-10" tabindex="-1"></a><span class="co">/*</span></span>
<span id="cb696-11"><a aria-hidden="true" href="#cb696-11" tabindex="-1"></a><span class="co"> * Convert a FILETIME struct into a 64 bit time_t.</span></span>
<span id="cb696-12"><a aria-hidden="true" href="#cb696-12" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb696-13"><a aria-hidden="true" href="#cb696-13" tabindex="-1"></a><span class="dt">static</span> __time64_t</span>
<span id="cb696-14"><a aria-hidden="true" href="#cb696-14" tabindex="-1"></a>filetime_to_time<span class="op">(</span><span class="dt">const</span> FILETIME <span class="op">*</span>ft<span class="op">)</span></span>
<span id="cb696-15"><a aria-hidden="true" href="#cb696-15" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb696-16"><a aria-hidden="true" href="#cb696-16" tabindex="-1"></a>    ULARGE_INTEGER unified_ft <span class="op">=</span> <span class="op">{</span><span class="dv">0</span><span class="op">};</span></span>
<span id="cb696-17"><a aria-hidden="true" href="#cb696-17" tabindex="-1"></a>    <span class="dt">static</span> <span class="dt">const</span> uint64 EpochShift <span class="op">=</span> UINT64CONST<span class="op">(</span><span class="dv">116444736000000000</span><span class="op">);</span></span>
<span id="cb696-18"><a aria-hidden="true" href="#cb696-18" tabindex="-1"></a>    </span>
<span id="cb696-19"><a aria-hidden="true" href="#cb696-19" tabindex="-1"></a>    unified_ft<span class="op">.</span>LowPart <span class="op">=</span> ft<span class="op">-&gt;</span>dwLowDateTime<span class="op">;</span></span>
<span id="cb696-20"><a aria-hidden="true" href="#cb696-20" tabindex="-1"></a>    unified_ft<span class="op">.</span>HighPart <span class="op">=</span> ft<span class="op">-&gt;</span>dwHighDateTime<span class="op">;</span></span>
<span id="cb696-21"><a aria-hidden="true" href="#cb696-21" tabindex="-1"></a>    </span>
<span id="cb696-22"><a aria-hidden="true" href="#cb696-22" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>unified_ft<span class="op">.</span>QuadPart <span class="op">&lt;</span> EpochShift<span class="op">)</span></span>
<span id="cb696-23"><a aria-hidden="true" href="#cb696-23" tabindex="-1"></a>        <span class="cf">return</span> <span class="op">-</span><span class="dv">1</span><span class="op">;</span></span>
<span id="cb696-24"><a aria-hidden="true" href="#cb696-24" tabindex="-1"></a>    </span>
<span id="cb696-25"><a aria-hidden="true" href="#cb696-25" tabindex="-1"></a>    unified_ft<span class="op">.</span>QuadPart <span class="op">-=</span> EpochShift<span class="op">;</span></span>
<span id="cb696-26"><a aria-hidden="true" href="#cb696-26" tabindex="-1"></a>    unified_ft<span class="op">.</span>QuadPart <span class="op">/=</span> <span class="dv">10</span> <span class="op">*</span> <span class="dv">1000</span> <span class="op">*</span> <span class="dv">1000</span><span class="op">;</span></span>
<span id="cb696-27"><a aria-hidden="true" href="#cb696-27" tabindex="-1"></a>    </span>
<span id="cb696-28"><a aria-hidden="true" href="#cb696-28" tabindex="-1"></a>    <span class="cf">return</span> unified_ft<span class="op">.</span>QuadPart<span class="op">;</span></span>
<span id="cb696-29"><a aria-hidden="true" href="#cb696-29" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb696-30"><a aria-hidden="true" href="#cb696-30" tabindex="-1"></a></span>
<span id="cb696-31"><a aria-hidden="true" href="#cb696-31" tabindex="-1"></a><span class="co">/*</span></span>
<span id="cb696-32"><a aria-hidden="true" href="#cb696-32" tabindex="-1"></a><span class="co"> * Convert WIN32 file attributes to a Unix-style mode.</span></span>
<span id="cb696-33"><a aria-hidden="true" href="#cb696-33" tabindex="-1"></a><span class="co"> * Only owner permissions are set.</span></span>
<span id="cb696-34"><a aria-hidden="true" href="#cb696-34" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb696-35"><a aria-hidden="true" href="#cb696-35" tabindex="-1"></a><span class="dt">static</span> <span class="dt">unsigned</span> <span class="dt">short</span></span>
<span id="cb696-36"><a aria-hidden="true" href="#cb696-36" tabindex="-1"></a>fileattr_to_unixmode<span class="op">(</span><span class="dt">int</span> attr<span class="op">)</span></span>
<span id="cb696-37"><a aria-hidden="true" href="#cb696-37" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb696-38"><a aria-hidden="true" href="#cb696-38" tabindex="-1"></a>    <span class="dt">unsigned</span> <span class="dt">short</span> uxmode <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb696-39"><a aria-hidden="true" href="#cb696-39" tabindex="-1"></a>    </span>
<span id="cb696-40"><a aria-hidden="true" href="#cb696-40" tabindex="-1"></a>    uxmode <span class="op">|=</span> <span class="op">(</span><span class="dt">unsigned</span> <span class="dt">short</span><span class="op">)</span> <span class="op">((</span>attr <span class="op">&amp;</span> FILE_ATTRIBUTE_DIRECTORY<span class="op">)</span> <span class="op">?</span></span>
<span id="cb696-41"><a aria-hidden="true" href="#cb696-41" tabindex="-1"></a>                                <span class="op">(</span>_S_IFDIR<span class="op">)</span> <span class="op">:</span> <span class="op">(</span>_S_IFREG<span class="op">));</span></span>
<span id="cb696-42"><a aria-hidden="true" href="#cb696-42" tabindex="-1"></a>    </span>
<span id="cb696-43"><a aria-hidden="true" href="#cb696-43" tabindex="-1"></a>    uxmode <span class="op">|=</span> <span class="op">(</span><span class="dt">unsigned</span> <span class="dt">short</span><span class="op">)</span> <span class="op">((</span>attr <span class="op">&amp;</span> FILE_ATTRIBUTE_READONLY<span class="op">)</span> <span class="op">?</span></span>
<span id="cb696-44"><a aria-hidden="true" href="#cb696-44" tabindex="-1"></a>                                <span class="op">(</span>_S_IREAD<span class="op">)</span> <span class="op">:</span> <span class="op">(</span>_S_IREAD <span class="op">|</span> _S_IWRITE<span class="op">));</span></span>
<span id="cb696-45"><a aria-hidden="true" href="#cb696-45" tabindex="-1"></a>    </span>
<span id="cb696-46"><a aria-hidden="true" href="#cb696-46" tabindex="-1"></a>    <span class="co">/* there is no need to simulate _S_IEXEC using CMD's PATHEXT extensions */</span></span>
<span id="cb696-47"><a aria-hidden="true" href="#cb696-47" tabindex="-1"></a>    uxmode <span class="op">|=</span> _S_IEXEC<span class="op">;</span></span>
<span id="cb696-48"><a aria-hidden="true" href="#cb696-48" tabindex="-1"></a>    </span>
<span id="cb696-49"><a aria-hidden="true" href="#cb696-49" tabindex="-1"></a>    <span class="cf">return</span> uxmode<span class="op">;</span></span>
<span id="cb696-50"><a aria-hidden="true" href="#cb696-50" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 data-number="11.4.4" id="meson-build-configuration"><span class="header-section-number">11.4.4</span> Meson Build
Configuration</h3>
<h4 data-number="11.4.4.1" id="homeuserpostgressrcportmeson.build"><span class="header-section-number">11.4.4.1</span>
/home/user/postgres/src/port/meson.build</h4>
<pre class="meson"><code># Portability layer build configuration

pgport_sources = [
  'bsearch_arg.c',
  'chklocale.c',
  'inet_net_ntop.c',
  'noblock.c',
  'path.c',
  'pg_bitutils.c',
  'pg_strong_random.c',
  'pgcheckdir.c',
  'pqsignal.c',
  'qsort.c',
  # ... more files
]

# Platform-specific sources
if host_system == 'windows'
  pgport_sources += files(
    'dirmod.c',
    'kill.c',
    'open.c',
    'win32common.c',
    'win32error.c',
    'win32stat.c',
    # ... more Windows-specific files
  )
endif

# Replacement functions (only build if not present)
replace_funcs_neg = [
  ['explicit_bzero'],
  ['getopt'],
  ['getopt_long'],
  ['strlcat'],
  ['strlcpy'],
  ['strnlen'],
]

foreach f : replace_funcs_neg
  func = f.get(0)
  varname = 'HAVE_@0@'.format(func.to_upper())
  filename = '@0@.c'.format(func)
  
  val = '@0@'.format(cdata.get(varname, 'false'))
  if val == 'false' or val == '0'
    pgport_sources += files(filename)
  endif
endforeach

# Platform-optimized CRC32C implementations
replace_funcs_pos = [
  ['pg_crc32c_sse42', 'USE_SSE42_CRC32C'],
  ['pg_crc32c_armv8', 'USE_ARMV8_CRC32C'],
  ['pg_crc32c_sb8', 'USE_SLICING_BY_8_CRC32C'],
]

# Build three variants: backend, frontend, and shared library
pgport_variants = {
  '_srv': internal_lib_args + {
    'dependencies': [backend_port_code],
  },
  '': default_lib_args + {
    'dependencies': [frontend_port_code],
  },
  '_shlib': default_lib_args + {
    'pic': true,
    'dependencies': [frontend_port_code],
  },
}

foreach name, opts : pgport_variants
  lib = static_library('libpgport@0@'.format(name),
      pgport_sources,
      kwargs: opts + {
        'dependencies': opts['dependencies'] + [ssl],
      }
    )
  pgport += {name: lib}
endforeach</code></pre>
<hr/>
<h2 data-number="11.5" id="platform-specific-code"><span class="header-section-number">11.5</span> 4. Platform-Specific Code</h2>
<h3 data-number="11.5.1" id="platform-headers"><span class="header-section-number">11.5.1</span> Platform Headers</h3>
<h4 data-number="11.5.1.1" id="linux-platform-header"><span class="header-section-number">11.5.1.1</span> Linux Platform Header</h4>
<p><strong>/home/user/postgres/src/include/port/linux.h</strong></p>
<div class="sourceCode" id="cb698"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb698-1"><a aria-hidden="true" href="#cb698-1" tabindex="-1"></a><span class="co">/* src/include/port/linux.h */</span></span>
<span id="cb698-2"><a aria-hidden="true" href="#cb698-2" tabindex="-1"></a></span>
<span id="cb698-3"><a aria-hidden="true" href="#cb698-3" tabindex="-1"></a><span class="co">/*</span></span>
<span id="cb698-4"><a aria-hidden="true" href="#cb698-4" tabindex="-1"></a><span class="co"> * As of July 2007, all known versions of the Linux kernel will sometimes</span></span>
<span id="cb698-5"><a aria-hidden="true" href="#cb698-5" tabindex="-1"></a><span class="co"> * return EIDRM for a shmctl() operation when EINVAL is correct (it happens</span></span>
<span id="cb698-6"><a aria-hidden="true" href="#cb698-6" tabindex="-1"></a><span class="co"> * when the low-order 15 bits of the supplied shm ID match the slot number</span></span>
<span id="cb698-7"><a aria-hidden="true" href="#cb698-7" tabindex="-1"></a><span class="co"> * assigned to a newer shmem segment). We deal with this by assuming that</span></span>
<span id="cb698-8"><a aria-hidden="true" href="#cb698-8" tabindex="-1"></a><span class="co"> * EIDRM means EINVAL in PGSharedMemoryIsInUse(). This is reasonably safe</span></span>
<span id="cb698-9"><a aria-hidden="true" href="#cb698-9" tabindex="-1"></a><span class="co"> * since in fact Linux has no excuse for ever returning EIDRM.</span></span>
<span id="cb698-10"><a aria-hidden="true" href="#cb698-10" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb698-11"><a aria-hidden="true" href="#cb698-11" tabindex="-1"></a><span class="pp">#define HAVE_LINUX_EIDRM_BUG</span></span>
<span id="cb698-12"><a aria-hidden="true" href="#cb698-12" tabindex="-1"></a></span>
<span id="cb698-13"><a aria-hidden="true" href="#cb698-13" tabindex="-1"></a><span class="co">/*</span></span>
<span id="cb698-14"><a aria-hidden="true" href="#cb698-14" tabindex="-1"></a><span class="co"> * Set the default wal_sync_method to fdatasync. With recent Linux versions,</span></span>
<span id="cb698-15"><a aria-hidden="true" href="#cb698-15" tabindex="-1"></a><span class="co"> * xlogdefs.h's normal rules will prefer open_datasync, which (a) doesn't</span></span>
<span id="cb698-16"><a aria-hidden="true" href="#cb698-16" tabindex="-1"></a><span class="co"> * perform better and (b) causes outright failures on ext4 data=journal</span></span>
<span id="cb698-17"><a aria-hidden="true" href="#cb698-17" tabindex="-1"></a><span class="co"> * filesystems, because those don't support O_DIRECT.</span></span>
<span id="cb698-18"><a aria-hidden="true" href="#cb698-18" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb698-19"><a aria-hidden="true" href="#cb698-19" tabindex="-1"></a><span class="pp">#define PLATFORM_DEFAULT_WAL_SYNC_METHOD    WAL_SYNC_METHOD_FDATASYNC</span></span></code></pre></div>
<h4 data-number="11.5.1.2" id="windows-platform-header"><span class="header-section-number">11.5.1.2</span> Windows Platform
Header</h4>
<p><strong>/home/user/postgres/src/include/port/win32.h (Lines
1-60)</strong></p>
<div class="sourceCode" id="cb699"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb699-1"><a aria-hidden="true" href="#cb699-1" tabindex="-1"></a><span class="co">/* src/include/port/win32.h */</span></span>
<span id="cb699-2"><a aria-hidden="true" href="#cb699-2" tabindex="-1"></a></span>
<span id="cb699-3"><a aria-hidden="true" href="#cb699-3" tabindex="-1"></a><span class="co">/*</span></span>
<span id="cb699-4"><a aria-hidden="true" href="#cb699-4" tabindex="-1"></a><span class="co"> * We always rely on the WIN32 macro being set by our build system,</span></span>
<span id="cb699-5"><a aria-hidden="true" href="#cb699-5" tabindex="-1"></a><span class="co"> * but _WIN32 is the compiler pre-defined macro. So make sure we define</span></span>
<span id="cb699-6"><a aria-hidden="true" href="#cb699-6" tabindex="-1"></a><span class="co"> * WIN32 whenever _WIN32 is set, to facilitate standalone building.</span></span>
<span id="cb699-7"><a aria-hidden="true" href="#cb699-7" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb699-8"><a aria-hidden="true" href="#cb699-8" tabindex="-1"></a><span class="pp">#if defined(_WIN32) &amp;&amp; !defined(WIN32)</span></span>
<span id="cb699-9"><a aria-hidden="true" href="#cb699-9" tabindex="-1"></a><span class="pp">#define WIN32</span></span>
<span id="cb699-10"><a aria-hidden="true" href="#cb699-10" tabindex="-1"></a><span class="pp">#endif</span></span>
<span id="cb699-11"><a aria-hidden="true" href="#cb699-11" tabindex="-1"></a></span>
<span id="cb699-12"><a aria-hidden="true" href="#cb699-12" tabindex="-1"></a><span class="co">/*</span></span>
<span id="cb699-13"><a aria-hidden="true" href="#cb699-13" tabindex="-1"></a><span class="co"> * Make sure _WIN32_WINNT has the minimum required value.</span></span>
<span id="cb699-14"><a aria-hidden="true" href="#cb699-14" tabindex="-1"></a><span class="co"> * Leave a higher value in place. The minimum requirement is Windows 10.</span></span>
<span id="cb699-15"><a aria-hidden="true" href="#cb699-15" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb699-16"><a aria-hidden="true" href="#cb699-16" tabindex="-1"></a><span class="pp">#ifdef _WIN32_WINNT</span></span>
<span id="cb699-17"><a aria-hidden="true" href="#cb699-17" tabindex="-1"></a><span class="pp">#undef _WIN32_WINNT</span></span>
<span id="cb699-18"><a aria-hidden="true" href="#cb699-18" tabindex="-1"></a><span class="pp">#endif</span></span>
<span id="cb699-19"><a aria-hidden="true" href="#cb699-19" tabindex="-1"></a></span>
<span id="cb699-20"><a aria-hidden="true" href="#cb699-20" tabindex="-1"></a><span class="pp">#define _WIN32_WINNT </span><span class="bn">0x0A00</span></span>
<span id="cb699-21"><a aria-hidden="true" href="#cb699-21" tabindex="-1"></a></span>
<span id="cb699-22"><a aria-hidden="true" href="#cb699-22" tabindex="-1"></a><span class="co">/*</span></span>
<span id="cb699-23"><a aria-hidden="true" href="#cb699-23" tabindex="-1"></a><span class="co"> * We need to prevent &lt;crtdefs.h&gt; from defining a symbol conflicting with</span></span>
<span id="cb699-24"><a aria-hidden="true" href="#cb699-24" tabindex="-1"></a><span class="co"> * our errcode() function.</span></span>
<span id="cb699-25"><a aria-hidden="true" href="#cb699-25" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb699-26"><a aria-hidden="true" href="#cb699-26" tabindex="-1"></a><span class="pp">#if defined(_MSC_VER) || defined(HAVE_CRTDEFS_H)</span></span>
<span id="cb699-27"><a aria-hidden="true" href="#cb699-27" tabindex="-1"></a><span class="pp">#define errcode __msvc_errcode</span></span>
<span id="cb699-28"><a aria-hidden="true" href="#cb699-28" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;crtdefs.h&gt;</span></span>
<span id="cb699-29"><a aria-hidden="true" href="#cb699-29" tabindex="-1"></a><span class="pp">#undef errcode</span></span>
<span id="cb699-30"><a aria-hidden="true" href="#cb699-30" tabindex="-1"></a><span class="pp">#endif</span></span>
<span id="cb699-31"><a aria-hidden="true" href="#cb699-31" tabindex="-1"></a></span>
<span id="cb699-32"><a aria-hidden="true" href="#cb699-32" tabindex="-1"></a><span class="co">/*</span></span>
<span id="cb699-33"><a aria-hidden="true" href="#cb699-33" tabindex="-1"></a><span class="co"> * Defines for dynamic linking on Win32 platform</span></span>
<span id="cb699-34"><a aria-hidden="true" href="#cb699-34" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb699-35"><a aria-hidden="true" href="#cb699-35" tabindex="-1"></a></span>
<span id="cb699-36"><a aria-hidden="true" href="#cb699-36" tabindex="-1"></a><span class="co">/*</span></span>
<span id="cb699-37"><a aria-hidden="true" href="#cb699-37" tabindex="-1"></a><span class="co"> * Variables declared in the core backend and referenced by loadable</span></span>
<span id="cb699-38"><a aria-hidden="true" href="#cb699-38" tabindex="-1"></a><span class="co"> * modules need to be marked "dllimport" in the core build, but</span></span>
<span id="cb699-39"><a aria-hidden="true" href="#cb699-39" tabindex="-1"></a><span class="co"> * "dllexport" when the declaration is read in a loadable module.</span></span>
<span id="cb699-40"><a aria-hidden="true" href="#cb699-40" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb699-41"><a aria-hidden="true" href="#cb699-41" tabindex="-1"></a><span class="pp">#ifndef FRONTEND</span></span>
<span id="cb699-42"><a aria-hidden="true" href="#cb699-42" tabindex="-1"></a><span class="pp">#ifdef BUILDING_DLL</span></span>
<span id="cb699-43"><a aria-hidden="true" href="#cb699-43" tabindex="-1"></a><span class="pp">#define PGDLLIMPORT __declspec </span><span class="op">(</span><span class="pp">dllexport</span><span class="op">)</span></span>
<span id="cb699-44"><a aria-hidden="true" href="#cb699-44" tabindex="-1"></a><span class="pp">#else</span></span>
<span id="cb699-45"><a aria-hidden="true" href="#cb699-45" tabindex="-1"></a><span class="pp">#define PGDLLIMPORT __declspec </span><span class="op">(</span><span class="pp">dllimport</span><span class="op">)</span></span>
<span id="cb699-46"><a aria-hidden="true" href="#cb699-46" tabindex="-1"></a><span class="pp">#endif</span></span>
<span id="cb699-47"><a aria-hidden="true" href="#cb699-47" tabindex="-1"></a><span class="pp">#endif</span></span>
<span id="cb699-48"><a aria-hidden="true" href="#cb699-48" tabindex="-1"></a></span>
<span id="cb699-49"><a aria-hidden="true" href="#cb699-49" tabindex="-1"></a><span class="co">/*</span></span>
<span id="cb699-50"><a aria-hidden="true" href="#cb699-50" tabindex="-1"></a><span class="co"> * Functions exported by a loadable module must be marked "dllexport".</span></span>
<span id="cb699-51"><a aria-hidden="true" href="#cb699-51" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb699-52"><a aria-hidden="true" href="#cb699-52" tabindex="-1"></a><span class="pp">#define PGDLLEXPORT __declspec </span><span class="op">(</span><span class="pp">dllexport</span><span class="op">)</span></span></code></pre></div>
<h3 data-number="11.5.2" id="atomic-operations"><span class="header-section-number">11.5.2</span> Atomic Operations</h3>
<h4 data-number="11.5.2.1" id="platform-independent-atomics-header"><span class="header-section-number">11.5.2.1</span> Platform-Independent
Atomics Header</h4>
<p><strong>/home/user/postgres/src/include/port/atomics.h (Lines
1-100)</strong></p>
<div class="sourceCode" id="cb700"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb700-1"><a aria-hidden="true" href="#cb700-1" tabindex="-1"></a><span class="co">/*</span></span>
<span id="cb700-2"><a aria-hidden="true" href="#cb700-2" tabindex="-1"></a><span class="co"> * atomics.h</span></span>
<span id="cb700-3"><a aria-hidden="true" href="#cb700-3" tabindex="-1"></a><span class="co"> *   Atomic operations.</span></span>
<span id="cb700-4"><a aria-hidden="true" href="#cb700-4" tabindex="-1"></a><span class="co"> *</span></span>
<span id="cb700-5"><a aria-hidden="true" href="#cb700-5" tabindex="-1"></a><span class="co"> * Hardware and compiler dependent functions for manipulating memory</span></span>
<span id="cb700-6"><a aria-hidden="true" href="#cb700-6" tabindex="-1"></a><span class="co"> * atomically and dealing with cache coherency.</span></span>
<span id="cb700-7"><a aria-hidden="true" href="#cb700-7" tabindex="-1"></a><span class="co"> *</span></span>
<span id="cb700-8"><a aria-hidden="true" href="#cb700-8" tabindex="-1"></a><span class="co"> * To bring up postgres on a platform/compiler at the very least</span></span>
<span id="cb700-9"><a aria-hidden="true" href="#cb700-9" tabindex="-1"></a><span class="co"> * implementations for the following operations should be provided:</span></span>
<span id="cb700-10"><a aria-hidden="true" href="#cb700-10" tabindex="-1"></a><span class="co"> * * pg_compiler_barrier(), pg_write_barrier(), pg_read_barrier()</span></span>
<span id="cb700-11"><a aria-hidden="true" href="#cb700-11" tabindex="-1"></a><span class="co"> * * pg_atomic_compare_exchange_u32(), pg_atomic_fetch_add_u32()</span></span>
<span id="cb700-12"><a aria-hidden="true" href="#cb700-12" tabindex="-1"></a><span class="co"> * * pg_atomic_test_set_flag(), pg_atomic_init_flag(), pg_atomic_clear_flag()</span></span>
<span id="cb700-13"><a aria-hidden="true" href="#cb700-13" tabindex="-1"></a><span class="co"> * * PG_HAVE_8BYTE_SINGLE_COPY_ATOMICITY should be defined if appropriate.</span></span>
<span id="cb700-14"><a aria-hidden="true" href="#cb700-14" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb700-15"><a aria-hidden="true" href="#cb700-15" tabindex="-1"></a></span>
<span id="cb700-16"><a aria-hidden="true" href="#cb700-16" tabindex="-1"></a><span class="pp">#ifndef ATOMICS_H</span></span>
<span id="cb700-17"><a aria-hidden="true" href="#cb700-17" tabindex="-1"></a><span class="pp">#define ATOMICS_H</span></span>
<span id="cb700-18"><a aria-hidden="true" href="#cb700-18" tabindex="-1"></a></span>
<span id="cb700-19"><a aria-hidden="true" href="#cb700-19" tabindex="-1"></a><span class="co">/*</span></span>
<span id="cb700-20"><a aria-hidden="true" href="#cb700-20" tabindex="-1"></a><span class="co"> * First a set of architecture specific files is included.</span></span>
<span id="cb700-21"><a aria-hidden="true" href="#cb700-21" tabindex="-1"></a><span class="co"> * These files can provide the full set of atomics or can do pretty much</span></span>
<span id="cb700-22"><a aria-hidden="true" href="#cb700-22" tabindex="-1"></a><span class="co"> * nothing if all the compilers commonly used on these platforms provide</span></span>
<span id="cb700-23"><a aria-hidden="true" href="#cb700-23" tabindex="-1"></a><span class="co"> * usable generics.</span></span>
<span id="cb700-24"><a aria-hidden="true" href="#cb700-24" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb700-25"><a aria-hidden="true" href="#cb700-25" tabindex="-1"></a><span class="pp">#if defined(__arm__) || defined(__arm) || defined(__aarch64__)</span></span>
<span id="cb700-26"><a aria-hidden="true" href="#cb700-26" tabindex="-1"></a><span class="pp">#include </span><span class="im">"port/atomics/arch-arm.h"</span></span>
<span id="cb700-27"><a aria-hidden="true" href="#cb700-27" tabindex="-1"></a><span class="pp">#elif defined(__i386__) || defined(__i386) || defined(__x86_64__)</span></span>
<span id="cb700-28"><a aria-hidden="true" href="#cb700-28" tabindex="-1"></a><span class="pp">#include </span><span class="im">"port/atomics/arch-x86.h"</span></span>
<span id="cb700-29"><a aria-hidden="true" href="#cb700-29" tabindex="-1"></a><span class="pp">#elif defined(__ppc__) || defined(__powerpc__) || defined(__ppc64__) || defined(__powerpc64__)</span></span>
<span id="cb700-30"><a aria-hidden="true" href="#cb700-30" tabindex="-1"></a><span class="pp">#include </span><span class="im">"port/atomics/arch-ppc.h"</span></span>
<span id="cb700-31"><a aria-hidden="true" href="#cb700-31" tabindex="-1"></a><span class="pp">#endif</span></span>
<span id="cb700-32"><a aria-hidden="true" href="#cb700-32" tabindex="-1"></a></span>
<span id="cb700-33"><a aria-hidden="true" href="#cb700-33" tabindex="-1"></a><span class="co">/*</span></span>
<span id="cb700-34"><a aria-hidden="true" href="#cb700-34" tabindex="-1"></a><span class="co"> * Compiler specific, but architecture independent implementations.</span></span>
<span id="cb700-35"><a aria-hidden="true" href="#cb700-35" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb700-36"><a aria-hidden="true" href="#cb700-36" tabindex="-1"></a><span class="pp">#if defined(__GNUC__) || defined(__INTEL_COMPILER)</span></span>
<span id="cb700-37"><a aria-hidden="true" href="#cb700-37" tabindex="-1"></a><span class="pp">#include </span><span class="im">"port/atomics/generic-gcc.h"</span></span>
<span id="cb700-38"><a aria-hidden="true" href="#cb700-38" tabindex="-1"></a><span class="pp">#elif defined(_MSC_VER)</span></span>
<span id="cb700-39"><a aria-hidden="true" href="#cb700-39" tabindex="-1"></a><span class="pp">#include </span><span class="im">"port/atomics/generic-msvc.h"</span></span>
<span id="cb700-40"><a aria-hidden="true" href="#cb700-40" tabindex="-1"></a><span class="pp">#else</span></span>
<span id="cb700-41"><a aria-hidden="true" href="#cb700-41" tabindex="-1"></a><span class="co">/* Unknown compiler. */</span></span>
<span id="cb700-42"><a aria-hidden="true" href="#cb700-42" tabindex="-1"></a><span class="pp">#endif</span></span>
<span id="cb700-43"><a aria-hidden="true" href="#cb700-43" tabindex="-1"></a></span>
<span id="cb700-44"><a aria-hidden="true" href="#cb700-44" tabindex="-1"></a><span class="co">/* Fail if we couldn't find implementations of required facilities. */</span></span>
<span id="cb700-45"><a aria-hidden="true" href="#cb700-45" tabindex="-1"></a><span class="pp">#if !defined(PG_HAVE_ATOMIC_U32_SUPPORT)</span></span>
<span id="cb700-46"><a aria-hidden="true" href="#cb700-46" tabindex="-1"></a><span class="pp">#error "could not find an implementation of pg_atomic_uint32"</span></span>
<span id="cb700-47"><a aria-hidden="true" href="#cb700-47" tabindex="-1"></a><span class="pp">#endif</span></span>
<span id="cb700-48"><a aria-hidden="true" href="#cb700-48" tabindex="-1"></a><span class="pp">#if !defined(pg_compiler_barrier_impl)</span></span>
<span id="cb700-49"><a aria-hidden="true" href="#cb700-49" tabindex="-1"></a><span class="pp">#error "could not find an implementation of pg_compiler_barrier"</span></span>
<span id="cb700-50"><a aria-hidden="true" href="#cb700-50" tabindex="-1"></a><span class="pp">#endif</span></span></code></pre></div>
<h3 data-number="11.5.3" id="crc32c-with-hardware-acceleration"><span class="header-section-number">11.5.3</span> CRC32C with Hardware
Acceleration</h3>
<p><strong>/home/user/postgres/src/include/port/pg_crc32c.h (Lines
1-100)</strong></p>
<div class="sourceCode" id="cb701"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb701-1"><a aria-hidden="true" href="#cb701-1" tabindex="-1"></a><span class="co">/*</span></span>
<span id="cb701-2"><a aria-hidden="true" href="#cb701-2" tabindex="-1"></a><span class="co"> * pg_crc32c.h</span></span>
<span id="cb701-3"><a aria-hidden="true" href="#cb701-3" tabindex="-1"></a><span class="co"> *   Routines for computing CRC-32C checksums.</span></span>
<span id="cb701-4"><a aria-hidden="true" href="#cb701-4" tabindex="-1"></a><span class="co"> *</span></span>
<span id="cb701-5"><a aria-hidden="true" href="#cb701-5" tabindex="-1"></a><span class="co"> * The speed of CRC-32C calculation has a big impact on performance, so we</span></span>
<span id="cb701-6"><a aria-hidden="true" href="#cb701-6" tabindex="-1"></a><span class="co"> * jump through some hoops to get the best implementation for each</span></span>
<span id="cb701-7"><a aria-hidden="true" href="#cb701-7" tabindex="-1"></a><span class="co"> * platform. Some CPU architectures have special instructions for speeding</span></span>
<span id="cb701-8"><a aria-hidden="true" href="#cb701-8" tabindex="-1"></a><span class="co"> * up CRC calculations (e.g. Intel SSE 4.2), on other platforms we use the</span></span>
<span id="cb701-9"><a aria-hidden="true" href="#cb701-9" tabindex="-1"></a><span class="co"> * Slicing-by-8 algorithm which uses lookup tables.</span></span>
<span id="cb701-10"><a aria-hidden="true" href="#cb701-10" tabindex="-1"></a><span class="co"> *</span></span>
<span id="cb701-11"><a aria-hidden="true" href="#cb701-11" tabindex="-1"></a><span class="co"> * The public interface consists of four macros:</span></span>
<span id="cb701-12"><a aria-hidden="true" href="#cb701-12" tabindex="-1"></a><span class="co"> * INIT_CRC32C(crc)     - Initialize a CRC accumulator</span></span>
<span id="cb701-13"><a aria-hidden="true" href="#cb701-13" tabindex="-1"></a><span class="co"> * COMP_CRC32C(crc, data, len) - Accumulate some bytes</span></span>
<span id="cb701-14"><a aria-hidden="true" href="#cb701-14" tabindex="-1"></a><span class="co"> * FIN_CRC32C(crc)      - Finish a CRC calculation</span></span>
<span id="cb701-15"><a aria-hidden="true" href="#cb701-15" tabindex="-1"></a><span class="co"> * EQ_CRC32C(c1, c2)    - Check for equality of two CRCs</span></span>
<span id="cb701-16"><a aria-hidden="true" href="#cb701-16" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb701-17"><a aria-hidden="true" href="#cb701-17" tabindex="-1"></a></span>
<span id="cb701-18"><a aria-hidden="true" href="#cb701-18" tabindex="-1"></a><span class="pp">#ifndef PG_CRC32C_H</span></span>
<span id="cb701-19"><a aria-hidden="true" href="#cb701-19" tabindex="-1"></a><span class="pp">#define PG_CRC32C_H</span></span>
<span id="cb701-20"><a aria-hidden="true" href="#cb701-20" tabindex="-1"></a></span>
<span id="cb701-21"><a aria-hidden="true" href="#cb701-21" tabindex="-1"></a><span class="kw">typedef</span> uint32 pg_crc32c<span class="op">;</span></span>
<span id="cb701-22"><a aria-hidden="true" href="#cb701-22" tabindex="-1"></a></span>
<span id="cb701-23"><a aria-hidden="true" href="#cb701-23" tabindex="-1"></a><span class="co">/* The INIT and EQ macros are the same for all implementations. */</span></span>
<span id="cb701-24"><a aria-hidden="true" href="#cb701-24" tabindex="-1"></a><span class="pp">#define INIT_CRC32C</span><span class="op">(</span><span class="pp">crc</span><span class="op">)</span><span class="pp"> </span><span class="op">((</span><span class="pp">crc</span><span class="op">)</span><span class="pp"> </span><span class="op">=</span><span class="pp"> </span><span class="bn">0xFFFFFFFF</span><span class="op">)</span></span>
<span id="cb701-25"><a aria-hidden="true" href="#cb701-25" tabindex="-1"></a><span class="pp">#define EQ_CRC32C</span><span class="op">(</span><span class="pp">c1</span><span class="op">,</span><span class="pp"> c2</span><span class="op">)</span><span class="pp"> </span><span class="op">((</span><span class="pp">c1</span><span class="op">)</span><span class="pp"> </span><span class="op">==</span><span class="pp"> </span><span class="op">(</span><span class="pp">c2</span><span class="op">))</span></span>
<span id="cb701-26"><a aria-hidden="true" href="#cb701-26" tabindex="-1"></a></span>
<span id="cb701-27"><a aria-hidden="true" href="#cb701-27" tabindex="-1"></a><span class="pp">#if defined(USE_SSE42_CRC32C)</span></span>
<span id="cb701-28"><a aria-hidden="true" href="#cb701-28" tabindex="-1"></a><span class="co">/*</span></span>
<span id="cb701-29"><a aria-hidden="true" href="#cb701-29" tabindex="-1"></a><span class="co"> * Use Intel SSE 4.2 or AVX-512 instructions.</span></span>
<span id="cb701-30"><a aria-hidden="true" href="#cb701-30" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb701-31"><a aria-hidden="true" href="#cb701-31" tabindex="-1"></a></span>
<span id="cb701-32"><a aria-hidden="true" href="#cb701-32" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;nmmintrin.h&gt;</span></span>
<span id="cb701-33"><a aria-hidden="true" href="#cb701-33" tabindex="-1"></a></span>
<span id="cb701-34"><a aria-hidden="true" href="#cb701-34" tabindex="-1"></a><span class="pp">#define COMP_CRC32C</span><span class="op">(</span><span class="pp">crc</span><span class="op">,</span><span class="pp"> data</span><span class="op">,</span><span class="pp"> len</span><span class="op">)</span><span class="pp"> </span><span class="op">\</span></span>
<span id="cb701-35"><a aria-hidden="true" href="#cb701-35" tabindex="-1"></a><span class="pp">    </span><span class="op">((</span><span class="pp">crc</span><span class="op">)</span><span class="pp"> </span><span class="op">=</span><span class="pp"> pg_comp_crc32c_dispatch</span><span class="op">((</span><span class="pp">crc</span><span class="op">),</span><span class="pp"> </span><span class="op">(</span><span class="pp">data</span><span class="op">),</span><span class="pp"> </span><span class="op">(</span><span class="pp">len</span><span class="op">)))</span></span>
<span id="cb701-36"><a aria-hidden="true" href="#cb701-36" tabindex="-1"></a><span class="pp">#define FIN_CRC32C</span><span class="op">(</span><span class="pp">crc</span><span class="op">)</span><span class="pp"> </span><span class="op">((</span><span class="pp">crc</span><span class="op">)</span><span class="pp"> </span><span class="op">^=</span><span class="pp"> </span><span class="bn">0xFFFFFFFF</span><span class="op">)</span></span>
<span id="cb701-37"><a aria-hidden="true" href="#cb701-37" tabindex="-1"></a></span>
<span id="cb701-38"><a aria-hidden="true" href="#cb701-38" tabindex="-1"></a><span class="kw">extern</span> pg_crc32c <span class="op">(*</span>pg_comp_crc32c<span class="op">)(</span>pg_crc32c crc<span class="op">,</span> <span class="dt">const</span> <span class="dt">void</span> <span class="op">*</span>data<span class="op">,</span> <span class="dt">size_t</span> len<span class="op">);</span></span>
<span id="cb701-39"><a aria-hidden="true" href="#cb701-39" tabindex="-1"></a><span class="kw">extern</span> pg_crc32c pg_comp_crc32c_sse42<span class="op">(</span>pg_crc32c crc<span class="op">,</span> <span class="dt">const</span> <span class="dt">void</span> <span class="op">*</span>data<span class="op">,</span> <span class="dt">size_t</span> len<span class="op">);</span></span>
<span id="cb701-40"><a aria-hidden="true" href="#cb701-40" tabindex="-1"></a></span>
<span id="cb701-41"><a aria-hidden="true" href="#cb701-41" tabindex="-1"></a>pg_attribute_no_sanitize_alignment<span class="op">()</span></span>
<span id="cb701-42"><a aria-hidden="true" href="#cb701-42" tabindex="-1"></a>pg_attribute_target<span class="op">(</span><span class="st">"sse4.2"</span><span class="op">)</span></span>
<span id="cb701-43"><a aria-hidden="true" href="#cb701-43" tabindex="-1"></a><span class="dt">static</span> <span class="kw">inline</span></span>
<span id="cb701-44"><a aria-hidden="true" href="#cb701-44" tabindex="-1"></a>pg_crc32c</span>
<span id="cb701-45"><a aria-hidden="true" href="#cb701-45" tabindex="-1"></a>pg_comp_crc32c_dispatch<span class="op">(</span>pg_crc32c crc<span class="op">,</span> <span class="dt">const</span> <span class="dt">void</span> <span class="op">*</span>data<span class="op">,</span> <span class="dt">size_t</span> len<span class="op">)</span></span>
<span id="cb701-46"><a aria-hidden="true" href="#cb701-46" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb701-47"><a aria-hidden="true" href="#cb701-47" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>__builtin_constant_p<span class="op">(</span>len<span class="op">)</span> <span class="op">&amp;&amp;</span> len <span class="op">&lt;</span> <span class="dv">32</span><span class="op">)</span></span>
<span id="cb701-48"><a aria-hidden="true" href="#cb701-48" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb701-49"><a aria-hidden="true" href="#cb701-49" tabindex="-1"></a>        <span class="dt">const</span> <span class="dt">unsigned</span> <span class="dt">char</span> <span class="op">*</span>p <span class="op">=</span> <span class="op">(</span><span class="dt">const</span> <span class="dt">unsigned</span> <span class="dt">char</span> <span class="op">*)</span> data<span class="op">;</span></span>
<span id="cb701-50"><a aria-hidden="true" href="#cb701-50" tabindex="-1"></a>        </span>
<span id="cb701-51"><a aria-hidden="true" href="#cb701-51" tabindex="-1"></a>        <span class="co">/* For small constant inputs, inline the computation */</span></span>
<span id="cb701-52"><a aria-hidden="true" href="#cb701-52" tabindex="-1"></a><span class="pp">#if SIZEOF_VOID_P &gt;= 8</span></span>
<span id="cb701-53"><a aria-hidden="true" href="#cb701-53" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(;</span> len <span class="op">&gt;=</span> <span class="dv">8</span><span class="op">;</span> p <span class="op">+=</span> <span class="dv">8</span><span class="op">,</span> len <span class="op">-=</span> <span class="dv">8</span><span class="op">)</span></span>
<span id="cb701-54"><a aria-hidden="true" href="#cb701-54" tabindex="-1"></a>            crc <span class="op">=</span> _mm_crc32_u64<span class="op">(</span>crc<span class="op">,</span> <span class="op">*(</span><span class="dt">const</span> uint64 <span class="op">*)</span> p<span class="op">);</span></span>
<span id="cb701-55"><a aria-hidden="true" href="#cb701-55" tabindex="-1"></a><span class="pp">#endif</span></span>
<span id="cb701-56"><a aria-hidden="true" href="#cb701-56" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(;</span> len <span class="op">&gt;=</span> <span class="dv">4</span><span class="op">;</span> p <span class="op">+=</span> <span class="dv">4</span><span class="op">,</span> len <span class="op">-=</span> <span class="dv">4</span><span class="op">)</span></span>
<span id="cb701-57"><a aria-hidden="true" href="#cb701-57" tabindex="-1"></a>            crc <span class="op">=</span> _mm_crc32_u32<span class="op">(</span>crc<span class="op">,</span> <span class="op">*(</span><span class="dt">const</span> uint32 <span class="op">*)</span> p<span class="op">);</span></span>
<span id="cb701-58"><a aria-hidden="true" href="#cb701-58" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(;</span> len <span class="op">&gt;</span> <span class="dv">0</span><span class="op">;</span> <span class="op">--</span>len<span class="op">)</span></span>
<span id="cb701-59"><a aria-hidden="true" href="#cb701-59" tabindex="-1"></a>            crc <span class="op">=</span> _mm_crc32_u8<span class="op">(</span>crc<span class="op">,</span> <span class="op">*</span>p<span class="op">++);</span></span>
<span id="cb701-60"><a aria-hidden="true" href="#cb701-60" tabindex="-1"></a>        <span class="cf">return</span> crc<span class="op">;</span></span>
<span id="cb701-61"><a aria-hidden="true" href="#cb701-61" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb701-62"><a aria-hidden="true" href="#cb701-62" tabindex="-1"></a>    <span class="cf">else</span></span>
<span id="cb701-63"><a aria-hidden="true" href="#cb701-63" tabindex="-1"></a>        <span class="co">/* Use runtime check for AVX-512 instructions */</span></span>
<span id="cb701-64"><a aria-hidden="true" href="#cb701-64" tabindex="-1"></a>        <span class="cf">return</span> pg_comp_crc32c<span class="op">(</span>crc<span class="op">,</span> data<span class="op">,</span> len<span class="op">);</span></span>
<span id="cb701-65"><a aria-hidden="true" href="#cb701-65" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb701-66"><a aria-hidden="true" href="#cb701-66" tabindex="-1"></a></span>
<span id="cb701-67"><a aria-hidden="true" href="#cb701-67" tabindex="-1"></a><span class="pp">#elif defined(USE_ARMV8_CRC32C)</span></span>
<span id="cb701-68"><a aria-hidden="true" href="#cb701-68" tabindex="-1"></a><span class="co">/* ARM version with CRC32 instructions */</span></span>
<span id="cb701-69"><a aria-hidden="true" href="#cb701-69" tabindex="-1"></a><span class="co">/* ... */</span></span>
<span id="cb701-70"><a aria-hidden="true" href="#cb701-70" tabindex="-1"></a></span>
<span id="cb701-71"><a aria-hidden="true" href="#cb701-71" tabindex="-1"></a><span class="pp">#else</span></span>
<span id="cb701-72"><a aria-hidden="true" href="#cb701-72" tabindex="-1"></a><span class="co">/* Slicing-by-8 software implementation */</span></span>
<span id="cb701-73"><a aria-hidden="true" href="#cb701-73" tabindex="-1"></a><span class="co">/* ... */</span></span>
<span id="cb701-74"><a aria-hidden="true" href="#cb701-74" tabindex="-1"></a></span>
<span id="cb701-75"><a aria-hidden="true" href="#cb701-75" tabindex="-1"></a><span class="pp">#endif </span><span class="co">/* CRC implementation selection */</span></span></code></pre></div>
<hr/>
<h2 data-number="11.6" id="testing-infrastructure"><span class="header-section-number">11.6</span> 5. Testing Infrastructure</h2>
<h3 data-number="11.6.1" id="test-organization"><span class="header-section-number">11.6.1</span> Test Organization</h3>
<h4 data-number="11.6.1.1" id="homeuserpostgressrctestreadme"><span class="header-section-number">11.6.1.1</span>
/home/user/postgres/src/test/README</h4>
<pre><code>PostgreSQL tests
================

This directory contains a variety of test infrastructure as well as some of the
tests in PostgreSQL. Not all tests are here -- in particular, there are more in
individual contrib/ modules and in src/bin.

authentication/
  Tests for authentication (but see also below)

examples/
  Demonstration programs for libpq that double as regression tests

isolation/
  Tests for concurrent behavior at the SQL level

kerberos/
  Tests for Kerberos/GSSAPI authentication and encryption

ldap/
  Tests for LDAP-based authentication

modules/
  Extensions used only or mainly for test purposes

perl/
  Infrastructure for Perl-based TAP tests

recovery/
  Test suite for recovery and replication

regress/
  PostgreSQL's main regression test suite, pg_regress

ssl/
  Tests to exercise and verify SSL certificate handling

subscription/
  Tests for logical replication</code></pre>
<h3 data-number="11.6.2" id="perl-test-framework"><span class="header-section-number">11.6.2</span> Perl Test Framework</h3>
<h4 data-number="11.6.2.1" id="homeuserpostgressrctestperlpostgresqltestutils.pm-lines-1-150"><span class="header-section-number">11.6.2.1</span>
/home/user/postgres/src/test/perl/PostgreSQL/Test/Utils.pm (Lines
1-150)</h4>
<div class="sourceCode" id="cb703"><pre class="sourceCode perl"><code class="sourceCode perl"><span id="cb703-1"><a aria-hidden="true" href="#cb703-1" tabindex="-1"></a><span class="co">=head1 NAME</span></span>
<span id="cb703-2"><a aria-hidden="true" href="#cb703-2" tabindex="-1"></a></span>
<span id="cb703-3"><a aria-hidden="true" href="#cb703-3" tabindex="-1"></a><span class="co">PostgreSQL::Test::Utils - helper module for writing PostgreSQL's C&lt;prove&gt; tests.</span></span>
<span id="cb703-4"><a aria-hidden="true" href="#cb703-4" tabindex="-1"></a></span>
<span id="cb703-5"><a aria-hidden="true" href="#cb703-5" tabindex="-1"></a><span class="co">=head1 SYNOPSIS</span></span>
<span id="cb703-6"><a aria-hidden="true" href="#cb703-6" tabindex="-1"></a></span>
<span id="cb703-7"><a aria-hidden="true" href="#cb703-7" tabindex="-1"></a><span class="co">  use PostgreSQL::Test::Utils;</span></span>
<span id="cb703-8"><a aria-hidden="true" href="#cb703-8" tabindex="-1"></a></span>
<span id="cb703-9"><a aria-hidden="true" href="#cb703-9" tabindex="-1"></a><span class="co">  # Test basic output of a command</span></span>
<span id="cb703-10"><a aria-hidden="true" href="#cb703-10" tabindex="-1"></a><span class="co">  program_help_ok('initdb');</span></span>
<span id="cb703-11"><a aria-hidden="true" href="#cb703-11" tabindex="-1"></a><span class="co">  program_version_ok('initdb');</span></span>
<span id="cb703-12"><a aria-hidden="true" href="#cb703-12" tabindex="-1"></a><span class="co">  </span></span>
<span id="cb703-13"><a aria-hidden="true" href="#cb703-13" tabindex="-1"></a><span class="co">  # Test option combinations</span></span>
<span id="cb703-14"><a aria-hidden="true" href="#cb703-14" tabindex="-1"></a><span class="co">  command_fails(['initdb', '--invalid-option'],</span></span>
<span id="cb703-15"><a aria-hidden="true" href="#cb703-15" tabindex="-1"></a><span class="co">              'command fails with invalid option');</span></span>
<span id="cb703-16"><a aria-hidden="true" href="#cb703-16" tabindex="-1"></a><span class="co">  my $tempdir = PostgreSQL::Test::Utils::tempdir;</span></span>
<span id="cb703-17"><a aria-hidden="true" href="#cb703-17" tabindex="-1"></a><span class="co">  command_ok('initdb', '--pgdata' =&gt; $tempdir);</span></span>
<span id="cb703-18"><a aria-hidden="true" href="#cb703-18" tabindex="-1"></a></span>
<span id="cb703-19"><a aria-hidden="true" href="#cb703-19" tabindex="-1"></a><span class="co">=cut</span></span>
<span id="cb703-20"><a aria-hidden="true" href="#cb703-20" tabindex="-1"></a></span>
<span id="cb703-21"><a aria-hidden="true" href="#cb703-21" tabindex="-1"></a><span class="kw">package</span> <span class="fu">PostgreSQL::Test</span>::<span class="fu">Utils</span>;</span>
<span id="cb703-22"><a aria-hidden="true" href="#cb703-22" tabindex="-1"></a></span>
<span id="cb703-23"><a aria-hidden="true" href="#cb703-23" tabindex="-1"></a><span class="fu">use</span> <span class="kw">strict</span>;</span>
<span id="cb703-24"><a aria-hidden="true" href="#cb703-24" tabindex="-1"></a><span class="fu">use</span> <span class="kw">warnings</span> FATAL =&gt; <span class="ot">'</span><span class="ss">all</span><span class="ot">'</span>;</span>
<span id="cb703-25"><a aria-hidden="true" href="#cb703-25" tabindex="-1"></a></span>
<span id="cb703-26"><a aria-hidden="true" href="#cb703-26" tabindex="-1"></a><span class="fu">use</span> Carp;</span>
<span id="cb703-27"><a aria-hidden="true" href="#cb703-27" tabindex="-1"></a><span class="fu">use</span> Config;</span>
<span id="cb703-28"><a aria-hidden="true" href="#cb703-28" tabindex="-1"></a><span class="fu">use</span> Cwd;</span>
<span id="cb703-29"><a aria-hidden="true" href="#cb703-29" tabindex="-1"></a><span class="fu">use</span> Exporter <span class="ot">'</span><span class="ss">import</span><span class="ot">'</span>;</span>
<span id="cb703-30"><a aria-hidden="true" href="#cb703-30" tabindex="-1"></a><span class="fu">use</span> <span class="fu">File::Find</span>;</span>
<span id="cb703-31"><a aria-hidden="true" href="#cb703-31" tabindex="-1"></a><span class="fu">use</span> <span class="fu">File::Temp</span> ();</span>
<span id="cb703-32"><a aria-hidden="true" href="#cb703-32" tabindex="-1"></a><span class="fu">use</span> <span class="fu">IPC::Run</span>;</span>
<span id="cb703-33"><a aria-hidden="true" href="#cb703-33" tabindex="-1"></a><span class="fu">use</span> <span class="fu">Test::More</span> <span class="fu">0</span>.<span class="dv">98</span>;</span>
<span id="cb703-34"><a aria-hidden="true" href="#cb703-34" tabindex="-1"></a></span>
<span id="cb703-35"><a aria-hidden="true" href="#cb703-35" tabindex="-1"></a><span class="kw">our</span> <span class="dt">@EXPORT</span> = <span class="ot">qw(</span></span>
<span id="cb703-36"><a aria-hidden="true" href="#cb703-36" tabindex="-1"></a>  generate_ascii_string</span>
<span id="cb703-37"><a aria-hidden="true" href="#cb703-37" tabindex="-1"></a>  slurp_file</span>
<span id="cb703-38"><a aria-hidden="true" href="#cb703-38" tabindex="-1"></a>  append_to_file</span>
<span id="cb703-39"><a aria-hidden="true" href="#cb703-39" tabindex="-1"></a>  string_replace_file</span>
<span id="cb703-40"><a aria-hidden="true" href="#cb703-40" tabindex="-1"></a>  </span>
<span id="cb703-41"><a aria-hidden="true" href="#cb703-41" tabindex="-1"></a>  command_ok</span>
<span id="cb703-42"><a aria-hidden="true" href="#cb703-42" tabindex="-1"></a>  command_fails</span>
<span id="cb703-43"><a aria-hidden="true" href="#cb703-43" tabindex="-1"></a>  command_exit_is</span>
<span id="cb703-44"><a aria-hidden="true" href="#cb703-44" tabindex="-1"></a>  program_help_ok</span>
<span id="cb703-45"><a aria-hidden="true" href="#cb703-45" tabindex="-1"></a>  program_version_ok</span>
<span id="cb703-46"><a aria-hidden="true" href="#cb703-46" tabindex="-1"></a>  command_like</span>
<span id="cb703-47"><a aria-hidden="true" href="#cb703-47" tabindex="-1"></a>  </span>
<span id="cb703-48"><a aria-hidden="true" href="#cb703-48" tabindex="-1"></a>  $windows_os</span>
<span id="cb703-49"><a aria-hidden="true" href="#cb703-49" tabindex="-1"></a>  $use_unix_sockets</span>
<span id="cb703-50"><a aria-hidden="true" href="#cb703-50" tabindex="-1"></a><span class="ot">)</span>;</span>
<span id="cb703-51"><a aria-hidden="true" href="#cb703-51" tabindex="-1"></a></span>
<span id="cb703-52"><a aria-hidden="true" href="#cb703-52" tabindex="-1"></a><span class="kw">BEGIN</span></span>
<span id="cb703-53"><a aria-hidden="true" href="#cb703-53" tabindex="-1"></a>{</span>
<span id="cb703-54"><a aria-hidden="true" href="#cb703-54" tabindex="-1"></a>    <span class="co"># Set to untranslated messages</span></span>
<span id="cb703-55"><a aria-hidden="true" href="#cb703-55" tabindex="-1"></a>    <span class="fu">delete</span> <span class="wa">$ENV</span>{LANGUAGE};</span>
<span id="cb703-56"><a aria-hidden="true" href="#cb703-56" tabindex="-1"></a>    <span class="fu">delete</span> <span class="wa">$ENV</span>{LC_ALL};</span>
<span id="cb703-57"><a aria-hidden="true" href="#cb703-57" tabindex="-1"></a>    <span class="wa">$ENV</span>{LC_MESSAGES} = <span class="ot">'</span><span class="ss">C</span><span class="ot">'</span>;</span>
<span id="cb703-58"><a aria-hidden="true" href="#cb703-58" tabindex="-1"></a>    <span class="wa">$ENV</span>{LC_NUMERIC} = <span class="ot">'</span><span class="ss">C</span><span class="ot">'</span>;</span>
<span id="cb703-59"><a aria-hidden="true" href="#cb703-59" tabindex="-1"></a>    </span>
<span id="cb703-60"><a aria-hidden="true" href="#cb703-60" tabindex="-1"></a>    <span class="co"># Clean environment of PostgreSQL-specific variables</span></span>
<span id="cb703-61"><a aria-hidden="true" href="#cb703-61" tabindex="-1"></a>    <span class="kw">my</span> <span class="dt">@envkeys</span> = <span class="ot">qw</span> <span class="ot">(</span></span>
<span id="cb703-62"><a aria-hidden="true" href="#cb703-62" tabindex="-1"></a>      PGCLIENTENCODING</span>
<span id="cb703-63"><a aria-hidden="true" href="#cb703-63" tabindex="-1"></a>      PGDATA</span>
<span id="cb703-64"><a aria-hidden="true" href="#cb703-64" tabindex="-1"></a>      PGDATABASE</span>
<span id="cb703-65"><a aria-hidden="true" href="#cb703-65" tabindex="-1"></a>      PGHOST</span>
<span id="cb703-66"><a aria-hidden="true" href="#cb703-66" tabindex="-1"></a>      PGPORT</span>
<span id="cb703-67"><a aria-hidden="true" href="#cb703-67" tabindex="-1"></a>      PGUSER</span>
<span id="cb703-68"><a aria-hidden="true" href="#cb703-68" tabindex="-1"></a>      # ... more</span>
<span id="cb703-69"><a aria-hidden="true" href="#cb703-69" tabindex="-1"></a>    <span class="ot">)</span>;</span>
<span id="cb703-70"><a aria-hidden="true" href="#cb703-70" tabindex="-1"></a>    <span class="fu">delete</span> <span class="dt">@ENV</span>{<span class="dt">@envkeys</span>};</span>
<span id="cb703-71"><a aria-hidden="true" href="#cb703-71" tabindex="-1"></a>    </span>
<span id="cb703-72"><a aria-hidden="true" href="#cb703-72" tabindex="-1"></a>    <span class="wa">$ENV</span>{PGAPPNAME} = basename(<span class="wa">$0</span>);</span>
<span id="cb703-73"><a aria-hidden="true" href="#cb703-73" tabindex="-1"></a>}</span></code></pre></div>
<h3 data-number="11.6.3" id="isolation-tests"><span class="header-section-number">11.6.3</span> Isolation Tests</h3>
<h4 data-number="11.6.3.1" id="homeuserpostgressrctestisolationreadme"><span class="header-section-number">11.6.3.1</span>
/home/user/postgres/src/test/isolation/README</h4>
<pre><code>Isolation tests
===============

This directory contains a set of tests for concurrent behaviors in
PostgreSQL. These tests require running multiple interacting transactions,
which requires management of multiple concurrent connections.

Test specification consists of four parts:

setup { &lt;SQL&gt; }
  - Executed once before running the test

teardown { &lt;SQL&gt; }
  - Executed once after the test is finished

session &lt;name&gt;
  - Each session is executed in its own connection
  - Contains setup, teardown, and steps

permutation &lt;step name&gt; ...
  - Specifies the order in which steps are run</code></pre>
<h4 data-number="11.6.3.2" id="example-isolation-test"><span class="header-section-number">11.6.3.2</span> Example Isolation
Test</h4>
<p><strong>/home/user/postgres/src/test/isolation/specs/deadlock-simple.spec</strong></p>
<pre><code># The deadlock detector has a special case for "simple" deadlocks.

setup
{
  CREATE TABLE a1 ();
}

teardown
{
  DROP TABLE a1;
}

session s1
setup       { BEGIN; }
step s1as   { LOCK TABLE a1 IN ACCESS SHARE MODE; }
step s1ae   { LOCK TABLE a1 IN ACCESS EXCLUSIVE MODE; }
step s1c    { COMMIT; }

session s2
setup       { BEGIN; }
step s2as   { LOCK TABLE a1 IN ACCESS SHARE MODE; }
step s2ae   { LOCK TABLE a1 IN ACCESS EXCLUSIVE MODE; }
step s2c    { COMMIT; }

permutation s1as s2as s1ae s2ae s1c s2c</code></pre>
<p>This test creates a deadlock scenario where both sessions hold ACCESS
SHARE locks and then try to upgrade to ACCESS EXCLUSIVE locks, which
will conflict.</p>
<hr/>
<h2 data-number="11.7" id="code-generation-tools"><span class="header-section-number">11.7</span> 6. Code Generation Tools</h2>
<h3 data-number="11.7.1" id="overview-19"><span class="header-section-number">11.7.1</span> Overview</h3>
<p>PostgreSQL uses Perl scripts to generate C code from catalog
definitions, ensuring consistency between data structures and the system
catalogs.</p>
<h3 data-number="11.7.2" id="main-code-generators"><span class="header-section-number">11.7.2</span> Main Code Generators</h3>
<h4 data-number="11.7.2.1" id="gen_fmgrtab.pl---function-manager-table-generator"><span class="header-section-number">11.7.2.1</span> 1. Gen_fmgrtab.pl -
Function Manager Table Generator</h4>
<p><strong>/home/user/postgres/src/backend/utils/Gen_fmgrtab.pl (Lines
1-100)</strong></p>
<div class="sourceCode" id="cb706"><pre class="sourceCode perl"><code class="sourceCode perl"><span id="cb706-1"><a aria-hidden="true" href="#cb706-1" tabindex="-1"></a><span class="kw">#!/usr/bin/perl</span></span>
<span id="cb706-2"><a aria-hidden="true" href="#cb706-2" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb706-3"><a aria-hidden="true" href="#cb706-3" tabindex="-1"></a><span class="co"># Gen_fmgrtab.pl</span></span>
<span id="cb706-4"><a aria-hidden="true" href="#cb706-4" tabindex="-1"></a><span class="co">#    Perl script that generates fmgroids.h, fmgrprotos.h, and fmgrtab.c</span></span>
<span id="cb706-5"><a aria-hidden="true" href="#cb706-5" tabindex="-1"></a><span class="co">#    from pg_proc.dat</span></span>
<span id="cb706-6"><a aria-hidden="true" href="#cb706-6" tabindex="-1"></a></span>
<span id="cb706-7"><a aria-hidden="true" href="#cb706-7" tabindex="-1"></a><span class="fu">use</span> Catalog;</span>
<span id="cb706-8"><a aria-hidden="true" href="#cb706-8" tabindex="-1"></a><span class="fu">use</span> <span class="kw">strict</span>;</span>
<span id="cb706-9"><a aria-hidden="true" href="#cb706-9" tabindex="-1"></a><span class="fu">use</span> <span class="kw">warnings</span> FATAL =&gt; <span class="ot">'</span><span class="ss">all</span><span class="ot">'</span>;</span>
<span id="cb706-10"><a aria-hidden="true" href="#cb706-10" tabindex="-1"></a><span class="fu">use</span> <span class="fu">Getopt::Long</span>;</span>
<span id="cb706-11"><a aria-hidden="true" href="#cb706-11" tabindex="-1"></a></span>
<span id="cb706-12"><a aria-hidden="true" href="#cb706-12" tabindex="-1"></a><span class="kw">my</span> <span class="dt">$output_path</span> = <span class="ot">''</span>;</span>
<span id="cb706-13"><a aria-hidden="true" href="#cb706-13" tabindex="-1"></a><span class="kw">my</span> <span class="dt">$include_path</span>;</span>
<span id="cb706-14"><a aria-hidden="true" href="#cb706-14" tabindex="-1"></a></span>
<span id="cb706-15"><a aria-hidden="true" href="#cb706-15" tabindex="-1"></a>GetOptions(</span>
<span id="cb706-16"><a aria-hidden="true" href="#cb706-16" tabindex="-1"></a>    <span class="ot">'</span><span class="ss">output:s</span><span class="ot">'</span> =&gt; \<span class="dt">$output_path</span>,</span>
<span id="cb706-17"><a aria-hidden="true" href="#cb706-17" tabindex="-1"></a>    <span class="ot">'</span><span class="ss">include-path:s</span><span class="ot">'</span> =&gt; \<span class="dt">$include_path</span>) || usage();</span>
<span id="cb706-18"><a aria-hidden="true" href="#cb706-18" tabindex="-1"></a></span>
<span id="cb706-19"><a aria-hidden="true" href="#cb706-19" tabindex="-1"></a><span class="co"># Make sure output_path ends in a slash</span></span>
<span id="cb706-20"><a aria-hidden="true" href="#cb706-20" tabindex="-1"></a><span class="cf">if</span> (<span class="dt">$output_path</span> <span class="ot">ne</span> <span class="ot">''</span> &amp;&amp; <span class="fu">substr</span>(<span class="dt">$output_path</span>, -<span class="dv">1</span>) <span class="ot">ne</span> <span class="ot">'</span><span class="ss">/</span><span class="ot">'</span>)</span>
<span id="cb706-21"><a aria-hidden="true" href="#cb706-21" tabindex="-1"></a>{</span>
<span id="cb706-22"><a aria-hidden="true" href="#cb706-22" tabindex="-1"></a>    <span class="dt">$output_path</span> .= <span class="ot">'</span><span class="ss">/</span><span class="ot">'</span>;</span>
<span id="cb706-23"><a aria-hidden="true" href="#cb706-23" tabindex="-1"></a>}</span>
<span id="cb706-24"><a aria-hidden="true" href="#cb706-24" tabindex="-1"></a></span>
<span id="cb706-25"><a aria-hidden="true" href="#cb706-25" tabindex="-1"></a><span class="co"># Sanity check arguments</span></span>
<span id="cb706-26"><a aria-hidden="true" href="#cb706-26" tabindex="-1"></a><span class="fu">die</span> <span class="ot">"</span><span class="st">No input files.</span><span class="ch">\n</span><span class="ot">"</span> <span class="cf">unless</span> <span class="wa">@ARGV</span>;</span>
<span id="cb706-27"><a aria-hidden="true" href="#cb706-27" tabindex="-1"></a><span class="fu">die</span> <span class="ot">"</span><span class="st">--include-path must be specified.</span><span class="ch">\n</span><span class="ot">"</span> <span class="cf">unless</span> <span class="dt">$include_path</span>;</span>
<span id="cb706-28"><a aria-hidden="true" href="#cb706-28" tabindex="-1"></a></span>
<span id="cb706-29"><a aria-hidden="true" href="#cb706-29" tabindex="-1"></a><span class="co"># Read all the input files into internal data structures</span></span>
<span id="cb706-30"><a aria-hidden="true" href="#cb706-30" tabindex="-1"></a><span class="kw">my</span> <span class="dt">%catalogs</span>;</span>
<span id="cb706-31"><a aria-hidden="true" href="#cb706-31" tabindex="-1"></a><span class="kw">my</span> <span class="dt">%catalog_data</span>;</span>
<span id="cb706-32"><a aria-hidden="true" href="#cb706-32" tabindex="-1"></a><span class="cf">foreach</span> <span class="kw">my</span> <span class="dt">$datfile</span> (<span class="wa">@ARGV</span>)</span>
<span id="cb706-33"><a aria-hidden="true" href="#cb706-33" tabindex="-1"></a>{</span>
<span id="cb706-34"><a aria-hidden="true" href="#cb706-34" tabindex="-1"></a>    <span class="dt">$datfile</span> =~ <span class="ot">/</span><span class="ch">(</span><span class="ot">.</span><span class="ch">+)</span><span class="ot">\.dat</span><span class="ch">$</span><span class="ot">/</span></span>
<span id="cb706-35"><a aria-hidden="true" href="#cb706-35" tabindex="-1"></a>      <span class="ot">or</span> <span class="fu">die</span> <span class="ot">"</span><span class="st">Input files need to be data (.dat) files.</span><span class="ch">\n</span><span class="ot">"</span>;</span>
<span id="cb706-36"><a aria-hidden="true" href="#cb706-36" tabindex="-1"></a>    </span>
<span id="cb706-37"><a aria-hidden="true" href="#cb706-37" tabindex="-1"></a>    <span class="kw">my</span> <span class="dt">$header</span> = <span class="ot">"</span><span class="wa">$1</span><span class="st">.h</span><span class="ot">"</span>;</span>
<span id="cb706-38"><a aria-hidden="true" href="#cb706-38" tabindex="-1"></a>    <span class="fu">die</span> <span class="ot">"</span><span class="st">There is no header file corresponding to </span><span class="dt">$datfile</span><span class="ot">"</span></span>
<span id="cb706-39"><a aria-hidden="true" href="#cb706-39" tabindex="-1"></a>      <span class="cf">if</span> !<span class="ot">-e</span> <span class="dt">$header</span>;</span>
<span id="cb706-40"><a aria-hidden="true" href="#cb706-40" tabindex="-1"></a>    </span>
<span id="cb706-41"><a aria-hidden="true" href="#cb706-41" tabindex="-1"></a>    <span class="kw">my</span> <span class="dt">$catalog</span> = <span class="fu">Catalog::ParseHeader</span>(<span class="dt">$</span>header);</span>
<span id="cb706-42"><a aria-hidden="true" href="#cb706-42" tabindex="-1"></a>    <span class="kw">my</span> <span class="dt">$catname</span> = <span class="dt">$catalog</span>-&gt;{catname};</span>
<span id="cb706-43"><a aria-hidden="true" href="#cb706-43" tabindex="-1"></a>    <span class="kw">my</span> <span class="dt">$schema</span> = <span class="dt">$catalog</span>-&gt;{columns};</span>
<span id="cb706-44"><a aria-hidden="true" href="#cb706-44" tabindex="-1"></a>    </span>
<span id="cb706-45"><a aria-hidden="true" href="#cb706-45" tabindex="-1"></a>    <span class="dt">$catalogs</span>{<span class="dt">$catname</span>} = <span class="dt">$catalog</span>;</span>
<span id="cb706-46"><a aria-hidden="true" href="#cb706-46" tabindex="-1"></a>    <span class="dt">$catalog_data</span>{<span class="dt">$catname</span>} = <span class="fu">Catalog::ParseData</span>(<span class="dt">$</span>datfile, <span class="dt">$schema</span>, <span class="dv">0</span>);</span>
<span id="cb706-47"><a aria-hidden="true" href="#cb706-47" tabindex="-1"></a>}</span>
<span id="cb706-48"><a aria-hidden="true" href="#cb706-48" tabindex="-1"></a></span>
<span id="cb706-49"><a aria-hidden="true" href="#cb706-49" tabindex="-1"></a><span class="co"># Collect certain fields from pg_proc.dat</span></span>
<span id="cb706-50"><a aria-hidden="true" href="#cb706-50" tabindex="-1"></a><span class="kw">my</span> <span class="dt">@fmgr</span> = ();</span>
<span id="cb706-51"><a aria-hidden="true" href="#cb706-51" tabindex="-1"></a><span class="kw">my</span> <span class="dt">%proname_counts</span>;</span>
<span id="cb706-52"><a aria-hidden="true" href="#cb706-52" tabindex="-1"></a></span>
<span id="cb706-53"><a aria-hidden="true" href="#cb706-53" tabindex="-1"></a><span class="cf">foreach</span> <span class="kw">my</span> <span class="dt">$row</span> (<span class="dt">@</span>{ <span class="dt">$catalog_data</span>{pg_proc} })</span>
<span id="cb706-54"><a aria-hidden="true" href="#cb706-54" tabindex="-1"></a>{</span>
<span id="cb706-55"><a aria-hidden="true" href="#cb706-55" tabindex="-1"></a>    <span class="kw">my</span> <span class="dt">%bki_values</span> = %<span class="dt">$row</span>;</span>
<span id="cb706-56"><a aria-hidden="true" href="#cb706-56" tabindex="-1"></a>    </span>
<span id="cb706-57"><a aria-hidden="true" href="#cb706-57" tabindex="-1"></a>    <span class="fu">push</span> <span class="dt">@fmgr</span>,</span>
<span id="cb706-58"><a aria-hidden="true" href="#cb706-58" tabindex="-1"></a>      {</span>
<span id="cb706-59"><a aria-hidden="true" href="#cb706-59" tabindex="-1"></a>        oid =&gt; <span class="dt">$bki_values</span>{oid},</span>
<span id="cb706-60"><a aria-hidden="true" href="#cb706-60" tabindex="-1"></a>        name =&gt; <span class="dt">$bki_values</span>{proname},</span>
<span id="cb706-61"><a aria-hidden="true" href="#cb706-61" tabindex="-1"></a>        lang =&gt; <span class="dt">$bki_values</span>{prolang},</span>
<span id="cb706-62"><a aria-hidden="true" href="#cb706-62" tabindex="-1"></a>        kind =&gt; <span class="dt">$bki_values</span>{prokind},</span>
<span id="cb706-63"><a aria-hidden="true" href="#cb706-63" tabindex="-1"></a>        <span class="kw">strict</span> =&gt; <span class="dt">$bki_values</span>{proisstrict},</span>
<span id="cb706-64"><a aria-hidden="true" href="#cb706-64" tabindex="-1"></a>        retset =&gt; <span class="dt">$bki_values</span>{proretset},</span>
<span id="cb706-65"><a aria-hidden="true" href="#cb706-65" tabindex="-1"></a>        nargs =&gt; <span class="dt">$bki_values</span>{pronargs},</span>
<span id="cb706-66"><a aria-hidden="true" href="#cb706-66" tabindex="-1"></a>        args =&gt; <span class="dt">$bki_values</span>{proargtypes},</span>
<span id="cb706-67"><a aria-hidden="true" href="#cb706-67" tabindex="-1"></a>        prosrc =&gt; <span class="dt">$bki_values</span>{prosrc},</span>
<span id="cb706-68"><a aria-hidden="true" href="#cb706-68" tabindex="-1"></a>      };</span>
<span id="cb706-69"><a aria-hidden="true" href="#cb706-69" tabindex="-1"></a>    </span>
<span id="cb706-70"><a aria-hidden="true" href="#cb706-70" tabindex="-1"></a>    <span class="co"># Count to detect overloaded pronames</span></span>
<span id="cb706-71"><a aria-hidden="true" href="#cb706-71" tabindex="-1"></a>    <span class="dt">$proname_counts</span>{ <span class="dt">$bki_values</span>{proname} }++;</span>
<span id="cb706-72"><a aria-hidden="true" href="#cb706-72" tabindex="-1"></a>}</span>
<span id="cb706-73"><a aria-hidden="true" href="#cb706-73" tabindex="-1"></a></span>
<span id="cb706-74"><a aria-hidden="true" href="#cb706-74" tabindex="-1"></a><span class="co"># Generate output files</span></span>
<span id="cb706-75"><a aria-hidden="true" href="#cb706-75" tabindex="-1"></a><span class="co"># - fmgroids.h: OID constants for functions</span></span>
<span id="cb706-76"><a aria-hidden="true" href="#cb706-76" tabindex="-1"></a><span class="co"># - fmgrprotos.h: Function prototypes</span></span>
<span id="cb706-77"><a aria-hidden="true" href="#cb706-77" tabindex="-1"></a><span class="co"># - fmgrtab.c: Function manager dispatch table</span></span></code></pre></div>
<p><strong>Generated Output Example (fmgroids.h):</strong></p>
<div class="sourceCode" id="cb707"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb707-1"><a aria-hidden="true" href="#cb707-1" tabindex="-1"></a><span class="co">/* Generated automatically by Gen_fmgrtab.pl */</span></span>
<span id="cb707-2"><a aria-hidden="true" href="#cb707-2" tabindex="-1"></a><span class="pp">#define F_BOOLIN </span><span class="dv">1242</span></span>
<span id="cb707-3"><a aria-hidden="true" href="#cb707-3" tabindex="-1"></a><span class="pp">#define F_BOOLOUT </span><span class="dv">1243</span></span>
<span id="cb707-4"><a aria-hidden="true" href="#cb707-4" tabindex="-1"></a><span class="pp">#define F_BYTEAIN </span><span class="dv">1244</span></span>
<span id="cb707-5"><a aria-hidden="true" href="#cb707-5" tabindex="-1"></a><span class="co">/* ... thousands more ... */</span></span></code></pre></div>
<h4 data-number="11.7.2.2" id="genbki.pl---bootstrap-catalog-generator"><span class="header-section-number">11.7.2.2</span> 2. genbki.pl - Bootstrap
Catalog Generator</h4>
<p><strong>/home/user/postgres/src/backend/catalog/genbki.pl (Lines
1-100)</strong></p>
<div class="sourceCode" id="cb708"><pre class="sourceCode perl"><code class="sourceCode perl"><span id="cb708-1"><a aria-hidden="true" href="#cb708-1" tabindex="-1"></a><span class="kw">#!/usr/bin/perl</span></span>
<span id="cb708-2"><a aria-hidden="true" href="#cb708-2" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb708-3"><a aria-hidden="true" href="#cb708-3" tabindex="-1"></a><span class="co"># genbki.pl</span></span>
<span id="cb708-4"><a aria-hidden="true" href="#cb708-4" tabindex="-1"></a><span class="co">#    Perl script that generates postgres.bki and symbol definition</span></span>
<span id="cb708-5"><a aria-hidden="true" href="#cb708-5" tabindex="-1"></a><span class="co">#    headers from specially formatted header files and data files.</span></span>
<span id="cb708-6"><a aria-hidden="true" href="#cb708-6" tabindex="-1"></a><span class="co">#    postgres.bki is used to initialize the postgres template database.</span></span>
<span id="cb708-7"><a aria-hidden="true" href="#cb708-7" tabindex="-1"></a></span>
<span id="cb708-8"><a aria-hidden="true" href="#cb708-8" tabindex="-1"></a><span class="fu">use</span> <span class="kw">strict</span>;</span>
<span id="cb708-9"><a aria-hidden="true" href="#cb708-9" tabindex="-1"></a><span class="fu">use</span> <span class="kw">warnings</span> FATAL =&gt; <span class="ot">'</span><span class="ss">all</span><span class="ot">'</span>;</span>
<span id="cb708-10"><a aria-hidden="true" href="#cb708-10" tabindex="-1"></a><span class="fu">use</span> <span class="fu">Getopt::Long</span>;</span>
<span id="cb708-11"><a aria-hidden="true" href="#cb708-11" tabindex="-1"></a><span class="fu">use</span> FindBin;</span>
<span id="cb708-12"><a aria-hidden="true" href="#cb708-12" tabindex="-1"></a><span class="fu">use</span> lib <span class="dt">$FindBin</span>::<span class="dt">RealBin</span>;</span>
<span id="cb708-13"><a aria-hidden="true" href="#cb708-13" tabindex="-1"></a><span class="fu">use</span> Catalog;</span>
<span id="cb708-14"><a aria-hidden="true" href="#cb708-14" tabindex="-1"></a></span>
<span id="cb708-15"><a aria-hidden="true" href="#cb708-15" tabindex="-1"></a><span class="kw">my</span> <span class="dt">$output_path</span> = <span class="ot">''</span>;</span>
<span id="cb708-16"><a aria-hidden="true" href="#cb708-16" tabindex="-1"></a><span class="kw">my</span> <span class="dt">$major_version</span>;</span>
<span id="cb708-17"><a aria-hidden="true" href="#cb708-17" tabindex="-1"></a><span class="kw">my</span> <span class="dt">$include_path</span>;</span>
<span id="cb708-18"><a aria-hidden="true" href="#cb708-18" tabindex="-1"></a><span class="kw">my</span> <span class="dt">$num_errors</span> = <span class="dv">0</span>;</span>
<span id="cb708-19"><a aria-hidden="true" href="#cb708-19" tabindex="-1"></a></span>
<span id="cb708-20"><a aria-hidden="true" href="#cb708-20" tabindex="-1"></a>GetOptions(</span>
<span id="cb708-21"><a aria-hidden="true" href="#cb708-21" tabindex="-1"></a>    <span class="ot">'</span><span class="ss">output:s</span><span class="ot">'</span> =&gt; \<span class="dt">$output_path</span>,</span>
<span id="cb708-22"><a aria-hidden="true" href="#cb708-22" tabindex="-1"></a>    <span class="ot">'</span><span class="ss">set-version:s</span><span class="ot">'</span> =&gt; \<span class="dt">$major_version</span>,</span>
<span id="cb708-23"><a aria-hidden="true" href="#cb708-23" tabindex="-1"></a>    <span class="ot">'</span><span class="ss">include-path:s</span><span class="ot">'</span> =&gt; \<span class="dt">$include_path</span>) || usage();</span>
<span id="cb708-24"><a aria-hidden="true" href="#cb708-24" tabindex="-1"></a></span>
<span id="cb708-25"><a aria-hidden="true" href="#cb708-25" tabindex="-1"></a><span class="co"># Sanity check arguments</span></span>
<span id="cb708-26"><a aria-hidden="true" href="#cb708-26" tabindex="-1"></a><span class="fu">die</span> <span class="ot">"</span><span class="st">No input files.</span><span class="ch">\n</span><span class="ot">"</span> <span class="cf">unless</span> <span class="wa">@ARGV</span>;</span>
<span id="cb708-27"><a aria-hidden="true" href="#cb708-27" tabindex="-1"></a><span class="fu">die</span> <span class="ot">"</span><span class="st">--set-version must be specified.</span><span class="ch">\n</span><span class="ot">"</span> <span class="cf">unless</span> <span class="dt">$major_version</span>;</span>
<span id="cb708-28"><a aria-hidden="true" href="#cb708-28" tabindex="-1"></a><span class="fu">die</span> <span class="ot">"</span><span class="st">Invalid version string: </span><span class="dt">$major_version</span><span class="ch">\n</span><span class="ot">"</span></span>
<span id="cb708-29"><a aria-hidden="true" href="#cb708-29" tabindex="-1"></a>  <span class="cf">unless</span> <span class="dt">$major_version</span> =~ <span class="ot">/</span><span class="ch">^</span><span class="bn">\d</span><span class="ch">+$</span><span class="ot">/</span>;</span>
<span id="cb708-30"><a aria-hidden="true" href="#cb708-30" tabindex="-1"></a><span class="fu">die</span> <span class="ot">"</span><span class="st">--include-path must be specified.</span><span class="ch">\n</span><span class="ot">"</span> <span class="cf">unless</span> <span class="dt">$include_path</span>;</span>
<span id="cb708-31"><a aria-hidden="true" href="#cb708-31" tabindex="-1"></a></span>
<span id="cb708-32"><a aria-hidden="true" href="#cb708-32" tabindex="-1"></a><span class="co"># Read all the files into internal data structures</span></span>
<span id="cb708-33"><a aria-hidden="true" href="#cb708-33" tabindex="-1"></a><span class="kw">my</span> <span class="dt">@catnames</span>;</span>
<span id="cb708-34"><a aria-hidden="true" href="#cb708-34" tabindex="-1"></a><span class="kw">my</span> <span class="dt">%catalogs</span>;</span>
<span id="cb708-35"><a aria-hidden="true" href="#cb708-35" tabindex="-1"></a><span class="kw">my</span> <span class="dt">%catalog_data</span>;</span>
<span id="cb708-36"><a aria-hidden="true" href="#cb708-36" tabindex="-1"></a><span class="kw">my</span> <span class="dt">@toast_decls</span>;</span>
<span id="cb708-37"><a aria-hidden="true" href="#cb708-37" tabindex="-1"></a><span class="kw">my</span> <span class="dt">@index_decls</span>;</span>
<span id="cb708-38"><a aria-hidden="true" href="#cb708-38" tabindex="-1"></a><span class="kw">my</span> <span class="dt">%syscaches</span>;</span>
<span id="cb708-39"><a aria-hidden="true" href="#cb708-39" tabindex="-1"></a></span>
<span id="cb708-40"><a aria-hidden="true" href="#cb708-40" tabindex="-1"></a><span class="cf">foreach</span> <span class="kw">my</span> <span class="dt">$header</span> (<span class="wa">@ARGV</span>)</span>
<span id="cb708-41"><a aria-hidden="true" href="#cb708-41" tabindex="-1"></a>{</span>
<span id="cb708-42"><a aria-hidden="true" href="#cb708-42" tabindex="-1"></a>    <span class="dt">$header</span> =~ <span class="ot">/</span><span class="ch">(</span><span class="ot">.</span><span class="ch">+)</span><span class="ot">\.h</span><span class="ch">$</span><span class="ot">/</span></span>
<span id="cb708-43"><a aria-hidden="true" href="#cb708-43" tabindex="-1"></a>      <span class="ot">or</span> <span class="fu">die</span> <span class="ot">"</span><span class="st">Input files need to be header files.</span><span class="ch">\n</span><span class="ot">"</span>;</span>
<span id="cb708-44"><a aria-hidden="true" href="#cb708-44" tabindex="-1"></a>    <span class="kw">my</span> <span class="dt">$datfile</span> = <span class="ot">"</span><span class="wa">$1</span><span class="st">.dat</span><span class="ot">"</span>;</span>
<span id="cb708-45"><a aria-hidden="true" href="#cb708-45" tabindex="-1"></a>    </span>
<span id="cb708-46"><a aria-hidden="true" href="#cb708-46" tabindex="-1"></a>    <span class="kw">my</span> <span class="dt">$catalog</span> = <span class="fu">Catalog::ParseHeader</span>(<span class="dt">$</span>header);</span>
<span id="cb708-47"><a aria-hidden="true" href="#cb708-47" tabindex="-1"></a>    <span class="kw">my</span> <span class="dt">$catname</span> = <span class="dt">$catalog</span>-&gt;{catname};</span>
<span id="cb708-48"><a aria-hidden="true" href="#cb708-48" tabindex="-1"></a>    <span class="kw">my</span> <span class="dt">$schema</span> = <span class="dt">$catalog</span>-&gt;{columns};</span>
<span id="cb708-49"><a aria-hidden="true" href="#cb708-49" tabindex="-1"></a>    </span>
<span id="cb708-50"><a aria-hidden="true" href="#cb708-50" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">defined</span> <span class="dt">$catname</span>)</span>
<span id="cb708-51"><a aria-hidden="true" href="#cb708-51" tabindex="-1"></a>    {</span>
<span id="cb708-52"><a aria-hidden="true" href="#cb708-52" tabindex="-1"></a>        <span class="fu">push</span> <span class="dt">@catnames</span>, <span class="dt">$catname</span>;</span>
<span id="cb708-53"><a aria-hidden="true" href="#cb708-53" tabindex="-1"></a>        <span class="dt">$catalogs</span>{<span class="dt">$catname</span>} = <span class="dt">$catalog</span>;</span>
<span id="cb708-54"><a aria-hidden="true" href="#cb708-54" tabindex="-1"></a>    }</span>
<span id="cb708-55"><a aria-hidden="true" href="#cb708-55" tabindex="-1"></a>    </span>
<span id="cb708-56"><a aria-hidden="true" href="#cb708-56" tabindex="-1"></a>    <span class="co"># Not all catalogs have a data file</span></span>
<span id="cb708-57"><a aria-hidden="true" href="#cb708-57" tabindex="-1"></a>    <span class="cf">if</span> (<span class="ot">-e</span> <span class="dt">$datfile</span>)</span>
<span id="cb708-58"><a aria-hidden="true" href="#cb708-58" tabindex="-1"></a>    {</span>
<span id="cb708-59"><a aria-hidden="true" href="#cb708-59" tabindex="-1"></a>        <span class="kw">my</span> <span class="dt">$data</span> = <span class="fu">Catalog::ParseData</span>(<span class="dt">$</span>datfile, <span class="dt">$schema</span>, <span class="dv">0</span>);</span>
<span id="cb708-60"><a aria-hidden="true" href="#cb708-60" tabindex="-1"></a>        <span class="dt">$catalog_data</span>{<span class="dt">$catname</span>} = <span class="dt">$data</span>;</span>
<span id="cb708-61"><a aria-hidden="true" href="#cb708-61" tabindex="-1"></a>    }</span>
<span id="cb708-62"><a aria-hidden="true" href="#cb708-62" tabindex="-1"></a>}</span></code></pre></div>
<h3 data-number="11.7.3" id="catalog-data-format"><span class="header-section-number">11.7.3</span> Catalog Data Format</h3>
<h4 data-number="11.7.3.1" id="homeuserpostgressrcincludecatalogpg_proc.h-lines-1-100"><span class="header-section-number">11.7.3.1</span>
/home/user/postgres/src/include/catalog/pg_proc.h (Lines 1-100)</h4>
<div class="sourceCode" id="cb709"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb709-1"><a aria-hidden="true" href="#cb709-1" tabindex="-1"></a><span class="co">/*</span></span>
<span id="cb709-2"><a aria-hidden="true" href="#cb709-2" tabindex="-1"></a><span class="co"> * pg_proc.h</span></span>
<span id="cb709-3"><a aria-hidden="true" href="#cb709-3" tabindex="-1"></a><span class="co"> *   definition of the "procedure" system catalog (pg_proc)</span></span>
<span id="cb709-4"><a aria-hidden="true" href="#cb709-4" tabindex="-1"></a><span class="co"> *</span></span>
<span id="cb709-5"><a aria-hidden="true" href="#cb709-5" tabindex="-1"></a><span class="co"> * NOTES</span></span>
<span id="cb709-6"><a aria-hidden="true" href="#cb709-6" tabindex="-1"></a><span class="co"> *   The Catalog.pm module reads this file and derives schema</span></span>
<span id="cb709-7"><a aria-hidden="true" href="#cb709-7" tabindex="-1"></a><span class="co"> *   information.</span></span>
<span id="cb709-8"><a aria-hidden="true" href="#cb709-8" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb709-9"><a aria-hidden="true" href="#cb709-9" tabindex="-1"></a><span class="pp">#ifndef PG_PROC_H</span></span>
<span id="cb709-10"><a aria-hidden="true" href="#cb709-10" tabindex="-1"></a><span class="pp">#define PG_PROC_H</span></span>
<span id="cb709-11"><a aria-hidden="true" href="#cb709-11" tabindex="-1"></a></span>
<span id="cb709-12"><a aria-hidden="true" href="#cb709-12" tabindex="-1"></a><span class="pp">#include </span><span class="im">"catalog/genbki.h"</span></span>
<span id="cb709-13"><a aria-hidden="true" href="#cb709-13" tabindex="-1"></a></span>
<span id="cb709-14"><a aria-hidden="true" href="#cb709-14" tabindex="-1"></a>CATALOG<span class="op">(</span>pg_proc<span class="op">,</span><span class="dv">1255</span><span class="op">,</span>ProcedureRelationId<span class="op">)</span> BKI_BOOTSTRAP BKI_ROWTYPE_OID<span class="op">(</span><span class="dv">81</span><span class="op">,</span>ProcedureRelation_Rowtype_Id<span class="op">)</span></span>
<span id="cb709-15"><a aria-hidden="true" href="#cb709-15" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb709-16"><a aria-hidden="true" href="#cb709-16" tabindex="-1"></a>    Oid         oid<span class="op">;</span>            <span class="co">/* oid */</span></span>
<span id="cb709-17"><a aria-hidden="true" href="#cb709-17" tabindex="-1"></a>    </span>
<span id="cb709-18"><a aria-hidden="true" href="#cb709-18" tabindex="-1"></a>    <span class="co">/* procedure name */</span></span>
<span id="cb709-19"><a aria-hidden="true" href="#cb709-19" tabindex="-1"></a>    NameData    proname<span class="op">;</span></span>
<span id="cb709-20"><a aria-hidden="true" href="#cb709-20" tabindex="-1"></a>    </span>
<span id="cb709-21"><a aria-hidden="true" href="#cb709-21" tabindex="-1"></a>    <span class="co">/* OID of namespace containing this proc */</span></span>
<span id="cb709-22"><a aria-hidden="true" href="#cb709-22" tabindex="-1"></a>    Oid         pronamespace BKI_DEFAULT<span class="op">(</span>pg_catalog<span class="op">)</span> BKI_LOOKUP<span class="op">(</span>pg_namespace<span class="op">);</span></span>
<span id="cb709-23"><a aria-hidden="true" href="#cb709-23" tabindex="-1"></a>    </span>
<span id="cb709-24"><a aria-hidden="true" href="#cb709-24" tabindex="-1"></a>    <span class="co">/* procedure owner */</span></span>
<span id="cb709-25"><a aria-hidden="true" href="#cb709-25" tabindex="-1"></a>    Oid         proowner BKI_DEFAULT<span class="op">(</span>POSTGRES<span class="op">)</span> BKI_LOOKUP<span class="op">(</span>pg_authid<span class="op">);</span></span>
<span id="cb709-26"><a aria-hidden="true" href="#cb709-26" tabindex="-1"></a>    </span>
<span id="cb709-27"><a aria-hidden="true" href="#cb709-27" tabindex="-1"></a>    <span class="co">/* OID of pg_language entry */</span></span>
<span id="cb709-28"><a aria-hidden="true" href="#cb709-28" tabindex="-1"></a>    Oid         prolang BKI_DEFAULT<span class="op">(</span>internal<span class="op">)</span> BKI_LOOKUP<span class="op">(</span>pg_language<span class="op">);</span></span>
<span id="cb709-29"><a aria-hidden="true" href="#cb709-29" tabindex="-1"></a>    </span>
<span id="cb709-30"><a aria-hidden="true" href="#cb709-30" tabindex="-1"></a>    <span class="co">/* estimated execution cost */</span></span>
<span id="cb709-31"><a aria-hidden="true" href="#cb709-31" tabindex="-1"></a>    float4      procost BKI_DEFAULT<span class="op">(</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb709-32"><a aria-hidden="true" href="#cb709-32" tabindex="-1"></a>    </span>
<span id="cb709-33"><a aria-hidden="true" href="#cb709-33" tabindex="-1"></a>    <span class="co">/* estimated # of rows out (if proretset) */</span></span>
<span id="cb709-34"><a aria-hidden="true" href="#cb709-34" tabindex="-1"></a>    float4      prorows BKI_DEFAULT<span class="op">(</span><span class="dv">0</span><span class="op">);</span></span>
<span id="cb709-35"><a aria-hidden="true" href="#cb709-35" tabindex="-1"></a>    </span>
<span id="cb709-36"><a aria-hidden="true" href="#cb709-36" tabindex="-1"></a>    <span class="co">/* see PROKIND_ categories below */</span></span>
<span id="cb709-37"><a aria-hidden="true" href="#cb709-37" tabindex="-1"></a>    <span class="dt">char</span>        prokind BKI_DEFAULT<span class="op">(</span>f<span class="op">);</span></span>
<span id="cb709-38"><a aria-hidden="true" href="#cb709-38" tabindex="-1"></a>    </span>
<span id="cb709-39"><a aria-hidden="true" href="#cb709-39" tabindex="-1"></a>    <span class="co">/* strict with respect to NULLs? */</span></span>
<span id="cb709-40"><a aria-hidden="true" href="#cb709-40" tabindex="-1"></a>    <span class="dt">bool</span>        proisstrict BKI_DEFAULT<span class="op">(</span>t<span class="op">);</span></span>
<span id="cb709-41"><a aria-hidden="true" href="#cb709-41" tabindex="-1"></a>    </span>
<span id="cb709-42"><a aria-hidden="true" href="#cb709-42" tabindex="-1"></a>    <span class="co">/* returns a set? */</span></span>
<span id="cb709-43"><a aria-hidden="true" href="#cb709-43" tabindex="-1"></a>    <span class="dt">bool</span>        proretset BKI_DEFAULT<span class="op">(</span>f<span class="op">);</span></span>
<span id="cb709-44"><a aria-hidden="true" href="#cb709-44" tabindex="-1"></a>    </span>
<span id="cb709-45"><a aria-hidden="true" href="#cb709-45" tabindex="-1"></a>    <span class="co">/* OID of result type */</span></span>
<span id="cb709-46"><a aria-hidden="true" href="#cb709-46" tabindex="-1"></a>    Oid         prorettype BKI_LOOKUP<span class="op">(</span>pg_type<span class="op">);</span></span>
<span id="cb709-47"><a aria-hidden="true" href="#cb709-47" tabindex="-1"></a>    </span>
<span id="cb709-48"><a aria-hidden="true" href="#cb709-48" tabindex="-1"></a>    <span class="co">/* parameter types (excludes OUT params) */</span></span>
<span id="cb709-49"><a aria-hidden="true" href="#cb709-49" tabindex="-1"></a>    oidvector   proargtypes BKI_LOOKUP<span class="op">(</span>pg_type<span class="op">)</span> BKI_FORCE_NOT_NULL<span class="op">;</span></span></code></pre></div>
<h4 data-number="11.7.3.2" id="catalog-data-file-example"><span class="header-section-number">11.7.3.2</span> Catalog Data File
Example</h4>
<div class="sourceCode" id="cb710"><pre class="sourceCode perl"><code class="sourceCode perl"><span id="cb710-1"><a aria-hidden="true" href="#cb710-1" tabindex="-1"></a><span class="co"># src/include/catalog/pg_proc.dat</span></span>
<span id="cb710-2"><a aria-hidden="true" href="#cb710-2" tabindex="-1"></a><span class="co"># Initial contents of the pg_proc system catalog</span></span>
<span id="cb710-3"><a aria-hidden="true" href="#cb710-3" tabindex="-1"></a></span>
<span id="cb710-4"><a aria-hidden="true" href="#cb710-4" tabindex="-1"></a>[</span>
<span id="cb710-5"><a aria-hidden="true" href="#cb710-5" tabindex="-1"></a></span>
<span id="cb710-6"><a aria-hidden="true" href="#cb710-6" tabindex="-1"></a><span class="co"># OIDS 1 - 99</span></span>
<span id="cb710-7"><a aria-hidden="true" href="#cb710-7" tabindex="-1"></a></span>
<span id="cb710-8"><a aria-hidden="true" href="#cb710-8" tabindex="-1"></a>{ oid =&gt; <span class="ot">'</span><span class="ss">1242</span><span class="ot">'</span>, descr =&gt; <span class="ot">'</span><span class="ss">I/O</span><span class="ot">'</span>,</span>
<span id="cb710-9"><a aria-hidden="true" href="#cb710-9" tabindex="-1"></a>  proname =&gt; <span class="ot">'</span><span class="ss">boolin</span><span class="ot">'</span>, prorettype =&gt; <span class="ot">'</span><span class="ss">bool</span><span class="ot">'</span>, proargtypes =&gt; <span class="ot">'</span><span class="ss">cstring</span><span class="ot">'</span>,</span>
<span id="cb710-10"><a aria-hidden="true" href="#cb710-10" tabindex="-1"></a>  prosrc =&gt; <span class="ot">'</span><span class="ss">boolin</span><span class="ot">'</span> },</span>
<span id="cb710-11"><a aria-hidden="true" href="#cb710-11" tabindex="-1"></a>  </span>
<span id="cb710-12"><a aria-hidden="true" href="#cb710-12" tabindex="-1"></a>{ oid =&gt; <span class="ot">'</span><span class="ss">1243</span><span class="ot">'</span>, descr =&gt; <span class="ot">'</span><span class="ss">I/O</span><span class="ot">'</span>,</span>
<span id="cb710-13"><a aria-hidden="true" href="#cb710-13" tabindex="-1"></a>  proname =&gt; <span class="ot">'</span><span class="ss">boolout</span><span class="ot">'</span>, prorettype =&gt; <span class="ot">'</span><span class="ss">cstring</span><span class="ot">'</span>, proargtypes =&gt; <span class="ot">'</span><span class="ss">bool</span><span class="ot">'</span>,</span>
<span id="cb710-14"><a aria-hidden="true" href="#cb710-14" tabindex="-1"></a>  prosrc =&gt; <span class="ot">'</span><span class="ss">boolout</span><span class="ot">'</span> },</span>
<span id="cb710-15"><a aria-hidden="true" href="#cb710-15" tabindex="-1"></a>  </span>
<span id="cb710-16"><a aria-hidden="true" href="#cb710-16" tabindex="-1"></a>{ oid =&gt; <span class="ot">'</span><span class="ss">1244</span><span class="ot">'</span>, descr =&gt; <span class="ot">'</span><span class="ss">I/O</span><span class="ot">'</span>,</span>
<span id="cb710-17"><a aria-hidden="true" href="#cb710-17" tabindex="-1"></a>  proname =&gt; <span class="ot">'</span><span class="ss">byteain</span><span class="ot">'</span>, prorettype =&gt; <span class="ot">'</span><span class="ss">bytea</span><span class="ot">'</span>, proargtypes =&gt; <span class="ot">'</span><span class="ss">cstring</span><span class="ot">'</span>,</span>
<span id="cb710-18"><a aria-hidden="true" href="#cb710-18" tabindex="-1"></a>  prosrc =&gt; <span class="ot">'</span><span class="ss">byteain</span><span class="ot">'</span> },</span>
<span id="cb710-19"><a aria-hidden="true" href="#cb710-19" tabindex="-1"></a></span>
<span id="cb710-20"><a aria-hidden="true" href="#cb710-20" tabindex="-1"></a><span class="co"># ... thousands more entries ...</span></span>
<span id="cb710-21"><a aria-hidden="true" href="#cb710-21" tabindex="-1"></a>]</span></code></pre></div>
<h3 data-number="11.7.4" id="other-code-generators"><span class="header-section-number">11.7.4</span> Other Code Generators</h3>
<p><strong>Code generation tools in PostgreSQL:</strong></p>
<ol type="1">
<li><strong>Gen_fmgrtab.pl</strong> - Generates function manager
tables</li>
<li><strong>genbki.pl</strong> - Generates bootstrap catalog data</li>
<li><strong>gen_node_support.pl</strong> - Generates node
copy/equal/read/write functions</li>
<li><strong>generate-lwlocknames.pl</strong> - Generates lightweight
lock definitions</li>
<li><strong>Gen_dummy_probes.pl</strong> - Generates dummy DTrace probe
definitions</li>
<li><strong>generate-wait_event_types.pl</strong> - Generates wait event
type definitions</li>
<li><strong>gen_guc_tables.pl</strong> - Generates GUC (configuration)
tables</li>
<li><strong>gen_keywordlist.pl</strong> - Generates keyword lookup
tables</li>
<li>**generate-unicode_*.pl** - Generates Unicode normalization
tables</li>
</ol>
<hr/>
<h2 data-number="11.8" id="documentation-build-system"><span class="header-section-number">11.8</span> 7. Documentation Build
System</h2>
<h3 data-number="11.8.1" id="overview-20"><span class="header-section-number">11.8.1</span> Overview</h3>
<p>PostgreSQL‚Äôs documentation is written in DocBook SGML and built into
HTML, man pages, and PDF formats.</p>
<h3 data-number="11.8.2" id="build-configuration"><span class="header-section-number">11.8.2</span> Build Configuration</h3>
<h4 data-number="11.8.2.1" id="homeuserpostgresdocsrcsgmlmakefile-lines-1-100"><span class="header-section-number">11.8.2.1</span>
/home/user/postgres/doc/src/sgml/Makefile (Lines 1-100)</h4>
<div class="sourceCode" id="cb711"><pre class="sourceCode makefile"><code class="sourceCode makefile"><span id="cb711-1"><a aria-hidden="true" href="#cb711-1" tabindex="-1"></a><span class="co">#----------------------------------------------------------------------------</span></span>
<span id="cb711-2"><a aria-hidden="true" href="#cb711-2" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb711-3"><a aria-hidden="true" href="#cb711-3" tabindex="-1"></a><span class="co"># PostgreSQL documentation makefile</span></span>
<span id="cb711-4"><a aria-hidden="true" href="#cb711-4" tabindex="-1"></a><span class="co"># doc/src/sgml/Makefile</span></span>
<span id="cb711-5"><a aria-hidden="true" href="#cb711-5" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb711-6"><a aria-hidden="true" href="#cb711-6" tabindex="-1"></a><span class="co">#----------------------------------------------------------------------------</span></span>
<span id="cb711-7"><a aria-hidden="true" href="#cb711-7" tabindex="-1"></a></span>
<span id="cb711-8"><a aria-hidden="true" href="#cb711-8" tabindex="-1"></a><span class="co"># Make "html" the default target</span></span>
<span id="cb711-9"><a aria-hidden="true" href="#cb711-9" tabindex="-1"></a><span class="dv">html:</span></span>
<span id="cb711-10"><a aria-hidden="true" href="#cb711-10" tabindex="-1"></a><span class="co"># Note that all is *not* the default target in this directory</span></span>
<span id="cb711-11"><a aria-hidden="true" href="#cb711-11" tabindex="-1"></a><span class="dv">all:</span><span class="dt"> html man</span></span>
<span id="cb711-12"><a aria-hidden="true" href="#cb711-12" tabindex="-1"></a></span>
<span id="cb711-13"><a aria-hidden="true" href="#cb711-13" tabindex="-1"></a><span class="dt">subdir</span> <span class="ch">=</span><span class="st"> doc/src/sgml</span></span>
<span id="cb711-14"><a aria-hidden="true" href="#cb711-14" tabindex="-1"></a><span class="dt">top_builddir</span> <span class="ch">=</span><span class="st"> ../../..</span></span>
<span id="cb711-15"><a aria-hidden="true" href="#cb711-15" tabindex="-1"></a><span class="kw">include</span> <span class="ch">$(</span><span class="dt">top_builddir</span><span class="ch">)</span>/src/Makefile.global</span>
<span id="cb711-16"><a aria-hidden="true" href="#cb711-16" tabindex="-1"></a></span>
<span id="cb711-17"><a aria-hidden="true" href="#cb711-17" tabindex="-1"></a><span class="cf">ifndef</span> DBTOEPUB</span>
<span id="cb711-18"><a aria-hidden="true" href="#cb711-18" tabindex="-1"></a><span class="dt">DBTOEPUB</span> <span class="ch">=</span><span class="st"> </span><span class="ch">$(</span><span class="dt">missing</span><span class="ch">)</span><span class="st"> dbtoepub</span></span>
<span id="cb711-19"><a aria-hidden="true" href="#cb711-19" tabindex="-1"></a><span class="cf">endif</span></span>
<span id="cb711-20"><a aria-hidden="true" href="#cb711-20" tabindex="-1"></a></span>
<span id="cb711-21"><a aria-hidden="true" href="#cb711-21" tabindex="-1"></a><span class="cf">ifndef</span> FOP</span>
<span id="cb711-22"><a aria-hidden="true" href="#cb711-22" tabindex="-1"></a><span class="dt">FOP</span> <span class="ch">=</span><span class="st"> </span><span class="ch">$(</span><span class="dt">missing</span><span class="ch">)</span><span class="st"> fop</span></span>
<span id="cb711-23"><a aria-hidden="true" href="#cb711-23" tabindex="-1"></a><span class="cf">endif</span></span>
<span id="cb711-24"><a aria-hidden="true" href="#cb711-24" tabindex="-1"></a></span>
<span id="cb711-25"><a aria-hidden="true" href="#cb711-25" tabindex="-1"></a><span class="dt">PANDOC</span> <span class="ch">=</span><span class="st"> pandoc</span></span>
<span id="cb711-26"><a aria-hidden="true" href="#cb711-26" tabindex="-1"></a></span>
<span id="cb711-27"><a aria-hidden="true" href="#cb711-27" tabindex="-1"></a><span class="dt">XMLINCLUDE</span> <span class="ch">=</span><span class="st"> --path . --path </span><span class="ch">$(</span><span class="dt">srcdir</span><span class="ch">)</span></span>
<span id="cb711-28"><a aria-hidden="true" href="#cb711-28" tabindex="-1"></a></span>
<span id="cb711-29"><a aria-hidden="true" href="#cb711-29" tabindex="-1"></a><span class="cf">ifdef</span> XMLLINT</span>
<span id="cb711-30"><a aria-hidden="true" href="#cb711-30" tabindex="-1"></a><span class="dt">XMLLINT</span> <span class="ch">:=</span><span class="st"> </span><span class="ch">$(</span><span class="dt">XMLLINT</span><span class="ch">)</span><span class="st"> --nonet</span></span>
<span id="cb711-31"><a aria-hidden="true" href="#cb711-31" tabindex="-1"></a><span class="cf">else</span></span>
<span id="cb711-32"><a aria-hidden="true" href="#cb711-32" tabindex="-1"></a><span class="dt">XMLLINT</span> <span class="ch">=</span><span class="st"> </span><span class="ch">$(</span><span class="dt">missing</span><span class="ch">)</span><span class="st"> xmllint</span></span>
<span id="cb711-33"><a aria-hidden="true" href="#cb711-33" tabindex="-1"></a><span class="cf">endif</span></span>
<span id="cb711-34"><a aria-hidden="true" href="#cb711-34" tabindex="-1"></a></span>
<span id="cb711-35"><a aria-hidden="true" href="#cb711-35" tabindex="-1"></a><span class="cf">ifdef</span> XSLTPROC</span>
<span id="cb711-36"><a aria-hidden="true" href="#cb711-36" tabindex="-1"></a><span class="dt">XSLTPROC</span> <span class="ch">:=</span><span class="st"> </span><span class="ch">$(</span><span class="dt">XSLTPROC</span><span class="ch">)</span><span class="st"> --nonet</span></span>
<span id="cb711-37"><a aria-hidden="true" href="#cb711-37" tabindex="-1"></a><span class="cf">else</span></span>
<span id="cb711-38"><a aria-hidden="true" href="#cb711-38" tabindex="-1"></a><span class="dt">XSLTPROC</span> <span class="ch">=</span><span class="st"> </span><span class="ch">$(</span><span class="dt">missing</span><span class="ch">)</span><span class="st"> xsltproc</span></span>
<span id="cb711-39"><a aria-hidden="true" href="#cb711-39" tabindex="-1"></a><span class="cf">endif</span></span>
<span id="cb711-40"><a aria-hidden="true" href="#cb711-40" tabindex="-1"></a></span>
<span id="cb711-41"><a aria-hidden="true" href="#cb711-41" tabindex="-1"></a><span class="kw">override</span> <span class="dt">XSLTPROCFLAGS </span><span class="ch">+=</span><span class="st"> --stringparam pg.version '</span><span class="ch">$(</span><span class="dt">VERSION</span><span class="ch">)</span><span class="st">'</span></span>
<span id="cb711-42"><a aria-hidden="true" href="#cb711-42" tabindex="-1"></a></span>
<span id="cb711-43"><a aria-hidden="true" href="#cb711-43" tabindex="-1"></a><span class="co"># Generated SGML files</span></span>
<span id="cb711-44"><a aria-hidden="true" href="#cb711-44" tabindex="-1"></a><span class="dt">GENERATED_SGML</span> <span class="ch">=</span><span class="st"> version.sgml </span><span class="ch">\</span></span>
<span id="cb711-45"><a aria-hidden="true" href="#cb711-45" tabindex="-1"></a><span class="st">    features-supported.sgml features-unsupported.sgml errcodes-table.sgml </span><span class="ch">\</span></span>
<span id="cb711-46"><a aria-hidden="true" href="#cb711-46" tabindex="-1"></a><span class="st">    keywords-table.sgml targets-meson.sgml wait_event_types.sgml</span></span>
<span id="cb711-47"><a aria-hidden="true" href="#cb711-47" tabindex="-1"></a></span>
<span id="cb711-48"><a aria-hidden="true" href="#cb711-48" tabindex="-1"></a><span class="dt">ALL_SGML</span> <span class="ch">:=</span><span class="st"> </span><span class="ch">$(</span><span class="kw">wildcard</span><span class="st"> </span><span class="ch">$(</span><span class="dt">srcdir</span><span class="ch">)</span><span class="st">/*.sgml </span><span class="ch">$(</span><span class="dt">srcdir</span><span class="ch">)</span><span class="st">/func/*.sgml </span><span class="ch">$(</span><span class="dt">srcdir</span><span class="ch">)</span><span class="st">/ref/*.sgml</span><span class="ch">)</span><span class="st"> </span><span class="ch">$(</span><span class="dt">GENERATED_SGML</span><span class="ch">)</span></span>
<span id="cb711-49"><a aria-hidden="true" href="#cb711-49" tabindex="-1"></a></span>
<span id="cb711-50"><a aria-hidden="true" href="#cb711-50" tabindex="-1"></a><span class="dt">ALL_IMAGES</span> <span class="ch">:=</span><span class="st"> </span><span class="ch">$(</span><span class="kw">wildcard</span><span class="st"> </span><span class="ch">$(</span><span class="dt">srcdir</span><span class="ch">)</span><span class="st">/images/*.svg</span><span class="ch">)</span></span>
<span id="cb711-51"><a aria-hidden="true" href="#cb711-51" tabindex="-1"></a></span>
<span id="cb711-52"><a aria-hidden="true" href="#cb711-52" tabindex="-1"></a><span class="co"># Run validation only once, common to all subsequent targets</span></span>
<span id="cb711-53"><a aria-hidden="true" href="#cb711-53" tabindex="-1"></a><span class="dv">postgres-full.xml:</span><span class="dt"> postgres.sgml </span><span class="ch">$(</span><span class="dt">ALL_SGML</span><span class="ch">)</span></span>
<span id="cb711-54"><a aria-hidden="true" href="#cb711-54" tabindex="-1"></a><span class="er">    </span><span class="ch">$(</span><span class="dt">XMLLINT</span><span class="ch">)</span> <span class="ch">$(</span><span class="dt">XMLINCLUDE</span><span class="ch">)</span> --output <span class="ch">$@</span> --noent --valid <span class="ch">$&lt;</span></span>
<span id="cb711-55"><a aria-hidden="true" href="#cb711-55" tabindex="-1"></a></span>
<span id="cb711-56"><a aria-hidden="true" href="#cb711-56" tabindex="-1"></a><span class="co">##</span></span>
<span id="cb711-57"><a aria-hidden="true" href="#cb711-57" tabindex="-1"></a><span class="co">## Man pages</span></span>
<span id="cb711-58"><a aria-hidden="true" href="#cb711-58" tabindex="-1"></a><span class="co">##</span></span>
<span id="cb711-59"><a aria-hidden="true" href="#cb711-59" tabindex="-1"></a></span>
<span id="cb711-60"><a aria-hidden="true" href="#cb711-60" tabindex="-1"></a><span class="dv">man:</span><span class="dt"> man-stamp</span></span>
<span id="cb711-61"><a aria-hidden="true" href="#cb711-61" tabindex="-1"></a></span>
<span id="cb711-62"><a aria-hidden="true" href="#cb711-62" tabindex="-1"></a><span class="dv">man-stamp:</span><span class="dt"> stylesheet-man.xsl postgres-full.xml</span></span>
<span id="cb711-63"><a aria-hidden="true" href="#cb711-63" tabindex="-1"></a><span class="er">    </span><span class="ch">$(</span><span class="dt">XSLTPROC</span><span class="ch">)</span> <span class="ch">$(</span><span class="dt">XMLINCLUDE</span><span class="ch">)</span> <span class="ch">$(</span><span class="dt">XSLTPROCFLAGS</span><span class="ch">)</span> <span class="ch">$(</span><span class="dt">XSLTPROC_MAN_FLAGS</span><span class="ch">)</span> <span class="ch">$^</span></span>
<span id="cb711-64"><a aria-hidden="true" href="#cb711-64" tabindex="-1"></a>    touch <span class="ch">$@</span></span>
<span id="cb711-65"><a aria-hidden="true" href="#cb711-65" tabindex="-1"></a></span>
<span id="cb711-66"><a aria-hidden="true" href="#cb711-66" tabindex="-1"></a><span class="co">##</span></span>
<span id="cb711-67"><a aria-hidden="true" href="#cb711-67" tabindex="-1"></a><span class="co">## Version file</span></span>
<span id="cb711-68"><a aria-hidden="true" href="#cb711-68" tabindex="-1"></a><span class="co">##</span></span>
<span id="cb711-69"><a aria-hidden="true" href="#cb711-69" tabindex="-1"></a></span>
<span id="cb711-70"><a aria-hidden="true" href="#cb711-70" tabindex="-1"></a><span class="dv">version.sgml:</span><span class="dt"> </span><span class="ch">$(</span><span class="dt">top_srcdir</span><span class="ch">)</span><span class="dt">/configure</span></span>
<span id="cb711-71"><a aria-hidden="true" href="#cb711-71" tabindex="-1"></a><span class="er">    </span>{ \</span>
<span id="cb711-72"><a aria-hidden="true" href="#cb711-72" tabindex="-1"></a>      echo <span class="st">"&lt;!ENTITY version \"</span><span class="ch">$(</span><span class="dt">VERSION</span><span class="ch">)</span>\<span class="st">"&gt;"</span>; \</span>
<span id="cb711-73"><a aria-hidden="true" href="#cb711-73" tabindex="-1"></a>      echo <span class="st">"&lt;!ENTITY majorversion \"</span><span class="ch">$(</span><span class="dt">MAJORVERSION</span><span class="ch">)</span>\<span class="st">"&gt;"</span>; \</span>
<span id="cb711-74"><a aria-hidden="true" href="#cb711-74" tabindex="-1"></a>    } &gt; <span class="ch">$@</span></span></code></pre></div>
<h3 data-number="11.8.3" id="documentation-build-process"><span class="header-section-number">11.8.3</span> Documentation Build
Process</h3>
<pre><code>1. Write DocBook SGML source
   ‚îú‚îÄ‚îÄ Main document: postgres.sgml
   ‚îú‚îÄ‚îÄ Chapters in *.sgml files
   ‚îú‚îÄ‚îÄ Function references in func/*.sgml
   ‚îî‚îÄ‚îÄ SQL command references in ref/*.sgml

2. Generate dynamic content
   ‚îú‚îÄ‚îÄ version.sgml (from configure)
   ‚îú‚îÄ‚îÄ keywords-table.sgml (from parser)
   ‚îú‚îÄ‚îÄ errcodes-table.sgml (from errcodes.txt)
   ‚îî‚îÄ‚îÄ wait_event_types.sgml (from wait events)

3. Validate and combine
   ‚îú‚îÄ‚îÄ xmllint validates SGML
   ‚îú‚îÄ‚îÄ Resolves all entities
   ‚îî‚îÄ‚îÄ Creates postgres-full.xml

4. Transform to output formats
   ‚îú‚îÄ‚îÄ HTML: xsltproc with stylesheet-html.xsl
   ‚îú‚îÄ‚îÄ Man pages: xsltproc with stylesheet-man.xsl
   ‚îî‚îÄ‚îÄ PDF: FOP processes DocBook

5. Install documentation
   ‚îú‚îÄ‚îÄ make install-docs
   ‚îú‚îÄ‚îÄ Copies to $(docdir)
   ‚îî‚îÄ‚îÄ Installs man pages to $(mandir)</code></pre>
<hr/>
<h2 data-number="11.9" id="development-practices-and-coding-standards"><span class="header-section-number">11.9</span> 8. Development Practices and
Coding Standards</h2>
<h3 data-number="11.9.1" id="code-formatting-with-pgindent"><span class="header-section-number">11.9.1</span> Code Formatting with
pgindent</h3>
<h4 data-number="11.9.1.1" id="homeuserpostgressrctoolspgindentreadme"><span class="header-section-number">11.9.1.1</span>
/home/user/postgres/src/tools/pgindent/README</h4>
<pre><code>pgindent'ing the PostgreSQL source tree
=======================================

pgindent is used to maintain uniform layout style in our C and Perl code,
and should be run for every commit.

PREREQUISITES:

1) Install pg_bsd_indent in your PATH. Its source code is in
   src/tools/pg_bsd_indent

2) Install perltidy version 20230309 exactly (for consistency)

DOING THE INDENT RUN BEFORE A NORMAL COMMIT:

1) Change directory to the top of the source tree

2) Run pgindent on the C files:

   src/tools/pgindent/pgindent .

3) Check for any newly-created files using "git status"
   (pgindent leaves *.BAK files if it has trouble)

4) If pgindent wants to change anything your commit wasn't touching,
   stop and figure out why.

5) Eyeball the "git diff" output for egregiously ugly changes

6) Do a full test build:

   make -s clean
   make -s all
   make check-world

AT LEAST ONCE PER RELEASE CYCLE:

1) Download the latest typedef file from the buildfarm:

   wget -O src/tools/pgindent/typedefs.list \
     https://buildfarm.postgresql.org/cgi-bin/typedefs.pl

2) Run pgindent as above

3) Indent the Perl code:

   src/tools/pgindent/pgperltidy .

4) Reformat the bootstrap catalog data files:

   ./configure
   cd src/include/catalog
   make reformat-dat-files

5) Commit everything including the typedefs.list file

6) Add the commit to .git-blame-ignore-revs</code></pre>
<h4 data-number="11.9.1.2" id="pgindent-script"><span class="header-section-number">11.9.1.2</span> pgindent Script</h4>
<p><strong>/home/user/postgres/src/tools/pgindent/pgindent (Lines
1-100)</strong></p>
<div class="sourceCode" id="cb714"><pre class="sourceCode perl"><code class="sourceCode perl"><span id="cb714-1"><a aria-hidden="true" href="#cb714-1" tabindex="-1"></a><span class="kw">#!/usr/bin/perl</span></span>
<span id="cb714-2"><a aria-hidden="true" href="#cb714-2" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb714-3"><a aria-hidden="true" href="#cb714-3" tabindex="-1"></a><span class="co"># Program to maintain uniform layout style in our C code.</span></span>
<span id="cb714-4"><a aria-hidden="true" href="#cb714-4" tabindex="-1"></a><span class="co"># Exit codes:</span></span>
<span id="cb714-5"><a aria-hidden="true" href="#cb714-5" tabindex="-1"></a><span class="co">#   0 -- all OK</span></span>
<span id="cb714-6"><a aria-hidden="true" href="#cb714-6" tabindex="-1"></a><span class="co">#   1 -- error invoking pgindent</span></span>
<span id="cb714-7"><a aria-hidden="true" href="#cb714-7" tabindex="-1"></a><span class="co">#   2 -- --check mode and at least one file requires changes</span></span>
<span id="cb714-8"><a aria-hidden="true" href="#cb714-8" tabindex="-1"></a><span class="co">#   3 -- pg_bsd_indent failed on at least one file</span></span>
<span id="cb714-9"><a aria-hidden="true" href="#cb714-9" tabindex="-1"></a></span>
<span id="cb714-10"><a aria-hidden="true" href="#cb714-10" tabindex="-1"></a><span class="fu">use</span> <span class="kw">strict</span>;</span>
<span id="cb714-11"><a aria-hidden="true" href="#cb714-11" tabindex="-1"></a><span class="fu">use</span> <span class="kw">warnings</span> FATAL =&gt; <span class="ot">'</span><span class="ss">all</span><span class="ot">'</span>;</span>
<span id="cb714-12"><a aria-hidden="true" href="#cb714-12" tabindex="-1"></a></span>
<span id="cb714-13"><a aria-hidden="true" href="#cb714-13" tabindex="-1"></a><span class="fu">use</span> Cwd <span class="ot">qw(</span>abs_path getcwd<span class="ot">)</span>;</span>
<span id="cb714-14"><a aria-hidden="true" href="#cb714-14" tabindex="-1"></a><span class="fu">use</span> <span class="fu">File::Find</span>;</span>
<span id="cb714-15"><a aria-hidden="true" href="#cb714-15" tabindex="-1"></a><span class="fu">use</span> <span class="fu">File::Temp</span>;</span>
<span id="cb714-16"><a aria-hidden="true" href="#cb714-16" tabindex="-1"></a><span class="fu">use</span> <span class="fu">Getopt::Long</span>;</span>
<span id="cb714-17"><a aria-hidden="true" href="#cb714-17" tabindex="-1"></a></span>
<span id="cb714-18"><a aria-hidden="true" href="#cb714-18" tabindex="-1"></a><span class="co"># Update for pg_bsd_indent version</span></span>
<span id="cb714-19"><a aria-hidden="true" href="#cb714-19" tabindex="-1"></a><span class="kw">my</span> <span class="dt">$INDENT_VERSION</span> = <span class="ot">"</span><span class="st">2.1.2</span><span class="ot">"</span>;</span>
<span id="cb714-20"><a aria-hidden="true" href="#cb714-20" tabindex="-1"></a></span>
<span id="cb714-21"><a aria-hidden="true" href="#cb714-21" tabindex="-1"></a><span class="co"># Our standard indent settings</span></span>
<span id="cb714-22"><a aria-hidden="true" href="#cb714-22" tabindex="-1"></a><span class="kw">my</span> <span class="dt">$indent_opts</span> =</span>
<span id="cb714-23"><a aria-hidden="true" href="#cb714-23" tabindex="-1"></a>  <span class="ot">"</span><span class="st">-bad -bap -bbb -bc -bl -cli1 -cp33 -cdb -nce -d0 -di12 -nfc1 -i4 -l79 -lp -lpl -nip -npro -sac -tpg -ts4</span><span class="ot">"</span>;</span>
<span id="cb714-24"><a aria-hidden="true" href="#cb714-24" tabindex="-1"></a></span>
<span id="cb714-25"><a aria-hidden="true" href="#cb714-25" tabindex="-1"></a><span class="kw">my</span> (<span class="dt">$typedefs_file</span>, <span class="dt">$typedef_str</span>, <span class="dt">@excludes</span>, <span class="dt">$indent</span>, <span class="dt">$diff</span>, <span class="dt">$check</span>);</span>
<span id="cb714-26"><a aria-hidden="true" href="#cb714-26" tabindex="-1"></a></span>
<span id="cb714-27"><a aria-hidden="true" href="#cb714-27" tabindex="-1"></a>GetOptions(</span>
<span id="cb714-28"><a aria-hidden="true" href="#cb714-28" tabindex="-1"></a>    <span class="ot">"</span><span class="st">help</span><span class="ot">"</span> =&gt; \<span class="dt">$help</span>,</span>
<span id="cb714-29"><a aria-hidden="true" href="#cb714-29" tabindex="-1"></a>    <span class="ot">"</span><span class="st">typedefs=s</span><span class="ot">"</span> =&gt; \<span class="dt">$typedefs_file</span>,</span>
<span id="cb714-30"><a aria-hidden="true" href="#cb714-30" tabindex="-1"></a>    <span class="ot">"</span><span class="st">excludes=s</span><span class="ot">"</span> =&gt; \<span class="dt">@excludes</span>,</span>
<span id="cb714-31"><a aria-hidden="true" href="#cb714-31" tabindex="-1"></a>    <span class="ot">"</span><span class="st">indent=s</span><span class="ot">"</span> =&gt; \<span class="dt">$indent</span>,</span>
<span id="cb714-32"><a aria-hidden="true" href="#cb714-32" tabindex="-1"></a>    <span class="ot">"</span><span class="st">diff</span><span class="ot">"</span> =&gt; \<span class="dt">$diff</span>,</span>
<span id="cb714-33"><a aria-hidden="true" href="#cb714-33" tabindex="-1"></a>    <span class="ot">"</span><span class="st">check</span><span class="ot">"</span> =&gt; \<span class="dt">$check</span>,</span>
<span id="cb714-34"><a aria-hidden="true" href="#cb714-34" tabindex="-1"></a>) || usage(<span class="ot">"</span><span class="st">bad command line argument</span><span class="ot">"</span>);</span>
<span id="cb714-35"><a aria-hidden="true" href="#cb714-35" tabindex="-1"></a></span>
<span id="cb714-36"><a aria-hidden="true" href="#cb714-36" tabindex="-1"></a><span class="co"># Get indent location</span></span>
<span id="cb714-37"><a aria-hidden="true" href="#cb714-37" tabindex="-1"></a><span class="dt">$indent</span> ||= <span class="wa">$ENV</span>{PGINDENT} || <span class="wa">$ENV</span>{INDENT} || <span class="ot">"</span><span class="st">pg_bsd_indent</span><span class="ot">"</span>;</span>
<span id="cb714-38"><a aria-hidden="true" href="#cb714-38" tabindex="-1"></a></span>
<span id="cb714-39"><a aria-hidden="true" href="#cb714-39" tabindex="-1"></a><span class="co"># Additional typedefs to hardwire</span></span>
<span id="cb714-40"><a aria-hidden="true" href="#cb714-40" tabindex="-1"></a><span class="kw">my</span> <span class="dt">@additional</span> = <span class="fu">map</span> { <span class="ot">"</span><span class="wa">$_</span><span class="ch">\n</span><span class="ot">"</span> } <span class="ot">qw(</span></span>
<span id="cb714-41"><a aria-hidden="true" href="#cb714-41" tabindex="-1"></a>  bool regex_t regmatch_t regoff</span>
<span id="cb714-42"><a aria-hidden="true" href="#cb714-42" tabindex="-1"></a><span class="ot">)</span>;</span>
<span id="cb714-43"><a aria-hidden="true" href="#cb714-43" tabindex="-1"></a></span>
<span id="cb714-44"><a aria-hidden="true" href="#cb714-44" tabindex="-1"></a><span class="co"># Typedefs to exclude</span></span>
<span id="cb714-45"><a aria-hidden="true" href="#cb714-45" tabindex="-1"></a><span class="kw">my</span> <span class="dt">%excluded</span> = <span class="fu">map</span> { +<span class="ot">"</span><span class="wa">$_</span><span class="ch">\n</span><span class="ot">"</span> =&gt; <span class="dv">1</span> } <span class="ot">qw(</span></span>
<span id="cb714-46"><a aria-hidden="true" href="#cb714-46" tabindex="-1"></a>  FD_SET LookupSet boolean date duration</span>
<span id="cb714-47"><a aria-hidden="true" href="#cb714-47" tabindex="-1"></a>  element_type inquiry iterator other</span>
<span id="cb714-48"><a aria-hidden="true" href="#cb714-48" tabindex="-1"></a>  pointer reference rep string timestamp type wrap</span>
<span id="cb714-49"><a aria-hidden="true" href="#cb714-49" tabindex="-1"></a><span class="ot">)</span>;</span></code></pre></div>
<h3 data-number="11.9.2" id="coding-style-guidelines"><span class="header-section-number">11.9.2</span> Coding Style Guidelines</h3>
<p><strong>Key C Coding Conventions:</strong></p>
<ol type="1">
<li><strong>Indentation:</strong> 4 spaces, no tabs in C code</li>
<li><strong>Line Length:</strong> Max 79 characters</li>
<li><strong>Braces:</strong> Opening brace on same line for functions,
on new line for control structures</li>
<li><strong>Comments:</strong> Use <code>/* ... */</code> style, not
<code>//</code></li>
<li><strong>Naming:</strong>
<ul>
<li>Functions: lowercase_with_underscores</li>
<li>Types: CamelCase or lowercase_t</li>
<li>Macros: UPPERCASE_WITH_UNDERSCORES</li>
</ul></li>
</ol>
<p><strong>Example:</strong></p>
<div class="sourceCode" id="cb715"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb715-1"><a aria-hidden="true" href="#cb715-1" tabindex="-1"></a><span class="co">/*</span></span>
<span id="cb715-2"><a aria-hidden="true" href="#cb715-2" tabindex="-1"></a><span class="co"> * FunctionName - short description</span></span>
<span id="cb715-3"><a aria-hidden="true" href="#cb715-3" tabindex="-1"></a><span class="co"> *</span></span>
<span id="cb715-4"><a aria-hidden="true" href="#cb715-4" tabindex="-1"></a><span class="co"> * Longer description of what the function does.</span></span>
<span id="cb715-5"><a aria-hidden="true" href="#cb715-5" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb715-6"><a aria-hidden="true" href="#cb715-6" tabindex="-1"></a><span class="dt">int</span></span>
<span id="cb715-7"><a aria-hidden="true" href="#cb715-7" tabindex="-1"></a>FunctionName<span class="op">(</span><span class="dt">int</span> param1<span class="op">,</span> <span class="dt">char</span> <span class="op">*</span>param2<span class="op">)</span></span>
<span id="cb715-8"><a aria-hidden="true" href="#cb715-8" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb715-9"><a aria-hidden="true" href="#cb715-9" tabindex="-1"></a>    <span class="dt">int</span>     local_var<span class="op">;</span></span>
<span id="cb715-10"><a aria-hidden="true" href="#cb715-10" tabindex="-1"></a>    </span>
<span id="cb715-11"><a aria-hidden="true" href="#cb715-11" tabindex="-1"></a>    <span class="co">/* Comment explaining this block */</span></span>
<span id="cb715-12"><a aria-hidden="true" href="#cb715-12" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>param1 <span class="op">&gt;</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb715-13"><a aria-hidden="true" href="#cb715-13" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb715-14"><a aria-hidden="true" href="#cb715-14" tabindex="-1"></a>        local_var <span class="op">=</span> param1 <span class="op">*</span> <span class="dv">2</span><span class="op">;</span></span>
<span id="cb715-15"><a aria-hidden="true" href="#cb715-15" tabindex="-1"></a>        elog<span class="op">(</span>DEBUG1<span class="op">,</span> <span class="st">"calculated value: </span><span class="sc">%d</span><span class="st">"</span><span class="op">,</span> local_var<span class="op">);</span></span>
<span id="cb715-16"><a aria-hidden="true" href="#cb715-16" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb715-17"><a aria-hidden="true" href="#cb715-17" tabindex="-1"></a>    <span class="cf">else</span></span>
<span id="cb715-18"><a aria-hidden="true" href="#cb715-18" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb715-19"><a aria-hidden="true" href="#cb715-19" tabindex="-1"></a>        local_var <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb715-20"><a aria-hidden="true" href="#cb715-20" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb715-21"><a aria-hidden="true" href="#cb715-21" tabindex="-1"></a>    </span>
<span id="cb715-22"><a aria-hidden="true" href="#cb715-22" tabindex="-1"></a>    <span class="cf">return</span> local_var<span class="op">;</span></span>
<span id="cb715-23"><a aria-hidden="true" href="#cb715-23" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 data-number="11.9.3" id="backend-makefile-structure"><span class="header-section-number">11.9.3</span> Backend Makefile
Structure</h3>
<h4 data-number="11.9.3.1" id="homeuserpostgressrcbackendmakefile-lines-1-100"><span class="header-section-number">11.9.3.1</span>
/home/user/postgres/src/backend/Makefile (Lines 1-100)</h4>
<div class="sourceCode" id="cb716"><pre class="sourceCode makefile"><code class="sourceCode makefile"><span id="cb716-1"><a aria-hidden="true" href="#cb716-1" tabindex="-1"></a><span class="co">#-------------------------------------------------------------------------</span></span>
<span id="cb716-2"><a aria-hidden="true" href="#cb716-2" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb716-3"><a aria-hidden="true" href="#cb716-3" tabindex="-1"></a><span class="co"># Makefile for the postgres backend</span></span>
<span id="cb716-4"><a aria-hidden="true" href="#cb716-4" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb716-5"><a aria-hidden="true" href="#cb716-5" tabindex="-1"></a><span class="co"># src/backend/Makefile</span></span>
<span id="cb716-6"><a aria-hidden="true" href="#cb716-6" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb716-7"><a aria-hidden="true" href="#cb716-7" tabindex="-1"></a><span class="co">#-------------------------------------------------------------------------</span></span>
<span id="cb716-8"><a aria-hidden="true" href="#cb716-8" tabindex="-1"></a></span>
<span id="cb716-9"><a aria-hidden="true" href="#cb716-9" tabindex="-1"></a><span class="dt">PGFILEDESC</span> <span class="ch">=</span><span class="st"> "PostgreSQL Server"</span></span>
<span id="cb716-10"><a aria-hidden="true" href="#cb716-10" tabindex="-1"></a><span class="dt">PGAPPICON</span><span class="ch">=</span><span class="st">win32</span></span>
<span id="cb716-11"><a aria-hidden="true" href="#cb716-11" tabindex="-1"></a></span>
<span id="cb716-12"><a aria-hidden="true" href="#cb716-12" tabindex="-1"></a><span class="dt">subdir</span> <span class="ch">=</span><span class="st"> src/backend</span></span>
<span id="cb716-13"><a aria-hidden="true" href="#cb716-13" tabindex="-1"></a><span class="dt">top_builddir</span> <span class="ch">=</span><span class="st"> ../..</span></span>
<span id="cb716-14"><a aria-hidden="true" href="#cb716-14" tabindex="-1"></a><span class="kw">include</span> <span class="ch">$(</span><span class="dt">top_builddir</span><span class="ch">)</span>/src/Makefile.global</span>
<span id="cb716-15"><a aria-hidden="true" href="#cb716-15" tabindex="-1"></a></span>
<span id="cb716-16"><a aria-hidden="true" href="#cb716-16" tabindex="-1"></a><span class="dt">SUBDIRS</span> <span class="ch">=</span><span class="st"> access archive backup bootstrap catalog parser commands executor </span><span class="ch">\</span></span>
<span id="cb716-17"><a aria-hidden="true" href="#cb716-17" tabindex="-1"></a><span class="st">    foreign lib libpq </span><span class="ch">\</span></span>
<span id="cb716-18"><a aria-hidden="true" href="#cb716-18" tabindex="-1"></a><span class="st">    main nodes optimizer partitioning port postmaster </span><span class="ch">\</span></span>
<span id="cb716-19"><a aria-hidden="true" href="#cb716-19" tabindex="-1"></a><span class="st">    regex replication rewrite </span><span class="ch">\</span></span>
<span id="cb716-20"><a aria-hidden="true" href="#cb716-20" tabindex="-1"></a><span class="st">    statistics storage tcop tsearch utils </span><span class="ch">$(</span><span class="dt">top_builddir</span><span class="ch">)</span><span class="st">/src/timezone </span><span class="ch">\</span></span>
<span id="cb716-21"><a aria-hidden="true" href="#cb716-21" tabindex="-1"></a><span class="st">    jit</span></span>
<span id="cb716-22"><a aria-hidden="true" href="#cb716-22" tabindex="-1"></a></span>
<span id="cb716-23"><a aria-hidden="true" href="#cb716-23" tabindex="-1"></a><span class="kw">include</span> <span class="ch">$(</span><span class="dt">srcdir</span><span class="ch">)</span>/common.mk</span>
<span id="cb716-24"><a aria-hidden="true" href="#cb716-24" tabindex="-1"></a></span>
<span id="cb716-25"><a aria-hidden="true" href="#cb716-25" tabindex="-1"></a><span class="co"># DTrace probe support</span></span>
<span id="cb716-26"><a aria-hidden="true" href="#cb716-26" tabindex="-1"></a><span class="cf">ifneq</span> (<span class="ch">$(</span><span class="dt">PORTNAME</span><span class="ch">)</span>, darwin)</span>
<span id="cb716-27"><a aria-hidden="true" href="#cb716-27" tabindex="-1"></a><span class="cf">ifeq</span> (<span class="ch">$(</span><span class="dt">enable_dtrace</span><span class="ch">)</span>, yes)</span>
<span id="cb716-28"><a aria-hidden="true" href="#cb716-28" tabindex="-1"></a><span class="dt">LOCALOBJS</span> <span class="ch">+=</span><span class="st"> utils/probes.o</span></span>
<span id="cb716-29"><a aria-hidden="true" href="#cb716-29" tabindex="-1"></a><span class="cf">endif</span></span>
<span id="cb716-30"><a aria-hidden="true" href="#cb716-30" tabindex="-1"></a><span class="cf">endif</span></span>
<span id="cb716-31"><a aria-hidden="true" href="#cb716-31" tabindex="-1"></a></span>
<span id="cb716-32"><a aria-hidden="true" href="#cb716-32" tabindex="-1"></a><span class="dt">OBJS</span> <span class="ch">=</span><span class="st"> </span><span class="ch">\</span></span>
<span id="cb716-33"><a aria-hidden="true" href="#cb716-33" tabindex="-1"></a><span class="st">    </span><span class="ch">$(</span><span class="dt">LOCALOBJS</span><span class="ch">)</span><span class="st"> </span><span class="ch">\</span></span>
<span id="cb716-34"><a aria-hidden="true" href="#cb716-34" tabindex="-1"></a><span class="st">    </span><span class="ch">$(</span><span class="dt">SUBDIROBJS</span><span class="ch">)</span><span class="st"> </span><span class="ch">\</span></span>
<span id="cb716-35"><a aria-hidden="true" href="#cb716-35" tabindex="-1"></a><span class="st">    </span><span class="ch">$(</span><span class="dt">top_builddir</span><span class="ch">)</span><span class="st">/src/common/libpgcommon_srv.a </span><span class="ch">\</span></span>
<span id="cb716-36"><a aria-hidden="true" href="#cb716-36" tabindex="-1"></a><span class="st">    </span><span class="ch">$(</span><span class="dt">top_builddir</span><span class="ch">)</span><span class="st">/src/port/libpgport_srv.a</span></span>
<span id="cb716-37"><a aria-hidden="true" href="#cb716-37" tabindex="-1"></a></span>
<span id="cb716-38"><a aria-hidden="true" href="#cb716-38" tabindex="-1"></a><span class="co"># Remove libpgport and libpgcommon from LIBS</span></span>
<span id="cb716-39"><a aria-hidden="true" href="#cb716-39" tabindex="-1"></a><span class="dt">LIBS</span> <span class="ch">:=</span><span class="st"> </span><span class="ch">$(</span><span class="kw">filter-out</span><span class="st"> -lpgport -lpgcommon</span><span class="kw">,</span><span class="st"> </span><span class="ch">$(</span><span class="dt">LIBS</span><span class="ch">))</span></span>
<span id="cb716-40"><a aria-hidden="true" href="#cb716-40" tabindex="-1"></a></span>
<span id="cb716-41"><a aria-hidden="true" href="#cb716-41" tabindex="-1"></a><span class="co"># Add backend-specific libraries</span></span>
<span id="cb716-42"><a aria-hidden="true" href="#cb716-42" tabindex="-1"></a><span class="dt">LIBS</span> <span class="ch">+=</span><span class="st"> </span><span class="ch">$(</span><span class="dt">LDAP_LIBS_BE</span><span class="ch">)</span><span class="st"> </span><span class="ch">$(</span><span class="dt">ICU_LIBS</span><span class="ch">)</span><span class="st"> </span><span class="ch">$(</span><span class="dt">LIBURING_LIBS</span><span class="ch">)</span></span>
<span id="cb716-43"><a aria-hidden="true" href="#cb716-43" tabindex="-1"></a></span>
<span id="cb716-44"><a aria-hidden="true" href="#cb716-44" tabindex="-1"></a><span class="kw">override</span> <span class="dt">LDFLAGS </span><span class="ch">:=</span><span class="st"> </span><span class="ch">$(</span><span class="dt">LDFLAGS</span><span class="ch">)</span><span class="st"> </span><span class="ch">$(</span><span class="dt">LDFLAGS_EX</span><span class="ch">)</span><span class="st"> </span><span class="ch">$(</span><span class="dt">LDFLAGS_EX_BE</span><span class="ch">)</span></span>
<span id="cb716-45"><a aria-hidden="true" href="#cb716-45" tabindex="-1"></a></span>
<span id="cb716-46"><a aria-hidden="true" href="#cb716-46" tabindex="-1"></a><span class="dv">all:</span><span class="dt"> submake-libpgport submake-catalog-headers submake-utils-headers postgres </span><span class="ch">$(</span><span class="dt">POSTGRES_IMP</span><span class="ch">)</span></span>
<span id="cb716-47"><a aria-hidden="true" href="#cb716-47" tabindex="-1"></a></span>
<span id="cb716-48"><a aria-hidden="true" href="#cb716-48" tabindex="-1"></a><span class="co"># Platform-specific linking</span></span>
<span id="cb716-49"><a aria-hidden="true" href="#cb716-49" tabindex="-1"></a><span class="cf">ifneq</span> (<span class="ch">$(</span><span class="dt">PORTNAME</span><span class="ch">)</span>, cygwin)</span>
<span id="cb716-50"><a aria-hidden="true" href="#cb716-50" tabindex="-1"></a><span class="cf">ifneq</span> (<span class="ch">$(</span><span class="dt">PORTNAME</span><span class="ch">)</span>, win32)</span>
<span id="cb716-51"><a aria-hidden="true" href="#cb716-51" tabindex="-1"></a></span>
<span id="cb716-52"><a aria-hidden="true" href="#cb716-52" tabindex="-1"></a><span class="dv">postgres:</span><span class="dt"> </span><span class="ch">$(</span><span class="dt">OBJS</span><span class="ch">)</span></span>
<span id="cb716-53"><a aria-hidden="true" href="#cb716-53" tabindex="-1"></a><span class="er">    </span><span class="ch">$(</span><span class="dt">CC</span><span class="ch">)</span> <span class="ch">$(</span><span class="dt">CFLAGS</span><span class="ch">)</span> <span class="ch">$(</span><span class="kw">call</span><span class="st"> expand_subsys</span><span class="kw">,</span><span class="ch">$^)</span> <span class="ch">$(</span><span class="dt">LDFLAGS</span><span class="ch">)</span> <span class="ch">$(</span><span class="dt">LIBS</span><span class="ch">)</span> -o <span class="ch">$@</span></span>
<span id="cb716-54"><a aria-hidden="true" href="#cb716-54" tabindex="-1"></a></span>
<span id="cb716-55"><a aria-hidden="true" href="#cb716-55" tabindex="-1"></a><span class="cf">endif</span></span>
<span id="cb716-56"><a aria-hidden="true" href="#cb716-56" tabindex="-1"></a><span class="cf">endif</span></span>
<span id="cb716-57"><a aria-hidden="true" href="#cb716-57" tabindex="-1"></a></span>
<span id="cb716-58"><a aria-hidden="true" href="#cb716-58" tabindex="-1"></a><span class="co"># Cygwin needs special export handling</span></span>
<span id="cb716-59"><a aria-hidden="true" href="#cb716-59" tabindex="-1"></a><span class="cf">ifeq</span> (<span class="ch">$(</span><span class="dt">PORTNAME</span><span class="ch">)</span>, cygwin)</span>
<span id="cb716-60"><a aria-hidden="true" href="#cb716-60" tabindex="-1"></a></span>
<span id="cb716-61"><a aria-hidden="true" href="#cb716-61" tabindex="-1"></a><span class="dv">postgres:</span><span class="dt"> </span><span class="ch">$(</span><span class="dt">OBJS</span><span class="ch">)</span></span>
<span id="cb716-62"><a aria-hidden="true" href="#cb716-62" tabindex="-1"></a><span class="er">    </span><span class="ch">$(</span><span class="dt">CC</span><span class="ch">)</span> <span class="ch">$(</span><span class="dt">CFLAGS</span><span class="ch">)</span> <span class="ch">$(</span><span class="kw">call</span><span class="st"> expand_subsys</span><span class="kw">,</span><span class="ch">$^)</span> <span class="ch">$(</span><span class="dt">LDFLAGS</span><span class="ch">)</span> \</span>
<span id="cb716-63"><a aria-hidden="true" href="#cb716-63" tabindex="-1"></a>      <span class="ch">-</span><span class="fu">Wl,--stack,</span><span class="ch">$(</span><span class="dt">WIN32_STACK_RLIMIT</span><span class="ch">)</span><span class="fu"> </span><span class="ch">\</span></span>
<span id="cb716-64"><a aria-hidden="true" href="#cb716-64" tabindex="-1"></a><span class="fu">      -Wl,--export-all-symbols </span><span class="ch">\</span></span>
<span id="cb716-65"><a aria-hidden="true" href="#cb716-65" tabindex="-1"></a><span class="fu">      -Wl,--out-implib=libpostgres.a </span><span class="ch">$(</span><span class="dt">LIBS</span><span class="ch">)</span><span class="fu"> -o </span><span class="ch">$@</span></span>
<span id="cb716-66"><a aria-hidden="true" href="#cb716-66" tabindex="-1"></a></span>
<span id="cb716-67"><a aria-hidden="true" href="#cb716-67" tabindex="-1"></a><span class="dv">libpostgres.a:</span><span class="dt"> postgres</span></span>
<span id="cb716-68"><a aria-hidden="true" href="#cb716-68" tabindex="-1"></a><span class="er">    </span>touch <span class="ch">$@</span></span>
<span id="cb716-69"><a aria-hidden="true" href="#cb716-69" tabindex="-1"></a></span>
<span id="cb716-70"><a aria-hidden="true" href="#cb716-70" tabindex="-1"></a><span class="cf">endif</span> <span class="co"># cygwin</span></span>
<span id="cb716-71"><a aria-hidden="true" href="#cb716-71" tabindex="-1"></a></span>
<span id="cb716-72"><a aria-hidden="true" href="#cb716-72" tabindex="-1"></a><span class="co"># Windows needs DLL export handling</span></span>
<span id="cb716-73"><a aria-hidden="true" href="#cb716-73" tabindex="-1"></a><span class="cf">ifeq</span> (<span class="ch">$(</span><span class="dt">PORTNAME</span><span class="ch">)</span>, win32)</span>
<span id="cb716-74"><a aria-hidden="true" href="#cb716-74" tabindex="-1"></a><span class="dt">LIBS</span> <span class="ch">+=</span><span class="st"> -lsecur32</span></span>
<span id="cb716-75"><a aria-hidden="true" href="#cb716-75" tabindex="-1"></a></span>
<span id="cb716-76"><a aria-hidden="true" href="#cb716-76" tabindex="-1"></a><span class="dv">postgres:</span><span class="dt"> </span><span class="ch">$(</span><span class="dt">OBJS</span><span class="ch">)</span><span class="dt"> </span><span class="ch">$(</span><span class="dt">WIN32RES</span><span class="ch">)</span></span>
<span id="cb716-77"><a aria-hidden="true" href="#cb716-77" tabindex="-1"></a><span class="er">    </span><span class="ch">$(</span><span class="dt">CC</span><span class="ch">)</span> <span class="ch">$(</span><span class="dt">CFLAGS</span><span class="ch">)</span> <span class="ch">$(</span><span class="kw">call</span><span class="st"> expand_subsys</span><span class="kw">,</span><span class="ch">$(</span><span class="dt">OBJS</span><span class="ch">))</span> <span class="ch">$(</span><span class="dt">WIN32RES</span><span class="ch">)</span> <span class="ch">$(</span><span class="dt">LDFLAGS</span><span class="ch">)</span> \</span>
<span id="cb716-78"><a aria-hidden="true" href="#cb716-78" tabindex="-1"></a>      <span class="dt">-Wl,--stack</span><span class="ch">=$(</span><span class="dt">WIN32_STACK_RLIMIT</span><span class="ch">)</span><span class="st"> </span><span class="ch">\</span></span>
<span id="cb716-79"><a aria-hidden="true" href="#cb716-79" tabindex="-1"></a><span class="st">      -Wl,--export-all-symbols </span><span class="ch">\</span></span>
<span id="cb716-80"><a aria-hidden="true" href="#cb716-80" tabindex="-1"></a><span class="st">      -Wl,--out-implib=libpostgres.a </span><span class="ch">$(</span><span class="dt">LIBS</span><span class="ch">)</span><span class="st"> -o </span><span class="ch">$@$(</span><span class="dt">X</span><span class="ch">)</span></span>
<span id="cb716-81"><a aria-hidden="true" href="#cb716-81" tabindex="-1"></a></span>
<span id="cb716-82"><a aria-hidden="true" href="#cb716-82" tabindex="-1"></a><span class="dv">libpostgres.a:</span><span class="dt"> postgres</span></span>
<span id="cb716-83"><a aria-hidden="true" href="#cb716-83" tabindex="-1"></a><span class="er">    </span>touch <span class="ch">$@</span></span>
<span id="cb716-84"><a aria-hidden="true" href="#cb716-84" tabindex="-1"></a></span>
<span id="cb716-85"><a aria-hidden="true" href="#cb716-85" tabindex="-1"></a><span class="cf">endif</span> <span class="co"># win32</span></span></code></pre></div>
<h3 data-number="11.9.4" id="developer-workflows"><span class="header-section-number">11.9.4</span> Developer Workflows</h3>
<h4 data-number="11.9.4.1" id="typical-development-cycle"><span class="header-section-number">11.9.4.1</span> Typical Development
Cycle</h4>
<pre><code>1. Set up development environment
   ‚îú‚îÄ‚îÄ Clone repository: git clone https://git.postgresql.org/git/postgresql.git
   ‚îú‚îÄ‚îÄ Install dependencies
   ‚îî‚îÄ‚îÄ Configure with debug options

2. Configure for development
   # Autoconf:
   ./configure \
     --enable-debug \
     --enable-cassert \
     --enable-tap-tests \
     CFLAGS="-O0 -g3"
   
   # Meson:
   meson setup build \
     --buildtype=debug \
     -Dcassert=true \
     -Dtap_tests=enabled

3. Build
   # Autoconf:
   make -j$(nproc)
   
   # Meson:
   meson compile -C build

4. Test changes
   # Run specific test
   make -C src/test/regress check TESTS="test_name"
   
   # Run TAP tests
   make -C src/bin/pg_dump check
   
   # Run isolation tests
   make -C src/test/isolation check

5. Format code
   src/tools/pgindent/pgindent path/to/changed/files.c

6. Commit
   git add path/to/files
   git commit -m "Brief description
   
   Detailed explanation of changes and rationale."

7. Create patch for mailing list
   git format-patch -1</code></pre>
<hr/>
<h2 data-number="11.10" id="summary-2"><span class="header-section-number">11.10</span> Summary</h2>
<p>PostgreSQL‚Äôs build system and portability layer represent a
sophisticated approach to cross-platform software development:</p>
<h3 data-number="11.10.1" id="key-strengths"><span class="header-section-number">11.10.1</span> Key Strengths</h3>
<ol type="1">
<li><strong>Dual Build Systems</strong>
<ul>
<li>Traditional autoconf for stability and compatibility</li>
<li>Modern Meson for speed and developer experience</li>
<li>Both maintained in parallel</li>
</ul></li>
<li><strong>Comprehensive Portability</strong>
<ul>
<li>Abstract platform differences in src/port/</li>
<li>Platform-specific optimizations (CRC32C, atomics)</li>
<li>Graceful degradation when features unavailable</li>
</ul></li>
<li><strong>Automated Code Generation</strong>
<ul>
<li>Ensures consistency between catalogs and code</li>
<li>Reduces manual maintenance burden</li>
<li>Enables large-scale refactoring</li>
</ul></li>
<li><strong>Robust Testing Infrastructure</strong>
<ul>
<li>Multiple test frameworks (pg_regress, TAP, isolation)</li>
<li>Platform-specific test filtering</li>
<li>Comprehensive coverage across features</li>
</ul></li>
<li><strong>Well-Documented Processes</strong>
<ul>
<li>Clear coding standards</li>
<li>Automated formatting tools</li>
<li>Detailed build documentation</li>
</ul></li>
</ol>
<h3 data-number="11.10.2" id="best-practices-for-contributors"><span class="header-section-number">11.10.2</span> Best Practices for
Contributors</h3>
<ol type="1">
<li>Always run pgindent before committing</li>
<li>Use appropriate configure/meson options for development</li>
<li>Write tests for new features</li>
<li>Follow the established directory and file naming conventions</li>
<li>Keep platform-specific code isolated in src/port/</li>
<li>Update documentation when changing user-visible behavior</li>
<li>Test on multiple platforms when possible</li>
</ol>
<p>This encyclopedic guide provides developers with the knowledge needed
to understand, build, test, and contribute to PostgreSQL effectively
across all supported platforms.</p>
<h1 data-number="12" id="postgresql-community-and-development-culture"><span class="header-section-number">12</span> PostgreSQL Community and
Development Culture</h1>
<h2 data-number="12.1" id="introduction-5"><span class="header-section-number">12.1</span> Introduction</h2>
<p>PostgreSQL‚Äôs development has long been guided by a distinctive
culture that emphasizes technical excellence, transparent
decision-making, and community consensus. Unlike many open-source
projects that rely on a single ‚ÄúBenevolent Dictator For Life‚Äù (BDFL),
PostgreSQL operates through a collaborative model that has evolved over
more than two decades. This chapter explores the values, processes, and
people that define PostgreSQL‚Äôs unique approach to software development
and community governance.</p>
<p>The project‚Äôs commitment to quality, stability, and correctness over
rapid feature deployment has established PostgreSQL as a trusted
foundation for mission-critical systems worldwide. Understanding this
culture is essential for anyone seeking to participate in the project or
appreciate what makes PostgreSQL distinct in the database landscape.</p>
<hr/>
<h2 data-number="12.2" id="part-i-the-development-process"><span class="header-section-number">12.2</span> Part I: The Development
Process</h2>
<h3 data-number="12.2.1" id="commitfest-postgresqls-development-cycle"><span class="header-section-number">12.2.1</span> CommitFest: PostgreSQL‚Äôs
Development Cycle</h3>
<p>PostgreSQL organizes its development work through a structured system
called CommitFest. This process divides each release cycle into phases,
typically running four to six CommitFests between major versions. Each
CommitFest lasts approximately six to eight weeks and follows a
consistent workflow designed to balance feature development with quality
assurance.</p>
<p>The CommitFest system originated from the need to create natural
milestones in development. In the 1990s and early 2000s, PostgreSQL
development was somewhat ad-hoc, with features being added continuously.
As the project grew and the community expanded geographically, the lack
of structure created coordination problems. CommitFest formalized
development into predictable phases, allowing distributed teams to
coordinate effectively and allowing the project to maintain regular
release schedules.</p>
<p><strong>The CommitFest Workflow</strong></p>
<p>Each CommitFest progresses through distinct phases:</p>
<ol type="1">
<li><p><strong>Submission Phase</strong>: Developers submit patches and
proposals. All submissions must include a clear description of the
changes, motivation, testing approach, and expected impact. The
submission typically includes a detailed message explaining why the
change is necessary, what alternatives were considered, and how the
proposed solution addresses the problem. Complex features typically
undergo lengthy discussion before a formal submission, with authors
gathering feedback informally and revising approaches based on community
input.</p></li>
<li><p><strong>Review and Discussion Phase</strong>: Community members
review submissions through the mailing list. This is where PostgreSQL‚Äôs
emphasis on thorough examination becomes evident. Reviewers examine
multiple dimensions: code quality, architectural fit with existing
systems, documentation completeness, backward compatibility
implications, performance characteristics, and potential side effects.
Experienced reviewers might trace through the code mentally, considering
edge cases and interactions with other systems.</p></li>
<li><p><strong>Revision Period</strong>: Patch authors refine their
submissions based on feedback. Multiple revision cycles are common, even
for relatively straightforward changes. An author might receive feedback
pointing out an architectural incompatibility, requiring a redesign. Or
reviewers might identify performance implications requiring
optimization. Rather than interpreting revision requests as criticism,
the PostgreSQL culture views them as collaborative refinement.</p></li>
<li><p><strong>Commit Period</strong>: Patches that have achieved
consensus and passed review are committed to the development branch.
This period allows a final verification that committed changes integrate
properly and don‚Äôt introduce unexpected interactions with other recent
commits. Committers typically review patches once more before
committing, ensuring they meet community expectations.</p></li>
<li><p><strong>Open Period</strong>: After CommitFest conclusions,
development continues with ongoing work and preparation for the next
cycle. Important bugs or critical fixes might be committed outside the
CommitFest cycle, but major features are reserved for structured
CommitFest periods.</p></li>
</ol>
<p><strong>Mechanics of CommitFest Management</strong></p>
<p>PostgreSQL maintains a CommitFest application where authors register
patches, reviewers volunteer to review submissions, and status is
tracked. The application serves as a registry of proposed changes,
preventing duplicated effort and helping the community understand what
development is underway. Status indicators‚Äîwhether a patch is awaiting
review, under discussion, has been revised, or is ready to commit‚Äîhelp
prioritize reviewer effort.</p>
<p>CommitFest maintainers ensure the process progresses smoothly. They
verify that submissions are properly formatted, track progress toward
the closing deadline, and occasionally make judgment calls about status.
This role is crucial for maintaining structure without becoming overly
bureaucratic.</p>
<p><strong>Transition Between CommitFests</strong></p>
<p>The transition between CommitFests is structured but not rigid. Near
the end of a CommitFest, the community starts discussing which features
should target the next CommitFest. Long-term planning discussions might
propose major features for several CommitFests ahead, allowing
developers to begin preliminary work. Meanwhile, the code repository
advances through beta releases and release candidates as the committed
features are stabilized.</p>
<p><strong>Why CommitFest Matters</strong></p>
<p>The CommitFest system ensures that PostgreSQL maintains a manageable
pace of change while guaranteeing that all modifications receive
scrutiny. Rather than allowing continuous integration of changes without
coordination, CommitFest creates natural points for assessment and
prioritization. This structure enables the project to release stable
versions at regular intervals while maintaining code quality
standards.</p>
<p>Moreover, CommitFest creates predictability. Developers can plan
their work around CommitFest cycles. Contributors know when to expect
feedback on patches. Users understand the development timeline and can
plan when to test features. Predictability reduces friction in
distributed development.</p>
<h3 data-number="12.2.2" id="mailing-list-culture"><span class="header-section-number">12.2.2</span> Mailing List Culture</h3>
<p>PostgreSQL‚Äôs development coordination happens primarily through email
mailing lists. The PostgreSQL Global Development Group operates multiple
specialized lists:</p>
<ul>
<li><strong>pgsql-hackers</strong>: The main development discussion list
where architectural decisions, feature proposals, and technical disputes
are debated.</li>
<li><strong>pgsql-patches</strong>: Formerly the primary patch
submission mechanism (now largely superseded by mailing list attachments
and version control).</li>
<li><strong>pgsql-committers</strong>: A more restricted list for core
committers to discuss policies and decisions.</li>
<li><strong>pgsql-announce</strong>: For announcing releases and
significant developments.</li>
<li><strong>Topic-specific lists</strong>: Including pgsql-performance,
pgsql-general, pgsql-sql, and others focused on specific domains.</li>
</ul>
<p><strong>Email-Driven Development</strong></p>
<p>The reliance on email as PostgreSQL‚Äôs primary communication medium
reflects the project‚Äôs distributed nature and historical roots. Email
provides a searchable, archivable record of all discussions‚Äîcrucial for
future reference and decision-making. Unlike chat systems that encourage
immediate but ephemeral communication, email discussions tend to be more
thoughtful and comprehensive, with participants taking time to fully
articulate positions and concerns.</p>
<p>This approach produces several benefits. First, it creates a
comprehensive historical record accessible through searchable archives.
Decisions made years ago can be reviewed with their full context intact.
Second, it accommodates contributors across all time zones without
requiring synchronous participation. Third, it naturally excludes
real-time social dynamics that might favor those most comfortable with
rapid-fire interaction.</p>
<p>However, the mailing list approach also presents challenges. New
contributors sometimes struggle with the volume of messages, the
expected formality of discourse, and the historical context required to
participate effectively in complex discussions.</p>
<h3 data-number="12.2.3" id="consensus-based-decision-making"><span class="header-section-number">12.2.3</span> Consensus-Based Decision
Making</h3>
<p>PostgreSQL employs a rough consensus model for decision-making. This
approach contrasts sharply with projects using strict voting procedures
or hierarchical decision authority. Instead, discussions continue until
a community consensus emerges‚Äînot unanimity, but a general agreement
that a proposed direction represents the best available approach.</p>
<p><strong>Reaching Consensus</strong></p>
<p>The consensus model functions as follows:</p>
<ol type="1">
<li>A proposal is introduced, typically from someone who has undertaken
substantial preliminary work.</li>
<li>Community members discuss the proposal, raising concerns, suggesting
alternatives, and exploring implications.</li>
<li>If significant disagreement exists, discussions continue. Authors
may revise proposals to address concerns.</li>
<li>Consensus is deemed reached when objections have been addressed or
when remaining dissenters agree that the proposal represents a
reasonable direction despite their reservations.</li>
</ol>
<p><strong>The Role of Core Contributors</strong></p>
<p>While PostgreSQL lacks a formal BDFL, certain individuals carry
disproportionate influence due to their technical expertise, involvement
history, and demonstrated judgment. These core contributors effectively
act as decision-makers in ambiguous situations. The project trusts these
individuals to make reasonable calls when perfect consensus remains
elusive.</p>
<p>This system works because these individuals have earned their
authority through consistent, excellent contributions rather than
through formal election or appointment. Their decisions are always
subject to appeal and override if the broader community mobilizes
opposition, but in practice, their judgments are rarely challenged
seriously.</p>
<hr/>
<h2 data-number="12.3" id="part-ii-key-contributors-and-personalities"><span class="header-section-number">12.3</span> Part II: Key Contributors and
Personalities</h2>
<h3 data-number="12.3.1" id="tom-lane-the-unwavering-technical-core"><span class="header-section-number">12.3.1</span> Tom Lane: The Unwavering
Technical Core</h3>
<p>No individual has shaped PostgreSQL more profoundly than Tom Lane. As
one of the few developers with involvement spanning multiple decades,
Lane has authored or guided discussions on nearly every significant
PostgreSQL component. His contributions extend beyond code to include
thoughtful technical guidance, architectural preservation, and
unwavering commitment to correctness.</p>
<p><strong>Scale of Contribution</strong></p>
<p>Tom Lane‚Äôs mailing list participation alone demonstrates
extraordinary commitment. Over more than twenty years, Lane has authored
approximately 82,565 emails to PostgreSQL mailing lists. This
volume‚Äîaveraging multiple substantive technical messages daily for two
decades‚Äîreflects both his productivity and his dedication to developing
consensus through discussion. These emails are not casual messages; many
are lengthy, detailed technical explanations addressing complex
questions with careful reasoning.</p>
<p>The sheer volume of Lane‚Äôs mailing list participation is remarkable,
but what matters more is the quality and consistency. Year after year,
decade after decade, Lane has been available to answer technical
questions, review proposed changes, and participate in architectural
discussions. This consistency has made him an institution within the
PostgreSQL community‚Äîa technical touchstone for understanding how
systems fit together.</p>
<p>Lane‚Äôs technical contributions span virtually every major system:</p>
<ul>
<li><strong>Query Optimizer</strong>: Lane significantly enhanced
PostgreSQL‚Äôs planner and optimizer, implementing advanced techniques
like bitmap index scans, sophisticated join ordering algorithms, and
improved cost estimation. His optimizer work is particularly important
because query performance is central to a database system‚Äôs
utility.</li>
<li><strong>Type System</strong>: He refined PostgreSQL‚Äôs extensive type
system and operator overloading mechanisms, ensuring type safety while
allowing the flexibility PostgreSQL is known for. His work here includes
improvements to implicit casting, operator resolution, and type coercion
rules.</li>
<li><strong>Error Handling</strong>: Lane improved error reporting and
debugging capabilities across the system, making PostgreSQL easier to
troubleshoot and more informative when problems occur.</li>
<li><strong>Buffer Manager and Storage</strong>: Contributions to
cache-conscious data structures and access methods, improving how
PostgreSQL manages memory and disk I/O.</li>
<li><strong>Standards Compliance</strong>: Numerous improvements
ensuring PostgreSQL‚Äôs compatibility with SQL standards. Lane is
unusually concerned with standards compliance, often arguing for
implementations that align with SQL semantics even when PostgreSQL had
implemented something different.</li>
<li><strong>Aggregate Functions and Window Functions</strong>:
Significant work on proper semantics of aggregation and windowing,
ensuring PostgreSQL handles complex analytical queries correctly.</li>
<li><strong>Constraints and Referential Integrity</strong>: Enhancements
to how PostgreSQL handles constraints, ensuring data integrity semantics
are correct.</li>
</ul>
<p><strong>The Philosophy Behind Lane‚Äôs Work</strong></p>
<p>Lane‚Äôs value extends beyond the number of contributions. His approach
embodies PostgreSQL‚Äôs cultural values in practice: he favors correctness
over expedience, prefers to solve problems completely rather than
partially, and maintains an encyclopedic knowledge of how changes in one
system affect others. He is known for tracking down subtle interactions
between systems that others might miss, and for explaining why an
apparently simple change might have far-reaching consequences.</p>
<p>When architectural questions arise, Lane‚Äôs perspective carries
significant weight, not due to formal authority but because his judgment
has proven reliable over decades. His willingness to discuss and defend
positions thoroughly, rather than simply imposing decisions, exemplifies
collaborative technical leadership. He will spend hours debating a
design decision via email if he believes the final result will be
better.</p>
<p>His patience in explaining subtle technical points to newer
contributors has educated generations of PostgreSQL developers. Many
core PostgreSQL contributors have learned database internals partly
through carefully written explanations from Lane addressing their
questions on the mailing list.</p>
<p><strong>Lane‚Äôs Influence on PostgreSQL Culture</strong></p>
<p>Lane‚Äôs long tenure and consistent participation have shaped
PostgreSQL‚Äôs culture in subtle ways. His emphasis on ‚Äúgetting it right‚Äù
has become part of the project‚Äôs identity. His skepticism toward trendy
features or approaches that lack solid foundations has influenced
PostgreSQL‚Äôs conservative evolution. His willingness to reconsider
decisions from years past when new evidence suggests a better approach
has normalized the idea of technical improvement across all historical
periods.</p>
<p>Lane represents an ideal of long-term technical stewardship. He has
no desire for fame or corporate leverage; he simply wants PostgreSQL to
be as good as possible. This commitment, sustained over twenty-five
years, has earned him a role that is somewhere between technical
advisor, architectural authority, and cultural institution.</p>
<h3 data-number="12.3.2" id="bruce-momjian-community-shepherd-and-release-manager"><span class="header-section-number">12.3.2</span> Bruce Momjian: Community
Shepherd and Release Manager</h3>
<p>Bruce Momjian has served PostgreSQL in complementary capacities. As a
long-time employee of EDB and major PostgreSQL advocate, Momjian has
been instrumental in shepherding the project‚Äôs evolution and ensuring
that practical considerations inform technical decisions.</p>
<p>Momjian‚Äôs primary contributions include:</p>
<ul>
<li><strong>Release Management</strong>: Leading or participating in
numerous major release efforts, ensuring smooth transitions between
versions. He has managed release cycles and coordinated the work of many
committers to ensure that releases happen on schedule.</li>
<li><strong>Documentation</strong>: Improving PostgreSQL‚Äôs comprehensive
documentation to make it more accessible. The ‚ÄúPostgreSQL Documentation‚Äù
that ships with every release has been substantially improved through
Momjian‚Äôs efforts. He recognized early that PostgreSQL‚Äôs technical
excellence was sometimes hidden behind incomplete or unclear
documentation.</li>
<li><strong>Business Liaison</strong>: Helping ensure that PostgreSQL
remains suitable for enterprise deployments while maintaining
open-source principles. Momjian serves as a bridge between the technical
community and the business requirements of companies using
PostgreSQL.</li>
<li><strong>Community Education</strong>: Extensive presentations and
writings about PostgreSQL for various audiences. Momjian has given
hundreds of talks, written numerous articles, and maintained the
‚ÄúPostgreSQL Detailed Release Notes‚Äù that accompany each release,
explaining changes in accessible language.</li>
<li><strong>Visual Communication</strong>: Creating slides, diagrams,
and presentations that make PostgreSQL concepts accessible to diverse
audiences, from technical developers to business decision-makers.</li>
</ul>
<p><strong>Momjian‚Äôs Philosophical Approach</strong></p>
<p>Momjian‚Äôs style contrasts productively with Lane‚Äôs‚Äîwhere Lane focuses
on architectural purity and deep technical correctness, Momjian
considers practical deployment realities and user needs. Momjian will
argue for a feature because customers need it, or against a design
because it creates deployment problems. This complementary tension has
served PostgreSQL well, ensuring that the database remains both
architecturally sound and practically usable.</p>
<p>Momjian represents the user‚Äôs voice in PostgreSQL development. While
the technical discussions on pgsql-hackers can become highly abstract,
Momjian reminds the community about real-world usage patterns and the
importance of migration paths for existing users. His influence has made
PostgreSQL more accessible without compromising its technical
standards.</p>
<h3 data-number="12.3.3" id="other-core-contributors"><span class="header-section-number">12.3.3</span> Other Core Contributors</h3>
<p>PostgreSQL‚Äôs development involves numerous other long-term
contributors:</p>
<ul>
<li><strong>Alvaro Herrera</strong>: Known for extensive work on logical
replication, partitioning, and system catalog management.</li>
<li><strong>Michael Paquier</strong>: High volume of contributions
across many subsystems; serves as a link between the PostgreSQL project
and other tools.</li>
<li><strong>Heikki Linnakangas</strong>: Major work on storage systems,
compression, and performance optimization.</li>
<li><strong>David Rowley</strong>: Prominent contributor to query
optimization and window functions.</li>
<li><strong>Robert Haas</strong>: Significant work on parallelization,
partitioning, and performance.</li>
<li><strong>Peter Eisentraut</strong>: Long-serving contributor with
focus on build system, standards compliance, and infrastructure.</li>
</ul>
<p>Each brings distinctive expertise and perspective, collectively
representing a diversity of technical specialties and geographic
locations.</p>
<hr/>
<h2 data-number="12.4" id="part-iii-corporate-participation-and-sponsorship"><span class="header-section-number">12.4</span> Part III: Corporate
Participation and Sponsorship</h2>
<h3 data-number="12.4.1" id="enterprise-database-companies"><span class="header-section-number">12.4.1</span> Enterprise Database
Companies</h3>
<p>PostgreSQL‚Äôs development has increasingly benefited from corporate
sponsorship. Unlike some open-source projects where corporate
involvement is viewed skeptically, PostgreSQL has successfully
integrated corporate participation while maintaining its open-source
principles.</p>
<p><strong>EDB (EnterpriseDB)</strong></p>
<p>EDB has been perhaps the most significant corporate sponsor of
PostgreSQL development. Founded in 2004 to provide enterprise support
for PostgreSQL, EDB has consistently committed substantial development
resources to the project. The company employs numerous core PostgreSQL
developers and has funded improvements in areas commercially valuable to
enterprise customers.</p>
<p>EDB‚Äôs contributions include:</p>
<ul>
<li>Advanced replication features and logical replication</li>
<li>Partitioning enhancements</li>
<li>Performance optimization work</li>
<li>Infrastructure improvements</li>
</ul>
<p>The company‚Äôs business model‚Äîselling support, consulting, and
proprietary extensions alongside open-source PostgreSQL‚Äîhas proven
sustainable while funding core development.</p>
<p><strong>Crunchy Data</strong></p>
<p>Crunchy Data emerged as a second major PostgreSQL sponsor, focusing
on Kubernetes-native PostgreSQL deployment. The company has sponsored
development of tools, extensions, and improvements relevant to
containerized deployments.</p>
<p><strong>Other Corporate Contributors</strong></p>
<p>Numerous other companies sponsor PostgreSQL development:</p>
<ul>
<li><strong>Google</strong>: Funded development in areas like logical
decoding and replication.</li>
<li><strong>Microsoft</strong>: Contributed improvements for Windows
compatibility and contributed to specific features.</li>
<li><strong>Salesforce</strong>: Sponsored work on logical replication
and other enterprise features.</li>
<li><strong>NTT Data, Fujitsu, and other Japanese companies</strong>:
Long history of PostgreSQL sponsorship and contribution.</li>
<li><strong>AWS, Azure, and other cloud providers</strong>: While often
contributing improvements for their platforms, these companies sometimes
invest in PostgreSQL development.</li>
</ul>
<h3 data-number="12.4.2" id="funding-and-investment-models"><span class="header-section-number">12.4.2</span> Funding and Investment
Models</h3>
<p>PostgreSQL‚Äôs funding differs from many open-source projects in
several important ways:</p>
<ol type="1">
<li><p><strong>No Single Funding Source</strong>: Unlike projects funded
primarily by one organization or foundation, PostgreSQL‚Äôs development is
funded by multiple independent actors. This diversity provides
stability‚Äîthe project cannot be dominated by any single funder‚Äôs
priorities. In the database landscape, this is particularly important
because funding decisions reflect different market segments. A
cloud-focused company might fund replication improvements, while an
analytics company might fund query performance. The diversity of funding
means PostgreSQL benefits from improvements driven by varied use
cases.</p></li>
<li><p><strong>Developer-Driven Funding</strong>: Money typically flows
to fund developers who want to work on PostgreSQL, rather than funding
being directed top-down by corporate strategy. Companies employ
developers who are passionate about PostgreSQL and allow them to
contribute to the project. This is remarkable because it means
PostgreSQL benefits from developers‚Äô intrinsic motivation to improve the
system, not just fulfilling corporate directives. Many PostgreSQL
developers are personally invested in the project‚Äôs quality and have
chosen to work for companies that support their PostgreSQL
interests.</p></li>
<li><p><strong>No Central Foundation</strong>: Unlike Linux, which is
coordinated by the Linux Foundation, or Python, which is guided by the
Python Software Foundation, PostgreSQL operates without a central
governance foundation. This has advantages (avoiding bureaucracy and
bureaucratic overhead) and disadvantages (requiring strong community
consensus for all decisions). PostgreSQL maintains its own
infrastructure and makes decisions through community discussion rather
than through a foundation board. This model relies on the community‚Äôs
maturity and ability to reach consensus.</p></li>
<li><p><strong>Limited Marketing Funding</strong>: Corporate sponsors
tend to fund development rather than marketing. This means PostgreSQL‚Äôs
growth has been organic, driven by quality rather than corporate
marketing campaigns. Users discover PostgreSQL because it solves their
problems, not because they saw an advertisement. This organic growth has
produced a user base that is genuinely committed to the technology
rather than using it because of marketing hype.</p></li>
<li><p><strong>Sustaining Engineering Funding</strong>: In recent years,
a new funding model has emerged: companies funding ‚Äúsustaining
engineering‚Äù‚Äîwork that doesn‚Äôt add features but improves reliability,
performance, and maintainability. This includes bug fixes, performance
optimization, and refactoring to improve code maintainability.
Sustaining engineering is sometimes unglamorous but essential for
long-term database stability. The presence of funding for this work
reflects mature recognition that databases require continuous investment
in quality, not just new features.</p></li>
</ol>
<h3 data-number="12.4.3" id="balancing-commercial-and-community-interests"><span class="header-section-number">12.4.3</span> Balancing Commercial and
Community Interests</h3>
<p>PostgreSQL has navigated the inherent tension between commercial
sponsors‚Äô business interests and the open-source community‚Äôs values.
This balance is maintained through several mechanisms:</p>
<p><strong>Technical Merit as Primary Criterion</strong></p>
<p>Features are adopted based on technical quality and community
consensus, not commercial pressure. A company cannot simply fund
development of a feature and expect it to be merged into core PostgreSQL
without community support.</p>
<p><strong>Proprietary Extensions and Additions</strong></p>
<p>PostgreSQL‚Äôs extensibility allows companies to build proprietary
capabilities atop the open-source core. This model enables commercial
differentiation without requiring changes to core PostgreSQL that might
serve only one company‚Äôs customers.</p>
<p><strong>Transparent Contribution Process</strong></p>
<p>Corporate-sponsored work goes through the same review and CommitFest
process as any other contribution. Corporate developers must justify
their work within the community, just as individual volunteers do.</p>
<hr/>
<h2 data-number="12.5" id="part-iv-cultural-values-and-principles"><span class="header-section-number">12.5</span> Part IV: Cultural Values and
Principles</h2>
<h3 data-number="12.5.1" id="technical-excellence-and-correctness"><span class="header-section-number">12.5.1</span> Technical Excellence and
Correctness</h3>
<p>PostgreSQL‚Äôs most distinctive cultural value is the prioritization of
technical excellence and correctness over expedience. This manifests in
numerous ways:</p>
<p><strong>Conservative Evolution</strong></p>
<p>PostgreSQL evolves carefully. New features are thoroughly vetted.
Architectural changes are implemented completely, not partially.
Performance optimizations are required to demonstrate measurable
improvement without introducing subtle correctness issues.</p>
<p>This conservatism sometimes means PostgreSQL lags competitors in
adding trendy features. But it means that when PostgreSQL implements
something, it works reliably. This has proven strategically
sound‚Äîcompanies choosing PostgreSQL expect stability and reliability
above all else.</p>
<p><strong>Deep Expertise Required</strong></p>
<p>Core PostgreSQL development requires substantial technical depth.
Contributing requires understanding not just how to write code, but how
code integrates with existing systems and affects the broader database
ecosystem. This high barrier to entry maintains code quality but also
makes the project less accessible to newcomers.</p>
<p><strong>Perfection as the Target</strong></p>
<p>PostgreSQL developers often say they prefer ‚Äúcorrect and slower‚Äù to
‚Äúfast and wrong.‚Äù This philosophy informs decisions across the project.
When choosing between an optimization that provides 5% improvement but
introduces subtle edge cases versus a slower approach that‚Äôs provably
correct, PostgreSQL favors the latter.</p>
<h3 data-number="12.5.2" id="transparency-and-open-discussion"><span class="header-section-number">12.5.2</span> Transparency and Open
Discussion</h3>
<p>PostgreSQL operates with remarkable transparency. Technical decisions
aren‚Äôt made in closed meetings or private discussions. They‚Äôre debated
publicly on mailing lists, with full reasoning and alternative
approaches documented in archives available to anyone.</p>
<p><strong>Public Deliberation</strong></p>
<p>When PostgreSQL faces significant technical decisions, the entire
community participates in discussion. A complex replication design might
generate hundreds of emails from developers around the world, each
contributing perspectives and identifying issues.</p>
<p>This transparency serves multiple functions. It ensures that diverse
viewpoints inform decisions. It educates newer developers about the
project‚Äôs thinking. It creates historical documentation of why
particular architectural choices were made. And it builds
trust‚Äîdevelopers know they can influence project direction through
reasoned argument.</p>
<p><strong>Accountability</strong></p>
<p>Transparency also creates accountability. Decisions made publicly can
be publicly questioned. If a change breaks user code or violates
community norms, the decision-maker must defend the choice to the full
community.</p>
<h3 data-number="12.5.3" id="inclusivity-and-global-participation"><span class="header-section-number">12.5.3</span> Inclusivity and Global
Participation</h3>
<p>PostgreSQL operates as a truly global project. Contributors span
every continent, speaking dozens of languages, coming from corporations,
startups, and individual hobby projects.</p>
<p><strong>Accommodating Different Work Styles</strong></p>
<p>The project consciously accommodates different participation styles.
Synchronous communication through chat is minimized; asynchronous email
discussion is primary. This allows contributors in different time zones
to participate fully. Weekly development meetings would exclude half the
world; email discussions include everyone.</p>
<p><strong>Translation and Localization</strong></p>
<p>PostgreSQL is available in numerous languages. Documentation is
translated. Error messages are internationalized. This commitment to
making PostgreSQL accessible across language barriers reflects the
project‚Äôs global identity.</p>
<p><strong>Diverse Perspectives</strong></p>
<p>The project‚Äôs international composition means it considers diverse
perspectives on database design. A feature proposal might be questioned
by developers in different countries who have encountered different use
cases in their regions. This diversity has generally improved
PostgreSQL‚Äôs design.</p>
<h3 data-number="12.5.4" id="long-term-thinking-and-stability"><span class="header-section-number">12.5.4</span> Long-Term Thinking and
Stability</h3>
<p>PostgreSQL developers understand that the database is often deployed
in contexts where it will operate for decades. This creates a strong
cultural emphasis on long-term thinking.</p>
<p><strong>Backward Compatibility</strong></p>
<p>PostgreSQL maintains exceptional backward compatibility. Extensions
written for PostgreSQL 9.x typically still work on PostgreSQL 15. User
applications rarely require modification beyond the feature level. This
stability matters profoundly for deployed systems.</p>
<p>The project will sometimes forgo features or optimizations to
preserve compatibility. The development team takes seriously any change
that might break existing deployments.</p>
<p><strong>Planning for Decades</strong></p>
<p>Architectural decisions are made with awareness that they‚Äôll shape
PostgreSQL for twenty years or more. A new storage format or replication
architecture is thoroughly evaluated before deployment, because changing
it later would be extraordinarily difficult.</p>
<p><strong>Deprecation Over Breaking Change</strong></p>
<p>When PostgreSQL must remove or change functionality, it typically
deprecates first, warning users for several releases before making the
change. This gives deployed systems time to migrate.</p>
<hr/>
<h2 data-number="12.6" id="part-v-decision-making-without-a-bdfl"><span class="header-section-number">12.6</span> Part V: Decision-Making
Without a BDFL</h2>
<h3 data-number="12.6.1" id="why-no-benevolent-dictator"><span class="header-section-number">12.6.1</span> Why No Benevolent
Dictator?</h3>
<p>PostgreSQL‚Äôs evolution from the original POSTGRES project through
various hands to the PostgreSQL project never established a single
leader with final authority. This emerged partly by accident‚Äîno one
person had the necessary skills and the will to consolidate control. But
it proved advantageous, because it forced the project to develop
consensus-based decision mechanisms.</p>
<p>Without a BDFL, PostgreSQL can‚Äôt be derailed by one person‚Äôs biases
or vision. Features that serve the majority aren‚Äôt blocked by a
dictator‚Äôs whim. Conversely, poor decisions aren‚Äôt imposed by top-down
authority. The burden of decision falls on the community.</p>
<h3 data-number="12.6.2" id="the-rough-consensus-model"><span class="header-section-number">12.6.2</span> The Rough Consensus
Model</h3>
<p>PostgreSQL uses ‚Äúrough consensus and running code‚Äù as its primary
decision model, borrowed from Internet standards development
(specifically the IETF‚Äôs RFC process). This approach works as
follows:</p>
<p><strong>Rough Consensus Defined</strong></p>
<p>Rough consensus means that:</p>
<ol type="1">
<li>Most of the community agrees on a direction</li>
<li>Those who disagree either agree it‚Äôs a reasonable direction despite
their reservations, or are significantly outnumbered</li>
<li>The proposal‚Äôs author(s) have addressed major objections</li>
<li>Proceeding will not cause severe harm to the minority view</li>
<li>The proposed implementation demonstrates technical soundness and
maturity (‚Äúrunning code‚Äù)</li>
</ol>
<p>Notably, rough consensus does NOT mean unanimous agreement. It
explicitly allows that some developers may believe a different approach
would be better. But the community agrees that the proposed approach is
reasonable and worth implementing. This is more realistic than demanding
unanimous agreement‚Äîin any diverse community, perfect consensus is
impossible, and demanding it would lead to stalemate.</p>
<p><strong>The ‚ÄúRunning Code‚Äù Requirement</strong></p>
<p>PostgreSQL complements consensus with a requirement for ‚Äúrunning
code.‚Äù This means that architectural proposals must not remain
theoretical; they must be implemented to validate the design. It‚Äôs one
thing to argue that an approach will work; it‚Äôs another to demonstrate
it actually does. This requirement has the effect of filtering out
half-baked proposals while rewarding developers who do the work to
validate their ideas.</p>
<p>This emphasis on running code also prevents the situation where
design discussions become purely theoretical. Many proposed database
features look good in the abstract but reveal problems when actually
implemented. PostgreSQL‚Äôs approach forces those discoveries to happen
before a feature is merged.</p>
<p><strong>How Consensus is Tested</strong></p>
<p>PostgreSQL tests consensus through extended discussion:</p>
<ol type="1">
<li>A proposal is made and thoroughly discussed</li>
<li>Objections are raised and addressed</li>
<li>If consensus appears to emerge after discussion, the proposal may
proceed</li>
<li>If strong objection persists, discussion continues</li>
</ol>
<p>Sometimes discussions last months or longer. A proposal that cannot
convince the community after extensive discussion is unlikely to be
accepted.</p>
<p><strong>The Authority to Commit</strong></p>
<p>Ultimately, someone must decide when to commit code. This authority
resides with PostgreSQL‚Äôs committers‚Äîdevelopers with write access to the
repository. There are typically five to ten core committers at any time,
with additional committers responsible for specific subsystems.</p>
<p>Committers typically have earned their position through years of
demonstrated competence and alignment with community values. They‚Äôre
expected to use their commit authority conservatively and in service of
community consensus, not to impose their personal preferences.</p>
<p><strong>Overriding Committers</strong></p>
<p>Theoretically, a committer could commit something without consensus.
In practice, doing so would trigger intense community backlash. A
committer who repeatedly commits code against community sentiment would
lose the trust that underlies their authority. The absence of formal
mechanisms for enforcing committer behavior is offset by the strength of
community disapprobation for violating norms.</p>
<h3 data-number="12.6.3" id="resolving-intractable-disagreement"><span class="header-section-number">12.6.3</span> Resolving Intractable
Disagreement</h3>
<p>Occasionally, PostgreSQL faces situations where consensus cannot be
reached. Different committers might have irreconcilable views. How does
the project proceed?</p>
<p><strong>Stalemate as Status Quo</strong></p>
<p>PostgreSQL has no formal mechanism for breaking ties. Sometimes, the
project simply accepts stalemate‚Äîa feature isn‚Äôt implemented because
consensus couldn‚Äôt be reached. Interestingly, this is often acceptable,
because a feature that doesn‚Äôt achieve consensus is probably something
the majority doesn‚Äôt need urgently.</p>
<p><strong>Compromise Solutions</strong></p>
<p>Often, extended discussion leads to compromise solutions that aren‚Äôt
anyone‚Äôs first choice but that everyone can accept. A particular
replication architecture might be modified to address concerns from
multiple parties.</p>
<p><strong>Deferring to Expertise</strong></p>
<p>When disagreement is particularly technical, PostgreSQL defers to the
expertise of those most familiar with relevant code. If a debate
concerns optimizer behavior, the primary optimizer maintainers‚Äô views
carry more weight.</p>
<p><strong>Time and Experimentation</strong></p>
<p>Sometimes PostgreSQL implements competing approaches in different
extensions or branches, allowing the community to experiment and develop
empirical evidence. A feature might exist in pglogical before being
integrated into core PostgreSQL, for instance.</p>
<hr/>
<h2 data-number="12.7" id="part-vi-code-of-conduct-and-communication-style"><span class="header-section-number">12.7</span> Part VI: Code of Conduct and
Communication Style</h2>
<h3 data-number="12.7.1" id="the-postgresql-code-of-conduct"><span class="header-section-number">12.7.1</span> The PostgreSQL Code of
Conduct</h3>
<p>PostgreSQL adopted a formal Code of Conduct in 2019, joining many
other open-source projects in establishing explicit expectations for
respectful interaction. The Code of Conduct addresses:</p>
<p><strong>Core Commitments</strong></p>
<ul>
<li>Welcoming environment for contributors of all backgrounds and
experience levels</li>
<li>Respect for different perspectives and ideas</li>
<li>Constructive criticism focused on technical merit</li>
<li>Accountability for harmful behavior</li>
<li>Inclusive language and awareness of diverse backgrounds</li>
<li>Prohibition of harassment, discrimination, and abusive behavior</li>
<li>Expectations that disagreements will be technical and civil</li>
</ul>
<p><strong>Historical Context</strong></p>
<p>Before adopting a formal Code of Conduct, PostgreSQL relied on
informal social norms and cultural understanding. The project had
generally maintained civil discourse, but the informality meant that
expectations were not explicit. Some newer contributors didn‚Äôt
understand the implicit rules. Occasional incidents of uncivil behavior
occurred, handled through informal mediation by senior members.</p>
<p>The decision to adopt a formal Code of Conduct reflected maturity and
growth. As PostgreSQL became more prominent and attracted contributors
from more diverse backgrounds and organizations, relying on implicit
understanding became insufficient. Different communities and
organizations have different norms. Making expectations explicit helps
everyone understand what behavior is expected and creates a framework
for addressing violations.</p>
<p><strong>Enforcement</strong></p>
<p>A Code of Conduct Committee investigates reports of violations. The
committee includes representatives from various parts of the PostgreSQL
community. The committee can request that individuals modify behavior,
require apologies, or in severe cases, remove them from project
participation. Notably, this is a significant change for PostgreSQL,
which historically relied on informal social norms rather than explicit
rules.</p>
<p>The Code of Conduct Committee emphasizes education and
rehabilitation. The goal is not to punish but to correct behavior.
Someone might not understand PostgreSQL‚Äôs communication norms and might
be behaving in ways that violate the Code of Conduct. In such cases, the
committee will explain expectations and give the person opportunity to
modify behavior.</p>
<p>Serious violations‚Äîharassment, discrimination, abusive language‚Äîare
handled more severely. But even then, removal from the project is a last
resort reserved for repeated violations after warnings.</p>
<p><strong>Integration with Project Culture</strong></p>
<p>The Code of Conduct is still relatively new in PostgreSQL‚Äôs context.
Its integration into a project culture previously governed by informal
norms required adjustment. Generally, it has been welcomed as making
explicit standards that were already widely expected. Most long-term
community members discovered that the Code of Conduct codified norms
they were already following.</p>
<p>However, the formalization also represented acknowledgment that
culture cannot be assumed. New, diverse community members need explicit
guidance about expectations. The Code of Conduct serves this educational
function, helping contributors understand how to participate
respectfully.</p>
<h3 data-number="12.7.2" id="expected-communication-style"><span class="header-section-number">12.7.2</span> Expected Communication
Style</h3>
<p>PostgreSQL‚Äôs communication culture reflects its values and history.
New contributors often must calibrate to different communication
expectations than in other open-source communities.</p>
<p><strong>Formal and Technical</strong></p>
<p>PostgreSQL discussions tend to be formal and highly technical. Casual
banter is minimized on technical lists. Discussions focus on code and
architecture rather than personalities. This formality can seem cold to
those accustomed to more casual online communities, but it reflects the
project‚Äôs focus on technical substance.</p>
<p><strong>Thorough Argumentation</strong></p>
<p>When disagreeing, PostgreSQL participants are expected to provide
thorough technical argumentation. ‚ÄúI disagree‚Äù is not an acceptable
position; ‚ÄúI disagree because X, Y, and Z‚Äù is required. This expectation
ensures that disagreements are substantive and that responses address
actual concerns rather than mere preference.</p>
<p><strong>Patience and Long Discussions</strong></p>
<p>PostgreSQL tolerates lengthy discussions as normal. If a feature
proposal generates 200 emails debating its merits, that‚Äôs viewed as
healthy community discussion, not an embarrassing flood. This contrasts
with communities expecting decisions to be made quickly.</p>
<p><strong>Respect for History and Context</strong></p>
<p>Contributors are expected to learn from PostgreSQL‚Äôs history. A
suggestion to change something that was deliberately designed a
particular way five years ago because of well-understood constraints is
not a fresh idea; it‚Äôs a question requiring engagement with historical
context.</p>
<h3 data-number="12.7.3" id="handling-conflict"><span class="header-section-number">12.7.3</span> Handling Conflict</h3>
<p>PostgreSQL‚Äôs mechanisms for handling interpersonal conflict are
informal and cultural rather than formal, though the Code of Conduct
Committee provides some structure. Key principles include:</p>
<p><strong>Direct Communication</strong></p>
<p>Conflicts are addressed directly between parties when possible. If
two developers disagree about code direction, they‚Äôre expected to
discuss it directly before escalating. An implicit norm says that airing
disagreements in public without first trying to resolve privately is
considered somewhat uncivil. This encourages developers to work through
issues collaboratively rather than posturing for an audience.</p>
<p>In practice, direct communication often happens via email between the
parties before broader discussion. If a committer disagrees with a patch
author about technical direction, they might email privately asking
questions. The author can clarify thinking and often agreement emerges
without broader discussion.</p>
<p><strong>Public Discussion</strong></p>
<p>Most conflicts that don‚Äôt resolve privately are worked through
publicly on mailing lists. This transparency ensures that problems don‚Äôt
fester in private and that the community can provide perspective. Public
discussion also creates accountability‚Äîboth parties know their arguments
are being evaluated by the broader community.</p>
<p>However, the public nature of conflict also creates pressure for
professionalism. Nobody wants to be publicly perceived as unreasonable
or uncollegial. This incentivizes developers to make careful,
well-reasoned arguments rather than emotional appeals.</p>
<p><strong>De-Escalation</strong></p>
<p>Senior contributors often play unofficial mediator roles in
conflicts. If a discussion is becoming unproductive or contentious, an
experienced developer might step in to reframe the issue, summarize
areas of agreement, or suggest a path forward. These interventions are
not formal‚Äîthere‚Äôs no mediation authority‚Äîbut they‚Äôre culturally
respected.</p>
<p>A committer with high credibility might write a message saying
something like ‚ÄúI think we‚Äôre talking past each other. Let me reframe
the concerns.‚Äù This can help reset a discussion that‚Äôs become emotional
or circular.</p>
<p><strong>Code of Conduct Enforcement for Serious
Conflicts</strong></p>
<p>While most conflicts are handled informally, serious
violations‚Äîabusive language, harassment, discrimination‚Äîare now handled
through the Code of Conduct Committee. This provides a more formal
process while still emphasizing education and rehabilitation over
punishment.</p>
<p><strong>The Possibility of Exclusion</strong></p>
<p>While PostgreSQL is generally forgiving, individuals who repeatedly
violate community norms can be asked to participate elsewhere. This is
rare‚Äîthe project prefers to rehabilitate contributors‚Äîbut it remains an
ultimate enforcement mechanism. Exclusion is used only when someone has
been warned multiple times and continues problematic behavior, or when
behavior is so egregious that immediate removal is necessary.</p>
<p>The threat of possible exclusion, while rarely implemented, helps
maintain community norms. People understand that uncivil behavior has
consequences, which incentivizes maintaining professional standards.</p>
<hr/>
<h2 data-number="12.8" id="part-vii-the-developer-experience"><span class="header-section-number">12.8</span> Part VII: The Developer
Experience</h2>
<h3 data-number="12.8.1" id="becoming-a-postgresql-contributor"><span class="header-section-number">12.8.1</span> Becoming a PostgreSQL
Contributor</h3>
<p>Contributing to PostgreSQL requires navigating a steep learning
curve. The project‚Äôs cultural values and technical depth mean that
casual contributions are rare. This stands in contrast to many modern
open-source projects that pride themselves on accepting first-time
contributions within minutes.</p>
<p><strong>Initial Barriers</strong></p>
<p>New contributors must:</p>
<ol type="1">
<li><p><strong>Understand PostgreSQL deeply</strong>: Core PostgreSQL
development requires substantial knowledge of the codebase,
architectural patterns, and design history. Understanding how the query
optimizer works, how the buffer manager functions, or how transactions
are processed requires studying code and reading documentation.
Contributors must know not just their specific change, but how it
affects adjacent systems.</p></li>
<li><p><strong>Learn community norms</strong>: The communication style,
discussion format, and cultural expectations differ from many other
projects. PostgreSQL‚Äôs formality, its emphasis on technical rigor, and
its tolerance for long discussion threads can feel alienating to those
accustomed to rapid chat-based decision-making. Learning to write
substantive technical emails and engage in detailed reasoning is itself
a learning curve.</p></li>
<li><p><strong>Prepare comprehensive contributions</strong>:
Half-finished or quick-and-dirty patches are not acceptable.
Contributors must demonstrate that they understand implications of their
changes across the entire system. A patch affecting the buffer manager
might interact with replication, transactions, and the statistics
collector. The contributor must trace these interactions and ensure the
patch doesn‚Äôt introduce subtle bugs.</p></li>
<li><p><strong>Engage in discussion</strong>: Proposals aren‚Äôt submitted
and then committed in isolation. The contributor must participate in
review discussion, address concerns, and revise iteratively. If a
reviewer asks a technical question, the contributor must answer
thoughtfully and address the underlying concern, not just defend the
patch.</p></li>
<li><p><strong>Have persistence</strong>: Getting a patch into
PostgreSQL can take months or even years. A feature proposed in one
CommitFest might not be ready until the next. The contributor must
maintain interest and motivation across long development
cycles.</p></li>
</ol>
<p><strong>Barriers as Features</strong></p>
<p>These barriers aren‚Äôt bugs in PostgreSQL‚Äôs development process;
they‚Äôre features. They ensure that core PostgreSQL is modified only by
people who understand it deeply. They preserve architectural
consistency. They maintain code quality standards. They prevent the
‚Äúpatch monoculture‚Äù where code quality degrades because anyone can
submit anything.</p>
<p>However, these barriers also mean PostgreSQL development is less
accessible than projects accepting quick patches from first-time
contributors. Someone who wants to submit a small documentation fix or
report a bug can do so easily. But someone wanting to modify core
behavior must invest substantial effort in understanding the system
first.</p>
<p>This creates a particular demographic pattern in PostgreSQL
development: contributors tend to be people who have been using
PostgreSQL for years and developed deep knowledge before attempting to
contribute. Many PostgreSQL core committers have used PostgreSQL in
production for ten or more years before submitting their first patch to
the core system.</p>
<h3 data-number="12.8.2" id="resources-for-contributors"><span class="header-section-number">12.8.2</span> Resources for
Contributors</h3>
<p>PostgreSQL provides substantial resources for developers:</p>
<ul>
<li><strong>Developer documentation</strong>: Extensive internals
documentation describing how various subsystems work</li>
<li><strong>Hackers wiki</strong>: Collaborative documentation created
by developers</li>
<li><strong>CommitFest tracking</strong>: Tools for managing patch
review process</li>
<li><strong>Discussion archives</strong>: Searchable email archives
spanning decades</li>
<li><strong>Code comments</strong>: Extensive inline documentation in
source code</li>
</ul>
<p>These resources help new developers understand the project. However,
learning PostgreSQL internals remains challenging‚Äîthe project‚Äôs
complexity is genuine.</p>
<h3 data-number="12.8.3" id="mentorship-and-learning"><span class="header-section-number">12.8.3</span> Mentorship and Learning</h3>
<p>Experienced developers in PostgreSQL often informally mentor newer
contributors. Someone might volunteer to help review patches from a
newcomer, answer questions about how particular systems work, or explain
why a particular architectural approach was chosen years ago. This
informal mentorship is essential for onboarding new developers into a
large, complex project.</p>
<p>The mentorship often starts with a newcomer asking a question on
pgsql-hackers: ‚ÄúI‚Äôm trying to understand how constraint exclusion
works‚Äîcan someone explain the relevant code sections?‚Äù An experienced
developer might respond with a detailed explanation, pointing to
specific code sections and explaining the design decisions behind them.
This kind of informal knowledge transfer happens constantly and is
crucial for spreading understanding.</p>
<p>For contributors with access to resources, more structured mentorship
happens in person at PostgreSQL conferences. The annual ‚ÄúPGConf‚Äù and
regional conferences include hallway conversations where experienced
developers help newer developers understand the codebase. Some
conferences also organize mentorship events specifically designed to
help newcomers.</p>
<p><strong>The Mentorship Opportunity and Challenge</strong></p>
<p>Experienced developers often report that helping newcomers is one of
the most rewarding aspects of PostgreSQL involvement. There‚Äôs
satisfaction in passing on knowledge and watching someone grow from
confused novice to confident contributor. Some experienced developers
make mentoring a explicit priority and will volunteer for CommitFests
specifically to review beginner-friendly patches.</p>
<p>However, mentorship is limited by the voluntary nature of
contribution. Unlike a company where senior engineers are assigned
mentorship responsibilities and evaluated on how effectively they
mentor, PostgreSQL relies on volunteers choosing to mentor. This works
but creates uneven mentorship availability. Some newcomers find
excellent mentors; others struggle to find guidance. Some experienced
developers mentor extensively; others provide no mentorship.</p>
<p>The project recognizes this as a limitation and occasionally
discusses more structured mentorship programs. However, implementing
formal programs requires infrastructure and coordination that
PostgreSQL‚Äôs volunteer-driven structure doesn‚Äôt naturally provide.</p>
<p><strong>Learning Resources</strong></p>
<p>PostgreSQL provides substantial resources for developers to learn
independently:</p>
<ul>
<li><strong>Developer documentation</strong>: Extensive internals
documentation describing how various subsystems work, available at
https://www.postgresql.org/docs/current/internals.html</li>
<li><strong>Code comments</strong>: Extensive inline documentation in
source code explaining why particular approaches were chosen</li>
<li><strong>Hackers wiki</strong>: Collaborative documentation created
by developers, including tutorials and system overviews</li>
<li><strong>Historical discussions</strong>: Searchable archives of two
decades of email discussions explaining reasoning behind design
decisions</li>
<li><strong>Source code history</strong>: Git blame can show when
particular code was written and the commit message explaining the
change</li>
</ul>
<p>These resources help new developers learn independently. However,
learning from code and commit messages requires patience and extensive
study. A clear tutorial written by an expert is often more efficient
than reverse-engineering understanding from code.</p>
<p><strong>Growing the Contributor Pipeline</strong></p>
<p>The community recognizes that the pipeline of new contributors
developing into core committers is not as robust as desired. Several
initiatives have been launched to improve onboarding:</p>
<ul>
<li><strong>Beginner-friendly issue tagging</strong>: Marking issues
that are good for new contributors to tackle</li>
<li><strong>Mentorship programs</strong>: Occasional formal mentorship
arrangements connecting newcomers with experienced developers</li>
<li><strong>Contributor gatherings</strong>: Organizing informal groups
of developers to work together on particular projects</li>
<li><strong>Documentation improvements</strong>: Making internal
documentation clearer and more accessible to newcomers</li>
</ul>
<p>These initiatives are ongoing, reflecting the community‚Äôs commitment
to making PostgreSQL development more accessible while maintaining
quality standards.</p>
<hr/>
<h2 data-number="12.9" id="part-viii-challenges-and-evolution"><span class="header-section-number">12.9</span> Part VIII: Challenges and
Evolution</h2>
<h3 data-number="12.9.1" id="growth-and-scaling-challenges"><span class="header-section-number">12.9.1</span> Growth and Scaling
Challenges</h3>
<p>As PostgreSQL has grown in importance and complexity, the project
faces challenges around decision-making and community coordination that
were not apparent when the project was smaller:</p>
<p><strong>Decision Throughput</strong></p>
<p>With so many committers and contributors, ensuring that discussions
reach consensus has become more complex. What worked for a 20-person
development community becomes harder at 100+ active contributors across
dozens of companies. Email discussions on pgsql-hackers can generate
hundreds of messages in a few days. Consensus becomes harder to identify
when there are many voices and many different perspectives.</p>
<p>The CommitFest system helps manage this complexity by structuring
when discussions happen and when decisions are made. However, even with
CommitFest structure, the volume of discussions requiring consensus has
increased. A complex architectural decision might involve emails from a
dozen developers, each with different concerns and perspectives.
Reaching consensus across so much diversity takes longer.</p>
<p><strong>Specialized Knowledge Silos</strong></p>
<p>As PostgreSQL has grown more complex, specialized knowledge about
particular subsystems is increasingly concentrated in particular
developers. The person who understands the optimizer best, the person
who understands replication best, and the person who understands the
buffer manager best might be three different people, none of whom
understand all three systems deeply.</p>
<p>This improves deep development in those areas but creates bottlenecks
when decisions affect subsystem boundaries. A query optimization might
interact with the buffer manager in subtle ways. Decisions require both
the optimizer expert and the buffer manager expert to understand
implications. If these experts disagree or have different priorities,
reaching consensus becomes difficult.</p>
<p><strong>Newcomer Integration</strong></p>
<p>The high barrier to entry means that PostgreSQL‚Äôs contributor base
grows slowly. Many other projects can recruit new contributors rapidly;
PostgreSQL must invest substantial effort in growing its developer
community. New developers must spend considerable time learning the
codebase before they can make meaningful contributions. This learning
curve is not unique to PostgreSQL, but it‚Äôs more pronounced because of
PostgreSQL‚Äôs size and complexity.</p>
<p>There‚Äôs also a concern about sustainability. Many long-term
PostgreSQL developers are in their 40s, 50s, or beyond. As they retire
or reduce involvement, the project needs new developers to maintain
existing systems. But the high barrier to entry means that pipeline of
new developers developing into core contributors is not as robust as
some other projects would prefer.</p>
<h3 data-number="12.9.2" id="responding-to-modern-development-practices"><span class="header-section-number">12.9.2</span> Responding to Modern
Development Practices</h3>
<p>PostgreSQL‚Äôs development culture formed in the 1990s and early 2000s.
Modern collaborative development practices have evolved
significantly:</p>
<p><strong>Chat and Synchronous Communication</strong></p>
<p>Many projects now use Slack, Discord, or IRC for real-time
discussion. PostgreSQL has resisted this, partly because it would
disadvantage asynchronous, distributed contributors but also partly
because of cultural preference for archivable discussion.</p>
<p>Recent years have seen increased use of chat channels, creating a
hybrid model. However, important decisions continue to happen on mailing
lists.</p>
<p><strong>Version Control Evolution</strong></p>
<p>PostgreSQL uses Git, but long resisted. The project maintained custom
patch application tools and email-based patch distribution longer than
many communities. This reflected the importance of archivable,
email-integrated patch flow in PostgreSQL‚Äôs decision-making.</p>
<p><strong>Issue Tracking</strong></p>
<p>PostgreSQL uses a custom issue tracking system on its website, less
sophisticated than GitHub Issues or Jira that many modern projects
employ. This reflects the project‚Äôs preference for email-driven
workflows and skepticism of tools that fragment discussion.</p>
<h3 data-number="12.9.3" id="increasing-pressure-for-rapid-development"><span class="header-section-number">12.9.3</span> Increasing Pressure for
Rapid Development</h3>
<p>The competitive database landscape applies pressure for rapid feature
development. Cloud databases, modern competitors, and market demands all
push for speedier releases and more features. PostgreSQL‚Äôs careful,
consensus-driven process sometimes feels slow in comparison.</p>
<p>The project has responded partially through increased release
frequency‚Äîreleases are now annually rather than every 18-24 months‚Äîwhile
maintaining the careful review process. However, tension between desired
pace and community consensus remains.</p>
<hr/>
<h2 data-number="12.10" id="part-ix-the-future-of-postgresql-culture"><span class="header-section-number">12.10</span> Part IX: The Future of
PostgreSQL Culture</h2>
<h3 data-number="12.10.1" id="adaptation-and-resilience"><span class="header-section-number">12.10.1</span> Adaptation and
Resilience</h3>
<p>PostgreSQL‚Äôs development culture has proven remarkably resilient and
capable of adaptation across three decades. The project has
successfully:</p>
<ul>
<li><strong>Integrated corporate sponsors</strong> without being
co-opted by any single company‚Äôs agenda</li>
<li><strong>Scaled from dozens to hundreds of active
contributors</strong> while maintaining quality standards</li>
<li><strong>Adapted tools and practices</strong> (adopting Git, web
infrastructure, etc.) while maintaining core community values</li>
<li><strong>Adopted formal structures</strong> (Code of Conduct, formal
governance documents) while preserving the consensus-based decision
model</li>
<li><strong>Absorbed significant changes in personnel</strong> as
founders retired and new leaders emerged</li>
<li><strong>Maintained development velocity</strong> despite increasing
complexity and codebase size</li>
</ul>
<p>These adaptations have not been made naively‚Äîthe community has
carefully considered how changes would affect the project‚Äôs character.
When adopting new tools or processes, PostgreSQL asks not just ‚Äúwill
this work?‚Äù but ‚Äúwill this reinforce or undermine our values?‚Äù</p>
<p>Looking forward, PostgreSQL faces the challenge of remaining both
high-quality and relevant as databases and development practices
continue evolving. The database landscape is increasingly competitive,
with cloud-native databases, specialized data stores, and novel
architectures challenging PostgreSQL‚Äôs position. Can PostgreSQL remain
innovative while maintaining its careful, consensus-driven development
model?</p>
<h3 data-number="12.10.2" id="inclusivity-and-accessibility"><span class="header-section-number">12.10.2</span> Inclusivity and
Accessibility</h3>
<p>The community is actively working to make PostgreSQL development more
accessible. Improved documentation, more structured mentorship, and
increased focus on diversity are explicit priorities. These efforts
acknowledge that PostgreSQL‚Äôs cultural values‚Äîtechnical excellence,
transparency, consensus‚Äîcan coexist with more accessible pathways for
new contributors.</p>
<p>Several concrete initiatives are underway:</p>
<ul>
<li><strong>Documentation projects</strong>: Volunteers are improving
internal documentation, making it more accessible to newcomers</li>
<li><strong>Mentorship matching</strong>: Formal programs occasionally
match experienced developers with newcomers</li>
<li><strong>Beginner-friendly patches</strong>: Labeling issues as good
candidates for first-time contributors</li>
<li><strong>Writing workshops</strong>: Teaching contributors how to
write effective technical emails and proposals</li>
<li><strong>Welcoming spaces</strong>: Creating special events at
conferences specifically for newcomers</li>
</ul>
<p>These initiatives recognize that PostgreSQL‚Äôs culture can be
intimidating for newcomers. The emphasis on rigor and correctness, the
expectation of deep technical knowledge, and the formality of
communication can create barriers to participation. By intentionally
working to lower these barriers, the project aims to grow the
contributor base and ensure long-term sustainability.</p>
<h3 data-number="12.10.3" id="geographic-and-demographic-diversity"><span class="header-section-number">12.10.3</span> Geographic and Demographic
Diversity</h3>
<p>PostgreSQL‚Äôs international community is its strength, and the project
recognizes both achievements and ongoing opportunities for
improvement:</p>
<p><strong>Achievements:</strong> - Contributors across all continents,
speaking dozens of languages - Major development hubs in Europe, North
America, and Asia - Conference presence worldwide, with regional
PostgreSQL conferences in many countries - Documentation and error
messages in multiple languages</p>
<p><strong>Ongoing Efforts:</strong> - Recruitment efforts in
underrepresented regions - Intentional translation of resources and
documentation - Support for diverse communication styles and time zones
- Mentorship of developers from underrepresented backgrounds in tech -
Examination of whether the project‚Äôs communication style inadvertently
excludes certain groups</p>
<p>The project recognizes that diverse perspectives improve
decision-making. When designing a database feature, diverse input from
different use cases and contexts results in better overall design.
Cultural diversity also enriches the community and makes participation
more rewarding for developers from different backgrounds.</p>
<h3 data-number="12.10.4" id="technical-evolution"><span class="header-section-number">12.10.4</span> Technical Evolution</h3>
<p>As database technology evolves‚Äîwith demands for distributed systems,
specialized data types, advanced optimization techniques, and
integration with modern frameworks‚ÄîPostgreSQL‚Äôs development culture will
be tested. Several questions shape thinking about PostgreSQL‚Äôs
future:</p>
<p><strong>Can Consensus Scale?</strong></p>
<p>The consensus-based decision model has worked for PostgreSQL‚Äôs entire
history. But will it work for a project that continues growing? At some
point, consensus-driven development might become too slow for
competitive markets. Will PostgreSQL need to evolve toward more
hierarchical decision-making? Or will the project remain committed to
consensus, accepting that some decisions might be slower but more
thoroughly considered?</p>
<p><strong>Innovation versus Stability</strong></p>
<p>PostgreSQL has long prioritized stability and correctness over rapid
feature development. This has proven strategically sound for databases,
which customers expect to be extremely reliable. But will competitors
who move faster eventually overtake PostgreSQL in the marketplace? Or
does PostgreSQL‚Äôs stability provide sufficient competitive
advantage?</p>
<p>The project‚Äôs response so far has been to embrace extensions and
modularity. Experimental features can be developed in extensions, proven
in production, and later integrated into core PostgreSQL if they prove
valuable. This allows innovation while maintaining core stability.</p>
<p><strong>Specialization versus Generality</strong></p>
<p>PostgreSQL has traditionally been a general-purpose database with
strong SQL support. As databases increasingly specialize‚Äîwith some
focusing on analytics, others on timeseries data, others on graph
structures‚ÄîPostgreSQL must decide whether to become more specialized or
remain general-purpose.</p>
<p>The project‚Äôs approach has been to support specialized capabilities
while remaining a general-purpose database. Proper array types, JSON
support, full-text search, and extensions for specialized domains allow
PostgreSQL to serve diverse use cases.</p>
<p><strong>Open Source Sustainability</strong></p>
<p>A long-term challenge for all open-source projects is sustainability.
How can PostgreSQL ensure that decades from now, it has active
developers maintaining and improving the system? The high barrier to
entry and the concentration of knowledge in particular developers
creates risks.</p>
<p>The project is working to address this by improving documentation,
mentorship, and onboarding. But fundamentally, the sustainability
question remains: will future generations have developers as committed
to PostgreSQL as Tom Lane, Bruce Momjian, and others have been?</p>
<hr/>
<h2 data-number="12.11" id="part-x-postgresql-culture-in-practice"><span class="header-section-number">12.11</span> Part X: PostgreSQL Culture in
Practice</h2>
<h3 data-number="12.11.1" id="rituals-and-traditions"><span class="header-section-number">12.11.1</span> Rituals and Traditions</h3>
<p>PostgreSQL has developed several rituals and traditions that
reinforce its values and maintain community bonds:</p>
<p><strong>CommitFest Cycles</strong></p>
<p>The CommitFest cycle has become a ritual for the development
community. Developers know to expect intense activity around CommitFest
submission deadlines and closing deadlines. Veterans of the project have
developed routines around CommitFest cycles, planning feature work for
CommitFest periods and maintenance work during inter-CommitFest times.
The cycle creates rhythm and predictability in development.</p>
<p><strong>Conference Community</strong></p>
<p>PostgreSQL Conferences (held annually in different locations) have
become major community gathering points. These conferences serve
multiple purposes: knowledge sharing, decision-making on significant
topics, face-to-face relationship building, and celebration of the
community. The conferences include both formal presentations and
informal ‚Äúhallway discussions‚Äù where important decisions and technical
debates happen.</p>
<p><strong>Code Ownership</strong></p>
<p>PostgreSQL has an informal system of code ownership where particular
developers have responsibility for particular subsystems. The optimizer
maintainer, the replication maintainer, the storage manager maintainer,
and others form informal ‚Äúexpert councils‚Äù for their domains. While
anyone can propose changes to any system, the subsystem maintainer‚Äôs
input carries significant weight. This creates accountability and
prevents arbitrary changes to critical systems.</p>
<p><strong>Review Standards</strong></p>
<p>PostgreSQL has developed shared understanding about what constitutes
acceptable review. A patch going into a CommitFest will typically
receive multiple reviews from community members before being marked as
‚Äúready to commit.‚Äù The reviews examine not just code correctness but
architectural fit, documentation quality, and potential interactions
with other systems. This culture of thorough review has become
self-reinforcing‚Äîdevelopers expect thorough review and prepare patches
accordingly.</p>
<h3 data-number="12.11.2" id="cultural-values-in-action"><span class="header-section-number">12.11.2</span> Cultural Values in
Action</h3>
<p><strong>Conservative Evolution</strong></p>
<p>PostgreSQL‚Äôs conservative approach manifests in numerous concrete
ways. New features are thoroughly explored before implementation. SQL
syntax changes are rare because they affect tools and applications that
parse SQL. Storage format changes are approached with extreme caution
because they affect data stored in user databases. Query optimizer
changes undergo extensive testing because incorrect optimizations can
produce wrong results.</p>
<p>This conservatism sometimes frustrates users who want rapid feature
development. But it has proven strategically sound‚ÄîPostgreSQL is known
as stable and reliable, which makes it appropriate for critical systems.
Users choosing PostgreSQL expect stability, and the project has built
its reputation on delivering it.</p>
<p>A concrete example illustrates this conservatism: when PostgreSQL
added JSON support, the project initially resisted adding a native JSON
data type. Instead, the project provided JSONB (a binary JSON format)
only after the concept had proven valuable through the json type.
Similarly, full-text search went through years of discussion and
multiple implementations before being integrated into PostgreSQL
proper.</p>
<p><strong>Pragmatic Problem-Solving</strong></p>
<p>Despite its emphasis on correctness, PostgreSQL is pragmatic about
solving real problems. If users encounter a problem frequently,
PostgreSQL will find a solution even if it requires compromise. The
project will implement features in slightly non-standard ways if that
solves real user problems. Features like RETURNING clause (non-standard
but extremely useful) exist because they address genuine user needs.</p>
<p>The RETURNING clause is an excellent example of pragmatic design.
It‚Äôs not part of the SQL standard, yet it solves a genuine problem: in
multi-row modifications, applications need to know what values were
assigned or returned. RETURNING makes this possible without requiring a
separate query. The feature has proven so valuable that other databases
have adopted similar features.</p>
<p><strong>Respect for Legacy</strong></p>
<p>PostgreSQL maintains extraordinary backward compatibility because the
project respects deployed databases. Changing behavior that existing
systems depend on is treated as breaking a contract with users. While
rare, when PostgreSQL must change behavior, it deprecates first, warns
for several versions, and provides migration paths. This respect for
legacy systems reflects the project‚Äôs user-focused orientation.</p>
<p>PostgreSQL‚Äôs version numbering reflects this commitment: version 11
to version 12 was a major version change, yet applications written for
PostgreSQL 11 typically work on PostgreSQL 12 without modification.
Similarly, database schemas created decades ago still work with current
PostgreSQL versions. Users have learned that upgrading PostgreSQL is
relatively safe‚Äîit won‚Äôt break their applications.</p>
<p>This backward compatibility commitment affects development decisions
significantly. A clever optimization that would require changing a
stored data format cannot be implemented if it breaks compatibility. A
more elegant query language syntax cannot be adopted if it conflicts
with existing query syntax. PostgreSQL will sometimes accept
less-than-optimal designs to maintain compatibility with deployed
systems.</p>
<h3 data-number="12.11.3" id="postgresqls-influence-on-database-community"><span class="header-section-number">12.11.3</span> PostgreSQL‚Äôs Influence on
Database Community</h3>
<p>While PostgreSQL‚Äôs internal culture is notable, the project has also
influenced broader database development culture:</p>
<p><strong>Influence on Other Open-Source Databases</strong></p>
<p>PostgreSQL‚Äôs commitment to technical excellence and transparent
development has influenced other open-source databases. Projects like
MySQL/MariaDB, MongoDB, and others have adopted some PostgreSQL
practices. The CommitFest model has been examined by other projects.
PostgreSQL‚Äôs emphasis on correctness over speed has resonated with users
of databases that need reliability.</p>
<p><strong>Community-Driven Development Model</strong></p>
<p>PostgreSQL has demonstrated that community-driven development of
databases is viable and can produce excellent results. While some
databases are sponsored by single companies (Google‚Äôs Spanner,
Facebook‚Äôs MyRocks), PostgreSQL has shown that a database can be
world-class when developed by a diverse global community.</p>
<p><strong>Standards Compliance Focus</strong></p>
<p>PostgreSQL‚Äôs emphasis on SQL standards compliance has influenced the
database industry. The project‚Äôs position that databases should follow
standards rather than impose proprietary lock-in has resonated with
users and other projects. This commitment to standards has made
PostgreSQL easier to migrate to or from compared to databases that use
extensive proprietary features.</p>
<h2 data-number="12.12" id="conclusion-6"><span class="header-section-number">12.12</span> Conclusion</h2>
<p>PostgreSQL‚Äôs community and development culture represents a
distinctive and enduring approach to open-source software development.
Rather than concentrating authority in a single leader or formal
hierarchy, PostgreSQL operates through rough consensus, transparent
discussion, and deference to technical expertise. This approach has
produced a database known for reliability, quality, and careful
evolution.</p>
<p>The culture emerged organically from PostgreSQL‚Äôs history and its
community‚Äôs values over three decades. It has proven resilient despite
the project‚Äôs growth from dozens to thousands of contributors across
multiple companies and organizations. It has successfully integrated
corporate sponsorship while maintaining independence and open-source
principles. And it has produced a system trusted for decades-long
deployments in mission-critical contexts worldwide.</p>
<p><strong>What Makes PostgreSQL‚Äôs Culture Distinctive</strong></p>
<p>Several factors distinguish PostgreSQL‚Äôs culture from other
open-source projects:</p>
<ol type="1">
<li><p><strong>Emphasis on Technical Excellence</strong>: Above all
else, PostgreSQL prioritizes correctness and technical quality. This is
not unique‚Äîmany projects value quality‚Äîbut PostgreSQL‚Äôs willingness to
sacrifice speed and features for quality is remarkable.</p></li>
<li><p><strong>Consensus-Based Decision-Making</strong>: Without a BDFL
or formal governance structure, PostgreSQL relies on rough consensus and
technical discussion. This requires maturity and prevents
authoritarianism.</p></li>
<li><p><strong>Transparent Processes</strong>: Development happens
publicly. Discussions are archived. Decisions are explained. This
transparency builds trust and creates accountability.</p></li>
<li><p><strong>Long-Term Thinking</strong>: PostgreSQL thinks in terms
of decades. Decisions are made with awareness of long-term implications.
This contrasts with cultures optimizing for short-term competitive
advantage.</p></li>
<li><p><strong>Global Community</strong>: PostgreSQL operates as a
genuinely global project, with contributors worldwide and conscious
effort to accommodate different regions and time zones.</p></li>
</ol>
<p>At its core, PostgreSQL‚Äôs culture reflects a community committed to
technical excellence above all else. Decisions are made publicly and
comprehensively. Contributions are judged on technical merit. And the
long-term stability of the system is valued more highly than short-term
features or competitive pressure.</p>
<p><strong>For Contributors and Users</strong></p>
<p>This culture is not for everyone. The high barriers to entry, the
sometimes slow pace of decision-making, and the emphasis on thorough
discussion can feel frustrating to those accustomed to other development
environments. For potential contributors, PostgreSQL requires
substantial commitment to understanding the system deeply before
contributing. For users, PostgreSQL sometimes feels slow to adopt new
features compared to competitors.</p>
<p>But for those committed to understanding database systems deeply and
contributing to a project that prioritizes correctness and stability,
PostgreSQL‚Äôs culture offers a distinctive and compelling model for
collaborative software development. And for users who value reliability
above all else, PostgreSQL‚Äôs careful, community-driven development
approach has produced a database system worthy of trust.</p>
<p>The project‚Äôs challenge going forward is to maintain these cultural
values while remaining relevant in an increasingly competitive database
landscape. But if PostgreSQL‚Äôs three-decade history is any guide, the
community‚Äôs commitment to technical excellence and thoughtful
decision-making will continue to serve it well.</p>
<hr/>
<h2 data-number="12.13" id="part-xi-lessons-from-postgresqls-culture"><span class="header-section-number">12.13</span> Part XI: Lessons from
PostgreSQL‚Äôs Culture</h2>
<p>PostgreSQL‚Äôs development culture offers lessons for other open-source
projects and organizations seeking to develop high-quality software:</p>
<p><strong>The Value of Technical Rigor</strong></p>
<p>PostgreSQL demonstrates that investing in technical rigor and
correctness produces systems that endure decades. Users trust PostgreSQL
for mission-critical applications precisely because they know the
project prioritizes correctness. In a world of rapid release cycles and
‚Äúmove fast and break things,‚Äù PostgreSQL‚Äôs approach seems
counterintuitive. Yet it has proven strategically superior for databases
where correctness is paramount.</p>
<p><strong>Consensus Works at Scale</strong></p>
<p>PostgreSQL has demonstrated that consensus-based decision-making can
work even with hundreds of contributors. While consensus requires more
discussion and sometimes feels slower, it produces decisions that the
community genuinely supports. This contrasts with hierarchical systems
where decisions might be faster but less supported.</p>
<p><strong>Transparency Builds Trust</strong></p>
<p>By conducting development publicly and explaining decisions openly,
PostgreSQL has built tremendous trust with users and contributors. Users
understand why features are or aren‚Äôt included. Contributors understand
why their patches are accepted or rejected. This transparency creates
accountability and prevents the resentment that sometimes occurs in less
open development models.</p>
<p><strong>Community Ownership Sustains Projects</strong></p>
<p>PostgreSQL has survived leadership transitions, corporate changes,
and competitive pressures because the community owns the project. No
company can force its strategic direction; no individual can impose
their vision. While this sometimes makes PostgreSQL less nimble than
company-backed projects, it ensures long-term sustainability.</p>
<p><strong>Investment in People Pays Dividends</strong></p>
<p>The effort that PostgreSQL invests in mentoring new contributors,
improving documentation, and welcoming diverse perspectives has paid
dividends. The project has built a deeper bench of contributors than it
would have if it maintained high barriers and discouraged newcomers. As
long-time developers retire, newer developers are ready to take on
responsibilities.</p>
<p><strong>Standards Alignment Adds Value</strong></p>
<p>PostgreSQL‚Äôs commitment to SQL standards has proven valuable.
Applications can more easily migrate between PostgreSQL and other
systems. Features are more predictable because they follow standard
semantics. While standards can sometimes constrain innovation, they have
proven net beneficial for PostgreSQL.</p>
<hr/>
<h2 data-number="12.14" id="further-reading-and-resources"><span class="header-section-number">12.14</span> Further Reading and
Resources</h2>
<p><strong>Primary Sources:</strong> - PostgreSQL Mailing List Archives:
https://www.postgresql.org/list/ - The complete historical record of
PostgreSQL development discussions - PostgreSQL Developer Documentation:
https://www.postgresql.org/docs/current/internals.html - Comprehensive
documentation of PostgreSQL internals for developers - PostgreSQL
Hackers Wiki: https://wiki.postgresql.org/ - Community-created
documentation and resources for developers - CommitFest Management
System: https://commitfest.postgresql.org/ - The system that manages
PostgreSQL‚Äôs development cycle</p>
<p><strong>Governance and Community:</strong> - PostgreSQL Code of
Conduct: https://www.postgresql.org/about/policies/conduct/ - Explicit
expectations for community participation - PostgreSQL Governance
Documentation: https://www.postgresql.org/community/governance/ -
Official governance structures and decision-making processes -
PostgreSQL Community Page: https://www.postgresql.org/community/ -
Information about how to participate in the PostgreSQL community -
PostgreSQL Security Information:
https://www.postgresql.org/about/security/ - How security issues are
handled by the project</p>
<p><strong>Related Topics:</strong> - Chapter 2: PostgreSQL‚Äôs History
and Evolution - Chapter 3: PostgreSQL Architecture and System Design -
Chapter 8: PostgreSQL‚Äôs Evolution and Release Cycles - Chapter 10:
Building and Extending PostgreSQL - Chapter 11: PostgreSQL in Production
and Operations</p>
<p><strong>Recommended Reading:</strong> For those interested in
open-source development culture and governance, several resources
provide context for understanding PostgreSQL‚Äôs approach:</p>
<ul>
<li>‚ÄúThe Cathedral and the Bazaar‚Äù by Eric S. Raymond - Classic essay on
open-source development models</li>
<li>‚ÄúProducing Open Source Software‚Äù by Karl Fogel - Comprehensive guide
to open-source development practices</li>
<li>Various PostgreSQL conference talks available on YouTube and
PostgreSQL documentation websites</li>
</ul>
<h1 data-number="13" id="postgresql-sql-reference-dialect-and-advanced-features"><span class="header-section-number">13</span> PostgreSQL SQL Reference:
Dialect and Advanced Features</h1>
<p>PostgreSQL extends the SQL standard with powerful features and a rich
type system that make it uniquely capable for complex data applications.
This chapter provides a reference guide to PostgreSQL‚Äôs SQL dialect,
highlighting features that distinguish it from other database
systems.</p>
<h2 data-number="13.1" id="postgresqls-rich-type-system"><span class="header-section-number">13.1</span> 1. PostgreSQL‚Äôs Rich Type
System</h2>
<h3 data-number="13.1.1" id="built-in-data-types"><span class="header-section-number">13.1.1</span> 1.1 Built-in Data Types</h3>
<p>PostgreSQL includes an extensive collection of data types beyond the
SQL standard:</p>
<h4 data-number="13.1.1.1" id="numeric-types"><span class="header-section-number">13.1.1.1</span> Numeric Types</h4>
<ul>
<li><strong>Integer Types</strong>: <code>smallint</code> (2 bytes),
<code>integer</code> (4 bytes), <code>bigint</code> (8 bytes)</li>
<li><strong>Decimal Types</strong>:
<code>numeric(precision, scale)</code> for exact arithmetic,
<code>decimal</code> (alias for numeric)</li>
<li><strong>Floating Point</strong>: <code>real</code> (4 bytes, ~6
decimal digits), <code>double precision</code> (8 bytes, ~15 decimal
digits)</li>
<li><strong>Serial Types</strong>: <code>smallserial</code>,
<code>serial</code>, <code>bigserial</code> for auto-incrementing
integers</li>
</ul>
<h4 data-number="13.1.1.2" id="text-types"><span class="header-section-number">13.1.1.2</span> Text Types</h4>
<ul>
<li><strong>Character</strong>: <code>char(n)</code> (fixed-length),
<code>varchar(n)</code> (variable-length), <code>text</code>
(unlimited)</li>
<li><strong>Text Search</strong>: Full-text search support with
<code>tsvector</code> and <code>tsquery</code> types</li>
</ul>
<h4 data-number="13.1.1.3" id="temporal-types"><span class="header-section-number">13.1.1.3</span> Temporal Types</h4>
<ul>
<li><strong>Date/Time</strong>: <code>date</code>, <code>time</code>,
<code>timestamp</code>, <code>timestamptz</code> (timezone-aware)</li>
<li><strong>Intervals</strong>: <code>interval</code> for durations,
supporting arithmetic with timestamps</li>
<li><strong>Time Zones</strong>: Native timezone handling with
<code>timestamptz</code> type</li>
</ul>
<h4 data-number="13.1.1.4" id="binary-and-encoding"><span class="header-section-number">13.1.1.4</span> Binary and Encoding</h4>
<ul>
<li><strong>Bytea</strong>: Binary data storage with hex or escape
encoding</li>
<li><strong>UUID</strong>: Universally unique identifiers (standard
128-bit)</li>
<li><strong>Bit Strings</strong>: <code>bit(n)</code> and
<code>bit varying(n)</code> for bit-level operations</li>
</ul>
<h4 data-number="13.1.1.5" id="geometric-types"><span class="header-section-number">13.1.1.5</span> Geometric Types</h4>
<p>PostgreSQL includes specialized types for geometric data: -
<strong>Points</strong>: <code>point</code> for 2D points (x, y) -
<strong>Line Segments</strong>: <code>lseg</code> for line segments -
<strong>Rectangles</strong>: <code>box</code> for axis-aligned
rectangles - <strong>Circles</strong>: <code>circle</code> for circles
with center and radius - <strong>Polygons</strong>: <code>polygon</code>
for general polygons - <strong>Paths</strong>: <code>path</code> for
open and closed paths</p>
<h4 data-number="13.1.1.6" id="network-types"><span class="header-section-number">13.1.1.6</span> Network Types</h4>
<ul>
<li><strong>inet</strong>: IPv4 or IPv6 network address</li>
<li><strong>cidr</strong>: IPv4 or IPv6 network specification (CIDR
notation)</li>
<li><strong>macaddr</strong>: MAC (hardware) addresses</li>
</ul>
<h4 data-number="13.1.1.7" id="range-types"><span class="header-section-number">13.1.1.7</span> Range Types</h4>
<div class="sourceCode" id="cb718"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb718-1"><a aria-hidden="true" href="#cb718-1" tabindex="-1"></a><span class="co">-- Built-in range types</span></span>
<span id="cb718-2"><a aria-hidden="true" href="#cb718-2" tabindex="-1"></a>int4range, int8range           <span class="co">-- Integer ranges</span></span>
<span id="cb718-3"><a aria-hidden="true" href="#cb718-3" tabindex="-1"></a>numrange                       <span class="co">-- Numeric ranges</span></span>
<span id="cb718-4"><a aria-hidden="true" href="#cb718-4" tabindex="-1"></a>tsrange, tstzrange             <span class="co">-- Timestamp ranges</span></span>
<span id="cb718-5"><a aria-hidden="true" href="#cb718-5" tabindex="-1"></a>daterange                      <span class="co">-- Date ranges</span></span>
<span id="cb718-6"><a aria-hidden="true" href="#cb718-6" tabindex="-1"></a></span>
<span id="cb718-7"><a aria-hidden="true" href="#cb718-7" tabindex="-1"></a><span class="co">-- Example usage</span></span>
<span id="cb718-8"><a aria-hidden="true" href="#cb718-8" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> availability (</span>
<span id="cb718-9"><a aria-hidden="true" href="#cb718-9" tabindex="-1"></a>    slot_id SERIAL <span class="kw">PRIMARY</span> <span class="kw">KEY</span>,</span>
<span id="cb718-10"><a aria-hidden="true" href="#cb718-10" tabindex="-1"></a>    available_hours tsrange <span class="kw">NOT</span> <span class="kw">NULL</span></span>
<span id="cb718-11"><a aria-hidden="true" href="#cb718-11" tabindex="-1"></a>);</span>
<span id="cb718-12"><a aria-hidden="true" href="#cb718-12" tabindex="-1"></a></span>
<span id="cb718-13"><a aria-hidden="true" href="#cb718-13" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> availability <span class="kw">VALUES</span></span>
<span id="cb718-14"><a aria-hidden="true" href="#cb718-14" tabindex="-1"></a>    (<span class="dv">1</span>, <span class="st">'[2024-01-01 09:00, 2024-01-01 17:00)'</span>),</span>
<span id="cb718-15"><a aria-hidden="true" href="#cb718-15" tabindex="-1"></a>    (<span class="dv">2</span>, <span class="st">'[2024-01-02 10:00, 2024-01-02 18:00)'</span>);</span>
<span id="cb718-16"><a aria-hidden="true" href="#cb718-16" tabindex="-1"></a></span>
<span id="cb718-17"><a aria-hidden="true" href="#cb718-17" tabindex="-1"></a><span class="co">-- Query overlapping ranges</span></span>
<span id="cb718-18"><a aria-hidden="true" href="#cb718-18" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> availability</span>
<span id="cb718-19"><a aria-hidden="true" href="#cb718-19" tabindex="-1"></a><span class="kw">WHERE</span> available_hours @<span class="op">&gt;</span> <span class="st">'2024-01-01 12:00'</span>:<span class="ch">:timestamp</span>;</span></code></pre></div>
<h4 data-number="13.1.1.8" id="json-and-jsonb"><span class="header-section-number">13.1.1.8</span> JSON and JSONB</h4>
<ul>
<li><strong>json</strong>: Text-based JSON storage (slower parsing,
preserves order, allows duplicates)</li>
<li><strong>jsonb</strong>: Binary JSON storage (faster processing,
normalized, index support)</li>
</ul>
<h3 data-number="13.1.2" id="composite-types"><span class="header-section-number">13.1.2</span> 1.2 Composite Types</h3>
<p>Create custom composite types for structured data:</p>
<div class="sourceCode" id="cb719"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb719-1"><a aria-hidden="true" href="#cb719-1" tabindex="-1"></a><span class="co">-- Define a composite type</span></span>
<span id="cb719-2"><a aria-hidden="true" href="#cb719-2" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TYPE</span> address <span class="kw">AS</span> (</span>
<span id="cb719-3"><a aria-hidden="true" href="#cb719-3" tabindex="-1"></a>    street <span class="dt">VARCHAR</span>(<span class="dv">100</span>),</span>
<span id="cb719-4"><a aria-hidden="true" href="#cb719-4" tabindex="-1"></a>    city <span class="dt">VARCHAR</span>(<span class="dv">50</span>),</span>
<span id="cb719-5"><a aria-hidden="true" href="#cb719-5" tabindex="-1"></a>    state <span class="dt">CHAR</span>(<span class="dv">2</span>),</span>
<span id="cb719-6"><a aria-hidden="true" href="#cb719-6" tabindex="-1"></a>    postal_code <span class="dt">VARCHAR</span>(<span class="dv">10</span>)</span>
<span id="cb719-7"><a aria-hidden="true" href="#cb719-7" tabindex="-1"></a>);</span>
<span id="cb719-8"><a aria-hidden="true" href="#cb719-8" tabindex="-1"></a></span>
<span id="cb719-9"><a aria-hidden="true" href="#cb719-9" tabindex="-1"></a><span class="co">-- Use in a table</span></span>
<span id="cb719-10"><a aria-hidden="true" href="#cb719-10" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> companies (</span>
<span id="cb719-11"><a aria-hidden="true" href="#cb719-11" tabindex="-1"></a>    <span class="kw">id</span> SERIAL <span class="kw">PRIMARY</span> <span class="kw">KEY</span>,</span>
<span id="cb719-12"><a aria-hidden="true" href="#cb719-12" tabindex="-1"></a>    name <span class="dt">VARCHAR</span>(<span class="dv">100</span>),</span>
<span id="cb719-13"><a aria-hidden="true" href="#cb719-13" tabindex="-1"></a>    headquarters address</span>
<span id="cb719-14"><a aria-hidden="true" href="#cb719-14" tabindex="-1"></a>);</span>
<span id="cb719-15"><a aria-hidden="true" href="#cb719-15" tabindex="-1"></a></span>
<span id="cb719-16"><a aria-hidden="true" href="#cb719-16" tabindex="-1"></a><span class="co">-- Insert values</span></span>
<span id="cb719-17"><a aria-hidden="true" href="#cb719-17" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> companies <span class="kw">VALUES</span></span>
<span id="cb719-18"><a aria-hidden="true" href="#cb719-18" tabindex="-1"></a>    (<span class="dv">1</span>, <span class="st">'Acme Corp'</span>, (<span class="st">'123 Main St'</span>, <span class="st">'New York'</span>, <span class="st">'NY'</span>, <span class="st">'10001'</span>));</span>
<span id="cb719-19"><a aria-hidden="true" href="#cb719-19" tabindex="-1"></a></span>
<span id="cb719-20"><a aria-hidden="true" href="#cb719-20" tabindex="-1"></a><span class="co">-- Access individual fields</span></span>
<span id="cb719-21"><a aria-hidden="true" href="#cb719-21" tabindex="-1"></a><span class="kw">SELECT</span> name, (headquarters).city <span class="kw">FROM</span> companies;</span></code></pre></div>
<h3 data-number="13.1.3" id="custom-types-and-domains"><span class="header-section-number">13.1.3</span> 1.3 Custom Types and
Domains</h3>
<p>Define domain types with constraints:</p>
<div class="sourceCode" id="cb720"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb720-1"><a aria-hidden="true" href="#cb720-1" tabindex="-1"></a><span class="co">-- Create a domain</span></span>
<span id="cb720-2"><a aria-hidden="true" href="#cb720-2" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">DOMAIN</span> email <span class="kw">AS</span> <span class="dt">varchar</span>(<span class="dv">255</span>) <span class="kw">CHECK</span> (</span>
<span id="cb720-3"><a aria-hidden="true" href="#cb720-3" tabindex="-1"></a>    <span class="fu">value</span> ~ <span class="st">'^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}$'</span></span>
<span id="cb720-4"><a aria-hidden="true" href="#cb720-4" tabindex="-1"></a>);</span>
<span id="cb720-5"><a aria-hidden="true" href="#cb720-5" tabindex="-1"></a></span>
<span id="cb720-6"><a aria-hidden="true" href="#cb720-6" tabindex="-1"></a><span class="co">-- Use the domain</span></span>
<span id="cb720-7"><a aria-hidden="true" href="#cb720-7" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> users (</span>
<span id="cb720-8"><a aria-hidden="true" href="#cb720-8" tabindex="-1"></a>    <span class="kw">id</span> SERIAL <span class="kw">PRIMARY</span> <span class="kw">KEY</span>,</span>
<span id="cb720-9"><a aria-hidden="true" href="#cb720-9" tabindex="-1"></a>    email_address email <span class="kw">NOT</span> <span class="kw">NULL</span> <span class="kw">UNIQUE</span></span>
<span id="cb720-10"><a aria-hidden="true" href="#cb720-10" tabindex="-1"></a>);</span>
<span id="cb720-11"><a aria-hidden="true" href="#cb720-11" tabindex="-1"></a></span>
<span id="cb720-12"><a aria-hidden="true" href="#cb720-12" tabindex="-1"></a><span class="co">-- Type constraints are automatically checked</span></span>
<span id="cb720-13"><a aria-hidden="true" href="#cb720-13" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> users <span class="kw">VALUES</span> (<span class="dv">1</span>, <span class="st">'invalid-email'</span>); <span class="co">-- ERROR: violates check constraint</span></span></code></pre></div>
<hr/>
<h2 data-number="13.2" id="advanced-sql-features"><span class="header-section-number">13.2</span> 2. Advanced SQL Features</h2>
<h3 data-number="13.2.1" id="window-functions"><span class="header-section-number">13.2.1</span> 2.1 Window Functions</h3>
<p>Window functions perform calculations across a set of rows related to
the current row, without collapsing results into a single row.</p>
<div class="sourceCode" id="cb721"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb721-1"><a aria-hidden="true" href="#cb721-1" tabindex="-1"></a><span class="co">-- Basic syntax</span></span>
<span id="cb721-2"><a aria-hidden="true" href="#cb721-2" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb721-3"><a aria-hidden="true" href="#cb721-3" tabindex="-1"></a>    employee_id,</span>
<span id="cb721-4"><a aria-hidden="true" href="#cb721-4" tabindex="-1"></a>    salary,</span>
<span id="cb721-5"><a aria-hidden="true" href="#cb721-5" tabindex="-1"></a>    department_id,</span>
<span id="cb721-6"><a aria-hidden="true" href="#cb721-6" tabindex="-1"></a>    <span class="fu">AVG</span>(salary) <span class="kw">OVER</span> (<span class="kw">PARTITION</span> <span class="kw">BY</span> department_id) <span class="kw">as</span> dept_avg,</span>
<span id="cb721-7"><a aria-hidden="true" href="#cb721-7" tabindex="-1"></a>    <span class="fu">ROW_NUMBER</span>() <span class="kw">OVER</span> (<span class="kw">PARTITION</span> <span class="kw">BY</span> department_id <span class="kw">ORDER</span> <span class="kw">BY</span> salary <span class="kw">DESC</span>) <span class="kw">as</span> <span class="fu">rank</span></span>
<span id="cb721-8"><a aria-hidden="true" href="#cb721-8" tabindex="-1"></a><span class="kw">FROM</span> employees;</span></code></pre></div>
<h4 data-number="13.2.1.1" id="window-function-categories"><span class="header-section-number">13.2.1.1</span> Window Function
Categories</h4>
<p><strong>Aggregate Functions as Window Functions:</strong></p>
<div class="sourceCode" id="cb722"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb722-1"><a aria-hidden="true" href="#cb722-1" tabindex="-1"></a><span class="co">-- Running totals</span></span>
<span id="cb722-2"><a aria-hidden="true" href="#cb722-2" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb722-3"><a aria-hidden="true" href="#cb722-3" tabindex="-1"></a>    order_date,</span>
<span id="cb722-4"><a aria-hidden="true" href="#cb722-4" tabindex="-1"></a>    amount,</span>
<span id="cb722-5"><a aria-hidden="true" href="#cb722-5" tabindex="-1"></a>    <span class="fu">SUM</span>(amount) <span class="kw">OVER</span> (<span class="kw">ORDER</span> <span class="kw">BY</span> order_date) <span class="kw">as</span> running_total</span>
<span id="cb722-6"><a aria-hidden="true" href="#cb722-6" tabindex="-1"></a><span class="kw">FROM</span> orders</span>
<span id="cb722-7"><a aria-hidden="true" href="#cb722-7" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> order_date;</span>
<span id="cb722-8"><a aria-hidden="true" href="#cb722-8" tabindex="-1"></a></span>
<span id="cb722-9"><a aria-hidden="true" href="#cb722-9" tabindex="-1"></a><span class="co">-- Partition-level aggregates</span></span>
<span id="cb722-10"><a aria-hidden="true" href="#cb722-10" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb722-11"><a aria-hidden="true" href="#cb722-11" tabindex="-1"></a>    customer_id,</span>
<span id="cb722-12"><a aria-hidden="true" href="#cb722-12" tabindex="-1"></a>    amount,</span>
<span id="cb722-13"><a aria-hidden="true" href="#cb722-13" tabindex="-1"></a>    <span class="fu">AVG</span>(amount) <span class="kw">OVER</span> (<span class="kw">PARTITION</span> <span class="kw">BY</span> customer_id) <span class="kw">as</span> customer_avg</span>
<span id="cb722-14"><a aria-hidden="true" href="#cb722-14" tabindex="-1"></a><span class="kw">FROM</span> orders;</span></code></pre></div>
<p><strong>Ranking Functions:</strong></p>
<div class="sourceCode" id="cb723"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb723-1"><a aria-hidden="true" href="#cb723-1" tabindex="-1"></a><span class="co">-- ROW_NUMBER(): Unique rank even for ties</span></span>
<span id="cb723-2"><a aria-hidden="true" href="#cb723-2" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb723-3"><a aria-hidden="true" href="#cb723-3" tabindex="-1"></a>    product_id,</span>
<span id="cb723-4"><a aria-hidden="true" href="#cb723-4" tabindex="-1"></a>    sales,</span>
<span id="cb723-5"><a aria-hidden="true" href="#cb723-5" tabindex="-1"></a>    <span class="fu">ROW_NUMBER</span>() <span class="kw">OVER</span> (<span class="kw">ORDER</span> <span class="kw">BY</span> sales <span class="kw">DESC</span>) <span class="kw">as</span> row_num</span>
<span id="cb723-6"><a aria-hidden="true" href="#cb723-6" tabindex="-1"></a><span class="kw">FROM</span> product_performance;</span>
<span id="cb723-7"><a aria-hidden="true" href="#cb723-7" tabindex="-1"></a></span>
<span id="cb723-8"><a aria-hidden="true" href="#cb723-8" tabindex="-1"></a><span class="co">-- RANK(): Ties get same rank, gaps in numbering</span></span>
<span id="cb723-9"><a aria-hidden="true" href="#cb723-9" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb723-10"><a aria-hidden="true" href="#cb723-10" tabindex="-1"></a>    product_id,</span>
<span id="cb723-11"><a aria-hidden="true" href="#cb723-11" tabindex="-1"></a>    sales,</span>
<span id="cb723-12"><a aria-hidden="true" href="#cb723-12" tabindex="-1"></a>    <span class="fu">RANK</span>() <span class="kw">OVER</span> (<span class="kw">ORDER</span> <span class="kw">BY</span> sales <span class="kw">DESC</span>) <span class="kw">as</span> <span class="fu">rank</span></span>
<span id="cb723-13"><a aria-hidden="true" href="#cb723-13" tabindex="-1"></a><span class="kw">FROM</span> product_performance;</span>
<span id="cb723-14"><a aria-hidden="true" href="#cb723-14" tabindex="-1"></a></span>
<span id="cb723-15"><a aria-hidden="true" href="#cb723-15" tabindex="-1"></a><span class="co">-- DENSE_RANK(): Ties get same rank, no gaps</span></span>
<span id="cb723-16"><a aria-hidden="true" href="#cb723-16" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb723-17"><a aria-hidden="true" href="#cb723-17" tabindex="-1"></a>    product_id,</span>
<span id="cb723-18"><a aria-hidden="true" href="#cb723-18" tabindex="-1"></a>    sales,</span>
<span id="cb723-19"><a aria-hidden="true" href="#cb723-19" tabindex="-1"></a>    <span class="fu">DENSE_RANK</span>() <span class="kw">OVER</span> (<span class="kw">ORDER</span> <span class="kw">BY</span> sales <span class="kw">DESC</span>) <span class="kw">as</span> <span class="fu">dense_rank</span></span>
<span id="cb723-20"><a aria-hidden="true" href="#cb723-20" tabindex="-1"></a><span class="kw">FROM</span> product_performance;</span>
<span id="cb723-21"><a aria-hidden="true" href="#cb723-21" tabindex="-1"></a></span>
<span id="cb723-22"><a aria-hidden="true" href="#cb723-22" tabindex="-1"></a><span class="co">-- PERCENT_RANK(): Percentile of partition (0 to 1)</span></span>
<span id="cb723-23"><a aria-hidden="true" href="#cb723-23" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb723-24"><a aria-hidden="true" href="#cb723-24" tabindex="-1"></a>    product_id,</span>
<span id="cb723-25"><a aria-hidden="true" href="#cb723-25" tabindex="-1"></a>    sales,</span>
<span id="cb723-26"><a aria-hidden="true" href="#cb723-26" tabindex="-1"></a>    <span class="fu">PERCENT_RANK</span>() <span class="kw">OVER</span> (<span class="kw">ORDER</span> <span class="kw">BY</span> sales <span class="kw">DESC</span>) <span class="kw">as</span> pct_rank</span>
<span id="cb723-27"><a aria-hidden="true" href="#cb723-27" tabindex="-1"></a><span class="kw">FROM</span> product_performance;</span></code></pre></div>
<p><strong>Offset Functions:</strong></p>
<div class="sourceCode" id="cb724"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb724-1"><a aria-hidden="true" href="#cb724-1" tabindex="-1"></a><span class="co">-- LAG/LEAD: Access previous/next row values</span></span>
<span id="cb724-2"><a aria-hidden="true" href="#cb724-2" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb724-3"><a aria-hidden="true" href="#cb724-3" tabindex="-1"></a>    order_date,</span>
<span id="cb724-4"><a aria-hidden="true" href="#cb724-4" tabindex="-1"></a>    amount,</span>
<span id="cb724-5"><a aria-hidden="true" href="#cb724-5" tabindex="-1"></a>    <span class="fu">LAG</span>(amount) <span class="kw">OVER</span> (<span class="kw">ORDER</span> <span class="kw">BY</span> order_date) <span class="kw">as</span> previous_amount,</span>
<span id="cb724-6"><a aria-hidden="true" href="#cb724-6" tabindex="-1"></a>    <span class="fu">LEAD</span>(amount) <span class="kw">OVER</span> (<span class="kw">ORDER</span> <span class="kw">BY</span> order_date) <span class="kw">as</span> next_amount</span>
<span id="cb724-7"><a aria-hidden="true" href="#cb724-7" tabindex="-1"></a><span class="kw">FROM</span> orders;</span>
<span id="cb724-8"><a aria-hidden="true" href="#cb724-8" tabindex="-1"></a></span>
<span id="cb724-9"><a aria-hidden="true" href="#cb724-9" tabindex="-1"></a><span class="co">-- First/Last value in window</span></span>
<span id="cb724-10"><a aria-hidden="true" href="#cb724-10" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb724-11"><a aria-hidden="true" href="#cb724-11" tabindex="-1"></a>    order_date,</span>
<span id="cb724-12"><a aria-hidden="true" href="#cb724-12" tabindex="-1"></a>    amount,</span>
<span id="cb724-13"><a aria-hidden="true" href="#cb724-13" tabindex="-1"></a>    <span class="fu">FIRST_VALUE</span>(amount) <span class="kw">OVER</span> (<span class="kw">ORDER</span> <span class="kw">BY</span> order_date) <span class="kw">as</span> first_amount,</span>
<span id="cb724-14"><a aria-hidden="true" href="#cb724-14" tabindex="-1"></a>    <span class="fu">LAST_VALUE</span>(amount) <span class="kw">OVER</span> (<span class="kw">ORDER</span> <span class="kw">BY</span> order_date</span>
<span id="cb724-15"><a aria-hidden="true" href="#cb724-15" tabindex="-1"></a>        <span class="kw">ROWS</span> <span class="kw">BETWEEN</span> <span class="kw">UNBOUNDED</span> <span class="kw">PRECEDING</span> <span class="kw">AND</span> <span class="kw">UNBOUNDED</span> <span class="kw">FOLLOWING</span>) <span class="kw">as</span> last_amount</span>
<span id="cb724-16"><a aria-hidden="true" href="#cb724-16" tabindex="-1"></a><span class="kw">FROM</span> orders;</span>
<span id="cb724-17"><a aria-hidden="true" href="#cb724-17" tabindex="-1"></a></span>
<span id="cb724-18"><a aria-hidden="true" href="#cb724-18" tabindex="-1"></a><span class="co">-- NTH_VALUE: Get value at specific position</span></span>
<span id="cb724-19"><a aria-hidden="true" href="#cb724-19" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb724-20"><a aria-hidden="true" href="#cb724-20" tabindex="-1"></a>    order_date,</span>
<span id="cb724-21"><a aria-hidden="true" href="#cb724-21" tabindex="-1"></a>    amount,</span>
<span id="cb724-22"><a aria-hidden="true" href="#cb724-22" tabindex="-1"></a>    NTH_VALUE(amount, <span class="dv">3</span>) <span class="kw">OVER</span> (<span class="kw">ORDER</span> <span class="kw">BY</span> order_date) <span class="kw">as</span> third_value</span>
<span id="cb724-23"><a aria-hidden="true" href="#cb724-23" tabindex="-1"></a><span class="kw">FROM</span> orders;</span></code></pre></div>
<p><strong>Frame Specifications:</strong></p>
<div class="sourceCode" id="cb725"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb725-1"><a aria-hidden="true" href="#cb725-1" tabindex="-1"></a><span class="co">-- Control which rows participate in the window</span></span>
<span id="cb725-2"><a aria-hidden="true" href="#cb725-2" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb725-3"><a aria-hidden="true" href="#cb725-3" tabindex="-1"></a>    order_date,</span>
<span id="cb725-4"><a aria-hidden="true" href="#cb725-4" tabindex="-1"></a>    amount,</span>
<span id="cb725-5"><a aria-hidden="true" href="#cb725-5" tabindex="-1"></a>    <span class="co">-- Moving average over 3 rows</span></span>
<span id="cb725-6"><a aria-hidden="true" href="#cb725-6" tabindex="-1"></a>    <span class="fu">AVG</span>(amount) <span class="kw">OVER</span> (<span class="kw">ORDER</span> <span class="kw">BY</span> order_date</span>
<span id="cb725-7"><a aria-hidden="true" href="#cb725-7" tabindex="-1"></a>        <span class="kw">ROWS</span> <span class="kw">BETWEEN</span> <span class="dv">1</span> <span class="kw">PRECEDING</span> <span class="kw">AND</span> <span class="dv">1</span> <span class="kw">FOLLOWING</span>) <span class="kw">as</span> moving_avg,</span>
<span id="cb725-8"><a aria-hidden="true" href="#cb725-8" tabindex="-1"></a>    <span class="co">-- Cumulative sum from start</span></span>
<span id="cb725-9"><a aria-hidden="true" href="#cb725-9" tabindex="-1"></a>    <span class="fu">SUM</span>(amount) <span class="kw">OVER</span> (<span class="kw">ORDER</span> <span class="kw">BY</span> order_date</span>
<span id="cb725-10"><a aria-hidden="true" href="#cb725-10" tabindex="-1"></a>        <span class="kw">ROWS</span> <span class="kw">BETWEEN</span> <span class="kw">UNBOUNDED</span> <span class="kw">PRECEDING</span> <span class="kw">AND</span> <span class="kw">CURRENT</span> <span class="kw">ROW</span>) <span class="kw">as</span> cumulative</span>
<span id="cb725-11"><a aria-hidden="true" href="#cb725-11" tabindex="-1"></a><span class="kw">FROM</span> orders;</span></code></pre></div>
<h3 data-number="13.2.2" id="common-table-expressions-ctes-and-recursive-queries"><span class="header-section-number">13.2.2</span> 2.2 Common Table Expressions
(CTEs) and Recursive Queries</h3>
<p>CTEs provide a way to define temporary named result sets that can be
referenced in SELECT, INSERT, UPDATE, or DELETE statements.</p>
<h4 data-number="13.2.2.1" id="simple-ctes"><span class="header-section-number">13.2.2.1</span> Simple CTEs</h4>
<div class="sourceCode" id="cb726"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb726-1"><a aria-hidden="true" href="#cb726-1" tabindex="-1"></a><span class="co">-- WITH clause for reusable subqueries</span></span>
<span id="cb726-2"><a aria-hidden="true" href="#cb726-2" tabindex="-1"></a><span class="kw">WITH</span> department_summary <span class="kw">AS</span> (</span>
<span id="cb726-3"><a aria-hidden="true" href="#cb726-3" tabindex="-1"></a>    <span class="kw">SELECT</span></span>
<span id="cb726-4"><a aria-hidden="true" href="#cb726-4" tabindex="-1"></a>        department_id,</span>
<span id="cb726-5"><a aria-hidden="true" href="#cb726-5" tabindex="-1"></a>        <span class="fu">AVG</span>(salary) <span class="kw">as</span> avg_salary,</span>
<span id="cb726-6"><a aria-hidden="true" href="#cb726-6" tabindex="-1"></a>        <span class="fu">COUNT</span>(<span class="op">*</span>) <span class="kw">as</span> emp_count</span>
<span id="cb726-7"><a aria-hidden="true" href="#cb726-7" tabindex="-1"></a>    <span class="kw">FROM</span> employees</span>
<span id="cb726-8"><a aria-hidden="true" href="#cb726-8" tabindex="-1"></a>    <span class="kw">GROUP</span> <span class="kw">BY</span> department_id</span>
<span id="cb726-9"><a aria-hidden="true" href="#cb726-9" tabindex="-1"></a>)</span>
<span id="cb726-10"><a aria-hidden="true" href="#cb726-10" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb726-11"><a aria-hidden="true" href="#cb726-11" tabindex="-1"></a>    e.name,</span>
<span id="cb726-12"><a aria-hidden="true" href="#cb726-12" tabindex="-1"></a>    e.salary,</span>
<span id="cb726-13"><a aria-hidden="true" href="#cb726-13" tabindex="-1"></a>    ds.avg_salary,</span>
<span id="cb726-14"><a aria-hidden="true" href="#cb726-14" tabindex="-1"></a>    e.salary <span class="op">-</span> ds.avg_salary <span class="kw">as</span> salary_diff</span>
<span id="cb726-15"><a aria-hidden="true" href="#cb726-15" tabindex="-1"></a><span class="kw">FROM</span> employees e</span>
<span id="cb726-16"><a aria-hidden="true" href="#cb726-16" tabindex="-1"></a><span class="kw">JOIN</span> department_summary ds <span class="kw">ON</span> e.department_id <span class="op">=</span> ds.department_id</span>
<span id="cb726-17"><a aria-hidden="true" href="#cb726-17" tabindex="-1"></a><span class="kw">WHERE</span> e.salary <span class="op">&gt;</span> ds.avg_salary;</span></code></pre></div>
<h4 data-number="13.2.2.2" id="multiple-ctes"><span class="header-section-number">13.2.2.2</span> Multiple CTEs</h4>
<div class="sourceCode" id="cb727"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb727-1"><a aria-hidden="true" href="#cb727-1" tabindex="-1"></a><span class="kw">WITH</span> sales_summary <span class="kw">AS</span> (</span>
<span id="cb727-2"><a aria-hidden="true" href="#cb727-2" tabindex="-1"></a>    <span class="kw">SELECT</span></span>
<span id="cb727-3"><a aria-hidden="true" href="#cb727-3" tabindex="-1"></a>        customer_id,</span>
<span id="cb727-4"><a aria-hidden="true" href="#cb727-4" tabindex="-1"></a>        <span class="fu">SUM</span>(amount) <span class="kw">as</span> total_sales</span>
<span id="cb727-5"><a aria-hidden="true" href="#cb727-5" tabindex="-1"></a>    <span class="kw">FROM</span> orders</span>
<span id="cb727-6"><a aria-hidden="true" href="#cb727-6" tabindex="-1"></a>    <span class="kw">GROUP</span> <span class="kw">BY</span> customer_id</span>
<span id="cb727-7"><a aria-hidden="true" href="#cb727-7" tabindex="-1"></a>),</span>
<span id="cb727-8"><a aria-hidden="true" href="#cb727-8" tabindex="-1"></a>customer_ranks <span class="kw">AS</span> (</span>
<span id="cb727-9"><a aria-hidden="true" href="#cb727-9" tabindex="-1"></a>    <span class="kw">SELECT</span></span>
<span id="cb727-10"><a aria-hidden="true" href="#cb727-10" tabindex="-1"></a>        customer_id,</span>
<span id="cb727-11"><a aria-hidden="true" href="#cb727-11" tabindex="-1"></a>        total_sales,</span>
<span id="cb727-12"><a aria-hidden="true" href="#cb727-12" tabindex="-1"></a>        <span class="fu">RANK</span>() <span class="kw">OVER</span> (<span class="kw">ORDER</span> <span class="kw">BY</span> total_sales <span class="kw">DESC</span>) <span class="kw">as</span> sales_rank</span>
<span id="cb727-13"><a aria-hidden="true" href="#cb727-13" tabindex="-1"></a>    <span class="kw">FROM</span> sales_summary</span>
<span id="cb727-14"><a aria-hidden="true" href="#cb727-14" tabindex="-1"></a>)</span>
<span id="cb727-15"><a aria-hidden="true" href="#cb727-15" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> customer_ranks <span class="kw">WHERE</span> sales_rank <span class="op">&lt;=</span> <span class="dv">10</span>;</span></code></pre></div>
<h4 data-number="13.2.2.3" id="recursive-ctes"><span class="header-section-number">13.2.2.3</span> Recursive CTEs</h4>
<p>Recursive CTEs enable hierarchical and tree-like query patterns:</p>
<div class="sourceCode" id="cb728"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb728-1"><a aria-hidden="true" href="#cb728-1" tabindex="-1"></a><span class="co">-- Organizational hierarchy</span></span>
<span id="cb728-2"><a aria-hidden="true" href="#cb728-2" tabindex="-1"></a><span class="kw">WITH</span> RECURSIVE org_hierarchy <span class="kw">AS</span> (</span>
<span id="cb728-3"><a aria-hidden="true" href="#cb728-3" tabindex="-1"></a>    <span class="co">-- Anchor: Start with top-level employees</span></span>
<span id="cb728-4"><a aria-hidden="true" href="#cb728-4" tabindex="-1"></a>    <span class="kw">SELECT</span></span>
<span id="cb728-5"><a aria-hidden="true" href="#cb728-5" tabindex="-1"></a>        employee_id,</span>
<span id="cb728-6"><a aria-hidden="true" href="#cb728-6" tabindex="-1"></a>        name,</span>
<span id="cb728-7"><a aria-hidden="true" href="#cb728-7" tabindex="-1"></a>        manager_id,</span>
<span id="cb728-8"><a aria-hidden="true" href="#cb728-8" tabindex="-1"></a>        <span class="dv">1</span> <span class="kw">as</span> <span class="kw">level</span></span>
<span id="cb728-9"><a aria-hidden="true" href="#cb728-9" tabindex="-1"></a>    <span class="kw">FROM</span> employees</span>
<span id="cb728-10"><a aria-hidden="true" href="#cb728-10" tabindex="-1"></a>    <span class="kw">WHERE</span> manager_id <span class="kw">IS</span> <span class="kw">NULL</span></span>
<span id="cb728-11"><a aria-hidden="true" href="#cb728-11" tabindex="-1"></a></span>
<span id="cb728-12"><a aria-hidden="true" href="#cb728-12" tabindex="-1"></a>    <span class="kw">UNION</span> <span class="kw">ALL</span></span>
<span id="cb728-13"><a aria-hidden="true" href="#cb728-13" tabindex="-1"></a></span>
<span id="cb728-14"><a aria-hidden="true" href="#cb728-14" tabindex="-1"></a>    <span class="co">-- Recursive: Find direct reports</span></span>
<span id="cb728-15"><a aria-hidden="true" href="#cb728-15" tabindex="-1"></a>    <span class="kw">SELECT</span></span>
<span id="cb728-16"><a aria-hidden="true" href="#cb728-16" tabindex="-1"></a>        e.employee_id,</span>
<span id="cb728-17"><a aria-hidden="true" href="#cb728-17" tabindex="-1"></a>        e.name,</span>
<span id="cb728-18"><a aria-hidden="true" href="#cb728-18" tabindex="-1"></a>        e.manager_id,</span>
<span id="cb728-19"><a aria-hidden="true" href="#cb728-19" tabindex="-1"></a>        oh.<span class="kw">level</span> <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb728-20"><a aria-hidden="true" href="#cb728-20" tabindex="-1"></a>    <span class="kw">FROM</span> employees e</span>
<span id="cb728-21"><a aria-hidden="true" href="#cb728-21" tabindex="-1"></a>    <span class="kw">INNER</span> <span class="kw">JOIN</span> org_hierarchy oh <span class="kw">ON</span> e.manager_id <span class="op">=</span> oh.employee_id</span>
<span id="cb728-22"><a aria-hidden="true" href="#cb728-22" tabindex="-1"></a>    <span class="kw">WHERE</span> oh.<span class="kw">level</span> <span class="op">&lt;</span> <span class="dv">10</span>  <span class="co">-- Prevent infinite recursion</span></span>
<span id="cb728-23"><a aria-hidden="true" href="#cb728-23" tabindex="-1"></a>)</span>
<span id="cb728-24"><a aria-hidden="true" href="#cb728-24" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> org_hierarchy</span>
<span id="cb728-25"><a aria-hidden="true" href="#cb728-25" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> <span class="kw">level</span>, name;</span></code></pre></div>
<h4 data-number="13.2.2.4" id="recursive-cte-graph-traversal"><span class="header-section-number">13.2.2.4</span> Recursive CTE: Graph
Traversal</h4>
<div class="sourceCode" id="cb729"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb729-1"><a aria-hidden="true" href="#cb729-1" tabindex="-1"></a><span class="co">-- Find all connected nodes in a graph</span></span>
<span id="cb729-2"><a aria-hidden="true" href="#cb729-2" tabindex="-1"></a><span class="kw">WITH</span> RECURSIVE graph_traversal <span class="kw">AS</span> (</span>
<span id="cb729-3"><a aria-hidden="true" href="#cb729-3" tabindex="-1"></a>    <span class="co">-- Start with a specific node</span></span>
<span id="cb729-4"><a aria-hidden="true" href="#cb729-4" tabindex="-1"></a>    <span class="kw">SELECT</span></span>
<span id="cb729-5"><a aria-hidden="true" href="#cb729-5" tabindex="-1"></a>        node_id,</span>
<span id="cb729-6"><a aria-hidden="true" href="#cb729-6" tabindex="-1"></a>        target_id,</span>
<span id="cb729-7"><a aria-hidden="true" href="#cb729-7" tabindex="-1"></a>        <span class="dv">1</span> <span class="kw">as</span> <span class="fu">depth</span></span>
<span id="cb729-8"><a aria-hidden="true" href="#cb729-8" tabindex="-1"></a>    <span class="kw">FROM</span> edges</span>
<span id="cb729-9"><a aria-hidden="true" href="#cb729-9" tabindex="-1"></a>    <span class="kw">WHERE</span> node_id <span class="op">=</span> <span class="st">'A'</span></span>
<span id="cb729-10"><a aria-hidden="true" href="#cb729-10" tabindex="-1"></a></span>
<span id="cb729-11"><a aria-hidden="true" href="#cb729-11" tabindex="-1"></a>    <span class="kw">UNION</span> <span class="kw">ALL</span></span>
<span id="cb729-12"><a aria-hidden="true" href="#cb729-12" tabindex="-1"></a></span>
<span id="cb729-13"><a aria-hidden="true" href="#cb729-13" tabindex="-1"></a>    <span class="co">-- Find reachable nodes</span></span>
<span id="cb729-14"><a aria-hidden="true" href="#cb729-14" tabindex="-1"></a>    <span class="kw">SELECT</span></span>
<span id="cb729-15"><a aria-hidden="true" href="#cb729-15" tabindex="-1"></a>        gt.node_id,</span>
<span id="cb729-16"><a aria-hidden="true" href="#cb729-16" tabindex="-1"></a>        e.target_id,</span>
<span id="cb729-17"><a aria-hidden="true" href="#cb729-17" tabindex="-1"></a>        gt.<span class="fu">depth</span> <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb729-18"><a aria-hidden="true" href="#cb729-18" tabindex="-1"></a>    <span class="kw">FROM</span> graph_traversal gt</span>
<span id="cb729-19"><a aria-hidden="true" href="#cb729-19" tabindex="-1"></a>    <span class="kw">JOIN</span> edges e <span class="kw">ON</span> gt.target_id <span class="op">=</span> e.node_id</span>
<span id="cb729-20"><a aria-hidden="true" href="#cb729-20" tabindex="-1"></a>    <span class="kw">WHERE</span> gt.<span class="fu">depth</span> <span class="op">&lt;</span> <span class="dv">20</span></span>
<span id="cb729-21"><a aria-hidden="true" href="#cb729-21" tabindex="-1"></a>)</span>
<span id="cb729-22"><a aria-hidden="true" href="#cb729-22" tabindex="-1"></a><span class="kw">SELECT</span> <span class="kw">DISTINCT</span> target_id <span class="kw">FROM</span> graph_traversal</span>
<span id="cb729-23"><a aria-hidden="true" href="#cb729-23" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> target_id;</span></code></pre></div>
<h4 data-number="13.2.2.5" id="materialized-ctes"><span class="header-section-number">13.2.2.5</span> Materialized CTEs</h4>
<p>Use <code>MATERIALIZED</code> keyword to force materialization
(vs.¬†inlining):</p>
<div class="sourceCode" id="cb730"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb730-1"><a aria-hidden="true" href="#cb730-1" tabindex="-1"></a><span class="kw">WITH</span> expensive_calc <span class="kw">AS</span> <span class="kw">MATERIALIZED</span> (</span>
<span id="cb730-2"><a aria-hidden="true" href="#cb730-2" tabindex="-1"></a>    <span class="kw">SELECT</span></span>
<span id="cb730-3"><a aria-hidden="true" href="#cb730-3" tabindex="-1"></a>        <span class="kw">id</span>,</span>
<span id="cb730-4"><a aria-hidden="true" href="#cb730-4" tabindex="-1"></a>        complex_computation(<span class="kw">data</span>) <span class="kw">as</span> result</span>
<span id="cb730-5"><a aria-hidden="true" href="#cb730-5" tabindex="-1"></a>    <span class="kw">FROM</span> large_table</span>
<span id="cb730-6"><a aria-hidden="true" href="#cb730-6" tabindex="-1"></a>)</span>
<span id="cb730-7"><a aria-hidden="true" href="#cb730-7" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> expensive_calc</span>
<span id="cb730-8"><a aria-hidden="true" href="#cb730-8" tabindex="-1"></a><span class="kw">WHERE</span> result <span class="op">&gt;</span> <span class="dv">1000</span>;</span></code></pre></div>
<h3 data-number="13.2.3" id="lateral-joins"><span class="header-section-number">13.2.3</span> 2.3 LATERAL Joins</h3>
<p>LATERAL subqueries allow the subquery to reference columns from
preceding tables, enabling powerful row-by-row processing:</p>
<div class="sourceCode" id="cb731"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb731-1"><a aria-hidden="true" href="#cb731-1" tabindex="-1"></a><span class="co">-- Find top 3 purchases for each customer</span></span>
<span id="cb731-2"><a aria-hidden="true" href="#cb731-2" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb731-3"><a aria-hidden="true" href="#cb731-3" tabindex="-1"></a>    c.customer_id,</span>
<span id="cb731-4"><a aria-hidden="true" href="#cb731-4" tabindex="-1"></a>    c.name,</span>
<span id="cb731-5"><a aria-hidden="true" href="#cb731-5" tabindex="-1"></a>    p.order_date,</span>
<span id="cb731-6"><a aria-hidden="true" href="#cb731-6" tabindex="-1"></a>    p.amount</span>
<span id="cb731-7"><a aria-hidden="true" href="#cb731-7" tabindex="-1"></a><span class="kw">FROM</span> customers c</span>
<span id="cb731-8"><a aria-hidden="true" href="#cb731-8" tabindex="-1"></a><span class="kw">CROSS</span> <span class="kw">JOIN</span> LATERAL (</span>
<span id="cb731-9"><a aria-hidden="true" href="#cb731-9" tabindex="-1"></a>    <span class="kw">SELECT</span> order_date, amount</span>
<span id="cb731-10"><a aria-hidden="true" href="#cb731-10" tabindex="-1"></a>    <span class="kw">FROM</span> orders</span>
<span id="cb731-11"><a aria-hidden="true" href="#cb731-11" tabindex="-1"></a>    <span class="kw">WHERE</span> customer_id <span class="op">=</span> c.customer_id</span>
<span id="cb731-12"><a aria-hidden="true" href="#cb731-12" tabindex="-1"></a>    <span class="kw">ORDER</span> <span class="kw">BY</span> amount <span class="kw">DESC</span></span>
<span id="cb731-13"><a aria-hidden="true" href="#cb731-13" tabindex="-1"></a>    <span class="kw">LIMIT</span> <span class="dv">3</span></span>
<span id="cb731-14"><a aria-hidden="true" href="#cb731-14" tabindex="-1"></a>) p;</span></code></pre></div>
<h4 data-number="13.2.3.1" id="lateral-with-function-calls"><span class="header-section-number">13.2.3.1</span> LATERAL with Function
Calls</h4>
<div class="sourceCode" id="cb732"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb732-1"><a aria-hidden="true" href="#cb732-1" tabindex="-1"></a><span class="co">-- Apply set-returning function to each row</span></span>
<span id="cb732-2"><a aria-hidden="true" href="#cb732-2" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb732-3"><a aria-hidden="true" href="#cb732-3" tabindex="-1"></a>    product_id,</span>
<span id="cb732-4"><a aria-hidden="true" href="#cb732-4" tabindex="-1"></a>    product_name,</span>
<span id="cb732-5"><a aria-hidden="true" href="#cb732-5" tabindex="-1"></a>    tags</span>
<span id="cb732-6"><a aria-hidden="true" href="#cb732-6" tabindex="-1"></a><span class="kw">FROM</span> products</span>
<span id="cb732-7"><a aria-hidden="true" href="#cb732-7" tabindex="-1"></a><span class="kw">CROSS</span> <span class="kw">JOIN</span> LATERAL unnest(product_tags) <span class="kw">AS</span> tags;</span>
<span id="cb732-8"><a aria-hidden="true" href="#cb732-8" tabindex="-1"></a></span>
<span id="cb732-9"><a aria-hidden="true" href="#cb732-9" tabindex="-1"></a><span class="co">-- Using json_each_text with LATERAL</span></span>
<span id="cb732-10"><a aria-hidden="true" href="#cb732-10" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb732-11"><a aria-hidden="true" href="#cb732-11" tabindex="-1"></a>    <span class="kw">id</span>,</span>
<span id="cb732-12"><a aria-hidden="true" href="#cb732-12" tabindex="-1"></a>    <span class="kw">key</span>,</span>
<span id="cb732-13"><a aria-hidden="true" href="#cb732-13" tabindex="-1"></a>    <span class="fu">value</span></span>
<span id="cb732-14"><a aria-hidden="true" href="#cb732-14" tabindex="-1"></a><span class="kw">FROM</span> json_data</span>
<span id="cb732-15"><a aria-hidden="true" href="#cb732-15" tabindex="-1"></a><span class="kw">CROSS</span> <span class="kw">JOIN</span> LATERAL json_each_text(<span class="kw">data</span>) <span class="kw">AS</span> kv(<span class="kw">key</span>, <span class="fu">value</span>);</span></code></pre></div>
<h4 data-number="13.2.3.2" id="lateral-with-join-conditions"><span class="header-section-number">13.2.3.2</span> LATERAL with JOIN
Conditions</h4>
<div class="sourceCode" id="cb733"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb733-1"><a aria-hidden="true" href="#cb733-1" tabindex="-1"></a><span class="co">-- Find related products based on category affinity</span></span>
<span id="cb733-2"><a aria-hidden="true" href="#cb733-2" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb733-3"><a aria-hidden="true" href="#cb733-3" tabindex="-1"></a>    p1.product_id,</span>
<span id="cb733-4"><a aria-hidden="true" href="#cb733-4" tabindex="-1"></a>    p1.name,</span>
<span id="cb733-5"><a aria-hidden="true" href="#cb733-5" tabindex="-1"></a>    p2.product_id,</span>
<span id="cb733-6"><a aria-hidden="true" href="#cb733-6" tabindex="-1"></a>    p2.name</span>
<span id="cb733-7"><a aria-hidden="true" href="#cb733-7" tabindex="-1"></a><span class="kw">FROM</span> products p1</span>
<span id="cb733-8"><a aria-hidden="true" href="#cb733-8" tabindex="-1"></a><span class="kw">JOIN</span> LATERAL (</span>
<span id="cb733-9"><a aria-hidden="true" href="#cb733-9" tabindex="-1"></a>    <span class="kw">SELECT</span> product_id, name</span>
<span id="cb733-10"><a aria-hidden="true" href="#cb733-10" tabindex="-1"></a>    <span class="kw">FROM</span> products</span>
<span id="cb733-11"><a aria-hidden="true" href="#cb733-11" tabindex="-1"></a>    <span class="kw">WHERE</span> <span class="kw">category</span> <span class="op">=</span> p1.<span class="kw">category</span></span>
<span id="cb733-12"><a aria-hidden="true" href="#cb733-12" tabindex="-1"></a>        <span class="kw">AND</span> product_id <span class="op">!=</span> p1.product_id</span>
<span id="cb733-13"><a aria-hidden="true" href="#cb733-13" tabindex="-1"></a>    <span class="kw">LIMIT</span> <span class="dv">5</span></span>
<span id="cb733-14"><a aria-hidden="true" href="#cb733-14" tabindex="-1"></a>) p2 <span class="kw">ON</span> <span class="kw">TRUE</span>;</span></code></pre></div>
<h3 data-number="13.2.4" id="grouping-sets-cube-and-rollup"><span class="header-section-number">13.2.4</span> 2.4 GROUPING SETS, CUBE, and
ROLLUP</h3>
<p>These features enable multi-level aggregation with a single
query:</p>
<div class="sourceCode" id="cb734"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb734-1"><a aria-hidden="true" href="#cb734-1" tabindex="-1"></a><span class="co">-- GROUPING SETS: Multiple independent groupings</span></span>
<span id="cb734-2"><a aria-hidden="true" href="#cb734-2" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb734-3"><a aria-hidden="true" href="#cb734-3" tabindex="-1"></a>    <span class="dt">year</span>,</span>
<span id="cb734-4"><a aria-hidden="true" href="#cb734-4" tabindex="-1"></a>    quarter,</span>
<span id="cb734-5"><a aria-hidden="true" href="#cb734-5" tabindex="-1"></a>    region,</span>
<span id="cb734-6"><a aria-hidden="true" href="#cb734-6" tabindex="-1"></a>    <span class="fu">SUM</span>(sales) <span class="kw">as</span> total_sales</span>
<span id="cb734-7"><a aria-hidden="true" href="#cb734-7" tabindex="-1"></a><span class="kw">FROM</span> sales_data</span>
<span id="cb734-8"><a aria-hidden="true" href="#cb734-8" tabindex="-1"></a><span class="kw">GROUP</span> <span class="kw">BY</span> <span class="fu">GROUPING</span> SETS (</span>
<span id="cb734-9"><a aria-hidden="true" href="#cb734-9" tabindex="-1"></a>    (<span class="dt">year</span>, quarter, region),</span>
<span id="cb734-10"><a aria-hidden="true" href="#cb734-10" tabindex="-1"></a>    (<span class="dt">year</span>, quarter),</span>
<span id="cb734-11"><a aria-hidden="true" href="#cb734-11" tabindex="-1"></a>    (<span class="dt">year</span>),</span>
<span id="cb734-12"><a aria-hidden="true" href="#cb734-12" tabindex="-1"></a>    ()</span>
<span id="cb734-13"><a aria-hidden="true" href="#cb734-13" tabindex="-1"></a>)</span>
<span id="cb734-14"><a aria-hidden="true" href="#cb734-14" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> <span class="dt">year</span>, quarter, region;</span>
<span id="cb734-15"><a aria-hidden="true" href="#cb734-15" tabindex="-1"></a></span>
<span id="cb734-16"><a aria-hidden="true" href="#cb734-16" tabindex="-1"></a><span class="co">-- Identify which grouping is used with GROUPING()</span></span>
<span id="cb734-17"><a aria-hidden="true" href="#cb734-17" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb734-18"><a aria-hidden="true" href="#cb734-18" tabindex="-1"></a>    <span class="dt">year</span>,</span>
<span id="cb734-19"><a aria-hidden="true" href="#cb734-19" tabindex="-1"></a>    quarter,</span>
<span id="cb734-20"><a aria-hidden="true" href="#cb734-20" tabindex="-1"></a>    region,</span>
<span id="cb734-21"><a aria-hidden="true" href="#cb734-21" tabindex="-1"></a>    <span class="fu">SUM</span>(sales) <span class="kw">as</span> total_sales,</span>
<span id="cb734-22"><a aria-hidden="true" href="#cb734-22" tabindex="-1"></a>    <span class="fu">GROUPING</span>(<span class="dt">year</span>, quarter, region) <span class="kw">as</span> <span class="fu">grouping_id</span></span>
<span id="cb734-23"><a aria-hidden="true" href="#cb734-23" tabindex="-1"></a><span class="kw">FROM</span> sales_data</span>
<span id="cb734-24"><a aria-hidden="true" href="#cb734-24" tabindex="-1"></a><span class="kw">GROUP</span> <span class="kw">BY</span> <span class="fu">GROUPING</span> SETS (</span>
<span id="cb734-25"><a aria-hidden="true" href="#cb734-25" tabindex="-1"></a>    (<span class="dt">year</span>, quarter, region),</span>
<span id="cb734-26"><a aria-hidden="true" href="#cb734-26" tabindex="-1"></a>    (<span class="dt">year</span>, quarter),</span>
<span id="cb734-27"><a aria-hidden="true" href="#cb734-27" tabindex="-1"></a>    (<span class="dt">year</span>),</span>
<span id="cb734-28"><a aria-hidden="true" href="#cb734-28" tabindex="-1"></a>    ()</span>
<span id="cb734-29"><a aria-hidden="true" href="#cb734-29" tabindex="-1"></a>)</span>
<span id="cb734-30"><a aria-hidden="true" href="#cb734-30" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> <span class="fu">grouping_id</span>;</span></code></pre></div>
<h4 data-number="13.2.4.1" id="rollup-hierarchical-aggregation"><span class="header-section-number">13.2.4.1</span> ROLLUP: Hierarchical
Aggregation</h4>
<div class="sourceCode" id="cb735"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb735-1"><a aria-hidden="true" href="#cb735-1" tabindex="-1"></a><span class="co">-- ROLLUP creates progressively aggregated rows</span></span>
<span id="cb735-2"><a aria-hidden="true" href="#cb735-2" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb735-3"><a aria-hidden="true" href="#cb735-3" tabindex="-1"></a>    <span class="dt">year</span>,</span>
<span id="cb735-4"><a aria-hidden="true" href="#cb735-4" tabindex="-1"></a>    quarter,</span>
<span id="cb735-5"><a aria-hidden="true" href="#cb735-5" tabindex="-1"></a>    <span class="dt">month</span>,</span>
<span id="cb735-6"><a aria-hidden="true" href="#cb735-6" tabindex="-1"></a>    <span class="fu">SUM</span>(sales) <span class="kw">as</span> total_sales</span>
<span id="cb735-7"><a aria-hidden="true" href="#cb735-7" tabindex="-1"></a><span class="kw">FROM</span> sales_data</span>
<span id="cb735-8"><a aria-hidden="true" href="#cb735-8" tabindex="-1"></a><span class="kw">GROUP</span> <span class="kw">BY</span> <span class="kw">ROLLUP</span> (<span class="dt">year</span>, quarter, <span class="dt">month</span>)</span>
<span id="cb735-9"><a aria-hidden="true" href="#cb735-9" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> <span class="dt">year</span>, quarter, <span class="dt">month</span>;</span>
<span id="cb735-10"><a aria-hidden="true" href="#cb735-10" tabindex="-1"></a></span>
<span id="cb735-11"><a aria-hidden="true" href="#cb735-11" tabindex="-1"></a><span class="co">-- Equivalent to:</span></span>
<span id="cb735-12"><a aria-hidden="true" href="#cb735-12" tabindex="-1"></a><span class="co">-- GROUP BY (year, quarter, month), (year, quarter), (year), ()</span></span></code></pre></div>
<h4 data-number="13.2.4.2" id="cube-all-possible-groupings"><span class="header-section-number">13.2.4.2</span> CUBE: All Possible
Groupings</h4>
<div class="sourceCode" id="cb736"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb736-1"><a aria-hidden="true" href="#cb736-1" tabindex="-1"></a><span class="co">-- CUBE generates all combinations of grouping</span></span>
<span id="cb736-2"><a aria-hidden="true" href="#cb736-2" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb736-3"><a aria-hidden="true" href="#cb736-3" tabindex="-1"></a>    product_category,</span>
<span id="cb736-4"><a aria-hidden="true" href="#cb736-4" tabindex="-1"></a>    region,</span>
<span id="cb736-5"><a aria-hidden="true" href="#cb736-5" tabindex="-1"></a>    sales_channel,</span>
<span id="cb736-6"><a aria-hidden="true" href="#cb736-6" tabindex="-1"></a>    <span class="fu">SUM</span>(amount) <span class="kw">as</span> total</span>
<span id="cb736-7"><a aria-hidden="true" href="#cb736-7" tabindex="-1"></a><span class="kw">FROM</span> sales</span>
<span id="cb736-8"><a aria-hidden="true" href="#cb736-8" tabindex="-1"></a><span class="kw">GROUP</span> <span class="kw">BY</span> <span class="kw">CUBE</span> (product_category, region, sales_channel)</span>
<span id="cb736-9"><a aria-hidden="true" href="#cb736-9" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> product_category, region, sales_channel;</span>
<span id="cb736-10"><a aria-hidden="true" href="#cb736-10" tabindex="-1"></a></span>
<span id="cb736-11"><a aria-hidden="true" href="#cb736-11" tabindex="-1"></a><span class="co">-- Generates 2^3 = 8 grouping combinations</span></span></code></pre></div>
<h3 data-number="13.2.5" id="json-and-jsonb-operations"><span class="header-section-number">13.2.5</span> 2.5 JSON and JSONB
Operations</h3>
<p>PostgreSQL provides comprehensive JSON support with powerful
operators:</p>
<h4 data-number="13.2.5.1" id="json-vs-jsonb"><span class="header-section-number">13.2.5.1</span> JSON vs JSONB</h4>
<div class="sourceCode" id="cb737"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb737-1"><a aria-hidden="true" href="#cb737-1" tabindex="-1"></a><span class="co">-- json: Text-based (slower, preserves format/duplicates)</span></span>
<span id="cb737-2"><a aria-hidden="true" href="#cb737-2" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> config_json (<span class="kw">data</span> json);</span>
<span id="cb737-3"><a aria-hidden="true" href="#cb737-3" tabindex="-1"></a></span>
<span id="cb737-4"><a aria-hidden="true" href="#cb737-4" tabindex="-1"></a><span class="co">-- jsonb: Binary (faster, normalized, supports indexing)</span></span>
<span id="cb737-5"><a aria-hidden="true" href="#cb737-5" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> config_jsonb (<span class="kw">data</span> jsonb);</span>
<span id="cb737-6"><a aria-hidden="true" href="#cb737-6" tabindex="-1"></a></span>
<span id="cb737-7"><a aria-hidden="true" href="#cb737-7" tabindex="-1"></a><span class="co">-- JSONB is generally preferred for most applications</span></span>
<span id="cb737-8"><a aria-hidden="true" href="#cb737-8" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> config_jsonb <span class="kw">VALUES</span> (<span class="st">'{"name": "Alice", "age": 30}'</span>);</span></code></pre></div>
<h4 data-number="13.2.5.2" id="accessing-json-data"><span class="header-section-number">13.2.5.2</span> Accessing JSON Data</h4>
<div class="sourceCode" id="cb738"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb738-1"><a aria-hidden="true" href="#cb738-1" tabindex="-1"></a><span class="co">-- -&gt; returns value as JSON</span></span>
<span id="cb738-2"><a aria-hidden="true" href="#cb738-2" tabindex="-1"></a><span class="co">-- -&gt;&gt; returns value as text</span></span>
<span id="cb738-3"><a aria-hidden="true" href="#cb738-3" tabindex="-1"></a><span class="co">-- #&gt; returns nested value as JSON</span></span>
<span id="cb738-4"><a aria-hidden="true" href="#cb738-4" tabindex="-1"></a><span class="co">-- #&gt;&gt; returns nested value as text</span></span>
<span id="cb738-5"><a aria-hidden="true" href="#cb738-5" tabindex="-1"></a></span>
<span id="cb738-6"><a aria-hidden="true" href="#cb738-6" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb738-7"><a aria-hidden="true" href="#cb738-7" tabindex="-1"></a>    <span class="kw">data</span><span class="op">-&gt;</span><span class="st">'name'</span> <span class="kw">as</span> name_json,</span>
<span id="cb738-8"><a aria-hidden="true" href="#cb738-8" tabindex="-1"></a>    <span class="kw">data</span><span class="op">-&gt;&gt;</span><span class="st">'name'</span> <span class="kw">as</span> name_text,</span>
<span id="cb738-9"><a aria-hidden="true" href="#cb738-9" tabindex="-1"></a>    <span class="kw">data</span><span class="op">-&gt;</span><span class="st">'address'</span><span class="op">-&gt;&gt;</span><span class="st">'city'</span> <span class="kw">as</span> city</span>
<span id="cb738-10"><a aria-hidden="true" href="#cb738-10" tabindex="-1"></a><span class="kw">FROM</span> config_jsonb</span>
<span id="cb738-11"><a aria-hidden="true" href="#cb738-11" tabindex="-1"></a><span class="kw">WHERE</span> (<span class="kw">data</span><span class="op">-&gt;</span><span class="st">'age'</span>):<span class="ch">:int</span> <span class="op">&gt;</span> <span class="dv">25</span>;</span></code></pre></div>
<h4 data-number="13.2.5.3" id="querying-json-arrays"><span class="header-section-number">13.2.5.3</span> Querying JSON Arrays</h4>
<div class="sourceCode" id="cb739"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb739-1"><a aria-hidden="true" href="#cb739-1" tabindex="-1"></a><span class="co">-- jsonb_array_elements: Expand JSON array</span></span>
<span id="cb739-2"><a aria-hidden="true" href="#cb739-2" tabindex="-1"></a><span class="kw">SELECT</span> jsonb_array_elements(tags) <span class="kw">as</span> tag</span>
<span id="cb739-3"><a aria-hidden="true" href="#cb739-3" tabindex="-1"></a><span class="kw">FROM</span> products</span>
<span id="cb739-4"><a aria-hidden="true" href="#cb739-4" tabindex="-1"></a><span class="kw">WHERE</span> name <span class="op">=</span> <span class="st">'Widget'</span>;</span>
<span id="cb739-5"><a aria-hidden="true" href="#cb739-5" tabindex="-1"></a></span>
<span id="cb739-6"><a aria-hidden="true" href="#cb739-6" tabindex="-1"></a><span class="co">-- jsonb_array_length: Array size</span></span>
<span id="cb739-7"><a aria-hidden="true" href="#cb739-7" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb739-8"><a aria-hidden="true" href="#cb739-8" tabindex="-1"></a>    name,</span>
<span id="cb739-9"><a aria-hidden="true" href="#cb739-9" tabindex="-1"></a>    jsonb_array_length(tags) <span class="kw">as</span> tag_count</span>
<span id="cb739-10"><a aria-hidden="true" href="#cb739-10" tabindex="-1"></a><span class="kw">FROM</span> products;</span>
<span id="cb739-11"><a aria-hidden="true" href="#cb739-11" tabindex="-1"></a></span>
<span id="cb739-12"><a aria-hidden="true" href="#cb739-12" tabindex="-1"></a><span class="co">-- Containment operators</span></span>
<span id="cb739-13"><a aria-hidden="true" href="#cb739-13" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> products</span>
<span id="cb739-14"><a aria-hidden="true" href="#cb739-14" tabindex="-1"></a><span class="kw">WHERE</span> tags @<span class="op">&gt;</span> <span class="st">'["electronics", "gadget"]'</span>:<span class="ch">:jsonb</span>;</span></code></pre></div>
<h4 data-number="13.2.5.4" id="building-and-modifying-json"><span class="header-section-number">13.2.5.4</span> Building and Modifying
JSON</h4>
<div class="sourceCode" id="cb740"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb740-1"><a aria-hidden="true" href="#cb740-1" tabindex="-1"></a><span class="co">-- jsonb_build_object: Build JSON object</span></span>
<span id="cb740-2"><a aria-hidden="true" href="#cb740-2" tabindex="-1"></a><span class="kw">SELECT</span> jsonb_build_object(</span>
<span id="cb740-3"><a aria-hidden="true" href="#cb740-3" tabindex="-1"></a>    <span class="st">'id'</span>, <span class="kw">id</span>,</span>
<span id="cb740-4"><a aria-hidden="true" href="#cb740-4" tabindex="-1"></a>    <span class="st">'name'</span>, name,</span>
<span id="cb740-5"><a aria-hidden="true" href="#cb740-5" tabindex="-1"></a>    <span class="st">'email'</span>, email</span>
<span id="cb740-6"><a aria-hidden="true" href="#cb740-6" tabindex="-1"></a>) <span class="kw">as</span> customer_json</span>
<span id="cb740-7"><a aria-hidden="true" href="#cb740-7" tabindex="-1"></a><span class="kw">FROM</span> customers;</span>
<span id="cb740-8"><a aria-hidden="true" href="#cb740-8" tabindex="-1"></a></span>
<span id="cb740-9"><a aria-hidden="true" href="#cb740-9" tabindex="-1"></a><span class="co">-- jsonb_build_array: Build JSON array</span></span>
<span id="cb740-10"><a aria-hidden="true" href="#cb740-10" tabindex="-1"></a><span class="kw">SELECT</span> jsonb_build_array(<span class="kw">id</span>, name, email)</span>
<span id="cb740-11"><a aria-hidden="true" href="#cb740-11" tabindex="-1"></a><span class="kw">FROM</span> customers;</span>
<span id="cb740-12"><a aria-hidden="true" href="#cb740-12" tabindex="-1"></a></span>
<span id="cb740-13"><a aria-hidden="true" href="#cb740-13" tabindex="-1"></a><span class="co">-- || operator: Merge JSON objects</span></span>
<span id="cb740-14"><a aria-hidden="true" href="#cb740-14" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb740-15"><a aria-hidden="true" href="#cb740-15" tabindex="-1"></a>    <span class="kw">data</span> <span class="op">||</span> <span class="st">'{"updated": true}'</span>:<span class="ch">:jsonb</span> <span class="kw">as</span> updated_data</span>
<span id="cb740-16"><a aria-hidden="true" href="#cb740-16" tabindex="-1"></a><span class="kw">FROM</span> config_jsonb;</span>
<span id="cb740-17"><a aria-hidden="true" href="#cb740-17" tabindex="-1"></a></span>
<span id="cb740-18"><a aria-hidden="true" href="#cb740-18" tabindex="-1"></a><span class="co">-- jsonb_set: Update nested values</span></span>
<span id="cb740-19"><a aria-hidden="true" href="#cb740-19" tabindex="-1"></a><span class="kw">SELECT</span> jsonb_set(</span>
<span id="cb740-20"><a aria-hidden="true" href="#cb740-20" tabindex="-1"></a>    <span class="kw">data</span>,</span>
<span id="cb740-21"><a aria-hidden="true" href="#cb740-21" tabindex="-1"></a>    <span class="st">'{address, city}'</span>,</span>
<span id="cb740-22"><a aria-hidden="true" href="#cb740-22" tabindex="-1"></a>    <span class="st">'"New York"'</span>:<span class="ch">:jsonb</span></span>
<span id="cb740-23"><a aria-hidden="true" href="#cb740-23" tabindex="-1"></a>)</span>
<span id="cb740-24"><a aria-hidden="true" href="#cb740-24" tabindex="-1"></a><span class="kw">FROM</span> customers;</span>
<span id="cb740-25"><a aria-hidden="true" href="#cb740-25" tabindex="-1"></a></span>
<span id="cb740-26"><a aria-hidden="true" href="#cb740-26" tabindex="-1"></a><span class="co">-- jsonb_insert: Insert value at path</span></span>
<span id="cb740-27"><a aria-hidden="true" href="#cb740-27" tabindex="-1"></a><span class="kw">SELECT</span> jsonb_insert(</span>
<span id="cb740-28"><a aria-hidden="true" href="#cb740-28" tabindex="-1"></a>    <span class="kw">data</span>,</span>
<span id="cb740-29"><a aria-hidden="true" href="#cb740-29" tabindex="-1"></a>    <span class="st">'{tags, 0}'</span>,</span>
<span id="cb740-30"><a aria-hidden="true" href="#cb740-30" tabindex="-1"></a>    <span class="st">'"new_tag"'</span>:<span class="ch">:jsonb</span></span>
<span id="cb740-31"><a aria-hidden="true" href="#cb740-31" tabindex="-1"></a>)</span>
<span id="cb740-32"><a aria-hidden="true" href="#cb740-32" tabindex="-1"></a><span class="kw">FROM</span> products;</span></code></pre></div>
<h4 data-number="13.2.5.5" id="json-aggregation"><span class="header-section-number">13.2.5.5</span> JSON Aggregation</h4>
<div class="sourceCode" id="cb741"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb741-1"><a aria-hidden="true" href="#cb741-1" tabindex="-1"></a><span class="co">-- json_object_agg: Create JSON object from rows</span></span>
<span id="cb741-2"><a aria-hidden="true" href="#cb741-2" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb741-3"><a aria-hidden="true" href="#cb741-3" tabindex="-1"></a>    <span class="kw">category</span>,</span>
<span id="cb741-4"><a aria-hidden="true" href="#cb741-4" tabindex="-1"></a>    json_object_agg(name, price) <span class="kw">as</span> products</span>
<span id="cb741-5"><a aria-hidden="true" href="#cb741-5" tabindex="-1"></a><span class="kw">FROM</span> products</span>
<span id="cb741-6"><a aria-hidden="true" href="#cb741-6" tabindex="-1"></a><span class="kw">GROUP</span> <span class="kw">BY</span> <span class="kw">category</span>;</span>
<span id="cb741-7"><a aria-hidden="true" href="#cb741-7" tabindex="-1"></a></span>
<span id="cb741-8"><a aria-hidden="true" href="#cb741-8" tabindex="-1"></a><span class="co">-- json_agg: Create JSON array</span></span>
<span id="cb741-9"><a aria-hidden="true" href="#cb741-9" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb741-10"><a aria-hidden="true" href="#cb741-10" tabindex="-1"></a>    customer_id,</span>
<span id="cb741-11"><a aria-hidden="true" href="#cb741-11" tabindex="-1"></a>    json_agg(json_build_object(<span class="st">'id'</span>, <span class="kw">id</span>, <span class="st">'amount'</span>, amount)) <span class="kw">as</span> orders</span>
<span id="cb741-12"><a aria-hidden="true" href="#cb741-12" tabindex="-1"></a><span class="kw">FROM</span> orders</span>
<span id="cb741-13"><a aria-hidden="true" href="#cb741-13" tabindex="-1"></a><span class="kw">GROUP</span> <span class="kw">BY</span> customer_id;</span></code></pre></div>
<h4 data-number="13.2.5.6" id="path-queries"><span class="header-section-number">13.2.5.6</span> Path Queries</h4>
<div class="sourceCode" id="cb742"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb742-1"><a aria-hidden="true" href="#cb742-1" tabindex="-1"></a><span class="co">-- jsonb_path_exists: Check if path exists</span></span>
<span id="cb742-2"><a aria-hidden="true" href="#cb742-2" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> documents</span>
<span id="cb742-3"><a aria-hidden="true" href="#cb742-3" tabindex="-1"></a><span class="kw">WHERE</span> jsonb_path_exists(<span class="kw">data</span>, <span class="st">'$.author.email'</span>);</span>
<span id="cb742-4"><a aria-hidden="true" href="#cb742-4" tabindex="-1"></a></span>
<span id="cb742-5"><a aria-hidden="true" href="#cb742-5" tabindex="-1"></a><span class="co">-- jsonb_path_query: Query using JSONPath</span></span>
<span id="cb742-6"><a aria-hidden="true" href="#cb742-6" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb742-7"><a aria-hidden="true" href="#cb742-7" tabindex="-1"></a>    <span class="kw">id</span>,</span>
<span id="cb742-8"><a aria-hidden="true" href="#cb742-8" tabindex="-1"></a>    jsonb_path_query(<span class="kw">data</span>, <span class="st">'$.items[*].price'</span>) <span class="kw">as</span> prices</span>
<span id="cb742-9"><a aria-hidden="true" href="#cb742-9" tabindex="-1"></a><span class="kw">FROM</span> orders;</span></code></pre></div>
<hr/>
<h2 data-number="13.3" id="plpgsql-procedural-sql-language"><span class="header-section-number">13.3</span> 3. PL/pgSQL: Procedural SQL
Language</h2>
<p>PL/pgSQL is PostgreSQL‚Äôs procedural language, enabling complex
business logic in stored procedures, functions, and triggers.</p>
<h3 data-number="13.3.1" id="basic-function-structure"><span class="header-section-number">13.3.1</span> 3.1 Basic Function
Structure</h3>
<div class="sourceCode" id="cb743"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb743-1"><a aria-hidden="true" href="#cb743-1" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">OR</span> <span class="kw">REPLACE</span> <span class="kw">FUNCTION</span> calculate_age(birth_date <span class="dt">date</span>)</span>
<span id="cb743-2"><a aria-hidden="true" href="#cb743-2" tabindex="-1"></a>RETURNS <span class="dt">int</span> <span class="kw">AS</span> $$</span>
<span id="cb743-3"><a aria-hidden="true" href="#cb743-3" tabindex="-1"></a><span class="kw">DECLARE</span></span>
<span id="cb743-4"><a aria-hidden="true" href="#cb743-4" tabindex="-1"></a>    age <span class="dt">int</span>;</span>
<span id="cb743-5"><a aria-hidden="true" href="#cb743-5" tabindex="-1"></a><span class="cf">BEGIN</span></span>
<span id="cb743-6"><a aria-hidden="true" href="#cb743-6" tabindex="-1"></a>    age <span class="op">:=</span> DATE_PART(<span class="st">'year'</span>, AGE(birth_date));</span>
<span id="cb743-7"><a aria-hidden="true" href="#cb743-7" tabindex="-1"></a>    <span class="kw">RETURN</span> age;</span>
<span id="cb743-8"><a aria-hidden="true" href="#cb743-8" tabindex="-1"></a><span class="cf">END</span>;</span>
<span id="cb743-9"><a aria-hidden="true" href="#cb743-9" tabindex="-1"></a>$$ LANGUAGE plpgsql;</span>
<span id="cb743-10"><a aria-hidden="true" href="#cb743-10" tabindex="-1"></a></span>
<span id="cb743-11"><a aria-hidden="true" href="#cb743-11" tabindex="-1"></a><span class="co">-- Usage</span></span>
<span id="cb743-12"><a aria-hidden="true" href="#cb743-12" tabindex="-1"></a><span class="kw">SELECT</span> calculate_age(<span class="st">'1990-05-15'</span>:<span class="ch">:date</span>);</span></code></pre></div>
<h3 data-number="13.3.2" id="variables-and-control-flow"><span class="header-section-number">13.3.2</span> 3.2 Variables and Control
Flow</h3>
<div class="sourceCode" id="cb744"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb744-1"><a aria-hidden="true" href="#cb744-1" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">OR</span> <span class="kw">REPLACE</span> <span class="kw">FUNCTION</span> process_employee(emp_id <span class="dt">int</span>)</span>
<span id="cb744-2"><a aria-hidden="true" href="#cb744-2" tabindex="-1"></a>RETURNS <span class="kw">TABLE</span>(name <span class="dt">varchar</span>, salary <span class="dt">numeric</span>, <span class="kw">category</span> text) <span class="kw">AS</span> $$</span>
<span id="cb744-3"><a aria-hidden="true" href="#cb744-3" tabindex="-1"></a><span class="kw">DECLARE</span></span>
<span id="cb744-4"><a aria-hidden="true" href="#cb744-4" tabindex="-1"></a>    v_salary <span class="dt">numeric</span>;</span>
<span id="cb744-5"><a aria-hidden="true" href="#cb744-5" tabindex="-1"></a>    v_name <span class="dt">varchar</span>;</span>
<span id="cb744-6"><a aria-hidden="true" href="#cb744-6" tabindex="-1"></a>    v_category text;</span>
<span id="cb744-7"><a aria-hidden="true" href="#cb744-7" tabindex="-1"></a><span class="cf">BEGIN</span></span>
<span id="cb744-8"><a aria-hidden="true" href="#cb744-8" tabindex="-1"></a>    <span class="co">-- Get employee data</span></span>
<span id="cb744-9"><a aria-hidden="true" href="#cb744-9" tabindex="-1"></a>    <span class="kw">SELECT</span> name, salary <span class="kw">INTO</span> v_name, v_salary</span>
<span id="cb744-10"><a aria-hidden="true" href="#cb744-10" tabindex="-1"></a>    <span class="kw">FROM</span> employees</span>
<span id="cb744-11"><a aria-hidden="true" href="#cb744-11" tabindex="-1"></a>    <span class="kw">WHERE</span> employee_id <span class="op">=</span> emp_id;</span>
<span id="cb744-12"><a aria-hidden="true" href="#cb744-12" tabindex="-1"></a></span>
<span id="cb744-13"><a aria-hidden="true" href="#cb744-13" tabindex="-1"></a>    <span class="co">-- Conditional logic</span></span>
<span id="cb744-14"><a aria-hidden="true" href="#cb744-14" tabindex="-1"></a>    <span class="cf">IF</span> v_salary <span class="op">&gt;</span> <span class="dv">150000</span> <span class="cf">THEN</span></span>
<span id="cb744-15"><a aria-hidden="true" href="#cb744-15" tabindex="-1"></a>        v_category <span class="op">:=</span> <span class="st">'Executive'</span>;</span>
<span id="cb744-16"><a aria-hidden="true" href="#cb744-16" tabindex="-1"></a>    <span class="cf">ELSIF</span> v_salary <span class="op">&gt;</span> <span class="dv">100000</span> <span class="cf">THEN</span></span>
<span id="cb744-17"><a aria-hidden="true" href="#cb744-17" tabindex="-1"></a>        v_category <span class="op">:=</span> <span class="st">'Senior'</span>;</span>
<span id="cb744-18"><a aria-hidden="true" href="#cb744-18" tabindex="-1"></a>    <span class="cf">ELSIF</span> v_salary <span class="op">&gt;</span> <span class="dv">50000</span> <span class="cf">THEN</span></span>
<span id="cb744-19"><a aria-hidden="true" href="#cb744-19" tabindex="-1"></a>        v_category <span class="op">:=</span> <span class="st">'Mid-level'</span>;</span>
<span id="cb744-20"><a aria-hidden="true" href="#cb744-20" tabindex="-1"></a>    <span class="cf">ELSE</span></span>
<span id="cb744-21"><a aria-hidden="true" href="#cb744-21" tabindex="-1"></a>        v_category <span class="op">:=</span> <span class="st">'Junior'</span>;</span>
<span id="cb744-22"><a aria-hidden="true" href="#cb744-22" tabindex="-1"></a>    <span class="cf">END</span> <span class="cf">IF</span>;</span>
<span id="cb744-23"><a aria-hidden="true" href="#cb744-23" tabindex="-1"></a></span>
<span id="cb744-24"><a aria-hidden="true" href="#cb744-24" tabindex="-1"></a>    <span class="kw">RETURN</span> <span class="kw">QUERY</span> <span class="kw">SELECT</span> v_name, v_salary, v_category;</span>
<span id="cb744-25"><a aria-hidden="true" href="#cb744-25" tabindex="-1"></a><span class="cf">END</span>;</span>
<span id="cb744-26"><a aria-hidden="true" href="#cb744-26" tabindex="-1"></a>$$ LANGUAGE plpgsql;</span></code></pre></div>
<h3 data-number="13.3.3" id="loops-and-iteration"><span class="header-section-number">13.3.3</span> 3.3 Loops and Iteration</h3>
<div class="sourceCode" id="cb745"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb745-1"><a aria-hidden="true" href="#cb745-1" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">OR</span> <span class="kw">REPLACE</span> <span class="kw">FUNCTION</span> batch_update()</span>
<span id="cb745-2"><a aria-hidden="true" href="#cb745-2" tabindex="-1"></a>RETURNS void <span class="kw">AS</span> $$</span>
<span id="cb745-3"><a aria-hidden="true" href="#cb745-3" tabindex="-1"></a><span class="kw">DECLARE</span></span>
<span id="cb745-4"><a aria-hidden="true" href="#cb745-4" tabindex="-1"></a>    emp_record employees<span class="dt">%ROWTYPE</span>;</span>
<span id="cb745-5"><a aria-hidden="true" href="#cb745-5" tabindex="-1"></a><span class="cf">BEGIN</span></span>
<span id="cb745-6"><a aria-hidden="true" href="#cb745-6" tabindex="-1"></a>    <span class="co">-- Loop through all records</span></span>
<span id="cb745-7"><a aria-hidden="true" href="#cb745-7" tabindex="-1"></a>    <span class="cf">FOR</span> emp_record <span class="kw">IN</span> <span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> employees <span class="kw">WHERE</span> status <span class="op">=</span> <span class="st">'active'</span></span>
<span id="cb745-8"><a aria-hidden="true" href="#cb745-8" tabindex="-1"></a>    <span class="cf">LOOP</span></span>
<span id="cb745-9"><a aria-hidden="true" href="#cb745-9" tabindex="-1"></a>        <span class="kw">UPDATE</span> employees</span>
<span id="cb745-10"><a aria-hidden="true" href="#cb745-10" tabindex="-1"></a>        <span class="kw">SET</span> last_review <span class="op">=</span> <span class="fu">CURRENT_DATE</span></span>
<span id="cb745-11"><a aria-hidden="true" href="#cb745-11" tabindex="-1"></a>        <span class="kw">WHERE</span> employee_id <span class="op">=</span> emp_record.employee_id;</span>
<span id="cb745-12"><a aria-hidden="true" href="#cb745-12" tabindex="-1"></a>    <span class="cf">END</span> <span class="cf">LOOP</span>;</span>
<span id="cb745-13"><a aria-hidden="true" href="#cb745-13" tabindex="-1"></a><span class="cf">END</span>;</span>
<span id="cb745-14"><a aria-hidden="true" href="#cb745-14" tabindex="-1"></a>$$ LANGUAGE plpgsql;</span></code></pre></div>
<h3 data-number="13.3.4" id="error-handling-1"><span class="header-section-number">13.3.4</span> 3.4 Error Handling</h3>
<div class="sourceCode" id="cb746"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb746-1"><a aria-hidden="true" href="#cb746-1" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">OR</span> <span class="kw">REPLACE</span> <span class="kw">FUNCTION</span> safe_insert_user(</span>
<span id="cb746-2"><a aria-hidden="true" href="#cb746-2" tabindex="-1"></a>    p_name <span class="dt">varchar</span>,</span>
<span id="cb746-3"><a aria-hidden="true" href="#cb746-3" tabindex="-1"></a>    p_email <span class="dt">varchar</span></span>
<span id="cb746-4"><a aria-hidden="true" href="#cb746-4" tabindex="-1"></a>) RETURNS <span class="dt">int</span> <span class="kw">AS</span> $$</span>
<span id="cb746-5"><a aria-hidden="true" href="#cb746-5" tabindex="-1"></a><span class="kw">DECLARE</span></span>
<span id="cb746-6"><a aria-hidden="true" href="#cb746-6" tabindex="-1"></a>    v_user_id <span class="dt">int</span>;</span>
<span id="cb746-7"><a aria-hidden="true" href="#cb746-7" tabindex="-1"></a><span class="cf">BEGIN</span></span>
<span id="cb746-8"><a aria-hidden="true" href="#cb746-8" tabindex="-1"></a>    <span class="kw">INSERT</span> <span class="kw">INTO</span> users (name, email)</span>
<span id="cb746-9"><a aria-hidden="true" href="#cb746-9" tabindex="-1"></a>    <span class="kw">VALUES</span> (p_name, p_email)</span>
<span id="cb746-10"><a aria-hidden="true" href="#cb746-10" tabindex="-1"></a>    <span class="kw">RETURNING</span> user_id <span class="kw">INTO</span> v_user_id;</span>
<span id="cb746-11"><a aria-hidden="true" href="#cb746-11" tabindex="-1"></a></span>
<span id="cb746-12"><a aria-hidden="true" href="#cb746-12" tabindex="-1"></a>    <span class="kw">RETURN</span> v_user_id;</span>
<span id="cb746-13"><a aria-hidden="true" href="#cb746-13" tabindex="-1"></a><span class="kw">EXCEPTION</span></span>
<span id="cb746-14"><a aria-hidden="true" href="#cb746-14" tabindex="-1"></a>    <span class="cf">WHEN</span> unique_violation <span class="cf">THEN</span></span>
<span id="cb746-15"><a aria-hidden="true" href="#cb746-15" tabindex="-1"></a>        RAISE NOTICE <span class="st">'Email % already exists'</span>, p_email;</span>
<span id="cb746-16"><a aria-hidden="true" href="#cb746-16" tabindex="-1"></a>        <span class="kw">RETURN</span> <span class="op">-</span><span class="dv">1</span>;</span>
<span id="cb746-17"><a aria-hidden="true" href="#cb746-17" tabindex="-1"></a>    <span class="cf">WHEN</span> OTHERS <span class="cf">THEN</span></span>
<span id="cb746-18"><a aria-hidden="true" href="#cb746-18" tabindex="-1"></a>        RAISE NOTICE <span class="st">'Error: %'</span>, SQLERRM;</span>
<span id="cb746-19"><a aria-hidden="true" href="#cb746-19" tabindex="-1"></a>        <span class="kw">RETURN</span> <span class="op">-</span><span class="dv">1</span>;</span>
<span id="cb746-20"><a aria-hidden="true" href="#cb746-20" tabindex="-1"></a><span class="cf">END</span>;</span>
<span id="cb746-21"><a aria-hidden="true" href="#cb746-21" tabindex="-1"></a>$$ LANGUAGE plpgsql;</span></code></pre></div>
<hr/>
<h2 data-number="13.4" id="performance-features"><span class="header-section-number">13.4</span> 4. Performance Features</h2>
<h3 data-number="13.4.1" id="prepared-statements"><span class="header-section-number">13.4.1</span> 4.1 Prepared Statements</h3>
<p>Prepared statements compile once and execute multiple times,
improving performance for repeated queries:</p>
<div class="sourceCode" id="cb747"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb747-1"><a aria-hidden="true" href="#cb747-1" tabindex="-1"></a><span class="co">-- In application code (pseudo-code):</span></span>
<span id="cb747-2"><a aria-hidden="true" href="#cb747-2" tabindex="-1"></a><span class="kw">PREPARE</span> stmt_get_user <span class="kw">AS</span></span>
<span id="cb747-3"><a aria-hidden="true" href="#cb747-3" tabindex="-1"></a>    <span class="kw">SELECT</span> <span class="kw">id</span>, name, email <span class="kw">FROM</span> users <span class="kw">WHERE</span> <span class="kw">id</span> <span class="op">=</span> $<span class="dv">1</span>;</span>
<span id="cb747-4"><a aria-hidden="true" href="#cb747-4" tabindex="-1"></a></span>
<span id="cb747-5"><a aria-hidden="true" href="#cb747-5" tabindex="-1"></a><span class="kw">EXECUTE</span> stmt_get_user(<span class="dv">123</span>);</span>
<span id="cb747-6"><a aria-hidden="true" href="#cb747-6" tabindex="-1"></a><span class="kw">EXECUTE</span> stmt_get_user(<span class="dv">456</span>);</span>
<span id="cb747-7"><a aria-hidden="true" href="#cb747-7" tabindex="-1"></a></span>
<span id="cb747-8"><a aria-hidden="true" href="#cb747-8" tabindex="-1"></a><span class="co">-- Cleanup</span></span>
<span id="cb747-9"><a aria-hidden="true" href="#cb747-9" tabindex="-1"></a><span class="kw">DEALLOCATE</span> stmt_get_user;</span></code></pre></div>
<h4 data-number="13.4.1.1" id="prepared-statements-with-multiple-parameters"><span class="header-section-number">13.4.1.1</span> Prepared Statements with
Multiple Parameters</h4>
<div class="sourceCode" id="cb748"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb748-1"><a aria-hidden="true" href="#cb748-1" tabindex="-1"></a><span class="kw">PREPARE</span> insert_product (<span class="dt">varchar</span>, <span class="dt">numeric</span>, <span class="dt">int</span>) <span class="kw">AS</span></span>
<span id="cb748-2"><a aria-hidden="true" href="#cb748-2" tabindex="-1"></a>    <span class="kw">INSERT</span> <span class="kw">INTO</span> products (name, price, stock)</span>
<span id="cb748-3"><a aria-hidden="true" href="#cb748-3" tabindex="-1"></a>    <span class="kw">VALUES</span> ($<span class="dv">1</span>, $<span class="dv">2</span>, $<span class="dv">3</span>)</span>
<span id="cb748-4"><a aria-hidden="true" href="#cb748-4" tabindex="-1"></a>    <span class="kw">RETURNING</span> product_id;</span>
<span id="cb748-5"><a aria-hidden="true" href="#cb748-5" tabindex="-1"></a></span>
<span id="cb748-6"><a aria-hidden="true" href="#cb748-6" tabindex="-1"></a><span class="kw">EXECUTE</span> insert_product(<span class="st">'Widget'</span>, <span class="fl">19.99</span>, <span class="dv">100</span>);</span></code></pre></div>
<h3 data-number="13.4.2" id="query-hints-pattern-pg_hint_plan-extension"><span class="header-section-number">13.4.2</span> 4.2 Query Hints Pattern
(pg_hint_plan Extension)</h3>
<p>While PostgreSQL doesn‚Äôt have built-in query hints like some other
databases, the <code>pg_hint_plan</code> extension provides this
capability:</p>
<div class="sourceCode" id="cb749"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb749-1"><a aria-hidden="true" href="#cb749-1" tabindex="-1"></a><span class="co">-- Install extension</span></span>
<span id="cb749-2"><a aria-hidden="true" href="#cb749-2" tabindex="-1"></a><span class="kw">CREATE</span> EXTENSION pg_hint_plan;</span>
<span id="cb749-3"><a aria-hidden="true" href="#cb749-3" tabindex="-1"></a></span>
<span id="cb749-4"><a aria-hidden="true" href="#cb749-4" tabindex="-1"></a><span class="co">-- Example: Force index usage</span></span>
<span id="cb749-5"><a aria-hidden="true" href="#cb749-5" tabindex="-1"></a><span class="co">/*+ IndexScan(orders idx_orders_customer) */</span></span>
<span id="cb749-6"><a aria-hidden="true" href="#cb749-6" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> orders <span class="kw">WHERE</span> customer_id <span class="op">=</span> <span class="dv">123</span>;</span>
<span id="cb749-7"><a aria-hidden="true" href="#cb749-7" tabindex="-1"></a></span>
<span id="cb749-8"><a aria-hidden="true" href="#cb749-8" tabindex="-1"></a><span class="co">-- Force join method</span></span>
<span id="cb749-9"><a aria-hidden="true" href="#cb749-9" tabindex="-1"></a><span class="co">/*+ HashJoin(o c) */</span></span>
<span id="cb749-10"><a aria-hidden="true" href="#cb749-10" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> orders o</span>
<span id="cb749-11"><a aria-hidden="true" href="#cb749-11" tabindex="-1"></a><span class="kw">JOIN</span> customers c <span class="kw">ON</span> o.customer_id <span class="op">=</span> c.customer_id</span>
<span id="cb749-12"><a aria-hidden="true" href="#cb749-12" tabindex="-1"></a><span class="kw">WHERE</span> o.total <span class="op">&gt;</span> <span class="dv">1000</span>;</span>
<span id="cb749-13"><a aria-hidden="true" href="#cb749-13" tabindex="-1"></a></span>
<span id="cb749-14"><a aria-hidden="true" href="#cb749-14" tabindex="-1"></a><span class="co">-- Nested loop join</span></span>
<span id="cb749-15"><a aria-hidden="true" href="#cb749-15" tabindex="-1"></a><span class="co">/*+ NestLoop(o l) */</span></span>
<span id="cb749-16"><a aria-hidden="true" href="#cb749-16" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> orders o</span>
<span id="cb749-17"><a aria-hidden="true" href="#cb749-17" tabindex="-1"></a><span class="kw">JOIN</span> line_items l <span class="kw">ON</span> o.order_id <span class="op">=</span> l.order_id;</span></code></pre></div>
<h4 data-number="13.4.2.1" id="without-extensions-query-optimization"><span class="header-section-number">13.4.2.1</span> Without Extensions: Query
Optimization</h4>
<p>Use PostgreSQL‚Äôs native features for query optimization:</p>
<div class="sourceCode" id="cb750"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb750-1"><a aria-hidden="true" href="#cb750-1" tabindex="-1"></a><span class="co">-- Analyze table statistics</span></span>
<span id="cb750-2"><a aria-hidden="true" href="#cb750-2" tabindex="-1"></a><span class="kw">ANALYZE</span> products;</span>
<span id="cb750-3"><a aria-hidden="true" href="#cb750-3" tabindex="-1"></a></span>
<span id="cb750-4"><a aria-hidden="true" href="#cb750-4" tabindex="-1"></a><span class="co">-- Use EXPLAIN to understand query plans</span></span>
<span id="cb750-5"><a aria-hidden="true" href="#cb750-5" tabindex="-1"></a><span class="kw">EXPLAIN</span> (<span class="kw">ANALYZE</span>, BUFFERS)</span>
<span id="cb750-6"><a aria-hidden="true" href="#cb750-6" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> orders <span class="kw">WHERE</span> customer_id <span class="op">=</span> <span class="dv">123</span>;</span>
<span id="cb750-7"><a aria-hidden="true" href="#cb750-7" tabindex="-1"></a></span>
<span id="cb750-8"><a aria-hidden="true" href="#cb750-8" tabindex="-1"></a><span class="co">-- Check and rebuild indexes</span></span>
<span id="cb750-9"><a aria-hidden="true" href="#cb750-9" tabindex="-1"></a>REINDEX <span class="kw">TABLE</span> products;</span>
<span id="cb750-10"><a aria-hidden="true" href="#cb750-10" tabindex="-1"></a></span>
<span id="cb750-11"><a aria-hidden="true" href="#cb750-11" tabindex="-1"></a><span class="co">-- Force sequential scan (for comparison)</span></span>
<span id="cb750-12"><a aria-hidden="true" href="#cb750-12" tabindex="-1"></a><span class="kw">SET</span> enable_seqscan <span class="op">=</span> <span class="kw">off</span>;</span>
<span id="cb750-13"><a aria-hidden="true" href="#cb750-13" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> products <span class="kw">WHERE</span> price <span class="op">&gt;</span> <span class="dv">1000</span>;</span>
<span id="cb750-14"><a aria-hidden="true" href="#cb750-14" tabindex="-1"></a><span class="kw">RESET</span> enable_seqscan;</span></code></pre></div>
<hr/>
<h2 data-number="13.5" id="extensions-to-sql-standard"><span class="header-section-number">13.5</span> 5. Extensions to SQL
Standard</h2>
<h3 data-number="13.5.1" id="distinct-on"><span class="header-section-number">13.5.1</span> 5.1 DISTINCT ON</h3>
<p>PostgreSQL‚Äôs DISTINCT ON extension allows selecting distinct values
based on specific columns while keeping other columns:</p>
<div class="sourceCode" id="cb751"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb751-1"><a aria-hidden="true" href="#cb751-1" tabindex="-1"></a><span class="co">-- Standard DISTINCT (requires all columns in ORDER BY)</span></span>
<span id="cb751-2"><a aria-hidden="true" href="#cb751-2" tabindex="-1"></a><span class="kw">SELECT</span> <span class="kw">DISTINCT</span> <span class="kw">ON</span> (customer_id)</span>
<span id="cb751-3"><a aria-hidden="true" href="#cb751-3" tabindex="-1"></a>    customer_id,</span>
<span id="cb751-4"><a aria-hidden="true" href="#cb751-4" tabindex="-1"></a>    order_date,</span>
<span id="cb751-5"><a aria-hidden="true" href="#cb751-5" tabindex="-1"></a>    amount</span>
<span id="cb751-6"><a aria-hidden="true" href="#cb751-6" tabindex="-1"></a><span class="kw">FROM</span> orders</span>
<span id="cb751-7"><a aria-hidden="true" href="#cb751-7" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> customer_id, order_date <span class="kw">DESC</span>;</span>
<span id="cb751-8"><a aria-hidden="true" href="#cb751-8" tabindex="-1"></a></span>
<span id="cb751-9"><a aria-hidden="true" href="#cb751-9" tabindex="-1"></a><span class="co">-- Returns one order per customer (most recent)</span></span>
<span id="cb751-10"><a aria-hidden="true" href="#cb751-10" tabindex="-1"></a><span class="co">-- Standard SQL would be more complex</span></span>
<span id="cb751-11"><a aria-hidden="true" href="#cb751-11" tabindex="-1"></a></span>
<span id="cb751-12"><a aria-hidden="true" href="#cb751-12" tabindex="-1"></a><span class="co">-- With DISTINCT ON and multiple columns</span></span>
<span id="cb751-13"><a aria-hidden="true" href="#cb751-13" tabindex="-1"></a><span class="kw">SELECT</span> <span class="kw">DISTINCT</span> <span class="kw">ON</span> (<span class="kw">category</span>, subcategory)</span>
<span id="cb751-14"><a aria-hidden="true" href="#cb751-14" tabindex="-1"></a>    <span class="kw">category</span>,</span>
<span id="cb751-15"><a aria-hidden="true" href="#cb751-15" tabindex="-1"></a>    subcategory,</span>
<span id="cb751-16"><a aria-hidden="true" href="#cb751-16" tabindex="-1"></a>    product_id,</span>
<span id="cb751-17"><a aria-hidden="true" href="#cb751-17" tabindex="-1"></a>    price</span>
<span id="cb751-18"><a aria-hidden="true" href="#cb751-18" tabindex="-1"></a><span class="kw">FROM</span> products</span>
<span id="cb751-19"><a aria-hidden="true" href="#cb751-19" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> <span class="kw">category</span>, subcategory, price <span class="kw">DESC</span>;</span></code></pre></div>
<h4 data-number="13.5.1.1" id="use-cases"><span class="header-section-number">13.5.1.1</span> Use Cases</h4>
<div class="sourceCode" id="cb752"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb752-1"><a aria-hidden="true" href="#cb752-1" tabindex="-1"></a><span class="co">-- Latest record per group</span></span>
<span id="cb752-2"><a aria-hidden="true" href="#cb752-2" tabindex="-1"></a><span class="kw">SELECT</span> <span class="kw">DISTINCT</span> <span class="kw">ON</span> (user_id)</span>
<span id="cb752-3"><a aria-hidden="true" href="#cb752-3" tabindex="-1"></a>    user_id,</span>
<span id="cb752-4"><a aria-hidden="true" href="#cb752-4" tabindex="-1"></a>    login_timestamp,</span>
<span id="cb752-5"><a aria-hidden="true" href="#cb752-5" tabindex="-1"></a>    ip_address</span>
<span id="cb752-6"><a aria-hidden="true" href="#cb752-6" tabindex="-1"></a><span class="kw">FROM</span> user_logins</span>
<span id="cb752-7"><a aria-hidden="true" href="#cb752-7" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> user_id, login_timestamp <span class="kw">DESC</span>;</span>
<span id="cb752-8"><a aria-hidden="true" href="#cb752-8" tabindex="-1"></a></span>
<span id="cb752-9"><a aria-hidden="true" href="#cb752-9" tabindex="-1"></a><span class="co">-- First occurrence per group</span></span>
<span id="cb752-10"><a aria-hidden="true" href="#cb752-10" tabindex="-1"></a><span class="kw">SELECT</span> <span class="kw">DISTINCT</span> <span class="kw">ON</span> (product_category)</span>
<span id="cb752-11"><a aria-hidden="true" href="#cb752-11" tabindex="-1"></a>    product_id,</span>
<span id="cb752-12"><a aria-hidden="true" href="#cb752-12" tabindex="-1"></a>    product_category,</span>
<span id="cb752-13"><a aria-hidden="true" href="#cb752-13" tabindex="-1"></a>    launch_date</span>
<span id="cb752-14"><a aria-hidden="true" href="#cb752-14" tabindex="-1"></a><span class="kw">FROM</span> products</span>
<span id="cb752-15"><a aria-hidden="true" href="#cb752-15" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> product_category, launch_date <span class="kw">ASC</span>;</span></code></pre></div>
<h3 data-number="13.5.2" id="returning-clause"><span class="header-section-number">13.5.2</span> 5.2 RETURNING Clause</h3>
<p>RETURNING returns affected rows from INSERT, UPDATE, DELETE, or
UPSERT operations:</p>
<h4 data-number="13.5.2.1" id="with-insert"><span class="header-section-number">13.5.2.1</span> With INSERT</h4>
<div class="sourceCode" id="cb753"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb753-1"><a aria-hidden="true" href="#cb753-1" tabindex="-1"></a><span class="co">-- Return generated ID</span></span>
<span id="cb753-2"><a aria-hidden="true" href="#cb753-2" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> users (name, email)</span>
<span id="cb753-3"><a aria-hidden="true" href="#cb753-3" tabindex="-1"></a><span class="kw">VALUES</span> (<span class="st">'Alice'</span>, <span class="st">'alice@example.com'</span>)</span>
<span id="cb753-4"><a aria-hidden="true" href="#cb753-4" tabindex="-1"></a><span class="kw">RETURNING</span> user_id, name, created_at;</span>
<span id="cb753-5"><a aria-hidden="true" href="#cb753-5" tabindex="-1"></a></span>
<span id="cb753-6"><a aria-hidden="true" href="#cb753-6" tabindex="-1"></a><span class="co">-- Return multiple rows</span></span>
<span id="cb753-7"><a aria-hidden="true" href="#cb753-7" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> products (name, price)</span>
<span id="cb753-8"><a aria-hidden="true" href="#cb753-8" tabindex="-1"></a><span class="kw">VALUES</span></span>
<span id="cb753-9"><a aria-hidden="true" href="#cb753-9" tabindex="-1"></a>    (<span class="st">'Widget'</span>, <span class="fl">9.99</span>),</span>
<span id="cb753-10"><a aria-hidden="true" href="#cb753-10" tabindex="-1"></a>    (<span class="st">'Gadget'</span>, <span class="fl">19.99</span>),</span>
<span id="cb753-11"><a aria-hidden="true" href="#cb753-11" tabindex="-1"></a>    (<span class="st">'Gizmo'</span>, <span class="fl">14.99</span>)</span>
<span id="cb753-12"><a aria-hidden="true" href="#cb753-12" tabindex="-1"></a><span class="kw">RETURNING</span> product_id, name;</span></code></pre></div>
<h4 data-number="13.5.2.2" id="with-update"><span class="header-section-number">13.5.2.2</span> With UPDATE</h4>
<div class="sourceCode" id="cb754"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb754-1"><a aria-hidden="true" href="#cb754-1" tabindex="-1"></a><span class="co">-- Track what was changed</span></span>
<span id="cb754-2"><a aria-hidden="true" href="#cb754-2" tabindex="-1"></a><span class="kw">UPDATE</span> employees</span>
<span id="cb754-3"><a aria-hidden="true" href="#cb754-3" tabindex="-1"></a><span class="kw">SET</span> salary <span class="op">=</span> salary <span class="op">*</span> <span class="fl">1.1</span></span>
<span id="cb754-4"><a aria-hidden="true" href="#cb754-4" tabindex="-1"></a><span class="kw">WHERE</span> department_id <span class="op">=</span> <span class="dv">5</span></span>
<span id="cb754-5"><a aria-hidden="true" href="#cb754-5" tabindex="-1"></a><span class="kw">RETURNING</span> employee_id, name, salary;</span>
<span id="cb754-6"><a aria-hidden="true" href="#cb754-6" tabindex="-1"></a></span>
<span id="cb754-7"><a aria-hidden="true" href="#cb754-7" tabindex="-1"></a><span class="co">-- Atomic read-modify-write</span></span>
<span id="cb754-8"><a aria-hidden="true" href="#cb754-8" tabindex="-1"></a><span class="kw">UPDATE</span> account_balance</span>
<span id="cb754-9"><a aria-hidden="true" href="#cb754-9" tabindex="-1"></a><span class="kw">SET</span> balance <span class="op">=</span> balance <span class="op">-</span> <span class="dv">100</span></span>
<span id="cb754-10"><a aria-hidden="true" href="#cb754-10" tabindex="-1"></a><span class="kw">WHERE</span> account_id <span class="op">=</span> <span class="dv">123</span></span>
<span id="cb754-11"><a aria-hidden="true" href="#cb754-11" tabindex="-1"></a><span class="kw">RETURNING</span> balance;</span></code></pre></div>
<h4 data-number="13.5.2.3" id="with-delete"><span class="header-section-number">13.5.2.3</span> With DELETE</h4>
<div class="sourceCode" id="cb755"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb755-1"><a aria-hidden="true" href="#cb755-1" tabindex="-1"></a><span class="co">-- Archive deleted records</span></span>
<span id="cb755-2"><a aria-hidden="true" href="#cb755-2" tabindex="-1"></a><span class="kw">WITH</span> deleted_orders <span class="kw">AS</span> (</span>
<span id="cb755-3"><a aria-hidden="true" href="#cb755-3" tabindex="-1"></a>    <span class="kw">DELETE</span> <span class="kw">FROM</span> orders</span>
<span id="cb755-4"><a aria-hidden="true" href="#cb755-4" tabindex="-1"></a>    <span class="kw">WHERE</span> created_at <span class="op">&lt;</span> <span class="fu">CURRENT_DATE</span> <span class="op">-</span> <span class="dt">INTERVAL</span> <span class="st">'1 year'</span></span>
<span id="cb755-5"><a aria-hidden="true" href="#cb755-5" tabindex="-1"></a>    <span class="kw">RETURNING</span> <span class="op">*</span></span>
<span id="cb755-6"><a aria-hidden="true" href="#cb755-6" tabindex="-1"></a>)</span>
<span id="cb755-7"><a aria-hidden="true" href="#cb755-7" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> archived_orders</span>
<span id="cb755-8"><a aria-hidden="true" href="#cb755-8" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> deleted_orders;</span></code></pre></div>
<h3 data-number="13.5.3" id="insert-on-conflict-upsert"><span class="header-section-number">13.5.3</span> 5.3 INSERT ‚Ä¶ ON CONFLICT
(UPSERT)</h3>
<p>PostgreSQL‚Äôs INSERT ‚Ä¶ ON CONFLICT provides upsert functionality
(SQL:2015 standard):</p>
<h4 data-number="13.5.3.1" id="basic-upsert"><span class="header-section-number">13.5.3.1</span> Basic UPSERT</h4>
<div class="sourceCode" id="cb756"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb756-1"><a aria-hidden="true" href="#cb756-1" tabindex="-1"></a><span class="co">-- Update on conflict with unique constraint</span></span>
<span id="cb756-2"><a aria-hidden="true" href="#cb756-2" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> users (email, name, updated_at)</span>
<span id="cb756-3"><a aria-hidden="true" href="#cb756-3" tabindex="-1"></a><span class="kw">VALUES</span> (<span class="st">'alice@example.com'</span>, <span class="st">'Alice Smith'</span>, <span class="fu">CURRENT_TIMESTAMP</span>)</span>
<span id="cb756-4"><a aria-hidden="true" href="#cb756-4" tabindex="-1"></a><span class="kw">ON</span> CONFLICT (email)</span>
<span id="cb756-5"><a aria-hidden="true" href="#cb756-5" tabindex="-1"></a>DO <span class="kw">UPDATE</span> <span class="kw">SET</span></span>
<span id="cb756-6"><a aria-hidden="true" href="#cb756-6" tabindex="-1"></a>    name <span class="op">=</span> EXCLUDED.name,</span>
<span id="cb756-7"><a aria-hidden="true" href="#cb756-7" tabindex="-1"></a>    updated_at <span class="op">=</span> EXCLUDED.updated_at;</span></code></pre></div>
<h4 data-number="13.5.3.2" id="conflict-resolution-strategies"><span class="header-section-number">13.5.3.2</span> Conflict Resolution
Strategies</h4>
<div class="sourceCode" id="cb757"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb757-1"><a aria-hidden="true" href="#cb757-1" tabindex="-1"></a><span class="co">-- Strategy 1: DO NOTHING</span></span>
<span id="cb757-2"><a aria-hidden="true" href="#cb757-2" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> unique_tags (tag_name)</span>
<span id="cb757-3"><a aria-hidden="true" href="#cb757-3" tabindex="-1"></a><span class="kw">VALUES</span> (<span class="st">'new-tag'</span>)</span>
<span id="cb757-4"><a aria-hidden="true" href="#cb757-4" tabindex="-1"></a><span class="kw">ON</span> CONFLICT (tag_name) DO <span class="kw">NOTHING</span>;</span>
<span id="cb757-5"><a aria-hidden="true" href="#cb757-5" tabindex="-1"></a></span>
<span id="cb757-6"><a aria-hidden="true" href="#cb757-6" tabindex="-1"></a><span class="co">-- Strategy 2: DO UPDATE with conditions</span></span>
<span id="cb757-7"><a aria-hidden="true" href="#cb757-7" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> user_sessions (user_id, session_token, expires_at)</span>
<span id="cb757-8"><a aria-hidden="true" href="#cb757-8" tabindex="-1"></a><span class="kw">VALUES</span> (<span class="dv">123</span>, <span class="st">'token_abc'</span>, <span class="fu">CURRENT_TIMESTAMP</span> <span class="op">+</span> <span class="dt">INTERVAL</span> <span class="st">'1 day'</span>)</span>
<span id="cb757-9"><a aria-hidden="true" href="#cb757-9" tabindex="-1"></a><span class="kw">ON</span> CONFLICT (user_id) DO <span class="kw">UPDATE</span> <span class="kw">SET</span></span>
<span id="cb757-10"><a aria-hidden="true" href="#cb757-10" tabindex="-1"></a>    session_token <span class="op">=</span> EXCLUDED.session_token,</span>
<span id="cb757-11"><a aria-hidden="true" href="#cb757-11" tabindex="-1"></a>    expires_at <span class="op">=</span> EXCLUDED.expires_at</span>
<span id="cb757-12"><a aria-hidden="true" href="#cb757-12" tabindex="-1"></a><span class="kw">WHERE</span> users_sessions.expires_at <span class="op">&lt;</span> <span class="fu">CURRENT_TIMESTAMP</span>;</span></code></pre></div>
<h4 data-number="13.5.3.3" id="multiple-conflict-targets"><span class="header-section-number">13.5.3.3</span> Multiple Conflict
Targets</h4>
<div class="sourceCode" id="cb758"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb758-1"><a aria-hidden="true" href="#cb758-1" tabindex="-1"></a><span class="co">-- Conflict on multiple columns</span></span>
<span id="cb758-2"><a aria-hidden="true" href="#cb758-2" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> user_preferences (user_id, preference_key, preference_value)</span>
<span id="cb758-3"><a aria-hidden="true" href="#cb758-3" tabindex="-1"></a><span class="kw">VALUES</span> (<span class="dv">1</span>, <span class="st">'theme'</span>, <span class="st">'dark'</span>)</span>
<span id="cb758-4"><a aria-hidden="true" href="#cb758-4" tabindex="-1"></a><span class="kw">ON</span> CONFLICT (user_id, preference_key)</span>
<span id="cb758-5"><a aria-hidden="true" href="#cb758-5" tabindex="-1"></a>DO <span class="kw">UPDATE</span> <span class="kw">SET</span></span>
<span id="cb758-6"><a aria-hidden="true" href="#cb758-6" tabindex="-1"></a>    preference_value <span class="op">=</span> EXCLUDED.preference_value,</span>
<span id="cb758-7"><a aria-hidden="true" href="#cb758-7" tabindex="-1"></a>    updated_at <span class="op">=</span> <span class="fu">CURRENT_TIMESTAMP</span>;</span></code></pre></div>
<h4 data-number="13.5.3.4" id="using-excluded"><span class="header-section-number">13.5.3.4</span> Using EXCLUDED</h4>
<div class="sourceCode" id="cb759"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb759-1"><a aria-hidden="true" href="#cb759-1" tabindex="-1"></a><span class="co">-- EXCLUDED references the proposed row values</span></span>
<span id="cb759-2"><a aria-hidden="true" href="#cb759-2" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> products (sku, name, price, last_updated)</span>
<span id="cb759-3"><a aria-hidden="true" href="#cb759-3" tabindex="-1"></a><span class="kw">VALUES</span> (<span class="st">'SKU-123'</span>, <span class="st">'Widget'</span>, <span class="fl">29.99</span>, <span class="fu">CURRENT_TIMESTAMP</span>)</span>
<span id="cb759-4"><a aria-hidden="true" href="#cb759-4" tabindex="-1"></a><span class="kw">ON</span> CONFLICT (sku)</span>
<span id="cb759-5"><a aria-hidden="true" href="#cb759-5" tabindex="-1"></a>DO <span class="kw">UPDATE</span> <span class="kw">SET</span></span>
<span id="cb759-6"><a aria-hidden="true" href="#cb759-6" tabindex="-1"></a>    name <span class="op">=</span> EXCLUDED.name,</span>
<span id="cb759-7"><a aria-hidden="true" href="#cb759-7" tabindex="-1"></a>    price <span class="op">=</span> EXCLUDED.price,</span>
<span id="cb759-8"><a aria-hidden="true" href="#cb759-8" tabindex="-1"></a>    last_updated <span class="op">=</span> EXCLUDED.last_updated</span>
<span id="cb759-9"><a aria-hidden="true" href="#cb759-9" tabindex="-1"></a><span class="kw">WHERE</span> products.price <span class="op">!=</span> EXCLUDED.price;  <span class="co">-- Only update if price changed</span></span></code></pre></div>
<h4 data-number="13.5.3.5" id="bulk-upsert-pattern"><span class="header-section-number">13.5.3.5</span> Bulk Upsert Pattern</h4>
<div class="sourceCode" id="cb760"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb760-1"><a aria-hidden="true" href="#cb760-1" tabindex="-1"></a><span class="co">-- Efficient bulk upsert</span></span>
<span id="cb760-2"><a aria-hidden="true" href="#cb760-2" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> users (email, name, verified_at)</span>
<span id="cb760-3"><a aria-hidden="true" href="#cb760-3" tabindex="-1"></a><span class="kw">VALUES</span></span>
<span id="cb760-4"><a aria-hidden="true" href="#cb760-4" tabindex="-1"></a>    (<span class="st">'alice@example.com'</span>, <span class="st">'Alice'</span>, <span class="fu">CURRENT_TIMESTAMP</span>),</span>
<span id="cb760-5"><a aria-hidden="true" href="#cb760-5" tabindex="-1"></a>    (<span class="st">'bob@example.com'</span>, <span class="st">'Bob'</span>, <span class="kw">NULL</span>),</span>
<span id="cb760-6"><a aria-hidden="true" href="#cb760-6" tabindex="-1"></a>    (<span class="st">'charlie@example.com'</span>, <span class="st">'Charlie'</span>, <span class="fu">CURRENT_TIMESTAMP</span>)</span>
<span id="cb760-7"><a aria-hidden="true" href="#cb760-7" tabindex="-1"></a><span class="kw">ON</span> CONFLICT (email)</span>
<span id="cb760-8"><a aria-hidden="true" href="#cb760-8" tabindex="-1"></a>DO <span class="kw">UPDATE</span> <span class="kw">SET</span></span>
<span id="cb760-9"><a aria-hidden="true" href="#cb760-9" tabindex="-1"></a>    name <span class="op">=</span> EXCLUDED.name,</span>
<span id="cb760-10"><a aria-hidden="true" href="#cb760-10" tabindex="-1"></a>    verified_at <span class="op">=</span> <span class="fu">COALESCE</span>(users.verified_at, EXCLUDED.verified_at);</span></code></pre></div>
<hr/>
<h2 data-number="13.6" id="advanced-query-patterns"><span class="header-section-number">13.6</span> 6. Advanced Query
Patterns</h2>
<h3 data-number="13.6.1" id="cte-with-window-functions"><span class="header-section-number">13.6.1</span> 6.1 CTE with Window
Functions</h3>
<p>Combine CTEs with window functions for powerful analytical
queries:</p>
<div class="sourceCode" id="cb761"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb761-1"><a aria-hidden="true" href="#cb761-1" tabindex="-1"></a><span class="kw">WITH</span> ranked_sales <span class="kw">AS</span> (</span>
<span id="cb761-2"><a aria-hidden="true" href="#cb761-2" tabindex="-1"></a>    <span class="kw">SELECT</span></span>
<span id="cb761-3"><a aria-hidden="true" href="#cb761-3" tabindex="-1"></a>        sales_date,</span>
<span id="cb761-4"><a aria-hidden="true" href="#cb761-4" tabindex="-1"></a>        amount,</span>
<span id="cb761-5"><a aria-hidden="true" href="#cb761-5" tabindex="-1"></a>        <span class="fu">ROW_NUMBER</span>() <span class="kw">OVER</span> (<span class="kw">ORDER</span> <span class="kw">BY</span> amount <span class="kw">DESC</span>) <span class="kw">as</span> <span class="fu">rank</span>,</span>
<span id="cb761-6"><a aria-hidden="true" href="#cb761-6" tabindex="-1"></a>        <span class="fu">PERCENT_RANK</span>() <span class="kw">OVER</span> (<span class="kw">ORDER</span> <span class="kw">BY</span> amount <span class="kw">DESC</span>) <span class="kw">as</span> pct_rank</span>
<span id="cb761-7"><a aria-hidden="true" href="#cb761-7" tabindex="-1"></a>    <span class="kw">FROM</span> sales</span>
<span id="cb761-8"><a aria-hidden="true" href="#cb761-8" tabindex="-1"></a>),</span>
<span id="cb761-9"><a aria-hidden="true" href="#cb761-9" tabindex="-1"></a>quartiles <span class="kw">AS</span> (</span>
<span id="cb761-10"><a aria-hidden="true" href="#cb761-10" tabindex="-1"></a>    <span class="kw">SELECT</span></span>
<span id="cb761-11"><a aria-hidden="true" href="#cb761-11" tabindex="-1"></a>        amount,</span>
<span id="cb761-12"><a aria-hidden="true" href="#cb761-12" tabindex="-1"></a>        <span class="fu">NTILE</span>(<span class="dv">4</span>) <span class="kw">OVER</span> (<span class="kw">ORDER</span> <span class="kw">BY</span> amount) <span class="kw">as</span> quartile</span>
<span id="cb761-13"><a aria-hidden="true" href="#cb761-13" tabindex="-1"></a>    <span class="kw">FROM</span> sales</span>
<span id="cb761-14"><a aria-hidden="true" href="#cb761-14" tabindex="-1"></a>)</span>
<span id="cb761-15"><a aria-hidden="true" href="#cb761-15" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb761-16"><a aria-hidden="true" href="#cb761-16" tabindex="-1"></a>    rs.sales_date,</span>
<span id="cb761-17"><a aria-hidden="true" href="#cb761-17" tabindex="-1"></a>    rs.amount,</span>
<span id="cb761-18"><a aria-hidden="true" href="#cb761-18" tabindex="-1"></a>    rs.<span class="fu">rank</span>,</span>
<span id="cb761-19"><a aria-hidden="true" href="#cb761-19" tabindex="-1"></a>    <span class="fu">ROUND</span>(rs.pct_rank <span class="op">*</span> <span class="dv">100</span>, <span class="dv">2</span>) <span class="kw">as</span> pct_rank,</span>
<span id="cb761-20"><a aria-hidden="true" href="#cb761-20" tabindex="-1"></a>    q.quartile</span>
<span id="cb761-21"><a aria-hidden="true" href="#cb761-21" tabindex="-1"></a><span class="kw">FROM</span> ranked_sales rs</span>
<span id="cb761-22"><a aria-hidden="true" href="#cb761-22" tabindex="-1"></a><span class="kw">JOIN</span> quartiles q <span class="kw">ON</span> rs.amount <span class="op">=</span> q.amount</span>
<span id="cb761-23"><a aria-hidden="true" href="#cb761-23" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> rs.<span class="fu">rank</span></span>
<span id="cb761-24"><a aria-hidden="true" href="#cb761-24" tabindex="-1"></a><span class="kw">LIMIT</span> <span class="dv">10</span>;</span></code></pre></div>
<h3 data-number="13.6.2" id="json-aggregation-with-complex-structures"><span class="header-section-number">13.6.2</span> 6.2 JSON Aggregation with
Complex Structures</h3>
<div class="sourceCode" id="cb762"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb762-1"><a aria-hidden="true" href="#cb762-1" tabindex="-1"></a><span class="co">-- Build hierarchical JSON structures</span></span>
<span id="cb762-2"><a aria-hidden="true" href="#cb762-2" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb762-3"><a aria-hidden="true" href="#cb762-3" tabindex="-1"></a>    c.customer_id,</span>
<span id="cb762-4"><a aria-hidden="true" href="#cb762-4" tabindex="-1"></a>    c.name,</span>
<span id="cb762-5"><a aria-hidden="true" href="#cb762-5" tabindex="-1"></a>    jsonb_agg(</span>
<span id="cb762-6"><a aria-hidden="true" href="#cb762-6" tabindex="-1"></a>        jsonb_build_object(</span>
<span id="cb762-7"><a aria-hidden="true" href="#cb762-7" tabindex="-1"></a>            <span class="st">'order_id'</span>, o.order_id,</span>
<span id="cb762-8"><a aria-hidden="true" href="#cb762-8" tabindex="-1"></a>            <span class="st">'order_date'</span>, o.order_date,</span>
<span id="cb762-9"><a aria-hidden="true" href="#cb762-9" tabindex="-1"></a>            <span class="st">'total'</span>, o.total,</span>
<span id="cb762-10"><a aria-hidden="true" href="#cb762-10" tabindex="-1"></a>            <span class="st">'items'</span>, (</span>
<span id="cb762-11"><a aria-hidden="true" href="#cb762-11" tabindex="-1"></a>                <span class="kw">SELECT</span> jsonb_agg(</span>
<span id="cb762-12"><a aria-hidden="true" href="#cb762-12" tabindex="-1"></a>                    jsonb_build_object(</span>
<span id="cb762-13"><a aria-hidden="true" href="#cb762-13" tabindex="-1"></a>                        <span class="st">'product_id'</span>, oi.product_id,</span>
<span id="cb762-14"><a aria-hidden="true" href="#cb762-14" tabindex="-1"></a>                        <span class="st">'quantity'</span>, oi.quantity,</span>
<span id="cb762-15"><a aria-hidden="true" href="#cb762-15" tabindex="-1"></a>                        <span class="st">'price'</span>, oi.unit_price</span>
<span id="cb762-16"><a aria-hidden="true" href="#cb762-16" tabindex="-1"></a>                    )</span>
<span id="cb762-17"><a aria-hidden="true" href="#cb762-17" tabindex="-1"></a>                )</span>
<span id="cb762-18"><a aria-hidden="true" href="#cb762-18" tabindex="-1"></a>                <span class="kw">FROM</span> order_items oi</span>
<span id="cb762-19"><a aria-hidden="true" href="#cb762-19" tabindex="-1"></a>                <span class="kw">WHERE</span> oi.order_id <span class="op">=</span> o.order_id</span>
<span id="cb762-20"><a aria-hidden="true" href="#cb762-20" tabindex="-1"></a>            )</span>
<span id="cb762-21"><a aria-hidden="true" href="#cb762-21" tabindex="-1"></a>        ) <span class="kw">ORDER</span> <span class="kw">BY</span> o.order_date <span class="kw">DESC</span></span>
<span id="cb762-22"><a aria-hidden="true" href="#cb762-22" tabindex="-1"></a>    ) <span class="kw">as</span> orders</span>
<span id="cb762-23"><a aria-hidden="true" href="#cb762-23" tabindex="-1"></a><span class="kw">FROM</span> customers c</span>
<span id="cb762-24"><a aria-hidden="true" href="#cb762-24" tabindex="-1"></a><span class="kw">LEFT</span> <span class="kw">JOIN</span> orders o <span class="kw">ON</span> c.customer_id <span class="op">=</span> o.customer_id</span>
<span id="cb762-25"><a aria-hidden="true" href="#cb762-25" tabindex="-1"></a><span class="kw">GROUP</span> <span class="kw">BY</span> c.customer_id, c.name;</span></code></pre></div>
<h3 data-number="13.6.3" id="recursive-cte-for-path-finding"><span class="header-section-number">13.6.3</span> 6.3 Recursive CTE for Path
Finding</h3>
<div class="sourceCode" id="cb763"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb763-1"><a aria-hidden="true" href="#cb763-1" tabindex="-1"></a><span class="co">-- Find shortest path in a graph</span></span>
<span id="cb763-2"><a aria-hidden="true" href="#cb763-2" tabindex="-1"></a><span class="kw">WITH</span> RECURSIVE path_search <span class="kw">AS</span> (</span>
<span id="cb763-3"><a aria-hidden="true" href="#cb763-3" tabindex="-1"></a>    <span class="co">-- Start node</span></span>
<span id="cb763-4"><a aria-hidden="true" href="#cb763-4" tabindex="-1"></a>    <span class="kw">SELECT</span></span>
<span id="cb763-5"><a aria-hidden="true" href="#cb763-5" tabindex="-1"></a>        node_id,</span>
<span id="cb763-6"><a aria-hidden="true" href="#cb763-6" tabindex="-1"></a>        target_id,</span>
<span id="cb763-7"><a aria-hidden="true" href="#cb763-7" tabindex="-1"></a>        <span class="dt">ARRAY</span>[node_id, target_id] <span class="kw">as</span> path,</span>
<span id="cb763-8"><a aria-hidden="true" href="#cb763-8" tabindex="-1"></a>        <span class="dv">1</span> <span class="kw">as</span> distance</span>
<span id="cb763-9"><a aria-hidden="true" href="#cb763-9" tabindex="-1"></a>    <span class="kw">FROM</span> edges</span>
<span id="cb763-10"><a aria-hidden="true" href="#cb763-10" tabindex="-1"></a>    <span class="kw">WHERE</span> node_id <span class="op">=</span> <span class="st">'START'</span></span>
<span id="cb763-11"><a aria-hidden="true" href="#cb763-11" tabindex="-1"></a></span>
<span id="cb763-12"><a aria-hidden="true" href="#cb763-12" tabindex="-1"></a>    <span class="kw">UNION</span> <span class="kw">ALL</span></span>
<span id="cb763-13"><a aria-hidden="true" href="#cb763-13" tabindex="-1"></a></span>
<span id="cb763-14"><a aria-hidden="true" href="#cb763-14" tabindex="-1"></a>    <span class="co">-- Extend path</span></span>
<span id="cb763-15"><a aria-hidden="true" href="#cb763-15" tabindex="-1"></a>    <span class="kw">SELECT</span></span>
<span id="cb763-16"><a aria-hidden="true" href="#cb763-16" tabindex="-1"></a>        ps.node_id,</span>
<span id="cb763-17"><a aria-hidden="true" href="#cb763-17" tabindex="-1"></a>        e.target_id,</span>
<span id="cb763-18"><a aria-hidden="true" href="#cb763-18" tabindex="-1"></a>        ps.path <span class="op">||</span> e.target_id,</span>
<span id="cb763-19"><a aria-hidden="true" href="#cb763-19" tabindex="-1"></a>        ps.distance <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb763-20"><a aria-hidden="true" href="#cb763-20" tabindex="-1"></a>    <span class="kw">FROM</span> path_search ps</span>
<span id="cb763-21"><a aria-hidden="true" href="#cb763-21" tabindex="-1"></a>    <span class="kw">JOIN</span> edges e <span class="kw">ON</span> ps.target_id <span class="op">=</span> e.node_id</span>
<span id="cb763-22"><a aria-hidden="true" href="#cb763-22" tabindex="-1"></a>    <span class="kw">WHERE</span> <span class="kw">NOT</span> e.target_id <span class="op">=</span> <span class="kw">ANY</span>(ps.path)  <span class="co">-- Avoid cycles</span></span>
<span id="cb763-23"><a aria-hidden="true" href="#cb763-23" tabindex="-1"></a>        <span class="kw">AND</span> ps.distance <span class="op">&lt;</span> <span class="dv">10</span></span>
<span id="cb763-24"><a aria-hidden="true" href="#cb763-24" tabindex="-1"></a>)</span>
<span id="cb763-25"><a aria-hidden="true" href="#cb763-25" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> path_search</span>
<span id="cb763-26"><a aria-hidden="true" href="#cb763-26" tabindex="-1"></a><span class="kw">WHERE</span> target_id <span class="op">=</span> <span class="st">'END'</span></span>
<span id="cb763-27"><a aria-hidden="true" href="#cb763-27" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> distance</span>
<span id="cb763-28"><a aria-hidden="true" href="#cb763-28" tabindex="-1"></a><span class="kw">LIMIT</span> <span class="dv">1</span>;</span></code></pre></div>
<hr/>
<h2 data-number="13.7" id="performance-considerations-3"><span class="header-section-number">13.7</span> 7. Performance
Considerations</h2>
<h3 data-number="13.7.1" id="index-selection-for-advanced-features"><span class="header-section-number">13.7.1</span> 7.1 Index Selection for
Advanced Features</h3>
<div class="sourceCode" id="cb764"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb764-1"><a aria-hidden="true" href="#cb764-1" tabindex="-1"></a><span class="co">-- GIN index for JSON containment queries</span></span>
<span id="cb764-2"><a aria-hidden="true" href="#cb764-2" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_config_data <span class="kw">ON</span> config_jsonb <span class="kw">USING</span> GIN (<span class="kw">data</span>);</span>
<span id="cb764-3"><a aria-hidden="true" href="#cb764-3" tabindex="-1"></a></span>
<span id="cb764-4"><a aria-hidden="true" href="#cb764-4" tabindex="-1"></a><span class="co">-- Expression index for computed columns</span></span>
<span id="cb764-5"><a aria-hidden="true" href="#cb764-5" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_lower_email <span class="kw">ON</span> users (<span class="fu">LOWER</span>(email));</span>
<span id="cb764-6"><a aria-hidden="true" href="#cb764-6" tabindex="-1"></a></span>
<span id="cb764-7"><a aria-hidden="true" href="#cb764-7" tabindex="-1"></a><span class="co">-- BRIN index for large tables with natural ordering</span></span>
<span id="cb764-8"><a aria-hidden="true" href="#cb764-8" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_events_timestamp <span class="kw">ON</span> <span class="kw">events</span> <span class="kw">USING</span> BRIN (<span class="dt">timestamp</span>);</span>
<span id="cb764-9"><a aria-hidden="true" href="#cb764-9" tabindex="-1"></a></span>
<span id="cb764-10"><a aria-hidden="true" href="#cb764-10" tabindex="-1"></a><span class="co">-- Partial index for filtered queries</span></span>
<span id="cb764-11"><a aria-hidden="true" href="#cb764-11" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_active_users <span class="kw">ON</span> users (user_id)</span>
<span id="cb764-12"><a aria-hidden="true" href="#cb764-12" tabindex="-1"></a><span class="kw">WHERE</span> status <span class="op">=</span> <span class="st">'active'</span>;</span></code></pre></div>
<h3 data-number="13.7.2" id="query-planning-for-window-functions"><span class="header-section-number">13.7.2</span> 7.2 Query Planning for
Window Functions</h3>
<div class="sourceCode" id="cb765"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb765-1"><a aria-hidden="true" href="#cb765-1" tabindex="-1"></a><span class="co">-- Window functions are generally efficient but check plans</span></span>
<span id="cb765-2"><a aria-hidden="true" href="#cb765-2" tabindex="-1"></a><span class="kw">EXPLAIN</span> (<span class="kw">ANALYZE</span>)</span>
<span id="cb765-3"><a aria-hidden="true" href="#cb765-3" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb765-4"><a aria-hidden="true" href="#cb765-4" tabindex="-1"></a>    <span class="op">*</span>,</span>
<span id="cb765-5"><a aria-hidden="true" href="#cb765-5" tabindex="-1"></a>    <span class="fu">ROW_NUMBER</span>() <span class="kw">OVER</span> (<span class="kw">PARTITION</span> <span class="kw">BY</span> dept <span class="kw">ORDER</span> <span class="kw">BY</span> salary <span class="kw">DESC</span>) <span class="kw">as</span> <span class="fu">rank</span></span>
<span id="cb765-6"><a aria-hidden="true" href="#cb765-6" tabindex="-1"></a><span class="kw">FROM</span> employees;</span>
<span id="cb765-7"><a aria-hidden="true" href="#cb765-7" tabindex="-1"></a></span>
<span id="cb765-8"><a aria-hidden="true" href="#cb765-8" tabindex="-1"></a><span class="co">-- For large partitions, ensure proper indexes on partition columns</span></span>
<span id="cb765-9"><a aria-hidden="true" href="#cb765-9" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_employees_dept <span class="kw">ON</span> employees (department_id);</span></code></pre></div>
<hr/>
<h2 data-number="13.8" id="summary-3"><span class="header-section-number">13.8</span> Summary</h2>
<p>PostgreSQL‚Äôs SQL dialect extends the SQL standard with:</p>
<ol type="1">
<li><strong>Rich Type System</strong>: Comprehensive built-in types and
ability to create custom types</li>
<li><strong>Advanced Analytics</strong>: Window functions and CTEs for
complex analytical queries</li>
<li><strong>JSON Support</strong>: Native JSONB with efficient indexing
and querying</li>
<li><strong>Procedural Logic</strong>: PL/pgSQL for complex business
logic</li>
<li><strong>Practical Extensions</strong>: DISTINCT ON, RETURNING, and
UPSERT (INSERT ‚Ä¶ ON CONFLICT)</li>
<li><strong>Performance Features</strong>: Prepared statements and
strategic indexing</li>
</ol>
<p>These features make PostgreSQL exceptionally capable for diverse
application requirements, from simple transactional systems to complex
analytical platforms.</p>
<h1 data-number="14" id="postgresql-glossary"><span class="header-section-number">14</span> PostgreSQL Glossary</h1>
<h2 data-number="14.1" id="comprehensive-terminology-reference"><span class="header-section-number">14.1</span> Comprehensive Terminology
Reference</h2>
<p>This glossary contains definitions of PostgreSQL-specific terms,
database concepts, and technical jargon used throughout this
encyclopedia. Terms are cross-referenced with related concepts and point
to relevant sections of the documentation.</p>
<hr/>
<h2 data-number="14.2" id="a"><span class="header-section-number">14.2</span> A</h2>
<p><strong>Access Method (AM)</strong> A pluggable interface for
implementing index types or table storage. PostgreSQL provides B-tree,
Hash, GiST, GIN, SP-GiST, BRIN, and Bloom access methods. Custom access
methods can be implemented. ‚Üí See: <a href="../08-extensions/access-methods.md">Custom Access Methods</a></p>
<p><strong>ACID</strong> The four properties guaranteeing reliable
transaction processing: - <strong>Atomicity</strong>: Transactions are
all-or-nothing - <strong>Consistency</strong>: Database remains in a
valid state - <strong>Isolation</strong>: Concurrent transactions don‚Äôt
interfere - <strong>Durability</strong>: Committed changes persist ‚Üí
See: <a href="../05-transactions/acid-properties.md">Transaction
Management</a></p>
<p><strong>Aggregate Function</strong> A function that computes a single
result from multiple input rows (e.g., SUM, AVG, COUNT). ‚Üí See: <a href="../03-query-processing/aggregation.md">Query Processing -
Aggregation</a></p>
<p><strong>Analyzestat</strong> Statistics collector process that
gathers information about database activity for the query planner. ‚Üí
See: <a href="../06-processes/statistics-collector.md">Process
Architecture</a></p>
<p><strong>Autovacuum</strong> Background process that automatically
performs VACUUM and ANALYZE operations to maintain database health. ‚Üí
See: <a href="../04-storage/vacuum.md#autovacuum">Maintenance -
Autovacuum</a></p>
<hr/>
<h2 data-number="14.3" id="b"><span class="header-section-number">14.3</span> B</h2>
<p><strong>Backend Process</strong> A server process dedicated to
handling a single client connection. ‚Üí See: <a href="../06-processes/backend-processes.md">Process Architecture -
Backends</a></p>
<p><strong>Base Backup</strong> A complete copy of the database cluster
taken while the database is running, used for point-in-time recovery or
creating standbys. ‚Üí See: <a href="../08-utilities/pg_basebackup.md">Utilities -
pg_basebackup</a></p>
<p><strong>Berkeley DB</strong> Historical: UC Berkeley‚Äôs database.
PostgreSQL descended from Berkeley POSTGRES, unrelated to Berkeley
DB.</p>
<p><strong>bgwriter (Background Writer)</strong> Process that writes
dirty buffers from shared memory to disk, smoothing I/O load. ‚Üí See: <a href="../06-processes/auxiliary-processes.md#bgwriter">Process
Architecture - bgwriter</a></p>
<p><strong>Bitmap Index Scan</strong> An index scan method that builds a
bitmap of matching tuples before accessing the heap, efficient for
multiple conditions. ‚Üí See: <a href="../03-query-processing/index-scans.md">Query Processing - Index
Scans</a></p>
<p><strong>BKI (Backend Interface)</strong> The format used for
bootstrap data files (e.g., postgres.bki) that create initial system
catalogs. ‚Üí See: <a href="../09-build-system/bootstrap.md">Build System
- Bootstrap</a></p>
<p><strong>Block</strong> See <strong>Page</strong></p>
<p><strong>Block Number</strong> Zero-based index of a page within a
relation fork. Type: <code>BlockNumber</code> (32-bit unsigned). ‚Üí See:
<a href="../04-storage/page-layout.md">Storage - Page Layout</a></p>
<p><strong>BRIN (Block Range Index)</strong> Index type that stores
summaries (min/max) for ranges of pages, very compact for correlated
data. ‚Üí See: <a href="../04-storage/indexes.md#brin">Indexes -
BRIN</a></p>
<p><strong>Buffer</strong> An in-memory copy of a page from disk,
managed by the buffer manager. ‚Üí See: <a href="../04-storage/buffer-manager.md">Storage - Buffer
Management</a></p>
<p><strong>Buffer Manager</strong> Subsystem that manages the buffer
pool, implementing caching and replacement policies. ‚Üí See: <a href="../04-storage/buffer-manager.md">Storage - Buffer
Management</a></p>
<p><strong>Buffer Pool</strong> Collection of shared memory buffers for
caching disk pages. Size controlled by <code>shared_buffers</code>. ‚Üí
See: <a href="../10-admin/configuration.md#shared_buffers">Configuration
- Memory</a></p>
<p><strong>B-tree</strong> The default index type, implementing Lehman
and Yao‚Äôs high-concurrency B+ tree algorithm. ‚Üí See: <a href="../04-storage/indexes.md#btree">Indexes - B-tree</a></p>
<hr/>
<h2 data-number="14.4" id="c"><span class="header-section-number">14.4</span> C</h2>
<p><strong>Catalog</strong> System tables (pg_class, pg_attribute, etc.)
that store metadata about database objects. ‚Üí See: <a href="../03-query-processing/catalog.md">Query Processing - Catalog
System</a></p>
<p><strong>Checkpointer</strong> Process that performs checkpoints,
ensuring all dirty buffers are written and creating recovery points. ‚Üí
See: <a href="../06-processes/auxiliary-processes.md#checkpointer">Process
Architecture - Checkpointer</a></p>
<p><strong>Checkpoint</strong> A point in the WAL sequence where all
data file changes have been flushed to disk, enabling recovery. ‚Üí See:
<a href="../04-storage/wal.md#checkpoints">WAL - Checkpoints</a></p>
<p><strong>CID (Command ID)</strong> Identifier for a command within a
transaction. Type: <code>CommandId</code> (32-bit unsigned). ‚Üí See: <a href="../05-transactions/mvcc.md#command-id">MVCC - Tuple
Visibility</a></p>
<p><strong>CLOG (Commit Log)</strong> Now called
<strong>pg_xact</strong>. SLRU storing transaction commit status. ‚Üí See:
<a href="../05-transactions/commit-log.md">Transactions - Commit
Log</a></p>
<p><strong>Clock-Sweep</strong> Buffer replacement algorithm that
approximates LRU with low overhead. ‚Üí See: <a href="../04-storage/buffer-manager.md#clock-sweep">Storage - Buffer
Replacement</a></p>
<p><strong>Commitfest</strong> Month-long period focused on reviewing
patches rather than developing new features. ‚Üí See: <a href="../11-culture/commitfest.md">Development Process</a></p>
<p><strong>Connection Pooling</strong> Reusing database connections to
reduce overhead. Typically done by external tools (pgBouncer, pgPool). ‚Üí
See: <a href="../06-processes/connection-pooling.md">Architecture -
Connection Management</a></p>
<p><strong>Constraint</strong> Rule enforcing data integrity: PRIMARY
KEY, FOREIGN KEY, UNIQUE, CHECK, NOT NULL. ‚Üí See: <a href="../02-sql/constraints.md">DDL - Constraints</a></p>
<p><strong>contrib</strong> Directory containing optional extensions and
modules distributed with PostgreSQL. ‚Üí See: <a href="../08-extensions/contrib.md">Extensions - Contrib Modules</a></p>
<p><strong>Cost Estimation</strong> Process of predicting resource usage
for different query plans. ‚Üí See: <a href="../03-query-processing/cost-estimation.md">Query Optimizer - Cost
Model</a></p>
<p><strong>CTE (Common Table Expression)</strong> Named subquery defined
with WITH clause. Can be recursive. ‚Üí See: <a href="../02-sql/with-queries.md">SQL - CTEs</a></p>
<p><strong>ctid</strong> System column containing tuple‚Äôs physical
location (page number, tuple index). ‚Üí See: <a href="../04-storage/tuple-format.md">Storage - Tuple Format</a></p>
<hr/>
<h2 data-number="14.5" id="d"><span class="header-section-number">14.5</span> D</h2>
<p><strong>Data Directory (PGDATA)</strong> Directory containing all
database files, configuration, and WAL. ‚Üí See: <a href="../10-admin/data-directory.md">Installation - Data
Directory</a></p>
<p><strong>Datum</strong> PostgreSQL‚Äôs universal data container type.
Can hold any PostgreSQL data value. ‚Üí See: <a href="../07-internals/datum.md">Internals - Datum</a></p>
<p><strong>Deadlock</strong> Circular wait condition where transactions
block each other. Detected and resolved automatically. ‚Üí See: <a href="../05-transactions/deadlocks.md">Locking - Deadlock
Detection</a></p>
<p><strong>Dirty Buffer</strong> A buffer containing modified data not
yet written to disk. ‚Üí See: <a href="../04-storage/buffer-manager.md#buffer-states">Storage - Buffer
States</a></p>
<hr/>
<h2 data-number="14.6" id="e"><span class="header-section-number">14.6</span> E</h2>
<p><strong>ECPG (Embedded SQL in C)</strong> Preprocessor allowing SQL
to be embedded in C programs. ‚Üí See: <a href="../07-interfaces/ecpg.md">Interfaces - ECPG</a></p>
<p><strong>Epoch</strong> 32-bit counter incremented on XID wraparound.
Combined with XID forms 64-bit FullTransactionId. ‚Üí See: <a href="../05-transactions/wraparound.md">Transactions - XID
Wraparound</a></p>
<p><strong>EState (Executor State)</strong> Per-query execution state
passed between executor nodes. ‚Üí See: <a href="../03-query-processing/executor.md#estate">Executor -
EState</a></p>
<p><strong>Extension</strong> Packaged collection of SQL objects (types,
functions, operators, etc.) managed as a unit. ‚Üí See: <a href="../08-extensions/extension-mechanism.md">Extensions - Extension
Mechanism</a></p>
<p><strong>ExprState (Expression State)</strong> Compiled representation
of an expression for fast evaluation. ‚Üí See: <a href="../03-query-processing/executor.md#expression-evaluation">Executor
- Expression Evaluation</a></p>
<hr/>
<h2 data-number="14.7" id="f"><span class="header-section-number">14.7</span> F</h2>
<p><strong>FDW (Foreign Data Wrapper)</strong> Interface for accessing
external data sources as if they were PostgreSQL tables. ‚Üí See: <a href="../08-extensions/fdw.md">Extensions - Foreign Data
Wrappers</a></p>
<p><strong>Fill Factor</strong> Percentage of page to fill during index
creation, leaving space for updates. ‚Üí See: <a href="../04-storage/indexes.md#fill-factor">Indexes - Fill
Factor</a></p>
<p><strong>fmgr (Function Manager)</strong> Subsystem managing function
calls, including caching and calling conventions. ‚Üí See: <a href="../07-internals/fmgr.md">Internals - Function Manager</a></p>
<p><strong>Fork</strong> Separate file storing different types of
relation data: main, FSM, VM, init. ‚Üí See: <a href="../04-storage/file-layout.md#forks">Storage - Relation
Forks</a></p>
<p><strong>Freezing</strong> Setting old transaction IDs to
FrozenTransactionId (2) to prevent wraparound. ‚Üí See: <a href="../04-storage/vacuum.md#freezing">VACUUM - Freezing</a></p>
<p><strong>FSM (Free Space Map)</strong> Per-relation structure tracking
available space in pages for efficient insertion. ‚Üí See: <a href="../04-storage/fsm.md">Storage - Free Space Map</a></p>
<hr/>
<h2 data-number="14.8" id="g"><span class="header-section-number">14.8</span> G</h2>
<p><strong>GEQO (Genetic Query Optimizer)</strong> Alternative query
optimizer using genetic algorithm for queries with many tables. ‚Üí See:
<a href="../03-query-processing/geqo.md">Optimizer - GEQO</a></p>
<p><strong>GIN (Generalized Inverted Index)</strong> Index type for
multi-valued data like arrays, JSONB, and full-text search. ‚Üí See: <a href="../04-storage/indexes.md#gin">Indexes - GIN</a></p>
<p><strong>GiST (Generalized Search Tree)</strong> Extensible balanced
tree structure for custom data types and operations. ‚Üí See: <a href="../04-storage/indexes.md#gist">Indexes - GiST</a></p>
<p><strong>GUC (Grand Unified Configuration)</strong> PostgreSQL‚Äôs
configuration system, managing all server parameters. ‚Üí See: <a href="../10-admin/configuration.md#guc-system">Configuration -
GUC</a></p>
<hr/>
<h2 data-number="14.9" id="h"><span class="header-section-number">14.9</span> H</h2>
<p><strong>Hash Join</strong> Join algorithm that builds hash table of
one input and probes with the other. ‚Üí See: <a href="../03-query-processing/joins.md#hash-join">Joins - Hash
Join</a></p>
<p><strong>Heap</strong> Default table storage format, storing tuples in
no particular order. ‚Üí See: <a href="../04-storage/heap.md">Storage -
Heap AM</a></p>
<p><strong>Heap-Only Tuple (HOT)</strong> Update optimization keeping
new tuple version on same page without updating indexes. ‚Üí See: <a href="../04-storage/hot.md">Storage - HOT Updates</a></p>
<p><strong>Hook</strong> Callback mechanism allowing extensions to
intercept and modify PostgreSQL behavior. ‚Üí See: <a href="../08-extensions/hooks.md">Extensions - Hooks</a></p>
<p><strong>Hot Standby</strong> Replica that accepts read-only queries
while in continuous recovery. ‚Üí See: <a href="../06-replication/hot-standby.md">Replication - Hot
Standby</a></p>
<hr/>
<h2 data-number="14.10" id="i"><span class="header-section-number">14.10</span> I</h2>
<p><strong>Index</strong> Data structure for efficiently finding rows
matching conditions. ‚Üí See: <a href="../04-storage/indexes.md">Storage -
Indexes</a></p>
<p><strong>Index-Only Scan</strong> Optimization returning data from
index without accessing heap, using visibility map. ‚Üí See: <a href="../04-storage/indexes.md#index-only-scans">Indexes - Index-Only
Scans</a></p>
<p><strong>Ingres</strong> Predecessor database system at UC Berkeley,
led by Michael Stonebraker. ‚Üí See: <a href="../00-introduction.md#ingres">History - Ingres</a></p>
<p><strong>initdb</strong> Utility that initializes a new database
cluster. ‚Üí See: <a href="../08-utilities/initdb.md">Utilities -
initdb</a></p>
<p><strong>Item Pointer (ItemPointer)</strong> See <strong>TID (Tuple
Identifier)</strong></p>
<hr/>
<h2 data-number="14.11" id="j"><span class="header-section-number">14.11</span> J</h2>
<p><strong>JIT (Just-In-Time Compilation)</strong> LLVM-based
compilation of expressions and tuple deforming for faster execution. ‚Üí
See: <a href="../03-query-processing/jit.md">Executor - JIT</a></p>
<p><strong>Join</strong> Combining rows from multiple tables based on
related columns. ‚Üí See: <a href="../02-sql/joins.md">SQL - Joins</a></p>
<hr/>
<h2 data-number="14.12" id="k"><span class="header-section-number">14.12</span> K</h2>
<p><strong>Key</strong> Column(s) uniquely identifying rows (primary
key) or referencing other tables (foreign key). ‚Üí See: <a href="../02-sql/keys.md">DDL - Keys</a></p>
<hr/>
<h2 data-number="14.13" id="l"><span class="header-section-number">14.13</span> L</h2>
<p><strong>Large Object (LOB)</strong> Object stored outside normal
tables, accessed via special API. Deprecated in favor of bytea/text. ‚Üí
See: <a href="../02-sql/large-objects.md">Data Types - Large
Objects</a></p>
<p><strong>Latch</strong> Lightweight waiting mechanism for
processes/threads to sleep until woken. ‚Üí See: <a href="../06-processes/latches.md">IPC - Latches</a></p>
<p><strong>libpq</strong> Official PostgreSQL C client library. ‚Üí See:
<a href="../07-interfaces/libpq.md">Interfaces - libpq</a></p>
<p><strong>Listen/Notify</strong> Asynchronous notification mechanism
for publishing messages between sessions. ‚Üí See: <a href="../02-sql/listen-notify.md">Features - LISTEN/NOTIFY</a></p>
<p><strong>Lock</strong> Mechanism preventing conflicting concurrent
access. Multiple granularities and modes. ‚Üí See: <a href="../05-transactions/locking.md">Concurrency - Locking</a></p>
<p><strong>Lock Manager (lmgr)</strong> Subsystem managing heavyweight
locks on database objects. ‚Üí See: <a href="../05-transactions/lock-manager.md">Locking - Lock Manager</a></p>
<p><strong>Logical Decoding</strong> Extracting changes from WAL in
readable format, foundation for logical replication. ‚Üí See: <a href="../06-replication/logical-decoding.md">Replication - Logical
Decoding</a></p>
<p><strong>Logical Replication</strong> Row-level replication using
logical decoding, allowing selective table replication. ‚Üí See: <a href="../06-replication/logical-replication.md">Replication - Logical
Replication</a></p>
<p><strong>LSN (Log Sequence Number)</strong> 64-bit position in WAL
stream. Type: <code>XLogRecPtr</code>. ‚Üí See: <a href="../04-storage/wal.md#lsn">WAL - LSN</a></p>
<p><strong>LWLock (Lightweight Lock)</strong> Spinlock with queue for
waiting, used for internal data structures. ‚Üí See: <a href="../05-transactions/lwlocks.md">Locking - LWLocks</a></p>
<hr/>
<h2 data-number="14.14" id="m"><span class="header-section-number">14.14</span> M</h2>
<p><strong>Merge Join</strong> Join algorithm for sorted inputs,
scanning both inputs simultaneously. ‚Üí See: <a href="../03-query-processing/joins.md#merge-join">Joins - Merge
Join</a></p>
<p><strong>MVCC (Multi-Version Concurrency Control)</strong> Concurrency
control mechanism where readers see consistent snapshot without blocking
writers. ‚Üí See: <a href="../05-transactions/mvcc.md">Transactions -
MVCC</a></p>
<hr/>
<h2 data-number="14.15" id="n"><span class="header-section-number">14.15</span> N</h2>
<p><strong>Nested Loop Join</strong> Join algorithm evaluating inner
relation once per outer row. ‚Üí See: <a href="../03-query-processing/joins.md#nested-loop">Joins - Nested
Loop</a></p>
<p><strong>Node</strong> Base type for parse trees, plan trees, and
executor state trees. ‚Üí See: <a href="../07-internals/nodes.md">Internals - Node System</a></p>
<hr/>
<h2 data-number="14.16" id="o"><span class="header-section-number">14.16</span> O</h2>
<p><strong>OID (Object Identifier)</strong> Unique identifier for system
catalog rows. Type: <code>Oid</code> (32-bit unsigned). ‚Üí See: <a href="../03-query-processing/catalog.md#oids">Catalog - OIDs</a></p>
<p><strong>ORDBMS (Object-Relational Database Management
System)</strong> Database combining relational model with
object-oriented features. ‚Üí See: <a href="../00-introduction.md">Introduction - What is PostgreSQL</a></p>
<hr/>
<h2 data-number="14.17" id="p"><span class="header-section-number">14.17</span> P</h2>
<p><strong>Page</strong> Basic I/O unit, typically 8KB. Contains header,
line pointers, tuples, and special space. ‚Üí See: <a href="../04-storage/page-layout.md">Storage - Page Layout</a></p>
<p><strong>Parallel Query</strong> Query execution using multiple worker
processes for faster results. ‚Üí See: <a href="../03-query-processing/parallel.md">Executor - Parallel
Execution</a></p>
<p><strong>Parse Tree</strong> Representation of SQL query after parsing
but before planning. ‚Üí See: <a href="../03-query-processing/parser.md">Query Processing -
Parser</a></p>
<p><strong>Partition</strong> Dividing large table into smaller physical
pieces while appearing as single table. ‚Üí See: <a href="../02-sql/partitioning.md">DDL - Partitioning</a></p>
<p><strong>Path</strong> Possible execution strategy for (part of) a
query, with estimated costs. ‚Üí See: <a href="../03-query-processing/paths.md">Optimizer - Path
Generation</a></p>
<p><strong>pg_dump</strong> Utility for logical database backup. ‚Üí See:
<a href="../08-utilities/pg_dump.md">Utilities - pg_dump</a></p>
<p><strong>PGDATA</strong> See <strong>Data Directory</strong></p>
<p><strong>PGXS (PostgreSQL Extension Building Infrastructure)</strong>
Build system for compiling extensions outside the source tree. ‚Üí See: <a href="../08-extensions/pgxs.md">Extensions - PGXS</a></p>
<p><strong>PITR (Point-In-Time Recovery)</strong> Recovering database to
specific moment using base backup and WAL archives. ‚Üí See: <a href="../10-admin/pitr.md">Backup - PITR</a></p>
<p><strong>Plan</strong> Executable representation of query, produced by
planner from cheapest path. ‚Üí See: <a href="../03-query-processing/planner.md">Query Processing -
Planner</a></p>
<p><strong>PlanState</strong> Runtime state for executing a plan node. ‚Üí
See: <a href="../03-query-processing/executor.md#plan-states">Executor -
Plan States</a></p>
<p><strong>PL/pgSQL</strong> PostgreSQL‚Äôs default procedural language,
similar to PL/SQL. ‚Üí See: <a href="../08-extensions/plpgsql.md">Procedural Languages -
PL/pgSQL</a></p>
<p><strong>Postmaster</strong> Main server process that manages
authentication and spawns backends. ‚Üí See: <a href="../06-processes/postmaster.md">Process Architecture -
Postmaster</a></p>
<p><strong>POSTGRES</strong> Original database system developed at UC
Berkeley (1986-1994), PostgreSQL‚Äôs ancestor. ‚Üí See: <a href="../00-introduction.md#postgres">History - Berkeley
POSTGRES</a></p>
<p><strong>Prepared Statement</strong> Pre-parsed query plan that can be
executed multiple times with different parameters. ‚Üí See: <a href="../02-sql/prepared.md">SQL - Prepared Statements</a></p>
<p><strong>Primary Key</strong> Column(s) uniquely identifying each row
in a table. ‚Üí See: <a href="../02-sql/constraints.md#primary-key">DDL -
Primary Keys</a></p>
<p><strong>psql</strong> Interactive terminal for PostgreSQL. ‚Üí See: <a href="../08-utilities/psql.md">Utilities - psql</a></p>
<hr/>
<h2 data-number="14.18" id="q"><span class="header-section-number">14.18</span> Q</h2>
<p><strong>Query</strong> Parsed and analyzed representation of SQL
statement. ‚Üí See: <a href="../03-query-processing/query-struct.md">Query
Processing - Query Structure</a></p>
<p><strong>Query Optimizer</strong> See <strong>Planner</strong></p>
<p><strong>Query Rewrite</strong> Transformation of queries by rules,
views, and row security policies. ‚Üí See: <a href="../03-query-processing/rewriter.md">Query Processing -
Rewriter</a></p>
<hr/>
<h2 data-number="14.19" id="r"><span class="header-section-number">14.19</span> R</h2>
<p><strong>Range Table Entry (RTE)</strong> Describes one
table/subquery/function in FROM clause. ‚Üí See: <a href="../03-query-processing/range-table.md">Query Processing - Range
Tables</a></p>
<p><strong>Relation</strong> Generic term for table, index, sequence,
view, etc. ‚Üí See: <a href="../03-query-processing/catalog.md#relations">Catalog -
Relations</a></p>
<p><strong>Relfilenode</strong> File name for storing relation‚Äôs data.
May differ from OID after certain operations. ‚Üí See: <a href="../04-storage/file-layout.md#relfilenode">Storage - File
Layout</a></p>
<p><strong>Replication Slot</strong> Named persistent state for
streaming or logical replication, preventing WAL deletion. ‚Üí See: <a href="../06-replication/slots.md">Replication - Replication
Slots</a></p>
<p><strong>Resource Manager (RM)</strong> Module handling specific WAL
record types (heap, btree, xact, etc.). ‚Üí See: <a href="../04-storage/wal.md#resource-managers">WAL - Resource
Managers</a></p>
<p><strong>Row-Level Security (RLS)</strong> Per-row access control
using policies. ‚Üí See: <a href="../10-admin/rls.md">Security - Row-Level
Security</a></p>
<hr/>
<h2 data-number="14.20" id="s"><span class="header-section-number">14.20</span> S</h2>
<p><strong>Sequential Scan</strong> Reading all tuples in a relation
sequentially. ‚Üí See: <a href="../04-storage/seqscan.md">Access Methods -
Sequential Scan</a></p>
<p><strong>Serializable Snapshot Isolation (SSI)</strong> Algorithm
implementing true SERIALIZABLE isolation without locking. ‚Üí See: <a href="../05-transactions/ssi.md">Isolation - SSI</a></p>
<p><strong>Shared Buffers</strong> Main buffer pool in shared memory for
caching pages. ‚Üí See: <a href="../10-admin/configuration.md#shared_buffers">Configuration -
shared_buffers</a></p>
<p><strong>Shared Memory</strong> Memory segment accessible to all
PostgreSQL processes. ‚Üí See: <a href="../06-processes/shared-memory.md">IPC - Shared Memory</a></p>
<p><strong>Slotted Page</strong> Page layout with indirection layer
(line pointers) between tuples and their references. ‚Üí See: <a href="../04-storage/page-layout.md">Storage - Page Layout</a></p>
<p><strong>SLRU (Simple LRU)</strong> Mini buffer manager for small
frequently-accessed data (commit log, subtransactions, etc.). ‚Üí See: <a href="../04-storage/slru.md">Storage - SLRU</a></p>
<p><strong>Snapshot</strong> View of database state at a point in time,
determining tuple visibility. ‚Üí See: <a href="../05-transactions/snapshots.md">MVCC - Snapshots</a></p>
<p><strong>SP-GiST (Space-Partitioned GiST)</strong> Index for
non-balanced tree structures like quad-trees and tries. ‚Üí See: <a href="../04-storage/indexes.md#spgist">Indexes - SP-GiST</a></p>
<p><strong>SPI (Server Programming Interface)</strong> API for writing
server-side functions that execute SQL. ‚Üí See: <a href="../08-extensions/spi.md">Extensions - SPI</a></p>
<p><strong>Spinlock</strong> Low-level lock implemented with atomic CPU
instructions. ‚Üí See: <a href="../05-transactions/spinlocks.md">Locking -
Spinlocks</a></p>
<p><strong>SQL (Structured Query Language)</strong> Standard language
for relational databases. ‚Üí See: <a href="../02-sql/README.md">SQL
Reference</a></p>
<p><strong>SSI</strong> See <strong>Serializable Snapshot
Isolation</strong></p>
<p><strong>Standby</strong> Replica server receiving changes via
streaming or WAL shipping. ‚Üí See: <a href="../06-replication/standbys.md">Replication - Standbys</a></p>
<p><strong>Statistics</strong> Information about data distribution used
by query planner. ‚Üí See: <a href="../03-query-processing/statistics.md">Optimizer -
Statistics</a></p>
<p><strong>Streaming Replication</strong> Real-time replication by
streaming WAL records to standby. ‚Üí See: <a href="../06-replication/streaming.md">Replication - Streaming</a></p>
<p><strong>syscache (System Cache)</strong> In-memory cache of
frequently-accessed catalog tuples. ‚Üí See: <a href="../03-query-processing/syscache.md">Catalog - Syscache</a></p>
<hr/>
<h2 data-number="14.21" id="t"><span class="header-section-number">14.21</span> T</h2>
<p><strong>Tablespace</strong> Named location on filesystem where
database objects can be stored. ‚Üí See: <a href="../04-storage/tablespaces.md">Storage - Tablespaces</a></p>
<p><strong>TID (Tuple Identifier)</strong> Physical location of tuple:
(block number, offset). Type: <code>ItemPointerData</code>. ‚Üí See: <a href="../04-storage/tid.md">Storage - TIDs</a></p>
<p><strong>Timeline</strong> Branch in WAL history after recovery to a
point in time. ‚Üí See: <a href="../06-replication/timelines.md">Recovery
- Timelines</a></p>
<p><strong>TOAST (The Oversized-Attribute Storage Technique)</strong>
Mechanism for storing large values out-of-line from main table. ‚Üí See:
<a href="../04-storage/toast.md">Storage - TOAST</a></p>
<p><strong>Transaction</strong> Atomic unit of work, either fully
completed or fully rolled back. ‚Üí See: <a href="../05-transactions/basics.md">Transactions - Basics</a></p>
<p><strong>Transaction ID (XID)</strong> Unique identifier for each
transaction. Type: <code>TransactionId</code> (32-bit), wraps around. ‚Üí
See: <a href="../05-transactions/xid.md">Transactions - Transaction
IDs</a></p>
<p><strong>Trigger</strong> Function automatically executed when
specified event occurs on a table. ‚Üí See: <a href="../02-sql/triggers.md">Triggers - Overview</a></p>
<p><strong>Tuple</strong> Single row in a table or index. ‚Üí See: <a href="../04-storage/tuple-format.md">Storage - Tuple Format</a></p>
<p><strong>Two-Phase Commit (2PC)</strong> Protocol for coordinating
distributed transactions across multiple databases. ‚Üí See: <a href="../05-transactions/2pc.md">Transactions - Two-Phase Commit</a></p>
<hr/>
<h2 data-number="14.22" id="u"><span class="header-section-number">14.22</span> U</h2>
<p><strong>Unlogged Table</strong> Table whose changes aren‚Äôt written to
WAL, faster but not crash-safe. ‚Üí See: <a href="../02-sql/unlogged.md">DDL - Unlogged Tables</a></p>
<hr/>
<h2 data-number="14.23" id="v"><span class="header-section-number">14.23</span> V</h2>
<p><strong>VACUUM</strong> Process that removes dead tuples, updates
statistics, and prevents XID wraparound. ‚Üí See: <a href="../04-storage/vacuum.md">Maintenance - VACUUM</a></p>
<p><strong>Visibility Map (VM)</strong> Bitmap tracking which pages have
all tuples visible to all transactions. ‚Üí See: <a href="../04-storage/vm.md">Storage - Visibility Map</a></p>
<hr/>
<h2 data-number="14.24" id="w"><span class="header-section-number">14.24</span> W</h2>
<p><strong>WAL (Write-Ahead Log)</strong> Transaction log ensuring
durability and enabling recovery. Also called ‚Äúxlog‚Äù internally. ‚Üí See:
<a href="../04-storage/wal.md">Storage - WAL</a></p>
<p><strong>WAL Archiving</strong> Copying completed WAL segments to
external storage for backup/recovery. ‚Üí See: <a href="../10-admin/wal-archiving.md">Backup - WAL Archiving</a></p>
<p><strong>WAL Sender (walsender)</strong> Process streaming WAL to
standby servers. ‚Üí See: <a href="../06-replication/walsender.md">Replication - WAL Sender</a></p>
<p><strong>WAL Writer (walwriter)</strong> Process that periodically
writes WAL buffers to disk. ‚Üí See: <a href="../06-processes/auxiliary-processes.md#walwriter">Process
Architecture - walwriter</a></p>
<p><strong>Window Function</strong> Function operating on set of rows
related to current row (e.g., rank(), lag()). ‚Üí See: <a href="../02-sql/window-functions.md">SQL - Window Functions</a></p>
<hr/>
<h2 data-number="14.25" id="x"><span class="header-section-number">14.25</span> X</h2>
<p><strong>XID</strong> See <strong>Transaction ID</strong></p>
<p><strong>xlog</strong> Internal name for WAL in source code and file
structures. ‚Üí See: <a href="../04-storage/wal.md">WAL - Overview</a></p>
<p><strong>xmin, xmax</strong> Transaction IDs in tuple header
indicating creation and deletion transactions. ‚Üí See: <a href="../05-transactions/mvcc.md#xmin-xmax">MVCC - Tuple
Visibility</a></p>
<hr/>
<h2 data-number="14.26" id="z"><span class="header-section-number">14.26</span> Z</h2>
<p><strong>Zero Page</strong> Newly allocated page filled with zeros,
avoiding leaked data from previous use. ‚Üí See: <a href="../04-storage/page-init.md">Storage - Page Initialization</a></p>
<hr/>
<h2 data-number="14.27" id="acronyms-quick-reference"><span class="header-section-number">14.27</span> Acronyms Quick Reference</h2>
<ul>
<li><strong>2PC</strong>: Two-Phase Commit</li>
<li><strong>ACL</strong>: Access Control List</li>
<li><strong>AM</strong>: Access Method</li>
<li><strong>API</strong>: Application Programming Interface</li>
<li><strong>BRIN</strong>: Block Range Index</li>
<li><strong>CID</strong>: Command ID</li>
<li><strong>CLOG</strong>: Commit Log (now pg_xact)</li>
<li><strong>CPU</strong>: Central Processing Unit</li>
<li><strong>CRC</strong>: Cyclic Redundancy Check</li>
<li><strong>CTE</strong>: Common Table Expression</li>
<li><strong>CTID</strong>: Current Tuple ID</li>
<li><strong>DDL</strong>: Data Definition Language</li>
<li><strong>DML</strong>: Data Manipulation Language</li>
<li><strong>ECPG</strong>: Embedded C for PostgreSQL</li>
<li><strong>FDW</strong>: Foreign Data Wrapper</li>
<li><strong>FSM</strong>: Free Space Map</li>
<li><strong>GEQO</strong>: Genetic Query Optimizer</li>
<li><strong>GIN</strong>: Generalized Inverted Index</li>
<li><strong>GiST</strong>: Generalized Search Tree</li>
<li><strong>GUC</strong>: Grand Unified Configuration</li>
<li><strong>HOT</strong>: Heap-Only Tuple</li>
<li><strong>I/O</strong>: Input/Output</li>
<li><strong>IPC</strong>: Inter-Process Communication</li>
<li><strong>JIT</strong>: Just-In-Time (compilation)</li>
<li><strong>LO</strong>: Large Object</li>
<li><strong>LOB</strong>: Large Object</li>
<li><strong>LSN</strong>: Log Sequence Number</li>
<li><strong>LWLock</strong>: Lightweight Lock</li>
<li><strong>MVCC</strong>: Multi-Version Concurrency Control</li>
<li><strong>OID</strong>: Object Identifier</li>
<li><strong>ORDBMS</strong>: Object-Relational DBMS</li>
<li><strong>PID</strong>: Process ID</li>
<li><strong>PITR</strong>: Point-In-Time Recovery</li>
<li><strong>PGDATA</strong>: PostgreSQL Data Directory</li>
<li><strong>PGXS</strong>: PostgreSQL Extension Building
Infrastructure</li>
<li><strong>RM</strong>: Resource Manager</li>
<li><strong>RLS</strong>: Row-Level Security</li>
<li><strong>RTE</strong>: Range Table Entry</li>
<li><strong>SPI</strong>: Server Programming Interface</li>
<li><strong>SP-GiST</strong>: Space-Partitioned GiST</li>
<li><strong>SQL</strong>: Structured Query Language</li>
<li><strong>SRF</strong>: Set-Returning Function</li>
<li><strong>SSI</strong>: Serializable Snapshot Isolation</li>
<li><strong>TID</strong>: Tuple Identifier</li>
<li><strong>TOAST</strong>: The Oversized-Attribute Storage
Technique</li>
<li><strong>TPS</strong>: Transactions Per Second</li>
<li><strong>VM</strong>: Visibility Map</li>
<li><strong>WAL</strong>: Write-Ahead Log</li>
<li><strong>XID</strong>: Transaction ID</li>
<li><strong>XLOG</strong>: Transaction Log (internal name for WAL)</li>
</ul>
<hr/>
<h2 data-number="14.28" id="see-also"><span class="header-section-number">14.28</span> See Also</h2>
<ul>
<li><strong><a href="index.md">Index</a></strong>: Alphabetical index of
all topics</li>
<li><strong><a href="../00-introduction.md">Introduction</a></strong>:
Overview of PostgreSQL</li>
<li><strong><a href="../01-architecture/overview.md">Architecture
Overview</a></strong>: High-level system architecture</li>
</ul>
<hr/>
<p><em>This glossary is continuously updated as PostgreSQL evolves. Last
updated: 2025</em></p>
<h1 data-number="15" id="postgresql-encyclopedia-comprehensive-alphabetical-index"><span class="header-section-number">15</span> PostgreSQL Encyclopedia:
Comprehensive Alphabetical Index</h1>
<p>A comprehensive, alphabetically organized index of all major
PostgreSQL concepts, data structures, functions, utilities, and
contributors referenced throughout this encyclopedia.</p>
<hr/>
<h2 data-number="15.1" id="a-1"><span class="header-section-number">15.1</span> A</h2>
<p><strong>Access Method (AM)</strong> ‚Üí Pluggable interface for
implementing index types or table storage ‚Üí See: <a href="../02-query-processing/query-pipeline.md">Query Processing - Index
Types</a>, <a href="../01-storage/storage-layer.md">Storage - Page
Layout</a> ‚Üí Types: B-tree, Hash, GiST, GIN, SP-GiST, BRIN, Bloom</p>
<p><strong>ACID Properties</strong> ‚Üí Atomicity, Consistency, Isolation,
Durability - the four transaction guarantees ‚Üí See: <a href="../00-introduction.md#15-core-features">Introduction - Core
Features</a></p>
<p><strong>Aggregate Functions</strong> ‚Üí Functions computing a single
result from multiple input rows (SUM, AVG, COUNT, etc.) ‚Üí See: <a href="../02-query-processing/query-pipeline.md">Query Processing -
Executor</a></p>
<p><strong>Analyzer</strong> ‚Üí Query processing stage performing
semantic analysis ‚Üí File: <code>src/backend/parser/analyze.c</code> ‚Üí
Converts parse tree to query tree with validation</p>
<p><strong>Autovacuum</strong> ‚Üí Background process automatically
performing VACUUM and ANALYZE ‚Üí See: <a href="../05-processes/process-architecture.md">Process Architecture -
Auxiliary Processes</a> ‚Üí Configurable via GUC parameters: autovacuum,
autovacuum_naptime</p>
<p><strong>Auxiliary Processes</strong> ‚Üí Background worker processes
(bgwriter, checkpointer, walwriter, autovacuum, etc.) ‚Üí See: <a href="../05-processes/process-architecture.md">Process
Architecture</a></p>
<hr/>
<h2 data-number="15.2" id="b-1"><span class="header-section-number">15.2</span> B</h2>
<p><strong>Backend Process</strong> ‚Üí Server process dedicated to
handling a single client connection ‚Üí File:
<code>src/backend/postmaster/postgres.c</code> ‚Üí Lifecycle: fork ‚Üí
authentication ‚Üí query processing loop</p>
<p><strong>Base Backup</strong> ‚Üí Complete copy of database cluster
taken while running ‚Üí Created using <code>pg_basebackup</code> utility ‚Üí
Used for point-in-time recovery and standby creation</p>
<p><strong>Benchmarking (pgbench)</strong> ‚Üí Utility for performance
testing with TPC-B-like workloads ‚Üí File:
<code>src/bin/pgbench/pgbench.c</code> ‚Üí See: <a href="../07-utilities/utility-programs.md">Utilities - pgbench</a></p>
<p><strong>Berkeley POSTGRES</strong> ‚Üí Original research database at UC
Berkeley (1986-1994) ‚Üí Created by Michael Stonebraker ‚Üí Predecessor to
PostgreSQL with PostQUEL query language</p>
<p><strong>bgwriter (Background Writer)</strong> ‚Üí Process that writes
dirty buffers from shared memory to disk ‚Üí File:
<code>src/backend/postmaster/bgwriter.c</code> ‚Üí Smooths I/O load
preventing sudden flush storms</p>
<p><strong>Bitmap Index Scan</strong> ‚Üí Index scan method building
bitmap of matching tuples before heap access ‚Üí Efficient for multiple
index conditions ‚Üí See: <a href="../02-query-processing/query-pipeline.md">Query Processing - Index
Scans</a></p>
<p><strong>BKI (Backend Interface)</strong> ‚Üí Format for bootstrap data
files creating initial system catalogs ‚Üí Files:
<code>src/include/catalog/postgres.bki</code> ‚Üí See: <a href="../09-build-system-and-portability.md">Build System -
Bootstrap</a></p>
<p><strong>Bloom Index</strong> ‚Üí Probabilistic index type using Bloom
filters ‚Üí Compact, space-efficient for large bitmaps ‚Üí Available in
contrib module</p>
<p><strong>Block/Page</strong> ‚Üí Fundamental 8KB unit of storage
organization ‚Üí Standard size configurable at compile time (1, 2, 4, 8,
16, 32 KB) ‚Üí See: <a href="../01-storage/storage-layer.md">Storage -
Page Structure</a></p>
<p><strong>Block Range Index (BRIN)</strong> ‚Üí Compact index storing
summaries (min/max) for page ranges ‚Üí Excellent for correlated data in
large tables ‚Üí See: <a href="../01-storage/storage-layer.md">Storage -
Index Access Methods</a></p>
<p><strong>BRIN Index</strong> ‚Üí See: Block Range Index</p>
<p><strong>B-tree</strong> ‚Üí Default index type implementing Lehman and
Yao high-concurrency B+ tree ‚Üí File:
<code>src/backend/access/nbtree/</code> ‚Üí Optimal for range queries and
equality searches</p>
<p><strong>Buffer</strong> ‚Üí In-memory copy of a disk page managed by
buffer manager ‚Üí Part of buffer pool (shared_buffers) ‚Üí See: <a href="../01-storage/storage-layer.md">Storage - Buffer Manager</a></p>
<p><strong>BufferDesc</strong> ‚Üí C structure representing buffer pool
entry metadata ‚Üí File: <code>src/include/storage/buf_internals.h</code>
‚Üí Contains: page content, usage count, pins, locks, LSN</p>
<p><strong>Buffer Manager</strong> ‚Üí Subsystem managing buffer pool with
clock-sweep replacement algorithm ‚Üí File:
<code>src/backend/storage/buffer/bufmgr.c</code> (7,468 lines) ‚Üí See: <a href="../01-storage/storage-layer.md">Storage - Buffer
Management</a></p>
<p><strong>Buffer Pool</strong> ‚Üí Collection of shared memory buffers
for caching disk pages ‚Üí Size: controlled by <code>shared_buffers</code>
GUC parameter ‚Üí See: <a href="../01-storage/storage-layer.md">Storage -
Buffer Manager</a></p>
<hr/>
<h2 data-number="15.3" id="c-1"><span class="header-section-number">15.3</span> C</h2>
<p><strong>Catalog System</strong> ‚Üí System tables storing metadata
about database objects ‚Üí Key tables: pg_class, pg_attribute, pg_proc,
pg_type, etc. ‚Üí File: <code>src/include/catalog/</code> ‚Üí See: <a href="../02-query-processing/query-pipeline.md">Query Processing -
Catalog System</a></p>
<p><strong>Checkpointer</strong> ‚Üí Process performing checkpoints to
ensure data durability ‚Üí File:
<code>src/backend/postmaster/checkpointer.c</code> ‚Üí Flushes dirty
buffers and creates recovery points</p>
<p><strong>Checkpoint</strong> ‚Üí Point in WAL sequence where all data
file changes written to disk ‚Üí Enables recovery to that point ‚Üí
Seven-phase process: REDO, checkpoint, CLOG, commit, data, sync, done ‚Üí
See: <a href="../01-storage/storage-layer.md">Storage - Write-Ahead
Logging</a></p>
<p><strong>Clock-Sweep</strong> ‚Üí Buffer replacement algorithm
approximating LRU with minimal overhead ‚Üí File:
<code>src/backend/storage/buffer/freelist.c</code> ‚Üí Uses ‚Äúusage count‚Äù
and clock hand positions</p>
<p><strong>CID (Command ID)</strong> ‚Üí Identifier for a command within a
transaction ‚Üí Type: 32-bit unsigned integer ‚Üí See: <a href="../01-storage/storage-layer.md">Storage - MVCC</a></p>
<p><strong>CLOG (Commit Log)</strong> ‚Üí Formerly called ‚Äúcommit log‚Äù,
now pg_xact ‚Üí SLRU storing transaction commit status ‚Üí See: <a href="../03-transactions/transaction-management.md">Transactions -
Commit Log</a></p>
<p><strong>CLRU (Circular LRU)</strong> ‚Üí See: Clock-Sweep</p>
<p><strong>Cluster (Database Cluster)</strong> ‚Üí Collection of databases
managed by single PostgreSQL server ‚Üí Stored in PGDATA directory ‚Üí See:
<a href="../00-introduction.md">Installation - Data Directory</a></p>
<p><strong>Commitfest</strong> ‚Üí Month-long period focused on reviewing
patches ‚Üí System for fair patch evaluation ‚Üí See: <a href="../00-introduction.md#31-development-process">Introduction -
Community Development</a> ‚Üí Tool: commitfest.postgresql.org</p>
<p><strong>Common Table Expression (CTE)</strong> ‚Üí Named subquery
defined with WITH clause ‚Üí Can be recursive (WITH RECURSIVE) ‚Üí See: <a href="../02-query-processing/query-pipeline.md">Query Processing -
CTEs</a></p>
<p><strong>Connection Pooling</strong> ‚Üí Technique for reusing database
connections ‚Üí External tools: PgBouncer, pgPool-II ‚Üí Reduces overhead of
process spawning</p>
<p><strong>Cost Estimation</strong> ‚Üí Process of predicting resource
usage for different query plans ‚Üí Uses statistical models and GUC
parameters ‚Üí File: <code>src/backend/optimizer/path/costsize.c</code>
(220,428 lines) ‚Üí See: <a href="../02-query-processing/query-pipeline.md">Query Processing - Cost
Model</a></p>
<p><strong>Cost Model Parameters</strong> ‚Üí GUC variables controlling
planner cost estimation ‚Üí Key parameters: seq_page_cost,
random_page_cost, cpu_operator_cost ‚Üí See: <a href="../02-query-processing/query-pipeline.md">Query Processing - Cost
Model</a></p>
<p><strong>CREATE DATABASE</strong> ‚Üí SQL command to create new database
‚Üí Creates new catalog entry and data directories ‚Üí See: <a href="../00-introduction.md">SQL - DDL</a></p>
<p><strong>CREATE EXTENSION</strong> ‚Üí SQL command to install extension
‚Üí Loads control file and executes SQL script ‚Üí See: <a href="../06-extensions/extension-system.md">Extensions - Extension
System</a></p>
<p><strong>CREATE INDEX</strong> ‚Üí SQL command to create index ‚Üí
Supports multiple index types and options ‚Üí See: <a href="../01-storage/storage-layer.md">Storage - Index Access
Methods</a></p>
<p><strong>CREATE TABLE</strong> ‚Üí SQL command to create table ‚Üí
Registers in pg_class and related catalogs ‚Üí See: <a href="../00-introduction.md">SQL - DDL</a></p>
<p><strong>CRC32C</strong> ‚Üí Cyclic Redundancy Check for data integrity
‚Üí Hardware-accelerated: SSE4.2, ARM, AVX-512 ‚Üí Used in WAL and page
checksums</p>
<p><strong>ctid</strong> ‚Üí System column containing tuple‚Äôs physical
location ‚Üí Format: (page_number, tuple_index) ‚Üí See: <a href="../01-storage/storage-layer.md">Storage - Tuple Format</a></p>
<hr/>
<h2 data-number="15.4" id="d-1"><span class="header-section-number">15.4</span> D</h2>
<p><strong>Data Directory (PGDATA)</strong> ‚Üí Directory containing all
database files, configuration, and WAL ‚Üí Set by initdb command ‚Üí See: <a href="../05-processes/process-architecture.md">Process Architecture -
Postmaster</a></p>
<p><strong>Data Structure Node Types</strong> ‚Üí Uniform handling for
copying, serialization, and debugging ‚Üí Implemented with T_* macros and
switch statements ‚Üí File: <code>src/include/nodes/nodes.h</code></p>
<p><strong>Database Cluster</strong> ‚Üí See: Cluster</p>
<p><strong>Database Independence</strong> ‚Üí PostgreSQL design allowing
multiple databases in one cluster ‚Üí Each database has independent
namespace ‚Üí See: <a href="../00-introduction.md">Introduction -
Architecture</a></p>
<p><strong>DARPA</strong> ‚Üí Defense Advanced Research Projects Agency ‚Üí
Funded original Berkeley POSTGRES research (1986-1992) ‚Üí See: <a href="../00-introduction.md#22-the-berkeley-postgres-era">Introduction -
Historical Context</a></p>
<p><strong>Deadlock</strong> ‚Üí Circular wait condition where
transactions block each other ‚Üí Detected by deadlock detection process ‚Üí
Resolved by aborting one transaction ‚Üí See: <a href="../03-transactions/transaction-management.md">Transactions -
Locking</a></p>
<p><strong>Deadlock Detection</strong> ‚Üí Process detecting circular
waits in lock graph ‚Üí File:
<code>src/backend/storage/lmgr/deadlock.c</code> ‚Üí Builds wait-for graph
and finds cycles</p>
<p><strong>DELETE</strong> ‚Üí SQL command to remove rows from table ‚Üí
Implemented via heap_delete() function ‚Üí Marks tuples as deleted
(MVCC-aware) ‚Üí See: <a href="../01-storage/storage-layer.md">Storage -
Heap Access Method</a></p>
<p><strong>Direct I/O</strong> ‚Üí I/O operations bypassing kernel cache ‚Üí
Not default in PostgreSQL (uses OS cache) ‚Üí Requires platform
support</p>
<p><strong>Dirty Buffer</strong> ‚Üí Buffer whose content differs from
disk page ‚Üí Written to disk by bgwriter or checkpointer ‚Üí See: <a href="../01-storage/storage-layer.md">Storage - Buffer Manager</a></p>
<p><strong>Disk Drive Organization</strong> ‚Üí See: Page Structure,
Block</p>
<p><strong>DTM (Dynamic Transaction Manager)</strong> ‚Üí Distributed
transaction coordination (in Postgres-XL extensions) ‚Üí Not in core
PostgreSQL</p>
<hr/>
<h2 data-number="15.5" id="e-1"><span class="header-section-number">15.5</span> E</h2>
<p><strong>Effective User ID</strong> ‚Üí Unix user ID determining session
privileges ‚Üí Set via SECURITY DEFINER functions ‚Üí See: <a href="../05-processes/process-architecture.md">Security -
Authentication</a></p>
<p><strong>Eisentraut, Peter</strong> ‚Üí Long-time PostgreSQL contributor
‚Üí Expertise: Internationalization, build system, SQL standards ‚Üí See: <a href="../00-introduction.md#32-key-contributors">Introduction - Key
Contributors</a></p>
<p><strong>Encoding Support</strong> ‚Üí Multi-byte character encoding
support ‚Üí Supported: UTF-8, LATIN1, EUC_JP, etc. ‚Üí Configured per
database ‚Üí See: <a href="../09-build-system-and-portability.md">Build
System - Internationalization</a></p>
<p><strong>ENUM Type</strong> ‚Üí Custom data type for enumerated values ‚Üí
Introduced in PostgreSQL 8.3 ‚Üí Ordered, comparable with indexes
supported ‚Üí See: <a href="../00-introduction.md#15-core-features">Introduction - Data
Types</a></p>
<p><strong>Event Handling</strong> ‚Üí Mechanism for process event
notification ‚Üí File: <code>src/backend/storage/lmgr/latch.c</code> ‚Üí
WaitEventSet API for efficient event waiting</p>
<p><strong>Executor</strong> ‚Üí Query processing stage executing plans ‚Üí
File: <code>src/backend/executor/execMain.c</code> (2,833 lines) ‚Üí See:
<a href="../02-query-processing/query-pipeline.md">Query Processing -
Executor</a></p>
<p><strong>Execution Nodes</strong> ‚Üí Data structures representing plan
execution steps ‚Üí File: <code>src/include/nodes/execnodes.h</code> ‚Üí
Types: SeqScanState, HashJoinState, etc.</p>
<p><strong>Executor Hooks</strong> ‚Üí Extensibility points allowing plan
modification during execution ‚Üí See: <a href="../06-extensions/extension-system.md">Extensions - Hooks</a></p>
<p><strong>Extension Control File</strong> ‚Üí File specifying extension
metadata and dependencies ‚Üí Format: <code>extension_name.control</code>
‚Üí Location: <code>SHAREDIR/extension/</code> ‚Üí See: <a href="../06-extensions/extension-system.md">Extensions - Extension
System</a></p>
<p><strong>Extension System</strong> ‚Üí Mechanism for adding custom
functionality without modifying core ‚Üí Supports: custom types,
operators, functions, index methods, hooks ‚Üí See: <a href="../06-extensions/extension-system.md">Extensions - Extension
System</a></p>
<p><strong>External Sorting</strong> ‚Üí Sorting algorithm for data
exceeding work_mem ‚Üí Uses temporary disk files for spillover ‚Üí
Implemented with merge phases ‚Üí See: <a href="../02-query-processing/query-pipeline.md">Query Processing -
Executor</a></p>
<hr/>
<h2 data-number="15.6" id="f-1"><span class="header-section-number">15.6</span> F</h2>
<p><strong>Failure Scenarios</strong> ‚Üí Designed resilience against:
power loss, system crash, disk failure ‚Üí Mitigated by WAL, checksums,
replication ‚Üí See: <a href="../01-storage/storage-layer.md">Storage -
Write-Ahead Logging</a></p>
<p><strong>FDW (Foreign Data Wrapper)</strong> ‚Üí Interface for querying
external data sources ‚Üí Built-in: postgres_fdw, file_fdw ‚Üí See: <a href="../06-extensions/extension-system.md">Extensions - Foreign Data
Wrappers</a></p>
<p><strong>FIFO (First In First Out)</strong> ‚Üí Queue discipline used in
some systems (not buffer manager) ‚Üí See: Clock-Sweep</p>
<p><strong>File Organization</strong> ‚Üí Heap files: tuples appended
sequentially ‚Üí Index files: structured by access method ‚Üí See: <a href="../01-storage/storage-layer.md">Storage</a></p>
<p><strong>First Normal Form (1NF)</strong> ‚Üí No repeating groups of
attributes ‚Üí Assumed in relational databases ‚Üí See: <a href="../00-introduction.md">Introduction - Core Concepts</a></p>
<p><strong>Foreign Key</strong> ‚Üí Constraint enforcing referential
integrity ‚Üí Referencing column(s) must exist in referenced table ‚Üí See:
<a href="../00-introduction.md#15-core-features">Introduction -
Constraints</a></p>
<p><strong>Fork (Table Fork)</strong> ‚Üí Separate physical file for table
relation ‚Üí Types: main, init, fsm, vm ‚Üí See: <a href="../01-storage/storage-layer.md">Storage - Page Structure</a></p>
<p><strong>Free Space Map (FSM)</strong> ‚Üí Tracks available space in
heap pages for INSERT operations ‚Üí File:
<code>src/backend/storage/freespace/freespace.c</code> ‚Üí SLRU-based
variable-length encoding ‚Üí See: <a href="../01-storage/storage-layer.md">Storage - Free Space Map</a></p>
<p><strong>Freund, Andres</strong> ‚Üí PostgreSQL core contributor ‚Üí
Expertise: Performance optimization, JIT compilation, query execution ‚Üí
See: <a href="../00-introduction.md#32-key-contributors">Introduction -
Key Contributors</a></p>
<p><strong>Full Table Scan</strong> ‚Üí Sequential scan reading all tuples
from heap ‚Üí Fallback when no suitable index exists ‚Üí See: <a href="../02-query-processing/query-pipeline.md">Query Processing -
Executor</a></p>
<p><strong>Full-Text Search</strong> ‚Üí Built-in text search with ranking
‚Üí Uses tsvector and tsquery types ‚Üí Multiple languages supported with
custom dictionaries ‚Üí See: <a href="../00-introduction.md#15-core-features">Introduction - Data
Types</a></p>
<hr/>
<h2 data-number="15.7" id="g-1"><span class="header-section-number">15.7</span> G</h2>
<p><strong>GiN (Generalized Inverted Index)</strong> ‚Üí Index type for
arrays, JSONB, and full-text search ‚Üí Structure: inverted index ‚Üí File:
<code>src/backend/access/gin/</code> ‚Üí See: <a href="../01-storage/storage-layer.md">Storage - Index Access
Methods</a></p>
<p><strong>GiST (Generalized Search Tree)</strong> ‚Üí Framework for
creating custom index types ‚Üí Used for geometric, full-text, and range
queries ‚Üí File: <code>src/backend/access/gist/</code> ‚Üí See: <a href="../01-storage/storage-layer.md">Storage - Index Access
Methods</a></p>
<p><strong>Global Development Group (PostgreSQL)</strong> ‚Üí Informal
organization managing PostgreSQL development ‚Üí Structure: Core Team (7
members) + Committers (~20-30) + Contributors ‚Üí Decision-making:
Consensus-driven, no BDFL ‚Üí See: <a href="../00-introduction.md#32-key-contributors">Introduction -
Community</a></p>
<p><strong>Glossary</strong> ‚Üí Comprehensive terminology reference ‚Üí
See: <a href="glossary.md">Appendices - Glossary</a></p>
<p><strong>GRANTs</strong> ‚Üí SQL command to assign privileges to roles ‚Üí
Granularity: database, schema, table, column ‚Üí See: <a href="../00-introduction.md">SQL - Privileges</a></p>
<p><strong>Grammar (Bison)</strong> ‚Üí SQL language grammar definition ‚Üí
File: <code>src/backend/parser/gram.y</code> (17,896 lines) ‚Üí Produces
parse tree from token stream ‚Üí See: <a href="../02-query-processing/query-pipeline.md">Query Processing -
Parser</a></p>
<p><strong>GRP (Group)</strong> ‚Üí File permissions group ownership ‚Üí
PostgreSQL processes typically run as ‚Äòpostgres‚Äô user ‚Üí See: <a href="../05-processes/process-architecture.md">Security - File
Permissions</a></p>
<p><strong>GUC (Grand Unified Configuration)</strong> ‚Üí Unified
configuration parameter system ‚Üí Parameters: PGC_POSTMASTER, PGC_SIGHUP,
PGC_BACKEND, PGC_USER ‚Üí File: <code>src/backend/utils/misc/guc.c</code>
‚Üí See: <a href="#configuration-parameters-section">Configuration
Parameters</a></p>
<hr/>
<h2 data-number="15.8" id="h-1"><span class="header-section-number">15.8</span> H</h2>
<p><strong>Hagander, Magnus</strong> ‚Üí PostgreSQL core contributor ‚Üí
Expertise: Windows port, infrastructure, replication ‚Üí See: <a href="../00-introduction.md#32-key-contributors">Introduction - Key
Contributors</a></p>
<p><strong>Hash Index</strong> ‚Üí Index type for equality operations ‚Üí
Structure: hash table with chaining ‚Üí File:
<code>src/backend/access/hash/</code> ‚Üí See: <a href="../01-storage/storage-layer.md">Storage - Index Access
Methods</a></p>
<p><strong>Hash Join</strong> ‚Üí Join algorithm using in-memory hash
table ‚Üí Efficient for joining large relations ‚Üí See: <a href="../02-query-processing/query-pipeline.md">Query Processing - Join
Algorithms</a></p>
<p><strong>Heap</strong> ‚Üí Storage system for table data (relations) ‚Üí
Unordered collection of tuples ‚Üí Access method: heap_scan, heap_insert,
heap_update, heap_delete ‚Üí See: <a href="../01-storage/storage-layer.md">Storage - Heap Access
Method</a></p>
<p><strong>heap_delete</strong> ‚Üí Function removing tuple from heap ‚Üí
File: <code>src/backend/access/heap/heapam.c</code> ‚Üí Marks tuple
deleted, updates indexes ‚Üí See: <a href="../01-storage/storage-layer.md">Storage - Heap Access
Method</a></p>
<p><strong>heap_insert</strong> ‚Üí Function inserting tuple into heap ‚Üí
File: <code>src/backend/access/heap/heapam.c</code> ‚Üí Returns TID of
inserted tuple for index creation ‚Üí See: <a href="../01-storage/storage-layer.md">Storage - Heap Access
Method</a></p>
<p><strong>heap_update</strong> ‚Üí Function updating tuple in heap ‚Üí
File: <code>src/backend/access/heap/heapam.c</code> ‚Üí MVCC-aware,
handles HOT optimization ‚Üí See: <a href="../01-storage/storage-layer.md">Storage - Heap Access
Method</a></p>
<p><strong>Heap-Only Tuple (HOT)</strong> ‚Üí Optimization for updates not
changing indexed columns ‚Üí Chains tuples on same page without index
updates ‚Üí Reduces index bloat and I/O ‚Üí See: <a href="../01-storage/storage-layer.md">Storage - Heap Access
Method</a></p>
<p><strong>HeapTupleHeaderData</strong> ‚Üí C structure for tuple header
metadata ‚Üí File: <code>src/include/access/htup_details.h</code> ‚Üí
Contains: transaction IDs, infomask, attribute offset ‚Üí See: <a href="../01-storage/storage-layer.md">Storage - Tuple Structure</a></p>
<p><strong>HOT (Heap-Only Tuple)</strong> ‚Üí See: Heap-Only Tuple</p>
<p><strong>Hot Standby</strong> ‚Üí Feature allowing read queries on
physical replica ‚Üí Requires standby_mode = on ‚Üí Conflicts resolved by
canceling queries ‚Üí See: <a href="../04-replication/replication-recovery.md">Replication - Hot
Standby</a></p>
<p><strong>Hot Standby Feedback</strong> ‚Üí Mechanism preventing standby
queries from blocking master VACUUM ‚Üí Sends oldest non-write-only XID
back to master ‚Üí See: <a href="../04-replication/replication-recovery.md">Replication - Hot
Standby</a></p>
<hr/>
<h2 data-number="15.9" id="i-1"><span class="header-section-number">15.9</span> I</h2>
<p><strong>Index</strong> ‚Üí Data structure optimizing data access for
specific columns/expressions ‚Üí Types: B-tree, Hash, GiST, GIN, SP-GiST,
BRIN, Bloom ‚Üí See: <a href="../01-storage/storage-layer.md">Storage -
Index Access Methods</a></p>
<p><strong>Index Access Method</strong> ‚Üí Interface for implementing
custom index types ‚Üí See: Access Method (AM)</p>
<p><strong>Index Bloat</strong> ‚Üí Accumulation of dead entries in index
pages ‚Üí Mitigated by HOT optimization and REINDEX ‚Üí See: <a href="../01-storage/storage-layer.md">Storage - Heap-Only Tuple</a></p>
<p><strong>Index-Only Scan</strong> ‚Üí Index scan returning all result
columns directly ‚Üí Does not access heap pages (when visibility map
allows) ‚Üí See: <a href="../02-query-processing/query-pipeline.md">Query
Processing - Index Scans</a></p>
<p><strong>Ingres</strong> ‚Üí Interactive Graphics and Retrieval System ‚Üí
Predecessor to POSTGRES by Michael Stonebraker ‚Üí See: <a href="../00-introduction.md#22-the-berkeley-postgres-era">Introduction -
Historical Context</a></p>
<p><strong>initdb</strong> ‚Üí Utility creating new PostgreSQL database
cluster ‚Üí File: <code>src/bin/initdb/initdb.c</code> ‚Üí Creates system
catalogs and bootstrap database ‚Üí See: <a href="../07-utilities/utility-programs.md">Utilities - initdb</a></p>
<p><strong>Inline Function</strong> ‚Üí User-defined function inlined into
query plan ‚Üí Requires LANGUAGE sql and IMMUTABLE designation ‚Üí See: <a href="../06-extensions/extension-system.md">Extensions -
Functions</a></p>
<p><strong>INSERT</strong> ‚Üí SQL command adding rows to table ‚Üí Executes
heap_insert() for each row ‚Üí See: <a href="../01-storage/storage-layer.md">Storage - Heap Access
Method</a></p>
<p><strong>INSERT ‚Ä¶ ON CONFLICT</strong> ‚Üí Upsert command (MERGE
alternative) ‚Üí Introduced in PostgreSQL 9.5 ‚Üí Specifies action on unique
constraint violation ‚Üí See: <a href="../00-introduction.md">Introduction
- SQL Features</a></p>
<p><strong>Isolation Level</strong> ‚Üí Level of consistency for
concurrent transactions ‚Üí Levels: READ UNCOMMITTED, READ COMMITTED,
REPEATABLE READ, SERIALIZABLE ‚Üí Default: READ COMMITTED ‚Üí See: <a href="../03-transactions/transaction-management.md">Transactions -
Isolation Levels</a></p>
<p><strong>ItemIdData</strong> ‚Üí C structure for item pointer (line
pointer) ‚Üí File: <code>src/include/storage/itemid.h</code> ‚Üí Maps
logical tuple ID to physical offset ‚Üí See: <a href="../01-storage/storage-layer.md">Storage - Item Pointers</a></p>
<p><strong>ItemPointer</strong> ‚Üí Logical pointer to tuple location ‚Üí
Type: (block_number, offset_number) ‚Üí Provides indirection enabling page
defragmentation ‚Üí See: <a href="../01-storage/storage-layer.md">Storage
- Item Pointers</a></p>
<hr/>
<h2 data-number="15.10" id="j-1"><span class="header-section-number">15.10</span> J</h2>
<p><strong>JIT Compilation</strong> ‚Üí Just-In-Time compilation of
expressions to machine code ‚Üí Uses LLVM ‚Üí Controlled by: jit,
jit_above_cost, jit_inline_above_cost ‚Üí Introduced in PostgreSQL 11 ‚Üí
See: <a href="../02-query-processing/query-pipeline.md">Query Processing
- Expression Evaluation</a></p>
<p><strong>JOIN</strong> ‚Üí SQL operation combining rows from multiple
tables ‚Üí Types: INNER, LEFT, RIGHT, FULL, CROSS ‚Üí Algorithms: Nested
Loop, Hash Join, Merge Join ‚Üí See: <a href="../02-query-processing/query-pipeline.md">Query Processing - Join
Algorithms</a></p>
<p><strong>JSON/JSONB</strong> ‚Üí JSON data types with indexing support ‚Üí
json: text storage, JSONB: binary with indexing ‚Üí Introduced: JSON
(8.2), JSONB (9.4) ‚Üí See: <a href="../00-introduction.md#15-core-features">Introduction - Data
Types</a></p>
<hr/>
<h2 data-number="15.11" id="k-1"><span class="header-section-number">15.11</span> K</h2>
<p><strong>Key-Value Store</strong> ‚Üí NoSQL pattern sometimes compared
to PostgreSQL with JSONB ‚Üí PostgreSQL more structured with ACID
guarantees ‚Üí See: <a href="../00-introduction.md">Introduction -
Features</a></p>
<p><strong>Keyword</strong> ‚Üí Reserved SQL word recognized by parser ‚Üí
File: <code>src/backend/parser/keywords.c</code> ‚Üí See: <a href="../02-query-processing/query-pipeline.md">Query Processing -
Parser</a></p>
<hr/>
<h2 data-number="15.12" id="l-1"><span class="header-section-number">15.12</span> L</h2>
<p><strong>Lane, Tom</strong> ‚Üí Most prolific PostgreSQL contributor
(82,565 mailing list emails) ‚Üí Expertise: Query optimizer, code review ‚Üí
Seen as ‚Äúfirst among equals‚Äù in decision-making ‚Üí See: <a href="../00-introduction.md#32-key-contributors">Introduction - Key
Contributors</a></p>
<p><strong>Latch</strong> ‚Üí Efficient inter-process communication
mechanism ‚Üí File: <code>src/backend/storage/lmgr/latch.c</code> ‚Üí Allows
event-driven waiting without busy loops ‚Üí See: <a href="../05-processes/process-architecture.md">Process Architecture -
IPC</a></p>
<p><strong>Lateral Join</strong> ‚Üí Join allowing right-hand side to
reference left columns ‚Üí Used with set-returning functions ‚Üí Introduced
in PostgreSQL 9.3 ‚Üí See: <a href="../02-query-processing/query-pipeline.md">Query Processing - Join
Algorithms</a></p>
<p><strong>Lehman and Yao B-Tree</strong> ‚Üí High-concurrency B-tree
algorithm used by PostgreSQL ‚Üí Allows lock-free searches during tree
modification ‚Üí See: <a href="../01-storage/storage-layer.md">Storage -
B-tree Index</a></p>
<p><strong>Lexer</strong> ‚Üí Tokenizer converting SQL text to token
stream ‚Üí File: <code>src/backend/parser/scan.l</code> (Flex-based) ‚Üí
Handles keywords, identifiers, literals, operators ‚Üí See: <a href="../02-query-processing/query-pipeline.md">Query Processing -
Parser</a></p>
<p><strong>Line Pointer</strong> ‚Üí See: ItemPointer</p>
<p><strong>Locking</strong> ‚Üí Mechanism for controlling concurrent
access to data ‚Üí Three-tier system: spinlocks, LWLocks, heavyweight
locks ‚Üí See: <a href="../03-transactions/transaction-management.md">Transactions -
Locking</a></p>
<p><strong>Log Sequence Number (LSN)</strong> ‚Üí Byte offset in WAL
stream identifying position ‚Üí Type: uint64 ‚Üí Used for recovery,
replication, MVCC ‚Üí See: <a href="../01-storage/storage-layer.md">Storage - Write-Ahead
Logging</a></p>
<p><strong>Logical Decoding</strong> ‚Üí Process extracting logical
changes from WAL ‚Üí Foundation for logical replication ‚Üí File:
<code>src/backend/replication/logical/</code> ‚Üí See: <a href="../04-replication/replication-recovery.md">Replication - Logical
Replication</a></p>
<p><strong>Logical Replication</strong> ‚Üí Row-level replication of
logical changes ‚Üí Selective table replication across versions ‚Üí
Introduced in PostgreSQL 10 ‚Üí See: <a href="../04-replication/replication-recovery.md">Replication - Logical
Replication</a></p>
<p><strong>LSN</strong> ‚Üí See: Log Sequence Number</p>
<p><strong>LWLock (Lightweight Lock)</strong> ‚Üí Efficient lock for
shared memory synchronization ‚Üí File:
<code>src/backend/storage/lmgr/lwlock.c</code> ‚Üí Spinlock + wait queue ‚Üí
See: <a href="../03-transactions/transaction-management.md">Transactions
- Locking</a></p>
<hr/>
<h2 data-number="15.13" id="m-1"><span class="header-section-number">15.13</span> M</h2>
<p><strong>Mailing Lists</strong> ‚Üí Primary communication channel for
PostgreSQL development ‚Üí Key lists: pgsql-hackers, pgsql-bugs,
pgsql-general, pgsql-performance, pgsql-admin ‚Üí Archives: searchable,
permanent record ‚Üí See: <a href="../00-introduction.md#31-development-process">Introduction -
Development Process</a></p>
<p><strong>Materialized View</strong> ‚Üí View with stored result set ‚Üí
Requires manual refresh (or REFRESH ‚Ä¶ CONCURRENTLY) ‚Üí Introduced in
PostgreSQL 9.3 ‚Üí See: <a href="../00-introduction.md">SQL -
Views</a></p>
<p><strong>Maximum Transaction ID (MAXOID)</strong> ‚Üí Upper bound on
transaction ID values ‚Üí 32-bit: 2^31 - 1 (approximately 2 billion) ‚Üí
Wraparound managed via vacuum ‚Üí See: <a href="../03-transactions/transaction-management.md">Transactions -
MVCC</a></p>
<p><strong>Merge Join</strong> ‚Üí Join algorithm using pre-sorted inputs
‚Üí Efficient for sorted data or large joins ‚Üí See: <a href="../02-query-processing/query-pipeline.md">Query Processing - Join
Algorithms</a></p>
<p><strong>Merge Statement</strong> ‚Üí SQL command for conditional
insert/update ‚Üí Equivalent to upsert ‚Üí Introduced in PostgreSQL 15 ‚Üí
See: <a href="../00-introduction.md">Introduction - SQL Features</a></p>
<p><strong>Metadata</strong> ‚Üí Data about data (catalog information) ‚Üí
Stored in system tables (pg_class, pg_attribute, etc.) ‚Üí See: <a href="../02-query-processing/query-pipeline.md">Query Processing -
Catalog System</a></p>
<p><strong>Michael Stonebraker</strong> ‚Üí Creator of POSTGRES and Ingres
‚Üí Turing Award winner ‚Üí Academic advisor to PostgreSQL‚Äôs founding ‚Üí See:
<a href="../00-introduction.md#22-the-berkeley-postgres-era">Introduction -
Historical Context</a></p>
<p><strong>Minmax Index</strong> ‚Üí See: BRIN Index</p>
<p><strong>Momjian, Bruce</strong> ‚Üí PostgreSQL core team member ‚Üí
Expertise: Advocacy, community building, documentation ‚Üí See: <a href="../00-introduction.md#32-key-contributors">Introduction - Key
Contributors</a></p>
<p><strong>Modulo Arithmetic</strong> ‚Üí Used for transaction ID
comparison ‚Üí Handles XID wraparound with modulo-2^32 ‚Üí See: <a href="../03-transactions/transaction-management.md">Transactions -
MVCC</a></p>
<p><strong>Meson Build System</strong> ‚Üí Alternative build system to
Autoconf ‚Üí Faster, more maintainable configuration ‚Üí Used as primary in
PostgreSQL 15+ ‚Üí See: <a href="../09-build-system-and-portability.md">Build System -
Meson</a></p>
<p><strong>MVCC (Multi-Version Concurrency Control)</strong> ‚Üí
Concurrency control mechanism allowing readers and writers to coexist ‚Üí
Each transaction sees consistent snapshot ‚Üí Implemented via transaction
IDs and tuple visibility rules ‚Üí See: <a href="../01-storage/storage-layer.md">Storage - MVCC</a></p>
<hr/>
<h2 data-number="15.14" id="n-1"><span class="header-section-number">15.14</span> N</h2>
<p><strong>Nested Loop Join</strong> ‚Üí Join algorithm comparing every
row of left to right table ‚Üí Simplest but potentially slowest algorithm
‚Üí See: <a href="../02-query-processing/query-pipeline.md">Query
Processing - Join Algorithms</a></p>
<p><strong>Node Types</strong> ‚Üí Unified data structure representation
in query trees ‚Üí File: <code>src/include/nodes/nodes.h</code> ‚Üí Include:
Query, Plan, Expr, Var, Const, etc. ‚Üí See: <a href="../02-query-processing/query-pipeline.md">Query Processing - Node
Types</a></p>
<p><strong>Normalization</strong> ‚Üí Process of organizing data to reduce
redundancy ‚Üí Normal forms: 1NF, 2NF, 3NF, BCNF, 4NF, 5NF ‚Üí See: <a href="../00-introduction.md">Introduction - Concepts</a></p>
<p><strong>NOT NULL Constraint</strong> ‚Üí Constraint requiring column to
have non-NULL value ‚Üí Enforced at insertion and update ‚Üí See: <a href="../00-introduction.md">SQL - Constraints</a></p>
<p><strong>Number of Tuples</strong> ‚Üí Cardinality statistic used in
cost estimation ‚Üí Updated by ANALYZE command ‚Üí Stored in pg_stats view ‚Üí
See: <a href="../02-query-processing/query-pipeline.md">Query Processing
- Cost Model</a></p>
<hr/>
<h2 data-number="15.15" id="o-1"><span class="header-section-number">15.15</span> O</h2>
<p><strong>Object-Relational Database</strong> ‚Üí Relational database
with object-oriented features ‚Üí Supports custom types, operators,
inheritance ‚Üí PostgreSQL: full ORDBMS ‚Üí See: <a href="../00-introduction.md#11-definition-and-core-characteristics">Introduction
- Definition</a></p>
<p><strong>ORDBMS</strong> ‚Üí See: Object-Relational Database</p>
<p><strong>On-Disk Format</strong> ‚Üí Physical layout of data in files ‚Üí
Stable across versions (with upgrade mechanisms) ‚Üí See: <a href="../01-storage/storage-layer.md">Storage - Page Structure</a></p>
<p><strong>Operator</strong> ‚Üí Comparison, arithmetic, or string
operation ‚Üí User-definable with custom implementations ‚Üí Index types
determine supported operators ‚Üí See: <a href="../00-introduction.md">Introduction - Extensibility</a></p>
<p><strong>Operator Family</strong> ‚Üí Group of operators working with
same index type ‚Üí File: <code>src/backend/catalog/pg_opfamily.h</code> ‚Üí
Enables multiple operators for one index ‚Üí See: <a href="../01-storage/storage-layer.md">Storage - Index Access
Methods</a></p>
<p><strong>Option (Command-line)</strong> ‚Üí Flags passed to PostgreSQL
utilities ‚Üí See individual utilities: pg_dump, pg_restore, psql, etc. ‚Üí
See: <a href="../07-utilities/utility-programs.md">Utilities</a></p>
<p><strong>Optimizer</strong> ‚Üí Query processing component selecting
execution plans ‚Üí Cost-based: chooses lowest estimated cost plan ‚Üí File:
<code>src/backend/optimizer/</code> (~220,428 lines) ‚Üí See: <a href="../02-query-processing/query-pipeline.md">Query Processing -
Planner</a></p>
<p><strong>ORDER BY</strong> ‚Üí SQL clause specifying sort order ‚Üí
Implemented via external sort or index-based ordering ‚Üí See: <a href="../02-query-processing/query-pipeline.md">Query Processing -
Sorting</a></p>
<hr/>
<h2 data-number="15.16" id="p-1"><span class="header-section-number">15.16</span> P</h2>
<p><strong>Page</strong> ‚Üí See: Block/Page</p>
<p><strong>PageHeaderData</strong> ‚Üí C structure containing page
metadata ‚Üí File: <code>src/include/storage/bufpage.h</code> ‚Üí Contains:
LSN, checksum, flags, offsets, pruning info ‚Üí See: <a href="../01-storage/storage-layer.md">Storage - Page Header</a></p>
<p><strong>Page Layout</strong> ‚Üí Physical organization of data within
8KB page ‚Üí Consists: header, item pointers, free space, tuple data,
special space ‚Üí See: <a href="../01-storage/storage-layer.md">Storage -
Page Structure</a></p>
<p><strong>Parallel Execution</strong> ‚Üí Query execution using multiple
processes/threads ‚Üí Supported: sequential scans, joins, aggregates ‚Üí
Introduced in PostgreSQL 9.6 ‚Üí Controlled by
max_parallel_workers_per_gather ‚Üí See: <a href="../02-query-processing/query-pipeline.md">Query Processing -
Parallel Execution</a></p>
<p><strong>Parallel Worker</strong> ‚Üí Process executing portion of
parallel query ‚Üí Spawned by main query process ‚Üí See: <a href="../05-processes/process-architecture.md">Process Architecture -
Parallel Workers</a></p>
<p><strong>Parameterized Path</strong> ‚Üí Query path with parameters for
outer relation values ‚Üí Enables nested loop join optimization ‚Üí See: <a href="../02-query-processing/query-pipeline.md">Query Processing - Path
Planning</a></p>
<p><strong>Parser</strong> ‚Üí Query processing stage converting SQL text
to parse tree ‚Üí File: <code>src/backend/parser/</code> (gram.y, scan.l)
‚Üí Produces Query structure from RawStmt ‚Üí See: <a href="../02-query-processing/query-pipeline.md">Query Processing -
Parser</a></p>
<p><strong>Paquier, Michael</strong> ‚Üí Recent prolific PostgreSQL
contributor ‚Üí Top committer in recent years ‚Üí See: <a href="../00-introduction.md#32-key-contributors">Introduction - Key
Contributors</a></p>
<p><strong>Path (Query Path)</strong> ‚Üí Intermediate representation
during query planning ‚Üí Describes access method and join method choice ‚Üí
File: <code>src/include/nodes/relationnode.h</code> ‚Üí See: <a href="../02-query-processing/query-pipeline.md">Query Processing - Path
Planning</a></p>
<p>**pg_*.c Files (Utilities)** ‚Üí Source code for command-line utilities
‚Üí See: <a href="#utilities-section">Utilities - File Locations</a></p>
<p><strong>pg_analyze_and_rewrite</strong> ‚Üí Function performing
semantic analysis and rewriting ‚Üí File:
<code>src/backend/parser/analyze.c</code> ‚Üí See: <a href="../02-query-processing/query-pipeline.md">Query Processing -
Analysis and Rewriting</a></p>
<p><strong>pg_attribute</strong> ‚Üí System catalog storing column
definitions ‚Üí One row per table column ‚Üí See: <a href="../02-query-processing/query-pipeline.md">Query Processing -
Catalog System</a></p>
<p><strong>pg_basebackup</strong> ‚Üí Utility creating base backup for
replication setup ‚Üí File:
<code>src/bin/pg_basebackup/pg_basebackup.c</code> ‚Üí Streams data while
server running ‚Üí See: <a href="../07-utilities/utility-programs.md">Utilities -
pg_basebackup</a></p>
<p><strong>pg_class</strong> ‚Üí System catalog storing table, index,
sequence definitions ‚Üí One row per relation ‚Üí See: <a href="../02-query-processing/query-pipeline.md">Query Processing -
Catalog System</a></p>
<p><strong>pg_control</strong> ‚Üí File storing cluster state information
‚Üí Location: $PGDATA/global/pg_control ‚Üí See: <a href="../01-storage/storage-layer.md">Storage - Write-Ahead
Logging</a></p>
<p><strong>pg_ctl</strong> ‚Üí Utility managing PostgreSQL server
lifecycle ‚Üí File: <code>src/bin/pg_ctl/pg_ctl.c</code> ‚Üí Commands:
start, stop, restart, promote, reload ‚Üí See: <a href="../07-utilities/utility-programs.md">Utilities - pg_ctl</a></p>
<p><strong>pg_dump</strong> ‚Üí Utility exporting database to SQL script
or archive ‚Üí File: <code>src/bin/pg_dump/pg_dump.c</code> (20,570 lines)
‚Üí Formats: plain SQL, custom archive, directory, tar ‚Üí See: <a href="../07-utilities/utility-programs.md">Utilities - pg_dump</a></p>
<p><strong>pg_hba.conf</strong> ‚Üí Host-based authentication
configuration file ‚Üí Location: $PGDATA/pg_hba.conf ‚Üí Specifies
authentication method for client connections ‚Üí See: <a href="../05-processes/process-architecture.md">Process Architecture -
Authentication</a></p>
<p><strong>pg_ident.conf</strong> ‚Üí User mapping configuration file ‚Üí
Maps OS users to PostgreSQL users ‚Üí Location: $PGDATA/pg_ident.conf ‚Üí
See: <a href="../05-processes/process-architecture.md">Process
Architecture - Authentication</a></p>
<p><strong>pg_plan_query</strong> ‚Üí Function performing query planning ‚Üí
File: <code>src/backend/optimizer/planner.c</code> ‚Üí See: <a href="../02-query-processing/query-pipeline.md">Query Processing -
Planner</a></p>
<p><strong>pg_proc</strong> ‚Üí System catalog storing function
definitions ‚Üí One row per function ‚Üí See: <a href="../02-query-processing/query-pipeline.md">Query Processing -
Catalog System</a></p>
<p><strong>pg_restore</strong> ‚Üí Utility restoring database from archive
‚Üí File: <code>src/bin/pg_dump/pg_restore.c</code> ‚Üí Parallel restoration
with dependency resolution ‚Üí See: <a href="../07-utilities/utility-programs.md">Utilities -
pg_restore</a></p>
<p><strong>pg_type</strong> ‚Üí System catalog storing data type
definitions ‚Üí One row per data type ‚Üí See: <a href="../02-query-processing/query-pipeline.md">Query Processing -
Catalog System</a></p>
<p><strong>pg_upgrade</strong> ‚Üí Utility performing in-place cluster
upgrade ‚Üí File: <code>src/bin/pg_upgrade/pg_upgrade.c</code> ‚Üí Modes:
link, copy, clone ‚Üí See: <a href="../07-utilities/utility-programs.md">Utilities -
pg_upgrade</a></p>
<p><strong>pg_xact</strong> ‚Üí SLRU directory storing transaction commit
status ‚Üí Formerly called ‚Äúclog‚Äù (commit log) ‚Üí Location:
$PGDATA/pg_xact/ ‚Üí See: <a href="../03-transactions/transaction-management.md">Transactions -
Commit Log</a></p>
<p><strong>pgbench</strong> ‚Üí Utility for database performance
benchmarking ‚Üí File: <code>src/bin/pgbench/pgbench.c</code> ‚Üí Workload:
TPC-B-like transactions ‚Üí See: <a href="../07-utilities/utility-programs.md">Utilities - pgbench</a></p>
<p><strong>PGDATA</strong> ‚Üí See: Data Directory</p>
<p><strong>pgindent</strong> ‚Üí Tool for formatting code to PostgreSQL
style ‚Üí See: <a href="../09-build-system-and-portability.md">Build
System - Development Tools</a></p>
<p><strong>PostgreSQL</strong> ‚Üí Official name since 1996, reflecting
SQL support ‚Üí Earlier names: POSTGRES (1986-1994), Postgres95
(1994-1996) ‚Üí See: <a href="../00-introduction.md#12-official-names-throughout-history">Introduction
- Official Names</a></p>
<p><strong>Postgres95</strong> ‚Üí Version adding SQL support to POSTGRES
‚Üí Released 1995, predecessor to PostgreSQL ‚Üí See: <a href="../00-introduction.md#22-the-transition-postgres95-1994-1996">Introduction
- Postgres95</a></p>
<p><strong>Postmaster</strong> ‚Üí Main PostgreSQL server process ‚Üí File:
<code>src/backend/postmaster/postmaster.c</code> ‚Üí Responsibilities:
initialization, process spawning, supervision, shutdown ‚Üí See: <a href="../05-processes/process-architecture.md">Process Architecture -
Postmaster</a></p>
<p><strong>PostQUEL</strong> ‚Üí Query language used by original POSTGRES
‚Üí Predecessor to SQL in PostgreSQL ‚Üí See: <a href="../00-introduction.md#22-the-berkeley-postgres-era">Introduction -
Historical Context</a></p>
<p><strong>Prepared Statement</strong> ‚Üí Pre-parsed and planned SQL
statement ‚Üí Reduces parsing/planning overhead ‚Üí Protocol support in
PostgreSQL 7.3+ ‚Üí See: <a href="../02-query-processing/query-pipeline.md">Query Processing -
Prepared Statements</a></p>
<p><strong>PRIMARY KEY</strong> ‚Üí Constraint enforcing unique
identification of rows ‚Üí Automatically creates B-tree index ‚Üí See: <a href="../00-introduction.md">SQL - Constraints</a></p>
<p><strong>Privilege</strong> ‚Üí Right to perform action on database
object ‚Üí Granularity: database, schema, table, column ‚Üí See: <a href="../05-processes/process-architecture.md">Security -
Privileges</a></p>
<p><strong>Procedural Language</strong> ‚Üí Language for writing stored
procedures ‚Üí Supported: PL/pgSQL, PL/Python, PL/Perl, PL/Tcl ‚Üí See: <a href="../06-extensions/extension-system.md">Extensions - Procedural
Languages</a></p>
<p><strong>Process Architecture</strong> ‚Üí Multi-process design of
PostgreSQL ‚Üí Advantages: fault isolation, portability, security,
simplicity ‚Üí See: <a href="../05-processes/process-architecture.md">Process
Architecture</a></p>
<p><strong>procarray.c</strong> ‚Üí File managing process array and
snapshot building ‚Üí Contains GetSnapshotData() implementation ‚Üí
Location: <code>src/backend/storage/ipc/procarray.c</code> ‚Üí See: <a href="../03-transactions/transaction-management.md">Transactions -
MVCC</a></p>
<p><strong>Publish-Subscribe Replication</strong> ‚Üí Logical replication
with flexible subscription ‚Üí Introduced in PostgreSQL 10 ‚Üí See: <a href="../04-replication/replication-recovery.md">Replication - Logical
Replication</a></p>
<p><strong>psql</strong> ‚Üí Interactive PostgreSQL terminal ‚Üí File:
<code>src/bin/psql/</code> (80+ meta-commands) ‚Üí Features: tab
completion, history, formatted output ‚Üí See: <a href="../07-utilities/utility-programs.md">Utilities - psql</a></p>
<p><strong>Pruning (HOT Pruning)</strong> ‚Üí Process removing old tuple
versions from page ‚Üí Optimization: keeps page reference without index
updates ‚Üí See: <a href="../01-storage/storage-layer.md">Storage -
Heap-Only Tuple</a></p>
<hr/>
<h2 data-number="15.17" id="q-1"><span class="header-section-number">15.17</span> Q</h2>
<p><strong>Query</strong> ‚Üí SQL statement requesting data ‚Üí Processing:
parse ‚Üí rewrite ‚Üí plan ‚Üí execute ‚Üí See: <a href="../02-query-processing/query-pipeline.md">Query Processing -
Overview</a></p>
<p><strong>Query Planner</strong> ‚Üí See: Optimizer</p>
<p><strong>Query Processing Pipeline</strong> ‚Üí Four stages: parse,
rewrite, plan, execute ‚Üí File: <code>src/backend/</code> (parser,
rewriter, optimizer, executor) ‚Üí See: <a href="../02-query-processing/query-pipeline.md">Query Processing</a></p>
<p><strong>Query Rewriter</strong> ‚Üí Stage handling view expansion and
rule application ‚Üí File:
<code>src/backend/rewrite/rewriteHandler.c</code> (3,877 lines) ‚Üí See:
<a href="../02-query-processing/query-pipeline.md">Query Processing -
Rewriter</a></p>
<p><strong>Query Tree</strong> ‚Üí Intermediate representation after
parsing ‚Üí Contains Query structure with semantic information ‚Üí See: <a href="../02-query-processing/query-pipeline.md">Query Processing -
Parser</a></p>
<hr/>
<h2 data-number="15.18" id="r-1"><span class="header-section-number">15.18</span> R</h2>
<p><strong>Range Type</strong> ‚Üí Data type representing range of values
‚Üí Examples: int4range, int8range, daterange, tsrange ‚Üí User-definable
custom ranges ‚Üí Introduced in PostgreSQL 9.2 ‚Üí See: <a href="../00-introduction.md#15-core-features">Introduction - Data
Types</a></p>
<p><strong>RawStmt</strong> ‚Üí Raw parse tree node before semantic
analysis ‚Üí See: <a href="../02-query-processing/query-pipeline.md">Query
Processing - Parser</a></p>
<p><strong>Read Committed</strong> ‚Üí Default isolation level ‚Üí Sees
committed data only ‚Üí Does not prevent dirty reads of uncommitted writes
‚Üí See: <a href="../03-transactions/transaction-management.md">Transactions -
Isolation Levels</a></p>
<p><strong>Read Uncommitted</strong> ‚Üí Isolation level treated as READ
COMMITTED in PostgreSQL ‚Üí See: <a href="../03-transactions/transaction-management.md">Transactions -
Isolation Levels</a></p>
<p><strong>Recovery</strong> ‚Üí Process restoring database after failure
‚Üí Uses WAL to replay transactions up to failure point ‚Üí See: <a href="../01-storage/storage-layer.md">Storage - Write-Ahead
Logging</a></p>
<p><strong>Recovery Target</strong> ‚Üí Point to recover to (XID,
timestamp, LSN, etc.) ‚Üí See: <a href="../04-replication/replication-recovery.md">Replication -
Point-In-Time Recovery</a></p>
<p><strong>Recursive Query</strong> ‚Üí See: Common Table Expression (WITH
RECURSIVE)</p>
<p><strong>Reindex</strong> ‚Üí Process rebuilding index from scratch ‚Üí
Utility: reindexdb ‚Üí See: <a href="../07-utilities/utility-programs.md">Utilities - reindexdb</a></p>
<p><strong>Relation</strong> ‚Üí Database object with named columns and
tuples (table, index, sequence) ‚Üí Stored in pg_class catalog ‚Üí See: <a href="../02-query-processing/query-pipeline.md">Query Processing -
Catalog System</a></p>
<p><strong>Replication</strong> ‚Üí Process of maintaining copies of data
on multiple servers ‚Üí Types: physical (WAL-based), logical (row-level) ‚Üí
See: <a href="../04-replication/replication-recovery.md">Replication</a></p>
<p><strong>Replication Slot</strong> ‚Üí Mechanism preventing WAL deletion
for a logical consumer ‚Üí Maintains retention information ‚Üí See: <a href="../04-replication/replication-recovery.md">Replication -
Replication Slots</a></p>
<p><strong>ReorderBuffer</strong> ‚Üí Structure managing transaction
ordering for logical replication ‚Üí Ensures consistent snapshots for
logical changes ‚Üí See: <a href="../04-replication/replication-recovery.md">Replication - Logical
Replication</a></p>
<p><strong>REPEATABLE READ</strong> ‚Üí Isolation level guaranteeing
repeatable reads ‚Üí Does not prevent phantom reads ‚Üí See: <a href="../03-transactions/transaction-management.md">Transactions -
Isolation Levels</a></p>
<p><strong>REPLICA IDENTITY</strong> ‚Üí Information identifying tuples
for logical replication ‚Üí Types: DEFAULT (primary key), FULL (all
columns), NOTHING (unavailable) ‚Üí See: <a href="../04-replication/replication-recovery.md">Replication - Logical
Replication</a></p>
<p><strong>Replicator</strong> ‚Üí See: WAL sender</p>
<p><strong>Resource Manager</strong> ‚Üí Component managing system
resources ‚Üí Example: buffer manager ‚Üí See: <a href="../01-storage/storage-layer.md">Storage - Buffer Manager</a></p>
<p><strong>REVOKE</strong> ‚Üí SQL command removing privileges from role ‚Üí
See: <a href="../05-processes/process-architecture.md">Security -
Privileges</a></p>
<p><strong>Rewrite</strong> ‚Üí See: Query Rewriter</p>
<p><strong>Rewriter</strong> ‚Üí See: Query Rewriter</p>
<p><strong>Role</strong> ‚Üí Database user or group with privileges ‚Üí Can
be login user or group for privilege aggregation ‚Üí See: <a href="../05-processes/process-architecture.md">Security - Roles</a></p>
<p><strong>Row-Level Security (RLS)</strong> ‚Üí Feature restricting row
access based on role ‚Üí Policies checked at query execution time ‚Üí See:
<a href="../05-processes/process-architecture.md">Security - Row-Level
Security</a></p>
<p><strong>Row Locking</strong> ‚Üí Locking at individual row level ‚Üí FOR
UPDATE, FOR SHARE in SELECT ‚Üí See: <a href="../03-transactions/transaction-management.md">Transactions -
Locking</a></p>
<hr/>
<h2 data-number="15.19" id="s-1"><span class="header-section-number">15.19</span> S</h2>
<p><strong>Safe Shutdown</strong> ‚Üí Smart or Fast shutdown mode ‚Üí See:
Shutdown Modes</p>
<p><strong>Savepoint</strong> ‚Üí Named point within transaction for
partial rollback ‚Üí Introduced in PostgreSQL 7.4 ‚Üí See: <a href="../03-transactions/transaction-management.md">Transactions -
Savepoints</a></p>
<p><strong>Scalability</strong> ‚Üí Ability to increase performance with
more hardware ‚Üí Challenges: lock contention, cache coherency ‚Üí Addressed
by: partitioning, parallel execution, lock-free algorithms ‚Üí See: <a href="../02-query-processing/query-pipeline.md">Query Processing -
Parallel Execution</a></p>
<p><strong>Scan (Table Scan)</strong> ‚Üí Access method reading table data
‚Üí Types: sequential scan, index scan, bitmap scan ‚Üí See: <a href="../02-query-processing/query-pipeline.md">Query Processing -
Scans</a></p>
<p><strong>SCRAM-SHA-256</strong> ‚Üí Salted Challenge Response
Authentication Mechanism ‚Üí Default authentication method since
PostgreSQL 10 ‚Üí See: <a href="../05-processes/process-architecture.md">Process Architecture -
Authentication</a></p>
<p><strong>Segment (WAL Segment)</strong> ‚Üí Fixed-size WAL file
(typically 16 MB) ‚Üí Location: $PGDATA/pg_wal/ ‚Üí See: <a href="../01-storage/storage-layer.md">Storage - Write-Ahead
Logging</a></p>
<p><strong>SELECT</strong> ‚Üí SQL command querying data ‚Üí Processing:
parse ‚Üí rewrite ‚Üí plan ‚Üí execute ‚Üí See: <a href="../02-query-processing/query-pipeline.md">Query Processing -
Overview</a></p>
<p><strong>Sequence</strong> ‚Üí Database object generating unique
identifier values ‚Üí Relation type in pg_class ‚Üí See: <a href="../00-introduction.md">Introduction - Data Types</a></p>
<p><strong>Sequential Scan</strong> ‚Üí Access method reading all heap
pages sequentially ‚Üí Fallback when no suitable index exists ‚Üí See: <a href="../02-query-processing/query-pipeline.md">Query Processing -
Scans</a></p>
<p><strong>Serializable</strong> ‚Üí Highest isolation level ‚Üí Implemented
via Serializable Snapshot Isolation (SSI) ‚Üí See: <a href="../03-transactions/transaction-management.md">Transactions -
Isolation Levels</a></p>
<p><strong>Serializable Snapshot Isolation (SSI)</strong> ‚Üí
Implementation of true SERIALIZABLE isolation ‚Üí Detects conflicts and
aborts transactions ‚Üí Introduced in PostgreSQL 9.1 ‚Üí See: <a href="../03-transactions/transaction-management.md">Transactions -
Serializable Snapshot Isolation</a></p>
<p><strong>Set Operations</strong> ‚Üí SQL operations on result sets ‚Üí
Operations: UNION, INTERSECT, EXCEPT ‚Üí See: <a href="../00-introduction.md">Introduction - SQL Features</a></p>
<p><strong>Shared Memory</strong> ‚Üí Memory accessible to multiple
processes ‚Üí Contains buffer pool, lock tables, shared state ‚Üí Size:
shared_buffers + miscellaneous overhead ‚Üí See: <a href="../05-processes/process-architecture.md">Process Architecture -
Shared Memory</a></p>
<p><strong>Shutdown Modes</strong> ‚Üí PostgreSQL shutdown methods ‚Üí
Modes: Smart (waits for connections), Fast (rolls back), Immediate
(emergency) ‚Üí See: <a href="../05-processes/process-architecture.md">Process Architecture -
Shutdown</a></p>
<p><strong>Signal</strong> ‚Üí IPC mechanism for asynchronous notification
‚Üí Used: SIGHUP (reload config), SIGTERM (shutdown), etc. ‚Üí See: <a href="../05-processes/process-architecture.md">Process Architecture -
IPC</a></p>
<p><strong>SLRU (Simple LRU)</strong> ‚Üí Fixed-size LRU cache for catalog
data ‚Üí Used for: CLOG, fsm, visibility map, commit log ‚Üí File:
<code>src/backend/access/transam/slru.c</code> ‚Üí See: <a href="../01-storage/storage-layer.md">Storage - MVCC</a></p>
<p><strong>Snapshot</strong> ‚Üí Consistent view of database at specific
transaction point ‚Üí Based on active transaction list ‚Üí See: <a href="../03-transactions/transaction-management.md">Transactions -
Snapshots</a></p>
<p><strong>Snapshot Isolation</strong> ‚Üí Each transaction sees
consistent snapshot ‚Üí Foundation of MVCC ‚Üí See: <a href="../03-transactions/transaction-management.md">Transactions -
MVCC</a></p>
<p><strong>SP-GiST (Space-Partitioned GiST)</strong> ‚Üí Index type for
partitioned space (quadtrees, k-d trees) ‚Üí Non-balanced tree structure ‚Üí
File: <code>src/backend/access/spgist/</code> ‚Üí See: <a href="../01-storage/storage-layer.md">Storage - Index Access
Methods</a></p>
<p><strong>Sparse Index</strong> ‚Üí Index not covering all rows ‚Üí
Example: partial index with WHERE clause ‚Üí See: <a href="../01-storage/storage-layer.md">Storage - Index Access
Methods</a></p>
<p><strong>Spinlock</strong> ‚Üí Lightweight spin-wait lock ‚Üí Used for
very short critical sections ‚Üí File:
<code>src/backend/storage/lmgr/spin.c</code> ‚Üí See: <a href="../03-transactions/transaction-management.md">Transactions -
Locking</a></p>
<p><strong>SQL</strong> ‚Üí Structured Query Language ‚Üí Supported:
SQL:2016 (large subset) ‚Üí See: <a href="../00-introduction.md">Introduction - Core Features</a></p>
<p><strong>SQLSTATE</strong> ‚Üí Error code format (5-character) ‚Üí First
two characters: class, last three: condition ‚Üí See: <a href="../05-processes/process-architecture.md">Error Handling</a></p>
<p><strong>Statement</strong> ‚Üí Complete SQL command ‚Üí See: Query</p>
<p><strong>Statistics</strong> ‚Üí Information about table/index
characteristics ‚Üí Used for query planning ‚Üí Updated by ANALYZE ‚Üí Stored
in pg_stats view ‚Üí See: <a href="../02-query-processing/query-pipeline.md">Query Processing - Cost
Model</a></p>
<p><strong>Stats Collector</strong> ‚Üí Auxiliary process gathering
statistics ‚Üí File: <code>src/backend/postmaster/pgstat.c</code> ‚Üí Sends
updates at intervals ‚Üí See: <a href="../05-processes/process-architecture.md">Process Architecture -
Auxiliary Processes</a></p>
<p><strong>Standby</strong> ‚Üí Replica database in replication setup ‚Üí
Can be warm standby or hot standby ‚Üí See: <a href="../04-replication/replication-recovery.md">Replication - Hot
Standby</a></p>
<p><strong>Stonebraker, Michael</strong> ‚Üí See: Michael Stonebraker</p>
<p><strong>Storage Format</strong> ‚Üí Physical layout of data on disk ‚Üí
See: <a href="../01-storage/storage-layer.md">Storage - Page
Structure</a></p>
<p><strong>Stored Procedure</strong> ‚Üí Named PL/pgSQL function with CALL
command ‚Üí Introduced in PostgreSQL 11 ‚Üí See: <a href="../06-extensions/extension-system.md">Extensions - Procedural
Languages</a></p>
<p><strong>Streaming Replication</strong> ‚Üí Physical replication sending
WAL records continuously ‚Üí Introduced in PostgreSQL 9.0 ‚Üí See: <a href="../04-replication/replication-recovery.md">Replication - Streaming
Replication</a></p>
<p><strong>String Literal</strong> ‚Üí Text value in SQL ‚Üí Enclosed in
single quotes ‚Üí See: <a href="../02-query-processing/query-pipeline.md">Query Processing -
Parser</a></p>
<p><strong>Subquery</strong> ‚Üí Query nested within another query ‚Üí Can
appear in SELECT, FROM, WHERE clauses ‚Üí See: <a href="../02-query-processing/query-pipeline.md">Query Processing -
Subqueries</a></p>
<p><strong>Syslogger</strong> ‚Üí Auxiliary process managing server
logging ‚Üí File: <code>src/backend/postmaster/syslogger.c</code> ‚Üí Writes
to log files or system logger ‚Üí See: <a href="../05-processes/process-architecture.md">Process Architecture -
Auxiliary Processes</a></p>
<p><strong>System Catalog</strong> ‚Üí Set of system tables storing
database metadata ‚Üí See: <a href="../02-query-processing/query-pipeline.md">Query Processing -
Catalog System</a></p>
<p><strong>System Column</strong> ‚Üí Column automatically provided by
PostgreSQL ‚Üí Examples: ctid, oid, xmin, xmax, xvac, cmin, cmax ‚Üí See: <a href="../01-storage/storage-layer.md">Storage - System Columns</a></p>
<hr/>
<h2 data-number="15.20" id="t-1"><span class="header-section-number">15.20</span> T</h2>
<p><strong>Table</strong> ‚Üí Named relation storing data ‚Üí Access method:
heap (default) ‚Üí See: <a href="../01-storage/storage-layer.md">Storage -
Heap Access Method</a></p>
<p><strong>Table Inheritance</strong> ‚Üí Object-oriented feature allowing
table hierarchy ‚Üí Queries can include inherited table data ‚Üí See: <a href="../00-introduction.md">Introduction - Extensibility</a></p>
<p><strong>Table Partitioning</strong> ‚Üí Division of large table into
smaller pieces ‚Üí Methods: range, list, hash ‚Üí Introduced: range/list
(8.1), hash (11) ‚Üí See: <a href="../00-introduction.md">SQL -
Partitioning</a></p>
<p><strong>Table Scan</strong> ‚Üí Reading table data via heap access
method ‚Üí See: Sequential Scan, Index Scan</p>
<p><strong>Tablespace</strong> ‚Üí Logical location for storing database
objects ‚Üí Maps to directory on filesystem ‚Üí See: <a href="../01-storage/storage-layer.md">Storage - Tablespaces</a></p>
<p><strong>TABLESAMPLE</strong> ‚Üí SQL clause sampling table rows ‚Üí
Methods: BERNOULLI, SYSTEM ‚Üí Introduced in PostgreSQL 9.5 ‚Üí See: <a href="../00-introduction.md">Introduction - SQL Features</a></p>
<p><strong>TOAST (The Oversized-Attribute Storage Technique)</strong> ‚Üí
System for storing large attribute values ‚Üí Compresses or externalizes
values &gt; TOAST_TUPLE_THRESHOLD ‚Üí See: <a href="../01-storage/storage-layer.md">Storage - TOAST</a></p>
<p><strong>TOAST Table</strong> ‚Üí Hidden table storing out-of-line
attribute data ‚Üí Created automatically for tables with TOAST-able
columns ‚Üí See: <a href="../01-storage/storage-layer.md">Storage -
TOAST</a></p>
<p><strong>Transaction</strong> ‚Üí Atomic unit of work with ACID
properties ‚Üí Begins: explicitly (BEGIN) or implicitly (first query) ‚Üí
Ends: COMMIT or ROLLBACK ‚Üí See: <a href="../03-transactions/transaction-management.md">Transactions</a></p>
<p><strong>Transaction ID (XID)</strong> ‚Üí Unique identifier for
transaction ‚Üí 32-bit unsigned integer ‚Üí Special values: 0 (invalid), 1
(bootstrap), 2+ (regular) ‚Üí See: <a href="../03-transactions/transaction-management.md">Transactions -
MVCC</a></p>
<p><strong>Transaction Isolation Level</strong> ‚Üí See: Isolation
Level</p>
<p><strong>Tuple</strong> ‚Üí Row in a table ‚Üí Consists of: header + null
bitmap + attribute data ‚Üí See: <a href="../01-storage/storage-layer.md">Storage - Tuple Structure</a></p>
<p><strong>Tuple Visibility</strong> ‚Üí Rules determining whether
transaction can see tuple version ‚Üí Based on transaction IDs and
isolation level ‚Üí See: <a href="../03-transactions/transaction-management.md">Transactions - Tuple
Visibility</a></p>
<p><strong>Two-Phase Commit (2PC)</strong> ‚Üí Protocol ensuring
consistency in distributed transactions ‚Üí Phases: prepare, commit ‚Üí See:
<a href="../03-transactions/transaction-management.md">Transactions -
Two-Phase Commit</a></p>
<p><strong>Two-Phase Locking</strong> ‚Üí Locking protocol with growing
and shrinking phases ‚Üí Guarantees serializability ‚Üí See: <a href="../03-transactions/transaction-management.md">Transactions -
Locking</a></p>
<p><strong>Type Coercion</strong> ‚Üí Automatic conversion between
compatible types ‚Üí Implicit vs explicit casting ‚Üí See: <a href="../02-query-processing/query-pipeline.md">Query Processing - Type
System</a></p>
<hr/>
<h2 data-number="15.21" id="u-1"><span class="header-section-number">15.21</span> U</h2>
<p><strong>Undo Log</strong> ‚Üí Not used in PostgreSQL ‚Üí MVCC provides
similar functionality without undo ‚Üí See: <a href="../03-transactions/transaction-management.md">Transactions -
MVCC</a></p>
<p><strong>UNIQUE Constraint</strong> ‚Üí Constraint enforcing uniqueness
of column value ‚Üí Creates B-tree index ‚Üí Allows NULL unless NOT NULL
also specified ‚Üí See: <a href="../00-introduction.md">SQL -
Constraints</a></p>
<p><strong>UNIQUE Index</strong> ‚Üí Index enforcing uniqueness ‚Üí Created
by UNIQUE constraint or explicit CREATE UNIQUE INDEX ‚Üí See: <a href="../01-storage/storage-layer.md">Storage - Index Access
Methods</a></p>
<p><strong>UNION</strong> ‚Üí SQL operation combining results of multiple
queries ‚Üí Variants: UNION (distinct), UNION ALL ‚Üí See: <a href="../00-introduction.md">Introduction - SQL Features</a></p>
<p><strong>UPDATE</strong> ‚Üí SQL command modifying rows ‚Üí MVCC: creates
new tuple versions ‚Üí See: <a href="../01-storage/storage-layer.md">Storage - Heap Access
Method</a></p>
<p><strong>Utility Statement</strong> ‚Üí Non-query SQL statement (DDL,
DCL) ‚Üí Examples: CREATE, ALTER, GRANT, etc. ‚Üí See: <a href="../02-query-processing/query-pipeline.md">Query Processing -
Utility Handling</a></p>
<p><strong>Utility Hooks</strong> ‚Üí Extensibility points for utility
statement processing ‚Üí See: <a href="../06-extensions/extension-system.md">Extensions - Hooks</a></p>
<p><strong>UUID</strong> ‚Üí Universally Unique Identifier ‚Üí 128-bit value
‚Üí Requires uuid extension for UUID type ‚Üí See: <a href="../00-introduction.md">Introduction - Data Types</a></p>
<hr/>
<h2 data-number="15.22" id="v-1"><span class="header-section-number">15.22</span> V</h2>
<p><strong>VACUUM</strong> ‚Üí Maintenance operation removing dead tuples
‚Üí Reclaims disk space and updates statistics ‚Üí Options: FULL (rewrites),
FREEZE, ANALYZE, VERBOSE ‚Üí See: <a href="../01-storage/storage-layer.md">Storage - Maintenance</a></p>
<p><strong>Visibility Map (VM)</strong> ‚Üí Bitmap tracking pages with
all-visible tuples ‚Üí Optimization for VACUUM and index-only scans ‚Üí
File: <code>src/backend/storage/buffer/visibilitymap.c</code> ‚Üí See: <a href="../01-storage/storage-layer.md">Storage - Visibility Map</a></p>
<p><strong>View</strong> ‚Üí Named query stored as database object ‚Üí
Types: view, materialized view ‚Üí See: <a href="../00-introduction.md">SQL - Views</a></p>
<p><strong>Virtual Transaction ID (Vxid)</strong> ‚Üí Transaction ID for
uncommitted transaction ‚Üí Format: (process_id, sequence_number) ‚Üí Not
visible to users ‚Üí See: <a href="../03-transactions/transaction-management.md">Transactions -
Transaction IDs</a></p>
<p><strong>VirtualXidBuffer</strong> ‚Üí Slotted array tracking virtual
transaction IDs ‚Üí File: <code>src/backend/storage/ipc/procarray.c</code>
‚Üí See: <a href="../03-transactions/transaction-management.md">Transactions -
MVCC</a></p>
<hr/>
<h2 data-number="15.23" id="w-1"><span class="header-section-number">15.23</span> W</h2>
<p><strong>WAL (Write-Ahead Logging)</strong> ‚Üí Technique ensuring ACID
durability ‚Üí All changes written to log before applied to disk ‚Üí File:
<code>src/backend/access/transam/xlog.c</code> (9,584 lines) ‚Üí See: <a href="../01-storage/storage-layer.md">Storage - Write-Ahead
Logging</a></p>
<p><strong>WAL Archiving</strong> ‚Üí Process copying completed WAL
segments to archive ‚Üí Used for point-in-time recovery ‚Üí See: <a href="../04-replication/replication-recovery.md">Replication -
Point-In-Time Recovery</a></p>
<p><strong>WAL Buffer</strong> ‚Üí In-memory buffer for WAL records ‚Üí
Flushed to disk by walwriter or COMMIT ‚Üí Size: wal_buffers parameter ‚Üí
See: <a href="../01-storage/storage-layer.md">Storage - Write-Ahead
Logging</a></p>
<p><strong>WAL Record</strong> ‚Üí Log entry describing data modification
‚Üí Contains: type, data, checksum, LSN ‚Üí See: <a href="../01-storage/storage-layer.md">Storage - Write-Ahead
Logging</a></p>
<p><strong>WAL Sender</strong> ‚Üí Auxiliary process sending WAL to
standby ‚Üí File: <code>src/backend/replication/walsender.c</code> ‚Üí One
per streaming replication connection ‚Üí See: <a href="../05-processes/process-architecture.md">Process Architecture -
Auxiliary Processes</a></p>
<p><strong>WAL Writer</strong> ‚Üí Auxiliary process writing WAL buffer to
disk ‚Üí File: <code>src/backend/postmaster/walwriter.c</code> ‚Üí Operates
at intervals (wal_writer_delay) ‚Üí See: <a href="../05-processes/process-architecture.md">Process Architecture -
Auxiliary Processes</a></p>
<p><strong>WHERE Clause</strong> ‚Üí SQL clause filtering rows ‚Üí
Conditions applied during execution ‚Üí See: <a href="../02-query-processing/query-pipeline.md">Query Processing -
Filtering</a></p>
<p><strong>Window Function</strong> ‚Üí Function operating on set of rows
related to current row ‚Üí Clauses: PARTITION BY, ORDER BY, frame
specification ‚Üí Examples: ROW_NUMBER, RANK, SUM OVER ‚Üí Introduced in
PostgreSQL 8.4 ‚Üí See: <a href="../00-introduction.md">Introduction - SQL
Features</a></p>
<p><strong>WITH Clause</strong> ‚Üí Common Table Expression definition ‚Üí
Can be recursive ‚Üí See: <a href="../02-query-processing/query-pipeline.md">Query Processing -
CTEs</a></p>
<p><strong>WITH RECURSIVE</strong> ‚Üí Recursive CTE for hierarchical
queries ‚Üí Introduced in PostgreSQL 8.4 ‚Üí See: <a href="../02-query-processing/query-pipeline.md">Query Processing -
CTEs</a></p>
<p><strong>Worker Pool</strong> ‚Üí Pool of parallel workers available for
query execution ‚Üí Size: max_worker_processes ‚Üí See: <a href="../05-processes/process-architecture.md">Process Architecture -
Parallel Workers</a></p>
<p><strong>Work Memory</strong> ‚Üí GUC parameter limiting memory per
sort/hash operation ‚Üí Parameter: work_mem ‚Üí Exceeding causes disk-based
operations ‚Üí See: <a href="#configuration-parameters-section">Configuration
Parameters</a></p>
<p><strong>Write Lock</strong> ‚Üí Lock preventing concurrent writes ‚Üí
Held during UPDATE, DELETE, INSERT ‚Üí See: <a href="../03-transactions/transaction-management.md">Transactions -
Locking</a></p>
<hr/>
<h2 data-number="15.24" id="x-1"><span class="header-section-number">15.24</span> X</h2>
<p><strong>XID</strong> ‚Üí See: Transaction ID</p>
<p><strong>xlog</strong> ‚Üí Write-Ahead Log (internal name) ‚Üí See:
WAL</p>
<hr/>
<h2 data-number="15.25" id="y"><span class="header-section-number">15.25</span> Y</h2>
<p><strong>Yu, Andrew</strong> ‚Üí UC Berkeley graduate student ‚Üí Added
SQL support to POSTGRES in 1994 ‚Üí Co-creator of Postgres95 ‚Üí See: <a href="../00-introduction.md#22-the-transition-postgres95-1994-1996">Introduction
- Postgres95 Era</a></p>
<hr/>
<h2 data-number="15.26" id="z-1"><span class="header-section-number">15.26</span> Z</h2>
<p><strong>ZHEAP</strong> ‚Üí Proposed heap storage optimization
(experimental) ‚Üí Reduces MVCC overhead ‚Üí See: <a href="../01-storage/storage-layer.md">Storage - Heap Access
Method</a></p>
<hr/>
<h1 data-number="16" id="technical-terms-and-concepts-cross-index"><span class="header-section-number">16</span> Technical Terms and Concepts
Cross-Index</h1>
<h2 data-number="16.1" id="data-structures"><span class="header-section-number">16.1</span> Data Structures</h2>
<table>
<colgroup>
<col style="width: 42%"/>
<col style="width: 23%"/>
<col style="width: 34%"/>
</colgroup>
<thead>
<tr>
<th>Structure</th>
<th>File</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>PageHeaderData</strong></td>
<td><code>src/include/storage/bufpage.h</code></td>
<td>Page metadata</td>
</tr>
<tr>
<td><strong>HeapTupleHeaderData</strong></td>
<td><code>src/include/access/htup_details.h</code></td>
<td>Tuple header</td>
</tr>
<tr>
<td><strong>ItemIdData</strong></td>
<td><code>src/include/storage/itemid.h</code></td>
<td>Item pointer (line pointer)</td>
</tr>
<tr>
<td><strong>BufferDesc</strong></td>
<td><code>src/include/storage/buf_internals.h</code></td>
<td>Buffer pool entry</td>
</tr>
<tr>
<td><strong>Query</strong></td>
<td><code>src/include/nodes/parsenodes.h</code></td>
<td>Parse/query tree node</td>
</tr>
<tr>
<td><strong>Plan</strong></td>
<td><code>src/include/nodes/plannodes.h</code></td>
<td>Query plan node</td>
</tr>
<tr>
<td><strong>PlanState</strong></td>
<td><code>src/include/nodes/execnodes.h</code></td>
<td>Executor state node</td>
</tr>
<tr>
<td><strong>Path</strong></td>
<td><code>src/include/nodes/relationnode.h</code></td>
<td>Query path node</td>
</tr>
<tr>
<td><strong>TupleTableSlot</strong></td>
<td><code>src/include/executor/tuptable.h</code></td>
<td>Tuple data container</td>
</tr>
</tbody>
</table>
<p>See: <a href="../01-storage/storage-layer.md">Storage - Data
Structures</a>, <a href="../02-query-processing/query-pipeline.md">Query
Processing - Node Types</a></p>
<hr/>
<h2 data-number="16.2" id="key-functions"><span class="header-section-number">16.2</span> Key Functions</h2>
<table>
<colgroup>
<col style="width: 40%"/>
<col style="width: 24%"/>
<col style="width: 36%"/>
</colgroup>
<thead>
<tr>
<th>Function</th>
<th>File</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>heap_insert()</strong></td>
<td><code>src/backend/access/heap/heapam.c</code></td>
<td>Insert tuple into heap</td>
</tr>
<tr>
<td><strong>heap_update()</strong></td>
<td><code>src/backend/access/heap/heapam.c</code></td>
<td>Update tuple in heap</td>
</tr>
<tr>
<td><strong>heap_delete()</strong></td>
<td><code>src/backend/access/heap/heapam.c</code></td>
<td>Delete tuple from heap</td>
</tr>
<tr>
<td><strong>GetSnapshotData()</strong></td>
<td><code>src/backend/storage/ipc/procarray.c</code></td>
<td>Build transaction snapshot</td>
</tr>
<tr>
<td><strong>pg_analyze_and_rewrite()</strong></td>
<td><code>src/backend/parser/analyze.c</code></td>
<td>Analysis and rewriting</td>
</tr>
<tr>
<td><strong>pg_plan_query()</strong></td>
<td><code>src/backend/optimizer/planner.c</code></td>
<td>Query planning</td>
</tr>
<tr>
<td><strong>ExecInitNode()</strong></td>
<td><code>src/backend/executor/execMain.c</code></td>
<td>Initialize executor node</td>
</tr>
<tr>
<td><strong>ExecProcNode()</strong></td>
<td><code>src/backend/executor/execMain.c</code></td>
<td>Execute executor node</td>
</tr>
<tr>
<td><strong>LockAcquire()</strong></td>
<td><code>src/backend/storage/lmgr/lock.c</code></td>
<td>Acquire lock</td>
</tr>
<tr>
<td><strong>CreateCheckPoint()</strong></td>
<td><code>src/backend/access/transam/xlog.c</code></td>
<td>Perform checkpoint</td>
</tr>
</tbody>
</table>
<p>See: <a href="../01-storage/storage-layer.md">Storage - Heap
Functions</a>, <a href="../02-query-processing/query-pipeline.md">Query
Processing - Execution</a>, <a href="../03-transactions/transaction-management.md">Transactions -
Locking</a></p>
<hr/>
<h2 data-number="16.3" id="configuration-parameters-guc"><span class="header-section-number">16.3</span> Configuration Parameters
(GUC)</h2>
<h3 data-number="16.3.1" id="memory-parameters"><span class="header-section-number">16.3.1</span> Memory Parameters</h3>
<ul>
<li><strong>shared_buffers</strong> - Size of shared memory buffer pool
(default: 128 MB)</li>
<li><strong>work_mem</strong> - Memory for sorting/hash (default: 4
MB)</li>
<li><strong>maintenance_work_mem</strong> - Memory for VACUUM/CREATE
INDEX (default: 64 MB)</li>
<li><strong>wal_buffers</strong> - WAL buffer size (default: 16 MB)</li>
<li><strong>effective_cache_size</strong> - Planner estimate of OS cache
(default: 4 GB)</li>
</ul>
<h3 data-number="16.3.2" id="io-parameters"><span class="header-section-number">16.3.2</span> I/O Parameters</h3>
<ul>
<li><strong>seq_page_cost</strong> - Cost of sequential page fetch
(default: 1.0)</li>
<li><strong>random_page_cost</strong> - Cost of random page fetch
(default: 4.0)</li>
<li><strong>cpu_operator_cost</strong> - Cost of expression evaluation
(default: 0.0025)</li>
<li><strong>effective_io_concurrency</strong> - Prefetch operations
(default: 1)</li>
</ul>
<h3 data-number="16.3.3" id="query-planning-parameters"><span class="header-section-number">16.3.3</span> Query Planning
Parameters</h3>
<ul>
<li><strong>max_parallel_workers_per_gather</strong> - Parallel workers
per Gather node (default: 2)</li>
<li><strong>max_parallel_workers</strong> - Total parallel workers
(default: 8)</li>
<li><strong>jit</strong> - Enable JIT compilation (default: on)</li>
<li><strong>jit_above_cost</strong> - Cost threshold for JIT (default:
100000)</li>
</ul>
<h3 data-number="16.3.4" id="replication-parameters"><span class="header-section-number">16.3.4</span> Replication Parameters</h3>
<ul>
<li><strong>wal_level</strong> - WAL detail level (default:
replica)</li>
<li><strong>max_wal_senders</strong> - Maximum streaming connections
(default: 3)</li>
<li><strong>wal_keep_size</strong> - WAL retention size (default:
0)</li>
<li><strong>hot_standby</strong> - Enable read queries on standby
(default: on)</li>
</ul>
<h3 data-number="16.3.5" id="maintenance-parameters"><span class="header-section-number">16.3.5</span> Maintenance Parameters</h3>
<ul>
<li><strong>autovacuum</strong> - Enable autovacuum (default: on)</li>
<li><strong>autovacuum_naptime</strong> - Time between autovacuum runs
(default: 1 min)</li>
<li><strong>autovacuum_vacuum_threshold</strong> - Tuples to trigger
vacuum (default: 50)</li>
<li><strong>autovacuum_analyze_threshold</strong> - Tuples to trigger
analyze (default: 50)</li>
</ul>
<p>See: <a href="../00-introduction.md">Configuration Parameters</a>, <a href="../02-query-processing/query-pipeline.md">Query Processing - Cost
Model</a></p>
<hr/>
<h2 data-number="16.4" id="utilities-and-tools"><span class="header-section-number">16.4</span> Utilities and Tools</h2>
<table>
<colgroup>
<col style="width: 37%"/>
<col style="width: 25%"/>
<col style="width: 37%"/>
</colgroup>
<thead>
<tr>
<th>Utility</th>
<th>File</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>pg_dump</strong></td>
<td><code>src/bin/pg_dump/pg_dump.c</code></td>
<td>Logical backup</td>
</tr>
<tr>
<td><strong>pg_restore</strong></td>
<td><code>src/bin/pg_dump/pg_restore.c</code></td>
<td>Restore from archive</td>
</tr>
<tr>
<td><strong>pg_basebackup</strong></td>
<td><code>src/bin/pg_basebackup/pg_basebackup.c</code></td>
<td>Physical backup</td>
</tr>
<tr>
<td><strong>psql</strong></td>
<td><code>src/bin/psql/</code></td>
<td>Interactive terminal</td>
</tr>
<tr>
<td><strong>pg_ctl</strong></td>
<td><code>src/bin/pg_ctl/pg_ctl.c</code></td>
<td>Server control</td>
</tr>
<tr>
<td><strong>initdb</strong></td>
<td><code>src/bin/initdb/initdb.c</code></td>
<td>Initialize cluster</td>
</tr>
<tr>
<td><strong>pg_upgrade</strong></td>
<td><code>src/bin/pg_upgrade/pg_upgrade.c</code></td>
<td>In-place upgrade</td>
</tr>
<tr>
<td><strong>pgbench</strong></td>
<td><code>src/bin/pgbench/pgbench.c</code></td>
<td>Performance testing</td>
</tr>
<tr>
<td><strong>vacuumdb</strong></td>
<td><code>src/bin/scripts/vacuumdb.c</code></td>
<td>Vacuum database</td>
</tr>
<tr>
<td><strong>reindexdb</strong></td>
<td><code>src/bin/scripts/reindexdb.c</code></td>
<td>Reindex database</td>
</tr>
<tr>
<td><strong>clusterdb</strong></td>
<td><code>src/bin/scripts/clusterdb.c</code></td>
<td>Cluster tables</td>
</tr>
</tbody>
</table>
<p>See: <a href="../07-utilities/utility-programs.md">Utilities</a></p>
<hr/>
<h2 data-number="16.5" id="key-contributors-1"><span class="header-section-number">16.5</span> Key Contributors</h2>
<table>
<colgroup>
<col style="width: 22%"/>
<col style="width: 22%"/>
<col style="width: 55%"/>
</colgroup>
<thead>
<tr>
<th>Name</th>
<th>Role</th>
<th>Contributions</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Tom Lane</strong></td>
<td>Core Team</td>
<td>Query optimizer, code review (82,565 emails)</td>
</tr>
<tr>
<td><strong>Bruce Momjian</strong></td>
<td>Core Team</td>
<td>Advocacy, community, documentation</td>
</tr>
<tr>
<td><strong>Magnus Hagander</strong></td>
<td>Core Team</td>
<td>Windows port, infrastructure, replication</td>
</tr>
<tr>
<td><strong>Andres Freund</strong></td>
<td>Core Contributor</td>
<td>Performance, JIT, query execution</td>
</tr>
<tr>
<td><strong>Peter Eisentraut</strong></td>
<td>Long-time</td>
<td>I18n, build system, SQL standards</td>
</tr>
<tr>
<td><strong>Robert Haas</strong></td>
<td>Core Contributor</td>
<td>Parallel query, partitioning, replication</td>
</tr>
<tr>
<td><strong>Michael Paquier</strong></td>
<td>Top Contributor</td>
<td>Recent prolific contributor</td>
</tr>
<tr>
<td><strong>Michael Stonebraker</strong></td>
<td>Founder</td>
<td>Original POSTGRES creator</td>
</tr>
<tr>
<td><strong>Andrew Yu</strong></td>
<td>Historical</td>
<td>Added SQL to POSTGRES</td>
</tr>
</tbody>
</table>
<p>See: <a href="../00-introduction.md#32-key-contributors">Introduction
- Key Contributors</a></p>
<hr/>
<h2 data-number="16.6" id="version-milestones"><span class="header-section-number">16.6</span> Version Milestones</h2>
<table>
<thead>
<tr>
<th>Version</th>
<th>Date</th>
<th>Key Features</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>POSTGRES 1</strong></td>
<td>June 1989</td>
<td>First external release</td>
</tr>
<tr>
<td><strong>POSTGRES 3</strong></td>
<td>1991</td>
<td>Multiple storage managers</td>
</tr>
<tr>
<td><strong>Postgres95 1.0</strong></td>
<td>Sept 1995</td>
<td>SQL support added</td>
</tr>
<tr>
<td><strong>PostgreSQL 6.0</strong></td>
<td>Jan 1997</td>
<td>First official PostgreSQL</td>
</tr>
<tr>
<td><strong>7.0</strong></td>
<td>May 2000</td>
<td>Foreign keys, WAL foundation</td>
</tr>
<tr>
<td><strong>8.0</strong></td>
<td>Jan 2005</td>
<td>Native Windows support</td>
</tr>
<tr>
<td><strong>8.3</strong></td>
<td>Feb 2008</td>
<td>Full-text search, XML, HOT, Enums</td>
</tr>
<tr>
<td><strong>9.0</strong></td>
<td>Sept 2010</td>
<td>Hot standby, streaming replication</td>
</tr>
<tr>
<td><strong>9.1</strong></td>
<td>Sept 2011</td>
<td>Synchronous replication, FDW, extensions</td>
</tr>
<tr>
<td><strong>9.2</strong></td>
<td>Sept 2012</td>
<td>JSON, index-only scans</td>
</tr>
<tr>
<td><strong>9.4</strong></td>
<td>Dec 2014</td>
<td>JSONB, logical replication foundation</td>
</tr>
<tr>
<td><strong>9.5</strong></td>
<td>Jan 2016</td>
<td>UPSERT, BRIN, RLS</td>
</tr>
<tr>
<td><strong>9.6</strong></td>
<td>Sept 2016</td>
<td>Parallel query execution</td>
</tr>
<tr>
<td><strong>10</strong></td>
<td>Oct 2017</td>
<td>Declarative partitioning, logical replication</td>
</tr>
<tr>
<td><strong>11</strong></td>
<td>Oct 2018</td>
<td>Stored procedures, JIT compilation</td>
</tr>
<tr>
<td><strong>12</strong></td>
<td>Oct 2019</td>
<td>Generated columns, pluggable storage</td>
</tr>
<tr>
<td><strong>13</strong></td>
<td>Sept 2020</td>
<td>Parallel vacuum, incremental sorting</td>
</tr>
<tr>
<td><strong>14</strong></td>
<td>Sept 2021</td>
<td>Pipeline mode, JSON subscripting</td>
</tr>
<tr>
<td><strong>15</strong></td>
<td>Oct 2022</td>
<td>MERGE command, regex improvements</td>
</tr>
<tr>
<td><strong>16</strong></td>
<td>Sept 2023</td>
<td>Parallelism improvements, logical replication</td>
</tr>
<tr>
<td><strong>17</strong></td>
<td>Sept 2024</td>
<td>Incremental backups, vacuum improvements</td>
</tr>
</tbody>
</table>
<p>See: <a href="../00-introduction.md#24-major-version-milestones">Introduction -
Version Milestones</a></p>
<hr/>
<h2 data-number="16.7" id="important-source-files"><span class="header-section-number">16.7</span> Important Source Files</h2>
<h3 data-number="16.7.1" id="core-engine"><span class="header-section-number">16.7.1</span> Core Engine</h3>
<ul>
<li><strong>Parser</strong>: <code>src/backend/parser/gram.y</code>,
<code>src/backend/parser/scan.l</code></li>
<li><strong>Planner</strong>:
<code>src/backend/optimizer/planner.c</code>,
<code>src/backend/optimizer/path/pathnode.c</code></li>
<li><strong>Executor</strong>:
<code>src/backend/executor/execMain.c</code>,
<code>src/backend/executor/execTuples.c</code></li>
<li><strong>Analyzer</strong>:
<code>src/backend/parser/analyze.c</code></li>
</ul>
<h3 data-number="16.7.2" id="storage"><span class="header-section-number">16.7.2</span> Storage</h3>
<ul>
<li><strong>Buffer Manager</strong>:
<code>src/backend/storage/buffer/bufmgr.c</code></li>
<li><strong>Heap Access</strong>:
<code>src/backend/access/heap/heapam.c</code></li>
<li><strong>WAL</strong>:
<code>src/backend/access/transam/xlog.c</code></li>
<li><strong>MVCC</strong>:
<code>src/backend/storage/ipc/procarray.c</code></li>
</ul>
<h3 data-number="16.7.3" id="transactions"><span class="header-section-number">16.7.3</span> Transactions</h3>
<ul>
<li><strong>Locking</strong>:
<code>src/backend/storage/lmgr/lock.c</code>,
<code>src/backend/storage/lmgr/lwlock.c</code></li>
<li><strong>Transaction State</strong>:
<code>src/backend/access/transam/xact.c</code></li>
<li><strong>Snapshot</strong>:
<code>src/backend/storage/ipc/procarray.c</code></li>
</ul>
<h3 data-number="16.7.4" id="process-management"><span class="header-section-number">16.7.4</span> Process Management</h3>
<ul>
<li><strong>Postmaster</strong>:
<code>src/backend/postmaster/postmaster.c</code></li>
<li><strong>Backend</strong>:
<code>src/backend/postmaster/postgres.c</code></li>
<li><strong>Autovacuum</strong>:
<code>src/backend/postmaster/autovacuum.c</code></li>
</ul>
<h3 data-number="16.7.5" id="index-access-methods-1"><span class="header-section-number">16.7.5</span> Index Access Methods</h3>
<ul>
<li><strong>B-tree</strong>:
<code>src/backend/access/nbtree/nbtree.c</code></li>
<li><strong>Hash</strong>:
<code>src/backend/access/hash/hash.c</code></li>
<li><strong>GiST</strong>:
<code>src/backend/access/gist/gist.c</code></li>
<li><strong>GIN</strong>:
<code>src/backend/access/gin/ginx.c</code></li>
</ul>
<p>See: <a href="../09-build-system-and-portability.md">Build System -
Source Organization</a></p>
<hr/>
<h1 data-number="17" id="index-usage-guide"><span class="header-section-number">17</span> Index Usage Guide</h1>
<p>This comprehensive index is organized alphabetically with
cross-references. To locate information:</p>
<ol type="1">
<li><strong>By Topic</strong>: Look up the main term (e.g., ‚ÄúMVCC‚Äù,
‚ÄúVACUUM‚Äù, ‚ÄúReplication‚Äù)</li>
<li><strong>By File</strong>: Search for source code files (e.g.,
‚Äúbufmgr.c‚Äù, ‚Äúxlog.c‚Äù)</li>
<li><strong>By Function</strong>: Look up C function names (e.g.,
‚Äúheap_insert‚Äù, ‚ÄúGetSnapshotData‚Äù)</li>
<li><strong>By Data Structure</strong>: Search for struct names (e.g.,
‚ÄúPageHeaderData‚Äù, ‚ÄúBufferDesc‚Äù)</li>
<li><strong>By Utility</strong>: Look up command names (e.g., ‚Äúpg_dump‚Äù,
‚Äúpsql‚Äù)</li>
<li><strong>By Person</strong>: Find contributors‚Äô names (e.g., ‚ÄúTom
Lane‚Äù, ‚ÄúBruce Momjian‚Äù)</li>
<li><strong>By Version</strong>: Browse version milestones section for
feature history</li>
</ol>
<p>Each entry includes: - <strong>Definition</strong>: Clear explanation
of the concept - <strong>Location</strong>: File path for source code
references - <strong>Cross-references</strong>: Links to related
encyclopedia sections - <strong>Context</strong>: Usage in PostgreSQL
internals</p>
<hr/>
<p><strong>Navigation:</strong> - <strong>Encyclopedia Home</strong>: <a href="../README.md">README.md</a> - <strong>Introduction</strong>: <a href="../00-introduction.md">00-introduction.md</a> -
<strong>Glossary</strong>: <a href="glossary.md">appendices/glossary.md</a> - <strong>Storage
Layer</strong>: <a href="../01-storage/storage-layer.md">01-storage/storage-layer.md</a> -
<strong>Query Processing</strong>: <a href="../02-query-processing/query-pipeline.md">02-query-processing/query-pipeline.md</a>
- <strong>Transactions</strong>: <a href="../03-transactions/transaction-management.md">03-transactions/transaction-management.md</a>
- <strong>Replication</strong>: <a href="../04-replication/replication-recovery.md">04-replication/replication-recovery.md</a>
- <strong>Process Architecture</strong>: <a href="../05-processes/process-architecture.md">05-processes/process-architecture.md</a>
- <strong>Extensions</strong>: <a href="../06-extensions/extension-system.md">06-extensions/extension-system.md</a>
- <strong>Utilities</strong>: <a href="../07-utilities/utility-programs.md">07-utilities/utility-programs.md</a>
- <strong>Build System</strong>: <a href="../09-build-system-and-portability.md">09-build-system-and-portability.md</a>
- <strong>Evolution</strong>: <a href="../08-evolution/historical-evolution.md">08-evolution/historical-evolution.md</a></p>
<hr/>
<p><em>Last Updated: November 19, 2025</em> <em>PostgreSQL Encyclopedia
Version 1.0</em></p>
<h1 data-number="18" id="bibliography-postgresql-encyclopedia"><span class="header-section-number">18</span> Bibliography: PostgreSQL
Encyclopedia</h1>
<p>A comprehensive collection of academic papers, official
documentation, books, online resources, and community references related
to PostgreSQL development and administration.</p>
<hr/>
<h2 data-number="18.1" id="academic-papers-1"><span class="header-section-number">18.1</span> 1. Academic Papers</h2>
<h3 data-number="18.1.1" id="foundational-works"><span class="header-section-number">18.1.1</span> Foundational Works</h3>
<p><strong>[1] Stonebraker, M., &amp; Rowe, L. A. (1986).</strong> ‚ÄúThe
Design of POSTGRES.‚Äù <em>Proceedings of the 1986 International
Conference on Very Large Data Bases (VLDB)</em>, San Francisco, CA. -
Seminal paper introducing POSTGRES design principles, including: - Rule
system and query rewriting - Time-travel capabilities - Object-oriented
extensions - Available: <a href="https://vldb.org/pvldb/">VLDB 1986
Archives</a></p>
<p><strong>[2] Stonebraker, M., &amp; Kemnitz, G. (1991).</strong> ‚ÄúThe
POSTGRES next generation database system.‚Äù <em>Communications of the
ACM</em>, 34(10), 78-92. - Overview of POSTGRES evolution and advanced
features - Discussion of inheritance and type systems</p>
<p><strong>[3] Hellerstein, J. M., Stonebraker, M., &amp; Hamilton, R.
(2007).</strong> ‚ÄúArchitecture of a Database System.‚Äù <em>Foundations
and Trends in Databases</em>, 1(2), 141-259. - Comprehensive database
system architecture principles applicable to PostgreSQL - Query
optimization and execution strategies</p>
<h3 data-number="18.1.2" id="concurrency-and-isolation"><span class="header-section-number">18.1.2</span> Concurrency and
Isolation</h3>
<p><strong>[4] Adya, A., Liskov, B., &amp; O‚ÄôNeill, P. (2000).</strong>
‚ÄúGeneralized Isolation Level Definitions.‚Äù <em>Proceedings of the 16th
International Conference on Data Engineering (ICDE)</em>, San Diego, CA.
- Theoretical foundation for transaction isolation levels - Directly
influenced PostgreSQL isolation implementations</p>
<p><strong>[5] Cahill, M. J., R√∂hm, U., &amp; Fekete, A. D.
(2008).</strong> ‚ÄúSerializable Isolation for Snapshot Databases.‚Äù
<em>Proceedings of the 2008 ACM SIGMOD International Conference on
Management of Data</em>, Vancouver, BC, Canada. - Foundational work on
Serializable Snapshot Isolation (SSI) - Implementation basis for
PostgreSQL 9.1+ SSI</p>
<p><strong>[6] Fekete, A., Liarokapis, D., O‚ÄôNeill, E., &amp; O‚ÄôNeill,
P. (2004).</strong> ‚ÄúMaking Snapshot Isolation Serializable.‚Äù <em>ACM
Transactions on Database Systems (TODS)</em>, 30(2), 492-528. - Detailed
analysis of snapshot isolation weaknesses - Solutions implemented in
PostgreSQL SSI</p>
<p><strong>[7] Ports, D. R., Grittner, A. L., Soros, C., O‚ÄôNeill, P.,
&amp; Fekete, A. D. (2012).</strong> ‚ÄúSerializable Snapshot Isolation in
PostgreSQL.‚Äù <em>Proceedings of the Very Large Databases Conference
(VLDB)</em>, Istanbul, Turkey. - Practical implementation of SSI in
PostgreSQL - Performance analysis and trade-offs</p>
<h3 data-number="18.1.3" id="mvcc-and-visibility"><span class="header-section-number">18.1.3</span> MVCC and Visibility</h3>
<p><strong>[8] Lomet, D. B. (1992).</strong> ‚ÄúThe Architecture of the
EXODUS Extensible Database System.‚Äù <em>Proceedings of the International
Workshop on Object-Oriented Database Systems</em>. - Time-travel and
versioning mechanisms - Influenced PostgreSQL MVCC design</p>
<p><strong>[9] Berenson, H., Bleakley, G., Gray, J., Huang, W.,
MacKenzie, P., Stonebraker, M., &amp; Vitter, J. S. (1995).</strong> ‚ÄúA
Critique of ANSI SQL Isolation Levels.‚Äù <em>Proceedings of the 1995 ACM
SIGMOD International Conference on Management of Data</em>, San Jose,
CA. - Critical analysis of SQL isolation definitions - Foundational for
PostgreSQL isolation level design</p>
<h3 data-number="18.1.4" id="query-optimization"><span class="header-section-number">18.1.4</span> Query Optimization</h3>
<p><strong>[10] Selinger, P. G., Astrahan, M. M., Chamberlin, D. D.,
Lorie, R. A., &amp; Price, T. G. (1979).</strong> ‚ÄúAccess Path Selection
in a Relational Database Management System.‚Äù <em>Proceedings of the 1979
ACM SIGMOD International Conference on Management of Data</em>, Boston,
MA. - Classical query optimization paper - Cost-based optimization
principles used in PostgreSQL</p>
<p><strong>[11] Ioannidis, Y. E. (1996).</strong> ‚ÄúQuery Optimization.‚Äù
<em>ACM Computing Surveys (CSUR)</em>, 28(1), 121-123. - Comprehensive
survey of query optimization techniques - Applicable to PostgreSQL query
planner</p>
<p><strong>[12] Leis, V., Gubichev, A., Mirchev, A., Boncz, P., &amp;
Kemper, A. (2015).</strong> ‚ÄúHow Good Are Query Optimizers, Really?‚Äù
<em>Proceedings of the VLDB Endowment</em>, 9(3), 204-215. - Modern
analysis of query optimizer effectiveness - Relevant to PostgreSQL query
planning strategies</p>
<h3 data-number="18.1.5" id="distributed-postgresql"><span class="header-section-number">18.1.5</span> Distributed PostgreSQL</h3>
<p><strong>[13] Stonebraker, M., Agrawal, D., El Abbadi, A., Brunstrom,
A., Chodorow, M., Fitting, C., et al.¬†(2010).</strong> ‚ÄúThe End of an
Architectural Era: (It‚Äôs Time for a Complete Rewrite).‚Äù <em>Proceedings
of the 36th International Conference on Very Large Databases
(VLDB)</em>, Singapore. - Discussion of modern database architecture -
Relevant to PostgreSQL distributed approaches (Postgres-XL, Citus)</p>
<p><strong>[14] Hellerstein, J. M., R√©, C., Schoppmann, F., Wang, D. Z.,
Zhao, E., Miao, Z., et al.¬†(2019).</strong> ‚ÄúThe Declarative Imperative:
Experiences and Opportunities for Declarative Programming.‚Äù <em>arXiv
preprint arXiv:1909.02029</em>. - PostgreSQL‚Äôs role in modern
declarative systems</p>
<h3 data-number="18.1.6" id="full-text-search-and-indexing"><span class="header-section-number">18.1.6</span> Full-Text Search and
Indexing</h3>
<p><strong>[15] Baeza-Yates, R., &amp; Ribeiro-Neto, B. (1999).</strong>
‚ÄúModern Information Retrieval.‚Äù <em>Addison-Wesley</em>, New York, NY. -
Foundation for PostgreSQL full-text search - Text indexing and ranking
algorithms</p>
<p><strong>[16] Knuth, D. E. (1997).</strong> ‚ÄúThe Art of Computer
Programming, Volume 3: Sorting and Searching.‚Äù <em>Addison-Wesley</em>,
2nd ed. - B-tree and balanced tree algorithms - Basis for PostgreSQL
index structures</p>
<h3 data-number="18.1.7" id="json-and-unstructured-data"><span class="header-section-number">18.1.7</span> JSON and Unstructured
Data</h3>
<p><strong>[17] Chamberlin, D., Melton, J., &amp; Myers, G.
(2011).</strong> ‚ÄúSQL and JSON Integration: SQL/JSON.‚Äù <em>ISO/IEC JTC
1/SC 32 Standards</em>. - Standards foundation for PostgreSQL JSON
features - SQL/JSON specification</p>
<h3 data-number="18.1.8" id="advanced-data-types"><span class="header-section-number">18.1.8</span> Advanced Data Types</h3>
<p><strong>[18] Rowe, L. A., &amp; Stonebraker, M. (1987).</strong> ‚ÄúThe
POSTGRES Data Model.‚Äù <em>Proceedings of the 13th International
Conference on Very Large Data Bases (VLDB)</em>, Brighton, England. -
Object-relational extensions - Type system extensibility</p>
<p><strong>[19] Melton, J., &amp; Simon, A. R. (2001).</strong>
‚ÄúSQL:1999 - Understanding Relational Language Components.‚Äù <em>Morgan
Kaufmann</em>, San Francisco, CA. - SQL standards including row types
and composite types - Applicable to PostgreSQL type system</p>
<hr/>
<h2 data-number="18.2" id="official-postgresql-documentation"><span class="header-section-number">18.2</span> 2. Official PostgreSQL
Documentation</h2>
<h3 data-number="18.2.1" id="current-documentation-postgresql-17"><span class="header-section-number">18.2.1</span> Current Documentation
(PostgreSQL 17)</h3>
<p><strong>Official PostgreSQL 17 Documentation</strong> - URL:
https://www.postgresql.org/docs/17/ - Full reference manual, tutorials,
and guides - Installation and administration guides - SQL reference -
Contrib modules documentation</p>
<p><strong>Key Documentation Sections:</strong> - <a href="https://www.postgresql.org/docs/17/admin.html">Server
Administration</a> - Administration, backup, replication - <a href="https://www.postgresql.org/docs/17/sql.html">SQL Language
Reference</a> - SQL commands, syntax, functions - <a href="https://www.postgresql.org/docs/17/server-programming.html">Server
Programming</a> - Extensions, PL/pgSQL, triggers - <a href="https://www.postgresql.org/docs/17/reference-client.html">Client
Applications</a> - psql, pg_dump, utilities - <a href="https://www.postgresql.org/docs/17/datatype.html">The PostgreSQL
Type System</a> - Data types and operators - <a href="https://www.postgresql.org/docs/17/indexes.html">Indexes</a> -
Index types and usage - <a href="https://www.postgresql.org/docs/17/performance-tips.html">Performance
Tips</a> - Query optimization and tuning</p>
<h3 data-number="18.2.2" id="historical-documentation-versions"><span class="header-section-number">18.2.2</span> Historical Documentation
Versions</h3>
<p><strong>PostgreSQL 16 Documentation</strong> - URL:
https://www.postgresql.org/docs/16/</p>
<p><strong>PostgreSQL 15 Documentation</strong> - URL:
https://www.postgresql.org/docs/15/</p>
<p><strong>PostgreSQL 14 Documentation</strong> - URL:
https://www.postgresql.org/docs/14/</p>
<p><strong>PostgreSQL 13 Documentation</strong> - URL:
https://www.postgresql.org/docs/13/</p>
<p><strong>PostgreSQL 12 Documentation</strong> - URL:
https://www.postgresql.org/docs/12/</p>
<p><strong>PostgreSQL 11 Documentation</strong> - URL:
https://www.postgresql.org/docs/11/</p>
<p><strong>Archived Documentation</strong> - Versions 10 and earlier:
https://www.postgresql.org/docs/old/</p>
<h3 data-number="18.2.3" id="technical-documentation"><span class="header-section-number">18.2.3</span> Technical Documentation</h3>
<p><strong>PostgreSQL Internals</strong> - URL:
https://www.postgresql.org/docs/17/internals.html - System catalog, WAL
architecture, buffer management - Query execution, parser, planner,
executor</p>
<p><strong>FDW (Foreign Data Wrapper) Documentation</strong> - URL:
https://www.postgresql.org/docs/17/ddl-foreign-data.html - Integrating
external data sources</p>
<p><strong>Replication Documentation</strong> - URL:
https://www.postgresql.org/docs/17/warm-standby.html - Streaming
replication, logical replication - High availability configuration</p>
<hr/>
<h2 data-number="18.3" id="books-1"><span class="header-section-number">18.3</span> 3. Books</h2>
<h3 data-number="18.3.1" id="comprehensive-guides"><span class="header-section-number">18.3.1</span> Comprehensive Guides</h3>
<p><strong>[1] Krosing, K., &amp; Momjian, B. (2022).</strong>
<em>PostgreSQL: Up and Running</em> (3rd ed.). <em>O‚ÄôReilly Media</em>,
Sebastopol, CA. - ISBN: 978-1492126683 - Practical guide to PostgreSQL
installation, configuration, and daily operations - Covers
backup/recovery, replication, monitoring, and optimization -
<strong>Audience:</strong> Database administrators and developers</p>
<p><strong>[2] M√ºller, P. (2019).</strong> <em>The Art of
PostgreSQL</em> (1st ed.). <em>Mastering PostgreSQL in Application
Development</em>. - URL: https://theartofpostgresql.com/ - Deep dive
into PostgreSQL for application developers - Advanced query techniques,
normalization, indexing strategies - <strong>Audience:</strong>
Application developers, data architects</p>
<p><strong>[3] Momjian, B. (2001).</strong> <em>PostgreSQL: Introduction
and Concepts</em>. <em>Addison-Wesley</em>, Boston, MA. - ISBN:
0201703527 - Foundational understanding of PostgreSQL architecture -
<strong>Audience:</strong> Developers and system architects</p>
<h3 data-number="18.3.2" id="administration-and-operations"><span class="header-section-number">18.3.2</span> Administration and
Operations</h3>
<p><strong>[4] Corradi, S., Sanguinetti, E., &amp; Scarano, G.
(2017).</strong> <em>PostgreSQL Administration Cookbook</em> (3rd ed.).
<em>Packt Publishing</em>, Birmingham, UK. - ISBN: 978-1785880529 -
Practical recipes for common PostgreSQL administration tasks - Backup
strategies, performance tuning, troubleshooting -
<strong>Audience:</strong> Database administrators</p>
<p><strong>[5] Momjian, B. (2023).</strong> <em>Mastering PostgreSQL in
Application Development</em>. <em>Self-published</em>. - URL:
https://masteringpostgresql.com/ - Comprehensive coverage of PostgreSQL
for developers - Advanced features: arrays, JSON, full-text search,
window functions - <strong>Audience:</strong> Experienced developers</p>
<p><strong>[6] Smith, E., &amp; Gooch, P. (2022).</strong>
<em>PostgreSQL 14 Administration Cookbook: Over 175 Recipes for Managing
and Monitoring PostgreSQL</em> (2nd ed.). <em>Packt Publishing</em>. -
ISBN: 978-1803248319 - Configuration, monitoring, security, and disaster
recovery - <strong>Audience:</strong> System administrators and DevOps
engineers</p>
<h3 data-number="18.3.3" id="specialized-topics"><span class="header-section-number">18.3.3</span> Specialized Topics</h3>
<p><strong>[7] Hansson, D. H., &amp; Brixius, L. A. (2015).</strong>
<em>Efficient Rails Development</em>. <em>Self-published</em>. -
Includes PostgreSQL optimization for Rails applications - Performance
tuning for web applications</p>
<p><strong>[8] Mokhov, S. (2016).</strong> <em>PostgreSQL Query
Performance Insights</em>. <em>Mastering PostgreSQL</em>. - Deep
analysis of query performance - Execution plans and optimization
strategies - <strong>Audience:</strong> DBAs and performance
engineers</p>
<p><strong>[9] M√ºller, P., &amp; Contributors. (2020).</strong> <em>SQL
and Relational Theory</em> (PostgreSQL Edition). <em>Online Guide</em>.
- SQL standards and relational theory application - Advanced query
design patterns</p>
<h3 data-number="18.3.4" id="plpgsql-and-programming"><span class="header-section-number">18.3.4</span> PL/pgSQL and
Programming</h3>
<p><strong>[10] Grand, S. (2010).</strong> <em>The PL/pgSQL
Tutorial</em>. <em>Online Documentation and PostgreSQL Wiki</em>. - URL:
https://wiki.postgresql.org/wiki/Pl_pgSQL_by_example - Practical
PL/pgSQL programming patterns - Stored procedures and triggers</p>
<p><strong>[11] M√ºller, P. (2021).</strong> <em>PostgreSQL and PL/pgSQL
Best Practices</em>. <em>Online Blog and Documentation</em>. - URL:
https://theartofpostgresql.com/ - Advanced procedural programming
techniques</p>
<h3 data-number="18.3.5" id="historical-and-reference"><span class="header-section-number">18.3.5</span> Historical and
Reference</h3>
<p><strong>[12] Momjian, B. (1997).</strong> <em>PostgreSQL: A
Comprehensive User Guide</em>. <em>Self-published</em>. - Historical
perspective on PostgreSQL development - Early features and design
decisions</p>
<hr/>
<h2 data-number="18.4" id="online-resources"><span class="header-section-number">18.4</span> 4. Online Resources</h2>
<h3 data-number="18.4.1" id="official-postgresql-sites"><span class="header-section-number">18.4.1</span> Official PostgreSQL
Sites</h3>
<p><strong>PostgreSQL Official Website</strong> - URL:
https://www.postgresql.org/ - News, downloads, documentation, community
information - List of PostgreSQL companies and contributors</p>
<p><strong>PostgreSQL Wiki</strong> - URL: https://wiki.postgresql.org/
- Community-maintained knowledge base - Useful articles on performance,
replication, monitoring - Performance tuning guides - Setup and
configuration best practices</p>
<p><strong>PostgreSQL Release Notes</strong> - URL:
https://www.postgresql.org/docs/release/ - Detailed changelog for each
PostgreSQL version - New features, improvements, and bug fixes</p>
<p><strong>PostgreSQL Bug Tracker</strong> - URL:
https://github.com/postgres/postgres/issues - Issue reporting and
tracking - Developer discussions on bugs and features</p>
<h3 data-number="18.4.2" id="documentation-and-guides"><span class="header-section-number">18.4.2</span> Documentation and
Guides</h3>
<p><strong>PostgreSQL Internals Documentation (unofficial)</strong> -
URL: https://www.postgresql.org/docs/current/internals.html - In-depth
coverage of PostgreSQL architecture - Query execution model, storage
engine, replication</p>
<p><strong>UseTheIndex, Luke!</strong> - URL:
https://use-the-index-luke.com/ - Database indexing fundamentals - Query
optimization strategies applicable to PostgreSQL</p>
<p><strong>SQL Performance Explained</strong> - URL:
https://sql-performance-explained.com/ - Detailed guide to SQL query
optimization - Execution plans and index usage</p>
<p><strong>PgAdmin Documentation</strong> - URL:
https://www.pgadmin.org/docs/pgadmin4/latest/ - Web-based PostgreSQL
administration interface - Complete feature documentation</p>
<h3 data-number="18.4.3" id="community-resources"><span class="header-section-number">18.4.3</span> Community Resources</h3>
<p><strong>PostgreSQL Mailing Lists</strong> - URL:
https://www.postgresql.org/list/ - pgsql-general: General questions and
discussions - pgsql-hackers: Developer discussions - pgsql-bugs: Bug
reports and discussions - pgsql-novice: Beginner questions - Searchable
archives dating back to 1997</p>
<p><strong>Stack Overflow PostgreSQL Tag</strong> - URL:
https://stackoverflow.com/questions/tagged/postgresql - Community
Q&amp;A platform - Thousands of answered questions on PostgreSQL
usage</p>
<p><strong>PostgreSQL Reddit Community</strong> - URL:
https://www.reddit.com/r/PostgreSQL/ - Active community discussions -
News, tips, and best practices</p>
<p><strong>PostgreSQL Discord Communities</strong> - Numerous
community-run Discord servers - Real-time chat, code sharing, and peer
support - New contributors welcome</p>
<h3 data-number="18.4.4" id="blogs-and-publications"><span class="header-section-number">18.4.4</span> Blogs and Publications</h3>
<p><strong>Planet PostgreSQL</strong> - URL:
https://planet.postgresql.org/ - Aggregated blog posts from PostgreSQL
community members - Latest news, tips, tutorials, and research</p>
<p><strong>PostgreSQL Consultants Blog Network</strong> - Various
independent PostgreSQL consultants maintain blogs - In-depth technical
articles on advanced topics - Case studies and real-world
optimizations</p>
<p><strong>Citus Data Blog</strong> - URL:
https://www.citusdata.com/blog - PostgreSQL extensions and distributed
PostgreSQL - Advanced optimization techniques</p>
<p><strong>Cybertec Blog</strong> - URL:
https://www.cybertec-postgresql.com/en/blog/ - PostgreSQL performance
and administration tips - Technical deep dives by experienced DBAs</p>
<p><strong>PostgreSQL Performance Analysis</strong> - URL:
https://explain.depesz.com/ - Query plan analyzer and discussion
platform - Community-driven performance optimization</p>
<h3 data-number="18.4.5" id="video-resources"><span class="header-section-number">18.4.5</span> Video Resources</h3>
<p><strong>PG Casts</strong> - URL: https://www.pgcasts.com/ - Short
video tutorials on PostgreSQL features - Tips and tricks for developers
and DBAs</p>
<p><strong>Percona University</strong> - URL:
https://www.percona.com/resources/webinars - Free webinars on database
topics including PostgreSQL</p>
<p><strong>YouTube PostgreSQL Channels</strong> - PostgreSQL official
channel - Community contributor channels - Educational playlists on
PostgreSQL features</p>
<hr/>
<h2 data-number="18.5" id="source-code"><span class="header-section-number">18.5</span> 5. Source Code</h2>
<h3 data-number="18.5.1" id="official-repository"><span class="header-section-number">18.5.1</span> Official Repository</h3>
<p><strong>PostgreSQL Git Repository</strong> - URL:
https://git.postgresql.org/git/postgresql.git/ - Official source code
repository - Complete git history since PostgreSQL 9.1 - Clone:
<code>git clone https://git.postgresql.org/git/postgresql.git</code></p>
<p><strong>GitHub Mirror</strong> - URL:
https://github.com/postgres/postgres - Official mirror hosted on GitHub
- Issue tracking (GitHub Issues) - Pull request discussions - Accessible
to developers without git.postgresql.org account</p>
<h3 data-number="18.5.2" id="key-source-files-and-directories"><span class="header-section-number">18.5.2</span> Key Source Files and
Directories</h3>
<p><strong>Backend Source Code: <code>/src/backend/</code></strong> -
<code>access/</code>: Access methods and AM interface -
<code>catalog/</code>: System catalog implementation -
<code>commands/</code>: SQL command execution - <code>executor/</code>:
Query executor - <code>nodes/</code>: Parse tree and plan nodes -
<code>optimizer/</code>: Query planner and optimizer -
<code>parser/</code>: SQL parser - <code>replication/</code>:
Replication logic - <code>storage/</code>: Storage layer (heap, indexes,
WAL) - <code>utils/</code>: Utility functions</p>
<p><strong>Frontend Source Code: <code>/src/frontend/</code></strong> -
<code>psql/</code>: PostgreSQL client application - <code>libpq/</code>:
Client library - <code>bin/</code>: Utility programs (pg_dump,
pg_restore, etc.)</p>
<p><strong>Include Files: <code>/src/include/</code></strong> - Header
files for internal data structures - Function prototypes and macros</p>
<p><strong>Contrib Modules: <code>/contrib/</code></strong> - Additional
modules and extensions - btree_gist, btree_gin, pg_stat_statements,
pg_trgm, etc.</p>
<h3 data-number="18.5.3" id="code-analysis-resources"><span class="header-section-number">18.5.3</span> Code Analysis Resources</h3>
<p><strong>Code Search Tools</strong> - URL: https://pgxn.org/ -
PostgreSQL Extensions Network - Search and browse extension source
code</p>
<p><strong>OpenGrok PostgreSQL</strong> - Cross-referenced PostgreSQL
source code - Fast code navigation and search</p>
<p><strong>Source Code Documentation</strong> - Files:
<code>INSTALL</code>, <code>README</code>,
<code>CODING_GUIDELINES</code> - Development documentation in
<code>/doc/src/sgml/</code></p>
<hr/>
<h2 data-number="18.6" id="community-resources-1"><span class="header-section-number">18.6</span> 6. Community Resources</h2>
<h3 data-number="18.6.1" id="conferences-and-events"><span class="header-section-number">18.6.1</span> Conferences and Events</h3>
<p><strong>PGCon (PostgreSQL Convention)</strong> - URL:
https://www.pgcon.org/ - Annual conference in Ottawa, Canada - Held
annually in May/June - Presentations from core developers and community
- Covers development, administration, and advanced topics - Proceedings
and slides available online</p>
<p><strong>FOSDEM PGDay</strong> - URL: https://fosdem.org/ - PostgreSQL
track at FOSDEM (Free and Open Source Developers Meeting) - Brussels,
Belgium, held in early February - Free, community-run conference -
Lightning talks and full presentations - Videos available
post-conference</p>
<p><strong>PostgreSQL Europe Conferences</strong> - Various regional
conferences throughout Europe - URLs available at
https://www.postgresql.eu/</p>
<p><strong>PostgreSQL Summit</strong> - North American PostgreSQL
Conference - Held in various cities annually - Vendor-neutral,
community-focused conference</p>
<p><strong>Local PostgreSQL Meetups</strong> - Hundreds of local user
groups worldwide - Meetup.com search: PostgreSQL + your city - Monthly
meetings and presentations - Networking opportunities</p>
<h3 data-number="18.6.2" id="online-communities"><span class="header-section-number">18.6.2</span> Online Communities</h3>
<p><strong>PostgreSQL Slack Community</strong> - Multiple community-run
Slack workspaces - #postgresql-general, #help, #advanced-topics channels
- Real-time community support</p>
<p><strong>IRC Channels</strong> - <code>#postgresql</code> on
Freenode/Libera Chat - Developer and user support - Active 24/7</p>
<p><strong>PostgreSQL Forum</strong> - URL:
https://www.postgresql.org/community/ - Official community page with
links to forums - Various third-party PostgreSQL forums</p>
<p><strong>Database Administration Exchange</strong> - URL:
https://dba.stackexchange.com/ - Database professional Q&amp;A -
PostgreSQL section and discussions</p>
<h3 data-number="18.6.3" id="developer-resources"><span class="header-section-number">18.6.3</span> Developer Resources</h3>
<p><strong>PostgreSQL Developer Community</strong> - URL:
https://www.postgresql.org/developer/ - Contributing guidelines -
Feature discussion and voting (commitfest) - Patch submission
procedures</p>
<p><strong>Commitfest</strong> - PostgreSQL development cycle review
process - Discussion and review of proposed patches - Multiple
commitfests throughout the year</p>
<p><strong>PostgreSQL Contributors</strong> - URL:
https://www.postgresql.org/community/contributors/ - Recognition of
PostgreSQL contributors - List of major contributors and their areas</p>
<p><strong>PostgreSQL Sponsorship and Support</strong> - URL:
https://www.postgresql.org/about/sponsors/ - Companies supporting
PostgreSQL development - Support and professional services providers</p>
<h3 data-number="18.6.4" id="companies-and-organizations"><span class="header-section-number">18.6.4</span> Companies and
Organizations</h3>
<p><strong>PostgreSQL Global Development Group (PGDG)</strong> -
Non-profit organization overseeing PostgreSQL development - URL:
https://www.postgresql.org/community/</p>
<p><strong>Core Team and Committers</strong> - URL:
https://www.postgresql.org/community/developers/ - Core team members -
Patch committers</p>
<p><strong>Major PostgreSQL Service Providers</strong> - Citus Data
(distributed PostgreSQL) - Percona (database services) - Cybertec
(PostgreSQL consulting) - 2ndQuadrant (PostgreSQL services) - Timescale
(TimescaleDB - time-series PostgreSQL extension) - EnterpriseDB
(PostgreSQL distributions and services)</p>
<h3 data-number="18.6.5" id="educational-programs"><span class="header-section-number">18.6.5</span> Educational Programs</h3>
<p><strong>PostgreSQL Certification Programs</strong> - PGDG
Certification (development focus) - PGCA Certification (administration
focus) - Various vendor certifications</p>
<p><strong>Online Courses</strong> - Coursera: Various database courses
using PostgreSQL - Udemy: PostgreSQL-specific courses - Pluralsight:
Database administration and optimization - A Cloud Guru: PostgreSQL
courses on cloud platforms</p>
<p><strong>University Programs</strong> - PostgreSQL used in many
computer science curricula - Database courses featuring PostgreSQL</p>
<hr/>
<h2 data-number="18.7" id="related-tools-and-extensions"><span class="header-section-number">18.7</span> 7. Related Tools and
Extensions</h2>
<h3 data-number="18.7.1" id="popular-postgresql-extensions"><span class="header-section-number">18.7.1</span> Popular PostgreSQL
Extensions</h3>
<p><strong>PostGIS</strong> - Spatial and geographic data support - URL:
https://postgis.net/ - GEOS, PROJ, SFCGAL integration</p>
<p><strong>TimescaleDB</strong> - Time-series database extension - URL:
https://www.timescaledata.com/</p>
<p><strong>Citus</strong> - Distributed PostgreSQL - URL:
https://www.citusdata.com/</p>
<p><strong>PgBouncer</strong> - Connection pooling and protocol
translation - URL: https://www.pgbouncer.org/</p>
<p><strong>pg_stat_statements</strong> - Query performance analysis -
Included in contrib</p>
<p><strong>pg_trgm</strong> - Trigram matching and full-text search
optimization - Included in contrib</p>
<p><strong>HypoPG</strong> - Virtual/hypothetical index management -
Useful for query optimization</p>
<h3 data-number="18.7.2" id="related-tools"><span class="header-section-number">18.7.2</span> Related Tools</h3>
<p><strong>DBeaver</strong> - URL: https://dbeaver.io/ - Database IDE
supporting PostgreSQL - Advanced features: query optimization, schema
comparison</p>
<p><strong>pgAdmin</strong> - URL: https://www.pgadmin.org/ - Web-based
PostgreSQL administration and development</p>
<p><strong>pg_dump / pg_restore</strong> - Official PostgreSQL backup
and restore utilities - Available in every PostgreSQL installation</p>
<p><strong>Patroni</strong> - Automated PostgreSQL high availability -
URL: https://github.com/zalando/patroni</p>
<p><strong>Docker PostgreSQL Images</strong> - Official PostgreSQL
Docker images - URL: https://hub.docker.com/_/postgres</p>
<hr/>
<h2 data-number="18.8" id="standards-and-specifications"><span class="header-section-number">18.8</span> 8. Standards and
Specifications</h2>
<h3 data-number="18.8.1" id="sql-standards"><span class="header-section-number">18.8.1</span> SQL Standards</h3>
<p><strong>ISO/IEC 9075 - SQL Standard</strong> - SQL:1986, SQL:1989,
SQL:1992, SQL:1999, SQL:2003, SQL:2008, SQL:2011, SQL:2016, SQL:2019 -
PostgreSQL implements large subset of SQL standard - Reference for SQL
syntax and behavior</p>
<p><strong>SQL/JSON (ISO/IEC 9075-2:2016)</strong> - JSON data type and
functions - Standardized JSON operations</p>
<p><strong>SQL/MED (ISO/IEC 9075-9)</strong> - Management of External
Data - Foreign Data Wrapper foundation</p>
<h3 data-number="18.8.2" id="database-architecture-standards"><span class="header-section-number">18.8.2</span> Database Architecture
Standards</h3>
<p><strong>ACID Properties</strong> - Atomicity, Consistency, Isolation,
Durability - PostgreSQL guarantees all ACID properties</p>
<p><strong>CAP Theorem</strong> - Consistency, Availability, Partition
Tolerance - Relevant to distributed PostgreSQL implementations</p>
<hr/>
<h2 data-number="18.9" id="recommended-reading-order"><span class="header-section-number">18.9</span> 9. Recommended Reading
Order</h2>
<h3 data-number="18.9.1" id="for-new-users"><span class="header-section-number">18.9.1</span> For New Users</h3>
<ol type="1">
<li>PostgreSQL: Up and Running (Ch. 1-5)</li>
<li>PostgreSQL Official Documentation (Getting Started)</li>
<li>PG Casts videos (basics)</li>
<li>Stack Overflow PostgreSQL tag (practical questions)</li>
</ol>
<h3 data-number="18.9.2" id="for-application-developers"><span class="header-section-number">18.9.2</span> For Application
Developers</h3>
<ol type="1">
<li>The Art of PostgreSQL</li>
<li>PostgreSQL Documentation (SQL Reference, Data Types)</li>
<li>Stack Overflow (PostgreSQL application development)</li>
<li>Planet PostgreSQL (latest techniques)</li>
</ol>
<h3 data-number="18.9.3" id="for-database-administrators"><span class="header-section-number">18.9.3</span> For Database
Administrators</h3>
<ol type="1">
<li>PostgreSQL Administration Cookbook</li>
<li>PostgreSQL: Up and Running (Administration sections)</li>
<li>Mastering PostgreSQL in Application Development</li>
<li>PostgreSQL Performance Tips Documentation</li>
</ol>
<h3 data-number="18.9.4" id="for-performance-engineers"><span class="header-section-number">18.9.4</span> For Performance
Engineers</h3>
<ol type="1">
<li>SQL and Relational Theory</li>
<li>SQL Performance Explained</li>
<li>PostgreSQL Internals Documentation</li>
<li>Cybertec Blog, Citus Data Blog</li>
<li>explain.depesz.com (query plan analysis)</li>
</ol>
<h3 data-number="18.9.5" id="for-postgresql-contributors-1"><span class="header-section-number">18.9.5</span> For PostgreSQL
Contributors</h3>
<ol type="1">
<li>PostgreSQL Coding Guidelines (in source)</li>
<li>PostgreSQL Internals Documentation</li>
<li>PostgreSQL Git Repository</li>
<li>Mailing list archives (pgsql-hackers)</li>
<li>PGCon talks (recent years)</li>
</ol>
<hr/>
<h2 data-number="18.10" id="citation-guide"><span class="header-section-number">18.10</span> 10. Citation Guide</h2>
<h3 data-number="18.10.1" id="how-to-cite-postgresql"><span class="header-section-number">18.10.1</span> How to Cite PostgreSQL</h3>
<p><strong>Academic Papers:</strong> &gt; Stonebraker, M., &amp; Rowe,
L. A. (1986). The Design of POSTGRES. Proceedings of the 1986
International Conference on Very Large Data Bases (VLDB), San Francisco,
CA.</p>
<p><strong>PostgreSQL Software:</strong> &gt; The PostgreSQL Global
Development Group. (2024). PostgreSQL (Version 17.0) [Computer
software]. Retrieved from https://www.postgresql.org/</p>
<p><strong>PostgreSQL Documentation:</strong> &gt; The PostgreSQL Global
Development Group. (2024). PostgreSQL 17 Documentation. Retrieved from
https://www.postgresql.org/docs/17/</p>
<p><strong>Books:</strong> &gt; Krosing, K., &amp; Momjian, B. (2022).
PostgreSQL: Up and Running (3rd ed.). O‚ÄôReilly Media.</p>
<p><strong>Online Articles:</strong> &gt; Author Name. (Year). Article
title. Retrieved from URL</p>
<hr/>
<h2 data-number="18.11" id="additional-resources"><span class="header-section-number">18.11</span> 11. Additional Resources</h2>
<h3 data-number="18.11.1" id="newsletters-and-subscriptions"><span class="header-section-number">18.11.1</span> Newsletters and
Subscriptions</h3>
<p><strong>PostgreSQL Weekly Digest</strong> - URL:
https://postgresweekly.com/ - Curated weekly news and articles</p>
<p><strong>Postgres FM</strong> - Weekly podcast about PostgreSQL - URL:
https://postgresfm.com/</p>
<h3 data-number="18.11.2" id="research-and-papers"><span class="header-section-number">18.11.2</span> Research and Papers</h3>
<p><strong>VLDB Archives</strong> - URL: https://vldb.org/ - Access to
published papers from VLDB conferences</p>
<p><strong>ACM Digital Library</strong> - URL: https://dl.acm.org/ -
Database papers and computer science research</p>
<p><strong>arXiv</strong> - URL: https://arxiv.org/ - Preprints of
computer science research - Search: PostgreSQL, databases, query
optimization</p>
<h3 data-number="18.11.3" id="benchmarking-resources"><span class="header-section-number">18.11.3</span> Benchmarking Resources</h3>
<p><strong>TPC (Transaction Processing Council)</strong> - URL:
https://www.tpc.org/ - Standard database benchmarks - TPC-C, TPC-H,
TPC-DS benchmarks</p>
<p><strong>pgbench</strong> - Built-in PostgreSQL benchmarking tool -
Documentation: https://www.postgresql.org/docs/current/pgbench.html</p>
<hr/>
<h2 data-number="18.12" id="conclusion-7"><span class="header-section-number">18.12</span> Conclusion</h2>
<p>This bibliography provides a comprehensive foundation for
understanding PostgreSQL from multiple perspectives: - <strong>Academic
Foundation:</strong> Understand the theoretical principles and research
behind PostgreSQL - <strong>Practical Documentation:</strong> Access
official guides for installation, administration, and development -
<strong>Published Works:</strong> Learn from experienced authors and
community members - <strong>Community Engagement:</strong> Connect with
the PostgreSQL community through conferences, meetups, and online forums
- <strong>Source Code:</strong> Study the implementation for deep
technical understanding</p>
<p>The PostgreSQL community is vibrant, well-documented, and welcoming
to new contributors and users at all levels. This bibliography serves as
a starting point for deeper exploration of any PostgreSQL topic.</p>
<hr/>
<p><strong>Last Updated:</strong> November 2024 <strong>PostgreSQL
Version:</strong> 17.0 and earlier <strong>Document Status:</strong>
Comprehensive Bibliography for PostgreSQL Encyclopedia</p>
</main>
</div>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>
<script>
  // Mobile TOC toggle
  function toggleTOC() {
    const tocContent = document.getElementById('toc-content');
    tocContent.classList.toggle('active');
  }

  // Close TOC when clicking a link on mobile
  document.querySelectorAll('#TOC a').forEach(link => {
    link.addEventListener('click', () => {
      if (window.innerWidth < 1024) {
        document.getElementById('toc-content').classList.remove('active');
      }
    });
  });

  // Smooth scrolling for anchor links
  document.querySelectorAll('a[href^="#"]').forEach(anchor => {
    anchor.addEventListener('click', function (e) {
      e.preventDefault();
      const target = document.querySelector(this.getAttribute('href'));
      if (target) {
        target.scrollIntoView({
          behavior: 'smooth',
          block: 'start'
        });
      }
    });
  });

  // Search functionality
  let searchIndex = [];
  let fuse = null;

  // Build search index from all headings and paragraphs
  function buildSearchIndex() {
    const content = document.querySelector('.book-content');
    const items = [];

    // Index all headings
    content.querySelectorAll('h1, h2, h3, h4, h5, h6').forEach((heading, idx) => {
      const id = heading.id || `heading-`;
      if (!heading.id) heading.id = id;

      items.push({
        id: id,
        title: heading.textContent,
        content: heading.textContent,
        type: 'heading',
        level: heading.tagName
      });

      // Also index the paragraph after each heading for context
      let next = heading.nextElementSibling;
      if (next && (next.tagName === 'P' || next.tagName === 'DIV')) {
        items.push({
          id: id,
          title: heading.textContent,
          content: next.textContent.substring(0, 200),
          type: 'content',
          level: heading.tagName
        });
      }
    });

    // Index code blocks
    content.querySelectorAll('pre code').forEach((code, idx) => {
      const pre = code.closest('pre');
      const id = pre.id || `code-`;
      if (!pre.id) pre.id = id;

      items.push({
        id: id,
        title: 'Code: ' + code.textContent.substring(0, 50) + '...',
        content: code.textContent,
        type: 'code'
      });
    });

    searchIndex = items;

    // Initialize Fuse.js
    fuse = new Fuse(searchIndex, {
      keys: ['title', 'content'],
      threshold: 0.3,
      includeScore: true,
      minMatchCharLength: 2
    });
  }

  // Perform search
  function performSearch(query) {
    const resultsDiv = document.getElementById('search-results');

    if (!query || query.length < 2) {
      resultsDiv.innerHTML = '';
      resultsDiv.style.display = 'none';
      return;
    }

    const results = fuse.search(query);

    if (results.length === 0) {
      resultsDiv.innerHTML = '<div class="search-no-results">No results found</div>';
      resultsDiv.style.display = 'block';
      return;
    }

    // Display top 10 results
    const html = results.slice(0, 10).map(result => {
      const item = result.item;
      const typeIcon = item.type === 'heading' ? 'üìÑ' : item.type === 'code' ? 'üíª' : 'üìù';
      return '<a href="#' + item.id + '" class="search-result-item" onclick="closeSearchOnMobile()">' +
        '<span class="search-result-icon">' + typeIcon + '</span>' +
        '<span class="search-result-title">' + highlightMatch(item.title, query) + '</span>' +
        '</a>';
    }).join('');

    resultsDiv.innerHTML = html;
    resultsDiv.style.display = 'block';
  }

  // Highlight matching text
  function highlightMatch(text, query) {
    const regex = new RegExp('(' + query + ')', 'gi');
    return text.replace(regex, '<mark>$1</mark>');
  }

  // Close search results on mobile
  function closeSearchOnMobile() {
    if (window.innerWidth < 1024) {
      document.getElementById('search-results').style.display = 'none';
      document.getElementById('search-input').value = '';
      document.getElementById('toc-content').classList.remove('active');
    }
  }

  // Initialize search when page loads
  document.addEventListener('DOMContentLoaded', () => {
    buildSearchIndex();

    const searchInput = document.getElementById('search-input');
    searchInput.addEventListener('input', (e) => {
      performSearch(e.target.value);
    });

    // Close search results when clicking outside
    document.addEventListener('click', (e) => {
      const searchContainer = document.querySelector('.search-container');
      if (!searchContainer.contains(e.target)) {
        document.getElementById('search-results').style.display = 'none';
      }
    });
  });
</script>
</body>
</html>
