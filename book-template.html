<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="$lang$" xml:lang="$lang$"$if(dir)$ dir="$dir$"$endif$>
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
$for(author-meta)$
  <meta name="author" content="$author-meta$" />
$endfor$
$if(date-meta)$
  <meta name="dcterms.date" content="$date-meta$" />
$endif$
$if(keywords)$
  <meta name="keywords" content="$for(keywords)$$keywords$$sep$, $endfor$" />
$endif$
$if(description-meta)$
  <meta name="description" content="$description-meta$" />
$endif$
  <title>$if(title-prefix)$$title-prefix$ ‚Äì $endif$$pagetitle$</title>
$for(css)$
  <link rel="stylesheet" href="$css$" />
$endfor$
$if(math)$
  $math$
$endif$
  <style>
    /* Inline critical CSS for faster loading */
    body { font-family: "Palatino", Georgia, serif; }
    .book-nav {
      background: #2c3e50;
      color: white;
      padding: 0.75rem 1.5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    }
    .book-nav a {
      color: white;
      text-decoration: none;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      transition: background 0.2s;
    }
    .book-nav a:hover { background: rgba(255,255,255,0.1); }
    .book-nav .nav-left { display: flex; gap: 1rem; align-items: center; }
    .book-nav .nav-right { display: flex; gap: 0.5rem; }
    .download-btn {
      background: #3498db;
      padding: 0.4rem 0.8rem;
      border-radius: 4px;
      font-size: 0.875rem;
      font-weight: 600;
    }
    .download-btn:hover { background: #2980b9; }
    .pdf-btn { background: #e74c3c; }
    .pdf-btn:hover { background: #c0392b; }
  </style>
</head>
<body>
<nav class="book-nav">
  <div class="nav-left">
    <a href="../index.html">‚Üê All Books</a>
    <span style="opacity: 0.7;">|</span>
    <span style="font-weight: 600;">$title$</span>
  </div>
  <div class="nav-right">
    <a href="#" class="download-btn" onclick="window.print(); return false;">üñ®Ô∏è Print</a>
$if(pdf-url)$
    <a href="$pdf-url$" class="download-btn pdf-btn">üìÑ Download PDF</a>
$endif$
  </div>
</nav>

<div class="book-container">
  <nav class="toc-sidebar">
    <button class="toc-toggle" onclick="toggleTOC()">üìñ Table of Contents</button>
    <div class="toc-content" id="toc-content">
      <div class="toc-title">$title$</div>
      <div class="search-container">
        <input type="text" id="search-input" placeholder="üîç Search..." class="search-input">
        <div id="search-results" class="search-results"></div>
      </div>
$if(toc)$
<nav id="TOC" role="doc-toc">
$toc$
</nav>
$endif$
    </div>
  </nav>

  <main class="book-content">
    <header class="book-header">
$if(title)$
      <h1 class="book-title">$title$</h1>
$endif$
$if(subtitle)$
      <p class="book-subtitle">$subtitle$</p>
$endif$
    </header>

    <div class="ai-notice">
      <strong>üìù AI-Generated Documentation:</strong> This encyclopedia was entirely created by Claude (Anthropic AI) through comprehensive source code analysis,
      historical research, and community documentation review. Starting from the actual codebase, Claude examined thousands of source files,
      traced git history, and synthesized documentation that explains not just <em>what</em> the code does, but <em>why</em> it exists
      and <em>how</em> it evolved. The result is a deep, systematic exploration compiled with attention to technical accuracy,
      historical context, and educational value.
    </div>

$body$
  </main>
</div>

<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>
<script>
  // Mobile TOC toggle
  function toggleTOC() {
    const tocContent = document.getElementById('toc-content');
    tocContent.classList.toggle('active');
  }

  // Close TOC when clicking a link on mobile
  document.querySelectorAll('#TOC a').forEach(link => {
    link.addEventListener('click', () => {
      if (window.innerWidth < 1024) {
        document.getElementById('toc-content').classList.remove('active');
      }
    });
  });

  // Smooth scrolling for anchor links
  document.querySelectorAll('a[href^="#"]').forEach(anchor => {
    anchor.addEventListener('click', function (e) {
      e.preventDefault();
      const target = document.querySelector(this.getAttribute('href'));
      if (target) {
        target.scrollIntoView({
          behavior: 'smooth',
          block: 'start'
        });
      }
    });
  });

  // Search functionality
  let searchIndex = [];
  let fuse = null;

  // Build search index from all headings and paragraphs
  function buildSearchIndex() {
    const content = document.querySelector('.book-content');
    const items = [];

    // Index all headings
    content.querySelectorAll('h1, h2, h3, h4, h5, h6').forEach((heading, idx) => {
      const id = heading.id || `heading-${idx}`;
      if (!heading.id) heading.id = id;

      items.push({
        id: id,
        title: heading.textContent,
        content: heading.textContent,
        type: 'heading',
        level: heading.tagName
      });

      // Also index the paragraph after each heading for context
      let next = heading.nextElementSibling;
      if (next && (next.tagName === 'P' || next.tagName === 'DIV')) {
        items.push({
          id: id,
          title: heading.textContent,
          content: next.textContent.substring(0, 200),
          type: 'content',
          level: heading.tagName
        });
      }
    });

    // Index code blocks
    content.querySelectorAll('pre code').forEach((code, idx) => {
      const pre = code.closest('pre');
      const id = pre.id || `code-${idx}`;
      if (!pre.id) pre.id = id;

      items.push({
        id: id,
        title: 'Code: ' + code.textContent.substring(0, 50) + '...',
        content: code.textContent,
        type: 'code'
      });
    });

    searchIndex = items;

    // Initialize Fuse.js
    fuse = new Fuse(searchIndex, {
      keys: ['title', 'content'],
      threshold: 0.3,
      includeScore: true,
      minMatchCharLength: 2
    });
  }

  // Perform search
  function performSearch(query) {
    const resultsDiv = document.getElementById('search-results');

    if (!query || query.length < 2) {
      resultsDiv.innerHTML = '';
      resultsDiv.style.display = 'none';
      return;
    }

    const results = fuse.search(query);

    if (results.length === 0) {
      resultsDiv.innerHTML = '<div class="search-no-results">No results found</div>';
      resultsDiv.style.display = 'block';
      return;
    }

    // Display top 10 results
    const html = results.slice(0, 10).map(result => {
      const item = result.item;
      const typeIcon = item.type === 'heading' ? 'üìÑ' : item.type === 'code' ? 'üíª' : 'üìù';
      return '<a href="#' + item.id + '" class="search-result-item" onclick="closeSearchOnMobile()">' +
        '<span class="search-result-icon">' + typeIcon + '</span>' +
        '<span class="search-result-title">' + highlightMatch(item.title, query) + '</span>' +
        '</a>';
    }).join('');

    resultsDiv.innerHTML = html;
    resultsDiv.style.display = 'block';
  }

  // Highlight matching text
  function highlightMatch(text, query) {
    const regex = new RegExp('(' + query + ')', 'gi');
    return text.replace(regex, '<mark>$$1</mark>');
  }

  // Close search results on mobile
  function closeSearchOnMobile() {
    if (window.innerWidth < 1024) {
      document.getElementById('search-results').style.display = 'none';
      document.getElementById('search-input').value = '';
      document.getElementById('toc-content').classList.remove('active');
    }
  }

  // Initialize search when page loads
  document.addEventListener('DOMContentLoaded', () => {
    buildSearchIndex();

    const searchInput = document.getElementById('search-input');
    searchInput.addEventListener('input', (e) => {
      performSearch(e.target.value);
    });

    // Close search results when clicking outside
    document.addEventListener('click', (e) => {
      const searchContainer = document.querySelector('.search-container');
      if (!searchContainer.contains(e.target)) {
        document.getElementById('search-results').style.display = 'none';
      }
    });
  });
</script>

$for(include-after)$
$include-after$
$endfor$
</body>
</html>
