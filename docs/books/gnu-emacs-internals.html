<!DOCTYPE html>

<html lang="" xml:lang="" xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta charset="utf-8"/>
<meta content="pandoc" name="generator"/>
<meta content="width=device-width, initial-scale=1.0, user-scalable=yes" name="viewport"/>
<title>The GNU Emacs Encyclopedic Guide</title>
<link href="../book-style.css" rel="stylesheet"/>
<style>
    /* Inline critical CSS for faster loading */
    body { font-family: "Palatino", Georgia, serif; }
    .book-nav {
      background: #2c3e50;
      color: white;
      padding: 0.75rem 1.5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    }
    .book-nav a {
      color: white;
      text-decoration: none;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      transition: background 0.2s;
    }
    .book-nav a:hover { background: rgba(255,255,255,0.1); }
    .book-nav .nav-left { display: flex; gap: 1rem; align-items: center; }
    .book-nav .nav-right { display: flex; gap: 0.5rem; }
    .download-btn {
      background: #3498db;
      padding: 0.4rem 0.8rem;
      border-radius: 4px;
      font-size: 0.875rem;
      font-weight: 600;
    }
    .download-btn:hover { background: #2980b9; }
    .pdf-btn { background: #e74c3c; }
    .pdf-btn:hover { background: #c0392b; }
  </style>
</head>
<body>
<nav class="book-nav">
<div class="nav-left">
<a href="../index.html">‚Üê All Books</a>
<span style="opacity: 0.7;">|</span>
<span style="font-weight: 600;">The GNU Emacs Encyclopedic
Guide</span>
</div>
<div class="nav-right">
<a class="download-btn" href="#" onclick="window.print(); return false;">üñ®Ô∏è Print</a>
<a class="download-btn pdf-btn" href="gnu-emacs-internals.pdf">üìÑ Download PDF</a>
</div>
</nav>
<div class="book-container">
<nav class="toc-sidebar">
<button class="toc-toggle" onclick="toggleTOC()">üìñ Table of Contents</button>
<div class="toc-content" id="toc-content">
<div class="toc-title">The GNU Emacs Encyclopedic Guide</div>
<div class="search-container">
<input class="search-input" id="search-input" placeholder="üîç Search..." type="text"/>
<div class="search-results" id="search-results"></div>
</div><nav id="TOC"><ul>
<li><details><summary><a href="#ai-generated-documentation-notice" id="toc-ai-generated-documentation-notice"><span class="toc-section-number">1</span> ‚ö†Ô∏è AI-Generated Documentation
Notice</a></summary><ul>
<li><a href="#what-this-means" id="toc-what-this-means"><span class="toc-section-number">1.1</span> What This Means</a></li>
<li><a href="#purpose" id="toc-purpose"><span class="toc-section-number">1.2</span> Purpose</a></li>
</ul></details></li>
<li><details><summary><a href="#chapter-00-introduction" id="toc-chapter-00-introduction"><span class="toc-section-number">2</span> Chapter 00: Introduction</a></summary><ul>
<li><a href="#chapter-overview" id="toc-chapter-overview"><span class="toc-section-number">2.1</span> Chapter Overview</a></li>
<li><a href="#learning-objectives" id="toc-learning-objectives"><span class="toc-section-number">2.2</span> Learning Objectives</a></li>
<li><details><summary><a href="#chapter-structure" id="toc-chapter-structure"><span class="toc-section-number">2.3</span> Chapter Structure</a></summary><ul>
<li><a href="#what-is-emacs.md-8-10-pages" id="toc-what-is-emacs.md-8-10-pages"><span class="toc-section-number">2.3.1</span> 01-what-is-emacs.md (8-10
pages)</a></li>
<li><a href="#architecture-overview.md-10-15-pages" id="toc-architecture-overview.md-10-15-pages"><span class="toc-section-number">2.3.2</span> 02-architecture-overview.md
(10-15 pages)</a></li>
<li><a href="#development-setup.md-8-10-pages" id="toc-development-setup.md-8-10-pages"><span class="toc-section-number">2.3.3</span> 03-development-setup.md (8-10
pages)</a></li>
<li><a href="#navigating-source.md-6-8-pages" id="toc-navigating-source.md-6-8-pages"><span class="toc-section-number">2.3.4</span> 04-navigating-source.md (6-8
pages)</a></li>
<li><a href="#reading-guide.md-4-6-pages" id="toc-reading-guide.md-4-6-pages"><span class="toc-section-number">2.3.5</span> 05-reading-guide.md (4-6
pages)</a></li>
<li><a href="#contributing.md-6-8-pages" id="toc-contributing.md-6-8-pages"><span class="toc-section-number">2.3.6</span> 06-contributing.md (6-8
pages)</a></li>
</ul></details></li>
<li><a href="#key-takeaways" id="toc-key-takeaways"><span class="toc-section-number">2.4</span> Key Takeaways</a></li>
<li><details><summary><a href="#prerequisites" id="toc-prerequisites"><span class="toc-section-number">2.5</span> Prerequisites</a></summary><ul>
<li><a href="#required-knowledge" id="toc-required-knowledge"><span class="toc-section-number">2.5.1</span> Required Knowledge</a></li>
<li><a href="#recommended-background" id="toc-recommended-background"><span class="toc-section-number">2.5.2</span> Recommended Background</a></li>
</ul></details></li>
<li><a href="#cross-references" id="toc-cross-references"><span class="toc-section-number">2.6</span> Cross-References</a></li>
<li><a href="#exercises-optional" id="toc-exercises-optional"><span class="toc-section-number">2.7</span> Exercises (Optional)</a></li>
<li><details><summary><a href="#further-reading" id="toc-further-reading"><span class="toc-section-number">2.8</span> Further Reading</a></summary><ul>
<li><a href="#primary-sources" id="toc-primary-sources"><span class="toc-section-number">2.8.1</span> Primary Sources</a></li>
<li><a href="#historical-context" id="toc-historical-context"><span class="toc-section-number">2.8.2</span> Historical Context</a></li>
<li><a href="#community-resources" id="toc-community-resources"><span class="toc-section-number">2.8.3</span> Community Resources</a></li>
</ul></details></li>
<li><details><summary><a href="#author-notes" id="toc-author-notes"><span class="toc-section-number">2.9</span> Author Notes</a></summary><ul>
<li><a href="#style-guidelines" id="toc-style-guidelines"><span class="toc-section-number">2.9.1</span> Style Guidelines</a></li>
<li><a href="#common-pitfalls-to-address" id="toc-common-pitfalls-to-address"><span class="toc-section-number">2.9.2</span> Common Pitfalls to
Address</a></li>
</ul></details></li>
<li><a href="#status-and-todo" id="toc-status-and-todo"><span class="toc-section-number">2.10</span> Status and Todo</a></li>
<li><a href="#changelog" id="toc-changelog"><span class="toc-section-number">2.11</span> Changelog</a></li>
</ul></details></li>
<li><details><summary><a href="#welcome-to-the-emacs-encyclopedia" id="toc-welcome-to-the-emacs-encyclopedia"><span class="toc-section-number">3</span> Welcome to the Emacs
Encyclopedia</a></summary><ul>
<li><a href="#a-living-monument-to-software-engineering" id="toc-a-living-monument-to-software-engineering"><span class="toc-section-number">3.1</span> A Living Monument to Software
Engineering</a></li>
<li><details><summary><a href="#why-emacs-matters" id="toc-why-emacs-matters"><span class="toc-section-number">3.2</span> Why Emacs Matters</a></summary><ul>
<li><a href="#the-longest-continuously-developed-software-project" id="toc-the-longest-continuously-developed-software-project"><span class="toc-section-number">3.2.1</span> The Longest Continuously
Developed Software Project</a></li>
<li><a href="#a-laboratory-for-programming-language-design" id="toc-a-laboratory-for-programming-language-design"><span class="toc-section-number">3.2.2</span> A Laboratory for Programming
Language Design</a></li>
<li><a href="#cultural-significance-in-the-free-software-movement" id="toc-cultural-significance-in-the-free-software-movement"><span class="toc-section-number">3.2.3</span> Cultural Significance in the
Free Software Movement</a></li>
<li><a href="#influence-on-modern-editors" id="toc-influence-on-modern-editors"><span class="toc-section-number">3.2.4</span> Influence on Modern
Editors</a></li>
</ul></details></li>
<li><details><summary><a href="#emacs-in-computing-history" id="toc-emacs-in-computing-history"><span class="toc-section-number">3.3</span> Emacs in Computing History</a></summary><ul>
<li><a href="#place-in-text-editor-evolution" id="toc-place-in-text-editor-evolution"><span class="toc-section-number">3.3.1</span> Place in Text Editor
Evolution</a></li>
<li><a href="#contributions-to-software-engineering" id="toc-contributions-to-software-engineering"><span class="toc-section-number">3.3.2</span> Contributions to Software
Engineering</a></li>
<li><a href="#innovations-that-came-from-emacs" id="toc-innovations-that-came-from-emacs"><span class="toc-section-number">3.3.3</span> Innovations That Came From
Emacs</a></li>
<li><a href="#academic-and-research-impact" id="toc-academic-and-research-impact"><span class="toc-section-number">3.3.4</span> Academic and Research
Impact</a></li>
</ul></details></li>
<li><details><summary><a href="#the-gnu-connection" id="toc-the-gnu-connection"><span class="toc-section-number">3.4</span> The GNU Connection</a></summary><ul>
<li><a href="#first-major-gnu-project" id="toc-first-major-gnu-project"><span class="toc-section-number">3.4.1</span> First Major GNU Project</a></li>
<li><a href="#role-in-the-free-software-movement" id="toc-role-in-the-free-software-movement"><span class="toc-section-number">3.4.2</span> Role in the Free Software
Movement</a></li>
<li><a href="#copyleft-and-gpl-implications" id="toc-copyleft-and-gpl-implications"><span class="toc-section-number">3.4.3</span> Copyleft and GPL
Implications</a></li>
<li><a href="#community-governance-model" id="toc-community-governance-model"><span class="toc-section-number">3.4.4</span> Community Governance
Model</a></li>
</ul></details></li>
<li><details><summary><a href="#technical-innovations" id="toc-technical-innovations"><span class="toc-section-number">3.5</span> Technical Innovations</a></summary><ul>
<li><a href="#lisp-based-extension-from-day-one" id="toc-lisp-based-extension-from-day-one"><span class="toc-section-number">3.5.1</span> Lisp-Based Extension From Day
One</a></li>
<li><a href="#self-documenting-code" id="toc-self-documenting-code"><span class="toc-section-number">3.5.2</span> Self-Documenting Code</a></li>
<li><a href="#portable-dumper" id="toc-portable-dumper"><span class="toc-section-number">3.5.3</span> Portable Dumper</a></li>
<li><a href="#tree-sitter-integration" id="toc-tree-sitter-integration"><span class="toc-section-number">3.5.4</span> Tree-Sitter Integration</a></li>
<li><a href="#native-compilation" id="toc-native-compilation"><span class="toc-section-number">3.5.5</span> Native Compilation</a></li>
<li><a href="#other-technical-innovations" id="toc-other-technical-innovations"><span class="toc-section-number">3.5.6</span> Other Technical
Innovations</a></li>
</ul></details></li>
<li><details><summary><a href="#lessons-for-modern-software" id="toc-lessons-for-modern-software"><span class="toc-section-number">3.6</span> Lessons for Modern Software</a></summary><ul>
<li><a href="#longevity-and-maintenance" id="toc-longevity-and-maintenance"><span class="toc-section-number">3.6.1</span> Longevity and
Maintenance</a></li>
<li><a href="#api-stability" id="toc-api-stability"><span class="toc-section-number">3.6.2</span> API Stability</a></li>
<li><a href="#community-management" id="toc-community-management"><span class="toc-section-number">3.6.3</span> Community Management</a></li>
<li><a href="#documentation-practices" id="toc-documentation-practices"><span class="toc-section-number">3.6.4</span> Documentation Practices</a></li>
<li><a href="#incremental-modernization" id="toc-incremental-modernization"><span class="toc-section-number">3.6.5</span> Incremental
Modernization</a></li>
<li><a href="#extensibility-as-a-forcing-function" id="toc-extensibility-as-a-forcing-function"><span class="toc-section-number">3.6.6</span> Extensibility as a Forcing
Function</a></li>
<li><a href="#the-value-of-consistency" id="toc-the-value-of-consistency"><span class="toc-section-number">3.6.7</span> The Value of
Consistency</a></li>
</ul></details></li>
<li><details><summary><a href="#the-genesis-from-teco-to-gnu" id="toc-the-genesis-from-teco-to-gnu"><span class="toc-section-number">3.7</span> The Genesis: From TECO to GNU</a></summary><ul>
<li><a href="#the-original-emacs-1976-1984" id="toc-the-original-emacs-1976-1984"><span class="toc-section-number">3.7.1</span> The Original EMACS
(1976-1984)</a></li>
<li><a href="#the-gnu-emacs-project-1984-1985" id="toc-the-gnu-emacs-project-1984-1985"><span class="toc-section-number">3.7.2</span> The GNU Emacs Project
(1984-1985)</a></li>
<li><a href="#four-decades-of-evolution" id="toc-four-decades-of-evolution"><span class="toc-section-number">3.7.3</span> Four Decades of
Evolution</a></li>
</ul></details></li>
<li><details><summary><a href="#what-makes-emacs-unique" id="toc-what-makes-emacs-unique"><span class="toc-section-number">3.8</span> What Makes Emacs Unique</a></summary><ul>
<li><a href="#self-documenting" id="toc-self-documenting"><span class="toc-section-number">3.8.1</span> Self-Documenting</a></li>
<li><a href="#self-extending" id="toc-self-extending"><span class="toc-section-number">3.8.2</span> Self-Extending</a></li>
<li><a href="#a-lisp-machine-for-text" id="toc-a-lisp-machine-for-text"><span class="toc-section-number">3.8.3</span> A Lisp Machine for Text</a></li>
<li><a href="#community-and-culture" id="toc-community-and-culture"><span class="toc-section-number">3.8.4</span> Community and Culture</a></li>
</ul></details></li>
<li><details><summary><a href="#architectural-overview" id="toc-architectural-overview"><span class="toc-section-number">3.9</span> Architectural Overview</a></summary><ul>
<li><a href="#layer-1-the-c-core-562000-lines" id="toc-layer-1-the-c-core-562000-lines"><span class="toc-section-number">3.9.1</span> Layer 1: The C Core (~562,000
lines)</a></li>
<li><a href="#layer-2-the-elisp-foundation-1.56-million-lines" id="toc-layer-2-the-elisp-foundation-1.56-million-lines"><span class="toc-section-number">3.9.2</span> Layer 2: The Elisp Foundation
(~1.56 million lines)</a></li>
<li><a href="#layer-3-the-bytecode-compiler" id="toc-layer-3-the-bytecode-compiler"><span class="toc-section-number">3.9.3</span> Layer 3: The Bytecode
Compiler</a></li>
<li><a href="#layer-4-native-compilation-emacs-28" id="toc-layer-4-native-compilation-emacs-28"><span class="toc-section-number">3.9.4</span> Layer 4: Native Compilation
(Emacs 28+)</a></li>
<li><a href="#why-this-architecture" id="toc-why-this-architecture"><span class="toc-section-number">3.9.5</span> Why This Architecture?</a></li>
</ul></details></li>
<li><details><summary><a href="#evolution-to-modernity" id="toc-evolution-to-modernity"><span class="toc-section-number">3.10</span> Evolution to Modernity</a></summary><ul>
<li><a href="#language-server-protocol-lsp" id="toc-language-server-protocol-lsp"><span class="toc-section-number">3.10.1</span> Language Server Protocol
(LSP)</a></li>
<li><a href="#tree-sitter-integration-1" id="toc-tree-sitter-integration-1"><span class="toc-section-number">3.10.2</span> Tree-sitter
Integration</a></li>
<li><a href="#native-compilation-1" id="toc-native-compilation-1"><span class="toc-section-number">3.10.3</span> Native Compilation</a></li>
<li><a href="#platform-expansion" id="toc-platform-expansion"><span class="toc-section-number">3.10.4</span> Platform Expansion</a></li>
</ul></details></li>
<li><details><summary><a href="#scope-and-purpose-of-this-encyclopedia" id="toc-scope-and-purpose-of-this-encyclopedia"><span class="toc-section-number">3.11</span> Scope and Purpose of This
Encyclopedia</a></summary><ul>
<li><a href="#what-you-will-learn" id="toc-what-you-will-learn"><span class="toc-section-number">3.11.1</span> What You Will Learn</a></li>
<li><a href="#how-to-use-this-guide" id="toc-how-to-use-this-guide"><span class="toc-section-number">3.11.2</span> How to Use This Guide</a></li>
<li><a href="#prerequisites-1" id="toc-prerequisites-1"><span class="toc-section-number">3.11.3</span> Prerequisites</a></li>
<li><a href="#what-this-guide-is-not" id="toc-what-this-guide-is-not"><span class="toc-section-number">3.11.4</span> What This Guide Is Not</a></li>
</ul></details></li>
<li><a href="#the-scale-of-the-system" id="toc-the-scale-of-the-system"><span class="toc-section-number">3.12</span> The Scale of the System</a></li>
<li><details><summary><a href="#who-this-guide-is-for" id="toc-who-this-guide-is-for"><span class="toc-section-number">3.13</span> Who This Guide Is For</a></summary><ul>
<li><a href="#emacs-developers" id="toc-emacs-developers"><span class="toc-section-number">3.13.1</span> Emacs Developers</a></li>
<li><a href="#elisp-package-authors" id="toc-elisp-package-authors"><span class="toc-section-number">3.13.2</span> Elisp Package Authors</a></li>
<li><a href="#computer-science-students" id="toc-computer-science-students"><span class="toc-section-number">3.13.3</span> Computer Science
Students</a></li>
<li><a href="#software-historians" id="toc-software-historians"><span class="toc-section-number">3.13.4</span> Software Historians</a></li>
<li><a href="#curious-programmers" id="toc-curious-programmers"><span class="toc-section-number">3.13.5</span> Curious Programmers</a></li>
<li><a href="#systems-thinkers" id="toc-systems-thinkers"><span class="toc-section-number">3.13.6</span> Systems Thinkers</a></li>
</ul></details></li>
<li><a href="#a-note-on-literate-programming-style" id="toc-a-note-on-literate-programming-style"><span class="toc-section-number">3.14</span> A Note on Literate Programming
Style</a></li>
<li><a href="#the-journey-ahead" id="toc-the-journey-ahead"><span class="toc-section-number">3.15</span> The Journey Ahead</a></li>
<li><a href="#a-living-document" id="toc-a-living-document"><span class="toc-section-number">3.16</span> A Living Document</a></li>
<li><a href="#conclusion-why-study-emacs" id="toc-conclusion-why-study-emacs"><span class="toc-section-number">3.17</span> Conclusion: Why Study
Emacs?</a></li>
</ul></details></li>
<li><details><summary><a href="#chapter-01-architecture" id="toc-chapter-01-architecture"><span class="toc-section-number">4</span> Chapter 01: Architecture</a></summary><ul>
<li><a href="#chapter-overview-1" id="toc-chapter-overview-1"><span class="toc-section-number">4.1</span> Chapter Overview</a></li>
<li><a href="#learning-objectives-1" id="toc-learning-objectives-1"><span class="toc-section-number">4.2</span> Learning Objectives</a></li>
<li><details><summary><a href="#chapter-structure-1" id="toc-chapter-structure-1"><span class="toc-section-number">4.3</span> Chapter Structure</a></summary><ul>
<li><a href="#system-architecture.md-15-20-pages" id="toc-system-architecture.md-15-20-pages"><span class="toc-section-number">4.3.1</span> 01-system-architecture.md (15-20
pages)</a></li>
<li><a href="#c-core-subsystems.md-20-25-pages" id="toc-c-core-subsystems.md-20-25-pages"><span class="toc-section-number">4.3.2</span> 02-c-core-subsystems.md (20-25
pages)</a></li>
<li><a href="#elisp-runtime.md-15-20-pages" id="toc-elisp-runtime.md-15-20-pages"><span class="toc-section-number">4.3.3</span> 03-elisp-runtime.md (15-20
pages)</a></li>
<li><a href="#bootstrap.md-12-15-pages" id="toc-bootstrap.md-12-15-pages"><span class="toc-section-number">4.3.4</span> 04-bootstrap.md (12-15
pages)</a></li>
<li><a href="#module-system.md-10-12-pages" id="toc-module-system.md-10-12-pages"><span class="toc-section-number">4.3.5</span> 05-module-system.md (10-12
pages)</a></li>
<li><a href="#threading.md-8-10-pages" id="toc-threading.md-8-10-pages"><span class="toc-section-number">4.3.6</span> 06-threading.md (8-10
pages)</a></li>
</ul></details></li>
<li><a href="#key-takeaways-1" id="toc-key-takeaways-1"><span class="toc-section-number">4.4</span> Key Takeaways</a></li>
<li><details><summary><a href="#prerequisites-2" id="toc-prerequisites-2"><span class="toc-section-number">4.5</span> Prerequisites</a></summary><ul>
<li><a href="#required-knowledge-1" id="toc-required-knowledge-1"><span class="toc-section-number">4.5.1</span> Required Knowledge</a></li>
<li><a href="#recommended-background-1" id="toc-recommended-background-1"><span class="toc-section-number">4.5.2</span> Recommended Background</a></li>
</ul></details></li>
<li><details><summary><a href="#cross-references-1" id="toc-cross-references-1"><span class="toc-section-number">4.6</span> Cross-References</a></summary><ul>
<li><a href="#this-chapter-references" id="toc-this-chapter-references"><span class="toc-section-number">4.6.1</span> This Chapter References</a></li>
<li><a href="#referenced-by" id="toc-referenced-by"><span class="toc-section-number">4.6.2</span> Referenced By</a></li>
</ul></details></li>
<li><details><summary><a href="#key-files-reference" id="toc-key-files-reference"><span class="toc-section-number">4.7</span> Key Files Reference</a></summary><ul>
<li><a href="#c-core-files" id="toc-c-core-files"><span class="toc-section-number">4.7.1</span> C Core Files</a></li>
<li><a href="#lisp-files" id="toc-lisp-files"><span class="toc-section-number">4.7.2</span> Lisp Files</a></li>
</ul></details></li>
<li><a href="#exercises" id="toc-exercises"><span class="toc-section-number">4.8</span> Exercises</a></li>
<li><details><summary><a href="#further-reading-1" id="toc-further-reading-1"><span class="toc-section-number">4.9</span> Further Reading</a></summary><ul>
<li><a href="#papers" id="toc-papers"><span class="toc-section-number">4.9.1</span> Papers</a></li>
<li><a href="#manuals" id="toc-manuals"><span class="toc-section-number">4.9.2</span> Manuals</a></li>
<li><a href="#source-code" id="toc-source-code"><span class="toc-section-number">4.9.3</span> Source Code</a></li>
</ul></details></li>
<li><details><summary><a href="#development-tips" id="toc-development-tips"><span class="toc-section-number">4.10</span> Development Tips</a></summary><ul>
<li><a href="#debugging-architecture" id="toc-debugging-architecture"><span class="toc-section-number">4.10.1</span> Debugging Architecture</a></li>
<li><a href="#exploring-components" id="toc-exploring-components"><span class="toc-section-number">4.10.2</span> Exploring Components</a></li>
</ul></details></li>
<li><a href="#status-and-todo-1" id="toc-status-and-todo-1"><span class="toc-section-number">4.11</span> Status and Todo</a></li>
<li><a href="#changelog-1" id="toc-changelog-1"><span class="toc-section-number">4.12</span> Changelog</a></li>
</ul></details></li>
<li><details><summary><a href="#design-philosophy-and-principles" id="toc-design-philosophy-and-principles"><span class="toc-section-number">5</span> Design Philosophy and Principles</a></summary><ul>
<li><a href="#overview" id="toc-overview"><span class="toc-section-number">5.1</span> Overview</a></li>
<li><details><summary><a href="#self-documentation-principle" id="toc-self-documentation-principle"><span class="toc-section-number">5.2</span> 1. Self-Documentation
Principle</a></summary><ul>
<li><a href="#the-philosophy" id="toc-the-philosophy"><span class="toc-section-number">5.2.1</span> The Philosophy</a></li>
<li><a href="#how-it-manifests-in-code" id="toc-how-it-manifests-in-code"><span class="toc-section-number">5.2.2</span> How It Manifests in
Code</a></li>
<li><a href="#why-this-matters" id="toc-why-this-matters"><span class="toc-section-number">5.2.3</span> Why This Matters</a></li>
<li><a href="#the-cost" id="toc-the-cost"><span class="toc-section-number">5.2.4</span> The Cost</a></li>
</ul></details></li>
<li><details><summary><a href="#extensibility-philosophy" id="toc-extensibility-philosophy"><span class="toc-section-number">5.3</span> 2. Extensibility Philosophy</a></summary><ul>
<li><a href="#the-philosophy-1" id="toc-the-philosophy-1"><span class="toc-section-number">5.3.1</span> The Philosophy</a></li>
<li><a href="#the-core-architecture" id="toc-the-core-architecture"><span class="toc-section-number">5.3.2</span> The Core Architecture</a></li>
<li><a href="#runtime-redefinition" id="toc-runtime-redefinition"><span class="toc-section-number">5.3.3</span> Runtime Redefinition</a></li>
<li><a href="#hooks-everywhere" id="toc-hooks-everywhere"><span class="toc-section-number">5.3.4</span> Hooks Everywhere</a></li>
<li><a href="#no-hard-coded-limits" id="toc-no-hard-coded-limits"><span class="toc-section-number">5.3.5</span> No Hard-Coded Limits</a></li>
<li><a href="#user-code-core-code" id="toc-user-code-core-code"><span class="toc-section-number">5.3.6</span> User Code = Core Code</a></li>
<li><a href="#why-this-matters-1" id="toc-why-this-matters-1"><span class="toc-section-number">5.3.7</span> Why This Matters</a></li>
<li><a href="#the-cost-1" id="toc-the-cost-1"><span class="toc-section-number">5.3.8</span> The Cost</a></li>
</ul></details></li>
<li><details><summary><a href="#backwards-compatibility" id="toc-backwards-compatibility"><span class="toc-section-number">5.4</span> 3. Backwards Compatibility</a></summary><ul>
<li><a href="#the-philosophy-2" id="toc-the-philosophy-2"><span class="toc-section-number">5.4.1</span> The Philosophy</a></li>
<li><a href="#deprecation-strategies" id="toc-deprecation-strategies"><span class="toc-section-number">5.4.2</span> Deprecation Strategies</a></li>
<li><a href="#how-new-features-are-added-without-breaking-old" id="toc-how-new-features-are-added-without-breaking-old"><span class="toc-section-number">5.4.3</span> How New Features Are Added
Without Breaking Old</a></li>
<li><a href="#feature-detection-and-graceful-degradation" id="toc-feature-detection-and-graceful-degradation"><span class="toc-section-number">5.4.4</span> Feature Detection and Graceful
Degradation</a></li>
<li><a href="#the-cost-of-compatibility" id="toc-the-cost-of-compatibility"><span class="toc-section-number">5.4.5</span> The Cost of
Compatibility</a></li>
<li><a href="#subr-compatibility" id="toc-subr-compatibility"><span class="toc-section-number">5.4.6</span> Subr Compatibility</a></li>
<li><a href="#why-this-matters-2" id="toc-why-this-matters-2"><span class="toc-section-number">5.4.7</span> Why This Matters</a></li>
<li><a href="#the-trade-offs" id="toc-the-trade-offs"><span class="toc-section-number">5.4.8</span> The Trade-offs</a></li>
</ul></details></li>
<li><details><summary><a href="#lisp-centric-design" id="toc-lisp-centric-design"><span class="toc-section-number">5.5</span> 4. Lisp-Centric Design</a></summary><ul>
<li><a href="#the-philosophy-3" id="toc-the-philosophy-3"><span class="toc-section-number">5.5.1</span> The Philosophy</a></li>
<li><a href="#the-division-of-labor" id="toc-the-division-of-labor"><span class="toc-section-number">5.5.2</span> The Division of Labor</a></li>
<li><a href="#why-lisp-for-extensibility" id="toc-why-lisp-for-extensibility"><span class="toc-section-number">5.5.3</span> Why Lisp for
Extensibility</a></li>
<li><a href="#the-lisp-2-namespace-decision" id="toc-the-lisp-2-namespace-decision"><span class="toc-section-number">5.5.4</span> The Lisp-2 Namespace
Decision</a></li>
<li><a href="#dynamic-vs-lexical-binding-evolution" id="toc-dynamic-vs-lexical-binding-evolution"><span class="toc-section-number">5.5.5</span> Dynamic vs Lexical Binding
Evolution</a></li>
<li><a href="#the-c-elisp-boundary" id="toc-the-c-elisp-boundary"><span class="toc-section-number">5.5.6</span> The C-Elisp Boundary</a></li>
<li><a href="#why-this-matters-3" id="toc-why-this-matters-3"><span class="toc-section-number">5.5.7</span> Why This Matters</a></li>
<li><a href="#the-trade-offs-1" id="toc-the-trade-offs-1"><span class="toc-section-number">5.5.8</span> The Trade-offs</a></li>
</ul></details></li>
<li><details><summary><a href="#modularity-and-abstraction" id="toc-modularity-and-abstraction"><span class="toc-section-number">5.6</span> 5. Modularity and Abstraction</a></summary><ul>
<li><a href="#the-philosophy-4" id="toc-the-philosophy-4"><span class="toc-section-number">5.6.1</span> The Philosophy</a></li>
<li><a href="#bufferwindowframe-separation" id="toc-bufferwindowframe-separation"><span class="toc-section-number">5.6.2</span> Buffer/Window/Frame
Separation</a></li>
<li><a href="#backend-abstraction" id="toc-backend-abstraction"><span class="toc-section-number">5.6.3</span> Backend Abstraction</a></li>
<li><a href="#terminal-abstraction" id="toc-terminal-abstraction"><span class="toc-section-number">5.6.4</span> Terminal Abstraction</a></li>
<li><a href="#mode-system" id="toc-mode-system"><span class="toc-section-number">5.6.5</span> Mode System</a></li>
<li><a href="#package-system" id="toc-package-system"><span class="toc-section-number">5.6.6</span> Package System</a></li>
<li><a href="#why-this-matters-4" id="toc-why-this-matters-4"><span class="toc-section-number">5.6.7</span> Why This Matters</a></li>
<li><a href="#the-cost-2" id="toc-the-cost-2"><span class="toc-section-number">5.6.8</span> The Cost</a></li>
</ul></details></li>
<li><details><summary><a href="#progressive-enhancement" id="toc-progressive-enhancement"><span class="toc-section-number">5.7</span> 6. Progressive Enhancement</a></summary><ul>
<li><a href="#the-philosophy-5" id="toc-the-philosophy-5"><span class="toc-section-number">5.7.1</span> The Philosophy</a></li>
<li><a href="#feature-detection" id="toc-feature-detection"><span class="toc-section-number">5.7.2</span> Feature Detection</a></li>
<li><a href="#graceful-degradation-in-display" id="toc-graceful-degradation-in-display"><span class="toc-section-number">5.7.3</span> Graceful Degradation in
Display</a></li>
<li><a href="#platform-differences" id="toc-platform-differences"><span class="toc-section-number">5.7.4</span> Platform Differences</a></li>
<li><a href="#optional-dependencies" id="toc-optional-dependencies"><span class="toc-section-number">5.7.5</span> Optional Dependencies</a></li>
<li><a href="#runtime-feature-checks" id="toc-runtime-feature-checks"><span class="toc-section-number">5.7.6</span> Runtime Feature Checks</a></li>
<li><a href="#capability-based-enhancement" id="toc-capability-based-enhancement"><span class="toc-section-number">5.7.7</span> Capability-Based
Enhancement</a></li>
<li><a href="#why-this-matters-5" id="toc-why-this-matters-5"><span class="toc-section-number">5.7.8</span> Why This Matters</a></li>
<li><a href="#the-cost-3" id="toc-the-cost-3"><span class="toc-section-number">5.7.9</span> The Cost</a></li>
</ul></details></li>
<li><details><summary><a href="#performance-vs-flexibility" id="toc-performance-vs-flexibility"><span class="toc-section-number">5.8</span> 7. Performance vs Flexibility</a></summary><ul>
<li><a href="#the-philosophy-6" id="toc-the-philosophy-6"><span class="toc-section-number">5.8.1</span> The Philosophy</a></li>
<li><a href="#when-to-optimize" id="toc-when-to-optimize"><span class="toc-section-number">5.8.2</span> When to Optimize</a></li>
<li><a href="#bytecode-compilation" id="toc-bytecode-compilation"><span class="toc-section-number">5.8.3</span> Bytecode Compilation</a></li>
<li><a href="#native-compilation-2" id="toc-native-compilation-2"><span class="toc-section-number">5.8.4</span> Native Compilation</a></li>
<li><a href="#lazy-loading" id="toc-lazy-loading"><span class="toc-section-number">5.8.5</span> Lazy Loading</a></li>
<li><a href="#caching-strategies" id="toc-caching-strategies"><span class="toc-section-number">5.8.6</span> Caching Strategies</a></li>
<li><a href="#optimization-example-list-deletion" id="toc-optimization-example-list-deletion"><span class="toc-section-number">5.8.7</span> Optimization Example: List
Deletion</a></li>
<li><a href="#memory-management-tuning" id="toc-memory-management-tuning"><span class="toc-section-number">5.8.8</span> Memory Management
Tuning</a></li>
<li><a href="#why-this-matters-6" id="toc-why-this-matters-6"><span class="toc-section-number">5.8.9</span> Why This Matters</a></li>
<li><a href="#the-cost-4" id="toc-the-cost-4"><span class="toc-section-number">5.8.10</span> The Cost</a></li>
</ul></details></li>
<li><details><summary><a href="#documentation-as-code" id="toc-documentation-as-code"><span class="toc-section-number">5.9</span> 8. Documentation as Code</a></summary><ul>
<li><a href="#the-philosophy-7" id="toc-the-philosophy-7"><span class="toc-section-number">5.9.1</span> The Philosophy</a></li>
<li><a href="#texinfo-integration" id="toc-texinfo-integration"><span class="toc-section-number">5.9.2</span> Texinfo Integration</a></li>
<li><a href="#inline-documentation" id="toc-inline-documentation"><span class="toc-section-number">5.9.3</span> Inline Documentation</a></li>
<li><a href="#examples-in-documentation" id="toc-examples-in-documentation"><span class="toc-section-number">5.9.4</span> Examples in
Documentation</a></li>
<li><a href="#cross-references-2" id="toc-cross-references-2"><span class="toc-section-number">5.9.5</span> Cross-References</a></li>
<li><a href="#self-documenting-help-system" id="toc-self-documenting-help-system"><span class="toc-section-number">5.9.6</span> Self-Documenting Help
System</a></li>
<li><a href="#documentation-in-c-code" id="toc-documentation-in-c-code"><span class="toc-section-number">5.9.7</span> Documentation in C Code</a></li>
<li><a href="#generated-documentation" id="toc-generated-documentation"><span class="toc-section-number">5.9.8</span> Generated Documentation</a></li>
<li><a href="#why-this-matters-7" id="toc-why-this-matters-7"><span class="toc-section-number">5.9.9</span> Why This Matters</a></li>
<li><a href="#the-cost-5" id="toc-the-cost-5"><span class="toc-section-number">5.9.10</span> The Cost</a></li>
</ul></details></li>
<li><details><summary><a href="#synthesis-how-principles-interact" id="toc-synthesis-how-principles-interact"><span class="toc-section-number">5.10</span> Synthesis: How Principles
Interact</a></summary><ul>
<li><a href="#self-documentation-extensibility" id="toc-self-documentation-extensibility"><span class="toc-section-number">5.10.1</span> Self-Documentation +
Extensibility</a></li>
<li><a href="#backwards-compatibility-lisp-centric" id="toc-backwards-compatibility-lisp-centric"><span class="toc-section-number">5.10.2</span> Backwards Compatibility +
Lisp-Centric</a></li>
<li><a href="#modularity-progressive-enhancement" id="toc-modularity-progressive-enhancement"><span class="toc-section-number">5.10.3</span> Modularity + Progressive
Enhancement</a></li>
<li><a href="#performance-flexibility" id="toc-performance-flexibility"><span class="toc-section-number">5.10.4</span> Performance +
Flexibility</a></li>
<li><a href="#documentation-self-documentation" id="toc-documentation-self-documentation"><span class="toc-section-number">5.10.5</span> Documentation +
Self-Documentation</a></li>
</ul></details></li>
<li><a href="#conclusion-principles-of-longevity" id="toc-conclusion-principles-of-longevity"><span class="toc-section-number">5.11</span> Conclusion: Principles of
Longevity</a></li>
<li><details><summary><a href="#further-reading-2" id="toc-further-reading-2"><span class="toc-section-number">5.12</span> Further Reading</a></summary><ul>
<li><a href="#source-files-referenced" id="toc-source-files-referenced"><span class="toc-section-number">5.12.1</span> Source Files
Referenced</a></li>
<li><a href="#related-chapters" id="toc-related-chapters"><span class="toc-section-number">5.12.2</span> Related Chapters</a></li>
<li><a href="#external-resources" id="toc-external-resources"><span class="toc-section-number">5.12.3</span> External Resources</a></li>
</ul></details></li>
</ul></details></li>
<li><details><summary><a href="#buffer-management-subsystem" id="toc-buffer-management-subsystem"><span class="toc-section-number">6</span> Buffer Management Subsystem</a></summary><ul>
<li><a href="#table-of-contents" id="toc-table-of-contents"><span class="toc-section-number">6.1</span> Table of Contents</a></li>
<li><details><summary><a href="#introduction" id="toc-introduction"><span class="toc-section-number">6.2</span> Introduction</a></summary><ul>
<li><a href="#core-responsibilities" id="toc-core-responsibilities"><span class="toc-section-number">6.2.1</span> Core Responsibilities</a></li>
<li><a href="#key-design-principles" id="toc-key-design-principles"><span class="toc-section-number">6.2.2</span> Key Design Principles</a></li>
</ul></details></li>
<li><details><summary><a href="#the-gap-buffer-core-data-structure" id="toc-the-gap-buffer-core-data-structure"><span class="toc-section-number">6.3</span> The Gap Buffer: Core Data
Structure</a></summary><ul>
<li><a href="#concept" id="toc-concept"><span class="toc-section-number">6.3.1</span> Concept</a></li>
<li><a href="#visual-representation" id="toc-visual-representation"><span class="toc-section-number">6.3.2</span> Visual Representation</a></li>
<li><a href="#implementation-details" id="toc-implementation-details"><span class="toc-section-number">6.3.3</span> Implementation Details</a></li>
<li><a href="#critical-macros-srcbuffer.h38-94" id="toc-critical-macros-srcbuffer.h38-94"><span class="toc-section-number">6.3.4</span> Critical Macros
(src/buffer.h:38-94)</a></li>
<li><a href="#address-calculation" id="toc-address-calculation"><span class="toc-section-number">6.3.5</span> Address Calculation</a></li>
<li><a href="#gap-movement" id="toc-gap-movement"><span class="toc-section-number">6.3.6</span> Gap Movement</a></li>
</ul></details></li>
<li><details><summary><a href="#buffer-structure-and-organization" id="toc-buffer-structure-and-organization"><span class="toc-section-number">6.4</span> Buffer Structure and
Organization</a></summary><ul>
<li><a href="#the-struct-buffer-srcbuffer.h319-743" id="toc-the-struct-buffer-srcbuffer.h319-743"><span class="toc-section-number">6.4.1</span> The <code>struct buffer</code>
(src/buffer.h:319-743)</a></li>
<li><a href="#buffer-allocation-srcbuffer.c595-682" id="toc-buffer-allocation-srcbuffer.c595-682"><span class="toc-section-number">6.4.2</span> Buffer Allocation
(src/buffer.c:595-682)</a></li>
<li><a href="#narrowing-and-accessible-region" id="toc-narrowing-and-accessible-region"><span class="toc-section-number">6.4.3</span> Narrowing and Accessible
Region</a></li>
</ul></details></li>
<li><details><summary><a href="#text-insertion-and-deletion" id="toc-text-insertion-and-deletion"><span class="toc-section-number">6.5</span> Text Insertion and Deletion</a></summary><ul>
<li><a href="#core-insertion-function" id="toc-core-insertion-function"><span class="toc-section-number">6.5.1</span> Core Insertion Function</a></li>
<li><a href="#making-the-gap-larger-srcinsdel.c467-512" id="toc-making-the-gap-larger-srcinsdel.c467-512"><span class="toc-section-number">6.5.2</span> Making the Gap Larger
(src/insdel.c:467-512)</a></li>
<li><a href="#deletion" id="toc-deletion"><span class="toc-section-number">6.5.3</span> Deletion</a></li>
<li><a href="#character-vs.-byte-positions" id="toc-character-vs.-byte-positions"><span class="toc-section-number">6.5.4</span> Character vs.¬†Byte
Positions</a></li>
</ul></details></li>
<li><details><summary><a href="#the-marker-system" id="toc-the-marker-system"><span class="toc-section-number">6.6</span> The Marker System</a></summary><ul>
<li><a href="#what-are-markers" id="toc-what-are-markers"><span class="toc-section-number">6.6.1</span> What Are Markers?</a></li>
<li><a href="#marker-structure-srclisp.h-referenced-in-srcbuffer.h288-295" id="toc-marker-structure-srclisp.h-referenced-in-srcbuffer.h288-295"><span class="toc-section-number">6.6.2</span> Marker Structure (src/lisp.h,
referenced in src/buffer.h:288-295)</a></li>
<li><a href="#marker-adjustment" id="toc-marker-adjustment"><span class="toc-section-number">6.6.3</span> Marker Adjustment</a></li>
<li><a href="#position-caching-with-markers" id="toc-position-caching-with-markers"><span class="toc-section-number">6.6.4</span> Position Caching with
Markers</a></li>
</ul></details></li>
<li><details><summary><a href="#text-properties-and-intervals" id="toc-text-properties-and-intervals"><span class="toc-section-number">6.7</span> Text Properties and Intervals</a></summary><ul>
<li><a href="#concept-1" id="toc-concept-1"><span class="toc-section-number">6.7.1</span> Concept</a></li>
<li><a href="#the-interval-tree-data-structure" id="toc-the-interval-tree-data-structure"><span class="toc-section-number">6.7.2</span> The Interval Tree Data
Structure</a></li>
<li><a href="#key-invariants-srcintervals.h99-119" id="toc-key-invariants-srcintervals.h99-119"><span class="toc-section-number">6.7.3</span> Key Invariants
(src/intervals.h:99-119)</a></li>
<li><a href="#interval-operations" id="toc-interval-operations"><span class="toc-section-number">6.7.4</span> Interval Operations</a></li>
<li><a href="#property-inheritance-and-stickiness" id="toc-property-inheritance-and-stickiness"><span class="toc-section-number">6.7.5</span> Property Inheritance and
Stickiness</a></li>
</ul></details></li>
<li><details><summary><a href="#buffer-local-variables" id="toc-buffer-local-variables"><span class="toc-section-number">6.8</span> Buffer-Local Variables</a></summary><ul>
<li><a href="#concept-2" id="toc-concept-2"><span class="toc-section-number">6.8.1</span> Concept</a></li>
<li><a href="#implementation-strategy" id="toc-implementation-strategy"><span class="toc-section-number">6.8.2</span> Implementation Strategy</a></li>
<li><a href="#built-in-per-buffer-variables-srcbuffer.h310-643" id="toc-built-in-per-buffer-variables-srcbuffer.h310-643"><span class="toc-section-number">6.8.3</span> Built-in Per-Buffer Variables
(src/buffer.h:310-643)</a></li>
<li><a href="#the-per-buffer-index-system" id="toc-the-per-buffer-index-system"><span class="toc-section-number">6.8.4</span> The Per-Buffer Index
System</a></li>
<li><a href="#lisp-level-buffer-local-variables-srcbuffer.h362" id="toc-lisp-level-buffer-local-variables-srcbuffer.h362"><span class="toc-section-number">6.8.5</span> Lisp-Level Buffer-Local
Variables (src/buffer.h:362)</a></li>
<li><a href="#default-values-srcbuffer.c70" id="toc-default-values-srcbuffer.c70"><span class="toc-section-number">6.8.6</span> Default Values
(src/buffer.c:70)</a></li>
</ul></details></li>
<li><details><summary><a href="#buffers-and-windows" id="toc-buffers-and-windows"><span class="toc-section-number">6.9</span> Buffers and Windows</a></summary><ul>
<li><a href="#conceptual-relationship" id="toc-conceptual-relationship"><span class="toc-section-number">6.9.1</span> Conceptual Relationship</a></li>
<li><a href="#tracking-window-display-srcbuffer.h634-636" id="toc-tracking-window-display-srcbuffer.h634-636"><span class="toc-section-number">6.9.2</span> Tracking Window Display
(src/buffer.h:634-636)</a></li>
<li><a href="#point-in-non-current-buffers" id="toc-point-in-non-current-buffers"><span class="toc-section-number">6.9.3</span> Point in Non-Current
Buffers</a></li>
<li><a href="#indirect-buffers-srcbuffer.h599-632" id="toc-indirect-buffers-srcbuffer.h599-632"><span class="toc-section-number">6.9.4</span> Indirect Buffers
(src/buffer.h:599-632)</a></li>
</ul></details></li>
<li><details><summary><a href="#the-elisp-layer" id="toc-the-elisp-layer"><span class="toc-section-number">6.10</span> The Elisp Layer</a></summary><ul>
<li><a href="#buffer-menu-lispbuff-menu.el" id="toc-buffer-menu-lispbuff-menu.el"><span class="toc-section-number">6.10.1</span> Buffer Menu
(lisp/buff-menu.el)</a></li>
<li><a href="#ibuffer-lispibuffer.el" id="toc-ibuffer-lispibuffer.el"><span class="toc-section-number">6.10.2</span> IBuffer
(lisp/ibuffer.el)</a></li>
<li><a href="#basic-editing-commands-lispsimple.el" id="toc-basic-editing-commands-lispsimple.el"><span class="toc-section-number">6.10.3</span> Basic Editing Commands
(lisp/simple.el)</a></li>
</ul></details></li>
<li><details><summary><a href="#design-rationale" id="toc-design-rationale"><span class="toc-section-number">6.11</span> Design Rationale</a></summary><ul>
<li><a href="#why-the-gap-buffer" id="toc-why-the-gap-buffer"><span class="toc-section-number">6.11.1</span> Why the Gap Buffer?</a></li>
<li><a href="#why-separate-character-and-byte-positions" id="toc-why-separate-character-and-byte-positions"><span class="toc-section-number">6.11.2</span> Why Separate Character and Byte
Positions?</a></li>
<li><a href="#why-intervals-instead-of-simpler-property-storage" id="toc-why-intervals-instead-of-simpler-property-storage"><span class="toc-section-number">6.11.3</span> Why Intervals Instead of
Simpler Property Storage?</a></li>
<li><a href="#why-buffer-local-variables" id="toc-why-buffer-local-variables"><span class="toc-section-number">6.11.4</span> Why Buffer-Local
Variables?</a></li>
</ul></details></li>
<li><details><summary><a href="#summary-key-insights" id="toc-summary-key-insights"><span class="toc-section-number">6.12</span> Summary: Key Insights</a></summary><ul>
<li><a href="#data-structure-hierarchy" id="toc-data-structure-hierarchy"><span class="toc-section-number">6.12.1</span> Data Structure
Hierarchy</a></li>
<li><a href="#critical-invariants" id="toc-critical-invariants"><span class="toc-section-number">6.12.2</span> Critical Invariants</a></li>
<li><a href="#performance-characteristics" id="toc-performance-characteristics"><span class="toc-section-number">6.12.3</span> Performance
Characteristics</a></li>
<li><a href="#code-organization" id="toc-code-organization"><span class="toc-section-number">6.12.4</span> Code Organization</a></li>
</ul></details></li>
<li><a href="#further-reading-3" id="toc-further-reading-3"><span class="toc-section-number">6.13</span> Further Reading</a></li>
</ul></details></li>
<li><details><summary><a href="#the-emacs-display-engine-a-literate-programming-guide" id="toc-the-emacs-display-engine-a-literate-programming-guide"><span class="toc-section-number">7</span> The Emacs Display Engine: A Literate
Programming Guide</a></summary><ul>
<li><a href="#table-of-contents-1" id="toc-table-of-contents-1"><span class="toc-section-number">7.1</span> Table of Contents</a></li>
<li><details><summary><a href="#introduction-1" id="toc-introduction-1"><span class="toc-section-number">7.2</span> Introduction</a></summary><ul>
<li><a href="#core-principles" id="toc-core-principles"><span class="toc-section-number">7.2.1</span> Core Principles</a></li>
<li><a href="#source-files" id="toc-source-files"><span class="toc-section-number">7.2.2</span> Source Files</a></li>
</ul></details></li>
<li><details><summary><a href="#architecture-overview" id="toc-architecture-overview"><span class="toc-section-number">7.3</span> Architecture Overview</a></summary><ul>
<li><a href="#the-display-pipeline" id="toc-the-display-pipeline"><span class="toc-section-number">7.3.1</span> The Display Pipeline</a></li>
<li><a href="#asynchronous-redisplay-triggers" id="toc-asynchronous-redisplay-triggers"><span class="toc-section-number">7.3.2</span> Asynchronous Redisplay
Triggers</a></li>
</ul></details></li>
<li><details><summary><a href="#the-redisplay-cycle" id="toc-the-redisplay-cycle"><span class="toc-section-number">7.4</span> The Redisplay Cycle</a></summary><ul>
<li><a href="#entry-point-redisplay_internal" id="toc-entry-point-redisplay_internal"><span class="toc-section-number">7.4.1</span> Entry Point:
<code>redisplay_internal()</code></a></li>
<li><a href="#the-retry-loop" id="toc-the-retry-loop"><span class="toc-section-number">7.4.2</span> The Retry Loop</a></li>
<li><a href="#frame-visibility-and-matrix-adjustment" id="toc-frame-visibility-and-matrix-adjustment"><span class="toc-section-number">7.4.3</span> Frame Visibility and Matrix
Adjustment</a></li>
</ul></details></li>
<li><details><summary><a href="#glyph-matrices-the-heart-of-display" id="toc-glyph-matrices-the-heart-of-display"><span class="toc-section-number">7.5</span> Glyph Matrices: The Heart of
Display</a></summary><ul>
<li><a href="#understanding-glyph-matrices" id="toc-understanding-glyph-matrices"><span class="toc-section-number">7.5.1</span> Understanding Glyph
Matrices</a></li>
<li><a href="#current-vs-desired-matrices" id="toc-current-vs-desired-matrices"><span class="toc-section-number">7.5.2</span> Current vs Desired
Matrices</a></li>
<li><a href="#glyph-row-structure" id="toc-glyph-row-structure"><span class="toc-section-number">7.5.3</span> Glyph Row Structure</a></li>
<li><a href="#the-glyph-structure" id="toc-the-glyph-structure"><span class="toc-section-number">7.5.4</span> The Glyph Structure</a></li>
<li><a href="#frame-matrices-text-mode-terminal-optimization" id="toc-frame-matrices-text-mode-terminal-optimization"><span class="toc-section-number">7.5.5</span> Frame Matrices: Text-Mode
Terminal Optimization</a></li>
</ul></details></li>
<li><details><summary><a href="#the-display-iterator" id="toc-the-display-iterator"><span class="toc-section-number">7.6</span> The Display Iterator</a></summary><ul>
<li><a href="#purpose-and-design" id="toc-purpose-and-design"><span class="toc-section-number">7.6.1</span> Purpose and Design</a></li>
<li><a href="#iterator-structure" id="toc-iterator-structure"><span class="toc-section-number">7.6.2</span> Iterator Structure</a></li>
<li><a href="#the-stop-position-mechanism" id="toc-the-stop-position-mechanism"><span class="toc-section-number">7.6.3</span> The Stop Position
Mechanism</a></li>
<li><a href="#iterator-state-stack" id="toc-iterator-state-stack"><span class="toc-section-number">7.6.4</span> Iterator State Stack</a></li>
</ul></details></li>
<li><details><summary><a href="#face-management-and-realization" id="toc-face-management-and-realization"><span class="toc-section-number">7.7</span> Face Management and
Realization</a></summary><ul>
<li><a href="#the-face-system-architecture" id="toc-the-face-system-architecture"><span class="toc-section-number">7.7.1</span> The Face System
Architecture</a></li>
<li><a href="#face-realization-process" id="toc-face-realization-process"><span class="toc-section-number">7.7.2</span> Face Realization
Process</a></li>
<li><a href="#font-selection" id="toc-font-selection"><span class="toc-section-number">7.7.3</span> Font Selection</a></li>
</ul></details></li>
<li><details><summary><a href="#bidirectional-text-rendering" id="toc-bidirectional-text-rendering"><span class="toc-section-number">7.8</span> Bidirectional Text Rendering</a></summary><ul>
<li><a href="#the-bidi-challenge" id="toc-the-bidi-challenge"><span class="toc-section-number">7.8.1</span> The Bidi Challenge</a></li>
<li><a href="#bidi-architecture" id="toc-bidi-architecture"><span class="toc-section-number">7.8.2</span> Bidi Architecture</a></li>
<li><a href="#bidi-processing-hierarchy" id="toc-bidi-processing-hierarchy"><span class="toc-section-number">7.8.3</span> Bidi Processing
Hierarchy</a></li>
<li><a href="#integration-with-display-iterator" id="toc-integration-with-display-iterator"><span class="toc-section-number">7.8.4</span> Integration with Display
Iterator</a></li>
</ul></details></li>
<li><details><summary><a href="#line-wrapping-and-truncation" id="toc-line-wrapping-and-truncation"><span class="toc-section-number">7.9</span> Line Wrapping and Truncation</a></summary><ul>
<li><a href="#wrapping-modes" id="toc-wrapping-modes"><span class="toc-section-number">7.9.1</span> Wrapping Modes</a></li>
<li><a href="#the-display_line-function" id="toc-the-display_line-function"><span class="toc-section-number">7.9.2</span> The <code>display_line()</code>
Function</a></li>
<li><a href="#word-wrapping-algorithm" id="toc-word-wrapping-algorithm"><span class="toc-section-number">7.9.3</span> Word Wrapping Algorithm</a></li>
</ul></details></li>
<li><details><summary><a href="#fringe-indicators" id="toc-fringe-indicators"><span class="toc-section-number">7.10</span> Fringe Indicators</a></summary><ul>
<li><a href="#fringe-architecture" id="toc-fringe-architecture"><span class="toc-section-number">7.10.1</span> Fringe Architecture</a></li>
<li><a href="#bitmap-definitions" id="toc-bitmap-definitions"><span class="toc-section-number">7.10.2</span> Bitmap Definitions</a></li>
<li><a href="#fringe-bitmap-structure" id="toc-fringe-bitmap-structure"><span class="toc-section-number">7.10.3</span> Fringe Bitmap
Structure</a></li>
</ul></details></li>
<li><details><summary><a href="#performance-optimizations" id="toc-performance-optimizations"><span class="toc-section-number">7.11</span> Performance Optimizations</a></summary><ul>
<li><a href="#the-optimization-strategy" id="toc-the-optimization-strategy"><span class="toc-section-number">7.11.1</span> The Optimization
Strategy</a></li>
<li><a href="#try_window-the-unoptimized-path" id="toc-try_window-the-unoptimized-path"><span class="toc-section-number">7.11.2</span> <code>try_window()</code>: The
Unoptimized Path</a></li>
<li><a href="#scroll-margin-optimization" id="toc-scroll-margin-optimization"><span class="toc-section-number">7.11.3</span> Scroll Margin
Optimization</a></li>
<li><a href="#hash-based-row-comparison" id="toc-hash-based-row-comparison"><span class="toc-section-number">7.11.4</span> Hash-Based Row
Comparison</a></li>
</ul></details></li>
<li><details><summary><a href="#window-system-integration" id="toc-window-system-integration"><span class="toc-section-number">7.12</span> Window System Integration</a></summary><ul>
<li><a href="#abstraction-through-backend-functions" id="toc-abstraction-through-backend-functions"><span class="toc-section-number">7.12.1</span> Abstraction Through Backend
Functions</a></li>
<li><a href="#the-update-dispatch" id="toc-the-update-dispatch"><span class="toc-section-number">7.12.2</span> The Update Dispatch</a></li>
<li><a href="#terminal-specific-rendering" id="toc-terminal-specific-rendering"><span class="toc-section-number">7.12.3</span> Terminal-Specific
Rendering</a></li>
<li><a href="#frame-matrix-usage-on-ttys" id="toc-frame-matrix-usage-on-ttys"><span class="toc-section-number">7.12.4</span> Frame Matrix Usage on
TTYs</a></li>
</ul></details></li>
<li><details><summary><a href="#advanced-topics" id="toc-advanced-topics"><span class="toc-section-number">7.13</span> Advanced Topics</a></summary><ul>
<li><a href="#long-line-optimization" id="toc-long-line-optimization"><span class="toc-section-number">7.13.1</span> Long Line Optimization</a></li>
<li><a href="#simulating-display-without-rendering" id="toc-simulating-display-without-rendering"><span class="toc-section-number">7.13.2</span> Simulating Display Without
Rendering</a></li>
</ul></details></li>
<li><details><summary><a href="#debugging-the-display-engine" id="toc-debugging-the-display-engine"><span class="toc-section-number">7.14</span> Debugging the Display Engine</a></summary><ul>
<li><a href="#glyph_debug-mode" id="toc-glyph_debug-mode"><span class="toc-section-number">7.14.1</span> GLYPH_DEBUG Mode</a></li>
<li><a href="#redisplay-history" id="toc-redisplay-history"><span class="toc-section-number">7.14.2</span> Redisplay History</a></li>
</ul></details></li>
<li><a href="#conclusion" id="toc-conclusion"><span class="toc-section-number">7.15</span> Conclusion</a></li>
<li><a href="#references" id="toc-references"><span class="toc-section-number">7.16</span> References</a></li>
</ul></details></li>
<li><details><summary><a href="#keyboard-and-event-handling-system" id="toc-keyboard-and-event-handling-system"><span class="toc-section-number">8</span> Keyboard and Event Handling
System</a></summary><ul>
<li><a href="#table-of-contents-2" id="toc-table-of-contents-2"><span class="toc-section-number">8.1</span> Table of Contents</a></li>
<li><details><summary><a href="#overview-1" id="toc-overview-1"><span class="toc-section-number">8.2</span> Overview</a></summary><ul>
<li><a href="#key-components" id="toc-key-components"><span class="toc-section-number">8.2.1</span> Key Components</a></li>
</ul></details></li>
<li><details><summary><a href="#core-data-structures" id="toc-core-data-structures"><span class="toc-section-number">8.3</span> Core Data Structures</a></summary><ul>
<li><a href="#kboard---per-keyboard-state" id="toc-kboard---per-keyboard-state"><span class="toc-section-number">8.3.1</span> 1. KBOARD - Per-Keyboard
State</a></li>
<li><a href="#input-events" id="toc-input-events"><span class="toc-section-number">8.3.2</span> 2. Input Events</a></li>
<li><a href="#keymap-data-structures" id="toc-keymap-data-structures"><span class="toc-section-number">8.3.3</span> 3. Keymap Data
Structures</a></li>
<li><a href="#keymap-hierarchy" id="toc-keymap-hierarchy"><span class="toc-section-number">8.3.4</span> 4. Keymap Hierarchy</a></li>
</ul></details></li>
<li><details><summary><a href="#event-loop-architecture" id="toc-event-loop-architecture"><span class="toc-section-number">8.4</span> Event Loop Architecture</a></summary><ul>
<li><a href="#command-loop-hierarchy" id="toc-command-loop-hierarchy"><span class="toc-section-number">8.4.1</span> Command Loop Hierarchy</a></li>
<li><a href="#command_loop---top-level-entry" id="toc-command_loop---top-level-entry"><span class="toc-section-number">8.4.2</span> 1. <code>command_loop()</code> -
Top-Level Entry</a></li>
<li><a href="#command_loop_1---main-command-loop" id="toc-command_loop_1---main-command-loop"><span class="toc-section-number">8.4.3</span> 2. <code>command_loop_1()</code>
- Main Command Loop</a></li>
<li><a href="#recursive_edit_1---recursive-editing" id="toc-recursive_edit_1---recursive-editing"><span class="toc-section-number">8.4.4</span> 3.
<code>recursive_edit_1()</code> - Recursive Editing</a></li>
</ul></details></li>
<li><details><summary><a href="#event-reading-and-processing" id="toc-event-reading-and-processing"><span class="toc-section-number">8.5</span> Event Reading and Processing</a></summary><ul>
<li><a href="#read_char---single-event-reading" id="toc-read_char---single-event-reading"><span class="toc-section-number">8.5.1</span> 1. <code>read_char()</code> -
Single Event Reading</a></li>
<li><a href="#event-queue-management" id="toc-event-queue-management"><span class="toc-section-number">8.5.2</span> 2. Event Queue
Management</a></li>
</ul></details></li>
<li><details><summary><a href="#keymap-system" id="toc-keymap-system"><span class="toc-section-number">8.6</span> Keymap System</a></summary><ul>
<li><a href="#keymap-lookup-algorithm" id="toc-keymap-lookup-algorithm"><span class="toc-section-number">8.6.1</span> 1. Keymap Lookup
Algorithm</a></li>
<li><a href="#key-lookup-through-keymap-hierarchy" id="toc-key-lookup-through-keymap-hierarchy"><span class="toc-section-number">8.6.2</span> 2. Key Lookup Through Keymap
Hierarchy</a></li>
<li><a href="#menu-item-handling" id="toc-menu-item-handling"><span class="toc-section-number">8.6.3</span> 3. Menu Item Handling</a></li>
</ul></details></li>
<li><details><summary><a href="#key-sequence-reading" id="toc-key-sequence-reading"><span class="toc-section-number">8.7</span> Key Sequence Reading</a></summary><ul>
<li><a href="#read_key_sequence---the-heart-of-key-reading" id="toc-read_key_sequence---the-heart-of-key-reading"><span class="toc-section-number">8.7.1</span> <code>read_key_sequence()</code>
- The Heart of Key Reading</a></li>
<li><a href="#translation-map-functions" id="toc-translation-map-functions"><span class="toc-section-number">8.7.2</span> Translation Map
Functions</a></li>
</ul></details></li>
<li><details><summary><a href="#command-execution" id="toc-command-execution"><span class="toc-section-number">8.8</span> Command Execution</a></summary><ul>
<li><a href="#call-interactively---interactive-command-execution" id="toc-call-interactively---interactive-command-execution"><span class="toc-section-number">8.8.1</span> <code>call-interactively</code>
- Interactive Command Execution</a></li>
</ul></details></li>
<li><details><summary><a href="#keyboard-macros" id="toc-keyboard-macros"><span class="toc-section-number">8.9</span> Keyboard Macros</a></summary><ul>
<li><a href="#recording-macros" id="toc-recording-macros"><span class="toc-section-number">8.9.1</span> Recording Macros</a></li>
<li><a href="#executing-macros" id="toc-executing-macros"><span class="toc-section-number">8.9.2</span> Executing Macros</a></li>
</ul></details></li>
<li><details><summary><a href="#special-event-types" id="toc-special-event-types"><span class="toc-section-number">8.10</span> Special Event Types</a></summary><ul>
<li><a href="#mouse-events" id="toc-mouse-events"><span class="toc-section-number">8.10.1</span> 1. Mouse Events</a></li>
<li><a href="#menu-events" id="toc-menu-events"><span class="toc-section-number">8.10.2</span> 2. Menu Events</a></li>
<li><a href="#drag-and-drop-events" id="toc-drag-and-drop-events"><span class="toc-section-number">8.10.3</span> 3. Drag and Drop
Events</a></li>
<li><a href="#touch-screen-events-modern-emacs" id="toc-touch-screen-events-modern-emacs"><span class="toc-section-number">8.10.4</span> 4. Touch Screen Events (Modern
Emacs)</a></li>
</ul></details></li>
<li><details><summary><a href="#multi-keyboard-support" id="toc-multi-keyboard-support"><span class="toc-section-number">8.11</span> Multi-Keyboard Support</a></summary><ul>
<li><a href="#kboard-management" id="toc-kboard-management"><span class="toc-section-number">8.11.1</span> KBOARD Management</a></li>
</ul></details></li>
<li><a href="#flow-diagram-complete-event-processing" id="toc-flow-diagram-complete-event-processing"><span class="toc-section-number">8.12</span> Flow Diagram: Complete Event
Processing</a></li>
<li><details><summary><a href="#key-functions-reference" id="toc-key-functions-reference"><span class="toc-section-number">8.13</span> Key Functions Reference</a></summary><ul>
<li><a href="#event-loop" id="toc-event-loop"><span class="toc-section-number">8.13.1</span> Event Loop</a></li>
<li><a href="#event-reading" id="toc-event-reading"><span class="toc-section-number">8.13.2</span> Event Reading</a></li>
<li><a href="#keymap-operations" id="toc-keymap-operations"><span class="toc-section-number">8.13.3</span> Keymap Operations</a></li>
<li><a href="#command-execution-1" id="toc-command-execution-1"><span class="toc-section-number">8.13.4</span> Command Execution</a></li>
<li><a href="#keyboard-macros-1" id="toc-keyboard-macros-1"><span class="toc-section-number">8.13.5</span> Keyboard Macros</a></li>
</ul></details></li>
<li><details><summary><a href="#performance-considerations" id="toc-performance-considerations"><span class="toc-section-number">8.14</span> Performance Considerations</a></summary><ul>
<li><a href="#keymap-lookup-optimization" id="toc-keymap-lookup-optimization"><span class="toc-section-number">8.14.1</span> 1. Keymap Lookup
Optimization</a></li>
<li><a href="#event-queue-management-1" id="toc-event-queue-management-1"><span class="toc-section-number">8.14.2</span> 2. Event Queue
Management</a></li>
<li><a href="#translation-map-application" id="toc-translation-map-application"><span class="toc-section-number">8.14.3</span> 3. Translation Map
Application</a></li>
</ul></details></li>
<li><details><summary><a href="#common-patterns" id="toc-common-patterns"><span class="toc-section-number">8.15</span> Common Patterns</a></summary><ul>
<li><a href="#reading-a-key-sequence" id="toc-reading-a-key-sequence"><span class="toc-section-number">8.15.1</span> 1. Reading a Key
Sequence</a></li>
<li><a href="#looking-up-a-key" id="toc-looking-up-a-key"><span class="toc-section-number">8.15.2</span> 2. Looking Up a Key</a></li>
<li><a href="#defining-a-key" id="toc-defining-a-key"><span class="toc-section-number">8.15.3</span> 3. Defining a Key</a></li>
<li><a href="#creating-interactive-commands" id="toc-creating-interactive-commands"><span class="toc-section-number">8.15.4</span> 4. Creating Interactive
Commands</a></li>
</ul></details></li>
<li><details><summary><a href="#debugging-tools" id="toc-debugging-tools"><span class="toc-section-number">8.16</span> Debugging Tools</a></summary><ul>
<li><a href="#view-lossage" id="toc-view-lossage"><span class="toc-section-number">8.16.1</span> 1. View Lossage</a></li>
<li><a href="#describe-key" id="toc-describe-key"><span class="toc-section-number">8.16.2</span> 2. Describe Key</a></li>
<li><a href="#where-is" id="toc-where-is"><span class="toc-section-number">8.16.3</span> 3. Where Is</a></li>
<li><a href="#event-debugging" id="toc-event-debugging"><span class="toc-section-number">8.16.4</span> 4. Event Debugging</a></li>
</ul></details></li>
<li><a href="#conclusion-1" id="toc-conclusion-1"><span class="toc-section-number">8.17</span> Conclusion</a></li>
</ul></details></li>
<li><details><summary><a href="#process-management-and-io-system" id="toc-process-management-and-io-system"><span class="toc-section-number">9</span> Process Management and I/O
System</a></summary><ul>
<li><a href="#table-of-contents-3" id="toc-table-of-contents-3"><span class="toc-section-number">9.1</span> Table of Contents</a></li>
<li><details><summary><a href="#overview-and-architecture" id="toc-overview-and-architecture"><span class="toc-section-number">9.2</span> Overview and Architecture</a></summary><ul>
<li><a href="#core-files" id="toc-core-files"><span class="toc-section-number">9.2.1</span> Core Files</a></li>
<li><a href="#design-philosophy" id="toc-design-philosophy"><span class="toc-section-number">9.2.2</span> Design Philosophy</a></li>
</ul></details></li>
<li><details><summary><a href="#core-data-structures-1" id="toc-core-data-structures-1"><span class="toc-section-number">9.3</span> Core Data Structures</a></summary><ul>
<li><a href="#the-lisp_process-structure" id="toc-the-lisp_process-structure"><span class="toc-section-number">9.3.1</span> The Lisp_Process
Structure</a></li>
<li><a href="#process-type-predicates" id="toc-process-type-predicates"><span class="toc-section-number">9.3.2</span> Process Type Predicates</a></li>
</ul></details></li>
<li><details><summary><a href="#process-creation-and-execution" id="toc-process-creation-and-execution"><span class="toc-section-number">9.4</span> Process Creation and Execution</a></summary><ul>
<li><a href="#the-make-process-function" id="toc-the-make-process-function"><span class="toc-section-number">9.4.1</span> The make-process
Function</a></li>
<li><a href="#synchronous-vs.-asynchronous-processes" id="toc-synchronous-vs.-asynchronous-processes"><span class="toc-section-number">9.4.2</span> Synchronous vs.¬†Asynchronous
Processes</a></li>
<li><a href="#forkexec-model" id="toc-forkexec-model"><span class="toc-section-number">9.4.3</span> Fork/Exec Model</a></li>
<li><a href="#modern-alternative-posix_spawn" id="toc-modern-alternative-posix_spawn"><span class="toc-section-number">9.4.4</span> Modern Alternative:
posix_spawn</a></li>
</ul></details></li>
<li><details><summary><a href="#io-system" id="toc-io-system"><span class="toc-section-number">9.5</span> I/O System</a></summary><ul>
<li><a href="#non-blocking-io-architecture" id="toc-non-blocking-io-architecture"><span class="toc-section-number">9.5.1</span> Non-Blocking I/O
Architecture</a></li>
<li><a href="#the-main-event-loop-wait_reading_process_output" id="toc-the-main-event-loop-wait_reading_process_output"><span class="toc-section-number">9.5.2</span> The Main Event Loop:
wait_reading_process_output</a></li>
<li><a href="#reading-process-output" id="toc-reading-process-output"><span class="toc-section-number">9.5.3</span> Reading Process Output</a></li>
<li><a href="#encoding-and-decoding-on-the-fly" id="toc-encoding-and-decoding-on-the-fly"><span class="toc-section-number">9.5.4</span> Encoding and Decoding on the
Fly</a></li>
<li><a href="#process-output-buffering" id="toc-process-output-buffering"><span class="toc-section-number">9.5.5</span> Process Output
Buffering</a></li>
<li><a href="#write-queue-for-output" id="toc-write-queue-for-output"><span class="toc-section-number">9.5.6</span> Write Queue for Output</a></li>
</ul></details></li>
<li><details><summary><a href="#process-filters-and-sentinels" id="toc-process-filters-and-sentinels"><span class="toc-section-number">9.6</span> Process Filters and Sentinels</a></summary><ul>
<li><a href="#process-filters" id="toc-process-filters"><span class="toc-section-number">9.6.1</span> Process Filters</a></li>
<li><a href="#process-sentinels" id="toc-process-sentinels"><span class="toc-section-number">9.6.2</span> Process Sentinels</a></li>
<li><a href="#signal-handling-and-sentinels" id="toc-signal-handling-and-sentinels"><span class="toc-section-number">9.6.3</span> Signal Handling and
Sentinels</a></li>
</ul></details></li>
<li><details><summary><a href="#network-processes" id="toc-network-processes"><span class="toc-section-number">9.7</span> Network Processes</a></summary><ul>
<li><a href="#creating-network-processes" id="toc-creating-network-processes"><span class="toc-section-number">9.7.1</span> Creating Network
Processes</a></li>
<li><a href="#network-server-example" id="toc-network-server-example"><span class="toc-section-number">9.7.2</span> Network Server Example</a></li>
<li><a href="#async-dns-resolution" id="toc-async-dns-resolution"><span class="toc-section-number">9.7.3</span> Async DNS Resolution</a></li>
</ul></details></li>
<li><a href="#serial-port-communication" id="toc-serial-port-communication"><span class="toc-section-number">9.8</span> Serial Port Communication</a></li>
<li><a href="#pty-allocation" id="toc-pty-allocation"><span class="toc-section-number">9.9</span> PTY Allocation</a></li>
<li><details><summary><a href="#signal-handling" id="toc-signal-handling"><span class="toc-section-number">9.10</span> Signal Handling</a></summary><ul>
<li><a href="#child-process-signals" id="toc-child-process-signals"><span class="toc-section-number">9.10.1</span> Child Process Signals</a></li>
<li><a href="#sending-signals-to-processes" id="toc-sending-signals-to-processes"><span class="toc-section-number">9.10.2</span> Sending Signals to
Processes</a></li>
</ul></details></li>
<li><details><summary><a href="#elisp-layer" id="toc-elisp-layer"><span class="toc-section-number">9.11</span> Elisp Layer</a></summary><ul>
<li><a href="#comint.el---command-interpreter" id="toc-comint.el---command-interpreter"><span class="toc-section-number">9.11.1</span> comint.el - Command
Interpreter</a></li>
<li><a href="#compile.el---compilation-mode" id="toc-compile.el---compilation-mode"><span class="toc-section-number">9.11.2</span> compile.el - Compilation
Mode</a></li>
<li><a href="#process-api-summary" id="toc-process-api-summary"><span class="toc-section-number">9.11.3</span> Process API Summary</a></li>
</ul></details></li>
<li><details><summary><a href="#advanced-topics-1" id="toc-advanced-topics-1"><span class="toc-section-number">9.12</span> Advanced Topics</a></summary><ul>
<li><a href="#process-environment" id="toc-process-environment"><span class="toc-section-number">9.12.1</span> Process Environment</a></li>
<li><a href="#subprocess-queries" id="toc-subprocess-queries"><span class="toc-section-number">9.12.2</span> Subprocess Queries</a></li>
<li><a href="#process-connections" id="toc-process-connections"><span class="toc-section-number">9.12.3</span> Process Connections</a></li>
<li><a href="#pipe-processes" id="toc-pipe-processes"><span class="toc-section-number">9.12.4</span> Pipe Processes</a></li>
<li><a href="#thread-affinity" id="toc-thread-affinity"><span class="toc-section-number">9.12.5</span> Thread Affinity</a></li>
<li><a href="#adaptive-read-buffering" id="toc-adaptive-read-buffering"><span class="toc-section-number">9.12.6</span> Adaptive Read
Buffering</a></li>
<li><a href="#file-handlers-and-tramp" id="toc-file-handlers-and-tramp"><span class="toc-section-number">9.12.7</span> File Handlers and
TRAMP</a></li>
</ul></details></li>
<li><details><summary><a href="#cross-platform-considerations" id="toc-cross-platform-considerations"><span class="toc-section-number">9.13</span> Cross-Platform Considerations</a></summary><ul>
<li><a href="#unix-vs.-windows" id="toc-unix-vs.-windows"><span class="toc-section-number">9.13.1</span> Unix vs.¬†Windows</a></li>
<li><a href="#platform-specific-code" id="toc-platform-specific-code"><span class="toc-section-number">9.13.2</span> Platform-Specific Code</a></li>
<li><a href="#macos-specifics" id="toc-macos-specifics"><span class="toc-section-number">9.13.3</span> macOS Specifics</a></li>
<li><a href="#android" id="toc-android"><span class="toc-section-number">9.13.4</span> Android</a></li>
</ul></details></li>
<li><details><summary><a href="#performance-considerations-1" id="toc-performance-considerations-1"><span class="toc-section-number">9.14</span> Performance Considerations</a></summary><ul>
<li><a href="#optimizing-process-io" id="toc-optimizing-process-io"><span class="toc-section-number">9.14.1</span> Optimizing Process I/O</a></li>
<li><a href="#memory-usage" id="toc-memory-usage"><span class="toc-section-number">9.14.2</span> Memory Usage</a></li>
</ul></details></li>
<li><details><summary><a href="#debugging-process-issues" id="toc-debugging-process-issues"><span class="toc-section-number">9.15</span> Debugging Process Issues</a></summary><ul>
<li><a href="#useful-debug-variables" id="toc-useful-debug-variables"><span class="toc-section-number">9.15.1</span> Useful Debug Variables</a></li>
<li><a href="#common-issues" id="toc-common-issues"><span class="toc-section-number">9.15.2</span> Common Issues</a></li>
</ul></details></li>
<li><a href="#summary" id="toc-summary"><span class="toc-section-number">9.16</span> Summary</a></li>
<li><a href="#references-1" id="toc-references-1"><span class="toc-section-number">9.17</span> References</a></li>
</ul></details></li>
<li><details><summary><a href="#file-io-and-character-encoding-system" id="toc-file-io-and-character-encoding-system"><span class="toc-section-number">10</span> File I/O and Character Encoding
System</a></summary><ul>
<li><a href="#table-of-contents-4" id="toc-table-of-contents-4"><span class="toc-section-number">10.1</span> Table of Contents</a></li>
<li><details><summary><a href="#architecture-overview-1" id="toc-architecture-overview-1"><span class="toc-section-number">10.2</span> Architecture Overview</a></summary><ul>
<li><a href="#design-philosophy-1" id="toc-design-philosophy-1"><span class="toc-section-number">10.2.1</span> Design Philosophy</a></li>
<li><a href="#key-concepts" id="toc-key-concepts"><span class="toc-section-number">10.2.2</span> Key Concepts</a></li>
</ul></details></li>
<li><details><summary><a href="#file-io-subsystem" id="toc-file-io-subsystem"><span class="toc-section-number">10.3</span> File I/O Subsystem</a></summary><ul>
<li><a href="#core-data-structures-2" id="toc-core-data-structures-2"><span class="toc-section-number">10.3.1</span> Core Data Structures</a></li>
<li><a href="#file-reading-insert-file-contents" id="toc-file-reading-insert-file-contents"><span class="toc-section-number">10.3.2</span> File Reading:
insert-file-contents</a></li>
<li><a href="#file-writing-write-region" id="toc-file-writing-write-region"><span class="toc-section-number">10.3.3</span> File Writing:
write-region</a></li>
<li><a href="#file-locking" id="toc-file-locking"><span class="toc-section-number">10.3.4</span> File Locking</a></li>
<li><a href="#directory-operations" id="toc-directory-operations"><span class="toc-section-number">10.3.5</span> Directory Operations</a></li>
</ul></details></li>
<li><details><summary><a href="#character-encoding-subsystem" id="toc-character-encoding-subsystem"><span class="toc-section-number">10.4</span> Character Encoding Subsystem</a></summary><ul>
<li><a href="#coding-system-architecture" id="toc-coding-system-architecture"><span class="toc-section-number">10.4.1</span> Coding System
Architecture</a></li>
<li><a href="#the-struct-coding_system" id="toc-the-struct-coding_system"><span class="toc-section-number">10.4.2</span> The struct
coding_system</a></li>
<li><a href="#coding-categories" id="toc-coding-categories"><span class="toc-section-number">10.4.3</span> Coding Categories</a></li>
</ul></details></li>
<li><details><summary><a href="#coding-system-framework" id="toc-coding-system-framework"><span class="toc-section-number">10.5</span> Coding System Framework</a></summary><ul>
<li><a href="#decoding-pipeline" id="toc-decoding-pipeline"><span class="toc-section-number">10.5.1</span> Decoding Pipeline</a></li>
<li><a href="#encoding-pipeline" id="toc-encoding-pipeline"><span class="toc-section-number">10.5.2</span> Encoding Pipeline</a></li>
<li><a href="#setup-and-configuration" id="toc-setup-and-configuration"><span class="toc-section-number">10.5.3</span> Setup and
Configuration</a></li>
</ul></details></li>
<li><details><summary><a href="#eol-conversion-and-bom-handling" id="toc-eol-conversion-and-bom-handling"><span class="toc-section-number">10.6</span> EOL Conversion and BOM
Handling</a></summary><ul>
<li><a href="#end-of-line-detection" id="toc-end-of-line-detection"><span class="toc-section-number">10.6.1</span> End-of-Line Detection</a></li>
<li><a href="#bom-byte-order-mark-handling" id="toc-bom-byte-order-mark-handling"><span class="toc-section-number">10.6.2</span> BOM (Byte Order Mark)
Handling</a></li>
</ul></details></li>
<li><details><summary><a href="#charset-system" id="toc-charset-system"><span class="toc-section-number">10.7</span> Charset System</a></summary><ul>
<li><a href="#charset-architecture" id="toc-charset-architecture"><span class="toc-section-number">10.7.1</span> Charset Architecture</a></li>
<li><a href="#dual-representation" id="toc-dual-representation"><span class="toc-section-number">10.7.2</span> Dual Representation</a></li>
<li><a href="#code-point-mapping" id="toc-code-point-mapping"><span class="toc-section-number">10.7.3</span> Code Point Mapping</a></li>
<li><a href="#important-charsets" id="toc-important-charsets"><span class="toc-section-number">10.7.4</span> Important Charsets</a></li>
<li><a href="#character-composition" id="toc-character-composition"><span class="toc-section-number">10.7.5</span> Character Composition</a></li>
</ul></details></li>
<li><details><summary><a href="#ccl-interpreter" id="toc-ccl-interpreter"><span class="toc-section-number">10.8</span> CCL Interpreter</a></summary><ul>
<li><a href="#ccl-architecture" id="toc-ccl-architecture"><span class="toc-section-number">10.8.1</span> CCL Architecture</a></li>
<li><a href="#ccl-commands" id="toc-ccl-commands"><span class="toc-section-number">10.8.2</span> CCL Commands</a></li>
</ul></details></li>
<li><details><summary><a href="#file-operations-pipeline" id="toc-file-operations-pipeline"><span class="toc-section-number">10.9</span> File Operations Pipeline</a></summary><ul>
<li><a href="#complete-read-pipeline" id="toc-complete-read-pipeline"><span class="toc-section-number">10.9.1</span> Complete Read Pipeline</a></li>
<li><a href="#complete-write-pipeline" id="toc-complete-write-pipeline"><span class="toc-section-number">10.9.2</span> Complete Write
Pipeline</a></li>
<li><a href="#error-handling-strategy" id="toc-error-handling-strategy"><span class="toc-section-number">10.9.3</span> Error Handling
Strategy</a></li>
</ul></details></li>
<li><details><summary><a href="#backup-and-auto-save" id="toc-backup-and-auto-save"><span class="toc-section-number">10.10</span> Backup and Auto-Save</a></summary><ul>
<li><a href="#backup-strategy" id="toc-backup-strategy"><span class="toc-section-number">10.10.1</span> Backup Strategy</a></li>
<li><a href="#backup-file-naming" id="toc-backup-file-naming"><span class="toc-section-number">10.10.2</span> Backup File Naming</a></li>
<li><a href="#auto-save-mechanism" id="toc-auto-save-mechanism"><span class="toc-section-number">10.10.3</span> Auto-Save Mechanism</a></li>
</ul></details></li>
<li><details><summary><a href="#elisp-interface" id="toc-elisp-interface"><span class="toc-section-number">10.11</span> Elisp Interface</a></summary><ul>
<li><a href="#file-io-functions" id="toc-file-io-functions"><span class="toc-section-number">10.11.1</span> File I/O Functions</a></li>
<li><a href="#coding-system-functions" id="toc-coding-system-functions"><span class="toc-section-number">10.11.2</span> Coding System
Functions</a></li>
<li><a href="#important-variables" id="toc-important-variables"><span class="toc-section-number">10.11.3</span> Important Variables</a></li>
<li><a href="#hooks" id="toc-hooks"><span class="toc-section-number">10.11.4</span> Hooks</a></li>
</ul></details></li>
<li><details><summary><a href="#implementation-deep-dives" id="toc-implementation-deep-dives"><span class="toc-section-number">10.12</span> Implementation Deep Dives</a></summary><ul>
<li><a href="#utf-8-detection-and-decoding" id="toc-utf-8-detection-and-decoding"><span class="toc-section-number">10.12.1</span> UTF-8 Detection and
Decoding</a></li>
<li><a href="#iso-2022-state-machine" id="toc-iso-2022-state-machine"><span class="toc-section-number">10.12.2</span> ISO-2022 State
Machine</a></li>
<li><a href="#file-name-expansion" id="toc-file-name-expansion"><span class="toc-section-number">10.12.3</span> File Name Expansion</a></li>
</ul></details></li>
<li><details><summary><a href="#performance-characteristics-1" id="toc-performance-characteristics-1"><span class="toc-section-number">10.13</span> Performance Characteristics</a></summary><ul>
<li><a href="#read-performance" id="toc-read-performance"><span class="toc-section-number">10.13.1</span> Read Performance</a></li>
<li><a href="#write-performance" id="toc-write-performance"><span class="toc-section-number">10.13.2</span> Write Performance</a></li>
<li><a href="#memory-usage-1" id="toc-memory-usage-1"><span class="toc-section-number">10.13.3</span> Memory Usage</a></li>
<li><a href="#optimization-strategies" id="toc-optimization-strategies"><span class="toc-section-number">10.13.4</span> Optimization
Strategies</a></li>
</ul></details></li>
<li><details><summary><a href="#security-considerations" id="toc-security-considerations"><span class="toc-section-number">10.14</span> Security Considerations</a></summary><ul>
<li><a href="#path-traversal-prevention" id="toc-path-traversal-prevention"><span class="toc-section-number">10.14.1</span> Path Traversal
Prevention</a></li>
<li><a href="#file-lock-race-conditions" id="toc-file-lock-race-conditions"><span class="toc-section-number">10.14.2</span> File Lock Race
Conditions</a></li>
<li><a href="#encoding-security" id="toc-encoding-security"><span class="toc-section-number">10.14.3</span> Encoding Security</a></li>
<li><a href="#temporary-file-security" id="toc-temporary-file-security"><span class="toc-section-number">10.14.4</span> Temporary File
Security</a></li>
</ul></details></li>
<li><details><summary><a href="#testing-and-validation" id="toc-testing-and-validation"><span class="toc-section-number">10.15</span> Testing and Validation</a></summary><ul>
<li><a href="#coding-system-test-coverage" id="toc-coding-system-test-coverage"><span class="toc-section-number">10.15.1</span> Coding System Test
Coverage</a></li>
<li><a href="#file-io-test-coverage" id="toc-file-io-test-coverage"><span class="toc-section-number">10.15.2</span> File I/O Test
Coverage</a></li>
</ul></details></li>
<li><details><summary><a href="#related-subsystems" id="toc-related-subsystems"><span class="toc-section-number">10.16</span> Related Subsystems</a></summary><ul>
<li><a href="#buffer-management" id="toc-buffer-management"><span class="toc-section-number">10.16.1</span> Buffer Management</a></li>
<li><a href="#display-engine" id="toc-display-engine"><span class="toc-section-number">10.16.2</span> Display Engine</a></li>
<li><a href="#process-io" id="toc-process-io"><span class="toc-section-number">10.16.3</span> Process I/O</a></li>
</ul></details></li>
<li><details><summary><a href="#historical-notes" id="toc-historical-notes"><span class="toc-section-number">10.17</span> Historical Notes</a></summary><ul>
<li><a href="#evolution-of-internal-encoding" id="toc-evolution-of-internal-encoding"><span class="toc-section-number">10.17.1</span> Evolution of Internal
Encoding</a></li>
<li><a href="#why-not-pure-utf-8" id="toc-why-not-pure-utf-8"><span class="toc-section-number">10.17.2</span> Why Not Pure UTF-8?</a></li>
<li><a href="#backward-compatibility" id="toc-backward-compatibility"><span class="toc-section-number">10.17.3</span> Backward
Compatibility</a></li>
</ul></details></li>
<li><a href="#conclusion-2" id="toc-conclusion-2"><span class="toc-section-number">10.18</span> Conclusion</a></li>
<li><details><summary><a href="#further-reading-4" id="toc-further-reading-4"><span class="toc-section-number">10.19</span> Further Reading</a></summary><ul>
<li><a href="#source-code-entry-points" id="toc-source-code-entry-points"><span class="toc-section-number">10.19.1</span> Source Code Entry
Points</a></li>
<li><a href="#documentation" id="toc-documentation"><span class="toc-section-number">10.19.2</span> Documentation</a></li>
<li><a href="#related-subsystems-1" id="toc-related-subsystems-1"><span class="toc-section-number">10.19.3</span> Related Subsystems</a></li>
</ul></details></li>
</ul></details></li>
<li><details><summary><a href="#emacs-lisp-interpreter-core" id="toc-emacs-lisp-interpreter-core"><span class="toc-section-number">11</span> Emacs Lisp Interpreter Core</a></summary><ul>
<li><a href="#table-of-contents-5" id="toc-table-of-contents-5"><span class="toc-section-number">11.1</span> Table of Contents</a></li>
<li><details><summary><a href="#fundamental-data-structures" id="toc-fundamental-data-structures"><span class="toc-section-number">11.2</span> 1. Fundamental Data
Structures</a></summary><ul>
<li><a href="#lisp_object-the-universal-type" id="toc-lisp_object-the-universal-type"><span class="toc-section-number">11.2.1</span> 1.1 Lisp_Object: The Universal
Type</a></li>
<li><a href="#tagged-pointer-architecture" id="toc-tagged-pointer-architecture"><span class="toc-section-number">11.2.2</span> 1.2 Tagged Pointer
Architecture</a></li>
<li><a href="#the-symbol-structure" id="toc-the-symbol-structure"><span class="toc-section-number">11.2.3</span> 1.3 The Symbol
Structure</a></li>
</ul></details></li>
<li><details><summary><a href="#the-lisp-object-system" id="toc-the-lisp-object-system"><span class="toc-section-number">11.3</span> 2. The Lisp Object System</a></summary><ul>
<li><a href="#type-predicates-and-extraction" id="toc-type-predicates-and-extraction"><span class="toc-section-number">11.3.1</span> 2.1 Type Predicates and
Extraction</a></li>
<li><a href="#integer-representation" id="toc-integer-representation"><span class="toc-section-number">11.3.2</span> 2.2 Integer
Representation</a></li>
</ul></details></li>
<li><details><summary><a href="#reading-lisp-code" id="toc-reading-lisp-code"><span class="toc-section-number">11.4</span> 3. Reading Lisp Code</a></summary><ul>
<li><a href="#the-lisp-reader" id="toc-the-lisp-reader"><span class="toc-section-number">11.4.1</span> 3.1 The Lisp Reader</a></li>
<li><a href="#the-obarray-symbol-interning" id="toc-the-obarray-symbol-interning"><span class="toc-section-number">11.4.2</span> 3.2 The Obarray: Symbol
Interning</a></li>
</ul></details></li>
<li><details><summary><a href="#the-evaluation-engine" id="toc-the-evaluation-engine"><span class="toc-section-number">11.5</span> 4. The Evaluation Engine</a></summary><ul>
<li><a href="#the-eval_sub-function" id="toc-the-eval_sub-function"><span class="toc-section-number">11.5.1</span> 4.1 The eval_sub
Function</a></li>
<li><a href="#function-dispatch" id="toc-function-dispatch"><span class="toc-section-number">11.5.2</span> 4.2 Function Dispatch</a></li>
<li><a href="#example-evaluating-1-2" id="toc-example-evaluating-1-2"><span class="toc-section-number">11.5.3</span> 4.3 Example: Evaluating
<code>(+ 1 2)</code></a></li>
</ul></details></li>
<li><details><summary><a href="#function-application" id="toc-function-application"><span class="toc-section-number">11.6</span> 5. Function Application</a></summary><ul>
<li><a href="#the-defun-macro" id="toc-the-defun-macro"><span class="toc-section-number">11.6.1</span> 5.1 The DEFUN Macro</a></li>
<li><a href="#funcall-the-direct-call-mechanism" id="toc-funcall-the-direct-call-mechanism"><span class="toc-section-number">11.6.2</span> 5.2 Funcall: The Direct Call
Mechanism</a></li>
<li><a href="#apply-spreading-argument-lists" id="toc-apply-spreading-argument-lists"><span class="toc-section-number">11.6.3</span> 5.3 Apply: Spreading Argument
Lists</a></li>
</ul></details></li>
<li><details><summary><a href="#bytecode-execution" id="toc-bytecode-execution"><span class="toc-section-number">11.7</span> 6. Bytecode Execution</a></summary><ul>
<li><a href="#why-bytecode" id="toc-why-bytecode"><span class="toc-section-number">11.7.1</span> 6.1 Why Bytecode?</a></li>
<li><a href="#bytecode-structure" id="toc-bytecode-structure"><span class="toc-section-number">11.7.2</span> 6.2 Bytecode Structure</a></li>
<li><a href="#the-bytecode-interpreter" id="toc-the-bytecode-interpreter"><span class="toc-section-number">11.7.3</span> 6.3 The Bytecode
Interpreter</a></li>
<li><a href="#bytecode-stack-architecture" id="toc-bytecode-stack-architecture"><span class="toc-section-number">11.7.4</span> 6.4 Bytecode Stack
Architecture</a></li>
<li><a href="#sample-bytecode-operations" id="toc-sample-bytecode-operations"><span class="toc-section-number">11.7.5</span> 6.5 Sample Bytecode
Operations</a></li>
</ul></details></li>
<li><details><summary><a href="#native-compilation-3" id="toc-native-compilation-3"><span class="toc-section-number">11.8</span> 7. Native Compilation</a></summary><ul>
<li><a href="#overview-2" id="toc-overview-2"><span class="toc-section-number">11.8.1</span> 7.1 Overview</a></li>
<li><a href="#native-compiled-functions" id="toc-native-compiled-functions"><span class="toc-section-number">11.8.2</span> 7.2 Native Compiled
Functions</a></li>
<li><a href="#advantages-and-tradeoffs" id="toc-advantages-and-tradeoffs"><span class="toc-section-number">11.8.3</span> 7.3 Advantages and
Tradeoffs</a></li>
</ul></details></li>
<li><details><summary><a href="#scoping-and-closures" id="toc-scoping-and-closures"><span class="toc-section-number">11.9</span> 8. Scoping and Closures</a></summary><ul>
<li><a href="#lexical-vs.-dynamic-scoping" id="toc-lexical-vs.-dynamic-scoping"><span class="toc-section-number">11.9.1</span> 8.1 Lexical vs.¬†Dynamic
Scoping</a></li>
<li><a href="#variable-lookup" id="toc-variable-lookup"><span class="toc-section-number">11.9.2</span> 8.2 Variable Lookup</a></li>
<li><a href="#creating-closures-funcall_lambda" id="toc-creating-closures-funcall_lambda"><span class="toc-section-number">11.9.3</span> 8.3 Creating Closures:
funcall_lambda</a></li>
<li><a href="#the-specpdl-dynamic-binding-stack" id="toc-the-specpdl-dynamic-binding-stack"><span class="toc-section-number">11.9.4</span> 8.4 The Specpdl: Dynamic
Binding Stack</a></li>
</ul></details></li>
<li><details><summary><a href="#special-forms-and-macros" id="toc-special-forms-and-macros"><span class="toc-section-number">11.10</span> 9. Special Forms and Macros</a></summary><ul>
<li><a href="#special-forms" id="toc-special-forms"><span class="toc-section-number">11.10.1</span> 9.1 Special Forms</a></li>
<li><a href="#macros" id="toc-macros"><span class="toc-section-number">11.10.2</span> 9.2 Macros</a></li>
</ul></details></li>
<li><details><summary><a href="#design-tradeoffs" id="toc-design-tradeoffs"><span class="toc-section-number">11.11</span> 10. Design Tradeoffs</a></summary><ul>
<li><a href="#three-execution-models" id="toc-three-execution-models"><span class="toc-section-number">11.11.1</span> 10.1 Three Execution
Models</a></li>
<li><a href="#tagged-pointers-vs.-boxed-values" id="toc-tagged-pointers-vs.-boxed-values"><span class="toc-section-number">11.11.2</span> 10.2 Tagged Pointers vs.¬†Boxed
Values</a></li>
<li><a href="#separate-function-namespace-lisp-2" id="toc-separate-function-namespace-lisp-2"><span class="toc-section-number">11.11.3</span> 10.3 Separate Function
Namespace (Lisp-2)</a></li>
<li><a href="#dynamic-vs.-lexical-scoping" id="toc-dynamic-vs.-lexical-scoping"><span class="toc-section-number">11.11.4</span> 10.4 Dynamic vs.¬†Lexical
Scoping</a></li>
<li><a href="#specpdl-vs.-c-stack" id="toc-specpdl-vs.-c-stack"><span class="toc-section-number">11.11.5</span> 10.5 Specpdl vs.¬†C
Stack</a></li>
<li><a href="#unevalled-vs.-macros" id="toc-unevalled-vs.-macros"><span class="toc-section-number">11.11.6</span> 10.6 UNEVALLED
vs.¬†Macros</a></li>
</ul></details></li>
<li><a href="#summary-1" id="toc-summary-1"><span class="toc-section-number">11.12</span> Summary</a></li>
</ul></details></li>
<li><details><summary><a href="#memory-management-and-garbage-collection" id="toc-memory-management-and-garbage-collection"><span class="toc-section-number">12</span> Memory Management and Garbage
Collection</a></summary><ul>
<li><a href="#table-of-contents-6" id="toc-table-of-contents-6"><span class="toc-section-number">12.1</span> Table of Contents</a></li>
<li><details><summary><a href="#overview-3" id="toc-overview-3"><span class="toc-section-number">12.2</span> Overview</a></summary><ul>
<li><a href="#key-design-principles-1" id="toc-key-design-principles-1"><span class="toc-section-number">12.2.1</span> Key Design Principles</a></li>
</ul></details></li>
<li><details><summary><a href="#the-allocation-system" id="toc-the-allocation-system"><span class="toc-section-number">12.3</span> The Allocation System</a></summary><ul>
<li><a href="#memory-type-tracking" id="toc-memory-type-tracking"><span class="toc-section-number">12.3.1</span> Memory Type Tracking</a></li>
<li><a href="#cons-cell-allocation" id="toc-cons-cell-allocation"><span class="toc-section-number">12.3.2</span> Cons Cell Allocation</a></li>
<li><a href="#string-allocation" id="toc-string-allocation"><span class="toc-section-number">12.3.3</span> String Allocation</a></li>
<li><a href="#vector-allocation" id="toc-vector-allocation"><span class="toc-section-number">12.3.4</span> Vector Allocation</a></li>
<li><a href="#float-and-symbol-allocation" id="toc-float-and-symbol-allocation"><span class="toc-section-number">12.3.5</span> Float and Symbol
Allocation</a></li>
<li><a href="#low-level-allocators" id="toc-low-level-allocators"><span class="toc-section-number">12.3.6</span> Low-Level Allocators</a></li>
<li><a href="#gmalloc.c---gnu-malloc" id="toc-gmalloc.c---gnu-malloc"><span class="toc-section-number">12.3.7</span> gmalloc.c - GNU malloc</a></li>
<li><a href="#ralloc.c---relocating-allocator" id="toc-ralloc.c---relocating-allocator"><span class="toc-section-number">12.3.8</span> ralloc.c - Relocating
Allocator</a></li>
</ul></details></li>
<li><details><summary><a href="#garbage-collection-algorithm" id="toc-garbage-collection-algorithm"><span class="toc-section-number">12.4</span> Garbage Collection Algorithm</a></summary><ul>
<li><a href="#the-mark-and-sweep-strategy" id="toc-the-mark-and-sweep-strategy"><span class="toc-section-number">12.4.1</span> The Mark-and-Sweep
Strategy</a></li>
<li><a href="#gc-entry-point" id="toc-gc-entry-point"><span class="toc-section-number">12.4.2</span> GC Entry Point</a></li>
<li><a href="#the-marking-phase" id="toc-the-marking-phase"><span class="toc-section-number">12.4.3</span> The Marking Phase</a></li>
<li><a href="#the-sweep-phase" id="toc-the-sweep-phase"><span class="toc-section-number">12.4.4</span> The Sweep Phase</a></li>
</ul></details></li>
<li><details><summary><a href="#key-functions-deep-dive" id="toc-key-functions-deep-dive"><span class="toc-section-number">12.5</span> Key Functions Deep Dive</a></summary><ul>
<li><a href="#garbage_collect" id="toc-garbage_collect"><span class="toc-section-number">12.5.1</span> garbage_collect</a></li>
<li><a href="#mark_object" id="toc-mark_object"><span class="toc-section-number">12.5.2</span> mark_object</a></li>
<li><a href="#conservative-stack-scanning" id="toc-conservative-stack-scanning"><span class="toc-section-number">12.5.3</span> Conservative Stack
Scanning</a></li>
</ul></details></li>
<li><details><summary><a href="#special-topics" id="toc-special-topics"><span class="toc-section-number">12.6</span> Special Topics</a></summary><ul>
<li><a href="#weak-hash-tables" id="toc-weak-hash-tables"><span class="toc-section-number">12.6.1</span> Weak Hash Tables</a></li>
<li><a href="#finalizers" id="toc-finalizers"><span class="toc-section-number">12.6.2</span> Finalizers</a></li>
<li><a href="#pdumper-integration" id="toc-pdumper-integration"><span class="toc-section-number">12.6.3</span> pdumper Integration</a></li>
<li><a href="#memory-reserve" id="toc-memory-reserve"><span class="toc-section-number">12.6.4</span> Memory Reserve</a></li>
</ul></details></li>
<li><details><summary><a href="#performance-and-tuning" id="toc-performance-and-tuning"><span class="toc-section-number">12.7</span> Performance and Tuning</a></summary><ul>
<li><a href="#gc-triggering" id="toc-gc-triggering"><span class="toc-section-number">12.7.1</span> GC Triggering</a></li>
<li><a href="#gc-thresholds" id="toc-gc-thresholds"><span class="toc-section-number">12.7.2</span> GC Thresholds</a></li>
<li><a href="#avoiding-gc-pauses" id="toc-avoiding-gc-pauses"><span class="toc-section-number">12.7.3</span> Avoiding GC Pauses</a></li>
<li><a href="#memory-profiling" id="toc-memory-profiling"><span class="toc-section-number">12.7.4</span> Memory Profiling</a></li>
<li><a href="#common-patterns-1" id="toc-common-patterns-1"><span class="toc-section-number">12.7.5</span> Common Patterns</a></li>
<li><a href="#performance-characteristics-2" id="toc-performance-characteristics-2"><span class="toc-section-number">12.7.6</span> Performance
Characteristics</a></li>
</ul></details></li>
<li><a href="#summary-2" id="toc-summary-2"><span class="toc-section-number">12.8</span> Summary</a></li>
</ul></details></li>
<li><details><summary><a href="#org-mode-literate-programming-and-organization" id="toc-org-mode-literate-programming-and-organization"><span class="toc-section-number">13</span> Org Mode: Literate Programming and
Organization</a></summary><ul>
<li><a href="#overview-4" id="toc-overview-4"><span class="toc-section-number">13.1</span> Overview</a></li>
<li><details><summary><a href="#core-architecture" id="toc-core-architecture"><span class="toc-section-number">13.2</span> Core Architecture</a></summary><ul>
<li><a href="#foundation-building-on-outline-mode" id="toc-foundation-building-on-outline-mode"><span class="toc-section-number">13.2.1</span> 1. Foundation: Building on
Outline Mode</a></li>
<li><a href="#the-org.el-core-22373-lines" id="toc-the-org.el-core-22373-lines"><span class="toc-section-number">13.2.2</span> 2. The org.el Core (22,373
lines)</a></li>
<li><a href="#the-element-parser-org-element.el-8730-lines" id="toc-the-element-parser-org-element.el-8730-lines"><span class="toc-section-number">13.2.3</span> 3. The Element Parser
(org-element.el, 8,730 lines)</a></li>
<li><a href="#visibility-cycling-org-cycle.el-947-lines" id="toc-visibility-cycling-org-cycle.el-947-lines"><span class="toc-section-number">13.2.4</span> 4. Visibility Cycling
(org-cycle.el, 947 lines)</a></li>
</ul></details></li>
<li><details><summary><a href="#babel-literate-programming-system" id="toc-babel-literate-programming-system"><span class="toc-section-number">13.3</span> Babel: Literate Programming
System</a></summary><ul>
<li><a href="#babel-core-ob-core.el-3677-lines" id="toc-babel-core-ob-core.el-3677-lines"><span class="toc-section-number">13.3.1</span> 1. Babel Core (ob-core.el,
3,677 lines)</a></li>
<li><a href="#language-support-48-language-files" id="toc-language-support-48-language-files"><span class="toc-section-number">13.3.2</span> 2. Language Support (48
language files)</a></li>
<li><a href="#tangling-ob-tangle.el-736-lines" id="toc-tangling-ob-tangle.el-736-lines"><span class="toc-section-number">13.3.3</span> 3. Tangling (ob-tangle.el, 736
lines)</a></li>
<li><a href="#noweb-reference-system" id="toc-noweb-reference-system"><span class="toc-section-number">13.3.4</span> 4. Noweb Reference
System</a></li>
</ul></details></li>
<li><details><summary><a href="#export-system" id="toc-export-system"><span class="toc-section-number">13.4</span> Export System</a></summary><ul>
<li><a href="#export-core-ox.el-7450-lines" id="toc-export-core-ox.el-7450-lines"><span class="toc-section-number">13.4.1</span> 1. Export Core (ox.el, 7,450
lines)</a></li>
<li><a href="#backend-architecture" id="toc-backend-architecture"><span class="toc-section-number">13.4.2</span> 2. Backend
Architecture</a></li>
<li><a href="#available-export-backends-12-total" id="toc-available-export-backends-12-total"><span class="toc-section-number">13.4.3</span> 3. Available Export Backends
(12 total)</a></li>
<li><a href="#export-process-flow" id="toc-export-process-flow"><span class="toc-section-number">13.4.4</span> 4. Export Process Flow</a></li>
</ul></details></li>
<li><details><summary><a href="#key-features" id="toc-key-features"><span class="toc-section-number">13.5</span> Key Features</a></summary><ul>
<li><a href="#agenda-system-org-agenda.el-11211-lines" id="toc-agenda-system-org-agenda.el-11211-lines"><span class="toc-section-number">13.5.1</span> 1. Agenda System
(org-agenda.el, 11,211 lines)</a></li>
<li><a href="#table-system-org-table.el-6438-lines" id="toc-table-system-org-table.el-6438-lines"><span class="toc-section-number">13.5.2</span> 2. Table System (org-table.el,
6,438 lines)</a></li>
<li><a href="#link-system-ol.el-2311-lines" id="toc-link-system-ol.el-2311-lines"><span class="toc-section-number">13.5.3</span> 3. Link System (ol.el, 2,311
lines)</a></li>
<li><a href="#capture-system-org-capture.el-2024-lines" id="toc-capture-system-org-capture.el-2024-lines"><span class="toc-section-number">13.5.4</span> 4. Capture System
(org-capture.el, 2,024 lines)</a></li>
<li><a href="#todo-and-scheduling" id="toc-todo-and-scheduling"><span class="toc-section-number">13.5.5</span> 5. TODO and Scheduling</a></li>
<li><a href="#tags-and-properties" id="toc-tags-and-properties"><span class="toc-section-number">13.5.6</span> 6. Tags and Properties</a></li>
<li><a href="#folding-system" id="toc-folding-system"><span class="toc-section-number">13.5.7</span> 7. Folding System</a></li>
</ul></details></li>
<li><details><summary><a href="#integration-with-emacs-systems" id="toc-integration-with-emacs-systems"><span class="toc-section-number">13.6</span> Integration with Emacs
Systems</a></summary><ul>
<li><a href="#calendar-and-diary-integration" id="toc-calendar-and-diary-integration"><span class="toc-section-number">13.6.1</span> 1. Calendar and Diary
Integration</a></li>
<li><a href="#narrowing-and-indirect-buffers" id="toc-narrowing-and-indirect-buffers"><span class="toc-section-number">13.6.2</span> 2. Narrowing and Indirect
Buffers</a></li>
<li><a href="#refile-system" id="toc-refile-system"><span class="toc-section-number">13.6.3</span> 3. Refile System</a></li>
<li><a href="#archive-system" id="toc-archive-system"><span class="toc-section-number">13.6.4</span> 4. Archive System</a></li>
<li><a href="#clock-system-org-clock.el-3336-lines" id="toc-clock-system-org-clock.el-3336-lines"><span class="toc-section-number">13.6.5</span> 5. Clock System (org-clock.el,
3,336 lines)</a></li>
</ul></details></li>
<li><a href="#module-dependencies" id="toc-module-dependencies"><span class="toc-section-number">13.7</span> Module Dependencies</a></li>
<li><details><summary><a href="#performance-considerations-2" id="toc-performance-considerations-2"><span class="toc-section-number">13.8</span> Performance Considerations</a></summary><ul>
<li><a href="#element-cache" id="toc-element-cache"><span class="toc-section-number">13.8.1</span> 1. Element Cache</a></li>
<li><a href="#lazy-loading-1" id="toc-lazy-loading-1"><span class="toc-section-number">13.8.2</span> 2. Lazy Loading</a></li>
<li><a href="#deferred-parsing" id="toc-deferred-parsing"><span class="toc-section-number">13.8.3</span> 3. Deferred Parsing</a></li>
</ul></details></li>
<li><details><summary><a href="#configuration-points" id="toc-configuration-points"><span class="toc-section-number">13.9</span> Configuration Points</a></summary><ul>
<li><a href="#startup-options" id="toc-startup-options"><span class="toc-section-number">13.9.1</span> 1. Startup Options</a></li>
<li><a href="#babel-configuration" id="toc-babel-configuration"><span class="toc-section-number">13.9.2</span> 2. Babel Configuration</a></li>
<li><a href="#export-configuration" id="toc-export-configuration"><span class="toc-section-number">13.9.3</span> 3. Export
Configuration</a></li>
<li><a href="#agenda-configuration" id="toc-agenda-configuration"><span class="toc-section-number">13.9.4</span> 4. Agenda
Configuration</a></li>
</ul></details></li>
<li><details><summary><a href="#key-innovations" id="toc-key-innovations"><span class="toc-section-number">13.10</span> Key Innovations</a></summary><ul>
<li><a href="#plain-text-format" id="toc-plain-text-format"><span class="toc-section-number">13.10.1</span> 1. Plain Text Format</a></li>
<li><a href="#parse-tree-architecture" id="toc-parse-tree-architecture"><span class="toc-section-number">13.10.2</span> 2. Parse Tree
Architecture</a></li>
<li><a href="#extensible-link-system" id="toc-extensible-link-system"><span class="toc-section-number">13.10.3</span> 3. Extensible Link
System</a></li>
<li><a href="#babels-language-agnostic-design" id="toc-babels-language-agnostic-design"><span class="toc-section-number">13.10.4</span> 4. Babel‚Äôs Language-Agnostic
Design</a></li>
<li><a href="#backend-transcoder-pattern" id="toc-backend-transcoder-pattern"><span class="toc-section-number">13.10.5</span> 5. Backend Transcoder
Pattern</a></li>
</ul></details></li>
<li><a href="#documentation-and-resources" id="toc-documentation-and-resources"><span class="toc-section-number">13.11</span> Documentation and
Resources</a></li>
<li><a href="#historical-context-1" id="toc-historical-context-1"><span class="toc-section-number">13.12</span> Historical Context</a></li>
<li><a href="#conclusion-3" id="toc-conclusion-3"><span class="toc-section-number">13.13</span> Conclusion</a></li>
</ul></details></li>
<li><details><summary><a href="#gnus-emacs-newsreader-and-mail-client" id="toc-gnus-emacs-newsreader-and-mail-client"><span class="toc-section-number">14</span> Gnus: Emacs Newsreader and Mail
Client</a></summary><ul>
<li><details><summary><a href="#overview-5" id="toc-overview-5"><span class="toc-section-number">14.1</span> Overview</a></summary><ul>
<li><a href="#architectural-philosophy" id="toc-architectural-philosophy"><span class="toc-section-number">14.1.1</span> Architectural
Philosophy</a></li>
</ul></details></li>
<li><details><summary><a href="#core-architecture-1" id="toc-core-architecture-1"><span class="toc-section-number">14.2</span> Core Architecture</a></summary><ul>
<li><a href="#entry-point-gnus.el-4204-lines" id="toc-entry-point-gnus.el-4204-lines"><span class="toc-section-number">14.2.1</span> 1. Entry Point: gnus.el (4,204
lines)</a></li>
<li><a href="#group-buffer-gnus-group.el-4869-lines" id="toc-group-buffer-gnus-group.el-4869-lines"><span class="toc-section-number">14.2.2</span> 2. Group Buffer: gnus-group.el
(4,869 lines)</a></li>
<li><a href="#summary-buffer-gnus-sum.el-13241-lines---largest-file" id="toc-summary-buffer-gnus-sum.el-13241-lines---largest-file"><span class="toc-section-number">14.2.3</span> 3. Summary Buffer: gnus-sum.el
(13,241 lines - largest file)</a></li>
<li><a href="#article-buffer-gnus-art.el-9061-lines" id="toc-article-buffer-gnus-art.el-9061-lines"><span class="toc-section-number">14.2.4</span> 4. Article Buffer: gnus-art.el
(9,061 lines)</a></li>
<li><a href="#message-composition-message.el-9065-lines" id="toc-message-composition-message.el-9065-lines"><span class="toc-section-number">14.2.5</span> 5. Message Composition:
message.el (9,065 lines)</a></li>
</ul></details></li>
<li><details><summary><a href="#backend-system-the-nnoo-architecture" id="toc-backend-system-the-nnoo-architecture"><span class="toc-section-number">14.3</span> Backend System: The nnoo
Architecture</a></summary><ul>
<li><a href="#backend-abstraction-nnoo.el" id="toc-backend-abstraction-nnoo.el"><span class="toc-section-number">14.3.1</span> Backend Abstraction:
nnoo.el</a></li>
<li><a href="#backend-interface-gnus-int.el" id="toc-backend-interface-gnus-int.el"><span class="toc-section-number">14.3.2</span> Backend Interface:
gnus-int.el</a></li>
<li><a href="#major-backends" id="toc-major-backends"><span class="toc-section-number">14.3.3</span> Major Backends</a></li>
</ul></details></li>
<li><details><summary><a href="#startup-and-state-management-gnus-start.el-3199-lines" id="toc-startup-and-state-management-gnus-start.el-3199-lines"><span class="toc-section-number">14.4</span> Startup and State Management:
gnus-start.el (3,199 lines)</a></summary><ul>
<li><a href="#startup-sequence" id="toc-startup-sequence"><span class="toc-section-number">14.4.1</span> Startup Sequence</a></li>
<li><a href="#the-newsrc-files" id="toc-the-newsrc-files"><span class="toc-section-number">14.4.2</span> The Newsrc Files</a></li>
<li><a href="#group-activation" id="toc-group-activation"><span class="toc-section-number">14.4.3</span> Group Activation</a></li>
<li><a href="#level-system" id="toc-level-system"><span class="toc-section-number">14.4.4</span> Level System</a></li>
</ul></details></li>
<li><details><summary><a href="#feature-modules" id="toc-feature-modules"><span class="toc-section-number">14.5</span> Feature Modules</a></summary><ul>
<li><a href="#offline-mode-gnus-agent.el-4143-lines" id="toc-offline-mode-gnus-agent.el-4143-lines"><span class="toc-section-number">14.5.1</span> Offline Mode: gnus-agent.el
(4,143 lines)</a></li>
<li><a href="#scoring-system-gnus-score.el-3188-lines" id="toc-scoring-system-gnus-score.el-3188-lines"><span class="toc-section-number">14.5.2</span> Scoring System: gnus-score.el
(3,188 lines)</a></li>
<li><a href="#search-system-gnus-search.el-2363-lines" id="toc-search-system-gnus-search.el-2363-lines"><span class="toc-section-number">14.5.3</span> Search System: gnus-search.el
(2,363 lines)</a></li>
<li><a href="#article-registry-gnus-registry.el-1304-lines" id="toc-article-registry-gnus-registry.el-1304-lines"><span class="toc-section-number">14.5.4</span> Article Registry:
gnus-registry.el (1,304 lines)</a></li>
<li><a href="#topic-mode-gnus-topic.el-1798-lines" id="toc-topic-mode-gnus-topic.el-1798-lines"><span class="toc-section-number">14.5.5</span> Topic Mode: gnus-topic.el
(1,798 lines)</a></li>
</ul></details></li>
<li><details><summary><a href="#mime-handling" id="toc-mime-handling"><span class="toc-section-number">14.6</span> MIME Handling</a></summary><ul>
<li><a href="#mime-meta-language-mml.el-1800-lines" id="toc-mime-meta-language-mml.el-1800-lines"><span class="toc-section-number">14.6.1</span> MIME Meta Language: mml.el
(1,800+ lines)</a></li>
<li><a href="#mime-decoding-mm-decode.el-2000-lines" id="toc-mime-decoding-mm-decode.el-2000-lines"><span class="toc-section-number">14.6.2</span> MIME Decoding: mm-decode.el
(2,000+ lines)</a></li>
<li><a href="#other-mime-modules" id="toc-other-mime-modules"><span class="toc-section-number">14.6.3</span> Other MIME Modules</a></li>
</ul></details></li>
<li><details><summary><a href="#integration-features" id="toc-integration-features"><span class="toc-section-number">14.7</span> Integration Features</a></summary><ul>
<li><a href="#cloud-synchronization-gnus-cloud.el-600-lines" id="toc-cloud-synchronization-gnus-cloud.el-600-lines"><span class="toc-section-number">14.7.1</span> Cloud Synchronization:
gnus-cloud.el (600+ lines)</a></li>
<li><a href="#message-encryption-mml-sec.el" id="toc-message-encryption-mml-sec.el"><span class="toc-section-number">14.7.2</span> Message Encryption:
mml-sec.el</a></li>
<li><a href="#spam-filtering-spam.el-3000-lines" id="toc-spam-filtering-spam.el-3000-lines"><span class="toc-section-number">14.7.3</span> Spam Filtering: spam.el (3,000+
lines)</a></li>
<li><a href="#utilities-and-infrastructure" id="toc-utilities-and-infrastructure"><span class="toc-section-number">14.7.4</span> Utilities and
Infrastructure</a></li>
</ul></details></li>
<li><details><summary><a href="#data-flow-examples" id="toc-data-flow-examples"><span class="toc-section-number">14.8</span> Data Flow Examples</a></summary><ul>
<li><a href="#reading-news" id="toc-reading-news"><span class="toc-section-number">14.8.1</span> Reading News</a></li>
<li><a href="#sending-mail" id="toc-sending-mail"><span class="toc-section-number">14.8.2</span> Sending Mail</a></li>
<li><a href="#mail-splitting" id="toc-mail-splitting"><span class="toc-section-number">14.8.3</span> Mail Splitting</a></li>
</ul></details></li>
<li><details><summary><a href="#performance-considerations-3" id="toc-performance-considerations-3"><span class="toc-section-number">14.9</span> Performance Considerations</a></summary><ul>
<li><a href="#startup-performance" id="toc-startup-performance"><span class="toc-section-number">14.9.1</span> Startup Performance</a></li>
<li><a href="#summary-generation" id="toc-summary-generation"><span class="toc-section-number">14.9.2</span> Summary Generation</a></li>
<li><a href="#memory-management" id="toc-memory-management"><span class="toc-section-number">14.9.3</span> Memory Management</a></li>
</ul></details></li>
<li><details><summary><a href="#customization-patterns" id="toc-customization-patterns"><span class="toc-section-number">14.10</span> Customization Patterns</a></summary><ul>
<li><a href="#group-parameters" id="toc-group-parameters"><span class="toc-section-number">14.10.1</span> Group Parameters</a></li>
<li><a href="#select-methods" id="toc-select-methods"><span class="toc-section-number">14.10.2</span> Select Methods</a></li>
<li><a href="#hooks-1" id="toc-hooks-1"><span class="toc-section-number">14.10.3</span> Hooks</a></li>
</ul></details></li>
<li><details><summary><a href="#design-patterns-and-idioms" id="toc-design-patterns-and-idioms"><span class="toc-section-number">14.11</span> Design Patterns and Idioms</a></summary><ul>
<li><a href="#the-three-buffer-model" id="toc-the-three-buffer-model"><span class="toc-section-number">14.11.1</span> The Three-Buffer
Model</a></li>
<li><a href="#format-specifications" id="toc-format-specifications"><span class="toc-section-number">14.11.2</span> Format Specifications</a></li>
<li><a href="#backend-inheritance" id="toc-backend-inheritance"><span class="toc-section-number">14.11.3</span> Backend Inheritance</a></li>
<li><a href="#range-compression" id="toc-range-compression"><span class="toc-section-number">14.11.4</span> Range Compression</a></li>
</ul></details></li>
<li><details><summary><a href="#testing-and-debugging" id="toc-testing-and-debugging"><span class="toc-section-number">14.12</span> Testing and Debugging</a></summary><ul>
<li><a href="#debug-variables" id="toc-debug-variables"><span class="toc-section-number">14.12.1</span> Debug Variables</a></li>
<li><a href="#repair-commands" id="toc-repair-commands"><span class="toc-section-number">14.12.2</span> Repair Commands</a></li>
</ul></details></li>
<li><a href="#historical-context-2" id="toc-historical-context-2"><span class="toc-section-number">14.13</span> Historical Context</a></li>
<li><a href="#code-statistics" id="toc-code-statistics"><span class="toc-section-number">14.14</span> Code Statistics</a></li>
<li><a href="#key-takeaways-2" id="toc-key-takeaways-2"><span class="toc-section-number">14.15</span> Key Takeaways</a></li>
</ul></details></li>
<li><details><summary><a href="#version-control-vc-system" id="toc-version-control-vc-system"><span class="toc-section-number">15</span> Version Control (VC) System</a></summary><ul>
<li><a href="#overview-6" id="toc-overview-6"><span class="toc-section-number">15.1</span> Overview</a></li>
<li><details><summary><a href="#architecture" id="toc-architecture"><span class="toc-section-number">15.2</span> Architecture</a></summary><ul>
<li><a href="#core-components" id="toc-core-components"><span class="toc-section-number">15.2.1</span> Core Components</a></li>
<li><a href="#file-organization" id="toc-file-organization"><span class="toc-section-number">15.2.2</span> File Organization</a></li>
</ul></details></li>
<li><details><summary><a href="#backend-abstraction-layer" id="toc-backend-abstraction-layer"><span class="toc-section-number">15.3</span> Backend Abstraction Layer</a></summary><ul>
<li><a href="#the-vc-call-dispatch-mechanism" id="toc-the-vc-call-dispatch-mechanism"><span class="toc-section-number">15.3.1</span> The vc-call Dispatch
Mechanism</a></li>
<li><a href="#backend-function-discovery" id="toc-backend-function-discovery"><span class="toc-section-number">15.3.2</span> Backend Function
Discovery</a></li>
<li><a href="#backend-api-contract" id="toc-backend-api-contract"><span class="toc-section-number">15.3.3</span> Backend API Contract</a></li>
<li><a href="#backend-registration" id="toc-backend-registration"><span class="toc-section-number">15.3.4</span> Backend Registration</a></li>
</ul></details></li>
<li><a href="#property-caching-system" id="toc-property-caching-system"><span class="toc-section-number">15.4</span> Property Caching System</a></li>
<li><details><summary><a href="#core-features" id="toc-core-features"><span class="toc-section-number">15.5</span> Core Features</a></summary><ul>
<li><a href="#file-status-queries" id="toc-file-status-queries"><span class="toc-section-number">15.5.1</span> 1. File Status Queries</a></li>
<li><a href="#diff-generation" id="toc-diff-generation"><span class="toc-section-number">15.5.2</span> 2. Diff Generation</a></li>
<li><a href="#commit-interface" id="toc-commit-interface"><span class="toc-section-number">15.5.3</span> 3. Commit Interface</a></li>
<li><a href="#log-viewing" id="toc-log-viewing"><span class="toc-section-number">15.5.4</span> 4. Log Viewing</a></li>
<li><a href="#branch-management" id="toc-branch-management"><span class="toc-section-number">15.5.5</span> 5. Branch Management</a></li>
<li><a href="#merging-and-conflict-resolution" id="toc-merging-and-conflict-resolution"><span class="toc-section-number">15.5.6</span> 6. Merging and Conflict
Resolution</a></li>
</ul></details></li>
<li><details><summary><a href="#related-tools" id="toc-related-tools"><span class="toc-section-number">15.6</span> Related Tools</a></summary><ul>
<li><a href="#diff-mode.el-3505-lines" id="toc-diff-mode.el-3505-lines"><span class="toc-section-number">15.6.1</span> diff-mode.el (3,505
lines)</a></li>
<li><a href="#log-view.el-956-lines" id="toc-log-view.el-956-lines"><span class="toc-section-number">15.6.2</span> log-view.el (956
lines)</a></li>
<li><a href="#ediff-suite-10-files-18000-lines" id="toc-ediff-suite-10-files-18000-lines"><span class="toc-section-number">15.6.3</span> ediff Suite (10 files, ~18,000
lines)</a></li>
<li><a href="#vc-annotate.el-835-lines" id="toc-vc-annotate.el-835-lines"><span class="toc-section-number">15.6.4</span> vc-annotate.el (835
lines)</a></li>
<li><a href="#vc-dir.el-1744-lines" id="toc-vc-dir.el-1744-lines"><span class="toc-section-number">15.6.5</span> vc-dir.el (1,744
lines)</a></li>
</ul></details></li>
<li><details><summary><a href="#design-patterns" id="toc-design-patterns"><span class="toc-section-number">15.7</span> Design Patterns</a></summary><ul>
<li><a href="#backend-registration-and-discovery" id="toc-backend-registration-and-discovery"><span class="toc-section-number">15.7.1</span> 1. Backend Registration and
Discovery</a></li>
<li><a href="#asynchronous-operations" id="toc-asynchronous-operations"><span class="toc-section-number">15.7.2</span> 2. Asynchronous
Operations</a></li>
<li><a href="#state-caching-and-invalidation" id="toc-state-caching-and-invalidation"><span class="toc-section-number">15.7.3</span> 3. State Caching and
Invalidation</a></li>
<li><a href="#hook-system" id="toc-hook-system"><span class="toc-section-number">15.7.4</span> 4. Hook System</a></li>
<li><a href="#mode-line-integration" id="toc-mode-line-integration"><span class="toc-section-number">15.7.5</span> 5. Mode-Line
Integration</a></li>
</ul></details></li>
<li><details><summary><a href="#implementation-deep-dives-1" id="toc-implementation-deep-dives-1"><span class="toc-section-number">15.8</span> Implementation Deep Dives</a></summary><ul>
<li><a href="#git-backend-vc-git.el" id="toc-git-backend-vc-git.el"><span class="toc-section-number">15.8.1</span> Git Backend
(vc-git.el)</a></li>
<li><a href="#dispatcher-architecture-vc-dispatcher.el" id="toc-dispatcher-architecture-vc-dispatcher.el"><span class="toc-section-number">15.8.2</span> Dispatcher Architecture
(vc-dispatcher.el)</a></li>
<li><a href="#diff-mode-features-diff-mode.el" id="toc-diff-mode-features-diff-mode.el"><span class="toc-section-number">15.8.3</span> Diff Mode Features
(diff-mode.el)</a></li>
<li><a href="#merge-conflict-resolution-smerge-mode.el" id="toc-merge-conflict-resolution-smerge-mode.el"><span class="toc-section-number">15.8.4</span> Merge Conflict Resolution
(smerge-mode.el)</a></li>
</ul></details></li>
<li><details><summary><a href="#user-interaction-patterns" id="toc-user-interaction-patterns"><span class="toc-section-number">15.9</span> User Interaction Patterns</a></summary><ul>
<li><a href="#context-aware-vc-next-action" id="toc-context-aware-vc-next-action"><span class="toc-section-number">15.9.1</span> Context-Aware
vc-next-action</a></li>
<li><a href="#prefix-arguments" id="toc-prefix-arguments"><span class="toc-section-number">15.9.2</span> Prefix Arguments</a></li>
<li><a href="#file-set-operations" id="toc-file-set-operations"><span class="toc-section-number">15.9.3</span> File Set Operations</a></li>
</ul></details></li>
<li><details><summary><a href="#configuration-and-customization" id="toc-configuration-and-customization"><span class="toc-section-number">15.10</span> Configuration and
Customization</a></summary><ul>
<li><a href="#key-customization-variables" id="toc-key-customization-variables"><span class="toc-section-number">15.10.1</span> Key Customization
Variables</a></li>
<li><a href="#backend-precedence" id="toc-backend-precedence"><span class="toc-section-number">15.10.2</span> Backend Precedence</a></li>
<li><a href="#performance-tuning" id="toc-performance-tuning"><span class="toc-section-number">15.10.3</span> Performance Tuning</a></li>
</ul></details></li>
<li><details><summary><a href="#advanced-features" id="toc-advanced-features"><span class="toc-section-number">15.11</span> Advanced Features</a></summary><ul>
<li><a href="#annotateblame" id="toc-annotateblame"><span class="toc-section-number">15.11.1</span> 1. Annotate/Blame</a></li>
<li><a href="#region-history" id="toc-region-history"><span class="toc-section-number">15.11.2</span> 2. Region History</a></li>
<li><a href="#shelvestash" id="toc-shelvestash"><span class="toc-section-number">15.11.3</span> 3. Shelve/Stash</a></li>
<li><a href="#working-trees-git-worktrees" id="toc-working-trees-git-worktrees"><span class="toc-section-number">15.11.4</span> 4. Working Trees (Git
Worktrees)</a></li>
<li><a href="#cherry-pick" id="toc-cherry-pick"><span class="toc-section-number">15.11.5</span> 5. Cherry-Pick</a></li>
<li><a href="#retrieve-revisions" id="toc-retrieve-revisions"><span class="toc-section-number">15.11.6</span> 6. Retrieve Revisions</a></li>
</ul></details></li>
<li><details><summary><a href="#error-handling-and-edge-cases" id="toc-error-handling-and-edge-cases"><span class="toc-section-number">15.12</span> Error Handling and Edge
Cases</a></summary><ul>
<li><a href="#missing-backend-executable" id="toc-missing-backend-executable"><span class="toc-section-number">15.12.1</span> Missing Backend
Executable</a></li>
<li><a href="#corrupted-repository" id="toc-corrupted-repository"><span class="toc-section-number">15.12.2</span> Corrupted Repository</a></li>
<li><a href="#nested-repositories" id="toc-nested-repositories"><span class="toc-section-number">15.12.3</span> Nested Repositories</a></li>
<li><a href="#remote-files-tramp" id="toc-remote-files-tramp"><span class="toc-section-number">15.12.4</span> Remote Files (TRAMP)</a></li>
</ul></details></li>
<li><details><summary><a href="#testing-and-debugging-1" id="toc-testing-and-debugging-1"><span class="toc-section-number">15.13</span> Testing and Debugging</a></summary><ul>
<li><a href="#debugging-vc-operations" id="toc-debugging-vc-operations"><span class="toc-section-number">15.13.1</span> Debugging VC
Operations</a></li>
<li><a href="#test-files" id="toc-test-files"><span class="toc-section-number">15.13.2</span> Test Files</a></li>
</ul></details></li>
<li><details><summary><a href="#migration-and-compatibility" id="toc-migration-and-compatibility"><span class="toc-section-number">15.14</span> Migration and Compatibility</a></summary><ul>
<li><a href="#supporting-new-vcs" id="toc-supporting-new-vcs"><span class="toc-section-number">15.14.1</span> Supporting New VCS</a></li>
<li><a href="#backward-compatibility-1" id="toc-backward-compatibility-1"><span class="toc-section-number">15.14.2</span> Backward
Compatibility</a></li>
</ul></details></li>
<li><details><summary><a href="#performance-characteristics-3" id="toc-performance-characteristics-3"><span class="toc-section-number">15.15</span> Performance Characteristics</a></summary><ul>
<li><a href="#backend-speed-comparison" id="toc-backend-speed-comparison"><span class="toc-section-number">15.15.1</span> Backend Speed
Comparison</a></li>
<li><a href="#optimization-strategies-1" id="toc-optimization-strategies-1"><span class="toc-section-number">15.15.2</span> Optimization
Strategies</a></li>
</ul></details></li>
<li><details><summary><a href="#future-directions" id="toc-future-directions"><span class="toc-section-number">15.16</span> Future Directions</a></summary><ul>
<li><a href="#planned-features" id="toc-planned-features"><span class="toc-section-number">15.16.1</span> Planned Features</a></li>
<li><a href="#modern-vcs-trends" id="toc-modern-vcs-trends"><span class="toc-section-number">15.16.2</span> Modern VCS Trends</a></li>
</ul></details></li>
<li><a href="#conclusion-4" id="toc-conclusion-4"><span class="toc-section-number">15.17</span> Conclusion</a></li>
<li><details><summary><a href="#references-2" id="toc-references-2"><span class="toc-section-number">15.18</span> References</a></summary><ul>
<li><a href="#primary-source-files" id="toc-primary-source-files"><span class="toc-section-number">15.18.1</span> Primary Source Files</a></li>
<li><a href="#related-documentation" id="toc-related-documentation"><span class="toc-section-number">15.18.2</span> Related Documentation</a></li>
<li><a href="#key-data-structures" id="toc-key-data-structures"><span class="toc-section-number">15.18.3</span> Key Data Structures</a></li>
<li><a href="#important-variables-1" id="toc-important-variables-1"><span class="toc-section-number">15.18.4</span> Important Variables</a></li>
</ul></details></li>
</ul></details></li>
<li><details><summary><a href="#cedet-collection-of-emacs-development-environment-tools" id="toc-cedet-collection-of-emacs-development-environment-tools"><span class="toc-section-number">16</span> CEDET: Collection of Emacs
Development Environment Tools</a></summary><ul>
<li><a href="#executive-summary" id="toc-executive-summary"><span class="toc-section-number">16.1</span> Executive Summary</a></li>
<li><details><summary><a href="#major-components-overview" id="toc-major-components-overview"><span class="toc-section-number">16.2</span> 1. Major Components Overview</a></summary><ul>
<li><a href="#architecture-diagram" id="toc-architecture-diagram"><span class="toc-section-number">16.2.1</span> Architecture Diagram</a></li>
<li><a href="#component-breakdown" id="toc-component-breakdown"><span class="toc-section-number">16.2.2</span> Component Breakdown</a></li>
</ul></details></li>
<li><details><summary><a href="#semantic-parser-framework-and-code-analysis" id="toc-semantic-parser-framework-and-code-analysis"><span class="toc-section-number">16.3</span> 2. Semantic: Parser Framework and
Code Analysis</a></summary><ul>
<li><a href="#the-tag-system-heart-of-semantic" id="toc-the-tag-system-heart-of-semantic"><span class="toc-section-number">16.3.1</span> 2.1 The Tag System: Heart of
Semantic</a></li>
<li><a href="#parser-infrastructure-bovine-vs.-wisent" id="toc-parser-infrastructure-bovine-vs.-wisent"><span class="toc-section-number">16.3.2</span> 2.2 Parser Infrastructure:
Bovine vs.¬†Wisent</a></li>
<li><a href="#language-parsers" id="toc-language-parsers"><span class="toc-section-number">16.3.3</span> 2.3 Language Parsers</a></li>
<li><a href="#the-semantic-database-semanticdb" id="toc-the-semantic-database-semanticdb"><span class="toc-section-number">16.3.4</span> 2.4 The Semantic Database
(SemanticDB)</a></li>
<li><a href="#code-analysis-and-completion" id="toc-code-analysis-and-completion"><span class="toc-section-number">16.3.5</span> 2.5 Code Analysis and
Completion</a></li>
</ul></details></li>
<li><details><summary><a href="#ede-emacs-development-environment-project-management" id="toc-ede-emacs-development-environment-project-management"><span class="toc-section-number">16.4</span> 3. EDE: Emacs Development
Environment (Project Management)</a></summary><ul>
<li><a href="#project-architecture" id="toc-project-architecture"><span class="toc-section-number">16.4.1</span> 3.1 Project
Architecture</a></li>
<li><a href="#project-types" id="toc-project-types"><span class="toc-section-number">16.4.2</span> 3.2 Project Types</a></li>
<li><a href="#build-system-integration" id="toc-build-system-integration"><span class="toc-section-number">16.4.3</span> 3.3 Build System
Integration</a></li>
<li><a href="#project-configuration" id="toc-project-configuration"><span class="toc-section-number">16.4.4</span> 3.4 Project
Configuration</a></li>
</ul></details></li>
<li><details><summary><a href="#srecode-semantic-recoder-template-system" id="toc-srecode-semantic-recoder-template-system"><span class="toc-section-number">16.5</span> 4. SRecode: Semantic Recoder
(Template System)</a></summary><ul>
<li><a href="#template-language" id="toc-template-language"><span class="toc-section-number">16.5.1</span> 4.1 Template Language</a></li>
<li><a href="#template-files" id="toc-template-files"><span class="toc-section-number">16.5.2</span> 4.2 Template Files</a></li>
<li><a href="#template-variables-and-context" id="toc-template-variables-and-context"><span class="toc-section-number">16.5.3</span> 4.3 Template Variables and
Context</a></li>
<li><a href="#template-maps" id="toc-template-maps"><span class="toc-section-number">16.5.4</span> 4.4 Template Maps</a></li>
</ul></details></li>
<li><details><summary><a href="#integration-and-architecture" id="toc-integration-and-architecture"><span class="toc-section-number">16.6</span> 5. Integration and
Architecture</a></summary><ul>
<li><a href="#mode-local-infrastructure" id="toc-mode-local-infrastructure"><span class="toc-section-number">16.6.1</span> 5.1 Mode-Local
Infrastructure</a></li>
<li><a href="#component-interaction-flow" id="toc-component-interaction-flow"><span class="toc-section-number">16.6.2</span> 5.2 Component Interaction
Flow</a></li>
<li><a href="#idle-time-services" id="toc-idle-time-services"><span class="toc-section-number">16.6.3</span> 5.3 Idle Time Services</a></li>
</ul></details></li>
<li><details><summary><a href="#modern-context-lsp-vs.-cedet" id="toc-modern-context-lsp-vs.-cedet"><span class="toc-section-number">16.7</span> 6. Modern Context: LSP
vs.¬†CEDET</a></summary><ul>
<li><a href="#the-lsp-advantage" id="toc-the-lsp-advantage"><span class="toc-section-number">16.7.1</span> 6.1 The LSP Advantage</a></li>
<li><a href="#when-cedet-still-makes-sense" id="toc-when-cedet-still-makes-sense"><span class="toc-section-number">16.7.2</span> 6.2 When CEDET Still Makes
Sense</a></li>
<li><a href="#hybrid-approach" id="toc-hybrid-approach"><span class="toc-section-number">16.7.3</span> 6.3 Hybrid Approach</a></li>
</ul></details></li>
<li><details><summary><a href="#historical-context-and-evolution" id="toc-historical-context-and-evolution"><span class="toc-section-number">16.8</span> 7. Historical Context and
Evolution</a></summary><ul>
<li><a href="#cedet-history" id="toc-cedet-history"><span class="toc-section-number">16.8.1</span> 7.1 CEDET History</a></li>
<li><a href="#architectural-lessons" id="toc-architectural-lessons"><span class="toc-section-number">16.8.2</span> 7.2 Architectural
Lessons</a></li>
<li><a href="#why-lsp-won" id="toc-why-lsp-won"><span class="toc-section-number">16.8.3</span> 7.3 Why LSP Won</a></li>
</ul></details></li>
<li><details><summary><a href="#code-examples-and-recipes" id="toc-code-examples-and-recipes"><span class="toc-section-number">16.9</span> 8. Code Examples and Recipes</a></summary><ul>
<li><a href="#basic-semantic-usage" id="toc-basic-semantic-usage"><span class="toc-section-number">16.9.1</span> 8.1 Basic Semantic
Usage</a></li>
<li><a href="#ede-project-setup" id="toc-ede-project-setup"><span class="toc-section-number">16.9.2</span> 8.2 EDE Project Setup</a></li>
<li><a href="#creating-custom-templates" id="toc-creating-custom-templates"><span class="toc-section-number">16.9.3</span> 8.3 Creating Custom
Templates</a></li>
<li><a href="#advanced-semantic-analysis" id="toc-advanced-semantic-analysis"><span class="toc-section-number">16.9.4</span> 8.4 Advanced Semantic
Analysis</a></li>
</ul></details></li>
<li><details><summary><a href="#performance-considerations-4" id="toc-performance-considerations-4"><span class="toc-section-number">16.10</span> 9. Performance
Considerations</a></summary><ul>
<li><a href="#optimization-strategies-2" id="toc-optimization-strategies-2"><span class="toc-section-number">16.10.1</span> 9.1 Optimization
Strategies</a></li>
<li><a href="#database-management" id="toc-database-management"><span class="toc-section-number">16.10.2</span> 9.2 Database
Management</a></li>
</ul></details></li>
<li><details><summary><a href="#debugging-and-troubleshooting" id="toc-debugging-and-troubleshooting"><span class="toc-section-number">16.11</span> 10. Debugging and
Troubleshooting</a></summary><ul>
<li><a href="#common-issues-1" id="toc-common-issues-1"><span class="toc-section-number">16.11.1</span> 10.1 Common Issues</a></li>
<li><a href="#debug-tools" id="toc-debug-tools"><span class="toc-section-number">16.11.2</span> 10.2 Debug Tools</a></li>
</ul></details></li>
<li><details><summary><a href="#comparison-matrix" id="toc-comparison-matrix"><span class="toc-section-number">16.12</span> 11. Comparison Matrix</a></summary><ul>
<li><a href="#cedet-vs.-lsp-feature-comparison" id="toc-cedet-vs.-lsp-feature-comparison"><span class="toc-section-number">16.12.1</span> CEDET vs.¬†LSP Feature
Comparison</a></li>
</ul></details></li>
<li><details><summary><a href="#migration-guide-cedet-to-lsp" id="toc-migration-guide-cedet-to-lsp"><span class="toc-section-number">16.13</span> 12. Migration Guide: CEDET to
LSP</a></summary><ul>
<li><a href="#equivalent-features" id="toc-equivalent-features"><span class="toc-section-number">16.13.1</span> 12.1 Equivalent
Features</a></li>
<li><a href="#feature-mapping" id="toc-feature-mapping"><span class="toc-section-number">16.13.2</span> 12.2 Feature Mapping</a></li>
</ul></details></li>
<li><details><summary><a href="#future-and-recommendations" id="toc-future-and-recommendations"><span class="toc-section-number">16.14</span> 13. Future and
Recommendations</a></summary><ul>
<li><a href="#current-status-2025" id="toc-current-status-2025"><span class="toc-section-number">16.14.1</span> 13.1 Current Status
(2025)</a></li>
<li><a href="#recommendations" id="toc-recommendations"><span class="toc-section-number">16.14.2</span> 13.2 Recommendations</a></li>
<li><a href="#learning-resources" id="toc-learning-resources"><span class="toc-section-number">16.14.3</span> 13.3 Learning
Resources</a></li>
</ul></details></li>
<li><a href="#conclusion-5" id="toc-conclusion-5"><span class="toc-section-number">16.15</span> Conclusion</a></li>
</ul></details></li>
<li><details><summary><a href="#calc-advanced-calculator" id="toc-calc-advanced-calculator"><span class="toc-section-number">17</span> Calc: Advanced Calculator</a></summary><ul>
<li><details><summary><a href="#overview-7" id="toc-overview-7"><span class="toc-section-number">17.1</span> Overview</a></summary><ul>
<li><a href="#key-features-1" id="toc-key-features-1"><span class="toc-section-number">17.1.1</span> Key Features</a></li>
</ul></details></li>
<li><details><summary><a href="#architecture-1" id="toc-architecture-1"><span class="toc-section-number">17.2</span> Architecture</a></summary><ul>
<li><a href="#core-module-structure" id="toc-core-module-structure"><span class="toc-section-number">17.2.1</span> Core Module Structure</a></li>
<li><a href="#lazy-loading-design" id="toc-lazy-loading-design"><span class="toc-section-number">17.2.2</span> Lazy Loading Design</a></li>
</ul></details></li>
<li><details><summary><a href="#data-representation" id="toc-data-representation"><span class="toc-section-number">17.3</span> Data Representation</a></summary><ul>
<li><a href="#internal-number-format" id="toc-internal-number-format"><span class="toc-section-number">17.3.1</span> Internal Number Format</a></li>
<li><a href="#type-code-notation" id="toc-type-code-notation"><span class="toc-section-number">17.3.2</span> Type Code Notation</a></li>
<li><a href="#examples-of-data-representation" id="toc-examples-of-data-representation"><span class="toc-section-number">17.3.3</span> Examples of Data
Representation</a></li>
</ul></details></li>
<li><a href="#core-normalization" id="toc-core-normalization"><span class="toc-section-number">17.4</span> Core Normalization</a></li>
<li><details><summary><a href="#stack-based-calculator-model" id="toc-stack-based-calculator-model"><span class="toc-section-number">17.5</span> Stack-Based Calculator Model</a></summary><ul>
<li><a href="#the-calculator-stack" id="toc-the-calculator-stack"><span class="toc-section-number">17.5.1</span> The Calculator Stack</a></li>
<li><a href="#rpn-vs.-algebraic-mode" id="toc-rpn-vs.-algebraic-mode"><span class="toc-section-number">17.5.2</span> RPN vs.¬†Algebraic Mode</a></li>
</ul></details></li>
<li><details><summary><a href="#arithmetic-operations" id="toc-arithmetic-operations"><span class="toc-section-number">17.6</span> Arithmetic Operations</a></summary><ul>
<li><a href="#basic-arithmetic-calc-arith.el" id="toc-basic-arithmetic-calc-arith.el"><span class="toc-section-number">17.6.1</span> Basic Arithmetic
(<code>calc-arith.el</code>)</a></li>
<li><a href="#mathematical-functions-calc-math.el" id="toc-mathematical-functions-calc-math.el"><span class="toc-section-number">17.6.2</span> Mathematical Functions
(<code>calc-math.el</code>)</a></li>
</ul></details></li>
<li><details><summary><a href="#algebraic-operations" id="toc-algebraic-operations"><span class="toc-section-number">17.7</span> Algebraic Operations</a></summary><ul>
<li><a href="#simplification-calc-alg.el" id="toc-simplification-calc-alg.el"><span class="toc-section-number">17.7.1</span> Simplification
(<code>calc-alg.el</code>)</a></li>
<li><a href="#symbolic-manipulation" id="toc-symbolic-manipulation"><span class="toc-section-number">17.7.2</span> Symbolic Manipulation</a></li>
</ul></details></li>
<li><details><summary><a href="#calculus-calcalg2.el" id="toc-calculus-calcalg2.el"><span class="toc-section-number">17.8</span> Calculus
(<code>calcalg2.el</code>)</a></summary><ul>
<li><a href="#differentiation" id="toc-differentiation"><span class="toc-section-number">17.8.1</span> Differentiation</a></li>
<li><a href="#integration" id="toc-integration"><span class="toc-section-number">17.8.2</span> Integration</a></li>
</ul></details></li>
<li><details><summary><a href="#vector-and-matrix-operations" id="toc-vector-and-matrix-operations"><span class="toc-section-number">17.9</span> Vector and Matrix Operations</a></summary><ul>
<li><a href="#vector-representation-calc-vec.el" id="toc-vector-representation-calc-vec.el"><span class="toc-section-number">17.9.1</span> Vector Representation
(<code>calc-vec.el</code>)</a></li>
<li><a href="#matrix-operations-calc-mtx.el" id="toc-matrix-operations-calc-mtx.el"><span class="toc-section-number">17.9.2</span> Matrix Operations
(<code>calc-mtx.el</code>)</a></li>
</ul></details></li>
<li><a href="#units-system-calc-units.el" id="toc-units-system-calc-units.el"><span class="toc-section-number">17.10</span> Units System
(<code>calc-units.el</code>)</a></li>
<li><a href="#statistics-calc-stat.el" id="toc-statistics-calc-stat.el"><span class="toc-section-number">17.11</span> Statistics
(<code>calc-stat.el</code>)</a></li>
<li><a href="#financial-functions-calc-fin.el" id="toc-financial-functions-calc-fin.el"><span class="toc-section-number">17.12</span> Financial Functions
(<code>calc-fin.el</code>)</a></li>
<li><details><summary><a href="#user-interface" id="toc-user-interface"><span class="toc-section-number">17.13</span> User Interface</a></summary><ul>
<li><a href="#trail-buffer-calc-trail.el" id="toc-trail-buffer-calc-trail.el"><span class="toc-section-number">17.13.1</span> Trail Buffer
(<code>calc-trail.el</code>)</a></li>
<li><a href="#embedded-mode-calc-embed.el" id="toc-embedded-mode-calc-embed.el"><span class="toc-section-number">17.13.2</span> Embedded Mode
(<code>calc-embed.el</code>)</a></li>
<li><a href="#complex-numbers-calc-cplx.el" id="toc-complex-numbers-calc-cplx.el"><span class="toc-section-number">17.13.3</span> Complex Numbers
(<code>calc-cplx.el</code>)</a></li>
</ul></details></li>
<li><details><summary><a href="#programming-features" id="toc-programming-features"><span class="toc-section-number">17.14</span> Programming Features</a></summary><ul>
<li><a href="#user-defined-functions-calc-prog.el" id="toc-user-defined-functions-calc-prog.el"><span class="toc-section-number">17.14.1</span> User-Defined Functions
(<code>calc-prog.el</code>)</a></li>
<li><a href="#keyboard-macros-2" id="toc-keyboard-macros-2"><span class="toc-section-number">17.14.2</span> Keyboard Macros</a></li>
<li><a href="#rewrite-rules-calc-rewr.el" id="toc-rewrite-rules-calc-rewr.el"><span class="toc-section-number">17.14.3</span> Rewrite Rules
(<code>calc-rewr.el</code>)</a></li>
</ul></details></li>
<li><a href="#language-modes-calc-lang.el" id="toc-language-modes-calc-lang.el"><span class="toc-section-number">17.15</span> Language Modes
(<code>calc-lang.el</code>)</a></li>
<li><details><summary><a href="#precision-and-modes" id="toc-precision-and-modes"><span class="toc-section-number">17.16</span> Precision and Modes</a></summary><ul>
<li><a href="#precision-control" id="toc-precision-control"><span class="toc-section-number">17.16.1</span> Precision Control</a></li>
<li><a href="#angular-modes" id="toc-angular-modes"><span class="toc-section-number">17.16.2</span> Angular Modes</a></li>
<li><a href="#display-modes" id="toc-display-modes"><span class="toc-section-number">17.16.3</span> Display Modes</a></li>
</ul></details></li>
<li><details><summary><a href="#advanced-features-1" id="toc-advanced-features-1"><span class="toc-section-number">17.17</span> Advanced Features</a></summary><ul>
<li><a href="#arbitrary-precision" id="toc-arbitrary-precision"><span class="toc-section-number">17.17.1</span> Arbitrary Precision</a></li>
<li><a href="#symbolic-computation" id="toc-symbolic-computation"><span class="toc-section-number">17.17.2</span> Symbolic Computation</a></li>
<li><a href="#error-forms-and-intervals" id="toc-error-forms-and-intervals"><span class="toc-section-number">17.17.3</span> Error Forms and
Intervals</a></li>
</ul></details></li>
<li><details><summary><a href="#extension-points" id="toc-extension-points"><span class="toc-section-number">17.18</span> Extension Points</a></summary><ul>
<li><a href="#custom-functions" id="toc-custom-functions"><span class="toc-section-number">17.18.1</span> Custom Functions</a></li>
<li><a href="#hooks-2" id="toc-hooks-2"><span class="toc-section-number">17.18.2</span> Hooks</a></li>
<li><a href="#settings-persistence" id="toc-settings-persistence"><span class="toc-section-number">17.18.3</span> Settings Persistence</a></li>
</ul></details></li>
<li><details><summary><a href="#implementation-insights" id="toc-implementation-insights"><span class="toc-section-number">17.19</span> Implementation Insights</a></summary><ul>
<li><a href="#performance-optimizations-1" id="toc-performance-optimizations-1"><span class="toc-section-number">17.19.1</span> Performance
Optimizations</a></li>
<li><a href="#error-handling" id="toc-error-handling"><span class="toc-section-number">17.19.2</span> Error Handling</a></li>
<li><a href="#normalization-philosophy" id="toc-normalization-philosophy"><span class="toc-section-number">17.19.3</span> Normalization
Philosophy</a></li>
</ul></details></li>
<li><details><summary><a href="#usage-examples" id="toc-usage-examples"><span class="toc-section-number">17.20</span> Usage Examples</a></summary><ul>
<li><a href="#basic-rpn-calculations" id="toc-basic-rpn-calculations"><span class="toc-section-number">17.20.1</span> Basic RPN
Calculations</a></li>
<li><a href="#algebraic-entry" id="toc-algebraic-entry"><span class="toc-section-number">17.20.2</span> Algebraic Entry</a></li>
<li><a href="#matrix-operations" id="toc-matrix-operations"><span class="toc-section-number">17.20.3</span> Matrix Operations</a></li>
<li><a href="#unit-conversions" id="toc-unit-conversions"><span class="toc-section-number">17.20.4</span> Unit Conversions</a></li>
<li><a href="#symbolic-computation-1" id="toc-symbolic-computation-1"><span class="toc-section-number">17.20.5</span> Symbolic Computation</a></li>
</ul></details></li>
<li><details><summary><a href="#integration-with-emacs" id="toc-integration-with-emacs"><span class="toc-section-number">17.21</span> Integration with Emacs</a></summary><ul>
<li><a href="#embedding-in-buffers" id="toc-embedding-in-buffers"><span class="toc-section-number">17.21.1</span> Embedding in Buffers</a></li>
<li><a href="#quick-calculations" id="toc-quick-calculations"><span class="toc-section-number">17.21.2</span> Quick Calculations</a></li>
<li><a href="#graph-integration" id="toc-graph-integration"><span class="toc-section-number">17.21.3</span> Graph Integration</a></li>
</ul></details></li>
<li><details><summary><a href="#design-philosophy-2" id="toc-design-philosophy-2"><span class="toc-section-number">17.22</span> Design Philosophy</a></summary><ul>
<li><a href="#comprehensiveness" id="toc-comprehensiveness"><span class="toc-section-number">17.22.1</span> Comprehensiveness</a></li>
<li><a href="#precision-and-correctness" id="toc-precision-and-correctness"><span class="toc-section-number">17.22.2</span> Precision and
Correctness</a></li>
<li><a href="#integration-1" id="toc-integration-1"><span class="toc-section-number">17.22.3</span> Integration</a></li>
<li><a href="#discoverability" id="toc-discoverability"><span class="toc-section-number">17.22.4</span> Discoverability</a></li>
</ul></details></li>
<li><a href="#historical-note" id="toc-historical-note"><span class="toc-section-number">17.23</span> Historical Note</a></li>
<li><a href="#summary-3" id="toc-summary-3"><span class="toc-section-number">17.24</span> Summary</a></li>
</ul></details></li>
<li><details><summary><a href="#platform-abstraction-layer-a-literate-programming-guide" id="toc-platform-abstraction-layer-a-literate-programming-guide"><span class="toc-section-number">18</span> Platform Abstraction Layer: A
Literate Programming Guide</a></summary><ul>
<li><a href="#table-of-contents-7" id="toc-table-of-contents-7"><span class="toc-section-number">18.1</span> Table of Contents</a></li>
<li><a href="#executive-summary-1" id="toc-executive-summary-1"><span class="toc-section-number">18.2</span> Executive Summary</a></li>
<li><details><summary><a href="#platform-overview" id="toc-platform-overview"><span class="toc-section-number">18.3</span> Platform Overview</a></summary><ul>
<li><a href="#supported-platforms" id="toc-supported-platforms"><span class="toc-section-number">18.3.1</span> 1.1 Supported
Platforms</a></li>
<li><a href="#design-philosophy-3" id="toc-design-philosophy-3"><span class="toc-section-number">18.3.2</span> 1.2 Design Philosophy</a></li>
</ul></details></li>
<li><details><summary><a href="#core-abstraction-layer" id="toc-core-abstraction-layer"><span class="toc-section-number">18.4</span> Core Abstraction Layer</a></summary><ul>
<li><a href="#the-terminal-structure" id="toc-the-terminal-structure"><span class="toc-section-number">18.4.1</span> 2.1 The Terminal
Structure</a></li>
<li><a href="#terminal-hook-functions" id="toc-terminal-hook-functions"><span class="toc-section-number">18.4.2</span> 2.2 Terminal Hook
Functions</a></li>
<li><a href="#the-redisplay-interface" id="toc-the-redisplay-interface"><span class="toc-section-number">18.4.3</span> 2.3 The Redisplay
Interface</a></li>
<li><a href="#terminal-creation-and-initialization" id="toc-terminal-creation-and-initialization"><span class="toc-section-number">18.4.4</span> 2.4 Terminal Creation and
Initialization</a></li>
</ul></details></li>
<li><details><summary><a href="#platform-implementations" id="toc-platform-implementations"><span class="toc-section-number">18.5</span> Platform Implementations</a></summary><ul>
<li><a href="#x11-x-window-system" id="toc-x11-x-window-system"><span class="toc-section-number">18.5.1</span> 3.1 X11 (X Window
System)</a></li>
<li><a href="#windows-win32w32" id="toc-windows-win32w32"><span class="toc-section-number">18.5.2</span> 3.2 Windows
(Win32/w32)</a></li>
<li><a href="#android-1" id="toc-android-1"><span class="toc-section-number">18.5.3</span> 3.3 Android</a></li>
<li><a href="#gtkpgtk-pure-gtk" id="toc-gtkpgtk-pure-gtk"><span class="toc-section-number">18.5.4</span> 3.4 GTK/PGTK (Pure
GTK)</a></li>
<li><a href="#haiku" id="toc-haiku"><span class="toc-section-number">18.5.5</span> 3.5 Haiku</a></li>
<li><a href="#tty-terminaltext-mode" id="toc-tty-terminaltext-mode"><span class="toc-section-number">18.5.6</span> 3.6 TTY (Terminal/Text
Mode)</a></li>
</ul></details></li>
<li><details><summary><a href="#common-patterns-2" id="toc-common-patterns-2"><span class="toc-section-number">18.6</span> Common Patterns</a></summary><ul>
<li><a href="#event-handling-abstraction" id="toc-event-handling-abstraction"><span class="toc-section-number">18.6.1</span> 4.1 Event Handling
Abstraction</a></li>
<li><a href="#font-backend-system" id="toc-font-backend-system"><span class="toc-section-number">18.6.2</span> 4.2 Font Backend
System</a></li>
<li><a href="#image-support" id="toc-image-support"><span class="toc-section-number">18.6.3</span> 4.3 Image Support</a></li>
<li><a href="#clipboardselection-handling" id="toc-clipboardselection-handling"><span class="toc-section-number">18.6.4</span> 4.4 Clipboard/Selection
Handling</a></li>
<li><a href="#menu-systems" id="toc-menu-systems"><span class="toc-section-number">18.6.5</span> 4.5 Menu Systems</a></li>
</ul></details></li>
<li><details><summary><a href="#case-study-x11-implementation" id="toc-case-study-x11-implementation"><span class="toc-section-number">18.7</span> Case Study: X11
Implementation</a></summary><ul>
<li><a href="#architecture-overview-2" id="toc-architecture-overview-2"><span class="toc-section-number">18.7.1</span> 5.1 Architecture
Overview</a></li>
<li><a href="#text-rendering-pipeline" id="toc-text-rendering-pipeline"><span class="toc-section-number">18.7.2</span> 5.2 Text Rendering
Pipeline</a></li>
<li><a href="#event-processing-pipeline" id="toc-event-processing-pipeline"><span class="toc-section-number">18.7.3</span> 5.3 Event Processing
Pipeline</a></li>
<li><a href="#x11-specific-features" id="toc-x11-specific-features"><span class="toc-section-number">18.7.4</span> 5.4 X11-Specific
Features</a></li>
</ul></details></li>
<li><details><summary><a href="#integration-guide" id="toc-integration-guide"><span class="toc-section-number">18.8</span> Integration Guide</a></summary><ul>
<li><a href="#adding-a-new-platform" id="toc-adding-a-new-platform"><span class="toc-section-number">18.8.1</span> 6.1 Adding a New
Platform</a></li>
<li><a href="#best-practices" id="toc-best-practices"><span class="toc-section-number">18.8.2</span> 6.2 Best Practices</a></li>
</ul></details></li>
<li><details><summary><a href="#references-3" id="toc-references-3"><span class="toc-section-number">18.9</span> References</a></summary><ul>
<li><a href="#primary-source-files-1" id="toc-primary-source-files-1"><span class="toc-section-number">18.9.1</span> Primary Source Files</a></li>
<li><a href="#key-concepts-1" id="toc-key-concepts-1"><span class="toc-section-number">18.9.2</span> Key Concepts</a></li>
<li><a href="#statistics-summary" id="toc-statistics-summary"><span class="toc-section-number">18.9.3</span> Statistics Summary</a></li>
</ul></details></li>
</ul></details></li>
<li><details><summary><a href="#x11-window-system-integration" id="toc-x11-window-system-integration"><span class="toc-section-number">19</span> X11 Window System Integration</a></summary><ul>
<li><details><summary><a href="#overview-8" id="toc-overview-8"><span class="toc-section-number">19.1</span> Overview</a></summary><ul>
<li><a href="#architecture-overview-3" id="toc-architecture-overview-3"><span class="toc-section-number">19.1.1</span> Architecture Overview</a></li>
</ul></details></li>
<li><details><summary><a href="#x11-integration-architecture" id="toc-x11-integration-architecture"><span class="toc-section-number">19.2</span> 1. X11 Integration
Architecture</a></summary><ul>
<li><a href="#display-connection-and-initialization" id="toc-display-connection-and-initialization"><span class="toc-section-number">19.2.1</span> 1.1 Display Connection and
Initialization</a></li>
<li><a href="#x-resources-and-xsettings" id="toc-x-resources-and-xsettings"><span class="toc-section-number">19.2.2</span> 1.2 X Resources and
XSETTINGS</a></li>
<li><a href="#toolkit-integration" id="toc-toolkit-integration"><span class="toc-section-number">19.2.3</span> 1.3 Toolkit
Integration</a></li>
<li><a href="#font-backends" id="toc-font-backends"><span class="toc-section-number">19.2.4</span> 1.4 Font Backends</a></li>
</ul></details></li>
<li><details><summary><a href="#graphics-and-rendering" id="toc-graphics-and-rendering"><span class="toc-section-number">19.3</span> 2. Graphics and Rendering</a></summary><ul>
<li><a href="#graphics-contexts-1" id="toc-graphics-contexts-1"><span class="toc-section-number">19.3.1</span> 2.1 Graphics Contexts</a></li>
<li><a href="#color-allocation" id="toc-color-allocation"><span class="toc-section-number">19.3.2</span> 2.2 Color Allocation</a></li>
<li><a href="#double-buffering" id="toc-double-buffering"><span class="toc-section-number">19.3.3</span> 2.3 Double Buffering</a></li>
<li><a href="#glyph-string-rendering" id="toc-glyph-string-rendering"><span class="toc-section-number">19.3.4</span> 2.4 Glyph String
Rendering</a></li>
<li><a href="#image-rendering" id="toc-image-rendering"><span class="toc-section-number">19.3.5</span> 2.5 Image Rendering</a></li>
</ul></details></li>
<li><details><summary><a href="#event-processing" id="toc-event-processing"><span class="toc-section-number">19.4</span> 3. Event Processing</a></summary><ul>
<li><a href="#event-loop-architecture-1" id="toc-event-loop-architecture-1"><span class="toc-section-number">19.4.1</span> 3.1 Event Loop
Architecture</a></li>
<li><a href="#event-translation---handle_one_xevent" id="toc-event-translation---handle_one_xevent"><span class="toc-section-number">19.4.2</span> 3.2 Event Translation -
handle_one_xevent</a></li>
<li><a href="#input-method-support-xim" id="toc-input-method-support-xim"><span class="toc-section-number">19.4.3</span> 3.3 Input Method Support
(XIM)</a></li>
<li><a href="#xinput2-extension" id="toc-xinput2-extension"><span class="toc-section-number">19.4.4</span> 3.4 XInput2 Extension</a></li>
</ul></details></li>
<li><details><summary><a href="#window-management" id="toc-window-management"><span class="toc-section-number">19.5</span> 4. Window Management</a></summary><ul>
<li><a href="#frame-creation" id="toc-frame-creation"><span class="toc-section-number">19.5.1</span> 4.1 Frame Creation</a></li>
<li><a href="#window-manager-hints" id="toc-window-manager-hints"><span class="toc-section-number">19.5.2</span> 4.2 Window Manager
Hints</a></li>
<li><a href="#desktop-integration" id="toc-desktop-integration"><span class="toc-section-number">19.5.3</span> 4.3 Desktop
Integration</a></li>
<li><a href="#multi-monitor-support" id="toc-multi-monitor-support"><span class="toc-section-number">19.5.4</span> 4.4 Multi-Monitor
Support</a></li>
</ul></details></li>
<li><details><summary><a href="#comparison-with-other-platforms" id="toc-comparison-with-other-platforms"><span class="toc-section-number">19.6</span> 5. Comparison with Other
Platforms</a></summary><ul>
<li><a href="#architecture-comparison" id="toc-architecture-comparison"><span class="toc-section-number">19.6.1</span> 5.1 Architecture
Comparison</a></li>
<li><a href="#event-processing-differences" id="toc-event-processing-differences"><span class="toc-section-number">19.6.2</span> 5.2 Event Processing
Differences</a></li>
<li><a href="#graphics-system-differences" id="toc-graphics-system-differences"><span class="toc-section-number">19.6.3</span> 5.3 Graphics System
Differences</a></li>
<li><a href="#font-system-differences" id="toc-font-system-differences"><span class="toc-section-number">19.6.4</span> 5.4 Font System
Differences</a></li>
<li><a href="#color-handling" id="toc-color-handling"><span class="toc-section-number">19.6.5</span> 5.5 Color Handling</a></li>
<li><a href="#clipboardselection" id="toc-clipboardselection"><span class="toc-section-number">19.6.6</span> 5.6
Clipboard/Selection</a></li>
<li><a href="#unique-x11-features" id="toc-unique-x11-features"><span class="toc-section-number">19.6.7</span> 5.7 Unique X11
Features</a></li>
<li><a href="#platform-specific-challenges" id="toc-platform-specific-challenges"><span class="toc-section-number">19.6.8</span> 5.8 Platform-Specific
Challenges</a></li>
</ul></details></li>
<li><details><summary><a href="#key-implementation-files" id="toc-key-implementation-files"><span class="toc-section-number">19.7</span> 6. Key Implementation Files</a></summary><ul>
<li><a href="#source-file-reference" id="toc-source-file-reference"><span class="toc-section-number">19.7.1</span> Source File Reference</a></li>
<li><a href="#header-dependencies" id="toc-header-dependencies"><span class="toc-section-number">19.7.2</span> Header Dependencies</a></li>
</ul></details></li>
<li><details><summary><a href="#configuration-and-build-options" id="toc-configuration-and-build-options"><span class="toc-section-number">19.8</span> 7. Configuration and Build
Options</a></summary><ul>
<li><a href="#x11-build-configuration" id="toc-x11-build-configuration"><span class="toc-section-number">19.8.1</span> X11 Build
Configuration</a></li>
<li><a href="#preprocessor-conditionals" id="toc-preprocessor-conditionals"><span class="toc-section-number">19.8.2</span> Preprocessor
Conditionals</a></li>
</ul></details></li>
<li><details><summary><a href="#performance-considerations-5" id="toc-performance-considerations-5"><span class="toc-section-number">19.9</span> 8. Performance Considerations</a></summary><ul>
<li><a href="#optimization-strategies-3" id="toc-optimization-strategies-3"><span class="toc-section-number">19.9.1</span> Optimization
Strategies</a></li>
<li><a href="#performance-tuning-1" id="toc-performance-tuning-1"><span class="toc-section-number">19.9.2</span> Performance Tuning</a></li>
</ul></details></li>
<li><details><summary><a href="#debugging-x11-issues" id="toc-debugging-x11-issues"><span class="toc-section-number">19.10</span> 9. Debugging X11 Issues</a></summary><ul>
<li><a href="#debug-tools-1" id="toc-debug-tools-1"><span class="toc-section-number">19.10.1</span> Debug Tools</a></li>
<li><a href="#common-issues-2" id="toc-common-issues-2"><span class="toc-section-number">19.10.2</span> Common Issues</a></li>
</ul></details></li>
<li><details><summary><a href="#future-directions-1" id="toc-future-directions-1"><span class="toc-section-number">19.11</span> 10. Future Directions</a></summary><ul>
<li><a href="#x11-evolution" id="toc-x11-evolution"><span class="toc-section-number">19.11.1</span> X11 Evolution</a></li>
<li><a href="#code-modernization" id="toc-code-modernization"><span class="toc-section-number">19.11.2</span> Code Modernization</a></li>
</ul></details></li>
<li><details><summary><a href="#references-4" id="toc-references-4"><span class="toc-section-number">19.12</span> 11. References</a></summary><ul>
<li><a href="#specifications" id="toc-specifications"><span class="toc-section-number">19.12.1</span> Specifications</a></li>
<li><a href="#source-documentation" id="toc-source-documentation"><span class="toc-section-number">19.12.2</span> Source Documentation</a></li>
<li><a href="#external-resources-1" id="toc-external-resources-1"><span class="toc-section-number">19.12.3</span> External Resources</a></li>
</ul></details></li>
</ul></details></li>
<li><details><summary><a href="#emacs-lisp-standard-library" id="toc-emacs-lisp-standard-library"><span class="toc-section-number">20</span> Emacs Lisp Standard Library</a></summary><ul>
<li><a href="#table-of-contents-8" id="toc-table-of-contents-8"><span class="toc-section-number">20.1</span> Table of Contents</a></li>
<li><details><summary><a href="#introduction-2" id="toc-introduction-2"><span class="toc-section-number">20.2</span> Introduction</a></summary><ul>
<li><a href="#design-philosophy-4" id="toc-design-philosophy-4"><span class="toc-section-number">20.2.1</span> Design Philosophy</a></li>
</ul></details></li>
<li><details><summary><a href="#core-utilities" id="toc-core-utilities"><span class="toc-section-number">20.3</span> Core Utilities</a></summary><ul>
<li><a href="#subr.el---fundamental-subroutines" id="toc-subr.el---fundamental-subroutines"><span class="toc-section-number">20.3.1</span> subr.el - Fundamental
Subroutines</a></li>
<li><a href="#simple.el---basic-editing-commands" id="toc-simple.el---basic-editing-commands"><span class="toc-section-number">20.3.2</span> simple.el - Basic Editing
Commands</a></li>
<li><a href="#files.el---file-operations" id="toc-files.el---file-operations"><span class="toc-section-number">20.3.3</span> files.el - File
Operations</a></li>
<li><a href="#window.el---window-management" id="toc-window.el---window-management"><span class="toc-section-number">20.3.4</span> window.el - Window
Management</a></li>
</ul></details></li>
<li><details><summary><a href="#data-structures" id="toc-data-structures"><span class="toc-section-number">20.4</span> Data Structures</a></summary><ul>
<li><a href="#seq.el---sequence-manipulation" id="toc-seq.el---sequence-manipulation"><span class="toc-section-number">20.4.1</span> seq.el - Sequence
Manipulation</a></li>
<li><a href="#map.el---mapdictionary-operations" id="toc-map.el---mapdictionary-operations"><span class="toc-section-number">20.4.2</span> map.el - Map/Dictionary
Operations</a></li>
<li><a href="#ring.el---ring-buffers" id="toc-ring.el---ring-buffers"><span class="toc-section-number">20.4.3</span> ring.el - Ring Buffers</a></li>
<li><a href="#avl-tree.el---balanced-binary-trees" id="toc-avl-tree.el---balanced-binary-trees"><span class="toc-section-number">20.4.4</span> avl-tree.el - Balanced Binary
Trees</a></li>
</ul></details></li>
<li><details><summary><a href="#completion-framework" id="toc-completion-framework"><span class="toc-section-number">20.5</span> Completion Framework</a></summary><ul>
<li><a href="#minibuffer.el---minibuffer-and-completion" id="toc-minibuffer.el---minibuffer-and-completion"><span class="toc-section-number">20.5.1</span> minibuffer.el - Minibuffer and
Completion</a></li>
</ul></details></li>
<li><details><summary><a href="#search-and-replace" id="toc-search-and-replace"><span class="toc-section-number">20.6</span> Search and Replace</a></summary><ul>
<li><a href="#isearch.el---incremental-search" id="toc-isearch.el---incremental-search"><span class="toc-section-number">20.6.1</span> isearch.el - Incremental
Search</a></li>
</ul></details></li>
<li><details><summary><a href="#help-system" id="toc-help-system"><span class="toc-section-number">20.7</span> Help System</a></summary><ul>
<li><a href="#help.el---help-commands" id="toc-help.el---help-commands"><span class="toc-section-number">20.7.1</span> help.el - Help
Commands</a></li>
</ul></details></li>
<li><details><summary><a href="#customization-1" id="toc-customization-1"><span class="toc-section-number">20.8</span> Customization</a></summary><ul>
<li><a href="#custom.el---customization-framework" id="toc-custom.el---customization-framework"><span class="toc-section-number">20.8.1</span> custom.el - Customization
Framework</a></li>
</ul></details></li>
<li><a href="#conclusion-6" id="toc-conclusion-6"><span class="toc-section-number">20.9</span> Conclusion</a></li>
<li><a href="#further-reading-5" id="toc-further-reading-5"><span class="toc-section-number">20.10</span> Further Reading</a></li>
</ul></details></li>
<li><details><summary><a href="#text-processing-search-and-regular-expressions" id="toc-text-processing-search-and-regular-expressions"><span class="toc-section-number">21</span> Text Processing: Search and Regular
Expressions</a></summary><ul>
<li><a href="#table-of-contents-9" id="toc-table-of-contents-9"><span class="toc-section-number">21.1</span> Table of Contents</a></li>
<li><details><summary><a href="#overview-9" id="toc-overview-9"><span class="toc-section-number">21.2</span> Overview</a></summary><ul>
<li><a href="#component-summary" id="toc-component-summary"><span class="toc-section-number">21.2.1</span> Component Summary</a></li>
<li><a href="#key-features-2" id="toc-key-features-2"><span class="toc-section-number">21.2.2</span> Key Features</a></li>
</ul></details></li>
<li><details><summary><a href="#search-system-architecture" id="toc-search-system-architecture"><span class="toc-section-number">21.3</span> Search System Architecture</a></summary><ul>
<li><a href="#file-srcsearch.c-3514-lines" id="toc-file-srcsearch.c-3514-lines"><span class="toc-section-number">21.3.1</span> File: <code>src/search.c</code>
(3,514 lines)</a></li>
<li><a href="#search-algorithms" id="toc-search-algorithms"><span class="toc-section-number">21.3.2</span> Search Algorithms</a></li>
<li><a href="#regex-pattern-cache" id="toc-regex-pattern-cache"><span class="toc-section-number">21.3.3</span> Regex Pattern Cache</a></li>
<li><a href="#search-functions-api" id="toc-search-functions-api"><span class="toc-section-number">21.3.4</span> Search Functions API</a></li>
</ul></details></li>
<li><details><summary><a href="#regular-expression-engine" id="toc-regular-expression-engine"><span class="toc-section-number">21.4</span> Regular Expression Engine</a></summary><ul>
<li><a href="#file-srcregex-emacs.c-5355-lines" id="toc-file-srcregex-emacs.c-5355-lines"><span class="toc-section-number">21.4.1</span> File:
<code>src/regex-emacs.c</code> (5,355 lines)</a></li>
<li><a href="#regex-opcodes" id="toc-regex-opcodes"><span class="toc-section-number">21.4.2</span> Regex Opcodes</a></li>
<li><a href="#pattern-compilation" id="toc-pattern-compilation"><span class="toc-section-number">21.4.3</span> Pattern Compilation</a></li>
<li><a href="#pattern-matching-1" id="toc-pattern-matching-1"><span class="toc-section-number">21.4.4</span> Pattern Matching</a></li>
<li><a href="#regex-pattern-buffer" id="toc-regex-pattern-buffer"><span class="toc-section-number">21.4.5</span> Regex Pattern Buffer</a></li>
<li><a href="#emacs-specific-extensions" id="toc-emacs-specific-extensions"><span class="toc-section-number">21.4.6</span> Emacs-Specific
Extensions</a></li>
<li><a href="#posix-vs.-emacs-backtracking" id="toc-posix-vs.-emacs-backtracking"><span class="toc-section-number">21.4.7</span> POSIX vs.¬†Emacs
Backtracking</a></li>
<li><a href="#performance-optimizations-2" id="toc-performance-optimizations-2"><span class="toc-section-number">21.4.8</span> Performance
Optimizations</a></li>
</ul></details></li>
<li><details><summary><a href="#syntax-tables" id="toc-syntax-tables"><span class="toc-section-number">21.5</span> Syntax Tables</a></summary><ul>
<li><a href="#file-srcsyntax.c-3831-lines" id="toc-file-srcsyntax.c-3831-lines"><span class="toc-section-number">21.5.1</span> File: <code>src/syntax.c</code>
(3,831 lines)</a></li>
<li><a href="#syntax-classes" id="toc-syntax-classes"><span class="toc-section-number">21.5.2</span> Syntax Classes</a></li>
<li><a href="#syntax-flags" id="toc-syntax-flags"><span class="toc-section-number">21.5.3</span> Syntax Flags</a></li>
<li><a href="#syntax-table-structure" id="toc-syntax-table-structure"><span class="toc-section-number">21.5.4</span> Syntax Table Structure</a></li>
<li><a href="#global-syntax-state" id="toc-global-syntax-state"><span class="toc-section-number">21.5.5</span> Global Syntax State</a></li>
<li><a href="#syntax-based-navigation" id="toc-syntax-based-navigation"><span class="toc-section-number">21.5.6</span> Syntax-Based
Navigation</a></li>
<li><a href="#comment-and-string-handling" id="toc-comment-and-string-handling"><span class="toc-section-number">21.5.7</span> Comment and String
Handling</a></li>
<li><a href="#syntax-properties" id="toc-syntax-properties"><span class="toc-section-number">21.5.8</span> Syntax Properties</a></li>
</ul></details></li>
<li><details><summary><a href="#case-handling" id="toc-case-handling"><span class="toc-section-number">21.6</span> Case Handling</a></summary><ul>
<li><a href="#file-srccasefiddle.c-764-lines" id="toc-file-srccasefiddle.c-764-lines"><span class="toc-section-number">21.6.1</span> File:
<code>src/casefiddle.c</code> (764 lines)</a></li>
<li><a href="#case-operations" id="toc-case-operations"><span class="toc-section-number">21.6.2</span> Case Operations</a></li>
<li><a href="#casing-context" id="toc-casing-context"><span class="toc-section-number">21.6.3</span> Casing Context</a></li>
<li><a href="#unicode-case-mapping" id="toc-unicode-case-mapping"><span class="toc-section-number">21.6.4</span> Unicode Case Mapping</a></li>
<li><a href="#greek-final-sigma" id="toc-greek-final-sigma"><span class="toc-section-number">21.6.5</span> Greek Final Sigma</a></li>
<li><a href="#word-boundaries" id="toc-word-boundaries"><span class="toc-section-number">21.6.6</span> Word Boundaries</a></li>
<li><a href="#buffer-case-operations" id="toc-buffer-case-operations"><span class="toc-section-number">21.6.7</span> Buffer Case Operations</a></li>
<li><a href="#api-functions" id="toc-api-functions"><span class="toc-section-number">21.6.8</span> API Functions</a></li>
</ul></details></li>
<li><details><summary><a href="#elisp-layer-1" id="toc-elisp-layer-1"><span class="toc-section-number">21.7</span> Elisp Layer</a></summary><ul>
<li><a href="#incremental-search-lispisearch.el" id="toc-incremental-search-lispisearch.el"><span class="toc-section-number">21.7.1</span> Incremental Search
(<code>lisp/isearch.el</code>)</a></li>
<li><a href="#regular-expression-builder-lispemacs-lispre-builder.el" id="toc-regular-expression-builder-lispemacs-lispre-builder.el"><span class="toc-section-number">21.7.2</span> Regular Expression Builder
(<code>lisp/emacs-lisp/re-builder.el</code>)</a></li>
<li><a href="#character-folding-lispchar-fold.el" id="toc-character-folding-lispchar-fold.el"><span class="toc-section-number">21.7.3</span> Character Folding
(<code>lisp/char-fold.el</code>)</a></li>
<li><a href="#integration-example" id="toc-integration-example"><span class="toc-section-number">21.7.4</span> Integration Example</a></li>
</ul></details></li>
<li><details><summary><a href="#integration-and-data-flow" id="toc-integration-and-data-flow"><span class="toc-section-number">21.8</span> Integration and Data Flow</a></summary><ul>
<li><a href="#search-flow-diagram" id="toc-search-flow-diagram"><span class="toc-section-number">21.8.1</span> Search Flow Diagram</a></li>
<li><a href="#key-integration-points" id="toc-key-integration-points"><span class="toc-section-number">21.8.2</span> Key Integration Points</a></li>
</ul></details></li>
<li><details><summary><a href="#performance-characteristics-4" id="toc-performance-characteristics-4"><span class="toc-section-number">21.9</span> Performance Characteristics</a></summary><ul>
<li><a href="#algorithm-complexity" id="toc-algorithm-complexity"><span class="toc-section-number">21.9.1</span> Algorithm Complexity</a></li>
<li><a href="#memory-usage-2" id="toc-memory-usage-2"><span class="toc-section-number">21.9.2</span> Memory Usage</a></li>
<li><a href="#optimization-strategies-4" id="toc-optimization-strategies-4"><span class="toc-section-number">21.9.3</span> Optimization
Strategies</a></li>
<li><a href="#performance-tips-for-users" id="toc-performance-tips-for-users"><span class="toc-section-number">21.9.4</span> Performance Tips for
Users</a></li>
</ul></details></li>
<li><details><summary><a href="#api-reference" id="toc-api-reference"><span class="toc-section-number">21.10</span> API Reference</a></summary><ul>
<li><a href="#c-functions" id="toc-c-functions"><span class="toc-section-number">21.10.1</span> C Functions</a></li>
<li><a href="#elisp-functions" id="toc-elisp-functions"><span class="toc-section-number">21.10.2</span> Elisp Functions</a></li>
</ul></details></li>
<li><a href="#related-documentation-1" id="toc-related-documentation-1"><span class="toc-section-number">21.11</span> Related Documentation</a></li>
<li><details><summary><a href="#references-5" id="toc-references-5"><span class="toc-section-number">21.12</span> References</a></summary><ul>
<li><a href="#source-files-1" id="toc-source-files-1"><span class="toc-section-number">21.12.1</span> Source Files</a></li>
<li><a href="#elisp-files" id="toc-elisp-files"><span class="toc-section-number">21.12.2</span> Elisp Files</a></li>
<li><a href="#documentation-1" id="toc-documentation-1"><span class="toc-section-number">21.12.3</span> Documentation</a></li>
<li><a href="#external-references" id="toc-external-references"><span class="toc-section-number">21.12.4</span> External References</a></li>
</ul></details></li>
</ul></details></li>
<li><details><summary><a href="#emacs-build-system-and-testing-infrastructure" id="toc-emacs-build-system-and-testing-infrastructure"><span class="toc-section-number">22</span> Emacs Build System and Testing
Infrastructure</a></summary><ul>
<li><a href="#table-of-contents-10" id="toc-table-of-contents-10"><span class="toc-section-number">22.1</span> Table of Contents</a></li>
<li><details><summary><a href="#build-system-architecture" id="toc-build-system-architecture"><span class="toc-section-number">22.2</span> 1. Build System Architecture</a></summary><ul>
<li><a href="#overview-10" id="toc-overview-10"><span class="toc-section-number">22.2.1</span> 1.1 Overview</a></li>
<li><a href="#autoconfautomake-architecture" id="toc-autoconfautomake-architecture"><span class="toc-section-number">22.2.2</span> 1.2 Autoconf/Automake
Architecture</a></li>
<li><a href="#building-from-source" id="toc-building-from-source"><span class="toc-section-number">22.2.3</span> 1.3 Building from
Source</a></li>
<li><a href="#configure-options" id="toc-configure-options"><span class="toc-section-number">22.2.4</span> 1.4 Configure Options</a></li>
<li><a href="#makefile.in-structure" id="toc-makefile.in-structure"><span class="toc-section-number">22.2.5</span> 1.5 Makefile.in
Structure</a></li>
<li><a href="#bootstrap-process" id="toc-bootstrap-process"><span class="toc-section-number">22.2.6</span> 1.6 Bootstrap Process</a></li>
<li><a href="#portable-dumper-pdumper" id="toc-portable-dumper-pdumper"><span class="toc-section-number">22.2.7</span> 1.7 Portable Dumper
(pdumper)</a></li>
<li><a href="#cross-compilation-support" id="toc-cross-compilation-support"><span class="toc-section-number">22.2.8</span> 1.8 Cross-Compilation
Support</a></li>
<li><a href="#native-compilation-4" id="toc-native-compilation-4"><span class="toc-section-number">22.2.9</span> 1.9 Native Compilation</a></li>
</ul></details></li>
<li><details><summary><a href="#testing-infrastructure" id="toc-testing-infrastructure"><span class="toc-section-number">22.3</span> 2. Testing Infrastructure</a></summary><ul>
<li><a href="#test-directory-structure" id="toc-test-directory-structure"><span class="toc-section-number">22.3.1</span> 2.1 Test Directory
Structure</a></li>
<li><a href="#ert-emacs-lisp-regression-testing" id="toc-ert-emacs-lisp-regression-testing"><span class="toc-section-number">22.3.2</span> 2.2 ERT (Emacs Lisp Regression
Testing)</a></li>
<li><a href="#running-tests" id="toc-running-tests"><span class="toc-section-number">22.3.3</span> 2.3 Running Tests</a></li>
<li><a href="#writing-new-tests" id="toc-writing-new-tests"><span class="toc-section-number">22.3.4</span> 2.4 Writing New Tests</a></li>
<li><a href="#test-makefile-details" id="toc-test-makefile-details"><span class="toc-section-number">22.3.5</span> 2.5 Test Makefile
Details</a></li>
</ul></details></li>
<li><details><summary><a href="#development-workflow" id="toc-development-workflow"><span class="toc-section-number">22.4</span> 3. Development Workflow</a></summary><ul>
<li><a href="#initial-setup" id="toc-initial-setup"><span class="toc-section-number">22.4.1</span> 3.1 Initial Setup</a></li>
<li><a href="#debugging-with-gdblldb" id="toc-debugging-with-gdblldb"><span class="toc-section-number">22.4.2</span> 3.2 Debugging with
GDB/LLDB</a></li>
<li><a href="#byte-compilation" id="toc-byte-compilation"><span class="toc-section-number">22.4.3</span> 3.3 Byte Compilation</a></li>
<li><a href="#native-compilation-5" id="toc-native-compilation-5"><span class="toc-section-number">22.4.4</span> 3.4 Native Compilation</a></li>
<li><a href="#documentation-generation" id="toc-documentation-generation"><span class="toc-section-number">22.4.5</span> 3.5 Documentation
Generation</a></li>
<li><a href="#release-process" id="toc-release-process"><span class="toc-section-number">22.4.6</span> 3.6 Release Process</a></li>
</ul></details></li>
<li><details><summary><a href="#quality-assurance" id="toc-quality-assurance"><span class="toc-section-number">22.5</span> 4. Quality Assurance</a></summary><ul>
<li><a href="#static-analysis-tools" id="toc-static-analysis-tools"><span class="toc-section-number">22.5.1</span> 4.1 Static Analysis
Tools</a></li>
<li><a href="#compiler-warnings" id="toc-compiler-warnings"><span class="toc-section-number">22.5.2</span> 4.2 Compiler Warnings</a></li>
<li><a href="#addresssanitizer-asan" id="toc-addresssanitizer-asan"><span class="toc-section-number">22.5.3</span> 4.3 AddressSanitizer
(ASan)</a></li>
<li><a href="#valgrind-support" id="toc-valgrind-support"><span class="toc-section-number">22.5.4</span> 4.4 Valgrind Support</a></li>
<li><a href="#code-coverage" id="toc-code-coverage"><span class="toc-section-number">22.5.5</span> 4.5 Code Coverage</a></li>
</ul></details></li>
<li><details><summary><a href="#platform-specific-information" id="toc-platform-specific-information"><span class="toc-section-number">22.6</span> 5. Platform-Specific
Information</a></summary><ul>
<li><a href="#unixlinux" id="toc-unixlinux"><span class="toc-section-number">22.6.1</span> 5.1 Unix/Linux</a></li>
<li><a href="#macos" id="toc-macos"><span class="toc-section-number">22.6.2</span> 5.2 macOS</a></li>
<li><a href="#windows-mingwmsys2" id="toc-windows-mingwmsys2"><span class="toc-section-number">22.6.3</span> 5.3 Windows
(MinGW/MSYS2)</a></li>
<li><a href="#android-2" id="toc-android-2"><span class="toc-section-number">22.6.4</span> 5.4 Android</a></li>
<li><a href="#ms-dos" id="toc-ms-dos"><span class="toc-section-number">22.6.5</span> 5.5 MS-DOS</a></li>
</ul></details></li>
<li><details><summary><a href="#continuous-integration" id="toc-continuous-integration"><span class="toc-section-number">22.7</span> 6. Continuous Integration</a></summary><ul>
<li><a href="#ci-platforms" id="toc-ci-platforms"><span class="toc-section-number">22.7.1</span> 6.1 CI Platforms</a></li>
<li><a href="#emba-gitlab-ci" id="toc-emba-gitlab-ci"><span class="toc-section-number">22.7.2</span> 6.2 Emba (GitLab CI)</a></li>
<li><a href="#hydra-nix-based" id="toc-hydra-nix-based"><span class="toc-section-number">22.7.3</span> 6.3 Hydra (Nix-based)</a></li>
<li><a href="#local-ci-testing" id="toc-local-ci-testing"><span class="toc-section-number">22.7.4</span> 6.4 Local CI Testing</a></li>
<li><a href="#ci-best-practices" id="toc-ci-best-practices"><span class="toc-section-number">22.7.5</span> 6.5 CI Best Practices</a></li>
</ul></details></li>
<li><details><summary><a href="#quick-reference" id="toc-quick-reference"><span class="toc-section-number">22.8</span> 7. Quick Reference</a></summary><ul>
<li><a href="#common-build-commands" id="toc-common-build-commands"><span class="toc-section-number">22.8.1</span> 7.1 Common Build
Commands</a></li>
<li><a href="#common-test-commands" id="toc-common-test-commands"><span class="toc-section-number">22.8.2</span> 7.2 Common Test
Commands</a></li>
<li><a href="#common-development-tasks" id="toc-common-development-tasks"><span class="toc-section-number">22.8.3</span> 7.3 Common Development
Tasks</a></li>
<li><a href="#common-configuration-options" id="toc-common-configuration-options"><span class="toc-section-number">22.8.4</span> 7.4 Common Configuration
Options</a></li>
</ul></details></li>
<li><details><summary><a href="#additional-resources" id="toc-additional-resources"><span class="toc-section-number">22.9</span> 8. Additional Resources</a></summary><ul>
<li><a href="#documentation-files" id="toc-documentation-files"><span class="toc-section-number">22.9.1</span> 8.1 Documentation
Files</a></li>
<li><a href="#online-resources" id="toc-online-resources"><span class="toc-section-number">22.9.2</span> 8.2 Online Resources</a></li>
<li><a href="#directories-to-know" id="toc-directories-to-know"><span class="toc-section-number">22.9.3</span> 8.3 Directories to
Know</a></li>
<li><a href="#key-make-variables" id="toc-key-make-variables"><span class="toc-section-number">22.9.4</span> 8.4 Key Make Variables</a></li>
</ul></details></li>
<li><details><summary><a href="#troubleshooting" id="toc-troubleshooting"><span class="toc-section-number">22.10</span> 9. Troubleshooting</a></summary><ul>
<li><a href="#build-issues" id="toc-build-issues"><span class="toc-section-number">22.10.1</span> 9.1 Build Issues</a></li>
<li><a href="#test-issues" id="toc-test-issues"><span class="toc-section-number">22.10.2</span> 9.2 Test Issues</a></li>
<li><a href="#platform-specific-issues" id="toc-platform-specific-issues"><span class="toc-section-number">22.10.3</span> 9.3 Platform-Specific
Issues</a></li>
</ul></details></li>
</ul></details></li>
<li><details><summary><a href="#evolution-of-coding-patterns-and-practices-in-emacs" id="toc-evolution-of-coding-patterns-and-practices-in-emacs"><span class="toc-section-number">23</span> Evolution of Coding Patterns and
Practices in Emacs</a></summary><ul>
<li><a href="#executive-summary-2" id="toc-executive-summary-2"><span class="toc-section-number">23.1</span> Executive Summary</a></li>
<li><details><summary><a href="#historical-timeline" id="toc-historical-timeline"><span class="toc-section-number">23.2</span> Historical Timeline</a></summary><ul>
<li><a href="#early-era-1985-1999-foundation-and-stability" id="toc-early-era-1985-1999-foundation-and-stability"><span class="toc-section-number">23.2.1</span> Early Era (1985-1999):
Foundation and Stability</a></li>
<li><a href="#modernization-era-2000-2011-version-control-and-standards" id="toc-modernization-era-2000-2011-version-control-and-standards"><span class="toc-section-number">23.2.2</span> Modernization Era (2000-2011):
Version Control and Standards</a></li>
<li><a href="#contemporary-era-2012-2025-performance-and-modern-features" id="toc-contemporary-era-2012-2025-performance-and-modern-features"><span class="toc-section-number">23.2.3</span> Contemporary Era (2012-2025):
Performance and Modern Features</a></li>
</ul></details></li>
<li><details><summary><a href="#coding-style-evolution" id="toc-coding-style-evolution"><span class="toc-section-number">23.3</span> Coding Style Evolution</a></summary><ul>
<li><a href="#c-code-patterns" id="toc-c-code-patterns"><span class="toc-section-number">23.3.1</span> C Code Patterns</a></li>
<li><a href="#elisp-code-evolution" id="toc-elisp-code-evolution"><span class="toc-section-number">23.3.2</span> Elisp Code Evolution</a></li>
</ul></details></li>
<li><details><summary><a href="#architectural-evolution" id="toc-architectural-evolution"><span class="toc-section-number">23.4</span> Architectural Evolution</a></summary><ul>
<li><a href="#major-subsystem-additions" id="toc-major-subsystem-additions"><span class="toc-section-number">23.4.1</span> Major Subsystem
Additions</a></li>
<li><a href="#refactoring-patterns" id="toc-refactoring-patterns"><span class="toc-section-number">23.4.2</span> Refactoring Patterns</a></li>
</ul></details></li>
<li><details><summary><a href="#deprecation-strategy" id="toc-deprecation-strategy"><span class="toc-section-number">23.5</span> Deprecation Strategy</a></summary><ul>
<li><a href="#systematic-obsolescence" id="toc-systematic-obsolescence"><span class="toc-section-number">23.5.1</span> Systematic
Obsolescence</a></li>
<li><a href="#version-tagging" id="toc-version-tagging"><span class="toc-section-number">23.5.2</span> Version Tagging</a></li>
</ul></details></li>
<li><details><summary><a href="#community-practices-evolution" id="toc-community-practices-evolution"><span class="toc-section-number">23.6</span> Community Practices Evolution</a></summary><ul>
<li><a href="#commit-message-standards" id="toc-commit-message-standards"><span class="toc-section-number">23.6.1</span> Commit Message
Standards</a></li>
<li><a href="#git-workflow-modern-era" id="toc-git-workflow-modern-era"><span class="toc-section-number">23.6.2</span> Git Workflow (Modern
Era)</a></li>
<li><a href="#bug-tracking-integration" id="toc-bug-tracking-integration"><span class="toc-section-number">23.6.3</span> Bug Tracking
Integration</a></li>
<li><a href="#testing-evolution" id="toc-testing-evolution"><span class="toc-section-number">23.6.4</span> Testing Evolution</a></li>
<li><a href="#documentation-standards" id="toc-documentation-standards"><span class="toc-section-number">23.6.5</span> Documentation
Standards</a></li>
<li><a href="#code-review-process" id="toc-code-review-process"><span class="toc-section-number">23.6.6</span> Code Review Process</a></li>
</ul></details></li>
<li><details><summary><a href="#technical-debt-management" id="toc-technical-debt-management"><span class="toc-section-number">23.7</span> Technical Debt Management</a></summary><ul>
<li><a href="#approaches-to-technical-debt" id="toc-approaches-to-technical-debt"><span class="toc-section-number">23.7.1</span> Approaches to Technical
Debt</a></li>
<li><a href="#backward-compatibility-principles" id="toc-backward-compatibility-principles"><span class="toc-section-number">23.7.2</span> Backward Compatibility
Principles</a></li>
</ul></details></li>
<li><details><summary><a href="#error-handling-evolution" id="toc-error-handling-evolution"><span class="toc-section-number">23.8</span> Error Handling Evolution</a></summary><ul>
<li><a href="#modern-error-patterns" id="toc-modern-error-patterns"><span class="toc-section-number">23.8.1</span> Modern Error Patterns</a></li>
<li><a href="#c-code-error-handling" id="toc-c-code-error-handling"><span class="toc-section-number">23.8.2</span> C Code Error Handling</a></li>
</ul></details></li>
<li><details><summary><a href="#key-transitions-analysis" id="toc-key-transitions-analysis"><span class="toc-section-number">23.9</span> Key Transitions Analysis</a></summary><ul>
<li><a href="#pre-git-to-git-2008-2014" id="toc-pre-git-to-git-2008-2014"><span class="toc-section-number">23.9.1</span> 1. Pre-Git to Git
(2008-2014)</a></li>
<li><a href="#lexical-binding-emacs-24-2012" id="toc-lexical-binding-emacs-24-2012"><span class="toc-section-number">23.9.2</span> 2. Lexical Binding (Emacs 24,
2012)</a></li>
<li><a href="#native-compilation-emacs-28-2021" id="toc-native-compilation-emacs-28-2021"><span class="toc-section-number">23.9.3</span> 3. Native Compilation (Emacs
28, 2021)</a></li>
<li><a href="#tree-sitter-integration-emacs-29-2022" id="toc-tree-sitter-integration-emacs-29-2022"><span class="toc-section-number">23.9.4</span> 4. Tree-sitter Integration
(Emacs 29, 2022)</a></li>
</ul></details></li>
<li><details><summary><a href="#documentation-practices-evolution" id="toc-documentation-practices-evolution"><span class="toc-section-number">23.10</span> Documentation Practices
Evolution</a></summary><ul>
<li><a href="#early-documentation" id="toc-early-documentation"><span class="toc-section-number">23.10.1</span> Early Documentation</a></li>
<li><a href="#modern-documentation" id="toc-modern-documentation"><span class="toc-section-number">23.10.2</span> Modern Documentation</a></li>
<li><a href="#comment-style-evolution" id="toc-comment-style-evolution"><span class="toc-section-number">23.10.3</span> Comment Style
Evolution</a></li>
</ul></details></li>
<li><details><summary><a href="#performance-evolution" id="toc-performance-evolution"><span class="toc-section-number">23.11</span> Performance Evolution</a></summary><ul>
<li><a href="#optimization-strategies-5" id="toc-optimization-strategies-5"><span class="toc-section-number">23.11.1</span> Optimization
Strategies</a></li>
</ul></details></li>
<li><details><summary><a href="#modern-development-tools-integration" id="toc-modern-development-tools-integration"><span class="toc-section-number">23.12</span> Modern Development Tools
Integration</a></summary><ul>
<li><a href="#sanitizers-and-debugging" id="toc-sanitizers-and-debugging"><span class="toc-section-number">23.12.1</span> 1. Sanitizers and
Debugging</a></li>
<li><a href="#continuous-integration-1" id="toc-continuous-integration-1"><span class="toc-section-number">23.12.2</span> 2. Continuous
Integration</a></li>
<li><a href="#package-management" id="toc-package-management"><span class="toc-section-number">23.12.3</span> 3. Package Management</a></li>
</ul></details></li>
<li><details><summary><a href="#lessons-learned" id="toc-lessons-learned"><span class="toc-section-number">23.13</span> Lessons Learned</a></summary><ul>
<li><a href="#incremental-change-philosophy" id="toc-incremental-change-philosophy"><span class="toc-section-number">23.13.1</span> 1. Incremental Change
Philosophy</a></li>
<li><a href="#documentation-as-first-class-citizen" id="toc-documentation-as-first-class-citizen"><span class="toc-section-number">23.13.2</span> 2. Documentation as
First-Class Citizen</a></li>
<li><a href="#testing-investment-pays-off" id="toc-testing-investment-pays-off"><span class="toc-section-number">23.13.3</span> 3. Testing Investment Pays
Off</a></li>
<li><a href="#platform-diversity-requires-discipline" id="toc-platform-diversity-requires-discipline"><span class="toc-section-number">23.13.4</span> 4. Platform Diversity Requires
Discipline</a></li>
<li><a href="#community-stewardship" id="toc-community-stewardship"><span class="toc-section-number">23.13.5</span> 5. Community
Stewardship</a></li>
</ul></details></li>
<li><details><summary><a href="#current-state-2025" id="toc-current-state-2025"><span class="toc-section-number">23.14</span> Current State (2025)</a></summary><ul>
<li><a href="#codebase-statistics" id="toc-codebase-statistics"><span class="toc-section-number">23.14.1</span> Codebase Statistics</a></li>
<li><a href="#modern-features" id="toc-modern-features"><span class="toc-section-number">23.14.2</span> Modern Features</a></li>
<li><a href="#development-practices" id="toc-development-practices"><span class="toc-section-number">23.14.3</span> Development Practices</a></li>
<li><a href="#community-health" id="toc-community-health"><span class="toc-section-number">23.14.4</span> Community Health</a></li>
</ul></details></li>
<li><details><summary><a href="#future-directions-2" id="toc-future-directions-2"><span class="toc-section-number">23.15</span> Future Directions</a></summary><ul>
<li><a href="#emerging-patterns" id="toc-emerging-patterns"><span class="toc-section-number">23.15.1</span> Emerging Patterns</a></li>
<li><a href="#technical-debt-areas" id="toc-technical-debt-areas"><span class="toc-section-number">23.15.2</span> Technical Debt Areas</a></li>
<li><a href="#opportunities" id="toc-opportunities"><span class="toc-section-number">23.15.3</span> Opportunities</a></li>
</ul></details></li>
<li><a href="#conclusion-7" id="toc-conclusion-7"><span class="toc-section-number">23.16</span> Conclusion</a></li>
<li><details><summary><a href="#references-6" id="toc-references-6"><span class="toc-section-number">23.17</span> References</a></summary><ul>
<li><a href="#primary-sources-1" id="toc-primary-sources-1"><span class="toc-section-number">23.17.1</span> Primary Sources</a></li>
<li><a href="#key-files-analyzed" id="toc-key-files-analyzed"><span class="toc-section-number">23.17.2</span> Key Files Analyzed</a></li>
<li><a href="#development-infrastructure" id="toc-development-infrastructure"><span class="toc-section-number">23.17.3</span> Development
Infrastructure</a></li>
</ul></details></li>
</ul></details></li>
<li><details><summary><a href="#technology-industry-trends-and-emacs-evolution" id="toc-technology-industry-trends-and-emacs-evolution"><span class="toc-section-number">24</span> Technology Industry Trends and
Emacs Evolution</a></summary><ul>
<li><a href="#table-of-contents-11" id="toc-table-of-contents-11"><span class="toc-section-number">24.1</span> Table of Contents</a></li>
<li><details><summary><a href="#the-lisp-machine-era-1970s-1980s" id="toc-the-lisp-machine-era-1970s-1980s"><span class="toc-section-number">24.2</span> The Lisp Machine Era
(1970s-1980s)</a></summary><ul>
<li><a href="#industry-context" id="toc-industry-context"><span class="toc-section-number">24.2.1</span> Industry Context</a></li>
<li><a href="#why-emacs-is-a-lisp-machine-for-text" id="toc-why-emacs-is-a-lisp-machine-for-text"><span class="toc-section-number">24.2.2</span> Why Emacs is ‚ÄúA Lisp Machine
for Text‚Äù</a></li>
<li><a href="#the-decline-of-lisp-machines-and-emacss-preservation" id="toc-the-decline-of-lisp-machines-and-emacss-preservation"><span class="toc-section-number">24.2.3</span> The Decline of Lisp Machines
and Emacs‚Äôs Preservation</a></li>
</ul></details></li>
<li><details><summary><a href="#the-unix-wars-and-portability-1980s-1990s" id="toc-the-unix-wars-and-portability-1980s-1990s"><span class="toc-section-number">24.3</span> the Unix Wars and Portability
(1980s-1990s)</a></summary><ul>
<li><a href="#industry-context-1" id="toc-industry-context-1"><span class="toc-section-number">24.3.1</span> Industry Context</a></li>
<li><a href="#why-emacs-needed-cross-platform-support" id="toc-why-emacs-needed-cross-platform-support"><span class="toc-section-number">24.3.2</span> Why Emacs Needed Cross-Platform
Support</a></li>
<li><a href="#gnu-project-context-and-free-software-philosophy" id="toc-gnu-project-context-and-free-software-philosophy"><span class="toc-section-number">24.3.3</span> GNU Project Context and Free
Software Philosophy</a></li>
<li><a href="#competition-with-vivim" id="toc-competition-with-vivim"><span class="toc-section-number">24.3.4</span> Competition with
vi/vim</a></li>
<li><a href="#x-window-system-adoption" id="toc-x-window-system-adoption"><span class="toc-section-number">24.3.5</span> X Window System
Adoption</a></li>
</ul></details></li>
<li><details><summary><a href="#the-rise-of-ides-1990s-2000s" id="toc-the-rise-of-ides-1990s-2000s"><span class="toc-section-number">24.4</span> The Rise of IDEs
(1990s-2000s)</a></summary><ul>
<li><a href="#industry-context-2" id="toc-industry-context-2"><span class="toc-section-number">24.4.1</span> Industry Context</a></li>
<li><a href="#why-emacs-added-ide-like-features-cedet" id="toc-why-emacs-added-ide-like-features-cedet"><span class="toc-section-number">24.4.2</span> Why Emacs Added IDE-like
Features (CEDET)</a></li>
<li><a href="#the-tags-vs-semantic-parsing-debate" id="toc-the-tags-vs-semantic-parsing-debate"><span class="toc-section-number">24.4.3</span> The Tags vs Semantic Parsing
Debate</a></li>
<li><a href="#integration-vs-extensibility-tradeoffs" id="toc-integration-vs-extensibility-tradeoffs"><span class="toc-section-number">24.4.4</span> Integration vs Extensibility
Tradeoffs</a></li>
</ul></details></li>
<li><details><summary><a href="#the-web-era-2000s-2010s" id="toc-the-web-era-2000s-2010s"><span class="toc-section-number">24.5</span> The Web Era (2000s-2010s)</a></summary><ul>
<li><a href="#industry-context-3" id="toc-industry-context-3"><span class="toc-section-number">24.5.1</span> Industry Context</a></li>
<li><a href="#why-emacs-needed-web-browsing-eww" id="toc-why-emacs-needed-web-browsing-eww"><span class="toc-section-number">24.5.2</span> Why Emacs Needed Web Browsing
(eww)</a></li>
<li><a href="#javascript-and-web-development-modes" id="toc-javascript-and-web-development-modes"><span class="toc-section-number">24.5.3</span> JavaScript and Web Development
Modes</a></li>
<li><a href="#cloud-synchronization-gnus-cloud" id="toc-cloud-synchronization-gnus-cloud"><span class="toc-section-number">24.5.4</span> Cloud Synchronization (Gnus
Cloud)</a></li>
<li><a href="#network-protocols-and-apis" id="toc-network-protocols-and-apis"><span class="toc-section-number">24.5.5</span> Network Protocols and
APIs</a></li>
</ul></details></li>
<li><details><summary><a href="#the-language-server-protocol-revolution-2016-present" id="toc-the-language-server-protocol-revolution-2016-present"><span class="toc-section-number">24.6</span> The Language Server Protocol
Revolution (2016-present)</a></summary><ul>
<li><a href="#industry-context-microsofts-lsp-and-why-it-matters" id="toc-industry-context-microsofts-lsp-and-why-it-matters"><span class="toc-section-number">24.6.1</span> Industry Context: Microsoft‚Äôs
LSP and Why It Matters</a></li>
<li><a href="#eglot-vs-cedet-architectural-shift" id="toc-eglot-vs-cedet-architectural-shift"><span class="toc-section-number">24.6.2</span> Eglot vs CEDET: Architectural
Shift</a></li>
<li><a href="#industry-standardization-benefits" id="toc-industry-standardization-benefits"><span class="toc-section-number">24.6.3</span> Industry Standardization
Benefits</a></li>
<li><a href="#tree-sitter-and-modern-parsing" id="toc-tree-sitter-and-modern-parsing"><span class="toc-section-number">24.6.4</span> Tree-sitter and Modern
Parsing</a></li>
</ul></details></li>
<li><details><summary><a href="#mobile-computing-2010s-2020s" id="toc-mobile-computing-2010s-2020s"><span class="toc-section-number">24.7</span> Mobile Computing
(2010s-2020s)</a></summary><ul>
<li><a href="#industry-context-4" id="toc-industry-context-4"><span class="toc-section-number">24.7.1</span> Industry Context</a></li>
<li><a href="#android-port-why-and-how" id="toc-android-port-why-and-how"><span class="toc-section-number">24.7.2</span> Android Port: Why and
How</a></li>
<li><a href="#touch-screen-support" id="toc-touch-screen-support"><span class="toc-section-number">24.7.3</span> Touch Screen Support</a></li>
<li><a href="#challenges-of-mobile-emacs" id="toc-challenges-of-mobile-emacs"><span class="toc-section-number">24.7.4</span> Challenges of Mobile
Emacs</a></li>
</ul></details></li>
<li><details><summary><a href="#performance-wars-2010s-2020s" id="toc-performance-wars-2010s-2020s"><span class="toc-section-number">24.8</span> Performance Wars
(2010s-2020s)</a></summary><ul>
<li><a href="#industry-context-jit-compilation-trends" id="toc-industry-context-jit-compilation-trends"><span class="toc-section-number">24.8.1</span> Industry Context: JIT
Compilation Trends</a></li>
<li><a href="#native-compilation-via-libgccjit" id="toc-native-compilation-via-libgccjit"><span class="toc-section-number">24.8.2</span> Native Compilation via
libgccjit</a></li>
<li><a href="#why-performance-suddenly-mattered-more" id="toc-why-performance-suddenly-mattered-more"><span class="toc-section-number">24.8.3</span> Why Performance Suddenly
Mattered More</a></li>
<li><a href="#electron-and-resource-usage-debates" id="toc-electron-and-resource-usage-debates"><span class="toc-section-number">24.8.4</span> Electron and Resource Usage
Debates</a></li>
</ul></details></li>
<li><details><summary><a href="#modern-development-practices" id="toc-modern-development-practices"><span class="toc-section-number">24.9</span> Modern Development Practices</a></summary><ul>
<li><a href="#git-dominance-and-vc-system-evolution" id="toc-git-dominance-and-vc-system-evolution"><span class="toc-section-number">24.9.1</span> Git Dominance and VC System
Evolution</a></li>
<li><a href="#package-management-standardization-elpa" id="toc-package-management-standardization-elpa"><span class="toc-section-number">24.9.2</span> Package Management
Standardization (ELPA)</a></li>
<li><a href="#testing-culture-ert-framework" id="toc-testing-culture-ert-framework"><span class="toc-section-number">24.9.3</span> Testing Culture (ERT
Framework)</a></li>
<li><a href="#continuous-integration-2" id="toc-continuous-integration-2"><span class="toc-section-number">24.9.4</span> Continuous Integration</a></li>
</ul></details></li>
<li><details><summary><a href="#synthesis-emacs-as-technology-survivor" id="toc-synthesis-emacs-as-technology-survivor"><span class="toc-section-number">24.10</span> Synthesis: Emacs as Technology
Survivor</a></summary><ul>
<li><a href="#themes-across-eras" id="toc-themes-across-eras"><span class="toc-section-number">24.10.1</span> Themes Across Eras</a></li>
<li><a href="#success-and-failure-metrics" id="toc-success-and-failure-metrics"><span class="toc-section-number">24.10.2</span> Success and Failure
Metrics</a></li>
<li><a href="#future-trends-and-emacss-position" id="toc-future-trends-and-emacss-position"><span class="toc-section-number">24.10.3</span> Future Trends and Emacs‚Äôs
Position</a></li>
<li><a href="#the-editor-wars-historical-perspective" id="toc-the-editor-wars-historical-perspective"><span class="toc-section-number">24.10.4</span> The Editor Wars: Historical
Perspective</a></li>
</ul></details></li>
<li><a href="#conclusion-8" id="toc-conclusion-8"><span class="toc-section-number">24.11</span> Conclusion</a></li>
<li><details><summary><a href="#references-and-further-reading" id="toc-references-and-further-reading"><span class="toc-section-number">24.12</span> References and Further
Reading</a></summary><ul>
<li><a href="#academic-papers" id="toc-academic-papers"><span class="toc-section-number">24.12.1</span> Academic Papers</a></li>
<li><a href="#historical-documents" id="toc-historical-documents"><span class="toc-section-number">24.12.2</span> Historical Documents</a></li>
<li><a href="#industry-analysis" id="toc-industry-analysis"><span class="toc-section-number">24.12.3</span> Industry Analysis</a></li>
<li><a href="#key-figures" id="toc-key-figures"><span class="toc-section-number">24.12.4</span> Key Figures</a></li>
<li><a href="#web-resources" id="toc-web-resources"><span class="toc-section-number">24.12.5</span> Web Resources</a></li>
</ul></details></li>
</ul></details></li>
<li><details><summary><a href="#chapter-20-comparative-analysis" id="toc-chapter-20-comparative-analysis"><span class="toc-section-number">25</span> Chapter 20: Comparative
Analysis</a></summary><ul>
<li><a href="#overview-12" id="toc-overview-12"><span class="toc-section-number">25.1</span> Overview</a></li>
<li><a href="#purpose-1" id="toc-purpose-1"><span class="toc-section-number">25.2</span> Purpose</a></li>
<li><details><summary><a href="#chapter-contents" id="toc-chapter-contents"><span class="toc-section-number">25.3</span> Chapter Contents</a></summary><ul>
<li><a href="#editor-comparison.md" id="toc-editor-comparison.md"><span class="toc-section-number">25.3.1</span>
01-editor-comparison.md</a></li>
</ul></details></li>
<li><details><summary><a href="#key-themes" id="toc-key-themes"><span class="toc-section-number">25.4</span> Key Themes</a></summary><ul>
<li><a href="#no-best-editor" id="toc-no-best-editor"><span class="toc-section-number">25.4.1</span> 1. No ‚ÄúBest‚Äù Editor</a></li>
<li><a href="#fundamental-tradeoffs" id="toc-fundamental-tradeoffs"><span class="toc-section-number">25.4.2</span> 2. Fundamental
Tradeoffs</a></li>
<li><a href="#convergent-evolution" id="toc-convergent-evolution"><span class="toc-section-number">25.4.3</span> 3. Convergent
Evolution</a></li>
<li><a href="#persistent-differences" id="toc-persistent-differences"><span class="toc-section-number">25.4.4</span> 4. Persistent
Differences</a></li>
</ul></details></li>
<li><a href="#learning-objectives-2" id="toc-learning-objectives-2"><span class="toc-section-number">25.5</span> Learning Objectives</a></li>
<li><a href="#target-audience" id="toc-target-audience"><span class="toc-section-number">25.6</span> Target Audience</a></li>
<li><a href="#reading-prerequisites" id="toc-reading-prerequisites"><span class="toc-section-number">25.7</span> Reading Prerequisites</a></li>
<li><a href="#recommended-reading-order" id="toc-recommended-reading-order"><span class="toc-section-number">25.8</span> Recommended Reading
Order</a></li>
<li><a href="#related-chapters-1" id="toc-related-chapters-1"><span class="toc-section-number">25.9</span> Related Chapters</a></li>
<li><a href="#key-insights-preview" id="toc-key-insights-preview"><span class="toc-section-number">25.10</span> Key Insights Preview</a></li>
<li><a href="#philosophical-framework" id="toc-philosophical-framework"><span class="toc-section-number">25.11</span> Philosophical Framework</a></li>
<li><a href="#document-statistics" id="toc-document-statistics"><span class="toc-section-number">25.12</span> Document Statistics</a></li>
<li><a href="#how-to-use-this-chapter" id="toc-how-to-use-this-chapter"><span class="toc-section-number">25.13</span> How to Use This Chapter</a></li>
<li><a href="#contributing" id="toc-contributing"><span class="toc-section-number">25.14</span> Contributing</a></li>
</ul></details></li>
<li><details><summary><a href="#editor-comparison-emacs-and-the-evolution-of-text-editing" id="toc-editor-comparison-emacs-and-the-evolution-of-text-editing"><span class="toc-section-number">26</span> Editor Comparison: Emacs and the
Evolution of Text Editing</a></summary><ul>
<li><a href="#executive-summary-3" id="toc-executive-summary-3"><span class="toc-section-number">26.1</span> Executive Summary</a></li>
<li><details><summary><a href="#vivim-the-minimalist-alternative" id="toc-vivim-the-minimalist-alternative"><span class="toc-section-number">26.2</span> 1. Vi/Vim: The Minimalist
Alternative</a></summary><ul>
<li><a href="#historical-context-and-philosophy" id="toc-historical-context-and-philosophy"><span class="toc-section-number">26.2.1</span> 1.1 Historical Context and
Philosophy</a></li>
<li><a href="#modal-vs.-modeless-editing" id="toc-modal-vs.-modeless-editing"><span class="toc-section-number">26.2.2</span> 1.2 Modal vs.¬†Modeless
Editing</a></li>
<li><a href="#extension-languages-vimscript-vs.-elisp" id="toc-extension-languages-vimscript-vs.-elisp"><span class="toc-section-number">26.2.3</span> 1.3 Extension Languages:
Vimscript vs.¬†Elisp</a></li>
<li><a href="#startup-time-and-resource-usage" id="toc-startup-time-and-resource-usage"><span class="toc-section-number">26.2.4</span> 1.4 Startup Time and Resource
Usage</a></li>
<li><a href="#why-both-survived-different-optimization-targets" id="toc-why-both-survived-different-optimization-targets"><span class="toc-section-number">26.2.5</span> 1.5 Why Both Survived:
Different Optimization Targets</a></li>
<li><a href="#technical-innovations-from-each" id="toc-technical-innovations-from-each"><span class="toc-section-number">26.2.6</span> 1.6 Technical Innovations from
Each</a></li>
</ul></details></li>
<li><details><summary><a href="#modern-editors-vscode-sublime-text-atom" id="toc-modern-editors-vscode-sublime-text-atom"><span class="toc-section-number">26.3</span> 2. Modern Editors: VSCode,
Sublime Text, Atom</a></summary><ul>
<li><a href="#the-new-generation-2008-2015" id="toc-the-new-generation-2008-2015"><span class="toc-section-number">26.3.1</span> 2.1 The New Generation
(2008-2015)</a></li>
<li><a href="#extension-architecture-comparison" id="toc-extension-architecture-comparison"><span class="toc-section-number">26.3.2</span> 2.2 Extension Architecture
Comparison</a></li>
<li><a href="#performance-characteristics-5" id="toc-performance-characteristics-5"><span class="toc-section-number">26.3.3</span> 2.3 Performance
Characteristics</a></li>
<li><a href="#language-server-protocol-the-great-convergence" id="toc-language-server-protocol-the-great-convergence"><span class="toc-section-number">26.3.4</span> 2.4 Language Server Protocol:
The Great Convergence</a></li>
<li><a href="#web-technology-integration" id="toc-web-technology-integration"><span class="toc-section-number">26.3.5</span> 2.5 Web Technology
Integration</a></li>
<li><a href="#market-success-factors" id="toc-market-success-factors"><span class="toc-section-number">26.3.6</span> 2.6 Market Success
Factors</a></li>
</ul></details></li>
<li><details><summary><a href="#integrated-development-environments-ides" id="toc-integrated-development-environments-ides"><span class="toc-section-number">26.4</span> 3. Integrated Development
Environments (IDEs)</a></summary><ul>
<li><a href="#philosophy-language-specific-vs.-language-agnostic" id="toc-philosophy-language-specific-vs.-language-agnostic"><span class="toc-section-number">26.4.1</span> 3.1 Philosophy:
Language-Specific vs.¬†Language-Agnostic</a></li>
<li><a href="#project-management-approaches" id="toc-project-management-approaches"><span class="toc-section-number">26.4.2</span> 3.2 Project Management
Approaches</a></li>
<li><a href="#refactoring-capabilities" id="toc-refactoring-capabilities"><span class="toc-section-number">26.4.3</span> 3.3 Refactoring
Capabilities</a></li>
<li><a href="#debugging-integration" id="toc-debugging-integration"><span class="toc-section-number">26.4.4</span> 3.4 Debugging
Integration</a></li>
<li><a href="#emacss-unique-strengths-vs.-ides" id="toc-emacss-unique-strengths-vs.-ides"><span class="toc-section-number">26.4.5</span> 3.5 Emacs‚Äôs Unique Strengths
vs.¬†IDEs</a></li>
<li><a href="#when-to-choose-what" id="toc-when-to-choose-what"><span class="toc-section-number">26.4.6</span> 3.6 When to Choose
What</a></li>
</ul></details></li>
<li><details><summary><a href="#cloud-editors-and-remote-development" id="toc-cloud-editors-and-remote-development"><span class="toc-section-number">26.5</span> 4. Cloud Editors and Remote
Development</a></summary><ul>
<li><a href="#the-shift-to-remote-computing" id="toc-the-shift-to-remote-computing"><span class="toc-section-number">26.5.1</span> 4.1 The Shift to Remote
Computing</a></li>
<li><a href="#cloud-editor-solutions" id="toc-cloud-editor-solutions"><span class="toc-section-number">26.5.2</span> 4.2 Cloud Editor
Solutions</a></li>
<li><a href="#local-vs.-remote-the-fundamental-tradeoff" id="toc-local-vs.-remote-the-fundamental-tradeoff"><span class="toc-section-number">26.5.3</span> 4.3 Local vs.¬†Remote: The
Fundamental Tradeoff</a></li>
<li><a href="#collaboration-features" id="toc-collaboration-features"><span class="toc-section-number">26.5.4</span> 4.4 Collaboration
Features</a></li>
<li><a href="#resource-models" id="toc-resource-models"><span class="toc-section-number">26.5.5</span> 4.5 Resource Models</a></li>
<li><a href="#the-future-hybrid-models" id="toc-the-future-hybrid-models"><span class="toc-section-number">26.5.6</span> 4.6 The Future: Hybrid
Models</a></li>
</ul></details></li>
<li><details><summary><a href="#historical-editors-learning-from-lineage" id="toc-historical-editors-learning-from-lineage"><span class="toc-section-number">26.6</span> 5. Historical Editors: Learning
from Lineage</a></summary><ul>
<li><a href="#teco-the-primordial-text-editor" id="toc-teco-the-primordial-text-editor"><span class="toc-section-number">26.6.1</span> 5.1 TECO: The Primordial Text
Editor</a></li>
<li><a href="#eine-and-zwei-lisp-machine-emacs" id="toc-eine-and-zwei-lisp-machine-emacs"><span class="toc-section-number">26.6.2</span> 5.2 EINE and ZWEI: Lisp Machine
EMACS</a></li>
<li><a href="#gosling-emacs-the-unix-compromise" id="toc-gosling-emacs-the-unix-compromise"><span class="toc-section-number">26.6.3</span> 5.3 Gosling Emacs: The Unix
Compromise</a></li>
<li><a href="#multics-emacs-multi-user-editing" id="toc-multics-emacs-multi-user-editing"><span class="toc-section-number">26.6.4</span> 5.4 Multics Emacs: Multi-User
Editing</a></li>
<li><a href="#evolution-timeline-what-was-preserved" id="toc-evolution-timeline-what-was-preserved"><span class="toc-section-number">26.6.5</span> 5.5 Evolution Timeline: What
Was Preserved</a></li>
<li><a href="#architectural-lessons-from-history" id="toc-architectural-lessons-from-history"><span class="toc-section-number">26.6.6</span> 5.6 Architectural Lessons from
History</a></li>
</ul></details></li>
<li><details><summary><a href="#cross-cutting-lessons-and-insights" id="toc-cross-cutting-lessons-and-insights"><span class="toc-section-number">26.7</span> 6. Cross-Cutting Lessons and
Insights</a></summary><ul>
<li><a href="#the-extensibility-performance-tradeoff" id="toc-the-extensibility-performance-tradeoff"><span class="toc-section-number">26.7.1</span> 6.1 The
Extensibility-Performance Tradeoff</a></li>
<li><a href="#the-keyboard-vs.-mouse-paradigm" id="toc-the-keyboard-vs.-mouse-paradigm"><span class="toc-section-number">26.7.2</span> 6.2 The Keyboard vs.¬†Mouse
Paradigm</a></li>
<li><a href="#the-monolith-vs.-microservices-debate" id="toc-the-monolith-vs.-microservices-debate"><span class="toc-section-number">26.7.3</span> 6.3 The Monolith
vs.¬†Microservices Debate</a></li>
<li><a href="#the-documentation-philosophy" id="toc-the-documentation-philosophy"><span class="toc-section-number">26.7.4</span> 6.4 The Documentation
Philosophy</a></li>
<li><a href="#the-configuration-explosion-problem" id="toc-the-configuration-explosion-problem"><span class="toc-section-number">26.7.5</span> 6.5 The Configuration Explosion
Problem</a></li>
<li><a href="#why-users-choose-one-over-another" id="toc-why-users-choose-one-over-another"><span class="toc-section-number">26.7.6</span> 6.6 Why Users Choose One Over
Another</a></li>
</ul></details></li>
<li><details><summary><a href="#the-future-convergence-and-divergence" id="toc-the-future-convergence-and-divergence"><span class="toc-section-number">26.8</span> 7. The Future: Convergence and
Divergence</a></summary><ul>
<li><a href="#convergent-evolution-1" id="toc-convergent-evolution-1"><span class="toc-section-number">26.8.1</span> 7.1 Convergent
Evolution</a></li>
<li><a href="#persistent-differences-1" id="toc-persistent-differences-1"><span class="toc-section-number">26.8.2</span> 7.2 Persistent
Differences</a></li>
<li><a href="#what-emacs-can-learn-from-others" id="toc-what-emacs-can-learn-from-others"><span class="toc-section-number">26.8.3</span> 7.3 What Emacs Can Learn from
Others</a></li>
<li><a href="#what-others-can-learn-from-emacs" id="toc-what-others-can-learn-from-emacs"><span class="toc-section-number">26.8.4</span> 7.4 What Others Can Learn from
Emacs</a></li>
</ul></details></li>
<li><details><summary><a href="#conclusion-learning-from-diversity" id="toc-conclusion-learning-from-diversity"><span class="toc-section-number">26.9</span> 8. Conclusion: Learning from
Diversity</a></summary><ul>
<li><a href="#there-is-no-best-editor" id="toc-there-is-no-best-editor"><span class="toc-section-number">26.9.1</span> 8.1 There Is No ‚ÄúBest‚Äù
Editor</a></li>
<li><a href="#architectural-insights" id="toc-architectural-insights"><span class="toc-section-number">26.9.2</span> 8.2 Architectural
Insights</a></li>
<li><a href="#practical-recommendations" id="toc-practical-recommendations"><span class="toc-section-number">26.9.3</span> 8.3 Practical
Recommendations</a></li>
<li><a href="#final-thoughts" id="toc-final-thoughts"><span class="toc-section-number">26.9.4</span> 8.4 Final Thoughts</a></li>
</ul></details></li>
<li><a href="#references-and-further-reading-1" id="toc-references-and-further-reading-1"><span class="toc-section-number">26.10</span> References and Further
Reading</a></li>
</ul></details></li>
<li><details><summary><a href="#emacs-terminology-glossary" id="toc-emacs-terminology-glossary"><span class="toc-section-number">27</span> Emacs Terminology Glossary</a></summary><ul>
<li><details><summary><a href="#a" id="toc-a"><span class="toc-section-number">27.1</span>
A</a></summary><ul>
<li><a href="#abbrev-core-system" id="toc-abbrev-core-system"><span class="toc-section-number">27.1.1</span> Abbrev <code>[Core]</code>
<code>[System]</code></a></li>
<li><a href="#abstraction-barrier-lisp" id="toc-abstraction-barrier-lisp"><span class="toc-section-number">27.1.2</span> Abstraction Barrier
<code>[Lisp]</code></a></li>
<li><a href="#active-keymap-core" id="toc-active-keymap-core"><span class="toc-section-number">27.1.3</span> Active Keymap
<code>[Core]</code></a></li>
<li><a href="#active-region-core" id="toc-active-region-core"><span class="toc-section-number">27.1.4</span> Active Region
<code>[Core]</code></a></li>
<li><a href="#advice-system" id="toc-advice-system"><span class="toc-section-number">27.1.5</span> Advice
<code>[System]</code></a></li>
<li><a href="#advice-combinator-lisp" id="toc-advice-combinator-lisp"><span class="toc-section-number">27.1.6</span> Advice Combinator
<code>[Lisp]</code></a></li>
<li><a href="#after-change-function-system" id="toc-after-change-function-system"><span class="toc-section-number">27.1.7</span> After-Change Function
<code>[System]</code></a></li>
<li><a href="#after-string-display" id="toc-after-string-display"><span class="toc-section-number">27.1.8</span> After String
<code>[Display]</code></a></li>
<li><a href="#ansi-escape-sequence-display" id="toc-ansi-escape-sequence-display"><span class="toc-section-number">27.1.9</span> ANSI Escape Sequence
<code>[Display]</code></a></li>
<li><a href="#alist-data" id="toc-alist-data"><span class="toc-section-number">27.1.10</span> Alist
<code>[Data]</code></a></li>
<li><a href="#apropos-core" id="toc-apropos-core"><span class="toc-section-number">27.1.11</span> Apropos
<code>[Core]</code></a></li>
<li><a href="#arc-mode-core" id="toc-arc-mode-core"><span class="toc-section-number">27.1.12</span> Arc Mode
<code>[Core]</code></a></li>
<li><a href="#argument-list-lisp" id="toc-argument-list-lisp"><span class="toc-section-number">27.1.13</span> Argument List
<code>[Lisp]</code></a></li>
<li><a href="#ascii-system" id="toc-ascii-system"><span class="toc-section-number">27.1.14</span> ASCII
<code>[System]</code></a></li>
<li><a href="#async-process-system" id="toc-async-process-system"><span class="toc-section-number">27.1.15</span> Async Process
<code>[System]</code></a></li>
<li><a href="#atom-lisp" id="toc-atom-lisp"><span class="toc-section-number">27.1.16</span> Atom
<code>[Lisp]</code></a></li>
<li><a href="#auto-composition-display" id="toc-auto-composition-display"><span class="toc-section-number">27.1.17</span> Auto-Composition
<code>[Display]</code></a></li>
<li><a href="#auto-fill-mode-core" id="toc-auto-fill-mode-core"><span class="toc-section-number">27.1.18</span> Auto-Fill Mode
<code>[Core]</code></a></li>
<li><a href="#auto-revert-mode-core" id="toc-auto-revert-mode-core"><span class="toc-section-number">27.1.19</span> Auto-Revert Mode
<code>[Core]</code></a></li>
<li><a href="#auto-save-core" id="toc-auto-save-core"><span class="toc-section-number">27.1.20</span> Auto-Save
<code>[Core]</code></a></li>
<li><a href="#autoload-lisp" id="toc-autoload-lisp"><span class="toc-section-number">27.1.21</span> Autoload
<code>[Lisp]</code></a></li>
<li><a href="#autoload-cookie-lisp" id="toc-autoload-cookie-lisp"><span class="toc-section-number">27.1.22</span> Autoload Cookie
<code>[Lisp]</code></a></li>
</ul></details></li>
<li><details><summary><a href="#b" id="toc-b"><span class="toc-section-number">27.2</span>
B</a></summary><ul>
<li><a href="#backtrace-lisp" id="toc-backtrace-lisp"><span class="toc-section-number">27.2.1</span> Backtrace
<code>[Lisp]</code></a></li>
<li><a href="#backup-file-core" id="toc-backup-file-core"><span class="toc-section-number">27.2.2</span> Backup File
<code>[Core]</code></a></li>
<li><a href="#balanced-expression-lisp" id="toc-balanced-expression-lisp"><span class="toc-section-number">27.2.3</span> Balanced Expression
<code>[Lisp]</code></a></li>
<li><a href="#before-change-function-system" id="toc-before-change-function-system"><span class="toc-section-number">27.2.4</span> Before-Change Function
<code>[System]</code></a></li>
<li><a href="#before-string-display" id="toc-before-string-display"><span class="toc-section-number">27.2.5</span> Before String
<code>[Display]</code></a></li>
<li><a href="#beg-begv-data" id="toc-beg-begv-data"><span class="toc-section-number">27.2.6</span> BEG / BEGV
<code>[Data]</code></a></li>
<li><a href="#bidirectional-text-display" id="toc-bidirectional-text-display"><span class="toc-section-number">27.2.7</span> Bidirectional Text
<code>[Display]</code></a></li>
<li><a href="#binding-lisp" id="toc-binding-lisp"><span class="toc-section-number">27.2.8</span> Binding
<code>[Lisp]</code></a></li>
<li><a href="#bitmap-display" id="toc-bitmap-display"><span class="toc-section-number">27.2.9</span> Bitmap
<code>[Display]</code></a></li>
<li><a href="#bobp-bolp-eobp-eolp-core" id="toc-bobp-bolp-eobp-eolp-core"><span class="toc-section-number">27.2.10</span> Bobp / Bolp / Eobp / Eolp
<code>[Core]</code></a></li>
<li><a href="#bool-vector-data" id="toc-bool-vector-data"><span class="toc-section-number">27.2.11</span> Bool Vector
<code>[Data]</code></a></li>
<li><a href="#buffer-core" id="toc-buffer-core"><span class="toc-section-number">27.2.12</span> Buffer
<code>[Core]</code></a></li>
<li><a href="#buffer-local-variable-lisp" id="toc-buffer-local-variable-lisp"><span class="toc-section-number">27.2.13</span> Buffer-Local Variable
<code>[Lisp]</code></a></li>
<li><a href="#buffer-gap-data" id="toc-buffer-gap-data"><span class="toc-section-number">27.2.14</span> Buffer Gap
<code>[Data]</code></a></li>
<li><a href="#buffer-list-core" id="toc-buffer-list-core"><span class="toc-section-number">27.2.15</span> Buffer List
<code>[Core]</code></a></li>
<li><a href="#buffer-undo-list-core" id="toc-buffer-undo-list-core"><span class="toc-section-number">27.2.16</span> Buffer-Undo-List
<code>[Core]</code></a></li>
<li><a href="#buried-buffer-core" id="toc-buried-buffer-core"><span class="toc-section-number">27.2.17</span> Buried Buffer
<code>[Core]</code></a></li>
<li><a href="#byte-code-lisp" id="toc-byte-code-lisp"><span class="toc-section-number">27.2.18</span> Byte Code
<code>[Lisp]</code></a></li>
<li><a href="#byte-compiler-lisp" id="toc-byte-compiler-lisp"><span class="toc-section-number">27.2.19</span> Byte Compiler
<code>[Lisp]</code></a></li>
<li><a href="#byte-position-data" id="toc-byte-position-data"><span class="toc-section-number">27.2.20</span> Byte Position
<code>[Data]</code></a></li>
</ul></details></li>
<li><details><summary><a href="#c" id="toc-c"><span class="toc-section-number">27.3</span>
C</a></summary><ul>
<li><a href="#c-h-abbrev" id="toc-c-h-abbrev"><span class="toc-section-number">27.3.1</span> C-h
<code>[Abbrev]</code></a></li>
<li><a href="#c-source-system" id="toc-c-source-system"><span class="toc-section-number">27.3.2</span> C Source
<code>[System]</code></a></li>
<li><a href="#call-stack-lisp" id="toc-call-stack-lisp"><span class="toc-section-number">27.3.3</span> Call Stack
<code>[Lisp]</code></a></li>
<li><a href="#canonical-character-system" id="toc-canonical-character-system"><span class="toc-section-number">27.3.4</span> Canonical Character
<code>[System]</code></a></li>
<li><a href="#case-table-data" id="toc-case-table-data"><span class="toc-section-number">27.3.5</span> Case Table
<code>[Data]</code></a></li>
<li><a href="#category-table-data" id="toc-category-table-data"><span class="toc-section-number">27.3.6</span> Category Table
<code>[Data]</code></a></li>
<li><a href="#cedet-abbrev" id="toc-cedet-abbrev"><span class="toc-section-number">27.3.7</span> CEDET
<code>[Abbrev]</code></a></li>
<li><a href="#change-group-system" id="toc-change-group-system"><span class="toc-section-number">27.3.8</span> Change Group
<code>[System]</code></a></li>
<li><a href="#character-data" id="toc-character-data"><span class="toc-section-number">27.3.9</span> Character
<code>[Data]</code></a></li>
<li><a href="#character-class-lisp" id="toc-character-class-lisp"><span class="toc-section-number">27.3.10</span> Character Class
<code>[Lisp]</code></a></li>
<li><a href="#character-code-data" id="toc-character-code-data"><span class="toc-section-number">27.3.11</span> Character Code
<code>[Data]</code></a></li>
<li><a href="#character-position-data" id="toc-character-position-data"><span class="toc-section-number">27.3.12</span> Character Position
<code>[Data]</code></a></li>
<li><a href="#charset-system-1" id="toc-charset-system-1"><span class="toc-section-number">27.3.13</span> Charset
<code>[System]</code></a></li>
<li><a href="#char-table-data" id="toc-char-table-data"><span class="toc-section-number">27.3.14</span> Char-Table
<code>[Data]</code></a></li>
<li><a href="#circular-list-data" id="toc-circular-list-data"><span class="toc-section-number">27.3.15</span> Circular List
<code>[Data]</code></a></li>
<li><a href="#cl-common-lisp-lisp" id="toc-cl-common-lisp-lisp"><span class="toc-section-number">27.3.16</span> CL (Common Lisp)
<code>[Lisp]</code></a></li>
<li><a href="#closure-lisp" id="toc-closure-lisp"><span class="toc-section-number">27.3.17</span> Closure
<code>[Lisp]</code></a></li>
<li><a href="#coding-system-system" id="toc-coding-system-system"><span class="toc-section-number">27.3.18</span> Coding System
<code>[System]</code></a></li>
<li><a href="#column-core" id="toc-column-core"><span class="toc-section-number">27.3.19</span> Column
<code>[Core]</code></a></li>
<li><a href="#command-core" id="toc-command-core"><span class="toc-section-number">27.3.20</span> Command
<code>[Core]</code></a></li>
<li><a href="#command-loop-system" id="toc-command-loop-system"><span class="toc-section-number">27.3.21</span> Command Loop
<code>[System]</code></a></li>
<li><a href="#comment-syntax-lisp" id="toc-comment-syntax-lisp"><span class="toc-section-number">27.3.22</span> Comment Syntax
<code>[Lisp]</code></a></li>
<li><a href="#compilation-lisp" id="toc-compilation-lisp"><span class="toc-section-number">27.3.23</span> Compilation
<code>[Lisp]</code></a></li>
<li><a href="#composition-display" id="toc-composition-display"><span class="toc-section-number">27.3.24</span> Composition
<code>[Display]</code></a></li>
<li><a href="#cons-cell-data" id="toc-cons-cell-data"><span class="toc-section-number">27.3.25</span> Cons Cell
<code>[Data]</code></a></li>
<li><a href="#continuation-line-display" id="toc-continuation-line-display"><span class="toc-section-number">27.3.26</span> Continuation Line
<code>[Display]</code></a></li>
<li><a href="#current-buffer-core" id="toc-current-buffer-core"><span class="toc-section-number">27.3.27</span> Current Buffer
<code>[Core]</code></a></li>
<li><a href="#customization-system" id="toc-customization-system"><span class="toc-section-number">27.3.28</span> Customization
<code>[System]</code></a></li>
<li><a href="#custom-theme-system" id="toc-custom-theme-system"><span class="toc-section-number">27.3.29</span> Custom Theme
<code>[System]</code></a></li>
</ul></details></li>
<li><details><summary><a href="#d" id="toc-d"><span class="toc-section-number">27.4</span>
D</a></summary><ul>
<li><a href="#daemon-mode-system" id="toc-daemon-mode-system"><span class="toc-section-number">27.4.1</span> Daemon Mode
<code>[System]</code></a></li>
<li><a href="#debug-on-error-lisp" id="toc-debug-on-error-lisp"><span class="toc-section-number">27.4.2</span> Debug On Error
<code>[Lisp]</code></a></li>
<li><a href="#debugger-lisp" id="toc-debugger-lisp"><span class="toc-section-number">27.4.3</span> Debugger
<code>[Lisp]</code></a></li>
<li><a href="#defadvice-lisp-deprecated" id="toc-defadvice-lisp-deprecated"><span class="toc-section-number">27.4.4</span> Defadvice <code>[Lisp]</code>
(Deprecated)</a></li>
<li><a href="#defconst-lisp" id="toc-defconst-lisp"><span class="toc-section-number">27.4.5</span> Defconst
<code>[Lisp]</code></a></li>
<li><a href="#defcustom-lisp" id="toc-defcustom-lisp"><span class="toc-section-number">27.4.6</span> Defcustom
<code>[Lisp]</code></a></li>
<li><a href="#defface-lisp" id="toc-defface-lisp"><span class="toc-section-number">27.4.7</span> Defface
<code>[Lisp]</code></a></li>
<li><a href="#defmacro-lisp" id="toc-defmacro-lisp"><span class="toc-section-number">27.4.8</span> Defmacro
<code>[Lisp]</code></a></li>
<li><a href="#defsubst-lisp" id="toc-defsubst-lisp"><span class="toc-section-number">27.4.9</span> Defsubst
<code>[Lisp]</code></a></li>
<li><a href="#defun-lisp-system" id="toc-defun-lisp-system"><span class="toc-section-number">27.4.10</span> DEFUN <code>[Lisp]</code>
<code>[System]</code></a></li>
<li><a href="#defun-abbrev" id="toc-defun-abbrev"><span class="toc-section-number">27.4.11</span> Defun
<code>[Abbrev]</code></a></li>
<li><a href="#defvar-lisp" id="toc-defvar-lisp"><span class="toc-section-number">27.4.12</span> Defvar
<code>[Lisp]</code></a></li>
<li><a href="#defvaralias-lisp" id="toc-defvaralias-lisp"><span class="toc-section-number">27.4.13</span> Defvaralias
<code>[Lisp]</code></a></li>
<li><a href="#describe-core" id="toc-describe-core"><span class="toc-section-number">27.4.14</span> Describe
<code>[Core]</code></a></li>
<li><a href="#display-engine-display" id="toc-display-engine-display"><span class="toc-section-number">27.4.15</span> Display Engine
<code>[Display]</code></a></li>
<li><a href="#display-property-display" id="toc-display-property-display"><span class="toc-section-number">27.4.16</span> Display Property
<code>[Display]</code></a></li>
<li><a href="#display-spec-display" id="toc-display-spec-display"><span class="toc-section-number">27.4.17</span> Display Spec
<code>[Display]</code></a></li>
<li><a href="#display-table-data" id="toc-display-table-data"><span class="toc-section-number">27.4.18</span> Display Table
<code>[Data]</code></a></li>
<li><a href="#dotted-pair-data" id="toc-dotted-pair-data"><span class="toc-section-number">27.4.19</span> Dotted Pair
<code>[Data]</code></a></li>
<li><a href="#dtrt-abbrev" id="toc-dtrt-abbrev"><span class="toc-section-number">27.4.20</span> DTRT
<code>[Abbrev]</code></a></li>
<li><a href="#dwim-abbrev" id="toc-dwim-abbrev"><span class="toc-section-number">27.4.21</span> DWIM
<code>[Abbrev]</code></a></li>
<li><a href="#dynamic-binding-lisp" id="toc-dynamic-binding-lisp"><span class="toc-section-number">27.4.22</span> Dynamic Binding
<code>[Lisp]</code></a></li>
<li><a href="#dynamic-module-system" id="toc-dynamic-module-system"><span class="toc-section-number">27.4.23</span> Dynamic Module
<code>[System]</code></a></li>
</ul></details></li>
<li><details><summary><a href="#e" id="toc-e"><span class="toc-section-number">27.5</span>
E</a></summary><ul>
<li><a href="#echo-area-core" id="toc-echo-area-core"><span class="toc-section-number">27.5.1</span> Echo Area
<code>[Core]</code></a></li>
<li><a href="#edebug-lisp" id="toc-edebug-lisp"><span class="toc-section-number">27.5.2</span> Edebug
<code>[Lisp]</code></a></li>
<li><a href="#electric-core" id="toc-electric-core"><span class="toc-section-number">27.5.3</span> Electric
<code>[Core]</code></a></li>
<li><a href="#elpa-abbrev" id="toc-elpa-abbrev"><span class="toc-section-number">27.5.4</span> ELPA
<code>[Abbrev]</code></a></li>
<li><a href="#elc-file-lisp" id="toc-elc-file-lisp"><span class="toc-section-number">27.5.5</span> .elc File
<code>[Lisp]</code></a></li>
<li><a href="#eln-file-lisp" id="toc-eln-file-lisp"><span class="toc-section-number">27.5.6</span> .eln File
<code>[Lisp]</code></a></li>
<li><a href="#emulation-mode-core" id="toc-emulation-mode-core"><span class="toc-section-number">27.5.7</span> Emulation Mode
<code>[Core]</code></a></li>
<li><a href="#environment-variable-system" id="toc-environment-variable-system"><span class="toc-section-number">27.5.8</span> Environment Variable
<code>[System]</code></a></li>
<li><a href="#eol-convention-system" id="toc-eol-convention-system"><span class="toc-section-number">27.5.9</span> EOL Convention
<code>[System]</code></a></li>
<li><a href="#error-lisp" id="toc-error-lisp"><span class="toc-section-number">27.5.10</span> Error
<code>[Lisp]</code></a></li>
<li><a href="#error-symbol-lisp" id="toc-error-symbol-lisp"><span class="toc-section-number">27.5.11</span> Error Symbol
<code>[Lisp]</code></a></li>
<li><a href="#eval-lisp" id="toc-eval-lisp"><span class="toc-section-number">27.5.12</span> Eval
<code>[Lisp]</code></a></li>
<li><a href="#evaluation-lisp" id="toc-evaluation-lisp"><span class="toc-section-number">27.5.13</span> Evaluation
<code>[Lisp]</code></a></li>
<li><a href="#event-system" id="toc-event-system"><span class="toc-section-number">27.5.14</span> Event
<code>[System]</code></a></li>
<li><a href="#extent-data-xemacs" id="toc-extent-data-xemacs"><span class="toc-section-number">27.5.15</span> Extent <code>[Data]</code>
(XEmacs)</a></li>
</ul></details></li>
<li><details><summary><a href="#f" id="toc-f"><span class="toc-section-number">27.6</span>
F</a></summary><ul>
<li><a href="#face-display" id="toc-face-display"><span class="toc-section-number">27.6.1</span> Face
<code>[Display]</code></a></li>
<li><a href="#face-attribute-display" id="toc-face-attribute-display"><span class="toc-section-number">27.6.2</span> Face Attribute
<code>[Display]</code></a></li>
<li><a href="#face-remapping-display" id="toc-face-remapping-display"><span class="toc-section-number">27.6.3</span> Face Remapping
<code>[Display]</code></a></li>
<li><a href="#feature-lisp" id="toc-feature-lisp"><span class="toc-section-number">27.6.4</span> Feature
<code>[Lisp]</code></a></li>
<li><a href="#field-core" id="toc-field-core"><span class="toc-section-number">27.6.5</span> Field
<code>[Core]</code></a></li>
<li><a href="#file-handler-system" id="toc-file-handler-system"><span class="toc-section-number">27.6.6</span> File Handler
<code>[System]</code></a></li>
<li><a href="#file-local-variable-core" id="toc-file-local-variable-core"><span class="toc-section-number">27.6.7</span> File Local Variable
<code>[Core]</code></a></li>
<li><a href="#fill-core" id="toc-fill-core"><span class="toc-section-number">27.6.8</span> Fill
<code>[Core]</code></a></li>
<li><a href="#fill-column-core" id="toc-fill-column-core"><span class="toc-section-number">27.6.9</span> Fill Column
<code>[Core]</code></a></li>
<li><a href="#fill-prefix-core" id="toc-fill-prefix-core"><span class="toc-section-number">27.6.10</span> Fill Prefix
<code>[Core]</code></a></li>
<li><a href="#filter-system" id="toc-filter-system"><span class="toc-section-number">27.6.11</span> Filter
<code>[System]</code></a></li>
<li><a href="#finalizer-lisp" id="toc-finalizer-lisp"><span class="toc-section-number">27.6.12</span> Finalizer
<code>[Lisp]</code></a></li>
<li><a href="#font-display" id="toc-font-display"><span class="toc-section-number">27.6.13</span> Font
<code>[Display]</code></a></li>
<li><a href="#font-backend-display" id="toc-font-backend-display"><span class="toc-section-number">27.6.14</span> Font Backend
<code>[Display]</code></a></li>
<li><a href="#font-lock-mode-display" id="toc-font-lock-mode-display"><span class="toc-section-number">27.6.15</span> Font Lock Mode
<code>[Display]</code></a></li>
<li><a href="#font-lock-keywords-display" id="toc-font-lock-keywords-display"><span class="toc-section-number">27.6.16</span> Font Lock Keywords
<code>[Display]</code></a></li>
<li><a href="#form-lisp" id="toc-form-lisp"><span class="toc-section-number">27.6.17</span> Form
<code>[Lisp]</code></a></li>
<li><a href="#frame-core" id="toc-frame-core"><span class="toc-section-number">27.6.18</span> Frame
<code>[Core]</code></a></li>
<li><a href="#frame-parameter-display" id="toc-frame-parameter-display"><span class="toc-section-number">27.6.19</span> Frame Parameter
<code>[Display]</code></a></li>
<li><a href="#fringe-display" id="toc-fringe-display"><span class="toc-section-number">27.6.20</span> Fringe
<code>[Display]</code></a></li>
<li><a href="#function-lisp" id="toc-function-lisp"><span class="toc-section-number">27.6.21</span> Function
<code>[Lisp]</code></a></li>
<li><a href="#function-cell-lisp" id="toc-function-cell-lisp"><span class="toc-section-number">27.6.22</span> Function Cell
<code>[Lisp]</code></a></li>
</ul></details></li>
<li><details><summary><a href="#g" id="toc-g"><span class="toc-section-number">27.7</span>
G</a></summary><ul>
<li><a href="#gap-buffer-data" id="toc-gap-buffer-data"><span class="toc-section-number">27.7.1</span> Gap Buffer
<code>[Data]</code></a></li>
<li><a href="#garbage-collection-gc-system" id="toc-garbage-collection-gc-system"><span class="toc-section-number">27.7.2</span> Garbage Collection (GC)
<code>[System]</code></a></li>
<li><a href="#generic-function-lisp" id="toc-generic-function-lisp"><span class="toc-section-number">27.7.3</span> Generic Function
<code>[Lisp]</code></a></li>
<li><a href="#glyph-display" id="toc-glyph-display"><span class="toc-section-number">27.7.4</span> Glyph
<code>[Display]</code></a></li>
<li><a href="#glyph-matrix-display" id="toc-glyph-matrix-display"><span class="toc-section-number">27.7.5</span> Glyph Matrix
<code>[Display]</code></a></li>
<li><a href="#goal-column-core" id="toc-goal-column-core"><span class="toc-section-number">27.7.6</span> Goal Column
<code>[Core]</code></a></li>
<li><a href="#gpt-gpt_byte-data" id="toc-gpt-gpt_byte-data"><span class="toc-section-number">27.7.7</span> GPT / GPT_BYTE
<code>[Data]</code></a></li>
</ul></details></li>
<li><details><summary><a href="#h" id="toc-h"><span class="toc-section-number">27.8</span>
H</a></summary><ul>
<li><a href="#hash-table-data" id="toc-hash-table-data"><span class="toc-section-number">27.8.1</span> Hash Table
<code>[Data]</code></a></li>
<li><a href="#header-line-display" id="toc-header-line-display"><span class="toc-section-number">27.8.2</span> Header Line
<code>[Display]</code></a></li>
<li><a href="#help-core" id="toc-help-core"><span class="toc-section-number">27.8.3</span> Help
<code>[Core]</code></a></li>
<li><a href="#hook-system-1" id="toc-hook-system-1"><span class="toc-section-number">27.8.4</span> Hook
<code>[System]</code></a></li>
<li><a href="#horizontal-scrolling-display" id="toc-horizontal-scrolling-display"><span class="toc-section-number">27.8.5</span> Horizontal Scrolling
<code>[Display]</code></a></li>
</ul></details></li>
<li><details><summary><a href="#i" id="toc-i"><span class="toc-section-number">27.9</span>
I</a></summary><ul>
<li><a href="#idle-timer-system" id="toc-idle-timer-system"><span class="toc-section-number">27.9.1</span> Idle Timer
<code>[System]</code></a></li>
<li><a href="#image-display" id="toc-image-display"><span class="toc-section-number">27.9.2</span> Image
<code>[Display]</code></a></li>
<li><a href="#image-descriptor-display" id="toc-image-descriptor-display"><span class="toc-section-number">27.9.3</span> Image Descriptor
<code>[Display]</code></a></li>
<li><a href="#imenu-core" id="toc-imenu-core"><span class="toc-section-number">27.9.4</span> Imenu
<code>[Core]</code></a></li>
<li><a href="#indentation-core" id="toc-indentation-core"><span class="toc-section-number">27.9.5</span> Indentation
<code>[Core]</code></a></li>
<li><a href="#indent-function-core" id="toc-indent-function-core"><span class="toc-section-number">27.9.6</span> Indent Function
<code>[Core]</code></a></li>
<li><a href="#indirect-buffer-core" id="toc-indirect-buffer-core"><span class="toc-section-number">27.9.7</span> Indirect Buffer
<code>[Core]</code></a></li>
<li><a href="#info-core" id="toc-info-core"><span class="toc-section-number">27.9.8</span> Info
<code>[Core]</code></a></li>
<li><a href="#inhibit-quit-system" id="toc-inhibit-quit-system"><span class="toc-section-number">27.9.9</span> Inhibit Quit
<code>[System]</code></a></li>
<li><a href="#init-file-core" id="toc-init-file-core"><span class="toc-section-number">27.9.10</span> Init File
<code>[Core]</code></a></li>
<li><a href="#input-focus-display" id="toc-input-focus-display"><span class="toc-section-number">27.9.11</span> Input Focus
<code>[Display]</code></a></li>
<li><a href="#input-method-system" id="toc-input-method-system"><span class="toc-section-number">27.9.12</span> Input Method
<code>[System]</code></a></li>
<li><a href="#insertion-core" id="toc-insertion-core"><span class="toc-section-number">27.9.13</span> Insertion
<code>[Core]</code></a></li>
<li><a href="#insertion-type-data" id="toc-insertion-type-data"><span class="toc-section-number">27.9.14</span> Insertion Type
<code>[Data]</code></a></li>
<li><a href="#interactive-lisp" id="toc-interactive-lisp"><span class="toc-section-number">27.9.15</span> Interactive
<code>[Lisp]</code></a></li>
<li><a href="#interactive-spec-lisp" id="toc-interactive-spec-lisp"><span class="toc-section-number">27.9.16</span> Interactive Spec
<code>[Lisp]</code></a></li>
<li><a href="#interpreter-lisp" id="toc-interpreter-lisp"><span class="toc-section-number">27.9.17</span> Interpreter
<code>[Lisp]</code></a></li>
<li><a href="#interval-data" id="toc-interval-data"><span class="toc-section-number">27.9.18</span> Interval
<code>[Data]</code></a></li>
<li><a href="#interval-tree-data" id="toc-interval-tree-data"><span class="toc-section-number">27.9.19</span> Interval Tree
<code>[Data]</code></a></li>
<li><a href="#invisible-text-display" id="toc-invisible-text-display"><span class="toc-section-number">27.9.20</span> Invisible Text
<code>[Display]</code></a></li>
<li><a href="#isearch-core" id="toc-isearch-core"><span class="toc-section-number">27.9.21</span> Isearch
<code>[Core]</code></a></li>
</ul></details></li>
<li><details><summary><a href="#j" id="toc-j"><span class="toc-section-number">27.10</span> J</a></summary><ul>
<li><a href="#jit-lock-display" id="toc-jit-lock-display"><span class="toc-section-number">27.10.1</span> JIT Lock
<code>[Display]</code></a></li>
</ul></details></li>
<li><details><summary><a href="#k" id="toc-k"><span class="toc-section-number">27.11</span> K</a></summary><ul>
<li><a href="#keyboard-macro-core" id="toc-keyboard-macro-core"><span class="toc-section-number">27.11.1</span> Keyboard Macro
<code>[Core]</code></a></li>
<li><a href="#key-binding-core" id="toc-key-binding-core"><span class="toc-section-number">27.11.2</span> Key Binding
<code>[Core]</code></a></li>
<li><a href="#key-sequence-core" id="toc-key-sequence-core"><span class="toc-section-number">27.11.3</span> Key Sequence
<code>[Core]</code></a></li>
<li><a href="#keymap-core" id="toc-keymap-core"><span class="toc-section-number">27.11.4</span> Keymap
<code>[Core]</code></a></li>
<li><a href="#kill-abbrev-core" id="toc-kill-abbrev-core"><span class="toc-section-number">27.11.5</span> Kill <code>[Abbrev]</code>
<code>[Core]</code></a></li>
<li><a href="#kill-ring-core" id="toc-kill-ring-core"><span class="toc-section-number">27.11.6</span> Kill Ring
<code>[Core]</code></a></li>
<li><a href="#killing-buffers-core" id="toc-killing-buffers-core"><span class="toc-section-number">27.11.7</span> Killing Buffers
<code>[Core]</code></a></li>
</ul></details></li>
<li><details><summary><a href="#l" id="toc-l"><span class="toc-section-number">27.12</span> L</a></summary><ul>
<li><a href="#lambda-lisp" id="toc-lambda-lisp"><span class="toc-section-number">27.12.1</span> Lambda
<code>[Lisp]</code></a></li>
<li><a href="#lambda-list-lisp" id="toc-lambda-list-lisp"><span class="toc-section-number">27.12.2</span> Lambda List
<code>[Lisp]</code></a></li>
<li><a href="#lap-lisp" id="toc-lap-lisp"><span class="toc-section-number">27.12.3</span> LAP
<code>[Lisp]</code></a></li>
<li><a href="#lazy-loading-lisp" id="toc-lazy-loading-lisp"><span class="toc-section-number">27.12.4</span> Lazy Loading
<code>[Lisp]</code></a></li>
<li><a href="#let-binding-lisp" id="toc-let-binding-lisp"><span class="toc-section-number">27.12.5</span> Let Binding
<code>[Lisp]</code></a></li>
<li><a href="#lexical-binding-lisp" id="toc-lexical-binding-lisp"><span class="toc-section-number">27.12.6</span> Lexical Binding
<code>[Lisp]</code></a></li>
<li><a href="#library-lisp" id="toc-library-lisp"><span class="toc-section-number">27.12.7</span> Library
<code>[Lisp]</code></a></li>
<li><a href="#line-number-core" id="toc-line-number-core"><span class="toc-section-number">27.12.8</span> Line Number
<code>[Core]</code></a></li>
<li><a href="#line-wrapping-display" id="toc-line-wrapping-display"><span class="toc-section-number">27.12.9</span> Line Wrapping
<code>[Display]</code></a></li>
<li><a href="#lisp_object-lisp-data" id="toc-lisp_object-lisp-data"><span class="toc-section-number">27.12.10</span> Lisp_Object
<code>[Lisp]</code> <code>[Data]</code></a></li>
<li><a href="#list-data" id="toc-list-data"><span class="toc-section-number">27.12.11</span> List
<code>[Data]</code></a></li>
<li><a href="#load-lisp" id="toc-load-lisp"><span class="toc-section-number">27.12.12</span> Load
<code>[Lisp]</code></a></li>
<li><a href="#load-path-lisp" id="toc-load-path-lisp"><span class="toc-section-number">27.12.13</span> Load Path
<code>[Lisp]</code></a></li>
<li><a href="#local-keymap-core" id="toc-local-keymap-core"><span class="toc-section-number">27.12.14</span> Local Keymap
<code>[Core]</code></a></li>
<li><a href="#local-variable-lisp" id="toc-local-variable-lisp"><span class="toc-section-number">27.12.15</span> Local Variable
<code>[Lisp]</code></a></li>
<li><a href="#locking-system" id="toc-locking-system"><span class="toc-section-number">27.12.16</span> Locking
<code>[System]</code></a></li>
<li><a href="#lsp-abbrev" id="toc-lsp-abbrev"><span class="toc-section-number">27.12.17</span> LSP
<code>[Abbrev]</code></a></li>
</ul></details></li>
<li><details><summary><a href="#m" id="toc-m"><span class="toc-section-number">27.13</span> M</a></summary><ul>
<li><a href="#m-x-core" id="toc-m-x-core"><span class="toc-section-number">27.13.1</span> M-x
<code>[Core]</code></a></li>
<li><a href="#macro-lisp" id="toc-macro-lisp"><span class="toc-section-number">27.13.2</span> Macro
<code>[Lisp]</code></a></li>
<li><a href="#macro-expansion-lisp" id="toc-macro-expansion-lisp"><span class="toc-section-number">27.13.3</span> Macro Expansion
<code>[Lisp]</code></a></li>
<li><a href="#major-mode-core" id="toc-major-mode-core"><span class="toc-section-number">27.13.4</span> Major Mode
<code>[Core]</code></a></li>
<li><a href="#margin-display" id="toc-margin-display"><span class="toc-section-number">27.13.5</span> Margin
<code>[Display]</code></a></li>
<li><a href="#mark-core" id="toc-mark-core"><span class="toc-section-number">27.13.6</span> Mark
<code>[Core]</code></a></li>
<li><a href="#mark-ring-core" id="toc-mark-ring-core"><span class="toc-section-number">27.13.7</span> Mark Ring
<code>[Core]</code></a></li>
<li><a href="#marker-data" id="toc-marker-data"><span class="toc-section-number">27.13.8</span> Marker
<code>[Data]</code></a></li>
<li><a href="#match-data-lisp" id="toc-match-data-lisp"><span class="toc-section-number">27.13.9</span> Match Data
<code>[Lisp]</code></a></li>
<li><a href="#melpa-abbrev" id="toc-melpa-abbrev"><span class="toc-section-number">27.13.10</span> MELPA
<code>[Abbrev]</code></a></li>
<li><a href="#message-core" id="toc-message-core"><span class="toc-section-number">27.13.11</span> Message
<code>[Core]</code></a></li>
<li><a href="#meta-key-core" id="toc-meta-key-core"><span class="toc-section-number">27.13.12</span> Meta Key
<code>[Core]</code></a></li>
<li><a href="#minibuffer-core" id="toc-minibuffer-core"><span class="toc-section-number">27.13.13</span> Minibuffer
<code>[Core]</code></a></li>
<li><a href="#minibuffer-history-core" id="toc-minibuffer-history-core"><span class="toc-section-number">27.13.14</span> Minibuffer History
<code>[Core]</code></a></li>
<li><a href="#minor-mode-core" id="toc-minor-mode-core"><span class="toc-section-number">27.13.15</span> Minor Mode
<code>[Core]</code></a></li>
<li><a href="#mode-hook-system" id="toc-mode-hook-system"><span class="toc-section-number">27.13.16</span> Mode Hook
<code>[System]</code></a></li>
<li><a href="#mode-line-display" id="toc-mode-line-display"><span class="toc-section-number">27.13.17</span> Mode Line
<code>[Display]</code></a></li>
<li><a href="#mode-line-format-display" id="toc-mode-line-format-display"><span class="toc-section-number">27.13.18</span> Mode Line Format
<code>[Display]</code></a></li>
<li><a href="#modification-time-system" id="toc-modification-time-system"><span class="toc-section-number">27.13.19</span> Modification Time
<code>[System]</code></a></li>
<li><a href="#mouse-event-system" id="toc-mouse-event-system"><span class="toc-section-number">27.13.20</span> Mouse Event
<code>[System]</code></a></li>
<li><a href="#multibyte-system" id="toc-multibyte-system"><span class="toc-section-number">27.13.21</span> Multibyte
<code>[System]</code></a></li>
</ul></details></li>
<li><details><summary><a href="#n" id="toc-n"><span class="toc-section-number">27.14</span> N</a></summary><ul>
<li><a href="#narrowing-core" id="toc-narrowing-core"><span class="toc-section-number">27.14.1</span> Narrowing
<code>[Core]</code></a></li>
<li><a href="#native-compilation-lisp" id="toc-native-compilation-lisp"><span class="toc-section-number">27.14.2</span> Native Compilation
<code>[Lisp]</code></a></li>
<li><a href="#nil-lisp" id="toc-nil-lisp"><span class="toc-section-number">27.14.3</span> Nil
<code>[Lisp]</code></a></li>
<li><a href="#normal-hook-system" id="toc-normal-hook-system"><span class="toc-section-number">27.14.4</span> Normal Hook
<code>[System]</code></a></li>
</ul></details></li>
<li><details><summary><a href="#o" id="toc-o"><span class="toc-section-number">27.15</span> O</a></summary><ul>
<li><a href="#obarray-data" id="toc-obarray-data"><span class="toc-section-number">27.15.1</span> Obarray
<code>[Data]</code></a></li>
<li><a href="#overlay-data" id="toc-overlay-data"><span class="toc-section-number">27.15.2</span> Overlay
<code>[Data]</code></a></li>
<li><a href="#override-keymap-core" id="toc-override-keymap-core"><span class="toc-section-number">27.15.3</span> Override Keymap
<code>[Core]</code></a></li>
</ul></details></li>
<li><details><summary><a href="#p" id="toc-p"><span class="toc-section-number">27.16</span> P</a></summary><ul>
<li><a href="#package-system-1" id="toc-package-system-1"><span class="toc-section-number">27.16.1</span> Package
<code>[System]</code></a></li>
<li><a href="#package-manager-system" id="toc-package-manager-system"><span class="toc-section-number">27.16.2</span> Package Manager
<code>[System]</code></a></li>
<li><a href="#paren-matching-display" id="toc-paren-matching-display"><span class="toc-section-number">27.16.3</span> Paren Matching
<code>[Display]</code></a></li>
<li><a href="#parse-state-lisp" id="toc-parse-state-lisp"><span class="toc-section-number">27.16.4</span> Parse State
<code>[Lisp]</code></a></li>
<li><a href="#plist-data" id="toc-plist-data"><span class="toc-section-number">27.16.5</span> Plist
<code>[Data]</code></a></li>
<li><a href="#point-core" id="toc-point-core"><span class="toc-section-number">27.16.6</span> Point
<code>[Core]</code></a></li>
<li><a href="#position-core" id="toc-position-core"><span class="toc-section-number">27.16.7</span> Position
<code>[Core]</code></a></li>
<li><a href="#predicate-lisp" id="toc-predicate-lisp"><span class="toc-section-number">27.16.8</span> Predicate
<code>[Lisp]</code></a></li>
<li><a href="#prefix-argument-core" id="toc-prefix-argument-core"><span class="toc-section-number">27.16.9</span> Prefix Argument
<code>[Core]</code></a></li>
<li><a href="#prefix-key-core" id="toc-prefix-key-core"><span class="toc-section-number">27.16.10</span> Prefix Key
<code>[Core]</code></a></li>
<li><a href="#primitive-lisp" id="toc-primitive-lisp"><span class="toc-section-number">27.16.11</span> Primitive
<code>[Lisp]</code></a></li>
<li><a href="#print-lisp" id="toc-print-lisp"><span class="toc-section-number">27.16.12</span> Print
<code>[Lisp]</code></a></li>
<li><a href="#process-system" id="toc-process-system"><span class="toc-section-number">27.16.13</span> Process
<code>[System]</code></a></li>
<li><a href="#property-list-data" id="toc-property-list-data"><span class="toc-section-number">27.16.14</span> Property List
<code>[Data]</code></a></li>
<li><a href="#provide-lisp" id="toc-provide-lisp"><span class="toc-section-number">27.16.15</span> Provide
<code>[Lisp]</code></a></li>
</ul></details></li>
<li><details><summary><a href="#q" id="toc-q"><span class="toc-section-number">27.17</span> Q</a></summary><ul>
<li><a href="#quail-system" id="toc-quail-system"><span class="toc-section-number">27.17.1</span> Quail
<code>[System]</code></a></li>
<li><a href="#query-replace-core" id="toc-query-replace-core"><span class="toc-section-number">27.17.2</span> Query-Replace
<code>[Core]</code></a></li>
<li><a href="#quit-core" id="toc-quit-core"><span class="toc-section-number">27.17.3</span> Quit
<code>[Core]</code></a></li>
<li><a href="#quote-lisp" id="toc-quote-lisp"><span class="toc-section-number">27.17.4</span> Quote
<code>[Lisp]</code></a></li>
</ul></details></li>
<li><details><summary><a href="#r" id="toc-r"><span class="toc-section-number">27.18</span> R</a></summary><ul>
<li><a href="#read-lisp" id="toc-read-lisp"><span class="toc-section-number">27.18.1</span> Read
<code>[Lisp]</code></a></li>
<li><a href="#read-only-buffer-core" id="toc-read-only-buffer-core"><span class="toc-section-number">27.18.2</span> Read-Only Buffer
<code>[Core]</code></a></li>
<li><a href="#reader-lisp" id="toc-reader-lisp"><span class="toc-section-number">27.18.3</span> Reader
<code>[Lisp]</code></a></li>
<li><a href="#recursion-lisp" id="toc-recursion-lisp"><span class="toc-section-number">27.18.4</span> Recursion
<code>[Lisp]</code></a></li>
<li><a href="#redisplay-display" id="toc-redisplay-display"><span class="toc-section-number">27.18.5</span> Redisplay
<code>[Display]</code></a></li>
<li><a href="#regexp-lisp" id="toc-regexp-lisp"><span class="toc-section-number">27.18.6</span> Regexp
<code>[Lisp]</code></a></li>
<li><a href="#region-core" id="toc-region-core"><span class="toc-section-number">27.18.7</span> Region
<code>[Core]</code></a></li>
<li><a href="#register-core" id="toc-register-core"><span class="toc-section-number">27.18.8</span> Register
<code>[Core]</code></a></li>
<li><a href="#repl-lisp" id="toc-repl-lisp"><span class="toc-section-number">27.18.9</span> REPL
<code>[Lisp]</code></a></li>
<li><a href="#require-lisp" id="toc-require-lisp"><span class="toc-section-number">27.18.10</span> Require
<code>[Lisp]</code></a></li>
<li><a href="#restriction-core" id="toc-restriction-core"><span class="toc-section-number">27.18.11</span> Restriction
<code>[Core]</code></a></li>
<li><a href="#revert-buffer-core" id="toc-revert-buffer-core"><span class="toc-section-number">27.18.12</span> Revert Buffer
<code>[Core]</code></a></li>
<li><a href="#ring-buffer-data" id="toc-ring-buffer-data"><span class="toc-section-number">27.18.13</span> Ring Buffer
<code>[Data]</code></a></li>
</ul></details></li>
<li><details><summary><a href="#s" id="toc-s"><span class="toc-section-number">27.19</span> S</a></summary><ul>
<li><a href="#safe-local-variable-core" id="toc-safe-local-variable-core"><span class="toc-section-number">27.19.1</span> Safe Local Variable
<code>[Core]</code></a></li>
<li><a href="#save-excursion-lisp" id="toc-save-excursion-lisp"><span class="toc-section-number">27.19.2</span> Save-Excursion
<code>[Lisp]</code></a></li>
<li><a href="#scope-lisp" id="toc-scope-lisp"><span class="toc-section-number">27.19.3</span> Scope
<code>[Lisp]</code></a></li>
<li><a href="#search-core" id="toc-search-core"><span class="toc-section-number">27.19.4</span> Search
<code>[Core]</code></a></li>
<li><a href="#selected-frame-core" id="toc-selected-frame-core"><span class="toc-section-number">27.19.5</span> Selected Frame
<code>[Core]</code></a></li>
<li><a href="#selected-window-core" id="toc-selected-window-core"><span class="toc-section-number">27.19.6</span> Selected Window
<code>[Core]</code></a></li>
<li><a href="#sentinel-system" id="toc-sentinel-system"><span class="toc-section-number">27.19.7</span> Sentinel
<code>[System]</code></a></li>
<li><a href="#server-mode-system" id="toc-server-mode-system"><span class="toc-section-number">27.19.8</span> Server Mode
<code>[System]</code></a></li>
<li><a href="#s-expression-lisp" id="toc-s-expression-lisp"><span class="toc-section-number">27.19.9</span> S-expression
<code>[Lisp]</code></a></li>
<li><a href="#sexp-abbrev" id="toc-sexp-abbrev"><span class="toc-section-number">27.19.10</span> Sexp
<code>[Abbrev]</code></a></li>
<li><a href="#signal-lisp" id="toc-signal-lisp"><span class="toc-section-number">27.19.11</span> Signal
<code>[Lisp]</code></a></li>
<li><a href="#smie-lisp" id="toc-smie-lisp"><span class="toc-section-number">27.19.12</span> SMIE
<code>[Lisp]</code></a></li>
<li><a href="#special-form-lisp" id="toc-special-form-lisp"><span class="toc-section-number">27.19.13</span> Special Form
<code>[Lisp]</code></a></li>
<li><a href="#special-variable-lisp" id="toc-special-variable-lisp"><span class="toc-section-number">27.19.14</span> Special Variable
<code>[Lisp]</code></a></li>
<li><a href="#subr-lisp" id="toc-subr-lisp"><span class="toc-section-number">27.19.15</span> Subr
<code>[Lisp]</code></a></li>
<li><a href="#symbol-lisp" id="toc-symbol-lisp"><span class="toc-section-number">27.19.16</span> Symbol
<code>[Lisp]</code></a></li>
<li><a href="#symbol-property-lisp" id="toc-symbol-property-lisp"><span class="toc-section-number">27.19.17</span> Symbol Property
<code>[Lisp]</code></a></li>
<li><a href="#syntax-class-lisp" id="toc-syntax-class-lisp"><span class="toc-section-number">27.19.18</span> Syntax Class
<code>[Lisp]</code></a></li>
<li><a href="#syntax-table-data" id="toc-syntax-table-data"><span class="toc-section-number">27.19.19</span> Syntax Table
<code>[Data]</code></a></li>
</ul></details></li>
<li><details><summary><a href="#t" id="toc-t"><span class="toc-section-number">27.20</span> T</a></summary><ul>
<li><a href="#t-lisp" id="toc-t-lisp"><span class="toc-section-number">27.20.1</span> T <code>[Lisp]</code></a></li>
<li><a href="#tab-core" id="toc-tab-core"><span class="toc-section-number">27.20.2</span> Tab
<code>[Core]</code></a></li>
<li><a href="#tab-stop-core" id="toc-tab-stop-core"><span class="toc-section-number">27.20.3</span> Tab Stop
<code>[Core]</code></a></li>
<li><a href="#tagged-pointer-data" id="toc-tagged-pointer-data"><span class="toc-section-number">27.20.4</span> Tagged Pointer
<code>[Data]</code></a></li>
<li><a href="#text-property-data" id="toc-text-property-data"><span class="toc-section-number">27.20.5</span> Text Property
<code>[Data]</code></a></li>
<li><a href="#theme-display" id="toc-theme-display"><span class="toc-section-number">27.20.6</span> Theme
<code>[Display]</code></a></li>
<li><a href="#thread-system" id="toc-thread-system"><span class="toc-section-number">27.20.7</span> Thread
<code>[System]</code></a></li>
<li><a href="#timer-system" id="toc-timer-system"><span class="toc-section-number">27.20.8</span> Timer
<code>[System]</code></a></li>
<li><a href="#tooltip-display" id="toc-tooltip-display"><span class="toc-section-number">27.20.9</span> Tooltip
<code>[Display]</code></a></li>
<li><a href="#tramp-abbrev" id="toc-tramp-abbrev"><span class="toc-section-number">27.20.10</span> TRAMP
<code>[Abbrev]</code></a></li>
<li><a href="#transient-mark-mode-core" id="toc-transient-mark-mode-core"><span class="toc-section-number">27.20.11</span> Transient Mark Mode
<code>[Core]</code></a></li>
<li><a href="#truncation-display" id="toc-truncation-display"><span class="toc-section-number">27.20.12</span> Truncation
<code>[Display]</code></a></li>
<li><a href="#tty-system" id="toc-tty-system"><span class="toc-section-number">27.20.13</span> TTY
<code>[System]</code></a></li>
<li><a href="#type-predicate-lisp" id="toc-type-predicate-lisp"><span class="toc-section-number">27.20.14</span> Type Predicate
<code>[Lisp]</code></a></li>
</ul></details></li>
<li><details><summary><a href="#u" id="toc-u"><span class="toc-section-number">27.21</span> U</a></summary><ul>
<li><a href="#undo-core" id="toc-undo-core"><span class="toc-section-number">27.21.1</span> Undo
<code>[Core]</code></a></li>
<li><a href="#unibyte-system" id="toc-unibyte-system"><span class="toc-section-number">27.21.2</span> Unibyte
<code>[System]</code></a></li>
<li><a href="#unicode-system" id="toc-unicode-system"><span class="toc-section-number">27.21.3</span> Unicode
<code>[System]</code></a></li>
<li><a href="#universal-argument-core" id="toc-universal-argument-core"><span class="toc-section-number">27.21.4</span> Universal Argument
<code>[Core]</code></a></li>
<li><a href="#unwind-protect-lisp" id="toc-unwind-protect-lisp"><span class="toc-section-number">27.21.5</span> Unwind-Protect
<code>[Lisp]</code></a></li>
<li><a href="#user-option-lisp" id="toc-user-option-lisp"><span class="toc-section-number">27.21.6</span> User Option
<code>[Lisp]</code></a></li>
<li><a href="#utf-8-system" id="toc-utf-8-system"><span class="toc-section-number">27.21.7</span> UTF-8
<code>[System]</code></a></li>
</ul></details></li>
<li><details><summary><a href="#v" id="toc-v"><span class="toc-section-number">27.22</span> V</a></summary><ul>
<li><a href="#value-cell-lisp" id="toc-value-cell-lisp"><span class="toc-section-number">27.22.1</span> Value Cell
<code>[Lisp]</code></a></li>
<li><a href="#variable-lisp" id="toc-variable-lisp"><span class="toc-section-number">27.22.2</span> Variable
<code>[Lisp]</code></a></li>
<li><a href="#vector-data" id="toc-vector-data"><span class="toc-section-number">27.22.3</span> Vector
<code>[Data]</code></a></li>
<li><a href="#version-control-system" id="toc-version-control-system"><span class="toc-section-number">27.22.4</span> Version Control
<code>[System]</code></a></li>
<li><a href="#visiting-core" id="toc-visiting-core"><span class="toc-section-number">27.22.5</span> Visiting
<code>[Core]</code></a></li>
<li><a href="#visual-line-mode-core" id="toc-visual-line-mode-core"><span class="toc-section-number">27.22.6</span> Visual Line Mode
<code>[Core]</code></a></li>
</ul></details></li>
<li><details><summary><a href="#w" id="toc-w"><span class="toc-section-number">27.23</span> W</a></summary><ul>
<li><a href="#widget-display" id="toc-widget-display"><span class="toc-section-number">27.23.1</span> Widget
<code>[Display]</code></a></li>
<li><a href="#widen-core" id="toc-widen-core"><span class="toc-section-number">27.23.2</span> Widen
<code>[Core]</code></a></li>
<li><a href="#window-core" id="toc-window-core"><span class="toc-section-number">27.23.3</span> Window
<code>[Core]</code></a></li>
<li><a href="#window-configuration-core" id="toc-window-configuration-core"><span class="toc-section-number">27.23.4</span> Window Configuration
<code>[Core]</code></a></li>
<li><a href="#window-parameter-display" id="toc-window-parameter-display"><span class="toc-section-number">27.23.5</span> Window Parameter
<code>[Display]</code></a></li>
<li><a href="#window-point-core" id="toc-window-point-core"><span class="toc-section-number">27.23.6</span> Window Point
<code>[Core]</code></a></li>
<li><a href="#window-system-display" id="toc-window-system-display"><span class="toc-section-number">27.23.7</span> Window System
<code>[Display]</code></a></li>
<li><a href="#window-tree-core" id="toc-window-tree-core"><span class="toc-section-number">27.23.8</span> Window Tree
<code>[Core]</code></a></li>
<li><a href="#word-wrap-display" id="toc-word-wrap-display"><span class="toc-section-number">27.23.9</span> Word Wrap
<code>[Display]</code></a></li>
</ul></details></li>
<li><details><summary><a href="#x" id="toc-x"><span class="toc-section-number">27.24</span> X</a></summary><ul>
<li><a href="#x-window-system-display" id="toc-x-window-system-display"><span class="toc-section-number">27.24.1</span> X Window System
<code>[Display]</code></a></li>
<li><a href="#xref-core" id="toc-xref-core"><span class="toc-section-number">27.24.2</span> Xref
<code>[Core]</code></a></li>
</ul></details></li>
<li><details><summary><a href="#y" id="toc-y"><span class="toc-section-number">27.25</span> Y</a></summary><ul>
<li><a href="#yank-abbrev-core" id="toc-yank-abbrev-core"><span class="toc-section-number">27.25.1</span> Yank <code>[Abbrev]</code>
<code>[Core]</code></a></li>
<li><a href="#yank-pop-core" id="toc-yank-pop-core"><span class="toc-section-number">27.25.2</span> Yank-Pop
<code>[Core]</code></a></li>
</ul></details></li>
<li><details><summary><a href="#z" id="toc-z"><span class="toc-section-number">27.26</span> Z</a></summary><ul>
<li><a href="#z-zv-data" id="toc-z-zv-data"><span class="toc-section-number">27.26.1</span> Z / ZV
<code>[Data]</code></a></li>
</ul></details></li>
<li><details><summary><a href="#appendix-common-patterns" id="toc-appendix-common-patterns"><span class="toc-section-number">27.27</span> Appendix: Common Patterns</a></summary><ul>
<li><a href="#begv-to-zv-pattern-data" id="toc-begv-to-zv-pattern-data"><span class="toc-section-number">27.27.1</span> BEGV-to-ZV Pattern
<code>[Data]</code></a></li>
<li><a href="#car-cdr-recursion-lisp" id="toc-car-cdr-recursion-lisp"><span class="toc-section-number">27.27.2</span> Car-Cdr Recursion
<code>[Lisp]</code></a></li>
<li><a href="#save-match-data-pattern-lisp" id="toc-save-match-data-pattern-lisp"><span class="toc-section-number">27.27.3</span> Save-Match-Data Pattern
<code>[Lisp]</code></a></li>
<li><a href="#with-current-buffer-pattern-lisp" id="toc-with-current-buffer-pattern-lisp"><span class="toc-section-number">27.27.4</span> With-Current-Buffer Pattern
<code>[Lisp]</code></a></li>
</ul></details></li>
<li><a href="#document-statistics-1" id="toc-document-statistics-1"><span class="toc-section-number">27.28</span> Document Statistics</a></li>
</ul></details></li>
<li><details><summary><a href="#comprehensive-index" id="toc-comprehensive-index"><span class="toc-section-number">28</span> Comprehensive Index</a></summary><ul>
<li><a href="#a-1" id="toc-a-1"><span class="toc-section-number">28.1</span> A</a></li>
<li><a href="#b-1" id="toc-b-1"><span class="toc-section-number">28.2</span> B</a></li>
<li><a href="#c-1" id="toc-c-1"><span class="toc-section-number">28.3</span> C</a></li>
<li><a href="#d-1" id="toc-d-1"><span class="toc-section-number">28.4</span> D</a></li>
<li><a href="#e-1" id="toc-e-1"><span class="toc-section-number">28.5</span> E</a></li>
<li><a href="#f-1" id="toc-f-1"><span class="toc-section-number">28.6</span> F</a></li>
<li><a href="#g-1" id="toc-g-1"><span class="toc-section-number">28.7</span> G</a></li>
<li><a href="#h-1" id="toc-h-1"><span class="toc-section-number">28.8</span> H</a></li>
<li><a href="#i-1" id="toc-i-1"><span class="toc-section-number">28.9</span> I</a></li>
<li><a href="#k-1" id="toc-k-1"><span class="toc-section-number">28.10</span> K</a></li>
<li><a href="#l-1" id="toc-l-1"><span class="toc-section-number">28.11</span> L</a></li>
<li><a href="#m-1" id="toc-m-1"><span class="toc-section-number">28.12</span> M</a></li>
<li><a href="#n-1" id="toc-n-1"><span class="toc-section-number">28.13</span> N</a></li>
<li><a href="#o-1" id="toc-o-1"><span class="toc-section-number">28.14</span> O</a></li>
<li><a href="#p-1" id="toc-p-1"><span class="toc-section-number">28.15</span> P</a></li>
<li><a href="#r-1" id="toc-r-1"><span class="toc-section-number">28.16</span> R</a></li>
<li><a href="#s-1" id="toc-s-1"><span class="toc-section-number">28.17</span> S</a></li>
<li><a href="#t-1" id="toc-t-1"><span class="toc-section-number">28.18</span> T</a></li>
<li><a href="#u-1" id="toc-u-1"><span class="toc-section-number">28.19</span> U</a></li>
<li><a href="#v-1" id="toc-v-1"><span class="toc-section-number">28.20</span> V</a></li>
<li><a href="#w-1" id="toc-w-1"><span class="toc-section-number">28.21</span> W</a></li>
<li><a href="#x-1" id="toc-x-1"><span class="toc-section-number">28.22</span> X</a></li>
<li><details><summary><a href="#cross-references-by-topic" id="toc-cross-references-by-topic"><span class="toc-section-number">28.23</span> Cross-References by Topic</a></summary><ul>
<li><a href="#core-architecture-2" id="toc-core-architecture-2"><span class="toc-section-number">28.23.1</span> Core Architecture</a></li>
<li><a href="#user-interface-1" id="toc-user-interface-1"><span class="toc-section-number">28.23.2</span> User Interface</a></li>
<li><a href="#io-systems" id="toc-io-systems"><span class="toc-section-number">28.23.3</span> I/O Systems</a></li>
<li><a href="#major-applications" id="toc-major-applications"><span class="toc-section-number">28.23.4</span> Major Applications</a></li>
<li><a href="#development" id="toc-development"><span class="toc-section-number">28.23.5</span> Development</a></li>
<li><a href="#context-analysis" id="toc-context-analysis"><span class="toc-section-number">28.23.6</span> Context &amp;
Analysis</a></li>
</ul></details></li>
</ul></details></li>
</ul></nav>

</div>
</nav>
<main class="book-content">
<header class="book-header">
<h1 class="book-title">The GNU Emacs Encyclopedic Guide</h1>
<p class="book-subtitle">A Deep Dive into GNU Emacs Internals</p>
</header>
<div class="ai-notice">
<strong>üìù AI-Generated Documentation:</strong> This encyclopedia was entirely created by Claude (Anthropic AI) through comprehensive source code analysis,
      historical research, and community documentation review. Starting from the actual codebase, Claude examined thousands of source files,
      traced git history, and synthesized documentation that explains not just <em>what</em> the code does, but <em>why</em> it exists
      and <em>how</em> it evolved. The result is a deep, systematic exploration compiled with attention to technical accuracy,
      historical context, and educational value.
    </div>
<h1 data-number="1" id="ai-generated-documentation-notice"><span class="header-section-number">1</span> ‚ö†Ô∏è AI-Generated Documentation
Notice</h1>
<p><strong>This documentation was entirely generated by Claude
(Anthropic AI) through automated source code analysis.</strong></p>
<h2 data-number="1.1" id="what-this-means"><span class="header-section-number">1.1</span> What This Means</h2>
<ul>
<li><strong>Automated Creation</strong>: This encyclopedia was created
by an AI system analyzing source code, documentation, and community
resources</li>
<li><strong>No Human Review</strong>: The content has not been verified
or reviewed by the project‚Äôs original authors or maintainers</li>
<li><strong>Potential Inaccuracies</strong>: While efforts were made to
ensure accuracy, AI-generated content may contain errors,
misinterpretations, or outdated information</li>
<li><strong>Not Official</strong>: This is not official project
documentation and should not be treated as authoritative</li>
<li><strong>Use at Your Own Risk</strong>: Readers should verify
critical information against official sources</li>
</ul>
<h2 data-number="1.2" id="purpose"><span class="header-section-number">1.2</span> Purpose</h2>
<p>This documentation aims to provide: - A comprehensive overview of the
codebase architecture - Historical context and evolution - Educational
insights into complex systems - A starting point for further
exploration</p>
<p><strong>Always consult official project documentation and source code
for authoritative information.</strong></p>
<hr/>
<h1 data-number="2" id="chapter-00-introduction"><span class="header-section-number">2</span> Chapter 00: Introduction</h1>
<p><strong>Status</strong>: Planning <strong>Estimated Pages</strong>:
40-60 <strong>Prerequisites</strong>: None
<strong>Dependencies</strong>: None</p>
<h2 data-number="2.1" id="chapter-overview"><span class="header-section-number">2.1</span> Chapter Overview</h2>
<p>This chapter provides an introduction to the Emacs Encyclopedic Guide
and to GNU Emacs itself. It covers the historical context, architectural
overview, and practical information for working with the Emacs source
code.</p>
<h2 data-number="2.2" id="learning-objectives"><span class="header-section-number">2.2</span> Learning Objectives</h2>
<p>After reading this chapter, you should be able to:</p>
<ol type="1">
<li>Understand the historical evolution of Emacs from TECO to GNU
Emacs</li>
<li>Grasp the high-level architecture of Emacs (C core + Elisp
layer)</li>
<li>Set up a development environment for Emacs</li>
<li>Navigate the Emacs source code effectively</li>
<li>Understand how to use this documentation guide</li>
<li>Know how to contribute to Emacs development</li>
</ol>
<h2 data-number="2.3" id="chapter-structure"><span class="header-section-number">2.3</span> Chapter Structure</h2>
<h3 data-number="2.3.1" id="what-is-emacs.md-8-10-pages"><span class="header-section-number">2.3.1</span> 01-what-is-emacs.md (8-10
pages)</h3>
<p><strong>Topics:</strong> - Historical overview (1976-present) - TECO
Emacs, Gosling Emacs, GNU Emacs - Design philosophy and goals - Key
innovations and influence - Emacs in the modern development
landscape</p>
<p><strong>Key Concepts:</strong> - Self-documenting editor -
Extensibility through Lisp - ‚ÄúLiving in Emacs‚Äù philosophy - Free
software principles</p>
<p><strong>Code Examples:</strong> - Simple Emacs Lisp customization -
Basic interactive command</p>
<h3 data-number="2.3.2" id="architecture-overview.md-10-15-pages"><span class="header-section-number">2.3.2</span> 02-architecture-overview.md
(10-15 pages)</h3>
<p><strong>Topics:</strong> - High-level system architecture diagram - C
core responsibilities - Elisp extension layer - Major subsystems
overview - Data flow through the system</p>
<p><strong>Key Concepts:</strong> - Two-tier architecture - Primitives
(C functions exposed to Lisp) - Event loop and command dispatch -
Buffer, window, and frame hierarchy</p>
<p><strong>Figures:</strong> - System architecture diagram - Component
interaction diagram - Startup sequence flowchart</p>
<h3 data-number="2.3.3" id="development-setup.md-8-10-pages"><span class="header-section-number">2.3.3</span> 03-development-setup.md (8-10
pages)</h3>
<p><strong>Topics:</strong> - Building Emacs from source - Development
tools and workflows - Debugging techniques (GDB, Edebug) - Version
control and patches - Testing framework</p>
<p><strong>Key Concepts:</strong> - Configure options - Development
vs.¬†production builds - Debugging symbols - Patch submission process</p>
<p><strong>Code Examples:</strong> - Configure command - GDB session -
ERT test</p>
<h3 data-number="2.3.4" id="navigating-source.md-6-8-pages"><span class="header-section-number">2.3.4</span> 04-navigating-source.md (6-8
pages)</h3>
<p><strong>Topics:</strong> - Directory structure (src/, lisp/, etc.) -
File naming conventions - Finding functions and variables - Using tags,
grep, and specialized tools - Documentation strings and comments</p>
<p><strong>Key Concepts:</strong> - DEFUN macro for C primitives - defun
for Elisp functions - Autoload cookies - Commentary sections</p>
<p><strong>Code Examples:</strong> - Using M-x find-function - Tags
table setup - Grep patterns for code search</p>
<h3 data-number="2.3.5" id="reading-guide.md-4-6-pages"><span class="header-section-number">2.3.5</span> 05-reading-guide.md (4-6
pages)</h3>
<p><strong>Topics:</strong> - How to use this documentation - Reading
paths for different audiences - Notation and conventions - Prerequisites
and assumed knowledge - Literate programming format</p>
<p><strong>Key Concepts:</strong> - Progressive disclosure -
Cross-references - Code annotations - Supplementary boxes</p>
<p><strong>Examples:</strong> - Reading path for extension developers -
Reading path for core developers - Reading path for students</p>
<h3 data-number="2.3.6" id="contributing.md-6-8-pages"><span class="header-section-number">2.3.6</span> 06-contributing.md (6-8
pages)</h3>
<p><strong>Topics:</strong> - Development process - Emacs coding
standards - Submitting patches - Copyright assignment - Mailing list
etiquette</p>
<p><strong>Key Concepts:</strong> - GNU Coding Standards - ChangeLog
format - Bug reporting - Feature requests</p>
<p><strong>Code Examples:</strong> - Properly formatted patch -
ChangeLog entry - Copyright assignment form</p>
<h2 data-number="2.4" id="key-takeaways"><span class="header-section-number">2.4</span> Key Takeaways</h2>
<ol type="1">
<li><strong>Emacs is Lisp</strong>: Understanding that Emacs is
fundamentally a Lisp environment is crucial</li>
<li><strong>Two-Tier Design</strong>: The C core provides primitives;
Elisp provides extensibility</li>
<li><strong>Community Project</strong>: Emacs is developed by a large
community with established processes</li>
<li><strong>Source Code is Documentation</strong>: Reading the source is
essential to understanding Emacs</li>
</ol>
<h2 data-number="2.5" id="prerequisites"><span class="header-section-number">2.5</span> Prerequisites</h2>
<h3 data-number="2.5.1" id="required-knowledge"><span class="header-section-number">2.5.1</span> Required Knowledge</h3>
<ul>
<li>Basic familiarity with text editors</li>
<li>Understanding of programming concepts</li>
<li>Some C programming experience</li>
<li>Basic command-line skills</li>
</ul>
<h3 data-number="2.5.2" id="recommended-background"><span class="header-section-number">2.5.2</span> Recommended Background</h3>
<ul>
<li>Unix/Linux system usage</li>
<li>Version control (Git)</li>
<li>Lisp or functional programming exposure</li>
<li>Compiler and build system concepts</li>
</ul>
<h2 data-number="2.6" id="cross-references"><span class="header-section-number">2.6</span> Cross-References</h2>
<p>This chapter references: - <span class="citation" data-cites="chap:01">[@chap:01]</span> Architecture (overview preview) -
<span class="citation" data-cites="chap:03">[@chap:03]</span> Elisp
Runtime (conceptual introduction) - <span class="citation" data-cites="chap:20">[@chap:20]</span> Testing and Debugging
(development tools)</p>
<p>Later chapters reference this chapter for: - Architectural context -
Historical background - Development environment setup</p>
<h2 data-number="2.7" id="exercises-optional"><span class="header-section-number">2.7</span> Exercises (Optional)</h2>
<ol type="1">
<li><strong>Build Emacs</strong>: Clone the repository and build Emacs
from source</li>
<li><strong>Explore Source</strong>: Find the definition of
<code>insert</code> in C and Elisp</li>
<li><strong>Write Simple Command</strong>: Create a simple interactive
command</li>
<li><strong>Read Code</strong>: Read the implementation of
<code>forward-char</code></li>
<li><strong>Submit Patch</strong>: Fix a typo in documentation and
submit a patch</li>
</ol>
<h2 data-number="2.8" id="further-reading"><span class="header-section-number">2.8</span> Further Reading</h2>
<h3 data-number="2.8.1" id="primary-sources"><span class="header-section-number">2.8.1</span> Primary Sources</h3>
<ul>
<li>GNU Emacs Manual</li>
<li>Emacs Lisp Reference Manual</li>
<li>‚ÄúEMACS: The Extensible, Customizable Display Editor‚Äù (Stallman
1981)</li>
</ul>
<h3 data-number="2.8.2" id="historical-context"><span class="header-section-number">2.8.2</span> Historical Context</h3>
<ul>
<li>‚ÄúHackers: Heroes of the Computer Revolution‚Äù (Levy 1984)</li>
<li>GNU Project history</li>
</ul>
<h3 data-number="2.8.3" id="community-resources"><span class="header-section-number">2.8.3</span> Community Resources</h3>
<ul>
<li>EmacsWiki</li>
<li>Planet Emacsen</li>
<li>/r/emacs subreddit</li>
<li>#emacs IRC channel</li>
</ul>
<h2 data-number="2.9" id="author-notes"><span class="header-section-number">2.9</span> Author Notes</h2>
<p>This chapter should be welcoming to newcomers while providing value
to experienced developers. Balance historical context with practical
information. Keep code examples simple but illustrative.</p>
<h3 data-number="2.9.1" id="style-guidelines"><span class="header-section-number">2.9.1</span> Style Guidelines</h3>
<ul>
<li>Use accessible language</li>
<li>Explain jargon on first use</li>
<li>Include concrete examples</li>
<li>Maintain enthusiasm without hyperbole</li>
<li>Acknowledge Emacs‚Äô limitations honestly</li>
</ul>
<h3 data-number="2.9.2" id="common-pitfalls-to-address"><span class="header-section-number">2.9.2</span> Common Pitfalls to
Address</h3>
<ul>
<li>Confusion between Emacs and Elisp</li>
<li>Overwhelming newcomers with complexity</li>
<li>Assuming too much prior knowledge</li>
<li>Insufficient guidance on next steps</li>
</ul>
<h2 data-number="2.10" id="status-and-todo"><span class="header-section-number">2.10</span> Status and Todo</h2>
<ul class="task-list">
<li><label><input type="checkbox">Draft
01-what-is-emacs.md</input></label></li>
<li><label><input type="checkbox"/>Draft
02-architecture-overview.md</label></li>
<li><label><input type="checkbox"/>Draft
03-development-setup.md</label></li>
<li><label><input type="checkbox"/>Draft
04-navigating-source.md</label></li>
<li><label><input type="checkbox"/>Draft
05-reading-guide.md</label></li>
<li><label><input type="checkbox"/>Draft
06-contributing.md</label></li>
<li><label><input type="checkbox"/>Create architecture
diagrams</label></li>
<li><label><input type="checkbox"/>Test all code examples</label></li>
<li><label><input type="checkbox"/>Peer review</label></li>
<li><label><input type="checkbox"/>Technical review by
maintainers</label></li>
</ul>
<h2 data-number="2.11" id="changelog"><span class="header-section-number">2.11</span> Changelog</h2>
<ul>
<li>2025-11-18: Initial chapter structure and README created</li>
</ul>
<h1 data-number="3" id="welcome-to-the-emacs-encyclopedia"><span class="header-section-number">3</span> Welcome to the Emacs
Encyclopedia</h1>
<h2 data-number="3.1" id="a-living-monument-to-software-engineering"><span class="header-section-number">3.1</span> A Living Monument to Software
Engineering</h2>
<p>In the summer of 1976, on a PDP-10 computer at MIT‚Äôs Artificial
Intelligence Laboratory, a young programmer named Richard Stallman began
assembling a collection of TECO editor macros. These macros would grow
into something far more significant than a mere text editor‚Äîthey would
become EMACS, one of the longest-lived and most influential software
systems in computing history.</p>
<p>Nearly five decades later, that vision persists in GNU Emacs, a
system that now spans 2.6 million lines of code across nearly 3,000
files, runs on seven major platforms from smartphones to mainframes, and
continues to evolve with modern features like tree-sitter parsing,
Language Server Protocol integration, and native compilation. This
encyclopedia is your guide to understanding how this remarkable software
works, from the bit patterns in its tagged pointers to the design
patterns in its major modes.</p>
<h2 data-number="3.2" id="why-emacs-matters"><span class="header-section-number">3.2</span> Why Emacs Matters</h2>
<p>Before diving into the technical details, it‚Äôs worth understanding
why Emacs deserves serious study as a software artifact and cultural
phenomenon.</p>
<h3 data-number="3.2.1" id="the-longest-continuously-developed-software-project"><span class="header-section-number">3.2.1</span> The Longest Continuously
Developed Software Project</h3>
<p>Emacs represents something extraordinarily rare in computing: genuine
longevity. The original EMACS was operational in late 1976, making the
Emacs lineage 49 years old as of 2025. GNU Emacs itself has been in
continuous development since 1984‚Äîover 40 years of sustained evolution
by a single project with an unbroken chain of development.</p>
<p>Few software systems can claim this kind of tenure. Most programs
from the 1970s and 1980s are museum pieces, studied for historical
interest but no longer actively developed or used. Emacs is different:
it‚Äôs both a living fossil and a modern development platform. The same
conceptual framework that worked in 1976‚Äîan extensible, self-documenting
editor built around a powerful scripting language‚Äîcontinues to work in
2025, adapted and extended but fundamentally intact.</p>
<p>This longevity makes Emacs invaluable for understanding how software
systems can be designed to last. It‚Äôs a working laboratory for studying:
- <strong>Backward compatibility</strong>: How do you maintain it over
decades while still innovating? - <strong>Incremental
modernization</strong>: How do you adopt new technologies (tree-sitter,
LSP, native compilation) without abandoning your core architecture? -
<strong>Community continuity</strong>: How do you transfer knowledge and
culture across generations of developers? - <strong>API
stability</strong>: What makes an API stable enough to support an
ecosystem for 40 years?</p>
<p>The answers to these questions are embedded in Emacs‚Äôs design
decisions, development practices, and community culture.</p>
<h3 data-number="3.2.2" id="a-laboratory-for-programming-language-design"><span class="header-section-number">3.2.2</span> A Laboratory for Programming
Language Design</h3>
<p>Emacs Lisp (Elisp) is one of the most widely deployed Lisp dialects,
with millions of users running billions of lines of Elisp code daily.
But beyond its deployment scale, Elisp has served as an experimental
platform for programming language features.</p>
<p>The evolution of Elisp mirrors broader trends in language design:</p>
<p><strong>Dynamic to Static Analysis</strong>: While Elisp remains
dynamically typed, modern versions include increasingly sophisticated
static analysis tools. The byte-compiler performs type inference and
optimization. The <code>checkdoc</code> system enforces documentation
standards. <code>Flycheck</code> and <code>flymake</code> provide
real-time feedback.</p>
<p><strong>Lexical Scoping</strong>: For decades, Elisp used only
dynamic scoping. Emacs 24 (2012) introduced optional lexical scoping,
demonstrating how a mature language can evolve fundamental semantics
while maintaining compatibility. The migration from dynamic to lexical
scoping‚Äîfile by file, over more than a decade‚Äîis a case study in gradual
type system migration.</p>
<p><strong>Native Compilation</strong>: Emacs 28‚Äôs native compilation
(via libgccjit) shows how a dynamically-typed, interpreted language can
transparently gain native code performance without changing its
semantics. This is active research territory: how do you compile a
highly dynamic language while preserving its dynamism?</p>
<p><strong>Concurrency Models</strong>: Emacs has experimented with
multiple approaches to concurrency: asynchronous processes, cooperative
threading, and limited preemptive threading. The constraints (backward
compatibility, single-threaded core) make this challenging, providing
insights into retrofitting concurrency into existing systems.</p>
<p>These experiments happen in a production environment with millions of
users, providing real-world feedback that academic languages rarely
receive.</p>
<h3 data-number="3.2.3" id="cultural-significance-in-the-free-software-movement"><span class="header-section-number">3.2.3</span> Cultural Significance in the
Free Software Movement</h3>
<p>Emacs occupies a unique position in software history as both an
artifact and an agent of the free software movement. It was the first
major program of the GNU Project, and its development helped establish
patterns that would define free software development for decades.</p>
<p>The practice of including complete source code with every
distribution, the expectation that users could and should modify their
software, the emphasis on documentation and accessibility‚Äîthese weren‚Äôt
universal before Emacs made them so. When Richard Stallman wrote the GNU
Manifesto in 1985, he could point to GNU Emacs as proof that the free
software model could produce professional-quality software.</p>
<p>Emacs‚Äôs development model influenced countless later projects: -
<strong>Distributed development</strong>: Contributors worldwide,
communicating via mailing lists and later version control -
<strong>Meritocratic governance</strong>: Technical merit and sustained
contribution determine influence - <strong>Comprehensive
documentation</strong>: Users deserve to understand their tools -
<strong>User empowerment</strong>: The boundary between user and
developer should be permeable</p>
<p>Modern open source development owes a debt to the patterns Emacs
established. When we talk about ‚Äúeating your own dog food,‚Äù ‚Äúrelease
early, release often,‚Äù or ‚Äúgiven enough eyeballs, all bugs are shallow,‚Äù
we‚Äôre describing practices that Emacs exemplified before they had
names.</p>
<h3 data-number="3.2.4" id="influence-on-modern-editors"><span class="header-section-number">3.2.4</span> Influence on Modern
Editors</h3>
<p>While Emacs‚Äôs market share is modest compared to VS Code or IntelliJ,
its conceptual influence is profound. Many ideas pioneered in Emacs are
now standard features in modern editors:</p>
<p><strong>Extensibility Through Scripting</strong>: VS Code‚Äôs
JavaScript/TypeScript extension API, Atom‚Äôs CoffeeScript/JavaScript
plugins, Sublime Text‚Äôs Python API‚Äîall follow Emacs‚Äôs model of exposing
editor internals through a scripting language. The idea that users
should be able to program their editor, not just configure it, comes
from Emacs.</p>
<p><strong>Self-Documentation</strong>: The practice of documenting
functions and variables in the code itself, then making that
documentation queryable at runtime, originated with Emacs. Modern IDEs‚Äô
inline documentation features descend from this innovation. The very
concept of an IDE being able to explain itself comes from Emacs‚Äôs
<code>C-h</code> help system.</p>
<p><strong>Package Ecosystems</strong>: Emacs‚Äôs MELPA (Emacs Lisp
Package Archive) and ELPA (Emacs Lisp Package Archive) anticipated
modern package managers. VS Code‚Äôs extension marketplace, Atom‚Äôs package
system, and similar mechanisms all follow the pattern Emacs established:
a central repository of community-contributed extensions that users can
browse, install, and update from within the editor.</p>
<p><strong>Modal Editing Alternatives</strong>: While Vim popularized
modal editing, Emacs demonstrated that a modeless, mnemonic keybinding
system could also be powerful. Modern editors‚Äô command palettes (VS
Code‚Äôs <code>Ctrl+Shift+P</code>, Sublime‚Äôs <code>Cmd+Shift+P</code>)
are descendants of Emacs‚Äôs <code>M-x</code> command interface.</p>
<p><strong>Language Server Protocol (LSP)</strong>: While Microsoft
created LSP, the problem it solves‚Äîseparating language-specific
intelligence from the editor‚Äîis one Emacs grappled with for decades.
Emacs‚Äôs various completion and navigation systems (etags, GNU Global,
CEDET) were attempts to solve the same problem. LSP finally standardized
what Emacs had been doing ad-hoc for years.</p>
<p>The fundamental architectural insight‚Äîthat an editor should be a
platform, not just an application‚Äîcame from Emacs and has become the
dominant paradigm in modern development tools.</p>
<h2 data-number="3.3" id="emacs-in-computing-history"><span class="header-section-number">3.3</span> Emacs in Computing History</h2>
<p>To understand Emacs‚Äôs significance, we need to place it in the
broader context of text editor evolution and software engineering
history.</p>
<h3 data-number="3.3.1" id="place-in-text-editor-evolution"><span class="header-section-number">3.3.1</span> Place in Text Editor
Evolution</h3>
<p>The history of text editors is a history of increasing abstraction
and user empowerment:</p>
<p><strong>First Generation (1960s)</strong>: Line editors like
<code>ed</code> and <code>EDIT</code>. You specified line numbers and
operations. You didn‚Äôt see the text; you commanded it. These editors
reflected the constraints of teletypes and slow connections.</p>
<p><strong>Second Generation (1970s)</strong>: Screen editors like
<code>vi</code> and the original EMACS. Text appeared on screen. Edits
were visible immediately. This reflected the advent of video terminals.
Modal editors (vi) used fewer keys by having different modes; modeless
editors (EMACS) required more key combinations but had simpler mental
models.</p>
<p><strong>Third Generation (1980s-1990s)</strong>: GUI editors like
<code>BBEdit</code>, early versions of Microsoft Word, and GUI-capable
editors like GNU Emacs 19. Mouse interaction, menus, multiple fonts, and
visual formatting. This reflected graphical workstations and personal
computers.</p>
<p><strong>Fourth Generation (2000s-2010s)</strong>: IDEs like Eclipse,
IntelliJ IDEA, and Visual Studio. Language-aware editing, refactoring,
debugging integration, project management. Editors became development
environments.</p>
<p><strong>Fifth Generation (2010s-present)</strong>: Modern
programmable editors like VS Code, Atom, and Sublime Text. Combine the
extensibility of Emacs with modern UI conventions, language servers, and
package ecosystems. Cloud integration and remote development.</p>
<p>Emacs is remarkable for having participated in generations 2-5. It
started as a second-generation screen editor, evolved GUI capabilities
in the third generation, adopted IDE features in the fourth, and
integrated language servers and modern parsing in the fifth. It‚Äôs one of
the few editors to successfully navigate this entire evolution.</p>
<h3 data-number="3.3.2" id="contributions-to-software-engineering"><span class="header-section-number">3.3.2</span> Contributions to Software
Engineering</h3>
<p>Beyond text editing, Emacs has contributed to broader software
engineering practice:</p>
<p><strong>Incremental Redisplay</strong>: Emacs‚Äôs redisplay algorithm,
which efficiently updates only the changed portions of the screen,
pioneered techniques later used in GUI frameworks and game engines. The
problem‚Äîdetermining minimal changes to transform one screen state to
another‚Äîis fundamental to interactive systems.
<code>/home/user/emacs/src/xdisp.c</code>, at over 36,000 lines, is a
master class in display optimization.</p>
<p><strong>Gap Buffers</strong>: The gap buffer data structure, used in
Emacs for efficient text editing, is now taught in data structures
courses. It provides O(1) insertion and deletion at the cursor position,
which is the common case in text editing. This is documented in
<code>/home/user/emacs/src/buffer.c</code> and
<code>/home/user/emacs/src/insdel.c</code>.</p>
<p><strong>Garbage Collection</strong>: Emacs has implemented and
refined garbage collection strategies for Lisp objects for 40 years. The
generational collector, the marking algorithms, the handling of weak
references‚Äîthese are production-tested solutions to hard problems. See
<code>/home/user/emacs/src/alloc.c</code> for implementation.</p>
<p><strong>Process Interaction</strong>: Emacs pioneered the idea of
embedding subprocess interaction in an editor. Compilation buffers,
shell modes, debugger integration‚Äîthe concept of treating subprocess I/O
as editable text was novel. This pattern now appears in Jupyter
notebooks, REPL-driven development, and interactive computing
environments.</p>
<p><strong>Asynchronous Programming</strong>: Before async/await was
popular, Emacs was managing asynchronous operations through filters,
sentinels, and event loops. The patterns in
<code>/home/user/emacs/src/process.c</code> for managing multiple
asynchronous processes influenced later systems.</p>
<p><strong>Portable Dumper</strong>: The portable dumper (replacing the
older unexec mechanism) solves the problem of saving and restoring a
complete application state across systems. This is relevant to
checkpoint/restart systems, application deployment, and fast startup
times.</p>
<h3 data-number="3.3.3" id="innovations-that-came-from-emacs"><span class="header-section-number">3.3.3</span> Innovations That Came From
Emacs</h3>
<p>Several computing concepts either originated in Emacs or were
popularized by it:</p>
<p><strong>Self-Documenting Code</strong>: The practice of embedding
documentation in code and making it runtime-accessible originated with
the first EMACS in 1976. The ACM paper ‚ÄúEMACS the extensible,
customizable self-documenting display editor‚Äù (1981) formalized this
concept. Subsequently, this practice spread to programming languages:
Lisp, Java (Javadoc), Python (docstrings), Perl (POD), and many others
adopted similar conventions.</p>
<p><strong>Real-Time Display Editing</strong>: Before EMACS, most
editors were line-oriented or required explicit commands to display
text. EMACS‚Äôs innovation was making changes immediately visible,
creating the ‚Äúwhat you see is what you get‚Äù (WYSIWYG) expectation for
text editing.</p>
<p><strong>Extensible Editor Architecture</strong>: While earlier
editors allowed customization, EMACS was the first to make extension in
the same language as the implementation a core feature. This
‚Äúdogfooding‚Äù approach‚Äîwriting the editor in its own extension
language‚Äîwas revolutionary.</p>
<p><strong>Keyboard Macro Recording</strong>: The ability to record a
sequence of keystrokes and replay them was popularized by Emacs. While
not necessarily originated there, Emacs made it accessible and powerful,
influencing later editors and automation tools.</p>
<p><strong>Integrated Development Environments (Conceptually)</strong>:
While the term ‚ÄúIDE‚Äù came later, Emacs pioneered the concept with modes
like <code>gdb-mode</code>, compilation integration, and
language-specific editing support. The idea that an editor could
understand code structure, integrate with compilers and debuggers, and
provide project-wide operations originated in Emacs culture.</p>
<h3 data-number="3.3.4" id="academic-and-research-impact"><span class="header-section-number">3.3.4</span> Academic and Research
Impact</h3>
<p>Emacs has been both a subject of research and a platform for
research:</p>
<p><strong>As Research Subject</strong>: - <strong>Programming Language
Evolution</strong>: Papers studying Elisp‚Äôs evolution from dynamic to
lexical scoping, including ‚ÄúEvolution of Emacs Lisp‚Äù (HOPL 2020),
examine how production languages evolve while maintaining compatibility.
- <strong>Software Longevity</strong>: Studies of long-lived software
projects frequently cite Emacs as an example of sustainable software
architecture. - <strong>Community Governance</strong>: Research on open
source governance often examines Emacs‚Äôs maintainer succession,
contribution processes, and copyright assignment practices. -
<strong>API Design</strong>: Emacs‚Äôs stable API over decades makes it a
case study in interface design and backward compatibility.</p>
<p><strong>As Research Platform</strong>: - <strong>Computational
Linguistics</strong>: Emacs modes for text analysis, corpus annotation,
and linguistic research. - <strong>Literate Programming</strong>:
Org-mode, included with Emacs, has become the standard for reproducible
research in many fields, supporting executable code blocks in multiple
languages. - <strong>Theorem Proving</strong>: Proof General provides
Emacs interfaces to theorem provers like Coq and Isabelle, making Emacs
a primary interface for formal mathematics and verification. -
<strong>Scientific Computing</strong>: ESS (Emacs Speaks Statistics)
provides sophisticated R and Julia integration, making Emacs a serious
platform for data science.</p>
<p>Emacs appears in computer science curricula as an example of: -
Long-lived software systems - Lisp implementation - Extensible
architectures - Open source development - Domain-specific languages
(Elisp as a DSL for text editing)</p>
<h2 data-number="3.4" id="the-gnu-connection"><span class="header-section-number">3.4</span> The GNU Connection</h2>
<p>Emacs‚Äôs relationship with the GNU Project and the free software
movement is not merely historical‚Äîit‚Äôs foundational to understanding
both Emacs‚Äôs design and its cultural position.</p>
<h3 data-number="3.4.1" id="first-major-gnu-project"><span class="header-section-number">3.4.1</span> First Major GNU Project</h3>
<p>When Richard Stallman announced the GNU Project in September 1983, he
outlined an ambitious goal: create a complete Unix-compatible operating
system composed entirely of free software. This was not merely a
technical project but a political and philosophical one‚Äîa rejection of
the proprietary software model that was closing off the previously open
computing culture.</p>
<p>GNU Emacs, begun in September 1984, was the first substantial program
of this project. This timing was strategic. An operating system requires
many components‚Äîkernel, shell, compiler, utilities, editor‚Äîbut an editor
was something Stallman knew intimately and could build independently.
Moreover, an editor is immediately useful. You don‚Äôt need a complete
operating system to benefit from a good editor.</p>
<p>The first public release, version 13 (the number indicating it wasn‚Äôt
the first Emacs, but the culmination of the EMACS tradition), came on
March 20, 1985. This predated most other GNU components: - <strong>GNU C
Compiler (GCC)</strong>: First release June 1987 - <strong>GNU
Bash</strong>: First release June 1989 - <strong>GNU Linux Kernel
(Linux)</strong>: First release September 1991 (and Linux wasn‚Äôt a GNU
project, though it integrated with GNU tools)</p>
<p>GNU Emacs thus served as proof-of-concept that the free software
model could work. It was professional-quality software, distributed with
full source code, that users could modify and redistribute freely. When
skeptics questioned whether the GNU Project could produce real software,
Stallman could point to GNU Emacs.</p>
<h3 data-number="3.4.2" id="role-in-the-free-software-movement"><span class="header-section-number">3.4.2</span> Role in the Free Software
Movement</h3>
<p>GNU Emacs did more than demonstrate feasibility‚Äîit helped establish
the practices and culture of free software development:</p>
<p><strong>The GNU General Public License (GPL)</strong>: GNU Emacs was
one of the first programs distributed under the GPL. Version 1 of the
GPL was released in February 1989, but earlier versions of Emacs used a
predecessor that embodied the same principles. The GPL‚Äôs copyleft
provision‚Äîthat derivative works must also be free‚Äîwas partly designed to
protect Emacs from proprietary forks.</p>
<p>This was a response to history. Gosling Emacs, written by James
Gosling (later famous for Java), was initially distributed with source
code. But Gosling sold it to a company that made it proprietary,
preventing further free distribution. The GPL was designed to prevent
this: you could build on GNU Emacs, but your improvements had to remain
free.</p>
<p><strong>Copyright Assignment</strong>: The Free Software Foundation
requires copyright assignment for contributions to GNU Emacs.
Contributors retain rights to use their code, but assign copyright to
the FSF. This allows the FSF to enforce the GPL in court and potentially
relicense if necessary.</p>
<p>This practice is controversial‚Äîmany modern projects don‚Äôt require
it‚Äîbut it reflects Stallman‚Äôs commitment to protecting software freedom
legally. The FSF has used its unified copyright to defend the GPL in
licensing disputes, vindicating this approach in some developers‚Äô
eyes.</p>
<p><strong>Distribution Philosophy</strong>: GNU Emacs established the
pattern of distributing complete source code, comprehensive
documentation, and build infrastructure. The expectation that a software
distribution includes everything needed to understand, modify, and
rebuild it comes from GNU, with Emacs as the exemplar.</p>
<p><strong>Community Access</strong>: From the beginning, GNU Emacs
development was open to contributors worldwide. Patches were discussed
on mailing lists, contributions were evaluated on technical merit, and
improvements were incorporated regardless of the contributor‚Äôs
affiliation. This meritocratic, distributed model predated ‚Äúopen source‚Äù
as a term and helped establish the norms later codified in open source
culture.</p>
<h3 data-number="3.4.3" id="copyleft-and-gpl-implications"><span class="header-section-number">3.4.3</span> Copyleft and GPL
Implications</h3>
<p>The GPL‚Äôs copyleft provision has profound implications for Emacs‚Äôs
ecosystem:</p>
<p><strong>Package Licensing</strong>: Emacs packages that are
distributed with GNU Emacs must be GPL-compatible. This means MELPA and
other package archives contain mostly GPL-licensed code. Some argue this
limits adoption; others argue it ensures freedom is preserved.</p>
<p><strong>Dynamic Linking Debate</strong>: Elisp‚Äôs nature as a
dynamically loaded extension language raised questions: Does loading an
Elisp file into Emacs create a derivative work? The FSF‚Äôs position is
yes‚ÄîElisp packages are derivative works of Emacs and thus must be
GPL-compatible. This interpretation is debated but shapes the
ecosystem.</p>
<p><strong>Proprietary Extension Barriers</strong>: Unlike editors with
permissive licenses, proprietary Emacs extensions are legally
problematic under the FSF‚Äôs interpretation of the GPL. This has
advantages (ensuring freedom) and disadvantages (limiting certain
commercial uses).</p>
<p><strong>Fork Prevention</strong>: The GPL‚Äôs copyleft has largely
prevented proprietary forks. XEmacs, the major fork of GNU Emacs in the
1990s, remained free software. The GPL ensured that improvements
couldn‚Äôt be captured by proprietary interests.</p>
<p><strong>GNU Project Integration</strong>: Because Emacs is a GNU
Project package, its development priorities sometimes reflect broader
GNU goals. For instance, support for GNU/Linux systems receives
particular attention, and integration with other GNU tools (GCC, GDB,
make, etc.) is prioritized.</p>
<h3 data-number="3.4.4" id="community-governance-model"><span class="header-section-number">3.4.4</span> Community Governance
Model</h3>
<p>Emacs‚Äôs governance has evolved but retains distinctive
characteristics:</p>
<p><strong>Benevolent Dictator to Maintainer Team</strong>: Stallman was
the original ‚Äúbenevolent dictator‚Äù until 2008, when he stepped down as
lead maintainer (remaining as GNU Emacs‚Äôs architect). Since then,
governance has been shared among maintainers, with a more collaborative
model.</p>
<p><strong>Consensus-Seeking</strong>: Major decisions are discussed on
the emacs-devel mailing list, seeking rough consensus. While maintainers
have final say, they typically defer to community sentiment on
controversial issues.</p>
<p><strong>Stable and Development Branches</strong>: Emacs uses a stable
release model with clear version numbers. Development happens on
master/main, with periodic releases. This provides stability for users
while allowing continuous innovation.</p>
<p><strong>Conservative Change Philosophy</strong>: Backward
compatibility is highly valued. Breaking changes require strong
justification. This conservatism frustrates some who want faster
innovation but ensures reliability.</p>
<p><strong>Public Development</strong>: All development happens in
public‚Äîmailing lists are archived, commit history is available, bug
reports are open. This transparency is a GNU Project principle.</p>
<p>The governance model has allowed Emacs to survive maintainer
transitions, incorporate contributors across decades, and maintain
coherence despite distributed development. It‚Äôs a case study in
sustaining a volunteer-driven project over decades.</p>
<h2 data-number="3.5" id="technical-innovations"><span class="header-section-number">3.5</span> Technical Innovations</h2>
<p>Emacs has pioneered or refined numerous technical innovations over
its history. Some are well-known; others are subtle but significant.</p>
<h3 data-number="3.5.1" id="lisp-based-extension-from-day-one"><span class="header-section-number">3.5.1</span> Lisp-Based Extension From Day
One</h3>
<p>The decision to build GNU Emacs around a full Lisp interpreter wasn‚Äôt
obvious in 1984. Most editors used macro languages or configuration
files. Lisp was considered esoteric, academic, and slow. But Stallman‚Äôs
choice was deliberate and transformative.</p>
<p><strong>Why Lisp?</strong></p>
<ol type="1">
<li><p><strong>Homoiconicity</strong>: Lisp code is Lisp data. This
means programs can manipulate programs, enabling powerful
metaprogramming and introspection. When you ask Emacs to describe a
function, it can show you the actual code because code is data.</p></li>
<li><p><strong>Garbage Collection</strong>: Automatic memory management
meant extension writers didn‚Äôt need to manage memory explicitly,
reducing errors and development time.</p></li>
<li><p><strong>Dynamic Typing</strong>: While controversial today,
dynamic typing allowed rapid prototyping and modification without
compilation cycles. You could redefine a function and immediately test
it.</p></li>
<li><p><strong>First-Class Functions</strong>: Functions as data meant
they could be passed as arguments, stored in data structures, and
generated on the fly. This enabled higher-order patterns like hooks,
advice, and functional composition.</p></li>
<li><p><strong>Read-Eval-Print Loop (REPL)</strong>: Emacs itself is
essentially a persistent REPL. You can evaluate expressions, see
results, modify code, and re-evaluate without restarting.</p></li>
</ol>
<p><strong>Implications</strong>:</p>
<p>The Lisp foundation meant that extension writers had the full power
of a real programming language. They weren‚Äôt limited to a ‚Äúplugin
API‚Äù‚Äîthey had the same tools as Emacs developers. A user‚Äôs configuration
file (<code>.emacs</code> or <code>init.el</code>) is Lisp code that
executes at startup, with complete access to Emacs internals.</p>
<p>This has profound implications: - <strong>No Artificial
Limitations</strong>: If you can imagine an extension, you can probably
implement it. The editor isn‚Äôt limited by what the developers
anticipated. - <strong>Organic Growth</strong>: Features start as user
configurations, become packages, and sometimes migrate into core Emacs.
There‚Äôs a smooth gradient from user to developer. - <strong>Learning
Curve</strong>: The power comes with complexity. Learning Emacs deeply
means learning Elisp. - <strong>Performance Challenges</strong>: Lisp is
slower than C for raw computation, though bytecode and native
compilation mitigate this.</p>
<h3 data-number="3.5.2" id="self-documenting-code"><span class="header-section-number">3.5.2</span> Self-Documenting Code</h3>
<p>The concept of self-documenting code‚Äîwhere every function, variable,
and keybinding is documented within the system itself‚Äîis so fundamental
to Emacs that users take it for granted. But this was revolutionary in
1976 and remains unusual today.</p>
<p><strong>How It Works</strong>:</p>
<p>Every Elisp function can (and should) have a documentation string as
its second element:</p>
<pre class="elisp"><code>(defun my-function (arg)
  "This docstring describes what my-function does.
ARG is explained here."
  (message "Hello %s" arg))</code></pre>
<p>At runtime, you can retrieve this documentation:</p>
<pre class="elisp"><code>(documentation 'my-function)
;=&gt; "This docstring describes what my-function does.\nARG is explained here."</code></pre>
<p>This powers the help system: - <code>C-h f</code> (describe-function)
shows function documentation - <code>C-h v</code> (describe-variable)
shows variable documentation - <code>C-h k</code> (describe-key) shows
what a key does - <code>C-h m</code> (describe-mode) shows mode-specific
bindings and behavior</p>
<p>More remarkably, help buffers make function and variable names into
hyperlinks to their source code. The system is transparent: you can
always drill down to understand how something works.</p>
<p><strong>Why This Matters</strong>:</p>
<ol type="1">
<li><p><strong>Discovery</strong>: New users can explore by asking ‚Äúwhat
does this key do?‚Äù rather than searching external
documentation.</p></li>
<li><p><strong>Accuracy</strong>: Documentation can‚Äôt become outdated
relative to code‚Äîit‚Äôs part of the code.</p></li>
<li><p><strong>Context</strong>: Documentation is available in the
context where you need it, not in a separate manual.</p></li>
<li><p><strong>Learning</strong>: You learn by using the help system,
building mental models of how things work.</p></li>
</ol>
<p>This innovation spread beyond Emacs. Python‚Äôs docstrings, Java‚Äôs
Javadoc, Perl‚Äôs POD, and other systems all echo Emacs‚Äôs
self-documentation approach.</p>
<h3 data-number="3.5.3" id="portable-dumper"><span class="header-section-number">3.5.3</span> Portable Dumper</h3>
<p>Emacs‚Äôs startup time has always been a challenge: loading and
initializing 1.56 million lines of Elisp takes time. The solution is
dumping: save a running Emacs‚Äôs memory image to disk, then reload it
quickly on startup.</p>
<p><strong>Historical Approach: Unexec</strong></p>
<p>For decades, Emacs used <code>unexec</code>, a platform-specific
mechanism to dump the memory of a running process to an executable file.
This was fragile‚Äîit required intimate knowledge of each platform‚Äôs
executable format (a.out, COFF, ELF, Mach-O, PE). Every OS update risked
breaking it.</p>
<p><strong>Modern Approach: Portable Dumper</strong></p>
<p>Emacs 27 introduced the portable dumper, replacing unexec. Instead of
dumping raw memory, it:</p>
<ol type="1">
<li>Serializes Lisp objects to a platform-independent format</li>
<li>Writes this to a <code>.pdmp</code> file</li>
<li>On startup, loads the dump file and reconstructs objects</li>
</ol>
<p>This is implemented in <code>/home/user/emacs/src/pdumper.c</code>
(~6,000 lines). The benefits:</p>
<ul>
<li><strong>Portability</strong>: Works the same on all platforms</li>
<li><strong>Safety</strong>: Doesn‚Äôt depend on executable formats</li>
<li><strong>Flexibility</strong>: Can dump at different points in
initialization</li>
<li><strong>Maintainability</strong>: Much simpler than unexec</li>
</ul>
<p>The portable dumper demonstrates Emacs‚Äôs ability to replace
fundamental mechanisms while maintaining compatibility. Version 31 is
removing unexec entirely, completing this multi-year migration.</p>
<h3 data-number="3.5.4" id="tree-sitter-integration"><span class="header-section-number">3.5.4</span> Tree-Sitter Integration</h3>
<p>Traditional syntax highlighting in Emacs used regular expressions and
heuristics. This is fast but fundamentally limited‚Äîyou can‚Äôt properly
parse context-free grammars with regular expressions. Complex languages
(JavaScript, C++, Python) had highlighting bugs because regex couldn‚Äôt
handle nesting, scoping, and context-dependent syntax.</p>
<p><strong>Tree-Sitter Solution</strong>:</p>
<p>Tree-sitter (https://tree-sitter.github.io) is an incremental parsing
library that builds proper syntax trees. Emacs 29 integrated it,
providing:</p>
<ol type="1">
<li><strong>Accurate Parsing</strong>: Real parse trees, not regex
approximations</li>
<li><strong>Incremental Updates</strong>: Only re-parses edited regions,
staying fast</li>
<li><strong>Query Language</strong>: A declarative language for
extracting patterns from trees</li>
<li><strong>Shared Grammars</strong>: Language grammars are separate
libraries, shared across editors</li>
</ol>
<p>The integration (<code>/home/user/emacs/src/treesit.c</code>,
<code>/home/user/emacs/lisp/treesit.el</code>) exposes tree-sitter to
Elisp:</p>
<pre class="elisp"><code>;; Get the syntax tree
(treesit-buffer-root-node)

;; Query for all function definitions
(treesit-query-capture 'python
  '((function_definition name: (identifier) @name)))</code></pre>
<p>This enables: - <strong>Better Highlighting</strong>: Based on actual
syntax structure - <strong>Structural Navigation</strong>: Jump between
functions, classes, blocks - <strong>Code Folding</strong>: Hide/show
based on parse tree structure - <strong>Indentation</strong>: Based on
syntax, not heuristics - <strong>Analysis</strong>: Refactoring tools
can use real syntax understanding</p>
<p><strong>Impact</strong>:</p>
<p>Tree-sitter brings Emacs‚Äôs code understanding to modern standards.
Editors like Atom, NeoVim, and Helix adopted it for similar reasons.
This shows Emacs can integrate modern parsing technology while
maintaining its architecture.</p>
<h3 data-number="3.5.5" id="native-compilation"><span class="header-section-number">3.5.5</span> Native Compilation</h3>
<p>For 35+ years, Emacs Lisp was either interpreted or byte-compiled.
Byte-compilation provided some speedup, but Elisp remained significantly
slower than native code. This was the price of dynamic flexibility.</p>
<p><strong>The Native Compiler (Emacs 28+)</strong>:</p>
<p>The native compiler, implemented in
<code>/home/user/emacs/src/comp.c</code> and
<code>/home/user/emacs/lisp/emacs-lisp/comp.el</code>, changes this:</p>
<ol type="1">
<li><strong>Elisp to LAP</strong>: Converts Elisp (or bytecode) to LAP
(Lisp Assembly Program), an intermediate representation</li>
<li><strong>LAP to LIMPLE</strong>: Translates to LIMPLE (Lisp
Middle-end Intermediate Language), a lower-level IR</li>
<li><strong>LIMPLE to C</strong>: Generates C-like code</li>
<li><strong>libgccjit</strong>: Uses GCC‚Äôs JIT library to compile to
native machine code</li>
<li><strong>Caching</strong>: Stores compiled <code>.eln</code> files
for reuse</li>
</ol>
<p><strong>Performance</strong>:</p>
<p>Native compilation provides 2-5x speedups for Lisp-heavy code.
Startup with precompiled native code is faster. Complex modes respond
more quickly.</p>
<p><strong>Transparency</strong>:</p>
<p>Crucially, native compilation is transparent. No code changes
required. If native compilation fails, Emacs falls back to bytecode.
Users get faster performance without any compatibility breaks.</p>
<p><strong>Technical Achievement</strong>:</p>
<p>Compiling a highly dynamic language while preserving its semantics is
difficult. Elisp allows: - Redefining functions at runtime - Advising
(wrapping) functions - Dynamic variable binding - Runtime type
changes</p>
<p>The native compiler preserves all this while still generating fast
code. It‚Äôs a significant technical achievement, documented in several
papers and conference talks.</p>
<h3 data-number="3.5.6" id="other-technical-innovations"><span class="header-section-number">3.5.6</span> Other Technical
Innovations</h3>
<p><strong>Text Properties and Overlays</strong>: Emacs allows attaching
arbitrary properties to text ranges. This enables syntax highlighting
(face properties), invisibility, mouse interaction, and more. The
overlay system provides a separate mechanism for temporary annotations.
These are implemented in <code>/home/user/emacs/src/buffer.c</code> and
<code>/home/user/emacs/src/textprop.c</code>.</p>
<p><strong>Process Filters and Sentinels</strong>: Asynchronous
subprocess interaction through filters (functions called with output)
and sentinels (functions called on status changes) predated modern async
patterns. See <code>/home/user/emacs/src/process.c</code>.</p>
<p><strong>Incremental Search</strong>: The <code>isearch</code>
(incremental search) feature, where search happens as you type with
immediate visual feedback, was innovative when introduced and influenced
modern find-as-you-type features.</p>
<p><strong>Keyboard Macros</strong>: Recording and replaying keystroke
sequences, with counters, conditionals, and editing, provides powerful
automation without programming.</p>
<p><strong>Multiple Windows and Frames</strong>: Emacs‚Äôs window model,
where a frame (top-level window) can contain multiple windows (panes
showing buffers), with sophisticated splitting and navigation, was
advanced for its time.</p>
<h2 data-number="3.6" id="lessons-for-modern-software"><span class="header-section-number">3.6</span> Lessons for Modern
Software</h2>
<p>After 49 years of continuous evolution, Emacs offers valuable lessons
for contemporary software development.</p>
<h3 data-number="3.6.1" id="longevity-and-maintenance"><span class="header-section-number">3.6.1</span> Longevity and
Maintenance</h3>
<p><strong>Lesson: Architecture for Decades, Not Years</strong></p>
<p>Emacs‚Äôs core architecture‚ÄîC core plus Lisp extension‚Äîhas remained
stable since 1985. This 40-year stability didn‚Äôt happen by accident. Key
principles:</p>
<ol type="1">
<li><p><strong>Clear Abstraction Layers</strong>: The C core provides
primitives (buffers, windows, processes, display); Lisp builds policies
on top. This separation means implementation can change without
affecting high-level code.</p></li>
<li><p><strong>Conservative Core, Flexible Extensions</strong>: The core
evolves slowly and carefully. Extensions and packages can innovate
rapidly without destabilizing the system.</p></li>
<li><p><strong>Avoid Premature Optimization</strong>: Early Emacs
prioritized clarity and correctness over raw performance. Performance
improvements came later (bytecode, native compilation) without changing
semantics.</p></li>
<li><p><strong>Design for Replacement</strong>: The portable dumper
replaced unexec. Tree-sitter is replacing regex-based parsing. Design
core systems so they can be replaced when better approaches
emerge.</p></li>
</ol>
<p><strong>Modern Application</strong>:</p>
<p>Contemporary systems often prioritize short-term velocity over
long-term sustainability. Emacs demonstrates that careful initial design
pays off over decades. The cost is slower initial development; the
benefit is a system that doesn‚Äôt require rewrites.</p>
<p>Cloud-native applications, microservices, and modern web frameworks
change frequently. But fundamental infrastructure‚Äîdatabases, compilers,
operating systems‚Äîbenefits from Emacs-like stability. Know which
category your system belongs to.</p>
<h3 data-number="3.6.2" id="api-stability"><span class="header-section-number">3.6.2</span> API Stability</h3>
<p><strong>Lesson: Stability Enables Ecosystems</strong></p>
<p>Emacs has thousands of packages, many maintained independently by
different authors. This ecosystem exists because Emacs‚Äôs APIs are
extraordinarily stable. Elisp code from the 1990s often still works.</p>
<p><strong>How Emacs Achieves This</strong>:</p>
<ol type="1">
<li><p><strong>Deprecation Over Removal</strong>: Old functions are
marked obsolete but remain functional for years (often decades).
Warnings guide users to new approaches.</p></li>
<li><p><strong>Compatibility Layers</strong>: When changing fundamental
mechanisms (dynamic to lexical scoping), provide compatibility
modes.</p></li>
<li><p><strong>Semantic Versioning</strong>: Version numbers convey
compatibility expectations. Major versions can break compatibility
(though rarely do); minor versions maintain it.</p></li>
<li><p><strong>Documentation of Contracts</strong>: Functions document
their contracts explicitly. Breaking these contracts requires strong
justification.</p></li>
<li><p><strong>Large Standard Library</strong>: By including
comprehensive functionality in the core, Emacs reduces the need for
breaking changes to accommodate new features.</p></li>
</ol>
<p><strong>Modern Application</strong>:</p>
<p>‚ÄúMove fast and break things‚Äù works for early-stage products but kills
ecosystems. If you want third-party developers to build on your
platform, you need API stability. Emacs shows that you can have both
stability and innovation‚Äîthe stable core enables innovative
extensions.</p>
<p>Cloud providers (AWS, Azure, GCP) understand this: they rarely break
existing APIs, preferring to version them or add new ones. This is the
Emacs approach at scale.</p>
<h3 data-number="3.6.3" id="community-management"><span class="header-section-number">3.6.3</span> Community Management</h3>
<p><strong>Lesson: Sustainable Communities Require
Governance</strong></p>
<p>Emacs has survived multiple generations of developers. The community
has maintained coherence despite distributed, volunteer development over
decades.</p>
<p><strong>Key Practices</strong>:</p>
<ol type="1">
<li><p><strong>Public Development</strong>: All development happens in
public (mailing lists, public git repo). This transparency builds trust
and allows new contributors to learn by observation.</p></li>
<li><p><strong>Documentation Requirements</strong>: Contributions
without documentation are incomplete. This ensures knowledge
transfer.</p></li>
<li><p><strong>Mentorship</strong>: Experienced developers mentor
newcomers through the patch submission process.</p></li>
<li><p><strong>Maintainer Succession</strong>: Leadership has
transitioned multiple times without crises. This requires intentional
succession planning.</p></li>
<li><p><strong>Conflict Resolution</strong>: The community has
mechanisms for resolving technical disputes (discussion, maintainer
decisions, sometimes forks like XEmacs).</p></li>
<li><p><strong>Credit Attribution</strong>: ChangeLog entries and commit
messages credit contributors, building a history of
participation.</p></li>
</ol>
<p><strong>Modern Application</strong>:</p>
<p>Many open source projects struggle with burnout, maintainer turnover,
and toxic communities. Emacs‚Äôs longevity demonstrates that sustainable
communities require intentional governance, not just code quality.</p>
<p>Modern projects can learn from Emacs‚Äôs formality: clear contribution
guidelines, documented decision-making processes, explicit maintainer
roles, and commitment to transparency.</p>
<h3 data-number="3.6.4" id="documentation-practices"><span class="header-section-number">3.6.4</span> Documentation Practices</h3>
<p><strong>Lesson: Documentation Is Infrastructure, Not
Afterthought</strong></p>
<p>Emacs‚Äôs comprehensive documentation (manuals totaling thousands of
pages, plus self-documentation) isn‚Äôt optional‚Äîit‚Äôs fundamental to the
system‚Äôs architecture.</p>
<p><strong>Why This Works</strong>:</p>
<ol type="1">
<li><p><strong>Discoverability</strong>: New users can learn without
external resources (though external tutorials help).</p></li>
<li><p><strong>Maintainability</strong>: Future developers can
understand code by reading documentation strings.</p></li>
<li><p><strong>Reduced Support Burden</strong>: Good documentation
reduces questions and issue reports.</p></li>
<li><p><strong>Knowledge Preservation</strong>: When developers leave,
their knowledge remains in documentation.</p></li>
</ol>
<p><strong>Emacs‚Äôs Documentation Approach</strong>:</p>
<ul>
<li><strong>Docstrings</strong>: Every function and variable documents
its purpose and contract</li>
<li><strong>User Manual</strong>: Comprehensive guide to using
Emacs</li>
<li><strong>Elisp Manual</strong>: Complete language and API
reference</li>
<li><strong>Internals Manual</strong>: (Incomplete) guide to C
internals</li>
<li><strong>Info System</strong>: Hyperlinked documentation within
Emacs</li>
<li><strong>Help System</strong>: Runtime introspection and source code
access</li>
</ul>
<p><strong>Modern Application</strong>:</p>
<p>Many modern projects treat documentation as secondary, something to
write after the code works. Emacs treats it as primary: code without
documentation is incomplete.</p>
<p>This approach scales: projects with Emacs-quality documentation have
lower contributor ramp-up time, fewer bugs (documented behavior is
clearer behavior), and better long-term maintainability.</p>
<h3 data-number="3.6.5" id="incremental-modernization"><span class="header-section-number">3.6.5</span> Incremental
Modernization</h3>
<p><strong>Lesson: You Don‚Äôt Need Rewrites to Stay Modern</strong></p>
<p>Emacs has avoided ‚Äúversion 2.0‚Äù rewrites. Instead, it modernizes
incrementally:</p>
<ul>
<li><strong>Lexical scoping</strong>: Introduced as opt-in (2012),
gradually becoming default</li>
<li><strong>Native compilation</strong>: Optional, transparent,
backward-compatible (2021)</li>
<li><strong>Tree-sitter</strong>: New modes coexist with old modes
(2023)</li>
<li><strong>Portable dumper</strong>: Gradually replaced unexec over
multiple versions (2017-2025)</li>
</ul>
<p><strong>The Incremental Approach</strong>:</p>
<ol type="1">
<li><strong>Add New, Deprecate Old</strong>: Introduce new systems
alongside old ones</li>
<li><strong>Migrate Gradually</strong>: Convert code piece by piece, not
all at once</li>
<li><strong>Maintain Compatibility</strong>: Ensure old code continues
working</li>
<li><strong>Eventual Removal</strong>: After years of deprecation,
remove obsolete systems</li>
<li><strong>User Choice</strong>: Often let users choose old vs.¬†new
behavior</li>
</ol>
<p><strong>Why This Works</strong>:</p>
<ul>
<li><strong>Reduces Risk</strong>: Incremental changes are easier to
test and debug</li>
<li><strong>Maintains Ecosystem</strong>: Third-party code keeps
working</li>
<li><strong>Allows Learning</strong>: Community can adapt gradually</li>
<li><strong>Avoids Big-Bang Failures</strong>: No single point of
failure</li>
</ul>
<p><strong>Modern Application</strong>:</p>
<p>The industry often prefers rewrites: ‚ÄúThis codebase is legacy; let‚Äôs
rebuild from scratch.‚Äù This usually fails (see Netscape Navigator, Perl
6). Emacs demonstrates an alternative: continuous evolution.</p>
<p>Modern examples of incremental modernization: Python 2-to-3 migration
(painful but eventually successful), Angular 1-to-2+ (painful and caused
community splits), Node.js ecosystem (constant churn). The successful
migrations (Python, eventually) followed Emacs-like principles: long
deprecation periods, compatibility tools, gradual migration.</p>
<p><strong>When Rewrites Make Sense</strong>:</p>
<p>Emacs‚Äôs approach works because its architecture was sound from the
beginning. If your core architecture is fundamentally wrong, incremental
changes won‚Äôt fix it. But ‚Äúfundamentally wrong‚Äù is rarer than developers
think. Often, the existing architecture just needs evolution, not
revolution.</p>
<h3 data-number="3.6.6" id="extensibility-as-a-forcing-function"><span class="header-section-number">3.6.6</span> Extensibility as a Forcing
Function</h3>
<p><strong>Lesson: Building for Extension Forces Better
Design</strong></p>
<p>Because Emacs exposes everything to Elisp, its internals can‚Äôt be too
tangled. If users can‚Äôt understand or extend something, it‚Äôs considered
poorly designed.</p>
<p>This creates a virtuous cycle: - <strong>Clear Interfaces</strong>:
Extension requires clear, documented interfaces -
<strong>Modularity</strong>: Extensible systems must be modular -
<strong>Thoughtful Design</strong>: Public APIs require more thought
than internal code - <strong>Dogfooding</strong>: Developers use the
same APIs they expose, ensuring they‚Äôre actually usable</p>
<p><strong>Modern Application</strong>:</p>
<p>‚ÄúEating your own dog food‚Äù is common advice, but Emacs takes it
further: make your users‚Äô tools the same as your tools. This is why
Emacs has remained coherent despite thousands of contributors‚Äîeveryone
uses the same extension mechanisms.</p>
<p>Modern platforms that embrace this: VS Code (extensions use the same
APIs Microsoft uses), Kubernetes (operators use the same APIs as
kubectl), Unix (everything‚Äôs a file/process).</p>
<p>Platforms that don‚Äôt: many proprietary tools with ‚Äúpublic APIs‚Äù that
lack features the internal code uses.</p>
<h3 data-number="3.6.7" id="the-value-of-consistency"><span class="header-section-number">3.6.7</span> The Value of Consistency</h3>
<p><strong>Lesson: Consistency Compounds Over Time</strong></p>
<p>Emacs has strong conventions: - <strong>Naming</strong>: Functions
are named <code>subsystem-what-it-does</code> (e.g.,
<code>buffer-list</code>, <code>window-split</code>) -
<strong>Keybindings</strong>: Consistent patterns (<code>C-x</code> for
file/buffer operations, <code>C-c</code> for mode-specific,
<code>C-h</code> for help) - <strong>Documentation</strong>: Standard
format for docstrings - <strong>Hook Names</strong>: End with
<code>-hook</code>, <code>-functions</code>, or <code>-mode-hook</code>
- <strong>Variable Names</strong>: End with <code>-flag</code>,
<code>-mode</code>, <code>-function</code> based on purpose</p>
<p><strong>Why This Matters</strong>:</p>
<ul>
<li><strong>Learnability</strong>: Learning one package helps you
understand others</li>
<li><strong>Predictability</strong>: You can often guess function names
or keybindings</li>
<li><strong>Tooling</strong>: Consistent conventions enable automated
tools (linters, analyzers)</li>
<li><strong>Reduced Cognitive Load</strong>: Consistency means less to
remember</li>
</ul>
<p><strong>Modern Application</strong>:</p>
<p>Modern development often prioritizes individual developer freedom
over consistency. Emacs demonstrates that consistency is a feature, not
a constraint. Style guides, linters, and code formatters enforce this in
modern projects (Prettier, Black, rustfmt, gofmt), but Emacs had this
cultural consistency before automated tools.</p>
<h2 data-number="3.7" id="the-genesis-from-teco-to-gnu"><span class="header-section-number">3.7</span> The Genesis: From TECO to
GNU</h2>
<h3 data-number="3.7.1" id="the-original-emacs-1976-1984"><span class="header-section-number">3.7.1</span> The Original EMACS
(1976-1984)</h3>
<p>The story begins not with an editor, but with a culture. At MIT in
the 1970s, hackers shared code freely, improving each other‚Äôs programs
in a communal ecosystem that predated the concept of ‚Äúopen source‚Äù by
decades. TECO (Text Editor and COrrector) was the dominant editor, but
it was more of a programming language than an interactive tool. Users
would write TECO programs to perform editing operations, executing these
programs against text buffers.</p>
<p>Richard Stallman recognized that many users were writing similar
macros and that these could be collected, standardized, and extended
into a coherent system. His key insight was that users should be able to
customize and extend the editor <em>while using it</em>, seeing
immediate results. The name EMACS stood for ‚ÄúEditor MACroS,‚Äù but it also
referenced earlier systems like TECMAC and TMACS that had explored
similar ideas.</p>
<p>The original EMACS, written in TECO assembly language, introduced
several revolutionary concepts:</p>
<ol type="1">
<li><strong>Real-time display</strong>: Changes appeared immediately on
screen, a stark contrast to line-oriented editors</li>
<li><strong>Self-documentation</strong>: The editor could describe
itself, listing available commands and their bindings</li>
<li><strong>Extensibility</strong>: Users could add new commands in the
same language the editor was written in</li>
<li><strong>Programmable</strong>: Complex editing tasks could be
automated</li>
</ol>
<p>By 1978, EMACS had become the standard editor at MIT‚Äôs AI Lab. Other
implementations appeared: EINE and ZWEI for Lisp Machines (the names are
jokes: EINE stood for ‚ÄúEINE Is Not EMACS,‚Äù and ZWEI is German for
‚Äútwo‚Äù), Gosling Emacs for Unix (written in C with a small Lisp-like
extension language), and various others.</p>
<h3 data-number="3.7.2" id="the-gnu-emacs-project-1984-1985"><span class="header-section-number">3.7.2</span> The GNU Emacs Project
(1984-1985)</h3>
<p>In 1984, Stallman began work on GNU Emacs as part of the larger GNU
(GNU‚Äôs Not Unix) project. His goal was to create a completely free
software system that could replace proprietary Unix. GNU Emacs would be
its editor.</p>
<p>Rather than port one of the existing EMACS variants, Stallman chose
to write a new implementation from scratch. The crucial architectural
decision was to build it around a full-featured Lisp interpreter. This
wasn‚Äôt just an extension language tacked onto a C editor‚Äîthe Lisp
interpreter would be the heart of the system, with text editing as its
primary application.</p>
<p>This decision had profound implications:</p>
<ul>
<li><strong>Power</strong>: Users could extend the editor with the full
power of a real programming language, not a limited macro facility</li>
<li><strong>Introspection</strong>: Since the editor‚Äôs own code was
Lisp, users could examine, modify, and learn from it</li>
<li><strong>Consistency</strong>: All extensions used the same language
and conventions</li>
<li><strong>Evolution</strong>: New features could be prototyped quickly
in Lisp without recompiling C code</li>
</ul>
<p>GNU Emacs 13, the first public release, was announced on March 20,
1985. The version number started at 13 to signify that this wasn‚Äôt the
first EMACS, but the culmination of the EMACS tradition. From the
beginning, it was distributed with complete source code under terms that
guaranteed users‚Äô freedom to study, modify, and share it.</p>
<h3 data-number="3.7.3" id="four-decades-of-evolution"><span class="header-section-number">3.7.3</span> Four Decades of
Evolution</h3>
<p>The history file in the Emacs source tree documents 66 stable
releases from version 13 (1985) to version 30.2 (2025), with version 31
currently in development. This represents an almost unbroken chain of
development spanning 40 years‚Äîa tenure matched by few software
systems.</p>
<p>Key milestones in this evolution include:</p>
<ul>
<li><strong>Version 18</strong> (1987-1992): Established the core
architecture still in use today</li>
<li><strong>Version 19</strong> (1993-1996): Added GUI support, face
system for text properties, multi-frame capability</li>
<li><strong>Version 20</strong> (1997-2000): Unicode support,
international character sets, sophisticated font handling</li>
<li><strong>Version 21</strong> (2001-2005): Images, anti-aliased fonts,
toolbar, menu bar improvements</li>
<li><strong>Version 22</strong> (2007-2008): GTK+ support, improved
Unicode, better Mac OS X integration</li>
<li><strong>Version 23</strong> (2009-2012): D-Bus support, lexical
scoping (optional), better font rendering</li>
<li><strong>Version 24</strong> (2012-2015): Package.el for package
management, 24-bit color, Cairo support</li>
<li><strong>Version 25</strong> (2016-2017): Xwidgets for embedding
browsers, improved Unicode handling</li>
<li><strong>Version 26</strong> (2018-2019): Threads (limited), modules
API for dynamic loading</li>
<li><strong>Version 27</strong> (2020-2021): Native JSON parsing,
tab-bar-mode, improved JSON/XML handling</li>
<li><strong>Version 28</strong> (2022): Native compilation via
libgccjit, major performance improvements</li>
<li><strong>Version 29</strong> (2023-2024): Tree-sitter support for
incremental parsing, pure GTK build, Eglot included</li>
<li><strong>Version 30</strong> (2025): Android support, improved
tree-sitter integration, extended functionality</li>
<li><strong>Version 31</strong> (in development): Removal of unexec
dumper, enhanced modern features</li>
</ul>
<p>Each major version has maintained backward compatibility to an
extraordinary degree. Elisp code written for Emacs 18 often still runs
in Emacs 31, albeit with deprecation warnings. This stability has
allowed a vast ecosystem of packages to flourish.</p>
<h2 data-number="3.8" id="what-makes-emacs-unique"><span class="header-section-number">3.8</span> What Makes Emacs Unique</h2>
<p>When people say ‚ÄúEmacs is an operating system disguised as a text
editor,‚Äù they‚Äôre only half-joking. To understand what makes Emacs
special, you need to look beyond the feature lists and examine its
fundamental architecture and philosophy.</p>
<h3 data-number="3.8.1" id="self-documenting"><span class="header-section-number">3.8.1</span> Self-Documenting</h3>
<p>Every function in Emacs has a documentation string built into it.
Every variable has a description. Every key binding can be queried. This
isn‚Äôt documentation that might become outdated‚Äîit‚Äôs part of the code
itself.</p>
<p>You can ask Emacs: - What does this key do? (<code>C-h k</code>) -
What keys run this command? (<code>C-h w</code>) - What does this
function do? (<code>C-h f</code>) - What does this variable control?
(<code>C-h v</code>) - What commands are available in this mode?
(<code>C-h m</code>)</p>
<p>More remarkably, you can click on any function name in a
documentation buffer and jump directly to its source code. The boundary
between user and developer is deliberately thin. Emacs invites you to
read its implementation, learn from it, and modify it to suit your
needs.</p>
<h3 data-number="3.8.2" id="self-extending"><span class="header-section-number">3.8.2</span> Self-Extending</h3>
<p>Most applications have a clean separation between the application
(written by developers in a compiled language) and user customization
(through configuration files or scripts). Emacs blurs this boundary to
the point of invisibility.</p>
<p>The distinction between ‚ÄúEmacs itself‚Äù and ‚ÄúEmacs extensions‚Äù is
largely arbitrary. Of the 1.56 million lines of Elisp code in the Emacs
distribution:</p>
<ul>
<li>The C core implements the Lisp interpreter, low-level buffer
operations, display rendering, and OS interfaces</li>
<li>Everything else‚Äîfrom basic editing commands to major modes, from the
package manager to the mail reader‚Äîis written in Elisp</li>
</ul>
<p>When you write a function in your <code>init.el</code> configuration
file, it‚Äôs a first-class citizen alongside the built-in functions. It
can be called the same way, documented the same way, and modified the
same way. There‚Äôs no plugin API to learn because there‚Äôs no distinction
between plugins and core functionality.</p>
<p>This has profound implications:</p>
<ol type="1">
<li><strong>Customization depth</strong>: You can modify <em>any</em>
aspect of Emacs‚Äôs behavior because you have access to the same tools its
developers use</li>
<li><strong>Learning curve</strong>: Reading Emacs‚Äôs own code teaches
you how to extend it</li>
<li><strong>Evolutionary architecture</strong>: Features can migrate
from user configurations to distributed packages to core inclusion
organically</li>
<li><strong>Responsibility</strong>: With great power comes great
opportunity to break things</li>
</ol>
<h3 data-number="3.8.3" id="a-lisp-machine-for-text"><span class="header-section-number">3.8.3</span> A Lisp Machine for Text</h3>
<p>In the 1970s and 1980s, Lisp Machines were computers designed from
the ground up to run Lisp efficiently. Their operating systems,
applications, and even hardware drivers were written in Lisp. These
machines are now museum pieces, but Emacs carries forward their
spirit.</p>
<p>Emacs is essentially a Lisp environment specialized for text
manipulation. The C core provides:</p>
<ul>
<li>A Lisp interpreter (see <code>/home/user/emacs/src/eval.c</code>,
<code>/home/user/emacs/src/bytecode.c</code>)</li>
<li>Primitives for buffer operations (see
<code>/home/user/emacs/src/buffer.c</code>)</li>
<li>Display and windowing code (see
<code>/home/user/emacs/src/xdisp.c</code>,
<code>/home/user/emacs/src/dispnew.c</code>)</li>
<li>OS interface and process management (see
<code>/home/user/emacs/src/process.c</code>,
<code>/home/user/emacs/src/fileio.c</code>)</li>
</ul>
<p>Everything else builds upon these primitives in Lisp. The result is
an environment where:</p>
<ul>
<li>Buffers are first-class objects you can create, query, and
manipulate programmatically</li>
<li>Text has properties that can store arbitrary data structures</li>
<li>Every editing operation can be intercepted and modified</li>
<li>Background processes can run while you edit</li>
<li>Network connections can be opened and managed like files</li>
<li>The display itself can be programmatically controlled</li>
</ul>
<p>One famous characterization, often attributed to various sources,
describes Emacs as ‚Äúa Lisp interpreter written in C that happens to
implement a text editor.‚Äù This isn‚Äôt quite right‚Äîthe text editor isn‚Äôt
an afterthought‚Äîbut it captures an important truth: Emacs is
fundamentally a Lisp environment, and text editing is its primary (but
not only) application.</p>
<h3 data-number="3.8.4" id="community-and-culture"><span class="header-section-number">3.8.4</span> Community and Culture</h3>
<p>Emacs has cultivated a unique community culture over four decades.
It‚Äôs not just a tool but a tradition, with its own conventions, humor,
folklore, and accumulated wisdom.</p>
<p>The Emacs community values:</p>
<ol type="1">
<li><p><strong>Documentation</strong>: Well-documented code isn‚Äôt
optional; it‚Äôs expected. Functions without docstrings are considered
incomplete.</p></li>
<li><p><strong>Customization</strong>: The assumption is that users will
want to modify behavior. Packages are expected to provide customization
points through variables and hooks.</p></li>
<li><p><strong>Discoverability</strong>: Features should be findable
without reading external documentation. The self-documentation features
support this.</p></li>
<li><p><strong>Backward compatibility</strong>: Breaking changes are
rare and carefully considered. Code from decades ago often still
works.</p></li>
<li><p><strong>Free software</strong>: In Stallman‚Äôs original
sense‚Äîsoftware that respects user freedom. Emacs accepts only
contributions that can be clearly licensed under the GPL.</p></li>
<li><p><strong>Long-term thinking</strong>: Emacs is designed to last.
Decisions aren‚Äôt made based on this year‚Äôs trends but on principles that
will remain relevant for decades.</p></li>
</ol>
<p>This culture has both strengths and weaknesses. It makes Emacs
stable, reliable, and trustworthy for professional work. It also makes
it conservative, sometimes slow to adopt new ideas, and intimidating to
newcomers who expect modern UI conventions.</p>
<h2 data-number="3.9" id="architectural-overview"><span class="header-section-number">3.9</span> Architectural Overview</h2>
<p>Understanding Emacs‚Äôs architecture requires thinking at several
levels simultaneously. From the bottom up:</p>
<h3 data-number="3.9.1" id="layer-1-the-c-core-562000-lines"><span class="header-section-number">3.9.1</span> Layer 1: The C Core (~562,000
lines)</h3>
<p>The C core, located in <code>/home/user/emacs/src/</code>, contains
152 source files implementing:</p>
<p><strong>The Lisp Interpreter</strong> (<code>eval.c</code>,
<code>lisp.h</code>, <code>lread.c</code>, <code>print.c</code>,
<code>data.c</code>, <code>alloc.c</code>): - Tagged pointer
representation for Lisp objects - Memory management and garbage
collection - The evaluator (both interpreted and bytecode execution) -
Reading and printing Lisp expressions - Primitive data types: integers,
floats, strings, symbols, cons cells, vectors, hash tables</p>
<p><strong>Buffer Management</strong> (<code>buffer.c</code>,
<code>buffer.h</code>, <code>insdel.c</code>): - Buffer creation,
deletion, and switching - Text insertion and deletion primitives - Gap
buffer data structure for efficient editing - Buffer-local variables -
Text properties and overlays</p>
<p><strong>Display Engine</strong> (<code>xdisp.c</code>,
<code>dispnew.c</code>, <code>dispextern.h</code>): - Redisplay
algorithm that updates the screen efficiently - Glyph matrices and row
structures - Font handling and text rendering - Image display - Cursor
management</p>
<p><strong>Window System</strong> (<code>window.c</code>,
<code>frame.c</code>, <code>xterm.c</code>, <code>w32term.c</code>,
etc.): - Window splitting and management - Frame (top-level window)
handling - Platform-specific terminal interfaces - Mouse and keyboard
input handling</p>
<p><strong>File Operations</strong> (<code>fileio.c</code>,
<code>filelock.c</code>, <code>coding.c</code>): - File reading and
writing - File locking to prevent simultaneous edits - Character
encoding conversion - Auto-save and backup management</p>
<p><strong>Process Management</strong> (<code>process.c</code>,
<code>sysdep.c</code>): - Subprocess creation and management - Network
connections - Asynchronous I/O - Signal handling</p>
<p><strong>Modern Features</strong>: - Tree-sitter integration
(<code>treesit.c</code>, <code>treesit.h</code>) for incremental parsing
- Native compilation (<code>comp.c</code>, <code>comp.h</code>) using
libgccjit - Threading support (<code>thread.c</code>,
<code>thread.h</code>) for limited concurrency - Module system
(<code>emacs-module.c</code>) for dynamic loading of shared
libraries</p>
<h3 data-number="3.9.2" id="layer-2-the-elisp-foundation-1.56-million-lines"><span class="header-section-number">3.9.2</span> Layer 2: The Elisp Foundation
(~1.56 million lines)</h3>
<p>The Lisp code in <code>/home/user/emacs/lisp/</code> spans 1,576
files organized into 35 subdirectories. This layer includes:</p>
<p><strong>Core Elisp</strong> (<code>subr.el</code>,
<code>simple.el</code>, <code>files.el</code>,
<code>minibuffer.el</code>): - Fundamental functions that extend the C
primitives - Basic editing commands (movement, deletion, insertion) -
File operations and buffer management - Minibuffer interaction - Command
completion</p>
<p><strong>Major Modes</strong> (100+ modes in
<code>/home/user/emacs/lisp/progmodes/</code>,
<code>/home/user/emacs/lisp/textmodes/</code>): - Programming language
support (C, Python, JavaScript, Ruby, etc.) - Text formatting modes
(Markdown, LaTeX, Org, etc.) - Specialized modes (Dired for file
management, occur for search results, etc.)</p>
<p><strong>Minor Modes</strong> (hundreds throughout the tree): -
Auto-complete, spell-checking, line numbering - Display enhancements,
behavior modifications - Tool integrations (version control, debugging,
etc.)</p>
<p><strong>Subsystems</strong>: - Package manager
(<code>package.el</code>) - Completion frameworks
(<code>completion.el</code>, <code>minibuffer.el</code>) - Window
configuration (<code>window.el</code>) - Network protocols
(<code>url/</code>, <code>net/</code>) - Calendar and diary
(<code>calendar/</code>) - Mail and news readers (<code>gnus/</code>,
<code>mh-e/</code>)</p>
<h3 data-number="3.9.3" id="layer-3-the-bytecode-compiler"><span class="header-section-number">3.9.3</span> Layer 3: The Bytecode
Compiler</h3>
<p>Elisp can run interpreted, but for better performance, it‚Äôs usually
byte-compiled. The bytecode compiler (<code>bytecomp.el</code>,
<code>byte-opt.el</code>) and interpreter (<code>bytecode.c</code>)
provide:</p>
<ul>
<li>Compilation of Lisp to a stack-based bytecode</li>
<li>Optimization passes (constant folding, dead code elimination,
etc.)</li>
<li>Lazy loading of compiled code</li>
<li>Faster function calls and variable access</li>
</ul>
<p>The bytecode format has evolved over Emacs versions but maintains
backward compatibility. Modern Emacs can execute bytecode compiled
decades ago, though it may warn about deprecated constructs.</p>
<h3 data-number="3.9.4" id="layer-4-native-compilation-emacs-28"><span class="header-section-number">3.9.4</span> Layer 4: Native Compilation
(Emacs 28+)</h3>
<p>Since Emacs 28, there‚Äôs an optional fourth layer: native compilation.
The native compiler:</p>
<ul>
<li>Translates Elisp (or bytecode) to C-like intermediate
representation</li>
<li>Uses libgccjit to compile this to native machine code</li>
<li>Provides 2-5x speedups for Lisp-heavy operations</li>
<li>Caches compiled native code for reuse</li>
<li>Falls back gracefully to bytecode or interpretation if compilation
fails</li>
</ul>
<p>This is implemented in <code>comp.c</code> and <code>comp.el</code>,
demonstrating Emacs‚Äôs ability to evolve fundamental capabilities while
maintaining compatibility.</p>
<h3 data-number="3.9.5" id="why-this-architecture"><span class="header-section-number">3.9.5</span> Why This Architecture?</h3>
<p>The layered C-core plus Lisp-extension architecture has several
advantages:</p>
<ol type="1">
<li><strong>Performance where it matters</strong>: Low-level operations
(buffer manipulation, display, I/O) are fast C code</li>
<li><strong>Flexibility where it‚Äôs needed</strong>: High-level behavior
(commands, modes, UI) is customizable Lisp</li>
<li><strong>Incremental modification</strong>: You can change behavior
without recompiling anything</li>
<li><strong>Introspection</strong>: Lisp code can examine and modify
itself</li>
<li><strong>Safe experimentation</strong>: Lisp errors don‚Äôt crash the
editor; they signal conditions you can handle</li>
</ol>
<p>The disadvantages are equally clear:</p>
<ol type="1">
<li><strong>Complexity</strong>: Understanding the full system requires
knowing both C and Lisp</li>
<li><strong>Performance overhead</strong>: Lisp is slower than compiled
C (mitigated by bytecode and native compilation)</li>
<li><strong>Memory usage</strong>: Lisp environments tend to be
memory-hungry</li>
<li><strong>Learning curve</strong>: The architecture is unusual
compared to typical applications</li>
</ol>
<h2 data-number="3.10" id="evolution-to-modernity"><span class="header-section-number">3.10</span> Evolution to Modernity</h2>
<p>While Emacs has maintained its core architecture for 40 years, it
hasn‚Äôt stood still. Recent additions demonstrate ongoing evolution:</p>
<h3 data-number="3.10.1" id="language-server-protocol-lsp"><span class="header-section-number">3.10.1</span> Language Server Protocol
(LSP)</h3>
<p>Traditionally, each programming mode implemented its own completion,
navigation, and refactoring features. LSP standardizes these
interactions, allowing Emacs to communicate with language servers that
provide IDE-like features.</p>
<p>Eglot (<code>eglot.el</code>), included in Emacs 29, provides a
lightweight LSP client. It enables features like: - Intelligent code
completion - Jump to definition across projects - Find references -
Inline documentation - Refactoring support</p>
<p>This brings Emacs‚Äôs programming environment up to modern IDE
standards while maintaining its distinctive character.</p>
<h3 data-number="3.10.2" id="tree-sitter-integration-1"><span class="header-section-number">3.10.2</span> Tree-sitter Integration</h3>
<p>Traditional major modes used regular expressions for syntax
highlighting and indentation. This is fast but fragile‚Äîcomplex languages
can‚Äôt be parsed correctly with regex.</p>
<p>Tree-sitter provides incremental parsing that builds proper syntax
trees. Emacs 29‚Äôs tree-sitter integration (<code>treesit.c</code>,
<code>treesit.el</code>) enables: - Accurate syntax highlighting based
on real parsing - Reliable code folding - Structural navigation (by
function, class, etc.) - Better indentation - Faster response to
edits</p>
<p>This represents a fundamental improvement in how Emacs understands
code, making it competitive with modern editors built around language
parsers.</p>
<h3 data-number="3.10.3" id="native-compilation-1"><span class="header-section-number">3.10.3</span> Native Compilation</h3>
<p>The native compiler in Emacs 28+ addresses one of Emacs‚Äôs traditional
weaknesses: performance of Lisp code. By compiling to native machine
code, it provides:</p>
<ul>
<li>Significantly faster execution (2-5x for Lisp-heavy code)</li>
<li>Reduced startup time (after initial compilation)</li>
<li>Better responsiveness in complex modes</li>
<li>Transparent operation (no code changes required)</li>
</ul>
<p>This keeps Emacs competitive as packages grow more sophisticated and
users expect instant response.</p>
<h3 data-number="3.10.4" id="platform-expansion"><span class="header-section-number">3.10.4</span> Platform Expansion</h3>
<p>Modern Emacs runs on an impressive variety of platforms:</p>
<ol type="1">
<li><strong>Unix/Linux/BSD</strong>: The native platform, supported via
X11, Wayland, or terminal</li>
<li><strong>macOS</strong>: Both native (via NS/Cocoa) and via
terminal</li>
<li><strong>Windows</strong>: Native GUI or terminal interface</li>
<li><strong>MS-DOS</strong>: Still supported for embedded systems</li>
<li><strong>Android</strong>: Full port with touch support (Emacs
30)</li>
<li><strong>Haiku</strong>: Support for the free BeOS successor</li>
<li><strong>Terminal</strong>: Works over SSH on essentially any
platform</li>
</ol>
<p>This portability is achieved through careful layering and
platform-specific code in dedicated directories (<code>nt/</code>,
<code>nextstep/</code>, <code>java/</code>, etc.).</p>
<h2 data-number="3.11" id="scope-and-purpose-of-this-encyclopedia"><span class="header-section-number">3.11</span> Scope and Purpose of This
Encyclopedia</h2>
<p>This work aims to provide a comprehensive technical reference to GNU
Emacs internals. It‚Äôs organized as an encyclopedia rather than a
tutorial‚Äîyou can read it linearly or jump to specific topics as
needed.</p>
<h3 data-number="3.11.1" id="what-you-will-learn"><span class="header-section-number">3.11.1</span> What You Will Learn</h3>
<p>This guide will take you from the lowest levels (how Lisp objects are
represented in memory, how the garbage collector works) through
mid-level subsystems (the display engine, buffer management, process
handling) to high-level patterns (how modes are structured, how packages
are organized, how to extend the system effectively).</p>
<p>Specific topics include:</p>
<ul>
<li><strong>Architecture</strong>: How the C core and Lisp layers
interact (Chapter 1)</li>
<li><strong>Core Subsystems</strong>: Memory management, evaluation,
I/O, processes (Chapter 2)</li>
<li><strong>Elisp Runtime</strong>: Object system, types, evaluation
model (Chapter 3)</li>
<li><strong>Buffer Management</strong>: Gap buffers, text properties,
markers (Chapter 4)</li>
<li><strong>Display Engine</strong>: Redisplay algorithm, glyphs, fonts,
faces (Chapter 5)</li>
<li><strong>Window System</strong>: Frames, windows, scrolling,
splitting (Chapter 6)</li>
<li><strong>Text Properties</strong>: Overlays, font-lock, invisibility
(Chapter 7)</li>
<li><strong>Major Modes</strong>: Derived modes, syntax tables, keymaps
(Chapter 8)</li>
<li><strong>Minor Modes</strong>: Global vs.¬†buffer-local, mode hooks
(Chapter 9)</li>
<li><strong>Keybindings</strong>: Keymap hierarchy, prefix keys,
translation (Chapter 10)</li>
<li><strong>Command Loop</strong>: Event processing, keyboard macros
(Chapter 11)</li>
<li><strong>Process Management</strong>: Subprocesses, filters,
sentinels (Chapter 12)</li>
<li><strong>Network I/O</strong>: Sockets, URLs, protocols (Chapter
13)</li>
<li><strong>File System</strong>: Encoding, locking, backups, auto-save
(Chapter 14)</li>
<li><strong>Internationalization</strong>: Unicode, charsets, language
environments (Chapter 15)</li>
<li><strong>Font Rendering</strong>: Font backends, shaping, emoji
(Chapter 16)</li>
<li><strong>Package System</strong>: Package.el, archives, dependencies
(Chapter 17)</li>
<li><strong>Build System</strong>: Autoconf, make, dumping (Chapter
18)</li>
<li><strong>Platform-Specific</strong>: Windows, macOS, Android (Chapter
19)</li>
<li><strong>Testing and Debugging</strong>: ERT, edebug, profiling
(Chapter 20)</li>
<li><strong>Advanced Topics</strong>: Native compilation, tree-sitter,
modules (Chapter 21)</li>
</ul>
<h3 data-number="3.11.2" id="how-to-use-this-guide"><span class="header-section-number">3.11.2</span> How to Use This Guide</h3>
<p>This encyclopedia is designed for multiple reading styles:</p>
<p><strong>Linear Reading</strong>: If you‚Äôre new to Emacs internals,
reading sequentially from Chapter 1 forward will build up your
understanding systematically.</p>
<p><strong>Reference Lookup</strong>: If you need to understand a
specific subsystem (e.g., how the redisplay algorithm works), jump
directly to that chapter.</p>
<p><strong>Deep Dive</strong>: Each chapter includes references to
specific source files. You can read the chapter, then explore the actual
implementation in the Emacs source tree.</p>
<p><strong>Literate Programming</strong>: Code examples throughout are
real, working Elisp. You can evaluate them in your own Emacs to see how
they behave.</p>
<p>Each chapter follows a consistent structure: -
<strong>Overview</strong>: High-level introduction to the topic -
<strong>Concepts</strong>: Key ideas and terminology -
<strong>Implementation</strong>: How it‚Äôs actually built -
<strong>Source Tour</strong>: Guided tour of relevant source files -
<strong>Patterns</strong>: Common usage patterns -
<strong>Customization</strong>: How to extend or modify behavior -
<strong>References</strong>: Pointers to related chapters and external
resources</p>
<h3 data-number="3.11.3" id="prerequisites-1"><span class="header-section-number">3.11.3</span> Prerequisites</h3>
<p>To get the most from this guide, you should have:</p>
<ol type="1">
<li><p><strong>Basic Emacs proficiency</strong>: You should be
comfortable editing files, using basic commands, and navigating buffers.
You don‚Äôt need to be an expert, but you should know what a buffer is,
what a window is, and how to execute commands with
<code>M-x</code>.</p></li>
<li><p><strong>Some programming experience</strong>: You don‚Äôt need to
be a Lisp expert, but familiarity with at least one programming language
will help. We‚Äôll explain Elisp constructs as we go, but we assume you
understand concepts like functions, variables, and control
flow.</p></li>
<li><p><strong>Basic C knowledge</strong>: Some chapters dive into the C
implementation. You don‚Äôt need to be a C expert, but understanding
pointers, structures, and basic C syntax will help.</p></li>
<li><p><strong>Curiosity about systems</strong>: This guide is for
people who want to understand <em>how things work</em>, not just how to
use them. If you‚Äôre the type who reads source code for fun, you‚Äôre in
the right place.</p></li>
<li><p><strong>Access to the Emacs source</strong>: While not strictly
required, having the Emacs source tree available
(<code>git clone https://git.savannah.gnu.org/git/emacs.git</code>) will
let you follow along with the source tours and explore on your
own.</p></li>
</ol>
<h3 data-number="3.11.4" id="what-this-guide-is-not"><span class="header-section-number">3.11.4</span> What This Guide Is Not</h3>
<p>To set proper expectations:</p>
<ul>
<li><p><strong>Not a user manual</strong>: We assume you already know
how to use Emacs. If you‚Äôre looking for how to configure your
<code>.emacs</code>, consult the Emacs manual (<code>C-h r</code>) or
online tutorials.</p></li>
<li><p><strong>Not an Elisp tutorial</strong>: While we explain Elisp
concepts as needed, this isn‚Äôt a learn-to-program guide. For systematic
Elisp learning, see ‚ÄúAn Introduction to Programming in Emacs Lisp‚Äù
(included with Emacs as <code>C-h i m Elisp Intro</code>) or the Elisp
reference manual (<code>C-h i m Elisp</code>).</p></li>
<li><p><strong>Not exhaustive</strong>: At 2.6 million lines of code,
complete coverage is impossible. We focus on the core systems and
architectural patterns, giving you the tools to understand the
rest.</p></li>
<li><p><strong>Not version-specific</strong>: We primarily discuss Emacs
29-31, but most material applies to recent versions. We note when
features are version-specific.</p></li>
<li><p><strong>Not a substitute for source</strong>: The definitive
reference is always the source code itself. This guide is a map and
guidebook, not a replacement for exploration.</p></li>
</ul>
<h2 data-number="3.12" id="the-scale-of-the-system"><span class="header-section-number">3.12</span> The Scale of the System</h2>
<p>To appreciate the scope of what we‚Äôre exploring, consider these
statistics from the Emacs source tree:</p>
<ul>
<li><strong>Total source files</strong>: ~2,924 (C, Lisp, Java for
Android)</li>
<li><strong>Total lines of code</strong>: ~2.6 million</li>
<li><strong>C code</strong>: ~562,000 lines across 152 files in
<code>/home/user/emacs/src/</code></li>
<li><strong>Elisp code</strong>: ~1.56 million lines across 1,576 files
in <code>/home/user/emacs/lisp/</code></li>
<li><strong>Major modes</strong>: 100+ for programming languages</li>
<li><strong>Text modes</strong>: 57+ for markup and document
formats</li>
<li><strong>Platform ports</strong>: 7+ (Unix, Linux, Windows, macOS,
Android, MS-DOS, Haiku)</li>
<li><strong>Elisp packages</strong>: 35+ subdirectories organizing
related functionality</li>
<li><strong>Documentation</strong>: Comprehensive manuals totaling
thousands of pages</li>
<li><strong>History</strong>: 66 stable releases over 40 years
(1985-2025)</li>
<li><strong>Development</strong>: Continuous, with multiple releases per
year</li>
</ul>
<p>This is not a toy system or an academic exercise. It‚Äôs
industrial-strength software used daily by millions of programmers,
writers, and researchers worldwide. It runs scientific computing
environments, manages email and RSS feeds, controls version control
workflows, and serves as the primary interface for countless
developers.</p>
<h2 data-number="3.13" id="who-this-guide-is-for"><span class="header-section-number">3.13</span> Who This Guide Is For</h2>
<p>This encyclopedia is written for several overlapping audiences:</p>
<h3 data-number="3.13.1" id="emacs-developers"><span class="header-section-number">3.13.1</span> Emacs Developers</h3>
<p>If you‚Äôre contributing to Emacs itself‚Äîfixing bugs, implementing
features, or improving performance‚Äîthis guide will help you understand
the existing architecture and conventions. It maps the territory so you
know where your changes fit.</p>
<h3 data-number="3.13.2" id="elisp-package-authors"><span class="header-section-number">3.13.2</span> Elisp Package Authors</h3>
<p>If you‚Äôre writing Emacs packages, understanding how Emacs works
internally helps you write better code. You‚Äôll understand why certain
patterns are idiomatic, how to work with rather than against the system,
and how to avoid common pitfalls.</p>
<h3 data-number="3.13.3" id="computer-science-students"><span class="header-section-number">3.13.3</span> Computer Science
Students</h3>
<p>Emacs is a treasure trove of interesting algorithms and design
patterns: garbage collection, incremental parsing, redisplay
optimization, asynchronous I/O, bytecode compilation, native code
generation, and more. Studying it teaches you software engineering at
scale.</p>
<h3 data-number="3.13.4" id="software-historians"><span class="header-section-number">3.13.4</span> Software Historians</h3>
<p>As one of the oldest continuously-developed software systems still in
active use, Emacs is a window into software engineering history. It
shows how systems evolve over decades, how architectural decisions play
out in the long term, and how communities form around code.</p>
<h3 data-number="3.13.5" id="curious-programmers"><span class="header-section-number">3.13.5</span> Curious Programmers</h3>
<p>Maybe you use Emacs daily and wonder how it works. Maybe you‚Äôve heard
about its unusual architecture and want to understand it. Maybe you‚Äôre
interested in Lisp, text editors, or long-lived software systems. This
guide welcomes your curiosity.</p>
<h3 data-number="3.13.6" id="systems-thinkers"><span class="header-section-number">3.13.6</span> Systems Thinkers</h3>
<p>Emacs exemplifies certain principles: extensibility, introspection,
self-documentation, user empowerment, and long-term thinking. If you‚Äôre
interested in how these principles manifest in working software, Emacs
is an excellent case study.</p>
<h2 data-number="3.14" id="a-note-on-literate-programming-style"><span class="header-section-number">3.14</span> A Note on Literate Programming
Style</h2>
<p>This guide follows principles of literate programming‚Äîthe idea that
code should be written for humans to read, with execution by computers
as a secondary concern. Throughout:</p>
<ul>
<li>We explain <em>why</em> before <em>how</em></li>
<li>We provide context before diving into details</li>
<li>We use narrative flow, not just reference material</li>
<li>We include working examples you can try</li>
<li>We reference actual source files you can examine</li>
<li>We connect concepts across chapters</li>
</ul>
<p>The goal is that you can understand Emacs not just as a collection of
features, but as a coherent system with underlying principles and
patterns. You should come away not just knowing what the display engine
does, but understanding <em>why</em> it does it that way and how it fits
into the larger architecture.</p>
<h2 data-number="3.15" id="the-journey-ahead"><span class="header-section-number">3.15</span> The Journey Ahead</h2>
<p>Emacs is a deep system. You won‚Äôt master it from one reading of this
guide (or from a hundred readings, for that matter). The system has been
growing for 40 years, accumulating features, refinements, and
accumulated wisdom from thousands of contributors.</p>
<p>But that depth is also richness. Every subsystem has interesting
problems and clever solutions. The display engine alone is a master
class in optimization and abstraction. The buffer management system is a
beautiful example of choosing the right data structure. The mode system
demonstrates composition and inheritance. The package system shows how
to build an ecosystem.</p>
<p>As you explore, you‚Äôll find that understanding one part often
illuminates others. The window system makes more sense once you
understand buffers. Modes make more sense once you understand keymaps
and hooks. Everything is connected, sometimes in surprising ways.</p>
<p>Don‚Äôt feel you need to understand everything at once. Pick a
subsystem that interests you. Read about it. Experiment with it. Look at
the source code. Ask questions. Try building something. Understanding
grows organically, not linearly.</p>
<h2 data-number="3.16" id="a-living-document"><span class="header-section-number">3.16</span> A Living Document</h2>
<p>This encyclopedia, like Emacs itself, is meant to evolve. As Emacs
adds features, as patterns change, as understanding deepens, this guide
should grow and adapt. It‚Äôs a snapshot of understanding at a particular
moment, not the final word.</p>
<p>If you find errors, gaps, or opportunities for improvement,
contributions are welcome. Like Emacs, this guide is a community
effort.</p>
<h2 data-number="3.17" id="conclusion-why-study-emacs"><span class="header-section-number">3.17</span> Conclusion: Why Study
Emacs?</h2>
<p>You might reasonably ask: why spend time understanding a 40-year-old
text editor? In a world of Visual Studio Code, IntelliJ, and cloud IDEs,
what‚Äôs the point?</p>
<p>Several answers:</p>
<ol type="1">
<li><p><strong>Timeless principles</strong>: Emacs embodies ideas about
extensibility, introspection, and user empowerment that remain relevant
regardless of technological fashion.</p></li>
<li><p><strong>Engineering excellence</strong>: The system demonstrates
solutions to hard problems: incremental redisplay, efficient text
manipulation, cross-platform abstraction, memory management, and
more.</p></li>
<li><p><strong>Practical utility</strong>: Understanding how Emacs works
makes you more effective at using and extending it. The system becomes a
tool you can shape to your needs.</p></li>
<li><p><strong>Historical perspective</strong>: Emacs shows how software
can evolve while maintaining compatibility and coherence. It‚Äôs a
counterexample to the ‚Äúrewrite from scratch‚Äù mentality.</p></li>
<li><p><strong>Intellectual satisfaction</strong>: There‚Äôs deep pleasure
in understanding complex systems, in seeing how the pieces fit together,
in appreciating elegant solutions.</p></li>
<li><p><strong>Community connection</strong>: Emacs has a vibrant
community of thoughtful users and developers. Understanding the system
connects you to that community and its accumulated wisdom.</p></li>
</ol>
<p>But perhaps the best reason is simply this: Emacs is
<em>interesting</em>. It‚Äôs a system that rewards study, that reveals new
depths the more you explore it, that teaches you things applicable far
beyond text editing.</p>
<p>So welcome to the encyclopedia. Whether you read it cover to cover or
dip in for specific topics, whether you‚Äôre debugging a package or just
curious, we hope you find it illuminating.</p>
<p>The journey into Emacs‚Äôs internals is challenging but rewarding.
Let‚Äôs begin.</p>
<hr/>
<p><em>This guide documents GNU Emacs version 31 (in development) but
applies generally to Emacs 27-31. Source file paths reference the
standard Emacs source tree layout.</em></p>
<p><em>For suggestions, corrections, or contributions, please consult
the guide‚Äôs repository or the Emacs development mailing list.</em></p>
<p><em>Happy hacking!</em></p>
<h1 data-number="4" id="chapter-01-architecture"><span class="header-section-number">4</span> Chapter 01: Architecture</h1>
<p><strong>Status</strong>: Planning <strong>Estimated Pages</strong>:
80-100 <strong>Prerequisites</strong>: Chapter 00
<strong>Dependencies</strong>: None</p>
<h2 data-number="4.1" id="chapter-overview-1"><span class="header-section-number">4.1</span> Chapter Overview</h2>
<p>This chapter provides a comprehensive look at Emacs‚Äô system
architecture, covering the C core, Elisp runtime, bootstrap process,
module system, and threading model. It establishes the foundational
knowledge needed to understand how all the pieces fit together.</p>
<h2 data-number="4.2" id="learning-objectives-1"><span class="header-section-number">4.2</span> Learning Objectives</h2>
<p>After reading this chapter, you should be able to:</p>
<ol type="1">
<li>Understand the overall system architecture and component
relationships</li>
<li>Identify the major C subsystems and their responsibilities</li>
<li>Explain how the Elisp runtime integrates with the C core</li>
<li>Trace the bootstrap process from executable to running Emacs</li>
<li>Understand the module system and FFI</li>
<li>Grasp Emacs‚Äô threading model and limitations</li>
</ol>
<h2 data-number="4.3" id="chapter-structure-1"><span class="header-section-number">4.3</span> Chapter Structure</h2>
<h3 data-number="4.3.1" id="system-architecture.md-15-20-pages"><span class="header-section-number">4.3.1</span> 01-system-architecture.md
(15-20 pages)</h3>
<p><strong>Topics:</strong> - Overall system design philosophy -
Two-tier architecture (C core + Elisp) - Component interaction patterns
- Initialization sequence overview - System boundaries and
abstractions</p>
<p><strong>Key Concepts:</strong> - Primitives (C functions callable
from Lisp) - Lisp objects and their C representation - Event-driven
architecture - Separation of concerns</p>
<p><strong>Code Examples:</strong></p>
<div class="sourceCode" id="cb4"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb4-1"><a aria-hidden="true" href="#cb4-1" tabindex="-1"></a><span class="co">// DEFUN macro structure</span></span>
<span id="cb4-2"><a aria-hidden="true" href="#cb4-2" tabindex="-1"></a>DEFUN <span class="op">(</span><span class="st">"forward-char"</span><span class="op">,</span> Fforward_char<span class="op">,</span> Sforward_char<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="st">"^p</span><span class="sc">\n</span><span class="st">p"</span><span class="op">,</span></span>
<span id="cb4-3"><a aria-hidden="true" href="#cb4-3" tabindex="-1"></a>       doc<span class="op">:</span> <span class="co">/* Move point N characters forward... */</span><span class="op">)</span></span>
<span id="cb4-4"><a aria-hidden="true" href="#cb4-4" tabindex="-1"></a>  <span class="op">(</span>Lisp_Object n<span class="op">,</span> Lisp_Object buffer<span class="op">)</span></span></code></pre></div>
<p><strong>Figures:</strong> - System architecture diagram - Component
dependency graph - Data flow diagram</p>
<h3 data-number="4.3.2" id="c-core-subsystems.md-20-25-pages"><span class="header-section-number">4.3.2</span> 02-c-core-subsystems.md
(20-25 pages)</h3>
<p><strong>Topics:</strong> - Memory management (alloc.c) - Object
allocation - Garbage collection - Lisp interpreter (eval.c, bytecode.c)
- Evaluation engine - Bytecode VM - Buffer management (buffer.c) - Gap
buffer implementation - Buffer-local variables - Display engine
(xdisp.c, dispnew.c) - Redisplay algorithm - Terminal abstraction -
Terminal abstraction layer - X11, GTK, Windows, macOS, TTY</p>
<p><strong>Key Concepts:</strong> - Lisp_Object type - Mark and sweep GC
- Bytecode interpreter - Gap buffer data structure - Terminal methods
table</p>
<p><strong>Code Examples:</strong></p>
<div class="sourceCode" id="cb5"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb5-1"><a aria-hidden="true" href="#cb5-1" tabindex="-1"></a><span class="co">// Lisp_Object representation</span></span>
<span id="cb5-2"><a aria-hidden="true" href="#cb5-2" tabindex="-1"></a><span class="kw">typedef</span> <span class="dt">intptr_t</span> Lisp_Object<span class="op">;</span></span>
<span id="cb5-3"><a aria-hidden="true" href="#cb5-3" tabindex="-1"></a></span>
<span id="cb5-4"><a aria-hidden="true" href="#cb5-4" tabindex="-1"></a><span class="co">// Object allocation</span></span>
<span id="cb5-5"><a aria-hidden="true" href="#cb5-5" tabindex="-1"></a>Lisp_Object obj <span class="op">=</span> allocate_vector<span class="op">(</span>size<span class="op">);</span></span>
<span id="cb5-6"><a aria-hidden="true" href="#cb5-6" tabindex="-1"></a></span>
<span id="cb5-7"><a aria-hidden="true" href="#cb5-7" tabindex="-1"></a><span class="co">// GC marking</span></span>
<span id="cb5-8"><a aria-hidden="true" href="#cb5-8" tabindex="-1"></a><span class="cf">if</span> <span class="op">(</span>VECTORP <span class="op">(</span>obj<span class="op">))</span></span>
<span id="cb5-9"><a aria-hidden="true" href="#cb5-9" tabindex="-1"></a>  mark_object <span class="op">(</span>obj<span class="op">);</span></span></code></pre></div>
<p><strong>Critical Files:</strong> - src/lisp.h (core type definitions)
- src/alloc.c (memory management) - src/eval.c (evaluator) -
src/buffer.c (buffer implementation) - src/xdisp.c (display engine)</p>
<h3 data-number="4.3.3" id="elisp-runtime.md-15-20-pages"><span class="header-section-number">4.3.3</span> 03-elisp-runtime.md (15-20
pages)</h3>
<p><strong>Topics:</strong> - Lisp object representation - Tagged
pointers - Type system - Immediate values - Garbage collection details -
Mark phase - Sweep phase - Generations (lack thereof) - Symbol table
(obarray) - Symbol lookup - Interning - Function calling convention -
Argument passing - Stack frames - Return values</p>
<p><strong>Key Concepts:</strong> - Fixnum vs.¬†Bignum - Cons cells -
Vectors and arrays - String representation - Symbol properties</p>
<p><strong>Code Examples:</strong></p>
<div class="sourceCode" id="cb6"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb6-1"><a aria-hidden="true" href="#cb6-1" tabindex="-1"></a><span class="co">// Type checking</span></span>
<span id="cb6-2"><a aria-hidden="true" href="#cb6-2" tabindex="-1"></a><span class="cf">if</span> <span class="op">(!</span>STRINGP <span class="op">(</span>obj<span class="op">))</span></span>
<span id="cb6-3"><a aria-hidden="true" href="#cb6-3" tabindex="-1"></a>  wrong_type_argument <span class="op">(</span>Qstringp<span class="op">,</span> obj<span class="op">);</span></span>
<span id="cb6-4"><a aria-hidden="true" href="#cb6-4" tabindex="-1"></a></span>
<span id="cb6-5"><a aria-hidden="true" href="#cb6-5" tabindex="-1"></a><span class="co">// Symbol lookup</span></span>
<span id="cb6-6"><a aria-hidden="true" href="#cb6-6" tabindex="-1"></a>Lisp_Object sym <span class="op">=</span> intern <span class="op">(</span><span class="st">"forward-char"</span><span class="op">);</span></span>
<span id="cb6-7"><a aria-hidden="true" href="#cb6-7" tabindex="-1"></a></span>
<span id="cb6-8"><a aria-hidden="true" href="#cb6-8" tabindex="-1"></a><span class="co">// Function call</span></span>
<span id="cb6-9"><a aria-hidden="true" href="#cb6-9" tabindex="-1"></a>Lisp_Object result <span class="op">=</span> Ffuncall <span class="op">(</span>nargs<span class="op">,</span> args<span class="op">);</span></span></code></pre></div>
<p><strong>Data Structures:</strong></p>
<pre><code>Symbol structure:
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ name        ‚îÇ ‚Üí String
‚îÇ value       ‚îÇ ‚Üí Lisp_Object
‚îÇ function    ‚îÇ ‚Üí Function
‚îÇ plist       ‚îÇ ‚Üí Property list
‚îÇ next        ‚îÇ ‚Üí Next in obarray bucket
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò</code></pre>
<h3 data-number="4.3.4" id="bootstrap.md-12-15-pages"><span class="header-section-number">4.3.4</span> 04-bootstrap.md (12-15
pages)</h3>
<p><strong>Topics:</strong> - Early initialization (emacs.c:main) -
Command-line parsing - Environment setup - Memory initialization -
Loading loadup.el - Core Lisp files - Loading order - Dependencies -
Temacs to Emacs transformation - Preloading - Function resolution -
Dumping and undumping - Traditional unexec - Portable dumper (pdumper) -
Memory layout after dump</p>
<p><strong>Key Concepts:</strong> - Temacs (bare Emacs) - Preloaded Lisp
- Pure space - Dumped vs.¬†runtime state - Dump file format</p>
<p><strong>Code Examples:</strong></p>
<div class="sourceCode" id="cb8"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb8-1"><a aria-hidden="true" href="#cb8-1" tabindex="-1"></a><span class="co">// Main entry point</span></span>
<span id="cb8-2"><a aria-hidden="true" href="#cb8-2" tabindex="-1"></a><span class="dt">int</span> main <span class="op">(</span><span class="dt">int</span> argc<span class="op">,</span> <span class="dt">char</span> <span class="op">**</span>argv<span class="op">)</span></span>
<span id="cb8-3"><a aria-hidden="true" href="#cb8-3" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb8-4"><a aria-hidden="true" href="#cb8-4" tabindex="-1"></a>  <span class="co">// Early init</span></span>
<span id="cb8-5"><a aria-hidden="true" href="#cb8-5" tabindex="-1"></a>  init_alloc_once <span class="op">();</span></span>
<span id="cb8-6"><a aria-hidden="true" href="#cb8-6" tabindex="-1"></a>  init_eval_once <span class="op">();</span></span>
<span id="cb8-7"><a aria-hidden="true" href="#cb8-7" tabindex="-1"></a>  init_obarray_once <span class="op">();</span></span>
<span id="cb8-8"><a aria-hidden="true" href="#cb8-8" tabindex="-1"></a></span>
<span id="cb8-9"><a aria-hidden="true" href="#cb8-9" tabindex="-1"></a>  <span class="co">// Load preloaded Lisp</span></span>
<span id="cb8-10"><a aria-hidden="true" href="#cb8-10" tabindex="-1"></a>  Vload_path <span class="op">=</span> decode_env_path <span class="op">(</span><span class="dv">0</span><span class="op">,</span> normal_path<span class="op">,</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb8-11"><a aria-hidden="true" href="#cb8-11" tabindex="-1"></a>  load_file <span class="op">(</span><span class="st">"loadup.el"</span><span class="op">);</span></span>
<span id="cb8-12"><a aria-hidden="true" href="#cb8-12" tabindex="-1"></a></span>
<span id="cb8-13"><a aria-hidden="true" href="#cb8-13" tabindex="-1"></a>  <span class="co">// Dump or run</span></span>
<span id="cb8-14"><a aria-hidden="true" href="#cb8-14" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>dumping<span class="op">)</span></span>
<span id="cb8-15"><a aria-hidden="true" href="#cb8-15" tabindex="-1"></a>    pdumper_dump <span class="op">();</span></span>
<span id="cb8-16"><a aria-hidden="true" href="#cb8-16" tabindex="-1"></a>  <span class="cf">else</span></span>
<span id="cb8-17"><a aria-hidden="true" href="#cb8-17" tabindex="-1"></a>    command_loop <span class="op">();</span></span>
<span id="cb8-18"><a aria-hidden="true" href="#cb8-18" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>Figures:</strong> - Bootstrap flowchart - Memory layout
before/after dump - Loading dependency graph</p>
<h3 data-number="4.3.5" id="module-system.md-10-12-pages"><span class="header-section-number">4.3.5</span> 05-module-system.md (10-12
pages)</h3>
<p><strong>Topics:</strong> - Dynamic modules overview - Module API
(emacs-module.h) - Module structure - Function exports - Type
conversions - FFI (Foreign Function Interface) - Calling conventions -
Type marshalling - Error handling - Native compilation (libgccjit) -
Compilation pipeline - Async compilation - Performance - Security
considerations - Sandboxing - Trust model - Safe evaluation</p>
<p><strong>Key Concepts:</strong> - Module initialization - Environment
objects - Value representation across boundary - Native compiled
functions - Compilation unit cache</p>
<p><strong>Code Examples:</strong></p>
<div class="sourceCode" id="cb9"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb9-1"><a aria-hidden="true" href="#cb9-1" tabindex="-1"></a><span class="co">// Module initialization</span></span>
<span id="cb9-2"><a aria-hidden="true" href="#cb9-2" tabindex="-1"></a><span class="dt">int</span> emacs_module_init <span class="op">(</span><span class="kw">struct</span> emacs_runtime <span class="op">*</span>runtime<span class="op">)</span></span>
<span id="cb9-3"><a aria-hidden="true" href="#cb9-3" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb9-4"><a aria-hidden="true" href="#cb9-4" tabindex="-1"></a>  emacs_env <span class="op">*</span>env <span class="op">=</span> runtime<span class="op">-&gt;</span>get_environment <span class="op">(</span>runtime<span class="op">);</span></span>
<span id="cb9-5"><a aria-hidden="true" href="#cb9-5" tabindex="-1"></a></span>
<span id="cb9-6"><a aria-hidden="true" href="#cb9-6" tabindex="-1"></a>  <span class="co">// Define function</span></span>
<span id="cb9-7"><a aria-hidden="true" href="#cb9-7" tabindex="-1"></a>  emacs_value fun <span class="op">=</span> env<span class="op">-&gt;</span>make_function <span class="op">(</span>env<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> my_func<span class="op">,</span></span>
<span id="cb9-8"><a aria-hidden="true" href="#cb9-8" tabindex="-1"></a>                                        <span class="st">"My function"</span><span class="op">,</span> NULL<span class="op">);</span></span>
<span id="cb9-9"><a aria-hidden="true" href="#cb9-9" tabindex="-1"></a></span>
<span id="cb9-10"><a aria-hidden="true" href="#cb9-10" tabindex="-1"></a>  <span class="co">// Bind to symbol</span></span>
<span id="cb9-11"><a aria-hidden="true" href="#cb9-11" tabindex="-1"></a>  emacs_value symbol <span class="op">=</span> env<span class="op">-&gt;</span>intern <span class="op">(</span>env<span class="op">,</span> <span class="st">"my-func"</span><span class="op">);</span></span>
<span id="cb9-12"><a aria-hidden="true" href="#cb9-12" tabindex="-1"></a>  env<span class="op">-&gt;</span>funcall <span class="op">(</span>env<span class="op">,</span> env<span class="op">-&gt;</span>intern <span class="op">(</span>env<span class="op">,</span> <span class="st">"defalias"</span><span class="op">),</span> <span class="dv">2</span><span class="op">,</span></span>
<span id="cb9-13"><a aria-hidden="true" href="#cb9-13" tabindex="-1"></a>                <span class="op">(</span>emacs_value<span class="op">[]){</span>symbol<span class="op">,</span> fun<span class="op">});</span></span>
<span id="cb9-14"><a aria-hidden="true" href="#cb9-14" tabindex="-1"></a></span>
<span id="cb9-15"><a aria-hidden="true" href="#cb9-15" tabindex="-1"></a>  <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb9-16"><a aria-hidden="true" href="#cb9-16" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 data-number="4.3.6" id="threading.md-8-10-pages"><span class="header-section-number">4.3.6</span> 06-threading.md (8-10
pages)</h3>
<p><strong>Topics:</strong> - Cooperative threads - Thread creation -
Thread switching - Thread-local state - Thread safety considerations -
Global state - Shared buffers - Mutual exclusion - Async I/O integration
- Futures and promises - Async programming patterns - Limitations and
constraints - No true parallelism - GIL equivalent - Performance
implications - Future directions - Potential improvements - Parallel GC
- True multi-threading</p>
<p><strong>Key Concepts:</strong> - Thread objects - Thread switching
points - Thread-local bindings - Deadlock avoidance</p>
<p><strong>Code Examples:</strong></p>
<pre class="elisp"><code>;; Create thread
(make-thread
  (lambda ()
    (message "Running in thread"))
  "my-thread")

;; Thread-local binding
(let ((lexical-binding t))
  (make-thread
    (lambda ()
      (let ((value 42))
        (message "Value: %d" value)))))</code></pre>
<h2 data-number="4.4" id="key-takeaways-1"><span class="header-section-number">4.4</span> Key Takeaways</h2>
<ol type="1">
<li><strong>Two-Tier Design</strong>: C provides performance-critical
primitives; Elisp provides extensibility</li>
<li><strong>Unified Type System</strong>: All Lisp objects share a
common representation</li>
<li><strong>Garbage Collection</strong>: Automatic memory management
with mark-and-sweep GC</li>
<li><strong>Bootstrap Complexity</strong>: Understanding startup is key
to understanding the whole system</li>
<li><strong>Module System</strong>: Modern extension mechanism for
performance-critical code</li>
<li><strong>Threading Limitations</strong>: Cooperative threading, not
true parallelism</li>
</ol>
<h2 data-number="4.5" id="prerequisites-2"><span class="header-section-number">4.5</span> Prerequisites</h2>
<h3 data-number="4.5.1" id="required-knowledge-1"><span class="header-section-number">4.5.1</span> Required Knowledge</h3>
<ul>
<li>C programming (pointers, structs, memory management)</li>
<li>Basic understanding of Lisp</li>
<li>Familiarity with system programming concepts</li>
<li>Operating system fundamentals</li>
</ul>
<h3 data-number="4.5.2" id="recommended-background-1"><span class="header-section-number">4.5.2</span> Recommended Background</h3>
<ul>
<li>Compiler design basics</li>
<li>Virtual machine implementation</li>
<li>Memory management techniques</li>
<li>Concurrent programming concepts</li>
</ul>
<h2 data-number="4.6" id="cross-references-1"><span class="header-section-number">4.6</span> Cross-References</h2>
<h3 data-number="4.6.1" id="this-chapter-references"><span class="header-section-number">4.6.1</span> This Chapter References</h3>
<ul>
<li><span class="citation" data-cites="chap:00">[@chap:00]</span>
Introduction (for context)</li>
<li><span class="citation" data-cites="chap:02">[@chap:02]</span> Core
Subsystems (detailed exploration)</li>
<li><span class="citation" data-cites="chap:03">[@chap:03]</span> Elisp
Runtime (detailed implementation)</li>
<li><span class="citation" data-cites="chap:18">[@chap:18]</span> Build
System (compilation and dumping)</li>
</ul>
<h3 data-number="4.6.2" id="referenced-by"><span class="header-section-number">4.6.2</span> Referenced By</h3>
<ul>
<li>Most subsequent chapters depend on this architectural
foundation</li>
<li><span class="citation" data-cites="chap:05">[@chap:05]</span>
Display Engine (terminal abstraction)</li>
<li><span class="citation" data-cites="chap:04">[@chap:04]</span> Buffer
Management (gap buffer details)</li>
<li><span class="citation" data-cites="chap:21">[@chap:21]</span>
Advanced Topics (extending the C core)</li>
</ul>
<h2 data-number="4.7" id="key-files-reference"><span class="header-section-number">4.7</span> Key Files Reference</h2>
<h3 data-number="4.7.1" id="c-core-files"><span class="header-section-number">4.7.1</span> C Core Files</h3>
<pre><code>src/
‚îú‚îÄ‚îÄ lisp.h           # Core type definitions
‚îú‚îÄ‚îÄ alloc.c          # Memory management and GC
‚îú‚îÄ‚îÄ eval.c           # Lisp evaluator
‚îú‚îÄ‚îÄ bytecode.c       # Bytecode interpreter
‚îú‚îÄ‚îÄ buffer.c         # Buffer implementation
‚îú‚îÄ‚îÄ emacs.c          # Main entry point
‚îú‚îÄ‚îÄ pdumper.c        # Portable dumper
‚îî‚îÄ‚îÄ module.c         # Module system</code></pre>
<h3 data-number="4.7.2" id="lisp-files"><span class="header-section-number">4.7.2</span> Lisp Files</h3>
<pre><code>lisp/
‚îú‚îÄ‚îÄ loadup.el        # Bootstrap loader
‚îú‚îÄ‚îÄ startup.el       # Startup sequence
‚îî‚îÄ‚îÄ emacs-lisp/
    ‚îú‚îÄ‚îÄ bytecomp.el  # Byte compiler
    ‚îî‚îÄ‚îÄ nadvice.el   # Advice system</code></pre>
<h2 data-number="4.8" id="exercises"><span class="header-section-number">4.8</span> Exercises</h2>
<ol type="1">
<li><strong>Trace Bootstrap</strong>: Follow execution from main()
through loadup.el</li>
<li><strong>Find Primitive</strong>: Locate a C primitive (DEFUN) and
trace its Lisp usage</li>
<li><strong>Dump Analysis</strong>: Compare temacs and dumped Emacs
memory layout</li>
<li><strong>Module Creation</strong>: Write a simple dynamic module</li>
<li><strong>Threading Experiment</strong>: Create threads and observe
switching behavior</li>
</ol>
<h2 data-number="4.9" id="further-reading-1"><span class="header-section-number">4.9</span> Further Reading</h2>
<h3 data-number="4.9.1" id="papers"><span class="header-section-number">4.9.1</span> Papers</h3>
<ul>
<li><span class="citation" data-cites="stallman:emacs:1981">[@stallman:emacs:1981]</span> Original
Emacs design</li>
<li><span class="citation" data-cites="steele:lambda:1978">[@steele:lambda:1978]</span> Lisp
interpreter implementation</li>
<li><span class="citation" data-cites="jones:gc:2011">[@jones:gc:2011]</span> Garbage collection
techniques</li>
</ul>
<h3 data-number="4.9.2" id="manuals"><span class="header-section-number">4.9.2</span> Manuals</h3>
<ul>
<li><span class="citation" data-cites="elisp:manual:2024">[@elisp:manual:2024]</span> Elisp
reference</li>
<li>GNU Coding Standards</li>
<li>GCC libgccjit documentation</li>
</ul>
<h3 data-number="4.9.3" id="source-code"><span class="header-section-number">4.9.3</span> Source Code</h3>
<ul>
<li>src/README</li>
<li>src/TUTORIAL</li>
<li>Comments in src/*.c files</li>
</ul>
<h2 data-number="4.10" id="development-tips"><span class="header-section-number">4.10</span> Development Tips</h2>
<h3 data-number="4.10.1" id="debugging-architecture"><span class="header-section-number">4.10.1</span> Debugging Architecture</h3>
<div class="sourceCode" id="cb13"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb13-1"><a aria-hidden="true" href="#cb13-1" tabindex="-1"></a><span class="co"># Build with debugging symbols</span></span>
<span id="cb13-2"><a aria-hidden="true" href="#cb13-2" tabindex="-1"></a><span class="ex">./configure</span> <span class="at">--enable-checking</span><span class="op">=</span><span class="st">'yes,glyphs'</span> CFLAGS=<span class="st">'-O0 -g3'</span></span>
<span id="cb13-3"><a aria-hidden="true" href="#cb13-3" tabindex="-1"></a><span class="fu">make</span></span>
<span id="cb13-4"><a aria-hidden="true" href="#cb13-4" tabindex="-1"></a></span>
<span id="cb13-5"><a aria-hidden="true" href="#cb13-5" tabindex="-1"></a><span class="co"># Debug with GDB</span></span>
<span id="cb13-6"><a aria-hidden="true" href="#cb13-6" tabindex="-1"></a><span class="fu">gdb</span> ./src/emacs</span>
<span id="cb13-7"><a aria-hidden="true" href="#cb13-7" tabindex="-1"></a><span class="kw">(</span><span class="fu">gdb</span><span class="kw">)</span> <span class="bu">source</span> src/.gdbinit</span>
<span id="cb13-8"><a aria-hidden="true" href="#cb13-8" tabindex="-1"></a><span class="kw">(</span><span class="fu">gdb</span><span class="kw">)</span> <span class="cf">break</span> <span class="ex">main</span></span>
<span id="cb13-9"><a aria-hidden="true" href="#cb13-9" tabindex="-1"></a><span class="kw">(</span><span class="fu">gdb</span><span class="kw">)</span> <span class="ex">run</span></span></code></pre></div>
<h3 data-number="4.10.2" id="exploring-components"><span class="header-section-number">4.10.2</span> Exploring Components</h3>
<pre class="elisp"><code>;; Find C primitive source
M-x find-function RET forward-char RET

;; View primitive help
C-h f forward-char RET

;; List all primitives
M-x apropos-value RET #&lt;subr RET</code></pre>
<h2 data-number="4.11" id="status-and-todo-1"><span class="header-section-number">4.11</span> Status and Todo</h2>
<ul class="task-list">
<li><label><input type="checkbox"/>Draft
01-system-architecture.md</label></li>
<li><label><input type="checkbox"/>Draft
02-c-core-subsystems.md</label></li>
<li><label><input type="checkbox"/>Draft
03-elisp-runtime.md</label></li>
<li><label><input type="checkbox"/>Draft 04-bootstrap.md</label></li>
<li><label><input type="checkbox"/>Draft
05-module-system.md</label></li>
<li><label><input type="checkbox"/>Draft 06-threading.md</label></li>
<li><label><input type="checkbox"/>Create architecture
diagrams</label></li>
<li><label><input type="checkbox"/>Create bootstrap
flowcharts</label></li>
<li><label><input type="checkbox"/>Create memory layout
diagrams</label></li>
<li><label><input type="checkbox"/>Test all code examples</label></li>
<li><label><input type="checkbox"/>Write exercises with
solutions</label></li>
<li><label><input type="checkbox"/>Peer review</label></li>
<li><label><input type="checkbox"/>Technical review by core
maintainers</label></li>
</ul>
<h2 data-number="4.12" id="changelog-1"><span class="header-section-number">4.12</span> Changelog</h2>
<ul>
<li>2025-11-18: Initial chapter structure and README created</li>
</ul>
<h1 data-number="5" id="design-philosophy-and-principles"><span class="header-section-number">5</span> Design Philosophy and
Principles</h1>
<p><strong>Chapter 01, Section 02</strong> <strong>Version:</strong>
1.0.0 <strong>Date:</strong> 2025-11-18 <strong>Status:</strong>
Complete</p>
<hr/>
<h2 data-number="5.1" id="overview"><span class="header-section-number">5.1</span> Overview</h2>
<p>Emacs has survived and thrived for four decades not through accident,
but through adherence to a coherent set of design principles. These
principles permeate every layer of the system, from the bit patterns in
C structures to the conventions in Elisp packages. Understanding these
principles is essential to understanding why Emacs works the way it
does‚Äîand why it has remained relevant while countless other editors have
come and gone.</p>
<p>This chapter analyzes the core design philosophy that runs through
the Emacs codebase, examining how abstract principles manifest as
concrete implementation decisions. We‚Äôll explore eight fundamental
principles with real code examples from the current codebase.</p>
<hr/>
<h2 data-number="5.2" id="self-documentation-principle"><span class="header-section-number">5.2</span> 1. Self-Documentation
Principle</h2>
<h3 data-number="5.2.1" id="the-philosophy"><span class="header-section-number">5.2.1</span> The Philosophy</h3>
<p>‚ÄúThe editor should explain itself.‚Äù Emacs was revolutionary in making
introspection a first-class feature. Every function, every variable,
every key binding can be queried at runtime. Documentation isn‚Äôt an
external artifact that might drift out of sync‚Äîit‚Äôs part of the code
itself.</p>
<h3 data-number="5.2.2" id="how-it-manifests-in-code"><span class="header-section-number">5.2.2</span> How It Manifests in Code</h3>
<h4 data-number="5.2.2.1" id="defun-documentation-strings"><span class="header-section-number">5.2.2.1</span> DEFUN Documentation
Strings</h4>
<p>In C, the <code>DEFUN</code> macro creates primitives that are
callable from Lisp. Every DEFUN includes a documentation string that
becomes part of the function object:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb15-1"><a aria-hidden="true" href="#cb15-1" tabindex="-1"></a><span class="co">// @file: src/buffer.c</span></span>
<span id="cb15-2"><a aria-hidden="true" href="#cb15-2" tabindex="-1"></a><span class="co">// @lines: 807-829</span></span>
<span id="cb15-3"><a aria-hidden="true" href="#cb15-3" tabindex="-1"></a><span class="co">// @description: DEFUN with comprehensive documentation</span></span>
<span id="cb15-4"><a aria-hidden="true" href="#cb15-4" tabindex="-1"></a></span>
<span id="cb15-5"><a aria-hidden="true" href="#cb15-5" tabindex="-1"></a>DEFUN <span class="op">(</span><span class="st">"make-indirect-buffer"</span><span class="op">,</span> Fmake_indirect_buffer<span class="op">,</span> Smake_indirect_buffer<span class="op">,</span></span>
<span id="cb15-6"><a aria-hidden="true" href="#cb15-6" tabindex="-1"></a>       <span class="dv">2</span><span class="op">,</span> <span class="dv">4</span><span class="op">,</span></span>
<span id="cb15-7"><a aria-hidden="true" href="#cb15-7" tabindex="-1"></a>       <span class="st">"bMake indirect buffer (to buffer): </span><span class="sc">\n</span><span class="st">BName of indirect buffer: "</span><span class="op">,</span></span>
<span id="cb15-8"><a aria-hidden="true" href="#cb15-8" tabindex="-1"></a>       doc<span class="op">:</span> <span class="co">/* Create and return an indirect buffer for buffer BASE-BUFFER, named NAME.</span></span>
<span id="cb15-9"><a aria-hidden="true" href="#cb15-9" tabindex="-1"></a><span class="co">BASE-BUFFER should be a live buffer, or the name of an existing buffer.</span></span>
<span id="cb15-10"><a aria-hidden="true" href="#cb15-10" tabindex="-1"></a></span>
<span id="cb15-11"><a aria-hidden="true" href="#cb15-11" tabindex="-1"></a><span class="co">NAME should be a string which is not the name of an existing buffer.</span></span>
<span id="cb15-12"><a aria-hidden="true" href="#cb15-12" tabindex="-1"></a></span>
<span id="cb15-13"><a aria-hidden="true" href="#cb15-13" tabindex="-1"></a><span class="co">Interactively, prompt for BASE-BUFFER (offering the current buffer as</span></span>
<span id="cb15-14"><a aria-hidden="true" href="#cb15-14" tabindex="-1"></a><span class="co">the default), and for NAME (offering as default the name of a recently</span></span>
<span id="cb15-15"><a aria-hidden="true" href="#cb15-15" tabindex="-1"></a><span class="co">used buffer).</span></span>
<span id="cb15-16"><a aria-hidden="true" href="#cb15-16" tabindex="-1"></a></span>
<span id="cb15-17"><a aria-hidden="true" href="#cb15-17" tabindex="-1"></a><span class="co">Optional argument CLONE non-nil means preserve BASE-BUFFER's state,</span></span>
<span id="cb15-18"><a aria-hidden="true" href="#cb15-18" tabindex="-1"></a><span class="co">such as major and minor modes, in the indirect buffer.</span></span>
<span id="cb15-19"><a aria-hidden="true" href="#cb15-19" tabindex="-1"></a><span class="co">CLONE nil means the indirect buffer's state is reset to default values.</span></span>
<span id="cb15-20"><a aria-hidden="true" href="#cb15-20" tabindex="-1"></a></span>
<span id="cb15-21"><a aria-hidden="true" href="#cb15-21" tabindex="-1"></a><span class="co">If optional argument INHIBIT-BUFFER-HOOKS is non-nil, the new buffer</span></span>
<span id="cb15-22"><a aria-hidden="true" href="#cb15-22" tabindex="-1"></a><span class="co">does not run the hooks `kill-buffer-hook',</span></span>
<span id="cb15-23"><a aria-hidden="true" href="#cb15-23" tabindex="-1"></a><span class="co">`kill-buffer-query-functions', and `buffer-list-update-hook'.</span></span>
<span id="cb15-24"><a aria-hidden="true" href="#cb15-24" tabindex="-1"></a></span>
<span id="cb15-25"><a aria-hidden="true" href="#cb15-25" tabindex="-1"></a><span class="co">Interactively, CLONE and INHIBIT-BUFFER-HOOKS are nil.  */</span><span class="op">)</span></span>
<span id="cb15-26"><a aria-hidden="true" href="#cb15-26" tabindex="-1"></a>  <span class="op">(</span>Lisp_Object base_buffer<span class="op">,</span> Lisp_Object name<span class="op">,</span> Lisp_Object clone<span class="op">,</span></span>
<span id="cb15-27"><a aria-hidden="true" href="#cb15-27" tabindex="-1"></a>   Lisp_Object inhibit_buffer_hooks<span class="op">)</span></span>
<span id="cb15-28"><a aria-hidden="true" href="#cb15-28" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb15-29"><a aria-hidden="true" href="#cb15-29" tabindex="-1"></a>  <span class="co">/* Implementation follows... */</span></span>
<span id="cb15-30"><a aria-hidden="true" href="#cb15-30" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>Key Elements:</strong></p>
<ol type="1">
<li><strong>Interactive specification</strong>:
<code>"bMake indirect buffer..."</code>‚Äîtells how to prompt users</li>
<li><strong>Documentation string</strong>: The <code>doc:</code> comment
becomes the function‚Äôs documentation</li>
<li><strong>Cross-references</strong>: Backtick-quoted names like
<code>`kill-buffer-hook'</code> become clickable links</li>
<li><strong>Complete signature</strong>: Parameters are documented with
types and meanings</li>
</ol>
<p>This documentation is <strong>not</strong> extracted by a separate
tool‚Äîit‚Äôs compiled into the function object. You can access it at
runtime:</p>
<pre class="elisp"><code>(documentation 'make-indirect-buffer)
;; Returns the doc string shown above</code></pre>
<h4 data-number="5.2.2.2" id="help-system-integration"><span class="header-section-number">5.2.2.2</span> Help System
Integration</h4>
<p>The help system (<code>/home/user/emacs/lisp/help.el</code>)
leverages this built-in documentation:</p>
<pre class="elisp"><code>;; From help.el
(defun describe-function (function)
  "Display the full documentation of FUNCTION (a symbol)."
  (interactive (list (function-called-at-point)))
  (let ((doc (documentation function)))
    (with-help-window (help-buffer)
      (prin1 function)
      (princ " is ")
      (describe-function-1 function)
      (with-current-buffer standard-output
        (insert "\n" doc)
        ;; Add links to source code
        (when (commandp function)
          (insert "\n\nIt is bound to ")
          (insert (mapconcat #'key-description
                             (where-is-internal function)
                             ", ")))))))</code></pre>
<p>The help system can: - Show documentation for any function - Display
the source code location - List all key bindings - Show interactive
prompts - Cross-reference related functions</p>
<h4 data-number="5.2.2.3" id="self-describing-data-structures"><span class="header-section-number">5.2.2.3</span> Self-Describing Data
Structures</h4>
<p>Even C structures participate in self-documentation through careful
naming and comments:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb18-1"><a aria-hidden="true" href="#cb18-1" tabindex="-1"></a><span class="co">// @file: src/buffer.h</span></span>
<span id="cb18-2"><a aria-hidden="true" href="#cb18-2" tabindex="-1"></a><span class="co">// @description: Buffer structure with inline documentation</span></span>
<span id="cb18-3"><a aria-hidden="true" href="#cb18-3" tabindex="-1"></a></span>
<span id="cb18-4"><a aria-hidden="true" href="#cb18-4" tabindex="-1"></a><span class="kw">struct</span> buffer</span>
<span id="cb18-5"><a aria-hidden="true" href="#cb18-5" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb18-6"><a aria-hidden="true" href="#cb18-6" tabindex="-1"></a>  <span class="co">/* The buffer's text, carefully documented */</span></span>
<span id="cb18-7"><a aria-hidden="true" href="#cb18-7" tabindex="-1"></a>  <span class="kw">struct</span> buffer_text <span class="op">*</span>text<span class="op">;</span></span>
<span id="cb18-8"><a aria-hidden="true" href="#cb18-8" tabindex="-1"></a></span>
<span id="cb18-9"><a aria-hidden="true" href="#cb18-9" tabindex="-1"></a>  <span class="co">/* Position of point in buffer. */</span></span>
<span id="cb18-10"><a aria-hidden="true" href="#cb18-10" tabindex="-1"></a>  <span class="dt">ptrdiff_t</span> pt<span class="op">;</span></span>
<span id="cb18-11"><a aria-hidden="true" href="#cb18-11" tabindex="-1"></a></span>
<span id="cb18-12"><a aria-hidden="true" href="#cb18-12" tabindex="-1"></a>  <span class="co">/* Byte position corresponding to PT. */</span></span>
<span id="cb18-13"><a aria-hidden="true" href="#cb18-13" tabindex="-1"></a>  <span class="dt">ptrdiff_t</span> pt_byte<span class="op">;</span></span>
<span id="cb18-14"><a aria-hidden="true" href="#cb18-14" tabindex="-1"></a></span>
<span id="cb18-15"><a aria-hidden="true" href="#cb18-15" tabindex="-1"></a>  <span class="co">/* Similar positions for start of visible region. */</span></span>
<span id="cb18-16"><a aria-hidden="true" href="#cb18-16" tabindex="-1"></a>  <span class="dt">ptrdiff_t</span> begv<span class="op">;</span></span>
<span id="cb18-17"><a aria-hidden="true" href="#cb18-17" tabindex="-1"></a>  <span class="dt">ptrdiff_t</span> begv_byte<span class="op">;</span></span>
<span id="cb18-18"><a aria-hidden="true" href="#cb18-18" tabindex="-1"></a></span>
<span id="cb18-19"><a aria-hidden="true" href="#cb18-19" tabindex="-1"></a>  <span class="co">/* Similar positions for end of visible region. */</span></span>
<span id="cb18-20"><a aria-hidden="true" href="#cb18-20" tabindex="-1"></a>  <span class="dt">ptrdiff_t</span> zv<span class="op">;</span></span>
<span id="cb18-21"><a aria-hidden="true" href="#cb18-21" tabindex="-1"></a>  <span class="dt">ptrdiff_t</span> zv_byte<span class="op">;</span></span>
<span id="cb18-22"><a aria-hidden="true" href="#cb18-22" tabindex="-1"></a></span>
<span id="cb18-23"><a aria-hidden="true" href="#cb18-23" tabindex="-1"></a>  <span class="co">/* The base buffer (null for non-indirect buffers). */</span></span>
<span id="cb18-24"><a aria-hidden="true" href="#cb18-24" tabindex="-1"></a>  <span class="kw">struct</span> buffer <span class="op">*</span>base_buffer<span class="op">;</span></span>
<span id="cb18-25"><a aria-hidden="true" href="#cb18-25" tabindex="-1"></a></span>
<span id="cb18-26"><a aria-hidden="true" href="#cb18-26" tabindex="-1"></a>  <span class="co">/* Count of how many indirect buffers share this buffer's text.</span></span>
<span id="cb18-27"><a aria-hidden="true" href="#cb18-27" tabindex="-1"></a><span class="co">     0 if this buffer is not sharing anyone else's text.</span></span>
<span id="cb18-28"><a aria-hidden="true" href="#cb18-28" tabindex="-1"></a><span class="co">     -1 if this buffer is an indirect buffer. */</span></span>
<span id="cb18-29"><a aria-hidden="true" href="#cb18-29" tabindex="-1"></a>  <span class="dt">int</span> indirections<span class="op">;</span></span>
<span id="cb18-30"><a aria-hidden="true" href="#cb18-30" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<h3 data-number="5.2.3" id="why-this-matters"><span class="header-section-number">5.2.3</span> Why This Matters</h3>
<ol type="1">
<li><strong>Reduced barrier to learning</strong>: Users can discover
features without external documentation</li>
<li><strong>Always accurate</strong>: Documentation can‚Äôt drift from
code‚Äîit <em>is</em> the code</li>
<li><strong>Encourages exploration</strong>: Users can safely
experiment, knowing help is always available</li>
<li><strong>Facilitates contribution</strong>: Reading documentation
leads naturally to reading implementation</li>
<li><strong>Enables tooling</strong>: IDEs, completion systems, and help
modes can leverage this metadata</li>
</ol>
<h3 data-number="5.2.4" id="the-cost"><span class="header-section-number">5.2.4</span> The Cost</h3>
<p>Self-documentation imposes discipline: - Every public function must
have a complete docstring - Interactive prompts must be user-friendly -
Parameter names must be meaningful - The documentation increases binary
size (mitigated by sharing strings)</p>
<p>But the payoff is enormous: Emacs users routinely read source code as
part of normal usage, blurring the line between user and developer.</p>
<hr/>
<h2 data-number="5.3" id="extensibility-philosophy"><span class="header-section-number">5.3</span> 2. Extensibility
Philosophy</h2>
<h3 data-number="5.3.1" id="the-philosophy-1"><span class="header-section-number">5.3.1</span> The Philosophy</h3>
<p>‚ÄúEverything can be changed at runtime.‚Äù Emacs isn‚Äôt just extensible
through plugins‚Äîit‚Äôs designed so that user code has the same power as
core code. There‚Äôs no privileged API boundary. The system is
fundamentally malleable.</p>
<h3 data-number="5.3.2" id="the-core-architecture"><span class="header-section-number">5.3.2</span> The Core Architecture</h3>
<p>Emacs is best understood as <strong>a Lisp interpreter that
specializes in text manipulation</strong>. The C core
(<code>/home/user/emacs/src/</code>) provides:</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb19-1"><a aria-hidden="true" href="#cb19-1" tabindex="-1"></a><span class="co">// @file: src/eval.c</span></span>
<span id="cb19-2"><a aria-hidden="true" href="#cb19-2" tabindex="-1"></a><span class="co">// @description: The evaluation engine that makes everything extensible</span></span>
<span id="cb19-3"><a aria-hidden="true" href="#cb19-3" tabindex="-1"></a></span>
<span id="cb19-4"><a aria-hidden="true" href="#cb19-4" tabindex="-1"></a><span class="co">/* Apply a Lisp function FUN to the NARGS evaluated arguments in ARG_VECTOR</span></span>
<span id="cb19-5"><a aria-hidden="true" href="#cb19-5" tabindex="-1"></a><span class="co">   and return the result.  */</span></span>
<span id="cb19-6"><a aria-hidden="true" href="#cb19-6" tabindex="-1"></a>Lisp_Object</span>
<span id="cb19-7"><a aria-hidden="true" href="#cb19-7" tabindex="-1"></a>Ffuncall <span class="op">(</span><span class="dt">ptrdiff_t</span> nargs<span class="op">,</span> Lisp_Object <span class="op">*</span>args<span class="op">)</span></span>
<span id="cb19-8"><a aria-hidden="true" href="#cb19-8" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb19-9"><a aria-hidden="true" href="#cb19-9" tabindex="-1"></a>  Lisp_Object fun<span class="op">,</span> val<span class="op">;</span></span>
<span id="cb19-10"><a aria-hidden="true" href="#cb19-10" tabindex="-1"></a>  Lisp_Object <span class="op">*</span>internal_args<span class="op">;</span></span>
<span id="cb19-11"><a aria-hidden="true" href="#cb19-11" tabindex="-1"></a>  <span class="dt">ptrdiff_t</span> i<span class="op">;</span></span>
<span id="cb19-12"><a aria-hidden="true" href="#cb19-12" tabindex="-1"></a></span>
<span id="cb19-13"><a aria-hidden="true" href="#cb19-13" tabindex="-1"></a>  <span class="co">/* Get the function to call */</span></span>
<span id="cb19-14"><a aria-hidden="true" href="#cb19-14" tabindex="-1"></a>  fun <span class="op">=</span> args<span class="op">[</span><span class="dv">0</span><span class="op">];</span></span>
<span id="cb19-15"><a aria-hidden="true" href="#cb19-15" tabindex="-1"></a></span>
<span id="cb19-16"><a aria-hidden="true" href="#cb19-16" tabindex="-1"></a>  <span class="co">/* If it's a symbol, find its function definition */</span></span>
<span id="cb19-17"><a aria-hidden="true" href="#cb19-17" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>SYMBOLP <span class="op">(</span>fun<span class="op">))</span></span>
<span id="cb19-18"><a aria-hidden="true" href="#cb19-18" tabindex="-1"></a>    fun <span class="op">=</span> XSYMBOL <span class="op">(</span>fun<span class="op">)-&gt;</span>u<span class="op">.</span>s<span class="op">.</span>function<span class="op">;</span></span>
<span id="cb19-19"><a aria-hidden="true" href="#cb19-19" tabindex="-1"></a></span>
<span id="cb19-20"><a aria-hidden="true" href="#cb19-20" tabindex="-1"></a>  <span class="co">/* Handle different function types */</span></span>
<span id="cb19-21"><a aria-hidden="true" href="#cb19-21" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>SUBRP <span class="op">(</span>fun<span class="op">))</span></span>
<span id="cb19-22"><a aria-hidden="true" href="#cb19-22" tabindex="-1"></a>    <span class="cf">return</span> Fsubr_call <span class="op">(</span>fun<span class="op">,</span> nargs <span class="op">-</span> <span class="dv">1</span><span class="op">,</span> args <span class="op">+</span> <span class="dv">1</span><span class="op">);</span>  <span class="co">/* C primitive */</span></span>
<span id="cb19-23"><a aria-hidden="true" href="#cb19-23" tabindex="-1"></a>  <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>COMPILEDP <span class="op">(</span>fun<span class="op">))</span></span>
<span id="cb19-24"><a aria-hidden="true" href="#cb19-24" tabindex="-1"></a>    <span class="cf">return</span> exec_byte_code <span class="op">(</span>fun<span class="op">,</span> nargs <span class="op">-</span> <span class="dv">1</span><span class="op">,</span> args <span class="op">+</span> <span class="dv">1</span><span class="op">);</span>  <span class="co">/* Bytecode */</span></span>
<span id="cb19-25"><a aria-hidden="true" href="#cb19-25" tabindex="-1"></a>  <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>CONSP <span class="op">(</span>fun<span class="op">))</span></span>
<span id="cb19-26"><a aria-hidden="true" href="#cb19-26" tabindex="-1"></a>    <span class="cf">return</span> Feval <span class="op">(</span>Fcons <span class="op">(</span>fun<span class="op">,</span> Flist <span class="op">(</span>nargs <span class="op">-</span> <span class="dv">1</span><span class="op">,</span> args <span class="op">+</span> <span class="dv">1</span><span class="op">)),</span> Qnil<span class="op">);</span>  <span class="co">/* Lambda */</span></span>
<span id="cb19-27"><a aria-hidden="true" href="#cb19-27" tabindex="-1"></a>  <span class="cf">else</span></span>
<span id="cb19-28"><a aria-hidden="true" href="#cb19-28" tabindex="-1"></a>    xsignal1 <span class="op">(</span>Qinvalid_function<span class="op">,</span> fun<span class="op">);</span></span>
<span id="cb19-29"><a aria-hidden="true" href="#cb19-29" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Notice that C primitives (SUBRP), bytecode (COMPILEDP), and
interpreted Lisp (CONSP) are <strong>all first-class</strong>. From
Lisp‚Äôs perspective, there‚Äôs no difference between calling a C function
and calling an Elisp function.</p>
<h3 data-number="5.3.3" id="runtime-redefinition"><span class="header-section-number">5.3.3</span> Runtime Redefinition</h3>
<p>Everything can be changed at runtime. <strong>Everything.</strong>
Consider the advice system
(<code>/home/user/emacs/lisp/emacs-lisp/nadvice.el</code>):</p>
<pre class="elisp"><code>;; @file: lisp/emacs-lisp/nadvice.el
;; @description: Advice allows wrapping any function with additional behavior

(defvar advice--how-alist
  '((:around (apply car cdr r))
    (:before (apply car r) (apply cdr r))
    (:after (prog1 (apply cdr r) (apply car r)))
    (:override (apply car r))
    (:after-until (or (apply cdr r) (apply car r)))
    (:after-while (and (apply cdr r) (apply car r)))
    (:before-until (or (apply car r) (apply cdr r)))
    (:before-while (and (apply car r) (apply cdr r)))
    (:filter-args (apply cdr (funcall car r)))
    (:filter-return (funcall car (apply cdr r))))
  "How to combine a piece of advice with the original function.")

;; Example: Add logging to any function
(defun my-trace (orig-fun &amp;rest args)
  "Log calls to ORIG-FUN with ARGS."
  (message "Calling %s with %S" orig-fun args)
  (let ((result (apply orig-fun args)))
    (message "Result: %S" result)
    result))

;; Now we can wrap ANY function, even C primitives:
(advice-add 'insert :around #'my-trace)
;; Now every call to `insert' will be logged!</code></pre>
<p>You can advise <strong>anything</strong>‚Äîeven core C primitives like
<code>insert</code>, <code>forward-char</code>, or
<code>redisplay</code>. The system doesn‚Äôt distinguish between core and
extension code.</p>
<h3 data-number="5.3.4" id="hooks-everywhere"><span class="header-section-number">5.3.4</span> Hooks Everywhere</h3>
<p>Extension points are pervasive. From
<code>/home/user/emacs/lisp/files.el</code>:</p>
<pre class="elisp"><code>;; @file: lisp/files.el
;; @description: Hooks provide extension points at every key operation

(defcustom find-file-hook nil
  "List of functions to call after finding a file.
See also `find-file-not-found-functions'."
  :type 'hook
  :group 'files)

(defcustom before-save-hook nil
  "Normal hook run before saving a file.
Errors running this hook don't prevent saving."
  :type 'hook
  :group 'files)

(defcustom after-save-hook nil
  "Normal hook run after a buffer is saved to its file."
  :type 'hook
  :group 'files)</code></pre>
<p>Every significant operation has hooks: - <code>find-file-hook</code>:
After opening a file - <code>before-save-hook</code>,
<code>after-save-hook</code>: Around saves -
<code>kill-buffer-hook</code>: Before killing buffers -
<code>change-major-mode-hook</code>: Before mode changes - Hundreds more
throughout the system</p>
<h3 data-number="5.3.5" id="no-hard-coded-limits"><span class="header-section-number">5.3.5</span> No Hard-Coded Limits</h3>
<p>The principle ‚Äúno arbitrary limits‚Äù is taken seriously. Buffer sizes
are limited only by available memory (ptrdiff_t range). Consider
<code>/home/user/emacs/src/lisp.h</code>:</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb22-1"><a aria-hidden="true" href="#cb22-1" tabindex="-1"></a><span class="co">// @file: src/lisp.h</span></span>
<span id="cb22-2"><a aria-hidden="true" href="#cb22-2" tabindex="-1"></a><span class="co">// @description: Emacs integer type chosen to avoid artificial limits</span></span>
<span id="cb22-3"><a aria-hidden="true" href="#cb22-3" tabindex="-1"></a></span>
<span id="cb22-4"><a aria-hidden="true" href="#cb22-4" tabindex="-1"></a><span class="co">/* EMACS_INT - signed integer wide enough to hold an Emacs value */</span></span>
<span id="cb22-5"><a aria-hidden="true" href="#cb22-5" tabindex="-1"></a><span class="pp">#if INTPTR_MAX &lt;= INT_MAX &amp;&amp; !defined WIDE_EMACS_INT</span></span>
<span id="cb22-6"><a aria-hidden="true" href="#cb22-6" tabindex="-1"></a><span class="kw">typedef</span> <span class="dt">int</span> EMACS_INT<span class="op">;</span></span>
<span id="cb22-7"><a aria-hidden="true" href="#cb22-7" tabindex="-1"></a><span class="kw">typedef</span> <span class="dt">unsigned</span> <span class="dt">int</span> EMACS_UINT<span class="op">;</span></span>
<span id="cb22-8"><a aria-hidden="true" href="#cb22-8" tabindex="-1"></a><span class="pp">#elif INTPTR_MAX &lt;= LONG_MAX &amp;&amp; !defined WIDE_EMACS_INT</span></span>
<span id="cb22-9"><a aria-hidden="true" href="#cb22-9" tabindex="-1"></a><span class="kw">typedef</span> <span class="dt">long</span> <span class="dt">int</span> EMACS_INT<span class="op">;</span></span>
<span id="cb22-10"><a aria-hidden="true" href="#cb22-10" tabindex="-1"></a><span class="kw">typedef</span> <span class="dt">unsigned</span> <span class="dt">long</span> EMACS_UINT<span class="op">;</span></span>
<span id="cb22-11"><a aria-hidden="true" href="#cb22-11" tabindex="-1"></a><span class="pp">#elif INTPTR_MAX &lt;= LLONG_MAX</span></span>
<span id="cb22-12"><a aria-hidden="true" href="#cb22-12" tabindex="-1"></a><span class="kw">typedef</span> <span class="dt">long</span> <span class="dt">long</span> <span class="dt">int</span> EMACS_INT<span class="op">;</span></span>
<span id="cb22-13"><a aria-hidden="true" href="#cb22-13" tabindex="-1"></a><span class="kw">typedef</span> <span class="dt">unsigned</span> <span class="dt">long</span> <span class="dt">long</span> <span class="dt">int</span> EMACS_UINT<span class="op">;</span></span>
<span id="cb22-14"><a aria-hidden="true" href="#cb22-14" tabindex="-1"></a><span class="pp">#else</span></span>
<span id="cb22-15"><a aria-hidden="true" href="#cb22-15" tabindex="-1"></a><span class="pp">#error "INTPTR_MAX too large"</span></span>
<span id="cb22-16"><a aria-hidden="true" href="#cb22-16" tabindex="-1"></a><span class="pp">#endif</span></span></code></pre></div>
<p>The integer type expands to match pointer size, ensuring buffers can
be as large as addressable memory allows.</p>
<h3 data-number="5.3.6" id="user-code-core-code"><span class="header-section-number">5.3.6</span> User Code = Core Code</h3>
<p>There‚Äôs no separate ‚Äúplugin API‚Äù with limited capabilities. Users
write code in the same language (Elisp), using the same primitives, with
the same access. From <code>/home/user/emacs/lisp/subr.el</code>:</p>
<pre class="elisp"><code>;; @file: lisp/subr.el
;; @description: Core Elisp utilities - indistinguishable from user code

(defun delete-dups (list)
  "Destructively remove `equal' duplicates from LIST.
Store the result in LIST and return it.  LIST must be a proper list.
Of several `equal' occurrences of an element in LIST, the first
one is kept."
  (let ((l (length list)))
    (if (&gt; l 100)
        (let ((hash (make-hash-table :test #'equal :size l))
              (tail list) retail)
          (while (setq retail (cdr tail))
            (if (gethash (car retail) hash)
                (setcdr tail (cdr retail))
              (puthash (car retail) t hash)
              (setq tail retail))))
      ;; For short lists, use the O(N^2) algorithm
      (let ((tail list))
        (while tail
          (setcdr tail (delete (car tail) (cdr tail)))
          (setq tail (cdr tail))))))
  list)</code></pre>
<p>This is from <code>subr.el</code>, part of Emacs core. But it‚Äôs
<strong>pure Elisp</strong>‚Äîa user could have written it. There‚Äôs no
magic C implementation, no special access. Core code and user code are
peers.</p>
<h3 data-number="5.3.7" id="why-this-matters-1"><span class="header-section-number">5.3.7</span> Why This Matters</h3>
<ol type="1">
<li><strong>Unlimited customization</strong>: If something bothers you,
change it</li>
<li><strong>Organic evolution</strong>: Good ideas migrate from user
configs to packages to core</li>
<li><strong>Long tail of features</strong>: Niche needs can be met
without bloating core</li>
<li><strong>Learning by doing</strong>: Reading core code teaches you
how to extend it</li>
<li><strong>Emergency repairs</strong>: Can work around bugs by advising
broken functions</li>
</ol>
<h3 data-number="5.3.8" id="the-cost-1"><span class="header-section-number">5.3.8</span> The Cost</h3>
<p>Complete extensibility means: - Hard to provide stability guarantees
(any function might be advised) - Security concerns (malicious code has
full access) - Debugging complexity (behavior depends on dynamic state)
- Performance overhead (indirection through function symbols)</p>
<p>But for a programmer‚Äôs editor, these costs are acceptable. The power
to modify anything is fundamental to the value proposition.</p>
<hr/>
<h2 data-number="5.4" id="backwards-compatibility"><span class="header-section-number">5.4</span> 3. Backwards Compatibility</h2>
<h3 data-number="5.4.1" id="the-philosophy-2"><span class="header-section-number">5.4.1</span> The Philosophy</h3>
<p>‚ÄúCode written for Emacs 18 should still work.‚Äù This is not quite true
(some things have been removed), but it‚Äôs aspirational. Emacs takes
backwards compatibility extremely seriously, maintaining decades-old
APIs to avoid breaking existing code.</p>
<h3 data-number="5.4.2" id="deprecation-strategies"><span class="header-section-number">5.4.2</span> Deprecation Strategies</h3>
<p>Emacs rarely removes features. Instead, it deprecates them
gradually:</p>
<pre class="elisp"><code>;; @file: lisp/emacs-lisp/nadvice.el
;; @lines: 87
;; @description: Marking old names as obsolete

(define-obsolete-function-alias 'advice--where #'advice--how "29.1")</code></pre>
<p>From <code>/home/user/emacs/lisp/frame.el</code>:</p>
<pre class="elisp"><code>;; @file: lisp/frame.el
;; @description: Backwards compatibility for renamed functions

(make-obsolete-variable
 'default-frame-alist
 "set the default in the `defcustom' for the frame parameter" "26.1")

(make-obsolete-variable
 'initial-frame-alist
 "set the default in the `defcustom' for the frame parameter" "26.1")</code></pre>
<p>The old names continue to work, but emit warnings when byte-compiled.
This gives users years (often decades) to migrate.</p>
<h3 data-number="5.4.3" id="how-new-features-are-added-without-breaking-old"><span class="header-section-number">5.4.3</span> How New Features Are Added
Without Breaking Old</h3>
<p>Consider the evolution of lexical binding. For 25+ years, Emacs used
dynamic scoping exclusively. Lexical scoping was added in Emacs 24
(2012), but <strong>dynamic scoping remains the default</strong> for
compatibility:</p>
<pre class="elisp"><code>;; @file: lisp/loadup.el
;; @lines: 1
;; @description: Files explicitly opt-in to lexical binding

;;; loadup.el --- load up always-loaded Lisp files for Emacs  -*- lexical-binding: t; -*-</code></pre>
<p>The <code>-*- lexical-binding: t; -*-</code> comment in the first
line opts this file into lexical scoping. Without it, dynamic scoping is
used. This allows old code to continue working unchanged.</p>
<h3 data-number="5.4.4" id="feature-detection-and-graceful-degradation"><span class="header-section-number">5.4.4</span> Feature Detection and
Graceful Degradation</h3>
<p>Code checks for features before using them, from
<code>/home/user/emacs/lisp/loadup.el</code>:</p>
<pre class="elisp"><code>;; @file: lisp/loadup.el
;; @description: Conditional loading based on available features

(if (featurep 'charprop)
    (load "international/charprop"))

(if (boundp 'x-toolkit-scroll-bars)
    (load "scroll-bar"))

(if (fboundp 'x-create-frame)
    (progn
      (load "international/fontset")
      (load "mouse")))

(if (featurep 'dynamic-setting)
    (load "dynamic-setting"))

(if (featurep 'x)
    (progn
      (load "x-dnd")
      (load "term/x-win")))

(if (featurep 'haiku)
    (load "term/haiku-win"))

(if (featurep 'android)
    (progn
      (load "term/android-win")
      (load "touch-screen")))</code></pre>
<p>Three predicates enable compatibility: - <code>featurep</code>: Check
if a feature is present - <code>fboundp</code>: Check if a function is
bound - <code>boundp</code>: Check if a variable is bound</p>
<h3 data-number="5.4.5" id="the-cost-of-compatibility"><span class="header-section-number">5.4.5</span> The Cost of
Compatibility</h3>
<p>Compatibility imposes real costs. From the ChangeLog, we see GCPRO
macros were used for decades to protect Lisp objects during C code
execution:</p>
<pre><code>;; @file: ChangeLog.2
;; @description: Removing GCPRO after 30+ years

Assume GC_MARK_STACK == GC_MAKE_GCPROS_NOOPS
This removes the need for GCPRO1 etc. Suggested by Stefan Monnier...</code></pre>
<p>GCPRO was needed for conservative garbage collection. Once precise GC
was reliable, GCPRO became unnecessary‚Äîbut it persisted for years
because removing it would break external C modules. Finally removed, but
only after ensuring the transition was safe.</p>
<h3 data-number="5.4.6" id="subr-compatibility"><span class="header-section-number">5.4.6</span> Subr Compatibility</h3>
<p>C primitives maintain compatibility even across major refactorings.
Old signatures continue to work:</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb29-1"><a aria-hidden="true" href="#cb29-1" tabindex="-1"></a><span class="co">// @file: src/buffer.c</span></span>
<span id="cb29-2"><a aria-hidden="true" href="#cb29-2" tabindex="-1"></a><span class="co">// @description: Primitives maintain compatibility</span></span>
<span id="cb29-3"><a aria-hidden="true" href="#cb29-3" tabindex="-1"></a></span>
<span id="cb29-4"><a aria-hidden="true" href="#cb29-4" tabindex="-1"></a><span class="co">/* Forward-compatibility: Emacs 21 took (buffer),</span></span>
<span id="cb29-5"><a aria-hidden="true" href="#cb29-5" tabindex="-1"></a><span class="co">   Emacs 22+ takes (buffer-or-name).</span></span>
<span id="cb29-6"><a aria-hidden="true" href="#cb29-6" tabindex="-1"></a><span class="co">   Both work. */</span></span>
<span id="cb29-7"><a aria-hidden="true" href="#cb29-7" tabindex="-1"></a>DEFUN <span class="op">(</span><span class="st">"get-buffer"</span><span class="op">,</span> Fget_buffer<span class="op">,</span> Sget_buffer<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb29-8"><a aria-hidden="true" href="#cb29-8" tabindex="-1"></a>       doc<span class="op">:</span> <span class="co">/* Return the buffer named BUFFER-OR-NAME... */</span><span class="op">)</span></span>
<span id="cb29-9"><a aria-hidden="true" href="#cb29-9" tabindex="-1"></a>  <span class="op">(</span><span class="dt">register</span> Lisp_Object buffer_or_name<span class="op">)</span></span>
<span id="cb29-10"><a aria-hidden="true" href="#cb29-10" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb29-11"><a aria-hidden="true" href="#cb29-11" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>BUFFERP <span class="op">(</span>buffer_or_name<span class="op">))</span></span>
<span id="cb29-12"><a aria-hidden="true" href="#cb29-12" tabindex="-1"></a>    <span class="cf">return</span> buffer_or_name<span class="op">;</span>  <span class="co">/* Already a buffer object */</span></span>
<span id="cb29-13"><a aria-hidden="true" href="#cb29-13" tabindex="-1"></a></span>
<span id="cb29-14"><a aria-hidden="true" href="#cb29-14" tabindex="-1"></a>  CHECK_STRING <span class="op">(</span>buffer_or_name<span class="op">);</span></span>
<span id="cb29-15"><a aria-hidden="true" href="#cb29-15" tabindex="-1"></a>  <span class="cf">return</span> Fcdr <span class="op">(</span>Fassoc <span class="op">(</span>buffer_or_name<span class="op">,</span> Vbuffer_alist<span class="op">,</span> Qnil<span class="op">));</span></span>
<span id="cb29-16"><a aria-hidden="true" href="#cb29-16" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 data-number="5.4.7" id="why-this-matters-2"><span class="header-section-number">5.4.7</span> Why This Matters</h3>
<ol type="1">
<li><strong>Long-term investment</strong>: Users can invest in Emacs
configurations knowing they‚Äôll keep working</li>
<li><strong>Ecosystem stability</strong>: Packages don‚Äôt break with
every release</li>
<li><strong>Migration flexibility</strong>: Users upgrade on their
schedule</li>
<li><strong>Trust</strong>: The community trusts Emacs won‚Äôt break their
workflows</li>
<li><strong>Accumulated knowledge</strong>: Old tutorials and books
remain relevant</li>
</ol>
<h3 data-number="5.4.8" id="the-trade-offs"><span class="header-section-number">5.4.8</span> The Trade-offs</h3>
<p>Backwards compatibility means: - Carrying dead code (obsolete
functions, deprecated APIs) - Complexity in implementation (multiple
code paths for old/new behavior) - Slower evolution (can‚Äôt just remove
bad designs) - Documentation burden (old and new ways both
documented)</p>
<p>But for a 40-year-old system still in active development, this is the
price of continuity.</p>
<hr/>
<h2 data-number="5.5" id="lisp-centric-design"><span class="header-section-number">5.5</span> 4. Lisp-Centric Design</h2>
<h3 data-number="5.5.1" id="the-philosophy-3"><span class="header-section-number">5.5.1</span> The Philosophy</h3>
<p>‚ÄúMinimal C core, maximum Elisp.‚Äù C provides speed and low-level
access; Elisp provides flexibility and introspection. The architecture
deliberately moves as much as possible into Elisp.</p>
<h3 data-number="5.5.2" id="the-division-of-labor"><span class="header-section-number">5.5.2</span> The Division of Labor</h3>
<p>From <code>/home/user/emacs/src/buffer.c</code>:</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb30-1"><a aria-hidden="true" href="#cb30-1" tabindex="-1"></a><span class="co">// @file: src/buffer.c</span></span>
<span id="cb30-2"><a aria-hidden="true" href="#cb30-2" tabindex="-1"></a><span class="co">// @lines: 0-99</span></span>
<span id="cb30-3"><a aria-hidden="true" href="#cb30-3" tabindex="-1"></a><span class="co">// @description: C handles low-level buffer manipulation</span></span>
<span id="cb30-4"><a aria-hidden="true" href="#cb30-4" tabindex="-1"></a></span>
<span id="cb30-5"><a aria-hidden="true" href="#cb30-5" tabindex="-1"></a><span class="co">/* Buffer manipulation primitives for GNU Emacs.</span></span>
<span id="cb30-6"><a aria-hidden="true" href="#cb30-6" tabindex="-1"></a></span>
<span id="cb30-7"><a aria-hidden="true" href="#cb30-7" tabindex="-1"></a><span class="co">   This file provides the low-level primitives for buffer manipulation:</span></span>
<span id="cb30-8"><a aria-hidden="true" href="#cb30-8" tabindex="-1"></a><span class="co">   - Creating and destroying buffers</span></span>
<span id="cb30-9"><a aria-hidden="true" href="#cb30-9" tabindex="-1"></a><span class="co">   - Gap buffer implementation</span></span>
<span id="cb30-10"><a aria-hidden="true" href="#cb30-10" tabindex="-1"></a><span class="co">   - Low-level insertion/deletion</span></span>
<span id="cb30-11"><a aria-hidden="true" href="#cb30-11" tabindex="-1"></a><span class="co">   - Character/byte position conversions</span></span>
<span id="cb30-12"><a aria-hidden="true" href="#cb30-12" tabindex="-1"></a></span>
<span id="cb30-13"><a aria-hidden="true" href="#cb30-13" tabindex="-1"></a><span class="co">   Higher-level operations are in Lisp. */</span></span></code></pre></div>
<p>Compare with <code>/home/user/emacs/lisp/files.el</code>, which
implements high-level file operations entirely in Elisp:</p>
<pre class="elisp"><code>;; @file: lisp/files.el
;; @description: High-level file operations in pure Elisp

(defun find-file (filename &amp;optional wildcards)
  "Edit file FILENAME.
Switch to a buffer visiting file FILENAME,
creating one if none already exists.
Interactively, the default if you just type RET is the current directory,
but the visited file name is available through the minibuffer history..."
  (interactive
   (find-file-read-args "Find file: "
                        (confirm-nonexistent-file-or-buffer)))
  (let ((value (find-file-noselect filename nil nil wildcards)))
    (if (listp value)
        (mapcar 'switch-to-buffer (nreverse value))
      (switch-to-buffer value))))</code></pre>
<p>The C primitive <code>insert-file-contents</code> does low-level
reading; <code>find-file</code> coordinates the user experience in
Lisp.</p>
<h3 data-number="5.5.3" id="why-lisp-for-extensibility"><span class="header-section-number">5.5.3</span> Why Lisp for
Extensibility</h3>
<p>From <code>/home/user/emacs/lisp/emacs-lisp/bytecomp.el</code>:</p>
<pre class="elisp"><code>;; @file: lisp/emacs-lisp/bytecomp.el
;; @lines: 26-32
;; @description: Commentary on the bytecode compiler

;;; Commentary:

;; The Emacs Lisp byte compiler.  This crunches Lisp source into a sort
;; of p-code (`lapcode') which takes up less space and can be interpreted
;; faster.  [`LAP' == `Lisp Assembly Program'.]
;; The user entry points are byte-compile-file and byte-recompile-directory.</code></pre>
<p>Lisp enables:</p>
<ol type="1">
<li><strong>Runtime introspection</strong>: Functions can examine their
own definitions</li>
<li><strong>Macro system</strong>: Code-generation at compile time</li>
<li><strong>First-class functions</strong>: Functions as data, closures,
partial application</li>
<li><strong>Garbage collection</strong>: Automatic memory
management</li>
<li><strong>Read-eval-print loop</strong>: Interactive development</li>
</ol>
<h3 data-number="5.5.4" id="the-lisp-2-namespace-decision"><span class="header-section-number">5.5.4</span> The Lisp-2 Namespace
Decision</h3>
<p>Emacs Lisp, like Common Lisp, is a ‚ÄúLisp-2‚Äù‚Äîseparate namespaces for
functions and variables:</p>
<pre class="elisp"><code>;; Function namespace
(defun list (x y z) (cons x (cons y (cons z nil))))

;; Variable namespace - same name, no conflict!
(let ((list '(1 2 3)))
  (length list))  ; Uses variable `list'

(list 1 2 3)  ; Uses function `list'</code></pre>
<p>This differs from Scheme (a ‚ÄúLisp-1‚Äù with unified namespace). The
choice enables: - Variables and functions with the same name (common:
<code>buffer</code>, <code>frame</code>, <code>window</code>) - Slightly
faster function calls (no need to check if binding is a function) -
Matches Common Lisp (easing transition for CL programmers)</p>
<h3 data-number="5.5.5" id="dynamic-vs-lexical-binding-evolution"><span class="header-section-number">5.5.5</span> Dynamic vs Lexical Binding
Evolution</h3>
<p>Originally, Emacs used only dynamic scoping:</p>
<pre class="elisp"><code>;; Dynamic scoping (pre-Emacs 24 or with lexical-binding: nil)
(setq x 10)

(defun get-x ()
  x)  ; Looks up `x' in dynamic environment

(let ((x 20))
  (get-x))  ; Returns 20 - sees caller's binding</code></pre>
<p>Emacs 24 added lexical scoping:</p>
<pre class="elisp"><code>;; -*- lexical-binding: t; -*-
;; Lexical scoping

(setq x 10)

(defun get-x ()
  x)  ; Lexically captured at definition time

(let ((x 20))
  (get-x))  ; Returns 10 - closed over global binding</code></pre>
<p>The transition was carefully managed: - Files opt-in with
<code>lexical-binding</code> cookie - Default remains dynamic for
compatibility - Byte-compiler warns about problematic dynamic bindings -
Native compilation benefits greatly from lexical scoping</p>
<h3 data-number="5.5.6" id="the-c-elisp-boundary"><span class="header-section-number">5.5.6</span> The C-Elisp Boundary</h3>
<p>The boundary is surprisingly permeable. From
<code>/home/user/emacs/src/lisp.h</code>:</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb36-1"><a aria-hidden="true" href="#cb36-1" tabindex="-1"></a><span class="co">// @file: src/lisp.h</span></span>
<span id="cb36-2"><a aria-hidden="true" href="#cb36-2" tabindex="-1"></a><span class="co">// @lines: 75-78</span></span>
<span id="cb36-3"><a aria-hidden="true" href="#cb36-3" tabindex="-1"></a><span class="co">// @description: Tagged pointer representation</span></span>
<span id="cb36-4"><a aria-hidden="true" href="#cb36-4" tabindex="-1"></a></span>
<span id="cb36-5"><a aria-hidden="true" href="#cb36-5" tabindex="-1"></a><span class="co">/* Number of bits in a Lisp_Object tag. */</span></span>
<span id="cb36-6"><a aria-hidden="true" href="#cb36-6" tabindex="-1"></a><span class="pp">#define GCTYPEBITS </span><span class="dv">3</span></span></code></pre></div>
<p>Lisp objects are tagged pointers‚Äîthe lowest 3 bits indicate type:</p>
<pre><code>000 - Symbol
001 - Fixnum (integer)
010 - String
011 - Vector
100 - Cons cell
101 - Float
110 - Compiled function
111 - Other...</code></pre>
<p>This enables C code to manipulate Lisp objects directly while
maintaining type safety through runtime checks.</p>
<h3 data-number="5.5.7" id="why-this-matters-3"><span class="header-section-number">5.5.7</span> Why This Matters</h3>
<ol type="1">
<li><strong>Performance where needed</strong>: Critical paths (text
insertion, display) are fast C</li>
<li><strong>Flexibility where wanted</strong>: User-facing behavior is
customizable Lisp</li>
<li><strong>Clear separation</strong>: C is for primitives, Lisp is for
policy</li>
<li><strong>Understandable</strong>: Can learn one layer at a time</li>
<li><strong>Evolvable</strong>: New features can be prototyped in Lisp,
moved to C if needed</li>
</ol>
<h3 data-number="5.5.8" id="the-trade-offs-1"><span class="header-section-number">5.5.8</span> The Trade-offs</h3>
<p>Lisp-centric design means: - Two languages to learn (C and Elisp) -
Impedance mismatch at boundary - Performance overhead for Lisp
interpretation - Memory overhead for garbage collection - Complexity in
maintaining the interpreter</p>
<p>But the architecture has proven remarkably durable, enabling
evolution while maintaining coherence.</p>
<hr/>
<h2 data-number="5.6" id="modularity-and-abstraction"><span class="header-section-number">5.6</span> 5. Modularity and
Abstraction</h2>
<h3 data-number="5.6.1" id="the-philosophy-4"><span class="header-section-number">5.6.1</span> The Philosophy</h3>
<p>‚ÄúSeparate concerns through clear abstractions.‚Äù Emacs achieves
modularity through careful layering: buffers are independent of windows,
windows independent of frames, frames independent of terminal types.
Backend implementations hide behind abstract interfaces.</p>
<h3 data-number="5.6.2" id="bufferwindowframe-separation"><span class="header-section-number">5.6.2</span> Buffer/Window/Frame
Separation</h3>
<p>These three concepts are often conflated in other editors, but Emacs
keeps them distinct:</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb38-1"><a aria-hidden="true" href="#cb38-1" tabindex="-1"></a><span class="co">// @file: src/buffer.h</span></span>
<span id="cb38-2"><a aria-hidden="true" href="#cb38-2" tabindex="-1"></a><span class="co">// @description: Buffers are independent of display</span></span>
<span id="cb38-3"><a aria-hidden="true" href="#cb38-3" tabindex="-1"></a></span>
<span id="cb38-4"><a aria-hidden="true" href="#cb38-4" tabindex="-1"></a><span class="kw">struct</span> buffer</span>
<span id="cb38-5"><a aria-hidden="true" href="#cb38-5" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb38-6"><a aria-hidden="true" href="#cb38-6" tabindex="-1"></a>  <span class="co">/* The actual text */</span></span>
<span id="cb38-7"><a aria-hidden="true" href="#cb38-7" tabindex="-1"></a>  <span class="kw">struct</span> buffer_text <span class="op">*</span>text<span class="op">;</span></span>
<span id="cb38-8"><a aria-hidden="true" href="#cb38-8" tabindex="-1"></a></span>
<span id="cb38-9"><a aria-hidden="true" href="#cb38-9" tabindex="-1"></a>  <span class="co">/* Position of point in this buffer */</span></span>
<span id="cb38-10"><a aria-hidden="true" href="#cb38-10" tabindex="-1"></a>  <span class="dt">ptrdiff_t</span> pt<span class="op">;</span></span>
<span id="cb38-11"><a aria-hidden="true" href="#cb38-11" tabindex="-1"></a></span>
<span id="cb38-12"><a aria-hidden="true" href="#cb38-12" tabindex="-1"></a>  <span class="co">/* No reference to windows! Buffers exist independently. */</span></span>
<span id="cb38-13"><a aria-hidden="true" href="#cb38-13" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<div class="sourceCode" id="cb39"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb39-1"><a aria-hidden="true" href="#cb39-1" tabindex="-1"></a><span class="co">// @file: src/window.h</span></span>
<span id="cb39-2"><a aria-hidden="true" href="#cb39-2" tabindex="-1"></a><span class="co">// @description: Windows display portions of buffers</span></span>
<span id="cb39-3"><a aria-hidden="true" href="#cb39-3" tabindex="-1"></a></span>
<span id="cb39-4"><a aria-hidden="true" href="#cb39-4" tabindex="-1"></a><span class="kw">struct</span> window</span>
<span id="cb39-5"><a aria-hidden="true" href="#cb39-5" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb39-6"><a aria-hidden="true" href="#cb39-6" tabindex="-1"></a>  <span class="co">/* The buffer displayed in this window */</span></span>
<span id="cb39-7"><a aria-hidden="true" href="#cb39-7" tabindex="-1"></a>  Lisp_Object contents<span class="op">;</span></span>
<span id="cb39-8"><a aria-hidden="true" href="#cb39-8" tabindex="-1"></a></span>
<span id="cb39-9"><a aria-hidden="true" href="#cb39-9" tabindex="-1"></a>  <span class="co">/* Start position of display in buffer */</span></span>
<span id="cb39-10"><a aria-hidden="true" href="#cb39-10" tabindex="-1"></a>  Lisp_Object start<span class="op">;</span></span>
<span id="cb39-11"><a aria-hidden="true" href="#cb39-11" tabindex="-1"></a></span>
<span id="cb39-12"><a aria-hidden="true" href="#cb39-12" tabindex="-1"></a>  <span class="co">/* Position of point when this window is selected */</span></span>
<span id="cb39-13"><a aria-hidden="true" href="#cb39-13" tabindex="-1"></a>  Lisp_Object pointm<span class="op">;</span></span>
<span id="cb39-14"><a aria-hidden="true" href="#cb39-14" tabindex="-1"></a></span>
<span id="cb39-15"><a aria-hidden="true" href="#cb39-15" tabindex="-1"></a>  <span class="co">/* Dimensions */</span></span>
<span id="cb39-16"><a aria-hidden="true" href="#cb39-16" tabindex="-1"></a>  Lisp_Object pixel_width<span class="op">;</span></span>
<span id="cb39-17"><a aria-hidden="true" href="#cb39-17" tabindex="-1"></a>  Lisp_Object pixel_height<span class="op">;</span></span>
<span id="cb39-18"><a aria-hidden="true" href="#cb39-18" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<div class="sourceCode" id="cb40"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb40-1"><a aria-hidden="true" href="#cb40-1" tabindex="-1"></a><span class="co">// @file: src/frame.h</span></span>
<span id="cb40-2"><a aria-hidden="true" href="#cb40-2" tabindex="-1"></a><span class="co">// @description: Frames contain window trees</span></span>
<span id="cb40-3"><a aria-hidden="true" href="#cb40-3" tabindex="-1"></a></span>
<span id="cb40-4"><a aria-hidden="true" href="#cb40-4" tabindex="-1"></a><span class="kw">struct</span> frame</span>
<span id="cb40-5"><a aria-hidden="true" href="#cb40-5" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb40-6"><a aria-hidden="true" href="#cb40-6" tabindex="-1"></a>  <span class="co">/* Root window of window tree */</span></span>
<span id="cb40-7"><a aria-hidden="true" href="#cb40-7" tabindex="-1"></a>  Lisp_Object root_window<span class="op">;</span></span>
<span id="cb40-8"><a aria-hidden="true" href="#cb40-8" tabindex="-1"></a></span>
<span id="cb40-9"><a aria-hidden="true" href="#cb40-9" tabindex="-1"></a>  <span class="co">/* Selected window (currently active) */</span></span>
<span id="cb40-10"><a aria-hidden="true" href="#cb40-10" tabindex="-1"></a>  Lisp_Object selected_window<span class="op">;</span></span>
<span id="cb40-11"><a aria-hidden="true" href="#cb40-11" tabindex="-1"></a></span>
<span id="cb40-12"><a aria-hidden="true" href="#cb40-12" tabindex="-1"></a>  <span class="co">/* Terminal this frame is displayed on */</span></span>
<span id="cb40-13"><a aria-hidden="true" href="#cb40-13" tabindex="-1"></a>  <span class="kw">struct</span> terminal <span class="op">*</span>terminal<span class="op">;</span></span>
<span id="cb40-14"><a aria-hidden="true" href="#cb40-14" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<p>This separation enables: - One buffer displayed in multiple windows -
Multiple buffers in one frame (split windows) - Buffers that exist
without being displayed - Uniform operations across display types</p>
<h3 data-number="5.6.3" id="backend-abstraction"><span class="header-section-number">5.6.3</span> Backend Abstraction</h3>
<p>Font backends illustrate the abstraction strategy. From
<code>/home/user/emacs/src/font.h</code>:</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb41-1"><a aria-hidden="true" href="#cb41-1" tabindex="-1"></a><span class="co">// @file: src/font.h</span></span>
<span id="cb41-2"><a aria-hidden="true" href="#cb41-2" tabindex="-1"></a><span class="co">// @lines: 34-61</span></span>
<span id="cb41-3"><a aria-hidden="true" href="#cb41-3" tabindex="-1"></a><span class="co">// @description: Abstract font object types</span></span>
<span id="cb41-4"><a aria-hidden="true" href="#cb41-4" tabindex="-1"></a></span>
<span id="cb41-5"><a aria-hidden="true" href="#cb41-5" tabindex="-1"></a><span class="co">/* We have three types of Lisp objects related to font.</span></span>
<span id="cb41-6"><a aria-hidden="true" href="#cb41-6" tabindex="-1"></a></span>
<span id="cb41-7"><a aria-hidden="true" href="#cb41-7" tabindex="-1"></a><span class="co">   FONT-SPEC</span></span>
<span id="cb41-8"><a aria-hidden="true" href="#cb41-8" tabindex="-1"></a><span class="co">       Pseudo vector of font properties. Some properties can be left</span></span>
<span id="cb41-9"><a aria-hidden="true" href="#cb41-9" tabindex="-1"></a><span class="co">       unspecified (i.e. nil). Emacs asks font-drivers to find a font</span></span>
<span id="cb41-10"><a aria-hidden="true" href="#cb41-10" tabindex="-1"></a><span class="co">       by FONT-SPEC.</span></span>
<span id="cb41-11"><a aria-hidden="true" href="#cb41-11" tabindex="-1"></a></span>
<span id="cb41-12"><a aria-hidden="true" href="#cb41-12" tabindex="-1"></a><span class="co">   FONT-ENTITY</span></span>
<span id="cb41-13"><a aria-hidden="true" href="#cb41-13" tabindex="-1"></a><span class="co">       Pseudo vector of fully instantiated font properties that a</span></span>
<span id="cb41-14"><a aria-hidden="true" href="#cb41-14" tabindex="-1"></a><span class="co">       font-driver returns upon a request of FONT-SPEC.</span></span>
<span id="cb41-15"><a aria-hidden="true" href="#cb41-15" tabindex="-1"></a></span>
<span id="cb41-16"><a aria-hidden="true" href="#cb41-16" tabindex="-1"></a><span class="co">       Note: Only the method `list' and `match' of a font-driver can</span></span>
<span id="cb41-17"><a aria-hidden="true" href="#cb41-17" tabindex="-1"></a><span class="co">       create this object, and it should never be modified by Lisp.</span></span>
<span id="cb41-18"><a aria-hidden="true" href="#cb41-18" tabindex="-1"></a></span>
<span id="cb41-19"><a aria-hidden="true" href="#cb41-19" tabindex="-1"></a><span class="co">   FONT-OBJECT</span></span>
<span id="cb41-20"><a aria-hidden="true" href="#cb41-20" tabindex="-1"></a><span class="co">       Pseudo vector of an opened font.</span></span>
<span id="cb41-21"><a aria-hidden="true" href="#cb41-21" tabindex="-1"></a></span>
<span id="cb41-22"><a aria-hidden="true" href="#cb41-22" tabindex="-1"></a><span class="co">       Lisp object encapsulating "struct font". This corresponds to</span></span>
<span id="cb41-23"><a aria-hidden="true" href="#cb41-23" tabindex="-1"></a><span class="co">       an opened font.</span></span>
<span id="cb41-24"><a aria-hidden="true" href="#cb41-24" tabindex="-1"></a></span>
<span id="cb41-25"><a aria-hidden="true" href="#cb41-25" tabindex="-1"></a><span class="co">       Note: Only the method `open_font' of a font-driver can create</span></span>
<span id="cb41-26"><a aria-hidden="true" href="#cb41-26" tabindex="-1"></a><span class="co">       this object, and it should never be modified by Lisp. */</span></span></code></pre></div>
<p>Different platforms provide different font backends: -
<strong>X11</strong>: <code>x</code>, <code>xft</code>,
<code>xfthb</code> - <strong>Windows</strong>: <code>harfbuzz</code>,
<code>uniscribe</code>, <code>gdi</code> - <strong>macOS</strong>:
<code>ns</code> - <strong>Android</strong>: <code>sfnt</code>,
<code>sfntfont-android</code></p>
<p>All implement the same abstract interface:</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb42-1"><a aria-hidden="true" href="#cb42-1" tabindex="-1"></a><span class="co">// @file: src/font.h</span></span>
<span id="cb42-2"><a aria-hidden="true" href="#cb42-2" tabindex="-1"></a><span class="co">// @description: Font driver methods</span></span>
<span id="cb42-3"><a aria-hidden="true" href="#cb42-3" tabindex="-1"></a></span>
<span id="cb42-4"><a aria-hidden="true" href="#cb42-4" tabindex="-1"></a><span class="kw">struct</span> font_driver</span>
<span id="cb42-5"><a aria-hidden="true" href="#cb42-5" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb42-6"><a aria-hidden="true" href="#cb42-6" tabindex="-1"></a>  <span class="co">/* List available fonts matching FONT_SPEC */</span></span>
<span id="cb42-7"><a aria-hidden="true" href="#cb42-7" tabindex="-1"></a>  Lisp_Object <span class="op">(*</span>list<span class="op">)</span> <span class="op">(</span><span class="kw">struct</span> frame <span class="op">*</span>f<span class="op">,</span> Lisp_Object font_spec<span class="op">);</span></span>
<span id="cb42-8"><a aria-hidden="true" href="#cb42-8" tabindex="-1"></a></span>
<span id="cb42-9"><a aria-hidden="true" href="#cb42-9" tabindex="-1"></a>  <span class="co">/* Get font matching FONT_SPEC most closely */</span></span>
<span id="cb42-10"><a aria-hidden="true" href="#cb42-10" tabindex="-1"></a>  Lisp_Object <span class="op">(*</span>match<span class="op">)</span> <span class="op">(</span><span class="kw">struct</span> frame <span class="op">*</span>f<span class="op">,</span> Lisp_Object font_spec<span class="op">);</span></span>
<span id="cb42-11"><a aria-hidden="true" href="#cb42-11" tabindex="-1"></a></span>
<span id="cb42-12"><a aria-hidden="true" href="#cb42-12" tabindex="-1"></a>  <span class="co">/* Open font and return font object */</span></span>
<span id="cb42-13"><a aria-hidden="true" href="#cb42-13" tabindex="-1"></a>  Lisp_Object <span class="op">(*</span>open_font<span class="op">)</span> <span class="op">(</span><span class="kw">struct</span> frame <span class="op">*</span>f<span class="op">,</span> Lisp_Object font_entity<span class="op">,</span></span>
<span id="cb42-14"><a aria-hidden="true" href="#cb42-14" tabindex="-1"></a>                            <span class="dt">int</span> pixel_size<span class="op">);</span></span>
<span id="cb42-15"><a aria-hidden="true" href="#cb42-15" tabindex="-1"></a></span>
<span id="cb42-16"><a aria-hidden="true" href="#cb42-16" tabindex="-1"></a>  <span class="co">/* Close font */</span></span>
<span id="cb42-17"><a aria-hidden="true" href="#cb42-17" tabindex="-1"></a>  <span class="dt">void</span> <span class="op">(*</span>close_font<span class="op">)</span> <span class="op">(</span><span class="kw">struct</span> font <span class="op">*</span>font<span class="op">);</span></span>
<span id="cb42-18"><a aria-hidden="true" href="#cb42-18" tabindex="-1"></a></span>
<span id="cb42-19"><a aria-hidden="true" href="#cb42-19" tabindex="-1"></a>  <span class="co">/* More methods... */</span></span>
<span id="cb42-20"><a aria-hidden="true" href="#cb42-20" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<p>The abstraction allows adding new font backends (HarfBuzz was added
recently) without changing high-level code.</p>
<h3 data-number="5.6.4" id="terminal-abstraction"><span class="header-section-number">5.6.4</span> Terminal Abstraction</h3>
<p>Display terminals are abstracted through a method table:</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb43-1"><a aria-hidden="true" href="#cb43-1" tabindex="-1"></a><span class="co">// @file: src/termhooks.h</span></span>
<span id="cb43-2"><a aria-hidden="true" href="#cb43-2" tabindex="-1"></a><span class="co">// @description: Terminal method abstraction</span></span>
<span id="cb43-3"><a aria-hidden="true" href="#cb43-3" tabindex="-1"></a></span>
<span id="cb43-4"><a aria-hidden="true" href="#cb43-4" tabindex="-1"></a><span class="kw">struct</span> terminal</span>
<span id="cb43-5"><a aria-hidden="true" href="#cb43-5" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb43-6"><a aria-hidden="true" href="#cb43-6" tabindex="-1"></a>  <span class="co">/* Clear frame to background color */</span></span>
<span id="cb43-7"><a aria-hidden="true" href="#cb43-7" tabindex="-1"></a>  <span class="dt">void</span> <span class="op">(*</span>clear_frame_hook<span class="op">)</span> <span class="op">(</span><span class="kw">struct</span> frame <span class="op">*);</span></span>
<span id="cb43-8"><a aria-hidden="true" href="#cb43-8" tabindex="-1"></a></span>
<span id="cb43-9"><a aria-hidden="true" href="#cb43-9" tabindex="-1"></a>  <span class="co">/* Clear from cursor to end of line */</span></span>
<span id="cb43-10"><a aria-hidden="true" href="#cb43-10" tabindex="-1"></a>  <span class="dt">void</span> <span class="op">(*</span>clear_end_of_line_hook<span class="op">)</span> <span class="op">(</span><span class="kw">struct</span> frame <span class="op">*,</span> <span class="dt">int</span><span class="op">);</span></span>
<span id="cb43-11"><a aria-hidden="true" href="#cb43-11" tabindex="-1"></a></span>
<span id="cb43-12"><a aria-hidden="true" href="#cb43-12" tabindex="-1"></a>  <span class="co">/* Move cursor to row, column */</span></span>
<span id="cb43-13"><a aria-hidden="true" href="#cb43-13" tabindex="-1"></a>  <span class="dt">void</span> <span class="op">(*</span>cursor_to_hook<span class="op">)</span> <span class="op">(</span><span class="kw">struct</span> frame <span class="op">*,</span> <span class="dt">int</span><span class="op">,</span> <span class="dt">int</span><span class="op">);</span></span>
<span id="cb43-14"><a aria-hidden="true" href="#cb43-14" tabindex="-1"></a></span>
<span id="cb43-15"><a aria-hidden="true" href="#cb43-15" tabindex="-1"></a>  <span class="co">/* Write glyphs to display */</span></span>
<span id="cb43-16"><a aria-hidden="true" href="#cb43-16" tabindex="-1"></a>  <span class="dt">void</span> <span class="op">(*</span>write_glyphs_hook<span class="op">)</span> <span class="op">(</span><span class="kw">struct</span> frame <span class="op">*,</span> <span class="kw">struct</span> glyph <span class="op">*,</span> <span class="dt">int</span><span class="op">);</span></span>
<span id="cb43-17"><a aria-hidden="true" href="#cb43-17" tabindex="-1"></a></span>
<span id="cb43-18"><a aria-hidden="true" href="#cb43-18" tabindex="-1"></a>  <span class="co">/* Platform-specific methods */</span></span>
<span id="cb43-19"><a aria-hidden="true" href="#cb43-19" tabindex="-1"></a>  <span class="kw">struct</span> terminal_specific <span class="op">*</span>specific<span class="op">;</span></span>
<span id="cb43-20"><a aria-hidden="true" href="#cb43-20" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<p>Different terminal types: - <strong>X11</strong>:
<code>/home/user/emacs/src/xterm.c</code> - <strong>Windows</strong>:
<code>/home/user/emacs/src/w32term.c</code> - <strong>macOS</strong>:
<code>/home/user/emacs/src/nsterm.m</code> - <strong>Android</strong>:
<code>/home/user/emacs/src/androidterm.c</code> - <strong>TTY</strong>:
<code>/home/user/emacs/src/term.c</code></p>
<p>All implement the same interface, allowing the display engine
(<code>xdisp.c</code>) to be platform-agnostic.</p>
<h3 data-number="5.6.5" id="mode-system"><span class="header-section-number">5.6.5</span> Mode System</h3>
<p>Major and minor modes provide modularity for buffer behavior:</p>
<pre class="elisp"><code>;; @file: lisp/emacs-lisp/lisp-mode.el
;; @description: Major modes compose behavior through inheritance

(define-derived-mode emacs-lisp-mode lisp-data-mode "Elisp"
  "Major mode for editing Emacs Lisp code.
Commands:
\\{emacs-lisp-mode-map}"
  :group 'lisp
  (lisp-mode-variables nil nil 'elisp)
  (add-hook 'after-load-functions #'elisp--font-lock-flush-elisp-buffers)
  (setq-local electric-pair-text-pairs
              (cons '(?\` . ?\') electric-pair-text-pairs)))</code></pre>
<p>This inherits from <code>lisp-data-mode</code>, which inherits from
<code>prog-mode</code>, which inherits from
<code>fundamental-mode</code>. Each layer adds behavior without
duplicating code.</p>
<p>Minor modes add orthogonal features:</p>
<pre class="elisp"><code>(define-minor-mode line-number-mode
  "Toggle display of line number in mode line."
  :global t
  :group 'mode-line)

(define-minor-mode auto-fill-mode
  "Toggle automatic line breaking."
  :lighter " Fill"
  :group 'fill)</code></pre>
<p>Multiple minor modes can be active simultaneously, composing
behavior.</p>
<h3 data-number="5.6.6" id="package-system"><span class="header-section-number">5.6.6</span> Package System</h3>
<p>The package system
(<code>/home/user/emacs/lisp/emacs-lisp/package.el</code>) provides
modularity for distributions:</p>
<pre class="elisp"><code>;; @file: lisp/emacs-lisp/package.el
;; @description: Package metadata and dependencies

(defstruct (package-desc
            (:constructor package-desc-create)
            (:type vector))
  "Structure describing a package."
  name                ; Symbol
  version             ; Version-list
  summary             ; One-line description
  reqs                ; List of (PACKAGE VERSION-LIST) dependencies
  kind                ; Symbol: 'single or 'tar
  archive             ; String: archive name
  dir                 ; String: package directory
  extras              ; Alist of additional properties
  signed)             ; Boolean: package signature verified</code></pre>
<p>Dependencies are explicit, allowing clean separation and controlled
loading.</p>
<h3 data-number="5.6.7" id="why-this-matters-4"><span class="header-section-number">5.6.7</span> Why This Matters</h3>
<ol type="1">
<li><strong>Understandability</strong>: Can learn one component without
understanding all</li>
<li><strong>Maintainability</strong>: Changes isolated to affected
components</li>
<li><strong>Testability</strong>: Components testable in isolation</li>
<li><strong>Portability</strong>: New platforms need only implement
terminal interface</li>
<li><strong>Extensibility</strong>: New backends (fonts, terminals) fit
cleanly into framework</li>
</ol>
<h3 data-number="5.6.8" id="the-cost-2"><span class="header-section-number">5.6.8</span> The Cost</h3>
<p>Abstraction layers impose: - Indirection overhead (function pointers,
method dispatch) - Increased complexity (more files, more concepts) -
Learning curve (must understand the abstractions) - Potential
inefficiency (abstraction prevents optimization across layers)</p>
<p>But for a system of Emacs‚Äôs scale, the organizational benefits far
outweigh the costs.</p>
<hr/>
<h2 data-number="5.7" id="progressive-enhancement"><span class="header-section-number">5.7</span> 6. Progressive Enhancement</h2>
<h3 data-number="5.7.1" id="the-philosophy-5"><span class="header-section-number">5.7.1</span> The Philosophy</h3>
<p>‚ÄúDegrade gracefully when features are unavailable.‚Äù Emacs runs on
everything from headless servers to high-DPI displays, from 1980s
terminals to modern Android tablets. It adapts to available capabilities
rather than requiring specific features.</p>
<h3 data-number="5.7.2" id="feature-detection"><span class="header-section-number">5.7.2</span> Feature Detection</h3>
<p>From <code>/home/user/emacs/lisp/loadup.el</code>, the bootstrap
process conditionally loads based on available features:</p>
<pre class="elisp"><code>;; @file: lisp/loadup.el
;; @description: Progressive enhancement through feature detection

;; Load character properties if available
(if (featurep 'charprop)
    (load "international/charprop"))

;; Load X window system support if available
(if (featurep 'x)
    (progn
      (load "x-dnd")           ; Drag and drop
      (load "term/x-win")))    ; X-specific setup

;; Load GTK+ integration if available
(if (featurep 'pgtk)
    (load "term/pgtk-win"))

;; Load Windows support if available
(if (or (eq system-type 'ms-dos)
        (eq system-type 'windows-nt)
        (featurep 'w32))
    (progn
      (load "term/w32-win")
      (load "w32-vars")))

;; Load macOS support if available
(if (featurep 'ns)
    (load "term/ns-win"))

;; Load Haiku support if available
(if (featurep 'haiku)
    (load "term/haiku-win"))

;; Load Android support if available
(if (featurep 'android)
    (progn
      (load "term/android-win")
      (load "touch-screen")))</code></pre>
<p>Each platform provides only what it can support. The core gracefully
adapts.</p>
<h3 data-number="5.7.3" id="graceful-degradation-in-display"><span class="header-section-number">5.7.3</span> Graceful Degradation in
Display</h3>
<p>The display engine adapts to terminal capabilities:</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb48-1"><a aria-hidden="true" href="#cb48-1" tabindex="-1"></a><span class="co">// @file: src/xdisp.c</span></span>
<span id="cb48-2"><a aria-hidden="true" href="#cb48-2" tabindex="-1"></a><span class="co">// @description: Display adapts to terminal capabilities</span></span>
<span id="cb48-3"><a aria-hidden="true" href="#cb48-3" tabindex="-1"></a></span>
<span id="cb48-4"><a aria-hidden="true" href="#cb48-4" tabindex="-1"></a><span class="co">/* Try to display image at position.</span></span>
<span id="cb48-5"><a aria-hidden="true" href="#cb48-5" tabindex="-1"></a><span class="co">   If terminal doesn't support images, display alternative text instead. */</span></span>
<span id="cb48-6"><a aria-hidden="true" href="#cb48-6" tabindex="-1"></a><span class="cf">if</span> <span class="op">(</span>TERMINAL_HAS_IMAGE_SUPPORT <span class="op">(</span>terminal<span class="op">))</span></span>
<span id="cb48-7"><a aria-hidden="true" href="#cb48-7" tabindex="-1"></a>  display_image <span class="op">(</span>image_spec<span class="op">);</span></span>
<span id="cb48-8"><a aria-hidden="true" href="#cb48-8" tabindex="-1"></a><span class="cf">else</span></span>
<span id="cb48-9"><a aria-hidden="true" href="#cb48-9" tabindex="-1"></a>  display_string <span class="op">(</span>ALTERNATIVE_TEXT <span class="op">(</span>image_spec<span class="op">));</span></span></code></pre></div>
<p>On a TTY: - Images become <code>[IMAGE]</code> markers - Multiple
fonts become ASCII approximations - Mouse hover becomes keyboard
navigation - Colors map to closest ANSI colors</p>
<p>But the <strong>same code</strong> runs on both graphical and text
terminals.</p>
<h3 data-number="5.7.4" id="platform-differences"><span class="header-section-number">5.7.4</span> Platform Differences</h3>
<p>Conditional compilation handles platform-specific code:</p>
<div class="sourceCode" id="cb49"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb49-1"><a aria-hidden="true" href="#cb49-1" tabindex="-1"></a><span class="co">// @file: src/dispnew.c</span></span>
<span id="cb49-2"><a aria-hidden="true" href="#cb49-2" tabindex="-1"></a><span class="co">// @description: Platform-specific includes</span></span>
<span id="cb49-3"><a aria-hidden="true" href="#cb49-3" tabindex="-1"></a></span>
<span id="cb49-4"><a aria-hidden="true" href="#cb49-4" tabindex="-1"></a><span class="pp">#ifdef HAVE_WINDOW_SYSTEM</span></span>
<span id="cb49-5"><a aria-hidden="true" href="#cb49-5" tabindex="-1"></a><span class="pp">#include TERM_HEADER  </span><span class="co">/* Platform-specific: xterm.h, w32term.h, nsterm.h */</span></span>
<span id="cb49-6"><a aria-hidden="true" href="#cb49-6" tabindex="-1"></a><span class="pp">#endif</span></span>
<span id="cb49-7"><a aria-hidden="true" href="#cb49-7" tabindex="-1"></a></span>
<span id="cb49-8"><a aria-hidden="true" href="#cb49-8" tabindex="-1"></a><span class="pp">#ifdef HAVE_ANDROID</span></span>
<span id="cb49-9"><a aria-hidden="true" href="#cb49-9" tabindex="-1"></a><span class="pp">#include </span><span class="im">"android.h"</span></span>
<span id="cb49-10"><a aria-hidden="true" href="#cb49-10" tabindex="-1"></a><span class="pp">#endif</span></span>
<span id="cb49-11"><a aria-hidden="true" href="#cb49-11" tabindex="-1"></a></span>
<span id="cb49-12"><a aria-hidden="true" href="#cb49-12" tabindex="-1"></a><span class="pp">#ifdef WINDOWSNT</span></span>
<span id="cb49-13"><a aria-hidden="true" href="#cb49-13" tabindex="-1"></a><span class="pp">#include </span><span class="im">"w32.h"</span></span>
<span id="cb49-14"><a aria-hidden="true" href="#cb49-14" tabindex="-1"></a><span class="pp">#endif</span></span></code></pre></div>
<p>The build system (<code>configure.ac</code>) detects available
features and sets appropriate flags.</p>
<h3 data-number="5.7.5" id="optional-dependencies"><span class="header-section-number">5.7.5</span> Optional Dependencies</h3>
<p>Features degrade when dependencies are missing:</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb50-1"><a aria-hidden="true" href="#cb50-1" tabindex="-1"></a><span class="co">// @file: src/buffer.c</span></span>
<span id="cb50-2"><a aria-hidden="true" href="#cb50-2" tabindex="-1"></a><span class="co">// @description: Tree-sitter is optional</span></span>
<span id="cb50-3"><a aria-hidden="true" href="#cb50-3" tabindex="-1"></a></span>
<span id="cb50-4"><a aria-hidden="true" href="#cb50-4" tabindex="-1"></a><span class="pp">#ifdef HAVE_TREE_SITTER</span></span>
<span id="cb50-5"><a aria-hidden="true" href="#cb50-5" tabindex="-1"></a>  <span class="co">/* Enable tree-sitter tracking if available */</span></span>
<span id="cb50-6"><a aria-hidden="true" href="#cb50-6" tabindex="-1"></a>  SET_BUF_TS_LINECOL_BEGV <span class="op">(</span>b<span class="op">,</span> TREESIT_EMPTY_LINECOL<span class="op">);</span></span>
<span id="cb50-7"><a aria-hidden="true" href="#cb50-7" tabindex="-1"></a>  SET_BUF_TS_LINECOL_POINT <span class="op">(</span>b<span class="op">,</span> TREESIT_EMPTY_LINECOL<span class="op">);</span></span>
<span id="cb50-8"><a aria-hidden="true" href="#cb50-8" tabindex="-1"></a>  SET_BUF_TS_LINECOL_ZV <span class="op">(</span>b<span class="op">,</span> TREESIT_EMPTY_LINECOL<span class="op">);</span></span>
<span id="cb50-9"><a aria-hidden="true" href="#cb50-9" tabindex="-1"></a><span class="pp">#endif</span></span></code></pre></div>
<p>If tree-sitter isn‚Äôt available at compile time, modes fall back to
regex-based parsing. The editor still works, just with fewer
features.</p>
<h3 data-number="5.7.6" id="runtime-feature-checks"><span class="header-section-number">5.7.6</span> Runtime Feature Checks</h3>
<p>Code checks capabilities before using them:</p>
<pre class="elisp"><code>;; @file: lisp/hilit-chg.el
;; @description: Check for grayscale display support

(and (fboundp 'x-display-grayscale-p)
     (x-display-grayscale-p))</code></pre>
<p>The <code>fboundp</code> check ensures the function exists before
calling it.</p>
<h3 data-number="5.7.7" id="capability-based-enhancement"><span class="header-section-number">5.7.7</span> Capability-Based
Enhancement</h3>
<p>Rather than failing when features are missing, Emacs enhances when
features are <strong>present</strong>:</p>
<pre class="elisp"><code>;; From display-time.el
(when (display-graphic-p)
  ;; Use graphical clock icon
  (setq display-time-string-forms
        '((propertize (format-time-string "%H:%M")
                      'display '(image :type xpm :file "clock.xpm")))))

(unless (display-graphic-p)
  ;; Use text-based clock
  (setq display-time-string-forms
        '((format-time-string "%H:%M"))))</code></pre>
<h3 data-number="5.7.8" id="why-this-matters-5"><span class="header-section-number">5.7.8</span> Why This Matters</h3>
<ol type="1">
<li><strong>Universality</strong>: Runs everywhere from $5 VPS to
high-end workstations</li>
<li><strong>Accessibility</strong>: Works without specialized
hardware</li>
<li><strong>Resilience</strong>: Continues functioning even with limited
capabilities</li>
<li><strong>Future-proof</strong>: New features don‚Äôt break old
platforms</li>
<li><strong>Testing</strong>: Can test on minimal systems</li>
</ol>
<h3 data-number="5.7.9" id="the-cost-3"><span class="header-section-number">5.7.9</span> The Cost</h3>
<p>Progressive enhancement requires: - Testing on multiple platforms -
Maintaining fallback code paths - Complexity from conditional code -
Documentation of feature dependencies - Conservative feature adoption
(can‚Äôt require cutting-edge features)</p>
<p>But this discipline is what allows Emacs to run on 7+ platforms
spanning 40 years of computing history.</p>
<hr/>
<h2 data-number="5.8" id="performance-vs-flexibility"><span class="header-section-number">5.8</span> 7. Performance vs
Flexibility</h2>
<h3 data-number="5.8.1" id="the-philosophy-6"><span class="header-section-number">5.8.1</span> The Philosophy</h3>
<p>‚ÄúOptimize the common case, but keep flexibility.‚Äù Emacs prioritizes
flexibility, but optimizes aggressively where it matters. The strategy
is: make it work, make it right, then make it fast‚Äîbut only where
profiling shows it matters.</p>
<h3 data-number="5.8.2" id="when-to-optimize"><span class="header-section-number">5.8.2</span> When to Optimize</h3>
<p>The redisplay engine is heavily optimized because it runs on every
keystroke. From <code>/home/user/emacs/src/xdisp.c</code>:</p>
<div class="sourceCode" id="cb53"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb53-1"><a aria-hidden="true" href="#cb53-1" tabindex="-1"></a><span class="co">// @file: src/xdisp.c</span></span>
<span id="cb53-2"><a aria-hidden="true" href="#cb53-2" tabindex="-1"></a><span class="co">// @lines: 19-99</span></span>
<span id="cb53-3"><a aria-hidden="true" href="#cb53-3" tabindex="-1"></a><span class="co">// @description: Extensive comment explaining redisplay optimization</span></span>
<span id="cb53-4"><a aria-hidden="true" href="#cb53-4" tabindex="-1"></a></span>
<span id="cb53-5"><a aria-hidden="true" href="#cb53-5" tabindex="-1"></a><span class="co">/* New redisplay written by Gerd Moellmann &lt;gerd@gnu.org&gt;.</span></span>
<span id="cb53-6"><a aria-hidden="true" href="#cb53-6" tabindex="-1"></a></span>
<span id="cb53-7"><a aria-hidden="true" href="#cb53-7" tabindex="-1"></a><span class="co">   Redisplay.</span></span>
<span id="cb53-8"><a aria-hidden="true" href="#cb53-8" tabindex="-1"></a></span>
<span id="cb53-9"><a aria-hidden="true" href="#cb53-9" tabindex="-1"></a><span class="co">   Emacs separates the task of updating the display -- which we call</span></span>
<span id="cb53-10"><a aria-hidden="true" href="#cb53-10" tabindex="-1"></a><span class="co">   "redisplay" -- from the code modifying global state, e.g. buffer</span></span>
<span id="cb53-11"><a aria-hidden="true" href="#cb53-11" tabindex="-1"></a><span class="co">   text.  This way functions operating on buffers don't also have to</span></span>
<span id="cb53-12"><a aria-hidden="true" href="#cb53-12" tabindex="-1"></a><span class="co">   be concerned with updating the display as result of their operations.</span></span>
<span id="cb53-13"><a aria-hidden="true" href="#cb53-13" tabindex="-1"></a></span>
<span id="cb53-14"><a aria-hidden="true" href="#cb53-14" tabindex="-1"></a><span class="co">   At its highest level, redisplay can be divided into 3 distinct steps:</span></span>
<span id="cb53-15"><a aria-hidden="true" href="#cb53-15" tabindex="-1"></a></span>
<span id="cb53-16"><a aria-hidden="true" href="#cb53-16" tabindex="-1"></a><span class="co">   1. decide which frames need their windows to be considered for redisplay</span></span>
<span id="cb53-17"><a aria-hidden="true" href="#cb53-17" tabindex="-1"></a><span class="co">   2. for each window whose display might need to be updated, compute</span></span>
<span id="cb53-18"><a aria-hidden="true" href="#cb53-18" tabindex="-1"></a><span class="co">      a structure, called "glyph matrix", which describes how it</span></span>
<span id="cb53-19"><a aria-hidden="true" href="#cb53-19" tabindex="-1"></a><span class="co">      should look on display</span></span>
<span id="cb53-20"><a aria-hidden="true" href="#cb53-20" tabindex="-1"></a><span class="co">   3. actually update the display of windows on the glass where the</span></span>
<span id="cb53-21"><a aria-hidden="true" href="#cb53-21" tabindex="-1"></a><span class="co">      newly obtained glyph matrix differs from the one produced by the</span></span>
<span id="cb53-22"><a aria-hidden="true" href="#cb53-22" tabindex="-1"></a><span class="co">      previous redisplay cycle</span></span>
<span id="cb53-23"><a aria-hidden="true" href="#cb53-23" tabindex="-1"></a></span>
<span id="cb53-24"><a aria-hidden="true" href="#cb53-24" tabindex="-1"></a><span class="co">   The function which considers a window and decides whether it actually</span></span>
<span id="cb53-25"><a aria-hidden="true" href="#cb53-25" tabindex="-1"></a><span class="co">   needs redisplay is `redisplay_window'.  It does so by looking at the</span></span>
<span id="cb53-26"><a aria-hidden="true" href="#cb53-26" tabindex="-1"></a><span class="co">   changes in position of point, in buffer text, in text properties,</span></span>
<span id="cb53-27"><a aria-hidden="true" href="#cb53-27" tabindex="-1"></a><span class="co">   overlays, and faces since last redisplay...</span></span>
<span id="cb53-28"><a aria-hidden="true" href="#cb53-28" tabindex="-1"></a></span>
<span id="cb53-29"><a aria-hidden="true" href="#cb53-29" tabindex="-1"></a><span class="co">   Optimizations are everywhere:</span></span>
<span id="cb53-30"><a aria-hidden="true" href="#cb53-30" tabindex="-1"></a><span class="co">   - Try to avoid complete redisplay (only redisplay changed portions)</span></span>
<span id="cb53-31"><a aria-hidden="true" href="#cb53-31" tabindex="-1"></a><span class="co">   - Reuse existing glyph matrices when possible</span></span>
<span id="cb53-32"><a aria-hidden="true" href="#cb53-32" tabindex="-1"></a><span class="co">   - Avoid recomputing what can be cached</span></span>
<span id="cb53-33"><a aria-hidden="true" href="#cb53-33" tabindex="-1"></a><span class="co">   - Fast path for simple cases (single line insert, etc.)</span></span>
<span id="cb53-34"><a aria-hidden="true" href="#cb53-34" tabindex="-1"></a><span class="co">*/</span></span></code></pre></div>
<p>The entire 25,000-line <code>xdisp.c</code> file is an optimization
masterpiece, with fast paths for common cases and fallbacks for complex
scenarios.</p>
<h3 data-number="5.8.3" id="bytecode-compilation"><span class="header-section-number">5.8.3</span> Bytecode Compilation</h3>
<p>Elisp can be interpreted, but is usually byte-compiled for
performance. From
<code>/home/user/emacs/lisp/emacs-lisp/bytecomp.el</code>:</p>
<pre class="elisp"><code>;; @file: lisp/emacs-lisp/bytecomp.el
;; @lines: 49-72
;; @description: Bytecode optimizations

;; This version of the byte compiler has the following improvements:
;;  + optimization of compiled code:
;;    - removal of unreachable code;
;;    - removal of calls to side-effectless functions whose return-value
;;      is unused;
;;    - compile-time evaluation of safe constant forms, such as (consp nil)
;;      and (ash 1 6);
;;    - open-coding of literal lambdas;
;;    - peephole optimization of emitted code;
;;    - trivial functions are left uncompiled for speed.
;;  + support for inline functions;
;;  + compile-time evaluation of arbitrary expressions;
;;  + compile-time warning messages for:
;;    - functions being redefined with incompatible arglists;
;;    - functions being redefined as macros, or vice-versa;
;;    - functions or macros defined multiple times in the same file;
;;    - functions being called with the incorrect number of arguments;
;;    - functions being called which are not defined globally, in the
;;      file, or as autoloads;
;;    - assignment and reference of undeclared free variables;
;;    - various syntax errors;</code></pre>
<p>Bytecode provides 5-10x speedup over interpretation while maintaining
flexibility (can still redefine functions at runtime).</p>
<h3 data-number="5.8.4" id="native-compilation-2"><span class="header-section-number">5.8.4</span> Native Compilation</h3>
<p>Emacs 28 added native compilation via libgccjit, providing another
2-5x speedup:</p>
<pre class="elisp"><code>;; Before native compilation:
(defun fibonacci (n)
  (if (&lt;= n 1)
      n
    (+ (fibonacci (- n 1))
       (fibonacci (- n 2)))))

;; Benchmark: (fibonacci 30)
;; Interpreted: ~30 seconds
;; Bytecode:    ~3 seconds  (10x faster)
;; Native:      ~0.6 seconds (50x faster than interpreted)</code></pre>
<p>Native compilation happens <strong>asynchronously</strong> in the
background, so startup isn‚Äôt delayed.</p>
<h3 data-number="5.8.5" id="lazy-loading"><span class="header-section-number">5.8.5</span> Lazy Loading</h3>
<p>Features load on demand rather than at startup. From
<code>/home/user/emacs/lisp/loadup.el</code>:</p>
<pre class="elisp"><code>;; Core functions loaded immediately
(load "subr")
(load "files")
(load "simple")

;; But most features autoload on first use
(autoload 'org-mode "org" "Org mode" t)
;; org.el only loads when you actually use it</code></pre>
<p>This keeps startup fast while providing access to thousands of
features.</p>
<h3 data-number="5.8.6" id="caching-strategies"><span class="header-section-number">5.8.6</span> Caching Strategies</h3>
<p>Expensive computations are cached. Font rendering uses caching:</p>
<div class="sourceCode" id="cb57"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb57-1"><a aria-hidden="true" href="#cb57-1" tabindex="-1"></a><span class="co">// @file: src/sfntfont-android.c</span></span>
<span id="cb57-2"><a aria-hidden="true" href="#cb57-2" tabindex="-1"></a><span class="co">// @lines: 59-60, 642-649</span></span>
<span id="cb57-3"><a aria-hidden="true" href="#cb57-3" tabindex="-1"></a><span class="co">// @description: Font cache</span></span>
<span id="cb57-4"><a aria-hidden="true" href="#cb57-4" tabindex="-1"></a></span>
<span id="cb57-5"><a aria-hidden="true" href="#cb57-5" tabindex="-1"></a><span class="co">/* The font cache. */</span></span>
<span id="cb57-6"><a aria-hidden="true" href="#cb57-6" tabindex="-1"></a><span class="dt">static</span> Lisp_Object font_cache<span class="op">;</span></span>
<span id="cb57-7"><a aria-hidden="true" href="#cb57-7" tabindex="-1"></a></span>
<span id="cb57-8"><a aria-hidden="true" href="#cb57-8" tabindex="-1"></a><span class="co">/* Return the font cache for this font driver.  F is ignored. */</span></span>
<span id="cb57-9"><a aria-hidden="true" href="#cb57-9" tabindex="-1"></a><span class="dt">static</span> Lisp_Object</span>
<span id="cb57-10"><a aria-hidden="true" href="#cb57-10" tabindex="-1"></a>sfntfont_android_get_cache <span class="op">(</span><span class="kw">struct</span> frame <span class="op">*</span>f<span class="op">)</span></span>
<span id="cb57-11"><a aria-hidden="true" href="#cb57-11" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb57-12"><a aria-hidden="true" href="#cb57-12" tabindex="-1"></a>  <span class="cf">return</span> font_cache<span class="op">;</span></span>
<span id="cb57-13"><a aria-hidden="true" href="#cb57-13" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Font lookups are expensive (require reading font files, measuring
metrics). Caching makes subsequent lookups instant.</p>
<p>Similarly, the display engine caches: - Glyph matrices (for reuse
when text unchanged) - Face realizations (merged face properties) - Font
metrics (character widths, heights) - Bidi reordering tables - Line
height calculations</p>
<h3 data-number="5.8.7" id="optimization-example-list-deletion"><span class="header-section-number">5.8.7</span> Optimization Example: List
Deletion</h3>
<p>From <code>/home/user/emacs/lisp/subr.el</code>:</p>
<pre class="elisp"><code>;; @file: lisp/subr.el
;; @description: Optimizing based on list length

(defun delete-dups (list)
  "Destructively remove `equal' duplicates from LIST."
  (let ((l (length list)))
    (if (&gt; l 100)
        ;; For long lists: use hash table (O(n) time, O(n) space)
        (let ((hash (make-hash-table :test #'equal :size l))
              (tail list) retail)
          (while (setq retail (cdr tail))
            (if (gethash (car retail) hash)
                (setcdr tail (cdr retail))
              (puthash (car retail) t hash)
              (setq tail retail))))
      ;; For short lists: use simple algorithm (O(n¬≤) time, O(1) space)
      (let ((tail list))
        (while tail
          (setcdr tail (delete (car tail) (cdr tail)))
          (setq tail (cdr tail))))))
  list)</code></pre>
<p>This optimizes based on problem size: - Short lists: Simple O(n¬≤)
algorithm with minimal overhead - Long lists: Hash table gives O(n)
performance despite allocation overhead</p>
<h3 data-number="5.8.8" id="memory-management-tuning"><span class="header-section-number">5.8.8</span> Memory Management Tuning</h3>
<p>GC can be tuned for performance:</p>
<pre class="elisp"><code>;; Default: Collect when 800KB allocated
(setq gc-cons-threshold 800000)

;; During startup, increase threshold to reduce GC pauses
(setq gc-cons-threshold (* 50 1000 1000))  ; 50MB

;; After startup, restore normal threshold
(add-hook 'emacs-startup-hook
          (lambda ()
            (setq gc-cons-threshold 800000)))</code></pre>
<p>This trades memory for speed during the intensive startup phase.</p>
<h3 data-number="5.8.9" id="why-this-matters-6"><span class="header-section-number">5.8.9</span> Why This Matters</h3>
<ol type="1">
<li><strong>Responsiveness</strong>: Editor feels instant even with huge
files</li>
<li><strong>Scalability</strong>: Handles buffers with millions of
lines</li>
<li><strong>Battery life</strong>: Efficient code uses less CPU, extends
laptop battery</li>
<li><strong>Accessibility</strong>: Runs acceptably even on older
hardware</li>
<li><strong>User satisfaction</strong>: Fast software is pleasant to
use</li>
</ol>
<h3 data-number="5.8.10" id="the-cost-4"><span class="header-section-number">5.8.10</span> The Cost</h3>
<p>Performance optimization requires: - Profiling to identify
bottlenecks - Complexity (specialized code paths, caching logic) -
Memory overhead (caches, pre-computed data) - Maintenance burden
(optimized code is harder to modify) - Testing (ensure optimizations
don‚Äôt break correctness)</p>
<p>But the optimization is <strong>targeted</strong>‚Äîmost code
prioritizes clarity over speed, optimizing only the hot paths.</p>
<hr/>
<h2 data-number="5.9" id="documentation-as-code"><span class="header-section-number">5.9</span> 8. Documentation as Code</h2>
<h3 data-number="5.9.1" id="the-philosophy-7"><span class="header-section-number">5.9.1</span> The Philosophy</h3>
<p>‚ÄúDocumentation is part of the program.‚Äù Emacs doesn‚Äôt have separate
documentation that might drift out of sync. Documentation is in the
code, extracted programmatically, and introspectable at runtime.</p>
<h3 data-number="5.9.2" id="texinfo-integration"><span class="header-section-number">5.9.2</span> Texinfo Integration</h3>
<p>The reference manual is written in Texinfo
(<code>/home/user/emacs/doc/lispref/elisp.texi</code>):</p>
<div class="sourceCode" id="cb60"><pre class="sourceCode texinfo"><code class="sourceCode texinfo"><span id="cb60-1"><a aria-hidden="true" href="#cb60-1" tabindex="-1"></a><span class="co">@c @file: doc/lispref/elisp.texi</span></span>
<span id="cb60-2"><a aria-hidden="true" href="#cb60-2" tabindex="-1"></a><span class="co">@c @description: Texinfo source for the Elisp Reference Manual</span></span>
<span id="cb60-3"><a aria-hidden="true" href="#cb60-3" tabindex="-1"></a></span>
<span id="cb60-4"><a aria-hidden="true" href="#cb60-4" tabindex="-1"></a>\input texinfo  <span class="co">@c -*-texinfo-*-</span></span>
<span id="cb60-5"><a aria-hidden="true" href="#cb60-5" tabindex="-1"></a><span class="co">@c %**start of header</span></span>
<span id="cb60-6"><a aria-hidden="true" href="#cb60-6" tabindex="-1"></a><span class="fu">@setfilename</span> ../../info/elisp.info</span>
<span id="cb60-7"><a aria-hidden="true" href="#cb60-7" tabindex="-1"></a></span>
<span id="cb60-8"><a aria-hidden="true" href="#cb60-8" tabindex="-1"></a><span class="fu">@settitle</span> GNU Emacs Lisp Reference Manual</span>
<span id="cb60-9"><a aria-hidden="true" href="#cb60-9" tabindex="-1"></a><span class="fu">@include</span> docstyle.texi</span>
<span id="cb60-10"><a aria-hidden="true" href="#cb60-10" tabindex="-1"></a></span>
<span id="cb60-11"><a aria-hidden="true" href="#cb60-11" tabindex="-1"></a><span class="co">@c Combine indices</span></span>
<span id="cb60-12"><a aria-hidden="true" href="#cb60-12" tabindex="-1"></a><span class="fu">@syncodeindex</span> fn cp</span>
<span id="cb60-13"><a aria-hidden="true" href="#cb60-13" tabindex="-1"></a><span class="fu">@syncodeindex</span> vr cp</span>
<span id="cb60-14"><a aria-hidden="true" href="#cb60-14" tabindex="-1"></a><span class="fu">@syncodeindex</span> ky cp</span>
<span id="cb60-15"><a aria-hidden="true" href="#cb60-15" tabindex="-1"></a><span class="fu">@syncodeindex</span> pg cp</span>
<span id="cb60-16"><a aria-hidden="true" href="#cb60-16" tabindex="-1"></a><span class="fu">@syncodeindex</span> tp cp</span></code></pre></div>
<p>Texinfo allows: - Multiple output formats (Info, HTML, PDF, plain
text) - Comprehensive indexing - Cross-references between sections -
Embedding of examples - Conditional text for different formats</p>
<h3 data-number="5.9.3" id="inline-documentation"><span class="header-section-number">5.9.3</span> Inline Documentation</h3>
<p>Every <code>defun</code>, <code>defvar</code>, <code>defcustom</code>
includes documentation:</p>
<pre class="elisp"><code>(defcustom find-file-hook nil
  "List of functions to call after finding a file.
See also `find-file-not-found-functions'."
  :type 'hook
  :group 'files)</code></pre>
<p>This documentation is: 1. <strong>Compiled into the code</strong>:
Available at runtime 2. <strong>Indexed</strong>: Help system can find
it 3. <strong>Cross-referenced</strong>: Backtick-quoted symbols become
links 4. <strong>Type-annotated</strong>: <code>:type</code> describes
expected values</p>
<h3 data-number="5.9.4" id="examples-in-documentation"><span class="header-section-number">5.9.4</span> Examples in
Documentation</h3>
<p>Documentation includes executable examples:</p>
<pre class="elisp"><code>(defun delete-dups (list)
  "Destructively remove `equal' duplicates from LIST.
Store the result in LIST and return it.  LIST must be a proper list.
Of several `equal' occurrences of an element in LIST, the first
one is kept.

Example:
  (setq my-list '(1 2 3 2 4 3 5))
  (delete-dups my-list)
  =&gt; (1 2 4 3 5)
  my-list
  =&gt; (1 2 4 3 5)  ; Modified in place

See also: `delete-consecutive-dups', `remove-duplicates'."
  ;; Implementation...
  )</code></pre>
<p>Users can copy examples from documentation and evaluate them
immediately.</p>
<h3 data-number="5.9.5" id="cross-references-2"><span class="header-section-number">5.9.5</span> Cross-References</h3>
<p>Documentation uses consistent reference format:</p>
<pre class="elisp"><code>"Set point to ARG, measured in characters from start of buffer.
The resulting position is constrained to the accessible portion of
the buffer.

Don't use this function in Lisp programs!  Use `goto-char' instead.
\(goto-char (point-min)) is equivalent to (beginning-of-buffer),
but using `goto-char' is more explicit.

See also:
  `end-of-buffer' - Go to end
  `point-min' - Return minimum valid point
  `point-max' - Return maximum valid point
  `narrow-to-region' - Restrict accessible portion"</code></pre>
<p>These references are <strong>live links</strong> in the help
system.</p>
<h3 data-number="5.9.6" id="self-documenting-help-system"><span class="header-section-number">5.9.6</span> Self-Documenting Help
System</h3>
<p>The help system generates documentation dynamically. From
<code>help.el</code>:</p>
<pre class="elisp"><code>(defun describe-function (function)
  "Display documentation of FUNCTION (a symbol)."
  (interactive (list (function-called-at-point)))
  (let* ((def (symbol-function function))
         (doc (documentation function))
         (file (find-lisp-object-file-name function def))
         (pt (with-current-buffer standard-output (point))))
    ;; Print function name and type
    (princ (format "%S is " function))
    (cond
     ((commandp function)
      (princ "an interactive "))
     ((macrop function)
      (princ "a Lisp macro"))
     ((subrp def)
      (princ "a built-in function"))
     ((byte-code-function-p def)
      (princ "a compiled Lisp function"))
     (t
      (princ "a Lisp function")))
    ;; Print source file
    (when file
      (princ (format " in `%s'" (file-name-nondirectory file))))
    ;; Print signature
    (princ ".\n\n")
    (let ((signature (help-function-arglist function)))
      (princ (format "(%S %s)\n\n" function signature)))
    ;; Print documentation
    (princ doc)
    ;; Add cross-references
    (help-xref-button 1 'help-function-def function file)))</code></pre>
<p>This generates: - Function type (built-in, compiled, interpreted) -
Source file location (clickable link) - Argument list - Full
documentation - Related functions - Key bindings (if interactive)</p>
<p>All from the runtime state of the system.</p>
<h3 data-number="5.9.7" id="documentation-in-c-code"><span class="header-section-number">5.9.7</span> Documentation in C Code</h3>
<p>Even C primitives include extensive documentation:</p>
<div class="sourceCode" id="cb65"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb65-1"><a aria-hidden="true" href="#cb65-1" tabindex="-1"></a>DEFUN <span class="op">(</span><span class="st">"make-indirect-buffer"</span><span class="op">,</span> Fmake_indirect_buffer<span class="op">,</span> Smake_indirect_buffer<span class="op">,</span></span>
<span id="cb65-2"><a aria-hidden="true" href="#cb65-2" tabindex="-1"></a>       <span class="dv">2</span><span class="op">,</span> <span class="dv">4</span><span class="op">,</span></span>
<span id="cb65-3"><a aria-hidden="true" href="#cb65-3" tabindex="-1"></a>       <span class="st">"bMake indirect buffer (to buffer): </span><span class="sc">\n</span><span class="st">BName of indirect buffer: "</span><span class="op">,</span></span>
<span id="cb65-4"><a aria-hidden="true" href="#cb65-4" tabindex="-1"></a>       doc<span class="op">:</span> <span class="co">/* Create and return an indirect buffer for buffer BASE-BUFFER, named NAME.</span></span>
<span id="cb65-5"><a aria-hidden="true" href="#cb65-5" tabindex="-1"></a><span class="co">BASE-BUFFER should be a live buffer, or the name of an existing buffer.</span></span>
<span id="cb65-6"><a aria-hidden="true" href="#cb65-6" tabindex="-1"></a></span>
<span id="cb65-7"><a aria-hidden="true" href="#cb65-7" tabindex="-1"></a><span class="co">NAME should be a string which is not the name of an existing buffer.</span></span>
<span id="cb65-8"><a aria-hidden="true" href="#cb65-8" tabindex="-1"></a></span>
<span id="cb65-9"><a aria-hidden="true" href="#cb65-9" tabindex="-1"></a><span class="co">Interactively, prompt for BASE-BUFFER (offering the current buffer as</span></span>
<span id="cb65-10"><a aria-hidden="true" href="#cb65-10" tabindex="-1"></a><span class="co">the default), and for NAME (offering as default the name of a recently</span></span>
<span id="cb65-11"><a aria-hidden="true" href="#cb65-11" tabindex="-1"></a><span class="co">used buffer).</span></span>
<span id="cb65-12"><a aria-hidden="true" href="#cb65-12" tabindex="-1"></a></span>
<span id="cb65-13"><a aria-hidden="true" href="#cb65-13" tabindex="-1"></a><span class="co">Optional argument CLONE non-nil means preserve BASE-BUFFER's state,</span></span>
<span id="cb65-14"><a aria-hidden="true" href="#cb65-14" tabindex="-1"></a><span class="co">such as major and minor modes, in the indirect buffer.</span></span>
<span id="cb65-15"><a aria-hidden="true" href="#cb65-15" tabindex="-1"></a><span class="co">CLONE nil means the indirect buffer's state is reset to default values.</span></span>
<span id="cb65-16"><a aria-hidden="true" href="#cb65-16" tabindex="-1"></a></span>
<span id="cb65-17"><a aria-hidden="true" href="#cb65-17" tabindex="-1"></a><span class="co">If optional argument INHIBIT-BUFFER-HOOKS is non-nil, the new buffer</span></span>
<span id="cb65-18"><a aria-hidden="true" href="#cb65-18" tabindex="-1"></a><span class="co">does not run the hooks `kill-buffer-hook',</span></span>
<span id="cb65-19"><a aria-hidden="true" href="#cb65-19" tabindex="-1"></a><span class="co">`kill-buffer-query-functions', and `buffer-list-update-hook'.</span></span>
<span id="cb65-20"><a aria-hidden="true" href="#cb65-20" tabindex="-1"></a></span>
<span id="cb65-21"><a aria-hidden="true" href="#cb65-21" tabindex="-1"></a><span class="co">Interactively, CLONE and INHIBIT-BUFFER-HOOKS are nil.  */</span><span class="op">)</span></span></code></pre></div>
<p>The <code>doc:</code> string is extracted during build and becomes
accessible to Lisp.</p>
<h3 data-number="5.9.8" id="generated-documentation"><span class="header-section-number">5.9.8</span> Generated Documentation</h3>
<p>Build process generates documentation from source:</p>
<div class="sourceCode" id="cb66"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb66-1"><a aria-hidden="true" href="#cb66-1" tabindex="-1"></a><span class="co"># Generate autoloads (function index)</span></span>
<span id="cb66-2"><a aria-hidden="true" href="#cb66-2" tabindex="-1"></a><span class="ex">emacs</span> <span class="at">-batch</span> <span class="at">-f</span> batch-update-autoloads lisp/</span>
<span id="cb66-3"><a aria-hidden="true" href="#cb66-3" tabindex="-1"></a></span>
<span id="cb66-4"><a aria-hidden="true" href="#cb66-4" tabindex="-1"></a><span class="co"># Generate DOC file (primitive documentation)</span></span>
<span id="cb66-5"><a aria-hidden="true" href="#cb66-5" tabindex="-1"></a><span class="ex">make-docfile</span> <span class="pp">*</span>.c <span class="op">&gt;</span> etc/DOC</span>
<span id="cb66-6"><a aria-hidden="true" href="#cb66-6" tabindex="-1"></a></span>
<span id="cb66-7"><a aria-hidden="true" href="#cb66-7" tabindex="-1"></a><span class="co"># Generate Info documentation</span></span>
<span id="cb66-8"><a aria-hidden="true" href="#cb66-8" tabindex="-1"></a><span class="ex">makeinfo</span> elisp.texi</span></code></pre></div>
<p>This ensures documentation accurately reflects the code.</p>
<h3 data-number="5.9.9" id="why-this-matters-7"><span class="header-section-number">5.9.9</span> Why This Matters</h3>
<ol type="1">
<li><strong>Accuracy</strong>: Documentation can‚Äôt drift from code‚Äîit
<em>is</em> the code</li>
<li><strong>Discoverability</strong>: Help is always available, always
current</li>
<li><strong>Learning</strong>: Reading documentation leads to reading
source</li>
<li><strong>Contribution</strong>: Good documentation is enforced by
structure</li>
<li><strong>Maintenance</strong>: Changes to code trigger documentation
updates</li>
</ol>
<h3 data-number="5.9.10" id="the-cost-5"><span class="header-section-number">5.9.10</span> The Cost</h3>
<p>Documentation as code requires: - Discipline (every public interface
must be documented) - Space overhead (documentation compiled into
binary) - Build complexity (extraction and generation steps) - Learning
curve (must understand documentation format)</p>
<p>But the payoff is enormous: Emacs‚Äôs help system is one of its
defining features, making a complex system approachable.</p>
<hr/>
<h2 data-number="5.10" id="synthesis-how-principles-interact"><span class="header-section-number">5.10</span> Synthesis: How Principles
Interact</h2>
<p>These eight principles don‚Äôt exist in isolation‚Äîthey reinforce each
other:</p>
<h3 data-number="5.10.1" id="self-documentation-extensibility"><span class="header-section-number">5.10.1</span> Self-Documentation +
Extensibility</h3>
<p>Because functions are self-documenting, users can confidently modify
them. The help system (<code>C-h f</code>) shows exactly what a function
does before advising it.</p>
<h3 data-number="5.10.2" id="backwards-compatibility-lisp-centric"><span class="header-section-number">5.10.2</span> Backwards Compatibility +
Lisp-Centric</h3>
<p>Moving functionality to Lisp makes evolution easier while maintaining
compatibility. Lisp functions can be advised, wrapped, or replaced
without changing C code.</p>
<h3 data-number="5.10.3" id="modularity-progressive-enhancement"><span class="header-section-number">5.10.3</span> Modularity + Progressive
Enhancement</h3>
<p>Clean abstractions enable platform-specific implementations. New
platforms need only implement the terminal interface; everything else
works automatically.</p>
<h3 data-number="5.10.4" id="performance-flexibility"><span class="header-section-number">5.10.4</span> Performance +
Flexibility</h3>
<p>Bytecode and native compilation provide performance without
sacrificing flexibility. Code remains introspectable even when compiled
to native code.</p>
<h3 data-number="5.10.5" id="documentation-self-documentation"><span class="header-section-number">5.10.5</span> Documentation +
Self-Documentation</h3>
<p>Texinfo manuals reference the same documentation strings visible in
help buffers, ensuring consistency.</p>
<hr/>
<h2 data-number="5.11" id="conclusion-principles-of-longevity"><span class="header-section-number">5.11</span> Conclusion: Principles of
Longevity</h2>
<p>Emacs has survived 40 years not by predicting the future, but by
adhering to principles that remain valuable regardless of technological
change:</p>
<ol type="1">
<li><strong>Self-Documentation</strong>: Systems should explain
themselves</li>
<li><strong>Extensibility</strong>: Users should have the power to
modify anything</li>
<li><strong>Backwards Compatibility</strong>: Respect user
investment</li>
<li><strong>Lisp-Centric Design</strong>: Flexibility through high-level
language</li>
<li><strong>Modularity</strong>: Separate concerns through clear
abstractions</li>
<li><strong>Progressive Enhancement</strong>: Degrade gracefully,
enhance opportunistically</li>
<li><strong>Performance vs Flexibility</strong>: Optimize the hot paths,
keep everything else flexible</li>
<li><strong>Documentation as Code</strong>: Documentation is part of the
program, not separate</li>
</ol>
<p>These principles create a system that is: -
<strong>Understandable</strong>: Self-documenting and well-architected -
<strong>Evolvable</strong>: Can add features without breaking existing
code - <strong>Powerful</strong>: Users have unlimited customization
capability - <strong>Portable</strong>: Runs everywhere through
abstraction and graceful degradation - <strong>Performant</strong>: Fast
where it matters, flexible where it doesn‚Äôt -
<strong>Maintainable</strong>: Clear separation of concerns,
comprehensive documentation</p>
<p>As you explore the Emacs codebase, you‚Äôll see these principles
manifested repeatedly. They‚Äôre not just theoretical‚Äîthey‚Äôre the
practical wisdom accumulated over four decades of continuous
development.</p>
<p>The next chapters dive deeper into specific subsystems. As you read
them, notice how these principles guide implementation decisions.
Understanding the philosophy helps you understand the details;
understanding the details helps you appreciate the philosophy.</p>
<hr/>
<h2 data-number="5.12" id="further-reading-2"><span class="header-section-number">5.12</span> Further Reading</h2>
<h3 data-number="5.12.1" id="source-files-referenced"><span class="header-section-number">5.12.1</span> Source Files Referenced</h3>
<ul>
<li><code>/home/user/emacs/src/buffer.c</code> - Buffer primitives and
DEFUN examples</li>
<li><code>/home/user/emacs/src/lisp.h</code> - Core type
definitions</li>
<li><code>/home/user/emacs/src/xdisp.c</code> - Display engine and
optimization</li>
<li><code>/home/user/emacs/src/eval.c</code> - Lisp evaluation and
extensibility</li>
<li><code>/home/user/emacs/src/font.h</code> - Backend abstraction
example</li>
<li><code>/home/user/emacs/lisp/loadup.el</code> - Progressive
enhancement</li>
<li><code>/home/user/emacs/lisp/emacs-lisp/bytecomp.el</code> -
Performance optimization</li>
<li><code>/home/user/emacs/lisp/emacs-lisp/nadvice.el</code> -
Extensibility through advice</li>
<li><code>/home/user/emacs/lisp/subr.el</code> - Core Elisp
utilities</li>
<li><code>/home/user/emacs/doc/lispref/elisp.texi</code> - Documentation
integration</li>
</ul>
<h3 data-number="5.12.2" id="related-chapters"><span class="header-section-number">5.12.2</span> Related Chapters</h3>
<ul>
<li><span class="citation" data-cites="chap:02">[@chap:02]</span> Core
Subsystems - Detailed implementation of core systems</li>
<li><span class="citation" data-cites="chap:03">[@chap:03]</span> Elisp
Runtime - Deep dive into the Lisp interpreter</li>
<li><span class="citation" data-cites="chap:05">[@chap:05]</span>
Display Engine - Optimization case study</li>
<li><span class="citation" data-cites="chap:08">[@chap:08]</span> Major
Modes - Modularity in action</li>
<li><span class="citation" data-cites="chap:18">[@chap:18]</span> Build
System - How principles manifest in build process</li>
</ul>
<h3 data-number="5.12.3" id="external-resources"><span class="header-section-number">5.12.3</span> External Resources</h3>
<ul>
<li>GNU Emacs Manual - User perspective on these principles</li>
<li>Emacs Lisp Reference Manual - API shaped by these philosophies</li>
<li>‚ÄúThe Craft of Text Editing‚Äù by Craig Finseth - Editor design
principles</li>
<li>‚ÄúHackers‚Äù by Steven Levy - Historical context of hacker culture that
shaped Emacs</li>
</ul>
<hr/>
<p><strong>End of Chapter 01, Section 02</strong></p>
<h1 data-number="6" id="buffer-management-subsystem"><span class="header-section-number">6</span> Buffer Management Subsystem</h1>
<h2 data-number="6.1" id="table-of-contents"><span class="header-section-number">6.1</span> Table of Contents</h2>
<ol type="1">
<li><a href="#introduction">Introduction</a></li>
<li><a href="#the-gap-buffer-core-data-structure">The Gap Buffer: Core
Data Structure</a></li>
<li><a href="#buffer-structure-and-organization">Buffer Structure and
Organization</a></li>
<li><a href="#text-insertion-and-deletion">Text Insertion and
Deletion</a></li>
<li><a href="#the-marker-system">The Marker System</a></li>
<li><a href="#text-properties-and-intervals">Text Properties and
Intervals</a></li>
<li><a href="#buffer-local-variables">Buffer-Local Variables</a></li>
<li><a href="#buffers-and-windows">Buffers and Windows</a></li>
<li><a href="#the-elisp-layer">The Elisp Layer</a></li>
<li><a href="#design-rationale">Design Rationale</a></li>
</ol>
<hr/>
<h2 data-number="6.2" id="introduction"><span class="header-section-number">6.2</span> Introduction</h2>
<p>The buffer management subsystem is the heart of Emacs text editing. A
<strong>buffer</strong> is Emacs‚Äô fundamental data structure for
representing editable text. Every piece of text you see in Emacs‚Äîwhether
it‚Äôs a file, a directory listing, a shell session, or temporary scratch
space‚Äîlives in a buffer.</p>
<h3 data-number="6.2.1" id="core-responsibilities"><span class="header-section-number">6.2.1</span> Core Responsibilities</h3>
<p>The buffer subsystem handles: - <strong>Efficient text
storage</strong> using the gap buffer data structure - <strong>Position
tracking</strong> through the marker system - <strong>Text
properties</strong> via interval trees - <strong>Buffer-local
state</strong> including variables, modes, and keymaps -
<strong>Integration with the display</strong> system and windows</p>
<h3 data-number="6.2.2" id="key-design-principles"><span class="header-section-number">6.2.2</span> Key Design Principles</h3>
<ol type="1">
<li><strong>Efficiency for interactive editing</strong>: Most operations
(insertion/deletion at point) are O(1)</li>
<li><strong>Multibyte character support</strong>: Seamless handling of
Unicode</li>
<li><strong>Undo support</strong>: All modifications are tracked</li>
<li><strong>Separation of concerns</strong>: Text storage is independent
of display</li>
</ol>
<hr/>
<h2 data-number="6.3" id="the-gap-buffer-core-data-structure"><span class="header-section-number">6.3</span> The Gap Buffer: Core Data
Structure</h2>
<h3 data-number="6.3.1" id="concept"><span class="header-section-number">6.3.1</span> Concept</h3>
<p>The <strong>gap buffer</strong> is an elegant data structure
optimized for text editing. Instead of using a simple array or linked
list, it maintains a ‚Äúgap‚Äù (empty space) in the middle of the buffer
text. This gap moves to wherever the user is editing, making insertions
and deletions at that point extremely fast.</p>
<h3 data-number="6.3.2" id="visual-representation"><span class="header-section-number">6.3.2</span> Visual Representation</h3>
<pre><code>Without a gap (conceptual):
[H][e][l][l][o][ ][w][o][r][l][d]
                 ‚Üë cursor here

With a gap buffer:
[H][e][l][l][o][ ][ ][ ][ ][ ][w][o][r][l][d]
                 ‚Üë               ‚Üë
                GPT          GAP_END

The gap provides space for fast insertion without reallocating.</code></pre>
<h3 data-number="6.3.3" id="implementation-details"><span class="header-section-number">6.3.3</span> Implementation Details</h3>
<p>The gap buffer implementation is split between
<code>struct buffer_text</code> (src/buffer.h:240-304) and the gap
manipulation functions (src/insdel.c).</p>
<p><strong>Data Structure</strong> (src/buffer.h:240-304):</p>
<div class="sourceCode" id="cb68"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb68-1"><a aria-hidden="true" href="#cb68-1" tabindex="-1"></a><span class="kw">struct</span> buffer_text</span>
<span id="cb68-2"><a aria-hidden="true" href="#cb68-2" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb68-3"><a aria-hidden="true" href="#cb68-3" tabindex="-1"></a>    <span class="dt">unsigned</span> <span class="dt">char</span> <span class="op">*</span>beg<span class="op">;</span>        <span class="co">/* Actual address of buffer contents */</span></span>
<span id="cb68-4"><a aria-hidden="true" href="#cb68-4" tabindex="-1"></a></span>
<span id="cb68-5"><a aria-hidden="true" href="#cb68-5" tabindex="-1"></a>    <span class="dt">ptrdiff_t</span> gpt<span class="op">;</span>             <span class="co">/* Char pos of gap in buffer */</span></span>
<span id="cb68-6"><a aria-hidden="true" href="#cb68-6" tabindex="-1"></a>    <span class="dt">ptrdiff_t</span> z<span class="op">;</span>               <span class="co">/* Char pos of end of buffer */</span></span>
<span id="cb68-7"><a aria-hidden="true" href="#cb68-7" tabindex="-1"></a>    <span class="dt">ptrdiff_t</span> gpt_byte<span class="op">;</span>        <span class="co">/* Byte pos of gap in buffer */</span></span>
<span id="cb68-8"><a aria-hidden="true" href="#cb68-8" tabindex="-1"></a>    <span class="dt">ptrdiff_t</span> z_byte<span class="op">;</span>          <span class="co">/* Byte pos of end of buffer */</span></span>
<span id="cb68-9"><a aria-hidden="true" href="#cb68-9" tabindex="-1"></a>    <span class="dt">ptrdiff_t</span> gap_size<span class="op">;</span>        <span class="co">/* Size of buffer's gap */</span></span>
<span id="cb68-10"><a aria-hidden="true" href="#cb68-10" tabindex="-1"></a></span>
<span id="cb68-11"><a aria-hidden="true" href="#cb68-11" tabindex="-1"></a>    modiff_count modiff<span class="op">;</span>       <span class="co">/* Modification counter */</span></span>
<span id="cb68-12"><a aria-hidden="true" href="#cb68-12" tabindex="-1"></a>    modiff_count chars_modiff<span class="op">;</span> <span class="co">/* Character change counter */</span></span>
<span id="cb68-13"><a aria-hidden="true" href="#cb68-13" tabindex="-1"></a></span>
<span id="cb68-14"><a aria-hidden="true" href="#cb68-14" tabindex="-1"></a>    INTERVAL intervals<span class="op">;</span>        <span class="co">/* Text properties tree */</span></span>
<span id="cb68-15"><a aria-hidden="true" href="#cb68-15" tabindex="-1"></a>    <span class="kw">struct</span> Lisp_Marker <span class="op">*</span>markers<span class="op">;</span> <span class="co">/* Chain of markers */</span></span>
<span id="cb68-16"><a aria-hidden="true" href="#cb68-16" tabindex="-1"></a></span>
<span id="cb68-17"><a aria-hidden="true" href="#cb68-17" tabindex="-1"></a>    <span class="co">// ... additional fields</span></span>
<span id="cb68-18"><a aria-hidden="true" href="#cb68-18" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<p><strong>Key Invariants:</strong> - The gap starts at byte position
<code>gpt_byte</code> and extends for <code>gap_size</code> bytes -
Buffer text before the gap: <code>[BEG_BYTE, gpt_byte)</code> - Buffer
text after the gap:
<code>[gpt_byte + gap_size, z_byte + gap_size)</code> - Total buffer
size: <code>z_byte</code> (excluding gap)</p>
<h3 data-number="6.3.4" id="critical-macros-srcbuffer.h38-94"><span class="header-section-number">6.3.4</span> Critical Macros
(src/buffer.h:38-94)</h3>
<div class="sourceCode" id="cb69"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb69-1"><a aria-hidden="true" href="#cb69-1" tabindex="-1"></a><span class="co">/* Position of beginning of buffer (always 1 in char positions) */</span></span>
<span id="cb69-2"><a aria-hidden="true" href="#cb69-2" tabindex="-1"></a><span class="kw">enum</span> <span class="op">{</span> BEG <span class="op">=</span> <span class="dv">1</span><span class="op">,</span> BEG_BYTE <span class="op">=</span> BEG <span class="op">};</span></span>
<span id="cb69-3"><a aria-hidden="true" href="#cb69-3" tabindex="-1"></a></span>
<span id="cb69-4"><a aria-hidden="true" href="#cb69-4" tabindex="-1"></a><span class="co">/* Position of point in buffer */</span></span>
<span id="cb69-5"><a aria-hidden="true" href="#cb69-5" tabindex="-1"></a><span class="pp">#define PT </span><span class="op">(</span><span class="pp">current_buffer</span><span class="op">-&gt;</span><span class="pp">pt </span><span class="op">+</span><span class="pp"> </span><span class="dv">0</span><span class="op">)</span><span class="pp">          </span><span class="co">/* Make it non-lvalue */</span></span>
<span id="cb69-6"><a aria-hidden="true" href="#cb69-6" tabindex="-1"></a><span class="pp">#define PT_BYTE </span><span class="op">(</span><span class="pp">current_buffer</span><span class="op">-&gt;</span><span class="pp">pt_byte </span><span class="op">+</span><span class="pp"> </span><span class="dv">0</span><span class="op">)</span></span>
<span id="cb69-7"><a aria-hidden="true" href="#cb69-7" tabindex="-1"></a></span>
<span id="cb69-8"><a aria-hidden="true" href="#cb69-8" tabindex="-1"></a><span class="co">/* Position of gap in buffer */</span></span>
<span id="cb69-9"><a aria-hidden="true" href="#cb69-9" tabindex="-1"></a><span class="pp">#define GPT </span><span class="op">(</span><span class="pp">current_buffer</span><span class="op">-&gt;</span><span class="pp">text</span><span class="op">-&gt;</span><span class="pp">gpt</span><span class="op">)</span></span>
<span id="cb69-10"><a aria-hidden="true" href="#cb69-10" tabindex="-1"></a><span class="pp">#define GPT_BYTE </span><span class="op">(</span><span class="pp">current_buffer</span><span class="op">-&gt;</span><span class="pp">text</span><span class="op">-&gt;</span><span class="pp">gpt_byte</span><span class="op">)</span></span>
<span id="cb69-11"><a aria-hidden="true" href="#cb69-11" tabindex="-1"></a></span>
<span id="cb69-12"><a aria-hidden="true" href="#cb69-12" tabindex="-1"></a><span class="co">/* Position of end of buffer */</span></span>
<span id="cb69-13"><a aria-hidden="true" href="#cb69-13" tabindex="-1"></a><span class="pp">#define Z </span><span class="op">(</span><span class="pp">current_buffer</span><span class="op">-&gt;</span><span class="pp">text</span><span class="op">-&gt;</span><span class="pp">z</span><span class="op">)</span></span>
<span id="cb69-14"><a aria-hidden="true" href="#cb69-14" tabindex="-1"></a><span class="pp">#define Z_BYTE </span><span class="op">(</span><span class="pp">current_buffer</span><span class="op">-&gt;</span><span class="pp">text</span><span class="op">-&gt;</span><span class="pp">z_byte</span><span class="op">)</span></span>
<span id="cb69-15"><a aria-hidden="true" href="#cb69-15" tabindex="-1"></a></span>
<span id="cb69-16"><a aria-hidden="true" href="#cb69-16" tabindex="-1"></a><span class="co">/* Size of the gap */</span></span>
<span id="cb69-17"><a aria-hidden="true" href="#cb69-17" tabindex="-1"></a><span class="pp">#define GAP_SIZE </span><span class="op">(</span><span class="pp">current_buffer</span><span class="op">-&gt;</span><span class="pp">text</span><span class="op">-&gt;</span><span class="pp">gap_size</span><span class="op">)</span></span></code></pre></div>
<p><strong>Why the ‚Äú+ 0‚Äù trick?</strong> Making <code>PT</code>
non-assignable (src/buffer.h:44-47) prevents accidental direct
assignment. You must use <code>SET_PT()</code> instead, which properly
updates all related state (markers, text properties, display, etc.).</p>
<h3 data-number="6.3.5" id="address-calculation"><span class="header-section-number">6.3.5</span> Address Calculation</h3>
<p>Getting the actual memory address of a buffer position requires
accounting for the gap (src/buffer.h:1072-1078):</p>
<div class="sourceCode" id="cb70"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb70-1"><a aria-hidden="true" href="#cb70-1" tabindex="-1"></a>INLINE <span class="dt">unsigned</span> <span class="dt">char</span> <span class="op">*</span></span>
<span id="cb70-2"><a aria-hidden="true" href="#cb70-2" tabindex="-1"></a>BYTE_POS_ADDR <span class="op">(</span><span class="dt">ptrdiff_t</span> n<span class="op">)</span></span>
<span id="cb70-3"><a aria-hidden="true" href="#cb70-3" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb70-4"><a aria-hidden="true" href="#cb70-4" tabindex="-1"></a>  <span class="cf">return</span> <span class="op">(</span>n <span class="op">&lt;</span> GPT_BYTE <span class="op">?</span> <span class="dv">0</span> <span class="op">:</span> GAP_SIZE<span class="op">)</span> <span class="op">+</span> n <span class="op">+</span> BEG_ADDR <span class="op">-</span> BEG_BYTE<span class="op">;</span></span>
<span id="cb70-5"><a aria-hidden="true" href="#cb70-5" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>This is crucial because: - Positions before the gap map directly to
memory - Positions after the gap must skip over the gap in memory - The
calculation is extremely fast (no branches on modern CPUs)</p>
<h3 data-number="6.3.6" id="gap-movement"><span class="header-section-number">6.3.6</span> Gap Movement</h3>
<p>When you edit text at a different location, the gap must move. This
is handled by <code>gap_left()</code> and <code>gap_right()</code>
(src/insdel.c:104-220).</p>
<p><strong>Moving the gap left</strong> (src/insdel.c:110-166):</p>
<div class="sourceCode" id="cb71"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb71-1"><a aria-hidden="true" href="#cb71-1" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span></span>
<span id="cb71-2"><a aria-hidden="true" href="#cb71-2" tabindex="-1"></a>gap_left <span class="op">(</span><span class="dt">ptrdiff_t</span> charpos<span class="op">,</span> <span class="dt">ptrdiff_t</span> bytepos<span class="op">,</span> <span class="dt">bool</span> newgap<span class="op">)</span></span>
<span id="cb71-3"><a aria-hidden="true" href="#cb71-3" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb71-4"><a aria-hidden="true" href="#cb71-4" tabindex="-1"></a>  <span class="dt">unsigned</span> <span class="dt">char</span> <span class="op">*</span>to<span class="op">,</span> <span class="op">*</span>from<span class="op">;</span></span>
<span id="cb71-5"><a aria-hidden="true" href="#cb71-5" tabindex="-1"></a>  <span class="dt">ptrdiff_t</span> i<span class="op">;</span></span>
<span id="cb71-6"><a aria-hidden="true" href="#cb71-6" tabindex="-1"></a>  <span class="dt">ptrdiff_t</span> new_s1<span class="op">;</span></span>
<span id="cb71-7"><a aria-hidden="true" href="#cb71-7" tabindex="-1"></a></span>
<span id="cb71-8"><a aria-hidden="true" href="#cb71-8" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(!</span>newgap<span class="op">)</span></span>
<span id="cb71-9"><a aria-hidden="true" href="#cb71-9" tabindex="-1"></a>    BUF_COMPUTE_UNCHANGED <span class="op">(</span>current_buffer<span class="op">,</span> charpos<span class="op">,</span> GPT<span class="op">);</span></span>
<span id="cb71-10"><a aria-hidden="true" href="#cb71-10" tabindex="-1"></a></span>
<span id="cb71-11"><a aria-hidden="true" href="#cb71-11" tabindex="-1"></a>  i <span class="op">=</span> GPT_BYTE<span class="op">;</span></span>
<span id="cb71-12"><a aria-hidden="true" href="#cb71-12" tabindex="-1"></a>  to <span class="op">=</span> GAP_END_ADDR<span class="op">;</span></span>
<span id="cb71-13"><a aria-hidden="true" href="#cb71-13" tabindex="-1"></a>  from <span class="op">=</span> GPT_ADDR<span class="op">;</span></span>
<span id="cb71-14"><a aria-hidden="true" href="#cb71-14" tabindex="-1"></a>  new_s1 <span class="op">=</span> GPT_BYTE<span class="op">;</span></span>
<span id="cb71-15"><a aria-hidden="true" href="#cb71-15" tabindex="-1"></a></span>
<span id="cb71-16"><a aria-hidden="true" href="#cb71-16" tabindex="-1"></a>  <span class="co">/* Copy characters up to move the gap down */</span></span>
<span id="cb71-17"><a aria-hidden="true" href="#cb71-17" tabindex="-1"></a>  <span class="cf">while</span> <span class="op">(</span><span class="dv">1</span><span class="op">)</span></span>
<span id="cb71-18"><a aria-hidden="true" href="#cb71-18" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb71-19"><a aria-hidden="true" href="#cb71-19" tabindex="-1"></a>      i <span class="op">=</span> new_s1 <span class="op">-</span> bytepos<span class="op">;</span></span>
<span id="cb71-20"><a aria-hidden="true" href="#cb71-20" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span>i <span class="op">==</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb71-21"><a aria-hidden="true" href="#cb71-21" tabindex="-1"></a>        <span class="cf">break</span><span class="op">;</span></span>
<span id="cb71-22"><a aria-hidden="true" href="#cb71-22" tabindex="-1"></a>      <span class="co">/* Check for quit every 32KB */</span></span>
<span id="cb71-23"><a aria-hidden="true" href="#cb71-23" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span>QUITP<span class="op">)</span> <span class="op">{</span> <span class="co">/* ... */</span> <span class="op">}</span></span>
<span id="cb71-24"><a aria-hidden="true" href="#cb71-24" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span>i <span class="op">&gt;</span> <span class="dv">32000</span><span class="op">)</span></span>
<span id="cb71-25"><a aria-hidden="true" href="#cb71-25" tabindex="-1"></a>        i <span class="op">=</span> <span class="dv">32000</span><span class="op">;</span></span>
<span id="cb71-26"><a aria-hidden="true" href="#cb71-26" tabindex="-1"></a>      new_s1 <span class="op">-=</span> i<span class="op">;</span></span>
<span id="cb71-27"><a aria-hidden="true" href="#cb71-27" tabindex="-1"></a>      from <span class="op">-=</span> i<span class="op">,</span> to <span class="op">-=</span> i<span class="op">;</span></span>
<span id="cb71-28"><a aria-hidden="true" href="#cb71-28" tabindex="-1"></a>      memmove <span class="op">(</span>to<span class="op">,</span> from<span class="op">,</span> i<span class="op">);</span></span>
<span id="cb71-29"><a aria-hidden="true" href="#cb71-29" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb71-30"><a aria-hidden="true" href="#cb71-30" tabindex="-1"></a></span>
<span id="cb71-31"><a aria-hidden="true" href="#cb71-31" tabindex="-1"></a>  GPT_BYTE <span class="op">=</span> bytepos<span class="op">;</span></span>
<span id="cb71-32"><a aria-hidden="true" href="#cb71-32" tabindex="-1"></a>  GPT <span class="op">=</span> charpos<span class="op">;</span></span>
<span id="cb71-33"><a aria-hidden="true" href="#cb71-33" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>GAP_SIZE <span class="op">&gt;</span> <span class="dv">0</span><span class="op">)</span> <span class="op">*(</span>GPT_ADDR<span class="op">)</span> <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> <span class="co">/* Put an anchor */</span></span>
<span id="cb71-34"><a aria-hidden="true" href="#cb71-34" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>Design notes:</strong> - Uses <code>memmove()</code> for safe
overlapping memory copy - Processes in 32KB chunks to allow
<code>C-g</code> to interrupt long moves - Puts a null byte anchor at
the gap start for C string safety - The ‚Äúnewgap‚Äù parameter is used when
creating/expanding the gap</p>
<hr/>
<h2 data-number="6.4" id="buffer-structure-and-organization"><span class="header-section-number">6.4</span> Buffer Structure and
Organization</h2>
<h3 data-number="6.4.1" id="the-struct-buffer-srcbuffer.h319-743"><span class="header-section-number">6.4.1</span> The
<code>struct buffer</code> (src/buffer.h:319-743)</h3>
<p>Every buffer in Emacs is represented by a <code>struct buffer</code>.
This is a large structure with two main categories of data:</p>
<ol type="1">
<li><strong>Lisp-visible fields</strong>: Buffer name, filename, modes,
keymaps, etc.</li>
<li><strong>Internal fields</strong>: Text storage, markers, position
tracking, etc.</li>
</ol>
<p><strong>Core fields</strong> (src/buffer.h:319-627):</p>
<div class="sourceCode" id="cb72"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb72-1"><a aria-hidden="true" href="#cb72-1" tabindex="-1"></a><span class="kw">struct</span> buffer</span>
<span id="cb72-2"><a aria-hidden="true" href="#cb72-2" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb72-3"><a aria-hidden="true" href="#cb72-3" tabindex="-1"></a>  <span class="kw">union</span> vectorlike_header header<span class="op">;</span>  <span class="co">/* For Lisp GC */</span></span>
<span id="cb72-4"><a aria-hidden="true" href="#cb72-4" tabindex="-1"></a></span>
<span id="cb72-5"><a aria-hidden="true" href="#cb72-5" tabindex="-1"></a>  <span class="co">/* === Lisp-visible buffer properties === */</span></span>
<span id="cb72-6"><a aria-hidden="true" href="#cb72-6" tabindex="-1"></a>  Lisp_Object name_<span class="op">;</span>              <span class="co">/* Buffer name */</span></span>
<span id="cb72-7"><a aria-hidden="true" href="#cb72-7" tabindex="-1"></a>  Lisp_Object filename_<span class="op">;</span>          <span class="co">/* Visited file name */</span></span>
<span id="cb72-8"><a aria-hidden="true" href="#cb72-8" tabindex="-1"></a>  Lisp_Object directory_<span class="op">;</span>         <span class="co">/* Default directory */</span></span>
<span id="cb72-9"><a aria-hidden="true" href="#cb72-9" tabindex="-1"></a>  Lisp_Object mode_name_<span class="op">;</span>         <span class="co">/* Mode name ("Emacs-Lisp", "C", etc.) */</span></span>
<span id="cb72-10"><a aria-hidden="true" href="#cb72-10" tabindex="-1"></a>  Lisp_Object major_mode_<span class="op">;</span>        <span class="co">/* Major mode symbol */</span></span>
<span id="cb72-11"><a aria-hidden="true" href="#cb72-11" tabindex="-1"></a>  Lisp_Object keymap_<span class="op">;</span>            <span class="co">/* Local keymap */</span></span>
<span id="cb72-12"><a aria-hidden="true" href="#cb72-12" tabindex="-1"></a>  Lisp_Object syntax_table_<span class="op">;</span>      <span class="co">/* Syntax table */</span></span>
<span id="cb72-13"><a aria-hidden="true" href="#cb72-13" tabindex="-1"></a>  Lisp_Object mark_<span class="op">;</span>              <span class="co">/* The mark (a marker) */</span></span>
<span id="cb72-14"><a aria-hidden="true" href="#cb72-14" tabindex="-1"></a>  Lisp_Object local_var_alist_<span class="op">;</span>   <span class="co">/* Buffer-local variables */</span></span>
<span id="cb72-15"><a aria-hidden="true" href="#cb72-15" tabindex="-1"></a></span>
<span id="cb72-16"><a aria-hidden="true" href="#cb72-16" tabindex="-1"></a>  <span class="co">/* === Text storage === */</span></span>
<span id="cb72-17"><a aria-hidden="true" href="#cb72-17" tabindex="-1"></a>  <span class="kw">struct</span> buffer_text own_text<span class="op">;</span>    <span class="co">/* This buffer's text */</span></span>
<span id="cb72-18"><a aria-hidden="true" href="#cb72-18" tabindex="-1"></a>  <span class="kw">struct</span> buffer_text <span class="op">*</span>text<span class="op">;</span>       <span class="co">/* Points to own_text or shared text */</span></span>
<span id="cb72-19"><a aria-hidden="true" href="#cb72-19" tabindex="-1"></a></span>
<span id="cb72-20"><a aria-hidden="true" href="#cb72-20" tabindex="-1"></a>  <span class="co">/* === Position tracking === */</span></span>
<span id="cb72-21"><a aria-hidden="true" href="#cb72-21" tabindex="-1"></a>  <span class="dt">ptrdiff_t</span> pt<span class="op">;</span>                   <span class="co">/* Point (character position) */</span></span>
<span id="cb72-22"><a aria-hidden="true" href="#cb72-22" tabindex="-1"></a>  <span class="dt">ptrdiff_t</span> pt_byte<span class="op">;</span>              <span class="co">/* Point (byte position) */</span></span>
<span id="cb72-23"><a aria-hidden="true" href="#cb72-23" tabindex="-1"></a>  <span class="dt">ptrdiff_t</span> begv<span class="op">;</span>                 <span class="co">/* Beginning of visible region */</span></span>
<span id="cb72-24"><a aria-hidden="true" href="#cb72-24" tabindex="-1"></a>  <span class="dt">ptrdiff_t</span> begv_byte<span class="op">;</span>            <span class="co">/* BEGV in bytes */</span></span>
<span id="cb72-25"><a aria-hidden="true" href="#cb72-25" tabindex="-1"></a>  <span class="dt">ptrdiff_t</span> zv<span class="op">;</span>                   <span class="co">/* End of visible region */</span></span>
<span id="cb72-26"><a aria-hidden="true" href="#cb72-26" tabindex="-1"></a>  <span class="dt">ptrdiff_t</span> zv_byte<span class="op">;</span>              <span class="co">/* ZV in bytes */</span></span>
<span id="cb72-27"><a aria-hidden="true" href="#cb72-27" tabindex="-1"></a></span>
<span id="cb72-28"><a aria-hidden="true" href="#cb72-28" tabindex="-1"></a>  <span class="co">/* === Buffer relationships === */</span></span>
<span id="cb72-29"><a aria-hidden="true" href="#cb72-29" tabindex="-1"></a>  <span class="kw">struct</span> buffer <span class="op">*</span>base_buffer<span class="op">;</span>     <span class="co">/* For indirect buffers */</span></span>
<span id="cb72-30"><a aria-hidden="true" href="#cb72-30" tabindex="-1"></a>  <span class="dt">int</span> indirections<span class="op">;</span>               <span class="co">/* Number of indirect buffers */</span></span>
<span id="cb72-31"><a aria-hidden="true" href="#cb72-31" tabindex="-1"></a>  <span class="dt">int</span> window_count<span class="op">;</span>               <span class="co">/* Number of windows showing this */</span></span>
<span id="cb72-32"><a aria-hidden="true" href="#cb72-32" tabindex="-1"></a></span>
<span id="cb72-33"><a aria-hidden="true" href="#cb72-33" tabindex="-1"></a>  <span class="co">/* === Overlays === */</span></span>
<span id="cb72-34"><a aria-hidden="true" href="#cb72-34" tabindex="-1"></a>  <span class="kw">struct</span> itree_tree <span class="op">*</span>overlays<span class="op">;</span>    <span class="co">/* Interval tree of overlays */</span></span>
<span id="cb72-35"><a aria-hidden="true" href="#cb72-35" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<h3 data-number="6.4.2" id="buffer-allocation-srcbuffer.c595-682"><span class="header-section-number">6.4.2</span> Buffer Allocation
(src/buffer.c:595-682)</h3>
<p>When you create a buffer with <code>get-buffer-create</code>, here‚Äôs
what happens (src/buffer.c:595-682):</p>
<div class="sourceCode" id="cb73"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb73-1"><a aria-hidden="true" href="#cb73-1" tabindex="-1"></a>DEFUN <span class="op">(</span><span class="st">"get-buffer-create"</span><span class="op">,</span> Fget_buffer_create<span class="op">,</span> <span class="op">...)</span></span>
<span id="cb73-2"><a aria-hidden="true" href="#cb73-2" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb73-3"><a aria-hidden="true" href="#cb73-3" tabindex="-1"></a>  <span class="co">// ... check if buffer exists ...</span></span>
<span id="cb73-4"><a aria-hidden="true" href="#cb73-4" tabindex="-1"></a></span>
<span id="cb73-5"><a aria-hidden="true" href="#cb73-5" tabindex="-1"></a>  b <span class="op">=</span> allocate_buffer<span class="op">();</span></span>
<span id="cb73-6"><a aria-hidden="true" href="#cb73-6" tabindex="-1"></a></span>
<span id="cb73-7"><a aria-hidden="true" href="#cb73-7" tabindex="-1"></a>  <span class="co">/* An ordinary buffer uses its own text storage */</span></span>
<span id="cb73-8"><a aria-hidden="true" href="#cb73-8" tabindex="-1"></a>  b<span class="op">-&gt;</span>text <span class="op">=</span> <span class="op">&amp;</span>b<span class="op">-&gt;</span>own_text<span class="op">;</span></span>
<span id="cb73-9"><a aria-hidden="true" href="#cb73-9" tabindex="-1"></a>  b<span class="op">-&gt;</span>base_buffer <span class="op">=</span> NULL<span class="op">;</span></span>
<span id="cb73-10"><a aria-hidden="true" href="#cb73-10" tabindex="-1"></a>  b<span class="op">-&gt;</span>indirections <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb73-11"><a aria-hidden="true" href="#cb73-11" tabindex="-1"></a>  b<span class="op">-&gt;</span>window_count <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb73-12"><a aria-hidden="true" href="#cb73-12" tabindex="-1"></a></span>
<span id="cb73-13"><a aria-hidden="true" href="#cb73-13" tabindex="-1"></a>  <span class="co">/* Allocate gap buffer with initial gap of 20 bytes */</span></span>
<span id="cb73-14"><a aria-hidden="true" href="#cb73-14" tabindex="-1"></a>  BUF_GAP_SIZE <span class="op">(</span>b<span class="op">)</span> <span class="op">=</span> <span class="dv">20</span><span class="op">;</span></span>
<span id="cb73-15"><a aria-hidden="true" href="#cb73-15" tabindex="-1"></a>  alloc_buffer_text <span class="op">(</span>b<span class="op">,</span> BUF_GAP_SIZE <span class="op">(</span>b<span class="op">)</span> <span class="op">+</span> <span class="dv">1</span><span class="op">);</span>  <span class="co">/* +1 for null terminator */</span></span>
<span id="cb73-16"><a aria-hidden="true" href="#cb73-16" tabindex="-1"></a></span>
<span id="cb73-17"><a aria-hidden="true" href="#cb73-17" tabindex="-1"></a>  <span class="co">/* Initialize positions - empty buffer */</span></span>
<span id="cb73-18"><a aria-hidden="true" href="#cb73-18" tabindex="-1"></a>  b<span class="op">-&gt;</span>pt <span class="op">=</span> BEG<span class="op">;</span></span>
<span id="cb73-19"><a aria-hidden="true" href="#cb73-19" tabindex="-1"></a>  b<span class="op">-&gt;</span>begv <span class="op">=</span> BEG<span class="op">;</span></span>
<span id="cb73-20"><a aria-hidden="true" href="#cb73-20" tabindex="-1"></a>  b<span class="op">-&gt;</span>zv <span class="op">=</span> BEG<span class="op">;</span></span>
<span id="cb73-21"><a aria-hidden="true" href="#cb73-21" tabindex="-1"></a>  b<span class="op">-&gt;</span>pt_byte <span class="op">=</span> BEG_BYTE<span class="op">;</span></span>
<span id="cb73-22"><a aria-hidden="true" href="#cb73-22" tabindex="-1"></a>  b<span class="op">-&gt;</span>begv_byte <span class="op">=</span> BEG_BYTE<span class="op">;</span></span>
<span id="cb73-23"><a aria-hidden="true" href="#cb73-23" tabindex="-1"></a>  b<span class="op">-&gt;</span>zv_byte <span class="op">=</span> BEG_BYTE<span class="op">;</span></span>
<span id="cb73-24"><a aria-hidden="true" href="#cb73-24" tabindex="-1"></a></span>
<span id="cb73-25"><a aria-hidden="true" href="#cb73-25" tabindex="-1"></a>  BUF_GPT <span class="op">(</span>b<span class="op">)</span> <span class="op">=</span> BEG<span class="op">;</span></span>
<span id="cb73-26"><a aria-hidden="true" href="#cb73-26" tabindex="-1"></a>  BUF_GPT_BYTE <span class="op">(</span>b<span class="op">)</span> <span class="op">=</span> BEG_BYTE<span class="op">;</span></span>
<span id="cb73-27"><a aria-hidden="true" href="#cb73-27" tabindex="-1"></a>  BUF_Z <span class="op">(</span>b<span class="op">)</span> <span class="op">=</span> BEG<span class="op">;</span></span>
<span id="cb73-28"><a aria-hidden="true" href="#cb73-28" tabindex="-1"></a>  BUF_Z_BYTE <span class="op">(</span>b<span class="op">)</span> <span class="op">=</span> BEG_BYTE<span class="op">;</span></span>
<span id="cb73-29"><a aria-hidden="true" href="#cb73-29" tabindex="-1"></a></span>
<span id="cb73-30"><a aria-hidden="true" href="#cb73-30" tabindex="-1"></a>  <span class="co">/* Initialize modification counters */</span></span>
<span id="cb73-31"><a aria-hidden="true" href="#cb73-31" tabindex="-1"></a>  BUF_MODIFF <span class="op">(</span>b<span class="op">)</span> <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb73-32"><a aria-hidden="true" href="#cb73-32" tabindex="-1"></a>  BUF_CHARS_MODIFF <span class="op">(</span>b<span class="op">)</span> <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb73-33"><a aria-hidden="true" href="#cb73-33" tabindex="-1"></a>  BUF_OVERLAY_MODIFF <span class="op">(</span>b<span class="op">)</span> <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb73-34"><a aria-hidden="true" href="#cb73-34" tabindex="-1"></a>  BUF_SAVE_MODIFF <span class="op">(</span>b<span class="op">)</span> <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb73-35"><a aria-hidden="true" href="#cb73-35" tabindex="-1"></a></span>
<span id="cb73-36"><a aria-hidden="true" href="#cb73-36" tabindex="-1"></a>  <span class="co">/* Put anchor null bytes */</span></span>
<span id="cb73-37"><a aria-hidden="true" href="#cb73-37" tabindex="-1"></a>  <span class="op">*(</span>BUF_GPT_ADDR <span class="op">(</span>b<span class="op">))</span> <span class="op">=</span> <span class="op">*(</span>BUF_Z_ADDR <span class="op">(</span>b<span class="op">))</span> <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb73-38"><a aria-hidden="true" href="#cb73-38" tabindex="-1"></a></span>
<span id="cb73-39"><a aria-hidden="true" href="#cb73-39" tabindex="-1"></a>  <span class="co">// ... set up buffer-local variables ...</span></span>
<span id="cb73-40"><a aria-hidden="true" href="#cb73-40" tabindex="-1"></a></span>
<span id="cb73-41"><a aria-hidden="true" href="#cb73-41" tabindex="-1"></a>  <span class="cf">return</span> buffer<span class="op">;</span></span>
<span id="cb73-42"><a aria-hidden="true" href="#cb73-42" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>Initial state visualization:</strong></p>
<pre><code>Empty buffer:
[GAP: 20 bytes]['\0']
^              ^
BEG,GPT        Z
pt=1, z=1, gap_size=20</code></pre>
<h3 data-number="6.4.3" id="narrowing-and-accessible-region"><span class="header-section-number">6.4.3</span> Narrowing and Accessible
Region</h3>
<p>Emacs supports <strong>narrowing</strong>: restricting editing to a
subset of the buffer. This is tracked by BEGV (beginning of visible) and
ZV (end of visible) (src/buffer.h:40-55):</p>
<pre><code>Full buffer:    [BEG .... BEGV ......... ZV .... Z]
                         ^               ^
                    Visible region (narrowed)</code></pre>
<p>The visible region is the only part accessible to most editing
commands. This enables: - Restricting syntax highlighting to visible
text - Limiting search/replace operations - Implementing ‚Äúwidening‚Äù and
‚Äúnarrowing‚Äù commands</p>
<hr/>
<h2 data-number="6.5" id="text-insertion-and-deletion"><span class="header-section-number">6.5</span> Text Insertion and
Deletion</h2>
<h3 data-number="6.5.1" id="core-insertion-function"><span class="header-section-number">6.5.1</span> Core Insertion Function</h3>
<p>All text insertion ultimately goes through
<code>insert_1_both()</code> (referenced in src/insdel.c:681-691). The
process is:</p>
<ol type="1">
<li><strong>Prepare the buffer</strong> for modification (undo,
read-only checks)</li>
<li><strong>Ensure gap is big enough</strong> (expand if needed)</li>
<li><strong>Move gap to insertion point</strong> (if not already
there)</li>
<li><strong>Copy text into the gap</strong> and adjust gap pointers</li>
<li><strong>Update markers</strong> and text properties</li>
<li><strong>Signal changes</strong> for undo and redisplay</li>
</ol>
<p><strong>Simplified insertion flow:</strong></p>
<div class="sourceCode" id="cb76"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb76-1"><a aria-hidden="true" href="#cb76-1" tabindex="-1"></a><span class="dt">void</span> insert<span class="op">(</span><span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>string<span class="op">,</span> <span class="dt">ptrdiff_t</span> nbytes<span class="op">)</span></span>
<span id="cb76-2"><a aria-hidden="true" href="#cb76-2" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb76-3"><a aria-hidden="true" href="#cb76-3" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>nbytes <span class="op">&gt;</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb76-4"><a aria-hidden="true" href="#cb76-4" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb76-5"><a aria-hidden="true" href="#cb76-5" tabindex="-1"></a>      <span class="dt">ptrdiff_t</span> len <span class="op">=</span> chars_in_text<span class="op">(</span>string<span class="op">,</span> nbytes<span class="op">);</span></span>
<span id="cb76-6"><a aria-hidden="true" href="#cb76-6" tabindex="-1"></a></span>
<span id="cb76-7"><a aria-hidden="true" href="#cb76-7" tabindex="-1"></a>      <span class="co">// Core insertion with:</span></span>
<span id="cb76-8"><a aria-hidden="true" href="#cb76-8" tabindex="-1"></a>      <span class="co">// - string: text to insert</span></span>
<span id="cb76-9"><a aria-hidden="true" href="#cb76-9" tabindex="-1"></a>      <span class="co">// - len: character count</span></span>
<span id="cb76-10"><a aria-hidden="true" href="#cb76-10" tabindex="-1"></a>      <span class="co">// - nbytes: byte count</span></span>
<span id="cb76-11"><a aria-hidden="true" href="#cb76-11" tabindex="-1"></a>      <span class="co">// - inherit=0: don't inherit properties</span></span>
<span id="cb76-12"><a aria-hidden="true" href="#cb76-12" tabindex="-1"></a>      <span class="co">// - prepare=1: prepare buffer for change</span></span>
<span id="cb76-13"><a aria-hidden="true" href="#cb76-13" tabindex="-1"></a>      <span class="co">// - before_markers=0: normal marker adjustment</span></span>
<span id="cb76-14"><a aria-hidden="true" href="#cb76-14" tabindex="-1"></a>      insert_1_both<span class="op">(</span>string<span class="op">,</span> len<span class="op">,</span> nbytes<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb76-15"><a aria-hidden="true" href="#cb76-15" tabindex="-1"></a></span>
<span id="cb76-16"><a aria-hidden="true" href="#cb76-16" tabindex="-1"></a>      <span class="dt">ptrdiff_t</span> opoint <span class="op">=</span> PT <span class="op">-</span> len<span class="op">;</span></span>
<span id="cb76-17"><a aria-hidden="true" href="#cb76-17" tabindex="-1"></a>      signal_after_change<span class="op">(</span>opoint<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> len<span class="op">);</span></span>
<span id="cb76-18"><a aria-hidden="true" href="#cb76-18" tabindex="-1"></a>      update_compositions<span class="op">(</span>opoint<span class="op">,</span> PT<span class="op">,</span> CHECK_BORDER<span class="op">);</span></span>
<span id="cb76-19"><a aria-hidden="true" href="#cb76-19" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb76-20"><a aria-hidden="true" href="#cb76-20" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 data-number="6.5.2" id="making-the-gap-larger-srcinsdel.c467-512"><span class="header-section-number">6.5.2</span> Making the Gap Larger
(src/insdel.c:467-512)</h3>
<p>When there‚Äôs not enough space in the gap for an insertion:</p>
<div class="sourceCode" id="cb77"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb77-1"><a aria-hidden="true" href="#cb77-1" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span></span>
<span id="cb77-2"><a aria-hidden="true" href="#cb77-2" tabindex="-1"></a>make_gap_larger <span class="op">(</span><span class="dt">ptrdiff_t</span> nbytes_added<span class="op">)</span></span>
<span id="cb77-3"><a aria-hidden="true" href="#cb77-3" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb77-4"><a aria-hidden="true" href="#cb77-4" tabindex="-1"></a>  <span class="dt">ptrdiff_t</span> current_size <span class="op">=</span> Z_BYTE <span class="op">-</span> BEG_BYTE <span class="op">+</span> GAP_SIZE<span class="op">;</span></span>
<span id="cb77-5"><a aria-hidden="true" href="#cb77-5" tabindex="-1"></a></span>
<span id="cb77-6"><a aria-hidden="true" href="#cb77-6" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>BUF_BYTES_MAX <span class="op">-</span> current_size <span class="op">&lt;</span> nbytes_added<span class="op">)</span></span>
<span id="cb77-7"><a aria-hidden="true" href="#cb77-7" tabindex="-1"></a>    buffer_overflow<span class="op">();</span></span>
<span id="cb77-8"><a aria-hidden="true" href="#cb77-8" tabindex="-1"></a></span>
<span id="cb77-9"><a aria-hidden="true" href="#cb77-9" tabindex="-1"></a>  <span class="co">/* Get enough space to last a while */</span></span>
<span id="cb77-10"><a aria-hidden="true" href="#cb77-10" tabindex="-1"></a>  nbytes_added <span class="op">=</span> min<span class="op">(</span>nbytes_added <span class="op">+</span> GAP_BYTES_DFL<span class="op">,</span></span>
<span id="cb77-11"><a aria-hidden="true" href="#cb77-11" tabindex="-1"></a>                     BUF_BYTES_MAX <span class="op">-</span> current_size<span class="op">);</span></span>
<span id="cb77-12"><a aria-hidden="true" href="#cb77-12" tabindex="-1"></a></span>
<span id="cb77-13"><a aria-hidden="true" href="#cb77-13" tabindex="-1"></a>  enlarge_buffer_text<span class="op">(</span>current_buffer<span class="op">,</span> nbytes_added<span class="op">);</span></span>
<span id="cb77-14"><a aria-hidden="true" href="#cb77-14" tabindex="-1"></a></span>
<span id="cb77-15"><a aria-hidden="true" href="#cb77-15" tabindex="-1"></a>  <span class="co">/* Prevent quitting during gap manipulation */</span></span>
<span id="cb77-16"><a aria-hidden="true" href="#cb77-16" tabindex="-1"></a>  Vinhibit_quit <span class="op">=</span> Qt<span class="op">;</span></span>
<span id="cb77-17"><a aria-hidden="true" href="#cb77-17" tabindex="-1"></a></span>
<span id="cb77-18"><a aria-hidden="true" href="#cb77-18" tabindex="-1"></a>  <span class="co">/* Move gap to end, add space, move back */</span></span>
<span id="cb77-19"><a aria-hidden="true" href="#cb77-19" tabindex="-1"></a>  real_gap_loc <span class="op">=</span> GPT<span class="op">;</span></span>
<span id="cb77-20"><a aria-hidden="true" href="#cb77-20" tabindex="-1"></a>  GPT <span class="op">=</span> Z <span class="op">+</span> GAP_SIZE<span class="op">;</span></span>
<span id="cb77-21"><a aria-hidden="true" href="#cb77-21" tabindex="-1"></a>  GAP_SIZE <span class="op">=</span> nbytes_added<span class="op">;</span></span>
<span id="cb77-22"><a aria-hidden="true" href="#cb77-22" tabindex="-1"></a>  gap_left<span class="op">(</span>real_gap_loc <span class="op">+</span> old_gap_size<span class="op">,</span> <span class="op">...);</span></span>
<span id="cb77-23"><a aria-hidden="true" href="#cb77-23" tabindex="-1"></a>  GAP_SIZE <span class="op">+=</span> old_gap_size<span class="op">;</span></span>
<span id="cb77-24"><a aria-hidden="true" href="#cb77-24" tabindex="-1"></a></span>
<span id="cb77-25"><a aria-hidden="true" href="#cb77-25" tabindex="-1"></a>  Vinhibit_quit <span class="op">=</span> tem<span class="op">;</span></span>
<span id="cb77-26"><a aria-hidden="true" href="#cb77-26" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>Strategy:</strong> - Add extra space (GAP_BYTES_DFL = 2000
bytes) beyond what‚Äôs immediately needed - This amortizes the cost of
reallocation - For large operations, add space proportional to buffer
size (up to Z/64) - This prevents O(n¬≤) behavior when repeatedly growing
a buffer</p>
<h3 data-number="6.5.3" id="deletion"><span class="header-section-number">6.5.3</span> Deletion</h3>
<p>Deletion is even simpler than insertion (conceptually):</p>
<ol type="1">
<li><strong>Move gap to deletion point</strong></li>
<li><strong>Expand gap to include deleted text</strong></li>
<li><strong>Update markers</strong> to collapse onto deletion point or
move after it</li>
<li><strong>Update text properties</strong></li>
</ol>
<p>The deleted text is now ‚Äúin the gap‚Äù and will be overwritten by
future insertions.</p>
<h3 data-number="6.5.4" id="character-vs.-byte-positions"><span class="header-section-number">6.5.4</span> Character vs.¬†Byte
Positions</h3>
<p>Emacs supports multibyte characters (Unicode), so it tracks both: -
<strong>Character positions</strong>: What users think of as positions
(pt, z, begv, zv) - <strong>Byte positions</strong>: Actual memory
offsets (pt_byte, z_byte, etc.)</p>
<p>In a unibyte buffer, these are identical. In a multibyte buffer: -
ASCII characters: 1 byte each - Unicode characters: 1-4 bytes each
(UTF-8 encoding)</p>
<p><strong>Conversion</strong> is handled by
<code>buf_charpos_to_bytepos()</code> and
<code>buf_bytepos_to_charpos()</code> (src/marker.c:167-421), which use
a clever optimization: they search from the <strong>nearest known
position</strong> (PT, GPT, BEGV, ZV, or markers) rather than always
scanning from the beginning.</p>
<hr/>
<h2 data-number="6.6" id="the-marker-system"><span class="header-section-number">6.6</span> The Marker System</h2>
<h3 data-number="6.6.1" id="what-are-markers"><span class="header-section-number">6.6.1</span> What Are Markers?</h3>
<p>A <strong>marker</strong> is a position in a buffer that
automatically updates when text is inserted or deleted. This is
essential for: - Maintaining point in non-current buffers - Implementing
the mark (for regions) - Tracking positions for overlays and text
properties - Undo system position tracking</p>
<h3 data-number="6.6.2" id="marker-structure-srclisp.h-referenced-in-srcbuffer.h288-295"><span class="header-section-number">6.6.2</span> Marker Structure (src/lisp.h,
referenced in src/buffer.h:288-295)</h3>
<div class="sourceCode" id="cb78"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb78-1"><a aria-hidden="true" href="#cb78-1" tabindex="-1"></a><span class="kw">struct</span> Lisp_Marker</span>
<span id="cb78-2"><a aria-hidden="true" href="#cb78-2" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb78-3"><a aria-hidden="true" href="#cb78-3" tabindex="-1"></a>  <span class="co">/* Core position tracking */</span></span>
<span id="cb78-4"><a aria-hidden="true" href="#cb78-4" tabindex="-1"></a>  <span class="dt">ptrdiff_t</span> charpos<span class="op">;</span>           <span class="co">/* Character position */</span></span>
<span id="cb78-5"><a aria-hidden="true" href="#cb78-5" tabindex="-1"></a>  <span class="dt">ptrdiff_t</span> bytepos<span class="op">;</span>           <span class="co">/* Byte position */</span></span>
<span id="cb78-6"><a aria-hidden="true" href="#cb78-6" tabindex="-1"></a></span>
<span id="cb78-7"><a aria-hidden="true" href="#cb78-7" tabindex="-1"></a>  <span class="co">/* Buffer linkage */</span></span>
<span id="cb78-8"><a aria-hidden="true" href="#cb78-8" tabindex="-1"></a>  <span class="kw">struct</span> buffer <span class="op">*</span>buffer<span class="op">;</span>       <span class="co">/* Which buffer */</span></span>
<span id="cb78-9"><a aria-hidden="true" href="#cb78-9" tabindex="-1"></a>  <span class="kw">struct</span> Lisp_Marker <span class="op">*</span>next<span class="op">;</span>    <span class="co">/* Next marker in buffer's chain */</span></span>
<span id="cb78-10"><a aria-hidden="true" href="#cb78-10" tabindex="-1"></a></span>
<span id="cb78-11"><a aria-hidden="true" href="#cb78-11" tabindex="-1"></a>  <span class="co">/* Behavior flags */</span></span>
<span id="cb78-12"><a aria-hidden="true" href="#cb78-12" tabindex="-1"></a>  bool_bf insertion_type <span class="op">:</span> <span class="dv">1</span><span class="op">;</span>  <span class="co">/* Advance on insertion? */</span></span>
<span id="cb78-13"><a aria-hidden="true" href="#cb78-13" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<p>All markers for a buffer are linked in a singly-linked list starting
from <code>buffer-&gt;text-&gt;markers</code> (src/buffer.h:295).</p>
<h3 data-number="6.6.3" id="marker-adjustment"><span class="header-section-number">6.6.3</span> Marker Adjustment</h3>
<p>When text is inserted or deleted, all markers must be updated. This
is done by functions in src/insdel.c:</p>
<p><strong>For insertion</strong> (src/insdel.c:287-316):</p>
<div class="sourceCode" id="cb79"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb79-1"><a aria-hidden="true" href="#cb79-1" tabindex="-1"></a><span class="dt">void</span> adjust_markers_for_insert<span class="op">(</span><span class="dt">ptrdiff_t</span> from<span class="op">,</span> <span class="dt">ptrdiff_t</span> from_byte<span class="op">,</span></span>
<span id="cb79-2"><a aria-hidden="true" href="#cb79-2" tabindex="-1"></a>                               <span class="dt">ptrdiff_t</span> to<span class="op">,</span> <span class="dt">ptrdiff_t</span> to_byte<span class="op">,</span></span>
<span id="cb79-3"><a aria-hidden="true" href="#cb79-3" tabindex="-1"></a>                               <span class="dt">bool</span> before_markers<span class="op">)</span></span>
<span id="cb79-4"><a aria-hidden="true" href="#cb79-4" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb79-5"><a aria-hidden="true" href="#cb79-5" tabindex="-1"></a>  <span class="kw">struct</span> Lisp_Marker <span class="op">*</span>m<span class="op">;</span></span>
<span id="cb79-6"><a aria-hidden="true" href="#cb79-6" tabindex="-1"></a>  <span class="dt">ptrdiff_t</span> nchars <span class="op">=</span> to <span class="op">-</span> from<span class="op">;</span></span>
<span id="cb79-7"><a aria-hidden="true" href="#cb79-7" tabindex="-1"></a>  <span class="dt">ptrdiff_t</span> nbytes <span class="op">=</span> to_byte <span class="op">-</span> from_byte<span class="op">;</span></span>
<span id="cb79-8"><a aria-hidden="true" href="#cb79-8" tabindex="-1"></a></span>
<span id="cb79-9"><a aria-hidden="true" href="#cb79-9" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span>m <span class="op">=</span> BUF_MARKERS<span class="op">(</span>current_buffer<span class="op">);</span> m<span class="op">;</span> m <span class="op">=</span> m<span class="op">-&gt;</span>next<span class="op">)</span></span>
<span id="cb79-10"><a aria-hidden="true" href="#cb79-10" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb79-11"><a aria-hidden="true" href="#cb79-11" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span>m<span class="op">-&gt;</span>bytepos <span class="op">==</span> from_byte<span class="op">)</span></span>
<span id="cb79-12"><a aria-hidden="true" href="#cb79-12" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb79-13"><a aria-hidden="true" href="#cb79-13" tabindex="-1"></a>          <span class="co">/* At insertion point: advance if marker says so */</span></span>
<span id="cb79-14"><a aria-hidden="true" href="#cb79-14" tabindex="-1"></a>          <span class="cf">if</span> <span class="op">(</span>m<span class="op">-&gt;</span>insertion_type <span class="op">||</span> before_markers<span class="op">)</span></span>
<span id="cb79-15"><a aria-hidden="true" href="#cb79-15" tabindex="-1"></a>            <span class="op">{</span></span>
<span id="cb79-16"><a aria-hidden="true" href="#cb79-16" tabindex="-1"></a>              m<span class="op">-&gt;</span>bytepos <span class="op">=</span> to_byte<span class="op">;</span></span>
<span id="cb79-17"><a aria-hidden="true" href="#cb79-17" tabindex="-1"></a>              m<span class="op">-&gt;</span>charpos <span class="op">=</span> to<span class="op">;</span></span>
<span id="cb79-18"><a aria-hidden="true" href="#cb79-18" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb79-19"><a aria-hidden="true" href="#cb79-19" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb79-20"><a aria-hidden="true" href="#cb79-20" tabindex="-1"></a>      <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>m<span class="op">-&gt;</span>bytepos <span class="op">&gt;</span> from_byte<span class="op">)</span></span>
<span id="cb79-21"><a aria-hidden="true" href="#cb79-21" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb79-22"><a aria-hidden="true" href="#cb79-22" tabindex="-1"></a>          <span class="co">/* After insertion: shift forward */</span></span>
<span id="cb79-23"><a aria-hidden="true" href="#cb79-23" tabindex="-1"></a>          m<span class="op">-&gt;</span>bytepos <span class="op">+=</span> nbytes<span class="op">;</span></span>
<span id="cb79-24"><a aria-hidden="true" href="#cb79-24" tabindex="-1"></a>          m<span class="op">-&gt;</span>charpos <span class="op">+=</span> nchars<span class="op">;</span></span>
<span id="cb79-25"><a aria-hidden="true" href="#cb79-25" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb79-26"><a aria-hidden="true" href="#cb79-26" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb79-27"><a aria-hidden="true" href="#cb79-27" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>For deletion</strong> (src/insdel.c:249-276):</p>
<div class="sourceCode" id="cb80"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb80-1"><a aria-hidden="true" href="#cb80-1" tabindex="-1"></a><span class="dt">void</span> adjust_markers_for_delete<span class="op">(</span><span class="dt">ptrdiff_t</span> from<span class="op">,</span> <span class="dt">ptrdiff_t</span> from_byte<span class="op">,</span></span>
<span id="cb80-2"><a aria-hidden="true" href="#cb80-2" tabindex="-1"></a>                               <span class="dt">ptrdiff_t</span> to<span class="op">,</span> <span class="dt">ptrdiff_t</span> to_byte<span class="op">)</span></span>
<span id="cb80-3"><a aria-hidden="true" href="#cb80-3" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb80-4"><a aria-hidden="true" href="#cb80-4" tabindex="-1"></a>  <span class="kw">struct</span> Lisp_Marker <span class="op">*</span>m<span class="op">;</span></span>
<span id="cb80-5"><a aria-hidden="true" href="#cb80-5" tabindex="-1"></a></span>
<span id="cb80-6"><a aria-hidden="true" href="#cb80-6" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span>m <span class="op">=</span> BUF_MARKERS<span class="op">(</span>current_buffer<span class="op">);</span> m<span class="op">;</span> m <span class="op">=</span> m<span class="op">-&gt;</span>next<span class="op">)</span></span>
<span id="cb80-7"><a aria-hidden="true" href="#cb80-7" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb80-8"><a aria-hidden="true" href="#cb80-8" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span>m<span class="op">-&gt;</span>charpos <span class="op">&gt;</span> to<span class="op">)</span></span>
<span id="cb80-9"><a aria-hidden="true" href="#cb80-9" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb80-10"><a aria-hidden="true" href="#cb80-10" tabindex="-1"></a>          <span class="co">/* After deletion: shift backward */</span></span>
<span id="cb80-11"><a aria-hidden="true" href="#cb80-11" tabindex="-1"></a>          m<span class="op">-&gt;</span>charpos <span class="op">-=</span> to <span class="op">-</span> from<span class="op">;</span></span>
<span id="cb80-12"><a aria-hidden="true" href="#cb80-12" tabindex="-1"></a>          m<span class="op">-&gt;</span>bytepos <span class="op">-=</span> to_byte <span class="op">-</span> from_byte<span class="op">;</span></span>
<span id="cb80-13"><a aria-hidden="true" href="#cb80-13" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb80-14"><a aria-hidden="true" href="#cb80-14" tabindex="-1"></a>      <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>m<span class="op">-&gt;</span>charpos <span class="op">&gt;</span> from<span class="op">)</span></span>
<span id="cb80-15"><a aria-hidden="true" href="#cb80-15" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb80-16"><a aria-hidden="true" href="#cb80-16" tabindex="-1"></a>          <span class="co">/* Inside deletion: collapse to deletion point */</span></span>
<span id="cb80-17"><a aria-hidden="true" href="#cb80-17" tabindex="-1"></a>          m<span class="op">-&gt;</span>charpos <span class="op">=</span> from<span class="op">;</span></span>
<span id="cb80-18"><a aria-hidden="true" href="#cb80-18" tabindex="-1"></a>          m<span class="op">-&gt;</span>bytepos <span class="op">=</span> from_byte<span class="op">;</span></span>
<span id="cb80-19"><a aria-hidden="true" href="#cb80-19" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb80-20"><a aria-hidden="true" href="#cb80-20" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb80-21"><a aria-hidden="true" href="#cb80-21" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 data-number="6.6.4" id="position-caching-with-markers"><span class="header-section-number">6.6.4</span> Position Caching with
Markers</h3>
<p>A clever optimization: when converting between character and byte
positions (src/marker.c:167-270), the system searches through
<strong>existing markers</strong> to find one close to the target
position. If the search covered a long distance (&gt;5000 positions), it
<strong>creates a new marker</strong> to cache that position for future
lookups.</p>
<p>These cache markers are temporary and get garbage collected normally,
but while they exist, they dramatically speed up repeated position
conversions.</p>
<hr/>
<h2 data-number="6.7" id="text-properties-and-intervals"><span class="header-section-number">6.7</span> Text Properties and
Intervals</h2>
<h3 data-number="6.7.1" id="concept-1"><span class="header-section-number">6.7.1</span> Concept</h3>
<p><strong>Text properties</strong> allow attaching arbitrary data to
ranges of text: - Font faces for syntax highlighting - Mouse click
handlers - Help text tooltips - Read-only regions - Invisible text</p>
<p>The challenge: efficiently storing and querying properties for
potentially millions of characters.</p>
<h3 data-number="6.7.2" id="the-interval-tree-data-structure"><span class="header-section-number">6.7.2</span> The Interval Tree Data
Structure</h3>
<p>Emacs uses a specialized balanced binary tree where each node (an
‚Äúinterval‚Äù) represents a contiguous range of text with identical
properties (src/intervals.h:29-66):</p>
<div class="sourceCode" id="cb81"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb81-1"><a aria-hidden="true" href="#cb81-1" tabindex="-1"></a><span class="kw">struct</span> interval</span>
<span id="cb81-2"><a aria-hidden="true" href="#cb81-2" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb81-3"><a aria-hidden="true" href="#cb81-3" tabindex="-1"></a>  <span class="co">/* Tree structure */</span></span>
<span id="cb81-4"><a aria-hidden="true" href="#cb81-4" tabindex="-1"></a>  <span class="dt">ptrdiff_t</span> total_length<span class="op">;</span>      <span class="co">/* Length of this + children */</span></span>
<span id="cb81-5"><a aria-hidden="true" href="#cb81-5" tabindex="-1"></a>  <span class="dt">ptrdiff_t</span> position<span class="op">;</span>          <span class="co">/* Cache of character position */</span></span>
<span id="cb81-6"><a aria-hidden="true" href="#cb81-6" tabindex="-1"></a>  <span class="kw">struct</span> interval <span class="op">*</span>left<span class="op">;</span>       <span class="co">/* Preceding intervals */</span></span>
<span id="cb81-7"><a aria-hidden="true" href="#cb81-7" tabindex="-1"></a>  <span class="kw">struct</span> interval <span class="op">*</span>right<span class="op">;</span>      <span class="co">/* Following intervals */</span></span>
<span id="cb81-8"><a aria-hidden="true" href="#cb81-8" tabindex="-1"></a></span>
<span id="cb81-9"><a aria-hidden="true" href="#cb81-9" tabindex="-1"></a>  <span class="co">/* Parent (either another interval or the containing object) */</span></span>
<span id="cb81-10"><a aria-hidden="true" href="#cb81-10" tabindex="-1"></a>  <span class="kw">union</span> <span class="op">{</span></span>
<span id="cb81-11"><a aria-hidden="true" href="#cb81-11" tabindex="-1"></a>    <span class="kw">struct</span> interval <span class="op">*</span>interval<span class="op">;</span></span>
<span id="cb81-12"><a aria-hidden="true" href="#cb81-12" tabindex="-1"></a>    Lisp_Object obj<span class="op">;</span>           <span class="co">/* Buffer or string */</span></span>
<span id="cb81-13"><a aria-hidden="true" href="#cb81-13" tabindex="-1"></a>  <span class="op">}</span> up<span class="op">;</span></span>
<span id="cb81-14"><a aria-hidden="true" href="#cb81-14" tabindex="-1"></a>  bool_bf up_obj <span class="op">:</span> <span class="dv">1</span><span class="op">;</span>          <span class="co">/* Is parent an object? */</span></span>
<span id="cb81-15"><a aria-hidden="true" href="#cb81-15" tabindex="-1"></a></span>
<span id="cb81-16"><a aria-hidden="true" href="#cb81-16" tabindex="-1"></a>  <span class="co">/* Cached property flags (for speed) */</span></span>
<span id="cb81-17"><a aria-hidden="true" href="#cb81-17" tabindex="-1"></a>  bool_bf write_protect <span class="op">:</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb81-18"><a aria-hidden="true" href="#cb81-18" tabindex="-1"></a>  bool_bf visible <span class="op">:</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb81-19"><a aria-hidden="true" href="#cb81-19" tabindex="-1"></a>  bool_bf front_sticky <span class="op">:</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb81-20"><a aria-hidden="true" href="#cb81-20" tabindex="-1"></a>  bool_bf rear_sticky <span class="op">:</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb81-21"><a aria-hidden="true" href="#cb81-21" tabindex="-1"></a></span>
<span id="cb81-22"><a aria-hidden="true" href="#cb81-22" tabindex="-1"></a>  <span class="co">/* The actual properties */</span></span>
<span id="cb81-23"><a aria-hidden="true" href="#cb81-23" tabindex="-1"></a>  Lisp_Object plist<span class="op">;</span>           <span class="co">/* Property list */</span></span>
<span id="cb81-24"><a aria-hidden="true" href="#cb81-24" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<p><strong>Visual representation:</strong></p>
<pre><code>Text: "Hello world"
Properties:
  [0-5):  face=bold
  [5-6):  no properties
  [6-11): face=italic

Interval tree:
         [0-11: total_len=11]
              /          \
    [0-5: bold]          [5-11]
                        /      \
                  [5-6: nil]  [6-11: italic]</code></pre>
<h3 data-number="6.7.3" id="key-invariants-srcintervals.h99-119"><span class="header-section-number">6.7.3</span> Key Invariants
(src/intervals.h:99-119)</h3>
<div class="sourceCode" id="cb83"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb83-1"><a aria-hidden="true" href="#cb83-1" tabindex="-1"></a><span class="co">/* Total length includes self and all children */</span></span>
<span id="cb83-2"><a aria-hidden="true" href="#cb83-2" tabindex="-1"></a><span class="pp">#define TOTAL_LENGTH</span><span class="op">(</span><span class="pp">i</span><span class="op">)</span><span class="pp"> </span><span class="op">((</span><span class="pp">i</span><span class="op">)-&gt;</span><span class="pp">total_length</span><span class="op">)</span></span>
<span id="cb83-3"><a aria-hidden="true" href="#cb83-3" tabindex="-1"></a></span>
<span id="cb83-4"><a aria-hidden="true" href="#cb83-4" tabindex="-1"></a><span class="co">/* Length of this interval alone */</span></span>
<span id="cb83-5"><a aria-hidden="true" href="#cb83-5" tabindex="-1"></a><span class="pp">#define LENGTH</span><span class="op">(</span><span class="pp">i</span><span class="op">)</span><span class="pp"> </span><span class="op">(</span><span class="pp">TOTAL_LENGTH</span><span class="op">(</span><span class="pp">i</span><span class="op">)</span><span class="pp">     </span><span class="op">\</span></span>
<span id="cb83-6"><a aria-hidden="true" href="#cb83-6" tabindex="-1"></a><span class="pp">                   </span><span class="op">-</span><span class="pp"> </span>RIGHT_TOTAL_LENGTH<span class="op">(</span><span class="pp">i</span><span class="op">)</span><span class="pp"> </span><span class="op">\</span></span>
<span id="cb83-7"><a aria-hidden="true" href="#cb83-7" tabindex="-1"></a><span class="pp">                   </span><span class="op">-</span><span class="pp"> </span>LEFT_TOTAL_LENGTH<span class="op">(</span><span class="pp">i</span><span class="op">))</span></span></code></pre></div>
<p>The tree is kept <strong>balanced</strong> through rotations
(src/intervals.c:269-300+), ensuring O(log n) operations.</p>
<h3 data-number="6.7.4" id="interval-operations"><span class="header-section-number">6.7.4</span> Interval Operations</h3>
<p><strong>Finding an interval</strong> at a position (src/intervals.c,
referenced in src/intervals.h:262):</p>
<div class="sourceCode" id="cb84"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb84-1"><a aria-hidden="true" href="#cb84-1" tabindex="-1"></a>INTERVAL find_interval<span class="op">(</span>INTERVAL tree<span class="op">,</span> <span class="dt">ptrdiff_t</span> position<span class="op">)</span></span>
<span id="cb84-2"><a aria-hidden="true" href="#cb84-2" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb84-3"><a aria-hidden="true" href="#cb84-3" tabindex="-1"></a>  <span class="co">/* Binary search through the tree */</span></span>
<span id="cb84-4"><a aria-hidden="true" href="#cb84-4" tabindex="-1"></a>  <span class="cf">while</span> <span class="op">(!</span>LEAF_INTERVAL_P<span class="op">(</span>tree<span class="op">))</span></span>
<span id="cb84-5"><a aria-hidden="true" href="#cb84-5" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb84-6"><a aria-hidden="true" href="#cb84-6" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span>position <span class="op">&lt;</span> LEFT_TOTAL_LENGTH<span class="op">(</span>tree<span class="op">))</span></span>
<span id="cb84-7"><a aria-hidden="true" href="#cb84-7" tabindex="-1"></a>        tree <span class="op">=</span> tree<span class="op">-&gt;</span>left<span class="op">;</span></span>
<span id="cb84-8"><a aria-hidden="true" href="#cb84-8" tabindex="-1"></a>      <span class="cf">else</span></span>
<span id="cb84-9"><a aria-hidden="true" href="#cb84-9" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb84-10"><a aria-hidden="true" href="#cb84-10" tabindex="-1"></a>          position <span class="op">-=</span> LEFT_TOTAL_LENGTH<span class="op">(</span>tree<span class="op">)</span> <span class="op">+</span> LENGTH<span class="op">(</span>tree<span class="op">);</span></span>
<span id="cb84-11"><a aria-hidden="true" href="#cb84-11" tabindex="-1"></a>          tree <span class="op">=</span> tree<span class="op">-&gt;</span>right<span class="op">;</span></span>
<span id="cb84-12"><a aria-hidden="true" href="#cb84-12" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb84-13"><a aria-hidden="true" href="#cb84-13" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb84-14"><a aria-hidden="true" href="#cb84-14" tabindex="-1"></a>  <span class="cf">return</span> tree<span class="op">;</span></span>
<span id="cb84-15"><a aria-hidden="true" href="#cb84-15" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>Splitting an interval</strong> (src/intervals.h:259-261) when
inserting text with different properties creates new tree nodes and
rebalances.</p>
<p><strong>Merging adjacent intervals</strong> (src/intervals.h:265)
with identical properties saves memory and speeds up searches.</p>
<h3 data-number="6.7.5" id="property-inheritance-and-stickiness"><span class="header-section-number">6.7.5</span> Property Inheritance and
Stickiness</h3>
<p>When you insert text at a boundary between two intervals, which
properties should the new text inherit? This is controlled by
<strong>stickiness</strong> (src/intervals.h:62-64):</p>
<ul>
<li><code>front_sticky</code>: Properties stick to text inserted before
the interval</li>
<li><code>rear_sticky</code>: Properties stick to text inserted after
the interval</li>
</ul>
<p>Example:</p>
<pre><code>Text: "AB"
      [A: face=bold, front_sticky=true]
      [B: face=italic]

Insert "X" between A and B:
Result: "AXB"
        [AX: face=bold]  ‚Üê X inherited bold because of front_sticky
        [B: face=italic]</code></pre>
<hr/>
<h2 data-number="6.8" id="buffer-local-variables"><span class="header-section-number">6.8</span> Buffer-Local Variables</h2>
<h3 data-number="6.8.1" id="concept-2"><span class="header-section-number">6.8.1</span> Concept</h3>
<p>Most Emacs Lisp variables have a single global value. But some
variables can have different values in different buffers. Examples: -
<code>major-mode</code>: C-mode vs.¬†Lisp-mode vs.¬†Text-mode -
<code>tab-width</code>: Different indentation per buffer -
<code>case-fold-search</code>: Case-sensitive search in some buffers</p>
<h3 data-number="6.8.2" id="implementation-strategy"><span class="header-section-number">6.8.2</span> Implementation Strategy</h3>
<p>Emacs uses two approaches for buffer-local variables:</p>
<ol type="1">
<li><strong>Built-in per-buffer variables</strong> (‚â§50 variables):
Stored directly in <code>struct buffer</code></li>
<li><strong>Lisp-level buffer-local variables</strong> (unlimited):
Stored in <code>local_var_alist</code></li>
</ol>
<h3 data-number="6.8.3" id="built-in-per-buffer-variables-srcbuffer.h310-643"><span class="header-section-number">6.8.3</span> Built-in Per-Buffer Variables
(src/buffer.h:310-643)</h3>
<p>The most commonly used buffer-local variables are stored as actual
fields in <code>struct buffer</code>:</p>
<div class="sourceCode" id="cb86"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb86-1"><a aria-hidden="true" href="#cb86-1" tabindex="-1"></a><span class="kw">struct</span> buffer</span>
<span id="cb86-2"><a aria-hidden="true" href="#cb86-2" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb86-3"><a aria-hidden="true" href="#cb86-3" tabindex="-1"></a>  <span class="co">// ... many fields ...</span></span>
<span id="cb86-4"><a aria-hidden="true" href="#cb86-4" tabindex="-1"></a>  Lisp_Object mode_line_format_<span class="op">;</span></span>
<span id="cb86-5"><a aria-hidden="true" href="#cb86-5" tabindex="-1"></a>  Lisp_Object abbrev_mode_<span class="op">;</span></span>
<span id="cb86-6"><a aria-hidden="true" href="#cb86-6" tabindex="-1"></a>  Lisp_Object tab_width_<span class="op">;</span></span>
<span id="cb86-7"><a aria-hidden="true" href="#cb86-7" tabindex="-1"></a>  Lisp_Object fill_column_<span class="op">;</span></span>
<span id="cb86-8"><a aria-hidden="true" href="#cb86-8" tabindex="-1"></a>  Lisp_Object syntax_table_<span class="op">;</span></span>
<span id="cb86-9"><a aria-hidden="true" href="#cb86-9" tabindex="-1"></a>  <span class="co">// ... etc ...</span></span>
<span id="cb86-10"><a aria-hidden="true" href="#cb86-10" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<p><strong>Note the trailing underscore:</strong> You access these
through the <code>BVAR()</code> macro (src/buffer.h:308):</p>
<div class="sourceCode" id="cb87"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb87-1"><a aria-hidden="true" href="#cb87-1" tabindex="-1"></a><span class="pp">#define BVAR</span><span class="op">(</span><span class="pp">buf</span><span class="op">,</span><span class="pp"> field</span><span class="op">)</span><span class="pp"> </span><span class="op">((</span><span class="pp">buf</span><span class="op">)-&gt;</span><span class="pp">field </span><span class="op">##</span><span class="pp"> _</span><span class="op">)</span></span>
<span id="cb87-2"><a aria-hidden="true" href="#cb87-2" tabindex="-1"></a></span>
<span id="cb87-3"><a aria-hidden="true" href="#cb87-3" tabindex="-1"></a><span class="co">// Usage:</span></span>
<span id="cb87-4"><a aria-hidden="true" href="#cb87-4" tabindex="-1"></a>BVAR<span class="op">(</span>current_buffer<span class="op">,</span> mode_line_format<span class="op">)</span>  <span class="co">// ‚Üí current_buffer-&gt;mode_line_format_</span></span></code></pre></div>
<p>This indirection allows future refactoring of storage without
changing call sites.</p>
<h3 data-number="6.8.4" id="the-per-buffer-index-system"><span class="header-section-number">6.8.4</span> The Per-Buffer Index
System</h3>
<p>Each built-in per-buffer variable has an <strong>index</strong>
stored in <code>buffer_local_flags</code> (src/buffer.c:89). This index
is used in the <code>local_flags</code> array (src/buffer.h:643) to
track whether a buffer has overridden the default:</p>
<div class="sourceCode" id="cb88"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb88-1"><a aria-hidden="true" href="#cb88-1" tabindex="-1"></a><span class="co">/* In struct buffer: */</span></span>
<span id="cb88-2"><a aria-hidden="true" href="#cb88-2" tabindex="-1"></a><span class="dt">char</span> local_flags<span class="op">[</span>MAX_PER_BUFFER_VARS<span class="op">];</span>  <span class="co">// 50 elements</span></span>
<span id="cb88-3"><a aria-hidden="true" href="#cb88-3" tabindex="-1"></a></span>
<span id="cb88-4"><a aria-hidden="true" href="#cb88-4" tabindex="-1"></a><span class="co">/* Usage: */</span></span>
<span id="cb88-5"><a aria-hidden="true" href="#cb88-5" tabindex="-1"></a><span class="cf">if</span> <span class="op">(</span>PER_BUFFER_VALUE_P<span class="op">(</span>buffer<span class="op">,</span> idx<span class="op">))</span></span>
<span id="cb88-6"><a aria-hidden="true" href="#cb88-6" tabindex="-1"></a>  <span class="co">/* This buffer has a local value for variable idx */</span></span>
<span id="cb88-7"><a aria-hidden="true" href="#cb88-7" tabindex="-1"></a><span class="cf">else</span></span>
<span id="cb88-8"><a aria-hidden="true" href="#cb88-8" tabindex="-1"></a>  <span class="co">/* Use default from buffer_defaults */</span></span></code></pre></div>
<h3 data-number="6.8.5" id="lisp-level-buffer-local-variables-srcbuffer.h362"><span class="header-section-number">6.8.5</span> Lisp-Level Buffer-Local
Variables (src/buffer.h:362)</h3>
<p>For variables not built into the structure:</p>
<div class="sourceCode" id="cb89"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb89-1"><a aria-hidden="true" href="#cb89-1" tabindex="-1"></a>Lisp_Object local_var_alist_<span class="op">;</span>  <span class="co">/* Alist of (SYMBOL . VALUE) */</span></span></code></pre></div>
<p>When you do <code>(make-variable-buffer-local 'foo)</code> or
<code>(setq-local foo value)</code>, the variable is added to this alist
for the current buffer.</p>
<h3 data-number="6.8.6" id="default-values-srcbuffer.c70"><span class="header-section-number">6.8.6</span> Default Values
(src/buffer.c:70)</h3>
<div class="sourceCode" id="cb90"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb90-1"><a aria-hidden="true" href="#cb90-1" tabindex="-1"></a><span class="kw">struct</span> buffer buffer_defaults<span class="op">;</span></span></code></pre></div>
<p>This is a global <code>struct buffer</code> that holds default
values. When a buffer doesn‚Äôt have a local value for a variable, it uses
the value from <code>buffer_defaults</code>.</p>
<hr/>
<h2 data-number="6.9" id="buffers-and-windows"><span class="header-section-number">6.9</span> Buffers and Windows</h2>
<h3 data-number="6.9.1" id="conceptual-relationship"><span class="header-section-number">6.9.1</span> Conceptual Relationship</h3>
<p>A <strong>buffer</strong> holds text. A <strong>window</strong>
displays a buffer. The relationship is many-to-many: - One buffer can be
displayed in multiple windows - One window displays exactly one buffer
at a time - A buffer can exist without being displayed in any window</p>
<h3 data-number="6.9.2" id="tracking-window-display-srcbuffer.h634-636"><span class="header-section-number">6.9.2</span> Tracking Window Display
(src/buffer.h:634-636)</h3>
<div class="sourceCode" id="cb91"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb91-1"><a aria-hidden="true" href="#cb91-1" tabindex="-1"></a><span class="kw">struct</span> buffer</span>
<span id="cb91-2"><a aria-hidden="true" href="#cb91-2" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb91-3"><a aria-hidden="true" href="#cb91-3" tabindex="-1"></a>  <span class="dt">int</span> window_count<span class="op">;</span>  <span class="co">/* Number of windows showing this buffer */</span></span>
<span id="cb91-4"><a aria-hidden="true" href="#cb91-4" tabindex="-1"></a>  <span class="co">// ...</span></span>
<span id="cb91-5"><a aria-hidden="true" href="#cb91-5" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<p>This counter is updated by the window system when windows are
created/deleted or their buffers changed.</p>
<h3 data-number="6.9.3" id="point-in-non-current-buffers"><span class="header-section-number">6.9.3</span> Point in Non-Current
Buffers</h3>
<p><strong>Challenge:</strong> Point (PT) is a single position, but a
buffer might be displayed in multiple windows with different points.</p>
<p><strong>Solution:</strong> Each window has its own
<code>pointm</code> marker (src/window.h). When a buffer is not current:
- Its PT is saved to <code>pt_marker</code> (src/buffer.h:492) - Each
window showing it has its own point in its <code>pointm</code></p>
<p>When you switch to a buffer in a window: 1. Current buffer‚Äôs PT ‚Üí
saved to current window‚Äôs <code>pointm</code> 2. New buffer‚Äôs
<code>pt_marker</code> ‚Üí restored to PT (if buffer wasn‚Äôt current) 3. Or
window‚Äôs <code>pointm</code> ‚Üí PT (if buffer was already current
elsewhere)</p>
<h3 data-number="6.9.4" id="indirect-buffers-srcbuffer.h599-632"><span class="header-section-number">6.9.4</span> Indirect Buffers
(src/buffer.h:599-632)</h3>
<p>An <strong>indirect buffer</strong> shares text storage with a
<strong>base buffer</strong>:</p>
<div class="sourceCode" id="cb92"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb92-1"><a aria-hidden="true" href="#cb92-1" tabindex="-1"></a><span class="kw">struct</span> buffer</span>
<span id="cb92-2"><a aria-hidden="true" href="#cb92-2" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb92-3"><a aria-hidden="true" href="#cb92-3" tabindex="-1"></a>  <span class="kw">struct</span> buffer_text own_text<span class="op">;</span>     <span class="co">/* Storage for ordinary buffers */</span></span>
<span id="cb92-4"><a aria-hidden="true" href="#cb92-4" tabindex="-1"></a>  <span class="kw">struct</span> buffer_text <span class="op">*</span>text<span class="op">;</span>        <span class="co">/* Points to own_text or base-&gt;own_text */</span></span>
<span id="cb92-5"><a aria-hidden="true" href="#cb92-5" tabindex="-1"></a></span>
<span id="cb92-6"><a aria-hidden="true" href="#cb92-6" tabindex="-1"></a>  <span class="kw">struct</span> buffer <span class="op">*</span>base_buffer<span class="op">;</span>      <span class="co">/* NULL for ordinary buffers */</span></span>
<span id="cb92-7"><a aria-hidden="true" href="#cb92-7" tabindex="-1"></a>  <span class="dt">int</span> indirections<span class="op">;</span>                <span class="co">/* Count of indirect buffers sharing our text */</span></span>
<span id="cb92-8"><a aria-hidden="true" href="#cb92-8" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<p><strong>Uses:</strong> - Multiple views of the same text with
different narrowing - Different modes on the same text (e.g., C mode
vs.¬†text mode) - Avoiding text duplication</p>
<p><strong>Key point:</strong> Indirect buffers share: - Text content -
Markers - Text properties</p>
<p>But have separate: - Point, mark, narrowing - Major mode -
Buffer-local variables</p>
<hr/>
<h2 data-number="6.10" id="the-elisp-layer"><span class="header-section-number">6.10</span> The Elisp Layer</h2>
<h3 data-number="6.10.1" id="buffer-menu-lispbuff-menu.el"><span class="header-section-number">6.10.1</span> Buffer Menu
(lisp/buff-menu.el)</h3>
<p>The traditional buffer list (<code>C-x C-b</code>) is implemented in
buff-menu.el. It uses <code>tabulated-list-mode</code> to display: -
Buffer names - Sizes - Modes - Associated files</p>
<p><strong>Key structure</strong> (lisp/buff-menu.el:165-200):</p>
<pre class="elisp"><code>(defvar-keymap Buffer-menu-mode-map
  :doc "Local keymap for Buffer-menu-mode buffers."
  :parent tabulated-list-mode-map
  "d"   #'Buffer-menu-delete      ; Mark for deletion
  "s"   #'Buffer-menu-save        ; Save buffer
  "x"   #'Buffer-menu-execute     ; Execute marks
  "f"   #'Buffer-menu-this-window ; Visit buffer
  ;; ... many more commands ...
  )</code></pre>
<h3 data-number="6.10.2" id="ibuffer-lispibuffer.el"><span class="header-section-number">6.10.2</span> IBuffer
(lisp/ibuffer.el)</h3>
<p>IBuffer is an advanced buffer list with: -
<strong>Filtering</strong>: Show only buffers matching criteria -
<strong>Grouping</strong>: Organize by mode, directory, etc. -
<strong>Marking</strong>: Dired-like bulk operations</p>
<p><strong>Design</strong> (lisp/ibuffer.el:86-154):</p>
<pre class="elisp"><code>(defcustom ibuffer-formats
  '((mark modified read-only locked
          " " (name 18 18 :left :elide)
          " " (size 9 -1 :right)
          " " (mode 16 16 :left :elide)
          " " filename-and-process))
  "List of ways to display buffer lines.
Each format specifies columns to display...")</code></pre>
<p>The format is extensible through <code>define-ibuffer-column</code>,
allowing users to add custom columns.</p>
<h3 data-number="6.10.3" id="basic-editing-commands-lispsimple.el"><span class="header-section-number">6.10.3</span> Basic Editing Commands
(lisp/simple.el)</h3>
<p>simple.el contains fundamental editing operations that work with
buffers: - Movement: <code>beginning-of-line</code>,
<code>end-of-line</code>, <code>forward-word</code> - Insertion:
<code>newline</code>, <code>self-insert-command</code> - Deletion:
<code>delete-backward-char</code>, <code>delete-forward-char</code> -
Killing: <code>kill-line</code>, <code>kill-region</code></p>
<p>These are mostly thin wrappers around C primitives, but add: -
Interactive specifications (for <code>M-x</code> and keybindings) -
Argument handling (prefix arguments) - Integration with kill ring, undo,
etc.</p>
<hr/>
<h2 data-number="6.11" id="design-rationale"><span class="header-section-number">6.11</span> Design Rationale</h2>
<h3 data-number="6.11.1" id="why-the-gap-buffer"><span class="header-section-number">6.11.1</span> Why the Gap Buffer?</h3>
<p><strong>Alternatives considered:</strong> 1. <strong>Simple
array</strong>: O(n) insertion/deletion 2. <strong>Linked list</strong>:
O(1) insertion/deletion but poor cache locality 3. <strong>Rope</strong>
(tree of strings): Complex, good for large files 4. <strong>Piece
table</strong>: Good for undo, used by some editors</p>
<p><strong>Why gap buffer wins for Emacs:</strong> - Interactive editing
is usually localized (typing in one spot) - Gap moves to edit point ‚Üí
O(1) for common case - Simple implementation (critical for 1980s) -
Excellent cache locality for sequential access - Easy to implement
multibyte character support</p>
<h3 data-number="6.11.2" id="why-separate-character-and-byte-positions"><span class="header-section-number">6.11.2</span> Why Separate Character and
Byte Positions?</h3>
<p>Before Unicode, Emacs used only character positions. With multibyte
support: - <strong>Option 1</strong>: Convert on every access (too slow)
- <strong>Option 2</strong>: Track both positions everywhere (chosen
approach)</p>
<p>The dual tracking adds complexity but enables: - Fast memory access
(use byte positions) - Correct character semantics (use char positions)
- Optimization: in unibyte buffers, they‚Äôre identical</p>
<h3 data-number="6.11.3" id="why-intervals-instead-of-simpler-property-storage"><span class="header-section-number">6.11.3</span> Why Intervals Instead of
Simpler Property Storage?</h3>
<p><strong>Alternatives:</strong> 1. <strong>Property per
character</strong>: Too much memory (millions of characters) 2.
<strong>Hash table of ranges</strong>: Hard to update efficiently 3.
<strong>Interval tree</strong> (chosen): Automatic merging of adjacent
identical properties</p>
<p><strong>Benefits:</strong> - O(log n) queries - Automatic memory
optimization (merging) - Efficient updates (splitting/merging only
what‚Äôs needed)</p>
<p>The complexity is high but unavoidable given the requirements: -
Millions of characters - Hundreds of thousands of properties (syntax
highlighting, etc.) - Interactive responsiveness</p>
<h3 data-number="6.11.4" id="why-buffer-local-variables"><span class="header-section-number">6.11.4</span> Why Buffer-Local
Variables?</h3>
<p>Modes need different behavior in different buffers. Options: 1.
<strong>Global variables</strong>: Doesn‚Äôt work (conflicts between
buffers) 2. <strong>Object-oriented</strong>: Each mode is an object
with methods 3. <strong>Buffer-local variables</strong> (chosen):
Lisp-friendly, flexible</p>
<p>The current design allows: - Gradual migration (start global, make
buffer-local as needed) - Easy customization (same variable name
everywhere) - Efficient built-in variables (in struct buffer) -
Unlimited Lisp-level variables (in alist)</p>
<hr/>
<h2 data-number="6.12" id="summary-key-insights"><span class="header-section-number">6.12</span> Summary: Key Insights</h2>
<h3 data-number="6.12.1" id="data-structure-hierarchy"><span class="header-section-number">6.12.1</span> Data Structure
Hierarchy</h3>
<pre><code>struct buffer                  (The buffer object)
  ‚îú‚îÄ struct buffer_text        (Gap buffer storage)
  ‚îÇ   ‚îú‚îÄ unsigned char *beg    (Actual memory)
  ‚îÇ   ‚îú‚îÄ gap position/size     (Gap metadata)
  ‚îÇ   ‚îú‚îÄ INTERVAL intervals    (Property tree root)
  ‚îÇ   ‚îî‚îÄ Lisp_Marker *markers  (Marker chain)
  ‚îú‚îÄ Position state            (pt, begv, zv)
  ‚îú‚îÄ Buffer-local vars         (Built-in + alist)
  ‚îî‚îÄ Display state             (windows, overlays)</code></pre>
<h3 data-number="6.12.2" id="critical-invariants"><span class="header-section-number">6.12.2</span> Critical Invariants</h3>
<ol type="1">
<li><strong>Gap invariant</strong>: <code>text-&gt;beg</code> always
points to allocated memory containing all buffer text except the
gap</li>
<li><strong>Position ordering</strong>:
<code>BEG ‚â§ BEGV ‚â§ PT ‚â§ ZV ‚â§ Z</code></li>
<li><strong>Byte/char relationship</strong>: In unibyte buffers,
char_pos == byte_pos</li>
<li><strong>Modification counts</strong>: Incremented on every change,
used for:
<ul>
<li>Undo system</li>
<li>Display optimization</li>
<li>Cache invalidation</li>
</ul></li>
</ol>
<h3 data-number="6.12.3" id="performance-characteristics"><span class="header-section-number">6.12.3</span> Performance
Characteristics</h3>
<table>
<colgroup>
<col style="width: 37%"/>
<col style="width: 37%"/>
<col style="width: 24%"/>
</colgroup>
<thead>
<tr>
<th>Operation</th>
<th>Complexity</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td>Insert at point</td>
<td>O(1) amortized</td>
<td>Gap is already there</td>
</tr>
<tr>
<td>Insert elsewhere</td>
<td>O(n)</td>
<td>Must move gap</td>
</tr>
<tr>
<td>Delete at point</td>
<td>O(1)</td>
<td>Expand gap</td>
</tr>
<tr>
<td>Find marker at position</td>
<td>O(m)</td>
<td>m = # of markers</td>
</tr>
<tr>
<td>Get text property</td>
<td>O(log n)</td>
<td>Interval tree search</td>
</tr>
<tr>
<td>Convert char‚ÜîÔ∏ébyte pos</td>
<td>O(m + d)</td>
<td>m = marker search, d = distance to scan</td>
</tr>
</tbody>
</table>
<h3 data-number="6.12.4" id="code-organization"><span class="header-section-number">6.12.4</span> Code Organization</h3>
<table>
<thead>
<tr>
<th>File</th>
<th>Primary Responsibility</th>
</tr>
</thead>
<tbody>
<tr>
<td>src/buffer.c</td>
<td>Buffer creation, switching, management</td>
</tr>
<tr>
<td>src/buffer.h</td>
<td>Buffer structure definitions</td>
</tr>
<tr>
<td>src/insdel.c</td>
<td>Gap buffer mechanics, insertion/deletion</td>
</tr>
<tr>
<td>src/marker.c</td>
<td>Marker operations, char/byte conversion</td>
</tr>
<tr>
<td>src/intervals.c</td>
<td>Interval tree algorithms</td>
</tr>
<tr>
<td>src/textprop.c</td>
<td>Text property API (uses intervals)</td>
</tr>
<tr>
<td>lisp/simple.el</td>
<td>Basic editing commands</td>
</tr>
<tr>
<td>lisp/buff-menu.el</td>
<td>Traditional buffer list</td>
</tr>
<tr>
<td>lisp/ibuffer.el</td>
<td>Advanced buffer list</td>
</tr>
</tbody>
</table>
<hr/>
<h2 data-number="6.13" id="further-reading-3"><span class="header-section-number">6.13</span> Further Reading</h2>
<p>For deeper understanding:</p>
<ol type="1">
<li><strong>Gap buffer tutorial</strong>: src/insdel.c contains detailed
comments</li>
<li><strong>Interval tree operations</strong>: src/intervals.c has
extensive documentation</li>
<li><strong>Multibyte character handling</strong>: Look at character.c
and character.h</li>
<li><strong>Undo system integration</strong>: See undo.c for how it uses
buffer modification counts</li>
<li><strong>Display integration</strong>: See xdisp.c for how the
display system uses buffers</li>
</ol>
<p><strong>Historical context:</strong> - Original gap buffer: TECO
editor (1960s) - Emacs adoption: Richard Stallman‚Äôs original Emacs
(1976) - Multibyte support: Added in Emacs 20 (1997) - Interval tree:
Added for text properties in Emacs 19 (1993)</p>
<h1 data-number="7" id="the-emacs-display-engine-a-literate-programming-guide"><span class="header-section-number">7</span> The Emacs Display Engine: A
Literate Programming Guide</h1>
<h2 data-number="7.1" id="table-of-contents-1"><span class="header-section-number">7.1</span> Table of Contents</h2>
<ol type="1">
<li><a href="#introduction">Introduction</a></li>
<li><a href="#architecture-overview">Architecture Overview</a></li>
<li><a href="#the-redisplay-cycle">The Redisplay Cycle</a></li>
<li><a href="#glyph-matrices">Glyph Matrices: The Heart of
Display</a></li>
<li><a href="#the-display-iterator">The Display Iterator</a></li>
<li><a href="#face-management">Face Management and Realization</a></li>
<li><a href="#bidirectional-text">Bidirectional Text Rendering</a></li>
<li><a href="#line-wrapping">Line Wrapping and Truncation</a></li>
<li><a href="#fringe-indicators">Fringe Indicators</a></li>
<li><a href="#performance-optimizations">Performance
Optimizations</a></li>
<li><a href="#window-system-integration">Window System
Integration</a></li>
</ol>
<hr/>
<h2 data-number="7.2" id="introduction-1"><span class="header-section-number">7.2</span> Introduction</h2>
<p>The Emacs display engine is one of the most sophisticated text
rendering systems ever built. Originally written by Gerd Moellmann and
refined over decades, it handles the complex task of transforming buffer
content into pixels on screen while maintaining exceptional performance
even with large files.</p>
<p>This document provides a literate programming perspective on the
display engine, weaving together code excerpts with detailed
explanations of the algorithms and data structures that make Emacs‚Äôs
display capabilities possible.</p>
<h3 data-number="7.2.1" id="core-principles"><span class="header-section-number">7.2.1</span> Core Principles</h3>
<p>The display engine is built on three fundamental principles:</p>
<ol type="1">
<li><p><strong>Separation of Concerns</strong>: Display code is
completely separate from buffer-modifying code. Functions that modify
buffers don‚Äôt need to worry about updating the display.</p></li>
<li><p><strong>Incremental Updates</strong>: Only the portions of the
display that have changed are redrawn, minimizing expensive redraw
operations.</p></li>
<li><p><strong>Abstract Display Elements</strong>: The engine works with
abstract ‚Äúglyphs‚Äù that can represent characters, images, or other
display elements uniformly.</p></li>
</ol>
<h3 data-number="7.2.2" id="source-files"><span class="header-section-number">7.2.2</span> Source Files</h3>
<p>The display engine comprises approximately 50,000 lines of carefully
optimized C code spread across several files:</p>
<table>
<thead>
<tr>
<th>File</th>
<th>Lines</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>src/xdisp.c</code></td>
<td>~39,000</td>
<td>Core redisplay logic, window updating</td>
</tr>
<tr>
<td><code>src/dispnew.c</code></td>
<td>~7,000</td>
<td>Glyph matrix management, screen updates</td>
</tr>
<tr>
<td><code>src/xfaces.c</code></td>
<td>~6,000</td>
<td>Face management, font selection</td>
</tr>
<tr>
<td><code>src/indent.c</code></td>
<td>~2,000</td>
<td>Indentation, column calculations</td>
</tr>
<tr>
<td><code>src/bidi.c</code></td>
<td>~2,500</td>
<td>Bidirectional text support</td>
</tr>
<tr>
<td><code>src/fringe.c</code></td>
<td>~1,500</td>
<td>Fringe bitmap management</td>
</tr>
</tbody>
</table>
<hr/>
<h2 data-number="7.3" id="architecture-overview"><span class="header-section-number">7.3</span> Architecture Overview</h2>
<h3 data-number="7.3.1" id="the-display-pipeline"><span class="header-section-number">7.3.1</span> The Display Pipeline</h3>
<p>The display process follows a three-phase pipeline as documented in
<code>xdisp.c</code>:</p>
<pre><code>‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    Phase 1: Decide What to Redisplay            ‚îÇ
‚îÇ  redisplay_internal() examines frames and windows to determine  ‚îÇ
‚îÇ  which ones need updating based on flags and buffer changes     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ              Phase 2: Build Desired Glyph Matrices              ‚îÇ
‚îÇ  redisplay_window() constructs the "desired matrix" describing  ‚îÇ
‚îÇ  how each window should appear on screen                        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ               Phase 3: Update Physical Display                  ‚îÇ
‚îÇ  update_frame() compares desired vs current matrices and        ‚îÇ
‚îÇ  performs minimal screen updates to show the changes            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò</code></pre>
<p>From <code>src/xdisp.c:78-88</code>:</p>
<div class="sourceCode" id="cb97"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb97-1"><a aria-hidden="true" href="#cb97-1" tabindex="-1"></a><span class="co">/*</span></span>
<span id="cb97-2"><a aria-hidden="true" href="#cb97-2" tabindex="-1"></a><span class="co">   At its highest level, redisplay can be divided into 3 distinct</span></span>
<span id="cb97-3"><a aria-hidden="true" href="#cb97-3" tabindex="-1"></a><span class="co">   steps, all of which are visible in `redisplay_internal':</span></span>
<span id="cb97-4"><a aria-hidden="true" href="#cb97-4" tabindex="-1"></a></span>
<span id="cb97-5"><a aria-hidden="true" href="#cb97-5" tabindex="-1"></a><span class="co">    . decide which frames need their windows to be considered for redisplay</span></span>
<span id="cb97-6"><a aria-hidden="true" href="#cb97-6" tabindex="-1"></a><span class="co">    . for each window whose display might need to be updated, compute</span></span>
<span id="cb97-7"><a aria-hidden="true" href="#cb97-7" tabindex="-1"></a><span class="co">      a structure, called "glyph matrix", which describes how it</span></span>
<span id="cb97-8"><a aria-hidden="true" href="#cb97-8" tabindex="-1"></a><span class="co">      should look on display</span></span>
<span id="cb97-9"><a aria-hidden="true" href="#cb97-9" tabindex="-1"></a><span class="co">    . actually update the display of windows on the glass where the</span></span>
<span id="cb97-10"><a aria-hidden="true" href="#cb97-10" tabindex="-1"></a><span class="co">      newly obtained glyph matrix differs from the one produced by the</span></span>
<span id="cb97-11"><a aria-hidden="true" href="#cb97-11" tabindex="-1"></a><span class="co">      previous redisplay cycle</span></span>
<span id="cb97-12"><a aria-hidden="true" href="#cb97-12" tabindex="-1"></a><span class="co">*/</span></span></code></pre></div>
<h3 data-number="7.3.2" id="asynchronous-redisplay-triggers"><span class="header-section-number">7.3.2</span> Asynchronous Redisplay
Triggers</h3>
<p>The display engine can be invoked both synchronously (from the
command loop) and asynchronously (from window system events). From
<code>src/xdisp.c:39-71</code>:</p>
<pre><code>   +--------------+   redisplay     +----------------+
   | Lisp machine |----------------&gt;| Redisplay code |&lt;--+
   +--------------+   (xdisp.c)     +----------------+   |
         ^                              |                |
         +----------------------------------+             |
           Block input to prevent this when               |
           called asynchronously!                         |
                                                          |
               note_mouse_highlight (asynchronous)       |
                                                          |
                           X mouse events  ---------------+
                                                          |
                   expose_frame (asynchronous)           |
                                                          |
                          X expose events  ---------------+</code></pre>
<p>This diagram illustrates a critical design constraint: C functions
that might trigger asynchronous redisplay must use
<code>block_input()</code>/<code>unblock_input()</code> to prevent
reentrancy issues.</p>
<hr/>
<h2 data-number="7.4" id="the-redisplay-cycle"><span class="header-section-number">7.4</span> The Redisplay Cycle</h2>
<h3 data-number="7.4.1" id="entry-point-redisplay_internal"><span class="header-section-number">7.4.1</span> Entry Point:
<code>redisplay_internal()</code></h3>
<p>The sole entry point into the display engine is
<code>redisplay_internal()</code> in <code>src/xdisp.c:17137</code>.
This function orchestrates the entire redisplay process.</p>
<p>From <code>src/xdisp.c:17137-17225</code>:</p>
<div class="sourceCode" id="cb99"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb99-1"><a aria-hidden="true" href="#cb99-1" tabindex="-1"></a>redisplay_internal <span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb99-2"><a aria-hidden="true" href="#cb99-2" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb99-3"><a aria-hidden="true" href="#cb99-3" tabindex="-1"></a>  <span class="kw">struct</span> window <span class="op">*</span>w <span class="op">=</span> XWINDOW <span class="op">(</span>selected_window<span class="op">);</span></span>
<span id="cb99-4"><a aria-hidden="true" href="#cb99-4" tabindex="-1"></a>  <span class="kw">struct</span> window <span class="op">*</span>sw<span class="op">;</span></span>
<span id="cb99-5"><a aria-hidden="true" href="#cb99-5" tabindex="-1"></a>  <span class="kw">struct</span> frame <span class="op">*</span>fr<span class="op">;</span></span>
<span id="cb99-6"><a aria-hidden="true" href="#cb99-6" tabindex="-1"></a>  <span class="dt">bool</span> must_finish <span class="op">=</span> <span class="kw">false</span><span class="op">,</span> match_p<span class="op">;</span></span>
<span id="cb99-7"><a aria-hidden="true" href="#cb99-7" tabindex="-1"></a>  <span class="kw">struct</span> text_pos tlbufpos<span class="op">,</span> tlendpos<span class="op">;</span></span>
<span id="cb99-8"><a aria-hidden="true" href="#cb99-8" tabindex="-1"></a>  <span class="dt">int</span> number_of_visible_frames<span class="op">;</span></span>
<span id="cb99-9"><a aria-hidden="true" href="#cb99-9" tabindex="-1"></a>  <span class="kw">struct</span> frame <span class="op">*</span>sf<span class="op">;</span></span>
<span id="cb99-10"><a aria-hidden="true" href="#cb99-10" tabindex="-1"></a>  <span class="dt">bool</span> polling_stopped_here <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb99-11"><a aria-hidden="true" href="#cb99-11" tabindex="-1"></a>  Lisp_Object tail<span class="op">,</span> frame<span class="op">;</span></span>
<span id="cb99-12"><a aria-hidden="true" href="#cb99-12" tabindex="-1"></a></span>
<span id="cb99-13"><a aria-hidden="true" href="#cb99-13" tabindex="-1"></a>  <span class="co">/* Set a limit to the number of retries we perform due to horizontal</span></span>
<span id="cb99-14"><a aria-hidden="true" href="#cb99-14" tabindex="-1"></a><span class="co">     scrolling, this avoids getting stuck in an uninterruptible</span></span>
<span id="cb99-15"><a aria-hidden="true" href="#cb99-15" tabindex="-1"></a><span class="co">     infinite loop (Bug #24633).  */</span></span>
<span id="cb99-16"><a aria-hidden="true" href="#cb99-16" tabindex="-1"></a>  <span class="kw">enum</span> <span class="op">{</span> MAX_HSCROLL_RETRIES <span class="op">=</span> <span class="dv">16</span> <span class="op">};</span></span>
<span id="cb99-17"><a aria-hidden="true" href="#cb99-17" tabindex="-1"></a>  <span class="dt">int</span> hscroll_retries <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb99-18"><a aria-hidden="true" href="#cb99-18" tabindex="-1"></a></span>
<span id="cb99-19"><a aria-hidden="true" href="#cb99-19" tabindex="-1"></a>  <span class="co">/* Limit the number of retries for when frame(s) become garbaged as</span></span>
<span id="cb99-20"><a aria-hidden="true" href="#cb99-20" tabindex="-1"></a><span class="co">     result of redisplaying them.  Some packages set various redisplay</span></span>
<span id="cb99-21"><a aria-hidden="true" href="#cb99-21" tabindex="-1"></a><span class="co">     hooks, such as window-scroll-functions, to run Lisp that always</span></span>
<span id="cb99-22"><a aria-hidden="true" href="#cb99-22" tabindex="-1"></a><span class="co">     calls APIs which cause the frame's garbaged flag to become set,</span></span>
<span id="cb99-23"><a aria-hidden="true" href="#cb99-23" tabindex="-1"></a><span class="co">     so we loop indefinitely.  */</span></span>
<span id="cb99-24"><a aria-hidden="true" href="#cb99-24" tabindex="-1"></a>  <span class="kw">enum</span> <span class="op">{</span>MAX_GARBAGED_FRAME_RETRIES <span class="op">=</span> <span class="dv">2</span> <span class="op">};</span></span>
<span id="cb99-25"><a aria-hidden="true" href="#cb99-25" tabindex="-1"></a>  <span class="dt">int</span> garbaged_frame_retries <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb99-26"><a aria-hidden="true" href="#cb99-26" tabindex="-1"></a></span>
<span id="cb99-27"><a aria-hidden="true" href="#cb99-27" tabindex="-1"></a>  <span class="co">/* False means that only the selected_window needs to be updated.</span></span>
<span id="cb99-28"><a aria-hidden="true" href="#cb99-28" tabindex="-1"></a><span class="co">     True means that other windows may need to be updated as well,</span></span>
<span id="cb99-29"><a aria-hidden="true" href="#cb99-29" tabindex="-1"></a><span class="co">     so we need to consult `needs_no_update` for all windows.  */</span></span>
<span id="cb99-30"><a aria-hidden="true" href="#cb99-30" tabindex="-1"></a>  <span class="dt">bool</span> consider_all_windows_p<span class="op">;</span></span>
<span id="cb99-31"><a aria-hidden="true" href="#cb99-31" tabindex="-1"></a></span>
<span id="cb99-32"><a aria-hidden="true" href="#cb99-32" tabindex="-1"></a>  <span class="co">/* True means redisplay has to redisplay the miniwindow.  */</span></span>
<span id="cb99-33"><a aria-hidden="true" href="#cb99-33" tabindex="-1"></a>  <span class="dt">bool</span> update_miniwindow_p <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb99-34"><a aria-hidden="true" href="#cb99-34" tabindex="-1"></a></span>
<span id="cb99-35"><a aria-hidden="true" href="#cb99-35" tabindex="-1"></a>  redisplay_trace <span class="op">(</span><span class="st">"redisplay_internal </span><span class="sc">%d\n</span><span class="st">"</span><span class="op">,</span> redisplaying_p<span class="op">);</span></span>
<span id="cb99-36"><a aria-hidden="true" href="#cb99-36" tabindex="-1"></a></span>
<span id="cb99-37"><a aria-hidden="true" href="#cb99-37" tabindex="-1"></a>  <span class="co">/* I don't think this happens but let's be paranoid.  In particular,</span></span>
<span id="cb99-38"><a aria-hidden="true" href="#cb99-38" tabindex="-1"></a><span class="co">     this was observed happening when Emacs shuts down due to losing X</span></span>
<span id="cb99-39"><a aria-hidden="true" href="#cb99-39" tabindex="-1"></a><span class="co">     connection, in which case accessing SELECTED_FRAME and the frame</span></span>
<span id="cb99-40"><a aria-hidden="true" href="#cb99-40" tabindex="-1"></a><span class="co">     structure is likely to barf.  */</span></span>
<span id="cb99-41"><a aria-hidden="true" href="#cb99-41" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>redisplaying_p<span class="op">)</span></span>
<span id="cb99-42"><a aria-hidden="true" href="#cb99-42" tabindex="-1"></a>    <span class="cf">return</span><span class="op">;</span></span>
<span id="cb99-43"><a aria-hidden="true" href="#cb99-43" tabindex="-1"></a></span>
<span id="cb99-44"><a aria-hidden="true" href="#cb99-44" tabindex="-1"></a>  <span class="co">/* No redisplay if running in batch mode or frame is not yet fully</span></span>
<span id="cb99-45"><a aria-hidden="true" href="#cb99-45" tabindex="-1"></a><span class="co">     initialized, or redisplay is explicitly turned off by setting</span></span>
<span id="cb99-46"><a aria-hidden="true" href="#cb99-46" tabindex="-1"></a><span class="co">     Vinhibit_redisplay.  */</span></span>
<span id="cb99-47"><a aria-hidden="true" href="#cb99-47" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">((</span>FRAME_INITIAL_P <span class="op">(</span>SELECTED_FRAME <span class="op">())</span></span>
<span id="cb99-48"><a aria-hidden="true" href="#cb99-48" tabindex="-1"></a>       <span class="op">&amp;&amp;</span> redisplay_skip_initial_frame<span class="op">)</span></span>
<span id="cb99-49"><a aria-hidden="true" href="#cb99-49" tabindex="-1"></a>      <span class="op">||</span> <span class="op">!</span>NILP <span class="op">(</span>Vinhibit_redisplay<span class="op">))</span></span>
<span id="cb99-50"><a aria-hidden="true" href="#cb99-50" tabindex="-1"></a>    <span class="cf">return</span><span class="op">;</span></span></code></pre></div>
<p><strong>Key Design Decisions:</strong></p>
<ol type="1">
<li><p><strong>Reentrancy Protection</strong>: The function immediately
returns if already redisplaying, preventing infinite recursion.</p></li>
<li><p><strong>Retry Limits</strong>: Hard limits prevent infinite loops
from misbehaving Lisp code or pathological buffer states.</p></li>
<li><p><strong>Early Exit Conditions</strong>: Multiple guards prevent
unnecessary work (batch mode, uninitialized frames, explicit
inhibition).</p></li>
</ol>
<h3 data-number="7.4.2" id="the-retry-loop"><span class="header-section-number">7.4.2</span> The Retry Loop</h3>
<p>Redisplay operates in a retry loop to handle cases where the display
state changes during redisplay itself:</p>
<div class="sourceCode" id="cb100"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb100-1"><a aria-hidden="true" href="#cb100-1" tabindex="-1"></a> retry<span class="op">:</span></span>
<span id="cb100-2"><a aria-hidden="true" href="#cb100-2" tabindex="-1"></a>  <span class="co">/* Remember the currently selected window.  */</span></span>
<span id="cb100-3"><a aria-hidden="true" href="#cb100-3" tabindex="-1"></a>  sw <span class="op">=</span> w<span class="op">;</span></span>
<span id="cb100-4"><a aria-hidden="true" href="#cb100-4" tabindex="-1"></a></span>
<span id="cb100-5"><a aria-hidden="true" href="#cb100-5" tabindex="-1"></a>  forget_escape_and_glyphless_faces <span class="op">();</span></span>
<span id="cb100-6"><a aria-hidden="true" href="#cb100-6" tabindex="-1"></a></span>
<span id="cb100-7"><a aria-hidden="true" href="#cb100-7" tabindex="-1"></a>  inhibit_free_realized_faces <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb100-8"><a aria-hidden="true" href="#cb100-8" tabindex="-1"></a></span>
<span id="cb100-9"><a aria-hidden="true" href="#cb100-9" tabindex="-1"></a>  <span class="co">/* If face_change, init_iterator will free all realized faces, which</span></span>
<span id="cb100-10"><a aria-hidden="true" href="#cb100-10" tabindex="-1"></a><span class="co">     includes the faces referenced from current matrices.  So, we</span></span>
<span id="cb100-11"><a aria-hidden="true" href="#cb100-11" tabindex="-1"></a><span class="co">     can't reuse current matrices in this case.  */</span></span>
<span id="cb100-12"><a aria-hidden="true" href="#cb100-12" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>face_change<span class="op">)</span></span>
<span id="cb100-13"><a aria-hidden="true" href="#cb100-13" tabindex="-1"></a>    windows_or_buffers_changed <span class="op">=</span> <span class="dv">47</span><span class="op">;</span></span></code></pre></div>
<p>The <code>retry:</code> label allows redisplay to restart if fonts
are loaded, frame geometry changes, or other global state modifications
occur during the redisplay process.</p>
<h3 data-number="7.4.3" id="frame-visibility-and-matrix-adjustment"><span class="header-section-number">7.4.3</span> Frame Visibility and Matrix
Adjustment</h3>
<p>From <code>src/xdisp.c:17258-17290</code>:</p>
<div class="sourceCode" id="cb101"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb101-1"><a aria-hidden="true" href="#cb101-1" tabindex="-1"></a>  <span class="co">/* Set the visible flags for all frames.  Do this before checking for</span></span>
<span id="cb101-2"><a aria-hidden="true" href="#cb101-2" tabindex="-1"></a><span class="co">     resized or garbaged frames; they want to know if their frames are</span></span>
<span id="cb101-3"><a aria-hidden="true" href="#cb101-3" tabindex="-1"></a><span class="co">     visible.  See the comment in frame.h for FRAME_SAMPLE_VISIBILITY.  */</span></span>
<span id="cb101-4"><a aria-hidden="true" href="#cb101-4" tabindex="-1"></a>  number_of_visible_frames <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb101-5"><a aria-hidden="true" href="#cb101-5" tabindex="-1"></a></span>
<span id="cb101-6"><a aria-hidden="true" href="#cb101-6" tabindex="-1"></a>  FOR_EACH_FRAME <span class="op">(</span>tail<span class="op">,</span> frame<span class="op">)</span></span>
<span id="cb101-7"><a aria-hidden="true" href="#cb101-7" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb101-8"><a aria-hidden="true" href="#cb101-8" tabindex="-1"></a>      <span class="kw">struct</span> frame <span class="op">*</span>f <span class="op">=</span> XFRAME <span class="op">(</span>frame<span class="op">);</span></span>
<span id="cb101-9"><a aria-hidden="true" href="#cb101-9" tabindex="-1"></a></span>
<span id="cb101-10"><a aria-hidden="true" href="#cb101-10" tabindex="-1"></a>      <span class="co">/* frame_redisplay_p true basically means the frame is visible. */</span></span>
<span id="cb101-11"><a aria-hidden="true" href="#cb101-11" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span>frame_redisplay_p <span class="op">(</span>f<span class="op">))</span></span>
<span id="cb101-12"><a aria-hidden="true" href="#cb101-12" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb101-13"><a aria-hidden="true" href="#cb101-13" tabindex="-1"></a>      <span class="op">++</span>number_of_visible_frames<span class="op">;</span></span>
<span id="cb101-14"><a aria-hidden="true" href="#cb101-14" tabindex="-1"></a>      <span class="co">/* Adjust matrices for visible frames only.  */</span></span>
<span id="cb101-15"><a aria-hidden="true" href="#cb101-15" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span>f<span class="op">-&gt;</span>fonts_changed<span class="op">)</span></span>
<span id="cb101-16"><a aria-hidden="true" href="#cb101-16" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb101-17"><a aria-hidden="true" href="#cb101-17" tabindex="-1"></a>          adjust_frame_glyphs <span class="op">(</span>f<span class="op">);</span></span>
<span id="cb101-18"><a aria-hidden="true" href="#cb101-18" tabindex="-1"></a>          <span class="co">/* Disable all redisplay optimizations for this frame.</span></span>
<span id="cb101-19"><a aria-hidden="true" href="#cb101-19" tabindex="-1"></a><span class="co">         This is because adjust_frame_glyphs resets the</span></span>
<span id="cb101-20"><a aria-hidden="true" href="#cb101-20" tabindex="-1"></a><span class="co">         enabled_p flag for all glyph rows of all windows, so</span></span>
<span id="cb101-21"><a aria-hidden="true" href="#cb101-21" tabindex="-1"></a><span class="co">         many optimizations will fail anyway, and some might</span></span>
<span id="cb101-22"><a aria-hidden="true" href="#cb101-22" tabindex="-1"></a><span class="co">         fail to test that flag and do bogus things as</span></span>
<span id="cb101-23"><a aria-hidden="true" href="#cb101-23" tabindex="-1"></a><span class="co">         result.  */</span></span>
<span id="cb101-24"><a aria-hidden="true" href="#cb101-24" tabindex="-1"></a>          SET_FRAME_GARBAGED <span class="op">(</span>f<span class="op">);</span></span>
<span id="cb101-25"><a aria-hidden="true" href="#cb101-25" tabindex="-1"></a>          f<span class="op">-&gt;</span>fonts_changed <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb101-26"><a aria-hidden="true" href="#cb101-26" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb101-27"><a aria-hidden="true" href="#cb101-27" tabindex="-1"></a>      <span class="co">/* If cursor type has been changed on the frame</span></span>
<span id="cb101-28"><a aria-hidden="true" href="#cb101-28" tabindex="-1"></a><span class="co">         other than selected, consider all frames.  */</span></span>
<span id="cb101-29"><a aria-hidden="true" href="#cb101-29" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span>f <span class="op">!=</span> sf <span class="op">&amp;&amp;</span> f<span class="op">-&gt;</span>cursor_type_changed<span class="op">)</span></span>
<span id="cb101-30"><a aria-hidden="true" href="#cb101-30" tabindex="-1"></a>        fset_redisplay <span class="op">(</span>f<span class="op">);</span></span>
<span id="cb101-31"><a aria-hidden="true" href="#cb101-31" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb101-32"><a aria-hidden="true" href="#cb101-32" tabindex="-1"></a>      clear_desired_matrices <span class="op">(</span>f<span class="op">);</span></span>
<span id="cb101-33"><a aria-hidden="true" href="#cb101-33" tabindex="-1"></a>    <span class="op">}</span></span></code></pre></div>
<p>This code demonstrates a key optimization: only visible frames have
their matrices adjusted. The <code>fonts_changed</code> flag triggers
complete matrix reallocation when font loading changes window
dimensions.</p>
<hr/>
<h2 data-number="7.5" id="glyph-matrices-the-heart-of-display"><span class="header-section-number">7.5</span> Glyph Matrices: The Heart of
Display</h2>
<h3 data-number="7.5.1" id="understanding-glyph-matrices"><span class="header-section-number">7.5.1</span> Understanding Glyph
Matrices</h3>
<p>A glyph matrix is a two-dimensional array of glyphs where: - Each
<strong>row</strong> corresponds to a screen line - Each
<strong>glyph</strong> in a row represents a display element (character,
image, etc.)</p>
<p>From <code>src/dispextern.h:783-847</code>:</p>
<div class="sourceCode" id="cb102"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb102-1"><a aria-hidden="true" href="#cb102-1" tabindex="-1"></a><span class="kw">struct</span> glyph_matrix</span>
<span id="cb102-2"><a aria-hidden="true" href="#cb102-2" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb102-3"><a aria-hidden="true" href="#cb102-3" tabindex="-1"></a>  <span class="co">/* The pool from which glyph memory is allocated, if any.  This is</span></span>
<span id="cb102-4"><a aria-hidden="true" href="#cb102-4" tabindex="-1"></a><span class="co">     null for frame matrices and for window matrices managing their</span></span>
<span id="cb102-5"><a aria-hidden="true" href="#cb102-5" tabindex="-1"></a><span class="co">     own storage.  */</span></span>
<span id="cb102-6"><a aria-hidden="true" href="#cb102-6" tabindex="-1"></a>  <span class="kw">struct</span> glyph_pool <span class="op">*</span>pool<span class="op">;</span></span>
<span id="cb102-7"><a aria-hidden="true" href="#cb102-7" tabindex="-1"></a></span>
<span id="cb102-8"><a aria-hidden="true" href="#cb102-8" tabindex="-1"></a>  <span class="co">/* Vector of glyph row structures.  The row at nrows - 1 is reserved</span></span>
<span id="cb102-9"><a aria-hidden="true" href="#cb102-9" tabindex="-1"></a><span class="co">     for the mode line.  */</span></span>
<span id="cb102-10"><a aria-hidden="true" href="#cb102-10" tabindex="-1"></a>  <span class="kw">struct</span> glyph_row <span class="op">*</span>rows<span class="op">;</span></span>
<span id="cb102-11"><a aria-hidden="true" href="#cb102-11" tabindex="-1"></a></span>
<span id="cb102-12"><a aria-hidden="true" href="#cb102-12" tabindex="-1"></a>  <span class="co">/* Number of elements allocated for the vector rows above.  */</span></span>
<span id="cb102-13"><a aria-hidden="true" href="#cb102-13" tabindex="-1"></a>  <span class="dt">ptrdiff_t</span> rows_allocated<span class="op">;</span></span>
<span id="cb102-14"><a aria-hidden="true" href="#cb102-14" tabindex="-1"></a></span>
<span id="cb102-15"><a aria-hidden="true" href="#cb102-15" tabindex="-1"></a>  <span class="co">/* The number of rows used by the window if all lines were displayed</span></span>
<span id="cb102-16"><a aria-hidden="true" href="#cb102-16" tabindex="-1"></a><span class="co">     with the smallest possible character height.  */</span></span>
<span id="cb102-17"><a aria-hidden="true" href="#cb102-17" tabindex="-1"></a>  <span class="dt">int</span> nrows<span class="op">;</span></span>
<span id="cb102-18"><a aria-hidden="true" href="#cb102-18" tabindex="-1"></a></span>
<span id="cb102-19"><a aria-hidden="true" href="#cb102-19" tabindex="-1"></a>  <span class="co">/* Origin within the frame matrix if this is a window matrix on a</span></span>
<span id="cb102-20"><a aria-hidden="true" href="#cb102-20" tabindex="-1"></a><span class="co">     frame having a frame matrix.  Both values are zero for</span></span>
<span id="cb102-21"><a aria-hidden="true" href="#cb102-21" tabindex="-1"></a><span class="co">     window-based redisplay.  */</span></span>
<span id="cb102-22"><a aria-hidden="true" href="#cb102-22" tabindex="-1"></a>  <span class="dt">int</span> matrix_x<span class="op">,</span> matrix_y<span class="op">;</span></span>
<span id="cb102-23"><a aria-hidden="true" href="#cb102-23" tabindex="-1"></a></span>
<span id="cb102-24"><a aria-hidden="true" href="#cb102-24" tabindex="-1"></a>  <span class="co">/* Width and height of the matrix in columns and rows.  */</span></span>
<span id="cb102-25"><a aria-hidden="true" href="#cb102-25" tabindex="-1"></a>  <span class="dt">int</span> matrix_w<span class="op">,</span> matrix_h<span class="op">;</span></span>
<span id="cb102-26"><a aria-hidden="true" href="#cb102-26" tabindex="-1"></a></span>
<span id="cb102-27"><a aria-hidden="true" href="#cb102-27" tabindex="-1"></a>  <span class="co">/* If this structure describes a window matrix of window W,</span></span>
<span id="cb102-28"><a aria-hidden="true" href="#cb102-28" tabindex="-1"></a><span class="co">     window_pixel_left is the value of W-&gt;pixel_left, window_pixel_top</span></span>
<span id="cb102-29"><a aria-hidden="true" href="#cb102-29" tabindex="-1"></a><span class="co">     the value of W-&gt;pixel_top, window_height and window_width are width</span></span>
<span id="cb102-30"><a aria-hidden="true" href="#cb102-30" tabindex="-1"></a><span class="co">     and height of W, as returned by window_box, and window_vscroll is</span></span>
<span id="cb102-31"><a aria-hidden="true" href="#cb102-31" tabindex="-1"></a><span class="co">     the value of W-&gt;vscroll at the time the matrix was last adjusted.</span></span>
<span id="cb102-32"><a aria-hidden="true" href="#cb102-32" tabindex="-1"></a><span class="co">     Only set for window-based redisplay.  */</span></span>
<span id="cb102-33"><a aria-hidden="true" href="#cb102-33" tabindex="-1"></a>  <span class="dt">int</span> window_pixel_left<span class="op">,</span> window_pixel_top<span class="op">;</span></span>
<span id="cb102-34"><a aria-hidden="true" href="#cb102-34" tabindex="-1"></a>  <span class="dt">int</span> window_height<span class="op">,</span> window_width<span class="op">;</span></span>
<span id="cb102-35"><a aria-hidden="true" href="#cb102-35" tabindex="-1"></a>  <span class="dt">int</span> window_vscroll<span class="op">;</span></span>
<span id="cb102-36"><a aria-hidden="true" href="#cb102-36" tabindex="-1"></a></span>
<span id="cb102-37"><a aria-hidden="true" href="#cb102-37" tabindex="-1"></a>  <span class="co">/* Number of glyphs reserved for left and right marginal areas when</span></span>
<span id="cb102-38"><a aria-hidden="true" href="#cb102-38" tabindex="-1"></a><span class="co">     the matrix was last adjusted.  */</span></span>
<span id="cb102-39"><a aria-hidden="true" href="#cb102-39" tabindex="-1"></a>  <span class="dt">int</span> left_margin_glyphs<span class="op">,</span> right_margin_glyphs<span class="op">;</span></span>
<span id="cb102-40"><a aria-hidden="true" href="#cb102-40" tabindex="-1"></a></span>
<span id="cb102-41"><a aria-hidden="true" href="#cb102-41" tabindex="-1"></a>  <span class="co">/* Flag indicating that scrolling should not be tried in</span></span>
<span id="cb102-42"><a aria-hidden="true" href="#cb102-42" tabindex="-1"></a><span class="co">     update_window.  This flag is set by functions like try_window_id</span></span>
<span id="cb102-43"><a aria-hidden="true" href="#cb102-43" tabindex="-1"></a><span class="co">     which do their own scrolling.  */</span></span>
<span id="cb102-44"><a aria-hidden="true" href="#cb102-44" tabindex="-1"></a>  bool_bf no_scrolling_p <span class="op">:</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb102-45"><a aria-hidden="true" href="#cb102-45" tabindex="-1"></a></span>
<span id="cb102-46"><a aria-hidden="true" href="#cb102-46" tabindex="-1"></a>  <span class="co">/* True means window displayed in this matrix has a tab line.  */</span></span>
<span id="cb102-47"><a aria-hidden="true" href="#cb102-47" tabindex="-1"></a>  bool_bf tab_line_p <span class="op">:</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb102-48"><a aria-hidden="true" href="#cb102-48" tabindex="-1"></a></span>
<span id="cb102-49"><a aria-hidden="true" href="#cb102-49" tabindex="-1"></a>  <span class="co">/* True means window displayed in this matrix has a header</span></span>
<span id="cb102-50"><a aria-hidden="true" href="#cb102-50" tabindex="-1"></a><span class="co">     line.  */</span></span>
<span id="cb102-51"><a aria-hidden="true" href="#cb102-51" tabindex="-1"></a>  bool_bf header_line_p <span class="op">:</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb102-52"><a aria-hidden="true" href="#cb102-52" tabindex="-1"></a></span>
<span id="cb102-53"><a aria-hidden="true" href="#cb102-53" tabindex="-1"></a><span class="pp">#ifdef GLYPH_DEBUG</span></span>
<span id="cb102-54"><a aria-hidden="true" href="#cb102-54" tabindex="-1"></a>  <span class="co">/* A string identifying the method used to display the matrix.  */</span></span>
<span id="cb102-55"><a aria-hidden="true" href="#cb102-55" tabindex="-1"></a>  <span class="dt">char</span> method<span class="op">[</span><span class="dv">512</span><span class="op">];</span></span>
<span id="cb102-56"><a aria-hidden="true" href="#cb102-56" tabindex="-1"></a><span class="pp">#endif</span></span>
<span id="cb102-57"><a aria-hidden="true" href="#cb102-57" tabindex="-1"></a></span>
<span id="cb102-58"><a aria-hidden="true" href="#cb102-58" tabindex="-1"></a>  <span class="co">/* The buffer this matrix displays.  Set in</span></span>
<span id="cb102-59"><a aria-hidden="true" href="#cb102-59" tabindex="-1"></a><span class="co">     mark_window_display_accurate_1.  */</span></span>
<span id="cb102-60"><a aria-hidden="true" href="#cb102-60" tabindex="-1"></a>  <span class="kw">struct</span> buffer <span class="op">*</span>buffer<span class="op">;</span></span>
<span id="cb102-61"><a aria-hidden="true" href="#cb102-61" tabindex="-1"></a></span>
<span id="cb102-62"><a aria-hidden="true" href="#cb102-62" tabindex="-1"></a>  <span class="co">/* Values of BEGV and ZV as of last redisplay.  Set in</span></span>
<span id="cb102-63"><a aria-hidden="true" href="#cb102-63" tabindex="-1"></a><span class="co">     mark_window_display_accurate_1.  */</span></span>
<span id="cb102-64"><a aria-hidden="true" href="#cb102-64" tabindex="-1"></a>  <span class="dt">ptrdiff_t</span> begv<span class="op">,</span> zv<span class="op">;</span></span>
<span id="cb102-65"><a aria-hidden="true" href="#cb102-65" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<h3 data-number="7.5.2" id="current-vs-desired-matrices"><span class="header-section-number">7.5.2</span> Current vs Desired
Matrices</h3>
<p>Each window maintains <strong>two</strong> glyph matrices:</p>
<ol type="1">
<li><strong>Current Matrix</strong>: Records what is currently displayed
on screen</li>
<li><strong>Desired Matrix</strong>: Describes what should be
displayed</li>
</ol>
<p>The update process compares these matrices to determine minimal
changes needed.</p>
<h3 data-number="7.5.3" id="glyph-row-structure"><span class="header-section-number">7.5.3</span> Glyph Row Structure</h3>
<p>Each row in a glyph matrix contains detailed information about a
screen line. From <code>src/dispextern.h:906-1055</code>:</p>
<div class="sourceCode" id="cb103"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb103-1"><a aria-hidden="true" href="#cb103-1" tabindex="-1"></a><span class="kw">struct</span> glyph_row</span>
<span id="cb103-2"><a aria-hidden="true" href="#cb103-2" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb103-3"><a aria-hidden="true" href="#cb103-3" tabindex="-1"></a>  <span class="co">/* Pointers to beginnings of areas.  The end of an area A is found at</span></span>
<span id="cb103-4"><a aria-hidden="true" href="#cb103-4" tabindex="-1"></a><span class="co">     A + 1 in the vector.  The last element of the vector is the end</span></span>
<span id="cb103-5"><a aria-hidden="true" href="#cb103-5" tabindex="-1"></a><span class="co">     of the whole row.</span></span>
<span id="cb103-6"><a aria-hidden="true" href="#cb103-6" tabindex="-1"></a></span>
<span id="cb103-7"><a aria-hidden="true" href="#cb103-7" tabindex="-1"></a><span class="co">     Kludge alert: Even if used[TEXT_AREA] == 0, glyphs[TEXT_AREA][0]'s</span></span>
<span id="cb103-8"><a aria-hidden="true" href="#cb103-8" tabindex="-1"></a><span class="co">     position field is used.  It is -1 if this row does not correspond</span></span>
<span id="cb103-9"><a aria-hidden="true" href="#cb103-9" tabindex="-1"></a><span class="co">     to any text; it is some buffer position if the row corresponds to</span></span>
<span id="cb103-10"><a aria-hidden="true" href="#cb103-10" tabindex="-1"></a><span class="co">     an empty display line that displays a line end.  This is what old</span></span>
<span id="cb103-11"><a aria-hidden="true" href="#cb103-11" tabindex="-1"></a><span class="co">     redisplay used to do.  (Except in code for terminal frames, this</span></span>
<span id="cb103-12"><a aria-hidden="true" href="#cb103-12" tabindex="-1"></a><span class="co">     kludge is no longer used, I believe. --gerd).</span></span>
<span id="cb103-13"><a aria-hidden="true" href="#cb103-13" tabindex="-1"></a></span>
<span id="cb103-14"><a aria-hidden="true" href="#cb103-14" tabindex="-1"></a><span class="co">     See also start, end, displays_text_p and ends_at_zv_p for cleaner</span></span>
<span id="cb103-15"><a aria-hidden="true" href="#cb103-15" tabindex="-1"></a><span class="co">     ways to do it.  The special meaning of positions 0 and -1 will be</span></span>
<span id="cb103-16"><a aria-hidden="true" href="#cb103-16" tabindex="-1"></a><span class="co">     removed some day, so don't use it in new code.  */</span></span>
<span id="cb103-17"><a aria-hidden="true" href="#cb103-17" tabindex="-1"></a>  <span class="kw">struct</span> glyph <span class="op">*</span>glyphs<span class="op">[</span><span class="dv">1</span> <span class="op">+</span> LAST_AREA<span class="op">];</span></span>
<span id="cb103-18"><a aria-hidden="true" href="#cb103-18" tabindex="-1"></a></span>
<span id="cb103-19"><a aria-hidden="true" href="#cb103-19" tabindex="-1"></a>  <span class="co">/* Number of glyphs actually filled in areas.  This could have size</span></span>
<span id="cb103-20"><a aria-hidden="true" href="#cb103-20" tabindex="-1"></a><span class="co">     LAST_AREA, but it's 1 + LAST_AREA to simplify offset calculations.  */</span></span>
<span id="cb103-21"><a aria-hidden="true" href="#cb103-21" tabindex="-1"></a>  <span class="dt">short</span> used<span class="op">[</span><span class="dv">1</span> <span class="op">+</span> LAST_AREA<span class="op">];</span></span>
<span id="cb103-22"><a aria-hidden="true" href="#cb103-22" tabindex="-1"></a></span>
<span id="cb103-23"><a aria-hidden="true" href="#cb103-23" tabindex="-1"></a>  <span class="co">/* Hash code.  This hash code is available as soon as the row</span></span>
<span id="cb103-24"><a aria-hidden="true" href="#cb103-24" tabindex="-1"></a><span class="co">     is constructed, i.e. after a call to display_line.  */</span></span>
<span id="cb103-25"><a aria-hidden="true" href="#cb103-25" tabindex="-1"></a>  <span class="dt">unsigned</span> hash<span class="op">;</span></span>
<span id="cb103-26"><a aria-hidden="true" href="#cb103-26" tabindex="-1"></a></span>
<span id="cb103-27"><a aria-hidden="true" href="#cb103-27" tabindex="-1"></a>  <span class="co">/* Window-relative x and y-position of the top-left corner of this</span></span>
<span id="cb103-28"><a aria-hidden="true" href="#cb103-28" tabindex="-1"></a><span class="co">     row.  If y &lt; 0, this means that eabs (y) pixels of the row are</span></span>
<span id="cb103-29"><a aria-hidden="true" href="#cb103-29" tabindex="-1"></a><span class="co">     invisible because it is partially visible at the top of a window.</span></span>
<span id="cb103-30"><a aria-hidden="true" href="#cb103-30" tabindex="-1"></a><span class="co">     If x &lt; 0, this means that eabs (x) pixels of the first glyph of</span></span>
<span id="cb103-31"><a aria-hidden="true" href="#cb103-31" tabindex="-1"></a><span class="co">     the text area of the row are invisible because the glyph is</span></span>
<span id="cb103-32"><a aria-hidden="true" href="#cb103-32" tabindex="-1"></a><span class="co">     partially visible.  */</span></span>
<span id="cb103-33"><a aria-hidden="true" href="#cb103-33" tabindex="-1"></a>  <span class="dt">int</span> x<span class="op">,</span> y<span class="op">;</span></span>
<span id="cb103-34"><a aria-hidden="true" href="#cb103-34" tabindex="-1"></a></span>
<span id="cb103-35"><a aria-hidden="true" href="#cb103-35" tabindex="-1"></a>  <span class="co">/* Width of the row in pixels without taking face extension at the</span></span>
<span id="cb103-36"><a aria-hidden="true" href="#cb103-36" tabindex="-1"></a><span class="co">     end of the row into account, and without counting truncation</span></span>
<span id="cb103-37"><a aria-hidden="true" href="#cb103-37" tabindex="-1"></a><span class="co">     and continuation glyphs at the end of a row on ttys.  */</span></span>
<span id="cb103-38"><a aria-hidden="true" href="#cb103-38" tabindex="-1"></a>  <span class="dt">int</span> pixel_width<span class="op">;</span></span>
<span id="cb103-39"><a aria-hidden="true" href="#cb103-39" tabindex="-1"></a></span>
<span id="cb103-40"><a aria-hidden="true" href="#cb103-40" tabindex="-1"></a>  <span class="co">/* Logical ascent/height of this line.  The value of ascent is zero</span></span>
<span id="cb103-41"><a aria-hidden="true" href="#cb103-41" tabindex="-1"></a><span class="co">     and height is 1 on terminal frames.  */</span></span>
<span id="cb103-42"><a aria-hidden="true" href="#cb103-42" tabindex="-1"></a>  <span class="dt">int</span> ascent<span class="op">,</span> height<span class="op">;</span></span>
<span id="cb103-43"><a aria-hidden="true" href="#cb103-43" tabindex="-1"></a></span>
<span id="cb103-44"><a aria-hidden="true" href="#cb103-44" tabindex="-1"></a>  <span class="co">/* Physical ascent/height of this line.  If max_ascent &gt; ascent,</span></span>
<span id="cb103-45"><a aria-hidden="true" href="#cb103-45" tabindex="-1"></a><span class="co">     this line overlaps the line above it on the display.  Otherwise,</span></span>
<span id="cb103-46"><a aria-hidden="true" href="#cb103-46" tabindex="-1"></a><span class="co">     if max_height &gt; height, this line overlaps the line beneath it.  */</span></span>
<span id="cb103-47"><a aria-hidden="true" href="#cb103-47" tabindex="-1"></a>  <span class="dt">int</span> phys_ascent<span class="op">,</span> phys_height<span class="op">;</span></span>
<span id="cb103-48"><a aria-hidden="true" href="#cb103-48" tabindex="-1"></a></span>
<span id="cb103-49"><a aria-hidden="true" href="#cb103-49" tabindex="-1"></a>  <span class="co">/* Portion of row that is visible.  Partially visible rows may be</span></span>
<span id="cb103-50"><a aria-hidden="true" href="#cb103-50" tabindex="-1"></a><span class="co">     found at the top and bottom of a window.  This is 1 for tty</span></span>
<span id="cb103-51"><a aria-hidden="true" href="#cb103-51" tabindex="-1"></a><span class="co">     frames.  It may be &lt; 0 in case of completely invisible rows.  */</span></span>
<span id="cb103-52"><a aria-hidden="true" href="#cb103-52" tabindex="-1"></a>  <span class="dt">int</span> visible_height<span class="op">;</span></span></code></pre></div>
<p><strong>Key Features:</strong></p>
<ul>
<li><strong>Three Areas</strong>: Each row can have left margin, text
area, and right margin glyphs</li>
<li><strong>Hash Codes</strong>: Enable fast equality comparisons for
optimization</li>
<li><strong>Pixel Geometry</strong>: Tracks exact position and
dimensions for precise rendering</li>
<li><strong>Visibility Tracking</strong>: Distinguishes fully visible,
partially visible, and invisible rows</li>
</ul>
<h3 data-number="7.5.4" id="the-glyph-structure"><span class="header-section-number">7.5.4</span> The Glyph Structure</h3>
<p>Individual glyphs are the atomic units of display. From
<code>src/dispextern.h:460-560</code>:</p>
<div class="sourceCode" id="cb104"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb104-1"><a aria-hidden="true" href="#cb104-1" tabindex="-1"></a><span class="kw">struct</span> glyph</span>
<span id="cb104-2"><a aria-hidden="true" href="#cb104-2" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb104-3"><a aria-hidden="true" href="#cb104-3" tabindex="-1"></a>  <span class="co">/* Position from which this glyph was drawn.  If `object' below is a</span></span>
<span id="cb104-4"><a aria-hidden="true" href="#cb104-4" tabindex="-1"></a><span class="co">     Lisp string, this is an index into that string.  If it is a</span></span>
<span id="cb104-5"><a aria-hidden="true" href="#cb104-5" tabindex="-1"></a><span class="co">     buffer, this is a position in that buffer.  In addition, some</span></span>
<span id="cb104-6"><a aria-hidden="true" href="#cb104-6" tabindex="-1"></a><span class="co">     special glyphs have special values for this:</span></span>
<span id="cb104-7"><a aria-hidden="true" href="#cb104-7" tabindex="-1"></a></span>
<span id="cb104-8"><a aria-hidden="true" href="#cb104-8" tabindex="-1"></a><span class="co">      glyph standing for newline at end of line    0</span></span>
<span id="cb104-9"><a aria-hidden="true" href="#cb104-9" tabindex="-1"></a><span class="co">      empty space after the end of the line       -1</span></span>
<span id="cb104-10"><a aria-hidden="true" href="#cb104-10" tabindex="-1"></a><span class="co">      overlay arrow on a TTY                      -1</span></span>
<span id="cb104-11"><a aria-hidden="true" href="#cb104-11" tabindex="-1"></a><span class="co">      glyph displaying line number                -1</span></span>
<span id="cb104-12"><a aria-hidden="true" href="#cb104-12" tabindex="-1"></a><span class="co">      glyph at EOB that ends in a newline         -1</span></span>
<span id="cb104-13"><a aria-hidden="true" href="#cb104-13" tabindex="-1"></a><span class="co">      left truncation glyphs:                     -1</span></span>
<span id="cb104-14"><a aria-hidden="true" href="#cb104-14" tabindex="-1"></a><span class="co">      right truncation/continuation glyphs        next buffer position</span></span>
<span id="cb104-15"><a aria-hidden="true" href="#cb104-15" tabindex="-1"></a><span class="co">      glyph standing for newline of an empty line buffer position of newline</span></span>
<span id="cb104-16"><a aria-hidden="true" href="#cb104-16" tabindex="-1"></a><span class="co">      stretch glyph at left edge of R2L lines     buffer position of newline  */</span></span>
<span id="cb104-17"><a aria-hidden="true" href="#cb104-17" tabindex="-1"></a>  <span class="dt">ptrdiff_t</span> charpos<span class="op">;</span></span>
<span id="cb104-18"><a aria-hidden="true" href="#cb104-18" tabindex="-1"></a></span>
<span id="cb104-19"><a aria-hidden="true" href="#cb104-19" tabindex="-1"></a>  <span class="co">/* Lisp object source of this glyph.  Currently either a buffer or a</span></span>
<span id="cb104-20"><a aria-hidden="true" href="#cb104-20" tabindex="-1"></a><span class="co">     string, if the glyph was produced from characters which came from</span></span>
<span id="cb104-21"><a aria-hidden="true" href="#cb104-21" tabindex="-1"></a><span class="co">     a buffer or a string; or nil if the glyph was inserted by</span></span>
<span id="cb104-22"><a aria-hidden="true" href="#cb104-22" tabindex="-1"></a><span class="co">     redisplay for its own purposes, such as padding, truncation, or</span></span>
<span id="cb104-23"><a aria-hidden="true" href="#cb104-23" tabindex="-1"></a><span class="co">     continuation glyphs, or the overlay-arrow glyphs on TTYs.  */</span></span>
<span id="cb104-24"><a aria-hidden="true" href="#cb104-24" tabindex="-1"></a>  Lisp_Object object<span class="op">;</span></span>
<span id="cb104-25"><a aria-hidden="true" href="#cb104-25" tabindex="-1"></a></span>
<span id="cb104-26"><a aria-hidden="true" href="#cb104-26" tabindex="-1"></a>  <span class="co">/* Frame on which the glyph was produced.  The face_id of this glyph</span></span>
<span id="cb104-27"><a aria-hidden="true" href="#cb104-27" tabindex="-1"></a><span class="co">     refers to the face_cache of this frame.  This is used on tty</span></span>
<span id="cb104-28"><a aria-hidden="true" href="#cb104-28" tabindex="-1"></a><span class="co">     frames only.  */</span></span>
<span id="cb104-29"><a aria-hidden="true" href="#cb104-29" tabindex="-1"></a>  <span class="kw">struct</span> frame <span class="op">*</span>frame<span class="op">;</span></span>
<span id="cb104-30"><a aria-hidden="true" href="#cb104-30" tabindex="-1"></a></span>
<span id="cb104-31"><a aria-hidden="true" href="#cb104-31" tabindex="-1"></a>  <span class="co">/* Width in pixels.  */</span></span>
<span id="cb104-32"><a aria-hidden="true" href="#cb104-32" tabindex="-1"></a>  <span class="dt">short</span> pixel_width<span class="op">;</span></span>
<span id="cb104-33"><a aria-hidden="true" href="#cb104-33" tabindex="-1"></a></span>
<span id="cb104-34"><a aria-hidden="true" href="#cb104-34" tabindex="-1"></a>  <span class="co">/* Ascent and descent in pixels.  */</span></span>
<span id="cb104-35"><a aria-hidden="true" href="#cb104-35" tabindex="-1"></a>  <span class="dt">short</span> ascent<span class="op">,</span> descent<span class="op">;</span></span>
<span id="cb104-36"><a aria-hidden="true" href="#cb104-36" tabindex="-1"></a></span>
<span id="cb104-37"><a aria-hidden="true" href="#cb104-37" tabindex="-1"></a>  <span class="co">/* Vertical offset.  If &lt; 0, the glyph is displayed raised, if &gt; 0</span></span>
<span id="cb104-38"><a aria-hidden="true" href="#cb104-38" tabindex="-1"></a><span class="co">     the glyph is displayed lowered.  */</span></span>
<span id="cb104-39"><a aria-hidden="true" href="#cb104-39" tabindex="-1"></a>  <span class="dt">short</span> voffset<span class="op">;</span></span>
<span id="cb104-40"><a aria-hidden="true" href="#cb104-40" tabindex="-1"></a></span>
<span id="cb104-41"><a aria-hidden="true" href="#cb104-41" tabindex="-1"></a>  <span class="co">/* Which kind of glyph this is---character, image etc.  Value</span></span>
<span id="cb104-42"><a aria-hidden="true" href="#cb104-42" tabindex="-1"></a><span class="co">     should be an enumerator of type enum glyph_type.  */</span></span>
<span id="cb104-43"><a aria-hidden="true" href="#cb104-43" tabindex="-1"></a>  <span class="dt">unsigned</span> type <span class="op">:</span> <span class="dv">3</span><span class="op">;</span></span>
<span id="cb104-44"><a aria-hidden="true" href="#cb104-44" tabindex="-1"></a></span>
<span id="cb104-45"><a aria-hidden="true" href="#cb104-45" tabindex="-1"></a>  <span class="co">/* True means this glyph was produced from multibyte text.  False</span></span>
<span id="cb104-46"><a aria-hidden="true" href="#cb104-46" tabindex="-1"></a><span class="co">     means it was produced from unibyte text, i.e. charsets aren't</span></span>
<span id="cb104-47"><a aria-hidden="true" href="#cb104-47" tabindex="-1"></a><span class="co">     applicable, and encoding is not performed.  */</span></span>
<span id="cb104-48"><a aria-hidden="true" href="#cb104-48" tabindex="-1"></a>  bool_bf multibyte_p <span class="op">:</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb104-49"><a aria-hidden="true" href="#cb104-49" tabindex="-1"></a></span>
<span id="cb104-50"><a aria-hidden="true" href="#cb104-50" tabindex="-1"></a>  <span class="co">/* True means draw a box line at the left or right side of this</span></span>
<span id="cb104-51"><a aria-hidden="true" href="#cb104-51" tabindex="-1"></a><span class="co">     glyph.  This is part of the implementation of the face attribute</span></span>
<span id="cb104-52"><a aria-hidden="true" href="#cb104-52" tabindex="-1"></a><span class="co">     `:box'.  */</span></span>
<span id="cb104-53"><a aria-hidden="true" href="#cb104-53" tabindex="-1"></a>  bool_bf left_box_line_p <span class="op">:</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb104-54"><a aria-hidden="true" href="#cb104-54" tabindex="-1"></a>  bool_bf right_box_line_p <span class="op">:</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb104-55"><a aria-hidden="true" href="#cb104-55" tabindex="-1"></a></span>
<span id="cb104-56"><a aria-hidden="true" href="#cb104-56" tabindex="-1"></a>  <span class="co">/* True means this glyph's physical ascent or descent is greater</span></span>
<span id="cb104-57"><a aria-hidden="true" href="#cb104-57" tabindex="-1"></a><span class="co">     than its logical ascent/descent, i.e. it may potentially overlap</span></span>
<span id="cb104-58"><a aria-hidden="true" href="#cb104-58" tabindex="-1"></a><span class="co">     glyphs above or below it.  */</span></span>
<span id="cb104-59"><a aria-hidden="true" href="#cb104-59" tabindex="-1"></a>  bool_bf overlaps_vertically_p <span class="op">:</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb104-60"><a aria-hidden="true" href="#cb104-60" tabindex="-1"></a></span>
<span id="cb104-61"><a aria-hidden="true" href="#cb104-61" tabindex="-1"></a>  <span class="co">/* For terminal frames, true means glyph is a padding glyph.  Padding</span></span>
<span id="cb104-62"><a aria-hidden="true" href="#cb104-62" tabindex="-1"></a><span class="co">     glyphs are used for characters whose visual shape consists of</span></span>
<span id="cb104-63"><a aria-hidden="true" href="#cb104-63" tabindex="-1"></a><span class="co">     more than one glyph (e.g. Asian characters).  All but the first</span></span>
<span id="cb104-64"><a aria-hidden="true" href="#cb104-64" tabindex="-1"></a><span class="co">     glyph of such a glyph sequence have the padding_p flag set.  This</span></span>
<span id="cb104-65"><a aria-hidden="true" href="#cb104-65" tabindex="-1"></a><span class="co">     flag is used only to minimize code changes.  A better way would</span></span>
<span id="cb104-66"><a aria-hidden="true" href="#cb104-66" tabindex="-1"></a><span class="co">     probably be to use the width field of glyphs to express padding.</span></span>
<span id="cb104-67"><a aria-hidden="true" href="#cb104-67" tabindex="-1"></a></span>
<span id="cb104-68"><a aria-hidden="true" href="#cb104-68" tabindex="-1"></a><span class="co">     For graphic frames, true means the pixel width of the glyph in a</span></span>
<span id="cb104-69"><a aria-hidden="true" href="#cb104-69" tabindex="-1"></a><span class="co">     font is 0, but 1-pixel is padded on displaying for correct cursor</span></span>
<span id="cb104-70"><a aria-hidden="true" href="#cb104-70" tabindex="-1"></a><span class="co">     displaying.  The member `pixel_width' above is set to 1.  */</span></span>
<span id="cb104-71"><a aria-hidden="true" href="#cb104-71" tabindex="-1"></a>  bool_bf padding_p <span class="op">:</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb104-72"><a aria-hidden="true" href="#cb104-72" tabindex="-1"></a></span>
<span id="cb104-73"><a aria-hidden="true" href="#cb104-73" tabindex="-1"></a>  <span class="co">/* True means the actual glyph is not available, draw using `struct</span></span>
<span id="cb104-74"><a aria-hidden="true" href="#cb104-74" tabindex="-1"></a><span class="co">     glyphless' below instead.  This can happen when a font couldn't</span></span>
<span id="cb104-75"><a aria-hidden="true" href="#cb104-75" tabindex="-1"></a><span class="co">     be loaded, or a character doesn't have a glyph in a font.  */</span></span>
<span id="cb104-76"><a aria-hidden="true" href="#cb104-76" tabindex="-1"></a>  bool_bf glyph_not_available_p <span class="op">:</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb104-77"><a aria-hidden="true" href="#cb104-77" tabindex="-1"></a></span>
<span id="cb104-78"><a aria-hidden="true" href="#cb104-78" tabindex="-1"></a>  <span class="co">/* True means don't display cursor here.  */</span></span>
<span id="cb104-79"><a aria-hidden="true" href="#cb104-79" tabindex="-1"></a>  bool_bf avoid_cursor_p <span class="op">:</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb104-80"><a aria-hidden="true" href="#cb104-80" tabindex="-1"></a></span>
<span id="cb104-81"><a aria-hidden="true" href="#cb104-81" tabindex="-1"></a>  <span class="co">/* Resolved bidirectional level of this character [0..127].  */</span></span>
<span id="cb104-82"><a aria-hidden="true" href="#cb104-82" tabindex="-1"></a>  <span class="dt">unsigned</span> resolved_level <span class="op">:</span> <span class="dv">7</span><span class="op">;</span></span>
<span id="cb104-83"><a aria-hidden="true" href="#cb104-83" tabindex="-1"></a></span>
<span id="cb104-84"><a aria-hidden="true" href="#cb104-84" tabindex="-1"></a>  <span class="co">/* Resolved bidirectional type of this character, see enum</span></span>
<span id="cb104-85"><a aria-hidden="true" href="#cb104-85" tabindex="-1"></a><span class="co">     bidi_type_t below.  Note that according to UAX#9, only some</span></span>
<span id="cb104-86"><a aria-hidden="true" href="#cb104-86" tabindex="-1"></a><span class="co">     values (STRONG_L, STRONG_R, WEAK_AN, WEAK_EN, WEAK_BN, and</span></span>
<span id="cb104-87"><a aria-hidden="true" href="#cb104-87" tabindex="-1"></a><span class="co">     NEUTRAL_B) can appear in the resolved type, so we only reserve</span></span>
<span id="cb104-88"><a aria-hidden="true" href="#cb104-88" tabindex="-1"></a><span class="co">     space for those that can.  */</span></span>
<span id="cb104-89"><a aria-hidden="true" href="#cb104-89" tabindex="-1"></a>  <span class="dt">unsigned</span> bidi_type <span class="op">:</span> <span class="dv">3</span><span class="op">;</span></span>
<span id="cb104-90"><a aria-hidden="true" href="#cb104-90" tabindex="-1"></a></span>
<span id="cb104-91"><a aria-hidden="true" href="#cb104-91" tabindex="-1"></a><span class="pp">#define FACE_ID_BITS    </span><span class="dv">20</span></span>
<span id="cb104-92"><a aria-hidden="true" href="#cb104-92" tabindex="-1"></a></span>
<span id="cb104-93"><a aria-hidden="true" href="#cb104-93" tabindex="-1"></a>  <span class="co">/* Face of the glyph.  This is a realized face ID,</span></span>
<span id="cb104-94"><a aria-hidden="true" href="#cb104-94" tabindex="-1"></a><span class="co">     an index in the face cache of the frame.  */</span></span>
<span id="cb104-95"><a aria-hidden="true" href="#cb104-95" tabindex="-1"></a>  <span class="dt">unsigned</span> face_id <span class="op">:</span> FACE_ID_BITS<span class="op">;</span></span></code></pre></div>
<p>This structure is a masterclass in bit-packing optimization, using
bitfields extensively to minimize memory usage while maintaining rich
metadata about each display element.</p>
<h3 data-number="7.5.5" id="frame-matrices-text-mode-terminal-optimization"><span class="header-section-number">7.5.5</span> Frame Matrices: Text-Mode
Terminal Optimization</h3>
<p>On text-mode terminals (TTYs), an additional optimization uses
<strong>frame matrices</strong> to enable efficient scrolling. From
<code>src/xdisp.c:307-335</code>:</p>
<div class="sourceCode" id="cb105"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb105-1"><a aria-hidden="true" href="#cb105-1" tabindex="-1"></a><span class="co">/*</span></span>
<span id="cb105-2"><a aria-hidden="true" href="#cb105-2" tabindex="-1"></a><span class="co">   Frame matrices.</span></span>
<span id="cb105-3"><a aria-hidden="true" href="#cb105-3" tabindex="-1"></a></span>
<span id="cb105-4"><a aria-hidden="true" href="#cb105-4" tabindex="-1"></a><span class="co">   That just couldn't be all, could it?  What about terminal types not</span></span>
<span id="cb105-5"><a aria-hidden="true" href="#cb105-5" tabindex="-1"></a><span class="co">   supporting operations on sub-windows of the screen (a.k.a. "TTY" or</span></span>
<span id="cb105-6"><a aria-hidden="true" href="#cb105-6" tabindex="-1"></a><span class="co">   "text-mode terminals")?  To update the display on such a terminal,</span></span>
<span id="cb105-7"><a aria-hidden="true" href="#cb105-7" tabindex="-1"></a><span class="co">   window-based glyph matrices are not well suited.  To be able to</span></span>
<span id="cb105-8"><a aria-hidden="true" href="#cb105-8" tabindex="-1"></a><span class="co">   reuse part of the display (scrolling lines up and down), we must</span></span>
<span id="cb105-9"><a aria-hidden="true" href="#cb105-9" tabindex="-1"></a><span class="co">   instead have a view of the whole screen.  This is what `frame</span></span>
<span id="cb105-10"><a aria-hidden="true" href="#cb105-10" tabindex="-1"></a><span class="co">   matrices' are for.  They are a trick.</span></span>
<span id="cb105-11"><a aria-hidden="true" href="#cb105-11" tabindex="-1"></a></span>
<span id="cb105-12"><a aria-hidden="true" href="#cb105-12" tabindex="-1"></a><span class="co">   Frames on text terminals have a glyph pool.  Windows on such a</span></span>
<span id="cb105-13"><a aria-hidden="true" href="#cb105-13" tabindex="-1"></a><span class="co">   frame sub-allocate their glyph memory from their frame's glyph</span></span>
<span id="cb105-14"><a aria-hidden="true" href="#cb105-14" tabindex="-1"></a><span class="co">   pool.  The frame itself is given its own glyph matrices.  By</span></span>
<span id="cb105-15"><a aria-hidden="true" href="#cb105-15" tabindex="-1"></a><span class="co">   coincidence---or maybe something else---rows in window glyph</span></span>
<span id="cb105-16"><a aria-hidden="true" href="#cb105-16" tabindex="-1"></a><span class="co">   matrices are slices of corresponding rows in frame matrices.  Thus</span></span>
<span id="cb105-17"><a aria-hidden="true" href="#cb105-17" tabindex="-1"></a><span class="co">   writing to window matrices implicitly updates a frame matrix which</span></span>
<span id="cb105-18"><a aria-hidden="true" href="#cb105-18" tabindex="-1"></a><span class="co">   provides us with the view of the whole screen that we originally</span></span>
<span id="cb105-19"><a aria-hidden="true" href="#cb105-19" tabindex="-1"></a><span class="co">   wanted to have without having to move many bytes around.  Then</span></span>
<span id="cb105-20"><a aria-hidden="true" href="#cb105-20" tabindex="-1"></a><span class="co">   updating all the visible windows on text-terminal frames is done by</span></span>
<span id="cb105-21"><a aria-hidden="true" href="#cb105-21" tabindex="-1"></a><span class="co">   using the frame matrices, which allows frame-global optimization of</span></span>
<span id="cb105-22"><a aria-hidden="true" href="#cb105-22" tabindex="-1"></a><span class="co">   what is actually written to the glass.</span></span>
<span id="cb105-23"><a aria-hidden="true" href="#cb105-23" tabindex="-1"></a></span>
<span id="cb105-24"><a aria-hidden="true" href="#cb105-24" tabindex="-1"></a><span class="co">   Frame matrices don't have marginal areas, only a text area.  That</span></span>
<span id="cb105-25"><a aria-hidden="true" href="#cb105-25" tabindex="-1"></a><span class="co">   is, the entire row of glyphs that spans the width of a text-mode</span></span>
<span id="cb105-26"><a aria-hidden="true" href="#cb105-26" tabindex="-1"></a><span class="co">   frame is treated as a single large "text area" for the purposes of</span></span>
<span id="cb105-27"><a aria-hidden="true" href="#cb105-27" tabindex="-1"></a><span class="co">   manipulating and updating a frame glyph matrix.</span></span>
<span id="cb105-28"><a aria-hidden="true" href="#cb105-28" tabindex="-1"></a><span class="co">*/</span></span></code></pre></div>
<p>This ‚Äútrick‚Äù is brilliant: by making window matrix rows point into
frame matrix rows, updates to windows automatically update the
frame-wide view needed for terminal scrolling optimization.</p>
<hr/>
<h2 data-number="7.6" id="the-display-iterator"><span class="header-section-number">7.6</span> The Display Iterator</h2>
<h3 data-number="7.6.1" id="purpose-and-design"><span class="header-section-number">7.6.1</span> Purpose and Design</h3>
<p>The display iterator (<code>struct it</code>) is the workhorse of
text layout. It traverses buffer or string text, handling:</p>
<ul>
<li>Text properties and overlays</li>
<li>Face changes</li>
<li>Display properties (images, space specs)</li>
<li>Bidirectional text reordering</li>
<li>Character composition</li>
<li>Invisible text</li>
</ul>
<p>From <code>src/xdisp.c:222-246</code>:</p>
<div class="sourceCode" id="cb106"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb106-1"><a aria-hidden="true" href="#cb106-1" tabindex="-1"></a><span class="co">/*</span></span>
<span id="cb106-2"><a aria-hidden="true" href="#cb106-2" tabindex="-1"></a><span class="co">   Iteration over buffer and strings.</span></span>
<span id="cb106-3"><a aria-hidden="true" href="#cb106-3" tabindex="-1"></a></span>
<span id="cb106-4"><a aria-hidden="true" href="#cb106-4" tabindex="-1"></a><span class="co">   Characters and pixmaps displayed for a range of buffer text depend</span></span>
<span id="cb106-5"><a aria-hidden="true" href="#cb106-5" tabindex="-1"></a><span class="co">   on various settings of buffers and windows, on overlays and text</span></span>
<span id="cb106-6"><a aria-hidden="true" href="#cb106-6" tabindex="-1"></a><span class="co">   properties, on display tables, on selective display.  The good news</span></span>
<span id="cb106-7"><a aria-hidden="true" href="#cb106-7" tabindex="-1"></a><span class="co">   is that all this hairy stuff is hidden behind a small set of</span></span>
<span id="cb106-8"><a aria-hidden="true" href="#cb106-8" tabindex="-1"></a><span class="co">   interface functions taking an iterator structure (`struct it')</span></span>
<span id="cb106-9"><a aria-hidden="true" href="#cb106-9" tabindex="-1"></a><span class="co">   argument.</span></span>
<span id="cb106-10"><a aria-hidden="true" href="#cb106-10" tabindex="-1"></a></span>
<span id="cb106-11"><a aria-hidden="true" href="#cb106-11" tabindex="-1"></a><span class="co">   Iteration over things to be displayed is then simple.  It is</span></span>
<span id="cb106-12"><a aria-hidden="true" href="#cb106-12" tabindex="-1"></a><span class="co">   started by initializing an iterator with a call to `init_iterator',</span></span>
<span id="cb106-13"><a aria-hidden="true" href="#cb106-13" tabindex="-1"></a><span class="co">   passing it the buffer position where to start iteration.  For</span></span>
<span id="cb106-14"><a aria-hidden="true" href="#cb106-14" tabindex="-1"></a><span class="co">   iteration over strings, pass -1 as the position to `init_iterator',</span></span>
<span id="cb106-15"><a aria-hidden="true" href="#cb106-15" tabindex="-1"></a><span class="co">   and call `reseat_to_string' when the string is ready, to initialize</span></span>
<span id="cb106-16"><a aria-hidden="true" href="#cb106-16" tabindex="-1"></a><span class="co">   the iterator for that string.  Thereafter, calls to</span></span>
<span id="cb106-17"><a aria-hidden="true" href="#cb106-17" tabindex="-1"></a><span class="co">   `get_next_display_element' fill the iterator structure with</span></span>
<span id="cb106-18"><a aria-hidden="true" href="#cb106-18" tabindex="-1"></a><span class="co">   relevant information about the next thing to display.  Calls to</span></span>
<span id="cb106-19"><a aria-hidden="true" href="#cb106-19" tabindex="-1"></a><span class="co">   `set_iterator_to_next' move the iterator to the next thing.</span></span>
<span id="cb106-20"><a aria-hidden="true" href="#cb106-20" tabindex="-1"></a></span>
<span id="cb106-21"><a aria-hidden="true" href="#cb106-21" tabindex="-1"></a><span class="co">   Besides this, an iterator also contains information about the</span></span>
<span id="cb106-22"><a aria-hidden="true" href="#cb106-22" tabindex="-1"></a><span class="co">   display environment in which glyphs for display elements are to be</span></span>
<span id="cb106-23"><a aria-hidden="true" href="#cb106-23" tabindex="-1"></a><span class="co">   produced.  It has fields for the width and height of the display,</span></span>
<span id="cb106-24"><a aria-hidden="true" href="#cb106-24" tabindex="-1"></a><span class="co">   the information whether long lines are truncated or continued, a</span></span>
<span id="cb106-25"><a aria-hidden="true" href="#cb106-25" tabindex="-1"></a><span class="co">   current X and Y position, the face currently in effect, and lots of</span></span>
<span id="cb106-26"><a aria-hidden="true" href="#cb106-26" tabindex="-1"></a><span class="co">   other stuff you can better see in dispextern.h.</span></span>
<span id="cb106-27"><a aria-hidden="true" href="#cb106-27" tabindex="-1"></a><span class="co">*/</span></span></code></pre></div>
<h3 data-number="7.6.2" id="iterator-structure"><span class="header-section-number">7.6.2</span> Iterator Structure</h3>
<p>From <code>src/dispextern.h:2391-2640</code>:</p>
<div class="sourceCode" id="cb107"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb107-1"><a aria-hidden="true" href="#cb107-1" tabindex="-1"></a><span class="kw">struct</span> it</span>
<span id="cb107-2"><a aria-hidden="true" href="#cb107-2" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb107-3"><a aria-hidden="true" href="#cb107-3" tabindex="-1"></a>  <span class="co">/* The window in which we iterate over current_buffer (or a string).  */</span></span>
<span id="cb107-4"><a aria-hidden="true" href="#cb107-4" tabindex="-1"></a>  Lisp_Object window<span class="op">;</span></span>
<span id="cb107-5"><a aria-hidden="true" href="#cb107-5" tabindex="-1"></a>  <span class="kw">struct</span> window <span class="op">*</span>w<span class="op">;</span></span>
<span id="cb107-6"><a aria-hidden="true" href="#cb107-6" tabindex="-1"></a></span>
<span id="cb107-7"><a aria-hidden="true" href="#cb107-7" tabindex="-1"></a>  <span class="co">/* The window's frame.  */</span></span>
<span id="cb107-8"><a aria-hidden="true" href="#cb107-8" tabindex="-1"></a>  <span class="kw">struct</span> frame <span class="op">*</span>f<span class="op">;</span></span>
<span id="cb107-9"><a aria-hidden="true" href="#cb107-9" tabindex="-1"></a></span>
<span id="cb107-10"><a aria-hidden="true" href="#cb107-10" tabindex="-1"></a>  <span class="co">/* Method to use to load this structure with the next display element.  */</span></span>
<span id="cb107-11"><a aria-hidden="true" href="#cb107-11" tabindex="-1"></a>  <span class="kw">enum</span> it_method method<span class="op">;</span></span>
<span id="cb107-12"><a aria-hidden="true" href="#cb107-12" tabindex="-1"></a></span>
<span id="cb107-13"><a aria-hidden="true" href="#cb107-13" tabindex="-1"></a>  <span class="co">/* The next position at which to check for face changes, invisible</span></span>
<span id="cb107-14"><a aria-hidden="true" href="#cb107-14" tabindex="-1"></a><span class="co">     text, overlay strings, end of text etc., which see.  */</span></span>
<span id="cb107-15"><a aria-hidden="true" href="#cb107-15" tabindex="-1"></a>  <span class="dt">ptrdiff_t</span> stop_charpos<span class="op">;</span></span>
<span id="cb107-16"><a aria-hidden="true" href="#cb107-16" tabindex="-1"></a></span>
<span id="cb107-17"><a aria-hidden="true" href="#cb107-17" tabindex="-1"></a>  <span class="co">/* Previous stop position, i.e. the last one before the current</span></span>
<span id="cb107-18"><a aria-hidden="true" href="#cb107-18" tabindex="-1"></a><span class="co">     iterator position in `current'.  */</span></span>
<span id="cb107-19"><a aria-hidden="true" href="#cb107-19" tabindex="-1"></a>  <span class="dt">ptrdiff_t</span> prev_stop<span class="op">;</span></span>
<span id="cb107-20"><a aria-hidden="true" href="#cb107-20" tabindex="-1"></a></span>
<span id="cb107-21"><a aria-hidden="true" href="#cb107-21" tabindex="-1"></a>  <span class="co">/* Last stop position iterated across whose bidi embedding level is</span></span>
<span id="cb107-22"><a aria-hidden="true" href="#cb107-22" tabindex="-1"></a><span class="co">     equal to the current paragraph's base embedding level.  */</span></span>
<span id="cb107-23"><a aria-hidden="true" href="#cb107-23" tabindex="-1"></a>  <span class="dt">ptrdiff_t</span> base_level_stop<span class="op">;</span></span>
<span id="cb107-24"><a aria-hidden="true" href="#cb107-24" tabindex="-1"></a></span>
<span id="cb107-25"><a aria-hidden="true" href="#cb107-25" tabindex="-1"></a>  <span class="co">/* Maximum string or buffer position + 1.  ZV when iterating over</span></span>
<span id="cb107-26"><a aria-hidden="true" href="#cb107-26" tabindex="-1"></a><span class="co">     current_buffer.  When iterating over a string in display_string,</span></span>
<span id="cb107-27"><a aria-hidden="true" href="#cb107-27" tabindex="-1"></a><span class="co">     this can be smaller or greater than the number of string</span></span>
<span id="cb107-28"><a aria-hidden="true" href="#cb107-28" tabindex="-1"></a><span class="co">     characters, depending on the values of PRECISION and FIELD_WIDTH</span></span>
<span id="cb107-29"><a aria-hidden="true" href="#cb107-29" tabindex="-1"></a><span class="co">     with which display_string was called.  */</span></span>
<span id="cb107-30"><a aria-hidden="true" href="#cb107-30" tabindex="-1"></a>  <span class="dt">ptrdiff_t</span> end_charpos<span class="op">;</span></span></code></pre></div>
<h3 data-number="7.6.3" id="the-stop-position-mechanism"><span class="header-section-number">7.6.3</span> The Stop Position
Mechanism</h3>
<p>One of the most important optimizations in the iterator is the
<strong>stop position</strong>. From
<code>src/xdisp.c:248-288</code>:</p>
<div class="sourceCode" id="cb108"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb108-1"><a aria-hidden="true" href="#cb108-1" tabindex="-1"></a><span class="co">/*</span></span>
<span id="cb108-2"><a aria-hidden="true" href="#cb108-2" tabindex="-1"></a><span class="co">   The "stop position".</span></span>
<span id="cb108-3"><a aria-hidden="true" href="#cb108-3" tabindex="-1"></a></span>
<span id="cb108-4"><a aria-hidden="true" href="#cb108-4" tabindex="-1"></a><span class="co">   Some of the fields maintained by the iterator change relatively</span></span>
<span id="cb108-5"><a aria-hidden="true" href="#cb108-5" tabindex="-1"></a><span class="co">   infrequently.  These include the face of the characters, whether</span></span>
<span id="cb108-6"><a aria-hidden="true" href="#cb108-6" tabindex="-1"></a><span class="co">   text is invisible, the object (buffer or display or overlay string)</span></span>
<span id="cb108-7"><a aria-hidden="true" href="#cb108-7" tabindex="-1"></a><span class="co">   being iterated, character composition info, etc.  For any given</span></span>
<span id="cb108-8"><a aria-hidden="true" href="#cb108-8" tabindex="-1"></a><span class="co">   buffer or string position, the sources of information that affects</span></span>
<span id="cb108-9"><a aria-hidden="true" href="#cb108-9" tabindex="-1"></a><span class="co">   the display can be determined by calling the appropriate</span></span>
<span id="cb108-10"><a aria-hidden="true" href="#cb108-10" tabindex="-1"></a><span class="co">   primitives, such as `Fnext_single_property_change', but both these</span></span>
<span id="cb108-11"><a aria-hidden="true" href="#cb108-11" tabindex="-1"></a><span class="co">   calls and the processing of their return values is relatively</span></span>
<span id="cb108-12"><a aria-hidden="true" href="#cb108-12" tabindex="-1"></a><span class="co">   expensive.  To optimize redisplay, the display engine checks these</span></span>
<span id="cb108-13"><a aria-hidden="true" href="#cb108-13" tabindex="-1"></a><span class="co">   sources of display information only when needed, not for every</span></span>
<span id="cb108-14"><a aria-hidden="true" href="#cb108-14" tabindex="-1"></a><span class="co">   character.  To that end, it always maintains the position of the</span></span>
<span id="cb108-15"><a aria-hidden="true" href="#cb108-15" tabindex="-1"></a><span class="co">   next place where it must stop and re-examine all those potential</span></span>
<span id="cb108-16"><a aria-hidden="true" href="#cb108-16" tabindex="-1"></a><span class="co">   sources.  This is called "the stop position" and is stored in the</span></span>
<span id="cb108-17"><a aria-hidden="true" href="#cb108-17" tabindex="-1"></a><span class="co">   `stop_charpos' field of the iterator.  The stop position is updated</span></span>
<span id="cb108-18"><a aria-hidden="true" href="#cb108-18" tabindex="-1"></a><span class="co">   by `compute_stop_pos', which is called whenever the iteration</span></span>
<span id="cb108-19"><a aria-hidden="true" href="#cb108-19" tabindex="-1"></a><span class="co">   reaches the current stop position and processes it.  Processing a</span></span>
<span id="cb108-20"><a aria-hidden="true" href="#cb108-20" tabindex="-1"></a><span class="co">   stop position is done by `handle_stop', which invokes a series of</span></span>
<span id="cb108-21"><a aria-hidden="true" href="#cb108-21" tabindex="-1"></a><span class="co">   handlers, one each for every potential source of display-related</span></span>
<span id="cb108-22"><a aria-hidden="true" href="#cb108-22" tabindex="-1"></a><span class="co">   information; see the `it_props' array for those handlers.  For</span></span>
<span id="cb108-23"><a aria-hidden="true" href="#cb108-23" tabindex="-1"></a><span class="co">   example, one handler is `handle_face_prop', which detects changes</span></span>
<span id="cb108-24"><a aria-hidden="true" href="#cb108-24" tabindex="-1"></a><span class="co">   in face properties, and supplies the face ID that the iterator will</span></span>
<span id="cb108-25"><a aria-hidden="true" href="#cb108-25" tabindex="-1"></a><span class="co">   use for all the glyphs it generates up to the next stop position;</span></span>
<span id="cb108-26"><a aria-hidden="true" href="#cb108-26" tabindex="-1"></a><span class="co">   this face ID is the result of "realizing" the face specified by the</span></span>
<span id="cb108-27"><a aria-hidden="true" href="#cb108-27" tabindex="-1"></a><span class="co">   relevant text properties at this position (see xfaces.c).  Each</span></span>
<span id="cb108-28"><a aria-hidden="true" href="#cb108-28" tabindex="-1"></a><span class="co">   handler called by `handle_stop' processes the sources of display</span></span>
<span id="cb108-29"><a aria-hidden="true" href="#cb108-29" tabindex="-1"></a><span class="co">   information for which it is "responsible", and returns a value</span></span>
<span id="cb108-30"><a aria-hidden="true" href="#cb108-30" tabindex="-1"></a><span class="co">   which tells `handle_stop' what to do next.</span></span>
<span id="cb108-31"><a aria-hidden="true" href="#cb108-31" tabindex="-1"></a></span>
<span id="cb108-32"><a aria-hidden="true" href="#cb108-32" tabindex="-1"></a><span class="co">   Once `handle_stop' returns, the information it stores in the</span></span>
<span id="cb108-33"><a aria-hidden="true" href="#cb108-33" tabindex="-1"></a><span class="co">   iterator fields will not be refreshed until the iteration reaches</span></span>
<span id="cb108-34"><a aria-hidden="true" href="#cb108-34" tabindex="-1"></a><span class="co">   the next stop position, which is computed by `compute_stop_pos'</span></span>
<span id="cb108-35"><a aria-hidden="true" href="#cb108-35" tabindex="-1"></a><span class="co">   called at the end of `handle_stop'.  `compute_stop_pos' examines</span></span>
<span id="cb108-36"><a aria-hidden="true" href="#cb108-36" tabindex="-1"></a><span class="co">   the buffer's or string's interval tree to determine where the text</span></span>
<span id="cb108-37"><a aria-hidden="true" href="#cb108-37" tabindex="-1"></a><span class="co">   properties change, finds the next position where overlays and</span></span>
<span id="cb108-38"><a aria-hidden="true" href="#cb108-38" tabindex="-1"></a><span class="co">   character composition can change, and stores in `stop_charpos' the</span></span>
<span id="cb108-39"><a aria-hidden="true" href="#cb108-39" tabindex="-1"></a><span class="co">   closest position where any of these factors should be reconsidered.</span></span>
<span id="cb108-40"><a aria-hidden="true" href="#cb108-40" tabindex="-1"></a></span>
<span id="cb108-41"><a aria-hidden="true" href="#cb108-41" tabindex="-1"></a><span class="co">   Handling of the stop position is done as part of the code in</span></span>
<span id="cb108-42"><a aria-hidden="true" href="#cb108-42" tabindex="-1"></a><span class="co">   `get_next_display_element'.</span></span>
<span id="cb108-43"><a aria-hidden="true" href="#cb108-43" tabindex="-1"></a><span class="co">*/</span></span></code></pre></div>
<p>This mechanism is crucial for performance: instead of checking text
properties and overlays at every character, the iterator only checks at
boundaries where these properties might change.</p>
<h3 data-number="7.6.4" id="iterator-state-stack"><span class="header-section-number">7.6.4</span> Iterator State Stack</h3>
<p>The iterator maintains a stack to handle nested display elements
(like overlay strings within display properties):</p>
<div class="sourceCode" id="cb109"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb109-1"><a aria-hidden="true" href="#cb109-1" tabindex="-1"></a>  <span class="co">/* Stack of saved values.  New entries are pushed when we begin to</span></span>
<span id="cb109-2"><a aria-hidden="true" href="#cb109-2" tabindex="-1"></a><span class="co">     process an overlay string or a string from a `glyph' property.</span></span>
<span id="cb109-3"><a aria-hidden="true" href="#cb109-3" tabindex="-1"></a><span class="co">     Entries are popped when we return to deliver display elements</span></span>
<span id="cb109-4"><a aria-hidden="true" href="#cb109-4" tabindex="-1"></a><span class="co">     from what we previously had.  */</span></span>
<span id="cb109-5"><a aria-hidden="true" href="#cb109-5" tabindex="-1"></a>  <span class="kw">struct</span> iterator_stack_entry</span>
<span id="cb109-6"><a aria-hidden="true" href="#cb109-6" tabindex="-1"></a>  <span class="op">{</span></span>
<span id="cb109-7"><a aria-hidden="true" href="#cb109-7" tabindex="-1"></a>    Lisp_Object string<span class="op">;</span></span>
<span id="cb109-8"><a aria-hidden="true" href="#cb109-8" tabindex="-1"></a>    <span class="dt">int</span> string_nchars<span class="op">;</span></span>
<span id="cb109-9"><a aria-hidden="true" href="#cb109-9" tabindex="-1"></a>    <span class="dt">ptrdiff_t</span> end_charpos<span class="op">;</span></span>
<span id="cb109-10"><a aria-hidden="true" href="#cb109-10" tabindex="-1"></a>    <span class="dt">ptrdiff_t</span> stop_charpos<span class="op">;</span></span>
<span id="cb109-11"><a aria-hidden="true" href="#cb109-11" tabindex="-1"></a>    <span class="dt">ptrdiff_t</span> prev_stop<span class="op">;</span></span>
<span id="cb109-12"><a aria-hidden="true" href="#cb109-12" tabindex="-1"></a>    <span class="dt">ptrdiff_t</span> base_level_stop<span class="op">;</span></span>
<span id="cb109-13"><a aria-hidden="true" href="#cb109-13" tabindex="-1"></a>    <span class="kw">struct</span> composition_it cmp_it<span class="op">;</span></span>
<span id="cb109-14"><a aria-hidden="true" href="#cb109-14" tabindex="-1"></a>    <span class="dt">int</span> face_id<span class="op">;</span></span>
<span id="cb109-15"><a aria-hidden="true" href="#cb109-15" tabindex="-1"></a></span>
<span id="cb109-16"><a aria-hidden="true" href="#cb109-16" tabindex="-1"></a>    <span class="co">/* Save values specific to a given method.  */</span></span>
<span id="cb109-17"><a aria-hidden="true" href="#cb109-17" tabindex="-1"></a>    <span class="kw">union</span> <span class="op">{</span></span>
<span id="cb109-18"><a aria-hidden="true" href="#cb109-18" tabindex="-1"></a>      <span class="co">/* method == GET_FROM_IMAGE */</span></span>
<span id="cb109-19"><a aria-hidden="true" href="#cb109-19" tabindex="-1"></a>      <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb109-20"><a aria-hidden="true" href="#cb109-20" tabindex="-1"></a>    Lisp_Object object<span class="op">;</span></span>
<span id="cb109-21"><a aria-hidden="true" href="#cb109-21" tabindex="-1"></a>    <span class="kw">struct</span> it_slice slice<span class="op">;</span></span>
<span id="cb109-22"><a aria-hidden="true" href="#cb109-22" tabindex="-1"></a>    <span class="dt">ptrdiff_t</span> image_id<span class="op">;</span></span>
<span id="cb109-23"><a aria-hidden="true" href="#cb109-23" tabindex="-1"></a>      <span class="op">}</span> image<span class="op">;</span></span>
<span id="cb109-24"><a aria-hidden="true" href="#cb109-24" tabindex="-1"></a>      <span class="co">/* method == GET_FROM_STRETCH */</span></span>
<span id="cb109-25"><a aria-hidden="true" href="#cb109-25" tabindex="-1"></a>      <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb109-26"><a aria-hidden="true" href="#cb109-26" tabindex="-1"></a>    Lisp_Object object<span class="op">;</span></span>
<span id="cb109-27"><a aria-hidden="true" href="#cb109-27" tabindex="-1"></a>      <span class="op">}</span> stretch<span class="op">;</span></span>
<span id="cb109-28"><a aria-hidden="true" href="#cb109-28" tabindex="-1"></a>      <span class="co">/* method == GET_FROM_XWIDGET */</span></span>
<span id="cb109-29"><a aria-hidden="true" href="#cb109-29" tabindex="-1"></a>      <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb109-30"><a aria-hidden="true" href="#cb109-30" tabindex="-1"></a>    Lisp_Object object<span class="op">;</span></span>
<span id="cb109-31"><a aria-hidden="true" href="#cb109-31" tabindex="-1"></a>      <span class="op">}</span> xwidget<span class="op">;</span></span>
<span id="cb109-32"><a aria-hidden="true" href="#cb109-32" tabindex="-1"></a>    <span class="op">}</span> u<span class="op">;</span></span>
<span id="cb109-33"><a aria-hidden="true" href="#cb109-33" tabindex="-1"></a></span>
<span id="cb109-34"><a aria-hidden="true" href="#cb109-34" tabindex="-1"></a>    <span class="co">/* Current text and display positions.  */</span></span>
<span id="cb109-35"><a aria-hidden="true" href="#cb109-35" tabindex="-1"></a>    <span class="kw">struct</span> text_pos position<span class="op">;</span></span>
<span id="cb109-36"><a aria-hidden="true" href="#cb109-36" tabindex="-1"></a>    <span class="kw">struct</span> display_pos current<span class="op">;</span></span>
<span id="cb109-37"><a aria-hidden="true" href="#cb109-37" tabindex="-1"></a>    Lisp_Object from_overlay<span class="op">;</span></span>
<span id="cb109-38"><a aria-hidden="true" href="#cb109-38" tabindex="-1"></a>    <span class="kw">enum</span> glyph_row_area area<span class="op">;</span></span>
<span id="cb109-39"><a aria-hidden="true" href="#cb109-39" tabindex="-1"></a>    <span class="kw">enum</span> it_method method<span class="op">;</span></span>
<span id="cb109-40"><a aria-hidden="true" href="#cb109-40" tabindex="-1"></a>    bidi_dir_t paragraph_embedding<span class="op">;</span></span>
<span id="cb109-41"><a aria-hidden="true" href="#cb109-41" tabindex="-1"></a>    bool_bf multibyte_p <span class="op">:</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb109-42"><a aria-hidden="true" href="#cb109-42" tabindex="-1"></a>    bool_bf string_from_display_prop_p <span class="op">:</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb109-43"><a aria-hidden="true" href="#cb109-43" tabindex="-1"></a>    bool_bf string_from_prefix_prop_p <span class="op">:</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb109-44"><a aria-hidden="true" href="#cb109-44" tabindex="-1"></a>    bool_bf display_ellipsis_p <span class="op">:</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb109-45"><a aria-hidden="true" href="#cb109-45" tabindex="-1"></a>    bool_bf avoid_cursor_p <span class="op">:</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb109-46"><a aria-hidden="true" href="#cb109-46" tabindex="-1"></a>    bool_bf bidi_p <span class="op">:</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb109-47"><a aria-hidden="true" href="#cb109-47" tabindex="-1"></a>    bool_bf from_disp_prop_p <span class="op">:</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb109-48"><a aria-hidden="true" href="#cb109-48" tabindex="-1"></a>    <span class="kw">enum</span> line_wrap_method line_wrap<span class="op">;</span></span>
<span id="cb109-49"><a aria-hidden="true" href="#cb109-49" tabindex="-1"></a></span>
<span id="cb109-50"><a aria-hidden="true" href="#cb109-50" tabindex="-1"></a>    <span class="co">/* Properties from display property that are reset by another display</span></span>
<span id="cb109-51"><a aria-hidden="true" href="#cb109-51" tabindex="-1"></a><span class="co">       property.  */</span></span>
<span id="cb109-52"><a aria-hidden="true" href="#cb109-52" tabindex="-1"></a>    <span class="dt">short</span> voffset<span class="op">;</span></span>
<span id="cb109-53"><a aria-hidden="true" href="#cb109-53" tabindex="-1"></a>    Lisp_Object space_width<span class="op">;</span></span>
<span id="cb109-54"><a aria-hidden="true" href="#cb109-54" tabindex="-1"></a>    Lisp_Object font_height<span class="op">;</span></span>
<span id="cb109-55"><a aria-hidden="true" href="#cb109-55" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb109-56"><a aria-hidden="true" href="#cb109-56" tabindex="-1"></a>  stack<span class="op">[</span>IT_STACK_SIZE<span class="op">];</span></span>
<span id="cb109-57"><a aria-hidden="true" href="#cb109-57" tabindex="-1"></a></span>
<span id="cb109-58"><a aria-hidden="true" href="#cb109-58" tabindex="-1"></a>  <span class="co">/* Stack pointer.  */</span></span>
<span id="cb109-59"><a aria-hidden="true" href="#cb109-59" tabindex="-1"></a>  <span class="dt">int</span> sp<span class="op">;</span></span></code></pre></div>
<hr/>
<h2 data-number="7.7" id="face-management-and-realization"><span class="header-section-number">7.7</span> Face Management and
Realization</h2>
<h3 data-number="7.7.1" id="the-face-system-architecture"><span class="header-section-number">7.7.1</span> The Face System
Architecture</h3>
<p>Faces in Emacs have a two-tier architecture:</p>
<ol type="1">
<li><strong>Lisp Faces</strong>: High-level face definitions with named
attributes</li>
<li><strong>Realized Faces</strong>: Low-level, platform-specific
rendering information</li>
</ol>
<p>From <code>src/xfaces.c:22-217</code>:</p>
<div class="sourceCode" id="cb110"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb110-1"><a aria-hidden="true" href="#cb110-1" tabindex="-1"></a><span class="co">/* Faces.</span></span>
<span id="cb110-2"><a aria-hidden="true" href="#cb110-2" tabindex="-1"></a></span>
<span id="cb110-3"><a aria-hidden="true" href="#cb110-3" tabindex="-1"></a><span class="co">   When using Emacs with X, the display style of characters can be</span></span>
<span id="cb110-4"><a aria-hidden="true" href="#cb110-4" tabindex="-1"></a><span class="co">   changed by defining `faces'.  Each face can specify the following</span></span>
<span id="cb110-5"><a aria-hidden="true" href="#cb110-5" tabindex="-1"></a><span class="co">   display attributes:</span></span>
<span id="cb110-6"><a aria-hidden="true" href="#cb110-6" tabindex="-1"></a></span>
<span id="cb110-7"><a aria-hidden="true" href="#cb110-7" tabindex="-1"></a><span class="co">   1. Font family name.</span></span>
<span id="cb110-8"><a aria-hidden="true" href="#cb110-8" tabindex="-1"></a></span>
<span id="cb110-9"><a aria-hidden="true" href="#cb110-9" tabindex="-1"></a><span class="co">   2. Font foundry name.</span></span>
<span id="cb110-10"><a aria-hidden="true" href="#cb110-10" tabindex="-1"></a></span>
<span id="cb110-11"><a aria-hidden="true" href="#cb110-11" tabindex="-1"></a><span class="co">   3. Relative proportionate width, aka character set width or set</span></span>
<span id="cb110-12"><a aria-hidden="true" href="#cb110-12" tabindex="-1"></a><span class="co">   width (swidth), e.g. `semi-compressed'.</span></span>
<span id="cb110-13"><a aria-hidden="true" href="#cb110-13" tabindex="-1"></a></span>
<span id="cb110-14"><a aria-hidden="true" href="#cb110-14" tabindex="-1"></a><span class="co">   4. Font height in 1/10pt.</span></span>
<span id="cb110-15"><a aria-hidden="true" href="#cb110-15" tabindex="-1"></a></span>
<span id="cb110-16"><a aria-hidden="true" href="#cb110-16" tabindex="-1"></a><span class="co">   5. Font weight, e.g. `bold'.</span></span>
<span id="cb110-17"><a aria-hidden="true" href="#cb110-17" tabindex="-1"></a></span>
<span id="cb110-18"><a aria-hidden="true" href="#cb110-18" tabindex="-1"></a><span class="co">   6. Font slant, e.g. `italic'.</span></span>
<span id="cb110-19"><a aria-hidden="true" href="#cb110-19" tabindex="-1"></a></span>
<span id="cb110-20"><a aria-hidden="true" href="#cb110-20" tabindex="-1"></a><span class="co">   7. Foreground color.</span></span>
<span id="cb110-21"><a aria-hidden="true" href="#cb110-21" tabindex="-1"></a></span>
<span id="cb110-22"><a aria-hidden="true" href="#cb110-22" tabindex="-1"></a><span class="co">   8. Background color.</span></span>
<span id="cb110-23"><a aria-hidden="true" href="#cb110-23" tabindex="-1"></a></span>
<span id="cb110-24"><a aria-hidden="true" href="#cb110-24" tabindex="-1"></a><span class="co">   9. Whether or not characters should be underlined, and in what color.</span></span>
<span id="cb110-25"><a aria-hidden="true" href="#cb110-25" tabindex="-1"></a></span>
<span id="cb110-26"><a aria-hidden="true" href="#cb110-26" tabindex="-1"></a><span class="co">   10. Whether or not characters should be displayed in inverse video.</span></span>
<span id="cb110-27"><a aria-hidden="true" href="#cb110-27" tabindex="-1"></a></span>
<span id="cb110-28"><a aria-hidden="true" href="#cb110-28" tabindex="-1"></a><span class="co">   11. A background stipple, a bitmap.</span></span>
<span id="cb110-29"><a aria-hidden="true" href="#cb110-29" tabindex="-1"></a></span>
<span id="cb110-30"><a aria-hidden="true" href="#cb110-30" tabindex="-1"></a><span class="co">   12. Whether or not characters should be overlined, and in what color.</span></span>
<span id="cb110-31"><a aria-hidden="true" href="#cb110-31" tabindex="-1"></a></span>
<span id="cb110-32"><a aria-hidden="true" href="#cb110-32" tabindex="-1"></a><span class="co">   13. Whether or not characters should be strike-through, and in what</span></span>
<span id="cb110-33"><a aria-hidden="true" href="#cb110-33" tabindex="-1"></a><span class="co">   color.</span></span>
<span id="cb110-34"><a aria-hidden="true" href="#cb110-34" tabindex="-1"></a></span>
<span id="cb110-35"><a aria-hidden="true" href="#cb110-35" tabindex="-1"></a><span class="co">   14. Whether or not a box should be drawn around characters, the box</span></span>
<span id="cb110-36"><a aria-hidden="true" href="#cb110-36" tabindex="-1"></a><span class="co">   type, and, for simple boxes, in what color.</span></span>
<span id="cb110-37"><a aria-hidden="true" href="#cb110-37" tabindex="-1"></a></span>
<span id="cb110-38"><a aria-hidden="true" href="#cb110-38" tabindex="-1"></a><span class="co">   15. Font-spec, or nil.  This is a special attribute.</span></span>
<span id="cb110-39"><a aria-hidden="true" href="#cb110-39" tabindex="-1"></a></span>
<span id="cb110-40"><a aria-hidden="true" href="#cb110-40" tabindex="-1"></a><span class="co">   A font-spec is a collection of font attributes (specs).</span></span>
<span id="cb110-41"><a aria-hidden="true" href="#cb110-41" tabindex="-1"></a></span>
<span id="cb110-42"><a aria-hidden="true" href="#cb110-42" tabindex="-1"></a><span class="co">   When this attribute is specified, the face uses a font matching</span></span>
<span id="cb110-43"><a aria-hidden="true" href="#cb110-43" tabindex="-1"></a><span class="co">   with the specs as is except for what overwritten by the specs in</span></span>
<span id="cb110-44"><a aria-hidden="true" href="#cb110-44" tabindex="-1"></a><span class="co">   the fontset (see below).  In addition, the other font-related</span></span>
<span id="cb110-45"><a aria-hidden="true" href="#cb110-45" tabindex="-1"></a><span class="co">   attributes (1st thru 5th) are updated from the spec.</span></span>
<span id="cb110-46"><a aria-hidden="true" href="#cb110-46" tabindex="-1"></a></span>
<span id="cb110-47"><a aria-hidden="true" href="#cb110-47" tabindex="-1"></a><span class="co">   On the other hand, if one of the other font-related attributes are</span></span>
<span id="cb110-48"><a aria-hidden="true" href="#cb110-48" tabindex="-1"></a><span class="co">   specified, the corresponding specs in this attribute is set to nil.</span></span>
<span id="cb110-49"><a aria-hidden="true" href="#cb110-49" tabindex="-1"></a></span>
<span id="cb110-50"><a aria-hidden="true" href="#cb110-50" tabindex="-1"></a><span class="co">   16. A face name or list of face names from which to inherit attributes.</span></span>
<span id="cb110-51"><a aria-hidden="true" href="#cb110-51" tabindex="-1"></a></span>
<span id="cb110-52"><a aria-hidden="true" href="#cb110-52" tabindex="-1"></a><span class="co">   17. A fontset name.  This is another special attribute.</span></span>
<span id="cb110-53"><a aria-hidden="true" href="#cb110-53" tabindex="-1"></a></span>
<span id="cb110-54"><a aria-hidden="true" href="#cb110-54" tabindex="-1"></a><span class="co">   A fontset is a mappings from characters to font-specs, and the</span></span>
<span id="cb110-55"><a aria-hidden="true" href="#cb110-55" tabindex="-1"></a><span class="co">   specs overwrite the font-spec in the 14th attribute.</span></span>
<span id="cb110-56"><a aria-hidden="true" href="#cb110-56" tabindex="-1"></a></span>
<span id="cb110-57"><a aria-hidden="true" href="#cb110-57" tabindex="-1"></a><span class="co">   18. A "distant background" color, to be used when the foreground is</span></span>
<span id="cb110-58"><a aria-hidden="true" href="#cb110-58" tabindex="-1"></a><span class="co">   too close to the background and is hard to read.</span></span>
<span id="cb110-59"><a aria-hidden="true" href="#cb110-59" tabindex="-1"></a></span>
<span id="cb110-60"><a aria-hidden="true" href="#cb110-60" tabindex="-1"></a><span class="co">   19. Whether to extend the face to end of line when the face</span></span>
<span id="cb110-61"><a aria-hidden="true" href="#cb110-61" tabindex="-1"></a><span class="co">   "covers" the newline that ends the line.</span></span>
<span id="cb110-62"><a aria-hidden="true" href="#cb110-62" tabindex="-1"></a></span>
<span id="cb110-63"><a aria-hidden="true" href="#cb110-63" tabindex="-1"></a><span class="co">   On the C level, a Lisp face is completely represented by its array</span></span>
<span id="cb110-64"><a aria-hidden="true" href="#cb110-64" tabindex="-1"></a><span class="co">   of attributes.  In that array, the zeroth element is Qface, and the</span></span>
<span id="cb110-65"><a aria-hidden="true" href="#cb110-65" tabindex="-1"></a><span class="co">   rest are the 19 face attributes described above.  The</span></span>
<span id="cb110-66"><a aria-hidden="true" href="#cb110-66" tabindex="-1"></a><span class="co">   lface_attribute_index enumeration, defined on dispextern.h, with</span></span>
<span id="cb110-67"><a aria-hidden="true" href="#cb110-67" tabindex="-1"></a><span class="co">   values given by the LFACE_*_INDEX constants, is used to reference</span></span>
<span id="cb110-68"><a aria-hidden="true" href="#cb110-68" tabindex="-1"></a><span class="co">   the individual attributes.</span></span>
<span id="cb110-69"><a aria-hidden="true" href="#cb110-69" tabindex="-1"></a></span>
<span id="cb110-70"><a aria-hidden="true" href="#cb110-70" tabindex="-1"></a><span class="co">   Faces are frame-local by nature because Emacs allows you to define the</span></span>
<span id="cb110-71"><a aria-hidden="true" href="#cb110-71" tabindex="-1"></a><span class="co">   same named face (face names are symbols) differently for different</span></span>
<span id="cb110-72"><a aria-hidden="true" href="#cb110-72" tabindex="-1"></a><span class="co">   frames.  Each frame has an alist of face definitions for all named</span></span>
<span id="cb110-73"><a aria-hidden="true" href="#cb110-73" tabindex="-1"></a><span class="co">   faces.  The value of a named face in such an alist is a Lisp vector</span></span>
<span id="cb110-74"><a aria-hidden="true" href="#cb110-74" tabindex="-1"></a><span class="co">   with the symbol `face' in slot 0, and a slot for each of the face</span></span>
<span id="cb110-75"><a aria-hidden="true" href="#cb110-75" tabindex="-1"></a><span class="co">   attributes mentioned above.</span></span>
<span id="cb110-76"><a aria-hidden="true" href="#cb110-76" tabindex="-1"></a></span>
<span id="cb110-77"><a aria-hidden="true" href="#cb110-77" tabindex="-1"></a><span class="co">   There is also a global face map `Vface_new_frame_defaults',</span></span>
<span id="cb110-78"><a aria-hidden="true" href="#cb110-78" tabindex="-1"></a><span class="co">   containing conses of (FACE_ID . FACE_DEFINITION).  Face definitions</span></span>
<span id="cb110-79"><a aria-hidden="true" href="#cb110-79" tabindex="-1"></a><span class="co">   from this table are used to initialize faces of newly created</span></span>
<span id="cb110-80"><a aria-hidden="true" href="#cb110-80" tabindex="-1"></a><span class="co">   frames.</span></span>
<span id="cb110-81"><a aria-hidden="true" href="#cb110-81" tabindex="-1"></a></span>
<span id="cb110-82"><a aria-hidden="true" href="#cb110-82" tabindex="-1"></a><span class="co">   A face doesn't have to specify all attributes.  Those not specified</span></span>
<span id="cb110-83"><a aria-hidden="true" href="#cb110-83" tabindex="-1"></a><span class="co">   have a value of `unspecified'.  Faces specifying all attributes but</span></span>
<span id="cb110-84"><a aria-hidden="true" href="#cb110-84" tabindex="-1"></a><span class="co">   the 14th are called `fully-specified'.</span></span>
<span id="cb110-85"><a aria-hidden="true" href="#cb110-85" tabindex="-1"></a></span>
<span id="cb110-86"><a aria-hidden="true" href="#cb110-86" tabindex="-1"></a></span>
<span id="cb110-87"><a aria-hidden="true" href="#cb110-87" tabindex="-1"></a><span class="co">   Face merging.</span></span>
<span id="cb110-88"><a aria-hidden="true" href="#cb110-88" tabindex="-1"></a></span>
<span id="cb110-89"><a aria-hidden="true" href="#cb110-89" tabindex="-1"></a><span class="co">   The display style of a given character in the text is determined by</span></span>
<span id="cb110-90"><a aria-hidden="true" href="#cb110-90" tabindex="-1"></a><span class="co">   combining several faces.  This process is called `face merging'.</span></span>
<span id="cb110-91"><a aria-hidden="true" href="#cb110-91" tabindex="-1"></a><span class="co">   Face merging combines the attributes of each of the faces being</span></span>
<span id="cb110-92"><a aria-hidden="true" href="#cb110-92" tabindex="-1"></a><span class="co">   merged such that the attributes of the face that is merged later</span></span>
<span id="cb110-93"><a aria-hidden="true" href="#cb110-93" tabindex="-1"></a><span class="co">   override those of a face merged earlier in the process.  In</span></span>
<span id="cb110-94"><a aria-hidden="true" href="#cb110-94" tabindex="-1"></a><span class="co">   particular, this replaces any 'unspecified' attributes with</span></span>
<span id="cb110-95"><a aria-hidden="true" href="#cb110-95" tabindex="-1"></a><span class="co">   non-'unspecified' values.  Also, if a face inherits from another</span></span>
<span id="cb110-96"><a aria-hidden="true" href="#cb110-96" tabindex="-1"></a><span class="co">   (via the :inherit attribute), the attributes of the parent face,</span></span>
<span id="cb110-97"><a aria-hidden="true" href="#cb110-97" tabindex="-1"></a><span class="co">   recursively, are applied where the inheriting face doesn't specify</span></span>
<span id="cb110-98"><a aria-hidden="true" href="#cb110-98" tabindex="-1"></a><span class="co">   non-'unspecified' values.  Any aspect of the display style that</span></span>
<span id="cb110-99"><a aria-hidden="true" href="#cb110-99" tabindex="-1"></a><span class="co">   isn't specified by overlays or text properties is taken from the</span></span>
<span id="cb110-100"><a aria-hidden="true" href="#cb110-100" tabindex="-1"></a><span class="co">   'default' face.  Since it is made sure that the default face is</span></span>
<span id="cb110-101"><a aria-hidden="true" href="#cb110-101" tabindex="-1"></a><span class="co">   always fully-specified, face merging always results in a</span></span>
<span id="cb110-102"><a aria-hidden="true" href="#cb110-102" tabindex="-1"></a><span class="co">   fully-specified face.</span></span>
<span id="cb110-103"><a aria-hidden="true" href="#cb110-103" tabindex="-1"></a></span>
<span id="cb110-104"><a aria-hidden="true" href="#cb110-104" tabindex="-1"></a></span>
<span id="cb110-105"><a aria-hidden="true" href="#cb110-105" tabindex="-1"></a><span class="co">   Face realization.</span></span>
<span id="cb110-106"><a aria-hidden="true" href="#cb110-106" tabindex="-1"></a></span>
<span id="cb110-107"><a aria-hidden="true" href="#cb110-107" tabindex="-1"></a><span class="co">   After all face attributes for a character have been determined by</span></span>
<span id="cb110-108"><a aria-hidden="true" href="#cb110-108" tabindex="-1"></a><span class="co">   merging faces of that character, that face is `realized'.  The</span></span>
<span id="cb110-109"><a aria-hidden="true" href="#cb110-109" tabindex="-1"></a><span class="co">   realization process maps face attributes to what is physically</span></span>
<span id="cb110-110"><a aria-hidden="true" href="#cb110-110" tabindex="-1"></a><span class="co">   available on the system where Emacs runs.  The result is a</span></span>
<span id="cb110-111"><a aria-hidden="true" href="#cb110-111" tabindex="-1"></a><span class="co">   `realized face' in the form of a struct face which is stored in the</span></span>
<span id="cb110-112"><a aria-hidden="true" href="#cb110-112" tabindex="-1"></a><span class="co">   face cache of the frame on which it was realized.</span></span>
<span id="cb110-113"><a aria-hidden="true" href="#cb110-113" tabindex="-1"></a></span>
<span id="cb110-114"><a aria-hidden="true" href="#cb110-114" tabindex="-1"></a><span class="co">   Face realization is done in the context of the character to display</span></span>
<span id="cb110-115"><a aria-hidden="true" href="#cb110-115" tabindex="-1"></a><span class="co">   because different fonts may be used for different characters.  In</span></span>
<span id="cb110-116"><a aria-hidden="true" href="#cb110-116" tabindex="-1"></a><span class="co">   other words, for characters that have different font</span></span>
<span id="cb110-117"><a aria-hidden="true" href="#cb110-117" tabindex="-1"></a><span class="co">   specifications, different realized faces are needed to display</span></span>
<span id="cb110-118"><a aria-hidden="true" href="#cb110-118" tabindex="-1"></a><span class="co">   them.</span></span>
<span id="cb110-119"><a aria-hidden="true" href="#cb110-119" tabindex="-1"></a></span>
<span id="cb110-120"><a aria-hidden="true" href="#cb110-120" tabindex="-1"></a><span class="co">   Font specification is done by fontsets.  See the comment in</span></span>
<span id="cb110-121"><a aria-hidden="true" href="#cb110-121" tabindex="-1"></a><span class="co">   fontset.c for the details.  In the current implementation, all ASCII</span></span>
<span id="cb110-122"><a aria-hidden="true" href="#cb110-122" tabindex="-1"></a><span class="co">   characters share the same font in a fontset.</span></span>
<span id="cb110-123"><a aria-hidden="true" href="#cb110-123" tabindex="-1"></a></span>
<span id="cb110-124"><a aria-hidden="true" href="#cb110-124" tabindex="-1"></a><span class="co">   Faces are at first realized for ASCII characters, and, at that</span></span>
<span id="cb110-125"><a aria-hidden="true" href="#cb110-125" tabindex="-1"></a><span class="co">   time, assigned a specific realized fontset.  Hereafter, we call</span></span>
<span id="cb110-126"><a aria-hidden="true" href="#cb110-126" tabindex="-1"></a><span class="co">   such a face as `ASCII face'.  When a face for a multibyte character</span></span>
<span id="cb110-127"><a aria-hidden="true" href="#cb110-127" tabindex="-1"></a><span class="co">   is realized, it inherits (thus shares) a fontset of an ASCII face</span></span>
<span id="cb110-128"><a aria-hidden="true" href="#cb110-128" tabindex="-1"></a><span class="co">   that has the same attributes other than font-related ones.</span></span>
<span id="cb110-129"><a aria-hidden="true" href="#cb110-129" tabindex="-1"></a></span>
<span id="cb110-130"><a aria-hidden="true" href="#cb110-130" tabindex="-1"></a><span class="co">   Thus, all realized faces have a realized fontset.</span></span></code></pre></div>
<h3 data-number="7.7.2" id="face-realization-process"><span class="header-section-number">7.7.2</span> Face Realization Process</h3>
<p>Face realization transforms abstract face attributes into concrete
rendering parameters:</p>
<pre><code>Lisp Face (symbolic)
        ‚Üì
   Face Merging (inherit, combine with default)
        ‚Üì
  Fully Specified Face
        ‚Üì
   Font Selection (match available fonts)
        ‚Üì
  Color Allocation (map colors to pixels)
        ‚Üì
Realized Face (cached, ready to render)</code></pre>
<h3 data-number="7.7.3" id="font-selection"><span class="header-section-number">7.7.3</span> Font Selection</h3>
<p>From <code>src/xfaces.c:162-198</code>:</p>
<div class="sourceCode" id="cb112"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb112-1"><a aria-hidden="true" href="#cb112-1" tabindex="-1"></a><span class="co">/*</span></span>
<span id="cb112-2"><a aria-hidden="true" href="#cb112-2" tabindex="-1"></a><span class="co">   Font selection.</span></span>
<span id="cb112-3"><a aria-hidden="true" href="#cb112-3" tabindex="-1"></a></span>
<span id="cb112-4"><a aria-hidden="true" href="#cb112-4" tabindex="-1"></a><span class="co">   Font selection tries to find the best available matching font for a</span></span>
<span id="cb112-5"><a aria-hidden="true" href="#cb112-5" tabindex="-1"></a><span class="co">   given (character, face) combination.</span></span>
<span id="cb112-6"><a aria-hidden="true" href="#cb112-6" tabindex="-1"></a></span>
<span id="cb112-7"><a aria-hidden="true" href="#cb112-7" tabindex="-1"></a><span class="co">   If the face specifies a fontset name, that fontset determines a</span></span>
<span id="cb112-8"><a aria-hidden="true" href="#cb112-8" tabindex="-1"></a><span class="co">   pattern for fonts of the given character.  If the face specifies a</span></span>
<span id="cb112-9"><a aria-hidden="true" href="#cb112-9" tabindex="-1"></a><span class="co">   font name or the other font-related attributes, a fontset is</span></span>
<span id="cb112-10"><a aria-hidden="true" href="#cb112-10" tabindex="-1"></a><span class="co">   realized from the default fontset.  In that case, that</span></span>
<span id="cb112-11"><a aria-hidden="true" href="#cb112-11" tabindex="-1"></a><span class="co">   specification determines a pattern for ASCII characters and the</span></span>
<span id="cb112-12"><a aria-hidden="true" href="#cb112-12" tabindex="-1"></a><span class="co">   default fontset determines a pattern for multibyte characters.</span></span>
<span id="cb112-13"><a aria-hidden="true" href="#cb112-13" tabindex="-1"></a></span>
<span id="cb112-14"><a aria-hidden="true" href="#cb112-14" tabindex="-1"></a><span class="co">   Available fonts on the system on which Emacs runs are then matched</span></span>
<span id="cb112-15"><a aria-hidden="true" href="#cb112-15" tabindex="-1"></a><span class="co">   against the font pattern.  The result of font selection is the best</span></span>
<span id="cb112-16"><a aria-hidden="true" href="#cb112-16" tabindex="-1"></a><span class="co">   match for the given face attributes in this font list.</span></span>
<span id="cb112-17"><a aria-hidden="true" href="#cb112-17" tabindex="-1"></a></span>
<span id="cb112-18"><a aria-hidden="true" href="#cb112-18" tabindex="-1"></a><span class="co">   Font selection can be influenced by the user.</span></span>
<span id="cb112-19"><a aria-hidden="true" href="#cb112-19" tabindex="-1"></a></span>
<span id="cb112-20"><a aria-hidden="true" href="#cb112-20" tabindex="-1"></a><span class="co">   1. The user can specify the relative importance he gives the face</span></span>
<span id="cb112-21"><a aria-hidden="true" href="#cb112-21" tabindex="-1"></a><span class="co">   attributes width, height, weight, and slant by setting</span></span>
<span id="cb112-22"><a aria-hidden="true" href="#cb112-22" tabindex="-1"></a><span class="co">   face-font-selection-order (faces.el) to a list of face attribute</span></span>
<span id="cb112-23"><a aria-hidden="true" href="#cb112-23" tabindex="-1"></a><span class="co">   names.  The default is '(:width :height :weight :slant), and means</span></span>
<span id="cb112-24"><a aria-hidden="true" href="#cb112-24" tabindex="-1"></a><span class="co">   that font selection first tries to find a good match for the font</span></span>
<span id="cb112-25"><a aria-hidden="true" href="#cb112-25" tabindex="-1"></a><span class="co">   width specified by a face, then---within fonts with that</span></span>
<span id="cb112-26"><a aria-hidden="true" href="#cb112-26" tabindex="-1"></a><span class="co">   width---tries to find a best match for the specified font height,</span></span>
<span id="cb112-27"><a aria-hidden="true" href="#cb112-27" tabindex="-1"></a><span class="co">   etc.</span></span>
<span id="cb112-28"><a aria-hidden="true" href="#cb112-28" tabindex="-1"></a></span>
<span id="cb112-29"><a aria-hidden="true" href="#cb112-29" tabindex="-1"></a><span class="co">   2. Setting face-font-family-alternatives allows the user to</span></span>
<span id="cb112-30"><a aria-hidden="true" href="#cb112-30" tabindex="-1"></a><span class="co">   specify alternative font families to try if a family specified by a</span></span>
<span id="cb112-31"><a aria-hidden="true" href="#cb112-31" tabindex="-1"></a><span class="co">   face doesn't exist.</span></span>
<span id="cb112-32"><a aria-hidden="true" href="#cb112-32" tabindex="-1"></a></span>
<span id="cb112-33"><a aria-hidden="true" href="#cb112-33" tabindex="-1"></a><span class="co">   3. Setting face-font-registry-alternatives allows the user to</span></span>
<span id="cb112-34"><a aria-hidden="true" href="#cb112-34" tabindex="-1"></a><span class="co">   specify all alternative font registries to try for a face</span></span>
<span id="cb112-35"><a aria-hidden="true" href="#cb112-35" tabindex="-1"></a><span class="co">   specifying a registry.</span></span>
<span id="cb112-36"><a aria-hidden="true" href="#cb112-36" tabindex="-1"></a></span>
<span id="cb112-37"><a aria-hidden="true" href="#cb112-37" tabindex="-1"></a><span class="co">   4. Setting face-ignored-fonts allows the user to ignore specific</span></span>
<span id="cb112-38"><a aria-hidden="true" href="#cb112-38" tabindex="-1"></a><span class="co">   fonts.</span></span>
<span id="cb112-39"><a aria-hidden="true" href="#cb112-39" tabindex="-1"></a><span class="co">*/</span></span></code></pre></div>
<hr/>
<h2 data-number="7.8" id="bidirectional-text-rendering"><span class="header-section-number">7.8</span> Bidirectional Text
Rendering</h2>
<h3 data-number="7.8.1" id="the-bidi-challenge"><span class="header-section-number">7.8.1</span> The Bidi Challenge</h3>
<p>Bidirectional text (mixing left-to-right and right-to-left scripts)
presents unique challenges:</p>
<ol type="1">
<li>Logical order (storage) differs from visual order (display)</li>
<li>Character reordering must follow Unicode Bidirectional Algorithm
(UBA)</li>
<li>Cursor movement becomes non-monotonic with respect to buffer
positions</li>
<li>Line wrapping must respect visual boundaries</li>
</ol>
<h3 data-number="7.8.2" id="bidi-architecture"><span class="header-section-number">7.8.2</span> Bidi Architecture</h3>
<p>From <code>src/bidi.c:23-106</code>:</p>
<div class="sourceCode" id="cb113"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb113-1"><a aria-hidden="true" href="#cb113-1" tabindex="-1"></a><span class="co">/* A sequential implementation of the Unicode Bidirectional algorithm,</span></span>
<span id="cb113-2"><a aria-hidden="true" href="#cb113-2" tabindex="-1"></a><span class="co">   (UBA) as per UAX#9, a part of the Unicode Standard.</span></span>
<span id="cb113-3"><a aria-hidden="true" href="#cb113-3" tabindex="-1"></a></span>
<span id="cb113-4"><a aria-hidden="true" href="#cb113-4" tabindex="-1"></a><span class="co">   Unlike the Reference Implementation and most other implementations,</span></span>
<span id="cb113-5"><a aria-hidden="true" href="#cb113-5" tabindex="-1"></a><span class="co">   this one is designed to be called once for every character in the</span></span>
<span id="cb113-6"><a aria-hidden="true" href="#cb113-6" tabindex="-1"></a><span class="co">   buffer or string.  That way, we can leave intact the design of the</span></span>
<span id="cb113-7"><a aria-hidden="true" href="#cb113-7" tabindex="-1"></a><span class="co">   Emacs display engine, whereby an iterator object is used to</span></span>
<span id="cb113-8"><a aria-hidden="true" href="#cb113-8" tabindex="-1"></a><span class="co">   traverse buffer or string text character by character, and generate</span></span>
<span id="cb113-9"><a aria-hidden="true" href="#cb113-9" tabindex="-1"></a><span class="co">   the necessary data for displaying each character in 'struct glyph'</span></span>
<span id="cb113-10"><a aria-hidden="true" href="#cb113-10" tabindex="-1"></a><span class="co">   objects.  (See xdisp.c for the details of that iteration.)  The</span></span>
<span id="cb113-11"><a aria-hidden="true" href="#cb113-11" tabindex="-1"></a><span class="co">   functions on this file replace the original linear iteration in the</span></span>
<span id="cb113-12"><a aria-hidden="true" href="#cb113-12" tabindex="-1"></a><span class="co">   logical order of the text with a non-linear iteration in the visual</span></span>
<span id="cb113-13"><a aria-hidden="true" href="#cb113-13" tabindex="-1"></a><span class="co">   order, i.e. in the order characters should be shown on display.</span></span>
<span id="cb113-14"><a aria-hidden="true" href="#cb113-14" tabindex="-1"></a></span>
<span id="cb113-15"><a aria-hidden="true" href="#cb113-15" tabindex="-1"></a><span class="co">   The main entry point is bidi_move_to_visually_next.  Each time it</span></span>
<span id="cb113-16"><a aria-hidden="true" href="#cb113-16" tabindex="-1"></a><span class="co">   is called, it finds the next character in the visual order, and</span></span>
<span id="cb113-17"><a aria-hidden="true" href="#cb113-17" tabindex="-1"></a><span class="co">   returns its information in a special structure.  The caller is then</span></span>
<span id="cb113-18"><a aria-hidden="true" href="#cb113-18" tabindex="-1"></a><span class="co">   expected to process this character for display or any other</span></span>
<span id="cb113-19"><a aria-hidden="true" href="#cb113-19" tabindex="-1"></a><span class="co">   purposes, and call bidi_move_to_visually_next for the next</span></span>
<span id="cb113-20"><a aria-hidden="true" href="#cb113-20" tabindex="-1"></a><span class="co">   character.  See the comments in bidi_move_to_visually_next for more</span></span>
<span id="cb113-21"><a aria-hidden="true" href="#cb113-21" tabindex="-1"></a><span class="co">   details about its algorithm that finds the next visual-order</span></span>
<span id="cb113-22"><a aria-hidden="true" href="#cb113-22" tabindex="-1"></a><span class="co">   character by resolving their levels on the fly.</span></span>
<span id="cb113-23"><a aria-hidden="true" href="#cb113-23" tabindex="-1"></a></span>
<span id="cb113-24"><a aria-hidden="true" href="#cb113-24" tabindex="-1"></a><span class="co">   Two other entry points are bidi_paragraph_init and</span></span>
<span id="cb113-25"><a aria-hidden="true" href="#cb113-25" tabindex="-1"></a><span class="co">   bidi_mirror_char.  The first determines the base direction of a</span></span>
<span id="cb113-26"><a aria-hidden="true" href="#cb113-26" tabindex="-1"></a><span class="co">   paragraph, while the second returns the mirrored version of its</span></span>
<span id="cb113-27"><a aria-hidden="true" href="#cb113-27" tabindex="-1"></a><span class="co">   argument character.</span></span>
<span id="cb113-28"><a aria-hidden="true" href="#cb113-28" tabindex="-1"></a></span>
<span id="cb113-29"><a aria-hidden="true" href="#cb113-29" tabindex="-1"></a><span class="co">   A few auxiliary entry points are used to initialize the bidi</span></span>
<span id="cb113-30"><a aria-hidden="true" href="#cb113-30" tabindex="-1"></a><span class="co">   iterator for iterating an object (buffer or string), push and pop</span></span>
<span id="cb113-31"><a aria-hidden="true" href="#cb113-31" tabindex="-1"></a><span class="co">   the bidi iterator state, and save and restore the state of the bidi</span></span>
<span id="cb113-32"><a aria-hidden="true" href="#cb113-32" tabindex="-1"></a><span class="co">   cache.</span></span>
<span id="cb113-33"><a aria-hidden="true" href="#cb113-33" tabindex="-1"></a></span>
<span id="cb113-34"><a aria-hidden="true" href="#cb113-34" tabindex="-1"></a><span class="co">   If you want to understand the code, you will have to read it</span></span>
<span id="cb113-35"><a aria-hidden="true" href="#cb113-35" tabindex="-1"></a><span class="co">   together with the relevant portions of UAX#9.  The comments include</span></span>
<span id="cb113-36"><a aria-hidden="true" href="#cb113-36" tabindex="-1"></a><span class="co">   references to UAX#9 rules, for that very reason.</span></span></code></pre></div>
<h3 data-number="7.8.3" id="bidi-processing-hierarchy"><span class="header-section-number">7.8.3</span> Bidi Processing
Hierarchy</h3>
<p>From <code>src/bidi.c:68-106</code>:</p>
<div class="sourceCode" id="cb114"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb114-1"><a aria-hidden="true" href="#cb114-1" tabindex="-1"></a><span class="co">/*</span></span>
<span id="cb114-2"><a aria-hidden="true" href="#cb114-2" tabindex="-1"></a><span class="co">   Here's the overview of the design of the reordering engine</span></span>
<span id="cb114-3"><a aria-hidden="true" href="#cb114-3" tabindex="-1"></a><span class="co">   implemented by this file.</span></span>
<span id="cb114-4"><a aria-hidden="true" href="#cb114-4" tabindex="-1"></a></span>
<span id="cb114-5"><a aria-hidden="true" href="#cb114-5" tabindex="-1"></a><span class="co">   Basic implementation structure</span></span>
<span id="cb114-6"><a aria-hidden="true" href="#cb114-6" tabindex="-1"></a><span class="co">   ------------------------------</span></span>
<span id="cb114-7"><a aria-hidden="true" href="#cb114-7" tabindex="-1"></a></span>
<span id="cb114-8"><a aria-hidden="true" href="#cb114-8" tabindex="-1"></a><span class="co">   The sequential processing steps described by UAX#9 are implemented</span></span>
<span id="cb114-9"><a aria-hidden="true" href="#cb114-9" tabindex="-1"></a><span class="co">   as recursive levels of processing, all of which examine the next</span></span>
<span id="cb114-10"><a aria-hidden="true" href="#cb114-10" tabindex="-1"></a><span class="co">   character in the logical order.  This hierarchy of processing looks</span></span>
<span id="cb114-11"><a aria-hidden="true" href="#cb114-11" tabindex="-1"></a><span class="co">   as follows, from the innermost (deepest) to the outermost level,</span></span>
<span id="cb114-12"><a aria-hidden="true" href="#cb114-12" tabindex="-1"></a><span class="co">   omitting some subroutines used by each level:</span></span>
<span id="cb114-13"><a aria-hidden="true" href="#cb114-13" tabindex="-1"></a></span>
<span id="cb114-14"><a aria-hidden="true" href="#cb114-14" tabindex="-1"></a><span class="co">     bidi_fetch_char         -- fetch next character</span></span>
<span id="cb114-15"><a aria-hidden="true" href="#cb114-15" tabindex="-1"></a><span class="co">     bidi_resolve_explicit   -- resolve explicit levels and directions</span></span>
<span id="cb114-16"><a aria-hidden="true" href="#cb114-16" tabindex="-1"></a><span class="co">     bidi_resolve_weak       -- resolve weak types</span></span>
<span id="cb114-17"><a aria-hidden="true" href="#cb114-17" tabindex="-1"></a><span class="co">     bidi_resolve_brackets   -- resolve "paired brackets" neutral types</span></span>
<span id="cb114-18"><a aria-hidden="true" href="#cb114-18" tabindex="-1"></a><span class="co">     bidi_resolve_neutral    -- resolve neutral types</span></span>
<span id="cb114-19"><a aria-hidden="true" href="#cb114-19" tabindex="-1"></a><span class="co">     bidi_level_of_next_char -- resolve implicit levels</span></span>
<span id="cb114-20"><a aria-hidden="true" href="#cb114-20" tabindex="-1"></a></span>
<span id="cb114-21"><a aria-hidden="true" href="#cb114-21" tabindex="-1"></a><span class="co">   Each level calls the level below it, and works on the result</span></span>
<span id="cb114-22"><a aria-hidden="true" href="#cb114-22" tabindex="-1"></a><span class="co">   returned by the lower level, including all of its sub-levels.</span></span>
<span id="cb114-23"><a aria-hidden="true" href="#cb114-23" tabindex="-1"></a></span>
<span id="cb114-24"><a aria-hidden="true" href="#cb114-24" tabindex="-1"></a><span class="co">   Unlike all the levels below it, bidi_level_of_next_char can return</span></span>
<span id="cb114-25"><a aria-hidden="true" href="#cb114-25" tabindex="-1"></a><span class="co">   the information about either the next or previous character in the</span></span>
<span id="cb114-26"><a aria-hidden="true" href="#cb114-26" tabindex="-1"></a><span class="co">   logical order, depending on the current direction of scanning the</span></span>
<span id="cb114-27"><a aria-hidden="true" href="#cb114-27" tabindex="-1"></a><span class="co">   buffer or string.  For the next character, it calls all the levels</span></span>
<span id="cb114-28"><a aria-hidden="true" href="#cb114-28" tabindex="-1"></a><span class="co">   below it; for the previous character, it uses the cache, described</span></span>
<span id="cb114-29"><a aria-hidden="true" href="#cb114-29" tabindex="-1"></a><span class="co">   below.</span></span>
<span id="cb114-30"><a aria-hidden="true" href="#cb114-30" tabindex="-1"></a></span>
<span id="cb114-31"><a aria-hidden="true" href="#cb114-31" tabindex="-1"></a><span class="co">   Thus, the result of calling bidi_level_of_next_char is the resolved</span></span>
<span id="cb114-32"><a aria-hidden="true" href="#cb114-32" tabindex="-1"></a><span class="co">   level of the next or the previous character in the logical order.</span></span>
<span id="cb114-33"><a aria-hidden="true" href="#cb114-33" tabindex="-1"></a><span class="co">   Based on this information, the function bidi_move_to_visually_next</span></span>
<span id="cb114-34"><a aria-hidden="true" href="#cb114-34" tabindex="-1"></a><span class="co">   finds the next character in the visual order and updates the</span></span>
<span id="cb114-35"><a aria-hidden="true" href="#cb114-35" tabindex="-1"></a><span class="co">   direction in which the buffer is scanned, either forward or</span></span>
<span id="cb114-36"><a aria-hidden="true" href="#cb114-36" tabindex="-1"></a><span class="co">   backward, to find the next character to be displayed.  (Text is</span></span>
<span id="cb114-37"><a aria-hidden="true" href="#cb114-37" tabindex="-1"></a><span class="co">   scanned backwards when it needs to be reversed for display, i.e. if</span></span>
<span id="cb114-38"><a aria-hidden="true" href="#cb114-38" tabindex="-1"></a><span class="co">   the visual order is the inverse of the logical order.)  This</span></span>
<span id="cb114-39"><a aria-hidden="true" href="#cb114-39" tabindex="-1"></a><span class="co">   implements the last, reordering steps of the UBA, by successively</span></span>
<span id="cb114-40"><a aria-hidden="true" href="#cb114-40" tabindex="-1"></a><span class="co">   calling bidi_level_of_next_char until the character of the required</span></span>
<span id="cb114-41"><a aria-hidden="true" href="#cb114-41" tabindex="-1"></a><span class="co">   embedding level is found; the scan direction is dynamically updated</span></span>
<span id="cb114-42"><a aria-hidden="true" href="#cb114-42" tabindex="-1"></a><span class="co">   as a side effect.  See the commentary before the 'while' loop in</span></span>
<span id="cb114-43"><a aria-hidden="true" href="#cb114-43" tabindex="-1"></a><span class="co">   bidi_move_to_visually_next, for the details.</span></span>
<span id="cb114-44"><a aria-hidden="true" href="#cb114-44" tabindex="-1"></a><span class="co">*/</span></span></code></pre></div>
<h3 data-number="7.8.4" id="integration-with-display-iterator"><span class="header-section-number">7.8.4</span> Integration with Display
Iterator</h3>
<p>The bidi engine integrates seamlessly with the display iterator. From
<code>src/xdisp.c:374-466</code>:</p>
<div class="sourceCode" id="cb115"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb115-1"><a aria-hidden="true" href="#cb115-1" tabindex="-1"></a><span class="co">/*</span></span>
<span id="cb115-2"><a aria-hidden="true" href="#cb115-2" tabindex="-1"></a><span class="co">   Bidirectional display.</span></span>
<span id="cb115-3"><a aria-hidden="true" href="#cb115-3" tabindex="-1"></a></span>
<span id="cb115-4"><a aria-hidden="true" href="#cb115-4" tabindex="-1"></a><span class="co">   Bidirectional display adds quite some hair to this already complex</span></span>
<span id="cb115-5"><a aria-hidden="true" href="#cb115-5" tabindex="-1"></a><span class="co">   design.  The good news are that a large portion of that hairy stuff</span></span>
<span id="cb115-6"><a aria-hidden="true" href="#cb115-6" tabindex="-1"></a><span class="co">   is hidden in bidi.c behind only 3 interfaces.  bidi.c implements a</span></span>
<span id="cb115-7"><a aria-hidden="true" href="#cb115-7" tabindex="-1"></a><span class="co">   reordering engine which is called by `set_iterator_to_next' and</span></span>
<span id="cb115-8"><a aria-hidden="true" href="#cb115-8" tabindex="-1"></a><span class="co">   returns the next character to display in the visual order.  See</span></span>
<span id="cb115-9"><a aria-hidden="true" href="#cb115-9" tabindex="-1"></a><span class="co">   commentary on bidi.c for more details.  As far as redisplay is</span></span>
<span id="cb115-10"><a aria-hidden="true" href="#cb115-10" tabindex="-1"></a><span class="co">   concerned, the effect of calling `bidi_move_to_visually_next', the</span></span>
<span id="cb115-11"><a aria-hidden="true" href="#cb115-11" tabindex="-1"></a><span class="co">   main interface of the reordering engine, is that the iterator gets</span></span>
<span id="cb115-12"><a aria-hidden="true" href="#cb115-12" tabindex="-1"></a><span class="co">   magically placed on the buffer or string position that is to be</span></span>
<span id="cb115-13"><a aria-hidden="true" href="#cb115-13" tabindex="-1"></a><span class="co">   displayed next in the visual order.  In other words, a linear</span></span>
<span id="cb115-14"><a aria-hidden="true" href="#cb115-14" tabindex="-1"></a><span class="co">   iteration through the buffer/string is replaced with a non-linear</span></span>
<span id="cb115-15"><a aria-hidden="true" href="#cb115-15" tabindex="-1"></a><span class="co">   one.  All the rest of the redisplay is oblivious to the bidi</span></span>
<span id="cb115-16"><a aria-hidden="true" href="#cb115-16" tabindex="-1"></a><span class="co">   reordering.</span></span>
<span id="cb115-17"><a aria-hidden="true" href="#cb115-17" tabindex="-1"></a></span>
<span id="cb115-18"><a aria-hidden="true" href="#cb115-18" tabindex="-1"></a><span class="co">   Well, almost oblivious---there are still complications, most of</span></span>
<span id="cb115-19"><a aria-hidden="true" href="#cb115-19" tabindex="-1"></a><span class="co">   them due to the fact that buffer and string positions no longer</span></span>
<span id="cb115-20"><a aria-hidden="true" href="#cb115-20" tabindex="-1"></a><span class="co">   change monotonously with glyph indices in a glyph row.  Moreover,</span></span>
<span id="cb115-21"><a aria-hidden="true" href="#cb115-21" tabindex="-1"></a><span class="co">   for continued lines, the buffer positions may not even be</span></span>
<span id="cb115-22"><a aria-hidden="true" href="#cb115-22" tabindex="-1"></a><span class="co">   monotonously changing with vertical positions.  Also, accounting</span></span>
<span id="cb115-23"><a aria-hidden="true" href="#cb115-23" tabindex="-1"></a><span class="co">   for face changes, overlays, etc. becomes more complex because</span></span>
<span id="cb115-24"><a aria-hidden="true" href="#cb115-24" tabindex="-1"></a><span class="co">   non-linear iteration could potentially skip many positions with</span></span>
<span id="cb115-25"><a aria-hidden="true" href="#cb115-25" tabindex="-1"></a><span class="co">   such changes, and then cross them again on the way back (see</span></span>
<span id="cb115-26"><a aria-hidden="true" href="#cb115-26" tabindex="-1"></a><span class="co">   `handle_stop_backwards')...</span></span>
<span id="cb115-27"><a aria-hidden="true" href="#cb115-27" tabindex="-1"></a></span>
<span id="cb115-28"><a aria-hidden="true" href="#cb115-28" tabindex="-1"></a><span class="co">   One other prominent effect of bidirectional display is that some</span></span>
<span id="cb115-29"><a aria-hidden="true" href="#cb115-29" tabindex="-1"></a><span class="co">   paragraphs of text need to be displayed starting at the right</span></span>
<span id="cb115-30"><a aria-hidden="true" href="#cb115-30" tabindex="-1"></a><span class="co">   margin of the window---the so-called right-to-left, or R2L</span></span>
<span id="cb115-31"><a aria-hidden="true" href="#cb115-31" tabindex="-1"></a><span class="co">   paragraphs.  R2L paragraphs are displayed with R2L glyph rows,</span></span>
<span id="cb115-32"><a aria-hidden="true" href="#cb115-32" tabindex="-1"></a><span class="co">   which have their `reversed_p' flag set.  The bidi reordering engine</span></span>
<span id="cb115-33"><a aria-hidden="true" href="#cb115-33" tabindex="-1"></a><span class="co">   produces characters in such rows starting from the character which</span></span>
<span id="cb115-34"><a aria-hidden="true" href="#cb115-34" tabindex="-1"></a><span class="co">   should be the rightmost on display.  `PRODUCE_GLYPHS' then reverses</span></span>
<span id="cb115-35"><a aria-hidden="true" href="#cb115-35" tabindex="-1"></a><span class="co">   the order, when it fills up the glyph row whose `reversed_p' flag</span></span>
<span id="cb115-36"><a aria-hidden="true" href="#cb115-36" tabindex="-1"></a><span class="co">   is set, by prepending each new glyph to what is already there,</span></span>
<span id="cb115-37"><a aria-hidden="true" href="#cb115-37" tabindex="-1"></a><span class="co">   instead of appending it.  When the glyph row is complete, the</span></span>
<span id="cb115-38"><a aria-hidden="true" href="#cb115-38" tabindex="-1"></a><span class="co">   function `extend_face_to_end_of_line' fills the empty space to the</span></span>
<span id="cb115-39"><a aria-hidden="true" href="#cb115-39" tabindex="-1"></a><span class="co">   left of the leftmost character with special glyphs, which will</span></span>
<span id="cb115-40"><a aria-hidden="true" href="#cb115-40" tabindex="-1"></a><span class="co">   display as, well, empty.  On text terminals, these special glyphs</span></span>
<span id="cb115-41"><a aria-hidden="true" href="#cb115-41" tabindex="-1"></a><span class="co">   are simply blank characters.  On graphics terminals, there's a</span></span>
<span id="cb115-42"><a aria-hidden="true" href="#cb115-42" tabindex="-1"></a><span class="co">   single stretch glyph of a suitably computed width.  Both the blanks</span></span>
<span id="cb115-43"><a aria-hidden="true" href="#cb115-43" tabindex="-1"></a><span class="co">   and the stretch glyph are given the face of the background of the</span></span>
<span id="cb115-44"><a aria-hidden="true" href="#cb115-44" tabindex="-1"></a><span class="co">   line.  This way, the terminal-specific back-end can still draw the</span></span>
<span id="cb115-45"><a aria-hidden="true" href="#cb115-45" tabindex="-1"></a><span class="co">   glyphs left to right, even for R2L lines.</span></span>
<span id="cb115-46"><a aria-hidden="true" href="#cb115-46" tabindex="-1"></a><span class="co">*/</span></span></code></pre></div>
<p>This is elegant: the bidi engine handles reordering complexity, while
the rest of the display code remains largely unchanged.</p>
<hr/>
<h2 data-number="7.9" id="line-wrapping-and-truncation"><span class="header-section-number">7.9</span> Line Wrapping and
Truncation</h2>
<h3 data-number="7.9.1" id="wrapping-modes"><span class="header-section-number">7.9.1</span> Wrapping Modes</h3>
<p>Emacs supports three line handling modes:</p>
<ol type="1">
<li><strong>Truncate</strong>: Long lines are cut off at window edge
with <code>$</code> indicator</li>
<li><strong>Word Wrap</strong>: Lines break at word boundaries</li>
<li><strong>Character Wrap</strong>: Lines break at any character</li>
</ol>
<h3 data-number="7.9.2" id="the-display_line-function"><span class="header-section-number">7.9.2</span> The
<code>display_line()</code> Function</h3>
<p>The core line layout function is <code>display_line()</code> in
<code>src/xdisp.c:25542</code>. This function constructs one row of the
desired glyph matrix.</p>
<p>From <code>src/xdisp.c:25542-25691</code>:</p>
<div class="sourceCode" id="cb116"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb116-1"><a aria-hidden="true" href="#cb116-1" tabindex="-1"></a>display_line <span class="op">(</span><span class="kw">struct</span> it <span class="op">*</span>it<span class="op">,</span> <span class="dt">int</span> cursor_vpos<span class="op">)</span></span>
<span id="cb116-2"><a aria-hidden="true" href="#cb116-2" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb116-3"><a aria-hidden="true" href="#cb116-3" tabindex="-1"></a>  <span class="kw">struct</span> glyph_row <span class="op">*</span>row <span class="op">=</span> it<span class="op">-&gt;</span>glyph_row<span class="op">;</span></span>
<span id="cb116-4"><a aria-hidden="true" href="#cb116-4" tabindex="-1"></a>  Lisp_Object overlay_arrow_string<span class="op">;</span></span>
<span id="cb116-5"><a aria-hidden="true" href="#cb116-5" tabindex="-1"></a>  <span class="kw">struct</span> it wrap_it<span class="op">;</span></span>
<span id="cb116-6"><a aria-hidden="true" href="#cb116-6" tabindex="-1"></a>  <span class="dt">void</span> <span class="op">*</span>wrap_data <span class="op">=</span> NULL<span class="op">;</span></span>
<span id="cb116-7"><a aria-hidden="true" href="#cb116-7" tabindex="-1"></a>  <span class="dt">bool</span> may_wrap <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb116-8"><a aria-hidden="true" href="#cb116-8" tabindex="-1"></a>  <span class="dt">int</span> wrap_x UNINIT<span class="op">;</span></span>
<span id="cb116-9"><a aria-hidden="true" href="#cb116-9" tabindex="-1"></a>  <span class="dt">int</span> wrap_row_used <span class="op">=</span> <span class="op">-</span><span class="dv">1</span><span class="op">;</span></span>
<span id="cb116-10"><a aria-hidden="true" href="#cb116-10" tabindex="-1"></a>  <span class="dt">int</span> wrap_row_ascent UNINIT<span class="op">,</span> wrap_row_height UNINIT<span class="op">;</span></span>
<span id="cb116-11"><a aria-hidden="true" href="#cb116-11" tabindex="-1"></a>  <span class="dt">int</span> wrap_row_phys_ascent UNINIT<span class="op">,</span> wrap_row_phys_height UNINIT<span class="op">;</span></span>
<span id="cb116-12"><a aria-hidden="true" href="#cb116-12" tabindex="-1"></a>  <span class="dt">int</span> wrap_row_extra_line_spacing UNINIT<span class="op">;</span></span>
<span id="cb116-13"><a aria-hidden="true" href="#cb116-13" tabindex="-1"></a>  <span class="dt">ptrdiff_t</span> wrap_row_min_pos UNINIT<span class="op">,</span> wrap_row_min_bpos UNINIT<span class="op">;</span></span>
<span id="cb116-14"><a aria-hidden="true" href="#cb116-14" tabindex="-1"></a>  <span class="dt">ptrdiff_t</span> wrap_row_max_pos UNINIT<span class="op">,</span> wrap_row_max_bpos UNINIT<span class="op">;</span></span>
<span id="cb116-15"><a aria-hidden="true" href="#cb116-15" tabindex="-1"></a>  <span class="dt">int</span> cvpos<span class="op">;</span></span>
<span id="cb116-16"><a aria-hidden="true" href="#cb116-16" tabindex="-1"></a>  <span class="dt">ptrdiff_t</span> min_pos <span class="op">=</span> ZV <span class="op">+</span> <span class="dv">1</span><span class="op">,</span> max_pos <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb116-17"><a aria-hidden="true" href="#cb116-17" tabindex="-1"></a>  <span class="dt">ptrdiff_t</span> min_bpos UNINIT<span class="op">,</span> max_bpos UNINIT<span class="op">;</span></span>
<span id="cb116-18"><a aria-hidden="true" href="#cb116-18" tabindex="-1"></a>  <span class="dt">bool</span> pending_handle_line_prefix <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb116-19"><a aria-hidden="true" href="#cb116-19" tabindex="-1"></a>  <span class="dt">int</span> tab_line <span class="op">=</span> window_wants_tab_line <span class="op">(</span>it<span class="op">-&gt;</span>w<span class="op">);</span></span>
<span id="cb116-20"><a aria-hidden="true" href="#cb116-20" tabindex="-1"></a>  <span class="dt">int</span> header_line <span class="op">=</span> window_wants_header_line <span class="op">(</span>it<span class="op">-&gt;</span>w<span class="op">);</span></span>
<span id="cb116-21"><a aria-hidden="true" href="#cb116-21" tabindex="-1"></a>  <span class="dt">bool</span> hscroll_this_line <span class="op">=</span> <span class="op">(</span>cursor_vpos <span class="op">&gt;=</span> <span class="dv">0</span></span>
<span id="cb116-22"><a aria-hidden="true" href="#cb116-22" tabindex="-1"></a>                <span class="op">&amp;&amp;</span> it<span class="op">-&gt;</span>vpos <span class="op">==</span> cursor_vpos <span class="op">-</span> tab_line <span class="op">-</span> header_line</span>
<span id="cb116-23"><a aria-hidden="true" href="#cb116-23" tabindex="-1"></a>                <span class="op">&amp;&amp;</span> hscrolling_current_line_p <span class="op">(</span>it<span class="op">-&gt;</span>w<span class="op">));</span></span>
<span id="cb116-24"><a aria-hidden="true" href="#cb116-24" tabindex="-1"></a>  <span class="dt">int</span> first_visible_x <span class="op">=</span> it<span class="op">-&gt;</span>first_visible_x<span class="op">;</span></span>
<span id="cb116-25"><a aria-hidden="true" href="#cb116-25" tabindex="-1"></a>  <span class="dt">int</span> last_visible_x <span class="op">=</span> it<span class="op">-&gt;</span>last_visible_x<span class="op">;</span></span>
<span id="cb116-26"><a aria-hidden="true" href="#cb116-26" tabindex="-1"></a>  <span class="dt">int</span> x_incr <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb116-27"><a aria-hidden="true" href="#cb116-27" tabindex="-1"></a>  <span class="dt">int</span> this_line_subject_to_line_prefix <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb116-28"><a aria-hidden="true" href="#cb116-28" tabindex="-1"></a></span>
<span id="cb116-29"><a aria-hidden="true" href="#cb116-29" tabindex="-1"></a>  <span class="co">/* We always start displaying at hpos zero even if hscrolled.  */</span></span>
<span id="cb116-30"><a aria-hidden="true" href="#cb116-30" tabindex="-1"></a>  eassert <span class="op">(</span>it<span class="op">-&gt;</span>hpos <span class="op">==</span> <span class="dv">0</span> <span class="op">&amp;&amp;</span> it<span class="op">-&gt;</span>current_x <span class="op">==</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb116-31"><a aria-hidden="true" href="#cb116-31" tabindex="-1"></a></span>
<span id="cb116-32"><a aria-hidden="true" href="#cb116-32" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>MATRIX_ROW_VPOS <span class="op">(</span>row<span class="op">,</span> it<span class="op">-&gt;</span>w<span class="op">-&gt;</span>desired_matrix<span class="op">)</span></span>
<span id="cb116-33"><a aria-hidden="true" href="#cb116-33" tabindex="-1"></a>      <span class="op">&gt;=</span> it<span class="op">-&gt;</span>w<span class="op">-&gt;</span>desired_matrix<span class="op">-&gt;</span>nrows<span class="op">)</span></span>
<span id="cb116-34"><a aria-hidden="true" href="#cb116-34" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb116-35"><a aria-hidden="true" href="#cb116-35" tabindex="-1"></a>      it<span class="op">-&gt;</span>w<span class="op">-&gt;</span>nrows_scale_factor<span class="op">++;</span></span>
<span id="cb116-36"><a aria-hidden="true" href="#cb116-36" tabindex="-1"></a>      it<span class="op">-&gt;</span>f<span class="op">-&gt;</span>fonts_changed <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb116-37"><a aria-hidden="true" href="#cb116-37" tabindex="-1"></a>      <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb116-38"><a aria-hidden="true" href="#cb116-38" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb116-39"><a aria-hidden="true" href="#cb116-39" tabindex="-1"></a></span>
<span id="cb116-40"><a aria-hidden="true" href="#cb116-40" tabindex="-1"></a>  <span class="co">/* Clear the result glyph row and enable it.  */</span></span>
<span id="cb116-41"><a aria-hidden="true" href="#cb116-41" tabindex="-1"></a>  prepare_desired_row <span class="op">(</span>it<span class="op">-&gt;</span>w<span class="op">,</span> row<span class="op">,</span> <span class="kw">false</span><span class="op">);</span></span>
<span id="cb116-42"><a aria-hidden="true" href="#cb116-42" tabindex="-1"></a></span>
<span id="cb116-43"><a aria-hidden="true" href="#cb116-43" tabindex="-1"></a>  row<span class="op">-&gt;</span>y <span class="op">=</span> it<span class="op">-&gt;</span>current_y<span class="op">;</span></span>
<span id="cb116-44"><a aria-hidden="true" href="#cb116-44" tabindex="-1"></a>  row<span class="op">-&gt;</span>start <span class="op">=</span> it<span class="op">-&gt;</span>start<span class="op">;</span></span>
<span id="cb116-45"><a aria-hidden="true" href="#cb116-45" tabindex="-1"></a>  row<span class="op">-&gt;</span>continuation_lines_width <span class="op">=</span> it<span class="op">-&gt;</span>continuation_lines_width<span class="op">;</span></span>
<span id="cb116-46"><a aria-hidden="true" href="#cb116-46" tabindex="-1"></a>  row<span class="op">-&gt;</span>displays_text_p <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb116-47"><a aria-hidden="true" href="#cb116-47" tabindex="-1"></a>  row<span class="op">-&gt;</span>starts_in_middle_of_char_p <span class="op">=</span> it<span class="op">-&gt;</span>starts_in_middle_of_char_p<span class="op">;</span></span>
<span id="cb116-48"><a aria-hidden="true" href="#cb116-48" tabindex="-1"></a>  it<span class="op">-&gt;</span>starts_in_middle_of_char_p <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb116-49"><a aria-hidden="true" href="#cb116-49" tabindex="-1"></a>  it<span class="op">-&gt;</span>stretch_adjust <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb116-50"><a aria-hidden="true" href="#cb116-50" tabindex="-1"></a>  it<span class="op">-&gt;</span>line_number_produced_p <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb116-51"><a aria-hidden="true" href="#cb116-51" tabindex="-1"></a></span>
<span id="cb116-52"><a aria-hidden="true" href="#cb116-52" tabindex="-1"></a>  <span class="co">/* If we are going to display the cursor's line, account for the</span></span>
<span id="cb116-53"><a aria-hidden="true" href="#cb116-53" tabindex="-1"></a><span class="co">     hscroll of that line.  We subtract the window's min_hscroll,</span></span>
<span id="cb116-54"><a aria-hidden="true" href="#cb116-54" tabindex="-1"></a><span class="co">     because that was already accounted for in init_iterator.  */</span></span>
<span id="cb116-55"><a aria-hidden="true" href="#cb116-55" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>hscroll_this_line<span class="op">)</span></span>
<span id="cb116-56"><a aria-hidden="true" href="#cb116-56" tabindex="-1"></a>    x_incr <span class="op">=</span></span>
<span id="cb116-57"><a aria-hidden="true" href="#cb116-57" tabindex="-1"></a>      <span class="op">(</span>window_hscroll_limited <span class="op">(</span>it<span class="op">-&gt;</span>w<span class="op">,</span> it<span class="op">-&gt;</span>f<span class="op">)</span> <span class="op">-</span> it<span class="op">-&gt;</span>w<span class="op">-&gt;</span>min_hscroll<span class="op">)</span></span>
<span id="cb116-58"><a aria-hidden="true" href="#cb116-58" tabindex="-1"></a>      <span class="op">*</span> FRAME_COLUMN_WIDTH <span class="op">(</span>it<span class="op">-&gt;</span>f<span class="op">);</span></span>
<span id="cb116-59"><a aria-hidden="true" href="#cb116-59" tabindex="-1"></a></span>
<span id="cb116-60"><a aria-hidden="true" href="#cb116-60" tabindex="-1"></a>  <span class="dt">bool</span> line_number_needed <span class="op">=</span> should_produce_line_number <span class="op">(</span>it<span class="op">);</span></span></code></pre></div>
<h3 data-number="7.9.3" id="word-wrapping-algorithm"><span class="header-section-number">7.9.3</span> Word Wrapping Algorithm</h3>
<p>The word wrap implementation saves iterator state at potential wrap
points:</p>
<div class="sourceCode" id="cb117"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb117-1"><a aria-hidden="true" href="#cb117-1" tabindex="-1"></a>  <span class="co">/* Main loop: fill the glyph row.  */</span></span>
<span id="cb117-2"><a aria-hidden="true" href="#cb117-2" tabindex="-1"></a>  <span class="cf">while</span> <span class="op">(</span><span class="kw">true</span><span class="op">)</span></span>
<span id="cb117-3"><a aria-hidden="true" href="#cb117-3" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb117-4"><a aria-hidden="true" href="#cb117-4" tabindex="-1"></a>      <span class="co">/* Get the next display element.  */</span></span>
<span id="cb117-5"><a aria-hidden="true" href="#cb117-5" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(!</span>get_next_display_element <span class="op">(</span>it<span class="op">))</span></span>
<span id="cb117-6"><a aria-hidden="true" href="#cb117-6" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb117-7"><a aria-hidden="true" href="#cb117-7" tabindex="-1"></a>          <span class="co">/* End of buffer/string reached.  */</span></span>
<span id="cb117-8"><a aria-hidden="true" href="#cb117-8" tabindex="-1"></a>          <span class="cf">break</span><span class="op">;</span></span>
<span id="cb117-9"><a aria-hidden="true" href="#cb117-9" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb117-10"><a aria-hidden="true" href="#cb117-10" tabindex="-1"></a></span>
<span id="cb117-11"><a aria-hidden="true" href="#cb117-11" tabindex="-1"></a>      <span class="co">/* Check if this is a good place to wrap.  */</span></span>
<span id="cb117-12"><a aria-hidden="true" href="#cb117-12" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span>may_wrap <span class="op">&amp;&amp;</span> it<span class="op">-&gt;</span>line_wrap <span class="op">==</span> WORD_WRAP<span class="op">)</span></span>
<span id="cb117-13"><a aria-hidden="true" href="#cb117-13" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb117-14"><a aria-hidden="true" href="#cb117-14" tabindex="-1"></a>          <span class="co">/* Save wrap point state.  */</span></span>
<span id="cb117-15"><a aria-hidden="true" href="#cb117-15" tabindex="-1"></a>          SAVE_IT <span class="op">(</span>wrap_it<span class="op">,</span> <span class="op">*</span>it<span class="op">,</span> wrap_data<span class="op">);</span></span>
<span id="cb117-16"><a aria-hidden="true" href="#cb117-16" tabindex="-1"></a>          wrap_x <span class="op">=</span> it<span class="op">-&gt;</span>current_x<span class="op">;</span></span>
<span id="cb117-17"><a aria-hidden="true" href="#cb117-17" tabindex="-1"></a>          wrap_row_used <span class="op">=</span> row<span class="op">-&gt;</span>used<span class="op">[</span>TEXT_AREA<span class="op">];</span></span>
<span id="cb117-18"><a aria-hidden="true" href="#cb117-18" tabindex="-1"></a>          <span class="co">/* ... save other wrap state ... */</span></span>
<span id="cb117-19"><a aria-hidden="true" href="#cb117-19" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb117-20"><a aria-hidden="true" href="#cb117-20" tabindex="-1"></a></span>
<span id="cb117-21"><a aria-hidden="true" href="#cb117-21" tabindex="-1"></a>      <span class="co">/* Produce glyphs.  */</span></span>
<span id="cb117-22"><a aria-hidden="true" href="#cb117-22" tabindex="-1"></a>      PRODUCE_GLYPHS <span class="op">(</span>it<span class="op">);</span></span>
<span id="cb117-23"><a aria-hidden="true" href="#cb117-23" tabindex="-1"></a></span>
<span id="cb117-24"><a aria-hidden="true" href="#cb117-24" tabindex="-1"></a>      <span class="co">/* Check if glyph fits on line.  */</span></span>
<span id="cb117-25"><a aria-hidden="true" href="#cb117-25" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span>it<span class="op">-&gt;</span>current_x <span class="op">&gt;</span> it<span class="op">-&gt;</span>last_visible_x<span class="op">)</span></span>
<span id="cb117-26"><a aria-hidden="true" href="#cb117-26" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb117-27"><a aria-hidden="true" href="#cb117-27" tabindex="-1"></a>          <span class="co">/* Doesn't fit.  */</span></span>
<span id="cb117-28"><a aria-hidden="true" href="#cb117-28" tabindex="-1"></a>          <span class="cf">if</span> <span class="op">(</span>it<span class="op">-&gt;</span>line_wrap <span class="op">==</span> WORD_WRAP <span class="op">&amp;&amp;</span> wrap_row_used <span class="op">&gt;</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb117-29"><a aria-hidden="true" href="#cb117-29" tabindex="-1"></a>            <span class="op">{</span></span>
<span id="cb117-30"><a aria-hidden="true" href="#cb117-30" tabindex="-1"></a>              <span class="co">/* Word wrap: restore to saved wrap point.  */</span></span>
<span id="cb117-31"><a aria-hidden="true" href="#cb117-31" tabindex="-1"></a>              RESTORE_IT <span class="op">(</span>it<span class="op">,</span> <span class="op">&amp;</span>wrap_it<span class="op">,</span> wrap_data<span class="op">);</span></span>
<span id="cb117-32"><a aria-hidden="true" href="#cb117-32" tabindex="-1"></a>              <span class="co">/* ... handle wrap ... */</span></span>
<span id="cb117-33"><a aria-hidden="true" href="#cb117-33" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb117-34"><a aria-hidden="true" href="#cb117-34" tabindex="-1"></a>          <span class="cf">else</span></span>
<span id="cb117-35"><a aria-hidden="true" href="#cb117-35" tabindex="-1"></a>            <span class="op">{</span></span>
<span id="cb117-36"><a aria-hidden="true" href="#cb117-36" tabindex="-1"></a>              <span class="co">/* Truncate or continue to next line.  */</span></span>
<span id="cb117-37"><a aria-hidden="true" href="#cb117-37" tabindex="-1"></a>              <span class="co">/* ... */</span></span>
<span id="cb117-38"><a aria-hidden="true" href="#cb117-38" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb117-39"><a aria-hidden="true" href="#cb117-39" tabindex="-1"></a>          <span class="cf">break</span><span class="op">;</span></span>
<span id="cb117-40"><a aria-hidden="true" href="#cb117-40" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb117-41"><a aria-hidden="true" href="#cb117-41" tabindex="-1"></a></span>
<span id="cb117-42"><a aria-hidden="true" href="#cb117-42" tabindex="-1"></a>      <span class="co">/* Glyph fits, advance iterator.  */</span></span>
<span id="cb117-43"><a aria-hidden="true" href="#cb117-43" tabindex="-1"></a>      set_iterator_to_next <span class="op">(</span>it<span class="op">,</span> <span class="kw">true</span><span class="op">);</span></span>
<span id="cb117-44"><a aria-hidden="true" href="#cb117-44" tabindex="-1"></a>    <span class="op">}</span></span></code></pre></div>
<p>This elegant state-save/restore mechanism enables efficient word
wrapping without complex backtracking.</p>
<hr/>
<h2 data-number="7.10" id="fringe-indicators"><span class="header-section-number">7.10</span> Fringe Indicators</h2>
<h3 data-number="7.10.1" id="fringe-architecture"><span class="header-section-number">7.10.1</span> Fringe Architecture</h3>
<p>The fringe is the narrow vertical area at each side of a window used
to display:</p>
<ul>
<li>Continuation/truncation indicators</li>
<li>Overlay arrows (debugging, org-mode)</li>
<li>Buffer boundaries</li>
<li>Custom bitmaps</li>
</ul>
<p>From <code>src/fringe.c:37-68</code>:</p>
<div class="sourceCode" id="cb118"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb118-1"><a aria-hidden="true" href="#cb118-1" tabindex="-1"></a><span class="co">/* Fringe bitmaps are represented in three different ways:</span></span>
<span id="cb118-2"><a aria-hidden="true" href="#cb118-2" tabindex="-1"></a></span>
<span id="cb118-3"><a aria-hidden="true" href="#cb118-3" tabindex="-1"></a><span class="co">   Logical bitmaps are used internally to denote things like</span></span>
<span id="cb118-4"><a aria-hidden="true" href="#cb118-4" tabindex="-1"></a><span class="co">   'continuation', 'overlay-arrow', etc.</span></span>
<span id="cb118-5"><a aria-hidden="true" href="#cb118-5" tabindex="-1"></a></span>
<span id="cb118-6"><a aria-hidden="true" href="#cb118-6" tabindex="-1"></a><span class="co">   Physical bitmaps specify the visual appearance of the bitmap,</span></span>
<span id="cb118-7"><a aria-hidden="true" href="#cb118-7" tabindex="-1"></a><span class="co">   e.g. 'left-arrow', 'right-arrow', 'left-curly-arrow', etc.</span></span>
<span id="cb118-8"><a aria-hidden="true" href="#cb118-8" tabindex="-1"></a></span>
<span id="cb118-9"><a aria-hidden="true" href="#cb118-9" tabindex="-1"></a><span class="co">   User defined bitmaps are physical bitmaps.</span></span>
<span id="cb118-10"><a aria-hidden="true" href="#cb118-10" tabindex="-1"></a></span>
<span id="cb118-11"><a aria-hidden="true" href="#cb118-11" tabindex="-1"></a><span class="co">   Internally, fringe bitmaps for a specific display row are</span></span>
<span id="cb118-12"><a aria-hidden="true" href="#cb118-12" tabindex="-1"></a><span class="co">   represented as an index into the table of all defined bitmaps.</span></span>
<span id="cb118-13"><a aria-hidden="true" href="#cb118-13" tabindex="-1"></a><span class="co">   This index is stored in the `fringe' property of the physical</span></span>
<span id="cb118-14"><a aria-hidden="true" href="#cb118-14" tabindex="-1"></a><span class="co">   bitmap symbol.</span></span>
<span id="cb118-15"><a aria-hidden="true" href="#cb118-15" tabindex="-1"></a></span>
<span id="cb118-16"><a aria-hidden="true" href="#cb118-16" tabindex="-1"></a><span class="co">   Logical bitmaps are mapped to physical bitmaps through the</span></span>
<span id="cb118-17"><a aria-hidden="true" href="#cb118-17" tabindex="-1"></a><span class="co">   buffer-local `fringe-indicator-alist' variable.</span></span>
<span id="cb118-18"><a aria-hidden="true" href="#cb118-18" tabindex="-1"></a></span>
<span id="cb118-19"><a aria-hidden="true" href="#cb118-19" tabindex="-1"></a><span class="co">   Each element of this alist is a cons cell (LOGICAL . PHYSICAL),</span></span>
<span id="cb118-20"><a aria-hidden="true" href="#cb118-20" tabindex="-1"></a><span class="co">   mapping a logical bitmap to a physical bitmap.</span></span>
<span id="cb118-21"><a aria-hidden="true" href="#cb118-21" tabindex="-1"></a><span class="co">   PHYSICAL is either a symbol to use in both left and right fringe,</span></span>
<span id="cb118-22"><a aria-hidden="true" href="#cb118-22" tabindex="-1"></a><span class="co">   or a cons cell (LEFT . RIGHT) specifying different physical</span></span>
<span id="cb118-23"><a aria-hidden="true" href="#cb118-23" tabindex="-1"></a><span class="co">   bitmaps to use in left and right fringe.</span></span>
<span id="cb118-24"><a aria-hidden="true" href="#cb118-24" tabindex="-1"></a></span>
<span id="cb118-25"><a aria-hidden="true" href="#cb118-25" tabindex="-1"></a><span class="co">   When a logical bitmap is to be displayed in a fringe, the</span></span>
<span id="cb118-26"><a aria-hidden="true" href="#cb118-26" tabindex="-1"></a><span class="co">   `fringe-indicator-alist' is first searched for a mapping in the</span></span>
<span id="cb118-27"><a aria-hidden="true" href="#cb118-27" tabindex="-1"></a><span class="co">   buffer-local value, then in the global value of the alist.</span></span>
<span id="cb118-28"><a aria-hidden="true" href="#cb118-28" tabindex="-1"></a></span>
<span id="cb118-29"><a aria-hidden="true" href="#cb118-29" tabindex="-1"></a><span class="co">   If no physical bitmap is found for the logical bitmap, or if the</span></span>
<span id="cb118-30"><a aria-hidden="true" href="#cb118-30" tabindex="-1"></a><span class="co">   bitmap that is found is nil, no bitmap is shown for the logical</span></span>
<span id="cb118-31"><a aria-hidden="true" href="#cb118-31" tabindex="-1"></a><span class="co">   bitmap.</span></span>
<span id="cb118-32"><a aria-hidden="true" href="#cb118-32" tabindex="-1"></a></span>
<span id="cb118-33"><a aria-hidden="true" href="#cb118-33" tabindex="-1"></a><span class="co">   The `left-fringe' and `right-fringe' display properties</span></span>
<span id="cb118-34"><a aria-hidden="true" href="#cb118-34" tabindex="-1"></a><span class="co">   must specify physical bitmap symbols.</span></span>
<span id="cb118-35"><a aria-hidden="true" href="#cb118-35" tabindex="-1"></a><span class="co">*/</span></span></code></pre></div>
<h3 data-number="7.10.2" id="bitmap-definitions"><span class="header-section-number">7.10.2</span> Bitmap Definitions</h3>
<p>Standard bitmaps are defined as static bit patterns. Example from
<code>src/fringe.c:140-154</code>:</p>
<div class="sourceCode" id="cb119"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb119-1"><a aria-hidden="true" href="#cb119-1" tabindex="-1"></a><span class="co">/* Right truncation arrow bitmap `-&gt;'.  */</span></span>
<span id="cb119-2"><a aria-hidden="true" href="#cb119-2" tabindex="-1"></a><span class="co">/*</span></span>
<span id="cb119-3"><a aria-hidden="true" href="#cb119-3" tabindex="-1"></a><span class="co">  ..xxxx..</span></span>
<span id="cb119-4"><a aria-hidden="true" href="#cb119-4" tabindex="-1"></a><span class="co">  ...xxxx.</span></span>
<span id="cb119-5"><a aria-hidden="true" href="#cb119-5" tabindex="-1"></a><span class="co">  ....xxxx</span></span>
<span id="cb119-6"><a aria-hidden="true" href="#cb119-6" tabindex="-1"></a><span class="co">  .....xxx</span></span>
<span id="cb119-7"><a aria-hidden="true" href="#cb119-7" tabindex="-1"></a><span class="co">  ....xxxx</span></span>
<span id="cb119-8"><a aria-hidden="true" href="#cb119-8" tabindex="-1"></a><span class="co">  ...xxxx.</span></span>
<span id="cb119-9"><a aria-hidden="true" href="#cb119-9" tabindex="-1"></a><span class="co">  ..xxxx..</span></span>
<span id="cb119-10"><a aria-hidden="true" href="#cb119-10" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb119-11"><a aria-hidden="true" href="#cb119-11" tabindex="-1"></a><span class="dt">static</span> <span class="dt">unsigned</span> <span class="dt">short</span> right_truncation_bits<span class="op">[]</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb119-12"><a aria-hidden="true" href="#cb119-12" tabindex="-1"></a>  <span class="bn">0x3c</span><span class="op">,</span> <span class="bn">0x3e</span><span class="op">,</span> <span class="bn">0x1f</span><span class="op">,</span> <span class="bn">0x0f</span><span class="op">,</span> <span class="bn">0x1f</span><span class="op">,</span> <span class="bn">0x3e</span><span class="op">,</span> <span class="bn">0x3c</span><span class="op">};</span></span></code></pre></div>
<h3 data-number="7.10.3" id="fringe-bitmap-structure"><span class="header-section-number">7.10.3</span> Fringe Bitmap Structure</h3>
<p>From <code>src/fringe.c:78-88</code>:</p>
<div class="sourceCode" id="cb120"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb120-1"><a aria-hidden="true" href="#cb120-1" tabindex="-1"></a><span class="kw">struct</span> fringe_bitmap</span>
<span id="cb120-2"><a aria-hidden="true" href="#cb120-2" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb120-3"><a aria-hidden="true" href="#cb120-3" tabindex="-1"></a>  <span class="dt">unsigned</span> <span class="dt">short</span> <span class="op">*</span>bits<span class="op">;</span></span>
<span id="cb120-4"><a aria-hidden="true" href="#cb120-4" tabindex="-1"></a>  <span class="dt">unsigned</span> height<span class="op">;</span></span>
<span id="cb120-5"><a aria-hidden="true" href="#cb120-5" tabindex="-1"></a>  <span class="dt">unsigned</span> width<span class="op">;</span></span>
<span id="cb120-6"><a aria-hidden="true" href="#cb120-6" tabindex="-1"></a>  <span class="dt">signed</span> <span class="dt">char</span> align<span class="op">;</span>    <span class="co">/* ALIGN_TOP, ALIGN_CENTER, ALIGN_BOTTOM */</span></span>
<span id="cb120-7"><a aria-hidden="true" href="#cb120-7" tabindex="-1"></a>  bool_bf dynamic <span class="op">:</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb120-8"><a aria-hidden="true" href="#cb120-8" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<hr/>
<h2 data-number="7.11" id="performance-optimizations"><span class="header-section-number">7.11</span> Performance Optimizations</h2>
<h3 data-number="7.11.1" id="the-optimization-strategy"><span class="header-section-number">7.11.1</span> The Optimization
Strategy</h3>
<p>The display engine employs multiple optimization levels, attempting
fast paths first and falling back to full redisplay only when
necessary.</p>
<p>From <code>src/xdisp.c:134-173</code>:</p>
<div class="sourceCode" id="cb121"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb121-1"><a aria-hidden="true" href="#cb121-1" tabindex="-1"></a><span class="co">/*</span></span>
<span id="cb121-2"><a aria-hidden="true" href="#cb121-2" tabindex="-1"></a><span class="co">   You will find a lot of redisplay optimizations when you start</span></span>
<span id="cb121-3"><a aria-hidden="true" href="#cb121-3" tabindex="-1"></a><span class="co">   looking at the innards of `redisplay_window'.  The overall goal of</span></span>
<span id="cb121-4"><a aria-hidden="true" href="#cb121-4" tabindex="-1"></a><span class="co">   all these optimizations is to make redisplay fast because it is</span></span>
<span id="cb121-5"><a aria-hidden="true" href="#cb121-5" tabindex="-1"></a><span class="co">   done frequently.  Some of these optimizations are implemented by</span></span>
<span id="cb121-6"><a aria-hidden="true" href="#cb121-6" tabindex="-1"></a><span class="co">   the following functions:</span></span>
<span id="cb121-7"><a aria-hidden="true" href="#cb121-7" tabindex="-1"></a></span>
<span id="cb121-8"><a aria-hidden="true" href="#cb121-8" tabindex="-1"></a><span class="co">    . try_cursor_movement</span></span>
<span id="cb121-9"><a aria-hidden="true" href="#cb121-9" tabindex="-1"></a></span>
<span id="cb121-10"><a aria-hidden="true" href="#cb121-10" tabindex="-1"></a><span class="co">      This optimization is applicable if the text in the window did</span></span>
<span id="cb121-11"><a aria-hidden="true" href="#cb121-11" tabindex="-1"></a><span class="co">      not change and did not scroll, only point moved, and it did not</span></span>
<span id="cb121-12"><a aria-hidden="true" href="#cb121-12" tabindex="-1"></a><span class="co">      move off the displayed portion of the text.  In that case, the</span></span>
<span id="cb121-13"><a aria-hidden="true" href="#cb121-13" tabindex="-1"></a><span class="co">      window's glyph matrix is still valid, and only the position of</span></span>
<span id="cb121-14"><a aria-hidden="true" href="#cb121-14" tabindex="-1"></a><span class="co">      the cursor might need to be updated.</span></span>
<span id="cb121-15"><a aria-hidden="true" href="#cb121-15" tabindex="-1"></a></span>
<span id="cb121-16"><a aria-hidden="true" href="#cb121-16" tabindex="-1"></a><span class="co">    . try_window_reusing_current_matrix</span></span>
<span id="cb121-17"><a aria-hidden="true" href="#cb121-17" tabindex="-1"></a></span>
<span id="cb121-18"><a aria-hidden="true" href="#cb121-18" tabindex="-1"></a><span class="co">      This function reuses the current glyph matrix of a window when</span></span>
<span id="cb121-19"><a aria-hidden="true" href="#cb121-19" tabindex="-1"></a><span class="co">      text has not changed, but the window start changed (e.g., due to</span></span>
<span id="cb121-20"><a aria-hidden="true" href="#cb121-20" tabindex="-1"></a><span class="co">      scrolling).</span></span>
<span id="cb121-21"><a aria-hidden="true" href="#cb121-21" tabindex="-1"></a></span>
<span id="cb121-22"><a aria-hidden="true" href="#cb121-22" tabindex="-1"></a><span class="co">    . try_window_id</span></span>
<span id="cb121-23"><a aria-hidden="true" href="#cb121-23" tabindex="-1"></a></span>
<span id="cb121-24"><a aria-hidden="true" href="#cb121-24" tabindex="-1"></a><span class="co">      This function attempts to update a window's glyph matrix by</span></span>
<span id="cb121-25"><a aria-hidden="true" href="#cb121-25" tabindex="-1"></a><span class="co">      reusing parts of its current glyph matrix.  It finds and reuses</span></span>
<span id="cb121-26"><a aria-hidden="true" href="#cb121-26" tabindex="-1"></a><span class="co">      the part that was not changed, and regenerates the rest.  (The</span></span>
<span id="cb121-27"><a aria-hidden="true" href="#cb121-27" tabindex="-1"></a><span class="co">      "id" part in the function's name stands for "insert/delete", not</span></span>
<span id="cb121-28"><a aria-hidden="true" href="#cb121-28" tabindex="-1"></a><span class="co">      for "identification" or somesuch.)</span></span>
<span id="cb121-29"><a aria-hidden="true" href="#cb121-29" tabindex="-1"></a></span>
<span id="cb121-30"><a aria-hidden="true" href="#cb121-30" tabindex="-1"></a><span class="co">    . try_window</span></span>
<span id="cb121-31"><a aria-hidden="true" href="#cb121-31" tabindex="-1"></a></span>
<span id="cb121-32"><a aria-hidden="true" href="#cb121-32" tabindex="-1"></a><span class="co">      This function performs the full, unoptimized, generation of a</span></span>
<span id="cb121-33"><a aria-hidden="true" href="#cb121-33" tabindex="-1"></a><span class="co">      single window's glyph matrix, assuming that its fonts were not</span></span>
<span id="cb121-34"><a aria-hidden="true" href="#cb121-34" tabindex="-1"></a><span class="co">      changed and that the cursor will not end up in the scroll</span></span>
<span id="cb121-35"><a aria-hidden="true" href="#cb121-35" tabindex="-1"></a><span class="co">      margins.  (Loading fonts requires re-adjustment of dimensions of</span></span>
<span id="cb121-36"><a aria-hidden="true" href="#cb121-36" tabindex="-1"></a><span class="co">      glyph matrices, which makes this method impossible to use.)</span></span>
<span id="cb121-37"><a aria-hidden="true" href="#cb121-37" tabindex="-1"></a></span>
<span id="cb121-38"><a aria-hidden="true" href="#cb121-38" tabindex="-1"></a><span class="co">   The optimizations are tried in sequence (some can be skipped if</span></span>
<span id="cb121-39"><a aria-hidden="true" href="#cb121-39" tabindex="-1"></a><span class="co">   it is known that they are not applicable).  If none of the</span></span>
<span id="cb121-40"><a aria-hidden="true" href="#cb121-40" tabindex="-1"></a><span class="co">   optimizations were successful, redisplay calls redisplay_windows,</span></span>
<span id="cb121-41"><a aria-hidden="true" href="#cb121-41" tabindex="-1"></a><span class="co">   which performs a full redisplay of all windows.</span></span>
<span id="cb121-42"><a aria-hidden="true" href="#cb121-42" tabindex="-1"></a><span class="co">*/</span></span></code></pre></div>
<h3 data-number="7.11.2" id="try_window-the-unoptimized-path"><span class="header-section-number">7.11.2</span> <code>try_window()</code>:
The Unoptimized Path</h3>
<p>Even the ‚Äúunoptimized‚Äù path is highly efficient. From
<code>src/xdisp.c:21461-21556</code>:</p>
<div class="sourceCode" id="cb122"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb122-1"><a aria-hidden="true" href="#cb122-1" tabindex="-1"></a>try_window <span class="op">(</span>Lisp_Object window<span class="op">,</span> <span class="kw">struct</span> text_pos pos<span class="op">,</span> <span class="dt">int</span> flags<span class="op">)</span></span>
<span id="cb122-2"><a aria-hidden="true" href="#cb122-2" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb122-3"><a aria-hidden="true" href="#cb122-3" tabindex="-1"></a>  <span class="kw">struct</span> window <span class="op">*</span>w <span class="op">=</span> XWINDOW <span class="op">(</span>window<span class="op">);</span></span>
<span id="cb122-4"><a aria-hidden="true" href="#cb122-4" tabindex="-1"></a>  <span class="kw">struct</span> it it<span class="op">;</span></span>
<span id="cb122-5"><a aria-hidden="true" href="#cb122-5" tabindex="-1"></a>  <span class="kw">struct</span> glyph_row <span class="op">*</span>last_text_row <span class="op">=</span> NULL<span class="op">;</span></span>
<span id="cb122-6"><a aria-hidden="true" href="#cb122-6" tabindex="-1"></a>  <span class="kw">struct</span> frame <span class="op">*</span>f <span class="op">=</span> XFRAME <span class="op">(</span>w<span class="op">-&gt;</span>frame<span class="op">);</span></span>
<span id="cb122-7"><a aria-hidden="true" href="#cb122-7" tabindex="-1"></a>  <span class="dt">int</span> cursor_vpos <span class="op">=</span> w<span class="op">-&gt;</span>cursor<span class="op">.</span>vpos<span class="op">;</span></span>
<span id="cb122-8"><a aria-hidden="true" href="#cb122-8" tabindex="-1"></a></span>
<span id="cb122-9"><a aria-hidden="true" href="#cb122-9" tabindex="-1"></a>  <span class="co">/* Make POS the new window start.  */</span></span>
<span id="cb122-10"><a aria-hidden="true" href="#cb122-10" tabindex="-1"></a>  set_marker_both <span class="op">(</span>w<span class="op">-&gt;</span>start<span class="op">,</span> Qnil<span class="op">,</span> CHARPOS <span class="op">(</span>pos<span class="op">),</span> BYTEPOS <span class="op">(</span>pos<span class="op">));</span></span>
<span id="cb122-11"><a aria-hidden="true" href="#cb122-11" tabindex="-1"></a></span>
<span id="cb122-12"><a aria-hidden="true" href="#cb122-12" tabindex="-1"></a>  <span class="co">/* Mark cursor position as unknown.  No overlay arrow seen.  */</span></span>
<span id="cb122-13"><a aria-hidden="true" href="#cb122-13" tabindex="-1"></a>  w<span class="op">-&gt;</span>cursor<span class="op">.</span>vpos <span class="op">=</span> <span class="op">-</span><span class="dv">1</span><span class="op">;</span></span>
<span id="cb122-14"><a aria-hidden="true" href="#cb122-14" tabindex="-1"></a>  overlay_arrow_seen <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb122-15"><a aria-hidden="true" href="#cb122-15" tabindex="-1"></a></span>
<span id="cb122-16"><a aria-hidden="true" href="#cb122-16" tabindex="-1"></a>  <span class="co">/* Initialize iterator and info to start at POS.  */</span></span>
<span id="cb122-17"><a aria-hidden="true" href="#cb122-17" tabindex="-1"></a>  start_display <span class="op">(&amp;</span>it<span class="op">,</span> w<span class="op">,</span> pos<span class="op">);</span></span>
<span id="cb122-18"><a aria-hidden="true" href="#cb122-18" tabindex="-1"></a>  it<span class="op">.</span>glyph_row<span class="op">-&gt;</span>reversed_p <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb122-19"><a aria-hidden="true" href="#cb122-19" tabindex="-1"></a></span>
<span id="cb122-20"><a aria-hidden="true" href="#cb122-20" tabindex="-1"></a>  <span class="co">/* Display all lines of W.  */</span></span>
<span id="cb122-21"><a aria-hidden="true" href="#cb122-21" tabindex="-1"></a>  <span class="cf">while</span> <span class="op">(</span>it<span class="op">.</span>current_y <span class="op">&lt;</span> it<span class="op">.</span>last_visible_y<span class="op">)</span></span>
<span id="cb122-22"><a aria-hidden="true" href="#cb122-22" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb122-23"><a aria-hidden="true" href="#cb122-23" tabindex="-1"></a>      <span class="dt">int</span> last_row_scale <span class="op">=</span> it<span class="op">.</span>w<span class="op">-&gt;</span>nrows_scale_factor<span class="op">;</span></span>
<span id="cb122-24"><a aria-hidden="true" href="#cb122-24" tabindex="-1"></a>      <span class="dt">int</span> last_col_scale <span class="op">=</span> it<span class="op">.</span>w<span class="op">-&gt;</span>ncols_scale_factor<span class="op">;</span></span>
<span id="cb122-25"><a aria-hidden="true" href="#cb122-25" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span>display_line <span class="op">(&amp;</span>it<span class="op">,</span> cursor_vpos<span class="op">))</span></span>
<span id="cb122-26"><a aria-hidden="true" href="#cb122-26" tabindex="-1"></a>    last_text_row <span class="op">=</span> it<span class="op">.</span>glyph_row <span class="op">-</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb122-27"><a aria-hidden="true" href="#cb122-27" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span>f<span class="op">-&gt;</span>fonts_changed</span>
<span id="cb122-28"><a aria-hidden="true" href="#cb122-28" tabindex="-1"></a>      <span class="op">&amp;&amp;</span> <span class="op">!((</span>flags <span class="op">&amp;</span> TRY_WINDOW_IGNORE_FONTS_CHANGE<span class="op">)</span></span>
<span id="cb122-29"><a aria-hidden="true" href="#cb122-29" tabindex="-1"></a>           <span class="co">/* If the matrix dimensions are insufficient, we _must_</span></span>
<span id="cb122-30"><a aria-hidden="true" href="#cb122-30" tabindex="-1"></a><span class="co">          fail and let dispnew.c reallocate the matrix.  */</span></span>
<span id="cb122-31"><a aria-hidden="true" href="#cb122-31" tabindex="-1"></a>           <span class="op">&amp;&amp;</span> last_row_scale <span class="op">==</span> it<span class="op">.</span>w<span class="op">-&gt;</span>nrows_scale_factor</span>
<span id="cb122-32"><a aria-hidden="true" href="#cb122-32" tabindex="-1"></a>           <span class="op">&amp;&amp;</span> last_col_scale <span class="op">==</span> it<span class="op">.</span>w<span class="op">-&gt;</span>ncols_scale_factor<span class="op">))</span></span>
<span id="cb122-33"><a aria-hidden="true" href="#cb122-33" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb122-34"><a aria-hidden="true" href="#cb122-34" tabindex="-1"></a>    <span class="op">}</span></span></code></pre></div>
<p>The function simply: 1. Initializes an iterator at the window start
position 2. Calls <code>display_line()</code> for each visible line 3.
Returns success/failure status</p>
<p><strong>Simplicity is performance</strong>: By avoiding special
cases, the code is easier to optimize at the compiler level.</p>
<h3 data-number="7.11.3" id="scroll-margin-optimization"><span class="header-section-number">7.11.3</span> Scroll Margin
Optimization</h3>
<p>From <code>src/xdisp.c:21500-21529</code>:</p>
<div class="sourceCode" id="cb123"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb123-1"><a aria-hidden="true" href="#cb123-1" tabindex="-1"></a>  <span class="co">/* Don't let the cursor end in the scroll margins.  However, when</span></span>
<span id="cb123-2"><a aria-hidden="true" href="#cb123-2" tabindex="-1"></a><span class="co">     the window is vscrolled, we leave it to vscroll to handle the</span></span>
<span id="cb123-3"><a aria-hidden="true" href="#cb123-3" tabindex="-1"></a><span class="co">     margins, see window_scroll_pixel_based.  */</span></span>
<span id="cb123-4"><a aria-hidden="true" href="#cb123-4" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">((</span>flags <span class="op">&amp;</span> TRY_WINDOW_CHECK_MARGINS<span class="op">)</span></span>
<span id="cb123-5"><a aria-hidden="true" href="#cb123-5" tabindex="-1"></a>      <span class="op">&amp;&amp;</span> w<span class="op">-&gt;</span>vscroll <span class="op">==</span> <span class="dv">0</span></span>
<span id="cb123-6"><a aria-hidden="true" href="#cb123-6" tabindex="-1"></a>      <span class="op">&amp;&amp;</span> <span class="op">!</span>MINI_WINDOW_P <span class="op">(</span>w<span class="op">))</span></span>
<span id="cb123-7"><a aria-hidden="true" href="#cb123-7" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb123-8"><a aria-hidden="true" href="#cb123-8" tabindex="-1"></a>      <span class="dt">int</span> top_scroll_margin <span class="op">=</span> window_scroll_margin <span class="op">(</span>w<span class="op">,</span> MARGIN_IN_PIXELS<span class="op">);</span></span>
<span id="cb123-9"><a aria-hidden="true" href="#cb123-9" tabindex="-1"></a>      <span class="dt">int</span> bot_scroll_margin <span class="op">=</span> top_scroll_margin<span class="op">;</span></span>
<span id="cb123-10"><a aria-hidden="true" href="#cb123-10" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span>window_wants_header_line <span class="op">(</span>w<span class="op">))</span></span>
<span id="cb123-11"><a aria-hidden="true" href="#cb123-11" tabindex="-1"></a>    top_scroll_margin <span class="op">+=</span> CURRENT_HEADER_LINE_HEIGHT <span class="op">(</span>w<span class="op">);</span></span>
<span id="cb123-12"><a aria-hidden="true" href="#cb123-12" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span>window_wants_tab_line <span class="op">(</span>w<span class="op">))</span></span>
<span id="cb123-13"><a aria-hidden="true" href="#cb123-13" tabindex="-1"></a>    top_scroll_margin <span class="op">+=</span> CURRENT_TAB_LINE_HEIGHT <span class="op">(</span>w<span class="op">);</span></span>
<span id="cb123-14"><a aria-hidden="true" href="#cb123-14" tabindex="-1"></a>      start_display <span class="op">(&amp;</span>it<span class="op">,</span> w<span class="op">,</span> pos<span class="op">);</span></span>
<span id="cb123-15"><a aria-hidden="true" href="#cb123-15" tabindex="-1"></a></span>
<span id="cb123-16"><a aria-hidden="true" href="#cb123-16" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">((</span>w<span class="op">-&gt;</span>cursor<span class="op">.</span>y <span class="op">&gt;=</span> <span class="dv">0</span></span>
<span id="cb123-17"><a aria-hidden="true" href="#cb123-17" tabindex="-1"></a>       <span class="op">&amp;&amp;</span> w<span class="op">-&gt;</span>cursor<span class="op">.</span>y <span class="op">&lt;</span> top_scroll_margin</span>
<span id="cb123-18"><a aria-hidden="true" href="#cb123-18" tabindex="-1"></a>       <span class="op">&amp;&amp;</span> CHARPOS <span class="op">(</span>pos<span class="op">)</span> <span class="op">&gt;</span> BEGV<span class="op">)</span></span>
<span id="cb123-19"><a aria-hidden="true" href="#cb123-19" tabindex="-1"></a>      <span class="co">/* rms: considering make_cursor_line_fully_visible_p here</span></span>
<span id="cb123-20"><a aria-hidden="true" href="#cb123-20" tabindex="-1"></a><span class="co">         seems to give wrong results.  We don't want to recenter</span></span>
<span id="cb123-21"><a aria-hidden="true" href="#cb123-21" tabindex="-1"></a><span class="co">         when the last line is partly visible, we want to allow</span></span>
<span id="cb123-22"><a aria-hidden="true" href="#cb123-22" tabindex="-1"></a><span class="co">         that case to be handled in the usual way.  */</span></span>
<span id="cb123-23"><a aria-hidden="true" href="#cb123-23" tabindex="-1"></a>      <span class="op">||</span> w<span class="op">-&gt;</span>cursor<span class="op">.</span>y <span class="op">&gt;</span> <span class="op">(</span>it<span class="op">.</span>last_visible_y <span class="op">-</span> partial_line_height <span class="op">(&amp;</span>it<span class="op">)</span></span>
<span id="cb123-24"><a aria-hidden="true" href="#cb123-24" tabindex="-1"></a>                <span class="op">-</span> bot_scroll_margin <span class="op">-</span> <span class="dv">1</span><span class="op">))</span></span>
<span id="cb123-25"><a aria-hidden="true" href="#cb123-25" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb123-26"><a aria-hidden="true" href="#cb123-26" tabindex="-1"></a>      w<span class="op">-&gt;</span>cursor<span class="op">.</span>vpos <span class="op">=</span> <span class="op">-</span><span class="dv">1</span><span class="op">;</span></span>
<span id="cb123-27"><a aria-hidden="true" href="#cb123-27" tabindex="-1"></a>      clear_glyph_matrix <span class="op">(</span>w<span class="op">-&gt;</span>desired_matrix<span class="op">);</span></span>
<span id="cb123-28"><a aria-hidden="true" href="#cb123-28" tabindex="-1"></a>      <span class="cf">return</span> <span class="op">-</span><span class="dv">1</span><span class="op">;</span></span>
<span id="cb123-29"><a aria-hidden="true" href="#cb123-29" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb123-30"><a aria-hidden="true" href="#cb123-30" tabindex="-1"></a>    <span class="op">}</span></span></code></pre></div>
<p>This check prevents the cursor from landing in scroll margins,
improving user experience.</p>
<h3 data-number="7.11.4" id="hash-based-row-comparison"><span class="header-section-number">7.11.4</span> Hash-Based Row
Comparison</h3>
<p>Glyph rows have hash codes for fast comparison. From
<code>src/dispextern.h:928-930</code>:</p>
<div class="sourceCode" id="cb124"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb124-1"><a aria-hidden="true" href="#cb124-1" tabindex="-1"></a>  <span class="co">/* Hash code.  This hash code is available as soon as the row</span></span>
<span id="cb124-2"><a aria-hidden="true" href="#cb124-2" tabindex="-1"></a><span class="co">     is constructed, i.e. after a call to display_line.  */</span></span>
<span id="cb124-3"><a aria-hidden="true" href="#cb124-3" tabindex="-1"></a>  <span class="dt">unsigned</span> hash<span class="op">;</span></span></code></pre></div>
<p>During screen update, identical rows (same hash) can be skipped,
avoiding unnecessary terminal I/O.</p>
<hr/>
<h2 data-number="7.12" id="window-system-integration"><span class="header-section-number">7.12</span> Window System Integration</h2>
<h3 data-number="7.12.1" id="abstraction-through-backend-functions"><span class="header-section-number">7.12.1</span> Abstraction Through Backend
Functions</h3>
<p>The display engine abstracts window system specifics through function
pointers in <code>struct terminal</code> and
<code>struct frame</code>.</p>
<h3 data-number="7.12.2" id="the-update-dispatch"><span class="header-section-number">7.12.2</span> The Update Dispatch</h3>
<p>From <code>src/dispnew.c:4115-4123</code>:</p>
<div class="sourceCode" id="cb125"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb125-1"><a aria-hidden="true" href="#cb125-1" tabindex="-1"></a>update_frame <span class="op">(</span><span class="kw">struct</span> frame <span class="op">*</span>f<span class="op">,</span> <span class="dt">bool</span> inhibit_scrolling<span class="op">)</span></span>
<span id="cb125-2"><a aria-hidden="true" href="#cb125-2" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb125-3"><a aria-hidden="true" href="#cb125-3" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>FRAME_WINDOW_P <span class="op">(</span>f<span class="op">))</span></span>
<span id="cb125-4"><a aria-hidden="true" href="#cb125-4" tabindex="-1"></a>    update_window_frame <span class="op">(</span>f<span class="op">);</span></span>
<span id="cb125-5"><a aria-hidden="true" href="#cb125-5" tabindex="-1"></a>  <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>FRAME_INITIAL_P <span class="op">(</span>f<span class="op">))</span></span>
<span id="cb125-6"><a aria-hidden="true" href="#cb125-6" tabindex="-1"></a>    update_initial_frame <span class="op">(</span>f<span class="op">);</span></span>
<span id="cb125-7"><a aria-hidden="true" href="#cb125-7" tabindex="-1"></a>  <span class="cf">else</span></span>
<span id="cb125-8"><a aria-hidden="true" href="#cb125-8" tabindex="-1"></a>    update_tty_frame <span class="op">(</span>f<span class="op">);</span></span>
<span id="cb125-9"><a aria-hidden="true" href="#cb125-9" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>Three Update Paths:</strong></p>
<ol type="1">
<li><strong>Window Frames</strong> (X11, Windows, macOS): Use GUI
toolkit facilities</li>
<li><strong>Initial Frames</strong>: Special handling for daemon
mode</li>
<li><strong>TTY Frames</strong>: Terminal control sequences</li>
</ol>
<h3 data-number="7.12.3" id="terminal-specific-rendering"><span class="header-section-number">7.12.3</span> Terminal-Specific
Rendering</h3>
<p>Each backend implements:</p>
<ul>
<li><code>write_glyphs()</code>: Output glyphs to screen</li>
<li><code>clear_end_of_line()</code>: Erase to end of line</li>
<li><code>ins_del_lines()</code>: Insert/delete lines (for
scrolling)</li>
<li><code>set_terminal_modes()</code>: Initialize terminal state</li>
<li><code>cursor_to()</code>: Move cursor to position</li>
</ul>
<p>These function pointers in <code>struct terminal</code> allow the
core display code to remain platform-independent.</p>
<h3 data-number="7.12.4" id="frame-matrix-usage-on-ttys"><span class="header-section-number">7.12.4</span> Frame Matrix Usage on
TTYs</h3>
<p>Text terminals use frame matrices for efficient scrolling. From
<code>dispnew.c</code>:</p>
<div class="sourceCode" id="cb126"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb126-1"><a aria-hidden="true" href="#cb126-1" tabindex="-1"></a><span class="co">/* Build frame matrix from window matrices.  */</span></span>
<span id="cb126-2"><a aria-hidden="true" href="#cb126-2" tabindex="-1"></a>build_frame_matrix_from_window_tree <span class="op">(</span>frame<span class="op">-&gt;</span>current_matrix<span class="op">,</span> root_window<span class="op">);</span></span>
<span id="cb126-3"><a aria-hidden="true" href="#cb126-3" tabindex="-1"></a></span>
<span id="cb126-4"><a aria-hidden="true" href="#cb126-4" tabindex="-1"></a><span class="co">/* Perform scrolling operations.  */</span></span>
<span id="cb126-5"><a aria-hidden="true" href="#cb126-5" tabindex="-1"></a>scrolling <span class="op">(</span>frame<span class="op">);</span></span>
<span id="cb126-6"><a aria-hidden="true" href="#cb126-6" tabindex="-1"></a></span>
<span id="cb126-7"><a aria-hidden="true" href="#cb126-7" tabindex="-1"></a><span class="co">/* Update terminal output.  */</span></span>
<span id="cb126-8"><a aria-hidden="true" href="#cb126-8" tabindex="-1"></a>write_matrix <span class="op">(</span>frame<span class="op">,</span> <span class="kw">true</span><span class="op">,</span> <span class="kw">true</span><span class="op">);</span></span></code></pre></div>
<p>The scrolling optimization detects that lines have merely moved
vertically and uses terminal scroll commands instead of rewriting entire
lines.</p>
<hr/>
<h2 data-number="7.13" id="advanced-topics"><span class="header-section-number">7.13</span> Advanced Topics</h2>
<h3 data-number="7.13.1" id="long-line-optimization"><span class="header-section-number">7.13.1</span> Long Line Optimization</h3>
<p>Modern Emacs includes special optimizations for extremely long lines
(10,000+ characters). From <code>src/xdisp.c:25616-25631</code>:</p>
<div class="sourceCode" id="cb127"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb127-1"><a aria-hidden="true" href="#cb127-1" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span>current_buffer<span class="op">-&gt;</span>long_line_optimizations_p</span>
<span id="cb127-2"><a aria-hidden="true" href="#cb127-2" tabindex="-1"></a>      <span class="op">&amp;&amp;</span> it<span class="op">-&gt;</span>line_wrap <span class="op">==</span> TRUNCATE</span>
<span id="cb127-3"><a aria-hidden="true" href="#cb127-3" tabindex="-1"></a>      <span class="op">&amp;&amp;</span> window_hscroll_limited <span class="op">(</span>it<span class="op">-&gt;</span>w<span class="op">,</span> it<span class="op">-&gt;</span>f<span class="op">)</span> <span class="op">&gt;</span> large_hscroll_threshold<span class="op">)</span></span>
<span id="cb127-4"><a aria-hidden="true" href="#cb127-4" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb127-5"><a aria-hidden="true" href="#cb127-5" tabindex="-1"></a>      <span class="co">/* Special optimization for very long and truncated lines</span></span>
<span id="cb127-6"><a aria-hidden="true" href="#cb127-6" tabindex="-1"></a><span class="co">         which are hscrolled far to the left: jump directly to the</span></span>
<span id="cb127-7"><a aria-hidden="true" href="#cb127-7" tabindex="-1"></a><span class="co">         (approximate) position that is visible, instead of slowly</span></span>
<span id="cb127-8"><a aria-hidden="true" href="#cb127-8" tabindex="-1"></a><span class="co">         walking there.  */</span></span>
<span id="cb127-9"><a aria-hidden="true" href="#cb127-9" tabindex="-1"></a>      <span class="dt">ptrdiff_t</span> chars_to_skip <span class="op">=</span></span>
<span id="cb127-10"><a aria-hidden="true" href="#cb127-10" tabindex="-1"></a>        it<span class="op">-&gt;</span>first_visible_x <span class="op">/</span> FRAME_COLUMN_WIDTH <span class="op">(</span>it<span class="op">-&gt;</span>f<span class="op">);</span></span>
<span id="cb127-11"><a aria-hidden="true" href="#cb127-11" tabindex="-1"></a>      move_result <span class="op">=</span> fast_move_it_horizontally <span class="op">(</span>it<span class="op">,</span> chars_to_skip<span class="op">);</span></span>
<span id="cb127-12"><a aria-hidden="true" href="#cb127-12" tabindex="-1"></a></span>
<span id="cb127-13"><a aria-hidden="true" href="#cb127-13" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span>move_result <span class="op">==</span> MOVE_X_REACHED<span class="op">)</span></span>
<span id="cb127-14"><a aria-hidden="true" href="#cb127-14" tabindex="-1"></a>        it<span class="op">-&gt;</span>current_x <span class="op">=</span> it<span class="op">-&gt;</span>first_visible_x<span class="op">;</span></span>
<span id="cb127-15"><a aria-hidden="true" href="#cb127-15" tabindex="-1"></a>      <span class="cf">else</span>  <span class="co">/* use arbitrary value &lt; first_visible_x */</span></span>
<span id="cb127-16"><a aria-hidden="true" href="#cb127-16" tabindex="-1"></a>        it<span class="op">-&gt;</span>current_x <span class="op">=</span> it<span class="op">-&gt;</span>first_visible_x <span class="op">-</span> FRAME_COLUMN_WIDTH <span class="op">(</span>it<span class="op">-&gt;</span>f<span class="op">);</span></span>
<span id="cb127-17"><a aria-hidden="true" href="#cb127-17" tabindex="-1"></a>    <span class="op">}</span></span></code></pre></div>
<p>This optimization skips calculating layout for off-screen portions of
very long lines.</p>
<h3 data-number="7.13.2" id="simulating-display-without-rendering"><span class="header-section-number">7.13.2</span> Simulating Display Without
Rendering</h3>
<p>Functions like <code>move_it_by_lines()</code> use the display engine
to calculate layout without producing glyphs. From
<code>src/xdisp.c:337-372</code>:</p>
<div class="sourceCode" id="cb128"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb128-1"><a aria-hidden="true" href="#cb128-1" tabindex="-1"></a><span class="co">/*</span></span>
<span id="cb128-2"><a aria-hidden="true" href="#cb128-2" tabindex="-1"></a><span class="co">   Simulating display.</span></span>
<span id="cb128-3"><a aria-hidden="true" href="#cb128-3" tabindex="-1"></a></span>
<span id="cb128-4"><a aria-hidden="true" href="#cb128-4" tabindex="-1"></a><span class="co">   Some of Emacs commands and functions need to take display layout</span></span>
<span id="cb128-5"><a aria-hidden="true" href="#cb128-5" tabindex="-1"></a><span class="co">   into consideration.  For example, C-n moves to the next screen</span></span>
<span id="cb128-6"><a aria-hidden="true" href="#cb128-6" tabindex="-1"></a><span class="co">   line, but to implement that, Emacs needs to find the buffer</span></span>
<span id="cb128-7"><a aria-hidden="true" href="#cb128-7" tabindex="-1"></a><span class="co">   position which is directly below the cursor position on display.</span></span>
<span id="cb128-8"><a aria-hidden="true" href="#cb128-8" tabindex="-1"></a><span class="co">   This is not trivial when buffer display includes variable-size</span></span>
<span id="cb128-9"><a aria-hidden="true" href="#cb128-9" tabindex="-1"></a><span class="co">   elements such as different fonts, tall images, etc.</span></span>
<span id="cb128-10"><a aria-hidden="true" href="#cb128-10" tabindex="-1"></a></span>
<span id="cb128-11"><a aria-hidden="true" href="#cb128-11" tabindex="-1"></a><span class="co">   To solve this problem, the display engine implements several</span></span>
<span id="cb128-12"><a aria-hidden="true" href="#cb128-12" tabindex="-1"></a><span class="co">   functions that can move through buffer text in the same manner as</span></span>
<span id="cb128-13"><a aria-hidden="true" href="#cb128-13" tabindex="-1"></a><span class="co">   `display_line' and `display_string' do, but without producing any</span></span>
<span id="cb128-14"><a aria-hidden="true" href="#cb128-14" tabindex="-1"></a><span class="co">   glyphs for the glyph matrices.  The workhorse of this is</span></span>
<span id="cb128-15"><a aria-hidden="true" href="#cb128-15" tabindex="-1"></a><span class="co">   `move_it_in_display_line_to'.  Its code and logic are very similar</span></span>
<span id="cb128-16"><a aria-hidden="true" href="#cb128-16" tabindex="-1"></a><span class="co">   to `display_line', but it differs in two important aspects: it</span></span>
<span id="cb128-17"><a aria-hidden="true" href="#cb128-17" tabindex="-1"></a><span class="co">   doesn't produce glyphs for any glyph matrix, and it returns a</span></span>
<span id="cb128-18"><a aria-hidden="true" href="#cb128-18" tabindex="-1"></a><span class="co">   status telling the caller how it ended the iteration: whether it</span></span>
<span id="cb128-19"><a aria-hidden="true" href="#cb128-19" tabindex="-1"></a><span class="co">   reached the required position, hit the end of line, arrived at the</span></span>
<span id="cb128-20"><a aria-hidden="true" href="#cb128-20" tabindex="-1"></a><span class="co">   window edge without exhausting the buffer's line, etc.  Since the</span></span>
<span id="cb128-21"><a aria-hidden="true" href="#cb128-21" tabindex="-1"></a><span class="co">   glyphs are not produced, the layout information available to the</span></span>
<span id="cb128-22"><a aria-hidden="true" href="#cb128-22" tabindex="-1"></a><span class="co">   callers of this function is what is recorded in `struct it' by the</span></span>
<span id="cb128-23"><a aria-hidden="true" href="#cb128-23" tabindex="-1"></a><span class="co">   iteration process.</span></span>
<span id="cb128-24"><a aria-hidden="true" href="#cb128-24" tabindex="-1"></a></span>
<span id="cb128-25"><a aria-hidden="true" href="#cb128-25" tabindex="-1"></a><span class="co">   Several higher-level functions call `move_it_in_display_line_to' to</span></span>
<span id="cb128-26"><a aria-hidden="true" href="#cb128-26" tabindex="-1"></a><span class="co">   perform more complex tasks: `move_it_by_lines' can move N lines up</span></span>
<span id="cb128-27"><a aria-hidden="true" href="#cb128-27" tabindex="-1"></a><span class="co">   or down from a given buffer position and `move_it_to' can move to a</span></span>
<span id="cb128-28"><a aria-hidden="true" href="#cb128-28" tabindex="-1"></a><span class="co">   given buffer position or to a given X or Y pixel coordinate.</span></span>
<span id="cb128-29"><a aria-hidden="true" href="#cb128-29" tabindex="-1"></a></span>
<span id="cb128-30"><a aria-hidden="true" href="#cb128-30" tabindex="-1"></a><span class="co">   These functions are called by the display engine itself as well,</span></span>
<span id="cb128-31"><a aria-hidden="true" href="#cb128-31" tabindex="-1"></a><span class="co">   when it needs to make layout decisions before producing the glyphs.</span></span>
<span id="cb128-32"><a aria-hidden="true" href="#cb128-32" tabindex="-1"></a><span class="co">   For example, one of the first things to decide when redisplaying a</span></span>
<span id="cb128-33"><a aria-hidden="true" href="#cb128-33" tabindex="-1"></a><span class="co">   window is where to put the `window-start' position; if the window</span></span>
<span id="cb128-34"><a aria-hidden="true" href="#cb128-34" tabindex="-1"></a><span class="co">   is to be recentered (the default), Emacs makes that decision by</span></span>
<span id="cb128-35"><a aria-hidden="true" href="#cb128-35" tabindex="-1"></a><span class="co">   starting from the position of point, then moving up the number of</span></span>
<span id="cb128-36"><a aria-hidden="true" href="#cb128-36" tabindex="-1"></a><span class="co">   lines corresponding to half the window height using</span></span>
<span id="cb128-37"><a aria-hidden="true" href="#cb128-37" tabindex="-1"></a><span class="co">   `move_it_by_lines'.</span></span>
<span id="cb128-38"><a aria-hidden="true" href="#cb128-38" tabindex="-1"></a><span class="co">*/</span></span></code></pre></div>
<p>This ‚Äúsimulation mode‚Äù enables commands like <code>next-line</code>
to work correctly with variable-height lines, images, and other complex
display elements.</p>
<hr/>
<h2 data-number="7.14" id="debugging-the-display-engine"><span class="header-section-number">7.14</span> Debugging the Display
Engine</h2>
<h3 data-number="7.14.1" id="glyph_debug-mode"><span class="header-section-number">7.14.1</span> GLYPH_DEBUG Mode</h3>
<p>Compiling with <code>GLYPH_DEBUG</code> enabled adds extensive
debugging infrastructure:</p>
<div class="sourceCode" id="cb129"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb129-1"><a aria-hidden="true" href="#cb129-1" tabindex="-1"></a><span class="pp">#ifdef GLYPH_DEBUG</span></span>
<span id="cb129-2"><a aria-hidden="true" href="#cb129-2" tabindex="-1"></a>  <span class="co">/* A string identifying the method used to display the matrix.  */</span></span>
<span id="cb129-3"><a aria-hidden="true" href="#cb129-3" tabindex="-1"></a>  <span class="dt">char</span> method<span class="op">[</span><span class="dv">512</span><span class="op">];</span></span>
<span id="cb129-4"><a aria-hidden="true" href="#cb129-4" tabindex="-1"></a><span class="pp">#endif</span></span></code></pre></div>
<p>Each glyph matrix records how it was constructed, enabling diagnosis
of optimization paths taken.</p>
<h3 data-number="7.14.2" id="redisplay-history"><span class="header-section-number">7.14.2</span> Redisplay History</h3>
<p>From <code>src/dispnew.c:144-193</code>:</p>
<div class="sourceCode" id="cb130"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb130-1"><a aria-hidden="true" href="#cb130-1" tabindex="-1"></a><span class="pp">#ifdef GLYPH_DEBUG</span></span>
<span id="cb130-2"><a aria-hidden="true" href="#cb130-2" tabindex="-1"></a></span>
<span id="cb130-3"><a aria-hidden="true" href="#cb130-3" tabindex="-1"></a><span class="co">/* One element of the ring buffer containing redisplay history</span></span>
<span id="cb130-4"><a aria-hidden="true" href="#cb130-4" tabindex="-1"></a><span class="co">   information.  */</span></span>
<span id="cb130-5"><a aria-hidden="true" href="#cb130-5" tabindex="-1"></a></span>
<span id="cb130-6"><a aria-hidden="true" href="#cb130-6" tabindex="-1"></a><span class="kw">struct</span> redisplay_history</span>
<span id="cb130-7"><a aria-hidden="true" href="#cb130-7" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb130-8"><a aria-hidden="true" href="#cb130-8" tabindex="-1"></a>  <span class="dt">char</span> trace<span class="op">[</span><span class="dv">512</span> <span class="op">+</span> <span class="dv">100</span><span class="op">];</span></span>
<span id="cb130-9"><a aria-hidden="true" href="#cb130-9" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb130-10"><a aria-hidden="true" href="#cb130-10" tabindex="-1"></a></span>
<span id="cb130-11"><a aria-hidden="true" href="#cb130-11" tabindex="-1"></a><span class="co">/* The size of the history buffer.  */</span></span>
<span id="cb130-12"><a aria-hidden="true" href="#cb130-12" tabindex="-1"></a></span>
<span id="cb130-13"><a aria-hidden="true" href="#cb130-13" tabindex="-1"></a><span class="pp">#define REDISPLAY_HISTORY_SIZE  </span><span class="dv">30</span></span>
<span id="cb130-14"><a aria-hidden="true" href="#cb130-14" tabindex="-1"></a></span>
<span id="cb130-15"><a aria-hidden="true" href="#cb130-15" tabindex="-1"></a><span class="co">/* The redisplay history buffer.  */</span></span>
<span id="cb130-16"><a aria-hidden="true" href="#cb130-16" tabindex="-1"></a></span>
<span id="cb130-17"><a aria-hidden="true" href="#cb130-17" tabindex="-1"></a><span class="dt">static</span> <span class="kw">struct</span> redisplay_history redisplay_history<span class="op">[</span>REDISPLAY_HISTORY_SIZE<span class="op">];</span></span>
<span id="cb130-18"><a aria-hidden="true" href="#cb130-18" tabindex="-1"></a></span>
<span id="cb130-19"><a aria-hidden="true" href="#cb130-19" tabindex="-1"></a><span class="co">/* Next free entry in redisplay_history.  */</span></span>
<span id="cb130-20"><a aria-hidden="true" href="#cb130-20" tabindex="-1"></a></span>
<span id="cb130-21"><a aria-hidden="true" href="#cb130-21" tabindex="-1"></a><span class="dt">static</span> <span class="dt">int</span> history_idx<span class="op">;</span></span>
<span id="cb130-22"><a aria-hidden="true" href="#cb130-22" tabindex="-1"></a></span>
<span id="cb130-23"><a aria-hidden="true" href="#cb130-23" tabindex="-1"></a><span class="co">/* A tick that's incremented each time something is added to the</span></span>
<span id="cb130-24"><a aria-hidden="true" href="#cb130-24" tabindex="-1"></a><span class="co">   history.  */</span></span>
<span id="cb130-25"><a aria-hidden="true" href="#cb130-25" tabindex="-1"></a></span>
<span id="cb130-26"><a aria-hidden="true" href="#cb130-26" tabindex="-1"></a><span class="dt">static</span> <span class="dt">uintmax_t</span> history_tick<span class="op">;</span></span>
<span id="cb130-27"><a aria-hidden="true" href="#cb130-27" tabindex="-1"></a></span>
<span id="cb130-28"><a aria-hidden="true" href="#cb130-28" tabindex="-1"></a><span class="co">/* Add to the redisplay history how window W has been displayed.</span></span>
<span id="cb130-29"><a aria-hidden="true" href="#cb130-29" tabindex="-1"></a><span class="co">   MSG is a trace containing the information how W's glyph matrix</span></span>
<span id="cb130-30"><a aria-hidden="true" href="#cb130-30" tabindex="-1"></a><span class="co">   has been constructed.  */</span></span>
<span id="cb130-31"><a aria-hidden="true" href="#cb130-31" tabindex="-1"></a></span>
<span id="cb130-32"><a aria-hidden="true" href="#cb130-32" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span></span>
<span id="cb130-33"><a aria-hidden="true" href="#cb130-33" tabindex="-1"></a>add_window_display_history <span class="op">(</span><span class="kw">struct</span> window <span class="op">*</span>w<span class="op">,</span> <span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>msg<span class="op">)</span></span>
<span id="cb130-34"><a aria-hidden="true" href="#cb130-34" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb130-35"><a aria-hidden="true" href="#cb130-35" tabindex="-1"></a>  <span class="dt">char</span> <span class="op">*</span>buf<span class="op">;</span></span>
<span id="cb130-36"><a aria-hidden="true" href="#cb130-36" tabindex="-1"></a>  <span class="dt">void</span> <span class="op">*</span>ptr <span class="op">=</span> w<span class="op">;</span></span>
<span id="cb130-37"><a aria-hidden="true" href="#cb130-37" tabindex="-1"></a></span>
<span id="cb130-38"><a aria-hidden="true" href="#cb130-38" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>history_idx <span class="op">&gt;=</span> REDISPLAY_HISTORY_SIZE<span class="op">)</span></span>
<span id="cb130-39"><a aria-hidden="true" href="#cb130-39" tabindex="-1"></a>    history_idx <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb130-40"><a aria-hidden="true" href="#cb130-40" tabindex="-1"></a>  buf <span class="op">=</span> redisplay_history<span class="op">[</span>history_idx<span class="op">].</span>trace<span class="op">;</span></span>
<span id="cb130-41"><a aria-hidden="true" href="#cb130-41" tabindex="-1"></a>  <span class="op">++</span>history_idx<span class="op">;</span></span>
<span id="cb130-42"><a aria-hidden="true" href="#cb130-42" tabindex="-1"></a></span>
<span id="cb130-43"><a aria-hidden="true" href="#cb130-43" tabindex="-1"></a>  snprintf <span class="op">(</span>buf<span class="op">,</span> <span class="kw">sizeof</span> redisplay_history<span class="op">[</span><span class="dv">0</span><span class="op">].</span>trace<span class="op">,</span></span>
<span id="cb130-44"><a aria-hidden="true" href="#cb130-44" tabindex="-1"></a>        <span class="st">"%"</span>PRIuMAX<span class="st">": window </span><span class="sc">%p</span><span class="st"> </span><span class="sc">%s\n%s</span><span class="st">"</span><span class="op">,</span></span>
<span id="cb130-45"><a aria-hidden="true" href="#cb130-45" tabindex="-1"></a>        history_tick<span class="op">++,</span></span>
<span id="cb130-46"><a aria-hidden="true" href="#cb130-46" tabindex="-1"></a>        ptr<span class="op">,</span></span>
<span id="cb130-47"><a aria-hidden="true" href="#cb130-47" tabindex="-1"></a>        <span class="op">((</span>BUFFERP <span class="op">(</span>w<span class="op">-&gt;</span>contents<span class="op">)</span></span>
<span id="cb130-48"><a aria-hidden="true" href="#cb130-48" tabindex="-1"></a>          <span class="op">&amp;&amp;</span> STRINGP <span class="op">(</span>BVAR <span class="op">(</span>XBUFFER <span class="op">(</span>w<span class="op">-&gt;</span>contents<span class="op">),</span> name<span class="op">)))</span></span>
<span id="cb130-49"><a aria-hidden="true" href="#cb130-49" tabindex="-1"></a>         <span class="op">?</span> SSDATA <span class="op">(</span>BVAR <span class="op">(</span>XBUFFER <span class="op">(</span>w<span class="op">-&gt;</span>contents<span class="op">),</span> name<span class="op">))</span></span>
<span id="cb130-50"><a aria-hidden="true" href="#cb130-50" tabindex="-1"></a>         <span class="op">:</span> <span class="st">"???"</span><span class="op">),</span></span>
<span id="cb130-51"><a aria-hidden="true" href="#cb130-51" tabindex="-1"></a>        msg<span class="op">);</span></span>
<span id="cb130-52"><a aria-hidden="true" href="#cb130-52" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>The function <code>dump-redisplay-history</code> provides access to
this circular buffer for debugging complex redisplay issues.</p>
<hr/>
<h2 data-number="7.15" id="conclusion"><span class="header-section-number">7.15</span> Conclusion</h2>
<p>The Emacs display engine represents decades of refinement in text
rendering technology. Its design principles‚Äîseparation of concerns,
incremental updates, and abstract display elements‚Äîenable it to handle
everything from simple text to complex bidirectional layouts with
images, while maintaining excellent performance.</p>
<p>Key takeaways:</p>
<ol type="1">
<li><p><strong>Three-Phase Architecture</strong>: Separation of decision
(what to redisplay), generation (desired matrices), and rendering
(physical updates) enables powerful optimizations.</p></li>
<li><p><strong>Glyph Matrices</strong>: The central data structure
provides a uniform representation of display content, enabling efficient
comparison and minimal updates.</p></li>
<li><p><strong>The Display Iterator</strong>: A sophisticated state
machine handles the complexity of text properties, overlays, and
bidirectional text while presenting a simple interface.</p></li>
<li><p><strong>Performance Through Layers</strong>: Multiple
optimization levels (try_cursor_movement ‚Üí
try_window_reusing_current_matrix ‚Üí try_window_id ‚Üí try_window) ensure
fast common cases without sacrificing correctness.</p></li>
<li><p><strong>Platform Abstraction</strong>: Clean separation between
core logic and platform-specific rendering enables Emacs to run
efficiently on everything from 1970s terminals to modern graphics
workstations.</p></li>
</ol>
<p>The display engine‚Äôs complexity is justified by its capabilities: no
other text editor can match Emacs‚Äôs combination of flexibility
(arbitrary text properties, images, variable fonts), correctness (proper
bidirectional text), and performance (instant response even in
multi-megabyte files).</p>
<p>For developers working on the display code, understanding these
architectural principles is essential. The code is dense and highly
optimized, but it follows consistent patterns throughout. Start with the
high-level flow in <code>redisplay_internal()</code>, understand the
iterator concept, and work through specific optimization paths as
needed.</p>
<hr/>
<h2 data-number="7.16" id="references"><span class="header-section-number">7.16</span> References</h2>
<ul>
<li>UAX#9: Unicode Bidirectional Algorithm -
https://www.unicode.org/reports/tr9/</li>
<li>Gerd Moellmann‚Äôs original design notes (in source comments)</li>
<li>GNU Emacs Internals Manual</li>
<li><code>src/xdisp.c</code> - Primary display engine
implementation</li>
<li><code>src/dispnew.c</code> - Glyph matrix management</li>
<li><code>src/xfaces.c</code> - Face realization</li>
<li><code>src/bidi.c</code> - Bidirectional text support</li>
</ul>
<hr/>
<p><strong>Document Version</strong>: 1.0 <strong>Last Updated</strong>:
2025-11-18 <strong>Authors</strong>: Based on analysis of Emacs 30.x
source code</p>
<h1 data-number="8" id="keyboard-and-event-handling-system"><span class="header-section-number">8</span> Keyboard and Event Handling
System</h1>
<h2 data-number="8.1" id="table-of-contents-2"><span class="header-section-number">8.1</span> Table of Contents</h2>
<ol type="1">
<li><a href="#overview">Overview</a></li>
<li><a href="#core-data-structures">Core Data Structures</a></li>
<li><a href="#event-loop-architecture">Event Loop Architecture</a></li>
<li><a href="#event-reading-and-processing">Event Reading and
Processing</a></li>
<li><a href="#keymap-system">Keymap System</a></li>
<li><a href="#key-sequence-reading">Key Sequence Reading</a></li>
<li><a href="#command-execution">Command Execution</a></li>
<li><a href="#keyboard-macros">Keyboard Macros</a></li>
<li><a href="#special-event-types">Special Event Types</a></li>
<li><a href="#multi-keyboard-support">Multi-Keyboard Support</a></li>
</ol>
<h2 data-number="8.2" id="overview-1"><span class="header-section-number">8.2</span> Overview</h2>
<p>The keyboard and event handling system is one of Emacs‚Äôs most complex
subsystems, comprising over 14,000 lines in <code>src/keyboard.c</code>
alone. It manages the complete flow from hardware events to command
execution, handling keyboard input, mouse events, menu interactions, and
more.</p>
<h3 data-number="8.2.1" id="key-components"><span class="header-section-number">8.2.1</span> Key Components</h3>
<pre><code>Hardware Event ‚Üí Input Queue ‚Üí Event Loop ‚Üí Key Reading ‚Üí
Keymap Lookup ‚Üí Command Dispatch ‚Üí Interactive Execution</code></pre>
<p><strong>Primary Files:</strong> - <code>src/keyboard.c</code> (14,582
lines) - Event loop, key sequence reading, command dispatch -
<code>src/keymap.c</code> (4,001 lines) - Keymap data structures and
lookup algorithms - <code>src/callint.c</code> - Interactive command
execution - <code>src/macros.c</code> - Keyboard macro recording and
playback - <code>lisp/bindings.el</code> - Global key bindings -
<code>lisp/keymap.el</code> - High-level keymap functions</p>
<h2 data-number="8.3" id="core-data-structures"><span class="header-section-number">8.3</span> Core Data Structures</h2>
<h3 data-number="8.3.1" id="kboard---per-keyboard-state"><span class="header-section-number">8.3.1</span> 1. KBOARD - Per-Keyboard
State</h3>
<p>Each physical keyboard or display has its own KBOARD structure to
maintain independent state for macro recording, prefix arguments, and
event queues.</p>
<p><strong>Definition:</strong> <code>src/keyboard.h:81-185</code></p>
<div class="sourceCode" id="cb132"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb132-1"><a aria-hidden="true" href="#cb132-1" tabindex="-1"></a><span class="kw">struct</span> kboard</span>
<span id="cb132-2"><a aria-hidden="true" href="#cb132-2" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb132-3"><a aria-hidden="true" href="#cb132-3" tabindex="-1"></a>    KBOARD <span class="op">*</span>next_kboard<span class="op">;</span></span>
<span id="cb132-4"><a aria-hidden="true" href="#cb132-4" tabindex="-1"></a></span>
<span id="cb132-5"><a aria-hidden="true" href="#cb132-5" tabindex="-1"></a>    <span class="co">/* Terminal-local keymap overrides */</span></span>
<span id="cb132-6"><a aria-hidden="true" href="#cb132-6" tabindex="-1"></a>    Lisp_Object Voverriding_terminal_local_map_<span class="op">;</span></span>
<span id="cb132-7"><a aria-hidden="true" href="#cb132-7" tabindex="-1"></a></span>
<span id="cb132-8"><a aria-hidden="true" href="#cb132-8" tabindex="-1"></a>    <span class="co">/* Last command executed (for repeat, undo tracking) */</span></span>
<span id="cb132-9"><a aria-hidden="true" href="#cb132-9" tabindex="-1"></a>    Lisp_Object Vlast_command_<span class="op">;</span></span>
<span id="cb132-10"><a aria-hidden="true" href="#cb132-10" tabindex="-1"></a>    Lisp_Object Vreal_last_command_<span class="op">;</span></span>
<span id="cb132-11"><a aria-hidden="true" href="#cb132-11" tabindex="-1"></a></span>
<span id="cb132-12"><a aria-hidden="true" href="#cb132-12" tabindex="-1"></a>    <span class="co">/* User-supplied keyboard translation table */</span></span>
<span id="cb132-13"><a aria-hidden="true" href="#cb132-13" tabindex="-1"></a>    Lisp_Object Vkeyboard_translate_table_<span class="op">;</span></span>
<span id="cb132-14"><a aria-hidden="true" href="#cb132-14" tabindex="-1"></a></span>
<span id="cb132-15"><a aria-hidden="true" href="#cb132-15" tabindex="-1"></a>    <span class="co">/* Last repeatable command */</span></span>
<span id="cb132-16"><a aria-hidden="true" href="#cb132-16" tabindex="-1"></a>    Lisp_Object Vlast_repeatable_command_<span class="op">;</span></span>
<span id="cb132-17"><a aria-hidden="true" href="#cb132-17" tabindex="-1"></a></span>
<span id="cb132-18"><a aria-hidden="true" href="#cb132-18" tabindex="-1"></a>    <span class="co">/* Prefix argument state */</span></span>
<span id="cb132-19"><a aria-hidden="true" href="#cb132-19" tabindex="-1"></a>    Lisp_Object Vprefix_arg_<span class="op">;</span></span>
<span id="cb132-20"><a aria-hidden="true" href="#cb132-20" tabindex="-1"></a>    Lisp_Object Vlast_prefix_arg_<span class="op">;</span></span>
<span id="cb132-21"><a aria-hidden="true" href="#cb132-21" tabindex="-1"></a></span>
<span id="cb132-22"><a aria-hidden="true" href="#cb132-22" tabindex="-1"></a>    <span class="co">/* Unread events specific to this keyboard */</span></span>
<span id="cb132-23"><a aria-hidden="true" href="#cb132-23" tabindex="-1"></a>    Lisp_Object kbd_queue_<span class="op">;</span></span>
<span id="cb132-24"><a aria-hidden="true" href="#cb132-24" tabindex="-1"></a></span>
<span id="cb132-25"><a aria-hidden="true" href="#cb132-25" tabindex="-1"></a>    <span class="co">/* Keyboard macro state */</span></span>
<span id="cb132-26"><a aria-hidden="true" href="#cb132-26" tabindex="-1"></a>    Lisp_Object defining_kbd_macro_<span class="op">;</span></span>
<span id="cb132-27"><a aria-hidden="true" href="#cb132-27" tabindex="-1"></a>    Lisp_Object <span class="op">*</span>kbd_macro_buffer<span class="op">;</span>      <span class="co">// Recording buffer</span></span>
<span id="cb132-28"><a aria-hidden="true" href="#cb132-28" tabindex="-1"></a>    Lisp_Object <span class="op">*</span>kbd_macro_ptr<span class="op">;</span>         <span class="co">// Current position</span></span>
<span id="cb132-29"><a aria-hidden="true" href="#cb132-29" tabindex="-1"></a>    Lisp_Object <span class="op">*</span>kbd_macro_end<span class="op">;</span>         <span class="co">// End of finalized section</span></span>
<span id="cb132-30"><a aria-hidden="true" href="#cb132-30" tabindex="-1"></a>    <span class="dt">ptrdiff_t</span> kbd_macro_bufsize<span class="op">;</span></span>
<span id="cb132-31"><a aria-hidden="true" href="#cb132-31" tabindex="-1"></a>    Lisp_Object Vlast_kbd_macro_<span class="op">;</span></span>
<span id="cb132-32"><a aria-hidden="true" href="#cb132-32" tabindex="-1"></a></span>
<span id="cb132-33"><a aria-hidden="true" href="#cb132-33" tabindex="-1"></a>    <span class="co">/* Window system identification */</span></span>
<span id="cb132-34"><a aria-hidden="true" href="#cb132-34" tabindex="-1"></a>    Lisp_Object Vwindow_system_<span class="op">;</span></span>
<span id="cb132-35"><a aria-hidden="true" href="#cb132-35" tabindex="-1"></a></span>
<span id="cb132-36"><a aria-hidden="true" href="#cb132-36" tabindex="-1"></a>    <span class="co">/* Key translation maps */</span></span>
<span id="cb132-37"><a aria-hidden="true" href="#cb132-37" tabindex="-1"></a>    Lisp_Object Vlocal_function_key_map_<span class="op">;</span></span>
<span id="cb132-38"><a aria-hidden="true" href="#cb132-38" tabindex="-1"></a>    Lisp_Object Vinput_decode_map_<span class="op">;</span></span>
<span id="cb132-39"><a aria-hidden="true" href="#cb132-39" tabindex="-1"></a></span>
<span id="cb132-40"><a aria-hidden="true" href="#cb132-40" tabindex="-1"></a>    <span class="co">/* Echo state */</span></span>
<span id="cb132-41"><a aria-hidden="true" href="#cb132-41" tabindex="-1"></a>    Lisp_Object echo_string_<span class="op">;</span></span>
<span id="cb132-42"><a aria-hidden="true" href="#cb132-42" tabindex="-1"></a>    Lisp_Object echo_prompt_<span class="op">;</span></span>
<span id="cb132-43"><a aria-hidden="true" href="#cb132-43" tabindex="-1"></a></span>
<span id="cb132-44"><a aria-hidden="true" href="#cb132-44" tabindex="-1"></a>    <span class="co">/* Reference count for shared displays */</span></span>
<span id="cb132-45"><a aria-hidden="true" href="#cb132-45" tabindex="-1"></a>    <span class="dt">int</span> reference_count<span class="op">;</span></span>
<span id="cb132-46"><a aria-hidden="true" href="#cb132-46" tabindex="-1"></a></span>
<span id="cb132-47"><a aria-hidden="true" href="#cb132-47" tabindex="-1"></a>    <span class="co">/* Queue status flags */</span></span>
<span id="cb132-48"><a aria-hidden="true" href="#cb132-48" tabindex="-1"></a>    bool_bf kbd_queue_has_data<span class="op">;</span></span>
<span id="cb132-49"><a aria-hidden="true" href="#cb132-49" tabindex="-1"></a>    bool_bf immediate_echo <span class="op">:</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb132-50"><a aria-hidden="true" href="#cb132-50" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<p><strong>Key Concepts:</strong></p>
<ol type="1">
<li><p><strong>Single vs Any-KBOARD State:</strong></p>
<ul>
<li><strong>Any-KBOARD:</strong> Accept input from any keyboard, switch
on first complete key</li>
<li><strong>Single-KBOARD:</strong> Running a command, only accept input
from its keyboard</li>
</ul></li>
<li><p><strong>Event Queue:</strong> Each KBOARD has its own
<code>kbd_queue_</code> for events arriving while Emacs is processing
another KBOARD</p></li>
<li><p><strong>Macro Recording:</strong> Each KBOARD independently
tracks macro definition state</p></li>
</ol>
<p><strong>Access Macro:</strong> <code>src/keyboard.h:38</code></p>
<div class="sourceCode" id="cb133"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb133-1"><a aria-hidden="true" href="#cb133-1" tabindex="-1"></a><span class="pp">#define KVAR</span><span class="op">(</span><span class="pp">kboard</span><span class="op">,</span><span class="pp"> field</span><span class="op">)</span><span class="pp"> </span><span class="op">((</span><span class="pp">kboard</span><span class="op">)-&gt;</span><span class="pp">field </span><span class="op">##</span><span class="pp"> _</span><span class="op">)</span></span></code></pre></div>
<h3 data-number="8.3.2" id="input-events"><span class="header-section-number">8.3.2</span> 2. Input Events</h3>
<p><strong>Definition:</strong> <code>src/termhooks.h:72-250</code></p>
<div class="sourceCode" id="cb134"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb134-1"><a aria-hidden="true" href="#cb134-1" tabindex="-1"></a><span class="kw">enum</span> event_kind</span>
<span id="cb134-2"><a aria-hidden="true" href="#cb134-2" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb134-3"><a aria-hidden="true" href="#cb134-3" tabindex="-1"></a>    NO_EVENT<span class="op">,</span>                    <span class="co">// No event</span></span>
<span id="cb134-4"><a aria-hidden="true" href="#cb134-4" tabindex="-1"></a>    ASCII_KEYSTROKE_EVENT<span class="op">,</span>       <span class="co">// ASCII character with modifiers</span></span>
<span id="cb134-5"><a aria-hidden="true" href="#cb134-5" tabindex="-1"></a>    MULTIBYTE_CHAR_KEYSTROKE_EVENT<span class="op">,</span>  <span class="co">// Multibyte character</span></span>
<span id="cb134-6"><a aria-hidden="true" href="#cb134-6" tabindex="-1"></a>    NON_ASCII_KEYSTROKE_EVENT<span class="op">,</span>   <span class="co">// Function keys</span></span>
<span id="cb134-7"><a aria-hidden="true" href="#cb134-7" tabindex="-1"></a>    TIMER_EVENT<span class="op">,</span>                 <span class="co">// Timer fired</span></span>
<span id="cb134-8"><a aria-hidden="true" href="#cb134-8" tabindex="-1"></a>    MOUSE_CLICK_EVENT<span class="op">,</span>           <span class="co">// Mouse button click</span></span>
<span id="cb134-9"><a aria-hidden="true" href="#cb134-9" tabindex="-1"></a>    WHEEL_EVENT<span class="op">,</span>                 <span class="co">// Mouse wheel scroll</span></span>
<span id="cb134-10"><a aria-hidden="true" href="#cb134-10" tabindex="-1"></a>    HORIZ_WHEEL_EVENT<span class="op">,</span>          <span class="co">// Horizontal wheel</span></span>
<span id="cb134-11"><a aria-hidden="true" href="#cb134-11" tabindex="-1"></a>    SCROLL_BAR_CLICK_EVENT<span class="op">,</span>     <span class="co">// Scroll bar interaction</span></span>
<span id="cb134-12"><a aria-hidden="true" href="#cb134-12" tabindex="-1"></a>    SELECTION_REQUEST_EVENT<span class="op">,</span>     <span class="co">// X selection request</span></span>
<span id="cb134-13"><a aria-hidden="true" href="#cb134-13" tabindex="-1"></a>    SELECTION_CLEAR_EVENT<span class="op">,</span>       <span class="co">// X selection cleared</span></span>
<span id="cb134-14"><a aria-hidden="true" href="#cb134-14" tabindex="-1"></a>    DELETE_WINDOW_EVENT<span class="op">,</span>         <span class="co">// Window close request</span></span>
<span id="cb134-15"><a aria-hidden="true" href="#cb134-15" tabindex="-1"></a>    MENU_BAR_EVENT<span class="op">,</span>             <span class="co">// Menu bar selection</span></span>
<span id="cb134-16"><a aria-hidden="true" href="#cb134-16" tabindex="-1"></a>    TAB_BAR_EVENT<span class="op">,</span>              <span class="co">// Tab bar interaction</span></span>
<span id="cb134-17"><a aria-hidden="true" href="#cb134-17" tabindex="-1"></a>    TOOL_BAR_EVENT<span class="op">,</span>             <span class="co">// Tool bar button</span></span>
<span id="cb134-18"><a aria-hidden="true" href="#cb134-18" tabindex="-1"></a>    ICONIFY_EVENT<span class="op">,</span>              <span class="co">// Window iconified</span></span>
<span id="cb134-19"><a aria-hidden="true" href="#cb134-19" tabindex="-1"></a>    DEICONIFY_EVENT<span class="op">,</span>            <span class="co">// Window restored</span></span>
<span id="cb134-20"><a aria-hidden="true" href="#cb134-20" tabindex="-1"></a>    DRAG_N_DROP_EVENT<span class="op">,</span>          <span class="co">// File drag and drop</span></span>
<span id="cb134-21"><a aria-hidden="true" href="#cb134-21" tabindex="-1"></a>    USER_SIGNAL_EVENT<span class="op">,</span>          <span class="co">// User-defined signal</span></span>
<span id="cb134-22"><a aria-hidden="true" href="#cb134-22" tabindex="-1"></a>    HELP_EVENT<span class="op">,</span>                 <span class="co">// Help request</span></span>
<span id="cb134-23"><a aria-hidden="true" href="#cb134-23" tabindex="-1"></a>    FOCUS_IN_EVENT<span class="op">,</span>             <span class="co">// Window gained focus</span></span>
<span id="cb134-24"><a aria-hidden="true" href="#cb134-24" tabindex="-1"></a>    FOCUS_OUT_EVENT<span class="op">,</span>            <span class="co">// Window lost focus</span></span>
<span id="cb134-25"><a aria-hidden="true" href="#cb134-25" tabindex="-1"></a>    MOVE_FRAME_EVENT<span class="op">,</span>           <span class="co">// Frame moved</span></span>
<span id="cb134-26"><a aria-hidden="true" href="#cb134-26" tabindex="-1"></a>    SELECT_WINDOW_EVENT<span class="op">,</span>        <span class="co">// Window selection</span></span>
<span id="cb134-27"><a aria-hidden="true" href="#cb134-27" tabindex="-1"></a>    SAVE_SESSION_EVENT<span class="op">,</span>         <span class="co">// Session save request</span></span>
<span id="cb134-28"><a aria-hidden="true" href="#cb134-28" tabindex="-1"></a>    <span class="co">// Platform-specific events...</span></span>
<span id="cb134-29"><a aria-hidden="true" href="#cb134-29" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<p><strong>Event Structure:</strong>
<code>src/termhooks.h:300+</code></p>
<div class="sourceCode" id="cb135"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb135-1"><a aria-hidden="true" href="#cb135-1" tabindex="-1"></a><span class="kw">struct</span> input_event</span>
<span id="cb135-2"><a aria-hidden="true" href="#cb135-2" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb135-3"><a aria-hidden="true" href="#cb135-3" tabindex="-1"></a>    <span class="kw">enum</span> event_kind kind<span class="op">;</span>        <span class="co">// Event type</span></span>
<span id="cb135-4"><a aria-hidden="true" href="#cb135-4" tabindex="-1"></a>    Lisp_Object code<span class="op">;</span>           <span class="co">// Character code or function key ID</span></span>
<span id="cb135-5"><a aria-hidden="true" href="#cb135-5" tabindex="-1"></a>    Lisp_Object frame_or_window<span class="op">;</span> <span class="co">// Where the event occurred</span></span>
<span id="cb135-6"><a aria-hidden="true" href="#cb135-6" tabindex="-1"></a>    Lisp_Object arg<span class="op">;</span>            <span class="co">// Event-specific argument</span></span>
<span id="cb135-7"><a aria-hidden="true" href="#cb135-7" tabindex="-1"></a>    <span class="dt">int</span> modifiers<span class="op">;</span>              <span class="co">// Modifier keys (shift, control, etc.)</span></span>
<span id="cb135-8"><a aria-hidden="true" href="#cb135-8" tabindex="-1"></a>    <span class="dt">int</span> x<span class="op">,</span> y<span class="op">;</span>                   <span class="co">// Mouse position (for mouse events)</span></span>
<span id="cb135-9"><a aria-hidden="true" href="#cb135-9" tabindex="-1"></a>    Time timestamp<span class="op">;</span>             <span class="co">// Event timestamp</span></span>
<span id="cb135-10"><a aria-hidden="true" href="#cb135-10" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<p><strong>Event Buffer:</strong>
<code>src/keyboard.h:381-383</code></p>
<div class="sourceCode" id="cb136"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb136-1"><a aria-hidden="true" href="#cb136-1" tabindex="-1"></a><span class="kw">enum</span> <span class="op">{</span> KBD_BUFFER_SIZE <span class="op">=</span> <span class="dv">4096</span> <span class="op">};</span></span>
<span id="cb136-2"><a aria-hidden="true" href="#cb136-2" tabindex="-1"></a></span>
<span id="cb136-3"><a aria-hidden="true" href="#cb136-3" tabindex="-1"></a><span class="kw">extern</span> <span class="kw">union</span> buffered_input_event kbd_buffer<span class="op">[</span>KBD_BUFFER_SIZE<span class="op">];</span></span>
<span id="cb136-4"><a aria-hidden="true" href="#cb136-4" tabindex="-1"></a><span class="kw">extern</span> <span class="kw">union</span> buffered_input_event <span class="op">*</span>kbd_fetch_ptr<span class="op">;</span></span>
<span id="cb136-5"><a aria-hidden="true" href="#cb136-5" tabindex="-1"></a><span class="kw">extern</span> <span class="kw">union</span> buffered_input_event <span class="op">*</span>kbd_store_ptr<span class="op">;</span></span></code></pre></div>
<p>The event buffer is a circular array. Terminal-specific code stores
events, and <code>read_char</code> fetches them.</p>
<h3 data-number="8.3.3" id="keymap-data-structures"><span class="header-section-number">8.3.3</span> 3. Keymap Data
Structures</h3>
<p>Emacs supports two keymap formats: <strong>sparse</strong> and
<strong>dense</strong> (full).</p>
<p><strong>Sparse Keymap Structure:</strong></p>
<div class="sourceCode" id="cb137"><pre class="sourceCode lisp"><code class="sourceCode commonlisp"><span id="cb137-1"><a aria-hidden="true" href="#cb137-1" tabindex="-1"></a>(keymap                              <span class="co">; Symbol marking keymap</span></span>
<span id="cb137-2"><a aria-hidden="true" href="#cb137-2" tabindex="-1"></a> <span class="st">"Menu name"</span>                         <span class="co">; Optional menu name string</span></span>
<span id="cb137-3"><a aria-hidden="true" href="#cb137-3" tabindex="-1"></a> (KEY . BINDING)                     <span class="co">; Individual bindings</span></span>
<span id="cb137-4"><a aria-hidden="true" href="#cb137-4" tabindex="-1"></a> (KEY . BINDING)</span>
<span id="cb137-5"><a aria-hidden="true" href="#cb137-5" tabindex="-1"></a> ...</span>
<span id="cb137-6"><a aria-hidden="true" href="#cb137-6" tabindex="-1"></a> PARENT-KEYMAP)                      <span class="co">; Optional parent</span></span></code></pre></div>
<p><strong>Dense Keymap Structure:</strong>
<code>src/keymap.c:93-108</code></p>
<div class="sourceCode" id="cb138"><pre class="sourceCode lisp"><code class="sourceCode commonlisp"><span id="cb138-1"><a aria-hidden="true" href="#cb138-1" tabindex="-1"></a>(keymap                              <span class="co">; Symbol marking keymap</span></span>
<span id="cb138-2"><a aria-hidden="true" href="#cb138-2" tabindex="-1"></a> CHAR-TABLE                          <span class="co">; Bindings for chars without modifiers</span></span>
<span id="cb138-3"><a aria-hidden="true" href="#cb138-3" tabindex="-1"></a> <span class="st">"Menu name"</span>                         <span class="co">; Optional menu name</span></span>
<span id="cb138-4"><a aria-hidden="true" href="#cb138-4" tabindex="-1"></a> (KEY . BINDING)                     <span class="co">; Additional bindings</span></span>
<span id="cb138-5"><a aria-hidden="true" href="#cb138-5" tabindex="-1"></a> ...</span>
<span id="cb138-6"><a aria-hidden="true" href="#cb138-6" tabindex="-1"></a> PARENT-KEYMAP)                      <span class="co">; Optional parent</span></span></code></pre></div>
<p><strong>Char-table</strong> (created by <code>make-keymap</code>):
Efficient storage for 256+ character bindings <strong>Alist</strong>
(created by <code>make-sparse-keymap</code>): For fewer bindings</p>
<p><strong>Key Binding Types:</strong></p>
<ol type="1">
<li><strong>Command</strong> - A function symbol or lambda</li>
<li><strong>Keymap</strong> - Prefix key (leads to more keys)</li>
<li><strong>String</strong> - Keyboard macro</li>
<li><strong>Vector</strong> - Key sequence to execute</li>
<li><strong>nil</strong> - Undefined</li>
<li><strong>Symbol</strong> - Indirect through symbol‚Äôs function
definition</li>
<li><strong>Cons <code>(STRING . DEFN)</code></strong> - Menu item with
string</li>
<li><strong>Menu item</strong> -
<code>(menu-item NAME BINDING . PROPERTIES)</code></li>
</ol>
<h3 data-number="8.3.4" id="keymap-hierarchy"><span class="header-section-number">8.3.4</span> 4. Keymap Hierarchy</h3>
<p>When looking up a key, Emacs searches multiple keymaps in order:</p>
<p><strong>From <code>read_key_sequence</code>:</strong>
<code>src/keyboard.c:10988-10993</code></p>
<div class="sourceCode" id="cb139"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb139-1"><a aria-hidden="true" href="#cb139-1" tabindex="-1"></a><span class="co">// Build active keymap list</span></span>
<span id="cb139-2"><a aria-hidden="true" href="#cb139-2" tabindex="-1"></a>current_binding <span class="op">=</span> active_maps <span class="op">(</span>first_event<span class="op">,</span> second_event<span class="op">);</span></span></code></pre></div>
<p><strong>Active Map Priority (highest to lowest):</strong></p>
<ol type="1">
<li><p><strong>Overriding maps</strong> (if non-nil):</p>
<ul>
<li><code>overriding-terminal-local-map</code> (KBOARD-specific)</li>
<li><code>overriding-local-map</code> (buffer-local override)</li>
</ul></li>
<li><p><strong>Character property maps</strong> (at point):</p>
<ul>
<li><code>keymap</code> property</li>
<li><code>local-map</code> property</li>
</ul></li>
<li><p><strong>Minor mode maps:</strong>
<code>minor-mode-overriding-map-alist</code>,
<code>minor-mode-map-alist</code></p></li>
<li><p><strong>Local map:</strong> <code>current-local-map</code> (major
mode map)</p></li>
<li><p><strong>Global map:</strong>
<code>current-global-map</code></p></li>
</ol>
<p><strong>Key Translation Maps</strong> (applied during reading): -
<code>input-decode-map</code> (terminal-specific, decode escape
sequences) - <code>local-function-key-map</code> (terminal-specific,
function keys) - <code>key-translation-map</code> (user
translations)</p>
<h2 data-number="8.4" id="event-loop-architecture"><span class="header-section-number">8.4</span> Event Loop Architecture</h2>
<h3 data-number="8.4.1" id="command-loop-hierarchy"><span class="header-section-number">8.4.1</span> Command Loop Hierarchy</h3>
<pre><code>main()
  ‚îî‚îÄ&gt; command_loop()
       ‚îú‚îÄ&gt; top_level_1()           // Run startup file
       ‚îî‚îÄ&gt; command_loop_2()        // Error handling wrapper
            ‚îî‚îÄ&gt; command_loop_1()    // Main loop
                 ‚îú‚îÄ&gt; read_key_sequence()
                 ‚îú‚îÄ&gt; command-execute
                 ‚îÇ    ‚îî‚îÄ&gt; call-interactively
                 ‚îú‚îÄ&gt; pre-command-hook
                 ‚îî‚îÄ&gt; post-command-hook</code></pre>
<h3 data-number="8.4.2" id="command_loop---top-level-entry"><span class="header-section-number">8.4.2</span> 1.
<code>command_loop()</code> - Top-Level Entry</h3>
<p><strong>Location:</strong> <code>src/keyboard.c:1113-1148</code></p>
<div class="sourceCode" id="cb141"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb141-1"><a aria-hidden="true" href="#cb141-1" tabindex="-1"></a>Lisp_Object</span>
<span id="cb141-2"><a aria-hidden="true" href="#cb141-2" tabindex="-1"></a>command_loop <span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb141-3"><a aria-hidden="true" href="#cb141-3" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb141-4"><a aria-hidden="true" href="#cb141-4" tabindex="-1"></a><span class="pp">#ifdef HAVE_STACK_OVERFLOW_HANDLING</span></span>
<span id="cb141-5"><a aria-hidden="true" href="#cb141-5" tabindex="-1"></a>    <span class="co">// Stack overflow recovery support</span></span>
<span id="cb141-6"><a aria-hidden="true" href="#cb141-6" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>sigsetjmp <span class="op">(</span>return_to_command_loop<span class="op">,</span> <span class="dv">1</span><span class="op">)</span> <span class="op">!=</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb141-7"><a aria-hidden="true" href="#cb141-7" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb141-8"><a aria-hidden="true" href="#cb141-8" tabindex="-1"></a>        <span class="co">// Recover from stack overflow</span></span>
<span id="cb141-9"><a aria-hidden="true" href="#cb141-9" tabindex="-1"></a>        init_eval <span class="op">();</span></span>
<span id="cb141-10"><a aria-hidden="true" href="#cb141-10" tabindex="-1"></a>        Vinternal__top_level_message <span class="op">=</span> recover_top_level_message<span class="op">;</span></span>
<span id="cb141-11"><a aria-hidden="true" href="#cb141-11" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb141-12"><a aria-hidden="true" href="#cb141-12" tabindex="-1"></a>    <span class="cf">else</span></span>
<span id="cb141-13"><a aria-hidden="true" href="#cb141-13" tabindex="-1"></a>        Vinternal__top_level_message <span class="op">=</span> regular_top_level_message<span class="op">;</span></span>
<span id="cb141-14"><a aria-hidden="true" href="#cb141-14" tabindex="-1"></a><span class="pp">#endif</span></span>
<span id="cb141-15"><a aria-hidden="true" href="#cb141-15" tabindex="-1"></a></span>
<span id="cb141-16"><a aria-hidden="true" href="#cb141-16" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>command_loop_level <span class="op">&gt;</span> <span class="dv">0</span> <span class="op">||</span> minibuf_level <span class="op">&gt;</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb141-17"><a aria-hidden="true" href="#cb141-17" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb141-18"><a aria-hidden="true" href="#cb141-18" tabindex="-1"></a>        <span class="co">// Recursive edit or minibuffer</span></span>
<span id="cb141-19"><a aria-hidden="true" href="#cb141-19" tabindex="-1"></a>        Lisp_Object val<span class="op">;</span></span>
<span id="cb141-20"><a aria-hidden="true" href="#cb141-20" tabindex="-1"></a>        val <span class="op">=</span> internal_catch <span class="op">(</span>Qexit<span class="op">,</span> command_loop_2<span class="op">,</span> Qerror<span class="op">);</span></span>
<span id="cb141-21"><a aria-hidden="true" href="#cb141-21" tabindex="-1"></a>        executing_kbd_macro <span class="op">=</span> Qnil<span class="op">;</span></span>
<span id="cb141-22"><a aria-hidden="true" href="#cb141-22" tabindex="-1"></a>        <span class="cf">return</span> val<span class="op">;</span></span>
<span id="cb141-23"><a aria-hidden="true" href="#cb141-23" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb141-24"><a aria-hidden="true" href="#cb141-24" tabindex="-1"></a>    <span class="cf">else</span></span>
<span id="cb141-25"><a aria-hidden="true" href="#cb141-25" tabindex="-1"></a>        <span class="co">// Top level - loop forever</span></span>
<span id="cb141-26"><a aria-hidden="true" href="#cb141-26" tabindex="-1"></a>        <span class="cf">while</span> <span class="op">(</span><span class="dv">1</span><span class="op">)</span></span>
<span id="cb141-27"><a aria-hidden="true" href="#cb141-27" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb141-28"><a aria-hidden="true" href="#cb141-28" tabindex="-1"></a>            internal_catch <span class="op">(</span>Qtop_level<span class="op">,</span> top_level_1<span class="op">,</span> Qnil<span class="op">);</span></span>
<span id="cb141-29"><a aria-hidden="true" href="#cb141-29" tabindex="-1"></a>            internal_catch <span class="op">(</span>Qtop_level<span class="op">,</span> command_loop_2<span class="op">,</span> Qerror<span class="op">);</span></span>
<span id="cb141-30"><a aria-hidden="true" href="#cb141-30" tabindex="-1"></a>            executing_kbd_macro <span class="op">=</span> Qnil<span class="op">;</span></span>
<span id="cb141-31"><a aria-hidden="true" href="#cb141-31" tabindex="-1"></a></span>
<span id="cb141-32"><a aria-hidden="true" href="#cb141-32" tabindex="-1"></a>            <span class="co">// Exit in batch mode on EOF</span></span>
<span id="cb141-33"><a aria-hidden="true" href="#cb141-33" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>noninteractive<span class="op">)</span></span>
<span id="cb141-34"><a aria-hidden="true" href="#cb141-34" tabindex="-1"></a>                Fkill_emacs <span class="op">(</span>Qt<span class="op">,</span> Qnil<span class="op">);</span></span>
<span id="cb141-35"><a aria-hidden="true" href="#cb141-35" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb141-36"><a aria-hidden="true" href="#cb141-36" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>Key Points:</strong> - Outermost catch point for
<code>(throw 'top-level)</code> - Handles recursive editing levels -
Recovers from stack overflow (on supported platforms) - Never returns in
interactive mode</p>
<h3 data-number="8.4.3" id="command_loop_1---main-command-loop"><span class="header-section-number">8.4.3</span> 2.
<code>command_loop_1()</code> - Main Command Loop</h3>
<p><strong>Location:</strong> <code>src/keyboard.c:1318-1700+</code></p>
<p>This is the heart of Emacs‚Äôs event processing.</p>
<div class="sourceCode" id="cb142"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb142-1"><a aria-hidden="true" href="#cb142-1" tabindex="-1"></a><span class="dt">static</span> Lisp_Object</span>
<span id="cb142-2"><a aria-hidden="true" href="#cb142-2" tabindex="-1"></a>command_loop_1 <span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb142-3"><a aria-hidden="true" href="#cb142-3" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb142-4"><a aria-hidden="true" href="#cb142-4" tabindex="-1"></a>    <span class="co">// Initialize command state</span></span>
<span id="cb142-5"><a aria-hidden="true" href="#cb142-5" tabindex="-1"></a>    kset_prefix_arg <span class="op">(</span>current_kboard<span class="op">,</span> Qnil<span class="op">);</span></span>
<span id="cb142-6"><a aria-hidden="true" href="#cb142-6" tabindex="-1"></a>    kset_last_prefix_arg <span class="op">(</span>current_kboard<span class="op">,</span> Qnil<span class="op">);</span></span>
<span id="cb142-7"><a aria-hidden="true" href="#cb142-7" tabindex="-1"></a>    Vdeactivate_mark <span class="op">=</span> Qnil<span class="op">;</span></span>
<span id="cb142-8"><a aria-hidden="true" href="#cb142-8" tabindex="-1"></a>    waiting_for_input <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb142-9"><a aria-hidden="true" href="#cb142-9" tabindex="-1"></a>    cancel_echoing <span class="op">();</span></span>
<span id="cb142-10"><a aria-hidden="true" href="#cb142-10" tabindex="-1"></a></span>
<span id="cb142-11"><a aria-hidden="true" href="#cb142-11" tabindex="-1"></a>    this_command_key_count <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb142-12"><a aria-hidden="true" href="#cb142-12" tabindex="-1"></a>    this_single_command_key_start <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb142-13"><a aria-hidden="true" href="#cb142-13" tabindex="-1"></a></span>
<span id="cb142-14"><a aria-hidden="true" href="#cb142-14" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>NILP <span class="op">(</span>Vmemory_full<span class="op">))</span></span>
<span id="cb142-15"><a aria-hidden="true" href="#cb142-15" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb142-16"><a aria-hidden="true" href="#cb142-16" tabindex="-1"></a>        <span class="co">// Run post-command-hook from previous command</span></span>
<span id="cb142-17"><a aria-hidden="true" href="#cb142-17" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(!</span>NILP <span class="op">(</span>Vpost_command_hook<span class="op">)</span> <span class="op">&amp;&amp;</span> <span class="op">!</span>NILP <span class="op">(</span>Vrun_hooks<span class="op">))</span></span>
<span id="cb142-18"><a aria-hidden="true" href="#cb142-18" tabindex="-1"></a>            safe_run_hooks_maybe_narrowed <span class="op">(</span>Qpost_command_hook<span class="op">,</span></span>
<span id="cb142-19"><a aria-hidden="true" href="#cb142-19" tabindex="-1"></a>                                          XWINDOW <span class="op">(</span>selected_window<span class="op">));</span></span>
<span id="cb142-20"><a aria-hidden="true" href="#cb142-20" tabindex="-1"></a></span>
<span id="cb142-21"><a aria-hidden="true" href="#cb142-21" tabindex="-1"></a>        <span class="co">// Resize echo area if needed</span></span>
<span id="cb142-22"><a aria-hidden="true" href="#cb142-22" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(!</span>NILP <span class="op">(</span>echo_area_buffer<span class="op">[</span><span class="dv">0</span><span class="op">]))</span></span>
<span id="cb142-23"><a aria-hidden="true" href="#cb142-23" tabindex="-1"></a>            resize_echo_area_exactly <span class="op">();</span></span>
<span id="cb142-24"><a aria-hidden="true" href="#cb142-24" tabindex="-1"></a></span>
<span id="cb142-25"><a aria-hidden="true" href="#cb142-25" tabindex="-1"></a>        <span class="co">// Process delayed warnings</span></span>
<span id="cb142-26"><a aria-hidden="true" href="#cb142-26" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(!</span>NILP <span class="op">(</span>Vdelayed_warnings_list<span class="op">))</span></span>
<span id="cb142-27"><a aria-hidden="true" href="#cb142-27" tabindex="-1"></a>            safe_run_hooks <span class="op">(</span>Qdelayed_warnings_hook<span class="op">);</span></span>
<span id="cb142-28"><a aria-hidden="true" href="#cb142-28" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb142-29"><a aria-hidden="true" href="#cb142-29" tabindex="-1"></a></span>
<span id="cb142-30"><a aria-hidden="true" href="#cb142-30" tabindex="-1"></a>    <span class="co">// Save last command</span></span>
<span id="cb142-31"><a aria-hidden="true" href="#cb142-31" tabindex="-1"></a>    kset_last_command <span class="op">(</span>current_kboard<span class="op">,</span> Vthis_command<span class="op">);</span></span>
<span id="cb142-32"><a aria-hidden="true" href="#cb142-32" tabindex="-1"></a>    kset_real_last_command <span class="op">(</span>current_kboard<span class="op">,</span> Vreal_this_command<span class="op">);</span></span>
<span id="cb142-33"><a aria-hidden="true" href="#cb142-33" tabindex="-1"></a></span>
<span id="cb142-34"><a aria-hidden="true" href="#cb142-34" tabindex="-1"></a>    <span class="cf">while</span> <span class="op">(</span><span class="kw">true</span><span class="op">)</span>  <span class="co">// Main command loop</span></span>
<span id="cb142-35"><a aria-hidden="true" href="#cb142-35" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb142-36"><a aria-hidden="true" href="#cb142-36" tabindex="-1"></a>        <span class="co">// Check frame is alive</span></span>
<span id="cb142-37"><a aria-hidden="true" href="#cb142-37" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(!</span> FRAME_LIVE_P <span class="op">(</span>XFRAME <span class="op">(</span>selected_frame<span class="op">)))</span></span>
<span id="cb142-38"><a aria-hidden="true" href="#cb142-38" tabindex="-1"></a>            Fkill_emacs <span class="op">(</span>Qnil<span class="op">,</span> Qnil<span class="op">);</span></span>
<span id="cb142-39"><a aria-hidden="true" href="#cb142-39" tabindex="-1"></a></span>
<span id="cb142-40"><a aria-hidden="true" href="#cb142-40" tabindex="-1"></a>        <span class="co">// Ensure current window's buffer is selected</span></span>
<span id="cb142-41"><a aria-hidden="true" href="#cb142-41" tabindex="-1"></a>        set_buffer_internal <span class="op">(</span>XBUFFER <span class="op">(</span>XWINDOW <span class="op">(</span>selected_window<span class="op">)-&gt;</span>contents<span class="op">));</span></span>
<span id="cb142-42"><a aria-hidden="true" href="#cb142-42" tabindex="-1"></a></span>
<span id="cb142-43"><a aria-hidden="true" href="#cb142-43" tabindex="-1"></a>        <span class="co">// Clear command-specific variables</span></span>
<span id="cb142-44"><a aria-hidden="true" href="#cb142-44" tabindex="-1"></a>        Vthis_command <span class="op">=</span> Qnil<span class="op">;</span></span>
<span id="cb142-45"><a aria-hidden="true" href="#cb142-45" tabindex="-1"></a>        Vreal_this_command <span class="op">=</span> Qnil<span class="op">;</span></span>
<span id="cb142-46"><a aria-hidden="true" href="#cb142-46" tabindex="-1"></a>        Vthis_original_command <span class="op">=</span> Qnil<span class="op">;</span></span>
<span id="cb142-47"><a aria-hidden="true" href="#cb142-47" tabindex="-1"></a></span>
<span id="cb142-48"><a aria-hidden="true" href="#cb142-48" tabindex="-1"></a>        <span class="co">// *** READ KEY SEQUENCE ***</span></span>
<span id="cb142-49"><a aria-hidden="true" href="#cb142-49" tabindex="-1"></a>        raw_keybuf_count <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb142-50"><a aria-hidden="true" href="#cb142-50" tabindex="-1"></a>        Lisp_Object keybuf<span class="op">[</span>READ_KEY_ELTS<span class="op">];</span></span>
<span id="cb142-51"><a aria-hidden="true" href="#cb142-51" tabindex="-1"></a>        <span class="dt">int</span> i <span class="op">=</span> read_key_sequence <span class="op">(</span>keybuf<span class="op">,</span> Qnil<span class="op">,</span> <span class="kw">false</span><span class="op">,</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb142-52"><a aria-hidden="true" href="#cb142-52" tabindex="-1"></a>                                   <span class="kw">true</span><span class="op">,</span> <span class="kw">false</span><span class="op">,</span> <span class="kw">false</span><span class="op">);</span></span>
<span id="cb142-53"><a aria-hidden="true" href="#cb142-53" tabindex="-1"></a></span>
<span id="cb142-54"><a aria-hidden="true" href="#cb142-54" tabindex="-1"></a>        <span class="co">// Handle special cases</span></span>
<span id="cb142-55"><a aria-hidden="true" href="#cb142-55" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>i <span class="op">==</span> <span class="dv">0</span><span class="op">)</span>    <span class="co">// EOF (only in keyboard macro)</span></span>
<span id="cb142-56"><a aria-hidden="true" href="#cb142-56" tabindex="-1"></a>            <span class="cf">return</span> Qnil<span class="op">;</span></span>
<span id="cb142-57"><a aria-hidden="true" href="#cb142-57" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>i <span class="op">==</span> <span class="op">-</span><span class="dv">1</span><span class="op">)</span>   <span class="co">// Rejected menu</span></span>
<span id="cb142-58"><a aria-hidden="true" href="#cb142-58" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb142-59"><a aria-hidden="true" href="#cb142-59" tabindex="-1"></a>            cancel_echoing <span class="op">();</span></span>
<span id="cb142-60"><a aria-hidden="true" href="#cb142-60" tabindex="-1"></a>            this_command_key_count <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb142-61"><a aria-hidden="true" href="#cb142-61" tabindex="-1"></a>            <span class="cf">goto</span> finalize<span class="op">;</span></span>
<span id="cb142-62"><a aria-hidden="true" href="#cb142-62" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb142-63"><a aria-hidden="true" href="#cb142-63" tabindex="-1"></a></span>
<span id="cb142-64"><a aria-hidden="true" href="#cb142-64" tabindex="-1"></a>        last_command_event <span class="op">=</span> keybuf<span class="op">[</span>i <span class="op">-</span> <span class="dv">1</span><span class="op">];</span></span>
<span id="cb142-65"><a aria-hidden="true" href="#cb142-65" tabindex="-1"></a></span>
<span id="cb142-66"><a aria-hidden="true" href="#cb142-66" tabindex="-1"></a>        <span class="co">// Get the command binding</span></span>
<span id="cb142-67"><a aria-hidden="true" href="#cb142-67" tabindex="-1"></a>        cmd <span class="op">=</span> read_key_sequence_cmd<span class="op">;</span></span>
<span id="cb142-68"><a aria-hidden="true" href="#cb142-68" tabindex="-1"></a></span>
<span id="cb142-69"><a aria-hidden="true" href="#cb142-69" tabindex="-1"></a>        <span class="co">// Apply command remapping</span></span>
<span id="cb142-70"><a aria-hidden="true" href="#cb142-70" tabindex="-1"></a>        Vthis_original_command <span class="op">=</span> cmd<span class="op">;</span></span>
<span id="cb142-71"><a aria-hidden="true" href="#cb142-71" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(!</span>NILP <span class="op">(</span>read_key_sequence_remapped<span class="op">))</span></span>
<span id="cb142-72"><a aria-hidden="true" href="#cb142-72" tabindex="-1"></a>            cmd <span class="op">=</span> read_key_sequence_remapped<span class="op">;</span></span>
<span id="cb142-73"><a aria-hidden="true" href="#cb142-73" tabindex="-1"></a></span>
<span id="cb142-74"><a aria-hidden="true" href="#cb142-74" tabindex="-1"></a>        <span class="co">// *** EXECUTE COMMAND ***</span></span>
<span id="cb142-75"><a aria-hidden="true" href="#cb142-75" tabindex="-1"></a>        Vthis_command <span class="op">=</span> cmd<span class="op">;</span></span>
<span id="cb142-76"><a aria-hidden="true" href="#cb142-76" tabindex="-1"></a>        Vreal_this_command <span class="op">=</span> cmd<span class="op">;</span></span>
<span id="cb142-77"><a aria-hidden="true" href="#cb142-77" tabindex="-1"></a></span>
<span id="cb142-78"><a aria-hidden="true" href="#cb142-78" tabindex="-1"></a>        <span class="co">// Run pre-command-hook</span></span>
<span id="cb142-79"><a aria-hidden="true" href="#cb142-79" tabindex="-1"></a>        safe_run_hooks_maybe_narrowed <span class="op">(</span>Qpre_command_hook<span class="op">,</span></span>
<span id="cb142-80"><a aria-hidden="true" href="#cb142-80" tabindex="-1"></a>                                      XWINDOW <span class="op">(</span>selected_window<span class="op">));</span></span>
<span id="cb142-81"><a aria-hidden="true" href="#cb142-81" tabindex="-1"></a></span>
<span id="cb142-82"><a aria-hidden="true" href="#cb142-82" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>NILP <span class="op">(</span>Vthis_command<span class="op">))</span></span>
<span id="cb142-83"><a aria-hidden="true" href="#cb142-83" tabindex="-1"></a>            call0 <span class="op">(</span>Qundefined<span class="op">);</span>  <span class="co">// Key undefined</span></span>
<span id="cb142-84"><a aria-hidden="true" href="#cb142-84" tabindex="-1"></a>        <span class="cf">else</span></span>
<span id="cb142-85"><a aria-hidden="true" href="#cb142-85" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb142-86"><a aria-hidden="true" href="#cb142-86" tabindex="-1"></a>            <span class="co">// Add undo boundary</span></span>
<span id="cb142-87"><a aria-hidden="true" href="#cb142-87" tabindex="-1"></a>            call0 <span class="op">(</span>Qundo_auto__add_boundary<span class="op">);</span></span>
<span id="cb142-88"><a aria-hidden="true" href="#cb142-88" tabindex="-1"></a></span>
<span id="cb142-89"><a aria-hidden="true" href="#cb142-89" tabindex="-1"></a>            <span class="co">// Execute the command</span></span>
<span id="cb142-90"><a aria-hidden="true" href="#cb142-90" tabindex="-1"></a>            calln <span class="op">(</span>Qcommand_execute<span class="op">,</span> Vthis_command<span class="op">);</span></span>
<span id="cb142-91"><a aria-hidden="true" href="#cb142-91" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb142-92"><a aria-hidden="true" href="#cb142-92" tabindex="-1"></a></span>
<span id="cb142-93"><a aria-hidden="true" href="#cb142-93" tabindex="-1"></a>        <span class="co">// Run post-command-hook</span></span>
<span id="cb142-94"><a aria-hidden="true" href="#cb142-94" tabindex="-1"></a>        safe_run_hooks_maybe_narrowed <span class="op">(</span>Qpost_command_hook<span class="op">,</span></span>
<span id="cb142-95"><a aria-hidden="true" href="#cb142-95" tabindex="-1"></a>                                      XWINDOW <span class="op">(</span>selected_window<span class="op">));</span></span>
<span id="cb142-96"><a aria-hidden="true" href="#cb142-96" tabindex="-1"></a></span>
<span id="cb142-97"><a aria-hidden="true" href="#cb142-97" tabindex="-1"></a>        <span class="co">// Update command history</span></span>
<span id="cb142-98"><a aria-hidden="true" href="#cb142-98" tabindex="-1"></a>        kset_last_command <span class="op">(</span>current_kboard<span class="op">,</span> Vthis_command<span class="op">);</span></span>
<span id="cb142-99"><a aria-hidden="true" href="#cb142-99" tabindex="-1"></a>        kset_real_last_command <span class="op">(</span>current_kboard<span class="op">,</span> Vreal_this_command<span class="op">);</span></span>
<span id="cb142-100"><a aria-hidden="true" href="#cb142-100" tabindex="-1"></a></span>
<span id="cb142-101"><a aria-hidden="true" href="#cb142-101" tabindex="-1"></a>        <span class="co">// Reset for next command</span></span>
<span id="cb142-102"><a aria-hidden="true" href="#cb142-102" tabindex="-1"></a>        this_command_key_count <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb142-103"><a aria-hidden="true" href="#cb142-103" tabindex="-1"></a>        this_single_command_key_start <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb142-104"><a aria-hidden="true" href="#cb142-104" tabindex="-1"></a></span>
<span id="cb142-105"><a aria-hidden="true" href="#cb142-105" tabindex="-1"></a>    finalize<span class="op">:</span></span>
<span id="cb142-106"><a aria-hidden="true" href="#cb142-106" tabindex="-1"></a>        <span class="co">// Handle auto-save, garbage collection, etc.</span></span>
<span id="cb142-107"><a aria-hidden="true" href="#cb142-107" tabindex="-1"></a>        <span class="op">...</span></span>
<span id="cb142-108"><a aria-hidden="true" href="#cb142-108" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb142-109"><a aria-hidden="true" href="#cb142-109" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>Command Loop Flow:</strong></p>
<ol type="1">
<li><strong>Post-processing from previous command</strong> - hooks, echo
area, warnings</li>
<li><strong>Read key sequence</strong> - Get user input via
<code>read_key_sequence()</code></li>
<li><strong>Command lookup</strong> - Find binding in active
keymaps</li>
<li><strong>Pre-command hook</strong> - User-defined pre-execution
code</li>
<li><strong>Command execution</strong> - Call
<code>command-execute</code> ‚Üí <code>call-interactively</code></li>
<li><strong>Post-command hook</strong> - User-defined post-execution
code</li>
<li><strong>Cleanup</strong> - Update state, handle auto-save, GC</li>
</ol>
<h3 data-number="8.4.4" id="recursive_edit_1---recursive-editing"><span class="header-section-number">8.4.4</span> 3.
<code>recursive_edit_1()</code> - Recursive Editing</h3>
<p><strong>Location:</strong> <code>src/keyboard.c:708-761</code></p>
<p>Recursive editing allows running a command loop within a command,
used by the debugger, <code>recursive-edit</code>, and some interactive
commands.</p>
<div class="sourceCode" id="cb143"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb143-1"><a aria-hidden="true" href="#cb143-1" tabindex="-1"></a>Lisp_Object</span>
<span id="cb143-2"><a aria-hidden="true" href="#cb143-2" tabindex="-1"></a>recursive_edit_1 <span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb143-3"><a aria-hidden="true" href="#cb143-3" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb143-4"><a aria-hidden="true" href="#cb143-4" tabindex="-1"></a>    specpdl_ref count <span class="op">=</span> SPECPDL_INDEX <span class="op">();</span></span>
<span id="cb143-5"><a aria-hidden="true" href="#cb143-5" tabindex="-1"></a>    Lisp_Object val<span class="op">;</span></span>
<span id="cb143-6"><a aria-hidden="true" href="#cb143-6" tabindex="-1"></a></span>
<span id="cb143-7"><a aria-hidden="true" href="#cb143-7" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>command_loop_level <span class="op">&gt;</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb143-8"><a aria-hidden="true" href="#cb143-8" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb143-9"><a aria-hidden="true" href="#cb143-9" tabindex="-1"></a>        <span class="co">// Bind standard streams</span></span>
<span id="cb143-10"><a aria-hidden="true" href="#cb143-10" tabindex="-1"></a>        specbind <span class="op">(</span>Qstandard_output<span class="op">,</span> Qt<span class="op">);</span></span>
<span id="cb143-11"><a aria-hidden="true" href="#cb143-11" tabindex="-1"></a>        specbind <span class="op">(</span>Qstandard_input<span class="op">,</span> Qt<span class="op">);</span></span>
<span id="cb143-12"><a aria-hidden="true" href="#cb143-12" tabindex="-1"></a>        specbind <span class="op">(</span>Qsymbols_with_pos_enabled<span class="op">,</span> Qnil<span class="op">);</span></span>
<span id="cb143-13"><a aria-hidden="true" href="#cb143-13" tabindex="-1"></a>        specbind <span class="op">(</span>Qprint_symbols_bare<span class="op">,</span> Qnil<span class="op">);</span></span>
<span id="cb143-14"><a aria-hidden="true" href="#cb143-14" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb143-15"><a aria-hidden="true" href="#cb143-15" tabindex="-1"></a></span>
<span id="cb143-16"><a aria-hidden="true" href="#cb143-16" tabindex="-1"></a>    <span class="co">// Allow redisplay in debugger</span></span>
<span id="cb143-17"><a aria-hidden="true" href="#cb143-17" tabindex="-1"></a>    specbind <span class="op">(</span>Qinhibit_redisplay<span class="op">,</span> Qnil<span class="op">);</span></span>
<span id="cb143-18"><a aria-hidden="true" href="#cb143-18" tabindex="-1"></a>    redisplaying_p <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb143-19"><a aria-hidden="true" href="#cb143-19" tabindex="-1"></a></span>
<span id="cb143-20"><a aria-hidden="true" href="#cb143-20" tabindex="-1"></a>    <span class="co">// Prevent undo boundaries in parent buffers</span></span>
<span id="cb143-21"><a aria-hidden="true" href="#cb143-21" tabindex="-1"></a>    specbind <span class="op">(</span>Qundo_auto__undoably_changed_buffers<span class="op">,</span> Qnil<span class="op">);</span></span>
<span id="cb143-22"><a aria-hidden="true" href="#cb143-22" tabindex="-1"></a></span>
<span id="cb143-23"><a aria-hidden="true" href="#cb143-23" tabindex="-1"></a>    <span class="co">// Run nested command loop</span></span>
<span id="cb143-24"><a aria-hidden="true" href="#cb143-24" tabindex="-1"></a>    val <span class="op">=</span> command_loop <span class="op">();</span></span>
<span id="cb143-25"><a aria-hidden="true" href="#cb143-25" tabindex="-1"></a></span>
<span id="cb143-26"><a aria-hidden="true" href="#cb143-26" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>EQ <span class="op">(</span>val<span class="op">,</span> Qt<span class="op">))</span></span>
<span id="cb143-27"><a aria-hidden="true" href="#cb143-27" tabindex="-1"></a>        quit <span class="op">();</span>  <span class="co">// User aborted</span></span>
<span id="cb143-28"><a aria-hidden="true" href="#cb143-28" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>STRINGP <span class="op">(</span>val<span class="op">))</span></span>
<span id="cb143-29"><a aria-hidden="true" href="#cb143-29" tabindex="-1"></a>        xsignal1 <span class="op">(</span>Qerror<span class="op">,</span> val<span class="op">);</span>  <span class="co">// Error message</span></span>
<span id="cb143-30"><a aria-hidden="true" href="#cb143-30" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>FUNCTIONP <span class="op">(</span>val<span class="op">))</span></span>
<span id="cb143-31"><a aria-hidden="true" href="#cb143-31" tabindex="-1"></a>        call0 <span class="op">(</span>val<span class="op">);</span>  <span class="co">// Callback function</span></span>
<span id="cb143-32"><a aria-hidden="true" href="#cb143-32" tabindex="-1"></a></span>
<span id="cb143-33"><a aria-hidden="true" href="#cb143-33" tabindex="-1"></a>    <span class="cf">return</span> unbind_to <span class="op">(</span>count<span class="op">,</span> Qnil<span class="op">);</span></span>
<span id="cb143-34"><a aria-hidden="true" href="#cb143-34" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>Exit values:</strong> - <code>nil</code> - Normal exit -
<code>t</code> - Abort (calls <code>quit()</code>) - String - Error
(signals error with message) - Function - Call function then return</p>
<h2 data-number="8.5" id="event-reading-and-processing"><span class="header-section-number">8.5</span> Event Reading and
Processing</h2>
<h3 data-number="8.5.1" id="read_char---single-event-reading"><span class="header-section-number">8.5.1</span> 1. <code>read_char()</code> -
Single Event Reading</h3>
<p><strong>Location:</strong> <code>src/keyboard.c:2534-3200+</code></p>
<p>This is the lowest-level function that reads a single input
event.</p>
<div class="sourceCode" id="cb144"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb144-1"><a aria-hidden="true" href="#cb144-1" tabindex="-1"></a>Lisp_Object</span>
<span id="cb144-2"><a aria-hidden="true" href="#cb144-2" tabindex="-1"></a>read_char <span class="op">(</span><span class="dt">int</span> commandflag<span class="op">,</span>          <span class="co">// Command vs non-command reading</span></span>
<span id="cb144-3"><a aria-hidden="true" href="#cb144-3" tabindex="-1"></a>           Lisp_Object map<span class="op">,</span>           <span class="co">// Keymap for help events</span></span>
<span id="cb144-4"><a aria-hidden="true" href="#cb144-4" tabindex="-1"></a>           Lisp_Object prev_event<span class="op">,</span>    <span class="co">// Previous event (for doubleclick)</span></span>
<span id="cb144-5"><a aria-hidden="true" href="#cb144-5" tabindex="-1"></a>           <span class="dt">bool</span> <span class="op">*</span>used_mouse_menu<span class="op">,</span>     <span class="co">// Output: was menu used?</span></span>
<span id="cb144-6"><a aria-hidden="true" href="#cb144-6" tabindex="-1"></a>           <span class="kw">struct</span> timespec <span class="op">*</span>end_time<span class="op">)</span> <span class="co">// Timeout</span></span>
<span id="cb144-7"><a aria-hidden="true" href="#cb144-7" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb144-8"><a aria-hidden="true" href="#cb144-8" tabindex="-1"></a>    Lisp_Object c<span class="op">;</span></span>
<span id="cb144-9"><a aria-hidden="true" href="#cb144-9" tabindex="-1"></a>    <span class="kw">struct</span> kboard <span class="op">*</span>orig_kboard <span class="op">=</span> current_kboard<span class="op">;</span></span>
<span id="cb144-10"><a aria-hidden="true" href="#cb144-10" tabindex="-1"></a></span>
<span id="cb144-11"><a aria-hidden="true" href="#cb144-11" tabindex="-1"></a> retry<span class="op">:</span></span>
<span id="cb144-12"><a aria-hidden="true" href="#cb144-12" tabindex="-1"></a></span>
<span id="cb144-13"><a aria-hidden="true" href="#cb144-13" tabindex="-1"></a>    <span class="co">// Check various event sources in priority order:</span></span>
<span id="cb144-14"><a aria-hidden="true" href="#cb144-14" tabindex="-1"></a></span>
<span id="cb144-15"><a aria-hidden="true" href="#cb144-15" tabindex="-1"></a>    <span class="co">// 1. Unread post-input-method events</span></span>
<span id="cb144-16"><a aria-hidden="true" href="#cb144-16" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>CONSP <span class="op">(</span>Vunread_post_input_method_events<span class="op">))</span></span>
<span id="cb144-17"><a aria-hidden="true" href="#cb144-17" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb144-18"><a aria-hidden="true" href="#cb144-18" tabindex="-1"></a>        c <span class="op">=</span> XCAR <span class="op">(</span>Vunread_post_input_method_events<span class="op">);</span></span>
<span id="cb144-19"><a aria-hidden="true" href="#cb144-19" tabindex="-1"></a>        Vunread_post_input_method_events <span class="op">=</span></span>
<span id="cb144-20"><a aria-hidden="true" href="#cb144-20" tabindex="-1"></a>            XCDR <span class="op">(</span>Vunread_post_input_method_events<span class="op">);</span></span>
<span id="cb144-21"><a aria-hidden="true" href="#cb144-21" tabindex="-1"></a>        reread <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb144-22"><a aria-hidden="true" href="#cb144-22" tabindex="-1"></a>        <span class="cf">goto</span> reread_first<span class="op">;</span></span>
<span id="cb144-23"><a aria-hidden="true" href="#cb144-23" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb144-24"><a aria-hidden="true" href="#cb144-24" tabindex="-1"></a></span>
<span id="cb144-25"><a aria-hidden="true" href="#cb144-25" tabindex="-1"></a>    <span class="co">// 2. Unread command events (highest priority for real input)</span></span>
<span id="cb144-26"><a aria-hidden="true" href="#cb144-26" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>CONSP <span class="op">(</span>Vunread_command_events<span class="op">))</span></span>
<span id="cb144-27"><a aria-hidden="true" href="#cb144-27" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb144-28"><a aria-hidden="true" href="#cb144-28" tabindex="-1"></a>        c <span class="op">=</span> XCAR <span class="op">(</span>Vunread_command_events<span class="op">);</span></span>
<span id="cb144-29"><a aria-hidden="true" href="#cb144-29" tabindex="-1"></a>        Vunread_command_events <span class="op">=</span> XCDR <span class="op">(</span>Vunread_command_events<span class="op">);</span></span>
<span id="cb144-30"><a aria-hidden="true" href="#cb144-30" tabindex="-1"></a></span>
<span id="cb144-31"><a aria-hidden="true" href="#cb144-31" tabindex="-1"></a>        <span class="co">// Handle special prefixes: (no-record . EVENT), (t . EVENT)</span></span>
<span id="cb144-32"><a aria-hidden="true" href="#cb144-32" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>CONSP <span class="op">(</span>c<span class="op">)</span> <span class="op">&amp;&amp;</span> EQ <span class="op">(</span>XCAR <span class="op">(</span>c<span class="op">),</span> Qno_record<span class="op">))</span></span>
<span id="cb144-33"><a aria-hidden="true" href="#cb144-33" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb144-34"><a aria-hidden="true" href="#cb144-34" tabindex="-1"></a>            c <span class="op">=</span> XCDR <span class="op">(</span>c<span class="op">);</span></span>
<span id="cb144-35"><a aria-hidden="true" href="#cb144-35" tabindex="-1"></a>            recorded <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb144-36"><a aria-hidden="true" href="#cb144-36" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb144-37"><a aria-hidden="true" href="#cb144-37" tabindex="-1"></a>        reread <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb144-38"><a aria-hidden="true" href="#cb144-38" tabindex="-1"></a>        <span class="cf">goto</span> reread_for_input_method<span class="op">;</span></span>
<span id="cb144-39"><a aria-hidden="true" href="#cb144-39" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb144-40"><a aria-hidden="true" href="#cb144-40" tabindex="-1"></a></span>
<span id="cb144-41"><a aria-hidden="true" href="#cb144-41" tabindex="-1"></a>    <span class="co">// 3. Input method events</span></span>
<span id="cb144-42"><a aria-hidden="true" href="#cb144-42" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>CONSP <span class="op">(</span>Vunread_input_method_events<span class="op">))</span></span>
<span id="cb144-43"><a aria-hidden="true" href="#cb144-43" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb144-44"><a aria-hidden="true" href="#cb144-44" tabindex="-1"></a>        c <span class="op">=</span> XCAR <span class="op">(</span>Vunread_input_method_events<span class="op">);</span></span>
<span id="cb144-45"><a aria-hidden="true" href="#cb144-45" tabindex="-1"></a>        Vunread_input_method_events <span class="op">=</span></span>
<span id="cb144-46"><a aria-hidden="true" href="#cb144-46" tabindex="-1"></a>            XCDR <span class="op">(</span>Vunread_input_method_events<span class="op">);</span></span>
<span id="cb144-47"><a aria-hidden="true" href="#cb144-47" tabindex="-1"></a>        reread <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb144-48"><a aria-hidden="true" href="#cb144-48" tabindex="-1"></a>        <span class="cf">goto</span> reread_for_input_method<span class="op">;</span></span>
<span id="cb144-49"><a aria-hidden="true" href="#cb144-49" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb144-50"><a aria-hidden="true" href="#cb144-50" tabindex="-1"></a></span>
<span id="cb144-51"><a aria-hidden="true" href="#cb144-51" tabindex="-1"></a>    <span class="co">// 4. Executing keyboard macro</span></span>
<span id="cb144-52"><a aria-hidden="true" href="#cb144-52" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(!</span>NILP <span class="op">(</span>Vexecuting_kbd_macro<span class="op">)</span> <span class="op">&amp;&amp;</span> <span class="op">!</span>at_end_of_macro_p <span class="op">())</span></span>
<span id="cb144-53"><a aria-hidden="true" href="#cb144-53" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb144-54"><a aria-hidden="true" href="#cb144-54" tabindex="-1"></a>        Vlast_event_frame <span class="op">=</span> internal_last_event_frame <span class="op">=</span> Qmacro<span class="op">;</span></span>
<span id="cb144-55"><a aria-hidden="true" href="#cb144-55" tabindex="-1"></a>        c <span class="op">=</span> Faref <span class="op">(</span>Vexecuting_kbd_macro<span class="op">,</span></span>
<span id="cb144-56"><a aria-hidden="true" href="#cb144-56" tabindex="-1"></a>                  make_int <span class="op">(</span>executing_kbd_macro_index<span class="op">));</span></span>
<span id="cb144-57"><a aria-hidden="true" href="#cb144-57" tabindex="-1"></a></span>
<span id="cb144-58"><a aria-hidden="true" href="#cb144-58" tabindex="-1"></a>        <span class="co">// Handle meta bit in string macros</span></span>
<span id="cb144-59"><a aria-hidden="true" href="#cb144-59" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>STRINGP <span class="op">(</span>Vexecuting_kbd_macro<span class="op">)</span></span>
<span id="cb144-60"><a aria-hidden="true" href="#cb144-60" tabindex="-1"></a>            <span class="op">&amp;&amp;</span> <span class="op">(</span>XFIXNAT <span class="op">(</span>c<span class="op">)</span> <span class="op">&amp;</span> <span class="bn">0x80</span><span class="op">)</span> <span class="op">&amp;&amp;</span> <span class="op">(</span>XFIXNAT <span class="op">(</span>c<span class="op">)</span> <span class="op">&lt;=</span> <span class="bn">0xff</span><span class="op">))</span></span>
<span id="cb144-61"><a aria-hidden="true" href="#cb144-61" tabindex="-1"></a>            XSETFASTINT <span class="op">(</span>c<span class="op">,</span> CHAR_META <span class="op">|</span> <span class="op">(</span>XFIXNAT <span class="op">(</span>c<span class="op">)</span> <span class="op">&amp;</span> <span class="op">~</span><span class="bn">0x80</span><span class="op">));</span></span>
<span id="cb144-62"><a aria-hidden="true" href="#cb144-62" tabindex="-1"></a></span>
<span id="cb144-63"><a aria-hidden="true" href="#cb144-63" tabindex="-1"></a>        executing_kbd_macro_index<span class="op">++;</span></span>
<span id="cb144-64"><a aria-hidden="true" href="#cb144-64" tabindex="-1"></a>        <span class="cf">goto</span> from_macro<span class="op">;</span></span>
<span id="cb144-65"><a aria-hidden="true" href="#cb144-65" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb144-66"><a aria-hidden="true" href="#cb144-66" tabindex="-1"></a></span>
<span id="cb144-67"><a aria-hidden="true" href="#cb144-67" tabindex="-1"></a>    <span class="co">// 5. Pending switch-frame event</span></span>
<span id="cb144-68"><a aria-hidden="true" href="#cb144-68" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(!</span>NILP <span class="op">(</span>unread_switch_frame<span class="op">))</span></span>
<span id="cb144-69"><a aria-hidden="true" href="#cb144-69" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb144-70"><a aria-hidden="true" href="#cb144-70" tabindex="-1"></a>        c <span class="op">=</span> unread_switch_frame<span class="op">;</span></span>
<span id="cb144-71"><a aria-hidden="true" href="#cb144-71" tabindex="-1"></a>        unread_switch_frame <span class="op">=</span> Qnil<span class="op">;</span></span>
<span id="cb144-72"><a aria-hidden="true" href="#cb144-72" tabindex="-1"></a>        <span class="cf">goto</span> reread_first<span class="op">;</span></span>
<span id="cb144-73"><a aria-hidden="true" href="#cb144-73" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb144-74"><a aria-hidden="true" href="#cb144-74" tabindex="-1"></a></span>
<span id="cb144-75"><a aria-hidden="true" href="#cb144-75" tabindex="-1"></a>    <span class="co">// 6. Redisplay if needed</span></span>
<span id="cb144-76"><a aria-hidden="true" href="#cb144-76" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>commandflag <span class="op">&gt;=</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb144-77"><a aria-hidden="true" href="#cb144-77" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb144-78"><a aria-hidden="true" href="#cb144-78" tabindex="-1"></a>        <span class="co">// Swallow non-user-visible events (X selections, etc.)</span></span>
<span id="cb144-79"><a aria-hidden="true" href="#cb144-79" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>input_pending <span class="op">||</span> detect_input_pending_run_timers <span class="op">(</span><span class="dv">0</span><span class="op">))</span></span>
<span id="cb144-80"><a aria-hidden="true" href="#cb144-80" tabindex="-1"></a>            swallow_events <span class="op">(</span><span class="kw">false</span><span class="op">);</span></span>
<span id="cb144-81"><a aria-hidden="true" href="#cb144-81" tabindex="-1"></a></span>
<span id="cb144-82"><a aria-hidden="true" href="#cb144-82" tabindex="-1"></a>        <span class="co">// Redisplay loop</span></span>
<span id="cb144-83"><a aria-hidden="true" href="#cb144-83" tabindex="-1"></a>        <span class="cf">while</span> <span class="op">(!(</span>input_pending <span class="op">&amp;&amp;</span> input_was_pending<span class="op">))</span></span>
<span id="cb144-84"><a aria-hidden="true" href="#cb144-84" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb144-85"><a aria-hidden="true" href="#cb144-85" tabindex="-1"></a>            input_was_pending <span class="op">=</span> input_pending<span class="op">;</span></span>
<span id="cb144-86"><a aria-hidden="true" href="#cb144-86" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>help_echo_showing_p <span class="op">&amp;&amp;</span></span>
<span id="cb144-87"><a aria-hidden="true" href="#cb144-87" tabindex="-1"></a>                <span class="op">!</span>BASE_EQ <span class="op">(</span>selected_window<span class="op">,</span> minibuf_window<span class="op">))</span></span>
<span id="cb144-88"><a aria-hidden="true" href="#cb144-88" tabindex="-1"></a>                redisplay_preserve_echo_area <span class="op">(</span><span class="dv">5</span><span class="op">);</span></span>
<span id="cb144-89"><a aria-hidden="true" href="#cb144-89" tabindex="-1"></a>            <span class="cf">else</span></span>
<span id="cb144-90"><a aria-hidden="true" href="#cb144-90" tabindex="-1"></a>                redisplay <span class="op">();</span></span>
<span id="cb144-91"><a aria-hidden="true" href="#cb144-91" tabindex="-1"></a></span>
<span id="cb144-92"><a aria-hidden="true" href="#cb144-92" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(!</span>input_pending<span class="op">)</span></span>
<span id="cb144-93"><a aria-hidden="true" href="#cb144-93" tabindex="-1"></a>                <span class="cf">break</span><span class="op">;</span></span>
<span id="cb144-94"><a aria-hidden="true" href="#cb144-94" tabindex="-1"></a>            swallow_events <span class="op">(</span><span class="kw">false</span><span class="op">);</span></span>
<span id="cb144-95"><a aria-hidden="true" href="#cb144-95" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb144-96"><a aria-hidden="true" href="#cb144-96" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb144-97"><a aria-hidden="true" href="#cb144-97" tabindex="-1"></a></span>
<span id="cb144-98"><a aria-hidden="true" href="#cb144-98" tabindex="-1"></a>    <span class="co">// 7. Read from actual input (keyboard, mouse, etc.)</span></span>
<span id="cb144-99"><a aria-hidden="true" href="#cb144-99" tabindex="-1"></a>    <span class="co">// This involves waiting for input if necessary</span></span>
<span id="cb144-100"><a aria-hidden="true" href="#cb144-100" tabindex="-1"></a></span>
<span id="cb144-101"><a aria-hidden="true" href="#cb144-101" tabindex="-1"></a>    <span class="co">/* ... complex input reading logic ... */</span></span>
<span id="cb144-102"><a aria-hidden="true" href="#cb144-102" tabindex="-1"></a></span>
<span id="cb144-103"><a aria-hidden="true" href="#cb144-103" tabindex="-1"></a>    <span class="co">// Try reading from current KBOARD</span></span>
<span id="cb144-104"><a aria-hidden="true" href="#cb144-104" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>KBOARD_HAS_INPUT <span class="op">(</span>current_kboard<span class="op">))</span></span>
<span id="cb144-105"><a aria-hidden="true" href="#cb144-105" tabindex="-1"></a>        c <span class="op">=</span> read_event_from_queue <span class="op">();</span></span>
<span id="cb144-106"><a aria-hidden="true" href="#cb144-106" tabindex="-1"></a></span>
<span id="cb144-107"><a aria-hidden="true" href="#cb144-107" tabindex="-1"></a>    <span class="co">// If no input on current KBOARD, try others or wait</span></span>
<span id="cb144-108"><a aria-hidden="true" href="#cb144-108" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>NILP <span class="op">(</span>c<span class="op">))</span></span>
<span id="cb144-109"><a aria-hidden="true" href="#cb144-109" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb144-110"><a aria-hidden="true" href="#cb144-110" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>commandflag <span class="op">&gt;=</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb144-111"><a aria-hidden="true" href="#cb144-111" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb144-112"><a aria-hidden="true" href="#cb144-112" tabindex="-1"></a>            <span class="co">// Wait for input with timeout</span></span>
<span id="cb144-113"><a aria-hidden="true" href="#cb144-113" tabindex="-1"></a>            c <span class="op">=</span> read_event_from_main_queue <span class="op">(</span>end_time<span class="op">,</span></span>
<span id="cb144-114"><a aria-hidden="true" href="#cb144-114" tabindex="-1"></a>                                           local_getcjmp<span class="op">,</span></span>
<span id="cb144-115"><a aria-hidden="true" href="#cb144-115" tabindex="-1"></a>                                           <span class="op">&amp;</span>used_mouse_menu<span class="op">);</span></span>
<span id="cb144-116"><a aria-hidden="true" href="#cb144-116" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb144-117"><a aria-hidden="true" href="#cb144-117" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb144-118"><a aria-hidden="true" href="#cb144-118" tabindex="-1"></a></span>
<span id="cb144-119"><a aria-hidden="true" href="#cb144-119" tabindex="-1"></a> reread_for_input_method<span class="op">:</span></span>
<span id="cb144-120"><a aria-hidden="true" href="#cb144-120" tabindex="-1"></a>    <span class="co">// Apply input method translation</span></span>
<span id="cb144-121"><a aria-hidden="true" href="#cb144-121" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(!</span>NILP <span class="op">(</span>Vinput_method_function<span class="op">)</span> <span class="op">&amp;&amp;</span> <span class="op">!</span>reread<span class="op">)</span></span>
<span id="cb144-122"><a aria-hidden="true" href="#cb144-122" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb144-123"><a aria-hidden="true" href="#cb144-123" tabindex="-1"></a>        c <span class="op">=</span> apply_input_method <span class="op">(</span>c<span class="op">);</span></span>
<span id="cb144-124"><a aria-hidden="true" href="#cb144-124" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb144-125"><a aria-hidden="true" href="#cb144-125" tabindex="-1"></a></span>
<span id="cb144-126"><a aria-hidden="true" href="#cb144-126" tabindex="-1"></a> reread_first<span class="op">:</span></span>
<span id="cb144-127"><a aria-hidden="true" href="#cb144-127" tabindex="-1"></a>    <span class="co">// Record in lossage</span></span>
<span id="cb144-128"><a aria-hidden="true" href="#cb144-128" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(!</span>recorded <span class="op">&amp;&amp;</span> <span class="op">!</span>CONSP <span class="op">(</span>c<span class="op">))</span></span>
<span id="cb144-129"><a aria-hidden="true" href="#cb144-129" tabindex="-1"></a>        record_char <span class="op">(</span>c<span class="op">);</span></span>
<span id="cb144-130"><a aria-hidden="true" href="#cb144-130" tabindex="-1"></a></span>
<span id="cb144-131"><a aria-hidden="true" href="#cb144-131" tabindex="-1"></a> from_macro<span class="op">:</span></span>
<span id="cb144-132"><a aria-hidden="true" href="#cb144-132" tabindex="-1"></a>    <span class="co">// Post-processing: help events, etc.</span></span>
<span id="cb144-133"><a aria-hidden="true" href="#cb144-133" tabindex="-1"></a></span>
<span id="cb144-134"><a aria-hidden="true" href="#cb144-134" tabindex="-1"></a>    <span class="cf">return</span> c<span class="op">;</span></span>
<span id="cb144-135"><a aria-hidden="true" href="#cb144-135" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>Event Source Priority:</strong> 1.
<code>unread-post-input-method-events</code> (after input method
processing) 2. <code>unread-command-events</code> (explicit unreading)
3. <code>unread-input-method-events</code> (before input method) 4.
Keyboard macro playback 5. Pending switch-frame 6. Actual hardware
input</p>
<p><strong>Key Features:</strong> - <strong>Handles multiple input
sources</strong> in defined priority order - <strong>Triggers
redisplay</strong> when appropriate - <strong>Applies input
methods</strong> for international character input - <strong>Records to
lossage</strong> for <code>view-lossage</code> command - <strong>Manages
KBOARD switching</strong> in multi-keyboard scenarios</p>
<h3 data-number="8.5.2" id="event-queue-management"><span class="header-section-number">8.5.2</span> 2. Event Queue
Management</h3>
<p><strong>Storing Events:</strong> <code>src/keyboard.c</code> (various
functions)</p>
<div class="sourceCode" id="cb145"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb145-1"><a aria-hidden="true" href="#cb145-1" tabindex="-1"></a><span class="dt">void</span></span>
<span id="cb145-2"><a aria-hidden="true" href="#cb145-2" tabindex="-1"></a>kbd_buffer_store_event <span class="op">(</span><span class="kw">struct</span> input_event <span class="op">*</span>event<span class="op">)</span></span>
<span id="cb145-3"><a aria-hidden="true" href="#cb145-3" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb145-4"><a aria-hidden="true" href="#cb145-4" tabindex="-1"></a>    <span class="co">// Store event in circular buffer</span></span>
<span id="cb145-5"><a aria-hidden="true" href="#cb145-5" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>kbd_store_ptr <span class="op">==</span> kbd_buffer <span class="op">+</span> KBD_BUFFER_SIZE<span class="op">)</span></span>
<span id="cb145-6"><a aria-hidden="true" href="#cb145-6" tabindex="-1"></a>        kbd_store_ptr <span class="op">=</span> kbd_buffer<span class="op">;</span></span>
<span id="cb145-7"><a aria-hidden="true" href="#cb145-7" tabindex="-1"></a></span>
<span id="cb145-8"><a aria-hidden="true" href="#cb145-8" tabindex="-1"></a>    <span class="co">// Copy event to buffer</span></span>
<span id="cb145-9"><a aria-hidden="true" href="#cb145-9" tabindex="-1"></a>    <span class="op">*</span>kbd_store_ptr <span class="op">=</span> <span class="op">*</span>event<span class="op">;</span></span>
<span id="cb145-10"><a aria-hidden="true" href="#cb145-10" tabindex="-1"></a></span>
<span id="cb145-11"><a aria-hidden="true" href="#cb145-11" tabindex="-1"></a>    <span class="co">// Advance store pointer</span></span>
<span id="cb145-12"><a aria-hidden="true" href="#cb145-12" tabindex="-1"></a>    <span class="op">++</span>kbd_store_ptr<span class="op">;</span></span>
<span id="cb145-13"><a aria-hidden="true" href="#cb145-13" tabindex="-1"></a></span>
<span id="cb145-14"><a aria-hidden="true" href="#cb145-14" tabindex="-1"></a>    <span class="co">// Set input_pending flag</span></span>
<span id="cb145-15"><a aria-hidden="true" href="#cb145-15" tabindex="-1"></a>    input_pending <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb145-16"><a aria-hidden="true" href="#cb145-16" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>Reading from Queue:</strong></p>
<div class="sourceCode" id="cb146"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb146-1"><a aria-hidden="true" href="#cb146-1" tabindex="-1"></a><span class="dt">static</span> Lisp_Object</span>
<span id="cb146-2"><a aria-hidden="true" href="#cb146-2" tabindex="-1"></a>read_event_from_queue <span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb146-3"><a aria-hidden="true" href="#cb146-3" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb146-4"><a aria-hidden="true" href="#cb146-4" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>kbd_fetch_ptr <span class="op">==</span> kbd_store_ptr<span class="op">)</span></span>
<span id="cb146-5"><a aria-hidden="true" href="#cb146-5" tabindex="-1"></a>        <span class="cf">return</span> Qnil<span class="op">;</span>  <span class="co">// Empty queue</span></span>
<span id="cb146-6"><a aria-hidden="true" href="#cb146-6" tabindex="-1"></a></span>
<span id="cb146-7"><a aria-hidden="true" href="#cb146-7" tabindex="-1"></a>    <span class="kw">struct</span> input_event <span class="op">*</span>event <span class="op">=</span> <span class="op">&amp;</span>kbd_fetch_ptr<span class="op">-&gt;</span>ie<span class="op">;</span></span>
<span id="cb146-8"><a aria-hidden="true" href="#cb146-8" tabindex="-1"></a></span>
<span id="cb146-9"><a aria-hidden="true" href="#cb146-9" tabindex="-1"></a>    <span class="co">// Advance fetch pointer</span></span>
<span id="cb146-10"><a aria-hidden="true" href="#cb146-10" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(++</span>kbd_fetch_ptr <span class="op">==</span> kbd_buffer <span class="op">+</span> KBD_BUFFER_SIZE<span class="op">)</span></span>
<span id="cb146-11"><a aria-hidden="true" href="#cb146-11" tabindex="-1"></a>        kbd_fetch_ptr <span class="op">=</span> kbd_buffer<span class="op">;</span></span>
<span id="cb146-12"><a aria-hidden="true" href="#cb146-12" tabindex="-1"></a></span>
<span id="cb146-13"><a aria-hidden="true" href="#cb146-13" tabindex="-1"></a>    <span class="co">// Convert to Lisp event</span></span>
<span id="cb146-14"><a aria-hidden="true" href="#cb146-14" tabindex="-1"></a>    <span class="cf">return</span> event_to_lisp <span class="op">(</span>event<span class="op">);</span></span>
<span id="cb146-15"><a aria-hidden="true" href="#cb146-15" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2 data-number="8.6" id="keymap-system"><span class="header-section-number">8.6</span> Keymap System</h2>
<h3 data-number="8.6.1" id="keymap-lookup-algorithm"><span class="header-section-number">8.6.1</span> 1. Keymap Lookup
Algorithm</h3>
<p><strong>Primary Function:</strong> <code>access_keymap_1()</code> -
<code>src/keymap.c:327-489</code></p>
<p>This function performs the core keymap lookup.</p>
<div class="sourceCode" id="cb147"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb147-1"><a aria-hidden="true" href="#cb147-1" tabindex="-1"></a>Lisp_Object</span>
<span id="cb147-2"><a aria-hidden="true" href="#cb147-2" tabindex="-1"></a>access_keymap_1 <span class="op">(</span>Lisp_Object map<span class="op">,</span></span>
<span id="cb147-3"><a aria-hidden="true" href="#cb147-3" tabindex="-1"></a>                 Lisp_Object idx<span class="op">,</span>        <span class="co">// Key to look up</span></span>
<span id="cb147-4"><a aria-hidden="true" href="#cb147-4" tabindex="-1"></a>                 <span class="dt">bool</span> t_ok<span class="op">,</span>              <span class="co">// Accept default binding?</span></span>
<span id="cb147-5"><a aria-hidden="true" href="#cb147-5" tabindex="-1"></a>                 <span class="dt">bool</span> noinherit<span class="op">,</span>         <span class="co">// Don't check parent?</span></span>
<span id="cb147-6"><a aria-hidden="true" href="#cb147-6" tabindex="-1"></a>                 <span class="dt">bool</span> autoload<span class="op">)</span>          <span class="co">// Autoload keymaps?</span></span>
<span id="cb147-7"><a aria-hidden="true" href="#cb147-7" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb147-8"><a aria-hidden="true" href="#cb147-8" tabindex="-1"></a>    <span class="co">// Normalize the key</span></span>
<span id="cb147-9"><a aria-hidden="true" href="#cb147-9" tabindex="-1"></a>    idx <span class="op">=</span> EVENT_HEAD <span class="op">(</span>idx<span class="op">);</span>  <span class="co">// Extract head from mouse events</span></span>
<span id="cb147-10"><a aria-hidden="true" href="#cb147-10" tabindex="-1"></a></span>
<span id="cb147-11"><a aria-hidden="true" href="#cb147-11" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>SYMBOLP <span class="op">(</span>idx<span class="op">))</span></span>
<span id="cb147-12"><a aria-hidden="true" href="#cb147-12" tabindex="-1"></a>        idx <span class="op">=</span> reorder_modifiers <span class="op">(</span>idx<span class="op">);</span>  <span class="co">// Canonical modifier order</span></span>
<span id="cb147-13"><a aria-hidden="true" href="#cb147-13" tabindex="-1"></a>    <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>FIXNUMP <span class="op">(</span>idx<span class="op">))</span></span>
<span id="cb147-14"><a aria-hidden="true" href="#cb147-14" tabindex="-1"></a>        <span class="co">// Mask to valid character range</span></span>
<span id="cb147-15"><a aria-hidden="true" href="#cb147-15" tabindex="-1"></a>        XSETFASTINT <span class="op">(</span>idx<span class="op">,</span> XFIXNUM <span class="op">(</span>idx<span class="op">)</span> <span class="op">&amp;</span> <span class="op">(</span>CHAR_META <span class="op">|</span> <span class="op">(</span>CHAR_META <span class="op">-</span> <span class="dv">1</span><span class="op">)));</span></span>
<span id="cb147-16"><a aria-hidden="true" href="#cb147-16" tabindex="-1"></a></span>
<span id="cb147-17"><a aria-hidden="true" href="#cb147-17" tabindex="-1"></a>    <span class="co">// *** META -&gt; ESC MAPPING ***</span></span>
<span id="cb147-18"><a aria-hidden="true" href="#cb147-18" tabindex="-1"></a>    <span class="co">// Handle meta modifier specially</span></span>
<span id="cb147-19"><a aria-hidden="true" href="#cb147-19" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>FIXNUMP <span class="op">(</span>idx<span class="op">)</span> <span class="op">&amp;&amp;</span> XFIXNAT <span class="op">(</span>idx<span class="op">)</span> <span class="op">&amp;</span> meta_modifier<span class="op">)</span></span>
<span id="cb147-20"><a aria-hidden="true" href="#cb147-20" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb147-21"><a aria-hidden="true" href="#cb147-21" tabindex="-1"></a>        <span class="co">// Look for meta-map (ESC prefix map)</span></span>
<span id="cb147-22"><a aria-hidden="true" href="#cb147-22" tabindex="-1"></a>        Lisp_Object event_meta_binding<span class="op">,</span> event_meta_map<span class="op">;</span></span>
<span id="cb147-23"><a aria-hidden="true" href="#cb147-23" tabindex="-1"></a></span>
<span id="cb147-24"><a aria-hidden="true" href="#cb147-24" tabindex="-1"></a>        event_meta_binding <span class="op">=</span> access_keymap_1 <span class="op">(</span>map<span class="op">,</span> meta_prefix_char<span class="op">,</span></span>
<span id="cb147-25"><a aria-hidden="true" href="#cb147-25" tabindex="-1"></a>                                             t_ok<span class="op">,</span> noinherit<span class="op">,</span> autoload<span class="op">);</span></span>
<span id="cb147-26"><a aria-hidden="true" href="#cb147-26" tabindex="-1"></a>        event_meta_map <span class="op">=</span> get_keymap <span class="op">(</span>event_meta_binding<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> autoload<span class="op">);</span></span>
<span id="cb147-27"><a aria-hidden="true" href="#cb147-27" tabindex="-1"></a></span>
<span id="cb147-28"><a aria-hidden="true" href="#cb147-28" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>CONSP <span class="op">(</span>event_meta_map<span class="op">))</span></span>
<span id="cb147-29"><a aria-hidden="true" href="#cb147-29" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb147-30"><a aria-hidden="true" href="#cb147-30" tabindex="-1"></a>            <span class="co">// Found meta-map, look up key without meta modifier</span></span>
<span id="cb147-31"><a aria-hidden="true" href="#cb147-31" tabindex="-1"></a>            map <span class="op">=</span> event_meta_map<span class="op">;</span></span>
<span id="cb147-32"><a aria-hidden="true" href="#cb147-32" tabindex="-1"></a>            idx <span class="op">=</span> make_fixnum <span class="op">(</span>XFIXNAT <span class="op">(</span>idx<span class="op">)</span> <span class="op">&amp;</span> <span class="op">~</span>meta_modifier<span class="op">);</span></span>
<span id="cb147-33"><a aria-hidden="true" href="#cb147-33" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb147-34"><a aria-hidden="true" href="#cb147-34" tabindex="-1"></a>        <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>t_ok<span class="op">)</span></span>
<span id="cb147-35"><a aria-hidden="true" href="#cb147-35" tabindex="-1"></a>            idx <span class="op">=</span> Qt<span class="op">;</span>  <span class="co">// Only accept default binding</span></span>
<span id="cb147-36"><a aria-hidden="true" href="#cb147-36" tabindex="-1"></a>        <span class="cf">else</span></span>
<span id="cb147-37"><a aria-hidden="true" href="#cb147-37" tabindex="-1"></a>            <span class="cf">return</span> NILP <span class="op">(</span>event_meta_binding<span class="op">)</span> <span class="op">?</span> Qnil <span class="op">:</span> Qunbound<span class="op">;</span></span>
<span id="cb147-38"><a aria-hidden="true" href="#cb147-38" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb147-39"><a aria-hidden="true" href="#cb147-39" tabindex="-1"></a></span>
<span id="cb147-40"><a aria-hidden="true" href="#cb147-40" tabindex="-1"></a>    <span class="co">// *** SEARCH KEYMAP CHAIN ***</span></span>
<span id="cb147-41"><a aria-hidden="true" href="#cb147-41" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb147-42"><a aria-hidden="true" href="#cb147-42" tabindex="-1"></a>        Lisp_Object tail<span class="op">;</span></span>
<span id="cb147-43"><a aria-hidden="true" href="#cb147-43" tabindex="-1"></a>        Lisp_Object t_binding <span class="op">=</span> Qunbound<span class="op">;</span>  <span class="co">// Default binding</span></span>
<span id="cb147-44"><a aria-hidden="true" href="#cb147-44" tabindex="-1"></a>        Lisp_Object retval <span class="op">=</span> Qunbound<span class="op">;</span></span>
<span id="cb147-45"><a aria-hidden="true" href="#cb147-45" tabindex="-1"></a>        Lisp_Object retval_tail <span class="op">=</span> Qnil<span class="op">;</span></span>
<span id="cb147-46"><a aria-hidden="true" href="#cb147-46" tabindex="-1"></a></span>
<span id="cb147-47"><a aria-hidden="true" href="#cb147-47" tabindex="-1"></a>        <span class="co">// Iterate through keymap structure</span></span>
<span id="cb147-48"><a aria-hidden="true" href="#cb147-48" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(</span>tail <span class="op">=</span> <span class="op">(</span>CONSP <span class="op">(</span>map<span class="op">)</span> <span class="op">&amp;&amp;</span> EQ <span class="op">(</span>Qkeymap<span class="op">,</span> XCAR <span class="op">(</span>map<span class="op">)))</span></span>
<span id="cb147-49"><a aria-hidden="true" href="#cb147-49" tabindex="-1"></a>                   <span class="op">?</span> XCDR <span class="op">(</span>map<span class="op">)</span> <span class="op">:</span> map<span class="op">;</span></span>
<span id="cb147-50"><a aria-hidden="true" href="#cb147-50" tabindex="-1"></a>             <span class="op">(</span>CONSP <span class="op">(</span>tail<span class="op">)</span> <span class="op">||</span></span>
<span id="cb147-51"><a aria-hidden="true" href="#cb147-51" tabindex="-1"></a>              <span class="op">(</span>tail <span class="op">=</span> get_keymap <span class="op">(</span>tail<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> autoload<span class="op">),</span> CONSP <span class="op">(</span>tail<span class="op">)));</span></span>
<span id="cb147-52"><a aria-hidden="true" href="#cb147-52" tabindex="-1"></a>             tail <span class="op">=</span> XCDR <span class="op">(</span>tail<span class="op">))</span></span>
<span id="cb147-53"><a aria-hidden="true" href="#cb147-53" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb147-54"><a aria-hidden="true" href="#cb147-54" tabindex="-1"></a>            Lisp_Object val <span class="op">=</span> Qunbound<span class="op">;</span></span>
<span id="cb147-55"><a aria-hidden="true" href="#cb147-55" tabindex="-1"></a>            Lisp_Object binding <span class="op">=</span> XCAR <span class="op">(</span>tail<span class="op">);</span></span>
<span id="cb147-56"><a aria-hidden="true" href="#cb147-56" tabindex="-1"></a>            Lisp_Object submap <span class="op">=</span> get_keymap <span class="op">(</span>binding<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> autoload<span class="op">);</span></span>
<span id="cb147-57"><a aria-hidden="true" href="#cb147-57" tabindex="-1"></a></span>
<span id="cb147-58"><a aria-hidden="true" href="#cb147-58" tabindex="-1"></a>            <span class="co">// Check for parent keymap marker</span></span>
<span id="cb147-59"><a aria-hidden="true" href="#cb147-59" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>EQ <span class="op">(</span>binding<span class="op">,</span> Qkeymap<span class="op">))</span></span>
<span id="cb147-60"><a aria-hidden="true" href="#cb147-60" tabindex="-1"></a>            <span class="op">{</span></span>
<span id="cb147-61"><a aria-hidden="true" href="#cb147-61" tabindex="-1"></a>                <span class="cf">if</span> <span class="op">(</span>noinherit <span class="op">||</span> NILP <span class="op">(</span>retval<span class="op">))</span></span>
<span id="cb147-62"><a aria-hidden="true" href="#cb147-62" tabindex="-1"></a>                    <span class="cf">break</span><span class="op">;</span>  <span class="co">// Stop here, rest is inherited</span></span>
<span id="cb147-63"><a aria-hidden="true" href="#cb147-63" tabindex="-1"></a></span>
<span id="cb147-64"><a aria-hidden="true" href="#cb147-64" tabindex="-1"></a>                <span class="co">// Merge with parent keymap</span></span>
<span id="cb147-65"><a aria-hidden="true" href="#cb147-65" tabindex="-1"></a>                <span class="cf">if</span> <span class="op">(!</span>BASE_EQ <span class="op">(</span>retval<span class="op">,</span> Qunbound<span class="op">))</span></span>
<span id="cb147-66"><a aria-hidden="true" href="#cb147-66" tabindex="-1"></a>                <span class="op">{</span></span>
<span id="cb147-67"><a aria-hidden="true" href="#cb147-67" tabindex="-1"></a>                    Lisp_Object parent_entry<span class="op">;</span></span>
<span id="cb147-68"><a aria-hidden="true" href="#cb147-68" tabindex="-1"></a>                    parent_entry <span class="op">=</span> get_keymap <span class="op">(</span></span>
<span id="cb147-69"><a aria-hidden="true" href="#cb147-69" tabindex="-1"></a>                        access_keymap_1 <span class="op">(</span>tail<span class="op">,</span> idx<span class="op">,</span> t_ok<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> autoload<span class="op">),</span></span>
<span id="cb147-70"><a aria-hidden="true" href="#cb147-70" tabindex="-1"></a>                        <span class="dv">0</span><span class="op">,</span> autoload<span class="op">);</span></span>
<span id="cb147-71"><a aria-hidden="true" href="#cb147-71" tabindex="-1"></a></span>
<span id="cb147-72"><a aria-hidden="true" href="#cb147-72" tabindex="-1"></a>                    <span class="cf">if</span> <span class="op">(</span>KEYMAPP <span class="op">(</span>parent_entry<span class="op">))</span></span>
<span id="cb147-73"><a aria-hidden="true" href="#cb147-73" tabindex="-1"></a>                    <span class="op">{</span></span>
<span id="cb147-74"><a aria-hidden="true" href="#cb147-74" tabindex="-1"></a>                        <span class="co">// Chain keymaps together</span></span>
<span id="cb147-75"><a aria-hidden="true" href="#cb147-75" tabindex="-1"></a>                        <span class="cf">if</span> <span class="op">(</span>CONSP <span class="op">(</span>retval_tail<span class="op">))</span></span>
<span id="cb147-76"><a aria-hidden="true" href="#cb147-76" tabindex="-1"></a>                            XSETCDR <span class="op">(</span>retval_tail<span class="op">,</span> parent_entry<span class="op">);</span></span>
<span id="cb147-77"><a aria-hidden="true" href="#cb147-77" tabindex="-1"></a>                        <span class="cf">else</span></span>
<span id="cb147-78"><a aria-hidden="true" href="#cb147-78" tabindex="-1"></a>                        <span class="op">{</span></span>
<span id="cb147-79"><a aria-hidden="true" href="#cb147-79" tabindex="-1"></a>                            retval_tail <span class="op">=</span> Fcons <span class="op">(</span>retval<span class="op">,</span> parent_entry<span class="op">);</span></span>
<span id="cb147-80"><a aria-hidden="true" href="#cb147-80" tabindex="-1"></a>                            retval <span class="op">=</span> Fcons <span class="op">(</span>Qkeymap<span class="op">,</span> retval_tail<span class="op">);</span></span>
<span id="cb147-81"><a aria-hidden="true" href="#cb147-81" tabindex="-1"></a>                        <span class="op">}</span></span>
<span id="cb147-82"><a aria-hidden="true" href="#cb147-82" tabindex="-1"></a>                    <span class="op">}</span></span>
<span id="cb147-83"><a aria-hidden="true" href="#cb147-83" tabindex="-1"></a>                    <span class="cf">break</span><span class="op">;</span></span>
<span id="cb147-84"><a aria-hidden="true" href="#cb147-84" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb147-85"><a aria-hidden="true" href="#cb147-85" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb147-86"><a aria-hidden="true" href="#cb147-86" tabindex="-1"></a>            <span class="co">// Recursively search sub-keymap</span></span>
<span id="cb147-87"><a aria-hidden="true" href="#cb147-87" tabindex="-1"></a>            <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>CONSP <span class="op">(</span>submap<span class="op">))</span></span>
<span id="cb147-88"><a aria-hidden="true" href="#cb147-88" tabindex="-1"></a>            <span class="op">{</span></span>
<span id="cb147-89"><a aria-hidden="true" href="#cb147-89" tabindex="-1"></a>                val <span class="op">=</span> access_keymap_1 <span class="op">(</span>submap<span class="op">,</span> idx<span class="op">,</span> t_ok<span class="op">,</span></span>
<span id="cb147-90"><a aria-hidden="true" href="#cb147-90" tabindex="-1"></a>                                      noinherit<span class="op">,</span> autoload<span class="op">);</span></span>
<span id="cb147-91"><a aria-hidden="true" href="#cb147-91" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb147-92"><a aria-hidden="true" href="#cb147-92" tabindex="-1"></a>            <span class="co">// Check alist entry: (KEY . BINDING)</span></span>
<span id="cb147-93"><a aria-hidden="true" href="#cb147-93" tabindex="-1"></a>            <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>CONSP <span class="op">(</span>binding<span class="op">))</span></span>
<span id="cb147-94"><a aria-hidden="true" href="#cb147-94" tabindex="-1"></a>            <span class="op">{</span></span>
<span id="cb147-95"><a aria-hidden="true" href="#cb147-95" tabindex="-1"></a>                Lisp_Object key <span class="op">=</span> XCAR <span class="op">(</span>binding<span class="op">);</span></span>
<span id="cb147-96"><a aria-hidden="true" href="#cb147-96" tabindex="-1"></a></span>
<span id="cb147-97"><a aria-hidden="true" href="#cb147-97" tabindex="-1"></a>                <span class="cf">if</span> <span class="op">(</span>EQ <span class="op">(</span>key<span class="op">,</span> idx<span class="op">))</span></span>
<span id="cb147-98"><a aria-hidden="true" href="#cb147-98" tabindex="-1"></a>                    val <span class="op">=</span> XCDR <span class="op">(</span>binding<span class="op">);</span></span>
<span id="cb147-99"><a aria-hidden="true" href="#cb147-99" tabindex="-1"></a>                <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>t_ok <span class="op">&amp;&amp;</span> EQ <span class="op">(</span>key<span class="op">,</span> Qt<span class="op">))</span></span>
<span id="cb147-100"><a aria-hidden="true" href="#cb147-100" tabindex="-1"></a>                <span class="op">{</span></span>
<span id="cb147-101"><a aria-hidden="true" href="#cb147-101" tabindex="-1"></a>                    t_binding <span class="op">=</span> XCDR <span class="op">(</span>binding<span class="op">);</span>  <span class="co">// Save default</span></span>
<span id="cb147-102"><a aria-hidden="true" href="#cb147-102" tabindex="-1"></a>                    t_ok <span class="op">=</span> <span class="dv">0</span><span class="op">;</span>  <span class="co">// Only use first default</span></span>
<span id="cb147-103"><a aria-hidden="true" href="#cb147-103" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb147-104"><a aria-hidden="true" href="#cb147-104" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb147-105"><a aria-hidden="true" href="#cb147-105" tabindex="-1"></a>            <span class="co">// Check vector entry (dense keymap)</span></span>
<span id="cb147-106"><a aria-hidden="true" href="#cb147-106" tabindex="-1"></a>            <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>VECTORP <span class="op">(</span>binding<span class="op">))</span></span>
<span id="cb147-107"><a aria-hidden="true" href="#cb147-107" tabindex="-1"></a>            <span class="op">{</span></span>
<span id="cb147-108"><a aria-hidden="true" href="#cb147-108" tabindex="-1"></a>                <span class="cf">if</span> <span class="op">(</span>FIXNUMP <span class="op">(</span>idx<span class="op">)</span> <span class="op">&amp;&amp;</span> XFIXNAT <span class="op">(</span>idx<span class="op">)</span> <span class="op">&lt;</span> ASIZE <span class="op">(</span>binding<span class="op">))</span></span>
<span id="cb147-109"><a aria-hidden="true" href="#cb147-109" tabindex="-1"></a>                    val <span class="op">=</span> AREF <span class="op">(</span>binding<span class="op">,</span> XFIXNAT <span class="op">(</span>idx<span class="op">));</span></span>
<span id="cb147-110"><a aria-hidden="true" href="#cb147-110" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb147-111"><a aria-hidden="true" href="#cb147-111" tabindex="-1"></a>            <span class="co">// Check char-table entry (full keymap)</span></span>
<span id="cb147-112"><a aria-hidden="true" href="#cb147-112" tabindex="-1"></a>            <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>CHAR_TABLE_P <span class="op">(</span>binding<span class="op">))</span></span>
<span id="cb147-113"><a aria-hidden="true" href="#cb147-113" tabindex="-1"></a>            <span class="op">{</span></span>
<span id="cb147-114"><a aria-hidden="true" href="#cb147-114" tabindex="-1"></a>                <span class="co">// Only characters without modifiers are in char-table</span></span>
<span id="cb147-115"><a aria-hidden="true" href="#cb147-115" tabindex="-1"></a>                <span class="cf">if</span> <span class="op">(</span>FIXNUMP <span class="op">(</span>idx<span class="op">)</span> <span class="op">&amp;&amp;</span></span>
<span id="cb147-116"><a aria-hidden="true" href="#cb147-116" tabindex="-1"></a>                    <span class="op">(</span>XFIXNAT <span class="op">(</span>idx<span class="op">)</span> <span class="op">&amp;</span> CHAR_MODIFIER_MASK<span class="op">)</span> <span class="op">==</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb147-117"><a aria-hidden="true" href="#cb147-117" tabindex="-1"></a>                <span class="op">{</span></span>
<span id="cb147-118"><a aria-hidden="true" href="#cb147-118" tabindex="-1"></a>                    val <span class="op">=</span> Faref <span class="op">(</span>binding<span class="op">,</span> idx<span class="op">);</span></span>
<span id="cb147-119"><a aria-hidden="true" href="#cb147-119" tabindex="-1"></a>                    <span class="co">// nil means explicitly unbound in char-tables</span></span>
<span id="cb147-120"><a aria-hidden="true" href="#cb147-120" tabindex="-1"></a>                    <span class="cf">if</span> <span class="op">(</span>NILP <span class="op">(</span>val<span class="op">))</span></span>
<span id="cb147-121"><a aria-hidden="true" href="#cb147-121" tabindex="-1"></a>                        val <span class="op">=</span> Qunbound<span class="op">;</span></span>
<span id="cb147-122"><a aria-hidden="true" href="#cb147-122" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb147-123"><a aria-hidden="true" href="#cb147-123" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb147-124"><a aria-hidden="true" href="#cb147-124" tabindex="-1"></a></span>
<span id="cb147-125"><a aria-hidden="true" href="#cb147-125" tabindex="-1"></a>            <span class="co">// Process found binding</span></span>
<span id="cb147-126"><a aria-hidden="true" href="#cb147-126" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(!</span>BASE_EQ <span class="op">(</span>val<span class="op">,</span> Qunbound<span class="op">))</span></span>
<span id="cb147-127"><a aria-hidden="true" href="#cb147-127" tabindex="-1"></a>            <span class="op">{</span></span>
<span id="cb147-128"><a aria-hidden="true" href="#cb147-128" tabindex="-1"></a>                <span class="co">// Qt binding shadows parent but is treated as nil</span></span>
<span id="cb147-129"><a aria-hidden="true" href="#cb147-129" tabindex="-1"></a>                <span class="cf">if</span> <span class="op">(</span>EQ <span class="op">(</span>val<span class="op">,</span> Qt<span class="op">))</span></span>
<span id="cb147-130"><a aria-hidden="true" href="#cb147-130" tabindex="-1"></a>                    val <span class="op">=</span> Qnil<span class="op">;</span></span>
<span id="cb147-131"><a aria-hidden="true" href="#cb147-131" tabindex="-1"></a></span>
<span id="cb147-132"><a aria-hidden="true" href="#cb147-132" tabindex="-1"></a>                <span class="co">// Trace indirect definitions, menu items</span></span>
<span id="cb147-133"><a aria-hidden="true" href="#cb147-133" tabindex="-1"></a>                val <span class="op">=</span> get_keyelt <span class="op">(</span>val<span class="op">,</span> autoload<span class="op">);</span></span>
<span id="cb147-134"><a aria-hidden="true" href="#cb147-134" tabindex="-1"></a></span>
<span id="cb147-135"><a aria-hidden="true" href="#cb147-135" tabindex="-1"></a>                <span class="cf">if</span> <span class="op">(!</span>KEYMAPP <span class="op">(</span>val<span class="op">))</span></span>
<span id="cb147-136"><a aria-hidden="true" href="#cb147-136" tabindex="-1"></a>                <span class="op">{</span></span>
<span id="cb147-137"><a aria-hidden="true" href="#cb147-137" tabindex="-1"></a>                    <span class="cf">if</span> <span class="op">(</span>NILP <span class="op">(</span>retval<span class="op">)</span> <span class="op">||</span> BASE_EQ <span class="op">(</span>retval<span class="op">,</span> Qunbound<span class="op">))</span></span>
<span id="cb147-138"><a aria-hidden="true" href="#cb147-138" tabindex="-1"></a>                        retval <span class="op">=</span> val<span class="op">;</span></span>
<span id="cb147-139"><a aria-hidden="true" href="#cb147-139" tabindex="-1"></a>                    <span class="cf">if</span> <span class="op">(!</span>NILP <span class="op">(</span>val<span class="op">))</span></span>
<span id="cb147-140"><a aria-hidden="true" href="#cb147-140" tabindex="-1"></a>                        <span class="cf">break</span><span class="op">;</span>  <span class="co">// Non-nil binding shadows everything</span></span>
<span id="cb147-141"><a aria-hidden="true" href="#cb147-141" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb147-142"><a aria-hidden="true" href="#cb147-142" tabindex="-1"></a>                <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>NILP <span class="op">(</span>retval<span class="op">)</span> <span class="op">||</span> BASE_EQ <span class="op">(</span>retval<span class="op">,</span> Qunbound<span class="op">))</span></span>
<span id="cb147-143"><a aria-hidden="true" href="#cb147-143" tabindex="-1"></a>                    retval <span class="op">=</span> val<span class="op">;</span></span>
<span id="cb147-144"><a aria-hidden="true" href="#cb147-144" tabindex="-1"></a>                <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>CONSP <span class="op">(</span>retval_tail<span class="op">))</span></span>
<span id="cb147-145"><a aria-hidden="true" href="#cb147-145" tabindex="-1"></a>                <span class="op">{</span></span>
<span id="cb147-146"><a aria-hidden="true" href="#cb147-146" tabindex="-1"></a>                    <span class="co">// Chain multiple keymap bindings</span></span>
<span id="cb147-147"><a aria-hidden="true" href="#cb147-147" tabindex="-1"></a>                    XSETCDR <span class="op">(</span>retval_tail<span class="op">,</span> list1 <span class="op">(</span>val<span class="op">));</span></span>
<span id="cb147-148"><a aria-hidden="true" href="#cb147-148" tabindex="-1"></a>                    retval_tail <span class="op">=</span> XCDR <span class="op">(</span>retval_tail<span class="op">);</span></span>
<span id="cb147-149"><a aria-hidden="true" href="#cb147-149" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb147-150"><a aria-hidden="true" href="#cb147-150" tabindex="-1"></a>                <span class="cf">else</span></span>
<span id="cb147-151"><a aria-hidden="true" href="#cb147-151" tabindex="-1"></a>                <span class="op">{</span></span>
<span id="cb147-152"><a aria-hidden="true" href="#cb147-152" tabindex="-1"></a>                    retval_tail <span class="op">=</span> list1 <span class="op">(</span>val<span class="op">);</span></span>
<span id="cb147-153"><a aria-hidden="true" href="#cb147-153" tabindex="-1"></a>                    retval <span class="op">=</span> Fcons <span class="op">(</span>Qkeymap<span class="op">,</span></span>
<span id="cb147-154"><a aria-hidden="true" href="#cb147-154" tabindex="-1"></a>                                   Fcons <span class="op">(</span>retval<span class="op">,</span> retval_tail<span class="op">));</span></span>
<span id="cb147-155"><a aria-hidden="true" href="#cb147-155" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb147-156"><a aria-hidden="true" href="#cb147-156" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb147-157"><a aria-hidden="true" href="#cb147-157" tabindex="-1"></a>            maybe_quit <span class="op">();</span>  <span class="co">// Allow C-g during long search</span></span>
<span id="cb147-158"><a aria-hidden="true" href="#cb147-158" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb147-159"><a aria-hidden="true" href="#cb147-159" tabindex="-1"></a></span>
<span id="cb147-160"><a aria-hidden="true" href="#cb147-160" tabindex="-1"></a>        <span class="co">// Return found binding or default</span></span>
<span id="cb147-161"><a aria-hidden="true" href="#cb147-161" tabindex="-1"></a>        <span class="cf">return</span> BASE_EQ <span class="op">(</span>Qunbound<span class="op">,</span> retval<span class="op">)</span></span>
<span id="cb147-162"><a aria-hidden="true" href="#cb147-162" tabindex="-1"></a>               <span class="op">?</span> get_keyelt <span class="op">(</span>t_binding<span class="op">,</span> autoload<span class="op">)</span> <span class="op">:</span> retval<span class="op">;</span></span>
<span id="cb147-163"><a aria-hidden="true" href="#cb147-163" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb147-164"><a aria-hidden="true" href="#cb147-164" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>Key Algorithm Steps:</strong></p>
<ol type="1">
<li><strong>Normalize key</strong> - Extract event head, reorder
modifiers</li>
<li><strong>Handle Meta mapping</strong> - Check for ESC-prefix
keymap</li>
<li><strong>Iterate keymap elements</strong> - Alist, vector,
char-table, sub-keymaps</li>
<li><strong>Process inheritance</strong> - Chain parent keymaps</li>
<li><strong>Return binding</strong> - First non-nil or default (Qt)</li>
</ol>
<p><strong>Lookup Precedence</strong> (within a single keymap): 1.
Explicit binding for the key 2. Sub-keymap bindings 3. Default binding
(key <code>t</code>) 4. Parent keymap</p>
<h3 data-number="8.6.2" id="key-lookup-through-keymap-hierarchy"><span class="header-section-number">8.6.2</span> 2. Key Lookup Through Keymap
Hierarchy</h3>
<p><strong>Function:</strong> <code>active_maps()</code> - Builds list
of active keymaps</p>
<p><strong>Lookup Process:</strong></p>
<pre><code>For each keymap in active-maps:
    binding = access_keymap (keymap, key)
    if binding is a command:
        return binding
    if binding is a keymap:
        mark as prefix, continue reading keys
    if binding is nil:
        continue to next keymap</code></pre>
<p><strong>Example Lookup for <code>C-x C-f</code>:</strong></p>
<pre><code>1. Read 'C-x':
   - Search active keymaps for C-x binding
   - Find: global-map[C-x] ‚Üí ctl-x-map (a keymap)
   - Mark as prefix, continue

2. Read 'C-f':
   - Search ctl-x-map for C-f binding
   - Find: ctl-x-map[C-f] ‚Üí find-file (a command)
   - Complete! Execute find-file</code></pre>
<h3 data-number="8.6.3" id="menu-item-handling"><span class="header-section-number">8.6.3</span> 3. Menu Item Handling</h3>
<p><strong>Function:</strong> <code>get_keyelt()</code> -
<code>src/keymap.c:679-750</code></p>
<p>Traces indirect definitions and handles menu items.</p>
<div class="sourceCode" id="cb150"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb150-1"><a aria-hidden="true" href="#cb150-1" tabindex="-1"></a><span class="dt">static</span> Lisp_Object</span>
<span id="cb150-2"><a aria-hidden="true" href="#cb150-2" tabindex="-1"></a>get_keyelt <span class="op">(</span>Lisp_Object object<span class="op">,</span> <span class="dt">bool</span> autoload<span class="op">)</span></span>
<span id="cb150-3"><a aria-hidden="true" href="#cb150-3" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb150-4"><a aria-hidden="true" href="#cb150-4" tabindex="-1"></a>    <span class="cf">while</span> <span class="op">(</span><span class="dv">1</span><span class="op">)</span></span>
<span id="cb150-5"><a aria-hidden="true" href="#cb150-5" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb150-6"><a aria-hidden="true" href="#cb150-6" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(!(</span>CONSP <span class="op">(</span>object<span class="op">)))</span></span>
<span id="cb150-7"><a aria-hidden="true" href="#cb150-7" tabindex="-1"></a>            <span class="cf">return</span> object<span class="op">;</span>  <span class="co">// This is the final value</span></span>
<span id="cb150-8"><a aria-hidden="true" href="#cb150-8" tabindex="-1"></a></span>
<span id="cb150-9"><a aria-hidden="true" href="#cb150-9" tabindex="-1"></a>        <span class="co">// Handle new-format menu items: (menu-item NAME BINDING ...)</span></span>
<span id="cb150-10"><a aria-hidden="true" href="#cb150-10" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>EQ <span class="op">(</span>XCAR <span class="op">(</span>object<span class="op">),</span> Qmenu_item<span class="op">))</span></span>
<span id="cb150-11"><a aria-hidden="true" href="#cb150-11" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb150-12"><a aria-hidden="true" href="#cb150-12" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>CONSP <span class="op">(</span>XCDR <span class="op">(</span>object<span class="op">)))</span></span>
<span id="cb150-13"><a aria-hidden="true" href="#cb150-13" tabindex="-1"></a>            <span class="op">{</span></span>
<span id="cb150-14"><a aria-hidden="true" href="#cb150-14" tabindex="-1"></a>                Lisp_Object tem<span class="op">;</span></span>
<span id="cb150-15"><a aria-hidden="true" href="#cb150-15" tabindex="-1"></a>                object <span class="op">=</span> XCDR <span class="op">(</span>XCDR <span class="op">(</span>object<span class="op">));</span>  <span class="co">// Skip name</span></span>
<span id="cb150-16"><a aria-hidden="true" href="#cb150-16" tabindex="-1"></a>                tem <span class="op">=</span> object<span class="op">;</span></span>
<span id="cb150-17"><a aria-hidden="true" href="#cb150-17" tabindex="-1"></a>                <span class="cf">if</span> <span class="op">(</span>CONSP <span class="op">(</span>object<span class="op">))</span></span>
<span id="cb150-18"><a aria-hidden="true" href="#cb150-18" tabindex="-1"></a>                    object <span class="op">=</span> XCAR <span class="op">(</span>object<span class="op">);</span>  <span class="co">// Get binding</span></span>
<span id="cb150-19"><a aria-hidden="true" href="#cb150-19" tabindex="-1"></a></span>
<span id="cb150-20"><a aria-hidden="true" href="#cb150-20" tabindex="-1"></a>                <span class="co">// Evaluate :filter property</span></span>
<span id="cb150-21"><a aria-hidden="true" href="#cb150-21" tabindex="-1"></a>                <span class="cf">if</span> <span class="op">(</span>CONSP <span class="op">(</span>tem<span class="op">)</span> <span class="op">&amp;&amp;</span> CONSP <span class="op">(</span>XCDR <span class="op">(</span>tem<span class="op">)))</span></span>
<span id="cb150-22"><a aria-hidden="true" href="#cb150-22" tabindex="-1"></a>                <span class="op">{</span></span>
<span id="cb150-23"><a aria-hidden="true" href="#cb150-23" tabindex="-1"></a>                    Lisp_Object filter <span class="op">=</span> Fplist_get <span class="op">(</span>XCDR <span class="op">(</span>tem<span class="op">),</span> QCfilter<span class="op">);</span></span>
<span id="cb150-24"><a aria-hidden="true" href="#cb150-24" tabindex="-1"></a>                    <span class="cf">if</span> <span class="op">(!</span>NILP <span class="op">(</span>filter<span class="op">))</span></span>
<span id="cb150-25"><a aria-hidden="true" href="#cb150-25" tabindex="-1"></a>                        object <span class="op">=</span> menu_item_eval_property <span class="op">(</span></span>
<span id="cb150-26"><a aria-hidden="true" href="#cb150-26" tabindex="-1"></a>                            list2 <span class="op">(</span>filter<span class="op">,</span> list2 <span class="op">(</span>Qquote<span class="op">,</span> object<span class="op">)));</span></span>
<span id="cb150-27"><a aria-hidden="true" href="#cb150-27" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb150-28"><a aria-hidden="true" href="#cb150-28" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb150-29"><a aria-hidden="true" href="#cb150-29" tabindex="-1"></a>            <span class="cf">else</span></span>
<span id="cb150-30"><a aria-hidden="true" href="#cb150-30" tabindex="-1"></a>                object <span class="op">=</span> Qnil<span class="op">;</span></span>
<span id="cb150-31"><a aria-hidden="true" href="#cb150-31" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb150-32"><a aria-hidden="true" href="#cb150-32" tabindex="-1"></a>        <span class="co">// Handle old-format menu items: (STRING . DEFN)</span></span>
<span id="cb150-33"><a aria-hidden="true" href="#cb150-33" tabindex="-1"></a>        <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>STRINGP <span class="op">(</span>XCAR <span class="op">(</span>object<span class="op">)))</span></span>
<span id="cb150-34"><a aria-hidden="true" href="#cb150-34" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb150-35"><a aria-hidden="true" href="#cb150-35" tabindex="-1"></a>            object <span class="op">=</span> XCDR <span class="op">(</span>object<span class="op">);</span></span>
<span id="cb150-36"><a aria-hidden="true" href="#cb150-36" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(!</span>CONSP <span class="op">(</span>object<span class="op">))</span></span>
<span id="cb150-37"><a aria-hidden="true" href="#cb150-37" tabindex="-1"></a>                object <span class="op">=</span> Qnil<span class="op">;</span></span>
<span id="cb150-38"><a aria-hidden="true" href="#cb150-38" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb150-39"><a aria-hidden="true" href="#cb150-39" tabindex="-1"></a>        <span class="co">// Handle keymap indirection: (KEYMAP . INDEX)</span></span>
<span id="cb150-40"><a aria-hidden="true" href="#cb150-40" tabindex="-1"></a>        <span class="cf">else</span> <span class="cf">if</span> <span class="op">(!</span>NILP <span class="op">(</span>object<span class="op">))</span></span>
<span id="cb150-41"><a aria-hidden="true" href="#cb150-41" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb150-42"><a aria-hidden="true" href="#cb150-42" tabindex="-1"></a>            Lisp_Object map <span class="op">=</span> get_keymap <span class="op">(</span>XCAR <span class="op">(</span>object<span class="op">),</span> <span class="dv">0</span><span class="op">,</span> autoload<span class="op">);</span></span>
<span id="cb150-43"><a aria-hidden="true" href="#cb150-43" tabindex="-1"></a>            Lisp_Object key <span class="op">=</span> XCDR <span class="op">(</span>object<span class="op">);</span></span>
<span id="cb150-44"><a aria-hidden="true" href="#cb150-44" tabindex="-1"></a></span>
<span id="cb150-45"><a aria-hidden="true" href="#cb150-45" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>CONSP <span class="op">(</span>map<span class="op">))</span></span>
<span id="cb150-46"><a aria-hidden="true" href="#cb150-46" tabindex="-1"></a>                object <span class="op">=</span> access_keymap <span class="op">(</span>map<span class="op">,</span> key<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> autoload<span class="op">);</span></span>
<span id="cb150-47"><a aria-hidden="true" href="#cb150-47" tabindex="-1"></a>            <span class="cf">else</span></span>
<span id="cb150-48"><a aria-hidden="true" href="#cb150-48" tabindex="-1"></a>                object <span class="op">=</span> Qnil<span class="op">;</span></span>
<span id="cb150-49"><a aria-hidden="true" href="#cb150-49" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb150-50"><a aria-hidden="true" href="#cb150-50" tabindex="-1"></a>        <span class="cf">else</span></span>
<span id="cb150-51"><a aria-hidden="true" href="#cb150-51" tabindex="-1"></a>            <span class="cf">return</span> Qnil<span class="op">;</span></span>
<span id="cb150-52"><a aria-hidden="true" href="#cb150-52" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb150-53"><a aria-hidden="true" href="#cb150-53" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>Menu Item Formats:</strong></p>
<p><strong>New format:</strong></p>
<div class="sourceCode" id="cb151"><pre class="sourceCode lisp"><code class="sourceCode commonlisp"><span id="cb151-1"><a aria-hidden="true" href="#cb151-1" tabindex="-1"></a>(menu-item <span class="st">"Find File"</span>      <span class="co">; Name shown in menu</span></span>
<span id="cb151-2"><a aria-hidden="true" href="#cb151-2" tabindex="-1"></a>           find-file        <span class="co">; Command to execute</span></span>
<span id="cb151-3"><a aria-hidden="true" href="#cb151-3" tabindex="-1"></a>           :help <span class="st">"Read a file into Emacs"</span></span>
<span id="cb151-4"><a aria-hidden="true" href="#cb151-4" tabindex="-1"></a>           :keys <span class="st">"C-x C-f"</span>  <span class="co">; Key equivalent</span></span>
<span id="cb151-5"><a aria-hidden="true" href="#cb151-5" tabindex="-1"></a>           :filter FUNCTION <span class="co">; Dynamic filtering</span></span>
<span id="cb151-6"><a aria-hidden="true" href="#cb151-6" tabindex="-1"></a>           :enable FORM)    <span class="co">; Enable condition</span></span></code></pre></div>
<p><strong>Old format:</strong></p>
<div class="sourceCode" id="cb152"><pre class="sourceCode lisp"><code class="sourceCode commonlisp"><span id="cb152-1"><a aria-hidden="true" href="#cb152-1" tabindex="-1"></a>(<span class="st">"Find File"</span> . find-file)   <span class="co">; Simple string + binding</span></span></code></pre></div>
<h2 data-number="8.7" id="key-sequence-reading"><span class="header-section-number">8.7</span> Key Sequence Reading</h2>
<h3 data-number="8.7.1" id="read_key_sequence---the-heart-of-key-reading"><span class="header-section-number">8.7.1</span>
<code>read_key_sequence()</code> - The Heart of Key Reading</h3>
<p><strong>Location:</strong> <code>src/keyboard.c:10841-12500+</code>
(massive 1600+ line function)</p>
<p>This function reads a complete key sequence, handling prefix keys,
function key translation, and command remapping.</p>
<p><strong>Signature:</strong></p>
<div class="sourceCode" id="cb153"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb153-1"><a aria-hidden="true" href="#cb153-1" tabindex="-1"></a><span class="dt">static</span> <span class="dt">int</span></span>
<span id="cb153-2"><a aria-hidden="true" href="#cb153-2" tabindex="-1"></a>read_key_sequence <span class="op">(</span>Lisp_Object <span class="op">*</span>keybuf<span class="op">,</span>      <span class="co">// Output buffer</span></span>
<span id="cb153-3"><a aria-hidden="true" href="#cb153-3" tabindex="-1"></a>                   Lisp_Object prompt<span class="op">,</span>       <span class="co">// Prompt string</span></span>
<span id="cb153-4"><a aria-hidden="true" href="#cb153-4" tabindex="-1"></a>                   <span class="dt">bool</span> dont_downcase_last<span class="op">,</span>  <span class="co">// Case sensitivity</span></span>
<span id="cb153-5"><a aria-hidden="true" href="#cb153-5" tabindex="-1"></a>                   <span class="dt">bool</span> can_return_switch_frame<span class="op">,</span></span>
<span id="cb153-6"><a aria-hidden="true" href="#cb153-6" tabindex="-1"></a>                   <span class="dt">bool</span> fix_current_buffer<span class="op">,</span></span>
<span id="cb153-7"><a aria-hidden="true" href="#cb153-7" tabindex="-1"></a>                   <span class="dt">bool</span> prevent_redisplay<span class="op">,</span></span>
<span id="cb153-8"><a aria-hidden="true" href="#cb153-8" tabindex="-1"></a>                   <span class="dt">bool</span> disable_text_conversion_p<span class="op">)</span></span></code></pre></div>
<p><strong>Key Data Structures:</strong></p>
<div class="sourceCode" id="cb154"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb154-1"><a aria-hidden="true" href="#cb154-1" tabindex="-1"></a><span class="co">// Current length of key sequence</span></span>
<span id="cb154-2"><a aria-hidden="true" href="#cb154-2" tabindex="-1"></a><span class="dt">int</span> t <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb154-3"><a aria-hidden="true" href="#cb154-3" tabindex="-1"></a></span>
<span id="cb154-4"><a aria-hidden="true" href="#cb154-4" tabindex="-1"></a><span class="co">// Mock input: replayed keys after function key translation</span></span>
<span id="cb154-5"><a aria-hidden="true" href="#cb154-5" tabindex="-1"></a><span class="dt">int</span> mock_input <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb154-6"><a aria-hidden="true" href="#cb154-6" tabindex="-1"></a></span>
<span id="cb154-7"><a aria-hidden="true" href="#cb154-7" tabindex="-1"></a><span class="co">// Translation state for three keymaps:</span></span>
<span id="cb154-8"><a aria-hidden="true" href="#cb154-8" tabindex="-1"></a>keyremap fkey<span class="op">;</span>      <span class="co">// local-function-key-map</span></span>
<span id="cb154-9"><a aria-hidden="true" href="#cb154-9" tabindex="-1"></a>keyremap keytran<span class="op">;</span>   <span class="co">// key-translation-map</span></span>
<span id="cb154-10"><a aria-hidden="true" href="#cb154-10" tabindex="-1"></a>keyremap indec<span class="op">;</span>     <span class="co">// input-decode-map</span></span>
<span id="cb154-11"><a aria-hidden="true" href="#cb154-11" tabindex="-1"></a></span>
<span id="cb154-12"><a aria-hidden="true" href="#cb154-12" tabindex="-1"></a><span class="co">// Delayed events</span></span>
<span id="cb154-13"><a aria-hidden="true" href="#cb154-13" tabindex="-1"></a>Lisp_Object delayed_switch_frame<span class="op">;</span></span></code></pre></div>
<p><strong>Translation Structure:</strong></p>
<div class="sourceCode" id="cb155"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb155-1"><a aria-hidden="true" href="#cb155-1" tabindex="-1"></a><span class="kw">struct</span> keyremap</span>
<span id="cb155-2"><a aria-hidden="true" href="#cb155-2" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb155-3"><a aria-hidden="true" href="#cb155-3" tabindex="-1"></a>    Lisp_Object parent<span class="op">;</span>   <span class="co">// Original translation map</span></span>
<span id="cb155-4"><a aria-hidden="true" href="#cb155-4" tabindex="-1"></a>    Lisp_Object map<span class="op">;</span>      <span class="co">// Current position in map</span></span>
<span id="cb155-5"><a aria-hidden="true" href="#cb155-5" tabindex="-1"></a>    <span class="dt">int</span> start<span class="op">;</span>            <span class="co">// Start of sequence being translated</span></span>
<span id="cb155-6"><a aria-hidden="true" href="#cb155-6" tabindex="-1"></a>    <span class="dt">int</span> end<span class="op">;</span>              <span class="co">// End of translated portion</span></span>
<span id="cb155-7"><a aria-hidden="true" href="#cb155-7" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<p><strong>Main Algorithm:</strong></p>
<div class="sourceCode" id="cb156"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb156-1"><a aria-hidden="true" href="#cb156-1" tabindex="-1"></a>read_key_sequence <span class="op">(</span>Lisp_Object <span class="op">*</span>keybuf<span class="op">,</span> <span class="op">...)</span></span>
<span id="cb156-2"><a aria-hidden="true" href="#cb156-2" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb156-3"><a aria-hidden="true" href="#cb156-3" tabindex="-1"></a>    <span class="dt">int</span> t <span class="op">=</span> <span class="dv">0</span><span class="op">;</span>  <span class="co">// Current position in keybuf</span></span>
<span id="cb156-4"><a aria-hidden="true" href="#cb156-4" tabindex="-1"></a>    <span class="dt">int</span> mock_input <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb156-5"><a aria-hidden="true" href="#cb156-5" tabindex="-1"></a></span>
<span id="cb156-6"><a aria-hidden="true" href="#cb156-6" tabindex="-1"></a>    keyremap indec<span class="op">,</span> fkey<span class="op">,</span> keytran<span class="op">;</span></span>
<span id="cb156-7"><a aria-hidden="true" href="#cb156-7" tabindex="-1"></a></span>
<span id="cb156-8"><a aria-hidden="true" href="#cb156-8" tabindex="-1"></a> replay_entire_sequence<span class="op">:</span></span>
<span id="cb156-9"><a aria-hidden="true" href="#cb156-9" tabindex="-1"></a>    <span class="co">// Initialize translation maps</span></span>
<span id="cb156-10"><a aria-hidden="true" href="#cb156-10" tabindex="-1"></a>    indec<span class="op">.</span>map <span class="op">=</span> indec<span class="op">.</span>parent <span class="op">=</span> KVAR <span class="op">(</span>current_kboard<span class="op">,</span> Vinput_decode_map<span class="op">);</span></span>
<span id="cb156-11"><a aria-hidden="true" href="#cb156-11" tabindex="-1"></a>    fkey<span class="op">.</span>map <span class="op">=</span> fkey<span class="op">.</span>parent <span class="op">=</span> KVAR <span class="op">(</span>current_kboard<span class="op">,</span> Vlocal_function_key_map<span class="op">);</span></span>
<span id="cb156-12"><a aria-hidden="true" href="#cb156-12" tabindex="-1"></a>    keytran<span class="op">.</span>map <span class="op">=</span> keytran<span class="op">.</span>parent <span class="op">=</span> Vkey_translation_map<span class="op">;</span></span>
<span id="cb156-13"><a aria-hidden="true" href="#cb156-13" tabindex="-1"></a></span>
<span id="cb156-14"><a aria-hidden="true" href="#cb156-14" tabindex="-1"></a>    indec<span class="op">.</span>start <span class="op">=</span> indec<span class="op">.</span>end <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb156-15"><a aria-hidden="true" href="#cb156-15" tabindex="-1"></a>    fkey<span class="op">.</span>start <span class="op">=</span> fkey<span class="op">.</span>end <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb156-16"><a aria-hidden="true" href="#cb156-16" tabindex="-1"></a>    keytran<span class="op">.</span>start <span class="op">=</span> keytran<span class="op">.</span>end <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb156-17"><a aria-hidden="true" href="#cb156-17" tabindex="-1"></a></span>
<span id="cb156-18"><a aria-hidden="true" href="#cb156-18" tabindex="-1"></a> replay_sequence<span class="op">:</span></span>
<span id="cb156-19"><a aria-hidden="true" href="#cb156-19" tabindex="-1"></a>    <span class="co">// Build active keymap list</span></span>
<span id="cb156-20"><a aria-hidden="true" href="#cb156-20" tabindex="-1"></a>    current_binding <span class="op">=</span> active_maps <span class="op">(</span>first_event<span class="op">,</span> second_event<span class="op">);</span></span>
<span id="cb156-21"><a aria-hidden="true" href="#cb156-21" tabindex="-1"></a></span>
<span id="cb156-22"><a aria-hidden="true" href="#cb156-22" tabindex="-1"></a>    t <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb156-23"><a aria-hidden="true" href="#cb156-23" tabindex="-1"></a>    first_unbound <span class="op">=</span> READ_KEY_ELTS <span class="op">+</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb156-24"><a aria-hidden="true" href="#cb156-24" tabindex="-1"></a></span>
<span id="cb156-25"><a aria-hidden="true" href="#cb156-25" tabindex="-1"></a>    <span class="co">// *** MAIN READING LOOP ***</span></span>
<span id="cb156-26"><a aria-hidden="true" href="#cb156-26" tabindex="-1"></a>    <span class="cf">while</span> <span class="op">(!</span>NILP <span class="op">(</span>current_binding<span class="op">)</span></span>
<span id="cb156-27"><a aria-hidden="true" href="#cb156-27" tabindex="-1"></a>           <span class="op">?</span> KEYMAPP <span class="op">(</span>current_binding<span class="op">)</span>  <span class="co">// Keep reading if prefix</span></span>
<span id="cb156-28"><a aria-hidden="true" href="#cb156-28" tabindex="-1"></a>           <span class="op">:</span> <span class="op">(</span>keytran<span class="op">.</span>start <span class="op">&lt;</span> t<span class="op">))</span>       <span class="co">// Or translating</span></span>
<span id="cb156-29"><a aria-hidden="true" href="#cb156-29" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb156-30"><a aria-hidden="true" href="#cb156-30" tabindex="-1"></a>        Lisp_Object key<span class="op">;</span></span>
<span id="cb156-31"><a aria-hidden="true" href="#cb156-31" tabindex="-1"></a>        <span class="dt">bool</span> used_mouse_menu <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb156-32"><a aria-hidden="true" href="#cb156-32" tabindex="-1"></a></span>
<span id="cb156-33"><a aria-hidden="true" href="#cb156-33" tabindex="-1"></a>        <span class="co">// Where the last real key started</span></span>
<span id="cb156-34"><a aria-hidden="true" href="#cb156-34" tabindex="-1"></a>        <span class="dt">int</span> last_real_key_start<span class="op">;</span></span>
<span id="cb156-35"><a aria-hidden="true" href="#cb156-35" tabindex="-1"></a></span>
<span id="cb156-36"><a aria-hidden="true" href="#cb156-36" tabindex="-1"></a>        <span class="co">// *** READ NEXT KEY ***</span></span>
<span id="cb156-37"><a aria-hidden="true" href="#cb156-37" tabindex="-1"></a></span>
<span id="cb156-38"><a aria-hidden="true" href="#cb156-38" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>t <span class="op">&lt;</span> mock_input<span class="op">)</span></span>
<span id="cb156-39"><a aria-hidden="true" href="#cb156-39" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb156-40"><a aria-hidden="true" href="#cb156-40" tabindex="-1"></a>            <span class="co">// Replaying translated keys</span></span>
<span id="cb156-41"><a aria-hidden="true" href="#cb156-41" tabindex="-1"></a>            key <span class="op">=</span> keybuf<span class="op">[</span>t<span class="op">];</span></span>
<span id="cb156-42"><a aria-hidden="true" href="#cb156-42" tabindex="-1"></a>            used_mouse_menu <span class="op">=</span> used_mouse_menu_history<span class="op">[</span>t<span class="op">];</span></span>
<span id="cb156-43"><a aria-hidden="true" href="#cb156-43" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb156-44"><a aria-hidden="true" href="#cb156-44" tabindex="-1"></a>        <span class="cf">else</span></span>
<span id="cb156-45"><a aria-hidden="true" href="#cb156-45" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb156-46"><a aria-hidden="true" href="#cb156-46" tabindex="-1"></a>            <span class="co">// Read actual input</span></span>
<span id="cb156-47"><a aria-hidden="true" href="#cb156-47" tabindex="-1"></a>            key <span class="op">=</span> read_char <span class="op">(</span>NILP <span class="op">(</span>prompt<span class="op">),</span></span>
<span id="cb156-48"><a aria-hidden="true" href="#cb156-48" tabindex="-1"></a>                           current_binding<span class="op">,</span></span>
<span id="cb156-49"><a aria-hidden="true" href="#cb156-49" tabindex="-1"></a>                           last_nonmenu_event<span class="op">,</span></span>
<span id="cb156-50"><a aria-hidden="true" href="#cb156-50" tabindex="-1"></a>                           <span class="op">&amp;</span>used_mouse_menu<span class="op">,</span></span>
<span id="cb156-51"><a aria-hidden="true" href="#cb156-51" tabindex="-1"></a>                           NULL<span class="op">);</span></span>
<span id="cb156-52"><a aria-hidden="true" href="#cb156-52" tabindex="-1"></a></span>
<span id="cb156-53"><a aria-hidden="true" href="#cb156-53" tabindex="-1"></a>            <span class="co">// Handle function keys, mouse events, help events...</span></span>
<span id="cb156-54"><a aria-hidden="true" href="#cb156-54" tabindex="-1"></a>            key <span class="op">=</span> process_special_events <span class="op">(</span>key<span class="op">,</span> <span class="op">...);</span></span>
<span id="cb156-55"><a aria-hidden="true" href="#cb156-55" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb156-56"><a aria-hidden="true" href="#cb156-56" tabindex="-1"></a></span>
<span id="cb156-57"><a aria-hidden="true" href="#cb156-57" tabindex="-1"></a>        <span class="co">// Add key to buffer</span></span>
<span id="cb156-58"><a aria-hidden="true" href="#cb156-58" tabindex="-1"></a>        keybuf<span class="op">[</span>t<span class="op">]</span> <span class="op">=</span> key<span class="op">;</span></span>
<span id="cb156-59"><a aria-hidden="true" href="#cb156-59" tabindex="-1"></a>        used_mouse_menu_history<span class="op">[</span>t<span class="op">]</span> <span class="op">=</span> used_mouse_menu<span class="op">;</span></span>
<span id="cb156-60"><a aria-hidden="true" href="#cb156-60" tabindex="-1"></a>        t<span class="op">++;</span></span>
<span id="cb156-61"><a aria-hidden="true" href="#cb156-61" tabindex="-1"></a></span>
<span id="cb156-62"><a aria-hidden="true" href="#cb156-62" tabindex="-1"></a>        <span class="co">// *** APPLY TRANSLATIONS ***</span></span>
<span id="cb156-63"><a aria-hidden="true" href="#cb156-63" tabindex="-1"></a></span>
<span id="cb156-64"><a aria-hidden="true" href="#cb156-64" tabindex="-1"></a>        <span class="co">// 1. Input decode map (terminal escape sequences)</span></span>
<span id="cb156-65"><a aria-hidden="true" href="#cb156-65" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>indec<span class="op">.</span>end <span class="op">&lt;</span> t<span class="op">)</span></span>
<span id="cb156-66"><a aria-hidden="true" href="#cb156-66" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb156-67"><a aria-hidden="true" href="#cb156-67" tabindex="-1"></a>            Lisp_Object translation<span class="op">;</span></span>
<span id="cb156-68"><a aria-hidden="true" href="#cb156-68" tabindex="-1"></a>            translation <span class="op">=</span> apply_keyremap <span class="op">(&amp;</span>indec<span class="op">,</span> keybuf<span class="op">,</span> t<span class="op">,</span> <span class="op">...);</span></span>
<span id="cb156-69"><a aria-hidden="true" href="#cb156-69" tabindex="-1"></a></span>
<span id="cb156-70"><a aria-hidden="true" href="#cb156-70" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(!</span>NILP <span class="op">(</span>translation<span class="op">))</span></span>
<span id="cb156-71"><a aria-hidden="true" href="#cb156-71" tabindex="-1"></a>            <span class="op">{</span></span>
<span id="cb156-72"><a aria-hidden="true" href="#cb156-72" tabindex="-1"></a>                <span class="co">// Replace sequence with translation</span></span>
<span id="cb156-73"><a aria-hidden="true" href="#cb156-73" tabindex="-1"></a>                mock_input <span class="op">=</span> translate_sequence <span class="op">(</span>keybuf<span class="op">,</span> <span class="op">&amp;</span>indec<span class="op">,</span></span>
<span id="cb156-74"><a aria-hidden="true" href="#cb156-74" tabindex="-1"></a>                                                translation<span class="op">);</span></span>
<span id="cb156-75"><a aria-hidden="true" href="#cb156-75" tabindex="-1"></a>                <span class="cf">goto</span> replay_sequence<span class="op">;</span></span>
<span id="cb156-76"><a aria-hidden="true" href="#cb156-76" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb156-77"><a aria-hidden="true" href="#cb156-77" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb156-78"><a aria-hidden="true" href="#cb156-78" tabindex="-1"></a></span>
<span id="cb156-79"><a aria-hidden="true" href="#cb156-79" tabindex="-1"></a>        <span class="co">// 2. Function key map (e.g., F1 ‚Üí help)</span></span>
<span id="cb156-80"><a aria-hidden="true" href="#cb156-80" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>fkey<span class="op">.</span>end <span class="op">&lt;</span> t<span class="op">)</span></span>
<span id="cb156-81"><a aria-hidden="true" href="#cb156-81" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb156-82"><a aria-hidden="true" href="#cb156-82" tabindex="-1"></a>            Lisp_Object translation<span class="op">;</span></span>
<span id="cb156-83"><a aria-hidden="true" href="#cb156-83" tabindex="-1"></a>            translation <span class="op">=</span> apply_keyremap <span class="op">(&amp;</span>fkey<span class="op">,</span> keybuf<span class="op">,</span> t<span class="op">,</span> <span class="op">...);</span></span>
<span id="cb156-84"><a aria-hidden="true" href="#cb156-84" tabindex="-1"></a></span>
<span id="cb156-85"><a aria-hidden="true" href="#cb156-85" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(!</span>NILP <span class="op">(</span>translation<span class="op">))</span></span>
<span id="cb156-86"><a aria-hidden="true" href="#cb156-86" tabindex="-1"></a>            <span class="op">{</span></span>
<span id="cb156-87"><a aria-hidden="true" href="#cb156-87" tabindex="-1"></a>                mock_input <span class="op">=</span> translate_sequence <span class="op">(</span>keybuf<span class="op">,</span> <span class="op">&amp;</span>fkey<span class="op">,</span></span>
<span id="cb156-88"><a aria-hidden="true" href="#cb156-88" tabindex="-1"></a>                                                translation<span class="op">);</span></span>
<span id="cb156-89"><a aria-hidden="true" href="#cb156-89" tabindex="-1"></a>                <span class="cf">goto</span> replay_sequence<span class="op">;</span></span>
<span id="cb156-90"><a aria-hidden="true" href="#cb156-90" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb156-91"><a aria-hidden="true" href="#cb156-91" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb156-92"><a aria-hidden="true" href="#cb156-92" tabindex="-1"></a></span>
<span id="cb156-93"><a aria-hidden="true" href="#cb156-93" tabindex="-1"></a>        <span class="co">// 3. Key translation map (user-defined)</span></span>
<span id="cb156-94"><a aria-hidden="true" href="#cb156-94" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>keytran<span class="op">.</span>end <span class="op">&lt;</span> t<span class="op">)</span></span>
<span id="cb156-95"><a aria-hidden="true" href="#cb156-95" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb156-96"><a aria-hidden="true" href="#cb156-96" tabindex="-1"></a>            Lisp_Object translation<span class="op">;</span></span>
<span id="cb156-97"><a aria-hidden="true" href="#cb156-97" tabindex="-1"></a>            translation <span class="op">=</span> apply_keyremap <span class="op">(&amp;</span>keytran<span class="op">,</span> keybuf<span class="op">,</span> t<span class="op">,</span> <span class="op">...);</span></span>
<span id="cb156-98"><a aria-hidden="true" href="#cb156-98" tabindex="-1"></a></span>
<span id="cb156-99"><a aria-hidden="true" href="#cb156-99" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(!</span>NILP <span class="op">(</span>translation<span class="op">))</span></span>
<span id="cb156-100"><a aria-hidden="true" href="#cb156-100" tabindex="-1"></a>            <span class="op">{</span></span>
<span id="cb156-101"><a aria-hidden="true" href="#cb156-101" tabindex="-1"></a>                mock_input <span class="op">=</span> translate_sequence <span class="op">(</span>keybuf<span class="op">,</span> <span class="op">&amp;</span>keytran<span class="op">,</span></span>
<span id="cb156-102"><a aria-hidden="true" href="#cb156-102" tabindex="-1"></a>                                                translation<span class="op">);</span></span>
<span id="cb156-103"><a aria-hidden="true" href="#cb156-103" tabindex="-1"></a>                <span class="cf">goto</span> replay_sequence<span class="op">;</span></span>
<span id="cb156-104"><a aria-hidden="true" href="#cb156-104" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb156-105"><a aria-hidden="true" href="#cb156-105" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb156-106"><a aria-hidden="true" href="#cb156-106" tabindex="-1"></a></span>
<span id="cb156-107"><a aria-hidden="true" href="#cb156-107" tabindex="-1"></a>        <span class="co">// *** LOOKUP IN KEYMAPS ***</span></span>
<span id="cb156-108"><a aria-hidden="true" href="#cb156-108" tabindex="-1"></a></span>
<span id="cb156-109"><a aria-hidden="true" href="#cb156-109" tabindex="-1"></a>        <span class="co">// Look up current sequence in active keymaps</span></span>
<span id="cb156-110"><a aria-hidden="true" href="#cb156-110" tabindex="-1"></a>        Lisp_Object new_binding<span class="op">;</span></span>
<span id="cb156-111"><a aria-hidden="true" href="#cb156-111" tabindex="-1"></a>        new_binding <span class="op">=</span> lookup_in_keymap_list <span class="op">(</span>current_binding<span class="op">,</span></span>
<span id="cb156-112"><a aria-hidden="true" href="#cb156-112" tabindex="-1"></a>                                            keybuf<span class="op">,</span> t<span class="op">,</span> <span class="op">...);</span></span>
<span id="cb156-113"><a aria-hidden="true" href="#cb156-113" tabindex="-1"></a></span>
<span id="cb156-114"><a aria-hidden="true" href="#cb156-114" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>NILP <span class="op">(</span>new_binding<span class="op">))</span></span>
<span id="cb156-115"><a aria-hidden="true" href="#cb156-115" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb156-116"><a aria-hidden="true" href="#cb156-116" tabindex="-1"></a>            <span class="co">// No binding found</span></span>
<span id="cb156-117"><a aria-hidden="true" href="#cb156-117" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>t <span class="op">&gt;</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb156-118"><a aria-hidden="true" href="#cb156-118" tabindex="-1"></a>            <span class="op">{</span></span>
<span id="cb156-119"><a aria-hidden="true" href="#cb156-119" tabindex="-1"></a>                <span class="co">// Try case conversion (e.g., C-X ‚Üí C-x)</span></span>
<span id="cb156-120"><a aria-hidden="true" href="#cb156-120" tabindex="-1"></a>                new_binding <span class="op">=</span> try_case_conversion <span class="op">(</span>keybuf<span class="op">,</span> t<span class="op">,</span> <span class="op">...);</span></span>
<span id="cb156-121"><a aria-hidden="true" href="#cb156-121" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb156-122"><a aria-hidden="true" href="#cb156-122" tabindex="-1"></a></span>
<span id="cb156-123"><a aria-hidden="true" href="#cb156-123" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>NILP <span class="op">(</span>new_binding<span class="op">))</span></span>
<span id="cb156-124"><a aria-hidden="true" href="#cb156-124" tabindex="-1"></a>            <span class="op">{</span></span>
<span id="cb156-125"><a aria-hidden="true" href="#cb156-125" tabindex="-1"></a>                <span class="co">// Truly unbound - sequence is complete</span></span>
<span id="cb156-126"><a aria-hidden="true" href="#cb156-126" tabindex="-1"></a>                current_binding <span class="op">=</span> Qnil<span class="op">;</span></span>
<span id="cb156-127"><a aria-hidden="true" href="#cb156-127" tabindex="-1"></a>                <span class="cf">break</span><span class="op">;</span></span>
<span id="cb156-128"><a aria-hidden="true" href="#cb156-128" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb156-129"><a aria-hidden="true" href="#cb156-129" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb156-130"><a aria-hidden="true" href="#cb156-130" tabindex="-1"></a></span>
<span id="cb156-131"><a aria-hidden="true" href="#cb156-131" tabindex="-1"></a>        current_binding <span class="op">=</span> new_binding<span class="op">;</span></span>
<span id="cb156-132"><a aria-hidden="true" href="#cb156-132" tabindex="-1"></a></span>
<span id="cb156-133"><a aria-hidden="true" href="#cb156-133" tabindex="-1"></a>        <span class="co">// *** CHECK FOR COMPLETION ***</span></span>
<span id="cb156-134"><a aria-hidden="true" href="#cb156-134" tabindex="-1"></a></span>
<span id="cb156-135"><a aria-hidden="true" href="#cb156-135" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(!</span>KEYMAPP <span class="op">(</span>current_binding<span class="op">))</span></span>
<span id="cb156-136"><a aria-hidden="true" href="#cb156-136" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb156-137"><a aria-hidden="true" href="#cb156-137" tabindex="-1"></a>            <span class="co">// Found a command - sequence complete!</span></span>
<span id="cb156-138"><a aria-hidden="true" href="#cb156-138" tabindex="-1"></a>            read_key_sequence_cmd <span class="op">=</span> current_binding<span class="op">;</span></span>
<span id="cb156-139"><a aria-hidden="true" href="#cb156-139" tabindex="-1"></a></span>
<span id="cb156-140"><a aria-hidden="true" href="#cb156-140" tabindex="-1"></a>            <span class="co">// Apply command remapping</span></span>
<span id="cb156-141"><a aria-hidden="true" href="#cb156-141" tabindex="-1"></a>            read_key_sequence_remapped <span class="op">=</span></span>
<span id="cb156-142"><a aria-hidden="true" href="#cb156-142" tabindex="-1"></a>                Fcommand_remapping <span class="op">(</span>current_binding<span class="op">,</span> Qnil<span class="op">,</span> Qnil<span class="op">);</span></span>
<span id="cb156-143"><a aria-hidden="true" href="#cb156-143" tabindex="-1"></a></span>
<span id="cb156-144"><a aria-hidden="true" href="#cb156-144" tabindex="-1"></a>            <span class="cf">break</span><span class="op">;</span></span>
<span id="cb156-145"><a aria-hidden="true" href="#cb156-145" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb156-146"><a aria-hidden="true" href="#cb156-146" tabindex="-1"></a></span>
<span id="cb156-147"><a aria-hidden="true" href="#cb156-147" tabindex="-1"></a>        <span class="co">// current_binding is a keymap - it's a prefix</span></span>
<span id="cb156-148"><a aria-hidden="true" href="#cb156-148" tabindex="-1"></a>        <span class="co">// Continue reading...</span></span>
<span id="cb156-149"><a aria-hidden="true" href="#cb156-149" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb156-150"><a aria-hidden="true" href="#cb156-150" tabindex="-1"></a></span>
<span id="cb156-151"><a aria-hidden="true" href="#cb156-151" tabindex="-1"></a>    <span class="co">// *** FINALIZATION ***</span></span>
<span id="cb156-152"><a aria-hidden="true" href="#cb156-152" tabindex="-1"></a></span>
<span id="cb156-153"><a aria-hidden="true" href="#cb156-153" tabindex="-1"></a>    <span class="co">// Update this_command_keys</span></span>
<span id="cb156-154"><a aria-hidden="true" href="#cb156-154" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span>i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> t<span class="op">;</span> i<span class="op">++)</span></span>
<span id="cb156-155"><a aria-hidden="true" href="#cb156-155" tabindex="-1"></a>        add_command_key <span class="op">(</span>keybuf<span class="op">[</span>i<span class="op">]);</span></span>
<span id="cb156-156"><a aria-hidden="true" href="#cb156-156" tabindex="-1"></a></span>
<span id="cb156-157"><a aria-hidden="true" href="#cb156-157" tabindex="-1"></a>    <span class="co">// Return number of keys read</span></span>
<span id="cb156-158"><a aria-hidden="true" href="#cb156-158" tabindex="-1"></a>    <span class="cf">return</span> t<span class="op">;</span></span>
<span id="cb156-159"><a aria-hidden="true" href="#cb156-159" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>Key Translation Process:</strong></p>
<p><strong>Example: <code>ESC [ A</code> ‚Üí
<code>&lt;up&gt;</code></strong></p>
<ol type="1">
<li>Read <code>ESC</code> - Look in input-decode-map, find prefix</li>
<li>Read <code>[</code> - Still a prefix in input-decode-map</li>
<li>Read <code>A</code> - Complete sequence <code>ESC [ A</code></li>
<li>Look up in input-decode-map: Found <code>&lt;up&gt;</code></li>
<li><strong>Replace sequence:</strong> keybuf[0] =
<code>&lt;up&gt;</code>, t = 1, mock_input = 1</li>
<li><strong>Replay:</strong> Look up <code>&lt;up&gt;</code> in active
keymaps</li>
<li>Find binding for <code>&lt;up&gt;</code> ‚Üí
<code>previous-line</code></li>
</ol>
<p><strong>Keymap Application Order:</strong></p>
<pre><code>input-decode-map        (terminal-specific, first)
   ‚Üì
local-function-key-map  (function keys)
   ‚Üì
key-translation-map     (user translations, last)
   ‚Üì
Active keymaps          (actual command lookup)</code></pre>
<h3 data-number="8.7.2" id="translation-map-functions"><span class="header-section-number">8.7.2</span> Translation Map
Functions</h3>
<p><strong>Applying a Translation:</strong></p>
<div class="sourceCode" id="cb158"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb158-1"><a aria-hidden="true" href="#cb158-1" tabindex="-1"></a><span class="dt">static</span> Lisp_Object</span>
<span id="cb158-2"><a aria-hidden="true" href="#cb158-2" tabindex="-1"></a>apply_keyremap <span class="op">(</span>keyremap <span class="op">*</span>map<span class="op">,</span></span>
<span id="cb158-3"><a aria-hidden="true" href="#cb158-3" tabindex="-1"></a>                Lisp_Object <span class="op">*</span>keybuf<span class="op">,</span></span>
<span id="cb158-4"><a aria-hidden="true" href="#cb158-4" tabindex="-1"></a>                <span class="dt">int</span> t<span class="op">,</span></span>
<span id="cb158-5"><a aria-hidden="true" href="#cb158-5" tabindex="-1"></a>                <span class="op">...)</span></span>
<span id="cb158-6"><a aria-hidden="true" href="#cb158-6" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb158-7"><a aria-hidden="true" href="#cb158-7" tabindex="-1"></a>    <span class="co">// Extend translation as far as possible</span></span>
<span id="cb158-8"><a aria-hidden="true" href="#cb158-8" tabindex="-1"></a>    <span class="cf">while</span> <span class="op">(</span>map<span class="op">-&gt;</span>end <span class="op">&lt;</span> t<span class="op">)</span></span>
<span id="cb158-9"><a aria-hidden="true" href="#cb158-9" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb158-10"><a aria-hidden="true" href="#cb158-10" tabindex="-1"></a>        Lisp_Object key <span class="op">=</span> keybuf<span class="op">[</span>map<span class="op">-&gt;</span>end<span class="op">];</span></span>
<span id="cb158-11"><a aria-hidden="true" href="#cb158-11" tabindex="-1"></a>        Lisp_Object binding<span class="op">;</span></span>
<span id="cb158-12"><a aria-hidden="true" href="#cb158-12" tabindex="-1"></a></span>
<span id="cb158-13"><a aria-hidden="true" href="#cb158-13" tabindex="-1"></a>        <span class="co">// Look up next key in translation map</span></span>
<span id="cb158-14"><a aria-hidden="true" href="#cb158-14" tabindex="-1"></a>        binding <span class="op">=</span> access_keymap <span class="op">(</span>map<span class="op">-&gt;</span>map<span class="op">,</span> key<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb158-15"><a aria-hidden="true" href="#cb158-15" tabindex="-1"></a></span>
<span id="cb158-16"><a aria-hidden="true" href="#cb158-16" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>NILP <span class="op">(</span>binding<span class="op">))</span></span>
<span id="cb158-17"><a aria-hidden="true" href="#cb158-17" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb158-18"><a aria-hidden="true" href="#cb158-18" tabindex="-1"></a>            <span class="co">// No translation for this sequence</span></span>
<span id="cb158-19"><a aria-hidden="true" href="#cb158-19" tabindex="-1"></a>            map<span class="op">-&gt;</span>end <span class="op">=</span> t<span class="op">;</span></span>
<span id="cb158-20"><a aria-hidden="true" href="#cb158-20" tabindex="-1"></a>            map<span class="op">-&gt;</span>map <span class="op">=</span> map<span class="op">-&gt;</span>parent<span class="op">;</span></span>
<span id="cb158-21"><a aria-hidden="true" href="#cb158-21" tabindex="-1"></a>            <span class="cf">return</span> Qnil<span class="op">;</span></span>
<span id="cb158-22"><a aria-hidden="true" href="#cb158-22" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb158-23"><a aria-hidden="true" href="#cb158-23" tabindex="-1"></a></span>
<span id="cb158-24"><a aria-hidden="true" href="#cb158-24" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(!</span>KEYMAPP <span class="op">(</span>binding<span class="op">))</span></span>
<span id="cb158-25"><a aria-hidden="true" href="#cb158-25" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb158-26"><a aria-hidden="true" href="#cb158-26" tabindex="-1"></a>            <span class="co">// Found complete translation</span></span>
<span id="cb158-27"><a aria-hidden="true" href="#cb158-27" tabindex="-1"></a>            <span class="cf">return</span> binding<span class="op">;</span></span>
<span id="cb158-28"><a aria-hidden="true" href="#cb158-28" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb158-29"><a aria-hidden="true" href="#cb158-29" tabindex="-1"></a></span>
<span id="cb158-30"><a aria-hidden="true" href="#cb158-30" tabindex="-1"></a>        <span class="co">// binding is a keymap - continue</span></span>
<span id="cb158-31"><a aria-hidden="true" href="#cb158-31" tabindex="-1"></a>        map<span class="op">-&gt;</span>map <span class="op">=</span> binding<span class="op">;</span></span>
<span id="cb158-32"><a aria-hidden="true" href="#cb158-32" tabindex="-1"></a>        map<span class="op">-&gt;</span>end<span class="op">++;</span></span>
<span id="cb158-33"><a aria-hidden="true" href="#cb158-33" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb158-34"><a aria-hidden="true" href="#cb158-34" tabindex="-1"></a></span>
<span id="cb158-35"><a aria-hidden="true" href="#cb158-35" tabindex="-1"></a>    <span class="cf">return</span> Qnil<span class="op">;</span></span>
<span id="cb158-36"><a aria-hidden="true" href="#cb158-36" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2 data-number="8.8" id="command-execution"><span class="header-section-number">8.8</span> Command Execution</h2>
<h3 data-number="8.8.1" id="call-interactively---interactive-command-execution"><span class="header-section-number">8.8.1</span>
<code>call-interactively</code> - Interactive Command Execution</h3>
<p><strong>Location:</strong> <code>src/callint.c:253-900+</code></p>
<p>This function executes commands with arguments gathered according to
their <code>interactive</code> spec.</p>
<div class="sourceCode" id="cb159"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb159-1"><a aria-hidden="true" href="#cb159-1" tabindex="-1"></a>DEFUN <span class="op">(</span><span class="st">"call-interactively"</span><span class="op">,</span> Fcall_interactively<span class="op">,</span> Scall_interactively<span class="op">,</span></span>
<span id="cb159-2"><a aria-hidden="true" href="#cb159-2" tabindex="-1"></a>       <span class="dv">1</span><span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb159-3"><a aria-hidden="true" href="#cb159-3" tabindex="-1"></a>       doc<span class="op">:</span> <span class="co">/* Call FUNCTION, providing args according to its interactive</span></span>
<span id="cb159-4"><a aria-hidden="true" href="#cb159-4" tabindex="-1"></a><span class="co">calling specs... */</span><span class="op">)</span></span>
<span id="cb159-5"><a aria-hidden="true" href="#cb159-5" tabindex="-1"></a>  <span class="op">(</span>Lisp_Object function<span class="op">,</span> Lisp_Object record_flag<span class="op">,</span> Lisp_Object keys<span class="op">)</span></span>
<span id="cb159-6"><a aria-hidden="true" href="#cb159-6" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb159-7"><a aria-hidden="true" href="#cb159-7" tabindex="-1"></a>    specpdl_ref speccount <span class="op">=</span> SPECPDL_INDEX <span class="op">();</span></span>
<span id="cb159-8"><a aria-hidden="true" href="#cb159-8" tabindex="-1"></a></span>
<span id="cb159-9"><a aria-hidden="true" href="#cb159-9" tabindex="-1"></a>    Lisp_Object prefix_arg <span class="op">=</span> Vcurrent_prefix_arg<span class="op">;</span></span>
<span id="cb159-10"><a aria-hidden="true" href="#cb159-10" tabindex="-1"></a>    Lisp_Object enable <span class="op">=</span> Fget <span class="op">(</span>function<span class="op">,</span> Qenable_recursive_minibuffers<span class="op">);</span></span>
<span id="cb159-11"><a aria-hidden="true" href="#cb159-11" tabindex="-1"></a></span>
<span id="cb159-12"><a aria-hidden="true" href="#cb159-12" tabindex="-1"></a>    <span class="co">// Get the interactive specification</span></span>
<span id="cb159-13"><a aria-hidden="true" href="#cb159-13" tabindex="-1"></a>    Lisp_Object specs <span class="op">=</span> Finteractive_form <span class="op">(</span>function<span class="op">);</span></span>
<span id="cb159-14"><a aria-hidden="true" href="#cb159-14" tabindex="-1"></a></span>
<span id="cb159-15"><a aria-hidden="true" href="#cb159-15" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>NILP <span class="op">(</span>specs<span class="op">))</span></span>
<span id="cb159-16"><a aria-hidden="true" href="#cb159-16" tabindex="-1"></a>        <span class="co">// Not an interactive function</span></span>
<span id="cb159-17"><a aria-hidden="true" href="#cb159-17" tabindex="-1"></a>        <span class="cf">return</span> Ffuncall <span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="op">&amp;</span>function<span class="op">);</span></span>
<span id="cb159-18"><a aria-hidden="true" href="#cb159-18" tabindex="-1"></a></span>
<span id="cb159-19"><a aria-hidden="true" href="#cb159-19" tabindex="-1"></a>    <span class="co">// specs is either:</span></span>
<span id="cb159-20"><a aria-hidden="true" href="#cb159-20" tabindex="-1"></a>    <span class="co">// - A string: "(interactive \"sString: \")"</span></span>
<span id="cb159-21"><a aria-hidden="true" href="#cb159-21" tabindex="-1"></a>    <span class="co">// - A list: "(interactive (list (read-string \"String: \")))"</span></span>
<span id="cb159-22"><a aria-hidden="true" href="#cb159-22" tabindex="-1"></a></span>
<span id="cb159-23"><a aria-hidden="true" href="#cb159-23" tabindex="-1"></a>    Lisp_Object spec_string <span class="op">=</span> Qnil<span class="op">;</span></span>
<span id="cb159-24"><a aria-hidden="true" href="#cb159-24" tabindex="-1"></a>    Lisp_Object spec_list <span class="op">=</span> Qnil<span class="op">;</span></span>
<span id="cb159-25"><a aria-hidden="true" href="#cb159-25" tabindex="-1"></a></span>
<span id="cb159-26"><a aria-hidden="true" href="#cb159-26" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>STRINGP <span class="op">(</span>XCAR <span class="op">(</span>specs<span class="op">)))</span></span>
<span id="cb159-27"><a aria-hidden="true" href="#cb159-27" tabindex="-1"></a>        spec_string <span class="op">=</span> XCAR <span class="op">(</span>specs<span class="op">);</span></span>
<span id="cb159-28"><a aria-hidden="true" href="#cb159-28" tabindex="-1"></a>    <span class="cf">else</span></span>
<span id="cb159-29"><a aria-hidden="true" href="#cb159-29" tabindex="-1"></a>        spec_list <span class="op">=</span> Feval <span class="op">(</span>XCAR <span class="op">(</span>specs<span class="op">),</span> Qt<span class="op">);</span>  <span class="co">// Evaluate the form</span></span>
<span id="cb159-30"><a aria-hidden="true" href="#cb159-30" tabindex="-1"></a></span>
<span id="cb159-31"><a aria-hidden="true" href="#cb159-31" tabindex="-1"></a>    <span class="co">// *** PROCESS INTERACTIVE STRING ***</span></span>
<span id="cb159-32"><a aria-hidden="true" href="#cb159-32" tabindex="-1"></a></span>
<span id="cb159-33"><a aria-hidden="true" href="#cb159-33" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(!</span>NILP <span class="op">(</span>spec_string<span class="op">))</span></span>
<span id="cb159-34"><a aria-hidden="true" href="#cb159-34" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb159-35"><a aria-hidden="true" href="#cb159-35" tabindex="-1"></a>        <span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>string <span class="op">=</span> SSDATA <span class="op">(</span>spec_string<span class="op">);</span></span>
<span id="cb159-36"><a aria-hidden="true" href="#cb159-36" tabindex="-1"></a>        <span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>tem<span class="op">;</span></span>
<span id="cb159-37"><a aria-hidden="true" href="#cb159-37" tabindex="-1"></a></span>
<span id="cb159-38"><a aria-hidden="true" href="#cb159-38" tabindex="-1"></a>        <span class="co">// Check special prefixes:</span></span>
<span id="cb159-39"><a aria-hidden="true" href="#cb159-39" tabindex="-1"></a>        <span class="co">// "*" - Error if buffer read-only</span></span>
<span id="cb159-40"><a aria-hidden="true" href="#cb159-40" tabindex="-1"></a>        <span class="co">// "@" - Select window from mouse event</span></span>
<span id="cb159-41"><a aria-hidden="true" href="#cb159-41" tabindex="-1"></a>        <span class="co">// "^" - Handle shift-selection</span></span>
<span id="cb159-42"><a aria-hidden="true" href="#cb159-42" tabindex="-1"></a></span>
<span id="cb159-43"><a aria-hidden="true" href="#cb159-43" tabindex="-1"></a>        <span class="cf">while</span> <span class="op">(*</span>string <span class="op">==</span> <span class="ch">'*'</span> <span class="op">||</span> <span class="op">*</span>string <span class="op">==</span> <span class="ch">'@'</span> <span class="op">||</span> <span class="op">*</span>string <span class="op">==</span> <span class="ch">'^'</span><span class="op">)</span></span>
<span id="cb159-44"><a aria-hidden="true" href="#cb159-44" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb159-45"><a aria-hidden="true" href="#cb159-45" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(*</span>string <span class="op">==</span> <span class="ch">'*'</span><span class="op">)</span></span>
<span id="cb159-46"><a aria-hidden="true" href="#cb159-46" tabindex="-1"></a>            <span class="op">{</span></span>
<span id="cb159-47"><a aria-hidden="true" href="#cb159-47" tabindex="-1"></a>                <span class="cf">if</span> <span class="op">(!</span>NILP <span class="op">(</span>BVAR <span class="op">(</span>current_buffer<span class="op">,</span> read_only<span class="op">)))</span></span>
<span id="cb159-48"><a aria-hidden="true" href="#cb159-48" tabindex="-1"></a>                    xsignal1 <span class="op">(</span>Qbuffer_read_only<span class="op">,</span> Fcurrent_buffer <span class="op">());</span></span>
<span id="cb159-49"><a aria-hidden="true" href="#cb159-49" tabindex="-1"></a>                string<span class="op">++;</span></span>
<span id="cb159-50"><a aria-hidden="true" href="#cb159-50" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb159-51"><a aria-hidden="true" href="#cb159-51" tabindex="-1"></a>            <span class="cf">else</span> <span class="cf">if</span> <span class="op">(*</span>string <span class="op">==</span> <span class="ch">'@'</span><span class="op">)</span></span>
<span id="cb159-52"><a aria-hidden="true" href="#cb159-52" tabindex="-1"></a>            <span class="op">{</span></span>
<span id="cb159-53"><a aria-hidden="true" href="#cb159-53" tabindex="-1"></a>                <span class="co">// Select window from event</span></span>
<span id="cb159-54"><a aria-hidden="true" href="#cb159-54" tabindex="-1"></a>                Lisp_Object event <span class="op">=</span> extract_event <span class="op">(</span>keys<span class="op">);</span></span>
<span id="cb159-55"><a aria-hidden="true" href="#cb159-55" tabindex="-1"></a>                Lisp_Object window <span class="op">=</span> posn_window <span class="op">(</span>event_start <span class="op">(</span>event<span class="op">));</span></span>
<span id="cb159-56"><a aria-hidden="true" href="#cb159-56" tabindex="-1"></a>                <span class="cf">if</span> <span class="op">(</span>WINDOWP <span class="op">(</span>window<span class="op">))</span></span>
<span id="cb159-57"><a aria-hidden="true" href="#cb159-57" tabindex="-1"></a>                    Fselect_window <span class="op">(</span>window<span class="op">,</span> Qnil<span class="op">);</span></span>
<span id="cb159-58"><a aria-hidden="true" href="#cb159-58" tabindex="-1"></a>                string<span class="op">++;</span></span>
<span id="cb159-59"><a aria-hidden="true" href="#cb159-59" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb159-60"><a aria-hidden="true" href="#cb159-60" tabindex="-1"></a>            <span class="cf">else</span> <span class="cf">if</span> <span class="op">(*</span>string <span class="op">==</span> <span class="ch">'^'</span><span class="op">)</span></span>
<span id="cb159-61"><a aria-hidden="true" href="#cb159-61" tabindex="-1"></a>            <span class="op">{</span></span>
<span id="cb159-62"><a aria-hidden="true" href="#cb159-62" tabindex="-1"></a>                <span class="co">// Handle shift-selection</span></span>
<span id="cb159-63"><a aria-hidden="true" href="#cb159-63" tabindex="-1"></a>                <span class="cf">if</span> <span class="op">(!</span>NILP <span class="op">(</span>Vshift_select_mode<span class="op">))</span></span>
<span id="cb159-64"><a aria-hidden="true" href="#cb159-64" tabindex="-1"></a>                    call0 <span class="op">(</span>Qhandle_shift_selection<span class="op">);</span></span>
<span id="cb159-65"><a aria-hidden="true" href="#cb159-65" tabindex="-1"></a>                string<span class="op">++;</span></span>
<span id="cb159-66"><a aria-hidden="true" href="#cb159-66" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb159-67"><a aria-hidden="true" href="#cb159-67" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb159-68"><a aria-hidden="true" href="#cb159-68" tabindex="-1"></a></span>
<span id="cb159-69"><a aria-hidden="true" href="#cb159-69" tabindex="-1"></a>        <span class="co">// *** PARSE INTERACTIVE CODES ***</span></span>
<span id="cb159-70"><a aria-hidden="true" href="#cb159-70" tabindex="-1"></a></span>
<span id="cb159-71"><a aria-hidden="true" href="#cb159-71" tabindex="-1"></a>        <span class="co">// Build argument list by parsing interactive code letters</span></span>
<span id="cb159-72"><a aria-hidden="true" href="#cb159-72" tabindex="-1"></a>        <span class="dt">ptrdiff_t</span> nargs <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb159-73"><a aria-hidden="true" href="#cb159-73" tabindex="-1"></a>        Lisp_Object <span class="op">*</span>args <span class="op">=</span> alloca <span class="op">(</span><span class="kw">sizeof</span> <span class="op">(</span>Lisp_Object<span class="op">)</span> <span class="op">*</span> strlen <span class="op">(</span>string<span class="op">));</span></span>
<span id="cb159-74"><a aria-hidden="true" href="#cb159-74" tabindex="-1"></a></span>
<span id="cb159-75"><a aria-hidden="true" href="#cb159-75" tabindex="-1"></a>        tem <span class="op">=</span> string<span class="op">;</span></span>
<span id="cb159-76"><a aria-hidden="true" href="#cb159-76" tabindex="-1"></a>        <span class="cf">while</span> <span class="op">(*</span>tem<span class="op">)</span></span>
<span id="cb159-77"><a aria-hidden="true" href="#cb159-77" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb159-78"><a aria-hidden="true" href="#cb159-78" tabindex="-1"></a>            <span class="co">// Each code letter specifies how to read one argument</span></span>
<span id="cb159-79"><a aria-hidden="true" href="#cb159-79" tabindex="-1"></a>            <span class="cf">switch</span> <span class="op">(*</span>tem<span class="op">)</span></span>
<span id="cb159-80"><a aria-hidden="true" href="#cb159-80" tabindex="-1"></a>            <span class="op">{</span></span>
<span id="cb159-81"><a aria-hidden="true" href="#cb159-81" tabindex="-1"></a>            <span class="cf">case</span> <span class="ch">'a'</span><span class="op">:</span>  <span class="co">// Function name</span></span>
<span id="cb159-82"><a aria-hidden="true" href="#cb159-82" tabindex="-1"></a>                args<span class="op">[</span>nargs<span class="op">++]</span> <span class="op">=</span> Fcompleting_read <span class="op">(...);</span></span>
<span id="cb159-83"><a aria-hidden="true" href="#cb159-83" tabindex="-1"></a>                <span class="cf">break</span><span class="op">;</span></span>
<span id="cb159-84"><a aria-hidden="true" href="#cb159-84" tabindex="-1"></a></span>
<span id="cb159-85"><a aria-hidden="true" href="#cb159-85" tabindex="-1"></a>            <span class="cf">case</span> <span class="ch">'b'</span><span class="op">:</span>  <span class="co">// Existing buffer name</span></span>
<span id="cb159-86"><a aria-hidden="true" href="#cb159-86" tabindex="-1"></a>                args<span class="op">[</span>nargs<span class="op">++]</span> <span class="op">=</span> Fread_buffer <span class="op">(...);</span></span>
<span id="cb159-87"><a aria-hidden="true" href="#cb159-87" tabindex="-1"></a>                <span class="cf">break</span><span class="op">;</span></span>
<span id="cb159-88"><a aria-hidden="true" href="#cb159-88" tabindex="-1"></a></span>
<span id="cb159-89"><a aria-hidden="true" href="#cb159-89" tabindex="-1"></a>            <span class="cf">case</span> <span class="ch">'B'</span><span class="op">:</span>  <span class="co">// Possibly nonexistent buffer</span></span>
<span id="cb159-90"><a aria-hidden="true" href="#cb159-90" tabindex="-1"></a>                args<span class="op">[</span>nargs<span class="op">++]</span> <span class="op">=</span> Fread_buffer <span class="op">(...);</span></span>
<span id="cb159-91"><a aria-hidden="true" href="#cb159-91" tabindex="-1"></a>                <span class="cf">break</span><span class="op">;</span></span>
<span id="cb159-92"><a aria-hidden="true" href="#cb159-92" tabindex="-1"></a></span>
<span id="cb159-93"><a aria-hidden="true" href="#cb159-93" tabindex="-1"></a>            <span class="cf">case</span> <span class="ch">'c'</span><span class="op">:</span>  <span class="co">// Character</span></span>
<span id="cb159-94"><a aria-hidden="true" href="#cb159-94" tabindex="-1"></a>                args<span class="op">[</span>nargs<span class="op">++]</span> <span class="op">=</span> Fread_char <span class="op">(...);</span></span>
<span id="cb159-95"><a aria-hidden="true" href="#cb159-95" tabindex="-1"></a>                <span class="cf">break</span><span class="op">;</span></span>
<span id="cb159-96"><a aria-hidden="true" href="#cb159-96" tabindex="-1"></a></span>
<span id="cb159-97"><a aria-hidden="true" href="#cb159-97" tabindex="-1"></a>            <span class="cf">case</span> <span class="ch">'C'</span><span class="op">:</span>  <span class="co">// Command name</span></span>
<span id="cb159-98"><a aria-hidden="true" href="#cb159-98" tabindex="-1"></a>                args<span class="op">[</span>nargs<span class="op">++]</span> <span class="op">=</span> Fcompleting_read <span class="op">(...);</span></span>
<span id="cb159-99"><a aria-hidden="true" href="#cb159-99" tabindex="-1"></a>                <span class="cf">break</span><span class="op">;</span></span>
<span id="cb159-100"><a aria-hidden="true" href="#cb159-100" tabindex="-1"></a></span>
<span id="cb159-101"><a aria-hidden="true" href="#cb159-101" tabindex="-1"></a>            <span class="cf">case</span> <span class="ch">'d'</span><span class="op">:</span>  <span class="co">// Point position (no I/O)</span></span>
<span id="cb159-102"><a aria-hidden="true" href="#cb159-102" tabindex="-1"></a>                args<span class="op">[</span>nargs<span class="op">++]</span> <span class="op">=</span> make_fixnum <span class="op">(</span>PT<span class="op">);</span></span>
<span id="cb159-103"><a aria-hidden="true" href="#cb159-103" tabindex="-1"></a>                <span class="cf">break</span><span class="op">;</span></span>
<span id="cb159-104"><a aria-hidden="true" href="#cb159-104" tabindex="-1"></a></span>
<span id="cb159-105"><a aria-hidden="true" href="#cb159-105" tabindex="-1"></a>            <span class="cf">case</span> <span class="ch">'D'</span><span class="op">:</span>  <span class="co">// Directory name</span></span>
<span id="cb159-106"><a aria-hidden="true" href="#cb159-106" tabindex="-1"></a>                args<span class="op">[</span>nargs<span class="op">++]</span> <span class="op">=</span> read_file_name <span class="op">(...);</span></span>
<span id="cb159-107"><a aria-hidden="true" href="#cb159-107" tabindex="-1"></a>                <span class="cf">break</span><span class="op">;</span></span>
<span id="cb159-108"><a aria-hidden="true" href="#cb159-108" tabindex="-1"></a></span>
<span id="cb159-109"><a aria-hidden="true" href="#cb159-109" tabindex="-1"></a>            <span class="cf">case</span> <span class="ch">'e'</span><span class="op">:</span>  <span class="co">// Event</span></span>
<span id="cb159-110"><a aria-hidden="true" href="#cb159-110" tabindex="-1"></a>                args<span class="op">[</span>nargs<span class="op">++]</span> <span class="op">=</span> extract_event <span class="op">(</span>keys<span class="op">,</span> nargs<span class="op">);</span></span>
<span id="cb159-111"><a aria-hidden="true" href="#cb159-111" tabindex="-1"></a>                <span class="cf">break</span><span class="op">;</span></span>
<span id="cb159-112"><a aria-hidden="true" href="#cb159-112" tabindex="-1"></a></span>
<span id="cb159-113"><a aria-hidden="true" href="#cb159-113" tabindex="-1"></a>            <span class="cf">case</span> <span class="ch">'f'</span><span class="op">:</span>  <span class="co">// Existing file</span></span>
<span id="cb159-114"><a aria-hidden="true" href="#cb159-114" tabindex="-1"></a>                args<span class="op">[</span>nargs<span class="op">++]</span> <span class="op">=</span> read_file_name <span class="op">(...);</span></span>
<span id="cb159-115"><a aria-hidden="true" href="#cb159-115" tabindex="-1"></a>                <span class="cf">break</span><span class="op">;</span></span>
<span id="cb159-116"><a aria-hidden="true" href="#cb159-116" tabindex="-1"></a></span>
<span id="cb159-117"><a aria-hidden="true" href="#cb159-117" tabindex="-1"></a>            <span class="cf">case</span> <span class="ch">'F'</span><span class="op">:</span>  <span class="co">// Possibly nonexistent file</span></span>
<span id="cb159-118"><a aria-hidden="true" href="#cb159-118" tabindex="-1"></a>                args<span class="op">[</span>nargs<span class="op">++]</span> <span class="op">=</span> read_file_name <span class="op">(...);</span></span>
<span id="cb159-119"><a aria-hidden="true" href="#cb159-119" tabindex="-1"></a>                <span class="cf">break</span><span class="op">;</span></span>
<span id="cb159-120"><a aria-hidden="true" href="#cb159-120" tabindex="-1"></a></span>
<span id="cb159-121"><a aria-hidden="true" href="#cb159-121" tabindex="-1"></a>            <span class="cf">case</span> <span class="ch">'k'</span><span class="op">:</span>  <span class="co">// Key sequence</span></span>
<span id="cb159-122"><a aria-hidden="true" href="#cb159-122" tabindex="-1"></a>                args<span class="op">[</span>nargs<span class="op">++]</span> <span class="op">=</span> Fread_key_sequence <span class="op">(...);</span></span>
<span id="cb159-123"><a aria-hidden="true" href="#cb159-123" tabindex="-1"></a>                <span class="cf">break</span><span class="op">;</span></span>
<span id="cb159-124"><a aria-hidden="true" href="#cb159-124" tabindex="-1"></a></span>
<span id="cb159-125"><a aria-hidden="true" href="#cb159-125" tabindex="-1"></a>            <span class="cf">case</span> <span class="ch">'K'</span><span class="op">:</span>  <span class="co">// Key sequence (for remapping)</span></span>
<span id="cb159-126"><a aria-hidden="true" href="#cb159-126" tabindex="-1"></a>                args<span class="op">[</span>nargs<span class="op">++]</span> <span class="op">=</span> Fread_key_sequence <span class="op">(...);</span></span>
<span id="cb159-127"><a aria-hidden="true" href="#cb159-127" tabindex="-1"></a>                <span class="cf">break</span><span class="op">;</span></span>
<span id="cb159-128"><a aria-hidden="true" href="#cb159-128" tabindex="-1"></a></span>
<span id="cb159-129"><a aria-hidden="true" href="#cb159-129" tabindex="-1"></a>            <span class="cf">case</span> <span class="ch">'m'</span><span class="op">:</span>  <span class="co">// Mark position</span></span>
<span id="cb159-130"><a aria-hidden="true" href="#cb159-130" tabindex="-1"></a>                check_mark <span class="op">(</span><span class="kw">false</span><span class="op">);</span></span>
<span id="cb159-131"><a aria-hidden="true" href="#cb159-131" tabindex="-1"></a>                args<span class="op">[</span>nargs<span class="op">++]</span> <span class="op">=</span> make_fixnum <span class="op">(</span>marker_position <span class="op">(</span></span>
<span id="cb159-132"><a aria-hidden="true" href="#cb159-132" tabindex="-1"></a>                    BVAR <span class="op">(</span>current_buffer<span class="op">,</span> mark<span class="op">)));</span></span>
<span id="cb159-133"><a aria-hidden="true" href="#cb159-133" tabindex="-1"></a>                <span class="cf">break</span><span class="op">;</span></span>
<span id="cb159-134"><a aria-hidden="true" href="#cb159-134" tabindex="-1"></a></span>
<span id="cb159-135"><a aria-hidden="true" href="#cb159-135" tabindex="-1"></a>            <span class="cf">case</span> <span class="ch">'n'</span><span class="op">:</span>  <span class="co">// Number from minibuffer</span></span>
<span id="cb159-136"><a aria-hidden="true" href="#cb159-136" tabindex="-1"></a>                args<span class="op">[</span>nargs<span class="op">++]</span> <span class="op">=</span> Fread_number <span class="op">(...);</span></span>
<span id="cb159-137"><a aria-hidden="true" href="#cb159-137" tabindex="-1"></a>                <span class="cf">break</span><span class="op">;</span></span>
<span id="cb159-138"><a aria-hidden="true" href="#cb159-138" tabindex="-1"></a></span>
<span id="cb159-139"><a aria-hidden="true" href="#cb159-139" tabindex="-1"></a>            <span class="cf">case</span> <span class="ch">'N'</span><span class="op">:</span>  <span class="co">// Numeric prefix or number</span></span>
<span id="cb159-140"><a aria-hidden="true" href="#cb159-140" tabindex="-1"></a>                <span class="cf">if</span> <span class="op">(</span>NILP <span class="op">(</span>prefix_arg<span class="op">))</span></span>
<span id="cb159-141"><a aria-hidden="true" href="#cb159-141" tabindex="-1"></a>                    args<span class="op">[</span>nargs<span class="op">++]</span> <span class="op">=</span> Fread_number <span class="op">(...);</span></span>
<span id="cb159-142"><a aria-hidden="true" href="#cb159-142" tabindex="-1"></a>                <span class="cf">else</span></span>
<span id="cb159-143"><a aria-hidden="true" href="#cb159-143" tabindex="-1"></a>                    args<span class="op">[</span>nargs<span class="op">++]</span> <span class="op">=</span> Fprefix_numeric_value <span class="op">(</span>prefix_arg<span class="op">);</span></span>
<span id="cb159-144"><a aria-hidden="true" href="#cb159-144" tabindex="-1"></a>                <span class="cf">break</span><span class="op">;</span></span>
<span id="cb159-145"><a aria-hidden="true" href="#cb159-145" tabindex="-1"></a></span>
<span id="cb159-146"><a aria-hidden="true" href="#cb159-146" tabindex="-1"></a>            <span class="cf">case</span> <span class="ch">'p'</span><span class="op">:</span>  <span class="co">// Prefix arg as number</span></span>
<span id="cb159-147"><a aria-hidden="true" href="#cb159-147" tabindex="-1"></a>                args<span class="op">[</span>nargs<span class="op">++]</span> <span class="op">=</span> Fprefix_numeric_value <span class="op">(</span>prefix_arg<span class="op">);</span></span>
<span id="cb159-148"><a aria-hidden="true" href="#cb159-148" tabindex="-1"></a>                <span class="cf">break</span><span class="op">;</span></span>
<span id="cb159-149"><a aria-hidden="true" href="#cb159-149" tabindex="-1"></a></span>
<span id="cb159-150"><a aria-hidden="true" href="#cb159-150" tabindex="-1"></a>            <span class="cf">case</span> <span class="ch">'P'</span><span class="op">:</span>  <span class="co">// Prefix arg in raw form</span></span>
<span id="cb159-151"><a aria-hidden="true" href="#cb159-151" tabindex="-1"></a>                args<span class="op">[</span>nargs<span class="op">++]</span> <span class="op">=</span> prefix_arg<span class="op">;</span></span>
<span id="cb159-152"><a aria-hidden="true" href="#cb159-152" tabindex="-1"></a>                <span class="cf">break</span><span class="op">;</span></span>
<span id="cb159-153"><a aria-hidden="true" href="#cb159-153" tabindex="-1"></a></span>
<span id="cb159-154"><a aria-hidden="true" href="#cb159-154" tabindex="-1"></a>            <span class="cf">case</span> <span class="ch">'r'</span><span class="op">:</span>  <span class="co">// Region: point and mark</span></span>
<span id="cb159-155"><a aria-hidden="true" href="#cb159-155" tabindex="-1"></a>                check_mark <span class="op">(</span><span class="kw">true</span><span class="op">);</span></span>
<span id="cb159-156"><a aria-hidden="true" href="#cb159-156" tabindex="-1"></a>                <span class="op">{</span></span>
<span id="cb159-157"><a aria-hidden="true" href="#cb159-157" tabindex="-1"></a>                    <span class="dt">ptrdiff_t</span> mark_pos <span class="op">=</span> marker_position <span class="op">(</span></span>
<span id="cb159-158"><a aria-hidden="true" href="#cb159-158" tabindex="-1"></a>                        BVAR <span class="op">(</span>current_buffer<span class="op">,</span> mark<span class="op">));</span></span>
<span id="cb159-159"><a aria-hidden="true" href="#cb159-159" tabindex="-1"></a>                    <span class="dt">ptrdiff_t</span> point_pos <span class="op">=</span> PT<span class="op">;</span></span>
<span id="cb159-160"><a aria-hidden="true" href="#cb159-160" tabindex="-1"></a></span>
<span id="cb159-161"><a aria-hidden="true" href="#cb159-161" tabindex="-1"></a>                    <span class="co">// Ensure smallest first</span></span>
<span id="cb159-162"><a aria-hidden="true" href="#cb159-162" tabindex="-1"></a>                    <span class="cf">if</span> <span class="op">(</span>point_pos <span class="op">&lt;</span> mark_pos<span class="op">)</span></span>
<span id="cb159-163"><a aria-hidden="true" href="#cb159-163" tabindex="-1"></a>                    <span class="op">{</span></span>
<span id="cb159-164"><a aria-hidden="true" href="#cb159-164" tabindex="-1"></a>                        args<span class="op">[</span>nargs<span class="op">++]</span> <span class="op">=</span> make_fixnum <span class="op">(</span>point_pos<span class="op">);</span></span>
<span id="cb159-165"><a aria-hidden="true" href="#cb159-165" tabindex="-1"></a>                        args<span class="op">[</span>nargs<span class="op">++]</span> <span class="op">=</span> make_fixnum <span class="op">(</span>mark_pos<span class="op">);</span></span>
<span id="cb159-166"><a aria-hidden="true" href="#cb159-166" tabindex="-1"></a>                    <span class="op">}</span></span>
<span id="cb159-167"><a aria-hidden="true" href="#cb159-167" tabindex="-1"></a>                    <span class="cf">else</span></span>
<span id="cb159-168"><a aria-hidden="true" href="#cb159-168" tabindex="-1"></a>                    <span class="op">{</span></span>
<span id="cb159-169"><a aria-hidden="true" href="#cb159-169" tabindex="-1"></a>                        args<span class="op">[</span>nargs<span class="op">++]</span> <span class="op">=</span> make_fixnum <span class="op">(</span>mark_pos<span class="op">);</span></span>
<span id="cb159-170"><a aria-hidden="true" href="#cb159-170" tabindex="-1"></a>                        args<span class="op">[</span>nargs<span class="op">++]</span> <span class="op">=</span> make_fixnum <span class="op">(</span>point_pos<span class="op">);</span></span>
<span id="cb159-171"><a aria-hidden="true" href="#cb159-171" tabindex="-1"></a>                    <span class="op">}</span></span>
<span id="cb159-172"><a aria-hidden="true" href="#cb159-172" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb159-173"><a aria-hidden="true" href="#cb159-173" tabindex="-1"></a>                <span class="cf">break</span><span class="op">;</span></span>
<span id="cb159-174"><a aria-hidden="true" href="#cb159-174" tabindex="-1"></a></span>
<span id="cb159-175"><a aria-hidden="true" href="#cb159-175" tabindex="-1"></a>            <span class="cf">case</span> <span class="ch">'s'</span><span class="op">:</span>  <span class="co">// String from minibuffer</span></span>
<span id="cb159-176"><a aria-hidden="true" href="#cb159-176" tabindex="-1"></a>                args<span class="op">[</span>nargs<span class="op">++]</span> <span class="op">=</span> Fread_string <span class="op">(...);</span></span>
<span id="cb159-177"><a aria-hidden="true" href="#cb159-177" tabindex="-1"></a>                <span class="cf">break</span><span class="op">;</span></span>
<span id="cb159-178"><a aria-hidden="true" href="#cb159-178" tabindex="-1"></a></span>
<span id="cb159-179"><a aria-hidden="true" href="#cb159-179" tabindex="-1"></a>            <span class="cf">case</span> <span class="ch">'S'</span><span class="op">:</span>  <span class="co">// Symbol</span></span>
<span id="cb159-180"><a aria-hidden="true" href="#cb159-180" tabindex="-1"></a>                args<span class="op">[</span>nargs<span class="op">++]</span> <span class="op">=</span> Fintern <span class="op">(</span>Fread_string <span class="op">(...),</span> Qnil<span class="op">);</span></span>
<span id="cb159-181"><a aria-hidden="true" href="#cb159-181" tabindex="-1"></a>                <span class="cf">break</span><span class="op">;</span></span>
<span id="cb159-182"><a aria-hidden="true" href="#cb159-182" tabindex="-1"></a></span>
<span id="cb159-183"><a aria-hidden="true" href="#cb159-183" tabindex="-1"></a>            <span class="cf">case</span> <span class="ch">'v'</span><span class="op">:</span>  <span class="co">// Variable name</span></span>
<span id="cb159-184"><a aria-hidden="true" href="#cb159-184" tabindex="-1"></a>                args<span class="op">[</span>nargs<span class="op">++]</span> <span class="op">=</span> Fread_variable <span class="op">(...);</span></span>
<span id="cb159-185"><a aria-hidden="true" href="#cb159-185" tabindex="-1"></a>                <span class="cf">break</span><span class="op">;</span></span>
<span id="cb159-186"><a aria-hidden="true" href="#cb159-186" tabindex="-1"></a></span>
<span id="cb159-187"><a aria-hidden="true" href="#cb159-187" tabindex="-1"></a>            <span class="cf">case</span> <span class="ch">'x'</span><span class="op">:</span>  <span class="co">// Lisp expression (not evaluated)</span></span>
<span id="cb159-188"><a aria-hidden="true" href="#cb159-188" tabindex="-1"></a>                args<span class="op">[</span>nargs<span class="op">++]</span> <span class="op">=</span> Fread_minibuffer <span class="op">(...);</span></span>
<span id="cb159-189"><a aria-hidden="true" href="#cb159-189" tabindex="-1"></a>                <span class="cf">break</span><span class="op">;</span></span>
<span id="cb159-190"><a aria-hidden="true" href="#cb159-190" tabindex="-1"></a></span>
<span id="cb159-191"><a aria-hidden="true" href="#cb159-191" tabindex="-1"></a>            <span class="cf">case</span> <span class="ch">'X'</span><span class="op">:</span>  <span class="co">// Lisp expression (evaluated)</span></span>
<span id="cb159-192"><a aria-hidden="true" href="#cb159-192" tabindex="-1"></a>                args<span class="op">[</span>nargs<span class="op">++]</span> <span class="op">=</span> Feval <span class="op">(</span>Fread_minibuffer <span class="op">(...),</span> Qt<span class="op">);</span></span>
<span id="cb159-193"><a aria-hidden="true" href="#cb159-193" tabindex="-1"></a>                <span class="cf">break</span><span class="op">;</span></span>
<span id="cb159-194"><a aria-hidden="true" href="#cb159-194" tabindex="-1"></a></span>
<span id="cb159-195"><a aria-hidden="true" href="#cb159-195" tabindex="-1"></a>            <span class="cf">case</span> <span class="ch">'z'</span><span class="op">:</span>  <span class="co">// Coding system</span></span>
<span id="cb159-196"><a aria-hidden="true" href="#cb159-196" tabindex="-1"></a>                args<span class="op">[</span>nargs<span class="op">++]</span> <span class="op">=</span> Fread_coding_system <span class="op">(...);</span></span>
<span id="cb159-197"><a aria-hidden="true" href="#cb159-197" tabindex="-1"></a>                <span class="cf">break</span><span class="op">;</span></span>
<span id="cb159-198"><a aria-hidden="true" href="#cb159-198" tabindex="-1"></a></span>
<span id="cb159-199"><a aria-hidden="true" href="#cb159-199" tabindex="-1"></a>            <span class="cf">case</span> <span class="ch">'Z'</span><span class="op">:</span>  <span class="co">// Coding system or nil</span></span>
<span id="cb159-200"><a aria-hidden="true" href="#cb159-200" tabindex="-1"></a>                <span class="cf">if</span> <span class="op">(</span>NILP <span class="op">(</span>prefix_arg<span class="op">))</span></span>
<span id="cb159-201"><a aria-hidden="true" href="#cb159-201" tabindex="-1"></a>                    args<span class="op">[</span>nargs<span class="op">++]</span> <span class="op">=</span> Qnil<span class="op">;</span></span>
<span id="cb159-202"><a aria-hidden="true" href="#cb159-202" tabindex="-1"></a>                <span class="cf">else</span></span>
<span id="cb159-203"><a aria-hidden="true" href="#cb159-203" tabindex="-1"></a>                    args<span class="op">[</span>nargs<span class="op">++]</span> <span class="op">=</span> Fread_coding_system <span class="op">(...);</span></span>
<span id="cb159-204"><a aria-hidden="true" href="#cb159-204" tabindex="-1"></a>                <span class="cf">break</span><span class="op">;</span></span>
<span id="cb159-205"><a aria-hidden="true" href="#cb159-205" tabindex="-1"></a></span>
<span id="cb159-206"><a aria-hidden="true" href="#cb159-206" tabindex="-1"></a>            <span class="cf">default</span><span class="op">:</span></span>
<span id="cb159-207"><a aria-hidden="true" href="#cb159-207" tabindex="-1"></a>                error <span class="op">(</span><span class="st">"Invalid interactive code: </span><span class="sc">%c</span><span class="st">"</span><span class="op">,</span> <span class="op">*</span>tem<span class="op">);</span></span>
<span id="cb159-208"><a aria-hidden="true" href="#cb159-208" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb159-209"><a aria-hidden="true" href="#cb159-209" tabindex="-1"></a></span>
<span id="cb159-210"><a aria-hidden="true" href="#cb159-210" tabindex="-1"></a>            <span class="co">// Skip to next code (skip prompt string after newline)</span></span>
<span id="cb159-211"><a aria-hidden="true" href="#cb159-211" tabindex="-1"></a>            tem<span class="op">++;</span></span>
<span id="cb159-212"><a aria-hidden="true" href="#cb159-212" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(*</span>tem <span class="op">==</span> <span class="ch">'</span><span class="sc">\n</span><span class="ch">'</span><span class="op">)</span></span>
<span id="cb159-213"><a aria-hidden="true" href="#cb159-213" tabindex="-1"></a>            <span class="op">{</span></span>
<span id="cb159-214"><a aria-hidden="true" href="#cb159-214" tabindex="-1"></a>                tem<span class="op">++;</span></span>
<span id="cb159-215"><a aria-hidden="true" href="#cb159-215" tabindex="-1"></a>                <span class="co">// Skip prompt</span></span>
<span id="cb159-216"><a aria-hidden="true" href="#cb159-216" tabindex="-1"></a>                <span class="cf">while</span> <span class="op">(*</span>tem <span class="op">&amp;&amp;</span> <span class="op">*</span>tem <span class="op">!=</span> <span class="ch">'</span><span class="sc">\n</span><span class="ch">'</span><span class="op">)</span></span>
<span id="cb159-217"><a aria-hidden="true" href="#cb159-217" tabindex="-1"></a>                    tem<span class="op">++;</span></span>
<span id="cb159-218"><a aria-hidden="true" href="#cb159-218" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb159-219"><a aria-hidden="true" href="#cb159-219" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb159-220"><a aria-hidden="true" href="#cb159-220" tabindex="-1"></a></span>
<span id="cb159-221"><a aria-hidden="true" href="#cb159-221" tabindex="-1"></a>        <span class="co">// *** CALL FUNCTION WITH ARGS ***</span></span>
<span id="cb159-222"><a aria-hidden="true" href="#cb159-222" tabindex="-1"></a></span>
<span id="cb159-223"><a aria-hidden="true" href="#cb159-223" tabindex="-1"></a>        <span class="co">// Record in command history if needed</span></span>
<span id="cb159-224"><a aria-hidden="true" href="#cb159-224" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(!</span>NILP <span class="op">(</span>record_flag<span class="op">)</span> <span class="op">||</span> arg_from_tty<span class="op">)</span></span>
<span id="cb159-225"><a aria-hidden="true" href="#cb159-225" tabindex="-1"></a>            record_command <span class="op">(</span>function<span class="op">,</span> args<span class="op">,</span> nargs<span class="op">);</span></span>
<span id="cb159-226"><a aria-hidden="true" href="#cb159-226" tabindex="-1"></a></span>
<span id="cb159-227"><a aria-hidden="true" href="#cb159-227" tabindex="-1"></a>        <span class="co">// Actually call the function</span></span>
<span id="cb159-228"><a aria-hidden="true" href="#cb159-228" tabindex="-1"></a>        Lisp_Object val <span class="op">=</span> Ffuncall <span class="op">(</span>nargs <span class="op">+</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb159-229"><a aria-hidden="true" href="#cb159-229" tabindex="-1"></a>                                   cons <span class="op">(</span>function<span class="op">,</span> args_to_list <span class="op">(</span>args<span class="op">,</span> nargs<span class="op">)));</span></span>
<span id="cb159-230"><a aria-hidden="true" href="#cb159-230" tabindex="-1"></a></span>
<span id="cb159-231"><a aria-hidden="true" href="#cb159-231" tabindex="-1"></a>        <span class="cf">return</span> unbind_to <span class="op">(</span>speccount<span class="op">,</span> val<span class="op">);</span></span>
<span id="cb159-232"><a aria-hidden="true" href="#cb159-232" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb159-233"><a aria-hidden="true" href="#cb159-233" tabindex="-1"></a></span>
<span id="cb159-234"><a aria-hidden="true" href="#cb159-234" tabindex="-1"></a>    <span class="co">// *** PROCESS INTERACTIVE LIST ***</span></span>
<span id="cb159-235"><a aria-hidden="true" href="#cb159-235" tabindex="-1"></a></span>
<span id="cb159-236"><a aria-hidden="true" href="#cb159-236" tabindex="-1"></a>    <span class="cf">else</span> <span class="cf">if</span> <span class="op">(!</span>NILP <span class="op">(</span>spec_list<span class="op">))</span></span>
<span id="cb159-237"><a aria-hidden="true" href="#cb159-237" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb159-238"><a aria-hidden="true" href="#cb159-238" tabindex="-1"></a>        <span class="co">// spec_list is a pre-computed list of arguments</span></span>
<span id="cb159-239"><a aria-hidden="true" href="#cb159-239" tabindex="-1"></a>        <span class="dt">ptrdiff_t</span> nargs <span class="op">=</span> list_length <span class="op">(</span>spec_list<span class="op">);</span></span>
<span id="cb159-240"><a aria-hidden="true" href="#cb159-240" tabindex="-1"></a>        Lisp_Object <span class="op">*</span>args <span class="op">=</span> alloca <span class="op">(</span><span class="kw">sizeof</span> <span class="op">(</span>Lisp_Object<span class="op">)</span> <span class="op">*</span> <span class="op">(</span>nargs <span class="op">+</span> <span class="dv">1</span><span class="op">));</span></span>
<span id="cb159-241"><a aria-hidden="true" href="#cb159-241" tabindex="-1"></a></span>
<span id="cb159-242"><a aria-hidden="true" href="#cb159-242" tabindex="-1"></a>        args<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">=</span> function<span class="op">;</span></span>
<span id="cb159-243"><a aria-hidden="true" href="#cb159-243" tabindex="-1"></a>        Lisp_Object tail <span class="op">=</span> spec_list<span class="op">;</span></span>
<span id="cb159-244"><a aria-hidden="true" href="#cb159-244" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(</span><span class="dt">ptrdiff_t</span> i <span class="op">=</span> <span class="dv">1</span><span class="op">;</span> i <span class="op">&lt;=</span> nargs<span class="op">;</span> i<span class="op">++,</span> tail <span class="op">=</span> XCDR <span class="op">(</span>tail<span class="op">))</span></span>
<span id="cb159-245"><a aria-hidden="true" href="#cb159-245" tabindex="-1"></a>            args<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> XCAR <span class="op">(</span>tail<span class="op">);</span></span>
<span id="cb159-246"><a aria-hidden="true" href="#cb159-246" tabindex="-1"></a></span>
<span id="cb159-247"><a aria-hidden="true" href="#cb159-247" tabindex="-1"></a>        <span class="co">// Record and call</span></span>
<span id="cb159-248"><a aria-hidden="true" href="#cb159-248" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(!</span>NILP <span class="op">(</span>record_flag<span class="op">))</span></span>
<span id="cb159-249"><a aria-hidden="true" href="#cb159-249" tabindex="-1"></a>            record_command <span class="op">(</span>function<span class="op">,</span> args <span class="op">+</span> <span class="dv">1</span><span class="op">,</span> nargs<span class="op">);</span></span>
<span id="cb159-250"><a aria-hidden="true" href="#cb159-250" tabindex="-1"></a></span>
<span id="cb159-251"><a aria-hidden="true" href="#cb159-251" tabindex="-1"></a>        <span class="cf">return</span> unbind_to <span class="op">(</span>speccount<span class="op">,</span> Ffuncall <span class="op">(</span>nargs <span class="op">+</span> <span class="dv">1</span><span class="op">,</span> args<span class="op">));</span></span>
<span id="cb159-252"><a aria-hidden="true" href="#cb159-252" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb159-253"><a aria-hidden="true" href="#cb159-253" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>Interactive Code Summary:</strong></p>
<table>
<colgroup>
<col style="width: 20%"/>
<col style="width: 30%"/>
<col style="width: 20%"/>
<col style="width: 30%"/>
</colgroup>
<thead>
<tr>
<th>Code</th>
<th>Meaning</th>
<th>I/O?</th>
<th>Example</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>a</code></td>
<td>Function name</td>
<td>Yes</td>
<td><code>(interactive "aFunction: ")</code></td>
</tr>
<tr>
<td><code>b</code></td>
<td>Existing buffer</td>
<td>Yes</td>
<td><code>(interactive "bBuffer: ")</code></td>
</tr>
<tr>
<td><code>B</code></td>
<td>Buffer (may not exist)</td>
<td>Yes</td>
<td><code>(interactive "BCreate buffer: ")</code></td>
</tr>
<tr>
<td><code>c</code></td>
<td>Character</td>
<td>Yes</td>
<td><code>(interactive "cChar: ")</code></td>
</tr>
<tr>
<td><code>C</code></td>
<td>Command name</td>
<td>Yes</td>
<td><code>(interactive "CCommand: ")</code></td>
</tr>
<tr>
<td><code>d</code></td>
<td>Point position</td>
<td>No</td>
<td><code>(interactive "d")</code></td>
</tr>
<tr>
<td><code>D</code></td>
<td>Directory name</td>
<td>Yes</td>
<td><code>(interactive "DDirectory: ")</code></td>
</tr>
<tr>
<td><code>e</code></td>
<td>Event</td>
<td>No</td>
<td><code>(interactive "e")</code></td>
</tr>
<tr>
<td><code>f</code></td>
<td>Existing file</td>
<td>Yes</td>
<td><code>(interactive "fFile: ")</code></td>
</tr>
<tr>
<td><code>F</code></td>
<td>File (may not exist)</td>
<td>Yes</td>
<td><code>(interactive "FNew file: ")</code></td>
</tr>
<tr>
<td><code>k</code></td>
<td>Key sequence</td>
<td>Yes</td>
<td><code>(interactive "kKey: ")</code></td>
</tr>
<tr>
<td><code>m</code></td>
<td>Mark position</td>
<td>No</td>
<td><code>(interactive "m")</code></td>
</tr>
<tr>
<td><code>n</code></td>
<td>Number</td>
<td>Yes</td>
<td><code>(interactive "nNumber: ")</code></td>
</tr>
<tr>
<td><code>N</code></td>
<td>Prefix or number</td>
<td>Maybe</td>
<td><code>(interactive "NCount: ")</code></td>
</tr>
<tr>
<td><code>p</code></td>
<td>Prefix as number</td>
<td>No</td>
<td><code>(interactive "p")</code></td>
</tr>
<tr>
<td><code>P</code></td>
<td>Prefix (raw)</td>
<td>No</td>
<td><code>(interactive "P")</code></td>
</tr>
<tr>
<td><code>r</code></td>
<td>Region (beg, end)</td>
<td>No</td>
<td><code>(interactive "r")</code></td>
</tr>
<tr>
<td><code>s</code></td>
<td>String</td>
<td>Yes</td>
<td><code>(interactive "sString: ")</code></td>
</tr>
<tr>
<td><code>v</code></td>
<td>Variable name</td>
<td>Yes</td>
<td><code>(interactive "vVariable: ")</code></td>
</tr>
<tr>
<td><code>x</code></td>
<td>Lisp expr (unevaled)</td>
<td>Yes</td>
<td><code>(interactive "xEval: ")</code></td>
</tr>
<tr>
<td><code>X</code></td>
<td>Lisp expr (evaled)</td>
<td>Yes</td>
<td><code>(interactive "XEval: ")</code></td>
</tr>
</tbody>
</table>
<p><strong>Special Prefixes:</strong> - <code>*</code> - Error if buffer
is read-only - <code>@</code> - Select window from mouse event -
<code>^</code> - Handle shift-selection</p>
<h2 data-number="8.9" id="keyboard-macros"><span class="header-section-number">8.9</span> Keyboard Macros</h2>
<p><strong>Location:</strong> <code>src/macros.c</code> (entire
file)</p>
<p>Keyboard macros allow recording and replaying sequences of
keystrokes.</p>
<h3 data-number="8.9.1" id="recording-macros"><span class="header-section-number">8.9.1</span> Recording Macros</h3>
<p><strong>Start Recording:</strong> <code>start-kbd-macro</code> -
<code>src/macros.c:42-110</code></p>
<div class="sourceCode" id="cb160"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb160-1"><a aria-hidden="true" href="#cb160-1" tabindex="-1"></a>DEFUN <span class="op">(</span><span class="st">"start-kbd-macro"</span><span class="op">,</span> Fstart_kbd_macro<span class="op">,</span> Sstart_kbd_macro<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="st">"P"</span><span class="op">,</span></span>
<span id="cb160-2"><a aria-hidden="true" href="#cb160-2" tabindex="-1"></a>       doc<span class="op">:</span> <span class="co">/* Record subsequent keyboard input, defining a keyboard macro... */</span><span class="op">)</span></span>
<span id="cb160-3"><a aria-hidden="true" href="#cb160-3" tabindex="-1"></a>  <span class="op">(</span>Lisp_Object append<span class="op">,</span> Lisp_Object no_exec<span class="op">)</span></span>
<span id="cb160-4"><a aria-hidden="true" href="#cb160-4" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb160-5"><a aria-hidden="true" href="#cb160-5" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(!</span>NILP <span class="op">(</span>KVAR <span class="op">(</span>current_kboard<span class="op">,</span> defining_kbd_macro<span class="op">)))</span></span>
<span id="cb160-6"><a aria-hidden="true" href="#cb160-6" tabindex="-1"></a>        error <span class="op">(</span><span class="st">"Already defining kbd macro"</span><span class="op">);</span></span>
<span id="cb160-7"><a aria-hidden="true" href="#cb160-7" tabindex="-1"></a></span>
<span id="cb160-8"><a aria-hidden="true" href="#cb160-8" tabindex="-1"></a>    <span class="co">// Allocate macro buffer if needed</span></span>
<span id="cb160-9"><a aria-hidden="true" href="#cb160-9" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(!</span>current_kboard<span class="op">-&gt;</span>kbd_macro_buffer<span class="op">)</span></span>
<span id="cb160-10"><a aria-hidden="true" href="#cb160-10" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb160-11"><a aria-hidden="true" href="#cb160-11" tabindex="-1"></a>        current_kboard<span class="op">-&gt;</span>kbd_macro_buffer <span class="op">=</span> xmalloc <span class="op">(</span><span class="dv">30</span> <span class="op">*</span> word_size<span class="op">);</span></span>
<span id="cb160-12"><a aria-hidden="true" href="#cb160-12" tabindex="-1"></a>        current_kboard<span class="op">-&gt;</span>kbd_macro_bufsize <span class="op">=</span> <span class="dv">30</span><span class="op">;</span></span>
<span id="cb160-13"><a aria-hidden="true" href="#cb160-13" tabindex="-1"></a>        current_kboard<span class="op">-&gt;</span>kbd_macro_ptr <span class="op">=</span> current_kboard<span class="op">-&gt;</span>kbd_macro_buffer<span class="op">;</span></span>
<span id="cb160-14"><a aria-hidden="true" href="#cb160-14" tabindex="-1"></a>        current_kboard<span class="op">-&gt;</span>kbd_macro_end <span class="op">=</span> current_kboard<span class="op">-&gt;</span>kbd_macro_buffer<span class="op">;</span></span>
<span id="cb160-15"><a aria-hidden="true" href="#cb160-15" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb160-16"><a aria-hidden="true" href="#cb160-16" tabindex="-1"></a></span>
<span id="cb160-17"><a aria-hidden="true" href="#cb160-17" tabindex="-1"></a>    update_mode_lines <span class="op">=</span> <span class="dv">19</span><span class="op">;</span>  <span class="co">// Update mode line display</span></span>
<span id="cb160-18"><a aria-hidden="true" href="#cb160-18" tabindex="-1"></a></span>
<span id="cb160-19"><a aria-hidden="true" href="#cb160-19" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>NILP <span class="op">(</span>append<span class="op">))</span></span>
<span id="cb160-20"><a aria-hidden="true" href="#cb160-20" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb160-21"><a aria-hidden="true" href="#cb160-21" tabindex="-1"></a>        <span class="co">// Start fresh macro</span></span>
<span id="cb160-22"><a aria-hidden="true" href="#cb160-22" tabindex="-1"></a>        current_kboard<span class="op">-&gt;</span>kbd_macro_ptr <span class="op">=</span> current_kboard<span class="op">-&gt;</span>kbd_macro_buffer<span class="op">;</span></span>
<span id="cb160-23"><a aria-hidden="true" href="#cb160-23" tabindex="-1"></a>        current_kboard<span class="op">-&gt;</span>kbd_macro_end <span class="op">=</span> current_kboard<span class="op">-&gt;</span>kbd_macro_buffer<span class="op">;</span></span>
<span id="cb160-24"><a aria-hidden="true" href="#cb160-24" tabindex="-1"></a>        message1 <span class="op">(</span><span class="st">"Defining kbd macro..."</span><span class="op">);</span></span>
<span id="cb160-25"><a aria-hidden="true" href="#cb160-25" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb160-26"><a aria-hidden="true" href="#cb160-26" tabindex="-1"></a>    <span class="cf">else</span></span>
<span id="cb160-27"><a aria-hidden="true" href="#cb160-27" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb160-28"><a aria-hidden="true" href="#cb160-28" tabindex="-1"></a>        <span class="co">// Append to existing macro</span></span>
<span id="cb160-29"><a aria-hidden="true" href="#cb160-29" tabindex="-1"></a>        <span class="co">// Copy last-kbd-macro into buffer</span></span>
<span id="cb160-30"><a aria-hidden="true" href="#cb160-30" tabindex="-1"></a>        Lisp_Object last_macro <span class="op">=</span> KVAR <span class="op">(</span>current_kboard<span class="op">,</span> Vlast_kbd_macro<span class="op">);</span></span>
<span id="cb160-31"><a aria-hidden="true" href="#cb160-31" tabindex="-1"></a>        <span class="dt">ptrdiff_t</span> len <span class="op">=</span> CHECK_VECTOR_OR_STRING <span class="op">(</span>last_macro<span class="op">);</span></span>
<span id="cb160-32"><a aria-hidden="true" href="#cb160-32" tabindex="-1"></a></span>
<span id="cb160-33"><a aria-hidden="true" href="#cb160-33" tabindex="-1"></a>        <span class="co">// Ensure buffer is large enough</span></span>
<span id="cb160-34"><a aria-hidden="true" href="#cb160-34" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>current_kboard<span class="op">-&gt;</span>kbd_macro_bufsize <span class="op">-</span> <span class="dv">30</span> <span class="op">&lt;</span> len<span class="op">)</span></span>
<span id="cb160-35"><a aria-hidden="true" href="#cb160-35" tabindex="-1"></a>            current_kboard<span class="op">-&gt;</span>kbd_macro_buffer <span class="op">=</span></span>
<span id="cb160-36"><a aria-hidden="true" href="#cb160-36" tabindex="-1"></a>                xpalloc <span class="op">(...);</span></span>
<span id="cb160-37"><a aria-hidden="true" href="#cb160-37" tabindex="-1"></a></span>
<span id="cb160-38"><a aria-hidden="true" href="#cb160-38" tabindex="-1"></a>        <span class="co">// Copy events</span></span>
<span id="cb160-39"><a aria-hidden="true" href="#cb160-39" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(</span><span class="dt">ptrdiff_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> len<span class="op">;</span> i<span class="op">++)</span></span>
<span id="cb160-40"><a aria-hidden="true" href="#cb160-40" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb160-41"><a aria-hidden="true" href="#cb160-41" tabindex="-1"></a>            Lisp_Object c <span class="op">=</span> Faref <span class="op">(</span>last_macro<span class="op">,</span> make_fixnum <span class="op">(</span>i<span class="op">));</span></span>
<span id="cb160-42"><a aria-hidden="true" href="#cb160-42" tabindex="-1"></a>            current_kboard<span class="op">-&gt;</span>kbd_macro_buffer<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> c<span class="op">;</span></span>
<span id="cb160-43"><a aria-hidden="true" href="#cb160-43" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb160-44"><a aria-hidden="true" href="#cb160-44" tabindex="-1"></a></span>
<span id="cb160-45"><a aria-hidden="true" href="#cb160-45" tabindex="-1"></a>        current_kboard<span class="op">-&gt;</span>kbd_macro_ptr <span class="op">=</span></span>
<span id="cb160-46"><a aria-hidden="true" href="#cb160-46" tabindex="-1"></a>            current_kboard<span class="op">-&gt;</span>kbd_macro_buffer <span class="op">+</span> len<span class="op">;</span></span>
<span id="cb160-47"><a aria-hidden="true" href="#cb160-47" tabindex="-1"></a>        current_kboard<span class="op">-&gt;</span>kbd_macro_end <span class="op">=</span></span>
<span id="cb160-48"><a aria-hidden="true" href="#cb160-48" tabindex="-1"></a>            current_kboard<span class="op">-&gt;</span>kbd_macro_buffer <span class="op">+</span> len<span class="op">;</span></span>
<span id="cb160-49"><a aria-hidden="true" href="#cb160-49" tabindex="-1"></a></span>
<span id="cb160-50"><a aria-hidden="true" href="#cb160-50" tabindex="-1"></a>        message1 <span class="op">(</span><span class="st">"Appending to kbd macro..."</span><span class="op">);</span></span>
<span id="cb160-51"><a aria-hidden="true" href="#cb160-51" tabindex="-1"></a></span>
<span id="cb160-52"><a aria-hidden="true" href="#cb160-52" tabindex="-1"></a>        <span class="co">// Re-execute the macro if requested</span></span>
<span id="cb160-53"><a aria-hidden="true" href="#cb160-53" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>NILP <span class="op">(</span>no_exec<span class="op">))</span></span>
<span id="cb160-54"><a aria-hidden="true" href="#cb160-54" tabindex="-1"></a>            Fexecute_kbd_macro <span class="op">(</span>last_macro<span class="op">,</span> make_fixnum <span class="op">(</span><span class="dv">1</span><span class="op">),</span> Qnil<span class="op">);</span></span>
<span id="cb160-55"><a aria-hidden="true" href="#cb160-55" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb160-56"><a aria-hidden="true" href="#cb160-56" tabindex="-1"></a></span>
<span id="cb160-57"><a aria-hidden="true" href="#cb160-57" tabindex="-1"></a>    <span class="co">// Mark as defining</span></span>
<span id="cb160-58"><a aria-hidden="true" href="#cb160-58" tabindex="-1"></a>    kset_defining_kbd_macro <span class="op">(</span>current_kboard<span class="op">,</span> Qt<span class="op">);</span></span>
<span id="cb160-59"><a aria-hidden="true" href="#cb160-59" tabindex="-1"></a></span>
<span id="cb160-60"><a aria-hidden="true" href="#cb160-60" tabindex="-1"></a>    <span class="cf">return</span> Qnil<span class="op">;</span></span>
<span id="cb160-61"><a aria-hidden="true" href="#cb160-61" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>During Recording:</strong></p>
<p>When <code>defining_kbd_macro</code> is non-nil,
<code>command_loop_1</code> stores each command:</p>
<div class="sourceCode" id="cb161"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb161-1"><a aria-hidden="true" href="#cb161-1" tabindex="-1"></a><span class="co">// In command_loop_1():</span></span>
<span id="cb161-2"><a aria-hidden="true" href="#cb161-2" tabindex="-1"></a><span class="cf">if</span> <span class="op">(!</span>NILP <span class="op">(</span>KVAR <span class="op">(</span>current_kboard<span class="op">,</span> defining_kbd_macro<span class="op">)))</span></span>
<span id="cb161-3"><a aria-hidden="true" href="#cb161-3" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb161-4"><a aria-hidden="true" href="#cb161-4" tabindex="-1"></a>    <span class="co">// Grow buffer if needed</span></span>
<span id="cb161-5"><a aria-hidden="true" href="#cb161-5" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>current_kboard<span class="op">-&gt;</span>kbd_macro_ptr <span class="op">==</span></span>
<span id="cb161-6"><a aria-hidden="true" href="#cb161-6" tabindex="-1"></a>        current_kboard<span class="op">-&gt;</span>kbd_macro_buffer <span class="op">+</span></span>
<span id="cb161-7"><a aria-hidden="true" href="#cb161-7" tabindex="-1"></a>        current_kboard<span class="op">-&gt;</span>kbd_macro_bufsize<span class="op">)</span></span>
<span id="cb161-8"><a aria-hidden="true" href="#cb161-8" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb161-9"><a aria-hidden="true" href="#cb161-9" tabindex="-1"></a>        <span class="co">// Reallocate with more space</span></span>
<span id="cb161-10"><a aria-hidden="true" href="#cb161-10" tabindex="-1"></a>        <span class="dt">ptrdiff_t</span> size <span class="op">=</span> current_kboard<span class="op">-&gt;</span>kbd_macro_bufsize<span class="op">;</span></span>
<span id="cb161-11"><a aria-hidden="true" href="#cb161-11" tabindex="-1"></a>        current_kboard<span class="op">-&gt;</span>kbd_macro_buffer <span class="op">=</span></span>
<span id="cb161-12"><a aria-hidden="true" href="#cb161-12" tabindex="-1"></a>            xpalloc <span class="op">(</span>current_kboard<span class="op">-&gt;</span>kbd_macro_buffer<span class="op">,</span></span>
<span id="cb161-13"><a aria-hidden="true" href="#cb161-13" tabindex="-1"></a>                    <span class="op">&amp;</span>current_kboard<span class="op">-&gt;</span>kbd_macro_bufsize<span class="op">,</span></span>
<span id="cb161-14"><a aria-hidden="true" href="#cb161-14" tabindex="-1"></a>                    <span class="dv">1</span><span class="op">,</span> <span class="op">-</span><span class="dv">1</span><span class="op">,</span> <span class="kw">sizeof</span> <span class="op">*</span>current_kboard<span class="op">-&gt;</span>kbd_macro_buffer<span class="op">);</span></span>
<span id="cb161-15"><a aria-hidden="true" href="#cb161-15" tabindex="-1"></a></span>
<span id="cb161-16"><a aria-hidden="true" href="#cb161-16" tabindex="-1"></a>        <span class="co">// Update pointers</span></span>
<span id="cb161-17"><a aria-hidden="true" href="#cb161-17" tabindex="-1"></a>        current_kboard<span class="op">-&gt;</span>kbd_macro_ptr <span class="op">=</span></span>
<span id="cb161-18"><a aria-hidden="true" href="#cb161-18" tabindex="-1"></a>            current_kboard<span class="op">-&gt;</span>kbd_macro_buffer <span class="op">+</span> size<span class="op">;</span></span>
<span id="cb161-19"><a aria-hidden="true" href="#cb161-19" tabindex="-1"></a>        current_kboard<span class="op">-&gt;</span>kbd_macro_end <span class="op">=</span></span>
<span id="cb161-20"><a aria-hidden="true" href="#cb161-20" tabindex="-1"></a>            current_kboard<span class="op">-&gt;</span>kbd_macro_buffer <span class="op">+</span> size<span class="op">;</span></span>
<span id="cb161-21"><a aria-hidden="true" href="#cb161-21" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb161-22"><a aria-hidden="true" href="#cb161-22" tabindex="-1"></a></span>
<span id="cb161-23"><a aria-hidden="true" href="#cb161-23" tabindex="-1"></a>    <span class="co">// Store the key</span></span>
<span id="cb161-24"><a aria-hidden="true" href="#cb161-24" tabindex="-1"></a>    <span class="op">*</span>current_kboard<span class="op">-&gt;</span>kbd_macro_ptr<span class="op">++</span> <span class="op">=</span> key<span class="op">;</span></span>
<span id="cb161-25"><a aria-hidden="true" href="#cb161-25" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>End Recording:</strong> <code>end-kbd-macro</code> -
<code>src/macros.c:112-140</code></p>
<div class="sourceCode" id="cb162"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb162-1"><a aria-hidden="true" href="#cb162-1" tabindex="-1"></a>DEFUN <span class="op">(</span><span class="st">"end-kbd-macro"</span><span class="op">,</span> Fend_kbd_macro<span class="op">,</span> Send_kbd_macro<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="st">"p"</span><span class="op">,</span></span>
<span id="cb162-2"><a aria-hidden="true" href="#cb162-2" tabindex="-1"></a>       doc<span class="op">:</span> <span class="co">/* Finish defining a keyboard macro... */</span><span class="op">)</span></span>
<span id="cb162-3"><a aria-hidden="true" href="#cb162-3" tabindex="-1"></a>  <span class="op">(</span>Lisp_Object repeat<span class="op">,</span> Lisp_Object loopfunc<span class="op">)</span></span>
<span id="cb162-4"><a aria-hidden="true" href="#cb162-4" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb162-5"><a aria-hidden="true" href="#cb162-5" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>NILP <span class="op">(</span>KVAR <span class="op">(</span>current_kboard<span class="op">,</span> defining_kbd_macro<span class="op">)))</span></span>
<span id="cb162-6"><a aria-hidden="true" href="#cb162-6" tabindex="-1"></a>        error <span class="op">(</span><span class="st">"Not defining kbd macro"</span><span class="op">);</span></span>
<span id="cb162-7"><a aria-hidden="true" href="#cb162-7" tabindex="-1"></a></span>
<span id="cb162-8"><a aria-hidden="true" href="#cb162-8" tabindex="-1"></a>    <span class="co">// Finalize the macro</span></span>
<span id="cb162-9"><a aria-hidden="true" href="#cb162-9" tabindex="-1"></a>    kset_defining_kbd_macro <span class="op">(</span>current_kboard<span class="op">,</span> Qnil<span class="op">);</span></span>
<span id="cb162-10"><a aria-hidden="true" href="#cb162-10" tabindex="-1"></a>    update_mode_lines <span class="op">=</span> <span class="dv">20</span><span class="op">;</span></span>
<span id="cb162-11"><a aria-hidden="true" href="#cb162-11" tabindex="-1"></a></span>
<span id="cb162-12"><a aria-hidden="true" href="#cb162-12" tabindex="-1"></a>    <span class="co">// Move end pointer to exclude end-kbd-macro itself</span></span>
<span id="cb162-13"><a aria-hidden="true" href="#cb162-13" tabindex="-1"></a>    current_kboard<span class="op">-&gt;</span>kbd_macro_end <span class="op">=</span> current_kboard<span class="op">-&gt;</span>kbd_macro_ptr<span class="op">;</span></span>
<span id="cb162-14"><a aria-hidden="true" href="#cb162-14" tabindex="-1"></a></span>
<span id="cb162-15"><a aria-hidden="true" href="#cb162-15" tabindex="-1"></a>    <span class="co">// Create Lisp vector from recorded events</span></span>
<span id="cb162-16"><a aria-hidden="true" href="#cb162-16" tabindex="-1"></a>    <span class="dt">ptrdiff_t</span> len <span class="op">=</span> current_kboard<span class="op">-&gt;</span>kbd_macro_end <span class="op">-</span></span>
<span id="cb162-17"><a aria-hidden="true" href="#cb162-17" tabindex="-1"></a>                    current_kboard<span class="op">-&gt;</span>kbd_macro_buffer<span class="op">;</span></span>
<span id="cb162-18"><a aria-hidden="true" href="#cb162-18" tabindex="-1"></a>    Lisp_Object macro <span class="op">=</span> Fmake_vector <span class="op">(</span>make_fixnum <span class="op">(</span>len<span class="op">),</span> Qnil<span class="op">);</span></span>
<span id="cb162-19"><a aria-hidden="true" href="#cb162-19" tabindex="-1"></a></span>
<span id="cb162-20"><a aria-hidden="true" href="#cb162-20" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">ptrdiff_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> len<span class="op">;</span> i<span class="op">++)</span></span>
<span id="cb162-21"><a aria-hidden="true" href="#cb162-21" tabindex="-1"></a>        ASET <span class="op">(</span>macro<span class="op">,</span> i<span class="op">,</span> current_kboard<span class="op">-&gt;</span>kbd_macro_buffer<span class="op">[</span>i<span class="op">]);</span></span>
<span id="cb162-22"><a aria-hidden="true" href="#cb162-22" tabindex="-1"></a></span>
<span id="cb162-23"><a aria-hidden="true" href="#cb162-23" tabindex="-1"></a>    <span class="co">// Save as last-kbd-macro</span></span>
<span id="cb162-24"><a aria-hidden="true" href="#cb162-24" tabindex="-1"></a>    kset_last_kbd_macro <span class="op">(</span>current_kboard<span class="op">,</span> macro<span class="op">);</span></span>
<span id="cb162-25"><a aria-hidden="true" href="#cb162-25" tabindex="-1"></a></span>
<span id="cb162-26"><a aria-hidden="true" href="#cb162-26" tabindex="-1"></a>    message1 <span class="op">(</span><span class="st">"Keyboard macro defined"</span><span class="op">);</span></span>
<span id="cb162-27"><a aria-hidden="true" href="#cb162-27" tabindex="-1"></a></span>
<span id="cb162-28"><a aria-hidden="true" href="#cb162-28" tabindex="-1"></a>    <span class="co">// Execute if repeat count given</span></span>
<span id="cb162-29"><a aria-hidden="true" href="#cb162-29" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(!</span>NILP <span class="op">(</span>repeat<span class="op">))</span></span>
<span id="cb162-30"><a aria-hidden="true" href="#cb162-30" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb162-31"><a aria-hidden="true" href="#cb162-31" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>FIXNUMP <span class="op">(</span>repeat<span class="op">))</span></span>
<span id="cb162-32"><a aria-hidden="true" href="#cb162-32" tabindex="-1"></a>            <span class="cf">return</span> Fexecute_kbd_macro <span class="op">(</span>macro<span class="op">,</span> repeat<span class="op">,</span> loopfunc<span class="op">);</span></span>
<span id="cb162-33"><a aria-hidden="true" href="#cb162-33" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb162-34"><a aria-hidden="true" href="#cb162-34" tabindex="-1"></a></span>
<span id="cb162-35"><a aria-hidden="true" href="#cb162-35" tabindex="-1"></a>    <span class="cf">return</span> Qnil<span class="op">;</span></span>
<span id="cb162-36"><a aria-hidden="true" href="#cb162-36" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 data-number="8.9.2" id="executing-macros"><span class="header-section-number">8.9.2</span> Executing Macros</h3>
<p><strong>Execution:</strong> <code>execute-kbd-macro</code> -
<code>src/macros.c:240-330</code></p>
<div class="sourceCode" id="cb163"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb163-1"><a aria-hidden="true" href="#cb163-1" tabindex="-1"></a>DEFUN <span class="op">(</span><span class="st">"execute-kbd-macro"</span><span class="op">,</span> Fexecute_kbd_macro<span class="op">,</span> Sexecute_kbd_macro<span class="op">,</span></span>
<span id="cb163-2"><a aria-hidden="true" href="#cb163-2" tabindex="-1"></a>       <span class="dv">1</span><span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb163-3"><a aria-hidden="true" href="#cb163-3" tabindex="-1"></a>       doc<span class="op">:</span> <span class="co">/* Execute MACRO (a keyboard macro)... */</span><span class="op">)</span></span>
<span id="cb163-4"><a aria-hidden="true" href="#cb163-4" tabindex="-1"></a>  <span class="op">(</span>Lisp_Object macro<span class="op">,</span> Lisp_Object count<span class="op">,</span> Lisp_Object loopfunc<span class="op">)</span></span>
<span id="cb163-5"><a aria-hidden="true" href="#cb163-5" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb163-6"><a aria-hidden="true" href="#cb163-6" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>NILP <span class="op">(</span>count<span class="op">))</span></span>
<span id="cb163-7"><a aria-hidden="true" href="#cb163-7" tabindex="-1"></a>        count <span class="op">=</span> make_fixnum <span class="op">(</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb163-8"><a aria-hidden="true" href="#cb163-8" tabindex="-1"></a>    <span class="cf">else</span></span>
<span id="cb163-9"><a aria-hidden="true" href="#cb163-9" tabindex="-1"></a>        CHECK_FIXNUM <span class="op">(</span>count<span class="op">);</span></span>
<span id="cb163-10"><a aria-hidden="true" href="#cb163-10" tabindex="-1"></a></span>
<span id="cb163-11"><a aria-hidden="true" href="#cb163-11" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(!</span>STRINGP <span class="op">(</span>macro<span class="op">)</span> <span class="op">&amp;&amp;</span> <span class="op">!</span>VECTORP <span class="op">(</span>macro<span class="op">))</span></span>
<span id="cb163-12"><a aria-hidden="true" href="#cb163-12" tabindex="-1"></a>        error <span class="op">(</span><span class="st">"Keyboard macro must be string or vector"</span><span class="op">);</span></span>
<span id="cb163-13"><a aria-hidden="true" href="#cb163-13" tabindex="-1"></a></span>
<span id="cb163-14"><a aria-hidden="true" href="#cb163-14" tabindex="-1"></a>    <span class="co">// Save previous macro execution state</span></span>
<span id="cb163-15"><a aria-hidden="true" href="#cb163-15" tabindex="-1"></a>    Lisp_Object save_macro <span class="op">=</span> Vexecuting_kbd_macro<span class="op">;</span></span>
<span id="cb163-16"><a aria-hidden="true" href="#cb163-16" tabindex="-1"></a>    EMACS_INT save_index <span class="op">=</span> executing_kbd_macro_index<span class="op">;</span></span>
<span id="cb163-17"><a aria-hidden="true" href="#cb163-17" tabindex="-1"></a>    EMACS_INT save_iterations <span class="op">=</span> executing_kbd_macro_iterations<span class="op">;</span></span>
<span id="cb163-18"><a aria-hidden="true" href="#cb163-18" tabindex="-1"></a></span>
<span id="cb163-19"><a aria-hidden="true" href="#cb163-19" tabindex="-1"></a>    <span class="co">// Set up new macro execution</span></span>
<span id="cb163-20"><a aria-hidden="true" href="#cb163-20" tabindex="-1"></a>    Vexecuting_kbd_macro <span class="op">=</span> macro<span class="op">;</span></span>
<span id="cb163-21"><a aria-hidden="true" href="#cb163-21" tabindex="-1"></a>    executing_kbd_macro_index <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb163-22"><a aria-hidden="true" href="#cb163-22" tabindex="-1"></a>    executing_kbd_macro_iterations <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb163-23"><a aria-hidden="true" href="#cb163-23" tabindex="-1"></a></span>
<span id="cb163-24"><a aria-hidden="true" href="#cb163-24" tabindex="-1"></a>    <span class="co">// Execute COUNT times</span></span>
<span id="cb163-25"><a aria-hidden="true" href="#cb163-25" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span>EMACS_INT i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> XFIXNUM <span class="op">(</span>count<span class="op">);</span> i<span class="op">++)</span></span>
<span id="cb163-26"><a aria-hidden="true" href="#cb163-26" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb163-27"><a aria-hidden="true" href="#cb163-27" tabindex="-1"></a>        executing_kbd_macro_iterations <span class="op">=</span> i<span class="op">;</span></span>
<span id="cb163-28"><a aria-hidden="true" href="#cb163-28" tabindex="-1"></a></span>
<span id="cb163-29"><a aria-hidden="true" href="#cb163-29" tabindex="-1"></a>        <span class="co">// Reset to beginning</span></span>
<span id="cb163-30"><a aria-hidden="true" href="#cb163-30" tabindex="-1"></a>        executing_kbd_macro_index <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb163-31"><a aria-hidden="true" href="#cb163-31" tabindex="-1"></a></span>
<span id="cb163-32"><a aria-hidden="true" href="#cb163-32" tabindex="-1"></a>        <span class="co">// Command loop will read from Vexecuting_kbd_macro</span></span>
<span id="cb163-33"><a aria-hidden="true" href="#cb163-33" tabindex="-1"></a>        <span class="co">// instead of real input</span></span>
<span id="cb163-34"><a aria-hidden="true" href="#cb163-34" tabindex="-1"></a>        command_loop <span class="op">();</span></span>
<span id="cb163-35"><a aria-hidden="true" href="#cb163-35" tabindex="-1"></a></span>
<span id="cb163-36"><a aria-hidden="true" href="#cb163-36" tabindex="-1"></a>        <span class="co">// Call loop function if provided</span></span>
<span id="cb163-37"><a aria-hidden="true" href="#cb163-37" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(!</span>NILP <span class="op">(</span>loopfunc<span class="op">))</span></span>
<span id="cb163-38"><a aria-hidden="true" href="#cb163-38" tabindex="-1"></a>            call0 <span class="op">(</span>loopfunc<span class="op">);</span></span>
<span id="cb163-39"><a aria-hidden="true" href="#cb163-39" tabindex="-1"></a></span>
<span id="cb163-40"><a aria-hidden="true" href="#cb163-40" tabindex="-1"></a>        <span class="co">// Check for quit</span></span>
<span id="cb163-41"><a aria-hidden="true" href="#cb163-41" tabindex="-1"></a>        maybe_quit <span class="op">();</span></span>
<span id="cb163-42"><a aria-hidden="true" href="#cb163-42" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb163-43"><a aria-hidden="true" href="#cb163-43" tabindex="-1"></a></span>
<span id="cb163-44"><a aria-hidden="true" href="#cb163-44" tabindex="-1"></a>    <span class="co">// Restore previous state</span></span>
<span id="cb163-45"><a aria-hidden="true" href="#cb163-45" tabindex="-1"></a>    Vexecuting_kbd_macro <span class="op">=</span> save_macro<span class="op">;</span></span>
<span id="cb163-46"><a aria-hidden="true" href="#cb163-46" tabindex="-1"></a>    executing_kbd_macro_index <span class="op">=</span> save_index<span class="op">;</span></span>
<span id="cb163-47"><a aria-hidden="true" href="#cb163-47" tabindex="-1"></a>    executing_kbd_macro_iterations <span class="op">=</span> save_iterations<span class="op">;</span></span>
<span id="cb163-48"><a aria-hidden="true" href="#cb163-48" tabindex="-1"></a></span>
<span id="cb163-49"><a aria-hidden="true" href="#cb163-49" tabindex="-1"></a>    <span class="cf">return</span> Qnil<span class="op">;</span></span>
<span id="cb163-50"><a aria-hidden="true" href="#cb163-50" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>Macro Playback:</strong></p>
<p>During macro execution, <code>read_char</code> checks:</p>
<div class="sourceCode" id="cb164"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb164-1"><a aria-hidden="true" href="#cb164-1" tabindex="-1"></a><span class="co">// In read_char():</span></span>
<span id="cb164-2"><a aria-hidden="true" href="#cb164-2" tabindex="-1"></a><span class="cf">if</span> <span class="op">(!</span>NILP <span class="op">(</span>Vexecuting_kbd_macro<span class="op">)</span> <span class="op">&amp;&amp;</span> <span class="op">!</span>at_end_of_macro_p <span class="op">())</span></span>
<span id="cb164-3"><a aria-hidden="true" href="#cb164-3" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb164-4"><a aria-hidden="true" href="#cb164-4" tabindex="-1"></a>    <span class="co">// Read from macro instead of real input</span></span>
<span id="cb164-5"><a aria-hidden="true" href="#cb164-5" tabindex="-1"></a>    Vlast_event_frame <span class="op">=</span> internal_last_event_frame <span class="op">=</span> Qmacro<span class="op">;</span></span>
<span id="cb164-6"><a aria-hidden="true" href="#cb164-6" tabindex="-1"></a></span>
<span id="cb164-7"><a aria-hidden="true" href="#cb164-7" tabindex="-1"></a>    c <span class="op">=</span> Faref <span class="op">(</span>Vexecuting_kbd_macro<span class="op">,</span></span>
<span id="cb164-8"><a aria-hidden="true" href="#cb164-8" tabindex="-1"></a>              make_int <span class="op">(</span>executing_kbd_macro_index<span class="op">));</span></span>
<span id="cb164-9"><a aria-hidden="true" href="#cb164-9" tabindex="-1"></a></span>
<span id="cb164-10"><a aria-hidden="true" href="#cb164-10" tabindex="-1"></a>    <span class="co">// Handle meta modifier in string macros</span></span>
<span id="cb164-11"><a aria-hidden="true" href="#cb164-11" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>STRINGP <span class="op">(</span>Vexecuting_kbd_macro<span class="op">)</span></span>
<span id="cb164-12"><a aria-hidden="true" href="#cb164-12" tabindex="-1"></a>        <span class="op">&amp;&amp;</span> <span class="op">(</span>XFIXNAT <span class="op">(</span>c<span class="op">)</span> <span class="op">&amp;</span> <span class="bn">0x80</span><span class="op">)</span> <span class="op">&amp;&amp;</span> <span class="op">(</span>XFIXNAT <span class="op">(</span>c<span class="op">)</span> <span class="op">&lt;=</span> <span class="bn">0xff</span><span class="op">))</span></span>
<span id="cb164-13"><a aria-hidden="true" href="#cb164-13" tabindex="-1"></a>        XSETFASTINT <span class="op">(</span>c<span class="op">,</span> CHAR_META <span class="op">|</span> <span class="op">(</span>XFIXNAT <span class="op">(</span>c<span class="op">)</span> <span class="op">&amp;</span> <span class="op">~</span><span class="bn">0x80</span><span class="op">));</span></span>
<span id="cb164-14"><a aria-hidden="true" href="#cb164-14" tabindex="-1"></a></span>
<span id="cb164-15"><a aria-hidden="true" href="#cb164-15" tabindex="-1"></a>    executing_kbd_macro_index<span class="op">++;</span></span>
<span id="cb164-16"><a aria-hidden="true" href="#cb164-16" tabindex="-1"></a>    <span class="cf">goto</span> from_macro<span class="op">;</span></span>
<span id="cb164-17"><a aria-hidden="true" href="#cb164-17" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2 data-number="8.10" id="special-event-types"><span class="header-section-number">8.10</span> Special Event Types</h2>
<h3 data-number="8.10.1" id="mouse-events"><span class="header-section-number">8.10.1</span> 1. Mouse Events</h3>
<p><strong>Structure:</strong> Mouse events are lists:</p>
<div class="sourceCode" id="cb165"><pre class="sourceCode lisp"><code class="sourceCode commonlisp"><span id="cb165-1"><a aria-hidden="true" href="#cb165-1" tabindex="-1"></a>(EVENT-TYPE              <span class="co">; e.g., mouse-1, mouse-2, mouse-3</span></span>
<span id="cb165-2"><a aria-hidden="true" href="#cb165-2" tabindex="-1"></a> POSITION)               <span class="co">; Position descriptor</span></span>
<span id="cb165-3"><a aria-hidden="true" href="#cb165-3" tabindex="-1"></a></span>
<span id="cb165-4"><a aria-hidden="true" href="#cb165-4" tabindex="-1"></a>POSITION:</span>
<span id="cb165-5"><a aria-hidden="true" href="#cb165-5" tabindex="-1"></a>(WINDOW                  <span class="co">; Window of event</span></span>
<span id="cb165-6"><a aria-hidden="true" href="#cb165-6" tabindex="-1"></a> AREA-OR-POS             <span class="co">; Text area or (X . Y) in chars</span></span>
<span id="cb165-7"><a aria-hidden="true" href="#cb165-7" tabindex="-1"></a> (X . Y)                 <span class="co">; Pixel coordinates</span></span>
<span id="cb165-8"><a aria-hidden="true" href="#cb165-8" tabindex="-1"></a> TIMESTAMP               <span class="co">; Time in milliseconds</span></span>
<span id="cb165-9"><a aria-hidden="true" href="#cb165-9" tabindex="-1"></a> OBJECT                  <span class="co">; String/image/nil</span></span>
<span id="cb165-10"><a aria-hidden="true" href="#cb165-10" tabindex="-1"></a> TEXT-POS                <span class="co">; Buffer/string position</span></span>
<span id="cb165-11"><a aria-hidden="true" href="#cb165-11" tabindex="-1"></a> (COL . ROW)             <span class="co">; Column and row</span></span>
<span id="cb165-12"><a aria-hidden="true" href="#cb165-12" tabindex="-1"></a> IMAGE)                  <span class="co">; Image description if on image</span></span></code></pre></div>
<p><strong>Example:</strong></p>
<div class="sourceCode" id="cb166"><pre class="sourceCode lisp"><code class="sourceCode commonlisp"><span id="cb166-1"><a aria-hidden="true" href="#cb166-1" tabindex="-1"></a>(mouse-1</span>
<span id="cb166-2"><a aria-hidden="true" href="#cb166-2" tabindex="-1"></a> (#&lt;window <span class="dv">3</span> on *scratch*&gt;</span>
<span id="cb166-3"><a aria-hidden="true" href="#cb166-3" tabindex="-1"></a>  <span class="dv">50</span>                     <span class="co">; Character position</span></span>
<span id="cb166-4"><a aria-hidden="true" href="#cb166-4" tabindex="-1"></a>  (<span class="dv">30</span> . <span class="dv">100</span>)            <span class="co">; Pixel position</span></span>
<span id="cb166-5"><a aria-hidden="true" href="#cb166-5" tabindex="-1"></a>  <span class="dv">123456</span>                <span class="co">; Timestamp</span></span>
<span id="cb166-6"><a aria-hidden="true" href="#cb166-6" tabindex="-1"></a>  <span class="kw">nil</span>                   <span class="co">; Not on string/image</span></span>
<span id="cb166-7"><a aria-hidden="true" href="#cb166-7" tabindex="-1"></a>  <span class="dv">50</span>                    <span class="co">; Buffer position</span></span>
<span id="cb166-8"><a aria-hidden="true" href="#cb166-8" tabindex="-1"></a>  (<span class="dv">5</span> . <span class="dv">10</span>)              <span class="co">; Column 5, row 10</span></span>
<span id="cb166-9"><a aria-hidden="true" href="#cb166-9" tabindex="-1"></a>  <span class="kw">nil</span>))                 <span class="co">; No image</span></span></code></pre></div>
<p><strong>Mouse Event Processing:</strong></p>
<div class="sourceCode" id="cb167"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb167-1"><a aria-hidden="true" href="#cb167-1" tabindex="-1"></a><span class="co">// When terminal code detects mouse click:</span></span>
<span id="cb167-2"><a aria-hidden="true" href="#cb167-2" tabindex="-1"></a><span class="dt">void</span></span>
<span id="cb167-3"><a aria-hidden="true" href="#cb167-3" tabindex="-1"></a>make_mouse_event <span class="op">(</span><span class="dt">int</span> x<span class="op">,</span> <span class="dt">int</span> y<span class="op">,</span> <span class="dt">int</span> button<span class="op">,</span> <span class="dt">int</span> modifiers<span class="op">)</span></span>
<span id="cb167-4"><a aria-hidden="true" href="#cb167-4" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb167-5"><a aria-hidden="true" href="#cb167-5" tabindex="-1"></a>    <span class="kw">struct</span> input_event event<span class="op">;</span></span>
<span id="cb167-6"><a aria-hidden="true" href="#cb167-6" tabindex="-1"></a></span>
<span id="cb167-7"><a aria-hidden="true" href="#cb167-7" tabindex="-1"></a>    event<span class="op">.</span>kind <span class="op">=</span> MOUSE_CLICK_EVENT<span class="op">;</span></span>
<span id="cb167-8"><a aria-hidden="true" href="#cb167-8" tabindex="-1"></a>    event<span class="op">.</span>code <span class="op">=</span> button<span class="op">;</span>  <span class="co">// 0=mouse-1, 1=mouse-2, 2=mouse-3</span></span>
<span id="cb167-9"><a aria-hidden="true" href="#cb167-9" tabindex="-1"></a>    event<span class="op">.</span>modifiers <span class="op">=</span> modifiers<span class="op">;</span>  <span class="co">// shift, control, meta, etc.</span></span>
<span id="cb167-10"><a aria-hidden="true" href="#cb167-10" tabindex="-1"></a>    event<span class="op">.</span>x <span class="op">=</span> x<span class="op">;</span></span>
<span id="cb167-11"><a aria-hidden="true" href="#cb167-11" tabindex="-1"></a>    event<span class="op">.</span>y <span class="op">=</span> y<span class="op">;</span></span>
<span id="cb167-12"><a aria-hidden="true" href="#cb167-12" tabindex="-1"></a>    event<span class="op">.</span>frame_or_window <span class="op">=</span> selected_frame<span class="op">;</span></span>
<span id="cb167-13"><a aria-hidden="true" href="#cb167-13" tabindex="-1"></a>    event<span class="op">.</span>timestamp <span class="op">=</span> current_time_ms <span class="op">();</span></span>
<span id="cb167-14"><a aria-hidden="true" href="#cb167-14" tabindex="-1"></a>    event<span class="op">.</span>arg <span class="op">=</span> Qnil<span class="op">;</span></span>
<span id="cb167-15"><a aria-hidden="true" href="#cb167-15" tabindex="-1"></a></span>
<span id="cb167-16"><a aria-hidden="true" href="#cb167-16" tabindex="-1"></a>    kbd_buffer_store_event <span class="op">(&amp;</span>event<span class="op">);</span></span>
<span id="cb167-17"><a aria-hidden="true" href="#cb167-17" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>Converting to Lisp:</strong></p>
<div class="sourceCode" id="cb168"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb168-1"><a aria-hidden="true" href="#cb168-1" tabindex="-1"></a>Lisp_Object</span>
<span id="cb168-2"><a aria-hidden="true" href="#cb168-2" tabindex="-1"></a>make_lispy_event <span class="op">(</span><span class="kw">struct</span> input_event <span class="op">*</span>event<span class="op">)</span></span>
<span id="cb168-3"><a aria-hidden="true" href="#cb168-3" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb168-4"><a aria-hidden="true" href="#cb168-4" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>event<span class="op">-&gt;</span>kind <span class="op">==</span> MOUSE_CLICK_EVENT<span class="op">)</span></span>
<span id="cb168-5"><a aria-hidden="true" href="#cb168-5" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb168-6"><a aria-hidden="true" href="#cb168-6" tabindex="-1"></a>        <span class="co">// Determine window and position</span></span>
<span id="cb168-7"><a aria-hidden="true" href="#cb168-7" tabindex="-1"></a>        Lisp_Object window <span class="op">=</span> window_from_coordinates <span class="op">(</span></span>
<span id="cb168-8"><a aria-hidden="true" href="#cb168-8" tabindex="-1"></a>            XFRAME <span class="op">(</span>event<span class="op">-&gt;</span>frame_or_window<span class="op">),</span></span>
<span id="cb168-9"><a aria-hidden="true" href="#cb168-9" tabindex="-1"></a>            event<span class="op">-&gt;</span>x<span class="op">,</span> event<span class="op">-&gt;</span>y<span class="op">,</span> <span class="op">...);</span></span>
<span id="cb168-10"><a aria-hidden="true" href="#cb168-10" tabindex="-1"></a></span>
<span id="cb168-11"><a aria-hidden="true" href="#cb168-11" tabindex="-1"></a>        Lisp_Object position <span class="op">=</span> make_lispy_position <span class="op">(</span></span>
<span id="cb168-12"><a aria-hidden="true" href="#cb168-12" tabindex="-1"></a>            window<span class="op">,</span> event<span class="op">-&gt;</span>x<span class="op">,</span> event<span class="op">-&gt;</span>y<span class="op">,</span> event<span class="op">-&gt;</span>timestamp<span class="op">);</span></span>
<span id="cb168-13"><a aria-hidden="true" href="#cb168-13" tabindex="-1"></a></span>
<span id="cb168-14"><a aria-hidden="true" href="#cb168-14" tabindex="-1"></a>        <span class="co">// Build event list: (mouse-N POSITION)</span></span>
<span id="cb168-15"><a aria-hidden="true" href="#cb168-15" tabindex="-1"></a>        Lisp_Object head <span class="op">=</span> intern <span class="op">(</span>mouse_button_names<span class="op">[</span>event<span class="op">-&gt;</span>code<span class="op">]);</span></span>
<span id="cb168-16"><a aria-hidden="true" href="#cb168-16" tabindex="-1"></a>        head <span class="op">=</span> apply_modifiers <span class="op">(</span>event<span class="op">-&gt;</span>modifiers<span class="op">,</span> head<span class="op">);</span></span>
<span id="cb168-17"><a aria-hidden="true" href="#cb168-17" tabindex="-1"></a></span>
<span id="cb168-18"><a aria-hidden="true" href="#cb168-18" tabindex="-1"></a>        <span class="cf">return</span> list2 <span class="op">(</span>head<span class="op">,</span> position<span class="op">);</span></span>
<span id="cb168-19"><a aria-hidden="true" href="#cb168-19" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb168-20"><a aria-hidden="true" href="#cb168-20" tabindex="-1"></a>    <span class="op">...</span></span>
<span id="cb168-21"><a aria-hidden="true" href="#cb168-21" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 data-number="8.10.2" id="menu-events"><span class="header-section-number">8.10.2</span> 2. Menu Events</h3>
<p><strong>Menu Bar Event:</strong></p>
<div class="sourceCode" id="cb169"><pre class="sourceCode lisp"><code class="sourceCode commonlisp"><span id="cb169-1"><a aria-hidden="true" href="#cb169-1" tabindex="-1"></a>(menu-bar               <span class="co">; Event type</span></span>
<span id="cb169-2"><a aria-hidden="true" href="#cb169-2" tabindex="-1"></a> (FILE                 <span class="co">; Menu name</span></span>
<span id="cb169-3"><a aria-hidden="true" href="#cb169-3" tabindex="-1"></a>  open-file))          <span class="co">; Menu item</span></span></code></pre></div>
<p><strong>Tool Bar Event:</strong></p>
<div class="sourceCode" id="cb170"><pre class="sourceCode lisp"><code class="sourceCode commonlisp"><span id="cb170-1"><a aria-hidden="true" href="#cb170-1" tabindex="-1"></a>(tool-bar               <span class="co">; Event type</span></span>
<span id="cb170-2"><a aria-hidden="true" href="#cb170-2" tabindex="-1"></a> save-buffer)          <span class="co">; Tool item</span></span></code></pre></div>
<p><strong>Processing:</strong></p>
<p>When user clicks menu bar, terminal code generates:</p>
<div class="sourceCode" id="cb171"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb171-1"><a aria-hidden="true" href="#cb171-1" tabindex="-1"></a>event<span class="op">.</span>kind <span class="op">=</span> MENU_BAR_EVENT<span class="op">;</span></span>
<span id="cb171-2"><a aria-hidden="true" href="#cb171-2" tabindex="-1"></a>event<span class="op">.</span>arg <span class="op">=</span> menu_item_selection<span class="op">;</span>  <span class="co">// Lisp list: (MENU ITEM)</span></span>
<span id="cb171-3"><a aria-hidden="true" href="#cb171-3" tabindex="-1"></a>event<span class="op">.</span>frame_or_window <span class="op">=</span> frame<span class="op">;</span></span></code></pre></div>
<p>In <code>read_key_sequence</code>, menu events are expanded to key
sequences:</p>
<div class="sourceCode" id="cb172"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb172-1"><a aria-hidden="true" href="#cb172-1" tabindex="-1"></a><span class="cf">if</span> <span class="op">(</span>EVENT_KIND <span class="op">(</span>key<span class="op">)</span> <span class="op">==</span> menu<span class="op">-</span>bar<span class="op">)</span></span>
<span id="cb172-2"><a aria-hidden="true" href="#cb172-2" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb172-3"><a aria-hidden="true" href="#cb172-3" tabindex="-1"></a>    <span class="co">// Expand to equivalent key sequence</span></span>
<span id="cb172-4"><a aria-hidden="true" href="#cb172-4" tabindex="-1"></a>    <span class="co">// E.g., (menu-bar file open) ‚Üí [menu-bar file open]</span></span>
<span id="cb172-5"><a aria-hidden="true" href="#cb172-5" tabindex="-1"></a>    key <span class="op">=</span> expand_menu_event <span class="op">(</span>key<span class="op">);</span></span>
<span id="cb172-6"><a aria-hidden="true" href="#cb172-6" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 data-number="8.10.3" id="drag-and-drop-events"><span class="header-section-number">8.10.3</span> 3. Drag and Drop Events</h3>
<p><strong>Structure:</strong></p>
<div class="sourceCode" id="cb173"><pre class="sourceCode lisp"><code class="sourceCode commonlisp"><span id="cb173-1"><a aria-hidden="true" href="#cb173-1" tabindex="-1"></a>(drag-n-drop</span>
<span id="cb173-2"><a aria-hidden="true" href="#cb173-2" tabindex="-1"></a> POSITION              <span class="co">; Where files were dropped</span></span>
<span id="cb173-3"><a aria-hidden="true" href="#cb173-3" tabindex="-1"></a> FILES)                <span class="co">; List of file names</span></span></code></pre></div>
<p><strong>Example:</strong></p>
<div class="sourceCode" id="cb174"><pre class="sourceCode lisp"><code class="sourceCode commonlisp"><span id="cb174-1"><a aria-hidden="true" href="#cb174-1" tabindex="-1"></a>(drag-n-drop</span>
<span id="cb174-2"><a aria-hidden="true" href="#cb174-2" tabindex="-1"></a> (#&lt;window <span class="dv">3</span> on *scratch*&gt; ...)</span>
<span id="cb174-3"><a aria-hidden="true" href="#cb174-3" tabindex="-1"></a> (<span class="st">"/home/user/file1.txt"</span> <span class="st">"/home/user/file2.c"</span>))</span></code></pre></div>
<h3 data-number="8.10.4" id="touch-screen-events-modern-emacs"><span class="header-section-number">8.10.4</span> 4. Touch Screen Events
(Modern Emacs)</h3>
<p><strong>Touch Begin:</strong></p>
<div class="sourceCode" id="cb175"><pre class="sourceCode lisp"><code class="sourceCode commonlisp"><span id="cb175-1"><a aria-hidden="true" href="#cb175-1" tabindex="-1"></a>(touchscreen-begin</span>
<span id="cb175-2"><a aria-hidden="true" href="#cb175-2" tabindex="-1"></a> POSITION              <span class="co">; Touch position</span></span>
<span id="cb175-3"><a aria-hidden="true" href="#cb175-3" tabindex="-1"></a> TOOL-ID)              <span class="co">; Unique touch identifier</span></span></code></pre></div>
<p><strong>Touch End:</strong></p>
<div class="sourceCode" id="cb176"><pre class="sourceCode lisp"><code class="sourceCode commonlisp"><span id="cb176-1"><a aria-hidden="true" href="#cb176-1" tabindex="-1"></a>(touchscreen-end</span>
<span id="cb176-2"><a aria-hidden="true" href="#cb176-2" tabindex="-1"></a> POSITION</span>
<span id="cb176-3"><a aria-hidden="true" href="#cb176-3" tabindex="-1"></a> TOOL-ID)</span></code></pre></div>
<h2 data-number="8.11" id="multi-keyboard-support"><span class="header-section-number">8.11</span> Multi-Keyboard Support</h2>
<h3 data-number="8.11.1" id="kboard-management"><span class="header-section-number">8.11.1</span> KBOARD Management</h3>
<p><strong>Initialization:</strong>
<code>src/keyboard.c:12900+</code></p>
<div class="sourceCode" id="cb177"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb177-1"><a aria-hidden="true" href="#cb177-1" tabindex="-1"></a>KBOARD <span class="op">*</span></span>
<span id="cb177-2"><a aria-hidden="true" href="#cb177-2" tabindex="-1"></a>allocate_kboard <span class="op">(</span>Lisp_Object type<span class="op">)</span></span>
<span id="cb177-3"><a aria-hidden="true" href="#cb177-3" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb177-4"><a aria-hidden="true" href="#cb177-4" tabindex="-1"></a>    KBOARD <span class="op">*</span>kb <span class="op">=</span> xzalloc <span class="op">(</span><span class="kw">sizeof</span> <span class="op">*</span>kb<span class="op">);</span></span>
<span id="cb177-5"><a aria-hidden="true" href="#cb177-5" tabindex="-1"></a></span>
<span id="cb177-6"><a aria-hidden="true" href="#cb177-6" tabindex="-1"></a>    <span class="co">// Initialize Lisp fields</span></span>
<span id="cb177-7"><a aria-hidden="true" href="#cb177-7" tabindex="-1"></a>    kset_default_minibuffer_frame <span class="op">(</span>kb<span class="op">,</span> Qnil<span class="op">);</span></span>
<span id="cb177-8"><a aria-hidden="true" href="#cb177-8" tabindex="-1"></a>    kset_last_command <span class="op">(</span>kb<span class="op">,</span> Qnil<span class="op">);</span></span>
<span id="cb177-9"><a aria-hidden="true" href="#cb177-9" tabindex="-1"></a>    kset_real_last_command <span class="op">(</span>kb<span class="op">,</span> Qnil<span class="op">);</span></span>
<span id="cb177-10"><a aria-hidden="true" href="#cb177-10" tabindex="-1"></a>    kset_keyboard_translate_table <span class="op">(</span>kb<span class="op">,</span> Qnil<span class="op">);</span></span>
<span id="cb177-11"><a aria-hidden="true" href="#cb177-11" tabindex="-1"></a>    kset_prefix_arg <span class="op">(</span>kb<span class="op">,</span> Qnil<span class="op">);</span></span>
<span id="cb177-12"><a aria-hidden="true" href="#cb177-12" tabindex="-1"></a>    kset_last_prefix_arg <span class="op">(</span>kb<span class="op">,</span> Qnil<span class="op">);</span></span>
<span id="cb177-13"><a aria-hidden="true" href="#cb177-13" tabindex="-1"></a>    kset_kbd_queue <span class="op">(</span>kb<span class="op">,</span> Qnil<span class="op">);</span></span>
<span id="cb177-14"><a aria-hidden="true" href="#cb177-14" tabindex="-1"></a>    kset_defining_kbd_macro <span class="op">(</span>kb<span class="op">,</span> Qnil<span class="op">);</span></span>
<span id="cb177-15"><a aria-hidden="true" href="#cb177-15" tabindex="-1"></a>    kset_last_kbd_macro <span class="op">(</span>kb<span class="op">,</span> Qnil<span class="op">);</span></span>
<span id="cb177-16"><a aria-hidden="true" href="#cb177-16" tabindex="-1"></a>    kset_system_key_alist <span class="op">(</span>kb<span class="op">,</span> Qnil<span class="op">);</span></span>
<span id="cb177-17"><a aria-hidden="true" href="#cb177-17" tabindex="-1"></a>    kset_window_system <span class="op">(</span>kb<span class="op">,</span> type<span class="op">);</span></span>
<span id="cb177-18"><a aria-hidden="true" href="#cb177-18" tabindex="-1"></a></span>
<span id="cb177-19"><a aria-hidden="true" href="#cb177-19" tabindex="-1"></a>    <span class="co">// Initialize keymaps</span></span>
<span id="cb177-20"><a aria-hidden="true" href="#cb177-20" tabindex="-1"></a>    kset_local_function_key_map <span class="op">(</span>kb<span class="op">,</span> Fmake_sparse_keymap <span class="op">(</span>Qnil<span class="op">));</span></span>
<span id="cb177-21"><a aria-hidden="true" href="#cb177-21" tabindex="-1"></a>    Fset_keymap_parent <span class="op">(</span>KVAR <span class="op">(</span>kb<span class="op">,</span> Vlocal_function_key_map<span class="op">),</span></span>
<span id="cb177-22"><a aria-hidden="true" href="#cb177-22" tabindex="-1"></a>                       Vfunction_key_map<span class="op">);</span></span>
<span id="cb177-23"><a aria-hidden="true" href="#cb177-23" tabindex="-1"></a></span>
<span id="cb177-24"><a aria-hidden="true" href="#cb177-24" tabindex="-1"></a>    kset_input_decode_map <span class="op">(</span>kb<span class="op">,</span> Fmake_sparse_keymap <span class="op">(</span>Qnil<span class="op">));</span></span>
<span id="cb177-25"><a aria-hidden="true" href="#cb177-25" tabindex="-1"></a></span>
<span id="cb177-26"><a aria-hidden="true" href="#cb177-26" tabindex="-1"></a>    <span class="co">// Initialize echo state</span></span>
<span id="cb177-27"><a aria-hidden="true" href="#cb177-27" tabindex="-1"></a>    kset_echo_string <span class="op">(</span>kb<span class="op">,</span> Qnil<span class="op">);</span></span>
<span id="cb177-28"><a aria-hidden="true" href="#cb177-28" tabindex="-1"></a>    kset_echo_prompt <span class="op">(</span>kb<span class="op">,</span> Qnil<span class="op">);</span></span>
<span id="cb177-29"><a aria-hidden="true" href="#cb177-29" tabindex="-1"></a>    kb<span class="op">-&gt;</span>echo_after_prompt <span class="op">=</span> <span class="op">-</span><span class="dv">1</span><span class="op">;</span></span>
<span id="cb177-30"><a aria-hidden="true" href="#cb177-30" tabindex="-1"></a></span>
<span id="cb177-31"><a aria-hidden="true" href="#cb177-31" tabindex="-1"></a>    <span class="co">// No macro buffer yet</span></span>
<span id="cb177-32"><a aria-hidden="true" href="#cb177-32" tabindex="-1"></a>    kb<span class="op">-&gt;</span>kbd_macro_buffer <span class="op">=</span> NULL<span class="op">;</span></span>
<span id="cb177-33"><a aria-hidden="true" href="#cb177-33" tabindex="-1"></a>    kb<span class="op">-&gt;</span>kbd_macro_bufsize <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb177-34"><a aria-hidden="true" href="#cb177-34" tabindex="-1"></a></span>
<span id="cb177-35"><a aria-hidden="true" href="#cb177-35" tabindex="-1"></a>    kb<span class="op">-&gt;</span>reference_count <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb177-36"><a aria-hidden="true" href="#cb177-36" tabindex="-1"></a>    kb<span class="op">-&gt;</span>kbd_queue_has_data <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb177-37"><a aria-hidden="true" href="#cb177-37" tabindex="-1"></a>    kb<span class="op">-&gt;</span>immediate_echo <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb177-38"><a aria-hidden="true" href="#cb177-38" tabindex="-1"></a></span>
<span id="cb177-39"><a aria-hidden="true" href="#cb177-39" tabindex="-1"></a>    <span class="co">// Add to global list</span></span>
<span id="cb177-40"><a aria-hidden="true" href="#cb177-40" tabindex="-1"></a>    kb<span class="op">-&gt;</span>next_kboard <span class="op">=</span> all_kboards<span class="op">;</span></span>
<span id="cb177-41"><a aria-hidden="true" href="#cb177-41" tabindex="-1"></a>    all_kboards <span class="op">=</span> kb<span class="op">;</span></span>
<span id="cb177-42"><a aria-hidden="true" href="#cb177-42" tabindex="-1"></a></span>
<span id="cb177-43"><a aria-hidden="true" href="#cb177-43" tabindex="-1"></a>    <span class="cf">return</span> kb<span class="op">;</span></span>
<span id="cb177-44"><a aria-hidden="true" href="#cb177-44" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>Switching KBOARDs:</strong></p>
<div class="sourceCode" id="cb178"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb178-1"><a aria-hidden="true" href="#cb178-1" tabindex="-1"></a><span class="dt">void</span></span>
<span id="cb178-2"><a aria-hidden="true" href="#cb178-2" tabindex="-1"></a>push_kboard <span class="op">(</span><span class="kw">struct</span> kboard <span class="op">*</span>kb<span class="op">)</span></span>
<span id="cb178-3"><a aria-hidden="true" href="#cb178-3" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb178-4"><a aria-hidden="true" href="#cb178-4" tabindex="-1"></a>    <span class="co">// Save current kboard</span></span>
<span id="cb178-5"><a aria-hidden="true" href="#cb178-5" tabindex="-1"></a>    <span class="kw">struct</span> kboard_stack <span class="op">*</span>p <span class="op">=</span> xmalloc <span class="op">(</span><span class="kw">sizeof</span> <span class="op">*</span>p<span class="op">);</span></span>
<span id="cb178-6"><a aria-hidden="true" href="#cb178-6" tabindex="-1"></a>    p<span class="op">-&gt;</span>kboard <span class="op">=</span> current_kboard<span class="op">;</span></span>
<span id="cb178-7"><a aria-hidden="true" href="#cb178-7" tabindex="-1"></a>    p<span class="op">-&gt;</span>next <span class="op">=</span> kboard_stack<span class="op">;</span></span>
<span id="cb178-8"><a aria-hidden="true" href="#cb178-8" tabindex="-1"></a>    kboard_stack <span class="op">=</span> p<span class="op">;</span></span>
<span id="cb178-9"><a aria-hidden="true" href="#cb178-9" tabindex="-1"></a></span>
<span id="cb178-10"><a aria-hidden="true" href="#cb178-10" tabindex="-1"></a>    <span class="co">// Switch to new kboard</span></span>
<span id="cb178-11"><a aria-hidden="true" href="#cb178-11" tabindex="-1"></a>    current_kboard <span class="op">=</span> kb<span class="op">;</span></span>
<span id="cb178-12"><a aria-hidden="true" href="#cb178-12" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb178-13"><a aria-hidden="true" href="#cb178-13" tabindex="-1"></a></span>
<span id="cb178-14"><a aria-hidden="true" href="#cb178-14" tabindex="-1"></a><span class="dt">void</span></span>
<span id="cb178-15"><a aria-hidden="true" href="#cb178-15" tabindex="-1"></a>pop_kboard <span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb178-16"><a aria-hidden="true" href="#cb178-16" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb178-17"><a aria-hidden="true" href="#cb178-17" tabindex="-1"></a>    <span class="kw">struct</span> kboard_stack <span class="op">*</span>p <span class="op">=</span> kboard_stack<span class="op">;</span></span>
<span id="cb178-18"><a aria-hidden="true" href="#cb178-18" tabindex="-1"></a></span>
<span id="cb178-19"><a aria-hidden="true" href="#cb178-19" tabindex="-1"></a>    <span class="co">// Restore previous kboard</span></span>
<span id="cb178-20"><a aria-hidden="true" href="#cb178-20" tabindex="-1"></a>    current_kboard <span class="op">=</span> p<span class="op">-&gt;</span>kboard<span class="op">;</span></span>
<span id="cb178-21"><a aria-hidden="true" href="#cb178-21" tabindex="-1"></a>    kboard_stack <span class="op">=</span> p<span class="op">-&gt;</span>next<span class="op">;</span></span>
<span id="cb178-22"><a aria-hidden="true" href="#cb178-22" tabindex="-1"></a>    xfree <span class="op">(</span>p<span class="op">);</span></span>
<span id="cb178-23"><a aria-hidden="true" href="#cb178-23" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>Single vs Any-KBOARD Mode:</strong></p>
<div class="sourceCode" id="cb179"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb179-1"><a aria-hidden="true" href="#cb179-1" tabindex="-1"></a><span class="co">// In read_key_sequence():</span></span>
<span id="cb179-2"><a aria-hidden="true" href="#cb179-2" tabindex="-1"></a></span>
<span id="cb179-3"><a aria-hidden="true" href="#cb179-3" tabindex="-1"></a><span class="co">// When entering command execution:</span></span>
<span id="cb179-4"><a aria-hidden="true" href="#cb179-4" tabindex="-1"></a>temporarily_switch_to_single_kboard <span class="op">(</span>SELECTED_FRAME <span class="op">());</span></span>
<span id="cb179-5"><a aria-hidden="true" href="#cb179-5" tabindex="-1"></a></span>
<span id="cb179-6"><a aria-hidden="true" href="#cb179-6" tabindex="-1"></a><span class="co">// This sets:</span></span>
<span id="cb179-7"><a aria-hidden="true" href="#cb179-7" tabindex="-1"></a>single_kboard <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb179-8"><a aria-hidden="true" href="#cb179-8" tabindex="-1"></a>current_kboard <span class="op">=</span> FRAME_KBOARD <span class="op">(</span>frame<span class="op">);</span></span>
<span id="cb179-9"><a aria-hidden="true" href="#cb179-9" tabindex="-1"></a></span>
<span id="cb179-10"><a aria-hidden="true" href="#cb179-10" tabindex="-1"></a><span class="co">// In read_char():</span></span>
<span id="cb179-11"><a aria-hidden="true" href="#cb179-11" tabindex="-1"></a><span class="cf">if</span> <span class="op">(</span>single_kboard<span class="op">)</span></span>
<span id="cb179-12"><a aria-hidden="true" href="#cb179-12" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb179-13"><a aria-hidden="true" href="#cb179-13" tabindex="-1"></a>    <span class="co">// Only accept input from current_kboard</span></span>
<span id="cb179-14"><a aria-hidden="true" href="#cb179-14" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>event_kboard <span class="op">!=</span> current_kboard<span class="op">)</span></span>
<span id="cb179-15"><a aria-hidden="true" href="#cb179-15" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb179-16"><a aria-hidden="true" href="#cb179-16" tabindex="-1"></a>        <span class="co">// Put event back in its KBOARD's queue</span></span>
<span id="cb179-17"><a aria-hidden="true" href="#cb179-17" tabindex="-1"></a>        KVAR <span class="op">(</span>event_kboard<span class="op">,</span> kbd_queue<span class="op">)</span> <span class="op">=</span></span>
<span id="cb179-18"><a aria-hidden="true" href="#cb179-18" tabindex="-1"></a>            Fcons <span class="op">(</span>event<span class="op">,</span> KVAR <span class="op">(</span>event_kboard<span class="op">,</span> kbd_queue<span class="op">));</span></span>
<span id="cb179-19"><a aria-hidden="true" href="#cb179-19" tabindex="-1"></a>        event_kboard<span class="op">-&gt;</span>kbd_queue_has_data <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb179-20"><a aria-hidden="true" href="#cb179-20" tabindex="-1"></a></span>
<span id="cb179-21"><a aria-hidden="true" href="#cb179-21" tabindex="-1"></a>        <span class="co">// Continue waiting for current_kboard input</span></span>
<span id="cb179-22"><a aria-hidden="true" href="#cb179-22" tabindex="-1"></a>        <span class="cf">goto</span> retry<span class="op">;</span></span>
<span id="cb179-23"><a aria-hidden="true" href="#cb179-23" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb179-24"><a aria-hidden="true" href="#cb179-24" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2 data-number="8.12" id="flow-diagram-complete-event-processing"><span class="header-section-number">8.12</span> Flow Diagram: Complete Event
Processing</h2>
<pre><code>‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    Hardware Event Occurs                     ‚îÇ
‚îÇ                  (keyboard, mouse, timer, etc.)              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                             ‚îÇ
                             ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ              Terminal-Specific Input Handler                 ‚îÇ
‚îÇ   (term.c, xterm.c, w32term.c, etc.)                        ‚îÇ
‚îÇ   - Reads from hardware/OS                                  ‚îÇ
‚îÇ   - Creates struct input_event                              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                             ‚îÇ
                             ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ               kbd_buffer_store_event()                       ‚îÇ
‚îÇ   - Stores in circular buffer kbd_buffer[]                  ‚îÇ
‚îÇ   - Sets input_pending flag                                 ‚îÇ
‚îÇ   - Stores in KBOARD's queue if needed                      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                             ‚îÇ
                             ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                      command_loop()                          ‚îÇ
‚îÇ   ‚îî‚îÄ&gt; command_loop_2() [error handling]                     ‚îÇ
‚îÇ       ‚îî‚îÄ&gt; command_loop_1() [main loop]                      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                             ‚îÇ
                             ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                  read_key_sequence()                         ‚îÇ
‚îÇ   - Builds complete key sequence                            ‚îÇ
‚îÇ   - Handles prefix keys                                     ‚îÇ
‚îÇ   - Applies translation maps                                ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                             ‚îÇ
          ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
          ‚îÇ                                     ‚îÇ
          ‚ñº                                     ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê          ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ     read_char()      ‚îÇ  (loop)  ‚îÇ  Translation Maps    ‚îÇ
‚îÇ - Gets single event  ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ  - input-decode-map  ‚îÇ
‚îÇ - From queue/macro   ‚îÇ          ‚îÇ  - function-key-map  ‚îÇ
‚îÇ - Handles reread     ‚îÇ          ‚îÇ  - key-translation   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò          ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
          ‚îÇ
          ‚îÇ
          ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ              Keymap Lookup (access_keymap)                   ‚îÇ
‚îÇ   Active keymap hierarchy:                                  ‚îÇ
‚îÇ   1. overriding-terminal-local-map                          ‚îÇ
‚îÇ   2. overriding-local-map                                   ‚îÇ
‚îÇ   3. char property keymaps                                  ‚îÇ
‚îÇ   4. minor-mode maps                                        ‚îÇ
‚îÇ   5. local-map                                              ‚îÇ
‚îÇ   6. global-map                                             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                             ‚îÇ
          ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
          ‚ñº                                     ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê          ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Prefix Key Found   ‚îÇ          ‚îÇ   Command Found      ‚îÇ
‚îÇ   - Continue reading ‚îÇ          ‚îÇ   - Complete!        ‚îÇ
‚îÇ   - Update keymaps   ‚îÇ          ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                 ‚îÇ
                                         ‚ñº
                         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                         ‚îÇ    Command Remapping          ‚îÇ
                         ‚îÇ    (command-remapping)        ‚îÇ
                         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                     ‚îÇ
                                     ‚ñº
                         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                         ‚îÇ    pre-command-hook           ‚îÇ
                         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                     ‚îÇ
                                     ‚ñº
                         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                         ‚îÇ    call-interactively         ‚îÇ
                         ‚îÇ    - Parse interactive spec   ‚îÇ
                         ‚îÇ    - Gather arguments         ‚îÇ
                         ‚îÇ    - Call function            ‚îÇ
                         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                     ‚îÇ
                                     ‚ñº
                         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                         ‚îÇ    Command Executes           ‚îÇ
                         ‚îÇ    (user's function)          ‚îÇ
                         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                     ‚îÇ
                                     ‚ñº
                         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                         ‚îÇ    post-command-hook          ‚îÇ
                         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                     ‚îÇ
                                     ‚ñº
                         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                         ‚îÇ    Cleanup &amp; Continue         ‚îÇ
                         ‚îÇ    - Update mode line         ‚îÇ
                         ‚îÇ    - Auto-save check          ‚îÇ
                         ‚îÇ    - GC check                 ‚îÇ
                         ‚îÇ    - Loop back                ‚îÇ
                         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò</code></pre>
<h2 data-number="8.13" id="key-functions-reference"><span class="header-section-number">8.13</span> Key Functions Reference</h2>
<h3 data-number="8.13.1" id="event-loop"><span class="header-section-number">8.13.1</span> Event Loop</h3>
<table>
<thead>
<tr>
<th>Function</th>
<th>File</th>
<th>Lines</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>command_loop</code></td>
<td>keyboard.c</td>
<td>1113-1148</td>
<td>Top-level event loop</td>
</tr>
<tr>
<td><code>command_loop_1</code></td>
<td>keyboard.c</td>
<td>1318-1700+</td>
<td>Main command loop</td>
</tr>
<tr>
<td><code>recursive_edit_1</code></td>
<td>keyboard.c</td>
<td>708-761</td>
<td>Recursive editing</td>
</tr>
</tbody>
</table>
<h3 data-number="8.13.2" id="event-reading"><span class="header-section-number">8.13.2</span> Event Reading</h3>
<table>
<colgroup>
<col style="width: 31%"/>
<col style="width: 18%"/>
<col style="width: 21%"/>
<col style="width: 28%"/>
</colgroup>
<thead>
<tr>
<th>Function</th>
<th>File</th>
<th>Lines</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>read_char</code></td>
<td>keyboard.c</td>
<td>2534-3200+</td>
<td>Read single event</td>
</tr>
<tr>
<td><code>read_key_sequence</code></td>
<td>keyboard.c</td>
<td>10841-12500+</td>
<td>Read complete key sequence</td>
</tr>
<tr>
<td><code>kbd_buffer_store_event</code></td>
<td>keyboard.c</td>
<td>~2000</td>
<td>Store event in buffer</td>
</tr>
</tbody>
</table>
<h3 data-number="8.13.3" id="keymap-operations"><span class="header-section-number">8.13.3</span> Keymap Operations</h3>
<table>
<thead>
<tr>
<th>Function</th>
<th>File</th>
<th>Lines</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>access_keymap</code></td>
<td>keymap.c</td>
<td>492-496</td>
<td>Look up key in keymap</td>
</tr>
<tr>
<td><code>access_keymap_1</code></td>
<td>keymap.c</td>
<td>327-489</td>
<td>Core lookup algorithm</td>
</tr>
<tr>
<td><code>get_keymap</code></td>
<td>keymap.c</td>
<td>192-240</td>
<td>Validate/dereference keymap</td>
</tr>
<tr>
<td><code>get_keyelt</code></td>
<td>keymap.c</td>
<td>679-750</td>
<td>Trace indirect definitions</td>
</tr>
<tr>
<td><code>map_keymap</code></td>
<td>keymap.c</td>
<td>584-600</td>
<td>Iterate over keymap</td>
</tr>
</tbody>
</table>
<h3 data-number="8.13.4" id="command-execution-1"><span class="header-section-number">8.13.4</span> Command Execution</h3>
<table>
<colgroup>
<col style="width: 31%"/>
<col style="width: 18%"/>
<col style="width: 21%"/>
<col style="width: 28%"/>
</colgroup>
<thead>
<tr>
<th>Function</th>
<th>File</th>
<th>Lines</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Fcall_interactively</code></td>
<td>callint.c</td>
<td>253-900+</td>
<td>Interactive command execution</td>
</tr>
<tr>
<td><code>Finteractive</code></td>
<td>callint.c</td>
<td>37-121</td>
<td>Interactive spec declaration</td>
</tr>
</tbody>
</table>
<h3 data-number="8.13.5" id="keyboard-macros-1"><span class="header-section-number">8.13.5</span> Keyboard Macros</h3>
<table>
<thead>
<tr>
<th>Function</th>
<th>File</th>
<th>Lines</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Fstart_kbd_macro</code></td>
<td>macros.c</td>
<td>42-110</td>
<td>Begin macro recording</td>
</tr>
<tr>
<td><code>Fend_kbd_macro</code></td>
<td>macros.c</td>
<td>112-140</td>
<td>End macro recording</td>
</tr>
<tr>
<td><code>Fexecute_kbd_macro</code></td>
<td>macros.c</td>
<td>240-330</td>
<td>Execute macro</td>
</tr>
</tbody>
</table>
<h2 data-number="8.14" id="performance-considerations"><span class="header-section-number">8.14</span> Performance
Considerations</h2>
<h3 data-number="8.14.1" id="keymap-lookup-optimization"><span class="header-section-number">8.14.1</span> 1. Keymap Lookup
Optimization</h3>
<p><strong>Problem:</strong> Looking up keys in deep keymap hierarchies
can be slow.</p>
<p><strong>Solutions:</strong> - <strong>Char-tables:</strong> O(1)
lookup for character keys without modifiers - <strong>Caching:</strong>
<code>where-is-cache</code> caches reverse lookups - <strong>Early
termination:</strong> Stop at first non-nil binding</p>
<h3 data-number="8.14.2" id="event-queue-management-1"><span class="header-section-number">8.14.2</span> 2. Event Queue
Management</h3>
<p><strong>Circular Buffer:</strong> Fixed-size
<code>kbd_buffer[KBD_BUFFER_SIZE]</code> avoids allocation</p>
<p><strong>Trade-offs:</strong> - Fast: No allocation during event
processing - Limited: Can overflow if 4096 events not consumed</p>
<h3 data-number="8.14.3" id="translation-map-application"><span class="header-section-number">8.14.3</span> 3. Translation Map
Application</h3>
<p><strong>Three-stage translation</strong> (indec ‚Üí fkey ‚Üí keytran)
requires careful state management:</p>
<div class="sourceCode" id="cb181"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb181-1"><a aria-hidden="true" href="#cb181-1" tabindex="-1"></a><span class="co">// Each stage maintains:</span></span>
<span id="cb181-2"><a aria-hidden="true" href="#cb181-2" tabindex="-1"></a><span class="kw">struct</span> keyremap <span class="op">{</span></span>
<span id="cb181-3"><a aria-hidden="true" href="#cb181-3" tabindex="-1"></a>    Lisp_Object parent<span class="op">;</span>  <span class="co">// Original map</span></span>
<span id="cb181-4"><a aria-hidden="true" href="#cb181-4" tabindex="-1"></a>    Lisp_Object map<span class="op">;</span>     <span class="co">// Current position</span></span>
<span id="cb181-5"><a aria-hidden="true" href="#cb181-5" tabindex="-1"></a>    <span class="dt">int</span> start<span class="op">,</span> end<span class="op">;</span>      <span class="co">// Range being translated</span></span>
<span id="cb181-6"><a aria-hidden="true" href="#cb181-6" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<p><strong>Replaying</strong> after translation uses mock_input to avoid
re-reading:</p>
<div class="sourceCode" id="cb182"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb182-1"><a aria-hidden="true" href="#cb182-1" tabindex="-1"></a><span class="cf">if</span> <span class="op">(</span>t <span class="op">&lt;</span> mock_input<span class="op">)</span></span>
<span id="cb182-2"><a aria-hidden="true" href="#cb182-2" tabindex="-1"></a>    key <span class="op">=</span> keybuf<span class="op">[</span>t<span class="op">];</span>  <span class="co">// Replay</span></span>
<span id="cb182-3"><a aria-hidden="true" href="#cb182-3" tabindex="-1"></a><span class="cf">else</span></span>
<span id="cb182-4"><a aria-hidden="true" href="#cb182-4" tabindex="-1"></a>    key <span class="op">=</span> read_char <span class="op">();</span>  <span class="co">// Read new</span></span></code></pre></div>
<h2 data-number="8.15" id="common-patterns"><span class="header-section-number">8.15</span> Common Patterns</h2>
<h3 data-number="8.15.1" id="reading-a-key-sequence"><span class="header-section-number">8.15.1</span> 1. Reading a Key
Sequence</h3>
<div class="sourceCode" id="cb183"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb183-1"><a aria-hidden="true" href="#cb183-1" tabindex="-1"></a>Lisp_Object keybuf<span class="op">[</span>READ_KEY_ELTS<span class="op">];</span></span>
<span id="cb183-2"><a aria-hidden="true" href="#cb183-2" tabindex="-1"></a><span class="dt">int</span> i <span class="op">=</span> read_key_sequence <span class="op">(</span>keybuf<span class="op">,</span> Qnil<span class="op">,</span> <span class="kw">false</span><span class="op">,</span> <span class="kw">true</span><span class="op">,</span> <span class="kw">true</span><span class="op">,</span> <span class="kw">false</span><span class="op">,</span> <span class="kw">false</span><span class="op">);</span></span>
<span id="cb183-3"><a aria-hidden="true" href="#cb183-3" tabindex="-1"></a></span>
<span id="cb183-4"><a aria-hidden="true" href="#cb183-4" tabindex="-1"></a><span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> j <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> j <span class="op">&lt;</span> i<span class="op">;</span> j<span class="op">++)</span></span>
<span id="cb183-5"><a aria-hidden="true" href="#cb183-5" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb183-6"><a aria-hidden="true" href="#cb183-6" tabindex="-1"></a>    Lisp_Object key <span class="op">=</span> keybuf<span class="op">[</span>j<span class="op">];</span></span>
<span id="cb183-7"><a aria-hidden="true" href="#cb183-7" tabindex="-1"></a>    <span class="co">// Process key</span></span>
<span id="cb183-8"><a aria-hidden="true" href="#cb183-8" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 data-number="8.15.2" id="looking-up-a-key"><span class="header-section-number">8.15.2</span> 2. Looking Up a Key</h3>
<div class="sourceCode" id="cb184"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb184-1"><a aria-hidden="true" href="#cb184-1" tabindex="-1"></a>Lisp_Object binding <span class="op">=</span> access_keymap <span class="op">(</span>current_global_map<span class="op">,</span> key<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb184-2"><a aria-hidden="true" href="#cb184-2" tabindex="-1"></a></span>
<span id="cb184-3"><a aria-hidden="true" href="#cb184-3" tabindex="-1"></a><span class="cf">if</span> <span class="op">(</span>NILP <span class="op">(</span>binding<span class="op">))</span></span>
<span id="cb184-4"><a aria-hidden="true" href="#cb184-4" tabindex="-1"></a>    <span class="co">// Unbound</span></span>
<span id="cb184-5"><a aria-hidden="true" href="#cb184-5" tabindex="-1"></a><span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>KEYMAPP <span class="op">(</span>binding<span class="op">))</span></span>
<span id="cb184-6"><a aria-hidden="true" href="#cb184-6" tabindex="-1"></a>    <span class="co">// Prefix key</span></span>
<span id="cb184-7"><a aria-hidden="true" href="#cb184-7" tabindex="-1"></a><span class="cf">else</span></span>
<span id="cb184-8"><a aria-hidden="true" href="#cb184-8" tabindex="-1"></a>    <span class="co">// Command</span></span></code></pre></div>
<h3 data-number="8.15.3" id="defining-a-key"><span class="header-section-number">8.15.3</span> 3. Defining a Key</h3>
<div class="sourceCode" id="cb185"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb185-1"><a aria-hidden="true" href="#cb185-1" tabindex="-1"></a><span class="co">// C code:</span></span>
<span id="cb185-2"><a aria-hidden="true" href="#cb185-2" tabindex="-1"></a>initial_define_lispy_key <span class="op">(</span>keymap<span class="op">,</span> <span class="st">"C-x C-f"</span><span class="op">,</span> <span class="st">"find-file"</span><span class="op">);</span></span>
<span id="cb185-3"><a aria-hidden="true" href="#cb185-3" tabindex="-1"></a></span>
<span id="cb185-4"><a aria-hidden="true" href="#cb185-4" tabindex="-1"></a><span class="co">// Expands to:</span></span>
<span id="cb185-5"><a aria-hidden="true" href="#cb185-5" tabindex="-1"></a>store_in_keymap <span class="op">(</span>keymap<span class="op">,</span></span>
<span id="cb185-6"><a aria-hidden="true" href="#cb185-6" tabindex="-1"></a>                intern_c_string <span class="op">(</span><span class="st">"C-x C-f"</span><span class="op">),</span></span>
<span id="cb185-7"><a aria-hidden="true" href="#cb185-7" tabindex="-1"></a>                intern_c_string <span class="op">(</span><span class="st">"find-file"</span><span class="op">),</span></span>
<span id="cb185-8"><a aria-hidden="true" href="#cb185-8" tabindex="-1"></a>                <span class="kw">false</span><span class="op">);</span></span></code></pre></div>
<h3 data-number="8.15.4" id="creating-interactive-commands"><span class="header-section-number">8.15.4</span> 4. Creating Interactive
Commands</h3>
<div class="sourceCode" id="cb186"><pre class="sourceCode lisp"><code class="sourceCode commonlisp"><span id="cb186-1"><a aria-hidden="true" href="#cb186-1" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> my-command </span>(start end)</span>
<span id="cb186-2"><a aria-hidden="true" href="#cb186-2" tabindex="-1"></a>  <span class="st">"Do something with region."</span></span>
<span id="cb186-3"><a aria-hidden="true" href="#cb186-3" tabindex="-1"></a>  (interactive <span class="st">"r"</span>)  <span class="co">; Two args: region start and end</span></span>
<span id="cb186-4"><a aria-hidden="true" href="#cb186-4" tabindex="-1"></a>  (message <span class="st">"Region: %d to %d"</span> start end))</span></code></pre></div>
<p>Equivalent C registration:</p>
<div class="sourceCode" id="cb187"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb187-1"><a aria-hidden="true" href="#cb187-1" tabindex="-1"></a>DEFUN <span class="op">(</span><span class="st">"my-command"</span><span class="op">,</span> Fmy_command<span class="op">,</span> Smy_command<span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="st">"r"</span><span class="op">,</span></span>
<span id="cb187-2"><a aria-hidden="true" href="#cb187-2" tabindex="-1"></a>       doc<span class="op">:</span> <span class="co">/* Do something with region. */</span><span class="op">)</span></span>
<span id="cb187-3"><a aria-hidden="true" href="#cb187-3" tabindex="-1"></a>  <span class="op">(</span>Lisp_Object start<span class="op">,</span> Lisp_Object end<span class="op">)</span></span>
<span id="cb187-4"><a aria-hidden="true" href="#cb187-4" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb187-5"><a aria-hidden="true" href="#cb187-5" tabindex="-1"></a>    message <span class="op">(</span><span class="st">"Region: </span><span class="sc">%d</span><span class="st"> to </span><span class="sc">%d</span><span class="st">"</span><span class="op">,</span> XFIXNUM <span class="op">(</span>start<span class="op">),</span> XFIXNUM <span class="op">(</span>end<span class="op">));</span></span>
<span id="cb187-6"><a aria-hidden="true" href="#cb187-6" tabindex="-1"></a>    <span class="cf">return</span> Qnil<span class="op">;</span></span>
<span id="cb187-7"><a aria-hidden="true" href="#cb187-7" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2 data-number="8.16" id="debugging-tools"><span class="header-section-number">8.16</span> Debugging Tools</h2>
<h3 data-number="8.16.1" id="view-lossage"><span class="header-section-number">8.16.1</span> 1. View Lossage</h3>
<p><strong>Command:</strong> <code>view-lossage</code> (C-h l)</p>
<p>Shows last 300 (or configured) input events:</p>
<div class="sourceCode" id="cb188"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb188-1"><a aria-hidden="true" href="#cb188-1" tabindex="-1"></a><span class="co">// Circular buffer of recent keys</span></span>
<span id="cb188-2"><a aria-hidden="true" href="#cb188-2" tabindex="-1"></a><span class="dt">static</span> Lisp_Object recent_keys<span class="op">;</span></span>
<span id="cb188-3"><a aria-hidden="true" href="#cb188-3" tabindex="-1"></a><span class="dt">static</span> <span class="dt">int</span> recent_keys_index<span class="op">;</span></span>
<span id="cb188-4"><a aria-hidden="true" href="#cb188-4" tabindex="-1"></a></span>
<span id="cb188-5"><a aria-hidden="true" href="#cb188-5" tabindex="-1"></a><span class="dt">void</span></span>
<span id="cb188-6"><a aria-hidden="true" href="#cb188-6" tabindex="-1"></a>record_char <span class="op">(</span>Lisp_Object c<span class="op">)</span></span>
<span id="cb188-7"><a aria-hidden="true" href="#cb188-7" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb188-8"><a aria-hidden="true" href="#cb188-8" tabindex="-1"></a>    total_keys <span class="op">+=</span> total_keys <span class="op">&lt;</span> lossage_limit<span class="op">;</span></span>
<span id="cb188-9"><a aria-hidden="true" href="#cb188-9" tabindex="-1"></a>    ASET <span class="op">(</span>recent_keys<span class="op">,</span> recent_keys_index<span class="op">,</span> c<span class="op">);</span></span>
<span id="cb188-10"><a aria-hidden="true" href="#cb188-10" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(++</span>recent_keys_index <span class="op">&gt;=</span> lossage_limit<span class="op">)</span></span>
<span id="cb188-11"><a aria-hidden="true" href="#cb188-11" tabindex="-1"></a>        recent_keys_index <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb188-12"><a aria-hidden="true" href="#cb188-12" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 data-number="8.16.2" id="describe-key"><span class="header-section-number">8.16.2</span> 2. Describe Key</h3>
<p><strong>Command:</strong> <code>describe-key</code> (C-h k)</p>
<p>Shows what command a key sequence runs:</p>
<div class="sourceCode" id="cb189"><pre class="sourceCode lisp"><code class="sourceCode commonlisp"><span id="cb189-1"><a aria-hidden="true" href="#cb189-1" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> describe-key </span>(key)</span>
<span id="cb189-2"><a aria-hidden="true" href="#cb189-2" tabindex="-1"></a>  (interactive <span class="st">"kDescribe key: "</span>)</span>
<span id="cb189-3"><a aria-hidden="true" href="#cb189-3" tabindex="-1"></a>  (<span class="kw">let</span> ((binding (key-binding key)))</span>
<span id="cb189-4"><a aria-hidden="true" href="#cb189-4" tabindex="-1"></a>    (<span class="kw">if</span> binding</span>
<span id="cb189-5"><a aria-hidden="true" href="#cb189-5" tabindex="-1"></a>        (describe-function binding)</span>
<span id="cb189-6"><a aria-hidden="true" href="#cb189-6" tabindex="-1"></a>      (message <span class="st">"%s is undefined"</span> (key-description key)))))</span></code></pre></div>
<h3 data-number="8.16.3" id="where-is"><span class="header-section-number">8.16.3</span> 3. Where Is</h3>
<p><strong>Command:</strong> <code>where-is</code> (C-h w)</p>
<p>Shows all key bindings for a command:</p>
<div class="sourceCode" id="cb190"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb190-1"><a aria-hidden="true" href="#cb190-1" tabindex="-1"></a><span class="co">// Uses reverse map cache: where_is_cache</span></span>
<span id="cb190-2"><a aria-hidden="true" href="#cb190-2" tabindex="-1"></a><span class="co">// Maps commands ‚Üí key sequences</span></span></code></pre></div>
<h3 data-number="8.16.4" id="event-debugging"><span class="header-section-number">8.16.4</span> 4. Event Debugging</h3>
<p><strong>Variables:</strong> - <code>last-command-event</code> - Last
key that invoked command - <code>this-command-keys</code> - Full key
sequence - <code>this-command-keys-vector</code> - Vector form</p>
<p><strong>Functions:</strong> - <code>recent-keys</code> - Get recent
key vector - <code>this-single-command-keys</code> - Keys of current
command only</p>
<h2 data-number="8.17" id="conclusion-1"><span class="header-section-number">8.17</span> Conclusion</h2>
<p>The keyboard and event handling system is a marvel of careful
engineering, managing:</p>
<ul>
<li><strong>Multiple input sources</strong> - keyboard, mouse, timers,
menus, macros</li>
<li><strong>Complex state</strong> - multi-keyboard support, recursive
editing, macro recording</li>
<li><strong>Efficient lookup</strong> - keymap hierarchy, translation
maps, caching</li>
<li><strong>Interactive execution</strong> - argument gathering, hooks,
command history</li>
</ul>
<p>Understanding this system is crucial for: - Implementing new input
methods - Adding special key handling - Debugging input-related issues -
Optimizing command execution - Extending Emacs‚Äôs interactivity</p>
<p>The clean separation between event reading, key sequence processing,
keymap lookup, and command execution makes the system remarkably
extensible despite its complexity.</p>
<h1 data-number="9" id="process-management-and-io-system"><span class="header-section-number">9</span> Process Management and I/O
System</h1>
<p>This document provides comprehensive literate programming
documentation for Emacs‚Äôs process management and I/O system, one of the
most sophisticated components of the editor.</p>
<h2 data-number="9.1" id="table-of-contents-3"><span class="header-section-number">9.1</span> Table of Contents</h2>
<ol type="1">
<li><a href="#overview-and-architecture">Overview and
Architecture</a></li>
<li><a href="#core-data-structures">Core Data Structures</a></li>
<li><a href="#process-creation-and-execution">Process Creation and
Execution</a></li>
<li><a href="#io-system">I/O System</a></li>
<li><a href="#process-filters-and-sentinels">Process Filters and
Sentinels</a></li>
<li><a href="#network-processes">Network Processes</a></li>
<li><a href="#serial-port-communication">Serial Port
Communication</a></li>
<li><a href="#pty-allocation">PTY Allocation</a></li>
<li><a href="#signal-handling">Signal Handling</a></li>
<li><a href="#elisp-layer">Elisp Layer</a></li>
<li><a href="#advanced-topics">Advanced Topics</a></li>
<li><a href="#cross-platform-considerations">Cross-Platform
Considerations</a></li>
</ol>
<h2 data-number="9.2" id="overview-and-architecture"><span class="header-section-number">9.2</span> Overview and Architecture</h2>
<p>Emacs‚Äôs process management system provides a unified interface for: -
Asynchronous subprocess execution - Network connections (TCP/UDP clients
and servers) - Serial port communication - Pipe processes</p>
<h3 data-number="9.2.1" id="core-files"><span class="header-section-number">9.2.1</span> Core Files</h3>
<table>
<colgroup>
<col style="width: 27%"/>
<col style="width: 31%"/>
<col style="width: 40%"/>
</colgroup>
<thead>
<tr>
<th>File</th>
<th>Lines</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>src/process.c</code></td>
<td>9,096</td>
<td>Main process management (64 DEFUN declarations)</td>
</tr>
<tr>
<td><code>src/sysdep.c</code></td>
<td>4,714</td>
<td>System-dependent process operations</td>
</tr>
<tr>
<td><code>src/callproc.c</code></td>
<td>2,247</td>
<td>Synchronous subprocess invocation</td>
</tr>
<tr>
<td><code>src/process.h</code></td>
<td>318</td>
<td>Process data structures and interfaces</td>
</tr>
<tr>
<td><code>lisp/comint.el</code></td>
<td>4,370</td>
<td>Command interpreter in a buffer</td>
</tr>
<tr>
<td><code>lisp/progmodes/compile.el</code></td>
<td>~3,000</td>
<td>Compilation mode</td>
</tr>
</tbody>
</table>
<h3 data-number="9.2.2" id="design-philosophy"><span class="header-section-number">9.2.2</span> Design Philosophy</h3>
<p>The process system is designed with several key principles:</p>
<ol type="1">
<li><strong>Unified Abstraction</strong>: All process types (subprocess,
network, serial) share a common interface</li>
<li><strong>Asynchronous I/O</strong>: Non-blocking operations with
event-driven processing</li>
<li><strong>Extensibility</strong>: Filters and sentinels provide hooks
for custom processing</li>
<li><strong>Thread Safety</strong>: Careful handling of signals and
concurrent access</li>
<li><strong>Cross-Platform</strong>: Abstractions over Unix/Windows
differences</li>
</ol>
<h2 data-number="9.3" id="core-data-structures-1"><span class="header-section-number">9.3</span> Core Data Structures</h2>
<h3 data-number="9.3.1" id="the-lisp_process-structure"><span class="header-section-number">9.3.1</span> The Lisp_Process
Structure</h3>
<p>The heart of process management is <code>struct Lisp_Process</code>,
defined in <code>src/process.h</code>:</p>
<div class="sourceCode" id="cb191"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb191-1"><a aria-hidden="true" href="#cb191-1" tabindex="-1"></a><span class="co">/* File: src/process.h, Lines: 42-214 */</span></span>
<span id="cb191-2"><a aria-hidden="true" href="#cb191-2" tabindex="-1"></a></span>
<span id="cb191-3"><a aria-hidden="true" href="#cb191-3" tabindex="-1"></a><span class="kw">struct</span> Lisp_Process</span>
<span id="cb191-4"><a aria-hidden="true" href="#cb191-4" tabindex="-1"></a>  <span class="op">{</span></span>
<span id="cb191-5"><a aria-hidden="true" href="#cb191-5" tabindex="-1"></a>    <span class="kw">union</span> vectorlike_header header<span class="op">;</span></span>
<span id="cb191-6"><a aria-hidden="true" href="#cb191-6" tabindex="-1"></a></span>
<span id="cb191-7"><a aria-hidden="true" href="#cb191-7" tabindex="-1"></a>    <span class="co">/* Name of subprocess terminal.  */</span></span>
<span id="cb191-8"><a aria-hidden="true" href="#cb191-8" tabindex="-1"></a>    Lisp_Object tty_name<span class="op">;</span></span>
<span id="cb191-9"><a aria-hidden="true" href="#cb191-9" tabindex="-1"></a></span>
<span id="cb191-10"><a aria-hidden="true" href="#cb191-10" tabindex="-1"></a>    <span class="co">/* Name of this process.  */</span></span>
<span id="cb191-11"><a aria-hidden="true" href="#cb191-11" tabindex="-1"></a>    Lisp_Object name<span class="op">;</span></span>
<span id="cb191-12"><a aria-hidden="true" href="#cb191-12" tabindex="-1"></a></span>
<span id="cb191-13"><a aria-hidden="true" href="#cb191-13" tabindex="-1"></a>    <span class="co">/* List of command arguments that this process was run with.</span></span>
<span id="cb191-14"><a aria-hidden="true" href="#cb191-14" tabindex="-1"></a><span class="co">       Is set to t for a stopped network process; nil otherwise.  */</span></span>
<span id="cb191-15"><a aria-hidden="true" href="#cb191-15" tabindex="-1"></a>    Lisp_Object command<span class="op">;</span></span>
<span id="cb191-16"><a aria-hidden="true" href="#cb191-16" tabindex="-1"></a></span>
<span id="cb191-17"><a aria-hidden="true" href="#cb191-17" tabindex="-1"></a>    <span class="co">/* (funcall FILTER PROC STRING)  (if FILTER is non-nil)</span></span>
<span id="cb191-18"><a aria-hidden="true" href="#cb191-18" tabindex="-1"></a><span class="co">       to dispose of a bunch of chars from the process all at once.  */</span></span>
<span id="cb191-19"><a aria-hidden="true" href="#cb191-19" tabindex="-1"></a>    Lisp_Object filter<span class="op">;</span></span>
<span id="cb191-20"><a aria-hidden="true" href="#cb191-20" tabindex="-1"></a></span>
<span id="cb191-21"><a aria-hidden="true" href="#cb191-21" tabindex="-1"></a>    <span class="co">/* (funcall SENTINEL PROCESS) when process state changes.  */</span></span>
<span id="cb191-22"><a aria-hidden="true" href="#cb191-22" tabindex="-1"></a>    Lisp_Object sentinel<span class="op">;</span></span>
<span id="cb191-23"><a aria-hidden="true" href="#cb191-23" tabindex="-1"></a></span>
<span id="cb191-24"><a aria-hidden="true" href="#cb191-24" tabindex="-1"></a>    <span class="co">/* (funcall LOG SERVER CLIENT MESSAGE) when a server process</span></span>
<span id="cb191-25"><a aria-hidden="true" href="#cb191-25" tabindex="-1"></a><span class="co">       accepts a connection from a client.  */</span></span>
<span id="cb191-26"><a aria-hidden="true" href="#cb191-26" tabindex="-1"></a>    Lisp_Object log<span class="op">;</span></span>
<span id="cb191-27"><a aria-hidden="true" href="#cb191-27" tabindex="-1"></a></span>
<span id="cb191-28"><a aria-hidden="true" href="#cb191-28" tabindex="-1"></a>    <span class="co">/* Buffer that output is going to.  */</span></span>
<span id="cb191-29"><a aria-hidden="true" href="#cb191-29" tabindex="-1"></a>    Lisp_Object buffer<span class="op">;</span></span>
<span id="cb191-30"><a aria-hidden="true" href="#cb191-30" tabindex="-1"></a></span>
<span id="cb191-31"><a aria-hidden="true" href="#cb191-31" tabindex="-1"></a>    <span class="co">/* t if this is a real child process.  For a network or serial</span></span>
<span id="cb191-32"><a aria-hidden="true" href="#cb191-32" tabindex="-1"></a><span class="co">       connection, it is a plist based on the arguments to</span></span>
<span id="cb191-33"><a aria-hidden="true" href="#cb191-33" tabindex="-1"></a><span class="co">       make-network-process or make-serial-process.  */</span></span>
<span id="cb191-34"><a aria-hidden="true" href="#cb191-34" tabindex="-1"></a>    Lisp_Object childp<span class="op">;</span></span>
<span id="cb191-35"><a aria-hidden="true" href="#cb191-35" tabindex="-1"></a></span>
<span id="cb191-36"><a aria-hidden="true" href="#cb191-36" tabindex="-1"></a>    <span class="co">/* Plist for programs to keep per-process state information, parameters, etc.  */</span></span>
<span id="cb191-37"><a aria-hidden="true" href="#cb191-37" tabindex="-1"></a>    Lisp_Object plist<span class="op">;</span></span>
<span id="cb191-38"><a aria-hidden="true" href="#cb191-38" tabindex="-1"></a></span>
<span id="cb191-39"><a aria-hidden="true" href="#cb191-39" tabindex="-1"></a>    <span class="co">/* Symbol indicating the type of process: real, network, serial.  */</span></span>
<span id="cb191-40"><a aria-hidden="true" href="#cb191-40" tabindex="-1"></a>    Lisp_Object type<span class="op">;</span></span>
<span id="cb191-41"><a aria-hidden="true" href="#cb191-41" tabindex="-1"></a></span>
<span id="cb191-42"><a aria-hidden="true" href="#cb191-42" tabindex="-1"></a>    <span class="co">/* Marker set to end of last buffer-inserted output from this process.  */</span></span>
<span id="cb191-43"><a aria-hidden="true" href="#cb191-43" tabindex="-1"></a>    Lisp_Object mark<span class="op">;</span></span>
<span id="cb191-44"><a aria-hidden="true" href="#cb191-44" tabindex="-1"></a></span>
<span id="cb191-45"><a aria-hidden="true" href="#cb191-45" tabindex="-1"></a>    <span class="co">/* Symbol indicating status of process.</span></span>
<span id="cb191-46"><a aria-hidden="true" href="#cb191-46" tabindex="-1"></a><span class="co">       This may be a symbol: run, listen, or failed.</span></span>
<span id="cb191-47"><a aria-hidden="true" href="#cb191-47" tabindex="-1"></a><span class="co">       Or it may be a pair (connect . ADDRINFOS) where ADDRINFOS is</span></span>
<span id="cb191-48"><a aria-hidden="true" href="#cb191-48" tabindex="-1"></a><span class="co">       a list of remaining (PROTOCOL . ADDRINFO) pairs to try.</span></span>
<span id="cb191-49"><a aria-hidden="true" href="#cb191-49" tabindex="-1"></a><span class="co">       Or it may be (failed ERR) where ERR is an integer, string or symbol.</span></span>
<span id="cb191-50"><a aria-hidden="true" href="#cb191-50" tabindex="-1"></a><span class="co">       Or it may be a list, whose car is stop, exit or signal</span></span>
<span id="cb191-51"><a aria-hidden="true" href="#cb191-51" tabindex="-1"></a><span class="co">       and whose cdr is a pair (EXIT_CODE . COREDUMP_FLAG)</span></span>
<span id="cb191-52"><a aria-hidden="true" href="#cb191-52" tabindex="-1"></a><span class="co">       or (SIGNAL_NUMBER . COREDUMP_FLAG).  */</span></span>
<span id="cb191-53"><a aria-hidden="true" href="#cb191-53" tabindex="-1"></a>    Lisp_Object status<span class="op">;</span></span>
<span id="cb191-54"><a aria-hidden="true" href="#cb191-54" tabindex="-1"></a></span>
<span id="cb191-55"><a aria-hidden="true" href="#cb191-55" tabindex="-1"></a>    <span class="co">/* Coding-system for decoding the input from this process.  */</span></span>
<span id="cb191-56"><a aria-hidden="true" href="#cb191-56" tabindex="-1"></a>    Lisp_Object decode_coding_system<span class="op">;</span></span>
<span id="cb191-57"><a aria-hidden="true" href="#cb191-57" tabindex="-1"></a></span>
<span id="cb191-58"><a aria-hidden="true" href="#cb191-58" tabindex="-1"></a>    <span class="co">/* Working buffer for decoding.  */</span></span>
<span id="cb191-59"><a aria-hidden="true" href="#cb191-59" tabindex="-1"></a>    Lisp_Object decoding_buf<span class="op">;</span></span>
<span id="cb191-60"><a aria-hidden="true" href="#cb191-60" tabindex="-1"></a></span>
<span id="cb191-61"><a aria-hidden="true" href="#cb191-61" tabindex="-1"></a>    <span class="co">/* Coding-system for encoding the output to this process.  */</span></span>
<span id="cb191-62"><a aria-hidden="true" href="#cb191-62" tabindex="-1"></a>    Lisp_Object encode_coding_system<span class="op">;</span></span>
<span id="cb191-63"><a aria-hidden="true" href="#cb191-63" tabindex="-1"></a></span>
<span id="cb191-64"><a aria-hidden="true" href="#cb191-64" tabindex="-1"></a>    <span class="co">/* Working buffer for encoding.  */</span></span>
<span id="cb191-65"><a aria-hidden="true" href="#cb191-65" tabindex="-1"></a>    Lisp_Object encoding_buf<span class="op">;</span></span>
<span id="cb191-66"><a aria-hidden="true" href="#cb191-66" tabindex="-1"></a></span>
<span id="cb191-67"><a aria-hidden="true" href="#cb191-67" tabindex="-1"></a>    <span class="co">/* Queue for storing waiting writes.  */</span></span>
<span id="cb191-68"><a aria-hidden="true" href="#cb191-68" tabindex="-1"></a>    Lisp_Object write_queue<span class="op">;</span></span>
<span id="cb191-69"><a aria-hidden="true" href="#cb191-69" tabindex="-1"></a></span>
<span id="cb191-70"><a aria-hidden="true" href="#cb191-70" tabindex="-1"></a>    <span class="co">/* Pipe process attached to the standard error of this process.  */</span></span>
<span id="cb191-71"><a aria-hidden="true" href="#cb191-71" tabindex="-1"></a>    Lisp_Object stderrproc<span class="op">;</span></span>
<span id="cb191-72"><a aria-hidden="true" href="#cb191-72" tabindex="-1"></a></span>
<span id="cb191-73"><a aria-hidden="true" href="#cb191-73" tabindex="-1"></a>    <span class="co">/* The thread a process is linked to, or nil for any thread.  */</span></span>
<span id="cb191-74"><a aria-hidden="true" href="#cb191-74" tabindex="-1"></a>    Lisp_Object thread<span class="op">;</span></span>
<span id="cb191-75"><a aria-hidden="true" href="#cb191-75" tabindex="-1"></a></span>
<span id="cb191-76"><a aria-hidden="true" href="#cb191-76" tabindex="-1"></a>    <span class="co">/* After this point, there are no Lisp_Objects.  */</span></span>
<span id="cb191-77"><a aria-hidden="true" href="#cb191-77" tabindex="-1"></a></span>
<span id="cb191-78"><a aria-hidden="true" href="#cb191-78" tabindex="-1"></a>    <span class="co">/* Process ID.  A positive value is a child process ID.</span></span>
<span id="cb191-79"><a aria-hidden="true" href="#cb191-79" tabindex="-1"></a><span class="co">       Zero is for pseudo-processes such as network or serial connections,</span></span>
<span id="cb191-80"><a aria-hidden="true" href="#cb191-80" tabindex="-1"></a><span class="co">       or for processes that have not been fully created yet.</span></span>
<span id="cb191-81"><a aria-hidden="true" href="#cb191-81" tabindex="-1"></a><span class="co">       -1 is for a process that was not created successfully.</span></span>
<span id="cb191-82"><a aria-hidden="true" href="#cb191-82" tabindex="-1"></a><span class="co">       -2 is for a pty with no process, e.g., for GDB.  */</span></span>
<span id="cb191-83"><a aria-hidden="true" href="#cb191-83" tabindex="-1"></a>    pid_t pid<span class="op">;</span></span>
<span id="cb191-84"><a aria-hidden="true" href="#cb191-84" tabindex="-1"></a></span>
<span id="cb191-85"><a aria-hidden="true" href="#cb191-85" tabindex="-1"></a>    <span class="co">/* Descriptor by which we read from this process.  */</span></span>
<span id="cb191-86"><a aria-hidden="true" href="#cb191-86" tabindex="-1"></a>    <span class="dt">int</span> infd<span class="op">;</span></span>
<span id="cb191-87"><a aria-hidden="true" href="#cb191-87" tabindex="-1"></a></span>
<span id="cb191-88"><a aria-hidden="true" href="#cb191-88" tabindex="-1"></a>    <span class="co">/* Byte-count modulo (UINTMAX_MAX + 1) for process output read from `infd'.  */</span></span>
<span id="cb191-89"><a aria-hidden="true" href="#cb191-89" tabindex="-1"></a>    <span class="dt">uintmax_t</span> nbytes_read<span class="op">;</span></span>
<span id="cb191-90"><a aria-hidden="true" href="#cb191-90" tabindex="-1"></a></span>
<span id="cb191-91"><a aria-hidden="true" href="#cb191-91" tabindex="-1"></a>    <span class="co">/* Descriptor by which we write to this process.  */</span></span>
<span id="cb191-92"><a aria-hidden="true" href="#cb191-92" tabindex="-1"></a>    <span class="dt">int</span> outfd<span class="op">;</span></span>
<span id="cb191-93"><a aria-hidden="true" href="#cb191-93" tabindex="-1"></a></span>
<span id="cb191-94"><a aria-hidden="true" href="#cb191-94" tabindex="-1"></a>    <span class="co">/* Descriptors that were created for this process and that need</span></span>
<span id="cb191-95"><a aria-hidden="true" href="#cb191-95" tabindex="-1"></a><span class="co">       closing.  Unused entries are negative.  */</span></span>
<span id="cb191-96"><a aria-hidden="true" href="#cb191-96" tabindex="-1"></a>    <span class="dt">int</span> open_fd<span class="op">[</span>PROCESS_OPEN_FDS<span class="op">];</span></span>
<span id="cb191-97"><a aria-hidden="true" href="#cb191-97" tabindex="-1"></a></span>
<span id="cb191-98"><a aria-hidden="true" href="#cb191-98" tabindex="-1"></a>    <span class="co">/* Event-count of last event in which this process changed status.  */</span></span>
<span id="cb191-99"><a aria-hidden="true" href="#cb191-99" tabindex="-1"></a>    EMACS_INT tick<span class="op">;</span></span>
<span id="cb191-100"><a aria-hidden="true" href="#cb191-100" tabindex="-1"></a></span>
<span id="cb191-101"><a aria-hidden="true" href="#cb191-101" tabindex="-1"></a>    <span class="co">/* Event-count of last such event reported.  */</span></span>
<span id="cb191-102"><a aria-hidden="true" href="#cb191-102" tabindex="-1"></a>    EMACS_INT update_tick<span class="op">;</span></span>
<span id="cb191-103"><a aria-hidden="true" href="#cb191-103" tabindex="-1"></a></span>
<span id="cb191-104"><a aria-hidden="true" href="#cb191-104" tabindex="-1"></a>    <span class="co">/* Size of carryover in decoding.  */</span></span>
<span id="cb191-105"><a aria-hidden="true" href="#cb191-105" tabindex="-1"></a>    <span class="dt">int</span> decoding_carryover<span class="op">;</span></span>
<span id="cb191-106"><a aria-hidden="true" href="#cb191-106" tabindex="-1"></a></span>
<span id="cb191-107"><a aria-hidden="true" href="#cb191-107" tabindex="-1"></a>    <span class="co">/* Hysteresis to try to read process output in larger blocks.</span></span>
<span id="cb191-108"><a aria-hidden="true" href="#cb191-108" tabindex="-1"></a><span class="co">       On some systems, e.g. GNU/Linux, Emacs is seen as</span></span>
<span id="cb191-109"><a aria-hidden="true" href="#cb191-109" tabindex="-1"></a><span class="co">       an interactive app also when reading process output, meaning</span></span>
<span id="cb191-110"><a aria-hidden="true" href="#cb191-110" tabindex="-1"></a><span class="co">       that process output can be read in as little as 1 byte at a</span></span>
<span id="cb191-111"><a aria-hidden="true" href="#cb191-111" tabindex="-1"></a><span class="co">       time.  Value is nanoseconds to delay reading output from</span></span>
<span id="cb191-112"><a aria-hidden="true" href="#cb191-112" tabindex="-1"></a><span class="co">       this process.  Range is 0 .. 50 * 1000 * 1000.  */</span></span>
<span id="cb191-113"><a aria-hidden="true" href="#cb191-113" tabindex="-1"></a>    <span class="dt">int</span> read_output_delay<span class="op">;</span></span>
<span id="cb191-114"><a aria-hidden="true" href="#cb191-114" tabindex="-1"></a></span>
<span id="cb191-115"><a aria-hidden="true" href="#cb191-115" tabindex="-1"></a>    <span class="co">/* Should we delay reading output from this process.</span></span>
<span id="cb191-116"><a aria-hidden="true" href="#cb191-116" tabindex="-1"></a><span class="co">       Initialized from `Vprocess_adaptive_read_buffering'.</span></span>
<span id="cb191-117"><a aria-hidden="true" href="#cb191-117" tabindex="-1"></a><span class="co">       0 = nil, 1 = t, 2 = other.  */</span></span>
<span id="cb191-118"><a aria-hidden="true" href="#cb191-118" tabindex="-1"></a>    <span class="dt">unsigned</span> <span class="dt">int</span> adaptive_read_buffering <span class="op">:</span> <span class="dv">2</span><span class="op">;</span></span>
<span id="cb191-119"><a aria-hidden="true" href="#cb191-119" tabindex="-1"></a></span>
<span id="cb191-120"><a aria-hidden="true" href="#cb191-120" tabindex="-1"></a>    <span class="co">/* Skip reading this process on next read.  */</span></span>
<span id="cb191-121"><a aria-hidden="true" href="#cb191-121" tabindex="-1"></a>    bool_bf read_output_skip <span class="op">:</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb191-122"><a aria-hidden="true" href="#cb191-122" tabindex="-1"></a></span>
<span id="cb191-123"><a aria-hidden="true" href="#cb191-123" tabindex="-1"></a>    <span class="co">/* Maximum number of bytes to read in a single chunk. */</span></span>
<span id="cb191-124"><a aria-hidden="true" href="#cb191-124" tabindex="-1"></a>    <span class="dt">ptrdiff_t</span> readmax<span class="op">;</span></span>
<span id="cb191-125"><a aria-hidden="true" href="#cb191-125" tabindex="-1"></a></span>
<span id="cb191-126"><a aria-hidden="true" href="#cb191-126" tabindex="-1"></a>    <span class="co">/* True means kill silently if Emacs is exited.</span></span>
<span id="cb191-127"><a aria-hidden="true" href="#cb191-127" tabindex="-1"></a><span class="co">       This is the inverse of the `query-on-exit' flag.  */</span></span>
<span id="cb191-128"><a aria-hidden="true" href="#cb191-128" tabindex="-1"></a>    bool_bf kill_without_query <span class="op">:</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb191-129"><a aria-hidden="true" href="#cb191-129" tabindex="-1"></a></span>
<span id="cb191-130"><a aria-hidden="true" href="#cb191-130" tabindex="-1"></a>    <span class="co">/* True if communicating through a pty for input or output.  */</span></span>
<span id="cb191-131"><a aria-hidden="true" href="#cb191-131" tabindex="-1"></a>    bool_bf pty_in <span class="op">:</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb191-132"><a aria-hidden="true" href="#cb191-132" tabindex="-1"></a>    bool_bf pty_out <span class="op">:</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb191-133"><a aria-hidden="true" href="#cb191-133" tabindex="-1"></a></span>
<span id="cb191-134"><a aria-hidden="true" href="#cb191-134" tabindex="-1"></a>    <span class="co">/* Flag to set coding-system of the process buffer from the</span></span>
<span id="cb191-135"><a aria-hidden="true" href="#cb191-135" tabindex="-1"></a><span class="co">       coding_system used to decode process output.  */</span></span>
<span id="cb191-136"><a aria-hidden="true" href="#cb191-136" tabindex="-1"></a>    bool_bf inherit_coding_system_flag <span class="op">:</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb191-137"><a aria-hidden="true" href="#cb191-137" tabindex="-1"></a></span>
<span id="cb191-138"><a aria-hidden="true" href="#cb191-138" tabindex="-1"></a>    <span class="co">/* Whether the process is alive, i.e., can be waited for.  Running</span></span>
<span id="cb191-139"><a aria-hidden="true" href="#cb191-139" tabindex="-1"></a><span class="co">       processes can be waited for, but exited and fake processes cannot.  */</span></span>
<span id="cb191-140"><a aria-hidden="true" href="#cb191-140" tabindex="-1"></a>    bool_bf alive <span class="op">:</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb191-141"><a aria-hidden="true" href="#cb191-141" tabindex="-1"></a></span>
<span id="cb191-142"><a aria-hidden="true" href="#cb191-142" tabindex="-1"></a>    <span class="co">/* Record the process status in the raw form in which it comes from `wait'.</span></span>
<span id="cb191-143"><a aria-hidden="true" href="#cb191-143" tabindex="-1"></a><span class="co">       This is to avoid consing in a signal handler.  The `raw_status_new'</span></span>
<span id="cb191-144"><a aria-hidden="true" href="#cb191-144" tabindex="-1"></a><span class="co">       flag indicates that `raw_status' contains a new status that still</span></span>
<span id="cb191-145"><a aria-hidden="true" href="#cb191-145" tabindex="-1"></a><span class="co">       needs to be synced to `status'.  */</span></span>
<span id="cb191-146"><a aria-hidden="true" href="#cb191-146" tabindex="-1"></a>    bool_bf raw_status_new <span class="op">:</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb191-147"><a aria-hidden="true" href="#cb191-147" tabindex="-1"></a></span>
<span id="cb191-148"><a aria-hidden="true" href="#cb191-148" tabindex="-1"></a>    <span class="co">/* Whether this is a nonblocking socket. */</span></span>
<span id="cb191-149"><a aria-hidden="true" href="#cb191-149" tabindex="-1"></a>    bool_bf is_non_blocking_client <span class="op">:</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb191-150"><a aria-hidden="true" href="#cb191-150" tabindex="-1"></a></span>
<span id="cb191-151"><a aria-hidden="true" href="#cb191-151" tabindex="-1"></a>    <span class="co">/* Whether this is a server or a client socket. */</span></span>
<span id="cb191-152"><a aria-hidden="true" href="#cb191-152" tabindex="-1"></a>    bool_bf is_server <span class="op">:</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb191-153"><a aria-hidden="true" href="#cb191-153" tabindex="-1"></a></span>
<span id="cb191-154"><a aria-hidden="true" href="#cb191-154" tabindex="-1"></a>    <span class="dt">int</span> raw_status<span class="op">;</span></span>
<span id="cb191-155"><a aria-hidden="true" href="#cb191-155" tabindex="-1"></a></span>
<span id="cb191-156"><a aria-hidden="true" href="#cb191-156" tabindex="-1"></a>    <span class="co">/* The length of the socket backlog. */</span></span>
<span id="cb191-157"><a aria-hidden="true" href="#cb191-157" tabindex="-1"></a>    <span class="dt">int</span> backlog<span class="op">;</span></span>
<span id="cb191-158"><a aria-hidden="true" href="#cb191-158" tabindex="-1"></a></span>
<span id="cb191-159"><a aria-hidden="true" href="#cb191-159" tabindex="-1"></a>    <span class="co">/* The port number. */</span></span>
<span id="cb191-160"><a aria-hidden="true" href="#cb191-160" tabindex="-1"></a>    <span class="dt">int</span> port<span class="op">;</span></span>
<span id="cb191-161"><a aria-hidden="true" href="#cb191-161" tabindex="-1"></a></span>
<span id="cb191-162"><a aria-hidden="true" href="#cb191-162" tabindex="-1"></a>    <span class="co">/* The socket type. */</span></span>
<span id="cb191-163"><a aria-hidden="true" href="#cb191-163" tabindex="-1"></a>    <span class="dt">int</span> socktype<span class="op">;</span></span>
<span id="cb191-164"><a aria-hidden="true" href="#cb191-164" tabindex="-1"></a></span>
<span id="cb191-165"><a aria-hidden="true" href="#cb191-165" tabindex="-1"></a><span class="pp">#ifdef HAVE_GNUTLS</span></span>
<span id="cb191-166"><a aria-hidden="true" href="#cb191-166" tabindex="-1"></a>    gnutls_initstage_t gnutls_initstage<span class="op">;</span></span>
<span id="cb191-167"><a aria-hidden="true" href="#cb191-167" tabindex="-1"></a>    gnutls_session_t gnutls_state<span class="op">;</span></span>
<span id="cb191-168"><a aria-hidden="true" href="#cb191-168" tabindex="-1"></a>    gnutls_certificate_client_credentials gnutls_x509_cred<span class="op">;</span></span>
<span id="cb191-169"><a aria-hidden="true" href="#cb191-169" tabindex="-1"></a>    gnutls_anon_client_credentials_t gnutls_anon_cred<span class="op">;</span></span>
<span id="cb191-170"><a aria-hidden="true" href="#cb191-170" tabindex="-1"></a>    gnutls_x509_crt_t <span class="op">*</span>gnutls_certificates<span class="op">;</span></span>
<span id="cb191-171"><a aria-hidden="true" href="#cb191-171" tabindex="-1"></a>    <span class="dt">int</span> gnutls_certificates_length<span class="op">;</span></span>
<span id="cb191-172"><a aria-hidden="true" href="#cb191-172" tabindex="-1"></a>    <span class="dt">unsigned</span> <span class="dt">int</span> gnutls_peer_verification<span class="op">;</span></span>
<span id="cb191-173"><a aria-hidden="true" href="#cb191-173" tabindex="-1"></a>    <span class="dt">unsigned</span> <span class="dt">int</span> gnutls_extra_peer_verification<span class="op">;</span></span>
<span id="cb191-174"><a aria-hidden="true" href="#cb191-174" tabindex="-1"></a>    <span class="dt">int</span> gnutls_log_level<span class="op">;</span></span>
<span id="cb191-175"><a aria-hidden="true" href="#cb191-175" tabindex="-1"></a>    <span class="dt">int</span> gnutls_handshakes_tried<span class="op">;</span></span>
<span id="cb191-176"><a aria-hidden="true" href="#cb191-176" tabindex="-1"></a>    bool_bf gnutls_p <span class="op">:</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb191-177"><a aria-hidden="true" href="#cb191-177" tabindex="-1"></a>    bool_bf gnutls_complete_negotiation_p <span class="op">:</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb191-178"><a aria-hidden="true" href="#cb191-178" tabindex="-1"></a><span class="pp">#endif</span></span>
<span id="cb191-179"><a aria-hidden="true" href="#cb191-179" tabindex="-1"></a>  <span class="op">}</span> GCALIGNED_STRUCT<span class="op">;</span></span></code></pre></div>
<p><strong>Key Design Points:</strong></p>
<ol type="1">
<li><strong>GC Alignment</strong>: The structure is marked with
<code>GCALIGNED_STRUCT</code> for proper garbage collection</li>
<li><strong>Lisp Objects First</strong>: All Lisp_Object fields come
before C types (required for GC marking)</li>
<li><strong>File Descriptors</strong>: Separate <code>infd</code> and
<code>outfd</code> for bidirectional communication</li>
<li><strong>Status Tracking</strong>: Both symbolic
(<code>status</code>) and raw (<code>raw_status</code>) forms</li>
<li><strong>Adaptive Buffering</strong>: Fields for optimizing read
performance</li>
<li><strong>Encoding Support</strong>: Separate coding systems for input
and output</li>
</ol>
<h3 data-number="9.3.2" id="process-type-predicates"><span class="header-section-number">9.3.2</span> Process Type Predicates</h3>
<div class="sourceCode" id="cb192"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb192-1"><a aria-hidden="true" href="#cb192-1" tabindex="-1"></a><span class="co">/* File: src/process.h, Lines: 216-233 */</span></span>
<span id="cb192-2"><a aria-hidden="true" href="#cb192-2" tabindex="-1"></a></span>
<span id="cb192-3"><a aria-hidden="true" href="#cb192-3" tabindex="-1"></a>INLINE <span class="dt">bool</span></span>
<span id="cb192-4"><a aria-hidden="true" href="#cb192-4" tabindex="-1"></a>PROCESSP <span class="op">(</span>Lisp_Object a<span class="op">)</span></span>
<span id="cb192-5"><a aria-hidden="true" href="#cb192-5" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb192-6"><a aria-hidden="true" href="#cb192-6" tabindex="-1"></a>  <span class="cf">return</span> PSEUDOVECTORP <span class="op">(</span>a<span class="op">,</span> PVEC_PROCESS<span class="op">);</span></span>
<span id="cb192-7"><a aria-hidden="true" href="#cb192-7" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb192-8"><a aria-hidden="true" href="#cb192-8" tabindex="-1"></a></span>
<span id="cb192-9"><a aria-hidden="true" href="#cb192-9" tabindex="-1"></a>INLINE <span class="dt">void</span></span>
<span id="cb192-10"><a aria-hidden="true" href="#cb192-10" tabindex="-1"></a>CHECK_PROCESS <span class="op">(</span>Lisp_Object x<span class="op">)</span></span>
<span id="cb192-11"><a aria-hidden="true" href="#cb192-11" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb192-12"><a aria-hidden="true" href="#cb192-12" tabindex="-1"></a>  CHECK_TYPE <span class="op">(</span>PROCESSP <span class="op">(</span>x<span class="op">),</span> Qprocessp<span class="op">,</span> x<span class="op">);</span></span>
<span id="cb192-13"><a aria-hidden="true" href="#cb192-13" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb192-14"><a aria-hidden="true" href="#cb192-14" tabindex="-1"></a></span>
<span id="cb192-15"><a aria-hidden="true" href="#cb192-15" tabindex="-1"></a>INLINE <span class="kw">struct</span> Lisp_Process <span class="op">*</span></span>
<span id="cb192-16"><a aria-hidden="true" href="#cb192-16" tabindex="-1"></a>XPROCESS <span class="op">(</span>Lisp_Object a<span class="op">)</span></span>
<span id="cb192-17"><a aria-hidden="true" href="#cb192-17" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb192-18"><a aria-hidden="true" href="#cb192-18" tabindex="-1"></a>  eassert <span class="op">(</span>PROCESSP <span class="op">(</span>a<span class="op">));</span></span>
<span id="cb192-19"><a aria-hidden="true" href="#cb192-19" tabindex="-1"></a>  <span class="cf">return</span> XUNTAG <span class="op">(</span>a<span class="op">,</span> Lisp_Vectorlike<span class="op">,</span> <span class="kw">struct</span> Lisp_Process<span class="op">);</span></span>
<span id="cb192-20"><a aria-hidden="true" href="#cb192-20" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2 data-number="9.4" id="process-creation-and-execution"><span class="header-section-number">9.4</span> Process Creation and
Execution</h2>
<h3 data-number="9.4.1" id="the-make-process-function"><span class="header-section-number">9.4.1</span> The make-process
Function</h3>
<p><code>make-process</code> is the primary interface for creating
asynchronous subprocesses:</p>
<div class="sourceCode" id="cb193"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb193-1"><a aria-hidden="true" href="#cb193-1" tabindex="-1"></a><span class="co">/* File: src/process.c, Lines: 1767-1849 */</span></span>
<span id="cb193-2"><a aria-hidden="true" href="#cb193-2" tabindex="-1"></a></span>
<span id="cb193-3"><a aria-hidden="true" href="#cb193-3" tabindex="-1"></a>DEFUN <span class="op">(</span><span class="st">"make-process"</span><span class="op">,</span> Fmake_process<span class="op">,</span> Smake_process<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> MANY<span class="op">,</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb193-4"><a aria-hidden="true" href="#cb193-4" tabindex="-1"></a>       doc<span class="op">:</span> <span class="co">/* Start a program in a subprocess.  Return the process object for it.</span></span>
<span id="cb193-5"><a aria-hidden="true" href="#cb193-5" tabindex="-1"></a></span>
<span id="cb193-6"><a aria-hidden="true" href="#cb193-6" tabindex="-1"></a><span class="co">This is similar to `start-process', but arguments are specified as</span></span>
<span id="cb193-7"><a aria-hidden="true" href="#cb193-7" tabindex="-1"></a><span class="co">keyword/argument pairs.  The following arguments are defined:</span></span>
<span id="cb193-8"><a aria-hidden="true" href="#cb193-8" tabindex="-1"></a></span>
<span id="cb193-9"><a aria-hidden="true" href="#cb193-9" tabindex="-1"></a><span class="co">:name NAME -- NAME is name for process.  It is modified if necessary</span></span>
<span id="cb193-10"><a aria-hidden="true" href="#cb193-10" tabindex="-1"></a><span class="co">to make it unique.</span></span>
<span id="cb193-11"><a aria-hidden="true" href="#cb193-11" tabindex="-1"></a></span>
<span id="cb193-12"><a aria-hidden="true" href="#cb193-12" tabindex="-1"></a><span class="co">:buffer BUFFER -- BUFFER is the buffer (or buffer-name) to associate</span></span>
<span id="cb193-13"><a aria-hidden="true" href="#cb193-13" tabindex="-1"></a><span class="co">with the process.  Process output goes at end of that buffer, unless</span></span>
<span id="cb193-14"><a aria-hidden="true" href="#cb193-14" tabindex="-1"></a><span class="co">you specify a filter function to handle the output.  BUFFER may be</span></span>
<span id="cb193-15"><a aria-hidden="true" href="#cb193-15" tabindex="-1"></a><span class="co">also nil, meaning that this process is not associated with any buffer.</span></span>
<span id="cb193-16"><a aria-hidden="true" href="#cb193-16" tabindex="-1"></a></span>
<span id="cb193-17"><a aria-hidden="true" href="#cb193-17" tabindex="-1"></a><span class="co">:command COMMAND -- COMMAND is a list starting with the program file</span></span>
<span id="cb193-18"><a aria-hidden="true" href="#cb193-18" tabindex="-1"></a><span class="co">name, followed by strings to give to the program as arguments.  If the</span></span>
<span id="cb193-19"><a aria-hidden="true" href="#cb193-19" tabindex="-1"></a><span class="co">program file name is not an absolute file name, `make-process' will</span></span>
<span id="cb193-20"><a aria-hidden="true" href="#cb193-20" tabindex="-1"></a><span class="co">look for the program file name in `exec-path' (which is a list of</span></span>
<span id="cb193-21"><a aria-hidden="true" href="#cb193-21" tabindex="-1"></a><span class="co">directories).</span></span>
<span id="cb193-22"><a aria-hidden="true" href="#cb193-22" tabindex="-1"></a></span>
<span id="cb193-23"><a aria-hidden="true" href="#cb193-23" tabindex="-1"></a><span class="co">:coding CODING -- If CODING is a symbol, it specifies the coding</span></span>
<span id="cb193-24"><a aria-hidden="true" href="#cb193-24" tabindex="-1"></a><span class="co">system used for both reading and writing for this process.  If CODING</span></span>
<span id="cb193-25"><a aria-hidden="true" href="#cb193-25" tabindex="-1"></a><span class="co">is a cons (DECODING . ENCODING), DECODING is used for reading, and</span></span>
<span id="cb193-26"><a aria-hidden="true" href="#cb193-26" tabindex="-1"></a><span class="co">ENCODING is used for writing.</span></span>
<span id="cb193-27"><a aria-hidden="true" href="#cb193-27" tabindex="-1"></a></span>
<span id="cb193-28"><a aria-hidden="true" href="#cb193-28" tabindex="-1"></a><span class="co">:noquery BOOL -- When exiting Emacs, query the user if BOOL is nil and</span></span>
<span id="cb193-29"><a aria-hidden="true" href="#cb193-29" tabindex="-1"></a><span class="co">the process is running.  If BOOL is not given, query before exiting.</span></span>
<span id="cb193-30"><a aria-hidden="true" href="#cb193-30" tabindex="-1"></a></span>
<span id="cb193-31"><a aria-hidden="true" href="#cb193-31" tabindex="-1"></a><span class="co">:stop BOOL -- BOOL must be nil.  The `:stop' key is ignored otherwise</span></span>
<span id="cb193-32"><a aria-hidden="true" href="#cb193-32" tabindex="-1"></a><span class="co">and is retained for compatibility with other process types such as</span></span>
<span id="cb193-33"><a aria-hidden="true" href="#cb193-33" tabindex="-1"></a><span class="co">pipe processes.</span></span>
<span id="cb193-34"><a aria-hidden="true" href="#cb193-34" tabindex="-1"></a></span>
<span id="cb193-35"><a aria-hidden="true" href="#cb193-35" tabindex="-1"></a><span class="co">:connection-type TYPE -- TYPE is control type of device used to</span></span>
<span id="cb193-36"><a aria-hidden="true" href="#cb193-36" tabindex="-1"></a><span class="co">communicate with subprocesses.  Values are `pipe' to use a pipe, `pty'</span></span>
<span id="cb193-37"><a aria-hidden="true" href="#cb193-37" tabindex="-1"></a><span class="co">to use a pty, or nil to use the default specified through</span></span>
<span id="cb193-38"><a aria-hidden="true" href="#cb193-38" tabindex="-1"></a><span class="co">`process-connection-type'.  If TYPE is a cons (INPUT . OUTPUT), then</span></span>
<span id="cb193-39"><a aria-hidden="true" href="#cb193-39" tabindex="-1"></a><span class="co">INPUT will be used for standard input and OUTPUT for standard output</span></span>
<span id="cb193-40"><a aria-hidden="true" href="#cb193-40" tabindex="-1"></a><span class="co">(and standard error if `:stderr' is nil).</span></span>
<span id="cb193-41"><a aria-hidden="true" href="#cb193-41" tabindex="-1"></a></span>
<span id="cb193-42"><a aria-hidden="true" href="#cb193-42" tabindex="-1"></a><span class="co">:filter FILTER -- Install FILTER as the process filter.</span></span>
<span id="cb193-43"><a aria-hidden="true" href="#cb193-43" tabindex="-1"></a></span>
<span id="cb193-44"><a aria-hidden="true" href="#cb193-44" tabindex="-1"></a><span class="co">:sentinel SENTINEL -- Install SENTINEL as the process sentinel.</span></span>
<span id="cb193-45"><a aria-hidden="true" href="#cb193-45" tabindex="-1"></a></span>
<span id="cb193-46"><a aria-hidden="true" href="#cb193-46" tabindex="-1"></a><span class="co">:stderr STDERR -- STDERR is either a buffer or a pipe process attached</span></span>
<span id="cb193-47"><a aria-hidden="true" href="#cb193-47" tabindex="-1"></a><span class="co">to the standard error of subprocess.</span></span>
<span id="cb193-48"><a aria-hidden="true" href="#cb193-48" tabindex="-1"></a></span>
<span id="cb193-49"><a aria-hidden="true" href="#cb193-49" tabindex="-1"></a><span class="co">:file-handler FILE-HANDLER -- If FILE-HANDLER is non-nil, then look</span></span>
<span id="cb193-50"><a aria-hidden="true" href="#cb193-50" tabindex="-1"></a><span class="co">for a file name handler for the current buffer's `default-directory'</span></span>
<span id="cb193-51"><a aria-hidden="true" href="#cb193-51" tabindex="-1"></a><span class="co">and invoke that file name handler to make the process.</span></span>
<span id="cb193-52"><a aria-hidden="true" href="#cb193-52" tabindex="-1"></a></span>
<span id="cb193-53"><a aria-hidden="true" href="#cb193-53" tabindex="-1"></a><span class="co">usage: (make-process &amp;rest ARGS)  */</span><span class="op">)</span></span>
<span id="cb193-54"><a aria-hidden="true" href="#cb193-54" tabindex="-1"></a>  <span class="op">(</span><span class="dt">ptrdiff_t</span> nargs<span class="op">,</span> Lisp_Object <span class="op">*</span>args<span class="op">)</span></span>
<span id="cb193-55"><a aria-hidden="true" href="#cb193-55" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb193-56"><a aria-hidden="true" href="#cb193-56" tabindex="-1"></a>  Lisp_Object buffer<span class="op">,</span> command<span class="op">,</span> program<span class="op">,</span> proc<span class="op">,</span> contact<span class="op">,</span> current_dir<span class="op">,</span> tem<span class="op">;</span></span>
<span id="cb193-57"><a aria-hidden="true" href="#cb193-57" tabindex="-1"></a>  Lisp_Object xstderr<span class="op">,</span> stderrproc<span class="op">;</span></span>
<span id="cb193-58"><a aria-hidden="true" href="#cb193-58" tabindex="-1"></a>  specpdl_ref count <span class="op">=</span> SPECPDL_INDEX <span class="op">();</span></span>
<span id="cb193-59"><a aria-hidden="true" href="#cb193-59" tabindex="-1"></a></span>
<span id="cb193-60"><a aria-hidden="true" href="#cb193-60" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>nargs <span class="op">==</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb193-61"><a aria-hidden="true" href="#cb193-61" tabindex="-1"></a>    <span class="cf">return</span> Qnil<span class="op">;</span></span>
<span id="cb193-62"><a aria-hidden="true" href="#cb193-62" tabindex="-1"></a>  CHECK_KEYWORD_ARGS <span class="op">(</span>nargs<span class="op">);</span></span>
<span id="cb193-63"><a aria-hidden="true" href="#cb193-63" tabindex="-1"></a></span>
<span id="cb193-64"><a aria-hidden="true" href="#cb193-64" tabindex="-1"></a>  <span class="co">/* Save arguments for process-contact and clone-process.  */</span></span>
<span id="cb193-65"><a aria-hidden="true" href="#cb193-65" tabindex="-1"></a>  contact <span class="op">=</span> Flist <span class="op">(</span>nargs<span class="op">,</span> args<span class="op">);</span></span>
<span id="cb193-66"><a aria-hidden="true" href="#cb193-66" tabindex="-1"></a></span>
<span id="cb193-67"><a aria-hidden="true" href="#cb193-67" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(!</span>NILP <span class="op">(</span>plist_get <span class="op">(</span>contact<span class="op">,</span> QCfile_handler<span class="op">)))</span></span>
<span id="cb193-68"><a aria-hidden="true" href="#cb193-68" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb193-69"><a aria-hidden="true" href="#cb193-69" tabindex="-1"></a>      Lisp_Object file_handler</span>
<span id="cb193-70"><a aria-hidden="true" href="#cb193-70" tabindex="-1"></a>        <span class="op">=</span> Ffind_file_name_handler <span class="op">(</span>BVAR <span class="op">(</span>current_buffer<span class="op">,</span> directory<span class="op">),</span></span>
<span id="cb193-71"><a aria-hidden="true" href="#cb193-71" tabindex="-1"></a>                                   Qmake_process<span class="op">);</span></span>
<span id="cb193-72"><a aria-hidden="true" href="#cb193-72" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(!</span>NILP <span class="op">(</span>file_handler<span class="op">))</span></span>
<span id="cb193-73"><a aria-hidden="true" href="#cb193-73" tabindex="-1"></a>        <span class="cf">return</span> CALLN <span class="op">(</span>Fapply<span class="op">,</span> file_handler<span class="op">,</span> Qmake_process<span class="op">,</span> contact<span class="op">);</span></span>
<span id="cb193-74"><a aria-hidden="true" href="#cb193-74" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb193-75"><a aria-hidden="true" href="#cb193-75" tabindex="-1"></a></span>
<span id="cb193-76"><a aria-hidden="true" href="#cb193-76" tabindex="-1"></a>  buffer <span class="op">=</span> plist_get <span class="op">(</span>contact<span class="op">,</span> QCbuffer<span class="op">);</span></span>
<span id="cb193-77"><a aria-hidden="true" href="#cb193-77" tabindex="-1"></a>  <span class="co">/* ... continued ... */</span></span></code></pre></div>
<p><strong>Process Creation Flow:</strong></p>
<ol type="1">
<li>Parse keyword arguments</li>
<li>Check for file handlers (TRAMP support)</li>
<li>Validate buffer and command</li>
<li>Set up encoding/decoding</li>
<li>Allocate PTY if needed</li>
<li>Fork and exec subprocess</li>
<li>Set up I/O descriptors</li>
<li>Install filter and sentinel</li>
<li>Add to process list</li>
</ol>
<h3 data-number="9.4.2" id="synchronous-vs.-asynchronous-processes"><span class="header-section-number">9.4.2</span> Synchronous vs.¬†Asynchronous
Processes</h3>
<p>Emacs supports two models:</p>
<p><strong>Asynchronous (process.c):</strong></p>
<pre class="elisp"><code>;; Non-blocking, returns immediately
(make-process :name "async"
              :buffer "*output*"
              :command '("long-running-command"))</code></pre>
<p><strong>Synchronous (callproc.c):</strong></p>
<pre class="elisp"><code>;; Blocks until completion
(call-process "command" nil t nil "arg1" "arg2")</code></pre>
<h3 data-number="9.4.3" id="forkexec-model"><span class="header-section-number">9.4.3</span> Fork/Exec Model</h3>
<p>The traditional Unix process creation follows this pattern:</p>
<div class="sourceCode" id="cb196"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb196-1"><a aria-hidden="true" href="#cb196-1" tabindex="-1"></a><span class="co">/* Conceptual flow - actual implementation in src/process.c */</span></span>
<span id="cb196-2"><a aria-hidden="true" href="#cb196-2" tabindex="-1"></a></span>
<span id="cb196-3"><a aria-hidden="true" href="#cb196-3" tabindex="-1"></a><span class="fl">1.</span> allocate_pty<span class="op">()</span> <span class="op">-</span> <span class="cf">if</span> PTY requested</span>
<span id="cb196-4"><a aria-hidden="true" href="#cb196-4" tabindex="-1"></a><span class="fl">2.</span> Setup file descriptors <span class="op">(</span>pipes or PTY<span class="op">)</span></span>
<span id="cb196-5"><a aria-hidden="true" href="#cb196-5" tabindex="-1"></a><span class="fl">3.</span> block_child_signal<span class="op">()</span> <span class="op">-</span> prevent race conditions</span>
<span id="cb196-6"><a aria-hidden="true" href="#cb196-6" tabindex="-1"></a><span class="fl">4.</span> fork<span class="op">()</span> <span class="op">-</span> create child process</span>
<span id="cb196-7"><a aria-hidden="true" href="#cb196-7" tabindex="-1"></a><span class="fl">5.</span> In child<span class="op">:</span></span>
<span id="cb196-8"><a aria-hidden="true" href="#cb196-8" tabindex="-1"></a>   <span class="op">-</span> dup2<span class="op">()</span> to redirect stdin<span class="op">/</span>stdout<span class="op">/</span>stderr</span>
<span id="cb196-9"><a aria-hidden="true" href="#cb196-9" tabindex="-1"></a>   <span class="op">-</span> close unused file descriptors</span>
<span id="cb196-10"><a aria-hidden="true" href="#cb196-10" tabindex="-1"></a>   <span class="op">-</span> set process group <span class="op">(</span>setsid<span class="op">)</span></span>
<span id="cb196-11"><a aria-hidden="true" href="#cb196-11" tabindex="-1"></a>   <span class="op">-</span> execvp<span class="op">()</span> to run program</span>
<span id="cb196-12"><a aria-hidden="true" href="#cb196-12" tabindex="-1"></a><span class="fl">6.</span> In parent<span class="op">:</span></span>
<span id="cb196-13"><a aria-hidden="true" href="#cb196-13" tabindex="-1"></a>   <span class="op">-</span> Store process information</span>
<span id="cb196-14"><a aria-hidden="true" href="#cb196-14" tabindex="-1"></a>   <span class="op">-</span> Setup read<span class="op">/</span>write descriptors</span>
<span id="cb196-15"><a aria-hidden="true" href="#cb196-15" tabindex="-1"></a>   <span class="op">-</span> Add to process list</span>
<span id="cb196-16"><a aria-hidden="true" href="#cb196-16" tabindex="-1"></a><span class="fl">7.</span> unblock_child_signal<span class="op">()</span></span></code></pre></div>
<h3 data-number="9.4.4" id="modern-alternative-posix_spawn"><span class="header-section-number">9.4.4</span> Modern Alternative:
posix_spawn</h3>
<p>On systems that support it, Emacs can use <code>posix_spawn</code>
for better performance:</p>
<div class="sourceCode" id="cb197"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb197-1"><a aria-hidden="true" href="#cb197-1" tabindex="-1"></a><span class="co">/* File: src/callproc.c, Lines: 34-49 */</span></span>
<span id="cb197-2"><a aria-hidden="true" href="#cb197-2" tabindex="-1"></a></span>
<span id="cb197-3"><a aria-hidden="true" href="#cb197-3" tabindex="-1"></a><span class="co">/* In order to be able to use `posix_spawn', it needs to support some</span></span>
<span id="cb197-4"><a aria-hidden="true" href="#cb197-4" tabindex="-1"></a><span class="co">   variant of `chdir' as well as `setsid'.  */</span></span>
<span id="cb197-5"><a aria-hidden="true" href="#cb197-5" tabindex="-1"></a><span class="pp">#if defined HAVE_SPAWN_H &amp;&amp; defined HAVE_POSIX_SPAWN        </span><span class="op">\</span></span>
<span id="cb197-6"><a aria-hidden="true" href="#cb197-6" tabindex="-1"></a><span class="pp">  &amp;&amp; defined HAVE_POSIX_SPAWNATTR_SETFLAGS                  </span><span class="op">\</span></span>
<span id="cb197-7"><a aria-hidden="true" href="#cb197-7" tabindex="-1"></a><span class="pp">  &amp;&amp; (defined HAVE_POSIX_SPAWN_FILE_ACTIONS_ADDCHDIR        </span><span class="op">\</span></span>
<span id="cb197-8"><a aria-hidden="true" href="#cb197-8" tabindex="-1"></a><span class="pp">      || defined HAVE_POSIX_SPAWN_FILE_ACTIONS_ADDCHDIR_NP) </span><span class="op">\</span></span>
<span id="cb197-9"><a aria-hidden="true" href="#cb197-9" tabindex="-1"></a><span class="pp">  &amp;&amp; defined HAVE_DECL_POSIX_SPAWN_SETSID                   </span><span class="op">\</span></span>
<span id="cb197-10"><a aria-hidden="true" href="#cb197-10" tabindex="-1"></a><span class="pp">  &amp;&amp; HAVE_DECL_POSIX_SPAWN_SETSID == 1</span></span>
<span id="cb197-11"><a aria-hidden="true" href="#cb197-11" tabindex="-1"></a><span class="pp"># include </span><span class="im">&lt;spawn.h&gt;</span></span>
<span id="cb197-12"><a aria-hidden="true" href="#cb197-12" tabindex="-1"></a><span class="pp"># define USABLE_POSIX_SPAWN </span><span class="dv">1</span></span>
<span id="cb197-13"><a aria-hidden="true" href="#cb197-13" tabindex="-1"></a><span class="pp">#else</span></span>
<span id="cb197-14"><a aria-hidden="true" href="#cb197-14" tabindex="-1"></a><span class="pp"># define USABLE_POSIX_SPAWN </span><span class="dv">0</span></span>
<span id="cb197-15"><a aria-hidden="true" href="#cb197-15" tabindex="-1"></a><span class="pp">#endif</span></span></code></pre></div>
<p>Benefits of <code>posix_spawn</code>: - Faster than fork/exec on some
systems - Better memory efficiency - Avoids vfork issues - Atomic setup
of file descriptors and environment</p>
<h2 data-number="9.5" id="io-system"><span class="header-section-number">9.5</span> I/O System</h2>
<h3 data-number="9.5.1" id="non-blocking-io-architecture"><span class="header-section-number">9.5.1</span> Non-Blocking I/O
Architecture</h3>
<p>Emacs uses non-blocking I/O for all asynchronous processes:</p>
<div class="sourceCode" id="cb198"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb198-1"><a aria-hidden="true" href="#cb198-1" tabindex="-1"></a><span class="co">/* File: src/process.c, Lines: 184-192 */</span></span>
<span id="cb198-2"><a aria-hidden="true" href="#cb198-2" tabindex="-1"></a></span>
<span id="cb198-3"><a aria-hidden="true" href="#cb198-3" tabindex="-1"></a><span class="co">/* True if ERRNUM represents an error where the system call would</span></span>
<span id="cb198-4"><a aria-hidden="true" href="#cb198-4" tabindex="-1"></a><span class="co">   block if a blocking variant were used.  */</span></span>
<span id="cb198-5"><a aria-hidden="true" href="#cb198-5" tabindex="-1"></a><span class="dt">static</span> <span class="dt">bool</span></span>
<span id="cb198-6"><a aria-hidden="true" href="#cb198-6" tabindex="-1"></a>would_block <span class="op">(</span><span class="dt">int</span> errnum<span class="op">)</span></span>
<span id="cb198-7"><a aria-hidden="true" href="#cb198-7" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb198-8"><a aria-hidden="true" href="#cb198-8" tabindex="-1"></a><span class="pp">#ifdef EWOULDBLOCK</span></span>
<span id="cb198-9"><a aria-hidden="true" href="#cb198-9" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>EWOULDBLOCK <span class="op">!=</span> EAGAIN <span class="op">&amp;&amp;</span> errnum <span class="op">==</span> EWOULDBLOCK<span class="op">)</span></span>
<span id="cb198-10"><a aria-hidden="true" href="#cb198-10" tabindex="-1"></a>    <span class="cf">return</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb198-11"><a aria-hidden="true" href="#cb198-11" tabindex="-1"></a><span class="pp">#endif</span></span>
<span id="cb198-12"><a aria-hidden="true" href="#cb198-12" tabindex="-1"></a>  <span class="cf">return</span> errnum <span class="op">==</span> EAGAIN<span class="op">;</span></span>
<span id="cb198-13"><a aria-hidden="true" href="#cb198-13" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 data-number="9.5.2" id="the-main-event-loop-wait_reading_process_output"><span class="header-section-number">9.5.2</span> The Main Event Loop:
wait_reading_process_output</h3>
<p>This is the heart of Emacs‚Äôs I/O system:</p>
<div class="sourceCode" id="cb199"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb199-1"><a aria-hidden="true" href="#cb199-1" tabindex="-1"></a><span class="co">/* File: src/process.c - Conceptual Overview */</span></span>
<span id="cb199-2"><a aria-hidden="true" href="#cb199-2" tabindex="-1"></a></span>
<span id="cb199-3"><a aria-hidden="true" href="#cb199-3" tabindex="-1"></a>wait_reading_process_output <span class="op">(</span></span>
<span id="cb199-4"><a aria-hidden="true" href="#cb199-4" tabindex="-1"></a>    <span class="dt">intmax_t</span> time_limit<span class="op">,</span>     <span class="co">/* Maximum time to wait */</span></span>
<span id="cb199-5"><a aria-hidden="true" href="#cb199-5" tabindex="-1"></a>    <span class="dt">int</span> nsecs<span class="op">,</span>               <span class="co">/* Nanoseconds component */</span></span>
<span id="cb199-6"><a aria-hidden="true" href="#cb199-6" tabindex="-1"></a>    <span class="dt">int</span> read_kbd<span class="op">,</span>            <span class="co">/* Also check for keyboard input */</span></span>
<span id="cb199-7"><a aria-hidden="true" href="#cb199-7" tabindex="-1"></a>    <span class="dt">bool</span> do_display<span class="op">,</span>         <span class="co">/* Update display while waiting */</span></span>
<span id="cb199-8"><a aria-hidden="true" href="#cb199-8" tabindex="-1"></a>    Lisp_Object wait_for_cell<span class="op">,</span></span>
<span id="cb199-9"><a aria-hidden="true" href="#cb199-9" tabindex="-1"></a>    <span class="kw">struct</span> Lisp_Process <span class="op">*</span>wait_proc<span class="op">,</span></span>
<span id="cb199-10"><a aria-hidden="true" href="#cb199-10" tabindex="-1"></a>    <span class="dt">int</span> just_wait_proc<span class="op">)</span></span>
<span id="cb199-11"><a aria-hidden="true" href="#cb199-11" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb199-12"><a aria-hidden="true" href="#cb199-12" tabindex="-1"></a>    <span class="co">/* Key responsibilities:</span></span>
<span id="cb199-13"><a aria-hidden="true" href="#cb199-13" tabindex="-1"></a><span class="co">       1. Use select()/pselect() to wait for I/O</span></span>
<span id="cb199-14"><a aria-hidden="true" href="#cb199-14" tabindex="-1"></a><span class="co">       2. Handle process output when available</span></span>
<span id="cb199-15"><a aria-hidden="true" href="#cb199-15" tabindex="-1"></a><span class="co">       3. Check for keyboard input if requested</span></span>
<span id="cb199-16"><a aria-hidden="true" href="#cb199-16" tabindex="-1"></a><span class="co">       4. Handle SIGCHLD (process status changes)</span></span>
<span id="cb199-17"><a aria-hidden="true" href="#cb199-17" tabindex="-1"></a><span class="co">       5. Respect timeouts</span></span>
<span id="cb199-18"><a aria-hidden="true" href="#cb199-18" tabindex="-1"></a><span class="co">       6. Update display if requested</span></span>
<span id="cb199-19"><a aria-hidden="true" href="#cb199-19" tabindex="-1"></a><span class="co">    */</span></span>
<span id="cb199-20"><a aria-hidden="true" href="#cb199-20" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>Event Loop Flow:</strong></p>
<pre><code>‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ wait_reading_process_output         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
            ‚îÇ
            ‚îú‚îÄ‚ñ∫ Setup file descriptor sets (FD_SET)
            ‚îÇ
            ‚îú‚îÄ‚ñ∫ Call select()/pselect() - Wait for events
            ‚îÇ
            ‚îú‚îÄ‚ñ∫ Process available input:
            ‚îÇ   ‚îÇ
            ‚îÇ   ‚îú‚îÄ‚ñ∫ read_process_output()
            ‚îÇ   ‚îÇ   ‚îú‚îÄ‚ñ∫ Read from file descriptor
            ‚îÇ   ‚îÇ   ‚îú‚îÄ‚ñ∫ Decode using coding system
            ‚îÇ   ‚îÇ   ‚îî‚îÄ‚ñ∫ Call filter or insert in buffer
            ‚îÇ   ‚îÇ
            ‚îÇ   ‚îî‚îÄ‚ñ∫ Check keyboard input
            ‚îÇ
            ‚îú‚îÄ‚ñ∫ Handle SIGCHLD:
            ‚îÇ   ‚îî‚îÄ‚ñ∫ Update process status
            ‚îÇ       ‚îî‚îÄ‚ñ∫ Call sentinel if status changed
            ‚îÇ
            ‚îî‚îÄ‚ñ∫ Check timeout and continue or return</code></pre>
<h3 data-number="9.5.3" id="reading-process-output"><span class="header-section-number">9.5.3</span> Reading Process Output</h3>
<div class="sourceCode" id="cb201"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb201-1"><a aria-hidden="true" href="#cb201-1" tabindex="-1"></a><span class="co">/* File: src/process.c, Line: 274 */</span></span>
<span id="cb201-2"><a aria-hidden="true" href="#cb201-2" tabindex="-1"></a><span class="dt">static</span> <span class="dt">int</span> read_process_output <span class="op">(</span>Lisp_Object proc<span class="op">,</span> <span class="dt">int</span> wait_proc_fd<span class="op">);</span></span>
<span id="cb201-3"><a aria-hidden="true" href="#cb201-3" tabindex="-1"></a></span>
<span id="cb201-4"><a aria-hidden="true" href="#cb201-4" tabindex="-1"></a><span class="co">/* This function:</span></span>
<span id="cb201-5"><a aria-hidden="true" href="#cb201-5" tabindex="-1"></a><span class="co">   1. Reads available data from the process</span></span>
<span id="cb201-6"><a aria-hidden="true" href="#cb201-6" tabindex="-1"></a><span class="co">   2. Handles encoding/decoding</span></span>
<span id="cb201-7"><a aria-hidden="true" href="#cb201-7" tabindex="-1"></a><span class="co">   3. Either calls the filter function or inserts into buffer</span></span>
<span id="cb201-8"><a aria-hidden="true" href="#cb201-8" tabindex="-1"></a><span class="co">   4. Manages adaptive read buffering</span></span>
<span id="cb201-9"><a aria-hidden="true" href="#cb201-9" tabindex="-1"></a><span class="co">   5. Updates process markers</span></span>
<span id="cb201-10"><a aria-hidden="true" href="#cb201-10" tabindex="-1"></a><span class="co">*/</span></span></code></pre></div>
<p><strong>Adaptive Read Buffering:</strong></p>
<div class="sourceCode" id="cb202"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb202-1"><a aria-hidden="true" href="#cb202-1" tabindex="-1"></a><span class="co">/* File: src/process.h, Lines: 150-164 */</span></span>
<span id="cb202-2"><a aria-hidden="true" href="#cb202-2" tabindex="-1"></a></span>
<span id="cb202-3"><a aria-hidden="true" href="#cb202-3" tabindex="-1"></a><span class="co">/* Hysteresis to try to read process output in larger blocks.</span></span>
<span id="cb202-4"><a aria-hidden="true" href="#cb202-4" tabindex="-1"></a><span class="co">   On some systems, e.g. GNU/Linux, Emacs is seen as</span></span>
<span id="cb202-5"><a aria-hidden="true" href="#cb202-5" tabindex="-1"></a><span class="co">   an interactive app also when reading process output, meaning</span></span>
<span id="cb202-6"><a aria-hidden="true" href="#cb202-6" tabindex="-1"></a><span class="co">   that process output can be read in as little as 1 byte at a</span></span>
<span id="cb202-7"><a aria-hidden="true" href="#cb202-7" tabindex="-1"></a><span class="co">   time.  Value is nanoseconds to delay reading output from</span></span>
<span id="cb202-8"><a aria-hidden="true" href="#cb202-8" tabindex="-1"></a><span class="co">   this process.  Range is 0 .. 50 * 1000 * 1000.  */</span></span>
<span id="cb202-9"><a aria-hidden="true" href="#cb202-9" tabindex="-1"></a><span class="dt">int</span> read_output_delay<span class="op">;</span></span>
<span id="cb202-10"><a aria-hidden="true" href="#cb202-10" tabindex="-1"></a></span>
<span id="cb202-11"><a aria-hidden="true" href="#cb202-11" tabindex="-1"></a><span class="co">/* Should we delay reading output from this process.</span></span>
<span id="cb202-12"><a aria-hidden="true" href="#cb202-12" tabindex="-1"></a><span class="co">   Initialized from `Vprocess_adaptive_read_buffering'.</span></span>
<span id="cb202-13"><a aria-hidden="true" href="#cb202-13" tabindex="-1"></a><span class="co">   0 = nil, 1 = t, 2 = other.  */</span></span>
<span id="cb202-14"><a aria-hidden="true" href="#cb202-14" tabindex="-1"></a><span class="dt">unsigned</span> <span class="dt">int</span> adaptive_read_buffering <span class="op">:</span> <span class="dv">2</span><span class="op">;</span></span></code></pre></div>
<p>This clever optimization delays reading by a small amount to allow
the OS to buffer more data, reducing the number of small reads.</p>
<h3 data-number="9.5.4" id="encoding-and-decoding-on-the-fly"><span class="header-section-number">9.5.4</span> Encoding and Decoding on the
Fly</h3>
<p>All process I/O goes through Emacs‚Äôs coding system:</p>
<div class="sourceCode" id="cb203"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb203-1"><a aria-hidden="true" href="#cb203-1" tabindex="-1"></a><span class="co">/* File: src/process.c, Lines: 6500-6518 */</span></span>
<span id="cb203-2"><a aria-hidden="true" href="#cb203-2" tabindex="-1"></a></span>
<span id="cb203-3"><a aria-hidden="true" href="#cb203-3" tabindex="-1"></a><span class="co">/* Decoding input from process */</span></span>
<span id="cb203-4"><a aria-hidden="true" href="#cb203-4" tabindex="-1"></a>decode_coding_c_string <span class="op">(</span>process_coding<span class="op">,</span></span>
<span id="cb203-5"><a aria-hidden="true" href="#cb203-5" tabindex="-1"></a>                        <span class="op">(</span><span class="dt">unsigned</span> <span class="dt">char</span> <span class="op">*)</span> buf<span class="op">,</span> nread<span class="op">,</span> curbuf<span class="op">);</span></span>
<span id="cb203-6"><a aria-hidden="true" href="#cb203-6" tabindex="-1"></a></span>
<span id="cb203-7"><a aria-hidden="true" href="#cb203-7" tabindex="-1"></a><span class="co">/* After decoding, insert into buffer */</span></span>
<span id="cb203-8"><a aria-hidden="true" href="#cb203-8" tabindex="-1"></a>TEMP_SET_PT_BOTH <span class="op">(</span>PT <span class="op">+</span> process_coding<span class="op">-&gt;</span>produced_char<span class="op">,</span></span>
<span id="cb203-9"><a aria-hidden="true" href="#cb203-9" tabindex="-1"></a>                  PT_BYTE <span class="op">+</span> process_coding<span class="op">-&gt;</span>produced<span class="op">);</span></span></code></pre></div>
<p><strong>Encoding output to process:</strong></p>
<div class="sourceCode" id="cb204"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb204-1"><a aria-hidden="true" href="#cb204-1" tabindex="-1"></a><span class="co">/* File: src/process.c, Lines: 6714+ */</span></span>
<span id="cb204-2"><a aria-hidden="true" href="#cb204-2" tabindex="-1"></a></span>
<span id="cb204-3"><a aria-hidden="true" href="#cb204-3" tabindex="-1"></a>send_process <span class="op">(</span>Lisp_Object proc<span class="op">,</span> <span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>buf<span class="op">,</span> <span class="dt">ptrdiff_t</span> len<span class="op">,</span></span>
<span id="cb204-4"><a aria-hidden="true" href="#cb204-4" tabindex="-1"></a>              Lisp_Object object<span class="op">)</span></span>
<span id="cb204-5"><a aria-hidden="true" href="#cb204-5" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb204-6"><a aria-hidden="true" href="#cb204-6" tabindex="-1"></a>  <span class="kw">struct</span> Lisp_Process <span class="op">*</span>p <span class="op">=</span> XPROCESS <span class="op">(</span>proc<span class="op">);</span></span>
<span id="cb204-7"><a aria-hidden="true" href="#cb204-7" tabindex="-1"></a>  <span class="dt">ssize_t</span> rv<span class="op">;</span></span>
<span id="cb204-8"><a aria-hidden="true" href="#cb204-8" tabindex="-1"></a>  <span class="kw">struct</span> coding_system <span class="op">*</span>coding<span class="op">;</span></span>
<span id="cb204-9"><a aria-hidden="true" href="#cb204-9" tabindex="-1"></a></span>
<span id="cb204-10"><a aria-hidden="true" href="#cb204-10" tabindex="-1"></a>  <span class="co">/* ... encoding happens here ... */</span></span>
<span id="cb204-11"><a aria-hidden="true" href="#cb204-11" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>Key Points:</strong></p>
<ol type="1">
<li>Input is decoded from process‚Äôs character set to Emacs‚Äôs internal
format</li>
<li>Output is encoded from internal format to process‚Äôs character
set</li>
<li>Partial character sequences are handled across read boundaries</li>
<li><code>decoding_carryover</code> field stores incomplete multibyte
sequences</li>
</ol>
<h3 data-number="9.5.5" id="process-output-buffering"><span class="header-section-number">9.5.5</span> Process Output Buffering</h3>
<p>Output can be handled two ways:</p>
<p><strong>1. Direct insertion (default):</strong></p>
<div class="sourceCode" id="cb205"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb205-1"><a aria-hidden="true" href="#cb205-1" tabindex="-1"></a><span class="co">/* File: src/process.c, Lines: 6589-6599 */</span></span>
<span id="cb205-2"><a aria-hidden="true" href="#cb205-2" tabindex="-1"></a></span>
<span id="cb205-3"><a aria-hidden="true" href="#cb205-3" tabindex="-1"></a>DEFUN <span class="op">(</span><span class="st">"internal-default-process-filter"</span><span class="op">,</span> Finternal_default_process_filter<span class="op">,</span></span>
<span id="cb205-4"><a aria-hidden="true" href="#cb205-4" tabindex="-1"></a>       Sinternal_default_process_filter<span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb205-5"><a aria-hidden="true" href="#cb205-5" tabindex="-1"></a>       doc<span class="op">:</span> <span class="co">/* Function used as default process filter.</span></span>
<span id="cb205-6"><a aria-hidden="true" href="#cb205-6" tabindex="-1"></a><span class="co">This inserts the process's output into its buffer, if there is one.</span></span>
<span id="cb205-7"><a aria-hidden="true" href="#cb205-7" tabindex="-1"></a><span class="co">Otherwise it discards the output.  */</span><span class="op">)</span></span>
<span id="cb205-8"><a aria-hidden="true" href="#cb205-8" tabindex="-1"></a>  <span class="op">(</span>Lisp_Object proc<span class="op">,</span> Lisp_Object text<span class="op">)</span></span>
<span id="cb205-9"><a aria-hidden="true" href="#cb205-9" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb205-10"><a aria-hidden="true" href="#cb205-10" tabindex="-1"></a>  <span class="kw">struct</span> Lisp_Process <span class="op">*</span>p<span class="op">;</span></span>
<span id="cb205-11"><a aria-hidden="true" href="#cb205-11" tabindex="-1"></a></span>
<span id="cb205-12"><a aria-hidden="true" href="#cb205-12" tabindex="-1"></a>  CHECK_PROCESS <span class="op">(</span>proc<span class="op">);</span></span>
<span id="cb205-13"><a aria-hidden="true" href="#cb205-13" tabindex="-1"></a>  p <span class="op">=</span> XPROCESS <span class="op">(</span>proc<span class="op">);</span></span>
<span id="cb205-14"><a aria-hidden="true" href="#cb205-14" tabindex="-1"></a>  <span class="co">/* Insert text at process mark... */</span></span>
<span id="cb205-15"><a aria-hidden="true" href="#cb205-15" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>2. Custom filter function:</strong></p>
<div class="sourceCode" id="cb206"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb206-1"><a aria-hidden="true" href="#cb206-1" tabindex="-1"></a><span class="co">/* File: src/process.c, Lines: 6521-6587 */</span></span>
<span id="cb206-2"><a aria-hidden="true" href="#cb206-2" tabindex="-1"></a></span>
<span id="cb206-3"><a aria-hidden="true" href="#cb206-3" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span></span>
<span id="cb206-4"><a aria-hidden="true" href="#cb206-4" tabindex="-1"></a>read_and_dispose_of_process_output <span class="op">(</span><span class="kw">struct</span> Lisp_Process <span class="op">*</span>p<span class="op">,</span> <span class="dt">char</span> <span class="op">*</span>chars<span class="op">,</span></span>
<span id="cb206-5"><a aria-hidden="true" href="#cb206-5" tabindex="-1"></a>                                    <span class="dt">ssize_t</span> nbytes<span class="op">,</span></span>
<span id="cb206-6"><a aria-hidden="true" href="#cb206-6" tabindex="-1"></a>                                    <span class="kw">struct</span> coding_system <span class="op">*</span>coding<span class="op">)</span></span>
<span id="cb206-7"><a aria-hidden="true" href="#cb206-7" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb206-8"><a aria-hidden="true" href="#cb206-8" tabindex="-1"></a>  Lisp_Object outstream <span class="op">=</span> p<span class="op">-&gt;</span>filter<span class="op">;</span></span>
<span id="cb206-9"><a aria-hidden="true" href="#cb206-9" tabindex="-1"></a></span>
<span id="cb206-10"><a aria-hidden="true" href="#cb206-10" tabindex="-1"></a>  <span class="co">/* ... setup ... */</span></span>
<span id="cb206-11"><a aria-hidden="true" href="#cb206-11" tabindex="-1"></a></span>
<span id="cb206-12"><a aria-hidden="true" href="#cb206-12" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>fast_read_process_output</span>
<span id="cb206-13"><a aria-hidden="true" href="#cb206-13" tabindex="-1"></a>      <span class="op">&amp;&amp;</span> EQ <span class="op">(</span>p<span class="op">-&gt;</span>filter<span class="op">,</span> Qinternal_default_process_filter<span class="op">))</span></span>
<span id="cb206-14"><a aria-hidden="true" href="#cb206-14" tabindex="-1"></a>    read_and_insert_process_output <span class="op">(</span>p<span class="op">,</span> chars<span class="op">,</span> nbytes<span class="op">,</span> coding<span class="op">);</span></span>
<span id="cb206-15"><a aria-hidden="true" href="#cb206-15" tabindex="-1"></a>  <span class="cf">else</span></span>
<span id="cb206-16"><a aria-hidden="true" href="#cb206-16" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb206-17"><a aria-hidden="true" href="#cb206-17" tabindex="-1"></a>      decode_coding_c_string <span class="op">(</span>coding<span class="op">,</span> <span class="op">(</span><span class="dt">unsigned</span> <span class="dt">char</span> <span class="op">*)</span> chars<span class="op">,</span> nbytes<span class="op">,</span> Qt<span class="op">);</span></span>
<span id="cb206-18"><a aria-hidden="true" href="#cb206-18" tabindex="-1"></a>      text <span class="op">=</span> coding<span class="op">-&gt;</span>dst_object<span class="op">;</span></span>
<span id="cb206-19"><a aria-hidden="true" href="#cb206-19" tabindex="-1"></a></span>
<span id="cb206-20"><a aria-hidden="true" href="#cb206-20" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span>SBYTES <span class="op">(</span>text<span class="op">)</span> <span class="op">&gt;</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb206-21"><a aria-hidden="true" href="#cb206-21" tabindex="-1"></a>        internal_condition_case_1 <span class="op">(</span>read_process_output_call<span class="op">,</span></span>
<span id="cb206-22"><a aria-hidden="true" href="#cb206-22" tabindex="-1"></a>                                   list3 <span class="op">(</span>outstream<span class="op">,</span> make_lisp_proc <span class="op">(</span>p<span class="op">),</span> text<span class="op">),</span></span>
<span id="cb206-23"><a aria-hidden="true" href="#cb206-23" tabindex="-1"></a>                                   <span class="op">!</span>NILP <span class="op">(</span>Vdebug_on_error<span class="op">)</span> <span class="op">?</span> Qnil <span class="op">:</span> Qerror<span class="op">,</span></span>
<span id="cb206-24"><a aria-hidden="true" href="#cb206-24" tabindex="-1"></a>                                   read_process_output_error_handler<span class="op">);</span></span>
<span id="cb206-25"><a aria-hidden="true" href="#cb206-25" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb206-26"><a aria-hidden="true" href="#cb206-26" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 data-number="9.5.6" id="write-queue-for-output"><span class="header-section-number">9.5.6</span> Write Queue for Output</h3>
<p>When a process can‚Äôt accept all data immediately, Emacs queues
it:</p>
<div class="sourceCode" id="cb207"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb207-1"><a aria-hidden="true" href="#cb207-1" tabindex="-1"></a><span class="co">/* File: src/process.h, Line: 115 */</span></span>
<span id="cb207-2"><a aria-hidden="true" href="#cb207-2" tabindex="-1"></a></span>
<span id="cb207-3"><a aria-hidden="true" href="#cb207-3" tabindex="-1"></a><span class="co">/* Queue for storing waiting writes.  */</span></span>
<span id="cb207-4"><a aria-hidden="true" href="#cb207-4" tabindex="-1"></a>Lisp_Object write_queue<span class="op">;</span></span></code></pre></div>
<p>This allows non-blocking writes and prevents data loss when the
pipe/socket is full.</p>
<h2 data-number="9.6" id="process-filters-and-sentinels"><span class="header-section-number">9.6</span> Process Filters and
Sentinels</h2>
<h3 data-number="9.6.1" id="process-filters"><span class="header-section-number">9.6.1</span> Process Filters</h3>
<p>Filters are the primary mechanism for handling process output:</p>
<pre class="elisp"><code>;; Install a filter
(set-process-filter proc
  (lambda (proc string)
    (with-current-buffer (process-buffer proc)
      (goto-char (point-max))
      (insert (format "Received: %s" string)))))</code></pre>
<p><strong>C Implementation:</strong></p>
<div class="sourceCode" id="cb209"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb209-1"><a aria-hidden="true" href="#cb209-1" tabindex="-1"></a><span class="co">/* File: src/process.c, Lines: 1359-1407 */</span></span>
<span id="cb209-2"><a aria-hidden="true" href="#cb209-2" tabindex="-1"></a></span>
<span id="cb209-3"><a aria-hidden="true" href="#cb209-3" tabindex="-1"></a>DEFUN <span class="op">(</span><span class="st">"set-process-filter"</span><span class="op">,</span> Fset_process_filter<span class="op">,</span> Sset_process_filter<span class="op">,</span></span>
<span id="cb209-4"><a aria-hidden="true" href="#cb209-4" tabindex="-1"></a>       <span class="dv">2</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb209-5"><a aria-hidden="true" href="#cb209-5" tabindex="-1"></a>       doc<span class="op">:</span> <span class="co">/* Give PROCESS the filter function FILTER; nil means default.</span></span>
<span id="cb209-6"><a aria-hidden="true" href="#cb209-6" tabindex="-1"></a><span class="co">A value of t means stop accepting output from the process.</span></span>
<span id="cb209-7"><a aria-hidden="true" href="#cb209-7" tabindex="-1"></a></span>
<span id="cb209-8"><a aria-hidden="true" href="#cb209-8" tabindex="-1"></a><span class="co">When a process has a non-default filter, its buffer is not used for output.</span></span>
<span id="cb209-9"><a aria-hidden="true" href="#cb209-9" tabindex="-1"></a><span class="co">Instead, each time it does output, the entire string of output is</span></span>
<span id="cb209-10"><a aria-hidden="true" href="#cb209-10" tabindex="-1"></a><span class="co">passed to the filter.</span></span>
<span id="cb209-11"><a aria-hidden="true" href="#cb209-11" tabindex="-1"></a></span>
<span id="cb209-12"><a aria-hidden="true" href="#cb209-12" tabindex="-1"></a><span class="co">The filter gets two arguments: the process and the string of output.</span></span>
<span id="cb209-13"><a aria-hidden="true" href="#cb209-13" tabindex="-1"></a><span class="co">The string argument is normally a multibyte string, except:</span></span>
<span id="cb209-14"><a aria-hidden="true" href="#cb209-14" tabindex="-1"></a><span class="co">- if the process's input coding system is no-conversion or raw-text,</span></span>
<span id="cb209-15"><a aria-hidden="true" href="#cb209-15" tabindex="-1"></a><span class="co">  it is a unibyte string (the non-converted input).  */</span><span class="op">)</span></span>
<span id="cb209-16"><a aria-hidden="true" href="#cb209-16" tabindex="-1"></a>  <span class="op">(</span>Lisp_Object process<span class="op">,</span> Lisp_Object filter<span class="op">)</span></span>
<span id="cb209-17"><a aria-hidden="true" href="#cb209-17" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb209-18"><a aria-hidden="true" href="#cb209-18" tabindex="-1"></a>  CHECK_PROCESS <span class="op">(</span>process<span class="op">);</span></span>
<span id="cb209-19"><a aria-hidden="true" href="#cb209-19" tabindex="-1"></a>  <span class="kw">struct</span> Lisp_Process <span class="op">*</span>p <span class="op">=</span> XPROCESS <span class="op">(</span>process<span class="op">);</span></span>
<span id="cb209-20"><a aria-hidden="true" href="#cb209-20" tabindex="-1"></a></span>
<span id="cb209-21"><a aria-hidden="true" href="#cb209-21" tabindex="-1"></a>  <span class="co">/* Don't signal an error if the process's input file descriptor</span></span>
<span id="cb209-22"><a aria-hidden="true" href="#cb209-22" tabindex="-1"></a><span class="co">     is closed.  This could make debugging Lisp code difficult.  */</span></span>
<span id="cb209-23"><a aria-hidden="true" href="#cb209-23" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>NETCONN_P <span class="op">(</span>process<span class="op">)</span> <span class="op">||</span> p<span class="op">-&gt;</span>infd <span class="op">&gt;=</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb209-24"><a aria-hidden="true" href="#cb209-24" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb209-25"><a aria-hidden="true" href="#cb209-25" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span>EQ <span class="op">(</span>filter<span class="op">,</span> Qt<span class="op">)</span> <span class="op">&amp;&amp;</span> <span class="op">!</span>EQ <span class="op">(</span>p<span class="op">-&gt;</span>status<span class="op">,</span> Qlisten<span class="op">))</span></span>
<span id="cb209-26"><a aria-hidden="true" href="#cb209-26" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb209-27"><a aria-hidden="true" href="#cb209-27" tabindex="-1"></a>          FD_CLR <span class="op">(</span>p<span class="op">-&gt;</span>infd<span class="op">,</span> <span class="op">&amp;</span>input_wait_mask<span class="op">);</span></span>
<span id="cb209-28"><a aria-hidden="true" href="#cb209-28" tabindex="-1"></a>          FD_CLR <span class="op">(</span>p<span class="op">-&gt;</span>infd<span class="op">,</span> <span class="op">&amp;</span>non_keyboard_wait_mask<span class="op">);</span></span>
<span id="cb209-29"><a aria-hidden="true" href="#cb209-29" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb209-30"><a aria-hidden="true" href="#cb209-30" tabindex="-1"></a>      <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>EQ <span class="op">(</span>p<span class="op">-&gt;</span>filter<span class="op">,</span> Qt<span class="op">)</span></span>
<span id="cb209-31"><a aria-hidden="true" href="#cb209-31" tabindex="-1"></a>               <span class="op">&amp;&amp;</span> <span class="op">!</span>EQ <span class="op">(</span>p<span class="op">-&gt;</span>command<span class="op">,</span> Qt<span class="op">))</span> <span class="co">/* Network process not stopped.  */</span></span>
<span id="cb209-32"><a aria-hidden="true" href="#cb209-32" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb209-33"><a aria-hidden="true" href="#cb209-33" tabindex="-1"></a>          FD_SET <span class="op">(</span>p<span class="op">-&gt;</span>infd<span class="op">,</span> <span class="op">&amp;</span>input_wait_mask<span class="op">);</span></span>
<span id="cb209-34"><a aria-hidden="true" href="#cb209-34" tabindex="-1"></a>          FD_SET <span class="op">(</span>p<span class="op">-&gt;</span>infd<span class="op">,</span> <span class="op">&amp;</span>non_keyboard_wait_mask<span class="op">);</span></span>
<span id="cb209-35"><a aria-hidden="true" href="#cb209-35" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb209-36"><a aria-hidden="true" href="#cb209-36" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb209-37"><a aria-hidden="true" href="#cb209-37" tabindex="-1"></a></span>
<span id="cb209-38"><a aria-hidden="true" href="#cb209-38" tabindex="-1"></a>  pset_filter <span class="op">(</span>p<span class="op">,</span> filter<span class="op">);</span></span>
<span id="cb209-39"><a aria-hidden="true" href="#cb209-39" tabindex="-1"></a></span>
<span id="cb209-40"><a aria-hidden="true" href="#cb209-40" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>NETCONN_P <span class="op">(</span>process<span class="op">)</span> <span class="op">||</span> SERIALCONN_P <span class="op">(</span>process<span class="op">))</span></span>
<span id="cb209-41"><a aria-hidden="true" href="#cb209-41" tabindex="-1"></a>    pset_childp <span class="op">(</span>p<span class="op">,</span> plist_put <span class="op">(</span>p<span class="op">-&gt;</span>childp<span class="op">,</span> QCfilter<span class="op">,</span> filter<span class="op">));</span></span>
<span id="cb209-42"><a aria-hidden="true" href="#cb209-42" tabindex="-1"></a>  <span class="cf">return</span> filter<span class="op">;</span></span>
<span id="cb209-43"><a aria-hidden="true" href="#cb209-43" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>Filter Function Characteristics:</strong></p>
<ol type="1">
<li>Called asynchronously when output is available</li>
<li>Receives process object and output string</li>
<li>Can modify any buffer, not just the process buffer</li>
<li>Must handle partial lines</li>
<li>Can be set to <code>t</code> to stop accepting output</li>
</ol>
<h3 data-number="9.6.2" id="process-sentinels"><span class="header-section-number">9.6.2</span> Process Sentinels</h3>
<p>Sentinels are called when a process changes state:</p>
<pre class="elisp"><code>;; Install a sentinel
(set-process-sentinel proc
  (lambda (proc event)
    (message "Process %s %s" (process-name proc) event)))</code></pre>
<p><strong>C Implementation:</strong></p>
<div class="sourceCode" id="cb211"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb211-1"><a aria-hidden="true" href="#cb211-1" tabindex="-1"></a><span class="co">/* File: src/process.c, Lines: 7796-7861 */</span></span>
<span id="cb211-2"><a aria-hidden="true" href="#cb211-2" tabindex="-1"></a></span>
<span id="cb211-3"><a aria-hidden="true" href="#cb211-3" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span></span>
<span id="cb211-4"><a aria-hidden="true" href="#cb211-4" tabindex="-1"></a>exec_sentinel <span class="op">(</span>Lisp_Object proc<span class="op">,</span> Lisp_Object reason<span class="op">)</span></span>
<span id="cb211-5"><a aria-hidden="true" href="#cb211-5" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb211-6"><a aria-hidden="true" href="#cb211-6" tabindex="-1"></a>  Lisp_Object sentinel<span class="op">,</span> odeactivate<span class="op">;</span></span>
<span id="cb211-7"><a aria-hidden="true" href="#cb211-7" tabindex="-1"></a>  <span class="kw">struct</span> Lisp_Process <span class="op">*</span>p <span class="op">=</span> XPROCESS <span class="op">(</span>proc<span class="op">);</span></span>
<span id="cb211-8"><a aria-hidden="true" href="#cb211-8" tabindex="-1"></a>  specpdl_ref count <span class="op">=</span> SPECPDL_INDEX <span class="op">();</span></span>
<span id="cb211-9"><a aria-hidden="true" href="#cb211-9" tabindex="-1"></a></span>
<span id="cb211-10"><a aria-hidden="true" href="#cb211-10" tabindex="-1"></a>  <span class="co">/* Inhibit quit so that random quits don't screw up a running filter.  */</span></span>
<span id="cb211-11"><a aria-hidden="true" href="#cb211-11" tabindex="-1"></a>  specbind <span class="op">(</span>Qinhibit_quit<span class="op">,</span> Qt<span class="op">);</span></span>
<span id="cb211-12"><a aria-hidden="true" href="#cb211-12" tabindex="-1"></a></span>
<span id="cb211-13"><a aria-hidden="true" href="#cb211-13" tabindex="-1"></a>  sentinel <span class="op">=</span> p<span class="op">-&gt;</span>sentinel<span class="op">;</span></span>
<span id="cb211-14"><a aria-hidden="true" href="#cb211-14" tabindex="-1"></a></span>
<span id="cb211-15"><a aria-hidden="true" href="#cb211-15" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(!</span>NILP <span class="op">(</span>sentinel<span class="op">))</span></span>
<span id="cb211-16"><a aria-hidden="true" href="#cb211-16" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb211-17"><a aria-hidden="true" href="#cb211-17" tabindex="-1"></a>      <span class="co">/* We used to bind `inhibit-quit' to t here, but that's not</span></span>
<span id="cb211-18"><a aria-hidden="true" href="#cb211-18" tabindex="-1"></a><span class="co">         needed now that we don't call Lisp code from</span></span>
<span id="cb211-19"><a aria-hidden="true" href="#cb211-19" tabindex="-1"></a><span class="co">         handle_child_signal.  */</span></span>
<span id="cb211-20"><a aria-hidden="true" href="#cb211-20" tabindex="-1"></a></span>
<span id="cb211-21"><a aria-hidden="true" href="#cb211-21" tabindex="-1"></a>      Lisp_Object obuffer<span class="op">,</span> okeymap<span class="op">;</span></span>
<span id="cb211-22"><a aria-hidden="true" href="#cb211-22" tabindex="-1"></a>      <span class="dt">ptrdiff_t</span> count1 <span class="op">=</span> SPECPDL_INDEX <span class="op">();</span></span>
<span id="cb211-23"><a aria-hidden="true" href="#cb211-23" tabindex="-1"></a></span>
<span id="cb211-24"><a aria-hidden="true" href="#cb211-24" tabindex="-1"></a>      <span class="co">/* Running the sentinel might delete the process, so save the</span></span>
<span id="cb211-25"><a aria-hidden="true" href="#cb211-25" tabindex="-1"></a><span class="co">         buffer and the keymap now.  */</span></span>
<span id="cb211-26"><a aria-hidden="true" href="#cb211-26" tabindex="-1"></a>      XSETBUFFER <span class="op">(</span>obuffer<span class="op">,</span> current_buffer<span class="op">);</span></span>
<span id="cb211-27"><a aria-hidden="true" href="#cb211-27" tabindex="-1"></a>      okeymap <span class="op">=</span> BVAR <span class="op">(</span>current_buffer<span class="op">,</span> keymap<span class="op">);</span></span>
<span id="cb211-28"><a aria-hidden="true" href="#cb211-28" tabindex="-1"></a></span>
<span id="cb211-29"><a aria-hidden="true" href="#cb211-29" tabindex="-1"></a>      <span class="co">/* Inhibit quit so that random quits don't screw up a running filter.  */</span></span>
<span id="cb211-30"><a aria-hidden="true" href="#cb211-30" tabindex="-1"></a>      specbind <span class="op">(</span>Qinhibit_quit<span class="op">,</span> Qt<span class="op">);</span></span>
<span id="cb211-31"><a aria-hidden="true" href="#cb211-31" tabindex="-1"></a>      specbind <span class="op">(</span>Qlast_nonmenu_event<span class="op">,</span> Qt<span class="op">);</span></span>
<span id="cb211-32"><a aria-hidden="true" href="#cb211-32" tabindex="-1"></a></span>
<span id="cb211-33"><a aria-hidden="true" href="#cb211-33" tabindex="-1"></a>      <span class="co">/* There's no good reason to let sentinels change the current</span></span>
<span id="cb211-34"><a aria-hidden="true" href="#cb211-34" tabindex="-1"></a><span class="co">         buffer, and many callers of accept-process-output don't expect it.  */</span></span>
<span id="cb211-35"><a aria-hidden="true" href="#cb211-35" tabindex="-1"></a>      record_unwind_current_buffer <span class="op">();</span></span>
<span id="cb211-36"><a aria-hidden="true" href="#cb211-36" tabindex="-1"></a></span>
<span id="cb211-37"><a aria-hidden="true" href="#cb211-37" tabindex="-1"></a>      sentinel <span class="op">=</span> p<span class="op">-&gt;</span>sentinel<span class="op">;</span></span>
<span id="cb211-38"><a aria-hidden="true" href="#cb211-38" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span>NILP <span class="op">(</span>sentinel<span class="op">))</span></span>
<span id="cb211-39"><a aria-hidden="true" href="#cb211-39" tabindex="-1"></a>        <span class="cf">goto</span> unlock<span class="op">;</span></span>
<span id="cb211-40"><a aria-hidden="true" href="#cb211-40" tabindex="-1"></a></span>
<span id="cb211-41"><a aria-hidden="true" href="#cb211-41" tabindex="-1"></a>      <span class="co">/* Zilch the sentinel while it's running, to avoid recursive invocations;</span></span>
<span id="cb211-42"><a aria-hidden="true" href="#cb211-42" tabindex="-1"></a><span class="co">         assure that it gets restored no matter how the sentinel exits.  */</span></span>
<span id="cb211-43"><a aria-hidden="true" href="#cb211-43" tabindex="-1"></a>      pset_sentinel <span class="op">(</span>p<span class="op">,</span> Qnil<span class="op">);</span></span>
<span id="cb211-44"><a aria-hidden="true" href="#cb211-44" tabindex="-1"></a>      record_unwind_protect <span class="op">(</span>exec_sentinel_restore<span class="op">,</span> Fcons <span class="op">(</span>proc<span class="op">,</span> sentinel<span class="op">));</span></span>
<span id="cb211-45"><a aria-hidden="true" href="#cb211-45" tabindex="-1"></a></span>
<span id="cb211-46"><a aria-hidden="true" href="#cb211-46" tabindex="-1"></a>      internal_condition_case_1 <span class="op">(</span>exec_sentinel_call<span class="op">,</span> list2 <span class="op">(</span>sentinel<span class="op">,</span> proc<span class="op">,</span> reason<span class="op">),</span></span>
<span id="cb211-47"><a aria-hidden="true" href="#cb211-47" tabindex="-1"></a>                                 Qt<span class="op">,</span> exec_sentinel_error_handler<span class="op">);</span></span>
<span id="cb211-48"><a aria-hidden="true" href="#cb211-48" tabindex="-1"></a></span>
<span id="cb211-49"><a aria-hidden="true" href="#cb211-49" tabindex="-1"></a>    unlock<span class="op">:</span></span>
<span id="cb211-50"><a aria-hidden="true" href="#cb211-50" tabindex="-1"></a>      unbind_to <span class="op">(</span>count1<span class="op">,</span> Qnil<span class="op">);</span></span>
<span id="cb211-51"><a aria-hidden="true" href="#cb211-51" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb211-52"><a aria-hidden="true" href="#cb211-52" tabindex="-1"></a></span>
<span id="cb211-53"><a aria-hidden="true" href="#cb211-53" tabindex="-1"></a>  unbind_to <span class="op">(</span>count<span class="op">,</span> Qnil<span class="op">);</span></span>
<span id="cb211-54"><a aria-hidden="true" href="#cb211-54" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>Sentinel Characteristics:</strong></p>
<ol type="1">
<li>Called when process status changes (exits, signals, etc.)</li>
<li>Receives process object and string describing the change</li>
<li>Sentinel is temporarily cleared during execution to prevent
recursion</li>
<li>Errors in sentinels are caught and reported</li>
<li>Can examine exit status with <code>process-exit-status</code></li>
</ol>
<h3 data-number="9.6.3" id="signal-handling-and-sentinels"><span class="header-section-number">9.6.3</span> Signal Handling and
Sentinels</h3>
<p>Process status changes are detected via SIGCHLD:</p>
<div class="sourceCode" id="cb212"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb212-1"><a aria-hidden="true" href="#cb212-1" tabindex="-1"></a><span class="co">/* File: src/process.c, Lines: 7687-7720 */</span></span>
<span id="cb212-2"><a aria-hidden="true" href="#cb212-2" tabindex="-1"></a></span>
<span id="cb212-3"><a aria-hidden="true" href="#cb212-3" tabindex="-1"></a>handle_child_signal <span class="op">(</span><span class="dt">int</span> sig<span class="op">)</span></span>
<span id="cb212-4"><a aria-hidden="true" href="#cb212-4" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb212-5"><a aria-hidden="true" href="#cb212-5" tabindex="-1"></a>  Lisp_Object tail<span class="op">,</span> proc<span class="op">;</span></span>
<span id="cb212-6"><a aria-hidden="true" href="#cb212-6" tabindex="-1"></a>  <span class="dt">bool</span> changed <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb212-7"><a aria-hidden="true" href="#cb212-7" tabindex="-1"></a></span>
<span id="cb212-8"><a aria-hidden="true" href="#cb212-8" tabindex="-1"></a>  <span class="co">/* Find the process that signaled us, and record its status.  */</span></span>
<span id="cb212-9"><a aria-hidden="true" href="#cb212-9" tabindex="-1"></a></span>
<span id="cb212-10"><a aria-hidden="true" href="#cb212-10" tabindex="-1"></a>  <span class="co">/* The process can have been deleted by Fdelete_process, or have</span></span>
<span id="cb212-11"><a aria-hidden="true" href="#cb212-11" tabindex="-1"></a><span class="co">     been started asynchronously by Fcall_process.  */</span></span>
<span id="cb212-12"><a aria-hidden="true" href="#cb212-12" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span>tail <span class="op">=</span> deleted_pid_list<span class="op">;</span> CONSP <span class="op">(</span>tail<span class="op">);</span> tail <span class="op">=</span> XCDR <span class="op">(</span>tail<span class="op">))</span></span>
<span id="cb212-13"><a aria-hidden="true" href="#cb212-13" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb212-14"><a aria-hidden="true" href="#cb212-14" tabindex="-1"></a>      <span class="co">/* ... check deleted processes ... */</span></span>
<span id="cb212-15"><a aria-hidden="true" href="#cb212-15" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb212-16"><a aria-hidden="true" href="#cb212-16" tabindex="-1"></a></span>
<span id="cb212-17"><a aria-hidden="true" href="#cb212-17" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span>tail <span class="op">=</span> Vprocess_alist<span class="op">;</span> CONSP <span class="op">(</span>tail<span class="op">);</span> tail <span class="op">=</span> XCDR <span class="op">(</span>tail<span class="op">))</span></span>
<span id="cb212-18"><a aria-hidden="true" href="#cb212-18" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb212-19"><a aria-hidden="true" href="#cb212-19" tabindex="-1"></a>      proc <span class="op">=</span> XCDR <span class="op">(</span>XCAR <span class="op">(</span>tail<span class="op">));</span></span>
<span id="cb212-20"><a aria-hidden="true" href="#cb212-20" tabindex="-1"></a>      p <span class="op">=</span> XPROCESS <span class="op">(</span>proc<span class="op">);</span></span>
<span id="cb212-21"><a aria-hidden="true" href="#cb212-21" tabindex="-1"></a></span>
<span id="cb212-22"><a aria-hidden="true" href="#cb212-22" tabindex="-1"></a>      <span class="co">/* ... check if this process changed status ... */</span></span>
<span id="cb212-23"><a aria-hidden="true" href="#cb212-23" tabindex="-1"></a></span>
<span id="cb212-24"><a aria-hidden="true" href="#cb212-24" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span>p<span class="op">-&gt;</span>pid <span class="op">&gt;</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb212-25"><a aria-hidden="true" href="#cb212-25" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb212-26"><a aria-hidden="true" href="#cb212-26" tabindex="-1"></a>          pid_t pid<span class="op">;</span></span>
<span id="cb212-27"><a aria-hidden="true" href="#cb212-27" tabindex="-1"></a>          <span class="dt">int</span> status<span class="op">;</span></span>
<span id="cb212-28"><a aria-hidden="true" href="#cb212-28" tabindex="-1"></a></span>
<span id="cb212-29"><a aria-hidden="true" href="#cb212-29" tabindex="-1"></a>          <span class="co">/* Use waitpid to get status */</span></span>
<span id="cb212-30"><a aria-hidden="true" href="#cb212-30" tabindex="-1"></a>          pid <span class="op">=</span> waitpid <span class="op">(</span>p<span class="op">-&gt;</span>pid<span class="op">,</span> <span class="op">&amp;</span>status<span class="op">,</span> WNOHANG <span class="op">|</span> WUNTRACED<span class="op">);</span></span>
<span id="cb212-31"><a aria-hidden="true" href="#cb212-31" tabindex="-1"></a></span>
<span id="cb212-32"><a aria-hidden="true" href="#cb212-32" tabindex="-1"></a>          <span class="cf">if</span> <span class="op">(</span>pid <span class="op">&gt;</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb212-33"><a aria-hidden="true" href="#cb212-33" tabindex="-1"></a>            <span class="op">{</span></span>
<span id="cb212-34"><a aria-hidden="true" href="#cb212-34" tabindex="-1"></a>              <span class="co">/* Process status changed */</span></span>
<span id="cb212-35"><a aria-hidden="true" href="#cb212-35" tabindex="-1"></a>              p<span class="op">-&gt;</span>raw_status <span class="op">=</span> status<span class="op">;</span></span>
<span id="cb212-36"><a aria-hidden="true" href="#cb212-36" tabindex="-1"></a>              p<span class="op">-&gt;</span>raw_status_new <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb212-37"><a aria-hidden="true" href="#cb212-37" tabindex="-1"></a>              changed <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb212-38"><a aria-hidden="true" href="#cb212-38" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb212-39"><a aria-hidden="true" href="#cb212-39" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb212-40"><a aria-hidden="true" href="#cb212-40" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb212-41"><a aria-hidden="true" href="#cb212-41" tabindex="-1"></a></span>
<span id="cb212-42"><a aria-hidden="true" href="#cb212-42" tabindex="-1"></a>  <span class="co">/* If any process changed status, call the sentinel */</span></span>
<span id="cb212-43"><a aria-hidden="true" href="#cb212-43" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>changed<span class="op">)</span></span>
<span id="cb212-44"><a aria-hidden="true" href="#cb212-44" tabindex="-1"></a>    status_notify <span class="op">(</span>NULL<span class="op">,</span> NULL<span class="op">);</span></span>
<span id="cb212-45"><a aria-hidden="true" href="#cb212-45" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2 data-number="9.7" id="network-processes"><span class="header-section-number">9.7</span> Network Processes</h2>
<h3 data-number="9.7.1" id="creating-network-processes"><span class="header-section-number">9.7.1</span> Creating Network
Processes</h3>
<div class="sourceCode" id="cb213"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb213-1"><a aria-hidden="true" href="#cb213-1" tabindex="-1"></a><span class="co">/* File: src/process.c, Lines: 3804-3823 */</span></span>
<span id="cb213-2"><a aria-hidden="true" href="#cb213-2" tabindex="-1"></a></span>
<span id="cb213-3"><a aria-hidden="true" href="#cb213-3" tabindex="-1"></a>DEFUN <span class="op">(</span><span class="st">"make-network-process"</span><span class="op">,</span> Fmake_network_process<span class="op">,</span> Smake_network_process<span class="op">,</span></span>
<span id="cb213-4"><a aria-hidden="true" href="#cb213-4" tabindex="-1"></a>       <span class="dv">0</span><span class="op">,</span> MANY<span class="op">,</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb213-5"><a aria-hidden="true" href="#cb213-5" tabindex="-1"></a>       doc<span class="op">:</span> <span class="co">/* Create and return a network server or client process.</span></span>
<span id="cb213-6"><a aria-hidden="true" href="#cb213-6" tabindex="-1"></a></span>
<span id="cb213-7"><a aria-hidden="true" href="#cb213-7" tabindex="-1"></a><span class="co">In Emacs, network connections are represented by process objects, so</span></span>
<span id="cb213-8"><a aria-hidden="true" href="#cb213-8" tabindex="-1"></a><span class="co">input and output work as for subprocesses and `delete-process' closes</span></span>
<span id="cb213-9"><a aria-hidden="true" href="#cb213-9" tabindex="-1"></a><span class="co">a network connection.  However, a network process has no process id,</span></span>
<span id="cb213-10"><a aria-hidden="true" href="#cb213-10" tabindex="-1"></a><span class="co">it cannot be signaled, and the status codes are different from normal</span></span>
<span id="cb213-11"><a aria-hidden="true" href="#cb213-11" tabindex="-1"></a><span class="co">processes.</span></span>
<span id="cb213-12"><a aria-hidden="true" href="#cb213-12" tabindex="-1"></a></span>
<span id="cb213-13"><a aria-hidden="true" href="#cb213-13" tabindex="-1"></a><span class="co">Arguments are specified as keyword/argument pairs.  The following</span></span>
<span id="cb213-14"><a aria-hidden="true" href="#cb213-14" tabindex="-1"></a><span class="co">arguments are defined:</span></span>
<span id="cb213-15"><a aria-hidden="true" href="#cb213-15" tabindex="-1"></a></span>
<span id="cb213-16"><a aria-hidden="true" href="#cb213-16" tabindex="-1"></a><span class="co">:name NAME -- NAME is name for process.  It is modified if necessary</span></span>
<span id="cb213-17"><a aria-hidden="true" href="#cb213-17" tabindex="-1"></a><span class="co">to make it unique.</span></span>
<span id="cb213-18"><a aria-hidden="true" href="#cb213-18" tabindex="-1"></a></span>
<span id="cb213-19"><a aria-hidden="true" href="#cb213-19" tabindex="-1"></a><span class="co">:buffer BUFFER -- BUFFER is the buffer (or buffer-name) to associate</span></span>
<span id="cb213-20"><a aria-hidden="true" href="#cb213-20" tabindex="-1"></a><span class="co">with the process.  Process output goes at end of that buffer, unless</span></span>
<span id="cb213-21"><a aria-hidden="true" href="#cb213-21" tabindex="-1"></a><span class="co">you specify a filter function to handle the output.  BUFFER may be</span></span>
<span id="cb213-22"><a aria-hidden="true" href="#cb213-22" tabindex="-1"></a><span class="co">also nil, meaning that this process is not associated with any buffer.</span></span></code></pre></div>
<p><strong>Network Process Features:</strong></p>
<ol type="1">
<li><strong>Client connections</strong>: TCP, UDP, local sockets</li>
<li><strong>Server sockets</strong>: Listen and accept connections</li>
<li><strong>Non-blocking connects</strong>: Asynchronous connection
establishment</li>
<li><strong>TLS/SSL support</strong>: Via GnuTLS integration</li>
<li><strong>Async DNS</strong>: Non-blocking hostname resolution</li>
<li><strong>IPv4 and IPv6</strong>: Full protocol support</li>
</ol>
<h3 data-number="9.7.2" id="network-server-example"><span class="header-section-number">9.7.2</span> Network Server Example</h3>
<pre class="elisp"><code>;; Create a TCP server on port 8080
(make-network-process
 :name "my-server"
 :server t
 :service 8080
 :sentinel 'my-server-sentinel
 :filter 'my-server-filter
 :log 'my-server-log)

;; Log function called when client connects
(defun my-server-log (server client message)
  (message "Connection from %s: %s" client message))</code></pre>
<h3 data-number="9.7.3" id="async-dns-resolution"><span class="header-section-number">9.7.3</span> Async DNS Resolution</h3>
<p>Modern Emacs supports non-blocking DNS lookups:</p>
<div class="sourceCode" id="cb215"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb215-1"><a aria-hidden="true" href="#cb215-1" tabindex="-1"></a><span class="co">/* File: src/process.c, Lines: 5200-5228 */</span></span>
<span id="cb215-2"><a aria-hidden="true" href="#cb215-2" tabindex="-1"></a></span>
<span id="cb215-3"><a aria-hidden="true" href="#cb215-3" tabindex="-1"></a><span class="pp">#ifdef HAVE_GETADDRINFO_A</span></span>
<span id="cb215-4"><a aria-hidden="true" href="#cb215-4" tabindex="-1"></a></span>
<span id="cb215-5"><a aria-hidden="true" href="#cb215-5" tabindex="-1"></a><span class="co">/* Check if a DNS lookup is complete */</span></span>
<span id="cb215-6"><a aria-hidden="true" href="#cb215-6" tabindex="-1"></a><span class="cf">if</span> <span class="op">(</span>p<span class="op">-&gt;</span>dns_request<span class="op">)</span></span>
<span id="cb215-7"><a aria-hidden="true" href="#cb215-7" tabindex="-1"></a>  <span class="op">{</span></span>
<span id="cb215-8"><a aria-hidden="true" href="#cb215-8" tabindex="-1"></a>    <span class="dt">int</span> ret <span class="op">=</span> gai_error <span class="op">(</span>p<span class="op">-&gt;</span>dns_request<span class="op">);</span></span>
<span id="cb215-9"><a aria-hidden="true" href="#cb215-9" tabindex="-1"></a></span>
<span id="cb215-10"><a aria-hidden="true" href="#cb215-10" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>ret <span class="op">==</span> EAI_INPROGRESS<span class="op">)</span></span>
<span id="cb215-11"><a aria-hidden="true" href="#cb215-11" tabindex="-1"></a>      <span class="cf">return</span> Qnil<span class="op">;</span>  <span class="co">/* Still waiting */</span></span>
<span id="cb215-12"><a aria-hidden="true" href="#cb215-12" tabindex="-1"></a></span>
<span id="cb215-13"><a aria-hidden="true" href="#cb215-13" tabindex="-1"></a>    <span class="co">/* We got a response. */</span></span>
<span id="cb215-14"><a aria-hidden="true" href="#cb215-14" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>ret <span class="op">==</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb215-15"><a aria-hidden="true" href="#cb215-15" tabindex="-1"></a>      <span class="op">{</span></span>
<span id="cb215-16"><a aria-hidden="true" href="#cb215-16" tabindex="-1"></a>        <span class="kw">struct</span> addrinfo <span class="op">*</span>res<span class="op">;</span></span>
<span id="cb215-17"><a aria-hidden="true" href="#cb215-17" tabindex="-1"></a></span>
<span id="cb215-18"><a aria-hidden="true" href="#cb215-18" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(</span>res <span class="op">=</span> p<span class="op">-&gt;</span>dns_request<span class="op">-&gt;</span>ar_result<span class="op">;</span> res<span class="op">;</span> res <span class="op">=</span> res<span class="op">-&gt;</span>ai_next<span class="op">)</span></span>
<span id="cb215-19"><a aria-hidden="true" href="#cb215-19" tabindex="-1"></a>          addrinfos <span class="op">=</span> Fcons <span class="op">(</span>conv_addrinfo_to_lisp <span class="op">(</span>res<span class="op">),</span> addrinfos<span class="op">);</span></span>
<span id="cb215-20"><a aria-hidden="true" href="#cb215-20" tabindex="-1"></a></span>
<span id="cb215-21"><a aria-hidden="true" href="#cb215-21" tabindex="-1"></a>        addrinfos <span class="op">=</span> Fnreverse <span class="op">(</span>addrinfos<span class="op">);</span></span>
<span id="cb215-22"><a aria-hidden="true" href="#cb215-22" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb215-23"><a aria-hidden="true" href="#cb215-23" tabindex="-1"></a>    <span class="co">/* The DNS lookup failed. */</span></span>
<span id="cb215-24"><a aria-hidden="true" href="#cb215-24" tabindex="-1"></a>    <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>connecting_status <span class="op">(</span>p<span class="op">-&gt;</span>status<span class="op">))</span></span>
<span id="cb215-25"><a aria-hidden="true" href="#cb215-25" tabindex="-1"></a>      <span class="op">{</span></span>
<span id="cb215-26"><a aria-hidden="true" href="#cb215-26" tabindex="-1"></a>        deactivate_process <span class="op">(</span>proc<span class="op">);</span></span>
<span id="cb215-27"><a aria-hidden="true" href="#cb215-27" tabindex="-1"></a>        pset_status <span class="op">(</span>p<span class="op">,</span> <span class="op">(</span>list2</span>
<span id="cb215-28"><a aria-hidden="true" href="#cb215-28" tabindex="-1"></a>                         <span class="op">(</span>Qfailed<span class="op">,</span></span>
<span id="cb215-29"><a aria-hidden="true" href="#cb215-29" tabindex="-1"></a>                          concat3 <span class="op">(</span>build_string <span class="op">(</span><span class="st">"Name lookup of "</span><span class="op">),</span></span>
<span id="cb215-30"><a aria-hidden="true" href="#cb215-30" tabindex="-1"></a>                                   build_string <span class="op">(</span>p<span class="op">-&gt;</span>dns_request<span class="op">-&gt;</span>ar_name<span class="op">),</span></span>
<span id="cb215-31"><a aria-hidden="true" href="#cb215-31" tabindex="-1"></a>                                   build_string <span class="op">(</span><span class="st">" failed"</span><span class="op">)))));</span></span>
<span id="cb215-32"><a aria-hidden="true" href="#cb215-32" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb215-33"><a aria-hidden="true" href="#cb215-33" tabindex="-1"></a></span>
<span id="cb215-34"><a aria-hidden="true" href="#cb215-34" tabindex="-1"></a>    free_dns_request <span class="op">(</span>proc<span class="op">);</span></span>
<span id="cb215-35"><a aria-hidden="true" href="#cb215-35" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb215-36"><a aria-hidden="true" href="#cb215-36" tabindex="-1"></a><span class="pp">#endif</span></span></code></pre></div>
<p>This prevents the entire Emacs process from blocking during DNS
lookups.</p>
<h2 data-number="9.8" id="serial-port-communication"><span class="header-section-number">9.8</span> Serial Port Communication</h2>
<p>Emacs can communicate with serial ports for embedded systems,
Arduinos, etc.:</p>
<div class="sourceCode" id="cb216"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb216-1"><a aria-hidden="true" href="#cb216-1" tabindex="-1"></a><span class="co">/* File: src/process.c, Lines: 3112-3142 */</span></span>
<span id="cb216-2"><a aria-hidden="true" href="#cb216-2" tabindex="-1"></a></span>
<span id="cb216-3"><a aria-hidden="true" href="#cb216-3" tabindex="-1"></a>DEFUN <span class="op">(</span><span class="st">"make-serial-process"</span><span class="op">,</span> Fmake_serial_process<span class="op">,</span> Smake_serial_process<span class="op">,</span></span>
<span id="cb216-4"><a aria-hidden="true" href="#cb216-4" tabindex="-1"></a>       <span class="dv">0</span><span class="op">,</span> MANY<span class="op">,</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb216-5"><a aria-hidden="true" href="#cb216-5" tabindex="-1"></a>       doc<span class="op">:</span> <span class="co">/* Create and return a serial port process.</span></span>
<span id="cb216-6"><a aria-hidden="true" href="#cb216-6" tabindex="-1"></a></span>
<span id="cb216-7"><a aria-hidden="true" href="#cb216-7" tabindex="-1"></a><span class="co">In Emacs, serial port connections are represented by process objects,</span></span>
<span id="cb216-8"><a aria-hidden="true" href="#cb216-8" tabindex="-1"></a><span class="co">so input and output work as for subprocesses, and `delete-process'</span></span>
<span id="cb216-9"><a aria-hidden="true" href="#cb216-9" tabindex="-1"></a><span class="co">closes a serial port connection.  However, a serial process has no</span></span>
<span id="cb216-10"><a aria-hidden="true" href="#cb216-10" tabindex="-1"></a><span class="co">process id, it cannot be signaled, and the status codes are different</span></span>
<span id="cb216-11"><a aria-hidden="true" href="#cb216-11" tabindex="-1"></a><span class="co">from normal processes.</span></span>
<span id="cb216-12"><a aria-hidden="true" href="#cb216-12" tabindex="-1"></a></span>
<span id="cb216-13"><a aria-hidden="true" href="#cb216-13" tabindex="-1"></a><span class="co">Arguments are specified as keyword/argument pairs.  The following</span></span>
<span id="cb216-14"><a aria-hidden="true" href="#cb216-14" tabindex="-1"></a><span class="co">arguments are defined:</span></span>
<span id="cb216-15"><a aria-hidden="true" href="#cb216-15" tabindex="-1"></a></span>
<span id="cb216-16"><a aria-hidden="true" href="#cb216-16" tabindex="-1"></a><span class="co">:port PORT -- (mandatory) PORT is the path or name of the serial port.</span></span>
<span id="cb216-17"><a aria-hidden="true" href="#cb216-17" tabindex="-1"></a><span class="co">For example, this could be "/dev/ttyS0" on Unix.  On Windows, this</span></span>
<span id="cb216-18"><a aria-hidden="true" href="#cb216-18" tabindex="-1"></a><span class="co">could be "COM1", or "\\\\.\\COM10" for ports higher than COM9.</span></span>
<span id="cb216-19"><a aria-hidden="true" href="#cb216-19" tabindex="-1"></a></span>
<span id="cb216-20"><a aria-hidden="true" href="#cb216-20" tabindex="-1"></a><span class="co">:speed SPEED -- (mandatory) SPEED is the terminal speed.</span></span>
<span id="cb216-21"><a aria-hidden="true" href="#cb216-21" tabindex="-1"></a><span class="co">Possible values: 1200, 1800, 2400, 4800, 9600, 14400, 19200,</span></span>
<span id="cb216-22"><a aria-hidden="true" href="#cb216-22" tabindex="-1"></a><span class="co">28800, 38400, 57600, 115200, 230400.</span></span>
<span id="cb216-23"><a aria-hidden="true" href="#cb216-23" tabindex="-1"></a></span>
<span id="cb216-24"><a aria-hidden="true" href="#cb216-24" tabindex="-1"></a><span class="co">:stopbits STOPBITS -- STOPBITS is the number of stopbits.</span></span>
<span id="cb216-25"><a aria-hidden="true" href="#cb216-25" tabindex="-1"></a><span class="co">STOPBITS = 1 or 2 (default 1).</span></span>
<span id="cb216-26"><a aria-hidden="true" href="#cb216-26" tabindex="-1"></a></span>
<span id="cb216-27"><a aria-hidden="true" href="#cb216-27" tabindex="-1"></a><span class="co">:bytesize BYTESIZE -- BYTESIZE is the number of bits per byte.</span></span>
<span id="cb216-28"><a aria-hidden="true" href="#cb216-28" tabindex="-1"></a><span class="co">BYTESIZE = 7 or 8 (default 8).</span></span>
<span id="cb216-29"><a aria-hidden="true" href="#cb216-29" tabindex="-1"></a></span>
<span id="cb216-30"><a aria-hidden="true" href="#cb216-30" tabindex="-1"></a><span class="co">:parity PARITY -- PARITY can be nil (don't use parity), the symbol</span></span>
<span id="cb216-31"><a aria-hidden="true" href="#cb216-31" tabindex="-1"></a><span class="co">`odd' (use odd parity), or the symbol `even' (use even parity).</span></span></code></pre></div>
<p><strong>Example Usage:</strong></p>
<pre class="elisp"><code>;; Connect to Arduino on /dev/ttyUSB0
(setq arduino
      (make-serial-process
       :port "/dev/ttyUSB0"
       :speed 9600
       :coding 'no-conversion
       :filter 'arduino-filter))

;; Send commands
(process-send-string arduino "LED ON\n")</code></pre>
<h2 data-number="9.9" id="pty-allocation"><span class="header-section-number">9.9</span> PTY Allocation</h2>
<p>PTY (pseudo-terminal) allocation is crucial for interactive
programs:</p>
<div class="sourceCode" id="cb218"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb218-1"><a aria-hidden="true" href="#cb218-1" tabindex="-1"></a><span class="co">/* File: src/process.c, Lines: 841-891 */</span></span>
<span id="cb218-2"><a aria-hidden="true" href="#cb218-2" tabindex="-1"></a></span>
<span id="cb218-3"><a aria-hidden="true" href="#cb218-3" tabindex="-1"></a>allocate_pty <span class="op">(</span><span class="dt">char</span> pty_name<span class="op">[</span>PTY_NAME_SIZE<span class="op">])</span></span>
<span id="cb218-4"><a aria-hidden="true" href="#cb218-4" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb218-5"><a aria-hidden="true" href="#cb218-5" tabindex="-1"></a><span class="pp">#ifdef HAVE_PTYS</span></span>
<span id="cb218-6"><a aria-hidden="true" href="#cb218-6" tabindex="-1"></a>  <span class="dt">int</span> fd<span class="op">;</span></span>
<span id="cb218-7"><a aria-hidden="true" href="#cb218-7" tabindex="-1"></a></span>
<span id="cb218-8"><a aria-hidden="true" href="#cb218-8" tabindex="-1"></a><span class="pp">#ifdef PTY_ITERATION</span></span>
<span id="cb218-9"><a aria-hidden="true" href="#cb218-9" tabindex="-1"></a>  PTY_ITERATION</span>
<span id="cb218-10"><a aria-hidden="true" href="#cb218-10" tabindex="-1"></a><span class="pp">#else</span></span>
<span id="cb218-11"><a aria-hidden="true" href="#cb218-11" tabindex="-1"></a>  <span class="dt">register</span> <span class="dt">int</span> c<span class="op">,</span> i<span class="op">;</span></span>
<span id="cb218-12"><a aria-hidden="true" href="#cb218-12" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span>c <span class="op">=</span> FIRST_PTY_LETTER<span class="op">;</span> c <span class="op">&lt;=</span> <span class="ch">'z'</span><span class="op">;</span> c<span class="op">++)</span></span>
<span id="cb218-13"><a aria-hidden="true" href="#cb218-13" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span>i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="dv">16</span><span class="op">;</span> i<span class="op">++)</span></span>
<span id="cb218-14"><a aria-hidden="true" href="#cb218-14" tabindex="-1"></a><span class="pp">#endif</span></span>
<span id="cb218-15"><a aria-hidden="true" href="#cb218-15" tabindex="-1"></a>      <span class="op">{</span></span>
<span id="cb218-16"><a aria-hidden="true" href="#cb218-16" tabindex="-1"></a><span class="pp">#ifdef PTY_NAME_SPRINTF</span></span>
<span id="cb218-17"><a aria-hidden="true" href="#cb218-17" tabindex="-1"></a>        PTY_NAME_SPRINTF</span>
<span id="cb218-18"><a aria-hidden="true" href="#cb218-18" tabindex="-1"></a><span class="pp">#else</span></span>
<span id="cb218-19"><a aria-hidden="true" href="#cb218-19" tabindex="-1"></a>        sprintf <span class="op">(</span>pty_name<span class="op">,</span> <span class="st">"/dev/pty</span><span class="sc">%c%x</span><span class="st">"</span><span class="op">,</span> c<span class="op">,</span> i<span class="op">);</span></span>
<span id="cb218-20"><a aria-hidden="true" href="#cb218-20" tabindex="-1"></a><span class="pp">#endif</span></span>
<span id="cb218-21"><a aria-hidden="true" href="#cb218-21" tabindex="-1"></a></span>
<span id="cb218-22"><a aria-hidden="true" href="#cb218-22" tabindex="-1"></a><span class="pp">#ifdef PTY_OPEN</span></span>
<span id="cb218-23"><a aria-hidden="true" href="#cb218-23" tabindex="-1"></a>        PTY_OPEN<span class="op">;</span></span>
<span id="cb218-24"><a aria-hidden="true" href="#cb218-24" tabindex="-1"></a><span class="pp">#else</span></span>
<span id="cb218-25"><a aria-hidden="true" href="#cb218-25" tabindex="-1"></a>        fd <span class="op">=</span> emacs_open <span class="op">(</span>pty_name<span class="op">,</span> O_RDWR <span class="op">|</span> O_NONBLOCK<span class="op">,</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb218-26"><a aria-hidden="true" href="#cb218-26" tabindex="-1"></a><span class="pp">#endif</span></span>
<span id="cb218-27"><a aria-hidden="true" href="#cb218-27" tabindex="-1"></a></span>
<span id="cb218-28"><a aria-hidden="true" href="#cb218-28" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>fd <span class="op">&gt;=</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb218-29"><a aria-hidden="true" href="#cb218-29" tabindex="-1"></a>          <span class="op">{</span></span>
<span id="cb218-30"><a aria-hidden="true" href="#cb218-30" tabindex="-1"></a><span class="pp">#ifdef PTY_TTY_NAME_SPRINTF</span></span>
<span id="cb218-31"><a aria-hidden="true" href="#cb218-31" tabindex="-1"></a>            PTY_TTY_NAME_SPRINTF</span>
<span id="cb218-32"><a aria-hidden="true" href="#cb218-32" tabindex="-1"></a><span class="pp">#else</span></span>
<span id="cb218-33"><a aria-hidden="true" href="#cb218-33" tabindex="-1"></a>            <span class="co">/* ... get slave name ... */</span></span>
<span id="cb218-34"><a aria-hidden="true" href="#cb218-34" tabindex="-1"></a><span class="pp">#endif</span></span>
<span id="cb218-35"><a aria-hidden="true" href="#cb218-35" tabindex="-1"></a></span>
<span id="cb218-36"><a aria-hidden="true" href="#cb218-36" tabindex="-1"></a>            <span class="co">/* Check permissions */</span></span>
<span id="cb218-37"><a aria-hidden="true" href="#cb218-37" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>faccessat <span class="op">(</span>AT_FDCWD<span class="op">,</span> pty_name<span class="op">,</span> R_OK <span class="op">|</span> W_OK<span class="op">,</span> AT_EACCESS<span class="op">)</span> <span class="op">!=</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb218-38"><a aria-hidden="true" href="#cb218-38" tabindex="-1"></a>              <span class="op">{</span></span>
<span id="cb218-39"><a aria-hidden="true" href="#cb218-39" tabindex="-1"></a>                emacs_close <span class="op">(</span>fd<span class="op">);</span></span>
<span id="cb218-40"><a aria-hidden="true" href="#cb218-40" tabindex="-1"></a>                <span class="cf">continue</span><span class="op">;</span></span>
<span id="cb218-41"><a aria-hidden="true" href="#cb218-41" tabindex="-1"></a>              <span class="op">}</span></span>
<span id="cb218-42"><a aria-hidden="true" href="#cb218-42" tabindex="-1"></a></span>
<span id="cb218-43"><a aria-hidden="true" href="#cb218-43" tabindex="-1"></a>            setup_pty <span class="op">(</span>fd<span class="op">);</span></span>
<span id="cb218-44"><a aria-hidden="true" href="#cb218-44" tabindex="-1"></a>            <span class="cf">return</span> fd<span class="op">;</span></span>
<span id="cb218-45"><a aria-hidden="true" href="#cb218-45" tabindex="-1"></a>          <span class="op">}</span></span>
<span id="cb218-46"><a aria-hidden="true" href="#cb218-46" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb218-47"><a aria-hidden="true" href="#cb218-47" tabindex="-1"></a><span class="pp">#endif </span><span class="co">/* HAVE_PTYS */</span></span>
<span id="cb218-48"><a aria-hidden="true" href="#cb218-48" tabindex="-1"></a>  <span class="cf">return</span> <span class="op">-</span><span class="dv">1</span><span class="op">;</span></span>
<span id="cb218-49"><a aria-hidden="true" href="#cb218-49" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>Why PTYs Matter:</strong></p>
<ol type="1">
<li><strong>Line editing</strong>: Programs like shells need PTY for
line editing</li>
<li><strong>Job control</strong>: PTYs support process groups and job
control signals</li>
<li><strong>Terminal emulation</strong>: Programs can detect they‚Äôre
running in a terminal</li>
<li><strong>Character-at-a-time I/O</strong>: For interactive
programs</li>
</ol>
<p><strong>PTY vs.¬†Pipe:</strong></p>
<table>
<thead>
<tr>
<th>Feature</th>
<th>PTY</th>
<th>Pipe</th>
</tr>
</thead>
<tbody>
<tr>
<td>Buffering</td>
<td>Line buffering</td>
<td>Block buffering</td>
</tr>
<tr>
<td>Job Control</td>
<td>Yes</td>
<td>No</td>
</tr>
<tr>
<td>Terminal Detection</td>
<td>isatty() returns true</td>
<td>isatty() returns false</td>
</tr>
<tr>
<td>Overhead</td>
<td>Higher</td>
<td>Lower</td>
</tr>
<tr>
<td>Use Case</td>
<td>Interactive shells</td>
<td>Non-interactive commands</td>
</tr>
</tbody>
</table>
<h2 data-number="9.10" id="signal-handling"><span class="header-section-number">9.10</span> Signal Handling</h2>
<h3 data-number="9.10.1" id="child-process-signals"><span class="header-section-number">9.10.1</span> Child Process Signals</h3>
<p>Emacs uses a clever self-pipe trick to handle SIGCHLD safely:</p>
<div class="sourceCode" id="cb219"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb219-1"><a aria-hidden="true" href="#cb219-1" tabindex="-1"></a><span class="co">/* File: src/process.c, Lines: 297-302 */</span></span>
<span id="cb219-2"><a aria-hidden="true" href="#cb219-2" tabindex="-1"></a></span>
<span id="cb219-3"><a aria-hidden="true" href="#cb219-3" tabindex="-1"></a><span class="co">/* File descriptor that becomes readable when we receive SIGCHLD.  */</span></span>
<span id="cb219-4"><a aria-hidden="true" href="#cb219-4" tabindex="-1"></a><span class="dt">static</span> <span class="dt">int</span> child_signal_write_fd <span class="op">=</span> <span class="op">-</span><span class="dv">1</span><span class="op">;</span></span>
<span id="cb219-5"><a aria-hidden="true" href="#cb219-5" tabindex="-1"></a></span>
<span id="cb219-6"><a aria-hidden="true" href="#cb219-6" tabindex="-1"></a><span class="pp">#ifndef WINDOWSNT</span></span>
<span id="cb219-7"><a aria-hidden="true" href="#cb219-7" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> child_signal_read <span class="op">(</span><span class="dt">int</span><span class="op">,</span> <span class="dt">void</span> <span class="op">*);</span></span>
<span id="cb219-8"><a aria-hidden="true" href="#cb219-8" tabindex="-1"></a><span class="pp">#endif</span></span></code></pre></div>
<p><strong>The Self-Pipe Pattern:</strong></p>
<pre><code>SIGCHLD arrives
     ‚Üì
Signal handler writes byte to pipe
     ‚Üì
Main event loop detects readable pipe
     ‚Üì
Calls waitpid() to get child status
     ‚Üì
Updates process object
     ‚Üì
Calls sentinel if needed</code></pre>
<p>This avoids calling non-async-signal-safe functions in the signal
handler.</p>
<h3 data-number="9.10.2" id="sending-signals-to-processes"><span class="header-section-number">9.10.2</span> Sending Signals to
Processes</h3>
<p>Users can send various signals:</p>
<pre class="elisp"><code>;; Send SIGINT (Ctrl-C)
(interrupt-process proc)

;; Send SIGTERM
(kill-process proc)

;; Send SIGSTOP
(stop-process proc)

;; Send SIGCONT
(continue-process proc)

;; Send arbitrary signal
(signal-process proc 'SIGUSR1)</code></pre>
<h2 data-number="9.11" id="elisp-layer"><span class="header-section-number">9.11</span> Elisp Layer</h2>
<h3 data-number="9.11.1" id="comint.el---command-interpreter"><span class="header-section-number">9.11.1</span> comint.el - Command
Interpreter</h3>
<p>The <code>comint</code> package provides a framework for process
interaction:</p>
<pre class="elisp"><code>/* File: lisp/comint.el, Lines: 27-54 */

;;; Commentary:

;; This file defines a general command-interpreter-in-a-buffer package
;; (comint mode).  The idea is that you can build specific process-in-a-buffer
;; modes on top of comint mode -- e.g., Lisp, shell, scheme, T, soar, ....
;; This way, all these specific packages share a common base functionality,
;; and a common set of bindings, which makes them easier to use (and
;; saves code, implementation time, etc., etc.).

;; Several packages are already defined using comint mode:
;; - shell.el defines a shell-in-a-buffer mode.
;; - cmulisp.el defines a simple lisp-in-a-buffer mode.
;;
;; - The file cmuscheme.el defines a scheme-in-a-buffer mode.
;; - The file tea.el tunes scheme and inferior-scheme modes for T.
;; - The file soar.el tunes Lisp and inferior-lisp modes for Soar.
;; - cmutex.el defines TeX and LaTeX modes that invoke TeX, LaTeX, BibTeX,
;;   previewers, and printers from within Emacs.
;; - background.el allows csh-like job control inside Emacs.
;; It is pretty easy to make new derived modes for other processes.</code></pre>
<p><strong>Key comint Features:</strong></p>
<ol type="1">
<li><strong>Input History</strong>: Cycle through previous commands with
M-p/M-n</li>
<li><strong>Output Handling</strong>: Smart handling of prompts and
output</li>
<li><strong>Completion</strong>: Filename and command completion</li>
<li><strong>Password Input</strong>: Detect password prompts and disable
echoing</li>
<li><strong>ANSI Color</strong>: Process terminal escape sequences</li>
</ol>
<p><strong>Major comint-based modes:</strong> - <code>shell-mode</code>
- Interactive shell - <code>ielm-mode</code> - Interactive Emacs Lisp -
<code>inferior-python-mode</code> - Python REPL -
<code>sql-interactive-mode</code> - Database shells</p>
<h3 data-number="9.11.2" id="compile.el---compilation-mode"><span class="header-section-number">9.11.2</span> compile.el - Compilation
Mode</h3>
<p>The compilation mode for running compilers and parsing errors:</p>
<pre class="elisp"><code>/* File: lisp/progmodes/compile.el, Lines: 25-40 */

;;; Commentary:

;; This package provides the compile facilities documented in the Emacs user's
;; manual.

;;; Key Features:

;; 1. Error Parsing: Automatically parse compiler output
;; 2. Navigation: Jump to errors with next-error/previous-error
;; 3. Highlighting: Colorize errors, warnings, info messages
;; 4. Recompilation: Rerun with the same command
;; 5. Multiple Formats: Support many compiler output formats</code></pre>
<p><strong>Error Parsing Example:</strong></p>
<pre class="elisp"><code>;; Run make
(compile "make")

;; In the *compilation* buffer:
;; foo.c:42:10: error: undeclared identifier 'bar'

;; Press RET or next-error to jump to foo.c line 42</code></pre>
<h3 data-number="9.11.3" id="process-api-summary"><span class="header-section-number">9.11.3</span> Process API Summary</h3>
<p><strong>Creation:</strong> - <code>make-process</code> - Asynchronous
subprocess - <code>start-process</code> - Simplified async process -
<code>call-process</code> - Synchronous subprocess -
<code>call-process-region</code> - Sync with region as input -
<code>make-network-process</code> - Network connection -
<code>make-serial-process</code> - Serial port</p>
<p><strong>Querying:</strong> - <code>process-status</code> - Current
status (run, exit, signal, etc.) - <code>process-exit-status</code> -
Exit code - <code>process-id</code> - Process ID -
<code>process-command</code> - Command that started it -
<code>process-buffer</code> - Associated buffer -
<code>process-mark</code> - Output insertion point</p>
<p><strong>I/O:</strong> - <code>process-send-string</code> - Send
string to process - <code>process-send-region</code> - Send buffer
region - <code>process-send-eof</code> - Send EOF -
<code>set-process-filter</code> - Install output handler -
<code>set-process-sentinel</code> - Install status change handler</p>
<p><strong>Control:</strong> - <code>delete-process</code> - Kill
process - <code>interrupt-process</code> - Send SIGINT -
<code>kill-process</code> - Send SIGKILL - <code>quit-process</code> -
Send SIGQUIT - <code>stop-process</code> - Send SIGSTOP -
<code>continue-process</code> - Send SIGCONT</p>
<p><strong>Properties:</strong> - <code>process-get</code> /
<code>process-put</code> - Get/set plist values -
<code>process-plist</code> - Get full property list -
<code>set-process-query-on-exit-flag</code> - Control exit query</p>
<h2 data-number="9.12" id="advanced-topics-1"><span class="header-section-number">9.12</span> Advanced Topics</h2>
<h3 data-number="9.12.1" id="process-environment"><span class="header-section-number">9.12.1</span> Process Environment</h3>
<p>Each process inherits or can customize its environment:</p>
<pre class="elisp"><code>;; Set environment for a process
(let ((process-environment (copy-sequence process-environment)))
  (setenv "PATH" "/custom/path")
  (setenv "LANG" "en_US.UTF-8")
  (make-process :name "custom-env"
                :command '("program")))</code></pre>
<p>The environment is copied at process creation time.</p>
<h3 data-number="9.12.2" id="subprocess-queries"><span class="header-section-number">9.12.2</span> Subprocess Queries</h3>
<div class="sourceCode" id="cb226"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb226-1"><a aria-hidden="true" href="#cb226-1" tabindex="-1"></a><span class="co">/* Get list of all processes */</span></span>
<span id="cb226-2"><a aria-hidden="true" href="#cb226-2" tabindex="-1"></a>DEFUN <span class="op">(</span><span class="st">"process-list"</span><span class="op">,</span> Fprocess_list<span class="op">,</span> Sprocess_list<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb226-3"><a aria-hidden="true" href="#cb226-3" tabindex="-1"></a>       doc<span class="op">:</span> <span class="co">/* Return a list of all processes that are Emacs sub-processes.  */</span><span class="op">)</span></span>
<span id="cb226-4"><a aria-hidden="true" href="#cb226-4" tabindex="-1"></a>  <span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb226-5"><a aria-hidden="true" href="#cb226-5" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb226-6"><a aria-hidden="true" href="#cb226-6" tabindex="-1"></a>  <span class="cf">return</span> Fmapcar <span class="op">(</span>Qcdr<span class="op">,</span> Vprocess_alist<span class="op">);</span></span>
<span id="cb226-7"><a aria-hidden="true" href="#cb226-7" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 data-number="9.12.3" id="process-connections"><span class="header-section-number">9.12.3</span> Process Connections</h3>
<p>The <code>:use-external-socket</code> feature allows using externally
created sockets:</p>
<pre class="elisp"><code>;; Accept pre-created socket (systemd socket activation, etc.)
(make-network-process
 :name "external"
 :use-external-socket t
 :service socket-fd)</code></pre>
<h3 data-number="9.12.4" id="pipe-processes"><span class="header-section-number">9.12.4</span> Pipe Processes</h3>
<p>Create a pipe between two processes:</p>
<pre class="elisp"><code>;; Pipe stderr to a separate buffer
(let* ((stderr-buf (generate-new-buffer "*stderr*"))
       (stderr-proc (make-pipe-process
                     :name "stderr-pipe"
                     :buffer stderr-buf))
       (main-proc (make-process
                   :name "main"
                   :buffer "*output*"
                   :command '("command")
                   :stderr stderr-proc)))
  main-proc)</code></pre>
<h3 data-number="9.12.5" id="thread-affinity"><span class="header-section-number">9.12.5</span> Thread Affinity</h3>
<p>Processes can be bound to specific threads:</p>
<div class="sourceCode" id="cb229"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb229-1"><a aria-hidden="true" href="#cb229-1" tabindex="-1"></a><span class="co">/* File: src/process.h, Line: 126 */</span></span>
<span id="cb229-2"><a aria-hidden="true" href="#cb229-2" tabindex="-1"></a></span>
<span id="cb229-3"><a aria-hidden="true" href="#cb229-3" tabindex="-1"></a><span class="co">/* The thread a process is linked to, or nil for any thread.  */</span></span>
<span id="cb229-4"><a aria-hidden="true" href="#cb229-4" tabindex="-1"></a>Lisp_Object thread<span class="op">;</span></span></code></pre></div>
<pre class="elisp"><code>;; Bind process to current thread
(set-process-thread proc (current-thread))</code></pre>
<h3 data-number="9.12.6" id="adaptive-read-buffering"><span class="header-section-number">9.12.6</span> Adaptive Read Buffering</h3>
<p>Control read performance:</p>
<pre class="elisp"><code>;; Enable adaptive buffering (default)
(setq process-adaptive-read-buffering t)

;; Disable for low latency
(setq process-adaptive-read-buffering nil)

;; Set maximum read size
(setq read-process-output-max (* 1024 1024)) ; 1MB</code></pre>
<h3 data-number="9.12.7" id="file-handlers-and-tramp"><span class="header-section-number">9.12.7</span> File Handlers and TRAMP</h3>
<p>Process creation respects file handlers:</p>
<pre class="elisp"><code>;; This works over TRAMP
(let ((default-directory "/ssh:remote:/path"))
  (make-process :name "remote"
                :command '("ls" "-la")))</code></pre>
<p>The <code>:file-handler</code> keyword controls this:</p>
<pre class="elisp"><code>;; Explicitly disable file handler
(make-process :name "local-only"
              :command '("ls")
              :file-handler nil)</code></pre>
<h2 data-number="9.13" id="cross-platform-considerations"><span class="header-section-number">9.13</span> Cross-Platform
Considerations</h2>
<h3 data-number="9.13.1" id="unix-vs.-windows"><span class="header-section-number">9.13.1</span> Unix vs.¬†Windows</h3>
<table>
<thead>
<tr>
<th>Feature</th>
<th>Unix</th>
<th>Windows</th>
</tr>
</thead>
<tbody>
<tr>
<td>PTY Support</td>
<td>Yes</td>
<td>Limited</td>
</tr>
<tr>
<td>Fork/Exec</td>
<td>Native</td>
<td>Emulated</td>
</tr>
<tr>
<td>Signal Delivery</td>
<td>POSIX signals</td>
<td>Limited</td>
</tr>
<tr>
<td>Process Groups</td>
<td>Full support</td>
<td>Partial</td>
</tr>
<tr>
<td>Select/Poll</td>
<td>Native</td>
<td>Emulated</td>
</tr>
<tr>
<td>Local Sockets</td>
<td>Unix domain</td>
<td>Named pipes</td>
</tr>
</tbody>
</table>
<h3 data-number="9.13.2" id="platform-specific-code"><span class="header-section-number">9.13.2</span> Platform-Specific Code</h3>
<p>The process system has many conditional compilation sections:</p>
<div class="sourceCode" id="cb234"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb234-1"><a aria-hidden="true" href="#cb234-1" tabindex="-1"></a><span class="pp">#ifdef subprocesses</span></span>
<span id="cb234-2"><a aria-hidden="true" href="#cb234-2" tabindex="-1"></a><span class="co">/* Full process support */</span></span>
<span id="cb234-3"><a aria-hidden="true" href="#cb234-3" tabindex="-1"></a><span class="pp">#else</span></span>
<span id="cb234-4"><a aria-hidden="true" href="#cb234-4" tabindex="-1"></a><span class="co">/* MS-DOS: No subprocess support */</span></span>
<span id="cb234-5"><a aria-hidden="true" href="#cb234-5" tabindex="-1"></a><span class="pp">#define PIPECONN_P</span><span class="op">(</span><span class="pp">p</span><span class="op">)</span><span class="pp"> </span><span class="kw">false</span></span>
<span id="cb234-6"><a aria-hidden="true" href="#cb234-6" tabindex="-1"></a><span class="pp">#endif</span></span>
<span id="cb234-7"><a aria-hidden="true" href="#cb234-7" tabindex="-1"></a></span>
<span id="cb234-8"><a aria-hidden="true" href="#cb234-8" tabindex="-1"></a><span class="pp">#ifdef WINDOWSNT</span></span>
<span id="cb234-9"><a aria-hidden="true" href="#cb234-9" tabindex="-1"></a><span class="co">/* Windows-specific implementations */</span></span>
<span id="cb234-10"><a aria-hidden="true" href="#cb234-10" tabindex="-1"></a><span class="kw">extern</span> <span class="dt">int</span> sys_select <span class="op">(...);</span></span>
<span id="cb234-11"><a aria-hidden="true" href="#cb234-11" tabindex="-1"></a><span class="pp">#endif</span></span>
<span id="cb234-12"><a aria-hidden="true" href="#cb234-12" tabindex="-1"></a></span>
<span id="cb234-13"><a aria-hidden="true" href="#cb234-13" tabindex="-1"></a><span class="pp">#ifdef HAVE_PTYS</span></span>
<span id="cb234-14"><a aria-hidden="true" href="#cb234-14" tabindex="-1"></a><span class="co">/* PTY allocation code */</span></span>
<span id="cb234-15"><a aria-hidden="true" href="#cb234-15" tabindex="-1"></a><span class="pp">#endif</span></span>
<span id="cb234-16"><a aria-hidden="true" href="#cb234-16" tabindex="-1"></a></span>
<span id="cb234-17"><a aria-hidden="true" href="#cb234-17" tabindex="-1"></a><span class="pp">#ifdef HAVE_GNUTLS</span></span>
<span id="cb234-18"><a aria-hidden="true" href="#cb234-18" tabindex="-1"></a><span class="co">/* TLS/SSL support */</span></span>
<span id="cb234-19"><a aria-hidden="true" href="#cb234-19" tabindex="-1"></a><span class="pp">#endif</span></span></code></pre></div>
<h3 data-number="9.13.3" id="macos-specifics"><span class="header-section-number">9.13.3</span> macOS Specifics</h3>
<ul>
<li>Uses <code>kqueue</code> for efficient event notification</li>
<li>Special handling for framework integration</li>
<li>Different PTY naming conventions</li>
</ul>
<h3 data-number="9.13.4" id="android"><span class="header-section-number">9.13.4</span> Android</h3>
<p>Special support for Android:</p>
<div class="sourceCode" id="cb235"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb235-1"><a aria-hidden="true" href="#cb235-1" tabindex="-1"></a><span class="pp">#ifdef HAVE_ANDROID</span></span>
<span id="cb235-2"><a aria-hidden="true" href="#cb235-2" tabindex="-1"></a><span class="pp">#include </span><span class="im">"android.h"</span></span>
<span id="cb235-3"><a aria-hidden="true" href="#cb235-3" tabindex="-1"></a><span class="pp">#include </span><span class="im">"androidterm.h"</span></span>
<span id="cb235-4"><a aria-hidden="true" href="#cb235-4" tabindex="-1"></a><span class="pp">#endif</span></span></code></pre></div>
<p>Handles Android‚Äôs unique process model and restrictions.</p>
<h2 data-number="9.14" id="performance-considerations-1"><span class="header-section-number">9.14</span> Performance
Considerations</h2>
<h3 data-number="9.14.1" id="optimizing-process-io"><span class="header-section-number">9.14.1</span> Optimizing Process I/O</h3>
<ol type="1">
<li><strong>Increase read buffer size:</strong></li>
</ol>
<pre class="elisp"><code>(setq read-process-output-max (* 1024 1024)) ; 1MB chunks</code></pre>
<ol start="2" type="1">
<li><strong>Use binary I/O when possible:</strong></li>
</ol>
<pre class="elisp"><code>(make-process :name "binary"
              :command '("cat" "file.bin")
              :coding 'no-conversion)</code></pre>
<ol start="3" type="1">
<li><strong>Batch writes:</strong></li>
</ol>
<pre class="elisp"><code>;; Bad: Multiple small writes
(dotimes (i 1000)
  (process-send-string proc (format "%d\n" i)))

;; Good: One large write
(process-send-string proc
  (mapconcat (lambda (i) (format "%d" i))
             (number-sequence 0 999)
             "\n"))</code></pre>
<ol start="4" type="1">
<li><strong>Disable adaptive buffering for low latency:</strong></li>
</ol>
<pre class="elisp"><code>(setq process-adaptive-read-buffering nil)</code></pre>
<h3 data-number="9.14.2" id="memory-usage"><span class="header-section-number">9.14.2</span> Memory Usage</h3>
<ul>
<li>Process buffers grow unbounded by default</li>
<li>Use filters to limit buffer size</li>
<li>Consider circular buffers for logs</li>
</ul>
<pre class="elisp"><code>(defun limit-buffer-size (proc string)
  "Insert STRING but keep buffer under 100KB."
  (with-current-buffer (process-buffer proc)
    (goto-char (point-max))
    (insert string)
    (when (&gt; (buffer-size) 100000)
      (delete-region (point-min)
                     (- (point-max) 100000)))))</code></pre>
<h2 data-number="9.15" id="debugging-process-issues"><span class="header-section-number">9.15</span> Debugging Process Issues</h2>
<h3 data-number="9.15.1" id="useful-debug-variables"><span class="header-section-number">9.15.1</span> Useful Debug Variables</h3>
<pre class="elisp"><code>;; Log all process events
(setq process-adaptive-read-buffering 'debug)

;; Show process output in real-time
(setq debug-on-error t)

;; Inspect process state
(process-attributes (process-id proc))</code></pre>
<h3 data-number="9.15.2" id="common-issues"><span class="header-section-number">9.15.2</span> Common Issues</h3>
<p><strong>1. Process Not Producing Output</strong> - Check if program
is buffering stdout - Try using PTY instead of pipe - Verify encoding
settings</p>
<p><strong>2. ‚ÄúProcess Not Running‚Äù Errors</strong> - Check process
status: <code>(process-status proc)</code> - Examine exit status:
<code>(process-exit-status proc)</code> - Review sentinel for clues</p>
<p><strong>3. High CPU Usage</strong> - Check for rapid output -
Increase <code>read-process-output-max</code> - Optimize filter
function</p>
<p><strong>4. Encoding Issues</strong> - Verify <code>:coding</code>
parameter - Check <code>process-coding-system</code> - Use
<code>set-process-coding-system</code></p>
<h2 data-number="9.16" id="summary"><span class="header-section-number">9.16</span> Summary</h2>
<p>Emacs‚Äôs process management and I/O system is a sophisticated piece of
engineering that provides:</p>
<ol type="1">
<li><strong>Unified Interface</strong>: Subprocesses, network, and
serial all use the same API</li>
<li><strong>Asynchronous Operation</strong>: Non-blocking I/O
throughout</li>
<li><strong>Rich Features</strong>: Filters, sentinels, encoding,
signals</li>
<li><strong>Cross-Platform</strong>: Works on Unix, Windows, macOS,
Android</li>
<li><strong>Performance</strong>: Adaptive buffering, efficient event
loops</li>
<li><strong>Extensibility</strong>: Elisp can customize every
aspect</li>
</ol>
<p>The system balances power with usability, allowing both simple
process creation:</p>
<pre class="elisp"><code>(start-process "ls" "*ls*" "ls" "-la")</code></pre>
<p>And sophisticated network servers:</p>
<pre class="elisp"><code>(make-network-process
 :name "http-server"
 :server t
 :service 8080
 :sentinel 'http-sentinel
 :filter 'http-filter
 :log 'http-log
 :plist '(:clients nil))</code></pre>
<p>Understanding this subsystem is crucial for: - Writing modes that
interact with external programs - Building network clients and servers -
Implementing REPL modes - Creating build systems - Developing remote
editing capabilities</p>
<p>The process system truly makes Emacs an operating system within an
operating system.</p>
<h2 data-number="9.17" id="references-1"><span class="header-section-number">9.17</span> References</h2>
<p><strong>Source Files:</strong> -
<code>/home/user/emacs/src/process.c</code> - Main process
implementation - <code>/home/user/emacs/src/process.h</code> - Process
structures - <code>/home/user/emacs/src/callproc.c</code> - Synchronous
processes - <code>/home/user/emacs/src/sysdep.c</code> -
System-dependent operations -
<code>/home/user/emacs/lisp/comint.el</code> - Command interpreter
framework - <code>/home/user/emacs/lisp/progmodes/compile.el</code> -
Compilation mode</p>
<p><strong>Documentation:</strong> - Info node
<code>(elisp) Processes</code> - Info node
<code>(elisp) Asynchronous Processes</code> - Info node
<code>(elisp) Network</code> - Info node
<code>(elisp) Serial Ports</code></p>
<p><strong>Key Functions (DEFUN count: 64 in process.c):</strong> -
Process creation: <code>make-process</code>,
<code>make-network-process</code>, <code>make-serial-process</code> -
Process control: <code>delete-process</code>,
<code>interrupt-process</code>, <code>signal-process</code> - I/O:
<code>process-send-string</code>, <code>process-send-region</code> -
Filters/Sentinels: <code>set-process-filter</code>,
<code>set-process-sentinel</code> - Queries:
<code>process-status</code>, <code>process-list</code>,
<code>process-attributes</code></p>
<h1 data-number="10" id="file-io-and-character-encoding-system"><span class="header-section-number">10</span> File I/O and Character Encoding
System</h1>
<p><strong>Core Files:</strong> - File I/O: <code>src/fileio.c</code>
(7,062 lines), <code>src/filelock.c</code> (840 lines),
<code>src/dired.c</code> (1,213 lines) - Encoding:
<code>src/coding.c</code> (12,337 lines - third largest!),
<code>src/charset.c</code> (2,456 lines), <code>src/character.c</code>
(1,164 lines) - CCL Interpreter: <code>src/ccl.c</code> - Elisp Layer:
<code>lisp/files.el</code> (9,391 lines),
<code>lisp/international/mule.el</code> (2,618 lines)</p>
<h2 data-number="10.1" id="table-of-contents-4"><span class="header-section-number">10.1</span> Table of Contents</h2>
<ol type="1">
<li><a href="#architecture-overview">Architecture Overview</a></li>
<li><a href="#file-io-subsystem">File I/O Subsystem</a></li>
<li><a href="#character-encoding-subsystem">Character Encoding
Subsystem</a></li>
<li><a href="#coding-system-framework">Coding System Framework</a></li>
<li><a href="#eol-conversion-and-bom-handling">EOL Conversion and BOM
Handling</a></li>
<li><a href="#charset-system">Charset System</a></li>
<li><a href="#ccl-interpreter">CCL Interpreter</a></li>
<li><a href="#file-operations-pipeline">File Operations
Pipeline</a></li>
<li><a href="#backup-and-auto-save">Backup and Auto-Save</a></li>
<li><a href="#elisp-interface">Elisp Interface</a></li>
</ol>
<hr/>
<h2 data-number="10.2" id="architecture-overview-1"><span class="header-section-number">10.2</span> Architecture Overview</h2>
<p>Emacs‚Äô file I/O and character encoding system is one of its most
sophisticated subsystems, handling the complex task of reading and
writing files across different character encodings, line ending
conventions, and file systems.</p>
<h3 data-number="10.2.1" id="design-philosophy-1"><span class="header-section-number">10.2.1</span> Design Philosophy</h3>
<pre><code>‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    Elisp User Interface                      ‚îÇ
‚îÇ         (files.el, mule.el, find-file-hook, etc.)           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚îÇ
                              ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                File I/O Layer (fileio.c)                     ‚îÇ
‚îÇ  ‚Ä¢ insert-file-contents    ‚Ä¢ write-region                   ‚îÇ
‚îÇ  ‚Ä¢ expand-file-name        ‚Ä¢ directory-files                ‚îÇ
‚îÇ  ‚Ä¢ file-attributes         ‚Ä¢ file-locks                      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚îÇ
                              ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ              Character Encoding Pipeline                     ‚îÇ
‚îÇ                     (coding.c)                               ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îÇ
‚îÇ  ‚îÇ   Detection  ‚îÇ‚îÄ‚ñ∂‚îÇ   Decoding   ‚îÇ‚îÄ‚ñ∂‚îÇ   Encoding   ‚îÇ     ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚îÇ
                              ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                 Charset/Character Layer                      ‚îÇ
‚îÇ           (charset.c, character.c, composite.c)              ‚îÇ
‚îÇ  ‚Ä¢ Unicode mapping         ‚Ä¢ Character composition          ‚îÇ
‚îÇ  ‚Ä¢ Charset definitions     ‚Ä¢ Width calculation               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚îÇ
                              ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    Operating System                          ‚îÇ
‚îÇ              (POSIX, Windows, Android APIs)                  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò</code></pre>
<h3 data-number="10.2.2" id="key-concepts"><span class="header-section-number">10.2.2</span> Key Concepts</h3>
<ol type="1">
<li><strong>Emacs Internal Format</strong>: UTF-8 based representation
(<code>emacs-utf-8</code>)</li>
<li><strong>Coding Systems</strong>: Pluggable encoders/decoders for
different character encodings</li>
<li><strong>File Handlers</strong>: Virtual file system abstraction for
remote files, archives, etc.</li>
<li><strong>Atomic Operations</strong>: File locking and safe writing
strategies</li>
<li><strong>Encoding Detection</strong>: Heuristic-based automatic
detection of file encodings</li>
</ol>
<hr/>
<h2 data-number="10.3" id="file-io-subsystem"><span class="header-section-number">10.3</span> File I/O Subsystem</h2>
<h3 data-number="10.3.1" id="core-data-structures-2"><span class="header-section-number">10.3.1</span> Core Data Structures</h3>
<h4 data-number="10.3.1.1" id="file-descriptor-abstraction"><span class="header-section-number">10.3.1.1</span> File Descriptor
Abstraction</h4>
<p>From <code>/home/user/emacs/src/fileio.c:117-149</code>:</p>
<div class="sourceCode" id="cb245"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb245-1"><a aria-hidden="true" href="#cb245-1" tabindex="-1"></a><span class="co">/* Type describing a file descriptor used by functions such as</span></span>
<span id="cb245-2"><a aria-hidden="true" href="#cb245-2" tabindex="-1"></a><span class="co">   `insert-file-contents'.  */</span></span>
<span id="cb245-3"><a aria-hidden="true" href="#cb245-3" tabindex="-1"></a></span>
<span id="cb245-4"><a aria-hidden="true" href="#cb245-4" tabindex="-1"></a><span class="pp">#if !defined HAVE_ANDROID || defined ANDROID_STUBIFY</span></span>
<span id="cb245-5"><a aria-hidden="true" href="#cb245-5" tabindex="-1"></a><span class="kw">typedef</span> <span class="dt">int</span> emacs_fd<span class="op">;</span></span>
<span id="cb245-6"><a aria-hidden="true" href="#cb245-6" tabindex="-1"></a></span>
<span id="cb245-7"><a aria-hidden="true" href="#cb245-7" tabindex="-1"></a><span class="co">/* Function used to read and open from such a file descriptor.  */</span></span>
<span id="cb245-8"><a aria-hidden="true" href="#cb245-8" tabindex="-1"></a><span class="pp">#define emacs_fd_open       emacs_open</span></span>
<span id="cb245-9"><a aria-hidden="true" href="#cb245-9" tabindex="-1"></a><span class="pp">#define emacs_fd_close      emacs_close</span></span>
<span id="cb245-10"><a aria-hidden="true" href="#cb245-10" tabindex="-1"></a><span class="pp">#define emacs_fd_read       emacs_read_quit</span></span>
<span id="cb245-11"><a aria-hidden="true" href="#cb245-11" tabindex="-1"></a><span class="pp">#define emacs_fd_lseek      lseek</span></span>
<span id="cb245-12"><a aria-hidden="true" href="#cb245-12" tabindex="-1"></a><span class="pp">#define emacs_fd_fstat      sys_fstat</span></span>
<span id="cb245-13"><a aria-hidden="true" href="#cb245-13" tabindex="-1"></a><span class="pp">#define emacs_fd_valid_p</span><span class="op">(</span><span class="pp">fd</span><span class="op">)</span><span class="pp">    </span><span class="op">((</span><span class="pp">fd</span><span class="op">)</span><span class="pp"> </span><span class="op">&gt;=</span><span class="pp"> </span><span class="dv">0</span><span class="op">)</span></span>
<span id="cb245-14"><a aria-hidden="true" href="#cb245-14" tabindex="-1"></a></span>
<span id="cb245-15"><a aria-hidden="true" href="#cb245-15" tabindex="-1"></a><span class="pp">#else </span><span class="co">/* HAVE_ANDROID &amp;&amp; !defined ANDROID_STUBIFY */</span></span>
<span id="cb245-16"><a aria-hidden="true" href="#cb245-16" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> android_fd_or_asset emacs_fd<span class="op">;</span></span>
<span id="cb245-17"><a aria-hidden="true" href="#cb245-17" tabindex="-1"></a></span>
<span id="cb245-18"><a aria-hidden="true" href="#cb245-18" tabindex="-1"></a><span class="pp">#define emacs_fd_open       android_open_asset</span></span>
<span id="cb245-19"><a aria-hidden="true" href="#cb245-19" tabindex="-1"></a><span class="pp">#define emacs_fd_close      android_close_asset</span></span>
<span id="cb245-20"><a aria-hidden="true" href="#cb245-20" tabindex="-1"></a><span class="pp">#define emacs_fd_read       android_asset_read_quit</span></span>
<span id="cb245-21"><a aria-hidden="true" href="#cb245-21" tabindex="-1"></a><span class="pp">#define emacs_fd_lseek      android_asset_lseek</span></span>
<span id="cb245-22"><a aria-hidden="true" href="#cb245-22" tabindex="-1"></a><span class="pp">#define emacs_fd_fstat      android_asset_fstat</span></span>
<span id="cb245-23"><a aria-hidden="true" href="#cb245-23" tabindex="-1"></a><span class="pp">#define emacs_fd_valid_p</span><span class="op">(</span><span class="pp">fd</span><span class="op">)</span><span class="pp">    </span><span class="op">((</span><span class="pp">fd</span><span class="op">).</span><span class="pp">asset </span><span class="op">!=</span><span class="pp"> </span><span class="op">((</span><span class="dt">void</span><span class="pp"> </span><span class="op">*)</span><span class="pp"> </span><span class="op">-</span><span class="dv">1</span><span class="op">))</span></span>
<span id="cb245-24"><a aria-hidden="true" href="#cb245-24" tabindex="-1"></a><span class="pp">#endif</span></span></code></pre></div>
<p><strong>Key insight</strong>: Emacs abstracts file descriptors to
support special file systems like Android assets and content URIs. This
allows the same code to handle regular files and virtual files.</p>
<h4 data-number="10.3.1.2" id="global-state-variables"><span class="header-section-number">10.3.1.2</span> Global State
Variables</h4>
<p>From <code>/home/user/emacs/src/fileio.c:151-174</code>:</p>
<div class="sourceCode" id="cb246"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb246-1"><a aria-hidden="true" href="#cb246-1" tabindex="-1"></a><span class="co">/* True during writing of auto-save files.  */</span></span>
<span id="cb246-2"><a aria-hidden="true" href="#cb246-2" tabindex="-1"></a><span class="dt">static</span> <span class="dt">bool</span> auto_saving<span class="op">;</span></span>
<span id="cb246-3"><a aria-hidden="true" href="#cb246-3" tabindex="-1"></a></span>
<span id="cb246-4"><a aria-hidden="true" href="#cb246-4" tabindex="-1"></a><span class="co">/* Emacs's real umask.  */</span></span>
<span id="cb246-5"><a aria-hidden="true" href="#cb246-5" tabindex="-1"></a><span class="dt">static</span> mode_t realmask<span class="op">;</span></span>
<span id="cb246-6"><a aria-hidden="true" href="#cb246-6" tabindex="-1"></a></span>
<span id="cb246-7"><a aria-hidden="true" href="#cb246-7" tabindex="-1"></a><span class="co">/* Nonzero umask during creation of auto-save directories.  */</span></span>
<span id="cb246-8"><a aria-hidden="true" href="#cb246-8" tabindex="-1"></a><span class="dt">static</span> mode_t auto_saving_dir_umask<span class="op">;</span></span>
<span id="cb246-9"><a aria-hidden="true" href="#cb246-9" tabindex="-1"></a></span>
<span id="cb246-10"><a aria-hidden="true" href="#cb246-10" tabindex="-1"></a><span class="co">/* Set by auto_save_1 to mode of original file so Fwrite_region will create</span></span>
<span id="cb246-11"><a aria-hidden="true" href="#cb246-11" tabindex="-1"></a><span class="co">   a new file with the same mode as the original.  */</span></span>
<span id="cb246-12"><a aria-hidden="true" href="#cb246-12" tabindex="-1"></a><span class="dt">static</span> mode_t auto_save_mode_bits<span class="op">;</span></span>
<span id="cb246-13"><a aria-hidden="true" href="#cb246-13" tabindex="-1"></a></span>
<span id="cb246-14"><a aria-hidden="true" href="#cb246-14" tabindex="-1"></a><span class="co">/* Set by auto_save_1 if an error occurred during the last auto-save.  */</span></span>
<span id="cb246-15"><a aria-hidden="true" href="#cb246-15" tabindex="-1"></a><span class="dt">static</span> <span class="dt">bool</span> auto_save_error_occurred<span class="op">;</span></span>
<span id="cb246-16"><a aria-hidden="true" href="#cb246-16" tabindex="-1"></a></span>
<span id="cb246-17"><a aria-hidden="true" href="#cb246-17" tabindex="-1"></a><span class="co">/* If VALID_TIMESTAMP_FILE_SYSTEM, then TIMESTAMP_FILE_SYSTEM is the device</span></span>
<span id="cb246-18"><a aria-hidden="true" href="#cb246-18" tabindex="-1"></a><span class="co">   number of a file system where time stamps were observed to work.  */</span></span>
<span id="cb246-19"><a aria-hidden="true" href="#cb246-19" tabindex="-1"></a><span class="dt">static</span> <span class="dt">bool</span> valid_timestamp_file_system<span class="op">;</span></span>
<span id="cb246-20"><a aria-hidden="true" href="#cb246-20" tabindex="-1"></a><span class="dt">static</span> dev_t timestamp_file_system<span class="op">;</span></span>
<span id="cb246-21"><a aria-hidden="true" href="#cb246-21" tabindex="-1"></a></span>
<span id="cb246-22"><a aria-hidden="true" href="#cb246-22" tabindex="-1"></a><span class="co">/* Each time an annotation function changes the buffer, the new buffer</span></span>
<span id="cb246-23"><a aria-hidden="true" href="#cb246-23" tabindex="-1"></a><span class="co">   is added here.  */</span></span>
<span id="cb246-24"><a aria-hidden="true" href="#cb246-24" tabindex="-1"></a><span class="dt">static</span> Lisp_Object Vwrite_region_annotation_buffers<span class="op">;</span></span></code></pre></div>
<h3 data-number="10.3.2" id="file-reading-insert-file-contents"><span class="header-section-number">10.3.2</span> File Reading:
insert-file-contents</h3>
<p>The <code>insert-file-contents</code> function is the core of Emacs‚Äô
file reading. It‚Äôs defined at
<code>/home/user/emacs/src/fileio.c:4055</code>.</p>
<h4 data-number="10.3.2.1" id="function-signature"><span class="header-section-number">10.3.2.1</span> Function Signature</h4>
<div class="sourceCode" id="cb247"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb247-1"><a aria-hidden="true" href="#cb247-1" tabindex="-1"></a>DEFUN <span class="op">(</span><span class="st">"insert-file-contents"</span><span class="op">,</span> Finsert_file_contents<span class="op">,</span> Sinsert_file_contents<span class="op">,</span></span>
<span id="cb247-2"><a aria-hidden="true" href="#cb247-2" tabindex="-1"></a>       <span class="dv">1</span><span class="op">,</span> <span class="dv">5</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb247-3"><a aria-hidden="true" href="#cb247-3" tabindex="-1"></a>       doc<span class="op">:</span> <span class="co">/* Insert contents of file FILENAME after point.</span></span>
<span id="cb247-4"><a aria-hidden="true" href="#cb247-4" tabindex="-1"></a><span class="co">Returns list of absolute file name and number of characters inserted.</span></span>
<span id="cb247-5"><a aria-hidden="true" href="#cb247-5" tabindex="-1"></a><span class="co">...</span></span>
<span id="cb247-6"><a aria-hidden="true" href="#cb247-6" tabindex="-1"></a><span class="co">This function does code conversion according to the value of</span></span>
<span id="cb247-7"><a aria-hidden="true" href="#cb247-7" tabindex="-1"></a><span class="co">`coding-system-for-read' or `file-coding-system-alist', and sets the</span></span>
<span id="cb247-8"><a aria-hidden="true" href="#cb247-8" tabindex="-1"></a><span class="co">variable `last-coding-system-used' to the coding system actually used. */</span><span class="op">)</span></span>
<span id="cb247-9"><a aria-hidden="true" href="#cb247-9" tabindex="-1"></a>  <span class="op">(</span>Lisp_Object filename<span class="op">,</span> Lisp_Object visit<span class="op">,</span> Lisp_Object beg<span class="op">,</span></span>
<span id="cb247-10"><a aria-hidden="true" href="#cb247-10" tabindex="-1"></a>   Lisp_Object end<span class="op">,</span> Lisp_Object replace<span class="op">)</span></span></code></pre></div>
<h4 data-number="10.3.2.2" id="key-parameters"><span class="header-section-number">10.3.2.2</span> Key Parameters</h4>
<ul>
<li><strong>filename</strong>: File to read</li>
<li><strong>visit</strong>: If non-nil, set buffer‚Äôs visited file and
mark as unmodified</li>
<li><strong>beg/end</strong>: Byte range to read (not character
range!)</li>
<li><strong>replace</strong>: If non-nil, replace buffer contents with
file contents</li>
</ul>
<h4 data-number="10.3.2.3" id="read-buffer-size-strategy"><span class="header-section-number">10.3.2.3</span> Read Buffer Size
Strategy</h4>
<p>From <code>/home/user/emacs/src/fileio.c:4096-4102</code>:</p>
<div class="sourceCode" id="cb248"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb248-1"><a aria-hidden="true" href="#cb248-1" tabindex="-1"></a><span class="co">/* A good read blocksize for insert-file-contents.</span></span>
<span id="cb248-2"><a aria-hidden="true" href="#cb248-2" tabindex="-1"></a><span class="co">   It is for reading a big chunk of a file into memory,</span></span>
<span id="cb248-3"><a aria-hidden="true" href="#cb248-3" tabindex="-1"></a><span class="co">   as opposed to coreutils IO_BUFSIZE which is for 'cat'-like stream reads.</span></span>
<span id="cb248-4"><a aria-hidden="true" href="#cb248-4" tabindex="-1"></a><span class="co">   If too small, insert-file-contents has more syscall overhead.</span></span>
<span id="cb248-5"><a aria-hidden="true" href="#cb248-5" tabindex="-1"></a><span class="co">   If too large, insert-file-contents might take too long respond to a quit.</span></span>
<span id="cb248-6"><a aria-hidden="true" href="#cb248-6" tabindex="-1"></a><span class="co">   1 MiB should be reasonable even for older, slower devices circa 2025.  */</span></span>
<span id="cb248-7"><a aria-hidden="true" href="#cb248-7" tabindex="-1"></a><span class="kw">enum</span> <span class="op">{</span> INSERT_READ_SIZE_MAX <span class="op">=</span> min <span class="op">(</span><span class="dv">1024</span> <span class="op">*</span> <span class="dv">1024</span><span class="op">,</span> SYS_BUFSIZE_MAX<span class="op">)</span> <span class="op">};</span></span></code></pre></div>
<p><strong>Design decision</strong>: 1 MiB buffer balances syscall
overhead with quit responsiveness. This is much larger than traditional
Unix buffer sizes but appropriate for modern systems.</p>
<h4 data-number="10.3.2.4" id="the-reading-pipeline"><span class="header-section-number">10.3.2.4</span> The Reading Pipeline</h4>
<pre><code>1. File Name Handler Check
   ‚Üì
2. File Opening (with encoding)
   ‚Üì
3. File Size Detection
   ‚Üì
4. Coding System Selection
   ‚Üì
5. Read Loop (1 MiB chunks)
   ‚Üì
6. Decode to Internal Format
   ‚Üì
7. Insert into Buffer
   ‚Üì
8. EOL Conversion
   ‚Üì
9. Format Decoding (format-decode)</code></pre>
<h3 data-number="10.3.3" id="file-writing-write-region"><span class="header-section-number">10.3.3</span> File Writing:
write-region</h3>
<p>The <code>write-region</code> function handles file writing with
sophisticated atomic update strategies.</p>
<p>From <code>/home/user/emacs/src/fileio.c:5459-5503</code>:</p>
<div class="sourceCode" id="cb250"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb250-1"><a aria-hidden="true" href="#cb250-1" tabindex="-1"></a>DEFUN <span class="op">(</span><span class="st">"write-region"</span><span class="op">,</span> Fwrite_region<span class="op">,</span> Swrite_region<span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="dv">7</span><span class="op">,</span></span>
<span id="cb250-2"><a aria-hidden="true" href="#cb250-2" tabindex="-1"></a>       <span class="st">"r</span><span class="sc">\n</span><span class="st">FWrite region to file: </span><span class="sc">\n</span><span class="st">i</span><span class="sc">\n</span><span class="st">i</span><span class="sc">\n</span><span class="st">i</span><span class="sc">\n</span><span class="st">p"</span><span class="op">,</span></span>
<span id="cb250-3"><a aria-hidden="true" href="#cb250-3" tabindex="-1"></a>       doc<span class="op">:</span> <span class="co">/* Write current region into specified file.</span></span>
<span id="cb250-4"><a aria-hidden="true" href="#cb250-4" tabindex="-1"></a><span class="co">...</span></span>
<span id="cb250-5"><a aria-hidden="true" href="#cb250-5" tabindex="-1"></a><span class="co">This does code conversion according to the value of</span></span>
<span id="cb250-6"><a aria-hidden="true" href="#cb250-6" tabindex="-1"></a><span class="co">`coding-system-for-write', `buffer-file-coding-system', or</span></span>
<span id="cb250-7"><a aria-hidden="true" href="#cb250-7" tabindex="-1"></a><span class="co">`file-coding-system-alist', and sets the variable</span></span>
<span id="cb250-8"><a aria-hidden="true" href="#cb250-8" tabindex="-1"></a><span class="co">`last-coding-system-used' to the coding system actually used. */</span><span class="op">)</span></span></code></pre></div>
<h4 data-number="10.3.3.1" id="atomic-write-strategy"><span class="header-section-number">10.3.3.1</span> Atomic Write Strategy</h4>
<p>Emacs uses several strategies to ensure atomic file updates:</p>
<ol type="1">
<li><strong>Write to temporary file, then rename</strong> (most
common)</li>
<li><strong>Write directly</strong> (for append mode or special
files)</li>
<li><strong>Write through file handlers</strong> (for remote/virtual
files)</li>
</ol>
<h4 data-number="10.3.3.2" id="the-writing-pipeline"><span class="header-section-number">10.3.3.2</span> The Writing Pipeline</h4>
<pre><code>1. File Name Handler Check
   ‚Üì
2. File Locking (if visiting)
   ‚Üì
3. Annotation Functions (write-region-annotate-functions)
   ‚Üì
4. Coding System Selection
   ‚Üì
5. Encode from Internal Format
   ‚Üì
6. EOL Conversion
   ‚Üì
7. Write Loop
   ‚Üì
8. fsync (if appropriate)
   ‚Üì
9. Rename/Close
   ‚Üì
10. Update modtime</code></pre>
<h3 data-number="10.3.4" id="file-locking"><span class="header-section-number">10.3.4</span> File Locking</h3>
<p>From <code>/home/user/emacs/src/filelock.c:58-99</code>:</p>
<div class="sourceCode" id="cb252"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb252-1"><a aria-hidden="true" href="#cb252-1" tabindex="-1"></a><span class="co">/* Normally use a symbolic link to represent a lock.</span></span>
<span id="cb252-2"><a aria-hidden="true" href="#cb252-2" tabindex="-1"></a><span class="co">   The strategy: to lock a file FN, create a symlink .#FN in FN's</span></span>
<span id="cb252-3"><a aria-hidden="true" href="#cb252-3" tabindex="-1"></a><span class="co">   directory, with link data USER@HOST.PID:BOOT.  This avoids a single</span></span>
<span id="cb252-4"><a aria-hidden="true" href="#cb252-4" tabindex="-1"></a><span class="co">   mount (== failure) point for lock files.  The :BOOT is omitted if</span></span>
<span id="cb252-5"><a aria-hidden="true" href="#cb252-5" tabindex="-1"></a><span class="co">   the boot time is not available.</span></span>
<span id="cb252-6"><a aria-hidden="true" href="#cb252-6" tabindex="-1"></a></span>
<span id="cb252-7"><a aria-hidden="true" href="#cb252-7" tabindex="-1"></a><span class="co">   When the host in the lock data is the current host, we can check if</span></span>
<span id="cb252-8"><a aria-hidden="true" href="#cb252-8" tabindex="-1"></a><span class="co">   the pid is valid with kill.</span></span>
<span id="cb252-9"><a aria-hidden="true" href="#cb252-9" tabindex="-1"></a></span>
<span id="cb252-10"><a aria-hidden="true" href="#cb252-10" tabindex="-1"></a><span class="co">   ...</span></span>
<span id="cb252-11"><a aria-hidden="true" href="#cb252-11" tabindex="-1"></a></span>
<span id="cb252-12"><a aria-hidden="true" href="#cb252-12" tabindex="-1"></a><span class="co">   We use symlinks instead of normal files because (1) they can be</span></span>
<span id="cb252-13"><a aria-hidden="true" href="#cb252-13" tabindex="-1"></a><span class="co">   stored more efficiently on the filesystem, since the kernel knows</span></span>
<span id="cb252-14"><a aria-hidden="true" href="#cb252-14" tabindex="-1"></a><span class="co">   they will be small, and (2) all the info about the lock can be read</span></span>
<span id="cb252-15"><a aria-hidden="true" href="#cb252-15" tabindex="-1"></a><span class="co">   in a single system call (readlink).</span></span>
<span id="cb252-16"><a aria-hidden="true" href="#cb252-16" tabindex="-1"></a></span>
<span id="cb252-17"><a aria-hidden="true" href="#cb252-17" tabindex="-1"></a><span class="co">   ...</span></span>
<span id="cb252-18"><a aria-hidden="true" href="#cb252-18" tabindex="-1"></a></span>
<span id="cb252-19"><a aria-hidden="true" href="#cb252-19" tabindex="-1"></a><span class="co">   On some file systems, notably those of MS-Windows, symbolic links</span></span>
<span id="cb252-20"><a aria-hidden="true" href="#cb252-20" tabindex="-1"></a><span class="co">   do not work well, so instead of a symlink .#FN -&gt; USER@HOST.PID:BOOT,</span></span>
<span id="cb252-21"><a aria-hidden="true" href="#cb252-21" tabindex="-1"></a><span class="co">   the lock is a regular file .#FN with contents USER@HOST.PID:BOOT.</span></span>
<span id="cb252-22"><a aria-hidden="true" href="#cb252-22" tabindex="-1"></a><span class="co">*/</span></span></code></pre></div>
<p><strong>Lock file format</strong>: <code>.#filename</code> ‚Üí
<code>user@host.pid:boottime</code></p>
<p>This distributed locking scheme allows: - Detection of stale locks
(check if PID exists) - Detection of locks from different machines - No
central lock server required - Atomic lock creation (symlink creation is
atomic)</p>
<h3 data-number="10.3.5" id="directory-operations"><span class="header-section-number">10.3.5</span> Directory Operations</h3>
<p>From <code>/home/user/emacs/src/dired.c</code>, Emacs provides
sophisticated directory listing functionality with support for:</p>
<ol type="1">
<li><strong>Multiple platforms</strong>: Unix, Windows, Android
(including <code>/assets</code> special directory)</li>
<li><strong>File attributes</strong>: Permissions, ownership,
timestamps, size</li>
<li><strong>Symbolic link handling</strong>: Following or preserving
links</li>
<li><strong>Wildcard matching</strong>: Shell-style pattern
matching</li>
</ol>
<hr/>
<h2 data-number="10.4" id="character-encoding-subsystem"><span class="header-section-number">10.4</span> Character Encoding
Subsystem</h2>
<p>The character encoding subsystem (<code>src/coding.c</code>) is the
third-largest source file in Emacs at 12,337 lines. It implements a
sophisticated framework for converting between different character
encodings.</p>
<h3 data-number="10.4.1" id="coding-system-architecture"><span class="header-section-number">10.4.1</span> Coding System
Architecture</h3>
<p>From <code>/home/user/emacs/src/coding.c:43-138</code>:</p>
<pre><code>CODING SYSTEM

  A coding system is an object for an encoding mechanism that contains
  information about how to convert byte sequences to character
  sequences and vice versa.  When we say "decode", it means converting
  a byte sequence of a specific coding system into a character
  sequence that is represented by Emacs's internal coding system
  `emacs-utf-8', and when we say "encode", it means converting a
  character sequence of emacs-utf-8 to a byte sequence of a specific
  coding system.

  In Emacs Lisp, a coding system is represented by a Lisp symbol.  On
  the C level, a coding system is represented by a vector of attributes
  stored in the hash table Vcharset_hash_table.</code></pre>
<h3 data-number="10.4.2" id="the-struct-coding_system"><span class="header-section-number">10.4.2</span> The struct
coding_system</h3>
<p>From <code>/home/user/emacs/src/coding.h:396-502</code>:</p>
<div class="sourceCode" id="cb254"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb254-1"><a aria-hidden="true" href="#cb254-1" tabindex="-1"></a><span class="kw">struct</span> coding_system</span>
<span id="cb254-2"><a aria-hidden="true" href="#cb254-2" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb254-3"><a aria-hidden="true" href="#cb254-3" tabindex="-1"></a>  <span class="co">/* ID number of the coding system.  This is an index to</span></span>
<span id="cb254-4"><a aria-hidden="true" href="#cb254-4" tabindex="-1"></a><span class="co">     Vcoding_system_hash_table.  */</span></span>
<span id="cb254-5"><a aria-hidden="true" href="#cb254-5" tabindex="-1"></a>  <span class="dt">ptrdiff_t</span> id<span class="op">;</span></span>
<span id="cb254-6"><a aria-hidden="true" href="#cb254-6" tabindex="-1"></a></span>
<span id="cb254-7"><a aria-hidden="true" href="#cb254-7" tabindex="-1"></a>  <span class="co">/* Flag bits of the coding system.  The meaning of each bit is common</span></span>
<span id="cb254-8"><a aria-hidden="true" href="#cb254-8" tabindex="-1"></a><span class="co">     to all types of coding systems.  */</span></span>
<span id="cb254-9"><a aria-hidden="true" href="#cb254-9" tabindex="-1"></a>  <span class="dt">unsigned</span> common_flags <span class="op">:</span> <span class="dv">14</span><span class="op">;</span></span>
<span id="cb254-10"><a aria-hidden="true" href="#cb254-10" tabindex="-1"></a></span>
<span id="cb254-11"><a aria-hidden="true" href="#cb254-11" tabindex="-1"></a>  <span class="co">/* Mode bits of the coding system.  */</span></span>
<span id="cb254-12"><a aria-hidden="true" href="#cb254-12" tabindex="-1"></a>  <span class="dt">unsigned</span> mode <span class="op">:</span> <span class="dv">5</span><span class="op">;</span></span>
<span id="cb254-13"><a aria-hidden="true" href="#cb254-13" tabindex="-1"></a></span>
<span id="cb254-14"><a aria-hidden="true" href="#cb254-14" tabindex="-1"></a>  <span class="co">/* The following two members specify how binary 8-bit code 128..255</span></span>
<span id="cb254-15"><a aria-hidden="true" href="#cb254-15" tabindex="-1"></a><span class="co">     are represented in source and destination text respectively.  */</span></span>
<span id="cb254-16"><a aria-hidden="true" href="#cb254-16" tabindex="-1"></a>  bool_bf src_multibyte <span class="op">:</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb254-17"><a aria-hidden="true" href="#cb254-17" tabindex="-1"></a>  bool_bf dst_multibyte <span class="op">:</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb254-18"><a aria-hidden="true" href="#cb254-18" tabindex="-1"></a></span>
<span id="cb254-19"><a aria-hidden="true" href="#cb254-19" tabindex="-1"></a>  <span class="co">/* True if the source of conversion is not in the member</span></span>
<span id="cb254-20"><a aria-hidden="true" href="#cb254-20" tabindex="-1"></a><span class="co">     `charbuf', but at `src_object'.  */</span></span>
<span id="cb254-21"><a aria-hidden="true" href="#cb254-21" tabindex="-1"></a>  bool_bf chars_at_source <span class="op">:</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb254-22"><a aria-hidden="true" href="#cb254-22" tabindex="-1"></a></span>
<span id="cb254-23"><a aria-hidden="true" href="#cb254-23" tabindex="-1"></a>  <span class="co">/* Nonzero if the result of conversion is in `destination'</span></span>
<span id="cb254-24"><a aria-hidden="true" href="#cb254-24" tabindex="-1"></a><span class="co">     buffer rather than in `dst_object'.  */</span></span>
<span id="cb254-25"><a aria-hidden="true" href="#cb254-25" tabindex="-1"></a>  bool_bf raw_destination <span class="op">:</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb254-26"><a aria-hidden="true" href="#cb254-26" tabindex="-1"></a></span>
<span id="cb254-27"><a aria-hidden="true" href="#cb254-27" tabindex="-1"></a>  <span class="co">/* Set to true if charbuf contains an annotation.  */</span></span>
<span id="cb254-28"><a aria-hidden="true" href="#cb254-28" tabindex="-1"></a>  bool_bf annotated <span class="op">:</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb254-29"><a aria-hidden="true" href="#cb254-29" tabindex="-1"></a></span>
<span id="cb254-30"><a aria-hidden="true" href="#cb254-30" tabindex="-1"></a>  <span class="co">/* Used internally in coding.c.  See the comment of detect_ascii.  */</span></span>
<span id="cb254-31"><a aria-hidden="true" href="#cb254-31" tabindex="-1"></a>  <span class="dt">unsigned</span> eol_seen <span class="op">:</span> <span class="dv">3</span><span class="op">;</span></span>
<span id="cb254-32"><a aria-hidden="true" href="#cb254-32" tabindex="-1"></a></span>
<span id="cb254-33"><a aria-hidden="true" href="#cb254-33" tabindex="-1"></a>  <span class="co">/* Finish status of code conversion.  */</span></span>
<span id="cb254-34"><a aria-hidden="true" href="#cb254-34" tabindex="-1"></a>  ENUM_BF <span class="op">(</span>coding_result_code<span class="op">)</span> result <span class="op">:</span> <span class="dv">3</span><span class="op">;</span></span>
<span id="cb254-35"><a aria-hidden="true" href="#cb254-35" tabindex="-1"></a></span>
<span id="cb254-36"><a aria-hidden="true" href="#cb254-36" tabindex="-1"></a>  <span class="dt">int</span> max_charset_id<span class="op">;</span></span>
<span id="cb254-37"><a aria-hidden="true" href="#cb254-37" tabindex="-1"></a></span>
<span id="cb254-38"><a aria-hidden="true" href="#cb254-38" tabindex="-1"></a>  <span class="co">/* Detailed information specific to each type of coding system.  */</span></span>
<span id="cb254-39"><a aria-hidden="true" href="#cb254-39" tabindex="-1"></a>  <span class="kw">union</span></span>
<span id="cb254-40"><a aria-hidden="true" href="#cb254-40" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb254-41"><a aria-hidden="true" href="#cb254-41" tabindex="-1"></a>      <span class="kw">struct</span> iso_2022_spec iso_2022<span class="op">;</span></span>
<span id="cb254-42"><a aria-hidden="true" href="#cb254-42" tabindex="-1"></a>      <span class="kw">struct</span> ccl_spec <span class="op">*</span>ccl<span class="op">;</span> <span class="co">/* Defined in ccl.h.  */</span></span>
<span id="cb254-43"><a aria-hidden="true" href="#cb254-43" tabindex="-1"></a>      <span class="kw">struct</span> utf_16_spec utf_16<span class="op">;</span></span>
<span id="cb254-44"><a aria-hidden="true" href="#cb254-44" tabindex="-1"></a>      <span class="kw">enum</span> utf_bom_type utf_8_bom<span class="op">;</span></span>
<span id="cb254-45"><a aria-hidden="true" href="#cb254-45" tabindex="-1"></a>      <span class="kw">struct</span> emacs_mule_spec emacs_mule<span class="op">;</span></span>
<span id="cb254-46"><a aria-hidden="true" href="#cb254-46" tabindex="-1"></a>      <span class="kw">struct</span> undecided_spec undecided<span class="op">;</span></span>
<span id="cb254-47"><a aria-hidden="true" href="#cb254-47" tabindex="-1"></a>    <span class="op">}</span> spec<span class="op">;</span></span>
<span id="cb254-48"><a aria-hidden="true" href="#cb254-48" tabindex="-1"></a></span>
<span id="cb254-49"><a aria-hidden="true" href="#cb254-49" tabindex="-1"></a>  <span class="dt">unsigned</span> <span class="dt">char</span> <span class="op">*</span>safe_charsets<span class="op">;</span></span>
<span id="cb254-50"><a aria-hidden="true" href="#cb254-50" tabindex="-1"></a>  <span class="dt">ptrdiff_t</span> head_ascii<span class="op">;</span></span>
<span id="cb254-51"><a aria-hidden="true" href="#cb254-51" tabindex="-1"></a>  <span class="dt">ptrdiff_t</span> detected_utf8_bytes<span class="op">,</span> detected_utf8_chars<span class="op">;</span></span>
<span id="cb254-52"><a aria-hidden="true" href="#cb254-52" tabindex="-1"></a></span>
<span id="cb254-53"><a aria-hidden="true" href="#cb254-53" tabindex="-1"></a>  <span class="co">/* The following members are set by encoding/decoding routine.  */</span></span>
<span id="cb254-54"><a aria-hidden="true" href="#cb254-54" tabindex="-1"></a>  <span class="dt">ptrdiff_t</span> produced<span class="op">,</span> produced_char<span class="op">,</span> consumed<span class="op">,</span> consumed_char<span class="op">;</span></span>
<span id="cb254-55"><a aria-hidden="true" href="#cb254-55" tabindex="-1"></a></span>
<span id="cb254-56"><a aria-hidden="true" href="#cb254-56" tabindex="-1"></a>  <span class="dt">ptrdiff_t</span> src_pos<span class="op">,</span> src_pos_byte<span class="op">,</span> src_chars<span class="op">,</span> src_bytes<span class="op">;</span></span>
<span id="cb254-57"><a aria-hidden="true" href="#cb254-57" tabindex="-1"></a>  Lisp_Object src_object<span class="op">;</span></span>
<span id="cb254-58"><a aria-hidden="true" href="#cb254-58" tabindex="-1"></a>  <span class="dt">const</span> <span class="dt">unsigned</span> <span class="dt">char</span> <span class="op">*</span>source<span class="op">;</span></span>
<span id="cb254-59"><a aria-hidden="true" href="#cb254-59" tabindex="-1"></a></span>
<span id="cb254-60"><a aria-hidden="true" href="#cb254-60" tabindex="-1"></a>  <span class="dt">ptrdiff_t</span> dst_pos<span class="op">,</span> dst_pos_byte<span class="op">,</span> dst_bytes<span class="op">;</span></span>
<span id="cb254-61"><a aria-hidden="true" href="#cb254-61" tabindex="-1"></a>  Lisp_Object dst_object<span class="op">;</span></span>
<span id="cb254-62"><a aria-hidden="true" href="#cb254-62" tabindex="-1"></a>  <span class="dt">unsigned</span> <span class="dt">char</span> <span class="op">*</span>destination<span class="op">;</span></span>
<span id="cb254-63"><a aria-hidden="true" href="#cb254-63" tabindex="-1"></a></span>
<span id="cb254-64"><a aria-hidden="true" href="#cb254-64" tabindex="-1"></a>  <span class="co">/* Character buffer for intermediate results.</span></span>
<span id="cb254-65"><a aria-hidden="true" href="#cb254-65" tabindex="-1"></a><span class="co">     If an element is non-negative, it is a character code.</span></span>
<span id="cb254-66"><a aria-hidden="true" href="#cb254-66" tabindex="-1"></a><span class="co">     If it is in the range -128..-1, it is a 8-bit character code minus 256.</span></span>
<span id="cb254-67"><a aria-hidden="true" href="#cb254-67" tabindex="-1"></a><span class="co">     If it is less than -128, it specifies the start of an annotation chunk. */</span></span>
<span id="cb254-68"><a aria-hidden="true" href="#cb254-68" tabindex="-1"></a>  <span class="dt">int</span> <span class="op">*</span>charbuf<span class="op">;</span></span>
<span id="cb254-69"><a aria-hidden="true" href="#cb254-69" tabindex="-1"></a>  <span class="dt">int</span> charbuf_size<span class="op">,</span> charbuf_used<span class="op">;</span></span>
<span id="cb254-70"><a aria-hidden="true" href="#cb254-70" tabindex="-1"></a></span>
<span id="cb254-71"><a aria-hidden="true" href="#cb254-71" tabindex="-1"></a>  <span class="dt">unsigned</span> <span class="dt">char</span> carryover<span class="op">[</span><span class="dv">64</span><span class="op">];</span></span>
<span id="cb254-72"><a aria-hidden="true" href="#cb254-72" tabindex="-1"></a>  <span class="dt">int</span> carryover_bytes<span class="op">;</span></span>
<span id="cb254-73"><a aria-hidden="true" href="#cb254-73" tabindex="-1"></a></span>
<span id="cb254-74"><a aria-hidden="true" href="#cb254-74" tabindex="-1"></a>  <span class="dt">int</span> default_char<span class="op">;</span></span>
<span id="cb254-75"><a aria-hidden="true" href="#cb254-75" tabindex="-1"></a></span>
<span id="cb254-76"><a aria-hidden="true" href="#cb254-76" tabindex="-1"></a>  <span class="dt">bool</span> <span class="op">(*</span>detector<span class="op">)</span> <span class="op">(</span><span class="kw">struct</span> coding_system <span class="op">*,</span> <span class="kw">struct</span> coding_detection_info <span class="op">*);</span></span>
<span id="cb254-77"><a aria-hidden="true" href="#cb254-77" tabindex="-1"></a>  <span class="dt">void</span> <span class="op">(*</span>decoder<span class="op">)</span> <span class="op">(</span><span class="kw">struct</span> coding_system <span class="op">*);</span></span>
<span id="cb254-78"><a aria-hidden="true" href="#cb254-78" tabindex="-1"></a>  <span class="dt">bool</span> <span class="op">(*</span>encoder<span class="op">)</span> <span class="op">(</span><span class="kw">struct</span> coding_system <span class="op">*);</span></span>
<span id="cb254-79"><a aria-hidden="true" href="#cb254-79" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<p><strong>Key design features</strong>:</p>
<ol type="1">
<li><strong>Polymorphic design</strong>: Function pointers for
detector/decoder/encoder</li>
<li><strong>Efficient buffering</strong>: Character buffer for
intermediate results</li>
<li><strong>Annotation support</strong>: Allows metadata in the
conversion stream</li>
<li><strong>Carryover handling</strong>: Manages incomplete multibyte
sequences</li>
<li><strong>Type-specific specs</strong>: Union for different coding
system types</li>
</ol>
<h3 data-number="10.4.3" id="coding-categories"><span class="header-section-number">10.4.3</span> Coding Categories</h3>
<p>From <code>/home/user/emacs/src/coding.c:473-498</code>:</p>
<div class="sourceCode" id="cb255"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb255-1"><a aria-hidden="true" href="#cb255-1" tabindex="-1"></a><span class="kw">enum</span> coding_category</span>
<span id="cb255-2"><a aria-hidden="true" href="#cb255-2" tabindex="-1"></a>  <span class="op">{</span></span>
<span id="cb255-3"><a aria-hidden="true" href="#cb255-3" tabindex="-1"></a>    coding_category_iso_7<span class="op">,</span></span>
<span id="cb255-4"><a aria-hidden="true" href="#cb255-4" tabindex="-1"></a>    coding_category_iso_7_tight<span class="op">,</span></span>
<span id="cb255-5"><a aria-hidden="true" href="#cb255-5" tabindex="-1"></a>    coding_category_iso_8_1<span class="op">,</span></span>
<span id="cb255-6"><a aria-hidden="true" href="#cb255-6" tabindex="-1"></a>    coding_category_iso_8_2<span class="op">,</span></span>
<span id="cb255-7"><a aria-hidden="true" href="#cb255-7" tabindex="-1"></a>    coding_category_iso_7_else<span class="op">,</span></span>
<span id="cb255-8"><a aria-hidden="true" href="#cb255-8" tabindex="-1"></a>    coding_category_iso_8_else<span class="op">,</span></span>
<span id="cb255-9"><a aria-hidden="true" href="#cb255-9" tabindex="-1"></a>    coding_category_utf_8_auto<span class="op">,</span></span>
<span id="cb255-10"><a aria-hidden="true" href="#cb255-10" tabindex="-1"></a>    coding_category_utf_8_nosig<span class="op">,</span></span>
<span id="cb255-11"><a aria-hidden="true" href="#cb255-11" tabindex="-1"></a>    coding_category_utf_8_sig<span class="op">,</span></span>
<span id="cb255-12"><a aria-hidden="true" href="#cb255-12" tabindex="-1"></a>    coding_category_utf_16_auto<span class="op">,</span></span>
<span id="cb255-13"><a aria-hidden="true" href="#cb255-13" tabindex="-1"></a>    coding_category_utf_16_be<span class="op">,</span></span>
<span id="cb255-14"><a aria-hidden="true" href="#cb255-14" tabindex="-1"></a>    coding_category_utf_16_le<span class="op">,</span></span>
<span id="cb255-15"><a aria-hidden="true" href="#cb255-15" tabindex="-1"></a>    coding_category_utf_16_be_nosig<span class="op">,</span></span>
<span id="cb255-16"><a aria-hidden="true" href="#cb255-16" tabindex="-1"></a>    coding_category_utf_16_le_nosig<span class="op">,</span></span>
<span id="cb255-17"><a aria-hidden="true" href="#cb255-17" tabindex="-1"></a>    coding_category_charset<span class="op">,</span></span>
<span id="cb255-18"><a aria-hidden="true" href="#cb255-18" tabindex="-1"></a>    coding_category_sjis<span class="op">,</span></span>
<span id="cb255-19"><a aria-hidden="true" href="#cb255-19" tabindex="-1"></a>    coding_category_big5<span class="op">,</span></span>
<span id="cb255-20"><a aria-hidden="true" href="#cb255-20" tabindex="-1"></a>    coding_category_ccl<span class="op">,</span></span>
<span id="cb255-21"><a aria-hidden="true" href="#cb255-21" tabindex="-1"></a>    coding_category_emacs_mule<span class="op">,</span></span>
<span id="cb255-22"><a aria-hidden="true" href="#cb255-22" tabindex="-1"></a>    <span class="co">/* All above are targets of code detection.  */</span></span>
<span id="cb255-23"><a aria-hidden="true" href="#cb255-23" tabindex="-1"></a>    coding_category_raw_text<span class="op">,</span></span>
<span id="cb255-24"><a aria-hidden="true" href="#cb255-24" tabindex="-1"></a>    coding_category_undecided<span class="op">,</span></span>
<span id="cb255-25"><a aria-hidden="true" href="#cb255-25" tabindex="-1"></a>    coding_category_max</span>
<span id="cb255-26"><a aria-hidden="true" href="#cb255-26" tabindex="-1"></a>  <span class="op">};</span></span></code></pre></div>
<p><strong>Detection priority</strong>: The order matters! UTF-8
variants come before legacy encodings, ensuring modern formats are
detected first.</p>
<hr/>
<h2 data-number="10.5" id="coding-system-framework"><span class="header-section-number">10.5</span> Coding System Framework</h2>
<h3 data-number="10.5.1" id="decoding-pipeline"><span class="header-section-number">10.5.1</span> Decoding Pipeline</h3>
<p>The generic decoding template from
<code>/home/user/emacs/src/coding.c:204-239</code>:</p>
<div class="sourceCode" id="cb256"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb256-1"><a aria-hidden="true" href="#cb256-1" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span></span>
<span id="cb256-2"><a aria-hidden="true" href="#cb256-2" tabindex="-1"></a>decode_coding_XXXX <span class="op">(</span><span class="kw">struct</span> coding_system <span class="op">*</span>coding<span class="op">)</span></span>
<span id="cb256-3"><a aria-hidden="true" href="#cb256-3" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb256-4"><a aria-hidden="true" href="#cb256-4" tabindex="-1"></a>  <span class="dt">const</span> <span class="dt">unsigned</span> <span class="dt">char</span> <span class="op">*</span>src <span class="op">=</span> coding<span class="op">-&gt;</span>source <span class="op">+</span> coding<span class="op">-&gt;</span>consumed<span class="op">;</span></span>
<span id="cb256-5"><a aria-hidden="true" href="#cb256-5" tabindex="-1"></a>  <span class="dt">const</span> <span class="dt">unsigned</span> <span class="dt">char</span> <span class="op">*</span>src_end <span class="op">=</span> coding<span class="op">-&gt;</span>source <span class="op">+</span> coding<span class="op">-&gt;</span>src_bytes<span class="op">;</span></span>
<span id="cb256-6"><a aria-hidden="true" href="#cb256-6" tabindex="-1"></a>  <span class="co">/* SRC_BASE remembers the start position in source in each loop.</span></span>
<span id="cb256-7"><a aria-hidden="true" href="#cb256-7" tabindex="-1"></a><span class="co">     The loop will be exited when there's not enough source code, or</span></span>
<span id="cb256-8"><a aria-hidden="true" href="#cb256-8" tabindex="-1"></a><span class="co">     when there's no room in CHARBUF for a decoded character.  */</span></span>
<span id="cb256-9"><a aria-hidden="true" href="#cb256-9" tabindex="-1"></a>  <span class="dt">const</span> <span class="dt">unsigned</span> <span class="dt">char</span> <span class="op">*</span>src_base<span class="op">;</span></span>
<span id="cb256-10"><a aria-hidden="true" href="#cb256-10" tabindex="-1"></a>  <span class="co">/* A buffer to produce decoded characters.  */</span></span>
<span id="cb256-11"><a aria-hidden="true" href="#cb256-11" tabindex="-1"></a>  <span class="dt">int</span> <span class="op">*</span>charbuf <span class="op">=</span> coding<span class="op">-&gt;</span>charbuf <span class="op">+</span> coding<span class="op">-&gt;</span>charbuf_used<span class="op">;</span></span>
<span id="cb256-12"><a aria-hidden="true" href="#cb256-12" tabindex="-1"></a>  <span class="dt">int</span> <span class="op">*</span>charbuf_end <span class="op">=</span> coding<span class="op">-&gt;</span>charbuf <span class="op">+</span> coding<span class="op">-&gt;</span>charbuf_size<span class="op">;</span></span>
<span id="cb256-13"><a aria-hidden="true" href="#cb256-13" tabindex="-1"></a>  <span class="dt">bool</span> multibytep <span class="op">=</span> coding<span class="op">-&gt;</span>src_multibyte<span class="op">;</span></span>
<span id="cb256-14"><a aria-hidden="true" href="#cb256-14" tabindex="-1"></a></span>
<span id="cb256-15"><a aria-hidden="true" href="#cb256-15" tabindex="-1"></a>  <span class="cf">while</span> <span class="op">(</span><span class="dv">1</span><span class="op">)</span></span>
<span id="cb256-16"><a aria-hidden="true" href="#cb256-16" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb256-17"><a aria-hidden="true" href="#cb256-17" tabindex="-1"></a>      src_base <span class="op">=</span> src<span class="op">;</span></span>
<span id="cb256-18"><a aria-hidden="true" href="#cb256-18" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span>charbuf <span class="op">&lt;</span> charbuf_end<span class="op">)</span></span>
<span id="cb256-19"><a aria-hidden="true" href="#cb256-19" tabindex="-1"></a>    <span class="co">/* No more room to produce a decoded character.  */</span></span>
<span id="cb256-20"><a aria-hidden="true" href="#cb256-20" tabindex="-1"></a>    <span class="cf">break</span><span class="op">;</span></span>
<span id="cb256-21"><a aria-hidden="true" href="#cb256-21" tabindex="-1"></a>      ONE_MORE_BYTE <span class="op">(</span>c<span class="op">);</span></span>
<span id="cb256-22"><a aria-hidden="true" href="#cb256-22" tabindex="-1"></a>      <span class="co">/* Decode it. */</span></span>
<span id="cb256-23"><a aria-hidden="true" href="#cb256-23" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb256-24"><a aria-hidden="true" href="#cb256-24" tabindex="-1"></a></span>
<span id="cb256-25"><a aria-hidden="true" href="#cb256-25" tabindex="-1"></a> no_more_source<span class="op">:</span></span>
<span id="cb256-26"><a aria-hidden="true" href="#cb256-26" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>src_base <span class="op">&lt;</span> src_end</span>
<span id="cb256-27"><a aria-hidden="true" href="#cb256-27" tabindex="-1"></a>      <span class="op">&amp;&amp;</span> coding<span class="op">-&gt;</span>mode <span class="op">&amp;</span> CODING_MODE_LAST_BLOCK<span class="op">)</span></span>
<span id="cb256-28"><a aria-hidden="true" href="#cb256-28" tabindex="-1"></a>    <span class="co">/* If the source ends by partial bytes to construct a character,</span></span>
<span id="cb256-29"><a aria-hidden="true" href="#cb256-29" tabindex="-1"></a><span class="co">       treat them as eight-bit raw data.  */</span></span>
<span id="cb256-30"><a aria-hidden="true" href="#cb256-30" tabindex="-1"></a>    <span class="cf">while</span> <span class="op">(</span>src_base <span class="op">&lt;</span> src_end <span class="op">&amp;&amp;</span> charbuf <span class="op">&lt;</span> charbuf_end<span class="op">)</span></span>
<span id="cb256-31"><a aria-hidden="true" href="#cb256-31" tabindex="-1"></a>      <span class="op">*</span>charbuf<span class="op">++</span> <span class="op">=</span> <span class="op">*</span>src_base<span class="op">++;</span></span>
<span id="cb256-32"><a aria-hidden="true" href="#cb256-32" tabindex="-1"></a>  <span class="co">/* Remember how many bytes and characters we consumed.  */</span></span>
<span id="cb256-33"><a aria-hidden="true" href="#cb256-33" tabindex="-1"></a>  coding<span class="op">-&gt;</span>consumed <span class="op">=</span> coding<span class="op">-&gt;</span>consumed_char <span class="op">=</span> src_base <span class="op">-</span> coding<span class="op">-&gt;</span>source<span class="op">;</span></span>
<span id="cb256-34"><a aria-hidden="true" href="#cb256-34" tabindex="-1"></a>  <span class="co">/* Remember how many characters we produced.  */</span></span>
<span id="cb256-35"><a aria-hidden="true" href="#cb256-35" tabindex="-1"></a>  coding<span class="op">-&gt;</span>charbuf_used <span class="op">=</span> charbuf <span class="op">-</span> coding<span class="op">-&gt;</span>charbuf<span class="op">;</span></span>
<span id="cb256-36"><a aria-hidden="true" href="#cb256-36" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>Design patterns</strong>: - <strong>Restart
capability</strong>: Tracks position for resuming after buffer fills -
<strong>Graceful degradation</strong>: Treats invalid sequences as raw
bytes - <strong>Separation of concerns</strong>: Character buffer
isolates decode from output</p>
<h3 data-number="10.5.2" id="encoding-pipeline"><span class="header-section-number">10.5.2</span> Encoding Pipeline</h3>
<p>The generic encoding template from
<code>/home/user/emacs/src/coding.c:260-281</code>:</p>
<div class="sourceCode" id="cb257"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb257-1"><a aria-hidden="true" href="#cb257-1" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span></span>
<span id="cb257-2"><a aria-hidden="true" href="#cb257-2" tabindex="-1"></a>encode_coding_XXX <span class="op">(</span><span class="kw">struct</span> coding_system <span class="op">*</span>coding<span class="op">)</span></span>
<span id="cb257-3"><a aria-hidden="true" href="#cb257-3" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb257-4"><a aria-hidden="true" href="#cb257-4" tabindex="-1"></a>  <span class="dt">bool</span> multibytep <span class="op">=</span> coding<span class="op">-&gt;</span>dst_multibyte<span class="op">;</span></span>
<span id="cb257-5"><a aria-hidden="true" href="#cb257-5" tabindex="-1"></a>  <span class="dt">int</span> <span class="op">*</span>charbuf <span class="op">=</span> coding<span class="op">-&gt;</span>charbuf<span class="op">;</span></span>
<span id="cb257-6"><a aria-hidden="true" href="#cb257-6" tabindex="-1"></a>  <span class="dt">int</span> <span class="op">*</span>charbuf_end <span class="op">=</span> charbuf<span class="op">-&gt;</span>charbuf <span class="op">+</span> coding<span class="op">-&gt;</span>charbuf_used<span class="op">;</span></span>
<span id="cb257-7"><a aria-hidden="true" href="#cb257-7" tabindex="-1"></a>  <span class="dt">unsigned</span> <span class="dt">char</span> <span class="op">*</span>dst <span class="op">=</span> coding<span class="op">-&gt;</span>destination <span class="op">+</span> coding<span class="op">-&gt;</span>produced<span class="op">;</span></span>
<span id="cb257-8"><a aria-hidden="true" href="#cb257-8" tabindex="-1"></a>  <span class="dt">unsigned</span> <span class="dt">char</span> <span class="op">*</span>dst_end <span class="op">=</span> coding<span class="op">-&gt;</span>destination <span class="op">+</span> coding<span class="op">-&gt;</span>dst_bytes<span class="op">;</span></span>
<span id="cb257-9"><a aria-hidden="true" href="#cb257-9" tabindex="-1"></a>  <span class="dt">unsigned</span> <span class="dt">char</span> <span class="op">*</span>adjusted_dst_end <span class="op">=</span> dst_end <span class="op">-</span> _MAX_BYTES_PRODUCED_IN_LOOP_<span class="op">;</span></span>
<span id="cb257-10"><a aria-hidden="true" href="#cb257-10" tabindex="-1"></a>  <span class="dt">ptrdiff_t</span> produced_chars <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb257-11"><a aria-hidden="true" href="#cb257-11" tabindex="-1"></a></span>
<span id="cb257-12"><a aria-hidden="true" href="#cb257-12" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(;</span> charbuf <span class="op">&lt;</span> charbuf_end <span class="op">&amp;&amp;</span> dst <span class="op">&lt;</span> adjusted_dst_end<span class="op">;</span> charbuf<span class="op">++)</span></span>
<span id="cb257-13"><a aria-hidden="true" href="#cb257-13" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb257-14"><a aria-hidden="true" href="#cb257-14" tabindex="-1"></a>      <span class="dt">int</span> c <span class="op">=</span> <span class="op">*</span>charbuf<span class="op">;</span></span>
<span id="cb257-15"><a aria-hidden="true" href="#cb257-15" tabindex="-1"></a>      <span class="co">/* Encode C into DST, and increment DST.  */</span></span>
<span id="cb257-16"><a aria-hidden="true" href="#cb257-16" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb257-17"><a aria-hidden="true" href="#cb257-17" tabindex="-1"></a> label_no_more_destination<span class="op">:</span></span>
<span id="cb257-18"><a aria-hidden="true" href="#cb257-18" tabindex="-1"></a>  <span class="co">/* How many chars and bytes we produced.  */</span></span>
<span id="cb257-19"><a aria-hidden="true" href="#cb257-19" tabindex="-1"></a>  coding<span class="op">-&gt;</span>produced_char <span class="op">+=</span> produced_chars<span class="op">;</span></span>
<span id="cb257-20"><a aria-hidden="true" href="#cb257-20" tabindex="-1"></a>  coding<span class="op">-&gt;</span>produced <span class="op">=</span> dst <span class="op">-</span> coding<span class="op">-&gt;</span>destination<span class="op">;</span></span>
<span id="cb257-21"><a aria-hidden="true" href="#cb257-21" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 data-number="10.5.3" id="setup-and-configuration"><span class="header-section-number">10.5.3</span> Setup and Configuration</h3>
<p>From <code>/home/user/emacs/src/coding.c:5666-5815</code>:</p>
<div class="sourceCode" id="cb258"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb258-1"><a aria-hidden="true" href="#cb258-1" tabindex="-1"></a><span class="dt">void</span></span>
<span id="cb258-2"><a aria-hidden="true" href="#cb258-2" tabindex="-1"></a>setup_coding_system <span class="op">(</span>Lisp_Object coding_system<span class="op">,</span> <span class="kw">struct</span> coding_system <span class="op">*</span>coding<span class="op">)</span></span>
<span id="cb258-3"><a aria-hidden="true" href="#cb258-3" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb258-4"><a aria-hidden="true" href="#cb258-4" tabindex="-1"></a>  Lisp_Object attrs<span class="op">;</span></span>
<span id="cb258-5"><a aria-hidden="true" href="#cb258-5" tabindex="-1"></a>  Lisp_Object eol_type<span class="op">;</span></span>
<span id="cb258-6"><a aria-hidden="true" href="#cb258-6" tabindex="-1"></a>  Lisp_Object coding_type<span class="op">;</span></span>
<span id="cb258-7"><a aria-hidden="true" href="#cb258-7" tabindex="-1"></a></span>
<span id="cb258-8"><a aria-hidden="true" href="#cb258-8" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>NILP <span class="op">(</span>coding_system<span class="op">))</span></span>
<span id="cb258-9"><a aria-hidden="true" href="#cb258-9" tabindex="-1"></a>    coding_system <span class="op">=</span> Qundecided<span class="op">;</span></span>
<span id="cb258-10"><a aria-hidden="true" href="#cb258-10" tabindex="-1"></a></span>
<span id="cb258-11"><a aria-hidden="true" href="#cb258-11" tabindex="-1"></a>  CHECK_CODING_SYSTEM_GET_ID <span class="op">(</span>coding_system<span class="op">,</span> coding<span class="op">-&gt;</span>id<span class="op">);</span></span>
<span id="cb258-12"><a aria-hidden="true" href="#cb258-12" tabindex="-1"></a>  attrs <span class="op">=</span> CODING_ID_ATTRS <span class="op">(</span>coding<span class="op">-&gt;</span>id<span class="op">);</span></span>
<span id="cb258-13"><a aria-hidden="true" href="#cb258-13" tabindex="-1"></a>  eol_type <span class="op">=</span> inhibit_eol_conversion <span class="op">?</span> Qunix <span class="op">:</span> CODING_ID_EOL_TYPE <span class="op">(</span>coding<span class="op">-&gt;</span>id<span class="op">);</span></span>
<span id="cb258-14"><a aria-hidden="true" href="#cb258-14" tabindex="-1"></a></span>
<span id="cb258-15"><a aria-hidden="true" href="#cb258-15" tabindex="-1"></a>  coding_type <span class="op">=</span> CODING_ATTR_TYPE <span class="op">(</span>attrs<span class="op">);</span></span>
<span id="cb258-16"><a aria-hidden="true" href="#cb258-16" tabindex="-1"></a></span>
<span id="cb258-17"><a aria-hidden="true" href="#cb258-17" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>EQ <span class="op">(</span>coding_type<span class="op">,</span> Qutf_8<span class="op">))</span></span>
<span id="cb258-18"><a aria-hidden="true" href="#cb258-18" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb258-19"><a aria-hidden="true" href="#cb258-19" tabindex="-1"></a>      val <span class="op">=</span> AREF <span class="op">(</span>attrs<span class="op">,</span> coding_attr_utf_bom<span class="op">);</span></span>
<span id="cb258-20"><a aria-hidden="true" href="#cb258-20" tabindex="-1"></a>      CODING_UTF_8_BOM <span class="op">(</span>coding<span class="op">)</span> <span class="op">=</span> <span class="op">(</span>CONSP <span class="op">(</span>val<span class="op">)</span> <span class="op">?</span> utf_detect_bom</span>
<span id="cb258-21"><a aria-hidden="true" href="#cb258-21" tabindex="-1"></a>                   <span class="op">:</span> EQ <span class="op">(</span>val<span class="op">,</span> Qt<span class="op">)</span> <span class="op">?</span> utf_with_bom</span>
<span id="cb258-22"><a aria-hidden="true" href="#cb258-22" tabindex="-1"></a>                   <span class="op">:</span> utf_without_bom<span class="op">);</span></span>
<span id="cb258-23"><a aria-hidden="true" href="#cb258-23" tabindex="-1"></a>      coding<span class="op">-&gt;</span>detector <span class="op">=</span> detect_coding_utf_8<span class="op">;</span></span>
<span id="cb258-24"><a aria-hidden="true" href="#cb258-24" tabindex="-1"></a>      coding<span class="op">-&gt;</span>decoder <span class="op">=</span> decode_coding_utf_8<span class="op">;</span></span>
<span id="cb258-25"><a aria-hidden="true" href="#cb258-25" tabindex="-1"></a>      coding<span class="op">-&gt;</span>encoder <span class="op">=</span> encode_coding_utf_8<span class="op">;</span></span>
<span id="cb258-26"><a aria-hidden="true" href="#cb258-26" tabindex="-1"></a>      <span class="co">// ...</span></span>
<span id="cb258-27"><a aria-hidden="true" href="#cb258-27" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb258-28"><a aria-hidden="true" href="#cb258-28" tabindex="-1"></a>  <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>EQ <span class="op">(</span>coding_type<span class="op">,</span> Qutf_16<span class="op">))</span></span>
<span id="cb258-29"><a aria-hidden="true" href="#cb258-29" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb258-30"><a aria-hidden="true" href="#cb258-30" tabindex="-1"></a>      <span class="co">// UTF-16 setup...</span></span>
<span id="cb258-31"><a aria-hidden="true" href="#cb258-31" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb258-32"><a aria-hidden="true" href="#cb258-32" tabindex="-1"></a>  <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>EQ <span class="op">(</span>coding_type<span class="op">,</span> Qiso_2022<span class="op">))</span></span>
<span id="cb258-33"><a aria-hidden="true" href="#cb258-33" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb258-34"><a aria-hidden="true" href="#cb258-34" tabindex="-1"></a>      <span class="co">// ISO-2022 setup...</span></span>
<span id="cb258-35"><a aria-hidden="true" href="#cb258-35" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb258-36"><a aria-hidden="true" href="#cb258-36" tabindex="-1"></a>  <span class="co">// ... other coding systems</span></span>
<span id="cb258-37"><a aria-hidden="true" href="#cb258-37" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>Polymorphic dispatch</strong>: Each coding system type gets
its own detector/decoder/encoder functions assigned.</p>
<hr/>
<h2 data-number="10.6" id="eol-conversion-and-bom-handling"><span class="header-section-number">10.6</span> EOL Conversion and BOM
Handling</h2>
<h3 data-number="10.6.1" id="end-of-line-detection"><span class="header-section-number">10.6.1</span> End-of-Line Detection</h3>
<p>From <code>/home/user/emacs/src/coding.c:1101-1104</code>:</p>
<div class="sourceCode" id="cb259"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb259-1"><a aria-hidden="true" href="#cb259-1" tabindex="-1"></a><span class="pp">#define EOL_SEEN_NONE   </span><span class="dv">0</span></span>
<span id="cb259-2"><a aria-hidden="true" href="#cb259-2" tabindex="-1"></a><span class="pp">#define EOL_SEEN_LF </span><span class="dv">1</span></span>
<span id="cb259-3"><a aria-hidden="true" href="#cb259-3" tabindex="-1"></a><span class="pp">#define EOL_SEEN_CR </span><span class="dv">2</span></span>
<span id="cb259-4"><a aria-hidden="true" href="#cb259-4" tabindex="-1"></a><span class="pp">#define EOL_SEEN_CRLF   </span><span class="dv">4</span></span></code></pre></div>
<p>EOL detection is stateful and cumulative using bit flags. A file can
contain multiple EOL types, and Emacs tracks all of them:</p>
<div class="sourceCode" id="cb260"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb260-1"><a aria-hidden="true" href="#cb260-1" tabindex="-1"></a><span class="co">// During detection:</span></span>
<span id="cb260-2"><a aria-hidden="true" href="#cb260-2" tabindex="-1"></a><span class="cf">if</span> <span class="op">(</span>c <span class="op">==</span> <span class="ch">'</span><span class="sc">\n</span><span class="ch">'</span><span class="op">)</span></span>
<span id="cb260-3"><a aria-hidden="true" href="#cb260-3" tabindex="-1"></a>  eol_seen <span class="op">|=</span> EOL_SEEN_LF<span class="op">;</span></span>
<span id="cb260-4"><a aria-hidden="true" href="#cb260-4" tabindex="-1"></a><span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>c <span class="op">==</span> <span class="ch">'</span><span class="sc">\r</span><span class="ch">'</span><span class="op">)</span></span>
<span id="cb260-5"><a aria-hidden="true" href="#cb260-5" tabindex="-1"></a>  <span class="op">{</span></span>
<span id="cb260-6"><a aria-hidden="true" href="#cb260-6" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>next <span class="op">==</span> <span class="ch">'</span><span class="sc">\n</span><span class="ch">'</span><span class="op">)</span></span>
<span id="cb260-7"><a aria-hidden="true" href="#cb260-7" tabindex="-1"></a>      eol_seen <span class="op">|=</span> EOL_SEEN_CRLF<span class="op">;</span></span>
<span id="cb260-8"><a aria-hidden="true" href="#cb260-8" tabindex="-1"></a>    <span class="cf">else</span></span>
<span id="cb260-9"><a aria-hidden="true" href="#cb260-9" tabindex="-1"></a>      eol_seen <span class="op">|=</span> EOL_SEEN_CR<span class="op">;</span></span>
<span id="cb260-10"><a aria-hidden="true" href="#cb260-10" tabindex="-1"></a>  <span class="op">}</span></span></code></pre></div>
<p><strong>Heuristic decision</strong>: After scanning, the most common
EOL type is chosen. If <code>CRLF</code> is seen, it takes precedence as
it‚Äôs most specific.</p>
<h3 data-number="10.6.2" id="bom-byte-order-mark-handling"><span class="header-section-number">10.6.2</span> BOM (Byte Order Mark)
Handling</h3>
<h4 data-number="10.6.2.1" id="utf-8-bom"><span class="header-section-number">10.6.2.1</span> UTF-8 BOM</h4>
<p>From <code>/home/user/emacs/src/coding.c:1124-1155</code>:</p>
<div class="sourceCode" id="cb261"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb261-1"><a aria-hidden="true" href="#cb261-1" tabindex="-1"></a><span class="pp">#define UTF_8_BOM_1 </span><span class="bn">0xEF</span></span>
<span id="cb261-2"><a aria-hidden="true" href="#cb261-2" tabindex="-1"></a><span class="pp">#define UTF_8_BOM_2 </span><span class="bn">0xBB</span></span>
<span id="cb261-3"><a aria-hidden="true" href="#cb261-3" tabindex="-1"></a><span class="pp">#define UTF_8_BOM_3 </span><span class="bn">0xBF</span></span>
<span id="cb261-4"><a aria-hidden="true" href="#cb261-4" tabindex="-1"></a></span>
<span id="cb261-5"><a aria-hidden="true" href="#cb261-5" tabindex="-1"></a><span class="dt">static</span> <span class="dt">bool</span></span>
<span id="cb261-6"><a aria-hidden="true" href="#cb261-6" tabindex="-1"></a>detect_coding_utf_8 <span class="op">(</span><span class="kw">struct</span> coding_system <span class="op">*</span>coding<span class="op">,</span></span>
<span id="cb261-7"><a aria-hidden="true" href="#cb261-7" tabindex="-1"></a>             <span class="kw">struct</span> coding_detection_info <span class="op">*</span>detect_info<span class="op">)</span></span>
<span id="cb261-8"><a aria-hidden="true" href="#cb261-8" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb261-9"><a aria-hidden="true" href="#cb261-9" tabindex="-1"></a>  <span class="co">// ...</span></span>
<span id="cb261-10"><a aria-hidden="true" href="#cb261-10" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>src <span class="op">==</span> coding<span class="op">-&gt;</span>source <span class="co">/* BOM should be at the head.  */</span></span>
<span id="cb261-11"><a aria-hidden="true" href="#cb261-11" tabindex="-1"></a>      <span class="op">&amp;&amp;</span> src <span class="op">+</span> <span class="dv">3</span> <span class="op">&lt;</span> src_end  <span class="co">/* BOM is 3-byte long.  */</span></span>
<span id="cb261-12"><a aria-hidden="true" href="#cb261-12" tabindex="-1"></a>      <span class="op">&amp;&amp;</span> src<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">==</span> UTF_8_BOM_1</span>
<span id="cb261-13"><a aria-hidden="true" href="#cb261-13" tabindex="-1"></a>      <span class="op">&amp;&amp;</span> src<span class="op">[</span><span class="dv">1</span><span class="op">]</span> <span class="op">==</span> UTF_8_BOM_2</span>
<span id="cb261-14"><a aria-hidden="true" href="#cb261-14" tabindex="-1"></a>      <span class="op">&amp;&amp;</span> src<span class="op">[</span><span class="dv">2</span><span class="op">]</span> <span class="op">==</span> UTF_8_BOM_3<span class="op">)</span></span>
<span id="cb261-15"><a aria-hidden="true" href="#cb261-15" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb261-16"><a aria-hidden="true" href="#cb261-16" tabindex="-1"></a>      bom_found <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb261-17"><a aria-hidden="true" href="#cb261-17" tabindex="-1"></a>      src <span class="op">+=</span> <span class="dv">3</span><span class="op">;</span></span>
<span id="cb261-18"><a aria-hidden="true" href="#cb261-18" tabindex="-1"></a>      nchars<span class="op">++;</span></span>
<span id="cb261-19"><a aria-hidden="true" href="#cb261-19" tabindex="-1"></a>    <span class="op">}</span></span></code></pre></div>
<p><strong>BOM policy</strong>: - <strong>Detection</strong>: BOM must
be at file start - <strong>Preservation</strong>: BOM is consumed during
decode, not passed to buffer - <strong>Generation</strong>: Controlled
by coding system attributes</p>
<h4 data-number="10.6.2.2" id="utf-16-bom"><span class="header-section-number">10.6.2.2</span> UTF-16 BOM</h4>
<p>UTF-16 has more complex BOM handling because it determines byte
order:</p>
<div class="sourceCode" id="cb262"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb262-1"><a aria-hidden="true" href="#cb262-1" tabindex="-1"></a><span class="kw">enum</span> utf_bom_type</span>
<span id="cb262-2"><a aria-hidden="true" href="#cb262-2" tabindex="-1"></a>  <span class="op">{</span></span>
<span id="cb262-3"><a aria-hidden="true" href="#cb262-3" tabindex="-1"></a>    utf_detect_bom<span class="op">,</span>      <span class="co">// Auto-detect based on BOM</span></span>
<span id="cb262-4"><a aria-hidden="true" href="#cb262-4" tabindex="-1"></a>    utf_without_bom<span class="op">,</span>     <span class="co">// No BOM expected</span></span>
<span id="cb262-5"><a aria-hidden="true" href="#cb262-5" tabindex="-1"></a>    utf_with_bom         <span class="co">// BOM required</span></span>
<span id="cb262-6"><a aria-hidden="true" href="#cb262-6" tabindex="-1"></a>  <span class="op">};</span></span>
<span id="cb262-7"><a aria-hidden="true" href="#cb262-7" tabindex="-1"></a></span>
<span id="cb262-8"><a aria-hidden="true" href="#cb262-8" tabindex="-1"></a><span class="kw">enum</span> utf_16_endian_type</span>
<span id="cb262-9"><a aria-hidden="true" href="#cb262-9" tabindex="-1"></a>  <span class="op">{</span></span>
<span id="cb262-10"><a aria-hidden="true" href="#cb262-10" tabindex="-1"></a>    utf_16_big_endian<span class="op">,</span></span>
<span id="cb262-11"><a aria-hidden="true" href="#cb262-11" tabindex="-1"></a>    utf_16_little_endian</span>
<span id="cb262-12"><a aria-hidden="true" href="#cb262-12" tabindex="-1"></a>  <span class="op">};</span></span></code></pre></div>
<p>The BOM <code>0xFEFF</code> appears as: - <code>FE FF</code> in
big-endian - <code>FF FE</code> in little-endian</p>
<p><strong>Detection strategy</strong>: If BOM present, use it to
determine endianness. Otherwise, use statistical analysis of the byte
stream.</p>
<hr/>
<h2 data-number="10.7" id="charset-system"><span class="header-section-number">10.7</span> Charset System</h2>
<h3 data-number="10.7.1" id="charset-architecture"><span class="header-section-number">10.7.1</span> Charset Architecture</h3>
<p>From <code>/home/user/emacs/src/charset.c:43-56</code>:</p>
<pre><code>/*** GENERAL NOTES on CODED CHARACTER SETS (CHARSETS) ***

  A coded character set ("charset" hereafter) is a meaningful
  collection (i.e. language, culture, functionality, etc.) of
  characters.  Emacs handles multiple charsets at once.  In Emacs Lisp
  code, a charset is represented by a symbol.  In C code, a charset is
  represented by its ID number or by a pointer to a struct charset.

  The actual information about each charset is stored in two places.
  Lispy information is stored in the hash table Vcharset_hash_table as
  a vector (charset attributes).  The other information is stored in
  charset_table as a struct charset.</code></pre>
<h3 data-number="10.7.2" id="dual-representation"><span class="header-section-number">10.7.2</span> Dual Representation</h3>
<pre><code>Lisp Level:              C Level:
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Symbol       ‚îÇ        ‚îÇ struct charset   ‚îÇ
‚îÇ 'iso-8859-1  ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ {                ‚îÇ
‚îÇ              ‚îÇ        ‚îÇ   id: 42         ‚îÇ
‚îÇ              ‚îÇ        ‚îÇ   dimension: 1   ‚îÇ
‚îÇ              ‚îÇ        ‚îÇ   code_space[8]  ‚îÇ
‚îÇ              ‚îÇ        ‚îÇ   min_code       ‚îÇ
‚îÇ              ‚îÇ        ‚îÇ   max_code       ‚îÇ
‚îÇ              ‚îÇ        ‚îÇ   ...            ‚îÇ
‚îÇ              ‚îÇ        ‚îÇ }                ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
        ‚îÇ                       ‚îÇ
        ‚ñº                       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ    Vcharset_hash_table               ‚îÇ
‚îÇ    (Symbol ‚Üí Attribute Vector)       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò</code></pre>
<h3 data-number="10.7.3" id="code-point-mapping"><span class="header-section-number">10.7.3</span> Code Point Mapping</h3>
<p>From <code>/home/user/emacs/src/charset.c:106-141</code>:</p>
<div class="sourceCode" id="cb265"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb265-1"><a aria-hidden="true" href="#cb265-1" tabindex="-1"></a><span class="pp">#define CODE_POINT_TO_INDEX</span><span class="op">(</span><span class="pp">charset</span><span class="op">,</span><span class="pp"> code</span><span class="op">)</span><span class="pp">              </span><span class="op">\</span></span>
<span id="cb265-2"><a aria-hidden="true" href="#cb265-2" tabindex="-1"></a><span class="pp">  </span><span class="op">((</span><span class="pp">charset</span><span class="op">)-&gt;</span><span class="pp">code_linear_p                     </span><span class="op">\</span></span>
<span id="cb265-3"><a aria-hidden="true" href="#cb265-3" tabindex="-1"></a><span class="pp">   </span><span class="op">?</span><span class="pp"> </span><span class="op">(</span><span class="dt">int</span><span class="op">)</span><span class="pp"> </span><span class="op">((</span><span class="pp">code</span><span class="op">)</span><span class="pp"> </span><span class="op">-</span><span class="pp"> </span><span class="op">(</span><span class="pp">charset</span><span class="op">)-&gt;</span><span class="pp">min_code</span><span class="op">)</span><span class="pp">               </span><span class="op">\</span></span>
<span id="cb265-4"><a aria-hidden="true" href="#cb265-4" tabindex="-1"></a><span class="pp">   </span><span class="op">:</span><span class="pp"> </span><span class="op">(((</span><span class="pp">charset</span><span class="op">)-&gt;</span><span class="pp">code_space_mask</span><span class="op">[(</span><span class="pp">code</span><span class="op">)</span><span class="pp"> </span><span class="op">&gt;&gt;</span><span class="pp"> </span><span class="dv">24</span><span class="op">]</span><span class="pp"> </span><span class="op">&amp;</span><span class="pp"> </span><span class="bn">0x8</span><span class="op">)</span><span class="pp">          </span><span class="op">\</span></span>
<span id="cb265-5"><a aria-hidden="true" href="#cb265-5" tabindex="-1"></a><span class="pp">      </span><span class="op">&amp;&amp;</span><span class="pp"> </span><span class="op">((</span><span class="pp">charset</span><span class="op">)-&gt;</span><span class="pp">code_space_mask</span><span class="op">[((</span><span class="pp">code</span><span class="op">)</span><span class="pp"> </span><span class="op">&gt;&gt;</span><span class="pp"> </span><span class="dv">16</span><span class="op">)</span><span class="pp"> </span><span class="op">&amp;</span><span class="pp"> </span><span class="bn">0xFF</span><span class="op">]</span><span class="pp"> </span><span class="op">&amp;</span><span class="pp"> </span><span class="bn">0x4</span><span class="op">)</span><span class="pp">  </span><span class="op">\</span></span>
<span id="cb265-6"><a aria-hidden="true" href="#cb265-6" tabindex="-1"></a><span class="pp">      </span><span class="op">&amp;&amp;</span><span class="pp"> </span><span class="op">((</span><span class="pp">charset</span><span class="op">)-&gt;</span><span class="pp">code_space_mask</span><span class="op">[((</span><span class="pp">code</span><span class="op">)</span><span class="pp"> </span><span class="op">&gt;&gt;</span><span class="pp"> </span><span class="dv">8</span><span class="op">)</span><span class="pp"> </span><span class="op">&amp;</span><span class="pp"> </span><span class="bn">0xFF</span><span class="op">]</span><span class="pp"> </span><span class="op">&amp;</span><span class="pp"> </span><span class="bn">0x2</span><span class="op">)</span><span class="pp">   </span><span class="op">\</span></span>
<span id="cb265-7"><a aria-hidden="true" href="#cb265-7" tabindex="-1"></a><span class="pp">      </span><span class="op">&amp;&amp;</span><span class="pp"> </span><span class="op">((</span><span class="pp">charset</span><span class="op">)-&gt;</span><span class="pp">code_space_mask</span><span class="op">[(</span><span class="pp">code</span><span class="op">)</span><span class="pp"> </span><span class="op">&amp;</span><span class="pp"> </span><span class="bn">0xFF</span><span class="op">]</span><span class="pp"> </span><span class="op">&amp;</span><span class="pp"> </span><span class="bn">0x1</span><span class="op">))</span><span class="pp">     </span><span class="op">\</span></span>
<span id="cb265-8"><a aria-hidden="true" href="#cb265-8" tabindex="-1"></a><span class="pp">   </span><span class="op">?</span><span class="pp"> </span><span class="op">(</span><span class="dt">int</span><span class="op">)</span><span class="pp"> </span><span class="op">(((((</span><span class="pp">code</span><span class="op">)</span><span class="pp"> </span><span class="op">&gt;&gt;</span><span class="pp"> </span><span class="dv">24</span><span class="op">)</span><span class="pp"> </span><span class="op">-</span><span class="pp"> </span><span class="op">(</span><span class="pp">charset</span><span class="op">)-&gt;</span><span class="pp">code_space</span><span class="op">[</span><span class="dv">12</span><span class="op">])</span><span class="pp">       </span><span class="op">\</span></span>
<span id="cb265-9"><a aria-hidden="true" href="#cb265-9" tabindex="-1"></a><span class="pp">         </span><span class="op">*</span><span class="pp"> </span><span class="op">(</span><span class="pp">charset</span><span class="op">)-&gt;</span><span class="pp">code_space</span><span class="op">[</span><span class="dv">11</span><span class="op">])</span><span class="pp">               </span><span class="op">\</span></span>
<span id="cb265-10"><a aria-hidden="true" href="#cb265-10" tabindex="-1"></a><span class="pp">        </span><span class="op">+</span><span class="pp"> </span><span class="op">(((((</span><span class="pp">code</span><span class="op">)</span><span class="pp"> </span><span class="op">&gt;&gt;</span><span class="pp"> </span><span class="dv">16</span><span class="op">)</span><span class="pp"> </span><span class="op">&amp;</span><span class="pp"> </span><span class="bn">0xFF</span><span class="op">)</span><span class="pp"> </span><span class="op">-</span><span class="pp"> </span><span class="op">(</span><span class="pp">charset</span><span class="op">)-&gt;</span><span class="pp">code_space</span><span class="op">[</span><span class="dv">8</span><span class="op">])</span><span class="pp"> </span><span class="op">\</span></span>
<span id="cb265-11"><a aria-hidden="true" href="#cb265-11" tabindex="-1"></a><span class="pp">           </span><span class="op">*</span><span class="pp"> </span><span class="op">(</span><span class="pp">charset</span><span class="op">)-&gt;</span><span class="pp">code_space</span><span class="op">[</span><span class="dv">7</span><span class="op">])</span><span class="pp">              </span><span class="op">\</span></span>
<span id="cb265-12"><a aria-hidden="true" href="#cb265-12" tabindex="-1"></a><span class="pp">        </span><span class="op">+</span><span class="pp"> </span><span class="op">(((((</span><span class="pp">code</span><span class="op">)</span><span class="pp"> </span><span class="op">&gt;&gt;</span><span class="pp"> </span><span class="dv">8</span><span class="op">)</span><span class="pp"> </span><span class="op">&amp;</span><span class="pp"> </span><span class="bn">0xFF</span><span class="op">)</span><span class="pp"> </span><span class="op">-</span><span class="pp"> </span><span class="op">(</span><span class="pp">charset</span><span class="op">)-&gt;</span><span class="pp">code_space</span><span class="op">[</span><span class="dv">4</span><span class="op">])</span><span class="pp">  </span><span class="op">\</span></span>
<span id="cb265-13"><a aria-hidden="true" href="#cb265-13" tabindex="-1"></a><span class="pp">           </span><span class="op">*</span><span class="pp"> </span><span class="op">(</span><span class="pp">charset</span><span class="op">)-&gt;</span><span class="pp">code_space</span><span class="op">[</span><span class="dv">3</span><span class="op">])</span><span class="pp">              </span><span class="op">\</span></span>
<span id="cb265-14"><a aria-hidden="true" href="#cb265-14" tabindex="-1"></a><span class="pp">        </span><span class="op">+</span><span class="pp"> </span><span class="op">(((</span><span class="pp">code</span><span class="op">)</span><span class="pp"> </span><span class="op">&amp;</span><span class="pp"> </span><span class="bn">0xFF</span><span class="op">)</span><span class="pp"> </span><span class="op">-</span><span class="pp"> </span><span class="op">(</span><span class="pp">charset</span><span class="op">)-&gt;</span><span class="pp">code_space</span><span class="op">[</span><span class="dv">0</span><span class="op">])</span><span class="pp">      </span><span class="op">\</span></span>
<span id="cb265-15"><a aria-hidden="true" href="#cb265-15" tabindex="-1"></a><span class="pp">        </span><span class="op">-</span><span class="pp"> </span><span class="op">((</span><span class="pp">charset</span><span class="op">)-&gt;</span><span class="pp">char_index_offset</span><span class="op">))</span><span class="pp">               </span><span class="op">\</span></span>
<span id="cb265-16"><a aria-hidden="true" href="#cb265-16" tabindex="-1"></a><span class="pp">   </span><span class="op">:</span><span class="pp"> </span><span class="op">-</span><span class="dv">1</span><span class="op">)</span></span></code></pre></div>
<p><strong>Two strategies</strong>: 1. <strong>Linear charsets</strong>:
Simple offset calculation (ASCII, ISO-8859-*) 2. <strong>Non-linear
charsets</strong>: Multi-dimensional mapping (CJK ideographs)</p>
<h3 data-number="10.7.4" id="important-charsets"><span class="header-section-number">10.7.4</span> Important Charsets</h3>
<p>From <code>/home/user/emacs/src/charset.c:67-81</code>:</p>
<div class="sourceCode" id="cb266"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb266-1"><a aria-hidden="true" href="#cb266-1" tabindex="-1"></a><span class="co">/* Special charsets corresponding to symbols.  */</span></span>
<span id="cb266-2"><a aria-hidden="true" href="#cb266-2" tabindex="-1"></a><span class="dt">int</span> charset_ascii<span class="op">;</span></span>
<span id="cb266-3"><a aria-hidden="true" href="#cb266-3" tabindex="-1"></a><span class="dt">int</span> charset_eight_bit<span class="op">;</span></span>
<span id="cb266-4"><a aria-hidden="true" href="#cb266-4" tabindex="-1"></a><span class="dt">static</span> <span class="dt">int</span> charset_iso_8859_1<span class="op">;</span></span>
<span id="cb266-5"><a aria-hidden="true" href="#cb266-5" tabindex="-1"></a><span class="dt">int</span> charset_unicode<span class="op">;</span></span>
<span id="cb266-6"><a aria-hidden="true" href="#cb266-6" tabindex="-1"></a><span class="dt">static</span> <span class="dt">int</span> charset_emacs<span class="op">;</span></span>
<span id="cb266-7"><a aria-hidden="true" href="#cb266-7" tabindex="-1"></a></span>
<span id="cb266-8"><a aria-hidden="true" href="#cb266-8" tabindex="-1"></a><span class="co">/* The other special charsets.  */</span></span>
<span id="cb266-9"><a aria-hidden="true" href="#cb266-9" tabindex="-1"></a><span class="dt">int</span> charset_jisx0201_roman<span class="op">;</span></span>
<span id="cb266-10"><a aria-hidden="true" href="#cb266-10" tabindex="-1"></a><span class="dt">int</span> charset_jisx0208_1978<span class="op">;</span></span>
<span id="cb266-11"><a aria-hidden="true" href="#cb266-11" tabindex="-1"></a><span class="dt">int</span> charset_jisx0208<span class="op">;</span></span>
<span id="cb266-12"><a aria-hidden="true" href="#cb266-12" tabindex="-1"></a><span class="dt">int</span> charset_ksc5601<span class="op">;</span></span>
<span id="cb266-13"><a aria-hidden="true" href="#cb266-13" tabindex="-1"></a></span>
<span id="cb266-14"><a aria-hidden="true" href="#cb266-14" tabindex="-1"></a><span class="co">/* Charset of unibyte characters.  */</span></span>
<span id="cb266-15"><a aria-hidden="true" href="#cb266-15" tabindex="-1"></a><span class="dt">int</span> charset_unibyte<span class="op">;</span></span></code></pre></div>
<h3 data-number="10.7.5" id="character-composition"><span class="header-section-number">10.7.5</span> Character Composition</h3>
<p>Emacs supports complex character composition for languages like Thai,
Arabic, and Indic scripts. Characters can be composed using composition
rules:</p>
<p>From <code>/home/user/emacs/src/coding.c:1084-1090</code>:</p>
<div class="sourceCode" id="cb267"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb267-1"><a aria-hidden="true" href="#cb267-1" tabindex="-1"></a><span class="pp">#define ADD_COMPOSITION_DATA</span><span class="op">(</span><span class="pp">buf</span><span class="op">,</span><span class="pp"> nchars</span><span class="op">,</span><span class="pp"> nbytes</span><span class="op">,</span><span class="pp"> method</span><span class="op">)</span><span class="pp">           </span><span class="op">\</span></span>
<span id="cb267-2"><a aria-hidden="true" href="#cb267-2" tabindex="-1"></a><span class="pp">  </span><span class="cf">do</span><span class="pp"> </span><span class="op">{</span><span class="pp">                                      </span><span class="op">\</span></span>
<span id="cb267-3"><a aria-hidden="true" href="#cb267-3" tabindex="-1"></a><span class="pp">    ADD_ANNOTATION_DATA </span><span class="op">(</span><span class="pp">buf</span><span class="op">,</span><span class="pp"> </span><span class="dv">5</span><span class="op">,</span><span class="pp"> CODING_ANNOTATE_COMPOSITION_MASK</span><span class="op">,</span><span class="pp"> nchars</span><span class="op">);</span><span class="pp"> </span><span class="op">\</span></span>
<span id="cb267-4"><a aria-hidden="true" href="#cb267-4" tabindex="-1"></a><span class="pp">    </span><span class="op">*</span><span class="pp">buf</span><span class="op">++</span><span class="pp"> </span><span class="op">=</span><span class="pp"> nbytes</span><span class="op">;</span><span class="pp">                                </span><span class="op">\</span></span>
<span id="cb267-5"><a aria-hidden="true" href="#cb267-5" tabindex="-1"></a><span class="pp">    </span><span class="op">*</span><span class="pp">buf</span><span class="op">++</span><span class="pp"> </span><span class="op">=</span><span class="pp"> method</span><span class="op">;</span><span class="pp">                                </span><span class="op">\</span></span>
<span id="cb267-6"><a aria-hidden="true" href="#cb267-6" tabindex="-1"></a><span class="pp">  </span><span class="op">}</span><span class="pp"> </span><span class="cf">while</span><span class="pp"> </span><span class="op">(</span><span class="dv">0</span><span class="op">)</span></span></code></pre></div>
<p><strong>Composition methods</strong>: - <strong>Relative</strong>:
Characters overlap - <strong>Base + combining</strong>: Base character
with combining marks - <strong>Rule-based</strong>: Complex composition
rules (from language-specific tables)</p>
<hr/>
<h2 data-number="10.8" id="ccl-interpreter"><span class="header-section-number">10.8</span> CCL Interpreter</h2>
<p>The CCL (Code Conversion Language) interpreter provides a way to
define custom character encoding/decoding without writing C code.</p>
<p>From <code>/home/user/emacs/src/ccl.c:50-84</code>:</p>
<div class="sourceCode" id="cb268"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb268-1"><a aria-hidden="true" href="#cb268-1" tabindex="-1"></a><span class="co">/* CCL (Code Conversion Language) is a simple language which has</span></span>
<span id="cb268-2"><a aria-hidden="true" href="#cb268-2" tabindex="-1"></a><span class="co">   operations on one input buffer, one output buffer, and 7 registers.</span></span>
<span id="cb268-3"><a aria-hidden="true" href="#cb268-3" tabindex="-1"></a><span class="co">   The syntax of CCL is described in `ccl.el'.  Emacs Lisp function</span></span>
<span id="cb268-4"><a aria-hidden="true" href="#cb268-4" tabindex="-1"></a><span class="co">   `ccl-compile' compiles a CCL program and produces a CCL code which</span></span>
<span id="cb268-5"><a aria-hidden="true" href="#cb268-5" tabindex="-1"></a><span class="co">   is a vector of integers.  The structure of this vector is as</span></span>
<span id="cb268-6"><a aria-hidden="true" href="#cb268-6" tabindex="-1"></a><span class="co">   follows: The 1st element: buffer-magnification, a factor for the</span></span>
<span id="cb268-7"><a aria-hidden="true" href="#cb268-7" tabindex="-1"></a><span class="co">   size of output buffer compared with the size of input buffer.  The</span></span>
<span id="cb268-8"><a aria-hidden="true" href="#cb268-8" tabindex="-1"></a><span class="co">   2nd element: address of CCL code to be executed when encountered</span></span>
<span id="cb268-9"><a aria-hidden="true" href="#cb268-9" tabindex="-1"></a><span class="co">   with end of input stream.  The 3rd and the remaining elements: CCL</span></span>
<span id="cb268-10"><a aria-hidden="true" href="#cb268-10" tabindex="-1"></a><span class="co">   codes.  */</span></span>
<span id="cb268-11"><a aria-hidden="true" href="#cb268-11" tabindex="-1"></a></span>
<span id="cb268-12"><a aria-hidden="true" href="#cb268-12" tabindex="-1"></a><span class="co">/* CCL code is a sequence of 28-bit integers.  Each contains a CCL</span></span>
<span id="cb268-13"><a aria-hidden="true" href="#cb268-13" tabindex="-1"></a><span class="co">   command and/or arguments in the following format:</span></span>
<span id="cb268-14"><a aria-hidden="true" href="#cb268-14" tabindex="-1"></a></span>
<span id="cb268-15"><a aria-hidden="true" href="#cb268-15" tabindex="-1"></a><span class="co">    |----------------- integer (28-bit) ------------------|</span></span>
<span id="cb268-16"><a aria-hidden="true" href="#cb268-16" tabindex="-1"></a><span class="co">    |------- 17-bit ------|- 3-bit --|- 3-bit --|- 5-bit -|</span></span>
<span id="cb268-17"><a aria-hidden="true" href="#cb268-17" tabindex="-1"></a><span class="co">    |--constant argument--|-register-|-register-|-command-|</span></span>
<span id="cb268-18"><a aria-hidden="true" href="#cb268-18" tabindex="-1"></a><span class="co">       ccccccccccccccccc      RRR        rrr       XXXXX</span></span>
<span id="cb268-19"><a aria-hidden="true" href="#cb268-19" tabindex="-1"></a><span class="co">  or</span></span>
<span id="cb268-20"><a aria-hidden="true" href="#cb268-20" tabindex="-1"></a><span class="co">    |------- relative address -------|-register-|-command-|</span></span>
<span id="cb268-21"><a aria-hidden="true" href="#cb268-21" tabindex="-1"></a><span class="co">           cccccccccccccccccccc          rrr       XXXXX</span></span>
<span id="cb268-22"><a aria-hidden="true" href="#cb268-22" tabindex="-1"></a><span class="co">  or</span></span>
<span id="cb268-23"><a aria-hidden="true" href="#cb268-23" tabindex="-1"></a><span class="co">    |------------- constant or other args ----------------|</span></span>
<span id="cb268-24"><a aria-hidden="true" href="#cb268-24" tabindex="-1"></a><span class="co">                     cccccccccccccccccccccccccccc</span></span></code></pre></div>
<h3 data-number="10.8.1" id="ccl-architecture"><span class="header-section-number">10.8.1</span> CCL Architecture</h3>
<pre><code>‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ          Lisp CCL Program               ‚îÇ
‚îÇ      (define-ccl-program ...)           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                 ‚îÇ
                 ‚îÇ ccl-compile
                 ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ         CCL Code Vector                 ‚îÇ
‚îÇ  [buf-mag, eof-addr, code1, code2, ...] ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                 ‚îÇ
                 ‚îÇ ccl_driver
                 ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ         CCL Virtual Machine             ‚îÇ
‚îÇ  ‚Ä¢ 7 registers (r0-r6)                  ‚îÇ
‚îÇ  ‚Ä¢ Input buffer + pointer               ‚îÇ
‚îÇ  ‚Ä¢ Output buffer + pointer              ‚îÇ
‚îÇ  ‚Ä¢ Instruction counter                  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò</code></pre>
<h3 data-number="10.8.2" id="ccl-commands"><span class="header-section-number">10.8.2</span> CCL Commands</h3>
<p>Basic commands include: - <code>CCL_SetRegister</code>: Copy register
to register - <code>CCL_SetConst</code>: Load constant into register -
<code>CCL_ReadWriteReadJump</code>: Read, write, read again, then jump -
<code>CCL_Branch</code>: Conditional branching -
<code>CCL_Translate</code>: Table-based character translation -
<code>CCL_End</code>: Terminate CCL program</p>
<p><strong>Use cases</strong>: - Legacy encodings not built into Emacs -
Custom encoding schemes - Character transliteration tables - Special
text transformations during I/O</p>
<hr/>
<h2 data-number="10.9" id="file-operations-pipeline"><span class="header-section-number">10.9</span> File Operations Pipeline</h2>
<h3 data-number="10.9.1" id="complete-read-pipeline"><span class="header-section-number">10.9.1</span> Complete Read Pipeline</h3>
<pre><code>find-file
   ‚îÇ
   ‚îú‚îÄ‚îÄ‚ñ∂ File name expansion
   ‚îÇ    ‚îî‚îÄ expand-file-name (handles ~, .., symlinks)
   ‚îÇ
   ‚îú‚îÄ‚îÄ‚ñ∂ File name handler check
   ‚îÇ    ‚îî‚îÄ Ffind_file_name_handler (TRAMP, ange-ftp, archives)
   ‚îÇ
   ‚îú‚îÄ‚îÄ‚ñ∂ File locking
   ‚îÇ    ‚îî‚îÄ lock_file (create .#filename symlink)
   ‚îÇ
   ‚îú‚îÄ‚îÄ‚ñ∂ insert-file-contents
   ‚îÇ    ‚îÇ
   ‚îÇ    ‚îú‚îÄ‚îÄ‚ñ∂ Open file
   ‚îÇ    ‚îÇ    ‚îî‚îÄ emacs_fd_open (platform abstracted)
   ‚îÇ    ‚îÇ
   ‚îÇ    ‚îú‚îÄ‚îÄ‚ñ∂ Determine coding system
   ‚îÇ    ‚îÇ    ‚îú‚îÄ coding-system-for-read (highest priority)
   ‚îÇ    ‚îÇ    ‚îú‚îÄ file-coding-system-alist
   ‚îÇ    ‚îÇ    ‚îú‚îÄ Auto-detection
   ‚îÇ    ‚îÇ    ‚îî‚îÄ default-buffer-file-coding-system
   ‚îÇ    ‚îÇ
   ‚îÇ    ‚îú‚îÄ‚îÄ‚ñ∂ Setup coding system
   ‚îÇ    ‚îÇ    ‚îî‚îÄ setup_coding_system
   ‚îÇ    ‚îÇ
   ‚îÇ    ‚îú‚îÄ‚îÄ‚ñ∂ Read loop (1 MiB chunks)
   ‚îÇ    ‚îÇ    ‚îú‚îÄ emacs_fd_read
   ‚îÇ    ‚îÇ    ‚îú‚îÄ decode_coding (bytes ‚Üí chars)
   ‚îÇ    ‚îÇ    ‚îî‚îÄ insert_from_gap (chars ‚Üí buffer)
   ‚îÇ    ‚îÇ
   ‚îÇ    ‚îî‚îÄ‚îÄ‚ñ∂ EOL conversion
   ‚îÇ         ‚îî‚îÄ decode_eol (CR/LF/CRLF ‚Üí LF)
   ‚îÇ
   ‚îú‚îÄ‚îÄ‚ñ∂ Format decoding
   ‚îÇ    ‚îî‚îÄ format-decode (handles enriched text, etc.)
   ‚îÇ
   ‚îú‚îÄ‚îÄ‚ñ∂ Run hooks
   ‚îÇ    ‚îú‚îÄ find-file-hook
   ‚îÇ    ‚îî‚îÄ after-find-file
   ‚îÇ
   ‚îî‚îÄ‚îÄ‚ñ∂ Update buffer state
        ‚îú‚îÄ Set buffer-file-name
        ‚îú‚îÄ Set buffer-file-coding-system
        ‚îú‚îÄ Clear modified flag
        ‚îî‚îÄ Record modtime</code></pre>
<h3 data-number="10.9.2" id="complete-write-pipeline"><span class="header-section-number">10.9.2</span> Complete Write Pipeline</h3>
<pre><code>save-buffer
   ‚îÇ
   ‚îú‚îÄ‚îÄ‚ñ∂ Backup creation (if first save)
   ‚îÇ    ‚îî‚îÄ backup-buffer
   ‚îÇ         ‚îú‚îÄ Find backup file name
   ‚îÇ         ‚îî‚îÄ Copy or rename
   ‚îÇ
   ‚îú‚îÄ‚îÄ‚ñ∂ write-region
   ‚îÇ    ‚îÇ
   ‚îÇ    ‚îú‚îÄ‚îÄ‚ñ∂ File locking check
   ‚îÇ    ‚îÇ    ‚îî‚îÄ Verify we still own the lock
   ‚îÇ    ‚îÇ
   ‚îÇ    ‚îú‚îÄ‚îÄ‚ñ∂ Annotation functions
   ‚îÇ    ‚îÇ    ‚îî‚îÄ write-region-annotate-functions
   ‚îÇ    ‚îÇ
   ‚îÇ    ‚îú‚îÄ‚îÄ‚ñ∂ Determine coding system
   ‚îÇ    ‚îÇ    ‚îú‚îÄ coding-system-for-write
   ‚îÇ    ‚îÇ    ‚îú‚îÄ buffer-file-coding-system
   ‚îÇ    ‚îÇ    ‚îî‚îÄ select-safe-coding-system
   ‚îÇ    ‚îÇ
   ‚îÇ    ‚îú‚îÄ‚îÄ‚ñ∂ Temporary file creation
   ‚îÇ    ‚îÇ    ‚îî‚îÄ Open with O_EXCL | O_CREAT
   ‚îÇ    ‚îÇ
   ‚îÇ    ‚îú‚îÄ‚îÄ‚ñ∂ Encode and write
   ‚îÇ    ‚îÇ    ‚îú‚îÄ encode_coding (chars ‚Üí bytes)
   ‚îÇ    ‚îÇ    ‚îú‚îÄ encode_eol (LF ‚Üí CR/LF/CRLF)
   ‚îÇ    ‚îÇ    ‚îî‚îÄ e_write (write bytes)
   ‚îÇ    ‚îÇ
   ‚îÇ    ‚îú‚îÄ‚îÄ‚ñ∂ Sync to disk
   ‚îÇ    ‚îÇ    ‚îî‚îÄ fsync (if write-region-inhibit-fsync is nil)
   ‚îÇ    ‚îÇ
   ‚îÇ    ‚îî‚îÄ‚îÄ‚ñ∂ Atomic rename
   ‚îÇ         ‚îî‚îÄ rename(temp, target)
   ‚îÇ
   ‚îú‚îÄ‚îÄ‚ñ∂ Update buffer state
   ‚îÇ    ‚îú‚îÄ Clear modified flag
   ‚îÇ    ‚îú‚îÄ Update modtime
   ‚îÇ    ‚îî‚îÄ Set buffer-file-coding-system
   ‚îÇ
   ‚îî‚îÄ‚îÄ‚ñ∂ Unlock file
        ‚îî‚îÄ unlock_file (remove .#filename)</code></pre>
<h3 data-number="10.9.3" id="error-handling-strategy"><span class="header-section-number">10.9.3</span> Error Handling Strategy</h3>
<div class="sourceCode" id="cb272"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb272-1"><a aria-hidden="true" href="#cb272-1" tabindex="-1"></a><span class="co">// From write_region implementation:</span></span>
<span id="cb272-2"><a aria-hidden="true" href="#cb272-2" tabindex="-1"></a><span class="co">// 1. Write to temporary file</span></span>
<span id="cb272-3"><a aria-hidden="true" href="#cb272-3" tabindex="-1"></a><span class="co">// 2. If error occurs, temp file is cleaned up</span></span>
<span id="cb272-4"><a aria-hidden="true" href="#cb272-4" tabindex="-1"></a><span class="co">// 3. Original file remains untouched</span></span>
<span id="cb272-5"><a aria-hidden="true" href="#cb272-5" tabindex="-1"></a><span class="co">// 4. Only on successful write + fsync do we rename</span></span>
<span id="cb272-6"><a aria-hidden="true" href="#cb272-6" tabindex="-1"></a><span class="co">// 5. Rename is atomic on most file systems</span></span></code></pre></div>
<p><strong>Crash safety</strong>: Even if Emacs crashes during write,
the original file is preserved.</p>
<hr/>
<h2 data-number="10.10" id="backup-and-auto-save"><span class="header-section-number">10.10</span> Backup and Auto-Save</h2>
<h3 data-number="10.10.1" id="backup-strategy"><span class="header-section-number">10.10.1</span> Backup Strategy</h3>
<p>From <code>/home/user/emacs/lisp/files.el:5356-5435</code>:</p>
<pre class="elisp"><code>(defun backup-buffer ()
  "Make a backup of the disk file visited by the current buffer, if appropriate.
This is normally done before saving the buffer the first time.

A backup may be done by renaming or by copying; see documentation of
variable `make-backup-files'.  If it's done by renaming, then the file is
no longer accessible under its old name."
  (when (and make-backup-files (not backup-inhibited) (not buffer-backed-up))
    ;; Determine whether to copy or rename
    (let ((make-copy
        (or file-precious-flag backup-by-copying
        ;; Don't rename a suid or sgid file.
        (and modes (&lt; 0 (logand modes #o6000)))
        (not (file-writable-p (file-name-directory real-file-name)))
        (and backup-by-copying-when-linked
             (&lt; 1 (file-nlinks real-file-name)))
        ;; Preserve ownership/group
        (and backup-by-copying-when-mismatch
             (not (file-ownership-preserved-p real-file-name t))))))
      ;; Actually make the backup file.
      (if make-copy
      (backup-buffer-copy real-file-name backupname modes extended-attributes)
    ;; rename-file should delete old backup.
    (rename-file real-file-name backupname t))</code></pre>
<p><strong>Decision tree for backup method</strong>:</p>
<pre><code>Should use copying if:
‚îú‚îÄ file-precious-flag is set
‚îú‚îÄ backup-by-copying is set
‚îú‚îÄ File has setuid/setgid bits
‚îú‚îÄ Directory not writable
‚îú‚îÄ File has multiple hard links (backup-by-copying-when-linked)
‚îî‚îÄ Ownership would change (backup-by-copying-when-mismatch)

Otherwise use renaming (faster)</code></pre>
<h3 data-number="10.10.2" id="backup-file-naming"><span class="header-section-number">10.10.2</span> Backup File Naming</h3>
<pre class="elisp"><code>;; Simple backup
file.txt ‚Üí file.txt~

;; Numbered backup
file.txt ‚Üí file.txt.~1~
file.txt ‚Üí file.txt.~2~
file.txt ‚Üí file.txt.~3~</code></pre>
<h3 data-number="10.10.3" id="auto-save-mechanism"><span class="header-section-number">10.10.3</span> Auto-Save Mechanism</h3>
<p>From <code>/home/user/emacs/src/fileio.c:6313-6412</code>:</p>
<div class="sourceCode" id="cb276"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb276-1"><a aria-hidden="true" href="#cb276-1" tabindex="-1"></a>DEFUN <span class="op">(</span><span class="st">"do-auto-save"</span><span class="op">,</span> Fdo_auto_save<span class="op">,</span> Sdo_auto_save<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="st">""</span><span class="op">,</span></span>
<span id="cb276-2"><a aria-hidden="true" href="#cb276-2" tabindex="-1"></a>       doc<span class="op">:</span> <span class="co">/* Auto-save all buffers that need it.</span></span>
<span id="cb276-3"><a aria-hidden="true" href="#cb276-3" tabindex="-1"></a><span class="co">This auto-saves all buffers that have auto-saving enabled and</span></span>
<span id="cb276-4"><a aria-hidden="true" href="#cb276-4" tabindex="-1"></a><span class="co">were changed since last auto-saved.</span></span>
<span id="cb276-5"><a aria-hidden="true" href="#cb276-5" tabindex="-1"></a></span>
<span id="cb276-6"><a aria-hidden="true" href="#cb276-6" tabindex="-1"></a><span class="co">Auto-saving writes the buffer into a file so that your edits are</span></span>
<span id="cb276-7"><a aria-hidden="true" href="#cb276-7" tabindex="-1"></a><span class="co">not lost if the system crashes.</span></span>
<span id="cb276-8"><a aria-hidden="true" href="#cb276-8" tabindex="-1"></a></span>
<span id="cb276-9"><a aria-hidden="true" href="#cb276-9" tabindex="-1"></a><span class="co">The auto-save file is not the file you visited; that changes only</span></span>
<span id="cb276-10"><a aria-hidden="true" href="#cb276-10" tabindex="-1"></a><span class="co">when you save.  */</span><span class="op">)</span></span></code></pre></div>
<h4 data-number="10.10.3.1" id="auto-save-file-names"><span class="header-section-number">10.10.3.1</span> Auto-Save File Names</h4>
<pre><code>Regular file:        /path/to/file.txt
Auto-save file:      /path/to/#file.txt#

Unsaved buffer:      &lt;buffer-name&gt;
Auto-save file:      ~/.emacs.d/auto-save-list/.saves-PID-hostname~</code></pre>
<h4 data-number="10.10.3.2" id="auto-save-list-file"><span class="header-section-number">10.10.3.2</span> Auto-Save List File</h4>
<p>Emacs maintains a list of all auto-save files in
<code>auto-save-list-file-name</code>:</p>
<pre><code>/path/to/file.txt
/path/to/#file.txt#
/other/file.el
/other/#file.el#</code></pre>
<p>This allows recovery tools to: 1. Find all auto-saved files 2. Match
them to original files 3. Offer batch recovery after a crash</p>
<h4 data-number="10.10.3.3" id="auto-save-trigger-conditions"><span class="header-section-number">10.10.3.3</span> Auto-Save Trigger
Conditions</h4>
<pre class="elisp"><code>;; Triggered by:
auto-save-interval          ; Number of input events (default 300)
auto-save-timeout           ; Idle time in seconds (default 30)
kill-emacs-hook             ; When exiting Emacs</code></pre>
<hr/>
<h2 data-number="10.11" id="elisp-interface"><span class="header-section-number">10.11</span> Elisp Interface</h2>
<h3 data-number="10.11.1" id="file-io-functions"><span class="header-section-number">10.11.1</span> File I/O Functions</h3>
<p>From <code>/home/user/emacs/lisp/files.el</code>:</p>
<h4 data-number="10.11.1.1" id="core-reading"><span class="header-section-number">10.11.1.1</span> Core Reading</h4>
<pre class="elisp"><code>(defun find-file (filename &amp;optional wildcards)
  "Edit file FILENAME.
Switch to a buffer visiting file FILENAME, creating one if none exists."
  ;; Implementation delegates to find-file-noselect + switch-to-buffer
  )

(defun insert-file-contents (filename &amp;optional visit beg end replace)
  ;; C implementation in fileio.c
  )</code></pre>
<h4 data-number="10.11.1.2" id="core-writing"><span class="header-section-number">10.11.1.2</span> Core Writing</h4>
<pre class="elisp"><code>(defun save-buffer (&amp;optional args)
  "Save current buffer in visited file if modified.
Calls backup-buffer first time, then write-region."
  ;; Handles backup creation
  ;; Calls write-region (C function)
  ;; Updates buffer state
  )

(defun write-file (filename &amp;optional confirm)
  "Write current buffer into file FILENAME.
Makes buffer visit that file and marks it not modified."
  )</code></pre>
<h4 data-number="10.11.1.3" id="directory-operations-1"><span class="header-section-number">10.11.1.3</span> Directory Operations</h4>
<pre class="elisp"><code>(defun directory-files (directory &amp;optional full match nosort count)
  ;; C implementation in dired.c
  )

(defun directory-files-and-attributes (directory &amp;optional full match nosort id-format count)
  ;; Returns file list with attributes
  )</code></pre>
<h3 data-number="10.11.2" id="coding-system-functions"><span class="header-section-number">10.11.2</span> Coding System
Functions</h3>
<p>From <code>/home/user/emacs/lisp/international/mule.el</code>:</p>
<pre class="elisp"><code>(defun define-charset (name docstring &amp;rest props)
  "Define NAME (symbol) as a charset with DOCSTRING.
Properties:
  :dimension        - Number of bytes per character
  :code-space       - Valid byte ranges
  :min-code, :max-code - Code point range
  :iso-final-char   - ISO-2022 final character
  :emacs-mule-id    - ID in emacs-mule encoding
  :code-offset      - Base offset for code points
  :map              - Mapping table file
  :subset, :superset - Inheritance relationships"
  )

(defun detect-coding-region (start end &amp;optional highest)
  "Detect coding system of the text in the region between START and END.
Return a list of possible coding systems ordered by priority."
  ;; C implementation in coding.c
  )

(defun decode-coding-region (start end coding-system &amp;optional destination)
  "Decode the current region from CODING-SYSTEM.
Decodes the text between START and END."
  ;; C implementation in coding.c
  )

(defun encode-coding-region (start end coding-system &amp;optional destination)
  "Encode the current region to CODING-SYSTEM."
  ;; C implementation in coding.c
  )</code></pre>
<h3 data-number="10.11.3" id="important-variables"><span class="header-section-number">10.11.3</span> Important Variables</h3>
<pre class="elisp"><code>;; File coding
buffer-file-coding-system         ; Coding system for current buffer
file-coding-system-alist          ; Filename patterns ‚Üí coding systems
auto-coding-alist                 ; File patterns for auto-detection
auto-coding-functions             ; Functions to determine coding
coding-system-for-read            ; Override for next read
coding-system-for-write           ; Override for next write
last-coding-system-used           ; What was actually used

;; File backups
make-backup-files                 ; Enable backups
backup-by-copying                 ; Copy vs rename
backup-directory-alist            ; Where to put backups
kept-new-versions                 ; Number of newest to keep
kept-old-versions                 ; Number of oldest to keep
delete-old-versions               ; Auto-delete excess versions
version-control                   ; nil, never, t (numbered)

;; Auto-save
auto-save-default                 ; Enable auto-save for new buffers
auto-save-interval                ; Events between auto-saves
auto-save-timeout                 ; Idle seconds before auto-save
auto-save-list-file-prefix        ; Where to record auto-saves</code></pre>
<h3 data-number="10.11.4" id="hooks"><span class="header-section-number">10.11.4</span> Hooks</h3>
<pre class="elisp"><code>;; File finding
find-file-hook                    ; After file found
find-file-not-found-functions     ; When file doesn't exist
after-find-file                   ; After find-file completes

;; File saving
before-save-hook                  ; Before saving
after-save-hook                   ; After saving
write-file-functions              ; Override save mechanism
write-contents-functions          ; Alternative save functions

;; Encoding
auto-coding-functions             ; Determine coding system</code></pre>
<hr/>
<h2 data-number="10.12" id="implementation-deep-dives"><span class="header-section-number">10.12</span> Implementation Deep
Dives</h2>
<h3 data-number="10.12.1" id="utf-8-detection-and-decoding"><span class="header-section-number">10.12.1</span> UTF-8 Detection and
Decoding</h3>
<p>From <code>/home/user/emacs/src/coding.c:1131-1199</code>:</p>
<div class="sourceCode" id="cb286"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb286-1"><a aria-hidden="true" href="#cb286-1" tabindex="-1"></a><span class="dt">static</span> <span class="dt">bool</span></span>
<span id="cb286-2"><a aria-hidden="true" href="#cb286-2" tabindex="-1"></a>detect_coding_utf_8 <span class="op">(</span><span class="kw">struct</span> coding_system <span class="op">*</span>coding<span class="op">,</span></span>
<span id="cb286-3"><a aria-hidden="true" href="#cb286-3" tabindex="-1"></a>             <span class="kw">struct</span> coding_detection_info <span class="op">*</span>detect_info<span class="op">)</span></span>
<span id="cb286-4"><a aria-hidden="true" href="#cb286-4" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb286-5"><a aria-hidden="true" href="#cb286-5" tabindex="-1"></a>  <span class="dt">const</span> <span class="dt">unsigned</span> <span class="dt">char</span> <span class="op">*</span>src <span class="op">=</span> coding<span class="op">-&gt;</span>source<span class="op">,</span> <span class="op">*</span>src_base<span class="op">;</span></span>
<span id="cb286-6"><a aria-hidden="true" href="#cb286-6" tabindex="-1"></a>  <span class="dt">const</span> <span class="dt">unsigned</span> <span class="dt">char</span> <span class="op">*</span>src_end <span class="op">=</span> coding<span class="op">-&gt;</span>source <span class="op">+</span> coding<span class="op">-&gt;</span>src_bytes<span class="op">;</span></span>
<span id="cb286-7"><a aria-hidden="true" href="#cb286-7" tabindex="-1"></a>  <span class="dt">bool</span> multibytep <span class="op">=</span> coding<span class="op">-&gt;</span>src_multibyte<span class="op">;</span></span>
<span id="cb286-8"><a aria-hidden="true" href="#cb286-8" tabindex="-1"></a>  <span class="dt">ptrdiff_t</span> consumed_chars <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb286-9"><a aria-hidden="true" href="#cb286-9" tabindex="-1"></a>  <span class="dt">bool</span> bom_found <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb286-10"><a aria-hidden="true" href="#cb286-10" tabindex="-1"></a>  <span class="dt">ptrdiff_t</span> nchars <span class="op">=</span> coding<span class="op">-&gt;</span>head_ascii<span class="op">;</span></span>
<span id="cb286-11"><a aria-hidden="true" href="#cb286-11" tabindex="-1"></a></span>
<span id="cb286-12"><a aria-hidden="true" href="#cb286-12" tabindex="-1"></a>  detect_info<span class="op">-&gt;</span>checked <span class="op">|=</span> CATEGORY_MASK_UTF_8<span class="op">;</span></span>
<span id="cb286-13"><a aria-hidden="true" href="#cb286-13" tabindex="-1"></a>  <span class="co">/* A coding system of this category is always ASCII compatible.  */</span></span>
<span id="cb286-14"><a aria-hidden="true" href="#cb286-14" tabindex="-1"></a>  src <span class="op">+=</span> nchars<span class="op">;</span></span>
<span id="cb286-15"><a aria-hidden="true" href="#cb286-15" tabindex="-1"></a></span>
<span id="cb286-16"><a aria-hidden="true" href="#cb286-16" tabindex="-1"></a>  <span class="co">// Check for UTF-8 BOM</span></span>
<span id="cb286-17"><a aria-hidden="true" href="#cb286-17" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>src <span class="op">==</span> coding<span class="op">-&gt;</span>source <span class="co">/* BOM should be at the head.  */</span></span>
<span id="cb286-18"><a aria-hidden="true" href="#cb286-18" tabindex="-1"></a>      <span class="op">&amp;&amp;</span> src <span class="op">+</span> <span class="dv">3</span> <span class="op">&lt;</span> src_end  <span class="co">/* BOM is 3-byte long.  */</span></span>
<span id="cb286-19"><a aria-hidden="true" href="#cb286-19" tabindex="-1"></a>      <span class="op">&amp;&amp;</span> src<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">==</span> UTF_8_BOM_1  <span class="co">/* 0xEF */</span></span>
<span id="cb286-20"><a aria-hidden="true" href="#cb286-20" tabindex="-1"></a>      <span class="op">&amp;&amp;</span> src<span class="op">[</span><span class="dv">1</span><span class="op">]</span> <span class="op">==</span> UTF_8_BOM_2  <span class="co">/* 0xBB */</span></span>
<span id="cb286-21"><a aria-hidden="true" href="#cb286-21" tabindex="-1"></a>      <span class="op">&amp;&amp;</span> src<span class="op">[</span><span class="dv">2</span><span class="op">]</span> <span class="op">==</span> UTF_8_BOM_3<span class="op">)</span> <span class="co">/* 0xBF */</span></span>
<span id="cb286-22"><a aria-hidden="true" href="#cb286-22" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb286-23"><a aria-hidden="true" href="#cb286-23" tabindex="-1"></a>      bom_found <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb286-24"><a aria-hidden="true" href="#cb286-24" tabindex="-1"></a>      src <span class="op">+=</span> <span class="dv">3</span><span class="op">;</span></span>
<span id="cb286-25"><a aria-hidden="true" href="#cb286-25" tabindex="-1"></a>      nchars<span class="op">++;</span></span>
<span id="cb286-26"><a aria-hidden="true" href="#cb286-26" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb286-27"><a aria-hidden="true" href="#cb286-27" tabindex="-1"></a></span>
<span id="cb286-28"><a aria-hidden="true" href="#cb286-28" tabindex="-1"></a>  <span class="cf">while</span> <span class="op">(</span><span class="dv">1</span><span class="op">)</span></span>
<span id="cb286-29"><a aria-hidden="true" href="#cb286-29" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb286-30"><a aria-hidden="true" href="#cb286-30" tabindex="-1"></a>      <span class="dt">int</span> c<span class="op">,</span> c1<span class="op">,</span> c2<span class="op">,</span> c3<span class="op">,</span> c4<span class="op">;</span></span>
<span id="cb286-31"><a aria-hidden="true" href="#cb286-31" tabindex="-1"></a>      src_base <span class="op">=</span> src<span class="op">;</span></span>
<span id="cb286-32"><a aria-hidden="true" href="#cb286-32" tabindex="-1"></a>      ONE_MORE_BYTE <span class="op">(</span>c<span class="op">);</span></span>
<span id="cb286-33"><a aria-hidden="true" href="#cb286-33" tabindex="-1"></a></span>
<span id="cb286-34"><a aria-hidden="true" href="#cb286-34" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span>c <span class="op">&lt;</span> <span class="dv">0</span> <span class="op">||</span> UTF_8_1_OCTET_P <span class="op">(</span>c<span class="op">))</span>  <span class="co">// ASCII character</span></span>
<span id="cb286-35"><a aria-hidden="true" href="#cb286-35" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb286-36"><a aria-hidden="true" href="#cb286-36" tabindex="-1"></a>      nchars<span class="op">++;</span></span>
<span id="cb286-37"><a aria-hidden="true" href="#cb286-37" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span>c <span class="op">==</span> <span class="ch">'</span><span class="sc">\r</span><span class="ch">'</span><span class="op">)</span>  <span class="co">// Track EOL</span></span>
<span id="cb286-38"><a aria-hidden="true" href="#cb286-38" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb286-39"><a aria-hidden="true" href="#cb286-39" tabindex="-1"></a>          <span class="cf">if</span> <span class="op">(</span>src <span class="op">&lt;</span> src_end <span class="op">&amp;&amp;</span> <span class="op">*</span>src <span class="op">==</span> <span class="ch">'</span><span class="sc">\n</span><span class="ch">'</span><span class="op">)</span></span>
<span id="cb286-40"><a aria-hidden="true" href="#cb286-40" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb286-41"><a aria-hidden="true" href="#cb286-41" tabindex="-1"></a>          src<span class="op">++;</span></span>
<span id="cb286-42"><a aria-hidden="true" href="#cb286-42" tabindex="-1"></a>          nchars<span class="op">++;</span></span>
<span id="cb286-43"><a aria-hidden="true" href="#cb286-43" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb286-44"><a aria-hidden="true" href="#cb286-44" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb286-45"><a aria-hidden="true" href="#cb286-45" tabindex="-1"></a>      <span class="cf">continue</span><span class="op">;</span></span>
<span id="cb286-46"><a aria-hidden="true" href="#cb286-46" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb286-47"><a aria-hidden="true" href="#cb286-47" tabindex="-1"></a></span>
<span id="cb286-48"><a aria-hidden="true" href="#cb286-48" tabindex="-1"></a>      <span class="co">// Multi-byte UTF-8 sequence</span></span>
<span id="cb286-49"><a aria-hidden="true" href="#cb286-49" tabindex="-1"></a>      ONE_MORE_BYTE <span class="op">(</span>c1<span class="op">);</span></span>
<span id="cb286-50"><a aria-hidden="true" href="#cb286-50" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span>c1 <span class="op">&lt;</span> <span class="dv">0</span> <span class="op">||</span> <span class="op">!</span> UTF_8_EXTRA_OCTET_P <span class="op">(</span>c1<span class="op">))</span></span>
<span id="cb286-51"><a aria-hidden="true" href="#cb286-51" tabindex="-1"></a>    <span class="cf">break</span><span class="op">;</span>  <span class="co">// Invalid UTF-8</span></span>
<span id="cb286-52"><a aria-hidden="true" href="#cb286-52" tabindex="-1"></a></span>
<span id="cb286-53"><a aria-hidden="true" href="#cb286-53" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span>UTF_8_2_OCTET_LEADING_P <span class="op">(</span>c<span class="op">))</span></span>
<span id="cb286-54"><a aria-hidden="true" href="#cb286-54" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb286-55"><a aria-hidden="true" href="#cb286-55" tabindex="-1"></a>      nchars<span class="op">++;</span></span>
<span id="cb286-56"><a aria-hidden="true" href="#cb286-56" tabindex="-1"></a>      <span class="cf">continue</span><span class="op">;</span></span>
<span id="cb286-57"><a aria-hidden="true" href="#cb286-57" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb286-58"><a aria-hidden="true" href="#cb286-58" tabindex="-1"></a></span>
<span id="cb286-59"><a aria-hidden="true" href="#cb286-59" tabindex="-1"></a>      <span class="co">// 3-byte sequence...</span></span>
<span id="cb286-60"><a aria-hidden="true" href="#cb286-60" tabindex="-1"></a>      <span class="co">// 4-byte sequence...</span></span>
<span id="cb286-61"><a aria-hidden="true" href="#cb286-61" tabindex="-1"></a>      <span class="co">// Similar validation for longer sequences</span></span>
<span id="cb286-62"><a aria-hidden="true" href="#cb286-62" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb286-63"><a aria-hidden="true" href="#cb286-63" tabindex="-1"></a></span>
<span id="cb286-64"><a aria-hidden="true" href="#cb286-64" tabindex="-1"></a>  <span class="co">// If we found invalid UTF-8, reject this coding</span></span>
<span id="cb286-65"><a aria-hidden="true" href="#cb286-65" tabindex="-1"></a>  detect_info<span class="op">-&gt;</span>rejected <span class="op">|=</span> CATEGORY_MASK_UTF_8<span class="op">;</span></span>
<span id="cb286-66"><a aria-hidden="true" href="#cb286-66" tabindex="-1"></a>  <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb286-67"><a aria-hidden="true" href="#cb286-67" tabindex="-1"></a></span>
<span id="cb286-68"><a aria-hidden="true" href="#cb286-68" tabindex="-1"></a> no_more_source<span class="op">:</span></span>
<span id="cb286-69"><a aria-hidden="true" href="#cb286-69" tabindex="-1"></a>  <span class="co">// Successfully scanned entire file</span></span>
<span id="cb286-70"><a aria-hidden="true" href="#cb286-70" tabindex="-1"></a>  detect_info<span class="op">-&gt;</span>found <span class="op">|=</span> found<span class="op">;</span></span>
<span id="cb286-71"><a aria-hidden="true" href="#cb286-71" tabindex="-1"></a>  coding<span class="op">-&gt;</span>detected_utf8_chars <span class="op">=</span> nchars<span class="op">;</span></span>
<span id="cb286-72"><a aria-hidden="true" href="#cb286-72" tabindex="-1"></a>  coding<span class="op">-&gt;</span>detected_utf8_bytes <span class="op">=</span> src_base <span class="op">-</span> coding<span class="op">-&gt;</span>source<span class="op">;</span></span>
<span id="cb286-73"><a aria-hidden="true" href="#cb286-73" tabindex="-1"></a>  <span class="cf">return</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb286-74"><a aria-hidden="true" href="#cb286-74" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>Detection strategy</strong>: 1. Check for BOM at file start
2. Validate UTF-8 byte sequences 3. Track character count for efficiency
4. Detect EOL style simultaneously 5. Reject on first invalid
sequence</p>
<h3 data-number="10.12.2" id="iso-2022-state-machine"><span class="header-section-number">10.12.2</span> ISO-2022 State Machine</h3>
<p>ISO-2022 is one of the most complex encoding systems, requiring a
state machine to track:</p>
<ul>
<li><strong>4 character sets</strong> (G0, G1, G2, G3)</li>
<li><strong>2 graphic planes</strong> (GL, GR)</li>
<li><strong>Designation sequences</strong>: Escape sequences that load
charsets into G0-G3</li>
<li><strong>Invocation sequences</strong>: Shift codes that map G0-G3 to
GL/GR</li>
<li><strong>Single-shift</strong>: Temporary one-character
invocation</li>
</ul>
<div class="sourceCode" id="cb287"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb287-1"><a aria-hidden="true" href="#cb287-1" tabindex="-1"></a><span class="co">// State tracking</span></span>
<span id="cb287-2"><a aria-hidden="true" href="#cb287-2" tabindex="-1"></a><span class="pp">#define CODING_ISO_DESIGNATION</span><span class="op">(</span><span class="pp">coding</span><span class="op">,</span><span class="pp"> reg</span><span class="op">)</span><span class="pp">    </span><span class="op">\</span></span>
<span id="cb287-3"><a aria-hidden="true" href="#cb287-3" tabindex="-1"></a><span class="pp">  </span><span class="op">((</span><span class="pp">coding</span><span class="op">)-&gt;</span><span class="pp">spec</span><span class="op">.</span><span class="pp">iso_2022</span><span class="op">.</span><span class="pp">current_designation</span><span class="op">[</span><span class="pp">reg</span><span class="op">])</span></span>
<span id="cb287-4"><a aria-hidden="true" href="#cb287-4" tabindex="-1"></a></span>
<span id="cb287-5"><a aria-hidden="true" href="#cb287-5" tabindex="-1"></a><span class="pp">#define CODING_ISO_INVOCATION</span><span class="op">(</span><span class="pp">coding</span><span class="op">,</span><span class="pp"> plane</span><span class="op">)</span><span class="pp">   </span><span class="op">\</span></span>
<span id="cb287-6"><a aria-hidden="true" href="#cb287-6" tabindex="-1"></a><span class="pp">  </span><span class="op">((</span><span class="pp">coding</span><span class="op">)-&gt;</span><span class="pp">spec</span><span class="op">.</span><span class="pp">iso_2022</span><span class="op">.</span><span class="pp">current_invocation</span><span class="op">[</span><span class="pp">plane</span><span class="op">])</span></span>
<span id="cb287-7"><a aria-hidden="true" href="#cb287-7" tabindex="-1"></a></span>
<span id="cb287-8"><a aria-hidden="true" href="#cb287-8" tabindex="-1"></a><span class="co">// Example designation sequence:</span></span>
<span id="cb287-9"><a aria-hidden="true" href="#cb287-9" tabindex="-1"></a><span class="co">// ESC $ B  ‚Üí Designate JISX0208 to G0</span></span>
<span id="cb287-10"><a aria-hidden="true" href="#cb287-10" tabindex="-1"></a><span class="co">// ESC ( B  ‚Üí Designate ASCII to G0</span></span>
<span id="cb287-11"><a aria-hidden="true" href="#cb287-11" tabindex="-1"></a><span class="co">// ESC ) I  ‚Üí Designate JISX0201-KANA to G1</span></span></code></pre></div>
<p>This complexity is why ISO-2022 code is so large and why modern
systems prefer UTF-8.</p>
<h3 data-number="10.12.3" id="file-name-expansion"><span class="header-section-number">10.12.3</span> File Name Expansion</h3>
<p>File name expansion is complex due to: 1. Platform differences (Unix
vs Windows vs Android) 2. Remote file access (TRAMP) 3. Symbolic links
4. Tilde expansion 5. Environment variables 6. Relative path
resolution</p>
<p>From <code>/home/user/emacs/src/fileio.c:992</code>:</p>
<div class="sourceCode" id="cb288"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb288-1"><a aria-hidden="true" href="#cb288-1" tabindex="-1"></a>DEFUN <span class="op">(</span><span class="st">"expand-file-name"</span><span class="op">,</span> Fexpand_file_name<span class="op">,</span> Sexpand_file_name<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb288-2"><a aria-hidden="true" href="#cb288-2" tabindex="-1"></a>       doc<span class="op">:</span> <span class="co">/* Convert filename NAME to absolute, and canonicalize it.</span></span>
<span id="cb288-3"><a aria-hidden="true" href="#cb288-3" tabindex="-1"></a><span class="co">Second arg DEFAULT-DIRECTORY is directory to start with if NAME is relative</span></span>
<span id="cb288-4"><a aria-hidden="true" href="#cb288-4" tabindex="-1"></a><span class="co">\(does not start with slash or tilde); both the directory name and</span></span>
<span id="cb288-5"><a aria-hidden="true" href="#cb288-5" tabindex="-1"></a><span class="co">a directory's file name are accepted.  If DEFAULT-DIRECTORY is nil or</span></span>
<span id="cb288-6"><a aria-hidden="true" href="#cb288-6" tabindex="-1"></a><span class="co">missing, the current buffer's value of `default-directory' is used.</span></span>
<span id="cb288-7"><a aria-hidden="true" href="#cb288-7" tabindex="-1"></a><span class="co">File name components that are `.' are removed, and so are file name</span></span>
<span id="cb288-8"><a aria-hidden="true" href="#cb288-8" tabindex="-1"></a><span class="co">components followed by `..', along with the `..' itself; note that</span></span>
<span id="cb288-9"><a aria-hidden="true" href="#cb288-9" tabindex="-1"></a><span class="co">these simplifications are done without checking the resulting file</span></span>
<span id="cb288-10"><a aria-hidden="true" href="#cb288-10" tabindex="-1"></a><span class="co">names in the file system.  Multiple consecutive slashes are collapsed</span></span>
<span id="cb288-11"><a aria-hidden="true" href="#cb288-11" tabindex="-1"></a><span class="co">into a single slash, except at the beginning of the file name when</span></span>
<span id="cb288-12"><a aria-hidden="true" href="#cb288-12" tabindex="-1"></a><span class="co">they are significant (e.g., UNC file names on MS-Windows.)</span></span>
<span id="cb288-13"><a aria-hidden="true" href="#cb288-13" tabindex="-1"></a><span class="co">An initial `~/' expands to your home directory.</span></span>
<span id="cb288-14"><a aria-hidden="true" href="#cb288-14" tabindex="-1"></a><span class="co">An initial `~USER/' expands to USER's home directory.</span></span>
<span id="cb288-15"><a aria-hidden="true" href="#cb288-15" tabindex="-1"></a><span class="co">See also the function `substitute-in-file-name'. */</span><span class="op">)</span></span></code></pre></div>
<p>The implementation handles: - <code>~</code> ‚Üí home directory -
<code>~/</code> ‚Üí current user‚Äôs home - <code>~user/</code> ‚Üí specific
user‚Äôs home - <code>.</code> removal - <code>..</code> resolution -
Multiple slash collapsing - UNC path preservation (Windows) - Drive
letters (DOS/Windows)</p>
<hr/>
<h2 data-number="10.13" id="performance-characteristics-1"><span class="header-section-number">10.13</span> Performance
Characteristics</h2>
<h3 data-number="10.13.1" id="read-performance"><span class="header-section-number">10.13.1</span> Read Performance</h3>
<table>
<thead>
<tr>
<th>Operation</th>
<th>Time Complexity</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td>File open</td>
<td>O(1)</td>
<td>System call</td>
</tr>
<tr>
<td>Coding detection</td>
<td>O(n)</td>
<td>Scans file prefix</td>
</tr>
<tr>
<td>UTF-8 decode</td>
<td>O(n)</td>
<td>Linear scan</td>
</tr>
<tr>
<td>ISO-2022 decode</td>
<td>O(n √ó s)</td>
<td>State machine transitions</td>
</tr>
<tr>
<td>Buffer insertion</td>
<td>O(m)</td>
<td>Move gap, m = insertion point</td>
</tr>
</tbody>
</table>
<h3 data-number="10.13.2" id="write-performance"><span class="header-section-number">10.13.2</span> Write Performance</h3>
<table>
<thead>
<tr>
<th>Operation</th>
<th>Time Complexity</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td>Backup creation</td>
<td>O(n)</td>
<td>Copy or rename</td>
</tr>
<tr>
<td>Encoding</td>
<td>O(n)</td>
<td>Linear</td>
</tr>
<tr>
<td>Temp file write</td>
<td>O(n)</td>
<td>Linear</td>
</tr>
<tr>
<td>fsync</td>
<td>Variable</td>
<td>Depends on disk cache</td>
</tr>
<tr>
<td>Atomic rename</td>
<td>O(1)</td>
<td>Filesystem operation</td>
</tr>
</tbody>
</table>
<h3 data-number="10.13.3" id="memory-usage-1"><span class="header-section-number">10.13.3</span> Memory Usage</h3>
<pre><code>Reading a file of size N bytes:

Minimum:
  - Read buffer: 1 MiB
  - Charbuf: ~256 KB (for decoding)
  - Buffer gap: ~2N (worst case for multibyte)
  Total: ~2N + 1.25 MB

Maximum (many multibyte chars):
  - Read buffer: 1 MiB
  - Charbuf: ~1 MB (worst case)
  - Buffer: up to 4N (max expansion: 1 byte ‚Üí 4 bytes UTF-8)
  - Gap: 2N
  Total: ~6N + 2 MB</code></pre>
<h3 data-number="10.13.4" id="optimization-strategies"><span class="header-section-number">10.13.4</span> Optimization
Strategies</h3>
<ol type="1">
<li><strong>ASCII Fast Path</strong>:
<ul>
<li>Most files are ASCII-compatible</li>
<li>Skip decoding for ASCII prefix</li>
<li><code>head_ascii</code> tracks how far we can skip</li>
</ul></li>
<li><strong>Detection Caching</strong>:
<ul>
<li>Once coding detected, skip re-detection</li>
<li>Cache in <code>buffer-file-coding-system</code></li>
</ul></li>
<li><strong>Gap Buffer Reuse</strong>:
<ul>
<li>Insert at gap to avoid moving text</li>
<li>REPLACE mode reuses existing buffer space</li>
</ul></li>
<li><strong>Lazy EOL Conversion</strong>:
<ul>
<li>If file is all LF, no conversion needed</li>
<li>Detected during initial scan</li>
</ul></li>
</ol>
<hr/>
<h2 data-number="10.14" id="security-considerations"><span class="header-section-number">10.14</span> Security Considerations</h2>
<h3 data-number="10.14.1" id="path-traversal-prevention"><span class="header-section-number">10.14.1</span> Path Traversal
Prevention</h3>
<div class="sourceCode" id="cb290"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb290-1"><a aria-hidden="true" href="#cb290-1" tabindex="-1"></a><span class="co">// Emacs validates file paths to prevent:</span></span>
<span id="cb290-2"><a aria-hidden="true" href="#cb290-2" tabindex="-1"></a><span class="co">// - Directory traversal (../..)</span></span>
<span id="cb290-3"><a aria-hidden="true" href="#cb290-3" tabindex="-1"></a><span class="co">// - Symlink attacks</span></span>
<span id="cb290-4"><a aria-hidden="true" href="#cb290-4" tabindex="-1"></a><span class="co">// - Access outside allowed directories</span></span></code></pre></div>
<h3 data-number="10.14.2" id="file-lock-race-conditions"><span class="header-section-number">10.14.2</span> File Lock Race
Conditions</h3>
<p>The file locking mechanism prevents: 1.
<strong>Double-write</strong>: Two Emacs instances modifying same file
2. <strong>Lost updates</strong>: Second write overwrites first 3.
<strong>Stale locks</strong>: Boot time detection identifies stale
locks</p>
<h3 data-number="10.14.3" id="encoding-security"><span class="header-section-number">10.14.3</span> Encoding Security</h3>
<ol type="1">
<li><strong>Invalid UTF-8</strong>: Treated as raw bytes, not error</li>
<li><strong>BOM injection</strong>: BOM only recognized at file
start</li>
<li><strong>Null byte handling</strong>: Special detection to avoid
encoding issues</li>
<li><strong>Overlong sequences</strong>: UTF-8 decoder rejects overlong
encodings</li>
</ol>
<h3 data-number="10.14.4" id="temporary-file-security"><span class="header-section-number">10.14.4</span> Temporary File
Security</h3>
<div class="sourceCode" id="cb291"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb291-1"><a aria-hidden="true" href="#cb291-1" tabindex="-1"></a><span class="co">// Temporary files created with:</span></span>
<span id="cb291-2"><a aria-hidden="true" href="#cb291-2" tabindex="-1"></a><span class="co">// - O_EXCL: Fail if file exists (prevents symlink attacks)</span></span>
<span id="cb291-3"><a aria-hidden="true" href="#cb291-3" tabindex="-1"></a><span class="co">// - O_CREAT: Atomic creation</span></span>
<span id="cb291-4"><a aria-hidden="true" href="#cb291-4" tabindex="-1"></a><span class="co">// - Restrictive permissions (0600)</span></span>
<span id="cb291-5"><a aria-hidden="true" href="#cb291-5" tabindex="-1"></a><span class="co">// - Random component in name</span></span></code></pre></div>
<hr/>
<h2 data-number="10.15" id="testing-and-validation"><span class="header-section-number">10.15</span> Testing and Validation</h2>
<h3 data-number="10.15.1" id="coding-system-test-coverage"><span class="header-section-number">10.15.1</span> Coding System Test
Coverage</h3>
<p>Emacs includes extensive tests for: - All major coding systems
(UTF-8, UTF-16, ISO-2022, Shift-JIS, Big5, etc.) - EOL conversion (LF,
CRLF, CR) - BOM handling - Encoding detection - Round-trip conversion
(encode ‚Üí decode = identity) - Edge cases (partial sequences, invalid
bytes, etc.)</p>
<h3 data-number="10.15.2" id="file-io-test-coverage"><span class="header-section-number">10.15.2</span> File I/O Test Coverage</h3>
<ul>
<li>Large files (&gt; 2 GB)</li>
<li>Empty files</li>
<li>Files with no final newline</li>
<li>Read-only files</li>
<li>Special files (/dev/null, /dev/urandom)</li>
<li>Remote files (TRAMP)</li>
<li>Archives (tar, zip)</li>
<li>Symbolic links</li>
<li>Hard links</li>
<li>Named pipes (FIFOs)</li>
</ul>
<hr/>
<h2 data-number="10.16" id="related-subsystems"><span class="header-section-number">10.16</span> Related Subsystems</h2>
<h3 data-number="10.16.1" id="buffer-management"><span class="header-section-number">10.16.1</span> Buffer Management</h3>
<ul>
<li><strong>Buffer gap</strong>: Efficient insertion/deletion</li>
<li><strong>Multibyte representation</strong>: Internal character
encoding</li>
<li><strong>Markers</strong>: Position tracking across
modifications</li>
</ul>
<h3 data-number="10.16.2" id="display-engine"><span class="header-section-number">10.16.2</span> Display Engine</h3>
<ul>
<li><strong>Character width</strong>: Unicode width properties</li>
<li><strong>Composition</strong>: Combining characters for display</li>
<li><strong>Font selection</strong>: Based on charset</li>
</ul>
<h3 data-number="10.16.3" id="process-io"><span class="header-section-number">10.16.3</span> Process I/O</h3>
<ul>
<li><strong>Encoding pipes</strong>: stdin/stdout encoding for
subprocesses</li>
<li><strong>PTY encoding</strong>: Terminal encoding for interactive
processes</li>
<li><strong>Network encoding</strong>: Socket I/O encoding</li>
</ul>
<hr/>
<h2 data-number="10.17" id="historical-notes"><span class="header-section-number">10.17</span> Historical Notes</h2>
<h3 data-number="10.17.1" id="evolution-of-internal-encoding"><span class="header-section-number">10.17.1</span> Evolution of Internal
Encoding</h3>
<ol type="1">
<li><strong>Emacs 19</strong>: Mixed multibyte (emacs-mule)</li>
<li><strong>Emacs 20-21</strong>: Mule-UCS (partial Unicode)</li>
<li><strong>Emacs 22+</strong>: Full Unicode support</li>
<li><strong>Emacs 23+</strong>: UTF-8 based internal representation</li>
</ol>
<h3 data-number="10.17.2" id="why-not-pure-utf-8"><span class="header-section-number">10.17.2</span> Why Not Pure UTF-8?</h3>
<p>Emacs‚Äô internal representation is ‚ÄúUTF-8 based‚Äù but not pure UTF-8
because:</p>
<ol type="1">
<li><strong>Eight-bit bytes</strong>: Raw bytes (128-255) represented as
special characters</li>
<li><strong>Unibyte buffers</strong>: Some buffers remain unibyte for
efficiency</li>
<li><strong>Composition</strong>: Complex character composition
metadata</li>
<li><strong>Charset information</strong>: Preserved for round-trip
conversion</li>
</ol>
<h3 data-number="10.17.3" id="backward-compatibility"><span class="header-section-number">10.17.3</span> Backward Compatibility</h3>
<p>Emacs maintains compatibility with: - Old Mule encodings (emacs-mule)
- Legacy Japanese encodings (iso-2022-jp variants) - Platform-specific
encodings (cp1252, shift-jis, etc.) - Ancient systems (no Unicode
support)</p>
<p>This accounts for much of coding.c‚Äôs size and complexity.</p>
<hr/>
<h2 data-number="10.18" id="conclusion-2"><span class="header-section-number">10.18</span> Conclusion</h2>
<p>The file I/O and character encoding system is one of Emacs‚Äô most
mature and battle-tested subsystems. Its design reflects decades of
evolution handling:</p>
<ul>
<li><strong>Dozens of character encodings</strong> from around the
world</li>
<li><strong>Multiple operating systems</strong> with different file
semantics</li>
<li><strong>Billions of files</strong> in every encoding imaginable</li>
<li><strong>Mission-critical data</strong> that must not be
corrupted</li>
</ul>
<p>The key architectural principles are:</p>
<ol type="1">
<li><strong>Robustness</strong>: Never lose user data</li>
<li><strong>Flexibility</strong>: Support any encoding via CCL</li>
<li><strong>Performance</strong>: Optimize common cases (ASCII,
UTF-8)</li>
<li><strong>Compatibility</strong>: Handle legacy formats correctly</li>
<li><strong>Safety</strong>: Atomic operations, file locking, crash
recovery</li>
</ol>
<p>Understanding this subsystem provides insight into how Emacs
maintains its reputation for reliability and internationalization
support.</p>
<hr/>
<h2 data-number="10.19" id="further-reading-4"><span class="header-section-number">10.19</span> Further Reading</h2>
<h3 data-number="10.19.1" id="source-code-entry-points"><span class="header-section-number">10.19.1</span> Source Code Entry
Points</h3>
<ul>
<li>File I/O: <code>/home/user/emacs/src/fileio.c:4055</code>
(insert-file-contents)</li>
<li>Encoding: <code>/home/user/emacs/src/coding.c:5666</code>
(setup_coding_system)</li>
<li>Charsets: <code>/home/user/emacs/src/charset.c:43</code> (charset
overview)</li>
<li>CCL: <code>/home/user/emacs/src/ccl.c:50</code> (CCL overview)</li>
<li>Elisp: <code>/home/user/emacs/lisp/files.el:5356</code>
(backup-buffer)</li>
</ul>
<h3 data-number="10.19.2" id="documentation"><span class="header-section-number">10.19.2</span> Documentation</h3>
<ul>
<li>Info node: <code>(elisp) Files</code></li>
<li>Info node: <code>(elisp) Coding Systems</code></li>
<li>Info node: <code>(emacs) International</code></li>
<li>Source: <code>src/coding.c:0</code> (extensive comments)</li>
</ul>
<h3 data-number="10.19.3" id="related-subsystems-1"><span class="header-section-number">10.19.3</span> Related Subsystems</h3>
<ul>
<li><a href="./01-buffer-management.md">Buffer Management</a></li>
<li><a href="./02-display-engine.md">Display Engine</a></li>
<li>Process I/O (not yet documented)</li>
<li>Network I/O (not yet documented)</li>
</ul>
<h1 data-number="11" id="emacs-lisp-interpreter-core"><span class="header-section-number">11</span> Emacs Lisp Interpreter Core</h1>
<p><strong>A Literate Programming Guide to the Emacs Lisp
Runtime</strong></p>
<p>This document provides an in-depth exploration of the Emacs Lisp
interpreter‚Äôs core implementation, tracing how Lisp expressions are
read, evaluated, and executed through three different execution models:
interpreted code, bytecode, and native compilation.</p>
<hr/>
<h2 data-number="11.1" id="table-of-contents-5"><span class="header-section-number">11.1</span> Table of Contents</h2>
<ol type="1">
<li><a href="#1-fundamental-data-structures">Fundamental Data
Structures</a></li>
<li><a href="#2-the-lisp-object-system">The Lisp Object System</a></li>
<li><a href="#3-reading-lisp-code">Reading Lisp Code</a></li>
<li><a href="#4-the-evaluation-engine">The Evaluation Engine</a></li>
<li><a href="#5-function-application">Function Application</a></li>
<li><a href="#6-bytecode-execution">Bytecode Execution</a></li>
<li><a href="#7-native-compilation">Native Compilation</a></li>
<li><a href="#8-scoping-and-closures">Scoping and Closures</a></li>
<li><a href="#9-special-forms-and-macros">Special Forms and
Macros</a></li>
<li><a href="#10-design-tradeoffs">Design Tradeoffs</a></li>
</ol>
<hr/>
<h2 data-number="11.2" id="fundamental-data-structures"><span class="header-section-number">11.2</span> 1. Fundamental Data
Structures</h2>
<h3 data-number="11.2.1" id="lisp_object-the-universal-type"><span class="header-section-number">11.2.1</span> 1.1 Lisp_Object: The
Universal Type</h3>
<p>At the heart of Emacs Lisp is <code>Lisp_Object</code>, a tagged
pointer that can represent any Lisp value. This is the fundamental type
that flows through the entire interpreter.</p>
<p><strong>Location</strong>:
<code>/home/user/emacs/src/lisp.h:602-611</code></p>
<div class="sourceCode" id="cb292"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb292-1"><a aria-hidden="true" href="#cb292-1" tabindex="-1"></a><span class="pp">#ifdef CHECK_LISP_OBJECT_TYPE</span></span>
<span id="cb292-2"><a aria-hidden="true" href="#cb292-2" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> Lisp_Object <span class="op">{</span> Lisp_Word i<span class="op">;</span> <span class="op">}</span> Lisp_Object<span class="op">;</span></span>
<span id="cb292-3"><a aria-hidden="true" href="#cb292-3" tabindex="-1"></a><span class="pp"># define LISP_OBJECT_IS_STRUCT</span></span>
<span id="cb292-4"><a aria-hidden="true" href="#cb292-4" tabindex="-1"></a><span class="pp"># define LISP_INITIALLY</span><span class="op">(</span><span class="pp">w</span><span class="op">)</span><span class="pp"> </span><span class="op">{</span><span class="pp">w</span><span class="op">}</span></span>
<span id="cb292-5"><a aria-hidden="true" href="#cb292-5" tabindex="-1"></a><span class="pp">#else</span></span>
<span id="cb292-6"><a aria-hidden="true" href="#cb292-6" tabindex="-1"></a><span class="kw">typedef</span> Lisp_Word Lisp_Object<span class="op">;</span></span>
<span id="cb292-7"><a aria-hidden="true" href="#cb292-7" tabindex="-1"></a><span class="pp"># define LISP_INITIALLY</span><span class="op">(</span><span class="pp">w</span><span class="op">)</span><span class="pp"> </span><span class="op">(</span><span class="pp">w</span><span class="op">)</span></span>
<span id="cb292-8"><a aria-hidden="true" href="#cb292-8" tabindex="-1"></a><span class="pp">#endif</span></span></code></pre></div>
<p><strong>Key Insight</strong>: <code>Lisp_Object</code> is either a
bare integer (<code>Lisp_Word</code>) or a struct wrapping it (when type
checking is enabled). This allows maximum performance in production
while enabling type safety during development.</p>
<h3 data-number="11.2.2" id="tagged-pointer-architecture"><span class="header-section-number">11.2.2</span> 1.2 Tagged Pointer
Architecture</h3>
<p>Emacs uses a sophisticated tagging scheme to encode type information
in the low bits of pointers. With 8-byte alignment on modern systems,
the bottom 3 bits are always zero in valid pointers, allowing us to
store type tags there.</p>
<p><strong>Location</strong>:
<code>/home/user/emacs/src/lisp.h:499-536</code></p>
<div class="sourceCode" id="cb293"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb293-1"><a aria-hidden="true" href="#cb293-1" tabindex="-1"></a><span class="co">/* Lisp_Object tagging scheme:</span></span>
<span id="cb293-2"><a aria-hidden="true" href="#cb293-2" tabindex="-1"></a><span class="co">        Tag location</span></span>
<span id="cb293-3"><a aria-hidden="true" href="#cb293-3" tabindex="-1"></a><span class="co">   Upper bits  Lower bits  Type        Payload</span></span>
<span id="cb293-4"><a aria-hidden="true" href="#cb293-4" tabindex="-1"></a><span class="co">   000.......  .......000  symbol      offset from lispsym to struct Lisp_Symbol</span></span>
<span id="cb293-5"><a aria-hidden="true" href="#cb293-5" tabindex="-1"></a><span class="co">   001.......  .......001  unused</span></span>
<span id="cb293-6"><a aria-hidden="true" href="#cb293-6" tabindex="-1"></a><span class="co">   01........  ........10  fixnum      signed integer of FIXNUM_BITS</span></span>
<span id="cb293-7"><a aria-hidden="true" href="#cb293-7" tabindex="-1"></a><span class="co">   110.......  .......011  cons        pointer to struct Lisp_Cons</span></span>
<span id="cb293-8"><a aria-hidden="true" href="#cb293-8" tabindex="-1"></a><span class="co">   100.......  .......100  string      pointer to struct Lisp_String</span></span>
<span id="cb293-9"><a aria-hidden="true" href="#cb293-9" tabindex="-1"></a><span class="co">   101.......  .......101  vectorlike  pointer to union vectorlike_header</span></span>
<span id="cb293-10"><a aria-hidden="true" href="#cb293-10" tabindex="-1"></a><span class="co">   111.......  .......111  float       pointer to struct Lisp_Float  */</span></span>
<span id="cb293-11"><a aria-hidden="true" href="#cb293-11" tabindex="-1"></a></span>
<span id="cb293-12"><a aria-hidden="true" href="#cb293-12" tabindex="-1"></a><span class="kw">enum</span> Lisp_Type</span>
<span id="cb293-13"><a aria-hidden="true" href="#cb293-13" tabindex="-1"></a>  <span class="op">{</span></span>
<span id="cb293-14"><a aria-hidden="true" href="#cb293-14" tabindex="-1"></a>    Lisp_Symbol <span class="op">=</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb293-15"><a aria-hidden="true" href="#cb293-15" tabindex="-1"></a>    Lisp_Type_Unused0 <span class="op">=</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb293-16"><a aria-hidden="true" href="#cb293-16" tabindex="-1"></a>    Lisp_Int0 <span class="op">=</span> <span class="dv">2</span><span class="op">,</span></span>
<span id="cb293-17"><a aria-hidden="true" href="#cb293-17" tabindex="-1"></a>    Lisp_Int1 <span class="op">=</span> USE_LSB_TAG <span class="op">?</span> <span class="dv">6</span> <span class="op">:</span> <span class="dv">3</span><span class="op">,</span></span>
<span id="cb293-18"><a aria-hidden="true" href="#cb293-18" tabindex="-1"></a>    Lisp_String <span class="op">=</span> <span class="dv">4</span><span class="op">,</span></span>
<span id="cb293-19"><a aria-hidden="true" href="#cb293-19" tabindex="-1"></a>    Lisp_Vectorlike <span class="op">=</span> <span class="dv">5</span><span class="op">,</span></span>
<span id="cb293-20"><a aria-hidden="true" href="#cb293-20" tabindex="-1"></a>    Lisp_Cons <span class="op">=</span> USE_LSB_TAG <span class="op">?</span> <span class="dv">3</span> <span class="op">:</span> <span class="dv">6</span><span class="op">,</span></span>
<span id="cb293-21"><a aria-hidden="true" href="#cb293-21" tabindex="-1"></a>    Lisp_Float <span class="op">=</span> <span class="dv">7</span></span>
<span id="cb293-22"><a aria-hidden="true" href="#cb293-22" tabindex="-1"></a>  <span class="op">};</span></span></code></pre></div>
<p><strong>Design Tradeoff</strong>: This scheme gives us: -
<strong>Fast type checking</strong>: Just mask and compare bits -
<strong>Immediate integers</strong>: Small integers don‚Äôt require heap
allocation - <strong>Compact representation</strong>: No space overhead
for type tags</p>
<p>The cost is that we lose 3 bits of address space (or integer range),
but on 64-bit systems this is negligible.</p>
<h3 data-number="11.2.3" id="the-symbol-structure"><span class="header-section-number">11.2.3</span> 1.3 The Symbol
Structure</h3>
<p>Symbols are fundamental to Lisp. They serve as variable names,
function names, and keys in property lists.</p>
<p><strong>Location</strong>:
<code>/home/user/emacs/src/lisp.h:797-840</code></p>
<div class="sourceCode" id="cb294"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb294-1"><a aria-hidden="true" href="#cb294-1" tabindex="-1"></a><span class="kw">struct</span> Lisp_Symbol</span>
<span id="cb294-2"><a aria-hidden="true" href="#cb294-2" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb294-3"><a aria-hidden="true" href="#cb294-3" tabindex="-1"></a>  <span class="kw">union</span></span>
<span id="cb294-4"><a aria-hidden="true" href="#cb294-4" tabindex="-1"></a>  <span class="op">{</span></span>
<span id="cb294-5"><a aria-hidden="true" href="#cb294-5" tabindex="-1"></a>    <span class="kw">struct</span></span>
<span id="cb294-6"><a aria-hidden="true" href="#cb294-6" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb294-7"><a aria-hidden="true" href="#cb294-7" tabindex="-1"></a>      bool_bf gcmarkbit <span class="op">:</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb294-8"><a aria-hidden="true" href="#cb294-8" tabindex="-1"></a></span>
<span id="cb294-9"><a aria-hidden="true" href="#cb294-9" tabindex="-1"></a>      <span class="co">/* Indicates where the value can be found.  */</span></span>
<span id="cb294-10"><a aria-hidden="true" href="#cb294-10" tabindex="-1"></a>      ENUM_BF <span class="op">(</span>symbol_redirect<span class="op">)</span> redirect <span class="op">:</span> <span class="dv">2</span><span class="op">;</span></span>
<span id="cb294-11"><a aria-hidden="true" href="#cb294-11" tabindex="-1"></a></span>
<span id="cb294-12"><a aria-hidden="true" href="#cb294-12" tabindex="-1"></a>      ENUM_BF <span class="op">(</span>symbol_trapped_write<span class="op">)</span> trapped_write <span class="op">:</span> <span class="dv">2</span><span class="op">;</span></span>
<span id="cb294-13"><a aria-hidden="true" href="#cb294-13" tabindex="-1"></a></span>
<span id="cb294-14"><a aria-hidden="true" href="#cb294-14" tabindex="-1"></a>      <span class="co">/* Interned state of the symbol.  */</span></span>
<span id="cb294-15"><a aria-hidden="true" href="#cb294-15" tabindex="-1"></a>      ENUM_BF <span class="op">(</span>symbol_interned<span class="op">)</span> interned <span class="op">:</span> <span class="dv">2</span><span class="op">;</span></span>
<span id="cb294-16"><a aria-hidden="true" href="#cb294-16" tabindex="-1"></a></span>
<span id="cb294-17"><a aria-hidden="true" href="#cb294-17" tabindex="-1"></a>      <span class="co">/* True means that this variable has been explicitly declared</span></span>
<span id="cb294-18"><a aria-hidden="true" href="#cb294-18" tabindex="-1"></a><span class="co">         special (with `defvar' etc), and shouldn't be lexically bound.  */</span></span>
<span id="cb294-19"><a aria-hidden="true" href="#cb294-19" tabindex="-1"></a>      bool_bf declared_special <span class="op">:</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb294-20"><a aria-hidden="true" href="#cb294-20" tabindex="-1"></a></span>
<span id="cb294-21"><a aria-hidden="true" href="#cb294-21" tabindex="-1"></a>      <span class="co">/* The symbol's name, as a Lisp string.  */</span></span>
<span id="cb294-22"><a aria-hidden="true" href="#cb294-22" tabindex="-1"></a>      Lisp_Object name<span class="op">;</span></span>
<span id="cb294-23"><a aria-hidden="true" href="#cb294-23" tabindex="-1"></a></span>
<span id="cb294-24"><a aria-hidden="true" href="#cb294-24" tabindex="-1"></a>      <span class="co">/* Value of the symbol or Qunbound if unbound.  Which alternative of the</span></span>
<span id="cb294-25"><a aria-hidden="true" href="#cb294-25" tabindex="-1"></a><span class="co">         union is used depends on the `redirect' field above.  */</span></span>
<span id="cb294-26"><a aria-hidden="true" href="#cb294-26" tabindex="-1"></a>      <span class="kw">union</span> <span class="op">{</span></span>
<span id="cb294-27"><a aria-hidden="true" href="#cb294-27" tabindex="-1"></a>        Lisp_Object value<span class="op">;</span></span>
<span id="cb294-28"><a aria-hidden="true" href="#cb294-28" tabindex="-1"></a>        <span class="kw">struct</span> Lisp_Symbol <span class="op">*</span>alias<span class="op">;</span></span>
<span id="cb294-29"><a aria-hidden="true" href="#cb294-29" tabindex="-1"></a>        <span class="kw">struct</span> Lisp_Buffer_Local_Value <span class="op">*</span>blv<span class="op">;</span></span>
<span id="cb294-30"><a aria-hidden="true" href="#cb294-30" tabindex="-1"></a>        lispfwd fwd<span class="op">;</span></span>
<span id="cb294-31"><a aria-hidden="true" href="#cb294-31" tabindex="-1"></a>      <span class="op">}</span> val<span class="op">;</span></span>
<span id="cb294-32"><a aria-hidden="true" href="#cb294-32" tabindex="-1"></a></span>
<span id="cb294-33"><a aria-hidden="true" href="#cb294-33" tabindex="-1"></a>      <span class="co">/* Function value of the symbol or Qnil if not fboundp.  */</span></span>
<span id="cb294-34"><a aria-hidden="true" href="#cb294-34" tabindex="-1"></a>      Lisp_Object function<span class="op">;</span></span>
<span id="cb294-35"><a aria-hidden="true" href="#cb294-35" tabindex="-1"></a></span>
<span id="cb294-36"><a aria-hidden="true" href="#cb294-36" tabindex="-1"></a>      <span class="co">/* The symbol's property list.  */</span></span>
<span id="cb294-37"><a aria-hidden="true" href="#cb294-37" tabindex="-1"></a>      Lisp_Object plist<span class="op">;</span></span>
<span id="cb294-38"><a aria-hidden="true" href="#cb294-38" tabindex="-1"></a></span>
<span id="cb294-39"><a aria-hidden="true" href="#cb294-39" tabindex="-1"></a>      <span class="co">/* Next symbol in obarray bucket, if the symbol is interned.  */</span></span>
<span id="cb294-40"><a aria-hidden="true" href="#cb294-40" tabindex="-1"></a>      <span class="kw">struct</span> Lisp_Symbol <span class="op">*</span>next<span class="op">;</span></span>
<span id="cb294-41"><a aria-hidden="true" href="#cb294-41" tabindex="-1"></a>    <span class="op">}</span> s<span class="op">;</span></span>
<span id="cb294-42"><a aria-hidden="true" href="#cb294-42" tabindex="-1"></a>    GCALIGNED_UNION_MEMBER</span>
<span id="cb294-43"><a aria-hidden="true" href="#cb294-43" tabindex="-1"></a>  <span class="op">}</span> u<span class="op">;</span></span>
<span id="cb294-44"><a aria-hidden="true" href="#cb294-44" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<p><strong>Key Features</strong>: 1. <strong>Separate
namespaces</strong>: <code>function</code> vs <code>value</code> slots
implement Lisp-2 semantics 2. <strong>Property lists</strong>:
Extensible metadata via <code>plist</code> 3. <strong>Symbol
interning</strong>: Hash table chaining via <code>next</code> 4.
<strong>Dynamic/forwarded variables</strong>: The <code>redirect</code>
field allows symbols to point to: - Regular Lisp values
(<code>SYMBOL_PLAINVAL</code>) - Other symbols (aliases via
<code>SYMBOL_VARALIAS</code>) - Buffer-local values
(<code>SYMBOL_LOCALIZED</code>) - C variables
(<code>SYMBOL_FORWARDED</code>)</p>
<hr/>
<h2 data-number="11.3" id="the-lisp-object-system"><span class="header-section-number">11.3</span> 2. The Lisp Object System</h2>
<h3 data-number="11.3.1" id="type-predicates-and-extraction"><span class="header-section-number">11.3.1</span> 2.1 Type Predicates and
Extraction</h3>
<p>The tagged pointer system enables fast type checking through bit
masking:</p>
<p><strong>Location</strong>:
<code>/home/user/emacs/src/lisp.h:399-417</code></p>
<div class="sourceCode" id="cb295"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb295-1"><a aria-hidden="true" href="#cb295-1" tabindex="-1"></a><span class="pp">#define lisp_h_CONSP</span><span class="op">(</span><span class="pp">x</span><span class="op">)</span><span class="pp"> TAGGEDP </span><span class="op">(</span><span class="pp">x</span><span class="op">,</span><span class="pp"> </span>Lisp_Cons<span class="op">)</span></span>
<span id="cb295-2"><a aria-hidden="true" href="#cb295-2" tabindex="-1"></a><span class="pp">#define lisp_h_FLOATP</span><span class="op">(</span><span class="pp">x</span><span class="op">)</span><span class="pp"> TAGGEDP </span><span class="op">(</span><span class="pp">x</span><span class="op">,</span><span class="pp"> </span>Lisp_Float<span class="op">)</span></span>
<span id="cb295-3"><a aria-hidden="true" href="#cb295-3" tabindex="-1"></a><span class="pp">#define lisp_h_NILP</span><span class="op">(</span><span class="pp">x</span><span class="op">)</span><span class="pp">  BASE_EQ </span><span class="op">(</span><span class="pp">x</span><span class="op">,</span><span class="pp"> Qnil</span><span class="op">)</span></span>
<span id="cb295-4"><a aria-hidden="true" href="#cb295-4" tabindex="-1"></a><span class="pp">#define lisp_h_BARE_SYMBOL_P</span><span class="op">(</span><span class="pp">x</span><span class="op">)</span><span class="pp"> TAGGEDP </span><span class="op">(</span><span class="pp">x</span><span class="op">,</span><span class="pp"> </span>Lisp_Symbol<span class="op">)</span></span>
<span id="cb295-5"><a aria-hidden="true" href="#cb295-5" tabindex="-1"></a></span>
<span id="cb295-6"><a aria-hidden="true" href="#cb295-6" tabindex="-1"></a><span class="pp">#define lisp_h_TAGGEDP</span><span class="op">(</span><span class="pp">a</span><span class="op">,</span><span class="pp"> tag</span><span class="op">)</span><span class="pp"> </span><span class="op">\</span></span>
<span id="cb295-7"><a aria-hidden="true" href="#cb295-7" tabindex="-1"></a><span class="pp">   </span><span class="op">(!</span><span class="pp"> </span><span class="op">(((</span><span class="dt">unsigned</span><span class="op">)</span><span class="pp"> </span><span class="op">(</span><span class="pp">XLI </span><span class="op">(</span><span class="pp">a</span><span class="op">)</span><span class="pp"> </span><span class="op">&gt;&gt;</span><span class="pp"> </span><span class="op">(</span>USE_LSB_TAG<span class="pp"> </span><span class="op">?</span><span class="pp"> </span><span class="dv">0</span><span class="pp"> </span><span class="op">:</span><span class="pp"> VALBITS</span><span class="op">))</span><span class="pp"> </span><span class="op">\</span></span>
<span id="cb295-8"><a aria-hidden="true" href="#cb295-8" tabindex="-1"></a><span class="pp">        </span><span class="op">-</span><span class="pp"> </span><span class="op">(</span><span class="dt">unsigned</span><span class="op">)</span><span class="pp"> </span><span class="op">(</span><span class="pp">tag</span><span class="op">))</span><span class="pp"> </span><span class="op">\</span></span>
<span id="cb295-9"><a aria-hidden="true" href="#cb295-9" tabindex="-1"></a><span class="pp">       </span><span class="op">&amp;</span><span class="pp"> </span><span class="op">((</span><span class="dv">1</span><span class="pp"> </span><span class="op">&lt;&lt;</span><span class="pp"> GCTYPEBITS</span><span class="op">)</span><span class="pp"> </span><span class="op">-</span><span class="pp"> </span><span class="dv">1</span><span class="op">)))</span></span>
<span id="cb295-10"><a aria-hidden="true" href="#cb295-10" tabindex="-1"></a></span>
<span id="cb295-11"><a aria-hidden="true" href="#cb295-11" tabindex="-1"></a><span class="pp">#define lisp_h_VECTORLIKEP</span><span class="op">(</span><span class="pp">x</span><span class="op">)</span><span class="pp"> TAGGEDP </span><span class="op">(</span><span class="pp">x</span><span class="op">,</span><span class="pp"> </span>Lisp_Vectorlike<span class="op">)</span></span>
<span id="cb295-12"><a aria-hidden="true" href="#cb295-12" tabindex="-1"></a><span class="pp">#define lisp_h_XCAR</span><span class="op">(</span><span class="pp">c</span><span class="op">)</span><span class="pp"> XCONS </span><span class="op">(</span><span class="pp">c</span><span class="op">)-&gt;</span>u<span class="op">.</span><span class="pp">s</span><span class="op">.</span><span class="pp">car</span></span>
<span id="cb295-13"><a aria-hidden="true" href="#cb295-13" tabindex="-1"></a><span class="pp">#define lisp_h_XCDR</span><span class="op">(</span><span class="pp">c</span><span class="op">)</span><span class="pp"> XCONS </span><span class="op">(</span><span class="pp">c</span><span class="op">)-&gt;</span>u<span class="op">.</span><span class="pp">s</span><span class="op">.</span>u<span class="op">.</span><span class="pp">cdr</span></span></code></pre></div>
<p><strong>Example: Type Checking <code>(foo . bar)</code></strong></p>
<div class="sourceCode" id="cb296"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb296-1"><a aria-hidden="true" href="#cb296-1" tabindex="-1"></a>Lisp_Object cons <span class="op">=</span> <span class="co">/* ... */</span><span class="op">;</span></span>
<span id="cb296-2"><a aria-hidden="true" href="#cb296-2" tabindex="-1"></a></span>
<span id="cb296-3"><a aria-hidden="true" href="#cb296-3" tabindex="-1"></a><span class="co">// Fast inline check - just a bit mask and comparison</span></span>
<span id="cb296-4"><a aria-hidden="true" href="#cb296-4" tabindex="-1"></a><span class="cf">if</span> <span class="op">(</span>CONSP<span class="op">(</span>cons<span class="op">))</span> <span class="op">{</span></span>
<span id="cb296-5"><a aria-hidden="true" href="#cb296-5" tabindex="-1"></a>    Lisp_Object car <span class="op">=</span> XCAR<span class="op">(</span>cons<span class="op">);</span>  <span class="co">// No overhead, just pointer arithmetic</span></span>
<span id="cb296-6"><a aria-hidden="true" href="#cb296-6" tabindex="-1"></a>    Lisp_Object cdr <span class="op">=</span> XCDR<span class="op">(</span>cons<span class="op">);</span></span>
<span id="cb296-7"><a aria-hidden="true" href="#cb296-7" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 data-number="11.3.2" id="integer-representation"><span class="header-section-number">11.3.2</span> 2.2 Integer
Representation</h3>
<p>Fixnums (small integers) are represented directly in the
<code>Lisp_Object</code>, using two tag values to gain an extra bit of
range.</p>
<p><strong>Location</strong>:
<code>/home/user/emacs/src/lisp.h:402-406,432-433</code></p>
<div class="sourceCode" id="cb297"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb297-1"><a aria-hidden="true" href="#cb297-1" tabindex="-1"></a><span class="pp">#define lisp_h_FIXNUMP</span><span class="op">(</span><span class="pp">x</span><span class="op">)</span><span class="pp"> </span><span class="op">\</span></span>
<span id="cb297-2"><a aria-hidden="true" href="#cb297-2" tabindex="-1"></a><span class="pp">   </span><span class="op">(!</span><span class="pp"> </span><span class="op">(((</span><span class="dt">unsigned</span><span class="op">)</span><span class="pp"> </span><span class="op">(</span><span class="pp">XLI </span><span class="op">(</span><span class="pp">x</span><span class="op">)</span><span class="pp"> </span><span class="op">&gt;&gt;</span><span class="pp"> </span><span class="op">(</span>USE_LSB_TAG<span class="pp"> </span><span class="op">?</span><span class="pp"> </span><span class="dv">0</span><span class="pp"> </span><span class="op">:</span><span class="pp"> FIXNUM_BITS</span><span class="op">))</span><span class="pp"> </span><span class="op">\</span></span>
<span id="cb297-3"><a aria-hidden="true" href="#cb297-3" tabindex="-1"></a><span class="pp">        </span><span class="op">-</span><span class="pp"> </span><span class="op">(</span><span class="dt">unsigned</span><span class="op">)</span><span class="pp"> </span><span class="op">(</span>Lisp_Int0<span class="pp"> </span><span class="op">&gt;&gt;</span><span class="pp"> </span><span class="op">!</span>USE_LSB_TAG<span class="op">))</span><span class="pp"> </span><span class="op">\</span></span>
<span id="cb297-4"><a aria-hidden="true" href="#cb297-4" tabindex="-1"></a><span class="pp">       </span><span class="op">&amp;</span><span class="pp"> </span><span class="op">((</span><span class="dv">1</span><span class="pp"> </span><span class="op">&lt;&lt;</span><span class="pp"> INTTYPEBITS</span><span class="op">)</span><span class="pp"> </span><span class="op">-</span><span class="pp"> </span><span class="dv">1</span><span class="op">)))</span></span>
<span id="cb297-5"><a aria-hidden="true" href="#cb297-5" tabindex="-1"></a></span>
<span id="cb297-6"><a aria-hidden="true" href="#cb297-6" tabindex="-1"></a><span class="pp">#if USE_LSB_TAG</span></span>
<span id="cb297-7"><a aria-hidden="true" href="#cb297-7" tabindex="-1"></a><span class="pp"># define lisp_h_XFIXNUM_RAW</span><span class="op">(</span><span class="pp">a</span><span class="op">)</span><span class="pp"> </span><span class="op">(</span><span class="pp">XLI </span><span class="op">(</span><span class="pp">a</span><span class="op">)</span><span class="pp"> </span><span class="op">&gt;&gt;</span><span class="pp"> INTTYPEBITS</span><span class="op">)</span></span>
<span id="cb297-8"><a aria-hidden="true" href="#cb297-8" tabindex="-1"></a><span class="pp"># define lisp_h_XTYPE</span><span class="op">(</span><span class="pp">a</span><span class="op">)</span><span class="pp"> </span><span class="op">((</span><span class="kw">enum</span><span class="pp"> </span>Lisp_Type<span class="op">)</span><span class="pp"> </span><span class="op">(</span><span class="pp">XLI </span><span class="op">(</span><span class="pp">a</span><span class="op">)</span><span class="pp"> </span><span class="op">&amp;</span><span class="pp"> </span><span class="op">~</span><span class="pp">VALMASK</span><span class="op">))</span></span>
<span id="cb297-9"><a aria-hidden="true" href="#cb297-9" tabindex="-1"></a><span class="pp">#endif</span></span></code></pre></div>
<p>On a 64-bit system with LSB tagging: - <strong>Fixnum range</strong>:
61 bits (one sign bit + 60 value bits) - <strong>Tag bits</strong>: 3
bits - <strong>Two tags</strong>: <code>Lisp_Int0</code> (tag=2) and
<code>Lisp_Int1</code> (tag=6) give us one extra bit</p>
<hr/>
<h2 data-number="11.4" id="reading-lisp-code"><span class="header-section-number">11.4</span> 3. Reading Lisp Code</h2>
<h3 data-number="11.4.1" id="the-lisp-reader"><span class="header-section-number">11.4.1</span> 3.1 The Lisp Reader</h3>
<p>The reader transforms textual S-expressions into internal Lisp_Object
structures.</p>
<p><strong>Location</strong>:
<code>/home/user/emacs/src/lread.c:1-200</code></p>
<p>The reader handles: - <strong>Symbols</strong>: Interned into the
obarray - <strong>Lists</strong>: Cons cells chained together -
<strong>Literals</strong>: Numbers, strings, vectors - <strong>Special
syntax</strong>: <code>#n=</code> and <code>#n#</code> for circular
structures, reader macros</p>
<p><strong>Key Variables</strong>:</p>
<div class="sourceCode" id="cb298"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb298-1"><a aria-hidden="true" href="#cb298-1" tabindex="-1"></a><span class="co">/* The objects or placeholders read with the #n=object form. */</span></span>
<span id="cb298-2"><a aria-hidden="true" href="#cb298-2" tabindex="-1"></a><span class="dt">static</span> Lisp_Object read_objects_map<span class="op">;</span></span>
<span id="cb298-3"><a aria-hidden="true" href="#cb298-3" tabindex="-1"></a></span>
<span id="cb298-4"><a aria-hidden="true" href="#cb298-4" tabindex="-1"></a><span class="co">/* The recursive objects read with the #n=object form. */</span></span>
<span id="cb298-5"><a aria-hidden="true" href="#cb298-5" tabindex="-1"></a><span class="dt">static</span> Lisp_Object read_objects_completed<span class="op">;</span></span></code></pre></div>
<h3 data-number="11.4.2" id="the-obarray-symbol-interning"><span class="header-section-number">11.4.2</span> 3.2 The Obarray: Symbol
Interning</h3>
<p>The obarray is a hash table that ensures symbol uniqueness - reading
<code>'foo</code> twice yields the same symbol object.</p>
<p><strong>Location</strong>:
<code>/home/user/emacs/src/lread.c:4639-4706</code></p>
<div class="sourceCode" id="cb299"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb299-1"><a aria-hidden="true" href="#cb299-1" tabindex="-1"></a><span class="dt">static</span> Lisp_Object initial_obarray<span class="op">;</span></span>
<span id="cb299-2"><a aria-hidden="true" href="#cb299-2" tabindex="-1"></a></span>
<span id="cb299-3"><a aria-hidden="true" href="#cb299-3" tabindex="-1"></a><span class="co">/* Intern a symbol into the obarray */</span></span>
<span id="cb299-4"><a aria-hidden="true" href="#cb299-4" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span></span>
<span id="cb299-5"><a aria-hidden="true" href="#cb299-5" tabindex="-1"></a>intern_sym <span class="op">(</span>Lisp_Object sym<span class="op">,</span> Lisp_Object obarray<span class="op">,</span> Lisp_Object index<span class="op">)</span></span>
<span id="cb299-6"><a aria-hidden="true" href="#cb299-6" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb299-7"><a aria-hidden="true" href="#cb299-7" tabindex="-1"></a>  <span class="kw">struct</span> Lisp_Symbol <span class="op">*</span>s <span class="op">=</span> XBARE_SYMBOL <span class="op">(</span>sym<span class="op">);</span></span>
<span id="cb299-8"><a aria-hidden="true" href="#cb299-8" tabindex="-1"></a>  s<span class="op">-&gt;</span>u<span class="op">.</span>s<span class="op">.</span>interned <span class="op">=</span> <span class="op">(</span>BASE_EQ <span class="op">(</span>obarray<span class="op">,</span> initial_obarray<span class="op">)</span></span>
<span id="cb299-9"><a aria-hidden="true" href="#cb299-9" tabindex="-1"></a>                     <span class="op">?</span> SYMBOL_INTERNED_IN_INITIAL_OBARRAY</span>
<span id="cb299-10"><a aria-hidden="true" href="#cb299-10" tabindex="-1"></a>                     <span class="op">:</span> SYMBOL_INTERNED<span class="op">);</span></span>
<span id="cb299-11"><a aria-hidden="true" href="#cb299-11" tabindex="-1"></a></span>
<span id="cb299-12"><a aria-hidden="true" href="#cb299-12" tabindex="-1"></a>  <span class="co">/* Keywords (symbols starting with ':') are self-evaluating */</span></span>
<span id="cb299-13"><a aria-hidden="true" href="#cb299-13" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>SREF <span class="op">(</span>s<span class="op">-&gt;</span>u<span class="op">.</span>s<span class="op">.</span>name<span class="op">,</span> <span class="dv">0</span><span class="op">)</span> <span class="op">==</span> <span class="ch">':'</span> <span class="op">&amp;&amp;</span> BASE_EQ <span class="op">(</span>obarray<span class="op">,</span> initial_obarray<span class="op">))</span></span>
<span id="cb299-14"><a aria-hidden="true" href="#cb299-14" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb299-15"><a aria-hidden="true" href="#cb299-15" tabindex="-1"></a>      s<span class="op">-&gt;</span>u<span class="op">.</span>s<span class="op">.</span>trapped_write <span class="op">=</span> SYMBOL_NOWRITE<span class="op">;</span></span>
<span id="cb299-16"><a aria-hidden="true" href="#cb299-16" tabindex="-1"></a>      SET_SYMBOL_VAL <span class="op">(</span>s<span class="op">,</span> sym<span class="op">);</span></span>
<span id="cb299-17"><a aria-hidden="true" href="#cb299-17" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb299-18"><a aria-hidden="true" href="#cb299-18" tabindex="-1"></a></span>
<span id="cb299-19"><a aria-hidden="true" href="#cb299-19" tabindex="-1"></a>  <span class="kw">struct</span> Lisp_Obarray <span class="op">*</span>o <span class="op">=</span> XOBARRAY <span class="op">(</span>obarray<span class="op">);</span></span>
<span id="cb299-20"><a aria-hidden="true" href="#cb299-20" tabindex="-1"></a>  <span class="co">/* ... chain symbol into hash bucket ... */</span></span>
<span id="cb299-21"><a aria-hidden="true" href="#cb299-21" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>Process</strong>: 1. Hash the symbol name 2. Look up in
obarray bucket 3. If found, return existing symbol 4. If not found,
create new symbol and intern it</p>
<hr/>
<h2 data-number="11.5" id="the-evaluation-engine"><span class="header-section-number">11.5</span> 4. The Evaluation Engine</h2>
<h3 data-number="11.5.1" id="the-eval_sub-function"><span class="header-section-number">11.5.1</span> 4.1 The eval_sub
Function</h3>
<p>This is the core of the interpreter - the function that evaluates
Lisp expressions.</p>
<p><strong>Location</strong>:
<code>/home/user/emacs/src/eval.c:2548-2767</code></p>
<div class="sourceCode" id="cb300"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb300-1"><a aria-hidden="true" href="#cb300-1" tabindex="-1"></a><span class="co">/* Eval a sub-expression of the current expression (i.e. in the same</span></span>
<span id="cb300-2"><a aria-hidden="true" href="#cb300-2" tabindex="-1"></a><span class="co">   lexical scope).  */</span></span>
<span id="cb300-3"><a aria-hidden="true" href="#cb300-3" tabindex="-1"></a>Lisp_Object</span>
<span id="cb300-4"><a aria-hidden="true" href="#cb300-4" tabindex="-1"></a>eval_sub <span class="op">(</span>Lisp_Object form<span class="op">)</span></span>
<span id="cb300-5"><a aria-hidden="true" href="#cb300-5" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb300-6"><a aria-hidden="true" href="#cb300-6" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>SYMBOLP <span class="op">(</span>form<span class="op">))</span></span>
<span id="cb300-7"><a aria-hidden="true" href="#cb300-7" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb300-8"><a aria-hidden="true" href="#cb300-8" tabindex="-1"></a>      <span class="co">/* Look up its binding in the lexical environment.</span></span>
<span id="cb300-9"><a aria-hidden="true" href="#cb300-9" tabindex="-1"></a><span class="co">         We do not pay attention to the declared_special flag here, since we</span></span>
<span id="cb300-10"><a aria-hidden="true" href="#cb300-10" tabindex="-1"></a><span class="co">         already did that when let-binding the variable.  */</span></span>
<span id="cb300-11"><a aria-hidden="true" href="#cb300-11" tabindex="-1"></a>      Lisp_Object lex_binding</span>
<span id="cb300-12"><a aria-hidden="true" href="#cb300-12" tabindex="-1"></a>        <span class="op">=</span> Fassq <span class="op">(</span>form<span class="op">,</span> Vinternal_interpreter_environment<span class="op">);</span></span>
<span id="cb300-13"><a aria-hidden="true" href="#cb300-13" tabindex="-1"></a>      <span class="cf">return</span> <span class="op">!</span>NILP <span class="op">(</span>lex_binding<span class="op">)</span> <span class="op">?</span> XCDR <span class="op">(</span>lex_binding<span class="op">)</span> <span class="op">:</span> Fsymbol_value <span class="op">(</span>form<span class="op">);</span></span>
<span id="cb300-14"><a aria-hidden="true" href="#cb300-14" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb300-15"><a aria-hidden="true" href="#cb300-15" tabindex="-1"></a></span>
<span id="cb300-16"><a aria-hidden="true" href="#cb300-16" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(!</span>CONSP <span class="op">(</span>form<span class="op">))</span></span>
<span id="cb300-17"><a aria-hidden="true" href="#cb300-17" tabindex="-1"></a>    <span class="cf">return</span> form<span class="op">;</span>  <span class="co">// Self-evaluating: numbers, strings, vectors, etc.</span></span>
<span id="cb300-18"><a aria-hidden="true" href="#cb300-18" tabindex="-1"></a></span>
<span id="cb300-19"><a aria-hidden="true" href="#cb300-19" tabindex="-1"></a>  maybe_quit <span class="op">();</span></span>
<span id="cb300-20"><a aria-hidden="true" href="#cb300-20" tabindex="-1"></a>  maybe_gc <span class="op">();</span></span>
<span id="cb300-21"><a aria-hidden="true" href="#cb300-21" tabindex="-1"></a></span>
<span id="cb300-22"><a aria-hidden="true" href="#cb300-22" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(++</span>lisp_eval_depth <span class="op">&gt;</span> max_lisp_eval_depth<span class="op">)</span></span>
<span id="cb300-23"><a aria-hidden="true" href="#cb300-23" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb300-24"><a aria-hidden="true" href="#cb300-24" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span>max_lisp_eval_depth <span class="op">&lt;</span> <span class="dv">100</span><span class="op">)</span></span>
<span id="cb300-25"><a aria-hidden="true" href="#cb300-25" tabindex="-1"></a>        max_lisp_eval_depth <span class="op">=</span> <span class="dv">100</span><span class="op">;</span></span>
<span id="cb300-26"><a aria-hidden="true" href="#cb300-26" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span>lisp_eval_depth <span class="op">&gt;</span> max_lisp_eval_depth<span class="op">)</span></span>
<span id="cb300-27"><a aria-hidden="true" href="#cb300-27" tabindex="-1"></a>        xsignal1 <span class="op">(</span>Qexcessive_lisp_nesting<span class="op">,</span> make_fixnum <span class="op">(</span>lisp_eval_depth<span class="op">));</span></span>
<span id="cb300-28"><a aria-hidden="true" href="#cb300-28" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb300-29"><a aria-hidden="true" href="#cb300-29" tabindex="-1"></a></span>
<span id="cb300-30"><a aria-hidden="true" href="#cb300-30" tabindex="-1"></a>  Lisp_Object original_fun <span class="op">=</span> XCAR <span class="op">(</span>form<span class="op">);</span></span>
<span id="cb300-31"><a aria-hidden="true" href="#cb300-31" tabindex="-1"></a>  Lisp_Object original_args <span class="op">=</span> XCDR <span class="op">(</span>form<span class="op">);</span></span>
<span id="cb300-32"><a aria-hidden="true" href="#cb300-32" tabindex="-1"></a>  CHECK_LIST <span class="op">(</span>original_args<span class="op">);</span></span>
<span id="cb300-33"><a aria-hidden="true" href="#cb300-33" tabindex="-1"></a></span>
<span id="cb300-34"><a aria-hidden="true" href="#cb300-34" tabindex="-1"></a>  <span class="co">/* Record in backtrace for debugging */</span></span>
<span id="cb300-35"><a aria-hidden="true" href="#cb300-35" tabindex="-1"></a>  specpdl_ref count</span>
<span id="cb300-36"><a aria-hidden="true" href="#cb300-36" tabindex="-1"></a>    <span class="op">=</span> record_in_backtrace <span class="op">(</span>original_fun<span class="op">,</span> <span class="op">&amp;</span>original_args<span class="op">,</span> UNEVALLED<span class="op">);</span></span>
<span id="cb300-37"><a aria-hidden="true" href="#cb300-37" tabindex="-1"></a></span>
<span id="cb300-38"><a aria-hidden="true" href="#cb300-38" tabindex="-1"></a>  <span class="co">/* ... (continues with function dispatch) ... */</span></span></code></pre></div>
<p><strong>Evaluation Steps</strong>:</p>
<ol type="1">
<li><strong>Symbols</strong>: Look up in lexical environment, then
dynamic (symbol value cell)</li>
<li><strong>Self-evaluating</strong>: Numbers, strings, keywords return
themselves</li>
<li><strong>Lists</strong>: Function application
<ul>
<li>Extract function and arguments</li>
<li>Resolve indirection (symbol to function)</li>
<li>Dispatch based on function type</li>
</ul></li>
</ol>
<h3 data-number="11.5.2" id="function-dispatch"><span class="header-section-number">11.5.2</span> 4.2 Function Dispatch</h3>
<p><strong>Location</strong>:
<code>/home/user/emacs/src/eval.c:2597-2767</code></p>
<div class="sourceCode" id="cb301"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb301-1"><a aria-hidden="true" href="#cb301-1" tabindex="-1"></a>retry<span class="op">:</span></span>
<span id="cb301-2"><a aria-hidden="true" href="#cb301-2" tabindex="-1"></a>  <span class="co">/* Optimize for no indirection.  */</span></span>
<span id="cb301-3"><a aria-hidden="true" href="#cb301-3" tabindex="-1"></a>  fun <span class="op">=</span> original_fun<span class="op">;</span></span>
<span id="cb301-4"><a aria-hidden="true" href="#cb301-4" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(!</span>SYMBOLP <span class="op">(</span>fun<span class="op">))</span></span>
<span id="cb301-5"><a aria-hidden="true" href="#cb301-5" tabindex="-1"></a>    fun <span class="op">=</span> Ffunction <span class="op">(</span>list1 <span class="op">(</span>fun<span class="op">));</span></span>
<span id="cb301-6"><a aria-hidden="true" href="#cb301-6" tabindex="-1"></a>  <span class="cf">else</span> <span class="cf">if</span> <span class="op">(!</span>NILP <span class="op">(</span>fun<span class="op">)</span> <span class="op">&amp;&amp;</span> <span class="op">(</span>fun <span class="op">=</span> XSYMBOL <span class="op">(</span>fun<span class="op">)-&gt;</span>u<span class="op">.</span>s<span class="op">.</span>function<span class="op">,</span> SYMBOLP <span class="op">(</span>fun<span class="op">)))</span></span>
<span id="cb301-7"><a aria-hidden="true" href="#cb301-7" tabindex="-1"></a>    fun <span class="op">=</span> indirect_function <span class="op">(</span>fun<span class="op">);</span></span>
<span id="cb301-8"><a aria-hidden="true" href="#cb301-8" tabindex="-1"></a></span>
<span id="cb301-9"><a aria-hidden="true" href="#cb301-9" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>SUBRP <span class="op">(</span>fun<span class="op">)</span> <span class="op">&amp;&amp;</span> <span class="op">!</span>NATIVE_COMP_FUNCTION_DYNP <span class="op">(</span>fun<span class="op">))</span></span>
<span id="cb301-10"><a aria-hidden="true" href="#cb301-10" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb301-11"><a aria-hidden="true" href="#cb301-11" tabindex="-1"></a>      <span class="co">/* Built-in function (implemented in C) */</span></span>
<span id="cb301-12"><a aria-hidden="true" href="#cb301-12" tabindex="-1"></a>      Lisp_Object args_left <span class="op">=</span> original_args<span class="op">;</span></span>
<span id="cb301-13"><a aria-hidden="true" href="#cb301-13" tabindex="-1"></a>      <span class="dt">ptrdiff_t</span> numargs <span class="op">=</span> list_length <span class="op">(</span>args_left<span class="op">);</span></span>
<span id="cb301-14"><a aria-hidden="true" href="#cb301-14" tabindex="-1"></a></span>
<span id="cb301-15"><a aria-hidden="true" href="#cb301-15" tabindex="-1"></a>      <span class="co">/* Check arity */</span></span>
<span id="cb301-16"><a aria-hidden="true" href="#cb301-16" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span>numargs <span class="op">&lt;</span> XSUBR <span class="op">(</span>fun<span class="op">)-&gt;</span>min_args</span>
<span id="cb301-17"><a aria-hidden="true" href="#cb301-17" tabindex="-1"></a>          <span class="op">||</span> <span class="op">(</span>XSUBR <span class="op">(</span>fun<span class="op">)-&gt;</span>max_args <span class="op">&gt;=</span> <span class="dv">0</span></span>
<span id="cb301-18"><a aria-hidden="true" href="#cb301-18" tabindex="-1"></a>              <span class="op">&amp;&amp;</span> XSUBR <span class="op">(</span>fun<span class="op">)-&gt;</span>max_args <span class="op">&lt;</span> numargs<span class="op">))</span></span>
<span id="cb301-19"><a aria-hidden="true" href="#cb301-19" tabindex="-1"></a>        xsignal2 <span class="op">(</span>Qwrong_number_of_arguments<span class="op">,</span> original_fun<span class="op">,</span></span>
<span id="cb301-20"><a aria-hidden="true" href="#cb301-20" tabindex="-1"></a>                  make_fixnum <span class="op">(</span>numargs<span class="op">));</span></span>
<span id="cb301-21"><a aria-hidden="true" href="#cb301-21" tabindex="-1"></a></span>
<span id="cb301-22"><a aria-hidden="true" href="#cb301-22" tabindex="-1"></a>      <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>XSUBR <span class="op">(</span>fun<span class="op">)-&gt;</span>max_args <span class="op">==</span> UNEVALLED<span class="op">)</span></span>
<span id="cb301-23"><a aria-hidden="true" href="#cb301-23" tabindex="-1"></a>        <span class="co">/* Special form - pass arguments UNEVALUATED */</span></span>
<span id="cb301-24"><a aria-hidden="true" href="#cb301-24" tabindex="-1"></a>        val <span class="op">=</span> <span class="op">(</span>XSUBR <span class="op">(</span>fun<span class="op">)-&gt;</span>function<span class="op">.</span>aUNEVALLED<span class="op">)</span> <span class="op">(</span>args_left<span class="op">);</span></span>
<span id="cb301-25"><a aria-hidden="true" href="#cb301-25" tabindex="-1"></a>      <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>XSUBR <span class="op">(</span>fun<span class="op">)-&gt;</span>max_args <span class="op">==</span> MANY</span>
<span id="cb301-26"><a aria-hidden="true" href="#cb301-26" tabindex="-1"></a>               <span class="op">||</span> XSUBR <span class="op">(</span>fun<span class="op">)-&gt;</span>max_args <span class="op">&gt;</span> <span class="dv">8</span><span class="op">)</span></span>
<span id="cb301-27"><a aria-hidden="true" href="#cb301-27" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb301-28"><a aria-hidden="true" href="#cb301-28" tabindex="-1"></a>          <span class="co">/* Evaluate all arguments into a vector */</span></span>
<span id="cb301-29"><a aria-hidden="true" href="#cb301-29" tabindex="-1"></a>          SAFE_ALLOCA_LISP <span class="op">(</span>vals<span class="op">,</span> numargs<span class="op">);</span></span>
<span id="cb301-30"><a aria-hidden="true" href="#cb301-30" tabindex="-1"></a></span>
<span id="cb301-31"><a aria-hidden="true" href="#cb301-31" tabindex="-1"></a>          <span class="cf">while</span> <span class="op">(</span>CONSP <span class="op">(</span>args_left<span class="op">)</span> <span class="op">&amp;&amp;</span> argnum <span class="op">&lt;</span> numargs<span class="op">)</span></span>
<span id="cb301-32"><a aria-hidden="true" href="#cb301-32" tabindex="-1"></a>            <span class="op">{</span></span>
<span id="cb301-33"><a aria-hidden="true" href="#cb301-33" tabindex="-1"></a>              Lisp_Object arg <span class="op">=</span> XCAR <span class="op">(</span>args_left<span class="op">);</span></span>
<span id="cb301-34"><a aria-hidden="true" href="#cb301-34" tabindex="-1"></a>              args_left <span class="op">=</span> XCDR <span class="op">(</span>args_left<span class="op">);</span></span>
<span id="cb301-35"><a aria-hidden="true" href="#cb301-35" tabindex="-1"></a>              vals<span class="op">[</span>argnum<span class="op">++]</span> <span class="op">=</span> eval_sub <span class="op">(</span>arg<span class="op">);</span>  <span class="co">// RECURSIVE CALL</span></span>
<span id="cb301-36"><a aria-hidden="true" href="#cb301-36" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb301-37"><a aria-hidden="true" href="#cb301-37" tabindex="-1"></a></span>
<span id="cb301-38"><a aria-hidden="true" href="#cb301-38" tabindex="-1"></a>          val <span class="op">=</span> XSUBR <span class="op">(</span>fun<span class="op">)-&gt;</span>function<span class="op">.</span>aMANY <span class="op">(</span>argnum<span class="op">,</span> vals<span class="op">);</span></span>
<span id="cb301-39"><a aria-hidden="true" href="#cb301-39" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb301-40"><a aria-hidden="true" href="#cb301-40" tabindex="-1"></a>      <span class="cf">else</span></span>
<span id="cb301-41"><a aria-hidden="true" href="#cb301-41" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb301-42"><a aria-hidden="true" href="#cb301-42" tabindex="-1"></a>          <span class="co">/* Fixed arity (0-8 args) - optimized path */</span></span>
<span id="cb301-43"><a aria-hidden="true" href="#cb301-43" tabindex="-1"></a>          <span class="dt">int</span> i<span class="op">,</span> maxargs <span class="op">=</span> XSUBR <span class="op">(</span>fun<span class="op">)-&gt;</span>max_args<span class="op">;</span></span>
<span id="cb301-44"><a aria-hidden="true" href="#cb301-44" tabindex="-1"></a></span>
<span id="cb301-45"><a aria-hidden="true" href="#cb301-45" tabindex="-1"></a>          <span class="cf">for</span> <span class="op">(</span>i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> maxargs<span class="op">;</span> i<span class="op">++)</span></span>
<span id="cb301-46"><a aria-hidden="true" href="#cb301-46" tabindex="-1"></a>            <span class="op">{</span></span>
<span id="cb301-47"><a aria-hidden="true" href="#cb301-47" tabindex="-1"></a>              argvals<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> eval_sub <span class="op">(</span>Fcar <span class="op">(</span>args_left<span class="op">));</span>  <span class="co">// RECURSIVE</span></span>
<span id="cb301-48"><a aria-hidden="true" href="#cb301-48" tabindex="-1"></a>              args_left <span class="op">=</span> Fcdr <span class="op">(</span>args_left<span class="op">);</span></span>
<span id="cb301-49"><a aria-hidden="true" href="#cb301-49" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb301-50"><a aria-hidden="true" href="#cb301-50" tabindex="-1"></a></span>
<span id="cb301-51"><a aria-hidden="true" href="#cb301-51" tabindex="-1"></a>          <span class="cf">switch</span> <span class="op">(</span>i<span class="op">)</span></span>
<span id="cb301-52"><a aria-hidden="true" href="#cb301-52" tabindex="-1"></a>            <span class="op">{</span></span>
<span id="cb301-53"><a aria-hidden="true" href="#cb301-53" tabindex="-1"></a>            <span class="cf">case</span> <span class="dv">0</span><span class="op">:</span> val <span class="op">=</span> <span class="op">(</span>XSUBR <span class="op">(</span>fun<span class="op">)-&gt;</span>function<span class="op">.</span>a0 <span class="op">());</span> <span class="cf">break</span><span class="op">;</span></span>
<span id="cb301-54"><a aria-hidden="true" href="#cb301-54" tabindex="-1"></a>            <span class="cf">case</span> <span class="dv">1</span><span class="op">:</span> val <span class="op">=</span> <span class="op">(</span>XSUBR <span class="op">(</span>fun<span class="op">)-&gt;</span>function<span class="op">.</span>a1 <span class="op">(</span>argvals<span class="op">[</span><span class="dv">0</span><span class="op">]));</span> <span class="cf">break</span><span class="op">;</span></span>
<span id="cb301-55"><a aria-hidden="true" href="#cb301-55" tabindex="-1"></a>            <span class="cf">case</span> <span class="dv">2</span><span class="op">:</span> val <span class="op">=</span> <span class="op">(</span>XSUBR <span class="op">(</span>fun<span class="op">)-&gt;</span>function<span class="op">.</span>a2 <span class="op">(</span>argvals<span class="op">[</span><span class="dv">0</span><span class="op">],</span> argvals<span class="op">[</span><span class="dv">1</span><span class="op">]));</span> <span class="cf">break</span><span class="op">;</span></span>
<span id="cb301-56"><a aria-hidden="true" href="#cb301-56" tabindex="-1"></a>            <span class="co">// ... cases 3-8 ...</span></span>
<span id="cb301-57"><a aria-hidden="true" href="#cb301-57" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb301-58"><a aria-hidden="true" href="#cb301-58" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb301-59"><a aria-hidden="true" href="#cb301-59" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb301-60"><a aria-hidden="true" href="#cb301-60" tabindex="-1"></a>  <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>CLOSUREP <span class="op">(</span>fun<span class="op">)</span></span>
<span id="cb301-61"><a aria-hidden="true" href="#cb301-61" tabindex="-1"></a>           <span class="op">||</span> NATIVE_COMP_FUNCTION_DYNP <span class="op">(</span>fun<span class="op">)</span></span>
<span id="cb301-62"><a aria-hidden="true" href="#cb301-62" tabindex="-1"></a>           <span class="op">||</span> MODULE_FUNCTIONP <span class="op">(</span>fun<span class="op">))</span></span>
<span id="cb301-63"><a aria-hidden="true" href="#cb301-63" tabindex="-1"></a>    <span class="cf">return</span> apply_lambda <span class="op">(</span>fun<span class="op">,</span> original_args<span class="op">,</span> count<span class="op">);</span></span>
<span id="cb301-64"><a aria-hidden="true" href="#cb301-64" tabindex="-1"></a>  <span class="cf">else</span></span>
<span id="cb301-65"><a aria-hidden="true" href="#cb301-65" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb301-66"><a aria-hidden="true" href="#cb301-66" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span>NILP <span class="op">(</span>fun<span class="op">))</span></span>
<span id="cb301-67"><a aria-hidden="true" href="#cb301-67" tabindex="-1"></a>        xsignal1 <span class="op">(</span>Qvoid_function<span class="op">,</span> original_fun<span class="op">);</span></span>
<span id="cb301-68"><a aria-hidden="true" href="#cb301-68" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(!</span>CONSP <span class="op">(</span>fun<span class="op">))</span></span>
<span id="cb301-69"><a aria-hidden="true" href="#cb301-69" tabindex="-1"></a>        xsignal1 <span class="op">(</span>Qinvalid_function<span class="op">,</span> original_fun<span class="op">);</span></span>
<span id="cb301-70"><a aria-hidden="true" href="#cb301-70" tabindex="-1"></a></span>
<span id="cb301-71"><a aria-hidden="true" href="#cb301-71" tabindex="-1"></a>      Lisp_Object funcar <span class="op">=</span> XCAR <span class="op">(</span>fun<span class="op">);</span></span>
<span id="cb301-72"><a aria-hidden="true" href="#cb301-72" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span>EQ <span class="op">(</span>funcar<span class="op">,</span> Qautoload<span class="op">))</span></span>
<span id="cb301-73"><a aria-hidden="true" href="#cb301-73" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb301-74"><a aria-hidden="true" href="#cb301-74" tabindex="-1"></a>          Fautoload_do_load <span class="op">(</span>fun<span class="op">,</span> original_fun<span class="op">,</span> Qnil<span class="op">);</span></span>
<span id="cb301-75"><a aria-hidden="true" href="#cb301-75" tabindex="-1"></a>          <span class="cf">goto</span> retry<span class="op">;</span></span>
<span id="cb301-76"><a aria-hidden="true" href="#cb301-76" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb301-77"><a aria-hidden="true" href="#cb301-77" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span>EQ <span class="op">(</span>funcar<span class="op">,</span> Qmacro<span class="op">))</span></span>
<span id="cb301-78"><a aria-hidden="true" href="#cb301-78" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb301-79"><a aria-hidden="true" href="#cb301-79" tabindex="-1"></a>          <span class="co">/* Macro expansion */</span></span>
<span id="cb301-80"><a aria-hidden="true" href="#cb301-80" tabindex="-1"></a>          Lisp_Object exp <span class="op">=</span> apply1 <span class="op">(</span>Fcdr <span class="op">(</span>fun<span class="op">),</span> original_args<span class="op">);</span></span>
<span id="cb301-81"><a aria-hidden="true" href="#cb301-81" tabindex="-1"></a>          val <span class="op">=</span> eval_sub <span class="op">(</span>exp<span class="op">);</span>  <span class="co">// Evaluate the expansion</span></span>
<span id="cb301-82"><a aria-hidden="true" href="#cb301-82" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb301-83"><a aria-hidden="true" href="#cb301-83" tabindex="-1"></a>      <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>EQ <span class="op">(</span>funcar<span class="op">,</span> Qlambda<span class="op">))</span></span>
<span id="cb301-84"><a aria-hidden="true" href="#cb301-84" tabindex="-1"></a>        <span class="cf">return</span> apply_lambda <span class="op">(</span>fun<span class="op">,</span> original_args<span class="op">,</span> count<span class="op">);</span></span>
<span id="cb301-85"><a aria-hidden="true" href="#cb301-85" tabindex="-1"></a>      <span class="cf">else</span></span>
<span id="cb301-86"><a aria-hidden="true" href="#cb301-86" tabindex="-1"></a>        xsignal1 <span class="op">(</span>Qinvalid_function<span class="op">,</span> original_fun<span class="op">);</span></span>
<span id="cb301-87"><a aria-hidden="true" href="#cb301-87" tabindex="-1"></a>    <span class="op">}</span></span></code></pre></div>
<p><strong>Design Insight</strong>: The evaluation loop has multiple
levels of optimization:</p>
<ol type="1">
<li><strong>Inline for common arities</strong>: Functions with 0-8 args
get specialized code paths</li>
<li><strong>UNEVALLED for special forms</strong>: Skip argument
evaluation</li>
<li><strong>Symbol indirection caching</strong>:
<code>indirect_function</code> to resolve aliases</li>
<li><strong>Tail call to apply_lambda</strong>: Let lambda application
handle its own evaluation</li>
</ol>
<h3 data-number="11.5.3" id="example-evaluating-1-2"><span class="header-section-number">11.5.3</span> 4.3 Example: Evaluating
<code>(+ 1 2)</code></h3>
<p>Let‚Äôs trace through the evaluation step by step:</p>
<div class="sourceCode" id="cb302"><pre class="sourceCode lisp"><code class="sourceCode commonlisp"><span id="cb302-1"><a aria-hidden="true" href="#cb302-1" tabindex="-1"></a>(<span class="op">+</span> <span class="dv">1</span> <span class="dv">2</span>)</span></code></pre></div>
<ol type="1">
<li><p><strong>Enter eval_sub</strong>:</p>
<ul>
<li><code>form = '(+ 1 2)</code> (a cons cell)</li>
<li>Not a symbol, not self-evaluating</li>
<li>It‚Äôs a list, so it‚Äôs a function call</li>
</ul></li>
<li><p><strong>Extract components</strong>:</p>
<ul>
<li><code>original_fun = '+</code></li>
<li><code>original_args = '(1 2)</code></li>
</ul></li>
<li><p><strong>Resolve function</strong>:</p>
<ul>
<li><code>+</code> is a symbol</li>
<li>Look up its function cell:
<code>XSYMBOL('+')-&gt;u.s.function</code></li>
<li>Returns a SUBR (built-in function)</li>
</ul></li>
<li><p><strong>Dispatch to SUBR</strong>:</p>
<ul>
<li>Count args: 2</li>
<li>Check arity: min=0, max=MANY (unlimited)</li>
<li>Path: MANY</li>
</ul></li>
<li><p><strong>Evaluate arguments</strong>:</p>
<div class="sourceCode" id="cb303"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb303-1"><a aria-hidden="true" href="#cb303-1" tabindex="-1"></a>vals<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">=</span> eval_sub <span class="op">(</span><span class="dv">1</span><span class="op">);</span>  <span class="co">// Returns 1 (self-evaluating)</span></span>
<span id="cb303-2"><a aria-hidden="true" href="#cb303-2" tabindex="-1"></a>vals<span class="op">[</span><span class="dv">1</span><span class="op">]</span> <span class="op">=</span> eval_sub <span class="op">(</span><span class="dv">2</span><span class="op">);</span>  <span class="co">// Returns 2 (self-evaluating)</span></span></code></pre></div></li>
<li><p><strong>Call C function</strong>:</p>
<div class="sourceCode" id="cb304"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb304-1"><a aria-hidden="true" href="#cb304-1" tabindex="-1"></a>val <span class="op">=</span> XSUBR<span class="op">(</span>fun<span class="op">)-&gt;</span>function<span class="op">.</span>aMANY<span class="op">(</span><span class="dv">2</span><span class="op">,</span> vals<span class="op">);</span></span>
<span id="cb304-2"><a aria-hidden="true" href="#cb304-2" tabindex="-1"></a><span class="co">// Calls Fplus(2, {1, 2}) in src/data.c</span></span></code></pre></div></li>
<li><p><strong>Return result</strong>: <code>3</code></p></li>
</ol>
<hr/>
<h2 data-number="11.6" id="function-application"><span class="header-section-number">11.6</span> 5. Function Application</h2>
<h3 data-number="11.6.1" id="the-defun-macro"><span class="header-section-number">11.6.1</span> 5.1 The DEFUN Macro</h3>
<p>Built-in functions are defined with the <code>DEFUN</code> macro,
which creates a <code>Lisp_Subr</code> structure.</p>
<p><strong>Location</strong>:
<code>/home/user/emacs/src/lisp.h:3458-3465</code></p>
<div class="sourceCode" id="cb305"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb305-1"><a aria-hidden="true" href="#cb305-1" tabindex="-1"></a><span class="pp">#define DEFUN</span><span class="op">(</span><span class="pp">lname</span><span class="op">,</span><span class="pp"> fnname</span><span class="op">,</span><span class="pp"> sname</span><span class="op">,</span><span class="pp"> minargs</span><span class="op">,</span><span class="pp"> maxargs</span><span class="op">,</span><span class="pp"> intspec</span><span class="op">,</span><span class="pp"> doc</span><span class="op">)</span><span class="pp"> </span><span class="op">\</span></span>
<span id="cb305-2"><a aria-hidden="true" href="#cb305-2" tabindex="-1"></a><span class="pp">  SUBR_SECTION_ATTRIBUTE                                            </span><span class="op">\</span></span>
<span id="cb305-3"><a aria-hidden="true" href="#cb305-3" tabindex="-1"></a><span class="pp">  </span><span class="dt">static</span><span class="pp"> </span><span class="kw">union</span><span class="pp"> Aligned_Lisp_Subr sname </span><span class="op">=</span><span class="pp">                            </span><span class="op">\</span></span>
<span id="cb305-4"><a aria-hidden="true" href="#cb305-4" tabindex="-1"></a><span class="pp">     </span><span class="op">{{{</span><span class="pp"> PVEC_SUBR </span><span class="op">&lt;&lt;</span><span class="pp"> PSEUDOVECTOR_AREA_BITS </span><span class="op">},</span><span class="pp">                    </span><span class="op">\</span></span>
<span id="cb305-5"><a aria-hidden="true" href="#cb305-5" tabindex="-1"></a><span class="pp">       </span><span class="op">{</span><span class="pp"> </span><span class="op">.</span><span class="pp">a </span><span class="op">##</span><span class="pp"> maxargs </span><span class="op">=</span><span class="pp"> fnname </span><span class="op">},</span><span class="pp">                                  </span><span class="op">\</span></span>
<span id="cb305-6"><a aria-hidden="true" href="#cb305-6" tabindex="-1"></a><span class="pp">       minargs</span><span class="op">,</span><span class="pp"> maxargs</span><span class="op">,</span><span class="pp"> lname</span><span class="op">,</span><span class="pp"> </span><span class="op">{</span><span class="pp">intspec</span><span class="op">},</span><span class="pp"> lisp_h_Qnil</span><span class="op">}};</span><span class="pp">          </span><span class="op">\</span></span>
<span id="cb305-7"><a aria-hidden="true" href="#cb305-7" tabindex="-1"></a><span class="pp">   </span>Lisp_Object<span class="pp"> fnname</span></span></code></pre></div>
<p><strong>The Lisp_Subr Structure</strong>:</p>
<p><strong>Location</strong>:
<code>/home/user/emacs/src/lisp.h:2186-2219</code></p>
<div class="sourceCode" id="cb306"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb306-1"><a aria-hidden="true" href="#cb306-1" tabindex="-1"></a><span class="kw">struct</span> Lisp_Subr</span>
<span id="cb306-2"><a aria-hidden="true" href="#cb306-2" tabindex="-1"></a>  <span class="op">{</span></span>
<span id="cb306-3"><a aria-hidden="true" href="#cb306-3" tabindex="-1"></a>    <span class="kw">union</span> vectorlike_header header<span class="op">;</span></span>
<span id="cb306-4"><a aria-hidden="true" href="#cb306-4" tabindex="-1"></a>    <span class="kw">union</span> <span class="op">{</span></span>
<span id="cb306-5"><a aria-hidden="true" href="#cb306-5" tabindex="-1"></a>      Lisp_Object <span class="op">(*</span>a0<span class="op">)</span> <span class="op">(</span><span class="dt">void</span><span class="op">);</span></span>
<span id="cb306-6"><a aria-hidden="true" href="#cb306-6" tabindex="-1"></a>      Lisp_Object <span class="op">(*</span>a1<span class="op">)</span> <span class="op">(</span>Lisp_Object<span class="op">);</span></span>
<span id="cb306-7"><a aria-hidden="true" href="#cb306-7" tabindex="-1"></a>      Lisp_Object <span class="op">(*</span>a2<span class="op">)</span> <span class="op">(</span>Lisp_Object<span class="op">,</span> Lisp_Object<span class="op">);</span></span>
<span id="cb306-8"><a aria-hidden="true" href="#cb306-8" tabindex="-1"></a>      Lisp_Object <span class="op">(*</span>a3<span class="op">)</span> <span class="op">(</span>Lisp_Object<span class="op">,</span> Lisp_Object<span class="op">,</span> Lisp_Object<span class="op">);</span></span>
<span id="cb306-9"><a aria-hidden="true" href="#cb306-9" tabindex="-1"></a>      Lisp_Object <span class="op">(*</span>a4<span class="op">)</span> <span class="op">(</span>Lisp_Object<span class="op">,</span> Lisp_Object<span class="op">,</span> Lisp_Object<span class="op">,</span> Lisp_Object<span class="op">);</span></span>
<span id="cb306-10"><a aria-hidden="true" href="#cb306-10" tabindex="-1"></a>      Lisp_Object <span class="op">(*</span>a5<span class="op">)</span> <span class="op">(</span>Lisp_Object<span class="op">,</span> Lisp_Object<span class="op">,</span> Lisp_Object<span class="op">,</span> Lisp_Object<span class="op">,</span> Lisp_Object<span class="op">);</span></span>
<span id="cb306-11"><a aria-hidden="true" href="#cb306-11" tabindex="-1"></a>      Lisp_Object <span class="op">(*</span>a6<span class="op">)</span> <span class="op">(</span>Lisp_Object<span class="op">,</span> Lisp_Object<span class="op">,</span> Lisp_Object<span class="op">,</span> Lisp_Object<span class="op">,</span> Lisp_Object<span class="op">,</span> Lisp_Object<span class="op">);</span></span>
<span id="cb306-12"><a aria-hidden="true" href="#cb306-12" tabindex="-1"></a>      Lisp_Object <span class="op">(*</span>a7<span class="op">)</span> <span class="op">(</span>Lisp_Object<span class="op">,</span> Lisp_Object<span class="op">,</span> Lisp_Object<span class="op">,</span> Lisp_Object<span class="op">,</span> Lisp_Object<span class="op">,</span> Lisp_Object<span class="op">,</span> Lisp_Object<span class="op">);</span></span>
<span id="cb306-13"><a aria-hidden="true" href="#cb306-13" tabindex="-1"></a>      Lisp_Object <span class="op">(*</span>a8<span class="op">)</span> <span class="op">(</span>Lisp_Object<span class="op">,</span> Lisp_Object<span class="op">,</span> Lisp_Object<span class="op">,</span> Lisp_Object<span class="op">,</span> Lisp_Object<span class="op">,</span> Lisp_Object<span class="op">,</span> Lisp_Object<span class="op">,</span> Lisp_Object<span class="op">);</span></span>
<span id="cb306-14"><a aria-hidden="true" href="#cb306-14" tabindex="-1"></a>      Lisp_Object <span class="op">(*</span>aUNEVALLED<span class="op">)</span> <span class="op">(</span>Lisp_Object args<span class="op">);</span></span>
<span id="cb306-15"><a aria-hidden="true" href="#cb306-15" tabindex="-1"></a>      Lisp_Object <span class="op">(*</span>aMANY<span class="op">)</span> <span class="op">(</span><span class="dt">ptrdiff_t</span><span class="op">,</span> Lisp_Object <span class="op">*);</span></span>
<span id="cb306-16"><a aria-hidden="true" href="#cb306-16" tabindex="-1"></a>    <span class="op">}</span> function<span class="op">;</span></span>
<span id="cb306-17"><a aria-hidden="true" href="#cb306-17" tabindex="-1"></a>    <span class="dt">short</span> min_args<span class="op">,</span> max_args<span class="op">;</span></span>
<span id="cb306-18"><a aria-hidden="true" href="#cb306-18" tabindex="-1"></a>    <span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>symbol_name<span class="op">;</span></span>
<span id="cb306-19"><a aria-hidden="true" href="#cb306-19" tabindex="-1"></a>    <span class="co">/* ... documentation, interactive spec, etc. ... */</span></span>
<span id="cb306-20"><a aria-hidden="true" href="#cb306-20" tabindex="-1"></a>  <span class="op">};</span></span></code></pre></div>
<p><strong>Example: Defining <code>eq</code></strong>:</p>
<p><strong>Location</strong>:
<code>/home/user/emacs/src/data.c:168-176</code></p>
<div class="sourceCode" id="cb307"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb307-1"><a aria-hidden="true" href="#cb307-1" tabindex="-1"></a>DEFUN <span class="op">(</span><span class="st">"eq"</span><span class="op">,</span> Feq<span class="op">,</span> Seq<span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb307-2"><a aria-hidden="true" href="#cb307-2" tabindex="-1"></a>       doc<span class="op">:</span> <span class="co">/* Return t if the two args are the same Lisp object.  */</span></span>
<span id="cb307-3"><a aria-hidden="true" href="#cb307-3" tabindex="-1"></a>       attributes<span class="op">:</span> <span class="dt">const</span><span class="op">)</span></span>
<span id="cb307-4"><a aria-hidden="true" href="#cb307-4" tabindex="-1"></a>  <span class="op">(</span>Lisp_Object obj1<span class="op">,</span> Lisp_Object obj2<span class="op">)</span></span>
<span id="cb307-5"><a aria-hidden="true" href="#cb307-5" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb307-6"><a aria-hidden="true" href="#cb307-6" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>EQ <span class="op">(</span>obj1<span class="op">,</span> obj2<span class="op">))</span></span>
<span id="cb307-7"><a aria-hidden="true" href="#cb307-7" tabindex="-1"></a>    <span class="cf">return</span> Qt<span class="op">;</span></span>
<span id="cb307-8"><a aria-hidden="true" href="#cb307-8" tabindex="-1"></a>  <span class="cf">return</span> Qnil<span class="op">;</span></span>
<span id="cb307-9"><a aria-hidden="true" href="#cb307-9" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>This expands to:</p>
<div class="sourceCode" id="cb308"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb308-1"><a aria-hidden="true" href="#cb308-1" tabindex="-1"></a><span class="dt">static</span> <span class="kw">union</span> Aligned_Lisp_Subr Seq <span class="op">=</span></span>
<span id="cb308-2"><a aria-hidden="true" href="#cb308-2" tabindex="-1"></a>  <span class="op">{{{</span> PVEC_SUBR <span class="op">&lt;&lt;</span> PSEUDOVECTOR_AREA_BITS <span class="op">},</span></span>
<span id="cb308-3"><a aria-hidden="true" href="#cb308-3" tabindex="-1"></a>    <span class="op">{</span> <span class="op">.</span>a2 <span class="op">=</span> Feq <span class="op">},</span>           <span class="co">// Function pointer for 2-arg function</span></span>
<span id="cb308-4"><a aria-hidden="true" href="#cb308-4" tabindex="-1"></a>    <span class="dv">2</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span>                     <span class="co">// min_args=2, max_args=2</span></span>
<span id="cb308-5"><a aria-hidden="true" href="#cb308-5" tabindex="-1"></a>    <span class="st">"eq"</span><span class="op">,</span> <span class="op">{</span>NULL<span class="op">},</span> Qnil<span class="op">}};</span></span>
<span id="cb308-6"><a aria-hidden="true" href="#cb308-6" tabindex="-1"></a></span>
<span id="cb308-7"><a aria-hidden="true" href="#cb308-7" tabindex="-1"></a>Lisp_Object Feq<span class="op">(</span>Lisp_Object obj1<span class="op">,</span> Lisp_Object obj2<span class="op">)</span></span>
<span id="cb308-8"><a aria-hidden="true" href="#cb308-8" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb308-9"><a aria-hidden="true" href="#cb308-9" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>EQ <span class="op">(</span>obj1<span class="op">,</span> obj2<span class="op">))</span></span>
<span id="cb308-10"><a aria-hidden="true" href="#cb308-10" tabindex="-1"></a>    <span class="cf">return</span> Qt<span class="op">;</span></span>
<span id="cb308-11"><a aria-hidden="true" href="#cb308-11" tabindex="-1"></a>  <span class="cf">return</span> Qnil<span class="op">;</span></span>
<span id="cb308-12"><a aria-hidden="true" href="#cb308-12" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 data-number="11.6.2" id="funcall-the-direct-call-mechanism"><span class="header-section-number">11.6.2</span> 5.2 Funcall: The Direct Call
Mechanism</h3>
<p><code>funcall</code> calls a function with already-evaluated
arguments, skipping the evaluation step.</p>
<p><strong>Location</strong>:
<code>/home/user/emacs/src/eval.c:3151-3184</code></p>
<div class="sourceCode" id="cb309"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb309-1"><a aria-hidden="true" href="#cb309-1" tabindex="-1"></a>DEFUN <span class="op">(</span><span class="st">"funcall"</span><span class="op">,</span> Ffuncall<span class="op">,</span> Sfuncall<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> MANY<span class="op">,</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb309-2"><a aria-hidden="true" href="#cb309-2" tabindex="-1"></a>       doc<span class="op">:</span> <span class="co">/* Call first argument as a function, passing remaining arguments to it.</span></span>
<span id="cb309-3"><a aria-hidden="true" href="#cb309-3" tabindex="-1"></a><span class="co">Return the value that function returns.</span></span>
<span id="cb309-4"><a aria-hidden="true" href="#cb309-4" tabindex="-1"></a><span class="co">Thus, (funcall \\='cons \\='x \\='y) returns (x . y).</span></span>
<span id="cb309-5"><a aria-hidden="true" href="#cb309-5" tabindex="-1"></a><span class="co">usage: (funcall FUNCTION &amp;rest ARGUMENTS)  */</span><span class="op">)</span></span>
<span id="cb309-6"><a aria-hidden="true" href="#cb309-6" tabindex="-1"></a>  <span class="op">(</span><span class="dt">ptrdiff_t</span> nargs<span class="op">,</span> Lisp_Object <span class="op">*</span>args<span class="op">)</span></span>
<span id="cb309-7"><a aria-hidden="true" href="#cb309-7" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb309-8"><a aria-hidden="true" href="#cb309-8" tabindex="-1"></a>  specpdl_ref count<span class="op">;</span></span>
<span id="cb309-9"><a aria-hidden="true" href="#cb309-9" tabindex="-1"></a></span>
<span id="cb309-10"><a aria-hidden="true" href="#cb309-10" tabindex="-1"></a>  maybe_quit <span class="op">();</span></span>
<span id="cb309-11"><a aria-hidden="true" href="#cb309-11" tabindex="-1"></a></span>
<span id="cb309-12"><a aria-hidden="true" href="#cb309-12" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(++</span>lisp_eval_depth <span class="op">&gt;</span> max_lisp_eval_depth<span class="op">)</span></span>
<span id="cb309-13"><a aria-hidden="true" href="#cb309-13" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb309-14"><a aria-hidden="true" href="#cb309-14" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span>max_lisp_eval_depth <span class="op">&lt;</span> <span class="dv">100</span><span class="op">)</span></span>
<span id="cb309-15"><a aria-hidden="true" href="#cb309-15" tabindex="-1"></a>        max_lisp_eval_depth <span class="op">=</span> <span class="dv">100</span><span class="op">;</span></span>
<span id="cb309-16"><a aria-hidden="true" href="#cb309-16" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span>lisp_eval_depth <span class="op">&gt;</span> max_lisp_eval_depth<span class="op">)</span></span>
<span id="cb309-17"><a aria-hidden="true" href="#cb309-17" tabindex="-1"></a>        xsignal1 <span class="op">(</span>Qexcessive_lisp_nesting<span class="op">,</span> make_fixnum <span class="op">(</span>lisp_eval_depth<span class="op">));</span></span>
<span id="cb309-18"><a aria-hidden="true" href="#cb309-18" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb309-19"><a aria-hidden="true" href="#cb309-19" tabindex="-1"></a></span>
<span id="cb309-20"><a aria-hidden="true" href="#cb309-20" tabindex="-1"></a>  count <span class="op">=</span> record_in_backtrace <span class="op">(</span>args<span class="op">[</span><span class="dv">0</span><span class="op">],</span> <span class="op">&amp;</span>args<span class="op">[</span><span class="dv">1</span><span class="op">],</span> nargs <span class="op">-</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb309-21"><a aria-hidden="true" href="#cb309-21" tabindex="-1"></a></span>
<span id="cb309-22"><a aria-hidden="true" href="#cb309-22" tabindex="-1"></a>  maybe_gc <span class="op">();</span></span>
<span id="cb309-23"><a aria-hidden="true" href="#cb309-23" tabindex="-1"></a></span>
<span id="cb309-24"><a aria-hidden="true" href="#cb309-24" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>debug_on_next_call<span class="op">)</span></span>
<span id="cb309-25"><a aria-hidden="true" href="#cb309-25" tabindex="-1"></a>    do_debug_on_call <span class="op">(</span>Qlambda<span class="op">,</span> count<span class="op">);</span></span>
<span id="cb309-26"><a aria-hidden="true" href="#cb309-26" tabindex="-1"></a></span>
<span id="cb309-27"><a aria-hidden="true" href="#cb309-27" tabindex="-1"></a>  Lisp_Object val <span class="op">=</span> funcall_general <span class="op">(</span>args<span class="op">[</span><span class="dv">0</span><span class="op">],</span> nargs <span class="op">-</span> <span class="dv">1</span><span class="op">,</span> args <span class="op">+</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb309-28"><a aria-hidden="true" href="#cb309-28" tabindex="-1"></a></span>
<span id="cb309-29"><a aria-hidden="true" href="#cb309-29" tabindex="-1"></a>  lisp_eval_depth<span class="op">--;</span></span>
<span id="cb309-30"><a aria-hidden="true" href="#cb309-30" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>backtrace_debug_on_exit <span class="op">(</span>specpdl_ref_to_ptr <span class="op">(</span>count<span class="op">)))</span></span>
<span id="cb309-31"><a aria-hidden="true" href="#cb309-31" tabindex="-1"></a>    val <span class="op">=</span> call_debugger <span class="op">(</span>list2 <span class="op">(</span>Qexit<span class="op">,</span> val<span class="op">));</span></span>
<span id="cb309-32"><a aria-hidden="true" href="#cb309-32" tabindex="-1"></a>  specpdl_ptr<span class="op">--;</span></span>
<span id="cb309-33"><a aria-hidden="true" href="#cb309-33" tabindex="-1"></a>  <span class="cf">return</span> val<span class="op">;</span></span>
<span id="cb309-34"><a aria-hidden="true" href="#cb309-34" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>funcall_general</strong> dispatches based on the function
type:</p>
<p><strong>Location</strong>:
<code>/home/user/emacs/src/eval.c:3115-3149</code></p>
<div class="sourceCode" id="cb310"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb310-1"><a aria-hidden="true" href="#cb310-1" tabindex="-1"></a>Lisp_Object</span>
<span id="cb310-2"><a aria-hidden="true" href="#cb310-2" tabindex="-1"></a>funcall_general <span class="op">(</span>Lisp_Object fun<span class="op">,</span> <span class="dt">ptrdiff_t</span> numargs<span class="op">,</span> Lisp_Object <span class="op">*</span>args<span class="op">)</span></span>
<span id="cb310-3"><a aria-hidden="true" href="#cb310-3" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb310-4"><a aria-hidden="true" href="#cb310-4" tabindex="-1"></a>  Lisp_Object original_fun <span class="op">=</span> fun<span class="op">;</span></span>
<span id="cb310-5"><a aria-hidden="true" href="#cb310-5" tabindex="-1"></a> retry<span class="op">:</span></span>
<span id="cb310-6"><a aria-hidden="true" href="#cb310-6" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>SYMBOLP <span class="op">(</span>fun<span class="op">)</span> <span class="op">&amp;&amp;</span> <span class="op">!</span>NILP <span class="op">(</span>fun<span class="op">)</span></span>
<span id="cb310-7"><a aria-hidden="true" href="#cb310-7" tabindex="-1"></a>      <span class="op">&amp;&amp;</span> <span class="op">(</span>fun <span class="op">=</span> XSYMBOL <span class="op">(</span>fun<span class="op">)-&gt;</span>u<span class="op">.</span>s<span class="op">.</span>function<span class="op">,</span> SYMBOLP <span class="op">(</span>fun<span class="op">)))</span></span>
<span id="cb310-8"><a aria-hidden="true" href="#cb310-8" tabindex="-1"></a>    fun <span class="op">=</span> indirect_function <span class="op">(</span>fun<span class="op">);</span></span>
<span id="cb310-9"><a aria-hidden="true" href="#cb310-9" tabindex="-1"></a></span>
<span id="cb310-10"><a aria-hidden="true" href="#cb310-10" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>SUBRP <span class="op">(</span>fun<span class="op">)</span> <span class="op">&amp;&amp;</span> <span class="op">!</span>NATIVE_COMP_FUNCTION_DYNP <span class="op">(</span>fun<span class="op">))</span></span>
<span id="cb310-11"><a aria-hidden="true" href="#cb310-11" tabindex="-1"></a>    <span class="cf">return</span> funcall_subr <span class="op">(</span>XSUBR <span class="op">(</span>fun<span class="op">),</span> numargs<span class="op">,</span> args<span class="op">);</span></span>
<span id="cb310-12"><a aria-hidden="true" href="#cb310-12" tabindex="-1"></a>  <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>CLOSUREP <span class="op">(</span>fun<span class="op">)</span></span>
<span id="cb310-13"><a aria-hidden="true" href="#cb310-13" tabindex="-1"></a>           <span class="op">||</span> NATIVE_COMP_FUNCTION_DYNP <span class="op">(</span>fun<span class="op">)</span></span>
<span id="cb310-14"><a aria-hidden="true" href="#cb310-14" tabindex="-1"></a>           <span class="op">||</span> MODULE_FUNCTIONP <span class="op">(</span>fun<span class="op">))</span></span>
<span id="cb310-15"><a aria-hidden="true" href="#cb310-15" tabindex="-1"></a>    <span class="cf">return</span> funcall_lambda <span class="op">(</span>fun<span class="op">,</span> numargs<span class="op">,</span> args<span class="op">);</span></span>
<span id="cb310-16"><a aria-hidden="true" href="#cb310-16" tabindex="-1"></a>  <span class="cf">else</span></span>
<span id="cb310-17"><a aria-hidden="true" href="#cb310-17" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb310-18"><a aria-hidden="true" href="#cb310-18" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span>NILP <span class="op">(</span>fun<span class="op">))</span></span>
<span id="cb310-19"><a aria-hidden="true" href="#cb310-19" tabindex="-1"></a>        xsignal1 <span class="op">(</span>Qvoid_function<span class="op">,</span> original_fun<span class="op">);</span></span>
<span id="cb310-20"><a aria-hidden="true" href="#cb310-20" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(!</span>CONSP <span class="op">(</span>fun<span class="op">))</span></span>
<span id="cb310-21"><a aria-hidden="true" href="#cb310-21" tabindex="-1"></a>        xsignal1 <span class="op">(</span>Qinvalid_function<span class="op">,</span> original_fun<span class="op">);</span></span>
<span id="cb310-22"><a aria-hidden="true" href="#cb310-22" tabindex="-1"></a>      Lisp_Object funcar <span class="op">=</span> XCAR <span class="op">(</span>fun<span class="op">);</span></span>
<span id="cb310-23"><a aria-hidden="true" href="#cb310-23" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(!</span>SYMBOLP <span class="op">(</span>funcar<span class="op">))</span></span>
<span id="cb310-24"><a aria-hidden="true" href="#cb310-24" tabindex="-1"></a>        xsignal1 <span class="op">(</span>Qinvalid_function<span class="op">,</span> original_fun<span class="op">);</span></span>
<span id="cb310-25"><a aria-hidden="true" href="#cb310-25" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span>EQ <span class="op">(</span>funcar<span class="op">,</span> Qlambda<span class="op">))</span></span>
<span id="cb310-26"><a aria-hidden="true" href="#cb310-26" tabindex="-1"></a>        <span class="cf">return</span> funcall_lambda <span class="op">(</span>fun<span class="op">,</span> numargs<span class="op">,</span> args<span class="op">);</span></span>
<span id="cb310-27"><a aria-hidden="true" href="#cb310-27" tabindex="-1"></a>      <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>EQ <span class="op">(</span>funcar<span class="op">,</span> Qautoload<span class="op">))</span></span>
<span id="cb310-28"><a aria-hidden="true" href="#cb310-28" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb310-29"><a aria-hidden="true" href="#cb310-29" tabindex="-1"></a>          Fautoload_do_load <span class="op">(</span>fun<span class="op">,</span> original_fun<span class="op">,</span> Qnil<span class="op">);</span></span>
<span id="cb310-30"><a aria-hidden="true" href="#cb310-30" tabindex="-1"></a>          fun <span class="op">=</span> original_fun<span class="op">;</span></span>
<span id="cb310-31"><a aria-hidden="true" href="#cb310-31" tabindex="-1"></a>          <span class="cf">goto</span> retry<span class="op">;</span></span>
<span id="cb310-32"><a aria-hidden="true" href="#cb310-32" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb310-33"><a aria-hidden="true" href="#cb310-33" tabindex="-1"></a>      <span class="cf">else</span></span>
<span id="cb310-34"><a aria-hidden="true" href="#cb310-34" tabindex="-1"></a>        xsignal1 <span class="op">(</span>Qinvalid_function<span class="op">,</span> original_fun<span class="op">);</span></span>
<span id="cb310-35"><a aria-hidden="true" href="#cb310-35" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb310-36"><a aria-hidden="true" href="#cb310-36" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 data-number="11.6.3" id="apply-spreading-argument-lists"><span class="header-section-number">11.6.3</span> 5.3 Apply: Spreading
Argument Lists</h3>
<p><code>apply</code> is like <code>funcall</code>, but its last
argument is a list that gets spread out.</p>
<p><strong>Location</strong>:
<code>/home/user/emacs/src/eval.c:2769-2838</code></p>
<div class="sourceCode" id="cb311"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb311-1"><a aria-hidden="true" href="#cb311-1" tabindex="-1"></a>DEFUN <span class="op">(</span><span class="st">"apply"</span><span class="op">,</span> Fapply<span class="op">,</span> Sapply<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> MANY<span class="op">,</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb311-2"><a aria-hidden="true" href="#cb311-2" tabindex="-1"></a>       doc<span class="op">:</span> <span class="co">/* Call FUNCTION with our remaining args, using our last arg as list of args.</span></span>
<span id="cb311-3"><a aria-hidden="true" href="#cb311-3" tabindex="-1"></a><span class="co">Then return the value FUNCTION returns.</span></span>
<span id="cb311-4"><a aria-hidden="true" href="#cb311-4" tabindex="-1"></a><span class="co">With a single argument, call the argument's first element using the</span></span>
<span id="cb311-5"><a aria-hidden="true" href="#cb311-5" tabindex="-1"></a><span class="co">other elements as args.</span></span>
<span id="cb311-6"><a aria-hidden="true" href="#cb311-6" tabindex="-1"></a><span class="co">Thus, (apply \\='+ 1 2 \\='(3 4)) returns 10.</span></span>
<span id="cb311-7"><a aria-hidden="true" href="#cb311-7" tabindex="-1"></a><span class="co">usage: (apply FUNCTION &amp;rest ARGUMENTS)  */</span><span class="op">)</span></span>
<span id="cb311-8"><a aria-hidden="true" href="#cb311-8" tabindex="-1"></a>  <span class="op">(</span><span class="dt">ptrdiff_t</span> nargs<span class="op">,</span> Lisp_Object <span class="op">*</span>args<span class="op">)</span></span>
<span id="cb311-9"><a aria-hidden="true" href="#cb311-9" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb311-10"><a aria-hidden="true" href="#cb311-10" tabindex="-1"></a>  <span class="dt">ptrdiff_t</span> i<span class="op">,</span> funcall_nargs<span class="op">;</span></span>
<span id="cb311-11"><a aria-hidden="true" href="#cb311-11" tabindex="-1"></a>  Lisp_Object <span class="op">*</span>funcall_args <span class="op">=</span> NULL<span class="op">;</span></span>
<span id="cb311-12"><a aria-hidden="true" href="#cb311-12" tabindex="-1"></a>  Lisp_Object spread_arg <span class="op">=</span> args<span class="op">[</span>nargs <span class="op">-</span> <span class="dv">1</span><span class="op">];</span>  <span class="co">// Last arg is the list</span></span>
<span id="cb311-13"><a aria-hidden="true" href="#cb311-13" tabindex="-1"></a>  Lisp_Object fun <span class="op">=</span> args<span class="op">[</span><span class="dv">0</span><span class="op">];</span></span>
<span id="cb311-14"><a aria-hidden="true" href="#cb311-14" tabindex="-1"></a>  USE_SAFE_ALLOCA<span class="op">;</span></span>
<span id="cb311-15"><a aria-hidden="true" href="#cb311-15" tabindex="-1"></a></span>
<span id="cb311-16"><a aria-hidden="true" href="#cb311-16" tabindex="-1"></a>  <span class="dt">ptrdiff_t</span> numargs <span class="op">=</span> list_length <span class="op">(</span>spread_arg<span class="op">);</span></span>
<span id="cb311-17"><a aria-hidden="true" href="#cb311-17" tabindex="-1"></a></span>
<span id="cb311-18"><a aria-hidden="true" href="#cb311-18" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>numargs <span class="op">==</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb311-19"><a aria-hidden="true" href="#cb311-19" tabindex="-1"></a>    <span class="cf">return</span> Ffuncall <span class="op">(</span>max <span class="op">(</span><span class="dv">1</span><span class="op">,</span> nargs <span class="op">-</span> <span class="dv">1</span><span class="op">),</span> args<span class="op">);</span></span>
<span id="cb311-20"><a aria-hidden="true" href="#cb311-20" tabindex="-1"></a>  <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>numargs <span class="op">==</span> <span class="dv">1</span><span class="op">)</span></span>
<span id="cb311-21"><a aria-hidden="true" href="#cb311-21" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb311-22"><a aria-hidden="true" href="#cb311-22" tabindex="-1"></a>      args <span class="op">[</span>nargs <span class="op">-</span> <span class="dv">1</span><span class="op">]</span> <span class="op">=</span> XCAR <span class="op">(</span>spread_arg<span class="op">);</span></span>
<span id="cb311-23"><a aria-hidden="true" href="#cb311-23" tabindex="-1"></a>      <span class="cf">return</span> Ffuncall <span class="op">(</span>nargs<span class="op">,</span> args<span class="op">);</span></span>
<span id="cb311-24"><a aria-hidden="true" href="#cb311-24" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb311-25"><a aria-hidden="true" href="#cb311-25" tabindex="-1"></a></span>
<span id="cb311-26"><a aria-hidden="true" href="#cb311-26" tabindex="-1"></a>  numargs <span class="op">+=</span> nargs <span class="op">-</span> <span class="dv">2</span><span class="op">;</span>  <span class="co">// Total args = direct args + spread list length</span></span>
<span id="cb311-27"><a aria-hidden="true" href="#cb311-27" tabindex="-1"></a></span>
<span id="cb311-28"><a aria-hidden="true" href="#cb311-28" tabindex="-1"></a>  <span class="co">/* ... optimization for SUBRs with fixed max_args ... */</span></span>
<span id="cb311-29"><a aria-hidden="true" href="#cb311-29" tabindex="-1"></a></span>
<span id="cb311-30"><a aria-hidden="true" href="#cb311-30" tabindex="-1"></a>  SAFE_ALLOCA_LISP <span class="op">(</span>funcall_args<span class="op">,</span> <span class="dv">1</span> <span class="op">+</span> numargs<span class="op">);</span></span>
<span id="cb311-31"><a aria-hidden="true" href="#cb311-31" tabindex="-1"></a>  funcall_nargs <span class="op">=</span> <span class="dv">1</span> <span class="op">+</span> numargs<span class="op">;</span></span>
<span id="cb311-32"><a aria-hidden="true" href="#cb311-32" tabindex="-1"></a></span>
<span id="cb311-33"><a aria-hidden="true" href="#cb311-33" tabindex="-1"></a>  memcpy <span class="op">(</span>funcall_args<span class="op">,</span> args<span class="op">,</span> nargs <span class="op">*</span> word_size<span class="op">);</span></span>
<span id="cb311-34"><a aria-hidden="true" href="#cb311-34" tabindex="-1"></a></span>
<span id="cb311-35"><a aria-hidden="true" href="#cb311-35" tabindex="-1"></a>  <span class="co">/* Spread the last arg */</span></span>
<span id="cb311-36"><a aria-hidden="true" href="#cb311-36" tabindex="-1"></a>  i <span class="op">=</span> nargs <span class="op">-</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb311-37"><a aria-hidden="true" href="#cb311-37" tabindex="-1"></a>  <span class="cf">while</span> <span class="op">(!</span>NILP <span class="op">(</span>spread_arg<span class="op">))</span></span>
<span id="cb311-38"><a aria-hidden="true" href="#cb311-38" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb311-39"><a aria-hidden="true" href="#cb311-39" tabindex="-1"></a>      funcall_args <span class="op">[</span>i<span class="op">++]</span> <span class="op">=</span> XCAR <span class="op">(</span>spread_arg<span class="op">);</span></span>
<span id="cb311-40"><a aria-hidden="true" href="#cb311-40" tabindex="-1"></a>      spread_arg <span class="op">=</span> XCDR <span class="op">(</span>spread_arg<span class="op">);</span></span>
<span id="cb311-41"><a aria-hidden="true" href="#cb311-41" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb311-42"><a aria-hidden="true" href="#cb311-42" tabindex="-1"></a></span>
<span id="cb311-43"><a aria-hidden="true" href="#cb311-43" tabindex="-1"></a>  Lisp_Object retval <span class="op">=</span> Ffuncall <span class="op">(</span>funcall_nargs<span class="op">,</span> funcall_args<span class="op">);</span></span>
<span id="cb311-44"><a aria-hidden="true" href="#cb311-44" tabindex="-1"></a></span>
<span id="cb311-45"><a aria-hidden="true" href="#cb311-45" tabindex="-1"></a>  SAFE_FREE <span class="op">();</span></span>
<span id="cb311-46"><a aria-hidden="true" href="#cb311-46" tabindex="-1"></a>  <span class="cf">return</span> retval<span class="op">;</span></span>
<span id="cb311-47"><a aria-hidden="true" href="#cb311-47" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>Example</strong>:</p>
<div class="sourceCode" id="cb312"><pre class="sourceCode lisp"><code class="sourceCode commonlisp"><span id="cb312-1"><a aria-hidden="true" href="#cb312-1" tabindex="-1"></a>(<span class="kw">apply</span> <span class="op">#'</span>+ <span class="dv">1</span> <span class="dv">2</span> '(<span class="dv">3</span> <span class="dv">4</span>))</span>
<span id="cb312-2"><a aria-hidden="true" href="#cb312-2" tabindex="-1"></a><span class="co">;; Transforms to: (funcall #'+ 1 2 3 4)</span></span>
<span id="cb312-3"><a aria-hidden="true" href="#cb312-3" tabindex="-1"></a><span class="co">;; Returns: 10</span></span></code></pre></div>
<hr/>
<h2 data-number="11.7" id="bytecode-execution"><span class="header-section-number">11.7</span> 6. Bytecode Execution</h2>
<h3 data-number="11.7.1" id="why-bytecode"><span class="header-section-number">11.7.1</span> 6.1 Why Bytecode?</h3>
<p>Interpreted Lisp (walking the AST) is slow. Native compilation is
fast but has high latency. Bytecode offers a middle ground:</p>
<ul>
<li><strong>Faster than interpretation</strong>: Pre-compiled to a
compact instruction stream</li>
<li><strong>Smaller than native code</strong>: More cache-friendly</li>
<li><strong>Quick to load</strong>: No JIT compilation overhead</li>
</ul>
<h3 data-number="11.7.2" id="bytecode-structure"><span class="header-section-number">11.7.2</span> 6.2 Bytecode Structure</h3>
<p>A byte-compiled function is represented as a closure with:</p>
<p><strong>Location</strong>:
<code>/home/user/emacs/src/eval.c:3329-3343</code></p>
<div class="sourceCode" id="cb313"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb313-1"><a aria-hidden="true" href="#cb313-1" tabindex="-1"></a><span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>CLOSUREP <span class="op">(</span>fun<span class="op">))</span></span>
<span id="cb313-2"><a aria-hidden="true" href="#cb313-2" tabindex="-1"></a>  <span class="op">{</span></span>
<span id="cb313-3"><a aria-hidden="true" href="#cb313-3" tabindex="-1"></a>    syms_left <span class="op">=</span> AREF <span class="op">(</span>fun<span class="op">,</span> CLOSURE_ARGLIST<span class="op">);</span></span>
<span id="cb313-4"><a aria-hidden="true" href="#cb313-4" tabindex="-1"></a>    <span class="co">/* Bytecode objects using lexical binding have an integral</span></span>
<span id="cb313-5"><a aria-hidden="true" href="#cb313-5" tabindex="-1"></a><span class="co">       ARGLIST slot value: pass the arguments to the byte-code</span></span>
<span id="cb313-6"><a aria-hidden="true" href="#cb313-6" tabindex="-1"></a><span class="co">       engine directly.  */</span></span>
<span id="cb313-7"><a aria-hidden="true" href="#cb313-7" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>FIXNUMP <span class="op">(</span>syms_left<span class="op">))</span></span>
<span id="cb313-8"><a aria-hidden="true" href="#cb313-8" tabindex="-1"></a>      <span class="cf">return</span> exec_byte_code <span class="op">(</span>fun<span class="op">,</span> XFIXNUM <span class="op">(</span>syms_left<span class="op">),</span> nargs<span class="op">,</span> arg_vector<span class="op">);</span></span>
<span id="cb313-9"><a aria-hidden="true" href="#cb313-9" tabindex="-1"></a>    <span class="co">/* Otherwise the closure either is interpreted</span></span>
<span id="cb313-10"><a aria-hidden="true" href="#cb313-10" tabindex="-1"></a><span class="co">       or uses dynamic binding and the ARGLIST slot contains a standard</span></span>
<span id="cb313-11"><a aria-hidden="true" href="#cb313-11" tabindex="-1"></a><span class="co">       formal argument list whose variables are bound dynamically below.  */</span></span>
<span id="cb313-12"><a aria-hidden="true" href="#cb313-12" tabindex="-1"></a>    lexenv <span class="op">=</span> CONSP <span class="op">(</span>AREF <span class="op">(</span>fun<span class="op">,</span> CLOSURE_CODE<span class="op">))</span></span>
<span id="cb313-13"><a aria-hidden="true" href="#cb313-13" tabindex="-1"></a>             <span class="op">?</span> AREF <span class="op">(</span>fun<span class="op">,</span> CLOSURE_CONSTANTS<span class="op">)</span></span>
<span id="cb313-14"><a aria-hidden="true" href="#cb313-14" tabindex="-1"></a>             <span class="op">:</span> Qnil<span class="op">;</span></span>
<span id="cb313-15"><a aria-hidden="true" href="#cb313-15" tabindex="-1"></a>  <span class="op">}</span></span></code></pre></div>
<p>A compiled function closure has: - <strong>CLOSURE_CODE</strong>: The
bytecode string - <strong>CLOSURE_CONSTANTS</strong>: Vector of
constants - <strong>CLOSURE_ARGLIST</strong>: Either a formal parameter
list or an encoded arity</p>
<h3 data-number="11.7.3" id="the-bytecode-interpreter"><span class="header-section-number">11.7.3</span> 6.3 The Bytecode
Interpreter</h3>
<p><strong>Location</strong>:
<code>/home/user/emacs/src/bytecode.c:481-500</code></p>
<div class="sourceCode" id="cb314"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb314-1"><a aria-hidden="true" href="#cb314-1" tabindex="-1"></a><span class="co">/* Execute the byte-code in FUN.  ARGS_TEMPLATE is the function arity</span></span>
<span id="cb314-2"><a aria-hidden="true" href="#cb314-2" tabindex="-1"></a><span class="co">   encoded as an integer (the one in FUN is ignored), and ARGS, of</span></span>
<span id="cb314-3"><a aria-hidden="true" href="#cb314-3" tabindex="-1"></a><span class="co">   size NARGS, should be a vector of the actual arguments.  The</span></span>
<span id="cb314-4"><a aria-hidden="true" href="#cb314-4" tabindex="-1"></a><span class="co">   arguments in ARGS are pushed on the stack according to</span></span>
<span id="cb314-5"><a aria-hidden="true" href="#cb314-5" tabindex="-1"></a><span class="co">   ARGS_TEMPLATE before executing FUN.  */</span></span>
<span id="cb314-6"><a aria-hidden="true" href="#cb314-6" tabindex="-1"></a></span>
<span id="cb314-7"><a aria-hidden="true" href="#cb314-7" tabindex="-1"></a>Lisp_Object</span>
<span id="cb314-8"><a aria-hidden="true" href="#cb314-8" tabindex="-1"></a>exec_byte_code <span class="op">(</span>Lisp_Object fun<span class="op">,</span> <span class="dt">ptrdiff_t</span> args_template<span class="op">,</span></span>
<span id="cb314-9"><a aria-hidden="true" href="#cb314-9" tabindex="-1"></a>                <span class="dt">ptrdiff_t</span> nargs<span class="op">,</span> Lisp_Object <span class="op">*</span>args<span class="op">)</span></span>
<span id="cb314-10"><a aria-hidden="true" href="#cb314-10" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb314-11"><a aria-hidden="true" href="#cb314-11" tabindex="-1"></a>  <span class="dt">unsigned</span> <span class="dt">char</span> quitcounter <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb314-12"><a aria-hidden="true" href="#cb314-12" tabindex="-1"></a>  <span class="kw">struct</span> bc_thread_state <span class="op">*</span>bc <span class="op">=</span> <span class="op">&amp;</span>current_thread<span class="op">-&gt;</span>bc<span class="op">;</span></span>
<span id="cb314-13"><a aria-hidden="true" href="#cb314-13" tabindex="-1"></a></span>
<span id="cb314-14"><a aria-hidden="true" href="#cb314-14" tabindex="-1"></a>  <span class="co">/* Values used for the first stack record when called from C.  */</span></span>
<span id="cb314-15"><a aria-hidden="true" href="#cb314-15" tabindex="-1"></a>  <span class="dt">register</span> Lisp_Object <span class="op">*</span>top BC_REG_TOP <span class="op">=</span> NULL<span class="op">;</span></span>
<span id="cb314-16"><a aria-hidden="true" href="#cb314-16" tabindex="-1"></a>  <span class="dt">register</span> <span class="dt">unsigned</span> <span class="dt">char</span> <span class="dt">const</span> <span class="op">*</span>pc BC_REG_PC <span class="op">=</span> NULL<span class="op">;</span></span>
<span id="cb314-17"><a aria-hidden="true" href="#cb314-17" tabindex="-1"></a></span>
<span id="cb314-18"><a aria-hidden="true" href="#cb314-18" tabindex="-1"></a>  Lisp_Object bytestr <span class="op">=</span> AREF <span class="op">(</span>fun<span class="op">,</span> CLOSURE_CODE<span class="op">);</span></span>
<span id="cb314-19"><a aria-hidden="true" href="#cb314-19" tabindex="-1"></a></span>
<span id="cb314-20"><a aria-hidden="true" href="#cb314-20" tabindex="-1"></a>  <span class="co">/* ... setup bytecode stack frame ... */</span></span></code></pre></div>
<h3 data-number="11.7.4" id="bytecode-stack-architecture"><span class="header-section-number">11.7.4</span> 6.4 Bytecode Stack
Architecture</h3>
<p>The bytecode interpreter uses a separate stack for performance:</p>
<p><strong>Location</strong>:
<code>/home/user/emacs/src/bytecode.c:339-377</code></p>
<div class="sourceCode" id="cb315"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb315-1"><a aria-hidden="true" href="#cb315-1" tabindex="-1"></a><span class="co">/* Bytecode interpreter stack:</span></span>
<span id="cb315-2"><a aria-hidden="true" href="#cb315-2" tabindex="-1"></a></span>
<span id="cb315-3"><a aria-hidden="true" href="#cb315-3" tabindex="-1"></a><span class="co">           |--------------|         --</span></span>
<span id="cb315-4"><a aria-hidden="true" href="#cb315-4" tabindex="-1"></a><span class="co">           |fun           |           |                   ^ stack growth</span></span>
<span id="cb315-5"><a aria-hidden="true" href="#cb315-5" tabindex="-1"></a><span class="co">           |saved_pc      |           |                   | direction</span></span>
<span id="cb315-6"><a aria-hidden="true" href="#cb315-6" tabindex="-1"></a><span class="co">           |saved_top    -------      |</span></span>
<span id="cb315-7"><a aria-hidden="true" href="#cb315-7" tabindex="-1"></a><span class="co">     fp---&gt;|saved_fp     ----   |     | current frame</span></span>
<span id="cb315-8"><a aria-hidden="true" href="#cb315-8" tabindex="-1"></a><span class="co">           |--------------|  |  |     | (called from bytecode in this example)</span></span>
<span id="cb315-9"><a aria-hidden="true" href="#cb315-9" tabindex="-1"></a><span class="co">           |   (free)     |  |  |     |</span></span>
<span id="cb315-10"><a aria-hidden="true" href="#cb315-10" tabindex="-1"></a><span class="co">     top--&gt;| ...stack...  |  |  |     |</span></span>
<span id="cb315-11"><a aria-hidden="true" href="#cb315-11" tabindex="-1"></a><span class="co">           : ...          :  |  |     |</span></span>
<span id="cb315-12"><a aria-hidden="true" href="#cb315-12" tabindex="-1"></a><span class="co">           |incoming args |  |  |     |</span></span>
<span id="cb315-13"><a aria-hidden="true" href="#cb315-13" tabindex="-1"></a><span class="co">           |--------------|  |  |   --</span></span>
<span id="cb315-14"><a aria-hidden="true" href="#cb315-14" tabindex="-1"></a><span class="co">           |fun           |  |  |     |</span></span>
<span id="cb315-15"><a aria-hidden="true" href="#cb315-15" tabindex="-1"></a><span class="co">           |saved_pc      |  |  |     |</span></span>
<span id="cb315-16"><a aria-hidden="true" href="#cb315-16" tabindex="-1"></a><span class="co">           |saved_top     |  |  |     |</span></span>
<span id="cb315-17"><a aria-hidden="true" href="#cb315-17" tabindex="-1"></a><span class="co">           |saved_fp      |&lt;-   |     | previous frame</span></span>
<span id="cb315-18"><a aria-hidden="true" href="#cb315-18" tabindex="-1"></a><span class="co">           |--------------|     |     |</span></span>
<span id="cb315-19"><a aria-hidden="true" href="#cb315-19" tabindex="-1"></a><span class="co">           |   (free)     |     |     |</span></span>
<span id="cb315-20"><a aria-hidden="true" href="#cb315-20" tabindex="-1"></a><span class="co">           | ...stack...  |&lt;----      |</span></span>
<span id="cb315-21"><a aria-hidden="true" href="#cb315-21" tabindex="-1"></a><span class="co">           : ...          :           |</span></span>
<span id="cb315-22"><a aria-hidden="true" href="#cb315-22" tabindex="-1"></a><span class="co">           |incoming args |           |</span></span>
<span id="cb315-23"><a aria-hidden="true" href="#cb315-23" tabindex="-1"></a><span class="co">           |--------------|         --</span></span>
<span id="cb315-24"><a aria-hidden="true" href="#cb315-24" tabindex="-1"></a><span class="co">           :              :</span></span>
<span id="cb315-25"><a aria-hidden="true" href="#cb315-25" tabindex="-1"></a><span class="co">*/</span></span>
<span id="cb315-26"><a aria-hidden="true" href="#cb315-26" tabindex="-1"></a></span>
<span id="cb315-27"><a aria-hidden="true" href="#cb315-27" tabindex="-1"></a><span class="kw">struct</span> bc_frame <span class="op">{</span></span>
<span id="cb315-28"><a aria-hidden="true" href="#cb315-28" tabindex="-1"></a>  <span class="kw">struct</span> bc_frame <span class="op">*</span>saved_fp<span class="op">;</span>        <span class="co">/* previous frame pointer */</span></span>
<span id="cb315-29"><a aria-hidden="true" href="#cb315-29" tabindex="-1"></a>  Lisp_Object <span class="op">*</span>saved_top<span class="op">;</span>           <span class="co">/* previous stack pointer */</span></span>
<span id="cb315-30"><a aria-hidden="true" href="#cb315-30" tabindex="-1"></a>  <span class="dt">const</span> <span class="dt">unsigned</span> <span class="dt">char</span> <span class="op">*</span>saved_pc<span class="op">;</span>    <span class="co">/* previous program counter */</span></span>
<span id="cb315-31"><a aria-hidden="true" href="#cb315-31" tabindex="-1"></a>  Lisp_Object fun<span class="op">;</span>                  <span class="co">/* current function object */</span></span>
<span id="cb315-32"><a aria-hidden="true" href="#cb315-32" tabindex="-1"></a>  Lisp_Object next_stack<span class="op">[];</span>         <span class="co">/* data stack of next frame */</span></span>
<span id="cb315-33"><a aria-hidden="true" href="#cb315-33" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<p><strong>Design Choice</strong>: A separate stack for bytecode
(instead of using the C stack) allows: - <strong>Faster function
calls</strong>: No C calling convention overhead - <strong>Tail call
optimization</strong>: Can reuse stack frames - <strong>Better GC
integration</strong>: Precise scanning of Lisp objects</p>
<h3 data-number="11.7.5" id="sample-bytecode-operations"><span class="header-section-number">11.7.5</span> 6.5 Sample Bytecode
Operations</h3>
<p><strong>Location</strong>:
<code>/home/user/emacs/src/bytecode.c:73-200</code></p>
<div class="sourceCode" id="cb316"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb316-1"><a aria-hidden="true" href="#cb316-1" tabindex="-1"></a><span class="pp">#define BYTE_CODES                                                      </span><span class="op">\</span></span>
<span id="cb316-2"><a aria-hidden="true" href="#cb316-2" tabindex="-1"></a><span class="pp">DEFINE </span><span class="op">(</span><span class="pp">Bstack_ref</span><span class="op">,</span><span class="pp"> </span><span class="dv">0</span><span class="op">)</span><span class="pp">   </span><span class="co">/* reference stack[n] */</span><span class="pp">                      </span><span class="op">\</span></span>
<span id="cb316-3"><a aria-hidden="true" href="#cb316-3" tabindex="-1"></a><span class="pp">DEFINE </span><span class="op">(</span><span class="pp">Bvarref</span><span class="op">,</span><span class="pp"> </span><span class="bn">010</span><span class="op">)</span><span class="pp">    </span><span class="co">/* varref symbol in constants[n] */</span><span class="pp">           </span><span class="op">\</span></span>
<span id="cb316-4"><a aria-hidden="true" href="#cb316-4" tabindex="-1"></a><span class="pp">DEFINE </span><span class="op">(</span><span class="pp">Bvarset</span><span class="op">,</span><span class="pp"> </span><span class="bn">020</span><span class="op">)</span><span class="pp">    </span><span class="co">/* varset symbol in constants[n] */</span><span class="pp">           </span><span class="op">\</span></span>
<span id="cb316-5"><a aria-hidden="true" href="#cb316-5" tabindex="-1"></a><span class="pp">DEFINE </span><span class="op">(</span><span class="pp">Bvarbind</span><span class="op">,</span><span class="pp"> </span><span class="bn">030</span><span class="op">)</span><span class="pp">   </span><span class="co">/* bind symbol in constants[n] */</span><span class="pp">             </span><span class="op">\</span></span>
<span id="cb316-6"><a aria-hidden="true" href="#cb316-6" tabindex="-1"></a><span class="pp">DEFINE </span><span class="op">(</span><span class="pp">Bcall</span><span class="op">,</span><span class="pp"> </span><span class="bn">040</span><span class="op">)</span><span class="pp">      </span><span class="co">/* call function with n args from stack */</span><span class="pp">    </span><span class="op">\</span></span>
<span id="cb316-7"><a aria-hidden="true" href="#cb316-7" tabindex="-1"></a><span class="pp">DEFINE </span><span class="op">(</span><span class="pp">Bunbind</span><span class="op">,</span><span class="pp"> </span><span class="bn">050</span><span class="op">)</span><span class="pp">    </span><span class="co">/* unbind n local variables */</span><span class="pp">                </span><span class="op">\</span></span>
<span id="cb316-8"><a aria-hidden="true" href="#cb316-8" tabindex="-1"></a><span class="pp">                                                                        </span><span class="op">\</span></span>
<span id="cb316-9"><a aria-hidden="true" href="#cb316-9" tabindex="-1"></a><span class="pp">DEFINE </span><span class="op">(</span><span class="pp">Bpushconditioncase</span><span class="op">,</span><span class="pp"> </span><span class="bn">061</span><span class="op">)</span><span class="pp">  </span><span class="co">/* push condition handler */</span><span class="pp">         </span><span class="op">\</span></span>
<span id="cb316-10"><a aria-hidden="true" href="#cb316-10" tabindex="-1"></a><span class="pp">DEFINE </span><span class="op">(</span><span class="pp">Bpushcatch</span><span class="op">,</span><span class="pp"> </span><span class="bn">062</span><span class="op">)</span><span class="pp">          </span><span class="co">/* push catch tag */</span><span class="pp">                 </span><span class="op">\</span></span>
<span id="cb316-11"><a aria-hidden="true" href="#cb316-11" tabindex="-1"></a><span class="pp">                                                                        </span><span class="op">\</span></span>
<span id="cb316-12"><a aria-hidden="true" href="#cb316-12" tabindex="-1"></a><span class="pp">DEFINE </span><span class="op">(</span><span class="pp">Bcar</span><span class="op">,</span><span class="pp"> </span><span class="bn">0100</span><span class="op">)</span><span class="pp">      </span><span class="co">/* (car top) */</span><span class="pp">                               </span><span class="op">\</span></span>
<span id="cb316-13"><a aria-hidden="true" href="#cb316-13" tabindex="-1"></a><span class="pp">DEFINE </span><span class="op">(</span><span class="pp">Bcdr</span><span class="op">,</span><span class="pp"> </span><span class="bn">0101</span><span class="op">)</span><span class="pp">      </span><span class="co">/* (cdr top) */</span><span class="pp">                               </span><span class="op">\</span></span>
<span id="cb316-14"><a aria-hidden="true" href="#cb316-14" tabindex="-1"></a><span class="pp">DEFINE </span><span class="op">(</span><span class="pp">Bcons</span><span class="op">,</span><span class="pp"> </span><span class="bn">0102</span><span class="op">)</span><span class="pp">     </span><span class="co">/* (cons top top-1) */</span><span class="pp">                        </span><span class="op">\</span></span>
<span id="cb316-15"><a aria-hidden="true" href="#cb316-15" tabindex="-1"></a><span class="pp">DEFINE </span><span class="op">(</span><span class="pp">Blist1</span><span class="op">,</span><span class="pp"> </span><span class="bn">0103</span><span class="op">)</span><span class="pp">    </span><span class="co">/* (list top) */</span><span class="pp">                              </span><span class="op">\</span></span>
<span id="cb316-16"><a aria-hidden="true" href="#cb316-16" tabindex="-1"></a><span class="co">/* ... many more opcodes ... */</span></span></code></pre></div>
<p><strong>Example: Bytecode for <code>(+ x 1)</code></strong></p>
<p>Assuming <code>x</code> is lexically bound:</p>
<pre><code>Bstack-ref 0     ; Push x onto stack
Bconstant 1      ; Push constant 1
Bplus            ; Call + with 2 args from stack
Breturn          ; Return top of stack</code></pre>
<hr/>
<h2 data-number="11.8" id="native-compilation-3"><span class="header-section-number">11.8</span> 7. Native Compilation</h2>
<h3 data-number="11.8.1" id="overview-2"><span class="header-section-number">11.8.1</span> 7.1 Overview</h3>
<p>Emacs 28+ supports native compilation via libgccjit, compiling Lisp
to native machine code.</p>
<p><strong>Location</strong>:
<code>/home/user/emacs/src/comp.c:1-200</code></p>
<div class="sourceCode" id="cb318"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb318-1"><a aria-hidden="true" href="#cb318-1" tabindex="-1"></a><span class="co">/* Compile Emacs Lisp into native code.</span></span>
<span id="cb318-2"><a aria-hidden="true" href="#cb318-2" tabindex="-1"></a><span class="co">   Copyright (C) 2019-2025 Free Software Foundation, Inc.</span></span>
<span id="cb318-3"><a aria-hidden="true" href="#cb318-3" tabindex="-1"></a></span>
<span id="cb318-4"><a aria-hidden="true" href="#cb318-4" tabindex="-1"></a><span class="co">Author: Andrea Corallo &lt;acorallo@gnu.org&gt;</span></span>
<span id="cb318-5"><a aria-hidden="true" href="#cb318-5" tabindex="-1"></a></span>
<span id="cb318-6"><a aria-hidden="true" href="#cb318-6" tabindex="-1"></a><span class="co">This file is part of GNU Emacs.</span></span>
<span id="cb318-7"><a aria-hidden="true" href="#cb318-7" tabindex="-1"></a><span class="co">*/</span></span>
<span id="cb318-8"><a aria-hidden="true" href="#cb318-8" tabindex="-1"></a></span>
<span id="cb318-9"><a aria-hidden="true" href="#cb318-9" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;config.h&gt;</span></span>
<span id="cb318-10"><a aria-hidden="true" href="#cb318-10" tabindex="-1"></a><span class="pp">#include </span><span class="im">"lisp.h"</span></span>
<span id="cb318-11"><a aria-hidden="true" href="#cb318-11" tabindex="-1"></a></span>
<span id="cb318-12"><a aria-hidden="true" href="#cb318-12" tabindex="-1"></a><span class="pp">#ifdef HAVE_NATIVE_COMP</span></span>
<span id="cb318-13"><a aria-hidden="true" href="#cb318-13" tabindex="-1"></a></span>
<span id="cb318-14"><a aria-hidden="true" href="#cb318-14" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;setjmp.h&gt;</span></span>
<span id="cb318-15"><a aria-hidden="true" href="#cb318-15" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb318-16"><a aria-hidden="true" href="#cb318-16" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb318-17"><a aria-hidden="true" href="#cb318-17" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;signal.h&gt;</span></span>
<span id="cb318-18"><a aria-hidden="true" href="#cb318-18" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;libgccjit.h&gt;</span></span></code></pre></div>
<h3 data-number="11.8.2" id="native-compiled-functions"><span class="header-section-number">11.8.2</span> 7.2 Native Compiled
Functions</h3>
<p>Native functions use the same <code>Lisp_Subr</code> structure but
with additional metadata:</p>
<p><strong>Location</strong>:
<code>/home/user/emacs/src/lisp.h:2213-2218</code></p>
<div class="sourceCode" id="cb319"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb319-1"><a aria-hidden="true" href="#cb319-1" tabindex="-1"></a><span class="pp">#ifdef HAVE_NATIVE_COMP</span></span>
<span id="cb319-2"><a aria-hidden="true" href="#cb319-2" tabindex="-1"></a>    Lisp_Object native_comp_u<span class="op">;</span>    <span class="co">/* Compilation unit */</span></span>
<span id="cb319-3"><a aria-hidden="true" href="#cb319-3" tabindex="-1"></a>    <span class="dt">char</span> <span class="op">*</span>native_c_name<span class="op">;</span>           <span class="co">/* Name in native code */</span></span>
<span id="cb319-4"><a aria-hidden="true" href="#cb319-4" tabindex="-1"></a>    Lisp_Object lambda_list<span class="op">;</span>       <span class="co">/* Original parameter list */</span></span>
<span id="cb319-5"><a aria-hidden="true" href="#cb319-5" tabindex="-1"></a>    Lisp_Object type<span class="op">;</span>              <span class="co">/* Type information */</span></span>
<span id="cb319-6"><a aria-hidden="true" href="#cb319-6" tabindex="-1"></a><span class="pp">#endif</span></span></code></pre></div>
<p>Native functions are called through the same
<code>funcall_lambda</code> path, but execution jumps directly to
machine code:</p>
<p><strong>Location</strong>:
<code>/home/user/emacs/src/eval.c:3348-3354</code></p>
<div class="sourceCode" id="cb320"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb320-1"><a aria-hidden="true" href="#cb320-1" tabindex="-1"></a><span class="pp">#ifdef HAVE_NATIVE_COMP</span></span>
<span id="cb320-2"><a aria-hidden="true" href="#cb320-2" tabindex="-1"></a>  <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>NATIVE_COMP_FUNCTION_DYNP <span class="op">(</span>fun<span class="op">))</span></span>
<span id="cb320-3"><a aria-hidden="true" href="#cb320-3" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb320-4"><a aria-hidden="true" href="#cb320-4" tabindex="-1"></a>      syms_left <span class="op">=</span> XSUBR <span class="op">(</span>fun<span class="op">)-&gt;</span>lambda_list<span class="op">;</span></span>
<span id="cb320-5"><a aria-hidden="true" href="#cb320-5" tabindex="-1"></a>      lexenv <span class="op">=</span> Qnil<span class="op">;</span></span>
<span id="cb320-6"><a aria-hidden="true" href="#cb320-6" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb320-7"><a aria-hidden="true" href="#cb320-7" tabindex="-1"></a><span class="pp">#endif</span></span></code></pre></div>
<h3 data-number="11.8.3" id="advantages-and-tradeoffs"><span class="header-section-number">11.8.3</span> 7.3 Advantages and
Tradeoffs</h3>
<p><strong>Advantages</strong>: - <strong>10x+ speedup</strong>: Native
code is much faster than bytecode - <strong>Type
specialization</strong>: Can optimize for specific types -
<strong>Inlining</strong>: Cross-function optimization</p>
<p><strong>Tradeoffs</strong>: - <strong>Compilation latency</strong>:
Initial compile can take seconds - <strong>Disk space</strong>: Native
code is larger than bytecode - <strong>Complexity</strong>: Debugging is
harder</p>
<hr/>
<h2 data-number="11.9" id="scoping-and-closures"><span class="header-section-number">11.9</span> 8. Scoping and Closures</h2>
<h3 data-number="11.9.1" id="lexical-vs.-dynamic-scoping"><span class="header-section-number">11.9.1</span> 8.1 Lexical vs.¬†Dynamic
Scoping</h3>
<p>Emacs Lisp supports both:</p>
<ul>
<li><strong>Lexical scoping</strong> (modern, recommended): Variables
capture their definition-time environment</li>
<li><strong>Dynamic scoping</strong> (legacy): Variables look up the
latest binding at runtime</li>
</ul>
<p><strong>Location</strong>:
<code>/home/user/emacs/src/eval.c:2514-2528</code></p>
<div class="sourceCode" id="cb321"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb321-1"><a aria-hidden="true" href="#cb321-1" tabindex="-1"></a>DEFUN <span class="op">(</span><span class="st">"eval"</span><span class="op">,</span> Feval<span class="op">,</span> Seval<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb321-2"><a aria-hidden="true" href="#cb321-2" tabindex="-1"></a>       doc<span class="op">:</span> <span class="co">/* Evaluate FORM and return its value.</span></span>
<span id="cb321-3"><a aria-hidden="true" href="#cb321-3" tabindex="-1"></a><span class="co">If LEXICAL is `t', evaluate using lexical binding by default.</span></span>
<span id="cb321-4"><a aria-hidden="true" href="#cb321-4" tabindex="-1"></a><span class="co">This is the recommended value.</span></span>
<span id="cb321-5"><a aria-hidden="true" href="#cb321-5" tabindex="-1"></a></span>
<span id="cb321-6"><a aria-hidden="true" href="#cb321-6" tabindex="-1"></a><span class="co">If absent or `nil', use dynamic scoping only.</span></span>
<span id="cb321-7"><a aria-hidden="true" href="#cb321-7" tabindex="-1"></a></span>
<span id="cb321-8"><a aria-hidden="true" href="#cb321-8" tabindex="-1"></a><span class="co">LEXICAL can also represent an actual lexical environment; see the Info</span></span>
<span id="cb321-9"><a aria-hidden="true" href="#cb321-9" tabindex="-1"></a><span class="co">node `(elisp)Eval' for details.  */</span><span class="op">)</span></span>
<span id="cb321-10"><a aria-hidden="true" href="#cb321-10" tabindex="-1"></a>  <span class="op">(</span>Lisp_Object form<span class="op">,</span> Lisp_Object lexical<span class="op">)</span></span>
<span id="cb321-11"><a aria-hidden="true" href="#cb321-11" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb321-12"><a aria-hidden="true" href="#cb321-12" tabindex="-1"></a>  specpdl_ref count <span class="op">=</span> SPECPDL_INDEX <span class="op">();</span></span>
<span id="cb321-13"><a aria-hidden="true" href="#cb321-13" tabindex="-1"></a>  specbind <span class="op">(</span>Qinternal_interpreter_environment<span class="op">,</span></span>
<span id="cb321-14"><a aria-hidden="true" href="#cb321-14" tabindex="-1"></a>            CONSP <span class="op">(</span>lexical<span class="op">)</span> <span class="op">||</span> NILP <span class="op">(</span>lexical<span class="op">)</span> <span class="op">?</span> lexical <span class="op">:</span> list_of_t<span class="op">);</span></span>
<span id="cb321-15"><a aria-hidden="true" href="#cb321-15" tabindex="-1"></a>  <span class="cf">return</span> unbind_to <span class="op">(</span>count<span class="op">,</span> eval_sub <span class="op">(</span>form<span class="op">));</span></span>
<span id="cb321-16"><a aria-hidden="true" href="#cb321-16" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>The lexical environment is stored in
<code>Vinternal_interpreter_environment</code>, which is an association
list of <code>(symbol . value)</code> pairs.</p>
<h3 data-number="11.9.2" id="variable-lookup"><span class="header-section-number">11.9.2</span> 8.2 Variable Lookup</h3>
<p><strong>Location</strong>:
<code>/home/user/emacs/src/eval.c:2553-2560</code></p>
<div class="sourceCode" id="cb322"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb322-1"><a aria-hidden="true" href="#cb322-1" tabindex="-1"></a><span class="cf">if</span> <span class="op">(</span>SYMBOLP <span class="op">(</span>form<span class="op">))</span></span>
<span id="cb322-2"><a aria-hidden="true" href="#cb322-2" tabindex="-1"></a>  <span class="op">{</span></span>
<span id="cb322-3"><a aria-hidden="true" href="#cb322-3" tabindex="-1"></a>    <span class="co">/* Look up its binding in the lexical environment.</span></span>
<span id="cb322-4"><a aria-hidden="true" href="#cb322-4" tabindex="-1"></a><span class="co">       We do not pay attention to the declared_special flag here, since we</span></span>
<span id="cb322-5"><a aria-hidden="true" href="#cb322-5" tabindex="-1"></a><span class="co">       already did that when let-binding the variable.  */</span></span>
<span id="cb322-6"><a aria-hidden="true" href="#cb322-6" tabindex="-1"></a>    Lisp_Object lex_binding</span>
<span id="cb322-7"><a aria-hidden="true" href="#cb322-7" tabindex="-1"></a>      <span class="op">=</span> Fassq <span class="op">(</span>form<span class="op">,</span> Vinternal_interpreter_environment<span class="op">);</span></span>
<span id="cb322-8"><a aria-hidden="true" href="#cb322-8" tabindex="-1"></a>    <span class="cf">return</span> <span class="op">!</span>NILP <span class="op">(</span>lex_binding<span class="op">)</span> <span class="op">?</span> XCDR <span class="op">(</span>lex_binding<span class="op">)</span> <span class="op">:</span> Fsymbol_value <span class="op">(</span>form<span class="op">);</span></span>
<span id="cb322-9"><a aria-hidden="true" href="#cb322-9" tabindex="-1"></a>  <span class="op">}</span></span></code></pre></div>
<p><strong>Lookup Order</strong>: 1. Check lexical environment (alist
lookup) 2. If not found, check symbol‚Äôs value cell (dynamic binding)</p>
<h3 data-number="11.9.3" id="creating-closures-funcall_lambda"><span class="header-section-number">11.9.3</span> 8.3 Creating Closures:
funcall_lambda</h3>
<p><strong>Location</strong>:
<code>/home/user/emacs/src/eval.c:3316-3421</code></p>
<div class="sourceCode" id="cb323"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb323-1"><a aria-hidden="true" href="#cb323-1" tabindex="-1"></a><span class="dt">static</span> Lisp_Object</span>
<span id="cb323-2"><a aria-hidden="true" href="#cb323-2" tabindex="-1"></a>funcall_lambda <span class="op">(</span>Lisp_Object fun<span class="op">,</span> <span class="dt">ptrdiff_t</span> nargs<span class="op">,</span> Lisp_Object <span class="op">*</span>arg_vector<span class="op">)</span></span>
<span id="cb323-3"><a aria-hidden="true" href="#cb323-3" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb323-4"><a aria-hidden="true" href="#cb323-4" tabindex="-1"></a>  Lisp_Object syms_left<span class="op">,</span> lexenv<span class="op">;</span></span>
<span id="cb323-5"><a aria-hidden="true" href="#cb323-5" tabindex="-1"></a></span>
<span id="cb323-6"><a aria-hidden="true" href="#cb323-6" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>CONSP <span class="op">(</span>fun<span class="op">))</span></span>
<span id="cb323-7"><a aria-hidden="true" href="#cb323-7" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb323-8"><a aria-hidden="true" href="#cb323-8" tabindex="-1"></a>      <span class="co">/* Interpreted lambda */</span></span>
<span id="cb323-9"><a aria-hidden="true" href="#cb323-9" tabindex="-1"></a>      lexenv <span class="op">=</span> Qnil<span class="op">;</span></span>
<span id="cb323-10"><a aria-hidden="true" href="#cb323-10" tabindex="-1"></a>      syms_left <span class="op">=</span> XCDR <span class="op">(</span>fun<span class="op">);</span></span>
<span id="cb323-11"><a aria-hidden="true" href="#cb323-11" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span>CONSP <span class="op">(</span>syms_left<span class="op">))</span></span>
<span id="cb323-12"><a aria-hidden="true" href="#cb323-12" tabindex="-1"></a>        syms_left <span class="op">=</span> XCAR <span class="op">(</span>syms_left<span class="op">);</span>  <span class="co">// Parameter list</span></span>
<span id="cb323-13"><a aria-hidden="true" href="#cb323-13" tabindex="-1"></a>      <span class="cf">else</span></span>
<span id="cb323-14"><a aria-hidden="true" href="#cb323-14" tabindex="-1"></a>        xsignal1 <span class="op">(</span>Qinvalid_function<span class="op">,</span> fun<span class="op">);</span></span>
<span id="cb323-15"><a aria-hidden="true" href="#cb323-15" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb323-16"><a aria-hidden="true" href="#cb323-16" tabindex="-1"></a>  <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>CLOSUREP <span class="op">(</span>fun<span class="op">))</span></span>
<span id="cb323-17"><a aria-hidden="true" href="#cb323-17" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb323-18"><a aria-hidden="true" href="#cb323-18" tabindex="-1"></a>      syms_left <span class="op">=</span> AREF <span class="op">(</span>fun<span class="op">,</span> CLOSURE_ARGLIST<span class="op">);</span></span>
<span id="cb323-19"><a aria-hidden="true" href="#cb323-19" tabindex="-1"></a>      <span class="co">/* Bytecode objects using lexical binding have an integral</span></span>
<span id="cb323-20"><a aria-hidden="true" href="#cb323-20" tabindex="-1"></a><span class="co">         ARGLIST slot value */</span></span>
<span id="cb323-21"><a aria-hidden="true" href="#cb323-21" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span>FIXNUMP <span class="op">(</span>syms_left<span class="op">))</span></span>
<span id="cb323-22"><a aria-hidden="true" href="#cb323-22" tabindex="-1"></a>        <span class="cf">return</span> exec_byte_code <span class="op">(</span>fun<span class="op">,</span> XFIXNUM <span class="op">(</span>syms_left<span class="op">),</span> nargs<span class="op">,</span> arg_vector<span class="op">);</span></span>
<span id="cb323-23"><a aria-hidden="true" href="#cb323-23" tabindex="-1"></a>      <span class="co">/* Otherwise the closure either is interpreted</span></span>
<span id="cb323-24"><a aria-hidden="true" href="#cb323-24" tabindex="-1"></a><span class="co">         or uses dynamic binding */</span></span>
<span id="cb323-25"><a aria-hidden="true" href="#cb323-25" tabindex="-1"></a>      lexenv <span class="op">=</span> CONSP <span class="op">(</span>AREF <span class="op">(</span>fun<span class="op">,</span> CLOSURE_CODE<span class="op">))</span></span>
<span id="cb323-26"><a aria-hidden="true" href="#cb323-26" tabindex="-1"></a>               <span class="op">?</span> AREF <span class="op">(</span>fun<span class="op">,</span> CLOSURE_CONSTANTS<span class="op">)</span></span>
<span id="cb323-27"><a aria-hidden="true" href="#cb323-27" tabindex="-1"></a>               <span class="op">:</span> Qnil<span class="op">;</span></span>
<span id="cb323-28"><a aria-hidden="true" href="#cb323-28" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb323-29"><a aria-hidden="true" href="#cb323-29" tabindex="-1"></a></span>
<span id="cb323-30"><a aria-hidden="true" href="#cb323-30" tabindex="-1"></a>  <span class="co">/* Bind parameters to arguments */</span></span>
<span id="cb323-31"><a aria-hidden="true" href="#cb323-31" tabindex="-1"></a>  specpdl_ref count <span class="op">=</span> SPECPDL_INDEX <span class="op">();</span></span>
<span id="cb323-32"><a aria-hidden="true" href="#cb323-32" tabindex="-1"></a>  <span class="dt">ptrdiff_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb323-33"><a aria-hidden="true" href="#cb323-33" tabindex="-1"></a>  <span class="dt">bool</span> optional <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb323-34"><a aria-hidden="true" href="#cb323-34" tabindex="-1"></a>  <span class="dt">bool</span> rest <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb323-35"><a aria-hidden="true" href="#cb323-35" tabindex="-1"></a>  <span class="dt">bool</span> previous_rest <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb323-36"><a aria-hidden="true" href="#cb323-36" tabindex="-1"></a></span>
<span id="cb323-37"><a aria-hidden="true" href="#cb323-37" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(;</span> CONSP <span class="op">(</span>syms_left<span class="op">);</span> syms_left <span class="op">=</span> XCDR <span class="op">(</span>syms_left<span class="op">))</span></span>
<span id="cb323-38"><a aria-hidden="true" href="#cb323-38" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb323-39"><a aria-hidden="true" href="#cb323-39" tabindex="-1"></a>      Lisp_Object next <span class="op">=</span> XCAR <span class="op">(</span>syms_left<span class="op">);</span></span>
<span id="cb323-40"><a aria-hidden="true" href="#cb323-40" tabindex="-1"></a></span>
<span id="cb323-41"><a aria-hidden="true" href="#cb323-41" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span>BASE_EQ <span class="op">(</span>next<span class="op">,</span> Qand_rest<span class="op">))</span></span>
<span id="cb323-42"><a aria-hidden="true" href="#cb323-42" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb323-43"><a aria-hidden="true" href="#cb323-43" tabindex="-1"></a>          rest <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb323-44"><a aria-hidden="true" href="#cb323-44" tabindex="-1"></a>          previous_rest <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb323-45"><a aria-hidden="true" href="#cb323-45" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb323-46"><a aria-hidden="true" href="#cb323-46" tabindex="-1"></a>      <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>BASE_EQ <span class="op">(</span>next<span class="op">,</span> Qand_optional<span class="op">))</span></span>
<span id="cb323-47"><a aria-hidden="true" href="#cb323-47" tabindex="-1"></a>        optional <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb323-48"><a aria-hidden="true" href="#cb323-48" tabindex="-1"></a>      <span class="cf">else</span></span>
<span id="cb323-49"><a aria-hidden="true" href="#cb323-49" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb323-50"><a aria-hidden="true" href="#cb323-50" tabindex="-1"></a>          Lisp_Object arg<span class="op">;</span></span>
<span id="cb323-51"><a aria-hidden="true" href="#cb323-51" tabindex="-1"></a>          <span class="cf">if</span> <span class="op">(</span>rest<span class="op">)</span></span>
<span id="cb323-52"><a aria-hidden="true" href="#cb323-52" tabindex="-1"></a>            <span class="op">{</span></span>
<span id="cb323-53"><a aria-hidden="true" href="#cb323-53" tabindex="-1"></a>              arg <span class="op">=</span> Flist <span class="op">(</span>nargs <span class="op">-</span> i<span class="op">,</span> <span class="op">&amp;</span>arg_vector<span class="op">[</span>i<span class="op">]);</span></span>
<span id="cb323-54"><a aria-hidden="true" href="#cb323-54" tabindex="-1"></a>              i <span class="op">=</span> nargs<span class="op">;</span></span>
<span id="cb323-55"><a aria-hidden="true" href="#cb323-55" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb323-56"><a aria-hidden="true" href="#cb323-56" tabindex="-1"></a>          <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>i <span class="op">&lt;</span> nargs<span class="op">)</span></span>
<span id="cb323-57"><a aria-hidden="true" href="#cb323-57" tabindex="-1"></a>            arg <span class="op">=</span> arg_vector<span class="op">[</span>i<span class="op">++];</span></span>
<span id="cb323-58"><a aria-hidden="true" href="#cb323-58" tabindex="-1"></a>          <span class="cf">else</span> <span class="cf">if</span> <span class="op">(!</span>optional<span class="op">)</span></span>
<span id="cb323-59"><a aria-hidden="true" href="#cb323-59" tabindex="-1"></a>            xsignal2 <span class="op">(</span>Qwrong_number_of_arguments<span class="op">,</span> fun<span class="op">,</span> make_fixnum <span class="op">(</span>nargs<span class="op">));</span></span>
<span id="cb323-60"><a aria-hidden="true" href="#cb323-60" tabindex="-1"></a>          <span class="cf">else</span></span>
<span id="cb323-61"><a aria-hidden="true" href="#cb323-61" tabindex="-1"></a>            arg <span class="op">=</span> Qnil<span class="op">;</span></span>
<span id="cb323-62"><a aria-hidden="true" href="#cb323-62" tabindex="-1"></a></span>
<span id="cb323-63"><a aria-hidden="true" href="#cb323-63" tabindex="-1"></a>          <span class="co">/* Bind the argument.  */</span></span>
<span id="cb323-64"><a aria-hidden="true" href="#cb323-64" tabindex="-1"></a>          <span class="cf">if</span> <span class="op">(!</span>NILP <span class="op">(</span>lexenv<span class="op">))</span></span>
<span id="cb323-65"><a aria-hidden="true" href="#cb323-65" tabindex="-1"></a>            <span class="co">/* Lexically bind NEXT by adding it to the lexenv alist.  */</span></span>
<span id="cb323-66"><a aria-hidden="true" href="#cb323-66" tabindex="-1"></a>            lexenv <span class="op">=</span> Fcons <span class="op">(</span>Fcons <span class="op">(</span>next<span class="op">,</span> arg<span class="op">),</span> lexenv<span class="op">);</span></span>
<span id="cb323-67"><a aria-hidden="true" href="#cb323-67" tabindex="-1"></a>          <span class="cf">else</span></span>
<span id="cb323-68"><a aria-hidden="true" href="#cb323-68" tabindex="-1"></a>            <span class="co">/* Dynamically bind NEXT.  */</span></span>
<span id="cb323-69"><a aria-hidden="true" href="#cb323-69" tabindex="-1"></a>            specbind <span class="op">(</span>next<span class="op">,</span> arg<span class="op">);</span></span>
<span id="cb323-70"><a aria-hidden="true" href="#cb323-70" tabindex="-1"></a>          previous_rest <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb323-71"><a aria-hidden="true" href="#cb323-71" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb323-72"><a aria-hidden="true" href="#cb323-72" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb323-73"><a aria-hidden="true" href="#cb323-73" tabindex="-1"></a></span>
<span id="cb323-74"><a aria-hidden="true" href="#cb323-74" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(!</span>BASE_EQ <span class="op">(</span>lexenv<span class="op">,</span> Vinternal_interpreter_environment<span class="op">))</span></span>
<span id="cb323-75"><a aria-hidden="true" href="#cb323-75" tabindex="-1"></a>    <span class="co">/* Instantiate a new lexical environment.  */</span></span>
<span id="cb323-76"><a aria-hidden="true" href="#cb323-76" tabindex="-1"></a>    specbind <span class="op">(</span>Qinternal_interpreter_environment<span class="op">,</span> lexenv<span class="op">);</span></span>
<span id="cb323-77"><a aria-hidden="true" href="#cb323-77" tabindex="-1"></a></span>
<span id="cb323-78"><a aria-hidden="true" href="#cb323-78" tabindex="-1"></a>  Lisp_Object val<span class="op">;</span></span>
<span id="cb323-79"><a aria-hidden="true" href="#cb323-79" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>CONSP <span class="op">(</span>fun<span class="op">))</span></span>
<span id="cb323-80"><a aria-hidden="true" href="#cb323-80" tabindex="-1"></a>    val <span class="op">=</span> Fprogn <span class="op">(</span>XCDR <span class="op">(</span>XCDR <span class="op">(</span>fun<span class="op">)));</span>  <span class="co">// Evaluate body</span></span>
<span id="cb323-81"><a aria-hidden="true" href="#cb323-81" tabindex="-1"></a>  <span class="co">/* ... bytecode and native paths ... */</span></span>
<span id="cb323-82"><a aria-hidden="true" href="#cb323-82" tabindex="-1"></a></span>
<span id="cb323-83"><a aria-hidden="true" href="#cb323-83" tabindex="-1"></a>  <span class="cf">return</span> unbind_to <span class="op">(</span>count<span class="op">,</span> val<span class="op">);</span></span>
<span id="cb323-84"><a aria-hidden="true" href="#cb323-84" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>Key Points</strong>:</p>
<ol type="1">
<li><strong>Parameter binding</strong>: Match formal parameters to
actual arguments</li>
<li><strong>Lexical binding</strong>: Extends the environment alist</li>
<li><strong>Dynamic binding</strong>: Uses the <code>specpdl</code>
(special variable bindings stack)</li>
<li><strong>&amp;optional and &amp;rest</strong>: Special parameter list
markers</li>
<li><strong>Cleanup</strong>: <code>unbind_to</code> restores previous
bindings</li>
</ol>
<h3 data-number="11.9.4" id="the-specpdl-dynamic-binding-stack"><span class="header-section-number">11.9.4</span> 8.4 The Specpdl: Dynamic
Binding Stack</h3>
<p>The <code>specpdl</code> (special bindings stack) tracks dynamic
variable bindings for cleanup.</p>
<p><strong>Location</strong>:
<code>/home/user/emacs/src/eval.c:3617-3676</code></p>
<div class="sourceCode" id="cb324"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb324-1"><a aria-hidden="true" href="#cb324-1" tabindex="-1"></a><span class="dt">void</span></span>
<span id="cb324-2"><a aria-hidden="true" href="#cb324-2" tabindex="-1"></a>specbind <span class="op">(</span>Lisp_Object symbol<span class="op">,</span> Lisp_Object value<span class="op">)</span></span>
<span id="cb324-3"><a aria-hidden="true" href="#cb324-3" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb324-4"><a aria-hidden="true" href="#cb324-4" tabindex="-1"></a>  <span class="kw">struct</span> Lisp_Symbol <span class="op">*</span>sym <span class="op">=</span> XBARE_SYMBOL <span class="op">(</span>symbol<span class="op">);</span></span>
<span id="cb324-5"><a aria-hidden="true" href="#cb324-5" tabindex="-1"></a></span>
<span id="cb324-6"><a aria-hidden="true" href="#cb324-6" tabindex="-1"></a> start<span class="op">:</span></span>
<span id="cb324-7"><a aria-hidden="true" href="#cb324-7" tabindex="-1"></a>  <span class="cf">switch</span> <span class="op">(</span>sym<span class="op">-&gt;</span>u<span class="op">.</span>s<span class="op">.</span>redirect<span class="op">)</span></span>
<span id="cb324-8"><a aria-hidden="true" href="#cb324-8" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb324-9"><a aria-hidden="true" href="#cb324-9" tabindex="-1"></a>    <span class="cf">case</span> SYMBOL_VARALIAS<span class="op">:</span></span>
<span id="cb324-10"><a aria-hidden="true" href="#cb324-10" tabindex="-1"></a>      sym <span class="op">=</span> SYMBOL_ALIAS <span class="op">(</span>sym<span class="op">);</span></span>
<span id="cb324-11"><a aria-hidden="true" href="#cb324-11" tabindex="-1"></a>      XSETSYMBOL <span class="op">(</span>symbol<span class="op">,</span> sym<span class="op">);</span></span>
<span id="cb324-12"><a aria-hidden="true" href="#cb324-12" tabindex="-1"></a>      <span class="cf">goto</span> start<span class="op">;</span></span>
<span id="cb324-13"><a aria-hidden="true" href="#cb324-13" tabindex="-1"></a></span>
<span id="cb324-14"><a aria-hidden="true" href="#cb324-14" tabindex="-1"></a>    <span class="cf">case</span> SYMBOL_PLAINVAL<span class="op">:</span></span>
<span id="cb324-15"><a aria-hidden="true" href="#cb324-15" tabindex="-1"></a>      <span class="co">/* The most common case is that of a non-constant symbol with a</span></span>
<span id="cb324-16"><a aria-hidden="true" href="#cb324-16" tabindex="-1"></a><span class="co">         trivial value.  Make that as fast as we can.  */</span></span>
<span id="cb324-17"><a aria-hidden="true" href="#cb324-17" tabindex="-1"></a>      specpdl_ptr<span class="op">-&gt;</span>let<span class="op">.</span>kind <span class="op">=</span> SPECPDL_LET<span class="op">;</span></span>
<span id="cb324-18"><a aria-hidden="true" href="#cb324-18" tabindex="-1"></a>      specpdl_ptr<span class="op">-&gt;</span>let<span class="op">.</span>symbol <span class="op">=</span> symbol<span class="op">;</span></span>
<span id="cb324-19"><a aria-hidden="true" href="#cb324-19" tabindex="-1"></a>      specpdl_ptr<span class="op">-&gt;</span>let<span class="op">.</span>old_value <span class="op">=</span> SYMBOL_VAL <span class="op">(</span>sym<span class="op">);</span></span>
<span id="cb324-20"><a aria-hidden="true" href="#cb324-20" tabindex="-1"></a>      specpdl_ptr<span class="op">-&gt;</span>let<span class="op">.</span>where<span class="op">.</span>kbd <span class="op">=</span> NULL<span class="op">;</span></span>
<span id="cb324-21"><a aria-hidden="true" href="#cb324-21" tabindex="-1"></a>      <span class="cf">break</span><span class="op">;</span></span>
<span id="cb324-22"><a aria-hidden="true" href="#cb324-22" tabindex="-1"></a></span>
<span id="cb324-23"><a aria-hidden="true" href="#cb324-23" tabindex="-1"></a>    <span class="cf">case</span> SYMBOL_LOCALIZED<span class="op">:</span></span>
<span id="cb324-24"><a aria-hidden="true" href="#cb324-24" tabindex="-1"></a>    <span class="cf">case</span> SYMBOL_FORWARDED<span class="op">:</span></span>
<span id="cb324-25"><a aria-hidden="true" href="#cb324-25" tabindex="-1"></a>      <span class="op">{</span></span>
<span id="cb324-26"><a aria-hidden="true" href="#cb324-26" tabindex="-1"></a>        Lisp_Object ovalue <span class="op">=</span> find_symbol_value <span class="op">(</span>symbol<span class="op">);</span></span>
<span id="cb324-27"><a aria-hidden="true" href="#cb324-27" tabindex="-1"></a>        specpdl_ptr<span class="op">-&gt;</span>let<span class="op">.</span>kind <span class="op">=</span> SPECPDL_LET_LOCAL<span class="op">;</span></span>
<span id="cb324-28"><a aria-hidden="true" href="#cb324-28" tabindex="-1"></a>        specpdl_ptr<span class="op">-&gt;</span>let<span class="op">.</span>symbol <span class="op">=</span> symbol<span class="op">;</span></span>
<span id="cb324-29"><a aria-hidden="true" href="#cb324-29" tabindex="-1"></a>        specpdl_ptr<span class="op">-&gt;</span>let<span class="op">.</span>old_value <span class="op">=</span> ovalue<span class="op">;</span></span>
<span id="cb324-30"><a aria-hidden="true" href="#cb324-30" tabindex="-1"></a>        specpdl_ptr<span class="op">-&gt;</span>let<span class="op">.</span>where<span class="op">.</span>buf <span class="op">=</span> Fcurrent_buffer <span class="op">();</span></span>
<span id="cb324-31"><a aria-hidden="true" href="#cb324-31" tabindex="-1"></a></span>
<span id="cb324-32"><a aria-hidden="true" href="#cb324-32" tabindex="-1"></a>        <span class="co">/* Handle buffer-local variables */</span></span>
<span id="cb324-33"><a aria-hidden="true" href="#cb324-33" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>sym<span class="op">-&gt;</span>u<span class="op">.</span>s<span class="op">.</span>redirect <span class="op">==</span> SYMBOL_LOCALIZED<span class="op">)</span></span>
<span id="cb324-34"><a aria-hidden="true" href="#cb324-34" tabindex="-1"></a>          <span class="op">{</span></span>
<span id="cb324-35"><a aria-hidden="true" href="#cb324-35" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(!</span>blv_found <span class="op">(</span>SYMBOL_BLV <span class="op">(</span>sym<span class="op">)))</span></span>
<span id="cb324-36"><a aria-hidden="true" href="#cb324-36" tabindex="-1"></a>              specpdl_ptr<span class="op">-&gt;</span>let<span class="op">.</span>kind <span class="op">=</span> SPECPDL_LET_DEFAULT<span class="op">;</span></span>
<span id="cb324-37"><a aria-hidden="true" href="#cb324-37" tabindex="-1"></a>          <span class="op">}</span></span>
<span id="cb324-38"><a aria-hidden="true" href="#cb324-38" tabindex="-1"></a>        <span class="cf">break</span><span class="op">;</span></span>
<span id="cb324-39"><a aria-hidden="true" href="#cb324-39" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb324-40"><a aria-hidden="true" href="#cb324-40" tabindex="-1"></a>    <span class="cf">default</span><span class="op">:</span> emacs_abort <span class="op">();</span></span>
<span id="cb324-41"><a aria-hidden="true" href="#cb324-41" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb324-42"><a aria-hidden="true" href="#cb324-42" tabindex="-1"></a>  grow_specpdl <span class="op">();</span></span>
<span id="cb324-43"><a aria-hidden="true" href="#cb324-43" tabindex="-1"></a>  do_specbind <span class="op">(</span>sym<span class="op">,</span> specpdl_ptr <span class="op">-</span> <span class="dv">1</span><span class="op">,</span> value<span class="op">,</span> SET_INTERNAL_BIND<span class="op">);</span></span>
<span id="cb324-44"><a aria-hidden="true" href="#cb324-44" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>The specpdl is a stack of</strong>: - <strong>Variable
bindings</strong> (<code>SPECPDL_LET</code>) - <strong>Unwind-protect
handlers</strong> (<code>SPECPDL_UNWIND</code>) - <strong>Catch
tags</strong> (<code>SPECPDL_CATCH</code>) - <strong>Condition
handlers</strong> (<code>SPECPDL_HANDLER</code>)</p>
<p>When a function returns or signals an error, <code>unbind_to</code>
walks back the stack, restoring old values and calling cleanup
functions.</p>
<hr/>
<h2 data-number="11.10" id="special-forms-and-macros"><span class="header-section-number">11.10</span> 9. Special Forms and
Macros</h2>
<h3 data-number="11.10.1" id="special-forms"><span class="header-section-number">11.10.1</span> 9.1 Special Forms</h3>
<p>Special forms are built-in functions that receive their arguments
UNEVALUATED, allowing them to control evaluation.</p>
<p><strong>Location</strong>:
<code>/home/user/emacs/src/eval.c:387-402</code></p>
<div class="sourceCode" id="cb325"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb325-1"><a aria-hidden="true" href="#cb325-1" tabindex="-1"></a>DEFUN <span class="op">(</span><span class="st">"if"</span><span class="op">,</span> Fif<span class="op">,</span> Sif<span class="op">,</span> <span class="dv">2</span><span class="op">,</span> UNEVALLED<span class="op">,</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb325-2"><a aria-hidden="true" href="#cb325-2" tabindex="-1"></a>       doc<span class="op">:</span> <span class="co">/* If COND yields non-nil, do THEN, else do ELSE...</span></span>
<span id="cb325-3"><a aria-hidden="true" href="#cb325-3" tabindex="-1"></a><span class="co">Returns the value of THEN or the value of the last of the ELSE's.</span></span>
<span id="cb325-4"><a aria-hidden="true" href="#cb325-4" tabindex="-1"></a><span class="co">THEN must be one expression, but ELSE... can be zero or more expressions.</span></span>
<span id="cb325-5"><a aria-hidden="true" href="#cb325-5" tabindex="-1"></a><span class="co">If COND yields nil, and there are no ELSE's, the value is nil.</span></span>
<span id="cb325-6"><a aria-hidden="true" href="#cb325-6" tabindex="-1"></a><span class="co">usage: (if COND THEN ELSE...)  */</span><span class="op">)</span></span>
<span id="cb325-7"><a aria-hidden="true" href="#cb325-7" tabindex="-1"></a>  <span class="op">(</span>Lisp_Object args<span class="op">)</span></span>
<span id="cb325-8"><a aria-hidden="true" href="#cb325-8" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb325-9"><a aria-hidden="true" href="#cb325-9" tabindex="-1"></a>  Lisp_Object cond<span class="op">;</span></span>
<span id="cb325-10"><a aria-hidden="true" href="#cb325-10" tabindex="-1"></a></span>
<span id="cb325-11"><a aria-hidden="true" href="#cb325-11" tabindex="-1"></a>  cond <span class="op">=</span> eval_sub <span class="op">(</span>XCAR <span class="op">(</span>args<span class="op">));</span></span>
<span id="cb325-12"><a aria-hidden="true" href="#cb325-12" tabindex="-1"></a></span>
<span id="cb325-13"><a aria-hidden="true" href="#cb325-13" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(!</span>NILP <span class="op">(</span>cond<span class="op">))</span></span>
<span id="cb325-14"><a aria-hidden="true" href="#cb325-14" tabindex="-1"></a>    <span class="cf">return</span> eval_sub <span class="op">(</span>Fcar <span class="op">(</span>XCDR <span class="op">(</span>args<span class="op">)));</span></span>
<span id="cb325-15"><a aria-hidden="true" href="#cb325-15" tabindex="-1"></a>  <span class="cf">return</span> Fprogn <span class="op">(</span>Fcdr <span class="op">(</span>XCDR <span class="op">(</span>args<span class="op">)));</span></span>
<span id="cb325-16"><a aria-hidden="true" href="#cb325-16" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>Key</strong>: <code>maxargs = UNEVALLED</code> means
arguments arrive as a list, not evaluated. The special form controls
when/if to call <code>eval_sub</code> on them.</p>
<p><strong>Other special forms</strong>: - <strong>quote</strong>:
Returns argument without evaluating - <strong>function</strong>: Returns
function object - <strong>let</strong>: Binds variables in a new scope -
<strong>cond</strong>: Multi-way conditional - <strong>while</strong>:
Looping - <strong>catch/throw</strong>: Non-local exits</p>
<p><strong>Location</strong>:
<code>/home/user/emacs/src/eval.c:508-519</code></p>
<div class="sourceCode" id="cb326"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb326-1"><a aria-hidden="true" href="#cb326-1" tabindex="-1"></a>DEFUN <span class="op">(</span><span class="st">"quote"</span><span class="op">,</span> Fquote<span class="op">,</span> Squote<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> UNEVALLED<span class="op">,</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb326-2"><a aria-hidden="true" href="#cb326-2" tabindex="-1"></a>       doc<span class="op">:</span> <span class="co">/* Return the argument, without evaluating it.  `(quote x)' yields `x'.</span></span>
<span id="cb326-3"><a aria-hidden="true" href="#cb326-3" tabindex="-1"></a><span class="co">Warning: `quote' does not construct its return value, but just returns</span></span>
<span id="cb326-4"><a aria-hidden="true" href="#cb326-4" tabindex="-1"></a><span class="co">the value that was pre-constructed by the Lisp reader...</span></span>
<span id="cb326-5"><a aria-hidden="true" href="#cb326-5" tabindex="-1"></a><span class="co">usage: (quote ARG)  */</span><span class="op">)</span></span>
<span id="cb326-6"><a aria-hidden="true" href="#cb326-6" tabindex="-1"></a>  <span class="op">(</span>Lisp_Object args<span class="op">)</span></span>
<span id="cb326-7"><a aria-hidden="true" href="#cb326-7" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb326-8"><a aria-hidden="true" href="#cb326-8" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(!</span>NILP <span class="op">(</span>XCDR <span class="op">(</span>args<span class="op">)))</span></span>
<span id="cb326-9"><a aria-hidden="true" href="#cb326-9" tabindex="-1"></a>    xsignal2 <span class="op">(</span>Qwrong_number_of_arguments<span class="op">,</span> Qquote<span class="op">,</span> Flist_length <span class="op">(</span>args<span class="op">));</span></span>
<span id="cb326-10"><a aria-hidden="true" href="#cb326-10" tabindex="-1"></a>  <span class="cf">return</span> XCAR <span class="op">(</span>args<span class="op">);</span></span>
<span id="cb326-11"><a aria-hidden="true" href="#cb326-11" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 data-number="11.10.2" id="macros"><span class="header-section-number">11.10.2</span> 9.2 Macros</h3>
<p>Macros are functions that return code to be evaluated.</p>
<p><strong>Location</strong>:
<code>/home/user/emacs/src/eval.c:2729-2754</code></p>
<div class="sourceCode" id="cb327"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb327-1"><a aria-hidden="true" href="#cb327-1" tabindex="-1"></a><span class="cf">if</span> <span class="op">(</span>EQ <span class="op">(</span>funcar<span class="op">,</span> Qmacro<span class="op">))</span></span>
<span id="cb327-2"><a aria-hidden="true" href="#cb327-2" tabindex="-1"></a>  <span class="op">{</span></span>
<span id="cb327-3"><a aria-hidden="true" href="#cb327-3" tabindex="-1"></a>    specpdl_ref count1 <span class="op">=</span> SPECPDL_INDEX <span class="op">();</span></span>
<span id="cb327-4"><a aria-hidden="true" href="#cb327-4" tabindex="-1"></a>    Lisp_Object exp<span class="op">;</span></span>
<span id="cb327-5"><a aria-hidden="true" href="#cb327-5" tabindex="-1"></a>    <span class="co">/* Bind lexical-binding during expansion of the macro, so the</span></span>
<span id="cb327-6"><a aria-hidden="true" href="#cb327-6" tabindex="-1"></a><span class="co">       macro can know reliably if the code it outputs will be</span></span>
<span id="cb327-7"><a aria-hidden="true" href="#cb327-7" tabindex="-1"></a><span class="co">       interpreted using lexical-binding or not.  */</span></span>
<span id="cb327-8"><a aria-hidden="true" href="#cb327-8" tabindex="-1"></a>    specbind <span class="op">(</span>Qlexical_binding<span class="op">,</span></span>
<span id="cb327-9"><a aria-hidden="true" href="#cb327-9" tabindex="-1"></a>              NILP <span class="op">(</span>Vinternal_interpreter_environment<span class="op">)</span> <span class="op">?</span> Qnil <span class="op">:</span> Qt<span class="op">);</span></span>
<span id="cb327-10"><a aria-hidden="true" href="#cb327-10" tabindex="-1"></a></span>
<span id="cb327-11"><a aria-hidden="true" href="#cb327-11" tabindex="-1"></a>    <span class="co">/* Make the macro aware of any defvar declarations in scope. */</span></span>
<span id="cb327-12"><a aria-hidden="true" href="#cb327-12" tabindex="-1"></a>    Lisp_Object dynvars <span class="op">=</span> Vmacroexp__dynvars<span class="op">;</span></span>
<span id="cb327-13"><a aria-hidden="true" href="#cb327-13" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span>Lisp_Object p <span class="op">=</span> Vinternal_interpreter_environment<span class="op">;</span></span>
<span id="cb327-14"><a aria-hidden="true" href="#cb327-14" tabindex="-1"></a>         <span class="op">!</span>NILP <span class="op">(</span>p<span class="op">);</span> p <span class="op">=</span> XCDR<span class="op">(</span>p<span class="op">))</span></span>
<span id="cb327-15"><a aria-hidden="true" href="#cb327-15" tabindex="-1"></a>      <span class="op">{</span></span>
<span id="cb327-16"><a aria-hidden="true" href="#cb327-16" tabindex="-1"></a>        Lisp_Object e <span class="op">=</span> XCAR <span class="op">(</span>p<span class="op">);</span></span>
<span id="cb327-17"><a aria-hidden="true" href="#cb327-17" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>SYMBOLP <span class="op">(</span>e<span class="op">))</span></span>
<span id="cb327-18"><a aria-hidden="true" href="#cb327-18" tabindex="-1"></a>          dynvars <span class="op">=</span> Fcons<span class="op">(</span>e<span class="op">,</span> dynvars<span class="op">);</span></span>
<span id="cb327-19"><a aria-hidden="true" href="#cb327-19" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb327-20"><a aria-hidden="true" href="#cb327-20" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(!</span>EQ <span class="op">(</span>dynvars<span class="op">,</span> Vmacroexp__dynvars<span class="op">))</span></span>
<span id="cb327-21"><a aria-hidden="true" href="#cb327-21" tabindex="-1"></a>      specbind <span class="op">(</span>Qmacroexp__dynvars<span class="op">,</span> dynvars<span class="op">);</span></span>
<span id="cb327-22"><a aria-hidden="true" href="#cb327-22" tabindex="-1"></a></span>
<span id="cb327-23"><a aria-hidden="true" href="#cb327-23" tabindex="-1"></a>    exp <span class="op">=</span> apply1 <span class="op">(</span>Fcdr <span class="op">(</span>fun<span class="op">),</span> original_args<span class="op">);</span></span>
<span id="cb327-24"><a aria-hidden="true" href="#cb327-24" tabindex="-1"></a>    exp <span class="op">=</span> unbind_to <span class="op">(</span>count1<span class="op">,</span> exp<span class="op">);</span></span>
<span id="cb327-25"><a aria-hidden="true" href="#cb327-25" tabindex="-1"></a>    val <span class="op">=</span> eval_sub <span class="op">(</span>exp<span class="op">);</span>  <span class="co">// Evaluate the macro expansion</span></span>
<span id="cb327-26"><a aria-hidden="true" href="#cb327-26" tabindex="-1"></a>  <span class="op">}</span></span></code></pre></div>
<p><strong>Macro Expansion Process</strong>:</p>
<ol type="1">
<li><strong>Detect macro</strong>: Check if function is
<code>(macro . function)</code></li>
<li><strong>Call macro function</strong>: Apply to UNEVALUATED
arguments</li>
<li><strong>Evaluate expansion</strong>: Call <code>eval_sub</code> on
the result</li>
<li><strong>Recursive</strong>: The expansion might contain more macro
calls</li>
</ol>
<p><strong>Example</strong>:</p>
<div class="sourceCode" id="cb328"><pre class="sourceCode lisp"><code class="sourceCode commonlisp"><span id="cb328-1"><a aria-hidden="true" href="#cb328-1" tabindex="-1"></a><span class="co">;; Macro definition</span></span>
<span id="cb328-2"><a aria-hidden="true" href="#cb328-2" tabindex="-1"></a>(<span class="kw">defmacro</span><span class="fu"> when </span>(<span class="kw">cond</span> &amp;<span class="kw">rest</span> body)</span>
<span id="cb328-3"><a aria-hidden="true" href="#cb328-3" tabindex="-1"></a>  `(<span class="kw">if</span> ,<span class="kw">cond</span> (<span class="kw">progn</span> ,@body)))</span>
<span id="cb328-4"><a aria-hidden="true" href="#cb328-4" tabindex="-1"></a></span>
<span id="cb328-5"><a aria-hidden="true" href="#cb328-5" tabindex="-1"></a><span class="co">;; Usage</span></span>
<span id="cb328-6"><a aria-hidden="true" href="#cb328-6" tabindex="-1"></a>(<span class="kw">when</span> (<span class="op">&gt;</span> x <span class="dv">0</span>)</span>
<span id="cb328-7"><a aria-hidden="true" href="#cb328-7" tabindex="-1"></a>  (<span class="kw">print</span> <span class="st">"positive"</span>)</span>
<span id="cb328-8"><a aria-hidden="true" href="#cb328-8" tabindex="-1"></a>  (<span class="kw">print</span> x))</span>
<span id="cb328-9"><a aria-hidden="true" href="#cb328-9" tabindex="-1"></a></span>
<span id="cb328-10"><a aria-hidden="true" href="#cb328-10" tabindex="-1"></a><span class="co">;; Expands to:</span></span>
<span id="cb328-11"><a aria-hidden="true" href="#cb328-11" tabindex="-1"></a>(<span class="kw">if</span> (<span class="op">&gt;</span> x <span class="dv">0</span>)</span>
<span id="cb328-12"><a aria-hidden="true" href="#cb328-12" tabindex="-1"></a>    (<span class="kw">progn</span></span>
<span id="cb328-13"><a aria-hidden="true" href="#cb328-13" tabindex="-1"></a>      (<span class="kw">print</span> <span class="st">"positive"</span>)</span>
<span id="cb328-14"><a aria-hidden="true" href="#cb328-14" tabindex="-1"></a>      (<span class="kw">print</span> x)))</span></code></pre></div>
<p>At runtime, the evaluator: 1. Sees <code>(when ...)</code> is a macro
2. Calls the macro function with
<code>((&gt; x 0) (print "positive") (print x))</code> 3. Gets back
<code>(if (&gt; x 0) (progn ...))</code> 4. Evaluates that expansion</p>
<hr/>
<h2 data-number="11.11" id="design-tradeoffs"><span class="header-section-number">11.11</span> 10. Design Tradeoffs</h2>
<h3 data-number="11.11.1" id="three-execution-models"><span class="header-section-number">11.11.1</span> 10.1 Three Execution
Models</h3>
<table>
<colgroup>
<col style="width: 17%"/>
<col style="width: 17%"/>
<col style="width: 21%"/>
<col style="width: 19%"/>
<col style="width: 24%"/>
</colgroup>
<thead>
<tr>
<th>Model</th>
<th>Speed</th>
<th>Startup</th>
<th>Memory</th>
<th>Use Case</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Interpreted</strong></td>
<td>1x</td>
<td>Instant</td>
<td>Low</td>
<td>Development, rarely-used code</td>
</tr>
<tr>
<td><strong>Bytecode</strong></td>
<td>3-5x</td>
<td>Fast</td>
<td>Medium</td>
<td>Most Emacs code</td>
</tr>
<tr>
<td><strong>Native</strong></td>
<td>10-20x</td>
<td>Slow (compile)</td>
<td>High</td>
<td>Hot paths, compute-heavy</td>
</tr>
</tbody>
</table>
<p><strong>Key Insight</strong>: The interpreter can seamlessly call
between all three: - Bytecode can call interpreted functions - Native
code can call bytecode - All share the same <code>funcall</code>
interface</p>
<h3 data-number="11.11.2" id="tagged-pointers-vs.-boxed-values"><span class="header-section-number">11.11.2</span> 10.2 Tagged Pointers
vs.¬†Boxed Values</h3>
<p><strong>Tagged pointers</strong> (Emacs approach): -
<strong>Pros</strong>: Fast type checking, immediate integers, no
allocation for fixnums - <strong>Cons</strong>: Reduced integer range,
complex pointer arithmetic</p>
<p><strong>Boxed values</strong> (Python, Ruby): -
<strong>Pros</strong>: Simpler implementation, uniform representation -
<strong>Cons</strong>: Every integer is heap-allocated, more GC
pressure</p>
<h3 data-number="11.11.3" id="separate-function-namespace-lisp-2"><span class="header-section-number">11.11.3</span> 10.3 Separate Function
Namespace (Lisp-2)</h3>
<p>Emacs Lisp has separate namespaces for variables and functions
(Lisp-2), unlike Scheme (Lisp-1).</p>
<p><strong>Pros</strong>: - Can have variable <code>list</code> and
function <code>list</code> separately - Closer to Common Lisp - No
accidental shadowing</p>
<p><strong>Cons</strong>: - Need <code>funcall</code> to call
function-valued variables - More complex scoping rules - Harder to pass
functions as arguments</p>
<p><strong>Example</strong>:</p>
<div class="sourceCode" id="cb329"><pre class="sourceCode lisp"><code class="sourceCode commonlisp"><span id="cb329-1"><a aria-hidden="true" href="#cb329-1" tabindex="-1"></a><span class="co">;; Lisp-2 (Emacs Lisp)</span></span>
<span id="cb329-2"><a aria-hidden="true" href="#cb329-2" tabindex="-1"></a>(<span class="kw">let</span> ((<span class="kw">list</span> '(<span class="dv">1</span> <span class="dv">2</span> <span class="dv">3</span>)))</span>
<span id="cb329-3"><a aria-hidden="true" href="#cb329-3" tabindex="-1"></a>  (<span class="kw">list</span> <span class="dv">4</span> <span class="dv">5</span> <span class="dv">6</span>))  <span class="co">; OK - function `list` != variable `list`</span></span>
<span id="cb329-4"><a aria-hidden="true" href="#cb329-4" tabindex="-1"></a><span class="op">=&gt;</span> (<span class="dv">4</span> <span class="dv">5</span> <span class="dv">6</span>)</span>
<span id="cb329-5"><a aria-hidden="true" href="#cb329-5" tabindex="-1"></a></span>
<span id="cb329-6"><a aria-hidden="true" href="#cb329-6" tabindex="-1"></a><span class="co">;; Lisp-1 (Scheme)</span></span>
<span id="cb329-7"><a aria-hidden="true" href="#cb329-7" tabindex="-1"></a>(<span class="kw">let</span> ((<span class="kw">list</span> '(<span class="dv">1</span> <span class="dv">2</span> <span class="dv">3</span>)))</span>
<span id="cb329-8"><a aria-hidden="true" href="#cb329-8" tabindex="-1"></a>  (<span class="kw">list</span> <span class="dv">4</span> <span class="dv">5</span> <span class="dv">6</span>))  <span class="co">; ERROR - `list` is shadowed</span></span></code></pre></div>
<h3 data-number="11.11.4" id="dynamic-vs.-lexical-scoping"><span class="header-section-number">11.11.4</span> 10.4 Dynamic vs.¬†Lexical
Scoping</h3>
<p><strong>Lexical scoping</strong> (modern default): -
<strong>Pros</strong>: Faster (compile-time resolution), safer, enables
optimization - <strong>Cons</strong>: Can‚Äôt dynamically rebind context
variables</p>
<p><strong>Dynamic scoping</strong> (legacy): - <strong>Pros</strong>:
Convenient for configuration (like <code>case-fold-search</code>) -
<strong>Cons</strong>: Slow (runtime lookup), hard to reason about,
breaks modularity</p>
<p>Emacs supports both, with special variables marked by
<code>defvar</code>.</p>
<h3 data-number="11.11.5" id="specpdl-vs.-c-stack"><span class="header-section-number">11.11.5</span> 10.5 Specpdl vs.¬†C
Stack</h3>
<p>Emacs uses a separate <code>specpdl</code> stack for dynamic bindings
instead of the C stack.</p>
<p><strong>Pros</strong>: - <strong>Precise unwinding</strong>: Can
restore exactly the right bindings - <strong>GC integration</strong>:
Knows what‚Äôs a Lisp object - <strong>Introspection</strong>: Backtrace,
profiling</p>
<p><strong>Cons</strong>: - <strong>Extra indirection</strong>: Slower
than native C calls - <strong>Memory overhead</strong>: Two stacks
instead of one</p>
<h3 data-number="11.11.6" id="unevalled-vs.-macros"><span class="header-section-number">11.11.6</span> 10.6 UNEVALLED
vs.¬†Macros</h3>
<p>For implementing conditionals like <code>if</code>, two choices:</p>
<p><strong>Special form</strong> (<code>UNEVALLED</code>):</p>
<div class="sourceCode" id="cb330"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb330-1"><a aria-hidden="true" href="#cb330-1" tabindex="-1"></a>DEFUN <span class="op">(</span><span class="st">"if"</span><span class="op">,</span> Fif<span class="op">,</span> Sif<span class="op">,</span> <span class="dv">2</span><span class="op">,</span> UNEVALLED<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="op">...)</span></span>
<span id="cb330-2"><a aria-hidden="true" href="#cb330-2" tabindex="-1"></a>  <span class="op">(</span>Lisp_Object args<span class="op">)</span></span>
<span id="cb330-3"><a aria-hidden="true" href="#cb330-3" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb330-4"><a aria-hidden="true" href="#cb330-4" tabindex="-1"></a>  Lisp_Object cond <span class="op">=</span> eval_sub <span class="op">(</span>XCAR <span class="op">(</span>args<span class="op">));</span></span>
<span id="cb330-5"><a aria-hidden="true" href="#cb330-5" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(!</span>NILP <span class="op">(</span>cond<span class="op">))</span></span>
<span id="cb330-6"><a aria-hidden="true" href="#cb330-6" tabindex="-1"></a>    <span class="cf">return</span> eval_sub <span class="op">(</span>Fcar <span class="op">(</span>XCDR <span class="op">(</span>args<span class="op">)));</span></span>
<span id="cb330-7"><a aria-hidden="true" href="#cb330-7" tabindex="-1"></a>  <span class="cf">return</span> Fprogn <span class="op">(</span>Fcdr <span class="op">(</span>XCDR <span class="op">(</span>args<span class="op">)));</span></span>
<span id="cb330-8"><a aria-hidden="true" href="#cb330-8" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>Macro</strong>:</p>
<div class="sourceCode" id="cb331"><pre class="sourceCode lisp"><code class="sourceCode commonlisp"><span id="cb331-1"><a aria-hidden="true" href="#cb331-1" tabindex="-1"></a>(<span class="kw">defmacro</span><span class="fu"> if </span>(<span class="kw">cond</span> then &amp;<span class="kw">rest</span> else)</span>
<span id="cb331-2"><a aria-hidden="true" href="#cb331-2" tabindex="-1"></a>  (<span class="kw">list</span> <span class="dt">'cond</span> (<span class="kw">list</span> <span class="kw">cond</span> then) (<span class="kw">cons</span> <span class="kw">t</span> else)))</span></code></pre></div>
<p>Special forms are: - <strong>Faster</strong>: No macro expansion step
- <strong>More flexible</strong>: Can inspect arguments at runtime -
<strong>Built-in only</strong>: Can‚Äôt be defined in Lisp</p>
<p>Macros are: - <strong>Extensible</strong>: Users can define their own
- <strong>Composable</strong>: Macros can call other macros -
<strong>Debuggable</strong>: Expansion is visible</p>
<p>Emacs uses special forms for core control flow (<code>if</code>,
<code>while</code>, <code>catch</code>) and macros for everything
else.</p>
<hr/>
<h2 data-number="11.12" id="summary-1"><span class="header-section-number">11.12</span> Summary</h2>
<p>The Emacs Lisp interpreter is a sophisticated piece of software that
balances:</p>
<ol type="1">
<li><strong>Flexibility</strong>: Three execution models, two scoping
modes, extensible via macros</li>
<li><strong>Performance</strong>: Tagged pointers, bytecode compilation,
native compilation</li>
<li><strong>Compatibility</strong>: Supports 40+ years of Emacs Lisp
code</li>
<li><strong>Debuggability</strong>: Rich introspection, backtraces,
profiling</li>
</ol>
<p><strong>Core Flow</strong>:</p>
<pre><code>Text ‚Üí Reader ‚Üí Lisp_Object ‚Üí eval_sub ‚Üí {
    Symbol lookup (lexical/dynamic)
    Function call (SUBR/lambda/bytecode/native)
    Special form (UNEVALLED)
    Macro expansion
} ‚Üí Result</code></pre>
<p><strong>Key Files</strong>: -
<code>/home/user/emacs/src/lisp.h</code>: Core data structures -
<code>/home/user/emacs/src/eval.c</code>: Evaluation engine (eval_sub,
funcall, apply) - <code>/home/user/emacs/src/data.c</code>: Type
predicates, primitive operations -
<code>/home/user/emacs/src/lread.c</code>: Reader, obarray, symbol
interning - <code>/home/user/emacs/src/print.c</code>: Printer -
<code>/home/user/emacs/src/bytecode.c</code>: Bytecode interpreter -
<code>/home/user/emacs/src/comp.c</code>: Native compiler
(libgccjit)</p>
<p>The beauty of this design is that all the complexity is hidden behind
simple interfaces: - Every value is a <code>Lisp_Object</code> - Every
function call goes through <code>funcall</code> - Every evaluation goes
through <code>eval</code></p>
<p>This uniformity makes the system both powerful and
understandable.</p>
<h1 data-number="12" id="memory-management-and-garbage-collection"><span class="header-section-number">12</span> Memory Management and Garbage
Collection</h1>
<p>This document provides a comprehensive guide to Emacs‚Äôs memory
management and garbage collection system, exploring the allocation
strategies, GC algorithms, and performance considerations that power the
Elisp runtime.</p>
<h2 data-number="12.1" id="table-of-contents-6"><span class="header-section-number">12.1</span> Table of Contents</h2>
<ol type="1">
<li><a href="#overview">Overview</a></li>
<li><a href="#the-allocation-system">The Allocation System</a></li>
<li><a href="#garbage-collection-algorithm">Garbage Collection
Algorithm</a></li>
<li><a href="#key-functions-deep-dive">Key Functions Deep Dive</a></li>
<li><a href="#special-topics">Special Topics</a></li>
<li><a href="#performance-and-tuning">Performance and Tuning</a></li>
</ol>
<hr/>
<h2 data-number="12.2" id="overview-3"><span class="header-section-number">12.2</span> Overview</h2>
<p>Emacs uses a <strong>mark-and-sweep garbage collector</strong> with
several sophisticated features:</p>
<ul>
<li><strong>Type-specific allocators</strong> optimized for different
Lisp object types</li>
<li><strong>Block-based allocation</strong> with free lists for fast
allocation</li>
<li><strong>Conservative stack scanning</strong> combined with precise
heap scanning</li>
<li><strong>Weak references</strong> and finalizers support</li>
<li><strong>Incremental compaction</strong> for strings</li>
<li><strong>Integration with pdumper</strong> for portable dumping</li>
</ul>
<p>The entire implementation resides primarily in
<code>/home/user/emacs/src/alloc.c</code> (7,500+ lines), with
supplementary allocators in <code>gmalloc.c</code> and
<code>ralloc.c</code>.</p>
<div class="sourceCode" id="cb333"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb333-1"><a aria-hidden="true" href="#cb333-1" tabindex="-1"></a><span class="co">/* From src/alloc.c:1 */</span></span>
<span id="cb333-2"><a aria-hidden="true" href="#cb333-2" tabindex="-1"></a><span class="co">/* Storage allocation and gc for GNU Emacs Lisp interpreter.</span></span>
<span id="cb333-3"><a aria-hidden="true" href="#cb333-3" tabindex="-1"></a><span class="co">   Copyright (C) 1985-2025 Free Software Foundation, Inc. */</span></span></code></pre></div>
<h3 data-number="12.2.1" id="key-design-principles-1"><span class="header-section-number">12.2.1</span> Key Design Principles</h3>
<ol type="1">
<li><strong>Fast Allocation</strong>: Most allocations happen from
pre-allocated blocks via free lists</li>
<li><strong>Minimal Fragmentation</strong>: Block-based allocation with
type-specific pools</li>
<li><strong>Precise Marking</strong>: GC knows exact layout of all heap
objects</li>
<li><strong>Conservative Scanning</strong>: Stack and registers scanned
conservatively</li>
<li><strong>Generational Hints</strong>: Track object age for better GC
decisions</li>
</ol>
<hr/>
<h2 data-number="12.3" id="the-allocation-system"><span class="header-section-number">12.3</span> The Allocation System</h2>
<h3 data-number="12.3.1" id="memory-type-tracking"><span class="header-section-number">12.3.1</span> Memory Type Tracking</h3>
<p>Emacs tracks what type of Lisp object each memory region contains for
conservative stack scanning:</p>
<div class="sourceCode" id="cb334"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb334-1"><a aria-hidden="true" href="#cb334-1" tabindex="-1"></a><span class="co">/* From src/alloc.c:408 */</span></span>
<span id="cb334-2"><a aria-hidden="true" href="#cb334-2" tabindex="-1"></a><span class="co">/* When scanning the C stack for live Lisp objects, Emacs keeps track of</span></span>
<span id="cb334-3"><a aria-hidden="true" href="#cb334-3" tabindex="-1"></a><span class="co">   what memory allocated via lisp_malloc and lisp_align_malloc is intended</span></span>
<span id="cb334-4"><a aria-hidden="true" href="#cb334-4" tabindex="-1"></a><span class="co">   for what purpose. This enumeration specifies the type of memory.  */</span></span>
<span id="cb334-5"><a aria-hidden="true" href="#cb334-5" tabindex="-1"></a></span>
<span id="cb334-6"><a aria-hidden="true" href="#cb334-6" tabindex="-1"></a><span class="kw">enum</span> mem_type</span>
<span id="cb334-7"><a aria-hidden="true" href="#cb334-7" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb334-8"><a aria-hidden="true" href="#cb334-8" tabindex="-1"></a>  MEM_TYPE_NON_LISP<span class="op">,</span></span>
<span id="cb334-9"><a aria-hidden="true" href="#cb334-9" tabindex="-1"></a>  MEM_TYPE_CONS<span class="op">,</span></span>
<span id="cb334-10"><a aria-hidden="true" href="#cb334-10" tabindex="-1"></a>  MEM_TYPE_STRING<span class="op">,</span></span>
<span id="cb334-11"><a aria-hidden="true" href="#cb334-11" tabindex="-1"></a>  MEM_TYPE_SYMBOL<span class="op">,</span></span>
<span id="cb334-12"><a aria-hidden="true" href="#cb334-12" tabindex="-1"></a>  MEM_TYPE_FLOAT<span class="op">,</span></span>
<span id="cb334-13"><a aria-hidden="true" href="#cb334-13" tabindex="-1"></a>  <span class="co">/* Since all non-bool pseudovectors are small enough to be</span></span>
<span id="cb334-14"><a aria-hidden="true" href="#cb334-14" tabindex="-1"></a><span class="co">     allocated from vector blocks, this memory type denotes</span></span>
<span id="cb334-15"><a aria-hidden="true" href="#cb334-15" tabindex="-1"></a><span class="co">     large regular vectors and large bool pseudovectors.  */</span></span>
<span id="cb334-16"><a aria-hidden="true" href="#cb334-16" tabindex="-1"></a>  MEM_TYPE_VECTORLIKE<span class="op">,</span></span>
<span id="cb334-17"><a aria-hidden="true" href="#cb334-17" tabindex="-1"></a>  <span class="co">/* Special type to denote vector blocks.  */</span></span>
<span id="cb334-18"><a aria-hidden="true" href="#cb334-18" tabindex="-1"></a>  MEM_TYPE_VECTOR_BLOCK<span class="op">,</span></span>
<span id="cb334-19"><a aria-hidden="true" href="#cb334-19" tabindex="-1"></a>  <span class="co">/* Special type to denote reserved memory.  */</span></span>
<span id="cb334-20"><a aria-hidden="true" href="#cb334-20" tabindex="-1"></a>  MEM_TYPE_SPARE</span>
<span id="cb334-21"><a aria-hidden="true" href="#cb334-21" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<p>A <strong>red-black tree</strong> tracks all allocated memory
regions:</p>
<div class="sourceCode" id="cb335"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb335-1"><a aria-hidden="true" href="#cb335-1" tabindex="-1"></a><span class="co">/* From src/alloc.c:461 */</span></span>
<span id="cb335-2"><a aria-hidden="true" href="#cb335-2" tabindex="-1"></a><span class="co">/* A red-black tree is a balanced binary tree with the following</span></span>
<span id="cb335-3"><a aria-hidden="true" href="#cb335-3" tabindex="-1"></a><span class="co">   properties:</span></span>
<span id="cb335-4"><a aria-hidden="true" href="#cb335-4" tabindex="-1"></a></span>
<span id="cb335-5"><a aria-hidden="true" href="#cb335-5" tabindex="-1"></a><span class="co">   1. Every node is either red or black.</span></span>
<span id="cb335-6"><a aria-hidden="true" href="#cb335-6" tabindex="-1"></a><span class="co">   2. Every leaf is black.</span></span>
<span id="cb335-7"><a aria-hidden="true" href="#cb335-7" tabindex="-1"></a><span class="co">   3. If a node is red, then both of its children are black.</span></span>
<span id="cb335-8"><a aria-hidden="true" href="#cb335-8" tabindex="-1"></a><span class="co">   4. Every simple path from a node to a descendant leaf contains</span></span>
<span id="cb335-9"><a aria-hidden="true" href="#cb335-9" tabindex="-1"></a><span class="co">      the same number of black nodes.</span></span>
<span id="cb335-10"><a aria-hidden="true" href="#cb335-10" tabindex="-1"></a><span class="co">   5. The root is always black. */</span></span>
<span id="cb335-11"><a aria-hidden="true" href="#cb335-11" tabindex="-1"></a></span>
<span id="cb335-12"><a aria-hidden="true" href="#cb335-12" tabindex="-1"></a><span class="kw">struct</span> mem_node</span>
<span id="cb335-13"><a aria-hidden="true" href="#cb335-13" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb335-14"><a aria-hidden="true" href="#cb335-14" tabindex="-1"></a>  <span class="kw">struct</span> mem_node <span class="op">*</span>left<span class="op">,</span> <span class="op">*</span>right<span class="op">;</span>  <span class="co">/* Children, never NULL */</span></span>
<span id="cb335-15"><a aria-hidden="true" href="#cb335-15" tabindex="-1"></a>  <span class="kw">struct</span> mem_node <span class="op">*</span>parent<span class="op">;</span>         <span class="co">/* Parent or NULL for root */</span></span>
<span id="cb335-16"><a aria-hidden="true" href="#cb335-16" tabindex="-1"></a>  <span class="dt">void</span> <span class="op">*</span>start<span class="op">,</span> <span class="op">*</span>end<span class="op">;</span>               <span class="co">/* Memory region bounds */</span></span>
<span id="cb335-17"><a aria-hidden="true" href="#cb335-17" tabindex="-1"></a>  <span class="kw">enum</span> <span class="op">{</span>MEM_BLACK<span class="op">,</span> MEM_RED<span class="op">}</span> color<span class="op">;</span></span>
<span id="cb335-18"><a aria-hidden="true" href="#cb335-18" tabindex="-1"></a>  <span class="kw">enum</span> mem_type type<span class="op">;</span>              <span class="co">/* What kind of objects */</span></span>
<span id="cb335-19"><a aria-hidden="true" href="#cb335-19" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<h3 data-number="12.3.2" id="cons-cell-allocation"><span class="header-section-number">12.3.2</span> Cons Cell Allocation</h3>
<p>Cons cells are allocated from <strong>cons blocks</strong>, with each
block containing multiple cons cells tracked via a bitmap for
marking:</p>
<div class="sourceCode" id="cb336"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb336-1"><a aria-hidden="true" href="#cb336-1" tabindex="-1"></a><span class="co">/* From src/alloc.c:2539 */</span></span>
<span id="cb336-2"><a aria-hidden="true" href="#cb336-2" tabindex="-1"></a><span class="pp">#define CONS_BLOCK_SIZE                     </span><span class="op">\</span></span>
<span id="cb336-3"><a aria-hidden="true" href="#cb336-3" tabindex="-1"></a><span class="pp">  </span><span class="op">(((</span><span class="pp">BLOCK_BYTES </span><span class="op">-</span><span class="pp"> </span><span class="kw">sizeof</span><span class="pp"> </span><span class="op">(</span><span class="kw">struct</span><span class="pp"> cons_block </span><span class="op">*)</span><span class="pp">         </span><span class="op">\</span></span>
<span id="cb336-4"><a aria-hidden="true" href="#cb336-4" tabindex="-1"></a><span class="pp">     </span><span class="op">-</span><span class="pp"> </span><span class="op">(</span><span class="kw">sizeof</span><span class="pp"> </span><span class="op">(</span><span class="kw">struct</span><span class="pp"> </span>Lisp_Cons<span class="op">)</span><span class="pp"> </span><span class="op">-</span><span class="pp"> </span><span class="kw">sizeof</span><span class="pp"> </span><span class="op">(</span><span class="pp">bits_word</span><span class="op">)))</span><span class="pp"> </span><span class="op">*</span><span class="pp"> CHAR_BIT</span><span class="op">)</span><span class="pp">    </span><span class="op">\</span></span>
<span id="cb336-5"><a aria-hidden="true" href="#cb336-5" tabindex="-1"></a><span class="pp">   </span><span class="op">/</span><span class="pp"> </span><span class="op">(</span><span class="kw">sizeof</span><span class="pp"> </span><span class="op">(</span><span class="kw">struct</span><span class="pp"> </span>Lisp_Cons<span class="op">)</span><span class="pp"> </span><span class="op">*</span><span class="pp"> CHAR_BIT </span><span class="op">+</span><span class="pp"> </span><span class="dv">1</span><span class="op">))</span></span>
<span id="cb336-6"><a aria-hidden="true" href="#cb336-6" tabindex="-1"></a></span>
<span id="cb336-7"><a aria-hidden="true" href="#cb336-7" tabindex="-1"></a><span class="kw">struct</span> cons_block</span>
<span id="cb336-8"><a aria-hidden="true" href="#cb336-8" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb336-9"><a aria-hidden="true" href="#cb336-9" tabindex="-1"></a>  <span class="co">/* Place `conses' at the beginning, to ease up CONS_INDEX's job.  */</span></span>
<span id="cb336-10"><a aria-hidden="true" href="#cb336-10" tabindex="-1"></a>  <span class="kw">struct</span> Lisp_Cons conses<span class="op">[</span>CONS_BLOCK_SIZE<span class="op">];</span></span>
<span id="cb336-11"><a aria-hidden="true" href="#cb336-11" tabindex="-1"></a>  bits_word gcmarkbits<span class="op">[</span><span class="dv">1</span> <span class="op">+</span> CONS_BLOCK_SIZE <span class="op">/</span> BITS_PER_BITS_WORD<span class="op">];</span></span>
<span id="cb336-12"><a aria-hidden="true" href="#cb336-12" tabindex="-1"></a>  <span class="kw">struct</span> cons_block <span class="op">*</span>next<span class="op">;</span></span>
<span id="cb336-13"><a aria-hidden="true" href="#cb336-13" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<p>Allocation tries the free list first, then allocates from the current
block:</p>
<div class="sourceCode" id="cb337"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb337-1"><a aria-hidden="true" href="#cb337-1" tabindex="-1"></a><span class="co">/* From src/alloc.c:2599 */</span></span>
<span id="cb337-2"><a aria-hidden="true" href="#cb337-2" tabindex="-1"></a>DEFUN <span class="op">(</span><span class="st">"cons"</span><span class="op">,</span> Fcons<span class="op">,</span> Scons<span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb337-3"><a aria-hidden="true" href="#cb337-3" tabindex="-1"></a>       doc<span class="op">:</span> <span class="co">/* Create a new cons, give it CAR and CDR as components, and return it.  */</span><span class="op">)</span></span>
<span id="cb337-4"><a aria-hidden="true" href="#cb337-4" tabindex="-1"></a>  <span class="op">(</span>Lisp_Object car<span class="op">,</span> Lisp_Object cdr<span class="op">)</span></span>
<span id="cb337-5"><a aria-hidden="true" href="#cb337-5" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb337-6"><a aria-hidden="true" href="#cb337-6" tabindex="-1"></a>  <span class="dt">register</span> Lisp_Object val<span class="op">;</span></span>
<span id="cb337-7"><a aria-hidden="true" href="#cb337-7" tabindex="-1"></a></span>
<span id="cb337-8"><a aria-hidden="true" href="#cb337-8" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>cons_free_list<span class="op">)</span></span>
<span id="cb337-9"><a aria-hidden="true" href="#cb337-9" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb337-10"><a aria-hidden="true" href="#cb337-10" tabindex="-1"></a>      ASAN_UNPOISON_CONS <span class="op">(</span>cons_free_list<span class="op">);</span></span>
<span id="cb337-11"><a aria-hidden="true" href="#cb337-11" tabindex="-1"></a>      XSETCONS <span class="op">(</span>val<span class="op">,</span> cons_free_list<span class="op">);</span></span>
<span id="cb337-12"><a aria-hidden="true" href="#cb337-12" tabindex="-1"></a>      cons_free_list <span class="op">=</span> cons_free_list<span class="op">-&gt;</span>u<span class="op">.</span>s<span class="op">.</span>u<span class="op">.</span>chain<span class="op">;</span></span>
<span id="cb337-13"><a aria-hidden="true" href="#cb337-13" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb337-14"><a aria-hidden="true" href="#cb337-14" tabindex="-1"></a>  <span class="cf">else</span></span>
<span id="cb337-15"><a aria-hidden="true" href="#cb337-15" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb337-16"><a aria-hidden="true" href="#cb337-16" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span>cons_block_index <span class="op">==</span> CONS_BLOCK_SIZE<span class="op">)</span></span>
<span id="cb337-17"><a aria-hidden="true" href="#cb337-17" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb337-18"><a aria-hidden="true" href="#cb337-18" tabindex="-1"></a>      <span class="kw">struct</span> cons_block <span class="op">*</span>new</span>
<span id="cb337-19"><a aria-hidden="true" href="#cb337-19" tabindex="-1"></a>        <span class="op">=</span> lisp_align_malloc <span class="op">(</span><span class="kw">sizeof</span> <span class="op">*</span>new<span class="op">,</span> MEM_TYPE_CONS<span class="op">);</span></span>
<span id="cb337-20"><a aria-hidden="true" href="#cb337-20" tabindex="-1"></a>      memset <span class="op">(</span>new<span class="op">-&gt;</span>gcmarkbits<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="kw">sizeof</span> new<span class="op">-&gt;</span>gcmarkbits<span class="op">);</span></span>
<span id="cb337-21"><a aria-hidden="true" href="#cb337-21" tabindex="-1"></a>      ASAN_POISON_CONS_BLOCK <span class="op">(</span>new<span class="op">);</span></span>
<span id="cb337-22"><a aria-hidden="true" href="#cb337-22" tabindex="-1"></a>      new<span class="op">-&gt;</span>next <span class="op">=</span> cons_block<span class="op">;</span></span>
<span id="cb337-23"><a aria-hidden="true" href="#cb337-23" tabindex="-1"></a>      cons_block <span class="op">=</span> new<span class="op">;</span></span>
<span id="cb337-24"><a aria-hidden="true" href="#cb337-24" tabindex="-1"></a>      cons_block_index <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb337-25"><a aria-hidden="true" href="#cb337-25" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb337-26"><a aria-hidden="true" href="#cb337-26" tabindex="-1"></a>      ASAN_UNPOISON_CONS <span class="op">(&amp;</span>cons_block<span class="op">-&gt;</span>conses<span class="op">[</span>cons_block_index<span class="op">]);</span></span>
<span id="cb337-27"><a aria-hidden="true" href="#cb337-27" tabindex="-1"></a>      XSETCONS <span class="op">(</span>val<span class="op">,</span> <span class="op">&amp;</span>cons_block<span class="op">-&gt;</span>conses<span class="op">[</span>cons_block_index<span class="op">]);</span></span>
<span id="cb337-28"><a aria-hidden="true" href="#cb337-28" tabindex="-1"></a>      cons_block_index<span class="op">++;</span></span>
<span id="cb337-29"><a aria-hidden="true" href="#cb337-29" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb337-30"><a aria-hidden="true" href="#cb337-30" tabindex="-1"></a></span>
<span id="cb337-31"><a aria-hidden="true" href="#cb337-31" tabindex="-1"></a>  XSETCAR <span class="op">(</span>val<span class="op">,</span> car<span class="op">);</span></span>
<span id="cb337-32"><a aria-hidden="true" href="#cb337-32" tabindex="-1"></a>  XSETCDR <span class="op">(</span>val<span class="op">,</span> cdr<span class="op">);</span></span>
<span id="cb337-33"><a aria-hidden="true" href="#cb337-33" tabindex="-1"></a>  eassert <span class="op">(!</span>XCONS_MARKED_P <span class="op">(</span>XCONS <span class="op">(</span>val<span class="op">)));</span></span>
<span id="cb337-34"><a aria-hidden="true" href="#cb337-34" tabindex="-1"></a>  consing_until_gc <span class="op">-=</span> <span class="kw">sizeof</span> <span class="op">(</span><span class="kw">struct</span> Lisp_Cons<span class="op">);</span></span>
<span id="cb337-35"><a aria-hidden="true" href="#cb337-35" tabindex="-1"></a>  cons_cells_consed<span class="op">++;</span></span>
<span id="cb337-36"><a aria-hidden="true" href="#cb337-36" tabindex="-1"></a>  <span class="cf">return</span> val<span class="op">;</span></span>
<span id="cb337-37"><a aria-hidden="true" href="#cb337-37" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 data-number="12.3.3" id="string-allocation"><span class="header-section-number">12.3.3</span> String Allocation</h3>
<p>Strings use a <strong>two-level allocation strategy</strong>:</p>
<ol type="1">
<li><strong>String objects</strong> (<code>struct Lisp_String</code>)
allocated from string blocks</li>
<li><strong>String data</strong> allocated from sblocks (sub-allocated
memory blocks)</li>
</ol>
<div class="sourceCode" id="cb338"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb338-1"><a aria-hidden="true" href="#cb338-1" tabindex="-1"></a><span class="co">/* From src/alloc.c:1318 */</span></span>
<span id="cb338-2"><a aria-hidden="true" href="#cb338-2" tabindex="-1"></a><span class="co">/* Lisp_Strings are allocated in string_block structures.  When a new</span></span>
<span id="cb338-3"><a aria-hidden="true" href="#cb338-3" tabindex="-1"></a><span class="co">   string_block is allocated, all the Lisp_Strings it contains are</span></span>
<span id="cb338-4"><a aria-hidden="true" href="#cb338-4" tabindex="-1"></a><span class="co">   added to a free-list string_free_list.  When a new Lisp_String is</span></span>
<span id="cb338-5"><a aria-hidden="true" href="#cb338-5" tabindex="-1"></a><span class="co">   needed, it is taken from that list.  During the sweep phase of GC,</span></span>
<span id="cb338-6"><a aria-hidden="true" href="#cb338-6" tabindex="-1"></a><span class="co">   string_blocks that are entirely free are freed, except two which</span></span>
<span id="cb338-7"><a aria-hidden="true" href="#cb338-7" tabindex="-1"></a><span class="co">   we keep.</span></span>
<span id="cb338-8"><a aria-hidden="true" href="#cb338-8" tabindex="-1"></a></span>
<span id="cb338-9"><a aria-hidden="true" href="#cb338-9" tabindex="-1"></a><span class="co">   String data is allocated from sblock structures.  Strings larger</span></span>
<span id="cb338-10"><a aria-hidden="true" href="#cb338-10" tabindex="-1"></a><span class="co">   than LARGE_STRING_BYTES, get their own sblock, data for smaller</span></span>
<span id="cb338-11"><a aria-hidden="true" href="#cb338-11" tabindex="-1"></a><span class="co">   strings is sub-allocated out of sblocks of size SBLOCK_SIZE.</span></span>
<span id="cb338-12"><a aria-hidden="true" href="#cb338-12" tabindex="-1"></a></span>
<span id="cb338-13"><a aria-hidden="true" href="#cb338-13" tabindex="-1"></a><span class="co">   Sblocks consist internally of sdata structures, one for each</span></span>
<span id="cb338-14"><a aria-hidden="true" href="#cb338-14" tabindex="-1"></a><span class="co">   Lisp_String.  The sdata structure points to the Lisp_String it</span></span>
<span id="cb338-15"><a aria-hidden="true" href="#cb338-15" tabindex="-1"></a><span class="co">   belongs to.  The Lisp_String points back to the `u.data' member of</span></span>
<span id="cb338-16"><a aria-hidden="true" href="#cb338-16" tabindex="-1"></a><span class="co">   its sdata structure. */</span></span></code></pre></div>
<p>String data structure:</p>
<div class="sourceCode" id="cb339"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb339-1"><a aria-hidden="true" href="#cb339-1" tabindex="-1"></a><span class="co">/* From src/alloc.c:1352 */</span></span>
<span id="cb339-2"><a aria-hidden="true" href="#cb339-2" tabindex="-1"></a><span class="kw">struct</span> sdata</span>
<span id="cb339-3"><a aria-hidden="true" href="#cb339-3" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb339-4"><a aria-hidden="true" href="#cb339-4" tabindex="-1"></a>  <span class="co">/* Back-pointer to the string this sdata belongs to.  If null, this</span></span>
<span id="cb339-5"><a aria-hidden="true" href="#cb339-5" tabindex="-1"></a><span class="co">     structure is free, and NBYTES contains the string's byte size.  */</span></span>
<span id="cb339-6"><a aria-hidden="true" href="#cb339-6" tabindex="-1"></a>  <span class="kw">struct</span> Lisp_String <span class="op">*</span>string<span class="op">;</span></span>
<span id="cb339-7"><a aria-hidden="true" href="#cb339-7" tabindex="-1"></a></span>
<span id="cb339-8"><a aria-hidden="true" href="#cb339-8" tabindex="-1"></a><span class="pp">#ifdef GC_CHECK_STRING_BYTES</span></span>
<span id="cb339-9"><a aria-hidden="true" href="#cb339-9" tabindex="-1"></a>  <span class="dt">ptrdiff_t</span> nbytes<span class="op">;</span></span>
<span id="cb339-10"><a aria-hidden="true" href="#cb339-10" tabindex="-1"></a><span class="pp">#endif</span></span>
<span id="cb339-11"><a aria-hidden="true" href="#cb339-11" tabindex="-1"></a></span>
<span id="cb339-12"><a aria-hidden="true" href="#cb339-12" tabindex="-1"></a>  <span class="dt">unsigned</span> <span class="dt">char</span> data<span class="op">[</span>FLEXIBLE_ARRAY_MEMBER<span class="op">];</span></span>
<span id="cb339-13"><a aria-hidden="true" href="#cb339-13" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<p>String blocks:</p>
<div class="sourceCode" id="cb340"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb340-1"><a aria-hidden="true" href="#cb340-1" tabindex="-1"></a><span class="co">/* From src/alloc.c:1405 */</span></span>
<span id="cb340-2"><a aria-hidden="true" href="#cb340-2" tabindex="-1"></a><span class="kw">struct</span> sblock</span>
<span id="cb340-3"><a aria-hidden="true" href="#cb340-3" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb340-4"><a aria-hidden="true" href="#cb340-4" tabindex="-1"></a>  <span class="kw">struct</span> sblock <span class="op">*</span>next<span class="op">;</span>              <span class="co">/* Next in list */</span></span>
<span id="cb340-5"><a aria-hidden="true" href="#cb340-5" tabindex="-1"></a>  sdata <span class="op">*</span>next_free<span class="op">;</span>                 <span class="co">/* Next free sdata block */</span></span>
<span id="cb340-6"><a aria-hidden="true" href="#cb340-6" tabindex="-1"></a>  sdata data<span class="op">[</span>FLEXIBLE_ARRAY_MEMBER<span class="op">];</span> <span class="co">/* String data */</span></span>
<span id="cb340-7"><a aria-hidden="true" href="#cb340-7" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<p>Key constants:</p>
<div class="sourceCode" id="cb341"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb341-1"><a aria-hidden="true" href="#cb341-1" tabindex="-1"></a><span class="co">/* From src/alloc.c:1343 */</span></span>
<span id="cb341-2"><a aria-hidden="true" href="#cb341-2" tabindex="-1"></a><span class="kw">enum</span> <span class="op">{</span> SBLOCK_SIZE <span class="op">=</span> MALLOC_SIZE_NEAR <span class="op">(</span><span class="dv">8192</span><span class="op">)</span> <span class="op">};</span></span>
<span id="cb341-3"><a aria-hidden="true" href="#cb341-3" tabindex="-1"></a></span>
<span id="cb341-4"><a aria-hidden="true" href="#cb341-4" tabindex="-1"></a><span class="co">/* Strings larger than this are considered large strings.  */</span></span>
<span id="cb341-5"><a aria-hidden="true" href="#cb341-5" tabindex="-1"></a><span class="pp">#define LARGE_STRING_BYTES </span><span class="dv">1024</span></span></code></pre></div>
<h3 data-number="12.3.4" id="vector-allocation"><span class="header-section-number">12.3.4</span> Vector Allocation</h3>
<p>Vectors use a sophisticated <strong>block allocator with multiple
free lists</strong>:</p>
<div class="sourceCode" id="cb342"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb342-1"><a aria-hidden="true" href="#cb342-1" tabindex="-1"></a><span class="co">/* From src/alloc.c:2760 */</span></span>
<span id="cb342-2"><a aria-hidden="true" href="#cb342-2" tabindex="-1"></a><span class="kw">enum</span> <span class="op">{</span> VECTOR_BLOCK_SIZE <span class="op">=</span> <span class="dv">4096</span> <span class="op">};</span></span>
<span id="cb342-3"><a aria-hidden="true" href="#cb342-3" tabindex="-1"></a></span>
<span id="cb342-4"><a aria-hidden="true" href="#cb342-4" tabindex="-1"></a><span class="co">/* Vector size requests are a multiple of this.  */</span></span>
<span id="cb342-5"><a aria-hidden="true" href="#cb342-5" tabindex="-1"></a><span class="kw">enum</span> <span class="op">{</span> roundup_size <span class="op">=</span> COMMON_MULTIPLE <span class="op">(</span>LISP_ALIGNMENT<span class="op">,</span> word_size<span class="op">)</span> <span class="op">};</span></span>
<span id="cb342-6"><a aria-hidden="true" href="#cb342-6" tabindex="-1"></a></span>
<span id="cb342-7"><a aria-hidden="true" href="#cb342-7" tabindex="-1"></a><span class="kw">enum</span> <span class="op">{</span>VECTOR_BLOCK_BYTES <span class="op">=</span> VECTOR_BLOCK_SIZE <span class="op">-</span> vroundup_ct <span class="op">(</span><span class="kw">sizeof</span> <span class="op">(</span><span class="dt">void</span> <span class="op">*))};</span></span></code></pre></div>
<p>Vector blocks contain multiple small vectors:</p>
<div class="sourceCode" id="cb343"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb343-1"><a aria-hidden="true" href="#cb343-1" tabindex="-1"></a><span class="co">/* From src/alloc.c:2845 */</span></span>
<span id="cb343-2"><a aria-hidden="true" href="#cb343-2" tabindex="-1"></a><span class="kw">struct</span> vector_block</span>
<span id="cb343-3"><a aria-hidden="true" href="#cb343-3" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb343-4"><a aria-hidden="true" href="#cb343-4" tabindex="-1"></a>  <span class="dt">char</span> data<span class="op">[</span>VECTOR_BLOCK_BYTES<span class="op">];</span></span>
<span id="cb343-5"><a aria-hidden="true" href="#cb343-5" tabindex="-1"></a>  <span class="kw">struct</span> vector_block <span class="op">*</span>next<span class="op">;</span></span>
<span id="cb343-6"><a aria-hidden="true" href="#cb343-6" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<p>Large vectors get their own allocation:</p>
<div class="sourceCode" id="cb344"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb344-1"><a aria-hidden="true" href="#cb344-1" tabindex="-1"></a><span class="co">/* From src/alloc.c:2826 */</span></span>
<span id="cb344-2"><a aria-hidden="true" href="#cb344-2" tabindex="-1"></a><span class="co">/* This internal type is used to maintain the list of large vectors</span></span>
<span id="cb344-3"><a aria-hidden="true" href="#cb344-3" tabindex="-1"></a><span class="co">   which are allocated at their own, e.g. outside of vector blocks. */</span></span>
<span id="cb344-4"><a aria-hidden="true" href="#cb344-4" tabindex="-1"></a></span>
<span id="cb344-5"><a aria-hidden="true" href="#cb344-5" tabindex="-1"></a><span class="kw">struct</span> large_vector</span>
<span id="cb344-6"><a aria-hidden="true" href="#cb344-6" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb344-7"><a aria-hidden="true" href="#cb344-7" tabindex="-1"></a>  <span class="kw">struct</span> large_vector <span class="op">*</span>next<span class="op">;</span></span>
<span id="cb344-8"><a aria-hidden="true" href="#cb344-8" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<p>Free lists organized by size:</p>
<div class="sourceCode" id="cb345"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb345-1"><a aria-hidden="true" href="#cb345-1" tabindex="-1"></a><span class="co">/* From src/alloc.c:2855 */</span></span>
<span id="cb345-2"><a aria-hidden="true" href="#cb345-2" tabindex="-1"></a><span class="co">/* Vector free lists, where NTH item points to a chain of free</span></span>
<span id="cb345-3"><a aria-hidden="true" href="#cb345-3" tabindex="-1"></a><span class="co">   vectors of the same NBYTES size, so NTH == VINDEX (NBYTES),</span></span>
<span id="cb345-4"><a aria-hidden="true" href="#cb345-4" tabindex="-1"></a><span class="co">   except for the last element which may contain larger vectors. */</span></span>
<span id="cb345-5"><a aria-hidden="true" href="#cb345-5" tabindex="-1"></a></span>
<span id="cb345-6"><a aria-hidden="true" href="#cb345-6" tabindex="-1"></a><span class="dt">static</span> <span class="kw">struct</span> Lisp_Vector <span class="op">*</span>vector_free_lists<span class="op">[</span>VECTOR_FREE_LIST_ARRAY_SIZE<span class="op">];</span></span></code></pre></div>
<p>The allocation algorithm:</p>
<div class="sourceCode" id="cb346"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb346-1"><a aria-hidden="true" href="#cb346-1" tabindex="-1"></a><span class="co">/* From src/alloc.c:2968 */</span></span>
<span id="cb346-2"><a aria-hidden="true" href="#cb346-2" tabindex="-1"></a><span class="dt">static</span> <span class="kw">struct</span> Lisp_Vector <span class="op">*</span></span>
<span id="cb346-3"><a aria-hidden="true" href="#cb346-3" tabindex="-1"></a>allocate_vector_from_block <span class="op">(</span><span class="dt">ptrdiff_t</span> nbytes<span class="op">)</span></span>
<span id="cb346-4"><a aria-hidden="true" href="#cb346-4" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb346-5"><a aria-hidden="true" href="#cb346-5" tabindex="-1"></a>  <span class="kw">struct</span> Lisp_Vector <span class="op">*</span>vector<span class="op">;</span></span>
<span id="cb346-6"><a aria-hidden="true" href="#cb346-6" tabindex="-1"></a>  <span class="kw">struct</span> vector_block <span class="op">*</span>block<span class="op">;</span></span>
<span id="cb346-7"><a aria-hidden="true" href="#cb346-7" tabindex="-1"></a>  <span class="dt">size_t</span> index<span class="op">,</span> restbytes<span class="op">;</span></span>
<span id="cb346-8"><a aria-hidden="true" href="#cb346-8" tabindex="-1"></a></span>
<span id="cb346-9"><a aria-hidden="true" href="#cb346-9" tabindex="-1"></a>  <span class="co">/* First, try to allocate from a free list</span></span>
<span id="cb346-10"><a aria-hidden="true" href="#cb346-10" tabindex="-1"></a><span class="co">     containing vectors of the requested size.  */</span></span>
<span id="cb346-11"><a aria-hidden="true" href="#cb346-11" tabindex="-1"></a>  index <span class="op">=</span> VINDEX <span class="op">(</span>nbytes<span class="op">);</span></span>
<span id="cb346-12"><a aria-hidden="true" href="#cb346-12" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>vector_free_lists<span class="op">[</span>index<span class="op">])</span></span>
<span id="cb346-13"><a aria-hidden="true" href="#cb346-13" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb346-14"><a aria-hidden="true" href="#cb346-14" tabindex="-1"></a>      vector <span class="op">=</span> vector_free_lists<span class="op">[</span>index<span class="op">];</span></span>
<span id="cb346-15"><a aria-hidden="true" href="#cb346-15" tabindex="-1"></a>      ASAN_UNPOISON_VECTOR_CONTENTS <span class="op">(</span>vector<span class="op">,</span> nbytes <span class="op">-</span> header_size<span class="op">);</span></span>
<span id="cb346-16"><a aria-hidden="true" href="#cb346-16" tabindex="-1"></a>      vector_free_lists<span class="op">[</span>index<span class="op">]</span> <span class="op">=</span> next_vector <span class="op">(</span>vector<span class="op">);</span></span>
<span id="cb346-17"><a aria-hidden="true" href="#cb346-17" tabindex="-1"></a>      <span class="cf">return</span> vector<span class="op">;</span></span>
<span id="cb346-18"><a aria-hidden="true" href="#cb346-18" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb346-19"><a aria-hidden="true" href="#cb346-19" tabindex="-1"></a></span>
<span id="cb346-20"><a aria-hidden="true" href="#cb346-20" tabindex="-1"></a>  <span class="co">/* Next, check free lists containing larger vectors. */</span></span>
<span id="cb346-21"><a aria-hidden="true" href="#cb346-21" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span>index <span class="op">=</span> max <span class="op">(</span>VINDEX <span class="op">(</span>nbytes <span class="op">+</span> VBLOCK_BYTES_MIN<span class="op">),</span></span>
<span id="cb346-22"><a aria-hidden="true" href="#cb346-22" tabindex="-1"></a>            last_inserted_vector_free_idx<span class="op">);</span></span>
<span id="cb346-23"><a aria-hidden="true" href="#cb346-23" tabindex="-1"></a>       index <span class="op">&lt;</span> VECTOR_FREE_LIST_ARRAY_SIZE<span class="op">;</span> index<span class="op">++)</span></span>
<span id="cb346-24"><a aria-hidden="true" href="#cb346-24" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>vector_free_lists<span class="op">[</span>index<span class="op">])</span></span>
<span id="cb346-25"><a aria-hidden="true" href="#cb346-25" tabindex="-1"></a>      <span class="op">{</span></span>
<span id="cb346-26"><a aria-hidden="true" href="#cb346-26" tabindex="-1"></a>    <span class="co">/* This vector is larger than requested. Split it. */</span></span>
<span id="cb346-27"><a aria-hidden="true" href="#cb346-27" tabindex="-1"></a>    vector <span class="op">=</span> vector_free_lists<span class="op">[</span>index<span class="op">];</span></span>
<span id="cb346-28"><a aria-hidden="true" href="#cb346-28" tabindex="-1"></a>    <span class="dt">size_t</span> vector_nbytes <span class="op">=</span> pseudovector_nbytes <span class="op">(&amp;</span>vector<span class="op">-&gt;</span>header<span class="op">);</span></span>
<span id="cb346-29"><a aria-hidden="true" href="#cb346-29" tabindex="-1"></a>    vector_free_lists<span class="op">[</span>index<span class="op">]</span> <span class="op">=</span> next_vector <span class="op">(</span>vector<span class="op">);</span></span>
<span id="cb346-30"><a aria-hidden="true" href="#cb346-30" tabindex="-1"></a></span>
<span id="cb346-31"><a aria-hidden="true" href="#cb346-31" tabindex="-1"></a>    <span class="co">/* Excess bytes are used for the smaller vector. */</span></span>
<span id="cb346-32"><a aria-hidden="true" href="#cb346-32" tabindex="-1"></a>    restbytes <span class="op">=</span> vector_nbytes <span class="op">-</span> nbytes<span class="op">;</span></span>
<span id="cb346-33"><a aria-hidden="true" href="#cb346-33" tabindex="-1"></a>    setup_on_free_list <span class="op">(</span>ADVANCE <span class="op">(</span>vector<span class="op">,</span> nbytes<span class="op">),</span> restbytes<span class="op">);</span></span>
<span id="cb346-34"><a aria-hidden="true" href="#cb346-34" tabindex="-1"></a>    <span class="cf">return</span> vector<span class="op">;</span></span>
<span id="cb346-35"><a aria-hidden="true" href="#cb346-35" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb346-36"><a aria-hidden="true" href="#cb346-36" tabindex="-1"></a></span>
<span id="cb346-37"><a aria-hidden="true" href="#cb346-37" tabindex="-1"></a>  <span class="co">/* Finally, need a new vector block.  */</span></span>
<span id="cb346-38"><a aria-hidden="true" href="#cb346-38" tabindex="-1"></a>  block <span class="op">=</span> allocate_vector_block <span class="op">();</span></span>
<span id="cb346-39"><a aria-hidden="true" href="#cb346-39" tabindex="-1"></a>  vector <span class="op">=</span> <span class="op">(</span><span class="kw">struct</span> Lisp_Vector <span class="op">*)</span> block<span class="op">-&gt;</span>data<span class="op">;</span></span>
<span id="cb346-40"><a aria-hidden="true" href="#cb346-40" tabindex="-1"></a></span>
<span id="cb346-41"><a aria-hidden="true" href="#cb346-41" tabindex="-1"></a>  <span class="co">/* Set up remaining space on free list */</span></span>
<span id="cb346-42"><a aria-hidden="true" href="#cb346-42" tabindex="-1"></a>  restbytes <span class="op">=</span> VECTOR_BLOCK_BYTES <span class="op">-</span> nbytes<span class="op">;</span></span>
<span id="cb346-43"><a aria-hidden="true" href="#cb346-43" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>restbytes <span class="op">&gt;=</span> VBLOCK_BYTES_MIN<span class="op">)</span></span>
<span id="cb346-44"><a aria-hidden="true" href="#cb346-44" tabindex="-1"></a>    setup_on_free_list <span class="op">(</span>ADVANCE <span class="op">(</span>vector<span class="op">,</span> nbytes<span class="op">),</span> restbytes<span class="op">);</span></span>
<span id="cb346-45"><a aria-hidden="true" href="#cb346-45" tabindex="-1"></a></span>
<span id="cb346-46"><a aria-hidden="true" href="#cb346-46" tabindex="-1"></a>  <span class="cf">return</span> vector<span class="op">;</span></span>
<span id="cb346-47"><a aria-hidden="true" href="#cb346-47" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 data-number="12.3.5" id="float-and-symbol-allocation"><span class="header-section-number">12.3.5</span> Float and Symbol
Allocation</h3>
<p>Floats and symbols use simpler block-based allocation similar to cons
cells, with free lists for fast reuse.</p>
<h3 data-number="12.3.6" id="low-level-allocators"><span class="header-section-number">12.3.6</span> Low-Level Allocators</h3>
<h4 data-number="12.3.6.1" id="lisp_malloc"><span class="header-section-number">12.3.6.1</span> lisp_malloc</h4>
<p>The primary allocator for Lisp objects:</p>
<div class="sourceCode" id="cb347"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb347-1"><a aria-hidden="true" href="#cb347-1" tabindex="-1"></a><span class="co">/* From src/alloc.c:876 */</span></span>
<span id="cb347-2"><a aria-hidden="true" href="#cb347-2" tabindex="-1"></a><span class="dt">void</span> <span class="op">*</span></span>
<span id="cb347-3"><a aria-hidden="true" href="#cb347-3" tabindex="-1"></a>lisp_malloc <span class="op">(</span><span class="dt">size_t</span> nbytes<span class="op">,</span> <span class="dt">bool</span> clearit<span class="op">,</span> <span class="kw">enum</span> mem_type type<span class="op">)</span></span>
<span id="cb347-4"><a aria-hidden="true" href="#cb347-4" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb347-5"><a aria-hidden="true" href="#cb347-5" tabindex="-1"></a>  <span class="dt">register</span> <span class="dt">void</span> <span class="op">*</span>val<span class="op">;</span></span>
<span id="cb347-6"><a aria-hidden="true" href="#cb347-6" tabindex="-1"></a></span>
<span id="cb347-7"><a aria-hidden="true" href="#cb347-7" tabindex="-1"></a><span class="pp">#ifdef GC_MALLOC_CHECK</span></span>
<span id="cb347-8"><a aria-hidden="true" href="#cb347-8" tabindex="-1"></a>  allocated_mem_type <span class="op">=</span> type<span class="op">;</span></span>
<span id="cb347-9"><a aria-hidden="true" href="#cb347-9" tabindex="-1"></a><span class="pp">#endif</span></span>
<span id="cb347-10"><a aria-hidden="true" href="#cb347-10" tabindex="-1"></a></span>
<span id="cb347-11"><a aria-hidden="true" href="#cb347-11" tabindex="-1"></a>  val <span class="op">=</span> clearit <span class="op">?</span> calloc <span class="op">(</span><span class="dv">1</span><span class="op">,</span> nbytes<span class="op">)</span> <span class="op">:</span> malloc <span class="op">(</span>nbytes<span class="op">);</span></span>
<span id="cb347-12"><a aria-hidden="true" href="#cb347-12" tabindex="-1"></a></span>
<span id="cb347-13"><a aria-hidden="true" href="#cb347-13" tabindex="-1"></a>  <span class="co">/* Record this allocation in the mem_node tree */</span></span>
<span id="cb347-14"><a aria-hidden="true" href="#cb347-14" tabindex="-1"></a><span class="pp">#ifndef GC_MALLOC_CHECK</span></span>
<span id="cb347-15"><a aria-hidden="true" href="#cb347-15" tabindex="-1"></a>  <span class="kw">struct</span> mem_node <span class="op">*</span>m <span class="op">=</span> mem_insert <span class="op">(</span>val<span class="op">,</span> <span class="op">(</span><span class="dt">char</span> <span class="op">*)</span> val <span class="op">+</span> nbytes<span class="op">,</span> type<span class="op">);</span></span>
<span id="cb347-16"><a aria-hidden="true" href="#cb347-16" tabindex="-1"></a><span class="pp">#endif</span></span>
<span id="cb347-17"><a aria-hidden="true" href="#cb347-17" tabindex="-1"></a></span>
<span id="cb347-18"><a aria-hidden="true" href="#cb347-18" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(!</span>val <span class="op">&amp;&amp;</span> nbytes<span class="op">)</span></span>
<span id="cb347-19"><a aria-hidden="true" href="#cb347-19" tabindex="-1"></a>    memory_full <span class="op">(</span>nbytes<span class="op">);</span></span>
<span id="cb347-20"><a aria-hidden="true" href="#cb347-20" tabindex="-1"></a></span>
<span id="cb347-21"><a aria-hidden="true" href="#cb347-21" tabindex="-1"></a>  <span class="cf">return</span> val<span class="op">;</span></span>
<span id="cb347-22"><a aria-hidden="true" href="#cb347-22" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h4 data-number="12.3.6.2" id="lisp_align_malloc"><span class="header-section-number">12.3.6.2</span> lisp_align_malloc</h4>
<p>For objects requiring special alignment (e.g., cons blocks):</p>
<div class="sourceCode" id="cb348"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb348-1"><a aria-hidden="true" href="#cb348-1" tabindex="-1"></a><span class="co">/* From src/alloc.c:930 */</span></span>
<span id="cb348-2"><a aria-hidden="true" href="#cb348-2" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> <span class="op">*</span></span>
<span id="cb348-3"><a aria-hidden="true" href="#cb348-3" tabindex="-1"></a>lisp_align_malloc <span class="op">(</span><span class="dt">size_t</span> nbytes<span class="op">,</span> <span class="kw">enum</span> mem_type type<span class="op">)</span></span>
<span id="cb348-4"><a aria-hidden="true" href="#cb348-4" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb348-5"><a aria-hidden="true" href="#cb348-5" tabindex="-1"></a>  <span class="dt">void</span> <span class="op">*</span>base <span class="op">=</span> malloc <span class="op">(</span>nbytes <span class="op">+</span> BLOCK_ALIGN<span class="op">);</span></span>
<span id="cb348-6"><a aria-hidden="true" href="#cb348-6" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>base <span class="op">==</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb348-7"><a aria-hidden="true" href="#cb348-7" tabindex="-1"></a>    memory_full <span class="op">(</span>nbytes<span class="op">);</span></span>
<span id="cb348-8"><a aria-hidden="true" href="#cb348-8" tabindex="-1"></a></span>
<span id="cb348-9"><a aria-hidden="true" href="#cb348-9" tabindex="-1"></a>  <span class="co">/* Align to BLOCK_ALIGN boundary */</span></span>
<span id="cb348-10"><a aria-hidden="true" href="#cb348-10" tabindex="-1"></a>  <span class="dt">void</span> <span class="op">*</span>val <span class="op">=</span> <span class="op">(</span><span class="dt">void</span> <span class="op">*)</span> ROUNDUP <span class="op">((</span><span class="dt">uintptr_t</span><span class="op">)</span> base<span class="op">,</span> BLOCK_ALIGN<span class="op">);</span></span>
<span id="cb348-11"><a aria-hidden="true" href="#cb348-11" tabindex="-1"></a></span>
<span id="cb348-12"><a aria-hidden="true" href="#cb348-12" tabindex="-1"></a>  <span class="co">/* Record in mem_node tree */</span></span>
<span id="cb348-13"><a aria-hidden="true" href="#cb348-13" tabindex="-1"></a><span class="pp">#ifndef GC_MALLOC_CHECK</span></span>
<span id="cb348-14"><a aria-hidden="true" href="#cb348-14" tabindex="-1"></a>  mem_insert <span class="op">(</span>val<span class="op">,</span> <span class="op">(</span><span class="dt">char</span> <span class="op">*)</span> val <span class="op">+</span> nbytes<span class="op">,</span> type<span class="op">);</span></span>
<span id="cb348-15"><a aria-hidden="true" href="#cb348-15" tabindex="-1"></a><span class="pp">#endif</span></span>
<span id="cb348-16"><a aria-hidden="true" href="#cb348-16" tabindex="-1"></a></span>
<span id="cb348-17"><a aria-hidden="true" href="#cb348-17" tabindex="-1"></a>  <span class="cf">return</span> val<span class="op">;</span></span>
<span id="cb348-18"><a aria-hidden="true" href="#cb348-18" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 data-number="12.3.7" id="gmalloc.c---gnu-malloc"><span class="header-section-number">12.3.7</span> gmalloc.c - GNU malloc</h3>
<p>A custom malloc implementation used on some platforms:</p>
<div class="sourceCode" id="cb349"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb349-1"><a aria-hidden="true" href="#cb349-1" tabindex="-1"></a><span class="co">/* From src/gmalloc.c:94 */</span></span>
<span id="cb349-2"><a aria-hidden="true" href="#cb349-2" tabindex="-1"></a><span class="co">/* The allocator divides the heap into blocks of fixed size; large</span></span>
<span id="cb349-3"><a aria-hidden="true" href="#cb349-3" tabindex="-1"></a><span class="co">   requests receive one or more whole blocks, and small requests</span></span>
<span id="cb349-4"><a aria-hidden="true" href="#cb349-4" tabindex="-1"></a><span class="co">   receive a fragment of a block.  Fragment sizes are powers of two,</span></span>
<span id="cb349-5"><a aria-hidden="true" href="#cb349-5" tabindex="-1"></a><span class="co">   and all fragments of a block are the same size.  When all the</span></span>
<span id="cb349-6"><a aria-hidden="true" href="#cb349-6" tabindex="-1"></a><span class="co">   fragments in a block have been freed, the block itself is freed.  */</span></span>
<span id="cb349-7"><a aria-hidden="true" href="#cb349-7" tabindex="-1"></a></span>
<span id="cb349-8"><a aria-hidden="true" href="#cb349-8" tabindex="-1"></a><span class="pp">#define BLOCKLOG    </span><span class="op">(</span><span class="pp">INT_WIDTH </span><span class="op">&gt;</span><span class="pp"> </span><span class="dv">16</span><span class="pp"> </span><span class="op">?</span><span class="pp"> </span><span class="dv">12</span><span class="pp"> </span><span class="op">:</span><span class="pp"> </span><span class="dv">9</span><span class="op">)</span></span>
<span id="cb349-9"><a aria-hidden="true" href="#cb349-9" tabindex="-1"></a><span class="pp">#define BLOCKSIZE   </span><span class="op">(</span><span class="dv">1</span><span class="pp"> </span><span class="op">&lt;&lt;</span><span class="pp"> BLOCKLOG</span><span class="op">)</span></span></code></pre></div>
<h3 data-number="12.3.8" id="ralloc.c---relocating-allocator"><span class="header-section-number">12.3.8</span> ralloc.c - Relocating
Allocator</h3>
<p>A block-relocating allocator for buffer text:</p>
<div class="sourceCode" id="cb350"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb350-1"><a aria-hidden="true" href="#cb350-1" tabindex="-1"></a><span class="co">/* From src/ralloc.c:1 */</span></span>
<span id="cb350-2"><a aria-hidden="true" href="#cb350-2" tabindex="-1"></a><span class="co">/* Block-relocating memory allocator.</span></span>
<span id="cb350-3"><a aria-hidden="true" href="#cb350-3" tabindex="-1"></a></span>
<span id="cb350-4"><a aria-hidden="true" href="#cb350-4" tabindex="-1"></a><span class="co">   Only relocate the blocs necessary for SIZE in r_alloc_sbrk,</span></span>
<span id="cb350-5"><a aria-hidden="true" href="#cb350-5" tabindex="-1"></a><span class="co">   rather than all of them.  This means allowing for a possible</span></span>
<span id="cb350-6"><a aria-hidden="true" href="#cb350-6" tabindex="-1"></a><span class="co">   hole between the first bloc and the end of malloc storage.  */</span></span></code></pre></div>
<p>The relocating allocator allows buffer text to be moved in memory
without updating pointers, enabling efficient memory compaction.</p>
<hr/>
<h2 data-number="12.4" id="garbage-collection-algorithm"><span class="header-section-number">12.4</span> Garbage Collection
Algorithm</h2>
<h3 data-number="12.4.1" id="the-mark-and-sweep-strategy"><span class="header-section-number">12.4.1</span> The Mark-and-Sweep
Strategy</h3>
<p>Emacs uses a <strong>non-copying, mark-and-sweep</strong> garbage
collector:</p>
<ol type="1">
<li><strong>Mark Phase</strong>: Traverse all reachable objects from
roots, marking them</li>
<li><strong>Sweep Phase</strong>: Scan all allocated objects, freeing
unmarked ones</li>
</ol>
<p>This approach has several advantages: - No need to update pointers
(non-copying) - Works with conservative stack scanning - Simple and
predictable - Integrates well with C code</p>
<h3 data-number="12.4.2" id="gc-entry-point"><span class="header-section-number">12.4.2</span> GC Entry Point</h3>
<div class="sourceCode" id="cb351"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb351-1"><a aria-hidden="true" href="#cb351-1" tabindex="-1"></a><span class="co">/* From src/alloc.c:5778 */</span></span>
<span id="cb351-2"><a aria-hidden="true" href="#cb351-2" tabindex="-1"></a><span class="dt">void</span></span>
<span id="cb351-3"><a aria-hidden="true" href="#cb351-3" tabindex="-1"></a>garbage_collect <span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb351-4"><a aria-hidden="true" href="#cb351-4" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb351-5"><a aria-hidden="true" href="#cb351-5" tabindex="-1"></a>  Lisp_Object tail<span class="op">,</span> buffer<span class="op">;</span></span>
<span id="cb351-6"><a aria-hidden="true" href="#cb351-6" tabindex="-1"></a>  <span class="dt">char</span> stack_top_variable<span class="op">;</span></span>
<span id="cb351-7"><a aria-hidden="true" href="#cb351-7" tabindex="-1"></a>  <span class="dt">bool</span> message_p<span class="op">;</span></span>
<span id="cb351-8"><a aria-hidden="true" href="#cb351-8" tabindex="-1"></a>  specpdl_ref count <span class="op">=</span> SPECPDL_INDEX <span class="op">();</span></span>
<span id="cb351-9"><a aria-hidden="true" href="#cb351-9" tabindex="-1"></a>  <span class="kw">struct</span> timespec start<span class="op">;</span></span>
<span id="cb351-10"><a aria-hidden="true" href="#cb351-10" tabindex="-1"></a></span>
<span id="cb351-11"><a aria-hidden="true" href="#cb351-11" tabindex="-1"></a>  eassert <span class="op">(</span>weak_hash_tables <span class="op">==</span> NULL<span class="op">);</span></span>
<span id="cb351-12"><a aria-hidden="true" href="#cb351-12" tabindex="-1"></a></span>
<span id="cb351-13"><a aria-hidden="true" href="#cb351-13" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>garbage_collection_inhibited<span class="op">)</span></span>
<span id="cb351-14"><a aria-hidden="true" href="#cb351-14" tabindex="-1"></a>    <span class="cf">return</span><span class="op">;</span></span>
<span id="cb351-15"><a aria-hidden="true" href="#cb351-15" tabindex="-1"></a></span>
<span id="cb351-16"><a aria-hidden="true" href="#cb351-16" tabindex="-1"></a>  <span class="co">/* Record this function for profiler backtraces */</span></span>
<span id="cb351-17"><a aria-hidden="true" href="#cb351-17" tabindex="-1"></a>  record_in_backtrace <span class="op">(</span>QAutomatic_GC<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb351-18"><a aria-hidden="true" href="#cb351-18" tabindex="-1"></a></span>
<span id="cb351-19"><a aria-hidden="true" href="#cb351-19" tabindex="-1"></a>  <span class="co">/* Compact undo lists early */</span></span>
<span id="cb351-20"><a aria-hidden="true" href="#cb351-20" tabindex="-1"></a>  FOR_EACH_LIVE_BUFFER <span class="op">(</span>tail<span class="op">,</span> buffer<span class="op">)</span></span>
<span id="cb351-21"><a aria-hidden="true" href="#cb351-21" tabindex="-1"></a>    compact_buffer <span class="op">(</span>XBUFFER <span class="op">(</span>buffer<span class="op">));</span></span>
<span id="cb351-22"><a aria-hidden="true" href="#cb351-22" tabindex="-1"></a></span>
<span id="cb351-23"><a aria-hidden="true" href="#cb351-23" tabindex="-1"></a>  start <span class="op">=</span> current_timespec <span class="op">();</span></span>
<span id="cb351-24"><a aria-hidden="true" href="#cb351-24" tabindex="-1"></a></span>
<span id="cb351-25"><a aria-hidden="true" href="#cb351-25" tabindex="-1"></a>  <span class="co">/* Prevent recursive GC */</span></span>
<span id="cb351-26"><a aria-hidden="true" href="#cb351-26" tabindex="-1"></a>  consing_until_gc <span class="op">=</span> HI_THRESHOLD<span class="op">;</span></span>
<span id="cb351-27"><a aria-hidden="true" href="#cb351-27" tabindex="-1"></a></span>
<span id="cb351-28"><a aria-hidden="true" href="#cb351-28" tabindex="-1"></a>  <span class="co">/* Save stack for conservative scanning */</span></span>
<span id="cb351-29"><a aria-hidden="true" href="#cb351-29" tabindex="-1"></a><span class="pp">#if MAX_SAVE_STACK &gt; 0</span></span>
<span id="cb351-30"><a aria-hidden="true" href="#cb351-30" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>NILP <span class="op">(</span>Vpurify_flag<span class="op">))</span></span>
<span id="cb351-31"><a aria-hidden="true" href="#cb351-31" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb351-32"><a aria-hidden="true" href="#cb351-32" tabindex="-1"></a>      <span class="co">/* Save a copy of the stack for debugging */</span></span>
<span id="cb351-33"><a aria-hidden="true" href="#cb351-33" tabindex="-1"></a>      <span class="dt">char</span> <span class="dt">const</span> <span class="op">*</span>stack<span class="op">;</span></span>
<span id="cb351-34"><a aria-hidden="true" href="#cb351-34" tabindex="-1"></a>      <span class="dt">ptrdiff_t</span> stack_size<span class="op">;</span></span>
<span id="cb351-35"><a aria-hidden="true" href="#cb351-35" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(&amp;</span>stack_top_variable <span class="op">&lt;</span> stack_bottom<span class="op">)</span></span>
<span id="cb351-36"><a aria-hidden="true" href="#cb351-36" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb351-37"><a aria-hidden="true" href="#cb351-37" tabindex="-1"></a>      stack <span class="op">=</span> <span class="op">&amp;</span>stack_top_variable<span class="op">;</span></span>
<span id="cb351-38"><a aria-hidden="true" href="#cb351-38" tabindex="-1"></a>      stack_size <span class="op">=</span> stack_bottom <span class="op">-</span> <span class="op">&amp;</span>stack_top_variable<span class="op">;</span></span>
<span id="cb351-39"><a aria-hidden="true" href="#cb351-39" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb351-40"><a aria-hidden="true" href="#cb351-40" tabindex="-1"></a>      <span class="cf">else</span></span>
<span id="cb351-41"><a aria-hidden="true" href="#cb351-41" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb351-42"><a aria-hidden="true" href="#cb351-42" tabindex="-1"></a>      stack <span class="op">=</span> stack_bottom<span class="op">;</span></span>
<span id="cb351-43"><a aria-hidden="true" href="#cb351-43" tabindex="-1"></a>      stack_size <span class="op">=</span> <span class="op">&amp;</span>stack_top_variable <span class="op">-</span> stack_bottom<span class="op">;</span></span>
<span id="cb351-44"><a aria-hidden="true" href="#cb351-44" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb351-45"><a aria-hidden="true" href="#cb351-45" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span>stack_size <span class="op">&lt;=</span> MAX_SAVE_STACK<span class="op">)</span></span>
<span id="cb351-46"><a aria-hidden="true" href="#cb351-46" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb351-47"><a aria-hidden="true" href="#cb351-47" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span>stack_copy_size <span class="op">&lt;</span> stack_size<span class="op">)</span></span>
<span id="cb351-48"><a aria-hidden="true" href="#cb351-48" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb351-49"><a aria-hidden="true" href="#cb351-49" tabindex="-1"></a>          stack_copy <span class="op">=</span> xrealloc <span class="op">(</span>stack_copy<span class="op">,</span> stack_size<span class="op">);</span></span>
<span id="cb351-50"><a aria-hidden="true" href="#cb351-50" tabindex="-1"></a>          stack_copy_size <span class="op">=</span> stack_size<span class="op">;</span></span>
<span id="cb351-51"><a aria-hidden="true" href="#cb351-51" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb351-52"><a aria-hidden="true" href="#cb351-52" tabindex="-1"></a>      no_sanitize_memcpy <span class="op">(</span>stack_copy<span class="op">,</span> stack<span class="op">,</span> stack_size<span class="op">);</span></span>
<span id="cb351-53"><a aria-hidden="true" href="#cb351-53" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb351-54"><a aria-hidden="true" href="#cb351-54" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb351-55"><a aria-hidden="true" href="#cb351-55" tabindex="-1"></a><span class="pp">#endif</span></span>
<span id="cb351-56"><a aria-hidden="true" href="#cb351-56" tabindex="-1"></a></span>
<span id="cb351-57"><a aria-hidden="true" href="#cb351-57" tabindex="-1"></a>  gc_in_progress <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb351-58"><a aria-hidden="true" href="#cb351-58" tabindex="-1"></a></span>
<span id="cb351-59"><a aria-hidden="true" href="#cb351-59" tabindex="-1"></a>  <span class="co">/* MARK PHASE: Mark all reachable objects */</span></span>
<span id="cb351-60"><a aria-hidden="true" href="#cb351-60" tabindex="-1"></a></span>
<span id="cb351-61"><a aria-hidden="true" href="#cb351-61" tabindex="-1"></a>  <span class="kw">struct</span> gc_root_visitor visitor <span class="op">=</span> <span class="op">{</span> <span class="op">.</span>visit <span class="op">=</span> mark_object_root_visitor <span class="op">};</span></span>
<span id="cb351-62"><a aria-hidden="true" href="#cb351-62" tabindex="-1"></a>  visit_static_gc_roots <span class="op">(</span>visitor<span class="op">);</span></span>
<span id="cb351-63"><a aria-hidden="true" href="#cb351-63" tabindex="-1"></a></span>
<span id="cb351-64"><a aria-hidden="true" href="#cb351-64" tabindex="-1"></a>  mark_lread <span class="op">();</span></span>
<span id="cb351-65"><a aria-hidden="true" href="#cb351-65" tabindex="-1"></a>  mark_terminals <span class="op">();</span></span>
<span id="cb351-66"><a aria-hidden="true" href="#cb351-66" tabindex="-1"></a>  mark_kboards <span class="op">();</span></span>
<span id="cb351-67"><a aria-hidden="true" href="#cb351-67" tabindex="-1"></a>  mark_threads <span class="op">();</span></span>
<span id="cb351-68"><a aria-hidden="true" href="#cb351-68" tabindex="-1"></a>  mark_charset <span class="op">();</span></span>
<span id="cb351-69"><a aria-hidden="true" href="#cb351-69" tabindex="-1"></a>  mark_composite <span class="op">();</span></span>
<span id="cb351-70"><a aria-hidden="true" href="#cb351-70" tabindex="-1"></a>  mark_profiler <span class="op">();</span></span>
<span id="cb351-71"><a aria-hidden="true" href="#cb351-71" tabindex="-1"></a></span>
<span id="cb351-72"><a aria-hidden="true" href="#cb351-72" tabindex="-1"></a>  <span class="co">/* Platform-specific marking */</span></span>
<span id="cb351-73"><a aria-hidden="true" href="#cb351-73" tabindex="-1"></a><span class="pp">#ifdef USE_GTK</span></span>
<span id="cb351-74"><a aria-hidden="true" href="#cb351-74" tabindex="-1"></a>  xg_mark_data <span class="op">();</span></span>
<span id="cb351-75"><a aria-hidden="true" href="#cb351-75" tabindex="-1"></a><span class="pp">#endif</span></span>
<span id="cb351-76"><a aria-hidden="true" href="#cb351-76" tabindex="-1"></a></span>
<span id="cb351-77"><a aria-hidden="true" href="#cb351-77" tabindex="-1"></a>  <span class="co">/* Mark font caches, then compact them */</span></span>
<span id="cb351-78"><a aria-hidden="true" href="#cb351-78" tabindex="-1"></a>  compact_font_caches <span class="op">();</span></span>
<span id="cb351-79"><a aria-hidden="true" href="#cb351-79" tabindex="-1"></a></span>
<span id="cb351-80"><a aria-hidden="true" href="#cb351-80" tabindex="-1"></a>  <span class="co">/* Mark undo lists after compaction */</span></span>
<span id="cb351-81"><a aria-hidden="true" href="#cb351-81" tabindex="-1"></a>  FOR_EACH_LIVE_BUFFER <span class="op">(</span>tail<span class="op">,</span> buffer<span class="op">)</span></span>
<span id="cb351-82"><a aria-hidden="true" href="#cb351-82" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb351-83"><a aria-hidden="true" href="#cb351-83" tabindex="-1"></a>      <span class="kw">struct</span> buffer <span class="op">*</span>nextb <span class="op">=</span> XBUFFER <span class="op">(</span>buffer<span class="op">);</span></span>
<span id="cb351-84"><a aria-hidden="true" href="#cb351-84" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(!</span>EQ <span class="op">(</span>BVAR <span class="op">(</span>nextb<span class="op">,</span> undo_list<span class="op">),</span> Qt<span class="op">))</span></span>
<span id="cb351-85"><a aria-hidden="true" href="#cb351-85" tabindex="-1"></a>    bset_undo_list <span class="op">(</span>nextb<span class="op">,</span> compact_undo_list <span class="op">(</span>BVAR <span class="op">(</span>nextb<span class="op">,</span> undo_list<span class="op">)));</span></span>
<span id="cb351-86"><a aria-hidden="true" href="#cb351-86" tabindex="-1"></a>      mark_object <span class="op">(</span>BVAR <span class="op">(</span>nextb<span class="op">,</span> undo_list<span class="op">));</span></span>
<span id="cb351-87"><a aria-hidden="true" href="#cb351-87" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb351-88"><a aria-hidden="true" href="#cb351-88" tabindex="-1"></a></span>
<span id="cb351-89"><a aria-hidden="true" href="#cb351-89" tabindex="-1"></a>  <span class="co">/* Handle finalizers */</span></span>
<span id="cb351-90"><a aria-hidden="true" href="#cb351-90" tabindex="-1"></a>  queue_doomed_finalizers <span class="op">(&amp;</span>doomed_finalizers<span class="op">,</span> <span class="op">&amp;</span>finalizers<span class="op">);</span></span>
<span id="cb351-91"><a aria-hidden="true" href="#cb351-91" tabindex="-1"></a>  mark_finalizer_list <span class="op">(&amp;</span>doomed_finalizers<span class="op">);</span></span>
<span id="cb351-92"><a aria-hidden="true" href="#cb351-92" tabindex="-1"></a></span>
<span id="cb351-93"><a aria-hidden="true" href="#cb351-93" tabindex="-1"></a>  <span class="co">/* Handle weak hash tables */</span></span>
<span id="cb351-94"><a aria-hidden="true" href="#cb351-94" tabindex="-1"></a>  mark_and_sweep_weak_table_contents <span class="op">();</span></span>
<span id="cb351-95"><a aria-hidden="true" href="#cb351-95" tabindex="-1"></a>  eassert <span class="op">(</span>weak_hash_tables <span class="op">==</span> NULL<span class="op">);</span></span>
<span id="cb351-96"><a aria-hidden="true" href="#cb351-96" tabindex="-1"></a></span>
<span id="cb351-97"><a aria-hidden="true" href="#cb351-97" tabindex="-1"></a>  eassert <span class="op">(</span>mark_stack_empty_p <span class="op">());</span></span>
<span id="cb351-98"><a aria-hidden="true" href="#cb351-98" tabindex="-1"></a></span>
<span id="cb351-99"><a aria-hidden="true" href="#cb351-99" tabindex="-1"></a>  <span class="co">/* SWEEP PHASE: Free unmarked objects */</span></span>
<span id="cb351-100"><a aria-hidden="true" href="#cb351-100" tabindex="-1"></a>  gc_sweep <span class="op">();</span></span>
<span id="cb351-101"><a aria-hidden="true" href="#cb351-101" tabindex="-1"></a></span>
<span id="cb351-102"><a aria-hidden="true" href="#cb351-102" tabindex="-1"></a>  unmark_main_thread <span class="op">();</span></span>
<span id="cb351-103"><a aria-hidden="true" href="#cb351-103" tabindex="-1"></a></span>
<span id="cb351-104"><a aria-hidden="true" href="#cb351-104" tabindex="-1"></a>  gc_in_progress <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb351-105"><a aria-hidden="true" href="#cb351-105" tabindex="-1"></a></span>
<span id="cb351-106"><a aria-hidden="true" href="#cb351-106" tabindex="-1"></a>  <span class="co">/* Update GC threshold */</span></span>
<span id="cb351-107"><a aria-hidden="true" href="#cb351-107" tabindex="-1"></a>  consing_until_gc <span class="op">=</span> gc_threshold</span>
<span id="cb351-108"><a aria-hidden="true" href="#cb351-108" tabindex="-1"></a>    <span class="op">=</span> consing_threshold <span class="op">(</span>gc_cons_threshold<span class="op">,</span> Vgc_cons_percentage<span class="op">,</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb351-109"><a aria-hidden="true" href="#cb351-109" tabindex="-1"></a></span>
<span id="cb351-110"><a aria-hidden="true" href="#cb351-110" tabindex="-1"></a>  unblock_input <span class="op">();</span></span>
<span id="cb351-111"><a aria-hidden="true" href="#cb351-111" tabindex="-1"></a></span>
<span id="cb351-112"><a aria-hidden="true" href="#cb351-112" tabindex="-1"></a>  <span class="co">/* Run finalizers after GC completes */</span></span>
<span id="cb351-113"><a aria-hidden="true" href="#cb351-113" tabindex="-1"></a>  run_finalizers <span class="op">(&amp;</span>doomed_finalizers<span class="op">);</span></span>
<span id="cb351-114"><a aria-hidden="true" href="#cb351-114" tabindex="-1"></a></span>
<span id="cb351-115"><a aria-hidden="true" href="#cb351-115" tabindex="-1"></a>  <span class="co">/* Update statistics */</span></span>
<span id="cb351-116"><a aria-hidden="true" href="#cb351-116" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>FLOATP <span class="op">(</span>Vgc_elapsed<span class="op">))</span></span>
<span id="cb351-117"><a aria-hidden="true" href="#cb351-117" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb351-118"><a aria-hidden="true" href="#cb351-118" tabindex="-1"></a>      <span class="dt">static</span> <span class="kw">struct</span> timespec gc_elapsed<span class="op">;</span></span>
<span id="cb351-119"><a aria-hidden="true" href="#cb351-119" tabindex="-1"></a>      gc_elapsed <span class="op">=</span> timespec_add <span class="op">(</span>gc_elapsed<span class="op">,</span></span>
<span id="cb351-120"><a aria-hidden="true" href="#cb351-120" tabindex="-1"></a>                 timespec_sub <span class="op">(</span>current_timespec <span class="op">(),</span> start<span class="op">));</span></span>
<span id="cb351-121"><a aria-hidden="true" href="#cb351-121" tabindex="-1"></a>      Vgc_elapsed <span class="op">=</span> make_float <span class="op">(</span>timespectod <span class="op">(</span>gc_elapsed<span class="op">));</span></span>
<span id="cb351-122"><a aria-hidden="true" href="#cb351-122" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb351-123"><a aria-hidden="true" href="#cb351-123" tabindex="-1"></a></span>
<span id="cb351-124"><a aria-hidden="true" href="#cb351-124" tabindex="-1"></a>  gcs_done<span class="op">++;</span></span>
<span id="cb351-125"><a aria-hidden="true" href="#cb351-125" tabindex="-1"></a></span>
<span id="cb351-126"><a aria-hidden="true" href="#cb351-126" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(!</span>NILP <span class="op">(</span>Vpost_gc_hook<span class="op">))</span></span>
<span id="cb351-127"><a aria-hidden="true" href="#cb351-127" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb351-128"><a aria-hidden="true" href="#cb351-128" tabindex="-1"></a>      specpdl_ref gc_count <span class="op">=</span> inhibit_garbage_collection <span class="op">();</span></span>
<span id="cb351-129"><a aria-hidden="true" href="#cb351-129" tabindex="-1"></a>      safe_run_hooks <span class="op">(</span>Qpost_gc_hook<span class="op">);</span></span>
<span id="cb351-130"><a aria-hidden="true" href="#cb351-130" tabindex="-1"></a>      unbind_to <span class="op">(</span>gc_count<span class="op">,</span> Qnil<span class="op">);</span></span>
<span id="cb351-131"><a aria-hidden="true" href="#cb351-131" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb351-132"><a aria-hidden="true" href="#cb351-132" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 data-number="12.4.3" id="the-marking-phase"><span class="header-section-number">12.4.3</span> The Marking Phase</h3>
<h4 data-number="12.4.3.1" id="mark-stack"><span class="header-section-number">12.4.3.1</span> Mark Stack</h4>
<p>To avoid deep C recursion, marking uses an explicit stack:</p>
<div class="sourceCode" id="cb352"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb352-1"><a aria-hidden="true" href="#cb352-1" tabindex="-1"></a><span class="co">/* From src/alloc.c:6318 */</span></span>
<span id="cb352-2"><a aria-hidden="true" href="#cb352-2" tabindex="-1"></a><span class="co">/* Entry of the mark stack.  */</span></span>
<span id="cb352-3"><a aria-hidden="true" href="#cb352-3" tabindex="-1"></a><span class="kw">struct</span> mark_entry</span>
<span id="cb352-4"><a aria-hidden="true" href="#cb352-4" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb352-5"><a aria-hidden="true" href="#cb352-5" tabindex="-1"></a>  <span class="dt">ptrdiff_t</span> n<span class="op">;</span>              <span class="co">/* number of values, or 0 if a single value */</span></span>
<span id="cb352-6"><a aria-hidden="true" href="#cb352-6" tabindex="-1"></a>  <span class="kw">union</span> <span class="op">{</span></span>
<span id="cb352-7"><a aria-hidden="true" href="#cb352-7" tabindex="-1"></a>    Lisp_Object value<span class="op">;</span>      <span class="co">/* when n = 0 */</span></span>
<span id="cb352-8"><a aria-hidden="true" href="#cb352-8" tabindex="-1"></a>    Lisp_Object <span class="op">*</span>values<span class="op">;</span>    <span class="co">/* when n &gt; 0 */</span></span>
<span id="cb352-9"><a aria-hidden="true" href="#cb352-9" tabindex="-1"></a>  <span class="op">}</span> u<span class="op">;</span></span>
<span id="cb352-10"><a aria-hidden="true" href="#cb352-10" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb352-11"><a aria-hidden="true" href="#cb352-11" tabindex="-1"></a></span>
<span id="cb352-12"><a aria-hidden="true" href="#cb352-12" tabindex="-1"></a><span class="kw">struct</span> mark_stack</span>
<span id="cb352-13"><a aria-hidden="true" href="#cb352-13" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb352-14"><a aria-hidden="true" href="#cb352-14" tabindex="-1"></a>  <span class="kw">struct</span> mark_entry <span class="op">*</span>stack<span class="op">;</span> <span class="co">/* base of stack */</span></span>
<span id="cb352-15"><a aria-hidden="true" href="#cb352-15" tabindex="-1"></a>  <span class="dt">ptrdiff_t</span> size<span class="op">;</span>       <span class="co">/* allocated size in entries */</span></span>
<span id="cb352-16"><a aria-hidden="true" href="#cb352-16" tabindex="-1"></a>  <span class="dt">ptrdiff_t</span> sp<span class="op">;</span>         <span class="co">/* current number of entries */</span></span>
<span id="cb352-17"><a aria-hidden="true" href="#cb352-17" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb352-18"><a aria-hidden="true" href="#cb352-18" tabindex="-1"></a></span>
<span id="cb352-19"><a aria-hidden="true" href="#cb352-19" tabindex="-1"></a><span class="dt">static</span> <span class="kw">struct</span> mark_stack mark_stk <span class="op">=</span> <span class="op">{</span>NULL<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">};</span></span></code></pre></div>
<h4 data-number="12.4.3.2" id="the-mark_object-function"><span class="header-section-number">12.4.3.2</span> The mark_object
Function</h4>
<p>The core marking function:</p>
<div class="sourceCode" id="cb353"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb353-1"><a aria-hidden="true" href="#cb353-1" tabindex="-1"></a><span class="co">/* From src/alloc.c:6720 */</span></span>
<span id="cb353-2"><a aria-hidden="true" href="#cb353-2" tabindex="-1"></a><span class="dt">void</span></span>
<span id="cb353-3"><a aria-hidden="true" href="#cb353-3" tabindex="-1"></a>mark_object <span class="op">(</span>Lisp_Object obj<span class="op">)</span></span>
<span id="cb353-4"><a aria-hidden="true" href="#cb353-4" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb353-5"><a aria-hidden="true" href="#cb353-5" tabindex="-1"></a>  <span class="dt">ptrdiff_t</span> sp <span class="op">=</span> mark_stk<span class="op">.</span>sp<span class="op">;</span></span>
<span id="cb353-6"><a aria-hidden="true" href="#cb353-6" tabindex="-1"></a>  mark_stack_push_value <span class="op">(</span>obj<span class="op">);</span></span>
<span id="cb353-7"><a aria-hidden="true" href="#cb353-7" tabindex="-1"></a>  process_mark_stack <span class="op">(</span>sp<span class="op">);</span></span>
<span id="cb353-8"><a aria-hidden="true" href="#cb353-8" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h4 data-number="12.4.3.3" id="processing-the-mark-stack"><span class="header-section-number">12.4.3.3</span> Processing the Mark
Stack</h4>
<div class="sourceCode" id="cb354"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb354-1"><a aria-hidden="true" href="#cb354-1" tabindex="-1"></a><span class="co">/* From src/alloc.c:6470 */</span></span>
<span id="cb354-2"><a aria-hidden="true" href="#cb354-2" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span></span>
<span id="cb354-3"><a aria-hidden="true" href="#cb354-3" tabindex="-1"></a>process_mark_stack <span class="op">(</span><span class="dt">ptrdiff_t</span> base_sp<span class="op">)</span></span>
<span id="cb354-4"><a aria-hidden="true" href="#cb354-4" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb354-5"><a aria-hidden="true" href="#cb354-5" tabindex="-1"></a>  <span class="cf">while</span> <span class="op">(</span>mark_stk<span class="op">.</span>sp <span class="op">&gt;</span> base_sp<span class="op">)</span></span>
<span id="cb354-6"><a aria-hidden="true" href="#cb354-6" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb354-7"><a aria-hidden="true" href="#cb354-7" tabindex="-1"></a>      Lisp_Object obj <span class="op">=</span> mark_stack_pop <span class="op">();</span></span>
<span id="cb354-8"><a aria-hidden="true" href="#cb354-8" tabindex="-1"></a>    mark_obj<span class="op">:</span> <span class="op">;</span></span>
<span id="cb354-9"><a aria-hidden="true" href="#cb354-9" tabindex="-1"></a>      <span class="dt">void</span> <span class="op">*</span>po <span class="op">=</span> XPNTR <span class="op">(</span>obj<span class="op">);</span></span>
<span id="cb354-10"><a aria-hidden="true" href="#cb354-10" tabindex="-1"></a></span>
<span id="cb354-11"><a aria-hidden="true" href="#cb354-11" tabindex="-1"></a>      <span class="cf">switch</span> <span class="op">(</span>XTYPE <span class="op">(</span>obj<span class="op">))</span></span>
<span id="cb354-12"><a aria-hidden="true" href="#cb354-12" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb354-13"><a aria-hidden="true" href="#cb354-13" tabindex="-1"></a>    <span class="cf">case</span> Lisp_String<span class="op">:</span></span>
<span id="cb354-14"><a aria-hidden="true" href="#cb354-14" tabindex="-1"></a>      <span class="op">{</span></span>
<span id="cb354-15"><a aria-hidden="true" href="#cb354-15" tabindex="-1"></a>        <span class="kw">struct</span> Lisp_String <span class="op">*</span>ptr <span class="op">=</span> XSTRING <span class="op">(</span>obj<span class="op">);</span></span>
<span id="cb354-16"><a aria-hidden="true" href="#cb354-16" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>string_marked_p <span class="op">(</span>ptr<span class="op">))</span></span>
<span id="cb354-17"><a aria-hidden="true" href="#cb354-17" tabindex="-1"></a>          <span class="cf">break</span><span class="op">;</span></span>
<span id="cb354-18"><a aria-hidden="true" href="#cb354-18" tabindex="-1"></a>        check_allocated_and_live <span class="op">(</span>live_string_p<span class="op">,</span> MEM_TYPE_STRING<span class="op">,</span> po<span class="op">);</span></span>
<span id="cb354-19"><a aria-hidden="true" href="#cb354-19" tabindex="-1"></a>        set_string_marked <span class="op">(</span>ptr<span class="op">);</span></span>
<span id="cb354-20"><a aria-hidden="true" href="#cb354-20" tabindex="-1"></a>        mark_interval_tree <span class="op">(</span>ptr<span class="op">-&gt;</span>u<span class="op">.</span>s<span class="op">.</span>intervals<span class="op">);</span></span>
<span id="cb354-21"><a aria-hidden="true" href="#cb354-21" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb354-22"><a aria-hidden="true" href="#cb354-22" tabindex="-1"></a>      <span class="cf">break</span><span class="op">;</span></span>
<span id="cb354-23"><a aria-hidden="true" href="#cb354-23" tabindex="-1"></a></span>
<span id="cb354-24"><a aria-hidden="true" href="#cb354-24" tabindex="-1"></a>    <span class="cf">case</span> Lisp_Vectorlike<span class="op">:</span></span>
<span id="cb354-25"><a aria-hidden="true" href="#cb354-25" tabindex="-1"></a>      <span class="op">{</span></span>
<span id="cb354-26"><a aria-hidden="true" href="#cb354-26" tabindex="-1"></a>        <span class="kw">struct</span> Lisp_Vector <span class="op">*</span>ptr <span class="op">=</span> XVECTOR <span class="op">(</span>obj<span class="op">);</span></span>
<span id="cb354-27"><a aria-hidden="true" href="#cb354-27" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>vector_marked_p <span class="op">(</span>ptr<span class="op">))</span></span>
<span id="cb354-28"><a aria-hidden="true" href="#cb354-28" tabindex="-1"></a>          <span class="cf">break</span><span class="op">;</span></span>
<span id="cb354-29"><a aria-hidden="true" href="#cb354-29" tabindex="-1"></a></span>
<span id="cb354-30"><a aria-hidden="true" href="#cb354-30" tabindex="-1"></a>        <span class="kw">enum</span> pvec_type pvectype <span class="op">=</span> PSEUDOVECTOR_TYPE <span class="op">(</span>ptr<span class="op">);</span></span>
<span id="cb354-31"><a aria-hidden="true" href="#cb354-31" tabindex="-1"></a></span>
<span id="cb354-32"><a aria-hidden="true" href="#cb354-32" tabindex="-1"></a>        <span class="cf">switch</span> <span class="op">(</span>pvectype<span class="op">)</span></span>
<span id="cb354-33"><a aria-hidden="true" href="#cb354-33" tabindex="-1"></a>          <span class="op">{</span></span>
<span id="cb354-34"><a aria-hidden="true" href="#cb354-34" tabindex="-1"></a>          <span class="cf">case</span> PVEC_BUFFER<span class="op">:</span></span>
<span id="cb354-35"><a aria-hidden="true" href="#cb354-35" tabindex="-1"></a>        mark_buffer <span class="op">((</span><span class="kw">struct</span> buffer <span class="op">*)</span> ptr<span class="op">);</span></span>
<span id="cb354-36"><a aria-hidden="true" href="#cb354-36" tabindex="-1"></a>        <span class="cf">break</span><span class="op">;</span></span>
<span id="cb354-37"><a aria-hidden="true" href="#cb354-37" tabindex="-1"></a></span>
<span id="cb354-38"><a aria-hidden="true" href="#cb354-38" tabindex="-1"></a>          <span class="cf">case</span> PVEC_FRAME<span class="op">:</span></span>
<span id="cb354-39"><a aria-hidden="true" href="#cb354-39" tabindex="-1"></a>        mark_frame <span class="op">(</span>ptr<span class="op">);</span></span>
<span id="cb354-40"><a aria-hidden="true" href="#cb354-40" tabindex="-1"></a>        <span class="cf">break</span><span class="op">;</span></span>
<span id="cb354-41"><a aria-hidden="true" href="#cb354-41" tabindex="-1"></a></span>
<span id="cb354-42"><a aria-hidden="true" href="#cb354-42" tabindex="-1"></a>          <span class="cf">case</span> PVEC_HASH_TABLE<span class="op">:</span></span>
<span id="cb354-43"><a aria-hidden="true" href="#cb354-43" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb354-44"><a aria-hidden="true" href="#cb354-44" tabindex="-1"></a>          <span class="kw">struct</span> Lisp_Hash_Table <span class="op">*</span>h <span class="op">=</span> <span class="op">(</span><span class="kw">struct</span> Lisp_Hash_Table <span class="op">*)</span>ptr<span class="op">;</span></span>
<span id="cb354-45"><a aria-hidden="true" href="#cb354-45" tabindex="-1"></a>          set_vector_marked <span class="op">(</span>ptr<span class="op">);</span></span>
<span id="cb354-46"><a aria-hidden="true" href="#cb354-46" tabindex="-1"></a>          <span class="cf">if</span> <span class="op">(</span>h<span class="op">-&gt;</span>weakness <span class="op">==</span> Weak_None<span class="op">)</span></span>
<span id="cb354-47"><a aria-hidden="true" href="#cb354-47" tabindex="-1"></a>            <span class="co">/* Mark all keys and values */</span></span>
<span id="cb354-48"><a aria-hidden="true" href="#cb354-48" tabindex="-1"></a>            mark_stack_push_values <span class="op">(</span>h<span class="op">-&gt;</span>key_and_value<span class="op">,</span></span>
<span id="cb354-49"><a aria-hidden="true" href="#cb354-49" tabindex="-1"></a>                        <span class="dv">2</span> <span class="op">*</span> h<span class="op">-&gt;</span>table_size<span class="op">);</span></span>
<span id="cb354-50"><a aria-hidden="true" href="#cb354-50" tabindex="-1"></a>          <span class="cf">else</span></span>
<span id="cb354-51"><a aria-hidden="true" href="#cb354-51" tabindex="-1"></a>            <span class="op">{</span></span>
<span id="cb354-52"><a aria-hidden="true" href="#cb354-52" tabindex="-1"></a>              <span class="co">/* Defer weak table handling */</span></span>
<span id="cb354-53"><a aria-hidden="true" href="#cb354-53" tabindex="-1"></a>              eassert <span class="op">(</span>h<span class="op">-&gt;</span>next_weak <span class="op">==</span> NULL<span class="op">);</span></span>
<span id="cb354-54"><a aria-hidden="true" href="#cb354-54" tabindex="-1"></a>              h<span class="op">-&gt;</span>next_weak <span class="op">=</span> weak_hash_tables<span class="op">;</span></span>
<span id="cb354-55"><a aria-hidden="true" href="#cb354-55" tabindex="-1"></a>              weak_hash_tables <span class="op">=</span> h<span class="op">;</span></span>
<span id="cb354-56"><a aria-hidden="true" href="#cb354-56" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb354-57"><a aria-hidden="true" href="#cb354-57" tabindex="-1"></a>          <span class="cf">break</span><span class="op">;</span></span>
<span id="cb354-58"><a aria-hidden="true" href="#cb354-58" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb354-59"><a aria-hidden="true" href="#cb354-59" tabindex="-1"></a></span>
<span id="cb354-60"><a aria-hidden="true" href="#cb354-60" tabindex="-1"></a>          <span class="cf">default</span><span class="op">:</span></span>
<span id="cb354-61"><a aria-hidden="true" href="#cb354-61" tabindex="-1"></a>        mark_vectorlike <span class="op">(&amp;</span>ptr<span class="op">-&gt;</span>header<span class="op">);</span></span>
<span id="cb354-62"><a aria-hidden="true" href="#cb354-62" tabindex="-1"></a>        <span class="cf">break</span><span class="op">;</span></span>
<span id="cb354-63"><a aria-hidden="true" href="#cb354-63" tabindex="-1"></a>          <span class="op">}</span></span>
<span id="cb354-64"><a aria-hidden="true" href="#cb354-64" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb354-65"><a aria-hidden="true" href="#cb354-65" tabindex="-1"></a>      <span class="cf">break</span><span class="op">;</span></span>
<span id="cb354-66"><a aria-hidden="true" href="#cb354-66" tabindex="-1"></a></span>
<span id="cb354-67"><a aria-hidden="true" href="#cb354-67" tabindex="-1"></a>    <span class="cf">case</span> Lisp_Cons<span class="op">:</span></span>
<span id="cb354-68"><a aria-hidden="true" href="#cb354-68" tabindex="-1"></a>      <span class="op">{</span></span>
<span id="cb354-69"><a aria-hidden="true" href="#cb354-69" tabindex="-1"></a>        <span class="kw">struct</span> Lisp_Cons <span class="op">*</span>ptr <span class="op">=</span> XCONS <span class="op">(</span>obj<span class="op">);</span></span>
<span id="cb354-70"><a aria-hidden="true" href="#cb354-70" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>cons_marked_p <span class="op">(</span>ptr<span class="op">))</span></span>
<span id="cb354-71"><a aria-hidden="true" href="#cb354-71" tabindex="-1"></a>          <span class="cf">break</span><span class="op">;</span></span>
<span id="cb354-72"><a aria-hidden="true" href="#cb354-72" tabindex="-1"></a>        check_allocated_and_live <span class="op">(</span>live_cons_p<span class="op">,</span> MEM_TYPE_CONS<span class="op">,</span> po<span class="op">);</span></span>
<span id="cb354-73"><a aria-hidden="true" href="#cb354-73" tabindex="-1"></a>        set_cons_marked <span class="op">(</span>ptr<span class="op">);</span></span>
<span id="cb354-74"><a aria-hidden="true" href="#cb354-74" tabindex="-1"></a>        <span class="co">/* Optimize tail recursion for lists */</span></span>
<span id="cb354-75"><a aria-hidden="true" href="#cb354-75" tabindex="-1"></a>        mark_object <span class="op">(</span>ptr<span class="op">-&gt;</span>u<span class="op">.</span>s<span class="op">.</span>car<span class="op">);</span></span>
<span id="cb354-76"><a aria-hidden="true" href="#cb354-76" tabindex="-1"></a>        obj <span class="op">=</span> ptr<span class="op">-&gt;</span>u<span class="op">.</span>s<span class="op">.</span>u<span class="op">.</span>cdr<span class="op">;</span></span>
<span id="cb354-77"><a aria-hidden="true" href="#cb354-77" tabindex="-1"></a>        <span class="cf">goto</span> mark_obj<span class="op">;</span></span>
<span id="cb354-78"><a aria-hidden="true" href="#cb354-78" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb354-79"><a aria-hidden="true" href="#cb354-79" tabindex="-1"></a></span>
<span id="cb354-80"><a aria-hidden="true" href="#cb354-80" tabindex="-1"></a>    <span class="cf">case</span> Lisp_Float<span class="op">:</span></span>
<span id="cb354-81"><a aria-hidden="true" href="#cb354-81" tabindex="-1"></a>      <span class="op">{</span></span>
<span id="cb354-82"><a aria-hidden="true" href="#cb354-82" tabindex="-1"></a>        <span class="kw">struct</span> Lisp_Float <span class="op">*</span>f <span class="op">=</span> XFLOAT <span class="op">(</span>obj<span class="op">);</span></span>
<span id="cb354-83"><a aria-hidden="true" href="#cb354-83" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>pdumper_object_p <span class="op">(</span>f<span class="op">))</span></span>
<span id="cb354-84"><a aria-hidden="true" href="#cb354-84" tabindex="-1"></a>          eassert <span class="op">(</span>pdumper_cold_object_p <span class="op">(</span>f<span class="op">));</span></span>
<span id="cb354-85"><a aria-hidden="true" href="#cb354-85" tabindex="-1"></a>        <span class="cf">else</span> <span class="cf">if</span> <span class="op">(!</span>XFLOAT_MARKED_P <span class="op">(</span>f<span class="op">))</span></span>
<span id="cb354-86"><a aria-hidden="true" href="#cb354-86" tabindex="-1"></a>          XFLOAT_MARK <span class="op">(</span>f<span class="op">);</span></span>
<span id="cb354-87"><a aria-hidden="true" href="#cb354-87" tabindex="-1"></a>        <span class="cf">break</span><span class="op">;</span></span>
<span id="cb354-88"><a aria-hidden="true" href="#cb354-88" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb354-89"><a aria-hidden="true" href="#cb354-89" tabindex="-1"></a></span>
<span id="cb354-90"><a aria-hidden="true" href="#cb354-90" tabindex="-1"></a>    <span class="cf">case</span> Lisp_Int0<span class="op">:</span></span>
<span id="cb354-91"><a aria-hidden="true" href="#cb354-91" tabindex="-1"></a>    <span class="cf">case</span> Lisp_Int1<span class="op">:</span></span>
<span id="cb354-92"><a aria-hidden="true" href="#cb354-92" tabindex="-1"></a>      <span class="cf">break</span><span class="op">;</span></span>
<span id="cb354-93"><a aria-hidden="true" href="#cb354-93" tabindex="-1"></a></span>
<span id="cb354-94"><a aria-hidden="true" href="#cb354-94" tabindex="-1"></a>    <span class="cf">default</span><span class="op">:</span></span>
<span id="cb354-95"><a aria-hidden="true" href="#cb354-95" tabindex="-1"></a>      emacs_abort <span class="op">();</span></span>
<span id="cb354-96"><a aria-hidden="true" href="#cb354-96" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb354-97"><a aria-hidden="true" href="#cb354-97" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb354-98"><a aria-hidden="true" href="#cb354-98" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h4 data-number="12.4.3.4" id="mark-bits"><span class="header-section-number">12.4.3.4</span> Mark Bits</h4>
<p>Different object types use different marking strategies:</p>
<p><strong>Strings and Vectors</strong>: Mark bit in the size field:</p>
<div class="sourceCode" id="cb355"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb355-1"><a aria-hidden="true" href="#cb355-1" tabindex="-1"></a><span class="co">/* From src/alloc.c:265 */</span></span>
<span id="cb355-2"><a aria-hidden="true" href="#cb355-2" tabindex="-1"></a><span class="pp">#define XMARK_STRING</span><span class="op">(</span><span class="pp">S</span><span class="op">)</span><span class="pp">     </span><span class="op">((</span><span class="pp">S</span><span class="op">)-&gt;</span>u<span class="op">.</span><span class="pp">s</span><span class="op">.</span><span class="pp">size </span><span class="op">|=</span><span class="pp"> ARRAY_MARK_FLAG</span><span class="op">)</span></span>
<span id="cb355-3"><a aria-hidden="true" href="#cb355-3" tabindex="-1"></a><span class="pp">#define XUNMARK_STRING</span><span class="op">(</span><span class="pp">S</span><span class="op">)</span><span class="pp">   </span><span class="op">((</span><span class="pp">S</span><span class="op">)-&gt;</span>u<span class="op">.</span><span class="pp">s</span><span class="op">.</span><span class="pp">size </span><span class="op">&amp;=</span><span class="pp"> </span><span class="op">~</span><span class="pp">ARRAY_MARK_FLAG</span><span class="op">)</span></span>
<span id="cb355-4"><a aria-hidden="true" href="#cb355-4" tabindex="-1"></a><span class="pp">#define XSTRING_MARKED_P</span><span class="op">(</span><span class="pp">S</span><span class="op">)</span><span class="pp"> </span><span class="op">(((</span><span class="pp">S</span><span class="op">)-&gt;</span>u<span class="op">.</span><span class="pp">s</span><span class="op">.</span><span class="pp">size </span><span class="op">&amp;</span><span class="pp"> ARRAY_MARK_FLAG</span><span class="op">)</span><span class="pp"> </span><span class="op">!=</span><span class="pp"> </span><span class="dv">0</span><span class="op">)</span></span>
<span id="cb355-5"><a aria-hidden="true" href="#cb355-5" tabindex="-1"></a></span>
<span id="cb355-6"><a aria-hidden="true" href="#cb355-6" tabindex="-1"></a><span class="pp">#define XMARK_VECTOR</span><span class="op">(</span><span class="pp">V</span><span class="op">)</span><span class="pp">     </span><span class="op">((</span><span class="pp">V</span><span class="op">)-&gt;</span><span class="pp">header</span><span class="op">.</span><span class="pp">size </span><span class="op">|=</span><span class="pp"> ARRAY_MARK_FLAG</span><span class="op">)</span></span>
<span id="cb355-7"><a aria-hidden="true" href="#cb355-7" tabindex="-1"></a><span class="pp">#define XUNMARK_VECTOR</span><span class="op">(</span><span class="pp">V</span><span class="op">)</span><span class="pp">   </span><span class="op">((</span><span class="pp">V</span><span class="op">)-&gt;</span><span class="pp">header</span><span class="op">.</span><span class="pp">size </span><span class="op">&amp;=</span><span class="pp"> </span><span class="op">~</span><span class="pp">ARRAY_MARK_FLAG</span><span class="op">)</span></span>
<span id="cb355-8"><a aria-hidden="true" href="#cb355-8" tabindex="-1"></a><span class="pp">#define XVECTOR_MARKED_P</span><span class="op">(</span><span class="pp">V</span><span class="op">)</span><span class="pp"> </span><span class="op">(((</span><span class="pp">V</span><span class="op">)-&gt;</span><span class="pp">header</span><span class="op">.</span><span class="pp">size </span><span class="op">&amp;</span><span class="pp"> ARRAY_MARK_FLAG</span><span class="op">)</span><span class="pp"> </span><span class="op">!=</span><span class="pp"> </span><span class="dv">0</span><span class="op">)</span></span></code></pre></div>
<p><strong>Cons Cells</strong>: Bitmap in cons_block:</p>
<div class="sourceCode" id="cb356"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb356-1"><a aria-hidden="true" href="#cb356-1" tabindex="-1"></a><span class="co">/* From src/alloc.c:2547 */</span></span>
<span id="cb356-2"><a aria-hidden="true" href="#cb356-2" tabindex="-1"></a><span class="pp">#define XCONS_MARKED_P</span><span class="op">(</span><span class="pp">fptr</span><span class="op">)</span><span class="pp"> </span><span class="op">\</span></span>
<span id="cb356-3"><a aria-hidden="true" href="#cb356-3" tabindex="-1"></a><span class="pp">  GETMARKBIT </span><span class="op">(</span><span class="pp">CONS_BLOCK </span><span class="op">(</span><span class="pp">fptr</span><span class="op">),</span><span class="pp"> CONS_INDEX </span><span class="op">(</span><span class="pp">fptr</span><span class="op">))</span></span>
<span id="cb356-4"><a aria-hidden="true" href="#cb356-4" tabindex="-1"></a></span>
<span id="cb356-5"><a aria-hidden="true" href="#cb356-5" tabindex="-1"></a><span class="pp">#define XMARK_CONS</span><span class="op">(</span><span class="pp">fptr</span><span class="op">)</span><span class="pp"> </span><span class="op">\</span></span>
<span id="cb356-6"><a aria-hidden="true" href="#cb356-6" tabindex="-1"></a><span class="pp">  SETMARKBIT </span><span class="op">(</span><span class="pp">CONS_BLOCK </span><span class="op">(</span><span class="pp">fptr</span><span class="op">),</span><span class="pp"> CONS_INDEX </span><span class="op">(</span><span class="pp">fptr</span><span class="op">))</span></span></code></pre></div>
<h3 data-number="12.4.4" id="the-sweep-phase"><span class="header-section-number">12.4.4</span> The Sweep Phase</h3>
<p>After marking completes, sweep reclaims unmarked objects:</p>
<div class="sourceCode" id="cb357"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb357-1"><a aria-hidden="true" href="#cb357-1" tabindex="-1"></a><span class="co">/* From src/alloc.c:7091 */</span></span>
<span id="cb357-2"><a aria-hidden="true" href="#cb357-2" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span></span>
<span id="cb357-3"><a aria-hidden="true" href="#cb357-3" tabindex="-1"></a>gc_sweep <span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb357-4"><a aria-hidden="true" href="#cb357-4" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb357-5"><a aria-hidden="true" href="#cb357-5" tabindex="-1"></a>  sweep_strings <span class="op">();</span></span>
<span id="cb357-6"><a aria-hidden="true" href="#cb357-6" tabindex="-1"></a>  check_string_bytes <span class="op">(!</span>noninteractive<span class="op">);</span></span>
<span id="cb357-7"><a aria-hidden="true" href="#cb357-7" tabindex="-1"></a>  sweep_conses <span class="op">();</span></span>
<span id="cb357-8"><a aria-hidden="true" href="#cb357-8" tabindex="-1"></a>  sweep_floats <span class="op">();</span></span>
<span id="cb357-9"><a aria-hidden="true" href="#cb357-9" tabindex="-1"></a>  sweep_intervals <span class="op">();</span></span>
<span id="cb357-10"><a aria-hidden="true" href="#cb357-10" tabindex="-1"></a>  sweep_symbols <span class="op">();</span></span>
<span id="cb357-11"><a aria-hidden="true" href="#cb357-11" tabindex="-1"></a>  sweep_buffers <span class="op">();</span></span>
<span id="cb357-12"><a aria-hidden="true" href="#cb357-12" tabindex="-1"></a>  sweep_vectors <span class="op">();</span></span>
<span id="cb357-13"><a aria-hidden="true" href="#cb357-13" tabindex="-1"></a>  pdumper_clear_marks <span class="op">();</span></span>
<span id="cb357-14"><a aria-hidden="true" href="#cb357-14" tabindex="-1"></a>  check_string_bytes <span class="op">(!</span>noninteractive<span class="op">);</span></span>
<span id="cb357-15"><a aria-hidden="true" href="#cb357-15" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h4 data-number="12.4.4.1" id="sweeping-cons-cells"><span class="header-section-number">12.4.4.1</span> Sweeping Cons Cells</h4>
<div class="sourceCode" id="cb358"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb358-1"><a aria-hidden="true" href="#cb358-1" tabindex="-1"></a><span class="co">/* From src/alloc.c:6801 */</span></span>
<span id="cb358-2"><a aria-hidden="true" href="#cb358-2" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span></span>
<span id="cb358-3"><a aria-hidden="true" href="#cb358-3" tabindex="-1"></a>sweep_conses <span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb358-4"><a aria-hidden="true" href="#cb358-4" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb358-5"><a aria-hidden="true" href="#cb358-5" tabindex="-1"></a>  <span class="kw">struct</span> cons_block <span class="op">**</span>cprev <span class="op">=</span> <span class="op">&amp;</span>cons_block<span class="op">;</span></span>
<span id="cb358-6"><a aria-hidden="true" href="#cb358-6" tabindex="-1"></a>  <span class="dt">int</span> lim <span class="op">=</span> cons_block_index<span class="op">;</span></span>
<span id="cb358-7"><a aria-hidden="true" href="#cb358-7" tabindex="-1"></a>  object_ct num_free <span class="op">=</span> <span class="dv">0</span><span class="op">,</span> num_used <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb358-8"><a aria-hidden="true" href="#cb358-8" tabindex="-1"></a></span>
<span id="cb358-9"><a aria-hidden="true" href="#cb358-9" tabindex="-1"></a>  cons_free_list <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb358-10"><a aria-hidden="true" href="#cb358-10" tabindex="-1"></a></span>
<span id="cb358-11"><a aria-hidden="true" href="#cb358-11" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="kw">struct</span> cons_block <span class="op">*</span>cblk<span class="op">;</span> <span class="op">(</span>cblk <span class="op">=</span> <span class="op">*</span>cprev<span class="op">);</span> <span class="op">)</span></span>
<span id="cb358-12"><a aria-hidden="true" href="#cb358-12" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb358-13"><a aria-hidden="true" href="#cb358-13" tabindex="-1"></a>      <span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb358-14"><a aria-hidden="true" href="#cb358-14" tabindex="-1"></a>      <span class="dt">int</span> this_free <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb358-15"><a aria-hidden="true" href="#cb358-15" tabindex="-1"></a>      <span class="dt">int</span> ilim <span class="op">=</span> <span class="op">(</span>lim <span class="op">+</span> BITS_PER_BITS_WORD <span class="op">-</span> <span class="dv">1</span><span class="op">)</span> <span class="op">/</span> BITS_PER_BITS_WORD<span class="op">;</span></span>
<span id="cb358-16"><a aria-hidden="true" href="#cb358-16" tabindex="-1"></a></span>
<span id="cb358-17"><a aria-hidden="true" href="#cb358-17" tabindex="-1"></a>      <span class="co">/* Scan the mark bits an int at a time.  */</span></span>
<span id="cb358-18"><a aria-hidden="true" href="#cb358-18" tabindex="-1"></a>      <span class="cf">for</span> <span class="op">(</span>i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> ilim<span class="op">;</span> i<span class="op">++)</span></span>
<span id="cb358-19"><a aria-hidden="true" href="#cb358-19" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb358-20"><a aria-hidden="true" href="#cb358-20" tabindex="-1"></a>          <span class="cf">if</span> <span class="op">(</span>cblk<span class="op">-&gt;</span>gcmarkbits<span class="op">[</span>i<span class="op">]</span> <span class="op">==</span> BITS_WORD_MAX<span class="op">)</span></span>
<span id="cb358-21"><a aria-hidden="true" href="#cb358-21" tabindex="-1"></a>            <span class="op">{</span></span>
<span id="cb358-22"><a aria-hidden="true" href="#cb358-22" tabindex="-1"></a>              <span class="co">/* Fast path - all cons cells marked.  */</span></span>
<span id="cb358-23"><a aria-hidden="true" href="#cb358-23" tabindex="-1"></a>              cblk<span class="op">-&gt;</span>gcmarkbits<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb358-24"><a aria-hidden="true" href="#cb358-24" tabindex="-1"></a>              num_used <span class="op">+=</span> BITS_PER_BITS_WORD<span class="op">;</span></span>
<span id="cb358-25"><a aria-hidden="true" href="#cb358-25" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb358-26"><a aria-hidden="true" href="#cb358-26" tabindex="-1"></a>          <span class="cf">else</span></span>
<span id="cb358-27"><a aria-hidden="true" href="#cb358-27" tabindex="-1"></a>            <span class="op">{</span></span>
<span id="cb358-28"><a aria-hidden="true" href="#cb358-28" tabindex="-1"></a>              <span class="co">/* Some cons cells not marked - find and free them.  */</span></span>
<span id="cb358-29"><a aria-hidden="true" href="#cb358-29" tabindex="-1"></a>              <span class="dt">int</span> start <span class="op">=</span> i <span class="op">*</span> BITS_PER_BITS_WORD<span class="op">;</span></span>
<span id="cb358-30"><a aria-hidden="true" href="#cb358-30" tabindex="-1"></a>              <span class="dt">int</span> stop <span class="op">=</span> min <span class="op">(</span>lim<span class="op">,</span> start <span class="op">+</span> BITS_PER_BITS_WORD<span class="op">);</span></span>
<span id="cb358-31"><a aria-hidden="true" href="#cb358-31" tabindex="-1"></a></span>
<span id="cb358-32"><a aria-hidden="true" href="#cb358-32" tabindex="-1"></a>              <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> pos <span class="op">=</span> start<span class="op">;</span> pos <span class="op">&lt;</span> stop<span class="op">;</span> pos<span class="op">++)</span></span>
<span id="cb358-33"><a aria-hidden="true" href="#cb358-33" tabindex="-1"></a>                <span class="op">{</span></span>
<span id="cb358-34"><a aria-hidden="true" href="#cb358-34" tabindex="-1"></a>          <span class="kw">struct</span> Lisp_Cons <span class="op">*</span>acons <span class="op">=</span> <span class="op">&amp;</span>cblk<span class="op">-&gt;</span>conses<span class="op">[</span>pos<span class="op">];</span></span>
<span id="cb358-35"><a aria-hidden="true" href="#cb358-35" tabindex="-1"></a>          <span class="cf">if</span> <span class="op">(!</span>XCONS_MARKED_P <span class="op">(</span>acons<span class="op">))</span></span>
<span id="cb358-36"><a aria-hidden="true" href="#cb358-36" tabindex="-1"></a>                    <span class="op">{</span></span>
<span id="cb358-37"><a aria-hidden="true" href="#cb358-37" tabindex="-1"></a>              <span class="co">/* Free this cons */</span></span>
<span id="cb358-38"><a aria-hidden="true" href="#cb358-38" tabindex="-1"></a>                      this_free<span class="op">++;</span></span>
<span id="cb358-39"><a aria-hidden="true" href="#cb358-39" tabindex="-1"></a>                      cblk<span class="op">-&gt;</span>conses<span class="op">[</span>pos<span class="op">].</span>u<span class="op">.</span>s<span class="op">.</span>u<span class="op">.</span>chain <span class="op">=</span> cons_free_list<span class="op">;</span></span>
<span id="cb358-40"><a aria-hidden="true" href="#cb358-40" tabindex="-1"></a>                      cons_free_list <span class="op">=</span> <span class="op">&amp;</span>cblk<span class="op">-&gt;</span>conses<span class="op">[</span>pos<span class="op">];</span></span>
<span id="cb358-41"><a aria-hidden="true" href="#cb358-41" tabindex="-1"></a>                      cons_free_list<span class="op">-&gt;</span>u<span class="op">.</span>s<span class="op">.</span>car <span class="op">=</span> dead_object <span class="op">();</span></span>
<span id="cb358-42"><a aria-hidden="true" href="#cb358-42" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb358-43"><a aria-hidden="true" href="#cb358-43" tabindex="-1"></a>                  <span class="cf">else</span></span>
<span id="cb358-44"><a aria-hidden="true" href="#cb358-44" tabindex="-1"></a>                    <span class="op">{</span></span>
<span id="cb358-45"><a aria-hidden="true" href="#cb358-45" tabindex="-1"></a>                      num_used<span class="op">++;</span></span>
<span id="cb358-46"><a aria-hidden="true" href="#cb358-46" tabindex="-1"></a>              XUNMARK_CONS <span class="op">(</span>acons<span class="op">);</span></span>
<span id="cb358-47"><a aria-hidden="true" href="#cb358-47" tabindex="-1"></a>                    <span class="op">}</span></span>
<span id="cb358-48"><a aria-hidden="true" href="#cb358-48" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb358-49"><a aria-hidden="true" href="#cb358-49" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb358-50"><a aria-hidden="true" href="#cb358-50" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb358-51"><a aria-hidden="true" href="#cb358-51" tabindex="-1"></a></span>
<span id="cb358-52"><a aria-hidden="true" href="#cb358-52" tabindex="-1"></a>      lim <span class="op">=</span> CONS_BLOCK_SIZE<span class="op">;</span></span>
<span id="cb358-53"><a aria-hidden="true" href="#cb358-53" tabindex="-1"></a></span>
<span id="cb358-54"><a aria-hidden="true" href="#cb358-54" tabindex="-1"></a>      <span class="co">/* If block contains only free conses, deallocate it */</span></span>
<span id="cb358-55"><a aria-hidden="true" href="#cb358-55" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span>this_free <span class="op">==</span> CONS_BLOCK_SIZE <span class="op">&amp;&amp;</span> num_free <span class="op">&gt;</span> CONS_BLOCK_SIZE<span class="op">)</span></span>
<span id="cb358-56"><a aria-hidden="true" href="#cb358-56" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb358-57"><a aria-hidden="true" href="#cb358-57" tabindex="-1"></a>          <span class="op">*</span>cprev <span class="op">=</span> cblk<span class="op">-&gt;</span>next<span class="op">;</span></span>
<span id="cb358-58"><a aria-hidden="true" href="#cb358-58" tabindex="-1"></a>          cons_free_list <span class="op">=</span> cblk<span class="op">-&gt;</span>conses<span class="op">[</span><span class="dv">0</span><span class="op">].</span>u<span class="op">.</span>s<span class="op">.</span>u<span class="op">.</span>chain<span class="op">;</span></span>
<span id="cb358-59"><a aria-hidden="true" href="#cb358-59" tabindex="-1"></a>          lisp_align_free <span class="op">(</span>cblk<span class="op">);</span></span>
<span id="cb358-60"><a aria-hidden="true" href="#cb358-60" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb358-61"><a aria-hidden="true" href="#cb358-61" tabindex="-1"></a>      <span class="cf">else</span></span>
<span id="cb358-62"><a aria-hidden="true" href="#cb358-62" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb358-63"><a aria-hidden="true" href="#cb358-63" tabindex="-1"></a>          num_free <span class="op">+=</span> this_free<span class="op">;</span></span>
<span id="cb358-64"><a aria-hidden="true" href="#cb358-64" tabindex="-1"></a>          cprev <span class="op">=</span> <span class="op">&amp;</span>cblk<span class="op">-&gt;</span>next<span class="op">;</span></span>
<span id="cb358-65"><a aria-hidden="true" href="#cb358-65" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb358-66"><a aria-hidden="true" href="#cb358-66" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb358-67"><a aria-hidden="true" href="#cb358-67" tabindex="-1"></a>  gcstat<span class="op">.</span>total_conses <span class="op">=</span> num_used<span class="op">;</span></span>
<span id="cb358-68"><a aria-hidden="true" href="#cb358-68" tabindex="-1"></a>  gcstat<span class="op">.</span>total_free_conses <span class="op">=</span> num_free<span class="op">;</span></span>
<span id="cb358-69"><a aria-hidden="true" href="#cb358-69" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h4 data-number="12.4.4.2" id="sweeping-strings"><span class="header-section-number">12.4.4.2</span> Sweeping Strings</h4>
<p>String sweeping is more complex due to the two-level allocation:</p>
<div class="sourceCode" id="cb359"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb359-1"><a aria-hidden="true" href="#cb359-1" tabindex="-1"></a><span class="co">/* From src/alloc.c:1826 */</span></span>
<span id="cb359-2"><a aria-hidden="true" href="#cb359-2" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span></span>
<span id="cb359-3"><a aria-hidden="true" href="#cb359-3" tabindex="-1"></a>sweep_strings <span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb359-4"><a aria-hidden="true" href="#cb359-4" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb359-5"><a aria-hidden="true" href="#cb359-5" tabindex="-1"></a>  <span class="kw">struct</span> string_block <span class="op">*</span>b<span class="op">,</span> <span class="op">*</span>next<span class="op">;</span></span>
<span id="cb359-6"><a aria-hidden="true" href="#cb359-6" tabindex="-1"></a>  <span class="kw">struct</span> string_block <span class="op">*</span>live_blocks <span class="op">=</span> NULL<span class="op">;</span></span>
<span id="cb359-7"><a aria-hidden="true" href="#cb359-7" tabindex="-1"></a></span>
<span id="cb359-8"><a aria-hidden="true" href="#cb359-8" tabindex="-1"></a>  string_free_list <span class="op">=</span> NULL<span class="op">;</span></span>
<span id="cb359-9"><a aria-hidden="true" href="#cb359-9" tabindex="-1"></a>  gcstat<span class="op">.</span>total_strings <span class="op">=</span> gcstat<span class="op">.</span>total_free_strings <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb359-10"><a aria-hidden="true" href="#cb359-10" tabindex="-1"></a>  gcstat<span class="op">.</span>total_string_bytes <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb359-11"><a aria-hidden="true" href="#cb359-11" tabindex="-1"></a></span>
<span id="cb359-12"><a aria-hidden="true" href="#cb359-12" tabindex="-1"></a>  <span class="co">/* Scan string_blocks, free unmarked Lisp_Strings */</span></span>
<span id="cb359-13"><a aria-hidden="true" href="#cb359-13" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span>b <span class="op">=</span> string_blocks<span class="op">;</span> b<span class="op">;</span> b <span class="op">=</span> next<span class="op">)</span></span>
<span id="cb359-14"><a aria-hidden="true" href="#cb359-14" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb359-15"><a aria-hidden="true" href="#cb359-15" tabindex="-1"></a>      <span class="dt">int</span> i<span class="op">,</span> nfree <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb359-16"><a aria-hidden="true" href="#cb359-16" tabindex="-1"></a>      <span class="kw">struct</span> Lisp_String <span class="op">*</span>free_list_before <span class="op">=</span> string_free_list<span class="op">;</span></span>
<span id="cb359-17"><a aria-hidden="true" href="#cb359-17" tabindex="-1"></a></span>
<span id="cb359-18"><a aria-hidden="true" href="#cb359-18" tabindex="-1"></a>      next <span class="op">=</span> b<span class="op">-&gt;</span>next<span class="op">;</span></span>
<span id="cb359-19"><a aria-hidden="true" href="#cb359-19" tabindex="-1"></a></span>
<span id="cb359-20"><a aria-hidden="true" href="#cb359-20" tabindex="-1"></a>      <span class="cf">for</span> <span class="op">(</span>i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> STRING_BLOCK_SIZE<span class="op">;</span> <span class="op">++</span>i<span class="op">)</span></span>
<span id="cb359-21"><a aria-hidden="true" href="#cb359-21" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb359-22"><a aria-hidden="true" href="#cb359-22" tabindex="-1"></a>      <span class="kw">struct</span> Lisp_String <span class="op">*</span>s <span class="op">=</span> b<span class="op">-&gt;</span>strings <span class="op">+</span> i<span class="op">;</span></span>
<span id="cb359-23"><a aria-hidden="true" href="#cb359-23" tabindex="-1"></a></span>
<span id="cb359-24"><a aria-hidden="true" href="#cb359-24" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span>s<span class="op">-&gt;</span>u<span class="op">.</span>s<span class="op">.</span>data<span class="op">)</span></span>
<span id="cb359-25"><a aria-hidden="true" href="#cb359-25" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb359-26"><a aria-hidden="true" href="#cb359-26" tabindex="-1"></a>          <span class="co">/* String was not on free-list before.  */</span></span>
<span id="cb359-27"><a aria-hidden="true" href="#cb359-27" tabindex="-1"></a>          <span class="cf">if</span> <span class="op">(</span>XSTRING_MARKED_P <span class="op">(</span>s<span class="op">))</span></span>
<span id="cb359-28"><a aria-hidden="true" href="#cb359-28" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb359-29"><a aria-hidden="true" href="#cb359-29" tabindex="-1"></a>          <span class="co">/* String is live; unmark it and balance intervals.  */</span></span>
<span id="cb359-30"><a aria-hidden="true" href="#cb359-30" tabindex="-1"></a>          XUNMARK_STRING <span class="op">(</span>s<span class="op">);</span></span>
<span id="cb359-31"><a aria-hidden="true" href="#cb359-31" tabindex="-1"></a>          s<span class="op">-&gt;</span>u<span class="op">.</span>s<span class="op">.</span>intervals <span class="op">=</span> balance_intervals <span class="op">(</span>s<span class="op">-&gt;</span>u<span class="op">.</span>s<span class="op">.</span>intervals<span class="op">);</span></span>
<span id="cb359-32"><a aria-hidden="true" href="#cb359-32" tabindex="-1"></a></span>
<span id="cb359-33"><a aria-hidden="true" href="#cb359-33" tabindex="-1"></a>          gcstat<span class="op">.</span>total_strings<span class="op">++;</span></span>
<span id="cb359-34"><a aria-hidden="true" href="#cb359-34" tabindex="-1"></a>          gcstat<span class="op">.</span>total_string_bytes <span class="op">+=</span> STRING_BYTES <span class="op">(</span>s<span class="op">);</span></span>
<span id="cb359-35"><a aria-hidden="true" href="#cb359-35" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb359-36"><a aria-hidden="true" href="#cb359-36" tabindex="-1"></a>          <span class="cf">else</span></span>
<span id="cb359-37"><a aria-hidden="true" href="#cb359-37" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb359-38"><a aria-hidden="true" href="#cb359-38" tabindex="-1"></a>          <span class="co">/* String is dead; free it and mark sdata as dead */</span></span>
<span id="cb359-39"><a aria-hidden="true" href="#cb359-39" tabindex="-1"></a>          sdata <span class="op">*</span>data <span class="op">=</span> SDATA_OF_STRING <span class="op">(</span>s<span class="op">);</span></span>
<span id="cb359-40"><a aria-hidden="true" href="#cb359-40" tabindex="-1"></a>          data<span class="op">-&gt;</span>string <span class="op">=</span> NULL<span class="op">;</span></span>
<span id="cb359-41"><a aria-hidden="true" href="#cb359-41" tabindex="-1"></a>          SDATA_NBYTES <span class="op">(</span>data<span class="op">)</span> <span class="op">=</span> STRING_BYTES <span class="op">(</span>s<span class="op">);</span></span>
<span id="cb359-42"><a aria-hidden="true" href="#cb359-42" tabindex="-1"></a></span>
<span id="cb359-43"><a aria-hidden="true" href="#cb359-43" tabindex="-1"></a>          s<span class="op">-&gt;</span>u<span class="op">.</span>s<span class="op">.</span>data <span class="op">=</span> NULL<span class="op">;</span></span>
<span id="cb359-44"><a aria-hidden="true" href="#cb359-44" tabindex="-1"></a>          s<span class="op">-&gt;</span>u<span class="op">.</span>next <span class="op">=</span> string_free_list<span class="op">;</span></span>
<span id="cb359-45"><a aria-hidden="true" href="#cb359-45" tabindex="-1"></a>          string_free_list <span class="op">=</span> s<span class="op">;</span></span>
<span id="cb359-46"><a aria-hidden="true" href="#cb359-46" tabindex="-1"></a>          <span class="op">++</span>nfree<span class="op">;</span></span>
<span id="cb359-47"><a aria-hidden="true" href="#cb359-47" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb359-48"><a aria-hidden="true" href="#cb359-48" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb359-49"><a aria-hidden="true" href="#cb359-49" tabindex="-1"></a>      <span class="cf">else</span></span>
<span id="cb359-50"><a aria-hidden="true" href="#cb359-50" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb359-51"><a aria-hidden="true" href="#cb359-51" tabindex="-1"></a>          <span class="co">/* String was already free */</span></span>
<span id="cb359-52"><a aria-hidden="true" href="#cb359-52" tabindex="-1"></a>          <span class="op">++</span>nfree<span class="op">;</span></span>
<span id="cb359-53"><a aria-hidden="true" href="#cb359-53" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb359-54"><a aria-hidden="true" href="#cb359-54" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb359-55"><a aria-hidden="true" href="#cb359-55" tabindex="-1"></a></span>
<span id="cb359-56"><a aria-hidden="true" href="#cb359-56" tabindex="-1"></a>      <span class="co">/* If block is entirely free, release it (keep at least 2) */</span></span>
<span id="cb359-57"><a aria-hidden="true" href="#cb359-57" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span>nfree <span class="op">==</span> STRING_BLOCK_SIZE <span class="op">&amp;&amp;</span> gcstat<span class="op">.</span>total_free_strings <span class="op">&gt;</span> STRING_BLOCK_SIZE<span class="op">)</span></span>
<span id="cb359-58"><a aria-hidden="true" href="#cb359-58" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb359-59"><a aria-hidden="true" href="#cb359-59" tabindex="-1"></a>      lisp_free <span class="op">(</span>b<span class="op">);</span></span>
<span id="cb359-60"><a aria-hidden="true" href="#cb359-60" tabindex="-1"></a>      string_free_list <span class="op">=</span> free_list_before<span class="op">;</span></span>
<span id="cb359-61"><a aria-hidden="true" href="#cb359-61" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb359-62"><a aria-hidden="true" href="#cb359-62" tabindex="-1"></a>      <span class="cf">else</span></span>
<span id="cb359-63"><a aria-hidden="true" href="#cb359-63" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb359-64"><a aria-hidden="true" href="#cb359-64" tabindex="-1"></a>      gcstat<span class="op">.</span>total_free_strings <span class="op">+=</span> nfree<span class="op">;</span></span>
<span id="cb359-65"><a aria-hidden="true" href="#cb359-65" tabindex="-1"></a>      b<span class="op">-&gt;</span>next <span class="op">=</span> live_blocks<span class="op">;</span></span>
<span id="cb359-66"><a aria-hidden="true" href="#cb359-66" tabindex="-1"></a>      live_blocks <span class="op">=</span> b<span class="op">;</span></span>
<span id="cb359-67"><a aria-hidden="true" href="#cb359-67" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb359-68"><a aria-hidden="true" href="#cb359-68" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb359-69"><a aria-hidden="true" href="#cb359-69" tabindex="-1"></a></span>
<span id="cb359-70"><a aria-hidden="true" href="#cb359-70" tabindex="-1"></a>  string_blocks <span class="op">=</span> live_blocks<span class="op">;</span></span>
<span id="cb359-71"><a aria-hidden="true" href="#cb359-71" tabindex="-1"></a></span>
<span id="cb359-72"><a aria-hidden="true" href="#cb359-72" tabindex="-1"></a>  <span class="co">/* Compact and free string data */</span></span>
<span id="cb359-73"><a aria-hidden="true" href="#cb359-73" tabindex="-1"></a>  compact_small_strings <span class="op">();</span></span>
<span id="cb359-74"><a aria-hidden="true" href="#cb359-74" tabindex="-1"></a>  free_large_strings <span class="op">();</span></span>
<span id="cb359-75"><a aria-hidden="true" href="#cb359-75" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h4 data-number="12.4.4.3" id="sweeping-vectors"><span class="header-section-number">12.4.4.3</span> Sweeping Vectors</h4>
<div class="sourceCode" id="cb360"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb360-1"><a aria-hidden="true" href="#cb360-1" tabindex="-1"></a><span class="co">/* From src/alloc.c:3241 */</span></span>
<span id="cb360-2"><a aria-hidden="true" href="#cb360-2" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span></span>
<span id="cb360-3"><a aria-hidden="true" href="#cb360-3" tabindex="-1"></a>sweep_vectors <span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb360-4"><a aria-hidden="true" href="#cb360-4" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb360-5"><a aria-hidden="true" href="#cb360-5" tabindex="-1"></a>  <span class="kw">struct</span> vector_block <span class="op">*</span>block<span class="op">,</span> <span class="op">**</span>bprev <span class="op">=</span> <span class="op">&amp;</span>vector_blocks<span class="op">;</span></span>
<span id="cb360-6"><a aria-hidden="true" href="#cb360-6" tabindex="-1"></a>  <span class="kw">struct</span> large_vector <span class="op">*</span>lv<span class="op">,</span> <span class="op">**</span>lvprev <span class="op">=</span> <span class="op">&amp;</span>large_vectors<span class="op">;</span></span>
<span id="cb360-7"><a aria-hidden="true" href="#cb360-7" tabindex="-1"></a>  <span class="kw">struct</span> Lisp_Vector <span class="op">*</span>vector<span class="op">,</span> <span class="op">*</span>next<span class="op">;</span></span>
<span id="cb360-8"><a aria-hidden="true" href="#cb360-8" tabindex="-1"></a></span>
<span id="cb360-9"><a aria-hidden="true" href="#cb360-9" tabindex="-1"></a>  gcstat<span class="op">.</span>total_vectors <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb360-10"><a aria-hidden="true" href="#cb360-10" tabindex="-1"></a>  gcstat<span class="op">.</span>total_vector_slots <span class="op">=</span> gcstat<span class="op">.</span>total_free_vector_slots <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb360-11"><a aria-hidden="true" href="#cb360-11" tabindex="-1"></a>  memset <span class="op">(</span>vector_free_lists<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="kw">sizeof</span> <span class="op">(</span>vector_free_lists<span class="op">));</span></span>
<span id="cb360-12"><a aria-hidden="true" href="#cb360-12" tabindex="-1"></a>  last_inserted_vector_free_idx <span class="op">=</span> VECTOR_FREE_LIST_ARRAY_SIZE<span class="op">;</span></span>
<span id="cb360-13"><a aria-hidden="true" href="#cb360-13" tabindex="-1"></a></span>
<span id="cb360-14"><a aria-hidden="true" href="#cb360-14" tabindex="-1"></a>  <span class="co">/* Sweep vector blocks */</span></span>
<span id="cb360-15"><a aria-hidden="true" href="#cb360-15" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span>block <span class="op">=</span> vector_blocks<span class="op">;</span> block<span class="op">;</span> block <span class="op">=</span> <span class="op">*</span>bprev<span class="op">)</span></span>
<span id="cb360-16"><a aria-hidden="true" href="#cb360-16" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb360-17"><a aria-hidden="true" href="#cb360-17" tabindex="-1"></a>      <span class="dt">bool</span> free_this_block <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb360-18"><a aria-hidden="true" href="#cb360-18" tabindex="-1"></a>      <span class="dt">ptrdiff_t</span> nbytes<span class="op">;</span></span>
<span id="cb360-19"><a aria-hidden="true" href="#cb360-19" tabindex="-1"></a></span>
<span id="cb360-20"><a aria-hidden="true" href="#cb360-20" tabindex="-1"></a>      <span class="cf">for</span> <span class="op">(</span>vector <span class="op">=</span> <span class="op">(</span><span class="kw">struct</span> Lisp_Vector <span class="op">*)</span> block<span class="op">-&gt;</span>data<span class="op">;</span></span>
<span id="cb360-21"><a aria-hidden="true" href="#cb360-21" tabindex="-1"></a>       VECTOR_IN_BLOCK <span class="op">(</span>vector<span class="op">,</span> block<span class="op">);</span> vector <span class="op">=</span> next<span class="op">)</span></span>
<span id="cb360-22"><a aria-hidden="true" href="#cb360-22" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb360-23"><a aria-hidden="true" href="#cb360-23" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span>PSEUDOVECTOR_TYPE <span class="op">(</span>vector<span class="op">)</span> <span class="op">==</span> PVEC_FREE<span class="op">)</span></span>
<span id="cb360-24"><a aria-hidden="true" href="#cb360-24" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb360-25"><a aria-hidden="true" href="#cb360-25" tabindex="-1"></a>          <span class="co">/* Already free - skip to next */</span></span>
<span id="cb360-26"><a aria-hidden="true" href="#cb360-26" tabindex="-1"></a>          next <span class="op">=</span> ADVANCE <span class="op">(</span>vector<span class="op">,</span> pseudovector_nbytes <span class="op">(&amp;</span>vector<span class="op">-&gt;</span>header<span class="op">));</span></span>
<span id="cb360-27"><a aria-hidden="true" href="#cb360-27" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb360-28"><a aria-hidden="true" href="#cb360-28" tabindex="-1"></a>      <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>vector_marked_p <span class="op">(</span>vector<span class="op">))</span></span>
<span id="cb360-29"><a aria-hidden="true" href="#cb360-29" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb360-30"><a aria-hidden="true" href="#cb360-30" tabindex="-1"></a>          <span class="co">/* Live vector - unmark and count */</span></span>
<span id="cb360-31"><a aria-hidden="true" href="#cb360-31" tabindex="-1"></a>          XUNMARK_VECTOR <span class="op">(</span>vector<span class="op">);</span></span>
<span id="cb360-32"><a aria-hidden="true" href="#cb360-32" tabindex="-1"></a></span>
<span id="cb360-33"><a aria-hidden="true" href="#cb360-33" tabindex="-1"></a>          gcstat<span class="op">.</span>total_vectors<span class="op">++;</span></span>
<span id="cb360-34"><a aria-hidden="true" href="#cb360-34" tabindex="-1"></a>          nbytes <span class="op">=</span> vectorlike_nbytes <span class="op">(&amp;</span>vector<span class="op">-&gt;</span>header<span class="op">);</span></span>
<span id="cb360-35"><a aria-hidden="true" href="#cb360-35" tabindex="-1"></a>          gcstat<span class="op">.</span>total_vector_slots <span class="op">+=</span> nbytes <span class="op">/</span> word_size<span class="op">;</span></span>
<span id="cb360-36"><a aria-hidden="true" href="#cb360-36" tabindex="-1"></a>          next <span class="op">=</span> ADVANCE <span class="op">(</span>vector<span class="op">,</span> nbytes<span class="op">);</span></span>
<span id="cb360-37"><a aria-hidden="true" href="#cb360-37" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb360-38"><a aria-hidden="true" href="#cb360-38" tabindex="-1"></a>      <span class="cf">else</span></span>
<span id="cb360-39"><a aria-hidden="true" href="#cb360-39" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb360-40"><a aria-hidden="true" href="#cb360-40" tabindex="-1"></a>          <span class="co">/* Dead vector - clean up and add to free list */</span></span>
<span id="cb360-41"><a aria-hidden="true" href="#cb360-41" tabindex="-1"></a>          <span class="dt">ptrdiff_t</span> total_bytes<span class="op">;</span></span>
<span id="cb360-42"><a aria-hidden="true" href="#cb360-42" tabindex="-1"></a></span>
<span id="cb360-43"><a aria-hidden="true" href="#cb360-43" tabindex="-1"></a>          nbytes <span class="op">=</span> vectorlike_nbytes <span class="op">(&amp;</span>vector<span class="op">-&gt;</span>header<span class="op">);</span></span>
<span id="cb360-44"><a aria-hidden="true" href="#cb360-44" tabindex="-1"></a>          total_bytes <span class="op">=</span> nbytes<span class="op">;</span></span>
<span id="cb360-45"><a aria-hidden="true" href="#cb360-45" tabindex="-1"></a></span>
<span id="cb360-46"><a aria-hidden="true" href="#cb360-46" tabindex="-1"></a>          <span class="co">/* Run cleanup for special vector types */</span></span>
<span id="cb360-47"><a aria-hidden="true" href="#cb360-47" tabindex="-1"></a>          cleanup_vector <span class="op">(</span>vector<span class="op">);</span></span>
<span id="cb360-48"><a aria-hidden="true" href="#cb360-48" tabindex="-1"></a></span>
<span id="cb360-49"><a aria-hidden="true" href="#cb360-49" tabindex="-1"></a>          <span class="co">/* Coalesce with following free vectors */</span></span>
<span id="cb360-50"><a aria-hidden="true" href="#cb360-50" tabindex="-1"></a>          next <span class="op">=</span> ADVANCE <span class="op">(</span>vector<span class="op">,</span> nbytes<span class="op">);</span></span>
<span id="cb360-51"><a aria-hidden="true" href="#cb360-51" tabindex="-1"></a>          <span class="cf">while</span> <span class="op">(</span>VECTOR_IN_BLOCK <span class="op">(</span>next<span class="op">,</span> block<span class="op">)</span></span>
<span id="cb360-52"><a aria-hidden="true" href="#cb360-52" tabindex="-1"></a>             <span class="op">&amp;&amp;</span> PSEUDOVECTOR_TYPE <span class="op">(</span>next<span class="op">)</span> <span class="op">==</span> PVEC_FREE<span class="op">)</span></span>
<span id="cb360-53"><a aria-hidden="true" href="#cb360-53" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb360-54"><a aria-hidden="true" href="#cb360-54" tabindex="-1"></a>          nbytes <span class="op">=</span> pseudovector_nbytes <span class="op">(&amp;</span>next<span class="op">-&gt;</span>header<span class="op">);</span></span>
<span id="cb360-55"><a aria-hidden="true" href="#cb360-55" tabindex="-1"></a>          total_bytes <span class="op">+=</span> nbytes<span class="op">;</span></span>
<span id="cb360-56"><a aria-hidden="true" href="#cb360-56" tabindex="-1"></a>          next <span class="op">=</span> ADVANCE <span class="op">(</span>next<span class="op">,</span> nbytes<span class="op">);</span></span>
<span id="cb360-57"><a aria-hidden="true" href="#cb360-57" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb360-58"><a aria-hidden="true" href="#cb360-58" tabindex="-1"></a></span>
<span id="cb360-59"><a aria-hidden="true" href="#cb360-59" tabindex="-1"></a>          <span class="co">/* Add to appropriate free list */</span></span>
<span id="cb360-60"><a aria-hidden="true" href="#cb360-60" tabindex="-1"></a>          eassert <span class="op">(</span>total_bytes <span class="op">%</span> roundup_size <span class="op">==</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb360-61"><a aria-hidden="true" href="#cb360-61" tabindex="-1"></a>          setup_on_free_list <span class="op">(</span>vector<span class="op">,</span> total_bytes<span class="op">);</span></span>
<span id="cb360-62"><a aria-hidden="true" href="#cb360-62" tabindex="-1"></a>          gcstat<span class="op">.</span>total_free_vector_slots <span class="op">+=</span> total_bytes <span class="op">/</span> word_size<span class="op">;</span></span>
<span id="cb360-63"><a aria-hidden="true" href="#cb360-63" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb360-64"><a aria-hidden="true" href="#cb360-64" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb360-65"><a aria-hidden="true" href="#cb360-65" tabindex="-1"></a></span>
<span id="cb360-66"><a aria-hidden="true" href="#cb360-66" tabindex="-1"></a>      <span class="co">/* Keep at least one vector block */</span></span>
<span id="cb360-67"><a aria-hidden="true" href="#cb360-67" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span>block <span class="op">==</span> vector_blocks <span class="op">&amp;&amp;</span> block<span class="op">-&gt;</span>next <span class="op">==</span> NULL<span class="op">)</span></span>
<span id="cb360-68"><a aria-hidden="true" href="#cb360-68" tabindex="-1"></a>    bprev <span class="op">=</span> <span class="op">&amp;</span>block<span class="op">-&gt;</span>next<span class="op">;</span></span>
<span id="cb360-69"><a aria-hidden="true" href="#cb360-69" tabindex="-1"></a>      <span class="cf">else</span></span>
<span id="cb360-70"><a aria-hidden="true" href="#cb360-70" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb360-71"><a aria-hidden="true" href="#cb360-71" tabindex="-1"></a>      <span class="op">*</span>bprev <span class="op">=</span> block<span class="op">-&gt;</span>next<span class="op">;</span></span>
<span id="cb360-72"><a aria-hidden="true" href="#cb360-72" tabindex="-1"></a>      xfree <span class="op">(</span>block<span class="op">);</span></span>
<span id="cb360-73"><a aria-hidden="true" href="#cb360-73" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb360-74"><a aria-hidden="true" href="#cb360-74" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb360-75"><a aria-hidden="true" href="#cb360-75" tabindex="-1"></a></span>
<span id="cb360-76"><a aria-hidden="true" href="#cb360-76" tabindex="-1"></a>  <span class="co">/* Sweep large vectors */</span></span>
<span id="cb360-77"><a aria-hidden="true" href="#cb360-77" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span>lv <span class="op">=</span> large_vectors<span class="op">;</span> lv<span class="op">;</span> lv <span class="op">=</span> <span class="op">*</span>lvprev<span class="op">)</span></span>
<span id="cb360-78"><a aria-hidden="true" href="#cb360-78" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb360-79"><a aria-hidden="true" href="#cb360-79" tabindex="-1"></a>      vector <span class="op">=</span> large_vector_vec <span class="op">(</span>lv<span class="op">);</span></span>
<span id="cb360-80"><a aria-hidden="true" href="#cb360-80" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span>vector_marked_p <span class="op">(</span>vector<span class="op">))</span></span>
<span id="cb360-81"><a aria-hidden="true" href="#cb360-81" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb360-82"><a aria-hidden="true" href="#cb360-82" tabindex="-1"></a>      XUNMARK_VECTOR <span class="op">(</span>vector<span class="op">);</span></span>
<span id="cb360-83"><a aria-hidden="true" href="#cb360-83" tabindex="-1"></a>      gcstat<span class="op">.</span>total_vectors<span class="op">++;</span></span>
<span id="cb360-84"><a aria-hidden="true" href="#cb360-84" tabindex="-1"></a>      gcstat<span class="op">.</span>total_vector_slots <span class="op">+=</span> vectorlike_nbytes <span class="op">(&amp;</span>vector<span class="op">-&gt;</span>header<span class="op">)</span> <span class="op">/</span> word_size<span class="op">;</span></span>
<span id="cb360-85"><a aria-hidden="true" href="#cb360-85" tabindex="-1"></a>      lvprev <span class="op">=</span> <span class="op">&amp;</span>lv<span class="op">-&gt;</span>next<span class="op">;</span></span>
<span id="cb360-86"><a aria-hidden="true" href="#cb360-86" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb360-87"><a aria-hidden="true" href="#cb360-87" tabindex="-1"></a>      <span class="cf">else</span></span>
<span id="cb360-88"><a aria-hidden="true" href="#cb360-88" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb360-89"><a aria-hidden="true" href="#cb360-89" tabindex="-1"></a>      <span class="op">*</span>lvprev <span class="op">=</span> lv<span class="op">-&gt;</span>next<span class="op">;</span></span>
<span id="cb360-90"><a aria-hidden="true" href="#cb360-90" tabindex="-1"></a>      cleanup_vector <span class="op">(</span>vector<span class="op">);</span></span>
<span id="cb360-91"><a aria-hidden="true" href="#cb360-91" tabindex="-1"></a>      lisp_free <span class="op">(</span>lv<span class="op">);</span></span>
<span id="cb360-92"><a aria-hidden="true" href="#cb360-92" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb360-93"><a aria-hidden="true" href="#cb360-93" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb360-94"><a aria-hidden="true" href="#cb360-94" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<hr/>
<h2 data-number="12.5" id="key-functions-deep-dive"><span class="header-section-number">12.5</span> Key Functions Deep Dive</h2>
<h3 data-number="12.5.1" id="garbage_collect"><span class="header-section-number">12.5.1</span> garbage_collect</h3>
<p>See ‚ÄúThe Mark-and-Sweep Strategy‚Äù section above for the complete
implementation.</p>
<h3 data-number="12.5.2" id="mark_object"><span class="header-section-number">12.5.2</span> mark_object</h3>
<p>The core marking primitive. See ‚ÄúThe Marking Phase‚Äù for details.</p>
<h3 data-number="12.5.3" id="conservative-stack-scanning"><span class="header-section-number">12.5.3</span> Conservative Stack
Scanning</h3>
<p>The GC scans the C stack conservatively to find roots:</p>
<div class="sourceCode" id="cb361"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb361-1"><a aria-hidden="true" href="#cb361-1" tabindex="-1"></a><span class="co">/* From src/alloc.c:4185 */</span></span>
<span id="cb361-2"><a aria-hidden="true" href="#cb361-2" tabindex="-1"></a><span class="co">/* Conservative C stack marking requires a method to identify possibly</span></span>
<span id="cb361-3"><a aria-hidden="true" href="#cb361-3" tabindex="-1"></a><span class="co">   live Lisp objects given a pointer value.  We do this by keeping</span></span>
<span id="cb361-4"><a aria-hidden="true" href="#cb361-4" tabindex="-1"></a><span class="co">   track of blocks of Lisp data that are allocated in a red-black tree</span></span>
<span id="cb361-5"><a aria-hidden="true" href="#cb361-5" tabindex="-1"></a><span class="co">   (see also the comment of mem_node which is the type of nodes in</span></span>
<span id="cb361-6"><a aria-hidden="true" href="#cb361-6" tabindex="-1"></a><span class="co">   that tree).  Function lisp_malloc adds information for an allocated</span></span>
<span id="cb361-7"><a aria-hidden="true" href="#cb361-7" tabindex="-1"></a><span class="co">   block to the red-black tree with calls to mem_insert, and function</span></span>
<span id="cb361-8"><a aria-hidden="true" href="#cb361-8" tabindex="-1"></a><span class="co">   lisp_free removes it with mem_delete.  Functions live_string_p etc</span></span>
<span id="cb361-9"><a aria-hidden="true" href="#cb361-9" tabindex="-1"></a><span class="co">   call mem_find to lookup information about a given pointer in the</span></span>
<span id="cb361-10"><a aria-hidden="true" href="#cb361-10" tabindex="-1"></a><span class="co">   tree, and use that to determine if the pointer points into a Lisp</span></span>
<span id="cb361-11"><a aria-hidden="true" href="#cb361-11" tabindex="-1"></a><span class="co">   object or not.  */</span></span></code></pre></div>
<p>Finding memory regions:</p>
<div class="sourceCode" id="cb362"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb362-1"><a aria-hidden="true" href="#cb362-1" tabindex="-1"></a><span class="co">/* From src/alloc.c:4212 */</span></span>
<span id="cb362-2"><a aria-hidden="true" href="#cb362-2" tabindex="-1"></a><span class="dt">static</span> <span class="kw">struct</span> mem_node <span class="op">*</span></span>
<span id="cb362-3"><a aria-hidden="true" href="#cb362-3" tabindex="-1"></a>mem_find <span class="op">(</span><span class="dt">void</span> <span class="op">*</span>start<span class="op">)</span></span>
<span id="cb362-4"><a aria-hidden="true" href="#cb362-4" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb362-5"><a aria-hidden="true" href="#cb362-5" tabindex="-1"></a>  <span class="kw">struct</span> mem_node <span class="op">*</span>p<span class="op">;</span></span>
<span id="cb362-6"><a aria-hidden="true" href="#cb362-6" tabindex="-1"></a></span>
<span id="cb362-7"><a aria-hidden="true" href="#cb362-7" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>start <span class="op">&lt;</span> min_heap_address <span class="op">||</span> start <span class="op">&gt;</span> max_heap_address<span class="op">)</span></span>
<span id="cb362-8"><a aria-hidden="true" href="#cb362-8" tabindex="-1"></a>    <span class="cf">return</span> MEM_NIL<span class="op">;</span></span>
<span id="cb362-9"><a aria-hidden="true" href="#cb362-9" tabindex="-1"></a></span>
<span id="cb362-10"><a aria-hidden="true" href="#cb362-10" tabindex="-1"></a>  <span class="co">/* Make the search always successful to speed up the loop below.  */</span></span>
<span id="cb362-11"><a aria-hidden="true" href="#cb362-11" tabindex="-1"></a>  mem_z<span class="op">.</span>start <span class="op">=</span> start<span class="op">;</span></span>
<span id="cb362-12"><a aria-hidden="true" href="#cb362-12" tabindex="-1"></a>  mem_z<span class="op">.</span>end <span class="op">=</span> <span class="op">(</span><span class="dt">char</span> <span class="op">*)</span> start <span class="op">+</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb362-13"><a aria-hidden="true" href="#cb362-13" tabindex="-1"></a></span>
<span id="cb362-14"><a aria-hidden="true" href="#cb362-14" tabindex="-1"></a>  p <span class="op">=</span> mem_root<span class="op">;</span></span>
<span id="cb362-15"><a aria-hidden="true" href="#cb362-15" tabindex="-1"></a>  <span class="cf">while</span> <span class="op">(</span>start <span class="op">&lt;</span> p<span class="op">-&gt;</span>start <span class="op">||</span> start <span class="op">&gt;=</span> p<span class="op">-&gt;</span>end<span class="op">)</span></span>
<span id="cb362-16"><a aria-hidden="true" href="#cb362-16" tabindex="-1"></a>    p <span class="op">=</span> start <span class="op">&lt;</span> p<span class="op">-&gt;</span>start <span class="op">?</span> p<span class="op">-&gt;</span>left <span class="op">:</span> p<span class="op">-&gt;</span>right<span class="op">;</span></span>
<span id="cb362-17"><a aria-hidden="true" href="#cb362-17" tabindex="-1"></a>  <span class="cf">return</span> p<span class="op">;</span></span>
<span id="cb362-18"><a aria-hidden="true" href="#cb362-18" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<hr/>
<h2 data-number="12.6" id="special-topics"><span class="header-section-number">12.6</span> Special Topics</h2>
<h3 data-number="12.6.1" id="weak-hash-tables"><span class="header-section-number">12.6.1</span> Weak Hash Tables</h3>
<p>Weak hash tables allow keys or values to be collected if not
referenced elsewhere:</p>
<div class="sourceCode" id="cb363"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb363-1"><a aria-hidden="true" href="#cb363-1" tabindex="-1"></a><span class="co">/* From src/alloc.c:5664 */</span></span>
<span id="cb363-2"><a aria-hidden="true" href="#cb363-2" tabindex="-1"></a><span class="co">/* List of weak hash tables we found during marking the Lisp heap.</span></span>
<span id="cb363-3"><a aria-hidden="true" href="#cb363-3" tabindex="-1"></a><span class="co">   NULL on entry to garbage_collect and after it returns.  */</span></span>
<span id="cb363-4"><a aria-hidden="true" href="#cb363-4" tabindex="-1"></a><span class="dt">static</span> <span class="kw">struct</span> Lisp_Hash_Table <span class="op">*</span>weak_hash_tables<span class="op">;</span></span></code></pre></div>
<p>Weak table processing happens after regular marking:</p>
<div class="sourceCode" id="cb364"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb364-1"><a aria-hidden="true" href="#cb364-1" tabindex="-1"></a><span class="co">/* From src/alloc.c:5670 */</span></span>
<span id="cb364-2"><a aria-hidden="true" href="#cb364-2" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span></span>
<span id="cb364-3"><a aria-hidden="true" href="#cb364-3" tabindex="-1"></a>mark_and_sweep_weak_table_contents <span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb364-4"><a aria-hidden="true" href="#cb364-4" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb364-5"><a aria-hidden="true" href="#cb364-5" tabindex="-1"></a>  <span class="kw">struct</span> Lisp_Hash_Table <span class="op">*</span>h<span class="op">;</span></span>
<span id="cb364-6"><a aria-hidden="true" href="#cb364-6" tabindex="-1"></a>  <span class="dt">bool</span> marked<span class="op">;</span></span>
<span id="cb364-7"><a aria-hidden="true" href="#cb364-7" tabindex="-1"></a></span>
<span id="cb364-8"><a aria-hidden="true" href="#cb364-8" tabindex="-1"></a>  <span class="co">/* Mark all keys and values that are in use.  Keep on marking until</span></span>
<span id="cb364-9"><a aria-hidden="true" href="#cb364-9" tabindex="-1"></a><span class="co">     there is no more change.  This is necessary for cases like</span></span>
<span id="cb364-10"><a aria-hidden="true" href="#cb364-10" tabindex="-1"></a><span class="co">     value-weak table A containing an entry X -&gt; Y, where Y is used in a</span></span>
<span id="cb364-11"><a aria-hidden="true" href="#cb364-11" tabindex="-1"></a><span class="co">     key-weak table B, Z -&gt; Y.  If B comes after A in the list of weak</span></span>
<span id="cb364-12"><a aria-hidden="true" href="#cb364-12" tabindex="-1"></a><span class="co">     tables, X -&gt; Y might be removed from A, although when looking at B</span></span>
<span id="cb364-13"><a aria-hidden="true" href="#cb364-13" tabindex="-1"></a><span class="co">     one finds that it shouldn't.  */</span></span>
<span id="cb364-14"><a aria-hidden="true" href="#cb364-14" tabindex="-1"></a>  <span class="cf">do</span></span>
<span id="cb364-15"><a aria-hidden="true" href="#cb364-15" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb364-16"><a aria-hidden="true" href="#cb364-16" tabindex="-1"></a>      marked <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb364-17"><a aria-hidden="true" href="#cb364-17" tabindex="-1"></a>      <span class="cf">for</span> <span class="op">(</span>h <span class="op">=</span> weak_hash_tables<span class="op">;</span> h<span class="op">;</span> h <span class="op">=</span> h<span class="op">-&gt;</span>next_weak<span class="op">)</span></span>
<span id="cb364-18"><a aria-hidden="true" href="#cb364-18" tabindex="-1"></a>        marked <span class="op">|=</span> sweep_weak_table <span class="op">(</span>h<span class="op">,</span> <span class="kw">false</span><span class="op">);</span></span>
<span id="cb364-19"><a aria-hidden="true" href="#cb364-19" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb364-20"><a aria-hidden="true" href="#cb364-20" tabindex="-1"></a>  <span class="cf">while</span> <span class="op">(</span>marked<span class="op">);</span></span>
<span id="cb364-21"><a aria-hidden="true" href="#cb364-21" tabindex="-1"></a></span>
<span id="cb364-22"><a aria-hidden="true" href="#cb364-22" tabindex="-1"></a>  <span class="co">/* Remove hash table entries that aren't used.  */</span></span>
<span id="cb364-23"><a aria-hidden="true" href="#cb364-23" tabindex="-1"></a>  <span class="cf">while</span> <span class="op">(</span>weak_hash_tables<span class="op">)</span></span>
<span id="cb364-24"><a aria-hidden="true" href="#cb364-24" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb364-25"><a aria-hidden="true" href="#cb364-25" tabindex="-1"></a>      h <span class="op">=</span> weak_hash_tables<span class="op">;</span></span>
<span id="cb364-26"><a aria-hidden="true" href="#cb364-26" tabindex="-1"></a>      weak_hash_tables <span class="op">=</span> h<span class="op">-&gt;</span>next_weak<span class="op">;</span></span>
<span id="cb364-27"><a aria-hidden="true" href="#cb364-27" tabindex="-1"></a>      h<span class="op">-&gt;</span>next_weak <span class="op">=</span> NULL<span class="op">;</span></span>
<span id="cb364-28"><a aria-hidden="true" href="#cb364-28" tabindex="-1"></a>      sweep_weak_table <span class="op">(</span>h<span class="op">,</span> <span class="kw">true</span><span class="op">);</span></span>
<span id="cb364-29"><a aria-hidden="true" href="#cb364-29" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb364-30"><a aria-hidden="true" href="#cb364-30" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 data-number="12.6.2" id="finalizers"><span class="header-section-number">12.6.2</span> Finalizers</h3>
<p>Finalizers allow running cleanup code when objects become
unreachable:</p>
<div class="sourceCode" id="cb365"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb365-1"><a aria-hidden="true" href="#cb365-1" tabindex="-1"></a><span class="co">/* From src/alloc.c:552 */</span></span>
<span id="cb365-2"><a aria-hidden="true" href="#cb365-2" tabindex="-1"></a><span class="co">/* Head of a circularly-linked list of extant finalizers. */</span></span>
<span id="cb365-3"><a aria-hidden="true" href="#cb365-3" tabindex="-1"></a><span class="kw">struct</span> Lisp_Finalizer finalizers<span class="op">;</span></span>
<span id="cb365-4"><a aria-hidden="true" href="#cb365-4" tabindex="-1"></a></span>
<span id="cb365-5"><a aria-hidden="true" href="#cb365-5" tabindex="-1"></a><span class="co">/* Head of a circularly-linked list of finalizers that must be invoked</span></span>
<span id="cb365-6"><a aria-hidden="true" href="#cb365-6" tabindex="-1"></a><span class="co">   because we deemed them unreachable.  This list must be global, and</span></span>
<span id="cb365-7"><a aria-hidden="true" href="#cb365-7" tabindex="-1"></a><span class="co">   not a local inside garbage_collect, in case we GC again while</span></span>
<span id="cb365-8"><a aria-hidden="true" href="#cb365-8" tabindex="-1"></a><span class="co">   running finalizers.  */</span></span>
<span id="cb365-9"><a aria-hidden="true" href="#cb365-9" tabindex="-1"></a><span class="kw">struct</span> Lisp_Finalizer doomed_finalizers<span class="op">;</span></span></code></pre></div>
<p>During GC, unreachable finalizers are queued:</p>
<div class="sourceCode" id="cb366"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb366-1"><a aria-hidden="true" href="#cb366-1" tabindex="-1"></a><span class="co">/* From src/alloc.c:3895 */</span></span>
<span id="cb366-2"><a aria-hidden="true" href="#cb366-2" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span></span>
<span id="cb366-3"><a aria-hidden="true" href="#cb366-3" tabindex="-1"></a>queue_doomed_finalizers <span class="op">(</span><span class="kw">struct</span> Lisp_Finalizer <span class="op">*</span>dest<span class="op">,</span></span>
<span id="cb366-4"><a aria-hidden="true" href="#cb366-4" tabindex="-1"></a>                         <span class="kw">struct</span> Lisp_Finalizer <span class="op">*</span>src<span class="op">)</span></span>
<span id="cb366-5"><a aria-hidden="true" href="#cb366-5" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb366-6"><a aria-hidden="true" href="#cb366-6" tabindex="-1"></a>  <span class="kw">struct</span> Lisp_Finalizer <span class="op">*</span>finalizer <span class="op">=</span> src<span class="op">-&gt;</span>next<span class="op">;</span></span>
<span id="cb366-7"><a aria-hidden="true" href="#cb366-7" tabindex="-1"></a>  <span class="cf">while</span> <span class="op">(</span>finalizer <span class="op">!=</span> src<span class="op">)</span></span>
<span id="cb366-8"><a aria-hidden="true" href="#cb366-8" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb366-9"><a aria-hidden="true" href="#cb366-9" tabindex="-1"></a>      <span class="kw">struct</span> Lisp_Finalizer <span class="op">*</span>next <span class="op">=</span> finalizer<span class="op">-&gt;</span>next<span class="op">;</span></span>
<span id="cb366-10"><a aria-hidden="true" href="#cb366-10" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(!</span>vectorlike_marked_p <span class="op">(&amp;</span>finalizer<span class="op">-&gt;</span>header<span class="op">)</span></span>
<span id="cb366-11"><a aria-hidden="true" href="#cb366-11" tabindex="-1"></a>          <span class="op">&amp;&amp;</span> <span class="op">!</span>NILP <span class="op">(</span>finalizer<span class="op">-&gt;</span>function<span class="op">))</span></span>
<span id="cb366-12"><a aria-hidden="true" href="#cb366-12" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb366-13"><a aria-hidden="true" href="#cb366-13" tabindex="-1"></a>          unchain_finalizer <span class="op">(</span>finalizer<span class="op">);</span></span>
<span id="cb366-14"><a aria-hidden="true" href="#cb366-14" tabindex="-1"></a>          finalizer_insert <span class="op">(</span>dest<span class="op">,</span> finalizer<span class="op">);</span></span>
<span id="cb366-15"><a aria-hidden="true" href="#cb366-15" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb366-16"><a aria-hidden="true" href="#cb366-16" tabindex="-1"></a>      finalizer <span class="op">=</span> next<span class="op">;</span></span>
<span id="cb366-17"><a aria-hidden="true" href="#cb366-17" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb366-18"><a aria-hidden="true" href="#cb366-18" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Then run after GC completes:</p>
<div class="sourceCode" id="cb367"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb367-1"><a aria-hidden="true" href="#cb367-1" tabindex="-1"></a><span class="co">/* From src/alloc.c:5960 */</span></span>
<span id="cb367-2"><a aria-hidden="true" href="#cb367-2" tabindex="-1"></a><span class="co">/* GC is complete: now we can run our finalizer callbacks.  */</span></span>
<span id="cb367-3"><a aria-hidden="true" href="#cb367-3" tabindex="-1"></a>run_finalizers <span class="op">(&amp;</span>doomed_finalizers<span class="op">);</span></span></code></pre></div>
<h3 data-number="12.6.3" id="pdumper-integration"><span class="header-section-number">12.6.3</span> pdumper Integration</h3>
<p>The portable dumper creates a snapshot of Emacs state. Objects in the
dump are treated specially:</p>
<div class="sourceCode" id="cb368"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb368-1"><a aria-hidden="true" href="#cb368-1" tabindex="-1"></a><span class="co">/* From src/alloc.c:6407 */</span></span>
<span id="cb368-2"><a aria-hidden="true" href="#cb368-2" tabindex="-1"></a><span class="cf">if</span> <span class="op">(</span>pdumper_object_p <span class="op">(</span>po<span class="op">))</span></span>
<span id="cb368-3"><a aria-hidden="true" href="#cb368-3" tabindex="-1"></a>  <span class="op">{</span></span>
<span id="cb368-4"><a aria-hidden="true" href="#cb368-4" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(!</span>pdumper_object_p_precise <span class="op">(</span>po<span class="op">))</span></span>
<span id="cb368-5"><a aria-hidden="true" href="#cb368-5" tabindex="-1"></a>      emacs_abort <span class="op">();</span></span>
<span id="cb368-6"><a aria-hidden="true" href="#cb368-6" tabindex="-1"></a>    <span class="cf">return</span><span class="op">;</span></span>
<span id="cb368-7"><a aria-hidden="true" href="#cb368-7" tabindex="-1"></a>  <span class="op">}</span></span></code></pre></div>
<p>Dumped objects: - Are never freed - Don‚Äôt have mark bits set - Use
special predicates for liveness checks</p>
<p>After sweeping, clear marks for dumped objects:</p>
<div class="sourceCode" id="cb369"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb369-1"><a aria-hidden="true" href="#cb369-1" tabindex="-1"></a><span class="co">/* From src/alloc.c:7101 */</span></span>
<span id="cb369-2"><a aria-hidden="true" href="#cb369-2" tabindex="-1"></a>pdumper_clear_marks <span class="op">();</span></span></code></pre></div>
<h3 data-number="12.6.4" id="memory-reserve"><span class="header-section-number">12.6.4</span> Memory Reserve</h3>
<p>Emacs keeps spare memory to handle allocation failures
gracefully:</p>
<div class="sourceCode" id="cb370"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb370-1"><a aria-hidden="true" href="#cb370-1" tabindex="-1"></a><span class="co">/* From src/alloc.c:332 */</span></span>
<span id="cb370-2"><a aria-hidden="true" href="#cb370-2" tabindex="-1"></a><span class="co">/* Points to memory space allocated as "spare", to be freed if we run</span></span>
<span id="cb370-3"><a aria-hidden="true" href="#cb370-3" tabindex="-1"></a><span class="co">   out of memory.  We keep one large block, four cons-blocks, and</span></span>
<span id="cb370-4"><a aria-hidden="true" href="#cb370-4" tabindex="-1"></a><span class="co">   two string blocks.  */</span></span>
<span id="cb370-5"><a aria-hidden="true" href="#cb370-5" tabindex="-1"></a></span>
<span id="cb370-6"><a aria-hidden="true" href="#cb370-6" tabindex="-1"></a><span class="dt">static</span> <span class="dt">char</span> <span class="op">*</span>spare_memory<span class="op">[</span><span class="dv">7</span><span class="op">];</span></span>
<span id="cb370-7"><a aria-hidden="true" href="#cb370-7" tabindex="-1"></a></span>
<span id="cb370-8"><a aria-hidden="true" href="#cb370-8" tabindex="-1"></a><span class="pp">#define SPARE_MEMORY </span><span class="op">(</span><span class="dv">1</span><span class="pp"> </span><span class="op">&lt;&lt;</span><span class="pp"> </span><span class="dv">14</span><span class="op">)</span></span></code></pre></div>
<p>On memory exhaustion:</p>
<div class="sourceCode" id="cb371"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb371-1"><a aria-hidden="true" href="#cb371-1" tabindex="-1"></a><span class="co">/* From src/alloc.c:4104 */</span></span>
<span id="cb371-2"><a aria-hidden="true" href="#cb371-2" tabindex="-1"></a><span class="dt">void</span></span>
<span id="cb371-3"><a aria-hidden="true" href="#cb371-3" tabindex="-1"></a>memory_full <span class="op">(</span><span class="dt">size_t</span> nbytes<span class="op">)</span></span>
<span id="cb371-4"><a aria-hidden="true" href="#cb371-4" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb371-5"><a aria-hidden="true" href="#cb371-5" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(!</span>initialized<span class="op">)</span></span>
<span id="cb371-6"><a aria-hidden="true" href="#cb371-6" tabindex="-1"></a>    fatal <span class="op">(</span><span class="st">"memory exhausted"</span><span class="op">);</span></span>
<span id="cb371-7"><a aria-hidden="true" href="#cb371-7" tabindex="-1"></a></span>
<span id="cb371-8"><a aria-hidden="true" href="#cb371-8" tabindex="-1"></a>  <span class="co">/* Free the spare memory */</span></span>
<span id="cb371-9"><a aria-hidden="true" href="#cb371-9" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> ARRAYELTS <span class="op">(</span>spare_memory<span class="op">);</span> i<span class="op">++)</span></span>
<span id="cb371-10"><a aria-hidden="true" href="#cb371-10" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>spare_memory<span class="op">[</span>i<span class="op">])</span></span>
<span id="cb371-11"><a aria-hidden="true" href="#cb371-11" tabindex="-1"></a>      <span class="op">{</span></span>
<span id="cb371-12"><a aria-hidden="true" href="#cb371-12" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>i <span class="op">==</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb371-13"><a aria-hidden="true" href="#cb371-13" tabindex="-1"></a>          free <span class="op">(</span>spare_memory<span class="op">[</span>i<span class="op">]);</span></span>
<span id="cb371-14"><a aria-hidden="true" href="#cb371-14" tabindex="-1"></a>        <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>i <span class="op">&gt;=</span> <span class="dv">1</span> <span class="op">&amp;&amp;</span> i <span class="op">&lt;=</span> <span class="dv">4</span><span class="op">)</span></span>
<span id="cb371-15"><a aria-hidden="true" href="#cb371-15" tabindex="-1"></a>          lisp_align_free <span class="op">(</span>spare_memory<span class="op">[</span>i<span class="op">]);</span></span>
<span id="cb371-16"><a aria-hidden="true" href="#cb371-16" tabindex="-1"></a>        <span class="cf">else</span></span>
<span id="cb371-17"><a aria-hidden="true" href="#cb371-17" tabindex="-1"></a>          lisp_free <span class="op">(</span>spare_memory<span class="op">[</span>i<span class="op">]);</span></span>
<span id="cb371-18"><a aria-hidden="true" href="#cb371-18" tabindex="-1"></a>        spare_memory<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb371-19"><a aria-hidden="true" href="#cb371-19" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb371-20"><a aria-hidden="true" href="#cb371-20" tabindex="-1"></a></span>
<span id="cb371-21"><a aria-hidden="true" href="#cb371-21" tabindex="-1"></a>  xsignal <span class="op">(</span>Qnil<span class="op">,</span> Vmemory_signal_data<span class="op">);</span></span>
<span id="cb371-22"><a aria-hidden="true" href="#cb371-22" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<hr/>
<h2 data-number="12.7" id="performance-and-tuning"><span class="header-section-number">12.7</span> Performance and Tuning</h2>
<h3 data-number="12.7.1" id="gc-triggering"><span class="header-section-number">12.7.1</span> GC Triggering</h3>
<p>GC is triggered when <code>consing_until_gc</code> becomes
negative:</p>
<div class="sourceCode" id="cb372"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb372-1"><a aria-hidden="true" href="#cb372-1" tabindex="-1"></a><span class="co">/* From src/alloc.c:282 */</span></span>
<span id="cb372-2"><a aria-hidden="true" href="#cb372-2" tabindex="-1"></a><span class="co">/* maybe_gc collects garbage if this goes negative.  */</span></span>
<span id="cb372-3"><a aria-hidden="true" href="#cb372-3" tabindex="-1"></a>EMACS_INT consing_until_gc<span class="op">;</span></span></code></pre></div>
<p>Each allocation decrements this counter:</p>
<div class="sourceCode" id="cb373"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb373-1"><a aria-hidden="true" href="#cb373-1" tabindex="-1"></a><span class="co">/* From src/alloc.c:2631 */</span></span>
<span id="cb373-2"><a aria-hidden="true" href="#cb373-2" tabindex="-1"></a>consing_until_gc <span class="op">-=</span> <span class="kw">sizeof</span> <span class="op">(</span><span class="kw">struct</span> Lisp_Cons<span class="op">);</span></span></code></pre></div>
<h3 data-number="12.7.2" id="gc-thresholds"><span class="header-section-number">12.7.2</span> GC Thresholds</h3>
<p>Two variables control when GC runs:</p>
<div class="sourceCode" id="cb374"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb374-1"><a aria-hidden="true" href="#cb374-1" tabindex="-1"></a><span class="co">/* From src/alloc.c:7385 */</span></span>
<span id="cb374-2"><a aria-hidden="true" href="#cb374-2" tabindex="-1"></a>DEFVAR_INT <span class="op">(</span><span class="st">"gc-cons-threshold"</span><span class="op">,</span> gc_cons_threshold<span class="op">,</span></span>
<span id="cb374-3"><a aria-hidden="true" href="#cb374-3" tabindex="-1"></a>      doc<span class="op">:</span> <span class="co">/* Number of bytes of consing between garbage collections.</span></span>
<span id="cb374-4"><a aria-hidden="true" href="#cb374-4" tabindex="-1"></a><span class="co">Garbage collection can happen automatically once this many bytes have been</span></span>
<span id="cb374-5"><a aria-hidden="true" href="#cb374-5" tabindex="-1"></a><span class="co">allocated since the last garbage collection.  All data types count.</span></span>
<span id="cb374-6"><a aria-hidden="true" href="#cb374-6" tabindex="-1"></a></span>
<span id="cb374-7"><a aria-hidden="true" href="#cb374-7" tabindex="-1"></a><span class="co">By binding this temporarily to a large number, you can effectively</span></span>
<span id="cb374-8"><a aria-hidden="true" href="#cb374-8" tabindex="-1"></a><span class="co">prevent garbage collection during a part of the program.  But be</span></span>
<span id="cb374-9"><a aria-hidden="true" href="#cb374-9" tabindex="-1"></a><span class="co">sure to get back to the normal value soon enough, to avoid system-wide</span></span>
<span id="cb374-10"><a aria-hidden="true" href="#cb374-10" tabindex="-1"></a><span class="co">memory pressure. */</span><span class="op">);</span></span></code></pre></div>
<p>And:</p>
<div class="sourceCode" id="cb375"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb375-1"><a aria-hidden="true" href="#cb375-1" tabindex="-1"></a>DEFVAR_LISP <span class="op">(</span><span class="st">"gc-cons-percentage"</span><span class="op">,</span> Vgc_cons_percentage<span class="op">,</span></span>
<span id="cb375-2"><a aria-hidden="true" href="#cb375-2" tabindex="-1"></a>      doc<span class="op">:</span> <span class="co">/* Portion of the heap used for allocation.</span></span>
<span id="cb375-3"><a aria-hidden="true" href="#cb375-3" tabindex="-1"></a><span class="co">Garbage collection can happen automatically once this portion of the heap</span></span>
<span id="cb375-4"><a aria-hidden="true" href="#cb375-4" tabindex="-1"></a><span class="co">has been allocated since the last garbage collection.</span></span>
<span id="cb375-5"><a aria-hidden="true" href="#cb375-5" tabindex="-1"></a><span class="co">If this portion is smaller than `gc-cons-threshold', this is ignored.  */</span><span class="op">);</span></span></code></pre></div>
<p>The threshold is calculated dynamically:</p>
<div class="sourceCode" id="cb376"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb376-1"><a aria-hidden="true" href="#cb376-1" tabindex="-1"></a><span class="co">/* From src/alloc.c:5703 */</span></span>
<span id="cb376-2"><a aria-hidden="true" href="#cb376-2" tabindex="-1"></a><span class="dt">static</span> EMACS_INT</span>
<span id="cb376-3"><a aria-hidden="true" href="#cb376-3" tabindex="-1"></a>consing_threshold <span class="op">(</span><span class="dt">intmax_t</span> threshold<span class="op">,</span> Lisp_Object percentage<span class="op">,</span></span>
<span id="cb376-4"><a aria-hidden="true" href="#cb376-4" tabindex="-1"></a>           <span class="dt">intmax_t</span> since_gc<span class="op">)</span></span>
<span id="cb376-5"><a aria-hidden="true" href="#cb376-5" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb376-6"><a aria-hidden="true" href="#cb376-6" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(!</span>NILP <span class="op">(</span>Vmemory_full<span class="op">))</span></span>
<span id="cb376-7"><a aria-hidden="true" href="#cb376-7" tabindex="-1"></a>    <span class="cf">return</span> memory_full_cons_threshold<span class="op">;</span></span>
<span id="cb376-8"><a aria-hidden="true" href="#cb376-8" tabindex="-1"></a>  <span class="cf">else</span></span>
<span id="cb376-9"><a aria-hidden="true" href="#cb376-9" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb376-10"><a aria-hidden="true" href="#cb376-10" tabindex="-1"></a>      threshold <span class="op">=</span> max <span class="op">(</span>threshold<span class="op">,</span> GC_DEFAULT_THRESHOLD <span class="op">/</span> <span class="dv">10</span><span class="op">);</span></span>
<span id="cb376-11"><a aria-hidden="true" href="#cb376-11" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span>FLOATP <span class="op">(</span>percentage<span class="op">))</span></span>
<span id="cb376-12"><a aria-hidden="true" href="#cb376-12" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb376-13"><a aria-hidden="true" href="#cb376-13" tabindex="-1"></a>      <span class="dt">double</span> tot <span class="op">=</span> <span class="op">(</span>XFLOAT_DATA <span class="op">(</span>percentage<span class="op">)</span></span>
<span id="cb376-14"><a aria-hidden="true" href="#cb376-14" tabindex="-1"></a>            <span class="op">*</span> <span class="op">(</span>total_bytes_of_live_objects <span class="op">()</span> <span class="op">+</span> since_gc<span class="op">));</span></span>
<span id="cb376-15"><a aria-hidden="true" href="#cb376-15" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span>threshold <span class="op">&lt;</span> tot<span class="op">)</span></span>
<span id="cb376-16"><a aria-hidden="true" href="#cb376-16" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb376-17"><a aria-hidden="true" href="#cb376-17" tabindex="-1"></a>          <span class="cf">if</span> <span class="op">(</span>tot <span class="op">&lt;</span> HI_THRESHOLD<span class="op">)</span></span>
<span id="cb376-18"><a aria-hidden="true" href="#cb376-18" tabindex="-1"></a>        <span class="cf">return</span> tot<span class="op">;</span></span>
<span id="cb376-19"><a aria-hidden="true" href="#cb376-19" tabindex="-1"></a>          <span class="cf">else</span></span>
<span id="cb376-20"><a aria-hidden="true" href="#cb376-20" tabindex="-1"></a>        <span class="cf">return</span> HI_THRESHOLD<span class="op">;</span></span>
<span id="cb376-21"><a aria-hidden="true" href="#cb376-21" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb376-22"><a aria-hidden="true" href="#cb376-22" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb376-23"><a aria-hidden="true" href="#cb376-23" tabindex="-1"></a>      <span class="cf">return</span> min <span class="op">(</span>threshold<span class="op">,</span> HI_THRESHOLD<span class="op">);</span></span>
<span id="cb376-24"><a aria-hidden="true" href="#cb376-24" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb376-25"><a aria-hidden="true" href="#cb376-25" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 data-number="12.7.3" id="avoiding-gc-pauses"><span class="header-section-number">12.7.3</span> Avoiding GC Pauses</h3>
<p><strong>Techniques</strong>:</p>
<ol type="1">
<li><p><strong>Increase <code>gc-cons-threshold</code></strong>
temporarily during performance-critical sections:</p>
<pre class="elisp"><code>(let ((gc-cons-threshold most-positive-fixnum))
  ;; Performance-critical code
  ...)</code></pre></li>
<li><p><strong>Pre-allocate</strong> objects when possible to avoid
allocation during critical sections</p></li>
<li><p><strong>Use <code>garbage-collection-messages</code></strong> to
monitor GC frequency:</p>
<pre class="elisp"><code>(setq garbage-collection-messages t)</code></pre></li>
<li><p><strong>Inhibit GC</strong> explicitly (use sparingly):</p>
<div class="sourceCode" id="cb379"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb379-1"><a aria-hidden="true" href="#cb379-1" tabindex="-1"></a><span class="co">/* From src/alloc.c:341 */</span></span>
<span id="cb379-2"><a aria-hidden="true" href="#cb379-2" tabindex="-1"></a><span class="dt">intptr_t</span> garbage_collection_inhibited<span class="op">;</span></span></code></pre></div></li>
<li><p><strong>Batch allocations</strong> to amortize GC cost</p></li>
</ol>
<h3 data-number="12.7.4" id="memory-profiling"><span class="header-section-number">12.7.4</span> Memory Profiling</h3>
<p><strong>Built-in tools</strong>:</p>
<ol type="1">
<li><p><strong><code>garbage-collect</code></strong> returns
statistics:</p>
<pre class="elisp"><code>(garbage-collect)
;; =&gt; ((conses 16 274839 55940)
;;     (symbols 48 22252 3)
;;     (strings 32 72874 4451)
;;     ...)</code></pre></li>
<li><p><strong><code>memory-use-counts</code></strong> shows allocation
counts:</p>
<div class="sourceCode" id="cb381"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb381-1"><a aria-hidden="true" href="#cb381-1" tabindex="-1"></a><span class="co">/* From src/alloc.c:7163 */</span></span>
<span id="cb381-2"><a aria-hidden="true" href="#cb381-2" tabindex="-1"></a>DEFUN <span class="op">(</span><span class="st">"memory-use-counts"</span><span class="op">,</span> Fmemory_use_counts<span class="op">,</span> <span class="op">...)</span></span></code></pre></div></li>
<li><p><strong><code>memory-info</code></strong> shows system
memory:</p>
<div class="sourceCode" id="cb382"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb382-1"><a aria-hidden="true" href="#cb382-1" tabindex="-1"></a><span class="co">/* From src/alloc.c:7105 */</span></span>
<span id="cb382-2"><a aria-hidden="true" href="#cb382-2" tabindex="-1"></a>DEFUN <span class="op">(</span><span class="st">"memory-info"</span><span class="op">,</span> Fmemory_info<span class="op">,</span> <span class="op">...)</span></span></code></pre></div></li>
</ol>
<p><strong>Statistics tracked</strong>:</p>
<div class="sourceCode" id="cb383"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb383-1"><a aria-hidden="true" href="#cb383-1" tabindex="-1"></a><span class="co">/* From src/alloc.c:308 */</span></span>
<span id="cb383-2"><a aria-hidden="true" href="#cb383-2" tabindex="-1"></a><span class="dt">static</span> <span class="kw">struct</span> gcstat</span>
<span id="cb383-3"><a aria-hidden="true" href="#cb383-3" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb383-4"><a aria-hidden="true" href="#cb383-4" tabindex="-1"></a>  object_ct total_conses<span class="op">,</span> total_free_conses<span class="op">;</span></span>
<span id="cb383-5"><a aria-hidden="true" href="#cb383-5" tabindex="-1"></a>  object_ct total_symbols<span class="op">,</span> total_free_symbols<span class="op">;</span></span>
<span id="cb383-6"><a aria-hidden="true" href="#cb383-6" tabindex="-1"></a>  object_ct total_strings<span class="op">,</span> total_free_strings<span class="op">;</span></span>
<span id="cb383-7"><a aria-hidden="true" href="#cb383-7" tabindex="-1"></a>  byte_ct total_string_bytes<span class="op">;</span></span>
<span id="cb383-8"><a aria-hidden="true" href="#cb383-8" tabindex="-1"></a>  object_ct total_vectors<span class="op">,</span> total_vector_slots<span class="op">,</span> total_free_vector_slots<span class="op">;</span></span>
<span id="cb383-9"><a aria-hidden="true" href="#cb383-9" tabindex="-1"></a>  object_ct total_floats<span class="op">,</span> total_free_floats<span class="op">;</span></span>
<span id="cb383-10"><a aria-hidden="true" href="#cb383-10" tabindex="-1"></a>  object_ct total_intervals<span class="op">,</span> total_free_intervals<span class="op">;</span></span>
<span id="cb383-11"><a aria-hidden="true" href="#cb383-11" tabindex="-1"></a>  object_ct total_buffers<span class="op">;</span></span>
<span id="cb383-12"><a aria-hidden="true" href="#cb383-12" tabindex="-1"></a>  byte_ct total_hash_table_bytes<span class="op">;</span></span>
<span id="cb383-13"><a aria-hidden="true" href="#cb383-13" tabindex="-1"></a><span class="op">}</span> gcstat<span class="op">;</span></span></code></pre></div>
<h3 data-number="12.7.5" id="common-patterns-1"><span class="header-section-number">12.7.5</span> Common Patterns</h3>
<p><strong>Pattern 1: Temporary High Threshold</strong></p>
<pre class="elisp"><code>(defun process-large-data (data)
  (let ((gc-cons-threshold (* 100 1024 1024))) ; 100MB
    (process data)))</code></pre>
<p><strong>Pattern 2: Explicit GC Between Tasks</strong></p>
<pre class="elisp"><code>(defun batch-processor (items)
  (dolist (item items)
    (process-item item)
    (garbage-collect))) ; Clean up between items</code></pre>
<p><strong>Pattern 3: Monitor GC Performance</strong></p>
<pre class="elisp"><code>(let ((start-time (float-time))
      (gc-start (garbage-collect)))
  ;; Do work
  (let ((gc-end (garbage-collect)))
    (message "GC diff: %S, Time: %.2fs"
             (mapcar (lambda (a b)
                      (list (car a)
                            (- (nth 2 a) (nth 2 b))))
                    gc-end gc-start)
             (- (float-time) start-time))))</code></pre>
<h3 data-number="12.7.6" id="performance-characteristics-2"><span class="header-section-number">12.7.6</span> Performance
Characteristics</h3>
<p><strong>Allocation Costs</strong>: - <strong>Cons</strong>: O(1) from
free list, O(1) amortized for new blocks - <strong>String</strong>: O(1)
for struct, O(n) for data - <strong>Vector</strong>: O(1) from free
list, O(log n) to find free space - <strong>Symbol</strong>: O(1) from
free list</p>
<p><strong>GC Costs</strong>: - <strong>Mark Phase</strong>: O(live
objects), depth-first traversal - <strong>Sweep Phase</strong>: O(all
allocated objects) - <strong>Total</strong>: O(heap size), not
generational</p>
<p><strong>Memory Overhead</strong>: - Cons: ~16 bytes + mark bit -
String: ~32 bytes struct + data + alignment - Vector: header + contents
+ alignment - Symbol: ~48 bytes</p>
<hr/>
<h2 data-number="12.8" id="summary-2"><span class="header-section-number">12.8</span> Summary</h2>
<p>Emacs‚Äôs memory management system is a carefully tuned implementation
that balances:</p>
<ol type="1">
<li><strong>Performance</strong>: Fast allocation via free lists and
block allocation</li>
<li><strong>Simplicity</strong>: Non-copying GC works well with C
integration</li>
<li><strong>Flexibility</strong>: Multiple specialized allocators for
different types</li>
<li><strong>Debugging</strong>: Comprehensive checking and
statistics</li>
</ol>
<p>Key insights:</p>
<ul>
<li><strong>Block allocation</strong> minimizes malloc overhead and
fragmentation</li>
<li><strong>Free lists</strong> make allocation O(1) for common
cases</li>
<li><strong>Mark-and-sweep</strong> is simple, predictable, and
C-friendly</li>
<li><strong>Conservative stack scanning</strong> handles C/Lisp
interaction safely</li>
<li><strong>Weak references</strong> and <strong>finalizers</strong>
provide advanced memory management</li>
<li><strong>pdumper integration</strong> enables fast startup with
pre-allocated objects</li>
</ul>
<p>For most Elisp code, the GC is transparent and efficient.
Understanding these internals helps when: - Optimizing
performance-critical code - Debugging memory issues - Interfacing with C
code - Tuning GC parameters for specific workloads</p>
<p>The implementation in <code>src/alloc.c</code> is a masterclass in
systems programming, balancing decades of evolution with modern
performance requirements.</p>
<h1 data-number="13" id="org-mode-literate-programming-and-organization"><span class="header-section-number">13</span> Org Mode: Literate Programming
and Organization</h1>
<h2 data-number="13.1" id="overview-4"><span class="header-section-number">13.1</span> Overview</h2>
<p>Org mode is one of Emacs‚Äôs most significant and comprehensive
subsystems, providing a complete environment for notes, task management,
literate programming, and document preparation. The codebase comprises
<strong>127 files with 146,533 lines</strong> of code.</p>
<p><strong>Location:</strong>
<code>/home/user/emacs/lisp/org/</code></p>
<p><strong>Key Statistics:</strong> - Core file: <code>org.el</code>
(22,373 lines) - Parser: <code>org-element.el</code> (8,730 lines) -
Agenda: <code>org-agenda.el</code> (11,211 lines) - Tables:
<code>org-table.el</code> (6,438 lines) - Export core:
<code>ox.el</code> (7,450 lines) - Babel core: <code>ob-core.el</code>
(3,677 lines) - 48 Babel language files (ob-<em>.el) - 12 export
backends (ox-</em>.el)</p>
<h2 data-number="13.2" id="core-architecture"><span class="header-section-number">13.2</span> Core Architecture</h2>
<h3 data-number="13.2.1" id="foundation-building-on-outline-mode"><span class="header-section-number">13.2.1</span> 1. Foundation: Building on
Outline Mode</h3>
<p>Org mode is fundamentally built on top of Emacs‚Äôs
<code>outline-mode</code>, extending it with rich functionality for task
management, literate programming, and document export.</p>
<pre class="elisp"><code>;; From org.el (lines 1-50)
;;; org.el --- Outline-based notes management and organizer -*- lexical-binding: t; -*-

;; Org is a mode for keeping notes, maintaining ToDo lists, and doing
;; project planning with a fast and effective plain-text system.
;;
;; Org mode develops organizational tasks around NOTES files that
;; contain information about projects as plain text.  Org mode is
;; implemented on top of outline-mode, which makes it possible to keep
;; the content of large files well structured.

;; Core outline integration
(defvar org-outline-regexp "\\*+ "
  "Regexp to match Org headlines.")

(defvar org-outline-regexp-bol "^\\*+ "
  "Regexp to match Org headlines.
This is similar to `org-outline-regexp' but additionally makes
sure that we are at the beginning of the line.")

(defvar org-heading-regexp "^\\(\\*+\\)\\(?: +\\(.*?\\)\\)?[ \t]*$"
  "Matches a headline, putting stars and text into groups.
Stars are put in group 1 and the trimmed body in group 2.")</code></pre>
<p><strong>Key Architecture Principle:</strong> Org mode headlines are
outline headings denoted by asterisks (*), with the number of asterisks
determining the heading level. This simple syntax enables the entire
hierarchy system.</p>
<h3 data-number="13.2.2" id="the-org.el-core-22373-lines"><span class="header-section-number">13.2.2</span> 2. The org.el Core (22,373
lines)</h3>
<p>The main <code>org.el</code> file serves as the entry point and
orchestrator for the entire system.</p>
<p><strong>Key Responsibilities:</strong></p>
<pre class="elisp"><code>;; From org.el (lines 72-104)
;;;; Require other packages

(require 'org-compat)
(org-assert-version)

(require 'cl-lib)
(require 'calendar)
(require 'find-func)
(require 'format-spec)
(require 'thingatpt)

;; Load org subsystems
(eval-and-compile (require 'org-macs))
(require 'org-compat)
(require 'org-keys)
(require 'ol)              ; Links
(require 'oc)              ; Citations
(require 'org-table)       ; Tables
(require 'org-fold)        ; Folding
(require 'org-cycle)       ; Visibility cycling</code></pre>
<p><strong>Module Organization:</strong> 1. <strong>Core
utilities</strong> - <code>org-macs.el</code>,
<code>org-compat.el</code> 2. <strong>Syntax layer</strong> -
<code>org-element.el</code> (parser) 3. <strong>UI layer</strong> -
<code>org-cycle.el</code>, <code>org-fold.el</code>,
<code>org-keys.el</code> 4. <strong>Feature modules</strong> - Links,
tables, agenda, capture 5. <strong>Babel</strong> -
<code>ob-core.el</code> + language files 6. <strong>Export</strong> -
<code>ox.el</code> + backend files</p>
<h3 data-number="13.2.3" id="the-element-parser-org-element.el-8730-lines"><span class="header-section-number">13.2.3</span> 3. The Element Parser
(org-element.el, 8,730 lines)</h3>
<p>The <code>org-element.el</code> parser provides a complete abstract
syntax tree (AST) representation of Org documents.</p>
<p><strong>Parser Architecture:</strong></p>
<pre class="elisp"><code>;; From org-element.el (lines 24-57)
;;; Commentary:
;;
;; See &lt;https://orgmode.org/worg/dev/org-syntax.html&gt; for details about
;; Org syntax.
;;
;; Lisp-wise, a syntax object can be represented as a list.
;; It follows the pattern (TYPE PROPERTIES CONTENTS), where:
;;   TYPE is a symbol describing the object.
;;   PROPERTIES is the property list attached to it.  See docstring of
;;              appropriate parsing function to get an exhaustive list.
;;   CONTENTS is a list of syntax objects or raw strings contained
;;            in the current object, when applicable.
;;
;; For the whole document, TYPE is `org-data' and PROPERTIES is nil.</code></pre>
<p><strong>Element Types Defined:</strong></p>
<pre class="elisp"><code>;; From org-element.el (lines 103-200)

;; Constant definitions for various element types
(defconst org-element-archive-tag "ARCHIVE"
  "Tag marking a subtree as archived.")

(defconst org-element-citation-key-re
  (rx "@" (group (one-or-more (any word "-.:?!`'/*@+|(){}&lt;&gt;&amp;_^$#%~"))))
  "Regexp matching a citation key.")

(defconst org-element-clock-line-re
  ;; Regex for CLOCK: lines
  "Regexp matching a clock line.")

(defconst org-element-comment-string "COMMENT"
  "String marker for commented headlines.")

(defconst org-element-closed-keyword "CLOSED:"
  "Keyword used to close TODO entries.")

(defconst org-element-deadline-keyword "DEADLINE:"
  "Keyword used to mark deadline entries.")

(defconst org-element-scheduled-keyword "SCHEDULED:"
  "Keyword used to mark scheduled entries.")

(defconst org-element-drawer-re
  (rx line-start (0+ (any ?\s ?\t))
      ":" (group (1+ (any ?- ?_ word))) ":"
      (0+ (any ?\s ?\t)) line-end)
  "Regexp matching opening or closing line of a drawer.")

(defconst org-element-dynamic-block-open-re
  ;; Regex for #+BEGIN: blocks
  "Regexp matching the opening line of a dynamic block.")</code></pre>
<p><strong>Parser API:</strong></p>
<p>The element parser provides several key functions:</p>
<ol type="1">
<li><strong><code>org-element-parse-buffer</code></strong> - Parse
entire buffer into AST</li>
<li><strong><code>org-element-at-point</code></strong> - Get element at
current position</li>
<li><strong><code>org-element-context</code></strong> - Get detailed
context (including objects within elements)</li>
<li><strong><code>org-element-map</code></strong> - Walk the parse
tree</li>
<li><strong><code>org-element-interpret-data</code></strong> - Convert
AST back to Org syntax</li>
</ol>
<p><strong>Cache System:</strong></p>
<p>The parser includes a sophisticated caching mechanism to avoid
re-parsing unchanged portions of the buffer, critical for performance on
large files.</p>
<h3 data-number="13.2.4" id="visibility-cycling-org-cycle.el-947-lines"><span class="header-section-number">13.2.4</span> 4. Visibility Cycling
(org-cycle.el, 947 lines)</h3>
<p>Org mode‚Äôs signature feature is TAB-based visibility cycling through
outline levels.</p>
<pre class="elisp"><code>;; From org-cycle.el (lines 1-30)
;;; org-cycle.el --- Visibility cycling of Org entries -*- lexical-binding: t; -*-

;;; Commentary:

;; This file contains code controlling global folding state in buffer
;; and TAB-cycling.

(defvar-local org-cycle-global-status nil)
(put 'org-cycle-global-status 'org-state t)
(defvar-local org-cycle-subtree-status nil)
(put 'org-cycle-subtree-status 'org-state t)

(defcustom org-cycle-skip-children-state-if-no-children t
  "Non-nil means skip CHILDREN state in entries that don't have any."
  :group 'org-cycle
  :type 'boolean)

(defcustom org-cycle-max-level nil
  "Maximum level which should still be subject to visibility cycling.
Levels higher than this will, for cycling, be treated as text, not a headline."
  :group 'org-cycle
  :type '(choice
          (const :tag "No limit" nil)
          (integer :tag "Maximum level")))</code></pre>
<p><strong>Cycling States:</strong> 1. <strong>FOLDED</strong> - Only
headlines visible 2. <strong>CHILDREN</strong> - Direct children visible
3. <strong>SUBTREE</strong> - All descendants visible</p>
<p>The cycling system integrates with the <code>org-fold.el</code>
folding backend, which provides efficient text hiding.</p>
<h2 data-number="13.3" id="babel-literate-programming-system"><span class="header-section-number">13.3</span> Babel: Literate Programming
System</h2>
<p>Org-Babel is Org mode‚Äôs literate programming subsystem, enabling
executable code blocks in 40+ languages.</p>
<h3 data-number="13.3.1" id="babel-core-ob-core.el-3677-lines"><span class="header-section-number">13.3.1</span> 1. Babel Core (ob-core.el,
3,677 lines)</h3>
<p>The core provides the execution engine and infrastructure.</p>
<pre class="elisp"><code>;; From ob-core.el (lines 1-27)
;;; ob-core.el --- Working with Code Blocks          -*- lexical-binding: t; -*-

;; Authors: Eric Schulte
;;  Dan Davison
;; Keywords: literate programming, reproducible research

;;; Commentary:

;; Security and confirmation
(defcustom org-confirm-babel-evaluate t
  "Confirm before evaluation.
Require confirmation before interactively evaluating code
blocks in Org buffers.  The default value of this variable is t,
meaning confirmation is required for any code block evaluation.
This variable can be set to nil to inhibit any future
confirmation requests.  This variable can also be set to a
function which takes two arguments the language of the code block
and the body of the code block.

Warning: Disabling confirmation may result in accidental
evaluation of potentially harmful code."
  :group 'org-babel
  :version "24.1"
  :type '(choice boolean function))

(defcustom org-babel-results-keyword "RESULTS"
  "Keyword used to name results generated by code blocks."
  :group 'org-babel
  :version "24.4"
  :type 'string)</code></pre>
<p><strong>Code Block Structure:</strong></p>
<div class="sourceCode" id="cb393"><pre class="sourceCode org"><code class="sourceCode orgmode"><span id="cb393-1"><a aria-hidden="true" href="#cb393-1" tabindex="-1"></a>#+begin_src language :header-args</span>
<span id="cb393-2"><a aria-hidden="true" href="#cb393-2" tabindex="-1"></a>  code here</span>
<span id="cb393-3"><a aria-hidden="true" href="#cb393-3" tabindex="-1"></a>#+end_src</span>
<span id="cb393-4"><a aria-hidden="true" href="#cb393-4" tabindex="-1"></a></span>
<span id="cb393-5"><a aria-hidden="true" href="#cb393-5" tabindex="-1"></a><span class="pp">#+RESULTS:</span></span>
<span id="cb393-6"><a aria-hidden="true" href="#cb393-6" tabindex="-1"></a>: output here</span></code></pre></div>
<p><strong>Header Arguments Control:</strong> - <code>:results</code> -
How to handle output (value, output, silent, replace, append) -
<code>:session</code> - Named session for persistent state -
<code>:exports</code> - What to export (code, results, both, none) -
<code>:file</code> - Output to file - <code>:var</code> - Variable
bindings - <code>:noweb</code> - Literate programming references</p>
<h3 data-number="13.3.2" id="language-support-48-language-files"><span class="header-section-number">13.3.2</span> 2. Language Support (48
language files)</h3>
<p>Each language has an <code>ob-LANG.el</code> file implementing the
language interface.</p>
<p><strong>Example: Python Support (ob-python.el)</strong></p>
<pre class="elisp"><code>;; From ob-python.el (lines 1-124)
;;; ob-python.el --- Babel Functions for Python      -*- lexical-binding: t; -*-

;; Authors: Eric Schulte
;;   Dan Davison
;; Maintainer: Jack Kamm &lt;jackkamm@gmail.com&gt;
;; Keywords: literate programming, reproducible research

(require 'ob)
(require 'org-macs)
(require 'python)

;; Register file extension for tangling
(defvar org-babel-tangle-lang-exts)
(add-to-list 'org-babel-tangle-lang-exts '("python" . "py"))

;; Default header arguments
(defvar org-babel-default-header-args:python '())

;; Language-specific header arguments
(defconst org-babel-header-args:python
  '((return . :any)
    (python . :any)
    (async . ((yes no))))
  "Python-specific header arguments.")

;; Main execution function
(defun org-babel-execute:python (body params)
  "Execute Python BODY according to PARAMS.
This function is called by `org-babel-execute-src-block'."
  (let* ((session (org-babel-python-initiate-session
                   (cdr (assq :session params))))
         (result-params (cdr (assq :result-params params)))
         (result-type (cdr (assq :result-type params)))
         (full-body
          (concat
           (org-babel-expand-body:generic
            body params
            (org-babel-variable-assignments:python params))
           (when return-val
             (format (if session "\n%s" "\nreturn %s") return-val))))
         (result (org-babel-python-evaluate
                  session full-body result-type
                  result-params preamble async graphics-file)))
    (org-babel-reassemble-table
     result
     (org-babel-pick-name (cdr (assq :colname-names params))
                          (cdr (assq :colnames params)))
     (org-babel-pick-name (cdr (assq :rowname-names params))
                          (cdr (assq :rownames params))))))</code></pre>
<p><strong>Language Interface Contract:</strong></p>
<p>Each language file must implement: 1.
<strong><code>org-babel-execute:LANG</code></strong> - Execute code
block 2. <strong><code>org-babel-expand-body:LANG</code></strong> -
Expand noweb references 3.
<strong><code>org-babel-variable-assignments:LANG</code></strong> -
Convert variables to language syntax 4.
<strong><code>org-babel-prep-session:LANG</code></strong> - Initialize
session (optional)</p>
<p><strong>Supported Languages (48 total):</strong></p>
<pre><code>awk, C/C++, R, calc, clojure, css, ditaa, dot, emacs-lisp, eshell,
forth, fortran, gnuplot, groovy, haskell, java, js, julia, latex,
lilypond, lisp, lua, makefile, matlab, maxima, ocaml, octave, org,
perl, plantuml, processing, python, ruby, sass, scheme, screen, sed,
shell, sql, sqlite, and more...</code></pre>
<h3 data-number="13.3.3" id="tangling-ob-tangle.el-736-lines"><span class="header-section-number">13.3.3</span> 3. Tangling (ob-tangle.el,
736 lines)</h3>
<p>Tangling extracts code blocks to source files for execution.</p>
<pre class="elisp"><code>;; From ob-tangle.el (lines 1-150)
;;; ob-tangle.el --- Extract Source Code From Org Files -*- lexical-binding: t; -*-

;; Author: Eric Schulte
;; Keywords: literate programming, reproducible research

;;; Commentary:

;; Extract the code from source blocks out into raw source-code files.

(defcustom org-babel-tangle-lang-exts
  '(("emacs-lisp" . "el")
    ("elisp" . "el"))
  "Alist mapping languages to their file extensions.
The key is the language name, the value is the string that should
be inserted as the extension commonly used to identify files
written in this language."
  :group 'org-babel-tangle
  :type '(repeat
          (cons
           (string "Language name")
           (string "File Extension"))))

(defcustom org-babel-post-tangle-hook nil
  "Hook run in code files tangled by `org-babel-tangle'."
  :group 'org-babel-tangle
  :type 'hook)

(defcustom org-babel-tangle-comment-format-beg "[[%link][%source-name]]"
  "Format of inserted comments in tangled code files.
The following format strings can be used to insert special
information into the output using `org-fill-template'.
%start-line --- the line number at the start of the code block
%file --------- the file from which the code block was tangled
%link --------- Org style link to the code block
%source-name -- name of the code block"
  :group 'org-babel-tangle
  :type 'string)</code></pre>
<p><strong>Tangle Process:</strong></p>
<ol type="1">
<li>Parse buffer for all code blocks with <code>:tangle</code>
header</li>
<li>Group blocks by target file</li>
<li>Sort by <code>:tangle</code> order or buffer position</li>
<li>Write blocks to files with optional comments</li>
<li>Set file permissions (for scripts)</li>
<li>Run <code>org-babel-post-tangle-hook</code></li>
</ol>
<p><strong>Tangle Headers:</strong></p>
<div class="sourceCode" id="cb397"><pre class="sourceCode org"><code class="sourceCode orgmode"><span id="cb397-1"><a aria-hidden="true" href="#cb397-1" tabindex="-1"></a>#+begin_src emacs-lisp :tangle init.el</span>
<span id="cb397-2"><a aria-hidden="true" href="#cb397-2" tabindex="-1"></a>  ;; This code will be written to init.el</span>
<span id="cb397-3"><a aria-hidden="true" href="#cb397-3" tabindex="-1"></a>#+end_src</span>
<span id="cb397-4"><a aria-hidden="true" href="#cb397-4" tabindex="-1"></a></span>
<span id="cb397-5"><a aria-hidden="true" href="#cb397-5" tabindex="-1"></a>#+begin_src python :tangle script.py :shebang #!/usr/bin/env python</span>
<span id="cb397-6"><a aria-hidden="true" href="#cb397-6" tabindex="-1"></a><span class="co">  # This becomes an executable Python script</span></span>
<span id="cb397-7"><a aria-hidden="true" href="#cb397-7" tabindex="-1"></a>#+end_src</span></code></pre></div>
<h3 data-number="13.3.4" id="noweb-reference-system"><span class="header-section-number">13.3.4</span> 4. Noweb Reference
System</h3>
<p>Babel supports literate programming through noweb-style
references.</p>
<pre class="elisp"><code>;; From ob-core.el (lines 199-200)
(defcustom org-babel-noweb-wrap-start "&lt;&lt;"
  "String used to begin a noweb reference in a code block.")

(defcustom org-babel-noweb-wrap-end "&gt;&gt;"
  "String used to end a noweb reference in a code block.")</code></pre>
<p><strong>Usage Example:</strong></p>
<div class="sourceCode" id="cb399"><pre class="sourceCode org"><code class="sourceCode orgmode"><span id="cb399-1"><a aria-hidden="true" href="#cb399-1" tabindex="-1"></a>#+name: setup</span>
<span id="cb399-2"><a aria-hidden="true" href="#cb399-2" tabindex="-1"></a>#+begin_src python</span>
<span id="cb399-3"><a aria-hidden="true" href="#cb399-3" tabindex="-1"></a>  import numpy as np</span>
<span id="cb399-4"><a aria-hidden="true" href="#cb399-4" tabindex="-1"></a>  import matplotlib.pyplot as plt</span>
<span id="cb399-5"><a aria-hidden="true" href="#cb399-5" tabindex="-1"></a>#+end_src</span>
<span id="cb399-6"><a aria-hidden="true" href="#cb399-6" tabindex="-1"></a></span>
<span id="cb399-7"><a aria-hidden="true" href="#cb399-7" tabindex="-1"></a>#+name: analysis</span>
<span id="cb399-8"><a aria-hidden="true" href="#cb399-8" tabindex="-1"></a>#+begin_src python :noweb yes</span>
<span id="cb399-9"><a aria-hidden="true" href="#cb399-9" tabindex="-1"></a>  &lt;&lt;setup&gt;&gt;</span>
<span id="cb399-10"><a aria-hidden="true" href="#cb399-10" tabindex="-1"></a></span>
<span id="cb399-11"><a aria-hidden="true" href="#cb399-11" tabindex="-1"></a><span class="co">  # Analysis code using the imports</span></span>
<span id="cb399-12"><a aria-hidden="true" href="#cb399-12" tabindex="-1"></a>  data = np.random.randn(1000)</span>
<span id="cb399-13"><a aria-hidden="true" href="#cb399-13" tabindex="-1"></a>  plt.hist(data)</span>
<span id="cb399-14"><a aria-hidden="true" href="#cb399-14" tabindex="-1"></a>#+end_src</span></code></pre></div>
<h2 data-number="13.4" id="export-system"><span class="header-section-number">13.4</span> Export System</h2>
<p>The export system provides a pluggable architecture for converting
Org documents to various formats.</p>
<h3 data-number="13.4.1" id="export-core-ox.el-7450-lines"><span class="header-section-number">13.4.1</span> 1. Export Core (ox.el, 7,450
lines)</h3>
<p>The generic export engine built on the element parser.</p>
<pre class="elisp"><code>;; From ox.el (lines 24-71)
;;; Commentary:
;;
;; This library implements a generic export engine for Org, built on
;; its syntactical parser: Org Elements.
;;
;; Besides that parser, the generic exporter is made of three distinct
;; parts:
;;
;; - The communication channel consists of a property list, which is
;;   created and updated during the process.  Its use is to offer
;;   every piece of information, would it be about initial environment
;;   or contextual data, all in a single place.
;;
;; - The transcoder walks the parse tree, ignores or treat as plain
;;   text elements and objects according to export options, and
;;   eventually calls backend specific functions to do the real
;;   transcoding, concatenating their return value along the way.
;;
;; - The filter system is activated at the very beginning and the very
;;   end of the export process, and each time an element or an object
;;   has been converted.  It is the entry point to fine-tune standard
;;   output from backend transcoders.
;;
;; The core functions is `org-export-as'.  It returns the transcoded
;; buffer as a string.  Its derivatives are `org-export-to-buffer' and
;; `org-export-to-file'.
;;
;; An export backend is defined with `org-export-define-backend'.</code></pre>
<p><strong>Export Options (Global):</strong></p>
<pre class="elisp"><code>;; From ox.el (lines 111-190)
(defconst org-export-options-alist
  '((:title "TITLE" nil nil parse)
    (:date "DATE" nil nil parse)
    (:author "AUTHOR" nil user-full-name parse)
    (:email "EMAIL" nil user-mail-address t)
    (:language "LANGUAGE" nil org-export-default-language t)
    (:select-tags "SELECT_TAGS" nil org-export-select-tags split)
    (:exclude-tags "EXCLUDE_TAGS" nil org-export-exclude-tags split)
    (:creator "CREATOR" nil org-export-creator-string)
    (:headline-levels nil "H" org-export-headline-levels)
    (:preserve-breaks nil "\\n" org-export-preserve-breaks)
    (:section-numbers nil "num" org-export-with-section-numbers)
    (:time-stamp-file nil "timestamp" org-export-timestamp-file)
    (:with-archived-trees nil "arch" org-export-with-archived-trees)
    (:with-author nil "author" org-export-with-author)
    (:with-broken-links nil "broken-links" org-export-with-broken-links)
    (:with-clocks nil "c" org-export-with-clocks)
    (:with-creator nil "creator" org-export-with-creator)
    (:with-date nil "date" org-export-with-date)
    (:with-drawers nil "d" org-export-with-drawers)
    (:with-email nil "email" org-export-with-email)
    (:with-emphasize nil "*" org-export-with-emphasize)
    (:with-entities nil "e" org-export-with-entities)
    (:with-footnotes nil "f" org-export-with-footnotes)
    (:with-latex nil "tex" org-export-with-latex)
    (:with-planning nil "p" org-export-with-planning)
    (:with-priority nil "pri" org-export-with-priority)
    (:with-properties nil "prop" org-export-with-properties)
    (:with-smart-quotes nil "'" org-export-with-smart-quotes)
    (:with-sub-superscript nil "^" org-export-with-sub-superscripts)
    (:with-toc nil "toc" org-export-with-toc)
    (:with-tables nil "|" org-export-with-tables)
    (:with-tags nil "tags" org-export-with-tags)
    (:with-tasks nil "tasks" org-export-with-tasks)
    (:with-timestamps nil "&lt;" org-export-with-timestamps)
    (:with-todo-keywords nil "todo" org-export-with-todo-keywords)
    ;; Citations processing
    (:with-cite-processors nil nil org-export-process-citations))
  "Alist between export properties and ways to set them.")</code></pre>
<h3 data-number="13.4.2" id="backend-architecture"><span class="header-section-number">13.4.2</span> 2. Backend Architecture</h3>
<p>Backends are defined using <code>org-export-define-backend</code>
macro.</p>
<p><strong>Example: HTML Backend (ox-html.el, 4,089 lines)</strong></p>
<pre class="elisp"><code>;; From ox-html.el (lines 58-119)
;;; Define Backend

(org-export-define-backend 'html
  '((bold . org-html-bold)
    (center-block . org-html-center-block)
    (clock . org-html-clock)
    (code . org-html-code)
    (drawer . org-html-drawer)
    (dynamic-block . org-html-dynamic-block)
    (entity . org-html-entity)
    (example-block . org-html-example-block)
    (export-block . org-html-export-block)
    (export-snippet . org-html-export-snippet)
    (fixed-width . org-html-fixed-width)
    (footnote-reference . org-html-footnote-reference)
    (headline . org-html-headline)
    (horizontal-rule . org-html-horizontal-rule)
    (inline-src-block . org-html-inline-src-block)
    (inlinetask . org-html-inlinetask)
    (inner-template . org-html-inner-template)
    (italic . org-html-italic)
    (item . org-html-item)
    (keyword . org-html-keyword)
    (latex-environment . org-html-latex-environment)
    (latex-fragment . org-html-latex-fragment)
    (line-break . org-html-line-break)
    (link . org-html-link)
    (node-property . org-html-node-property)
    (paragraph . org-html-paragraph)
    (plain-list . org-html-plain-list)
    (plain-text . org-html-plain-text)
    (planning . org-html-planning)
    (property-drawer . org-html-property-drawer)
    (quote-block . org-html-quote-block)
    (radio-target . org-html-radio-target)
    (section . org-html-section)
    (special-block . org-html-special-block)
    (src-block . org-html-src-block)
    (statistics-cookie . org-html-statistics-cookie)
    (strike-through . org-html-strike-through)
    (subscript . org-html-subscript)
    (superscript . org-html-superscript)
    (table . org-html-table)
    (table-cell . org-html-table-cell)
    (table-row . org-html-table-row)
    (target . org-html-target)
    (template . org-html-template)
    (timestamp . org-html-timestamp)
    (underline . org-html-underline)
    (verbatim . org-html-verbatim)
    (verse-block . org-html-verse-block))
  :filters-alist '((:filter-options . org-html-infojs-install-script)
                   (:filter-parse-tree . org-html-image-link-filter)
                   (:filter-final-output . org-html-final-function))
  :menu-entry
  '(?h "Export to HTML"
       ((?H "As HTML buffer" org-html-export-as-html)
        (?h "As HTML file" org-html-export-to-html)
        (?o "As HTML file and open"
            (lambda (a s v b)
              (if a (org-html-export-to-html t s v b)
                (org-open-file (org-html-export-to-html nil s v b)))))))
  :options-alist
  '((:html-doctype "HTML_DOCTYPE" nil org-html-doctype)
    (:html-container "HTML_CONTAINER" nil org-html-container-element)
    ;; ... many more options
    ))</code></pre>
<p><strong>Backend Components:</strong></p>
<ol type="1">
<li><strong>Transcoders</strong> - Functions that convert each element
type to target format</li>
<li><strong>Filters</strong> - Hooks to modify output at various
stages</li>
<li><strong>Options</strong> - Backend-specific export settings</li>
<li><strong>Menu entry</strong> - Interactive export commands</li>
</ol>
<h3 data-number="13.4.3" id="available-export-backends-12-total"><span class="header-section-number">13.4.3</span> 3. Available Export Backends
(12 total)</h3>
<pre><code>ox-ascii.el      (2,235 lines) - Plain text export
ox-beamer.el     (1,092 lines) - Beamer presentations (LaTeX)
ox-html.el       (4,089 lines) - HTML export
ox-icalendar.el    (937 lines) - iCalendar format
ox-koma-letter.el  (867 lines) - KOMA-Script letters
ox-latex.el      (4,512 lines) - LaTeX export
ox-man.el          (728 lines) - Unix man pages
ox-md.el           (650 lines) - Markdown export
ox-odt.el        (4,376 lines) - OpenDocument Text
ox-org.el          (369 lines) - Org to Org (normalization)
ox-publish.el    (1,368 lines) - Website publishing
ox-texinfo.el    (2,070 lines) - Texinfo documentation</code></pre>
<h3 data-number="13.4.4" id="export-process-flow"><span class="header-section-number">13.4.4</span> 4. Export Process Flow</h3>
<pre><code>1. Parse buffer with org-element-parse-buffer
   ‚îî‚îÄ&gt; Produces AST (Abstract Syntax Tree)

2. Initialize communication channel (plist with options)
   ‚îî‚îÄ&gt; Merge file options, buffer options, defaults

3. Run :filter-parse-tree filters
   ‚îî‚îÄ&gt; Modify AST before transcoding

4. Walk AST and call transcoders
   ‚îî‚îÄ&gt; Each element/object converted via backend function
   ‚îî‚îÄ&gt; Results concatenated into output string

5. Run :filter-final-output filters
   ‚îî‚îÄ&gt; Final modifications to complete output

6. Write to buffer or file
   ‚îî‚îÄ&gt; org-export-to-buffer or org-export-to-file</code></pre>
<h2 data-number="13.5" id="key-features"><span class="header-section-number">13.5</span> Key Features</h2>
<h3 data-number="13.5.1" id="agenda-system-org-agenda.el-11211-lines"><span class="header-section-number">13.5.1</span> 1. Agenda System
(org-agenda.el, 11,211 lines)</h3>
<p>The agenda provides a dynamic view of tasks across multiple Org
files.</p>
<pre class="elisp"><code>;; From org-agenda.el (lines 1-45)
;;; org-agenda.el --- Dynamic task and appointment lists for Org

;;; Commentary:

;; This file contains the code for creating and using the Agenda for Org.
;;
;; The functions `org-batch-agenda', `org-batch-agenda-csv', and
;; `org-batch-store-agenda-views' are implemented as macros to provide
;; a convenient way for extracting agenda information from the command
;; line.

(defvar org-agenda-buffer-name "*Org Agenda*")

(defcustom org-agenda-confirm-kill 1
  "When set, remote killing from the agenda buffer needs confirmation.
When t, a confirmation is always needed.  When a number N, confirmation is
only needed when the text to be killed contains more than N non-white lines."
  :group 'org-agenda
  :type '(choice
          (const :tag "Never" nil)
          (const :tag "Always" t)
          (integer :tag "When more than N lines")))</code></pre>
<p><strong>Agenda Views:</strong></p>
<ol type="1">
<li><strong>Daily/Weekly Agenda</strong> - Scheduled items and
deadlines</li>
<li><strong>TODO Lists</strong> - Tasks by state</li>
<li><strong>Tags/Properties Search</strong> - Query-based views</li>
<li><strong>Stuck Projects</strong> - Projects without next actions</li>
<li><strong>Custom Views</strong> - User-defined combinations</li>
</ol>
<p><strong>Agenda Features:</strong> - Multi-file aggregation - Custom
commands and filters - Bulk operations on entries - Time grid display -
Habit tracking integration - Export to various formats</p>
<h3 data-number="13.5.2" id="table-system-org-table.el-6438-lines"><span class="header-section-number">13.5.2</span> 2. Table System
(org-table.el, 6,438 lines)</h3>
<p>Org tables are a full spreadsheet system embedded in Org mode.</p>
<pre class="elisp"><code>;; From org-table.el (lines 1-34)
;;; org-table.el --- The Table Editor for Org        -*- lexical-binding: t; -*-

;;; Commentary:

;; This file contains the table editor and spreadsheet for Org mode.

;; Watch out:  Here we are talking about two different kind of tables.
;; Most of the code is for the tables created with the Org mode table editor.
;; Sometimes, we talk about tables created and edited with the table.el
;; Emacs package.  We call the former org-type tables, and the latter
;; table.el-type tables.

(defcustom org-table-default-size "5x2"
  "The default size for newly created tables, Columns x Rows."
  :group 'org-table-settings
  :type 'string)

(defcustom org-table-number-regexp
  "^\\([&lt;&gt;]?[-+^.0-9]*[0-9][-+^.0-9eEdDx()%:]*\\|...)$"
  "Regular expression for recognizing numbers in table columns.
If a table column contains mostly numbers, it will be aligned to the
right.  If not, it will be aligned to the left."
  :group 'org-table-settings
  :type 'regexp)</code></pre>
<p><strong>Table Features:</strong></p>
<ol type="1">
<li><strong>Automatic formatting</strong> - Columns auto-align on
TAB</li>
<li><strong>Spreadsheet formulas</strong> - Calc integration for cell
calculations</li>
<li><strong>Column formulas</strong> - Apply to entire columns</li>
<li><strong>Field references</strong> - <code>@row$col</code>
notation</li>
<li><strong>Named fields</strong> - Use <code>$name</code>
references</li>
<li><strong>Table ranges</strong> - <code>@2$3..@5$7</code> range
notation</li>
<li><strong>Remote references</strong> - Reference other tables</li>
<li><strong>Plotting</strong> - Integration with gnuplot</li>
<li><strong>Radio tables</strong> - Embed in other modes</li>
</ol>
<p><strong>Table Example:</strong></p>
<div class="sourceCode" id="cb407"><pre class="sourceCode org"><code class="sourceCode orgmode"><span id="cb407-1"><a aria-hidden="true" href="#cb407-1" tabindex="-1"></a>| Name    | Hours | Rate | Total |</span>
<span id="cb407-2"><a aria-hidden="true" href="#cb407-2" tabindex="-1"></a>|---------+-------+------+-------|</span>
<span id="cb407-3"><a aria-hidden="true" href="#cb407-3" tabindex="-1"></a>| Alice   |    40 |   50 |  2000 |</span>
<span id="cb407-4"><a aria-hidden="true" href="#cb407-4" tabindex="-1"></a>| Bob     |    35 |   60 |  2100 |</span>
<span id="cb407-5"><a aria-hidden="true" href="#cb407-5" tabindex="-1"></a>|---------+-------+------+-------|</span>
<span id="cb407-6"><a aria-hidden="true" href="#cb407-6" tabindex="-1"></a>| Totals  |    75 |      |  4100 |</span>
<span id="cb407-7"><a aria-hidden="true" href="#cb407-7" tabindex="-1"></a><span class="pp">#+TBLFM: $4=$2*$3::@5$2=vsum(@2..@3)::@5$4=vsum(@2..@3)</span></span></code></pre></div>
<h3 data-number="13.5.3" id="link-system-ol.el-2311-lines"><span class="header-section-number">13.5.3</span> 3. Link System (ol.el, 2,311
lines)</h3>
<p>Org‚Äôs extensible link system supports internal and external
links.</p>
<pre class="elisp"><code>;; From ol.el (lines 1-150)
;;; ol.el --- Org links library                      -*- lexical-binding: t; -*-

;;; Commentary:

;; This library provides tooling to handle both external and internal
;; links.

(defcustom org-link-parameters nil
  "Alist of properties that defines all the links in Org mode.

The key in each association is a string of the link type.
Subsequent optional elements make up a property list for that
type.

All properties are optional.  However, the most important ones
are, in this order, `:follow', `:export', and `:store'.

`:follow'
  Function used to follow the link, when the `org-open-at-point'
  command runs on it.

`:export'
  Function that accepts four arguments:
  - the path, as a string,
  - the description as a string, or nil,
  - the export backend,
  - the export communication channel, as a plist.

`:store'
  Function responsible for storing the link."
  :group 'org-link
  :type 'alist)</code></pre>
<p><strong>Link Types:</strong></p>
<ol type="1">
<li><strong>Internal links</strong> - <code>[[*Headline]]</code>,
<code>[[#custom-id]]</code></li>
<li><strong>File links</strong> -
<code>[[file:path/to/file.org]]</code></li>
<li><strong>URL links</strong> -
<code>[[https://example.com][Description]]</code></li>
<li><strong>Email links</strong> -
<code>[[mailto:user@example.com]]</code></li>
<li><strong>ID links</strong> - <code>[[id:UUID]]</code> (persistent
across file moves)</li>
<li><strong>Code references</strong> -
<code>[[elisp:(function)]]</code></li>
<li><strong>Custom link types</strong> - Extensible via
<code>org-link-parameters</code></li>
</ol>
<p><strong>Additional Link Modules:</strong> -
<code>ol-docview.el</code> - DocView integration -
<code>ol-gnus.el</code> - Gnus email links - <code>ol-man.el</code> -
Man page links - <code>ol-w3m.el</code> - w3m browser links</p>
<h3 data-number="13.5.4" id="capture-system-org-capture.el-2024-lines"><span class="header-section-number">13.5.4</span> 4. Capture System
(org-capture.el, 2,024 lines)</h3>
<p>Quick capture of notes and tasks from anywhere in Emacs.</p>
<p><strong>Capture Templates:</strong></p>
<pre class="elisp"><code>(setq org-capture-templates
  '(("t" "Todo" entry (file+headline "tasks.org" "Tasks")
     "* TODO %?\n  %i\n  %a")
    ("n" "Note" entry (file+datetree "notes.org")
     "* %?\nEntered on %U\n  %i\n  %a")
    ("m" "Meeting" entry (file+headline "meetings.org" "Meetings")
     "* MEETING with %? :meeting:\n  %U")))</code></pre>
<p><strong>Template Expansion:</strong> - <code>%?</code> - Cursor
position after expansion - <code>%i</code> - Initial content (from
selection) - <code>%a</code> - Link to current location -
<code>%U</code> - Inactive timestamp - <code>%t</code> - Active
timestamp - <code>%^{prompt}</code> - Interactive prompt</p>
<h3 data-number="13.5.5" id="todo-and-scheduling"><span class="header-section-number">13.5.5</span> 5. TODO and Scheduling</h3>
<p><strong>TODO States:</strong></p>
<pre class="elisp"><code>(setq org-todo-keywords
  '((sequence "TODO(t)" "STARTED(s)" "|" "DONE(d)")
    (sequence "WAITING(w)" "|" "CANCELLED(c)")))</code></pre>
<p><strong>Scheduling Keywords:</strong> - <code>SCHEDULED:</code> -
When you plan to work on item - <code>DEADLINE:</code> - When item must
be completed - <code>CLOSED:</code> - When item was marked DONE</p>
<p><strong>Timestamps:</strong> - <code>&lt;2025-01-15 Wed&gt;</code> -
Active timestamp (shows in agenda) - <code>[2025-01-15 Wed]</code> -
Inactive timestamp (doesn‚Äôt show) -
<code>&lt;2025-01-15 Wed 10:00-11:00&gt;</code> - With time range -
<code>&lt;2025-01-15 Wed +1w&gt;</code> - Repeating task</p>
<h3 data-number="13.5.6" id="tags-and-properties"><span class="header-section-number">13.5.6</span> 6. Tags and Properties</h3>
<p><strong>Tags:</strong></p>
<div class="sourceCode" id="cb411"><pre class="sourceCode org"><code class="sourceCode orgmode"><span id="cb411-1"><a aria-hidden="true" href="#cb411-1" tabindex="-1"></a><span class="fu">* Headline :tag1:tag2:tag3:</span></span>
<span id="cb411-2"><a aria-hidden="true" href="#cb411-2" tabindex="-1"></a><span class="fu">* Project Alpha :work:important:</span></span></code></pre></div>
<p><strong>Properties:</strong></p>
<div class="sourceCode" id="cb412"><pre class="sourceCode org"><code class="sourceCode orgmode"><span id="cb412-1"><a aria-hidden="true" href="#cb412-1" tabindex="-1"></a><span class="fu">* Task</span></span>
<span id="cb412-2"><a aria-hidden="true" href="#cb412-2" tabindex="-1"></a>  <span class="in">:PROPERTIES:</span></span>
<span id="cb412-3"><a aria-hidden="true" href="#cb412-3" tabindex="-1"></a><span class="in">  :CUSTOM_ID: unique-id</span></span>
<span id="cb412-4"><a aria-hidden="true" href="#cb412-4" tabindex="-1"></a><span class="in">  :CREATED:  [2025-01-15 Wed]</span></span>
<span id="cb412-5"><a aria-hidden="true" href="#cb412-5" tabindex="-1"></a><span class="in">  :EFFORT:   2:00</span></span>
<span id="cb412-6"><a aria-hidden="true" href="#cb412-6" tabindex="-1"></a><span class="in">  :END:</span></span></code></pre></div>
<h3 data-number="13.5.7" id="folding-system"><span class="header-section-number">13.5.7</span> 7. Folding System</h3>
<p>The folding system has been modernized with <code>org-fold.el</code>
and <code>org-fold-core.el</code>:</p>
<ul>
<li>Text-properties based (not overlays for performance)</li>
<li>Maintains fold state through edits</li>
<li>Integration with isearch</li>
<li>Preserves folds on save/load</li>
</ul>
<h2 data-number="13.6" id="integration-with-emacs-systems"><span class="header-section-number">13.6</span> Integration with Emacs
Systems</h2>
<h3 data-number="13.6.1" id="calendar-and-diary-integration"><span class="header-section-number">13.6.1</span> 1. Calendar and Diary
Integration</h3>
<ul>
<li>Org timestamps integrate with Emacs calendar</li>
<li>Can show Org agenda items in diary</li>
<li>Export to iCalendar format</li>
</ul>
<h3 data-number="13.6.2" id="narrowing-and-indirect-buffers"><span class="header-section-number">13.6.2</span> 2. Narrowing and Indirect
Buffers</h3>
<ul>
<li><code>org-narrow-to-subtree</code> - Focus on single subtree</li>
<li><code>org-tree-to-indirect-buffer</code> - Work on subtree in
separate buffer</li>
</ul>
<h3 data-number="13.6.3" id="refile-system"><span class="header-section-number">13.6.3</span> 3. Refile System</h3>
<ul>
<li>Move entries between files and headlines</li>
<li>Completion on all headlines across agenda files</li>
<li>Preserve or update metadata</li>
</ul>
<h3 data-number="13.6.4" id="archive-system"><span class="header-section-number">13.6.4</span> 4. Archive System</h3>
<ul>
<li>Archive completed tasks</li>
<li>Archive to separate file or subtree</li>
<li>Archive with date tree</li>
</ul>
<h3 data-number="13.6.5" id="clock-system-org-clock.el-3336-lines"><span class="header-section-number">13.6.5</span> 5. Clock System
(org-clock.el, 3,336 lines)</h3>
<ul>
<li>Clock in/out on tasks</li>
<li>Time tracking reports</li>
<li>Effort estimates</li>
<li>Clock tables (dynamic blocks)</li>
</ul>
<h2 data-number="13.7" id="module-dependencies"><span class="header-section-number">13.7</span> Module Dependencies</h2>
<pre><code>org.el (core)
‚îú‚îÄ‚îÄ org-macs.el (macros and utilities)
‚îú‚îÄ‚îÄ org-compat.el (compatibility)
‚îú‚îÄ‚îÄ org-element.el (parser)
‚îÇ   ‚îî‚îÄ‚îÄ org-element-ast.el (AST utilities)
‚îú‚îÄ‚îÄ org-fold.el (folding)
‚îÇ   ‚îî‚îÄ‚îÄ org-fold-core.el (folding primitives)
‚îú‚îÄ‚îÄ org-cycle.el (visibility cycling)
‚îú‚îÄ‚îÄ org-keys.el (key bindings)
‚îú‚îÄ‚îÄ ol.el (links)
‚îÇ   ‚îú‚îÄ‚îÄ ol-docview.el
‚îÇ   ‚îú‚îÄ‚îÄ ol-gnus.el
‚îÇ   ‚îú‚îÄ‚îÄ ol-man.el
‚îÇ   ‚îî‚îÄ‚îÄ ol-w3m.el
‚îú‚îÄ‚îÄ oc.el (citations)
‚îú‚îÄ‚îÄ org-table.el (tables and spreadsheet)
‚îú‚îÄ‚îÄ org-list.el (lists)
‚îú‚îÄ‚îÄ org-agenda.el (agenda views)
‚îÇ   ‚îî‚îÄ‚îÄ org-agenda-property.el
‚îú‚îÄ‚îÄ org-capture.el (quick capture)
‚îú‚îÄ‚îÄ org-refile.el (refiling)
‚îú‚îÄ‚îÄ org-archive.el (archiving)
‚îú‚îÄ‚îÄ org-clock.el (time tracking)
‚îú‚îÄ‚îÄ org-timer.el (timers)
‚îú‚îÄ‚îÄ org-id.el (unique IDs)
‚îú‚îÄ‚îÄ org-attach.el (attachments)
‚îú‚îÄ‚îÄ org-src.el (source code editing)
‚îú‚îÄ‚îÄ org-colview.el (column view)
‚îú‚îÄ‚îÄ org-duration.el (duration parsing)
‚îú‚îÄ‚îÄ org-macro.el (macro expansion)
‚îú‚îÄ‚îÄ org-indent.el (indentation)
‚îú‚îÄ‚îÄ org-plot.el (plotting)
‚îú‚îÄ‚îÄ org-num.el (heading numbers)
‚îú‚îÄ‚îÄ org-tempo.el (template expansion)
‚îú‚îÄ‚îÄ Babel subsystem
‚îÇ   ‚îú‚îÄ‚îÄ ob-core.el (Babel core)
‚îÇ   ‚îú‚îÄ‚îÄ ob-eval.el (evaluation)
‚îÇ   ‚îú‚îÄ‚îÄ ob-exp.el (export)
‚îÇ   ‚îú‚îÄ‚îÄ ob-tangle.el (tangling)
‚îÇ   ‚îú‚îÄ‚îÄ ob-lob.el (library of babel)
‚îÇ   ‚îú‚îÄ‚îÄ ob-ref.el (references)
‚îÇ   ‚îú‚îÄ‚îÄ ob-comint.el (comint sessions)
‚îÇ   ‚îú‚îÄ‚îÄ ob-table.el (table results)
‚îÇ   ‚îî‚îÄ‚îÄ ob-*.el (48 language files)
‚îî‚îÄ‚îÄ Export subsystem
    ‚îú‚îÄ‚îÄ ox.el (export core)
    ‚îî‚îÄ‚îÄ ox-*.el (12 export backends)</code></pre>
<h2 data-number="13.8" id="performance-considerations-2"><span class="header-section-number">13.8</span> Performance
Considerations</h2>
<h3 data-number="13.8.1" id="element-cache"><span class="header-section-number">13.8.1</span> 1. Element Cache</h3>
<p>The element parser maintains a sophisticated cache to avoid
re-parsing unchanged portions of large buffers. The cache uses:</p>
<ul>
<li>AVL trees for efficient lookups</li>
<li>Invalidation on buffer changes</li>
<li>Persistence across sessions</li>
</ul>
<h3 data-number="13.8.2" id="lazy-loading-1"><span class="header-section-number">13.8.2</span> 2. Lazy Loading</h3>
<p>Many Org subsystems are autoloaded: - Export backends loaded on
demand - Babel languages loaded when first used - Agenda only loads when
invoked</p>
<h3 data-number="13.8.3" id="deferred-parsing"><span class="header-section-number">13.8.3</span> 3. Deferred Parsing</h3>
<p>The parser can defer parsing of certain elements until needed,
improving initial buffer load time.</p>
<h2 data-number="13.9" id="configuration-points"><span class="header-section-number">13.9</span> Configuration Points</h2>
<h3 data-number="13.9.1" id="startup-options"><span class="header-section-number">13.9.1</span> 1. Startup Options</h3>
<pre class="elisp"><code>(setq org-startup-folded t)              ; Start with all folded
(setq org-startup-indented t)            ; Indented view
(setq org-startup-with-inline-images t)  ; Show images
(setq org-hide-emphasis-markers t)       ; Hide */= markers</code></pre>
<h3 data-number="13.9.2" id="babel-configuration"><span class="header-section-number">13.9.2</span> 2. Babel Configuration</h3>
<pre class="elisp"><code>(org-babel-do-load-languages
 'org-babel-load-languages
 '((python . t)
   (emacs-lisp . t)
   (shell . t)
   (R . t)))

(setq org-confirm-babel-evaluate nil)  ; Disable confirmation</code></pre>
<h3 data-number="13.9.3" id="export-configuration"><span class="header-section-number">13.9.3</span> 3. Export Configuration</h3>
<pre class="elisp"><code>(setq org-export-with-toc t)            ; Include table of contents
(setq org-export-with-section-numbers t) ; Number sections
(setq org-html-head-include-default-style nil) ; Custom styles</code></pre>
<h3 data-number="13.9.4" id="agenda-configuration"><span class="header-section-number">13.9.4</span> 4. Agenda Configuration</h3>
<pre class="elisp"><code>(setq org-agenda-files '("~/org/"))     ; Where to look for files
(setq org-agenda-span 7)                 ; Show week view
(setq org-agenda-start-on-weekday 1)     ; Start on Monday</code></pre>
<h2 data-number="13.10" id="key-innovations"><span class="header-section-number">13.10</span> Key Innovations</h2>
<h3 data-number="13.10.1" id="plain-text-format"><span class="header-section-number">13.10.1</span> 1. Plain Text Format</h3>
<p>Org uses a simple, readable plain text format that‚Äôs human-editable
without Emacs, making it future-proof and tool-independent.</p>
<h3 data-number="13.10.2" id="parse-tree-architecture"><span class="header-section-number">13.10.2</span> 2. Parse Tree
Architecture</h3>
<p>The <code>org-element.el</code> parser provides a clean separation
between syntax and semantics, enabling: - Robust export to multiple
formats - Consistent behavior across features - Easy addition of new
export backends</p>
<h3 data-number="13.10.3" id="extensible-link-system"><span class="header-section-number">13.10.3</span> 3. Extensible Link
System</h3>
<p>The link system is fully extensible, allowing new link types to be
added with custom following and export behavior.</p>
<h3 data-number="13.10.4" id="babels-language-agnostic-design"><span class="header-section-number">13.10.4</span> 4. Babel‚Äôs
Language-Agnostic Design</h3>
<p>Babel‚Äôs architecture allows easy addition of new languages through a
simple interface contract, without modifying core code.</p>
<h3 data-number="13.10.5" id="backend-transcoder-pattern"><span class="header-section-number">13.10.5</span> 5. Backend Transcoder
Pattern</h3>
<p>The export system‚Äôs transcoder pattern cleanly separates the export
process from backend-specific rendering.</p>
<h2 data-number="13.11" id="documentation-and-resources"><span class="header-section-number">13.11</span> Documentation and
Resources</h2>
<ul>
<li><strong>Org Manual:</strong> Comprehensive documentation built with
Texinfo</li>
<li><strong>Worg:</strong> Community wiki at <a class="uri" href="https://orgmode.org/worg/">https://orgmode.org/worg/</a></li>
<li><strong>Syntax specification:</strong> <a class="uri" href="https://orgmode.org/worg/dev/org-syntax.html">https://orgmode.org/worg/dev/org-syntax.html</a></li>
<li><strong>Export reference:</strong> <a class="uri" href="https://orgmode.org/worg/dev/org-export-reference.html">https://orgmode.org/worg/dev/org-export-reference.html</a></li>
</ul>
<h2 data-number="13.12" id="historical-context-1"><span class="header-section-number">13.12</span> Historical Context</h2>
<p>Org mode was created by Carsten Dominik in 2003 as a personal
organization system. It has grown into one of Emacs‚Äôs most powerful and
widely-used subsystems, influencing the development of similar tools in
other editors.</p>
<p>The codebase demonstrates excellent software engineering: - Clean
module boundaries - Consistent naming conventions - Comprehensive
documentation strings - Extensive customization options - Backward
compatibility maintenance</p>
<h2 data-number="13.13" id="conclusion-3"><span class="header-section-number">13.13</span> Conclusion</h2>
<p>Org mode exemplifies literate programming as both a tool and a
philosophy. Its architecture demonstrates how to build a large, complex
system through:</p>
<ol type="1">
<li><strong>Layered abstraction</strong> - Parser, core, features,
UI</li>
<li><strong>Pluggable components</strong> - Babel languages, export
backends</li>
<li><strong>Extensibility</strong> - Hooks, customization, link
types</li>
<li><strong>Integration</strong> - Works with Emacs calendar, diary, and
other systems</li>
<li><strong>Performance</strong> - Caching, lazy loading, deferred
parsing</li>
</ol>
<p>The system handles 146,533 lines of code across 127 files while
remaining maintainable, extensible, and performant. It serves as an
excellent example of how to architect a major subsystem within
Emacs.</p>
<h1 data-number="14" id="gnus-emacs-newsreader-and-mail-client"><span class="header-section-number">14</span> Gnus: Emacs Newsreader and Mail
Client</h1>
<p><strong>Files</strong>: 106 files, 120,363 lines
<strong>Location</strong>: <code>/lisp/gnus/</code> <strong>Primary
Authors</strong>: Lars Magne Ingebrigtsen, Masanobu UMEDA
<strong>Version</strong>: 5.13</p>
<h2 data-number="14.1" id="overview-5"><span class="header-section-number">14.1</span> Overview</h2>
<p>Gnus is a sophisticated newsreader and mail client for Emacs,
designed with a highly modular, pluggable backend architecture.
Originally created as a newsreader, it has evolved into a comprehensive
message handling system that can read news (NNTP), email (IMAP, POP3,
local mail spools), RSS feeds, and more through a unified interface.</p>
<p>The name ‚ÄúGnus‚Äù is pronounced ‚Äúnews‚Äù and stands for ‚ÄúGnus Network
User Services‚Äù (recursive acronym). The system exemplifies literate
programming through its clear separation of concerns: user interface
buffers (group, summary, article), backend abstraction layer, and
pluggable storage backends.</p>
<h3 data-number="14.1.1" id="architectural-philosophy"><span class="header-section-number">14.1.1</span> Architectural
Philosophy</h3>
<pre><code>‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                      User Interface Layer                    ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îÇ
‚îÇ  ‚îÇ Group Buffer ‚îÇ‚Üí ‚îÇSummary Buffer‚îÇ‚Üí ‚îÇArticle Buffer‚îÇ       ‚îÇ
‚îÇ  ‚îÇ (gnus-group) ‚îÇ  ‚îÇ (gnus-sum)   ‚îÇ  ‚îÇ (gnus-art)   ‚îÇ       ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                            ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                   Core Abstraction Layer                     ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îÇ
‚îÇ  ‚îÇ  gnus-int    ‚îÇ  ‚îÇ    nnoo      ‚îÇ  ‚îÇ  gnus-start  ‚îÇ       ‚îÇ
‚îÇ  ‚îÇ  (Backend    ‚îÇ  ‚îÇ  (Backend    ‚îÇ  ‚îÇ  (Startup &amp;  ‚îÇ       ‚îÇ
‚îÇ  ‚îÇ  Interface)  ‚îÇ  ‚îÇ  OO System)  ‚îÇ  ‚îÇ   Newsrc)    ‚îÇ       ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                            ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    Backend Implementations                   ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ  nntp  ‚îÇ ‚îÇ nnimap ‚îÇ ‚îÇ  nnml  ‚îÇ ‚îÇnnmaildir‚îÇ ‚îÇ  nnrss  ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ (NNTP) ‚îÇ ‚îÇ (IMAP) ‚îÇ ‚îÇ (Mail) ‚îÇ ‚îÇ(Maildir)‚îÇ ‚îÇ  (RSS)  ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ  ... and 20+ other backends ...                             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                            ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    Feature Modules                           ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îÇ
‚îÇ  ‚îÇ  Agent   ‚îÇ ‚îÇ  Score   ‚îÇ ‚îÇ  Search  ‚îÇ ‚îÇ Registry ‚îÇ      ‚îÇ
‚îÇ  ‚îÇ(Offline) ‚îÇ ‚îÇ (Filter) ‚îÇ ‚îÇ (Index)  ‚îÇ ‚îÇ(Tracking)‚îÇ      ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò</code></pre>
<h2 data-number="14.2" id="core-architecture-1"><span class="header-section-number">14.2</span> Core Architecture</h2>
<h3 data-number="14.2.1" id="entry-point-gnus.el-4204-lines"><span class="header-section-number">14.2.1</span> 1. Entry Point: gnus.el
(4,204 lines)</h3>
<p><strong>Purpose</strong>: Main entry point, customization groups, and
global configuration.</p>
<p><strong>File</strong>: <code>/lisp/gnus/gnus.el</code></p>
<p>The core entry point defines: - <strong>Customization
Groups</strong>: Hierarchical organization of all Gnus options -
<strong>Global Variables</strong>: Version info, home directory, select
methods - <strong>Group Levels</strong>: Subscription levels
(subscribed, unsubscribed, zombie, killed)</p>
<pre class="elisp"><code>;; From gnus.el:
(defgroup gnus nil
  "The coffee-brewing, all singing, all dancing, kitchen sink newsreader."
  :group 'news
  :group 'mail)

;; Five subscription levels control group visibility
(defconst gnus-level-subscribed 5
  "Groups with levels less than or equal to this are subscribed.")
(defconst gnus-level-unsubscribed 7)
(defconst gnus-level-zombie 8)
(defconst gnus-level-killed 9)</code></pre>
<p><strong>Design Pattern</strong>: Gnus uses extensive customization
groups to organize its hundreds of options. Each major component (group,
summary, article, score, etc.) has dedicated customization
hierarchies.</p>
<h3 data-number="14.2.2" id="group-buffer-gnus-group.el-4869-lines"><span class="header-section-number">14.2.2</span> 2. Group Buffer:
gnus-group.el (4,869 lines)</h3>
<p><strong>Purpose</strong>: The <em>Group</em> buffer displays
available newsgroups and mailboxes.</p>
<p><strong>File</strong>: <code>/lisp/gnus/gnus-group.el</code></p>
<p>The Group buffer is Gnus‚Äôs ‚Äúhome screen‚Äù where users: - Browse
subscribed and unsubscribed groups - See unread message counts - Manage
subscriptions and group parameters - Access server configuration</p>
<p><strong>Key Data Structures</strong>:</p>
<pre class="elisp"><code>;; Groups are stored in gnus-newsrc-hashtb and gnus-newsrc-alist
;; Each group entry contains:
;; - Group name (e.g., "nnimap+gmail:INBOX")
;; - Subscription level (1-9)
;; - Read articles (as ranges: "1-100,150,200-300")
;; - Group parameters (custom settings per group)

;; Group line format is customizable via specs:
(defcustom gnus-group-line-format "%M%S%p%P%5y:%B%(%g%)\n"
  "Format of group lines.
%M    Only marked articles
%S    Whether subscribed (U/K/Z or space)
%y    Number of unread, unticked articles
%g    Qualified group name")</code></pre>
<p><strong>Threading Model</strong>: The group buffer maintains: 1.
<code>gnus-newsrc-alist</code> - Complete list of groups with their
state 2. <code>gnus-newsrc-hashtb</code> - Hash table for O(1) group
lookup 3. Display list (potentially filtered/sorted) shown to user</p>
<h3 data-number="14.2.3" id="summary-buffer-gnus-sum.el-13241-lines---largest-file"><span class="header-section-number">14.2.3</span> 3. Summary Buffer:
gnus-sum.el (13,241 lines - largest file)</h3>
<p><strong>Purpose</strong>: Displays article lists with threading,
scoring, and marking.</p>
<p><strong>File</strong>: <code>/lisp/gnus/gnus-sum.el</code></p>
<p>The Summary buffer is where Gnus‚Äôs sophistication shines. It displays
articles with: - <strong>Threading</strong>: Builds conversation trees
from References/In-Reply-To headers - <strong>Scoring</strong>:
Automatic and manual article prioritization - <strong>Marks</strong>:
Read, ticked, dormant, expirable, etc. - <strong>Limiting</strong>:
Filter articles by various criteria - <strong>Sorting</strong>: Multiple
sort orders (date, score, author, etc.)</p>
<p><strong>Threading Algorithm</strong>:</p>
<pre class="elisp"><code>;; Threading builds a tree structure from article headers
;; Each article can have:
;; - Parent (article it replies to)
;; - Children (articles replying to it)
;; - Siblings (at same thread level)

;; Key variables for threading:
(defcustom gnus-summary-make-false-root 'adopt
  "How to handle threads with missing root articles.
- adopt: Make one child the parent
- dummy: Create a dummy root
- empty: Show with empty subject
- none: Don't gather loose threads")

(defcustom gnus-fetch-old-headers nil
  "Fetch old headers to build complete threads.
- nil: Don't fetch
- t: Fetch all old headers
- some: Fetch only connecting headers
- NUMBER: Fetch at most NUMBER old headers")</code></pre>
<p><strong>Thread Building Process</strong>: 1. Fetch article headers
from backend 2. Extract Message-ID, References, In-Reply-To 3. Build
hash table of all articles 4. Link articles to parents via References
chain 5. Handle missing roots (adopt/dummy/empty) 6. Sort threads and
sub-threads 7. Apply scoring and marks 8. Generate display lines</p>
<p><strong>Summary Line Format</strong>:</p>
<pre class="elisp"><code>;; Summary lines use format specs similar to printf:
;; Example: "%U%R%z%I%(%[%4L: %-23,23f%]%) %s\n"
;;
;; Common specs:
;; %U = User-defined marks (!, ?, etc.)
;; %R = Whether read (R or space)
;; %z = Zcore (article score)
;; %I = Indentation (for threading)
;; %L = Lines in article
;; %f = From header
;; %s = Subject</code></pre>
<p><strong>Performance Optimizations</strong>: - Summary lines are
pre-formatted and cached - Threading uses hash tables for O(1) lookups -
Partial group entry (fetch headers in chunks) - Prefetching of article
bodies</p>
<h3 data-number="14.2.4" id="article-buffer-gnus-art.el-9061-lines"><span class="header-section-number">14.2.4</span> 4. Article Buffer:
gnus-art.el (9,061 lines)</h3>
<p><strong>Purpose</strong>: Display and manipulate article content.</p>
<p><strong>File</strong>: <code>/lisp/gnus/gnus-art.el</code></p>
<p>The Article buffer handles: - <strong>Header Display</strong>:
Selective header showing/hiding - <strong>MIME Handling</strong>:
Multipart messages, attachments - <strong>Washing</strong>: Remove
quoted text, signatures, HTML rendering - <strong>Highlighting</strong>:
Citations, headers, signatures - <strong>Buttons</strong>: Clickable
URLs, email addresses, message IDs - <strong>Treatments</strong>:
Charset decoding, overstrike, ROT13, etc.</p>
<p><strong>MIME Processing Pipeline</strong>:</p>
<pre class="elisp"><code>;; Article display pipeline:
;; 1. Fetch raw article from backend
;; 2. Parse MIME structure (mm-decode.el)
;; 3. Apply article treatments
;; 4. Render each MIME part
;; 5. Add buttons and highlighting
;; 6. Display in article buffer

;; Header visibility control:
(defcustom gnus-visible-headers
  "^From:\\|^Newsgroups:\\|^Subject:\\|^Date:\\|^To:\\|..."
  "Headers matching this regexp are shown.
If non-nil, gnus-ignored-headers is ignored.")

(defcustom gnus-ignored-headers
  '("^Path:" "^Expires:" "^X-.*" ...)
  "Headers matching these regexps are hidden.")</code></pre>
<p><strong>Treatment System</strong>:</p>
<p>Gnus applies a series of ‚Äútreatments‚Äù to articles: -
<code>gnus-treat-highlight-headers</code> - Colorize headers -
<code>gnus-treat-highlight-citation</code> - Color quoted text -
<code>gnus-treat-strip-trailing-blank-lines</code> -
<code>gnus-treat-hide-citation</code> - Hide excessive quoting -
<code>gnus-treat-decode-encoded-words</code> - MIME word decoding -
<code>gnus-treat-display-smileys</code> - Show emoji -
<code>gnus-treat-overstrike</code> - Handle <em>underline</em></p>
<p>Each treatment can be: - <code>nil</code> (never) - <code>t</code>
(always) - <code>head</code> (only in headers) - <code>last</code> (only
in last part) - A predicate function</p>
<h3 data-number="14.2.5" id="message-composition-message.el-9065-lines"><span class="header-section-number">14.2.5</span> 5. Message Composition:
message.el (9,065 lines)</h3>
<p><strong>Purpose</strong>: Compose and send email/news messages.</p>
<p><strong>File</strong>: <code>/lisp/gnus/message.el</code></p>
<p><strong>Not Gnus-Specific</strong>: message.el is a standalone
package used by Gnus but also usable independently. It provides:</p>
<ul>
<li><strong>Mail Composition</strong>: Headers, body, attachments</li>
<li><strong>News Posting</strong>: Newsgroups, Followup-To, etc.</li>
<li><strong>MIME Support</strong>: via mml.el (MIME Meta Language)</li>
<li><strong>Sending</strong>: Multiple backends (SMTP, sendmail,
feedmail)</li>
<li><strong>Encryption</strong>: PGP/MIME, S/MIME support</li>
</ul>
<p><strong>Message Structure</strong>:</p>
<pre class="elisp"><code>;; A message buffer contains:
;; 1. Headers (To:, Subject:, etc.)
;; 2. Separator line ("--text follows this line--")
;; 3. Body (may contain MML tags for attachments)

;; MML (MIME Meta Language) example:
;; &lt;#multipart type=mixed&gt;
;; Here's the text body
;; &lt;#part type=image/png filename=screenshot.png disposition=attachment&gt;
;; &lt;#/multipart&gt;

;; When sent, MML tags are converted to proper MIME structure</code></pre>
<p><strong>Sending Pipeline</strong>: 1. User composes message with
optional MML tags 2. <code>message-send</code> validates headers 3. MML
tags converted to MIME (mml.el) 4. Encoding applied (charset,
transfer-encoding) 5. Send via configured method (SMTP, etc.) 6.
Optionally save copy (Fcc header) 7. Update Gnus state (marks, registry,
etc.)</p>
<h2 data-number="14.3" id="backend-system-the-nnoo-architecture"><span class="header-section-number">14.3</span> Backend System: The nnoo
Architecture</h2>
<h3 data-number="14.3.1" id="backend-abstraction-nnoo.el"><span class="header-section-number">14.3.1</span> Backend Abstraction:
nnoo.el</h3>
<p><strong>Purpose</strong>: Object-oriented backend system allowing
pluggable storage.</p>
<p><strong>File</strong>: <code>/lisp/gnus/nnoo.el</code></p>
<p>Gnus‚Äôs backend abstraction is one of its most elegant designs. The
<code>nnoo</code> (nn-object-oriented) system allows backends to: -
Inherit from parent backends - Override specific methods - Share
variable state - Provide consistent interface</p>
<p><strong>Core Macros</strong>:</p>
<pre class="elisp"><code>;; nnoo-declare: Declare a backend
(nnoo-declare nnml)        ; Declare nnml backend
(nnoo-declare nnimap)      ; Declare nnimap backend

;; defvoo: Define backend variable (like defvar)
(defvoo nnml-directory message-directory
  "Spool directory for the nnml mail backend.")

;; deffoo: Define backend function (like defun)
(deffoo nnml-retrieve-headers (articles &amp;optional group server fetch-old)
  "Retrieve headers for ARTICLES in GROUP.")

;; nnoo-import: Inherit functions from parent backend
(nnoo-import nnml
  (nnmail))  ; Import functions from nnmail</code></pre>
<p><strong>Backend Protocol</strong>:</p>
<p>Every backend must implement these core functions:</p>
<pre class="elisp"><code>;; Essential functions:
(nnXXX-retrieve-headers articles group)
  ;; Return article headers in NOV format

(nnXXX-request-article article group)
  ;; Return article content

(nnXXX-request-group group &amp;optional server)
  ;; Select a group, return article range

(nnXXX-close-group group)
  ;; Close the group

(nnXXX-request-list &amp;optional server)
  ;; Return list of all groups

(nnXXX-open-server server)
  ;; Open connection to server

(nnXXX-close-server)
  ;; Close server connection

;; Optional functions:
(nnXXX-request-post)          ; Post news article
(nnXXX-request-move-article)  ; Move between groups
(nnXXX-request-accept-article); Accept incoming article
(nnXXX-request-expire-articles) ; Expire old articles</code></pre>
<h3 data-number="14.3.2" id="backend-interface-gnus-int.el"><span class="header-section-number">14.3.2</span> Backend Interface:
gnus-int.el</h3>
<p><strong>Purpose</strong>: Mediates between Gnus core and
backends.</p>
<p><strong>File</strong>: <code>/lisp/gnus/gnus-int.el</code></p>
<p>The interface layer: 1. Dispatches requests to appropriate backend 2.
Handles server state (opened, denied, offline) 3. Manages backend
selection methods 4. Provides hooks for agent/registry integration</p>
<pre class="elisp"><code>;; Server status states:
;; - opened: Connection active
;; - closed: Not connected
;; - denied: Connection rejected
;; - offline: Agent mode (working unplugged)

(defun gnus-request-article (article group)
  "Request ARTICLE from GROUP."
  ;; 1. Find backend for this group
  ;; 2. Ensure server is open
  ;; 3. Call backend's request-article function
  ;; 4. Handle errors/retries
  )</code></pre>
<h3 data-number="14.3.3" id="major-backends"><span class="header-section-number">14.3.3</span> Major Backends</h3>
<h4 data-number="14.3.3.1" id="nntp-backend-nntp.el-2000-lines"><span class="header-section-number">14.3.3.1</span> NNTP Backend: nntp.el
(2,000+ lines)</h4>
<p><strong>Purpose</strong>: Read news via NNTP protocol (RFC 3977).</p>
<p><strong>File</strong>: <code>/lisp/gnus/nntp.el</code></p>
<pre class="elisp"><code>(defvoo nntp-address nil
  "Address of the physical nntp server.")

(defvoo nntp-port-number "nntp"
  "Port number (default 119).")

(defvoo nntp-open-connection-function 'nntp-open-network-stream
  "How to connect:
  - nntp-open-network-stream: TLS via STARTTLS
  - nntp-open-tls-stream: Direct TLS
  - nntp-open-plain-stream: Unencrypted
  - nntp-open-via-*: Via intermediate host")</code></pre>
<p><strong>Connection Management</strong>: - Maintains persistent
connections - Handles authentication (AUTHINFO) - Manages pipelining
(multiple commands in flight) - Detects server capabilities</p>
<p><strong>NOV (News Overview) Support</strong>: - Fetches headers
efficiently via XOVER - Parses NOV format (tab-separated) - Falls back
to HEAD for old servers</p>
<h4 data-number="14.3.3.2" id="imap-backend-nnimap.el-2700-lines"><span class="header-section-number">14.3.3.2</span> IMAP Backend: nnimap.el
(2,700+ lines)</h4>
<p><strong>Purpose</strong>: Read email via IMAP protocol (RFC
3501).</p>
<p><strong>File</strong>: <code>/lisp/gnus/nnimap.el</code></p>
<pre class="elisp"><code>(defvoo nnimap-address nil
  "The address of the IMAP server.")

(defvoo nnimap-stream 'undecided
  "Connection type: undecided, tls, network, starttls, ssl, shell")

(defvoo nnimap-inbox nil
  "Mailbox for incoming mail splitting.
  Can be string or list: \"INBOX\" or (\"INBOX\" \"SENT\")")

(defvoo nnimap-split-methods nil
  "Mail splitting rules (same as nnmail-split-methods).")</code></pre>
<p><strong>Key Features</strong>: - <strong>Streaming</strong>:
Pipelines IMAP commands for speed - <strong>UID EXPUNGE</strong>:
Selective deletion support - <strong>IDLE</strong>: Real-time
notification of new mail - <strong>Namespaces</strong>: Handles IMAP
folder hierarchies - <strong>Splitting</strong>: Server-side mail
filtering</p>
<p><strong>Authentication</strong>: - Login, Plain, CRAM-MD5 - OAuth2
support - Integration with auth-source</p>
<h4 data-number="14.3.3.3" id="mail-spool-backend-nnml.el-1700-lines"><span class="header-section-number">14.3.3.3</span> Mail Spool Backend:
nnml.el (1,700+ lines)</h4>
<p><strong>Purpose</strong>: Local mail storage (one file per
article).</p>
<p><strong>File</strong>: <code>/lisp/gnus/nnml.el</code></p>
<pre class="elisp"><code>(defvoo nnml-directory message-directory
  "Spool directory for nnml backend.")

(defvoo nnml-get-new-mail t
  "If non-nil, check incoming mail and split it.")

(defvoo nnml-nov-is-evil nil
  "If non-nil, don't use NOV databases.
  Using NOV is much faster but requires generation.")</code></pre>
<p><strong>Storage Structure</strong>:</p>
<pre><code>~/Mail/
  active              ; List of groups and article ranges
  newsgroups          ; Group descriptions
  mail/
    misc/
      1               ; Article 1
      2               ; Article 2
      .overview       ; NOV database
    work/
      1
      2
      .overview</code></pre>
<p><strong>NOV Database</strong>: - Pre-computed header cache -
Tab-separated format - Generated by
<code>nnml-generate-nov-databases</code> - Dramatically speeds up
summary generation</p>
<h4 data-number="14.3.3.4" id="other-notable-backends"><span class="header-section-number">14.3.3.4</span> Other Notable
Backends</h4>
<p><strong>nnmaildir.el</strong> - Maildir format (qmail, Courier) -
Atomic delivery (tmp/new/cur structure) - Safe for concurrent access -
No file locking needed</p>
<p><strong>nnrss.el</strong> - RSS/Atom feed reader - Fetches feeds as
‚Äúgroups‚Äù - Articles are feed items - Supports enclosures</p>
<p><strong>nnvirtual.el</strong> - Virtual groups - Combines multiple
groups - Useful for searching, merging</p>
<p><strong>nnselect.el</strong> - Search results as groups - Used by
gnus-search - Ephemeral groups</p>
<p><strong>nndoc.el</strong> - Files as groups - Digest messages - Mail
archives - Babyl, MMDF formats</p>
<p><strong>nnfolder.el</strong> - Unix mbox format - Single file per
group - Berkeley mail format</p>
<h2 data-number="14.4" id="startup-and-state-management-gnus-start.el-3199-lines"><span class="header-section-number">14.4</span> Startup and State Management:
gnus-start.el (3,199 lines)</h2>
<p><strong>Purpose</strong>: Initialize Gnus, read/write newsrc files,
manage group state.</p>
<p><strong>File</strong>: <code>/lisp/gnus/gnus-start.el</code></p>
<h3 data-number="14.4.1" id="startup-sequence"><span class="header-section-number">14.4.1</span> Startup Sequence</h3>
<pre class="elisp"><code>;; Entry point: M-x gnus
(defun gnus ()
  "Read network news."
  ;; 1. Load ~/.gnus.el (user config)
  ;; 2. Read ~/.newsrc.eld (group state)
  ;; 3. Contact servers
  ;; 4. Check for new groups
  ;; 5. Update active files
  ;; 6. Display group buffer
  )</code></pre>
<h3 data-number="14.4.2" id="the-newsrc-files"><span class="header-section-number">14.4.2</span> The Newsrc Files</h3>
<p><strong>~/.newsrc.eld</strong>: Emacs Lisp Data file (primary
state)</p>
<pre class="elisp"><code>;; Format:
(setq gnus-newsrc-alist
  '(("nnimap+gmail:INBOX" 3 ((1 . 1500)) nil)
    ("nnml:mail.misc" 1 ((1 . 250) 300) nil)))
;;     ^group-name    ^level ^read-articles ^params

(setq gnus-newsrc-hashtb
  #s(hash-table ...))  ; Hash table for fast lookup</code></pre>
<p><strong>~/.newsrc</strong>: Traditional newsreader format
(compatibility)</p>
<pre><code>nnimap+gmail:INBOX: 1-1500
nnml:mail.misc! 1-250,300</code></pre>
<h3 data-number="14.4.3" id="group-activation"><span class="header-section-number">14.4.3</span> Group Activation</h3>
<pre class="elisp"><code>(defcustom gnus-activate-level (1+ gnus-level-subscribed)
  "Groups higher than this level won't be activated on startup.
  Setting this low speeds startup for users with many groups.")

;; Activation process:
;; 1. Contact backend for group
;; 2. Request article range (e.g., "1-5000")
;; 3. Update read marks
;; 4. Store in newsrc structures</code></pre>
<h3 data-number="14.4.4" id="level-system"><span class="header-section-number">14.4.4</span> Level System</h3>
<p>Groups have levels 1-9: - <strong>1-5</strong>: Subscribed (shown by
default) - <strong>6-7</strong>: Unsubscribed (shown with ‚ÄòL‚Äô) -
<strong>8</strong>: Zombie (dead groups) - <strong>9</strong>: Killed
(completely hidden)</p>
<p>Levels allow: - Selective display (show only level 1-3) - Faster
startup (don‚Äôt activate high levels) - Organizational hierarchy</p>
<h2 data-number="14.5" id="feature-modules"><span class="header-section-number">14.5</span> Feature Modules</h2>
<h3 data-number="14.5.1" id="offline-mode-gnus-agent.el-4143-lines"><span class="header-section-number">14.5.1</span> Offline Mode: gnus-agent.el
(4,143 lines)</h3>
<p><strong>Purpose</strong>: Work with Gnus while disconnected from
servers.</p>
<p><strong>File</strong>: <code>/lisp/gnus/gnus-agent.el</code></p>
<p>The Agent allows: - <strong>Fetching</strong>: Download articles for
offline reading - <strong>Queueing</strong>: Compose messages while
offline, send later - <strong>Synchronization</strong>: Merge changes
when reconnecting - <strong>Predicates</strong>: Control what to
download</p>
<pre class="elisp"><code>(defcustom gnus-agent-directory (concat gnus-directory "agent/")
  "Where the agent stores downloaded articles.")

;; Agent states:
;; - Plugged: Online, accessing servers directly
;; - Unplugged: Offline, using local cache

;; Download predicates control what to fetch:
(defcustom gnus-agent-predicate 'false
  "Predicate to control fetching.
  - true: Fetch all
  - false: Fetch none
  - (or (short) (scored 1000)): Fetch short or high-scoring")</code></pre>
<p><strong>Agent Storage</strong>:</p>
<pre><code>~/News/agent/
  nnimap+gmail/
    INBOX/
      1.INC         ; Article 1
      2.INC         ; Article 2
      .agentview    ; Downloaded article list
  nntp+news/
    comp.emacs/
      100.INC
      101.INC</code></pre>
<p><strong>Synchronization</strong>: When plugging in: 1. Upload queued
mail/news 2. Optionally sync flags (read marks) 3. Optionally fetch new
articles 4. Update active ranges</p>
<h3 data-number="14.5.2" id="scoring-system-gnus-score.el-3188-lines"><span class="header-section-number">14.5.2</span> Scoring System:
gnus-score.el (3,188 lines)</h3>
<p><strong>Purpose</strong>: Automatically prioritize articles based on
rules.</p>
<p><strong>File</strong>: <code>/lisp/gnus/gnus-score.el</code></p>
<p>Scoring assigns numeric values to articles based on: - Subject
keywords - Author - Thread depth - Age - Cross-posts - Lines - Custom
predicates</p>
<pre class="elisp"><code>;; Score file format:
(("subject"
  ("emacs" 1000 nil s)      ; +1000 for "emacs" (substring)
  ("spam" -500 nil e))      ; -500 for "spam" (exact)
 ("from"
  ("alice@example.com" 100 nil s)))

;; Match types:
;; s = substring
;; e = exact
;; r = regexp
;; f = fuzzy</code></pre>
<p><strong>Adaptive Scoring</strong>:</p>
<p>Gnus can learn from your reading:</p>
<pre class="elisp"><code>(defcustom gnus-use-adaptive-scoring nil
  "If non-nil, learn scoring rules from reading behavior.

  Reading an article: increase score
  Marking as read: decrease score
  Following up: increase score significantly")

;; Adaptive rules are saved to GROUP.ADAPT files</code></pre>
<p><strong>Score Files</strong>: - <strong>Global</strong>: Apply to all
groups - <strong>Hierarchical</strong>: <code>all.SCORE</code>,
<code>comp.SCORE</code>, <code>comp.emacs.SCORE</code> -
<strong>Group-specific</strong>: <code>comp.emacs.SCORE</code> -
<strong>Adaptive</strong>: Auto-generated from behavior</p>
<p><strong>Decay</strong>: Scores can decay over time:</p>
<pre class="elisp"><code>(defcustom gnus-decay-scores nil
  "If non-nil, reduce scores over time.
  Prevents old rules from dominating.")</code></pre>
<h3 data-number="14.5.3" id="search-system-gnus-search.el-2363-lines"><span class="header-section-number">14.5.3</span> Search System:
gnus-search.el (2,363 lines)</h3>
<p><strong>Purpose</strong>: Unified search interface for multiple
backends.</p>
<p><strong>File</strong>: <code>/lisp/gnus/gnus-search.el</code></p>
<p>The search system provides: - <strong>Unified Query
Language</strong>: Same syntax across backends - <strong>Multiple
Engines</strong>: IMAP, Mairix, Notmuch, Namazu, Swish++ -
<strong>Results as Groups</strong>: Search results appear as nnselect
groups</p>
<pre class="elisp"><code>;; Search query syntax:
;; "from:alice subject:emacs since:1w"
;;
;; Parsed to:
;; (and (from "alice")
;;      (subject "emacs")
;;      (since "1w"))

;; Search engines:
;; - gnus-search-imap: Use IMAP SEARCH
;; - gnus-search-notmuch: Use notmuch
;; - gnus-search-mairix: Use mairix
;; - gnus-search-namazu: Use Namazu</code></pre>
<p><strong>Search Flow</strong>: 1. User enters query string 2. Parse
query to s-expression 3. Categorize groups by server 4. Find search
engine for each server 5. Transform query to engine-specific format 6.
Execute searches 7. Collect results 8. Create nnselect group displaying
results</p>
<h3 data-number="14.5.4" id="article-registry-gnus-registry.el-1304-lines"><span class="header-section-number">14.5.4</span> Article Registry:
gnus-registry.el (1,304 lines)</h3>
<p><strong>Purpose</strong>: Track articles across groups, backends, and
time.</p>
<p><strong>File</strong>: <code>/lisp/gnus/gnus-registry.el</code></p>
<p>The registry maintains a database of: - Article Message-IDs - Groups
where article appears - Custom marks - Thread relationships -
Keywords/tags</p>
<pre class="elisp"><code>;; Registry database structure:
;; Message-ID -&gt; {groups, marks, keywords, subjects, senders}

;; Use cases:
;; 1. Split by parent: Reply goes to same group as parent
;; 2. Track moved articles
;; 3. Find all copies of an article
;; 4. Persistent marks across backends
;; 5. Thread reconstruction

(defcustom gnus-registry-max-entries 2500
  "Maximum number of articles to track.")

(defcustom gnus-registry-track-extra '(sender subject recipient)
  "What extra data to track for each article.")</code></pre>
<p><strong>Registry Splitting</strong>:</p>
<pre class="elisp"><code>;; In fancy-split rules:
(: gnus-registry-split-fancy-with-parent)

;; This places replies in the same group as the parent,
;; even across backends!</code></pre>
<h3 data-number="14.5.5" id="topic-mode-gnus-topic.el-1798-lines"><span class="header-section-number">14.5.5</span> Topic Mode: gnus-topic.el
(1,798 lines)</h3>
<p><strong>Purpose</strong>: Organize groups hierarchically.</p>
<p><strong>File</strong>: <code>/lisp/gnus/gnus-topic.el</code></p>
<p>Topics provide: - <strong>Hierarchical Grouping</strong>: Organize
groups in trees - <strong>Folding</strong>: Hide/show topic branches -
<strong>Bulk Operations</strong>: Act on all groups in topic -
<strong>Visual Organization</strong>: Indented display</p>
<pre class="elisp"><code>;; Topic structure:
;; Gnus
;;   Mail
;;     Work
;;       nnimap+work:INBOX
;;       nnimap+work:Projects
;;     Personal
;;       nnml:mail.misc
;;   News
;;     Emacs
;;       gmane.emacs.gnus.general
;;       comp.emacs</code></pre>
<p><strong>Topic Topology</strong>:</p>
<pre class="elisp"><code>(defvar gnus-topic-topology
  '(("Gnus" visible)
    (("Mail" visible)
     (("Work" visible))
     (("Personal" visible)))
    (("News" visible)
     (("Emacs" visible)))))

(defvar gnus-topic-alist
  '(("Work" "nnimap+work:INBOX" "nnimap+work:Projects")
    ("Personal" "nnml:mail.misc")
    ("Emacs" "gmane.emacs.gnus.general" "comp.emacs")))</code></pre>
<h2 data-number="14.6" id="mime-handling"><span class="header-section-number">14.6</span> MIME Handling</h2>
<h3 data-number="14.6.1" id="mime-meta-language-mml.el-1800-lines"><span class="header-section-number">14.6.1</span> MIME Meta Language: mml.el
(1,800+ lines)</h3>
<p><strong>Purpose</strong>: User-friendly MIME message composition.</p>
<p><strong>File</strong>: <code>/lisp/gnus/mml.el</code></p>
<p>MML provides a simple tag syntax for creating MIME messages:</p>
<pre class="elisp"><code>;; MML tags in message buffer:
;; &lt;#part type=text/plain&gt;
;; This is plain text.
;; &lt;#/part&gt;
;; &lt;#part type=image/png filename=screenshot.png disposition=attachment&gt;
;; &lt;#/part&gt;

;; Converted to MIME on send:
;; Content-Type: multipart/mixed; boundary="=-=-="
;;
;; --=-=-=
;; Content-Type: text/plain
;;
;; This is plain text.
;; --=-=-=
;; Content-Type: image/png
;; Content-Disposition: attachment; filename=screenshot.png
;; Content-Transfer-Encoding: base64
;;
;; iVBORw0KGgoAAAANSUhEUgAA...
;; --=-=-=--</code></pre>
<p><strong>MML Functions</strong>: - <code>mml-attach-file</code>:
Attach a file - <code>mml-insert-part</code>: Insert MIME part -
<code>mml-to-mime</code>: Convert MML tags to MIME -
<code>mml-preview</code>: Preview message as MIME</p>
<h3 data-number="14.6.2" id="mime-decoding-mm-decode.el-2000-lines"><span class="header-section-number">14.6.2</span> MIME Decoding: mm-decode.el
(2,000+ lines)</h3>
<p><strong>Purpose</strong>: Parse and display MIME messages.</p>
<p><strong>File</strong>: <code>/lisp/gnus/mm-decode.el</code></p>
<pre class="elisp"><code>;; MIME handle structure:
;; (buffer type encoding undisplayer disposition description cache id)

;; Display actions:
(defcustom mm-text-html-renderer
  (cond ((fboundp 'libxml-parse-html-region) 'shr)
        ((executable-find "w3m") 'gnus-w3m)
        (t 'shr))
  "How to render HTML:
  - shr: Built-in Emacs HTML renderer
  - gnus-w3m: Use w3m in Emacs
  - w3m: External w3m
  - links/lynx: External text browsers")</code></pre>
<p><strong>MIME Decoding Pipeline</strong>: 1. Parse Content-Type
headers 2. Build handle tree for multipart messages 3. Decode transfer
encodings (base64, quoted-printable) 4. Convert charsets 5. Display each
part via appropriate viewer 6. Handle alternative parts (prefer HTML vs
text)</p>
<h3 data-number="14.6.3" id="other-mime-modules"><span class="header-section-number">14.6.3</span> Other MIME Modules</h3>
<p><strong>mm-encode.el</strong>: Encode content for sending - Choose
transfer encoding - Handle charsets - Generate boundaries</p>
<p><strong>mm-view.el</strong>: Display MIME parts - Inline images -
External viewers - Button creation</p>
<p><strong>mm-util.el</strong>: MIME utilities - Charset handling -
Encoding detection - Multibyte operations</p>
<p><strong>mm-uu.el</strong>: Uuencode/shar detection - Find encoded
sections in plain text - Decode automatically</p>
<h2 data-number="14.7" id="integration-features"><span class="header-section-number">14.7</span> Integration Features</h2>
<h3 data-number="14.7.1" id="cloud-synchronization-gnus-cloud.el-600-lines"><span class="header-section-number">14.7.1</span> Cloud Synchronization:
gnus-cloud.el (600+ lines)</h3>
<p><strong>Purpose</strong>: Sync newsrc and other files via IMAP.</p>
<p><strong>File</strong>: <code>/lisp/gnus/gnus-cloud.el</code></p>
<pre class="elisp"><code>(defcustom gnus-cloud-synced-files
  '("~/.authinfo.gpg"
    "~/.gnus.el"
    (:directory "~/News" :match ".*.SCORE\\'"))
  "Files to sync across machines.")

(defcustom gnus-cloud-storage-method
  (if (featurep 'epg) 'epg 'base64-gzip)
  "How to encode data:
  - epg: Encrypt with GPG
  - base64-gzip: Compress and encode
  - base64: Just encode")</code></pre>
<p><strong>Sync Process</strong>: 1. Upload files to special IMAP folder
2. Store as email messages 3. Download on other machine 4.
Decrypt/decompress 5. Write to files</p>
<h3 data-number="14.7.2" id="message-encryption-mml-sec.el"><span class="header-section-number">14.7.2</span> Message Encryption:
mml-sec.el</h3>
<p><strong>Purpose</strong>: PGP/MIME and S/MIME support.</p>
<p><strong>File</strong>: <code>/lisp/gnus/mml-sec.el</code></p>
<pre class="elisp"><code>;; MML security tags:
;; &lt;#secure method=pgpmime mode=sign&gt;
;; Message to sign
;; &lt;#/secure&gt;

;; &lt;#secure method=smime mode=encrypt&gt;
;; Encrypted message
;; &lt;#/secure&gt;

;; Methods:
;; - pgpmime: PGP/MIME (RFC 3156)
;; - smime: S/MIME
;; - pgp: Old-style PGP

;; Modes:
;; - sign: Digital signature only
;; - encrypt: Encryption only
;; - signencrypt: Both</code></pre>
<h3 data-number="14.7.3" id="spam-filtering-spam.el-3000-lines"><span class="header-section-number">14.7.3</span> Spam Filtering: spam.el
(3,000+ lines)</h3>
<p><strong>Purpose</strong>: Integrate with spam filters (SpamAssassin,
Bogofilter, etc.)</p>
<p><strong>File</strong>: <code>/lisp/gnus/spam.el</code></p>
<pre class="elisp"><code>;; Spam processing:
;; 1. Mark messages as spam/ham
;; 2. Train filter
;; 3. Move to appropriate group
;; 4. Report to blacklists

(defcustom spam-split-group "spam"
  "Group for suspected spam.")

;; Backends:
;; - spam-use-bogofilter
;; - spam-use-spamassassin
;; - spam-use-spamoracle
;; - spam-use-BBDB (check against address book)
;; - spam-use-regex-headers</code></pre>
<h3 data-number="14.7.4" id="utilities-and-infrastructure"><span class="header-section-number">14.7.4</span> Utilities and
Infrastructure</h3>
<p><strong>gnus-util.el</strong> (1,544 lines): Core utilities - Date
parsing - String operations - Hash table helpers - Process
management</p>
<p><strong>gnus-spec.el</strong>: Format specifications - Compile format
strings to functions - Caching for performance</p>
<p><strong>gnus-range.el</strong>: Range operations - Compact
representation (1-100,150,200-300) - Union, intersection, difference -
Efficient storage</p>
<p><strong>gnus-undo.el</strong>: Undo system - Track operations -
Restore group/summary state - Transactional changes</p>
<h2 data-number="14.8" id="data-flow-examples"><span class="header-section-number">14.8</span> Data Flow Examples</h2>
<h3 data-number="14.8.1" id="reading-news"><span class="header-section-number">14.8.1</span> Reading News</h3>
<pre><code>User presses RET on group
  ‚Üì
gnus-group-read-group
  ‚Üì
gnus-summary-read-group
  ‚Üì
gnus-select-newsgroup
  ‚Üì
gnus-request-group (via gnus-int)
  ‚Üì
Backend: nntp-request-group
  ‚Üí "GROUP comp.emacs" to server
  ‚Üê "211 450 1 450 comp.emacs"
  ‚Üì
gnus-get-unread-articles-in-group
  ‚Üì
gnus-retrieve-headers (via gnus-int)
  ‚Üì
Backend: nntp-retrieve-headers
  ‚Üí "XOVER 1-450" to server
  ‚Üê NOV data
  ‚Üì
gnus-get-newsgroup-headers
  ‚Üí Parse NOV lines
  ‚Üí Build threading
  ‚Üí Apply scoring
  ‚Üì
gnus-summary-prepare
  ‚Üí Format summary lines
  ‚Üí Display in buffer</code></pre>
<h3 data-number="14.8.2" id="sending-mail"><span class="header-section-number">14.8.2</span> Sending Mail</h3>
<pre><code>User composes message
  ‚Üì
M-x message-send-and-exit
  ‚Üì
message-send
  ‚Üì
message-do-fcc (save copy)
  ‚Üí gnus-request-accept-article
  ‚Üí Backend saves to Sent group
  ‚Üì
mml-to-mime (process MML tags)
  ‚Üí Build MIME structure
  ‚Üí Encode attachments
  ‚Üí Generate boundaries
  ‚Üì
message-send-mail
  ‚Üì
smtpmail-send-it
  ‚Üí Connect to SMTP server
  ‚Üí Send EHLO
  ‚Üí STARTTLS (if supported)
  ‚Üí AUTH (if needed)
  ‚Üí MAIL FROM
  ‚Üí RCPT TO
  ‚Üí DATA
  ‚Üí Send message
  ‚Üí QUIT
  ‚Üì
gnus-registry-handle-action
  ‚Üí Record in registry</code></pre>
<h3 data-number="14.8.3" id="mail-splitting"><span class="header-section-number">14.8.3</span> Mail Splitting</h3>
<pre><code>New mail arrives in INBOX
  ‚Üì
gnus-request-scan (or backend auto-check)
  ‚Üì
nnmail-split-incoming
  ‚Üì
nnmail-split-fancy (or nnmail-split-methods)
  ‚Üí Evaluate split rules:
    ("^From:.*alice" "mail.alice")
    ("^Subject:.*work" "mail.work")
    ((: gnus-registry-split-fancy-with-parent))
  ‚Üì
For each message:
  ‚Üí Check rules in order
  ‚Üí First match wins
  ‚Üí Move to target group
  ‚Üì
gnus-request-accept-article
  ‚Üí Backend saves to group
  ‚Üí Update active file
  ‚Üí Generate NOV entry</code></pre>
<h2 data-number="14.9" id="performance-considerations-3"><span class="header-section-number">14.9</span> Performance
Considerations</h2>
<h3 data-number="14.9.1" id="startup-performance"><span class="header-section-number">14.9.1</span> Startup Performance</h3>
<pre class="elisp"><code>;; Techniques to speed startup:

;; 1. Lazy server connection
(setq gnus-check-new-newsgroups nil)  ; Don't scan for new groups

;; 2. Limited activation
(setq gnus-activate-level 3)  ; Only activate levels 1-3

;; 3. Partial group entry
(setq gnus-large-newsgroup 1000)  ; Prompt for partial entry

;; 4. Asynchronous operations
(setq gnus-asynchronous t)    ; Prefetch in background
(setq gnus-use-article-prefetch 15)  ; Prefetch next 15 articles</code></pre>
<h3 data-number="14.9.2" id="summary-generation"><span class="header-section-number">14.9.2</span> Summary Generation</h3>
<pre class="elisp"><code>;; Threading performance:
;; - Hash tables for O(1) message lookup
;; - Compiled format specs (gnus-spec.el)
;; - Cached summary lines

;; NOV databases:
;; - Pre-computed header cache
;; - Single file read vs. N file reads
;; - Dramatically faster than parsing articles

;; Example speedup:
;; Without NOV: 50 articles/second
;; With NOV: 5000 articles/second</code></pre>
<h3 data-number="14.9.3" id="memory-management"><span class="header-section-number">14.9.3</span> Memory Management</h3>
<pre class="elisp"><code>;; Summary buffer data structures:
;; - gnus-newsgroup-data: Article headers
;; - gnus-newsgroup-threads: Thread tree
;; - gnus-summary-buffer: Formatted display

;; Memory is freed when exiting group:
(defcustom gnus-kill-summary-on-exit t
  "Kill summary buffer on exit to reclaim memory.")

;; Article buffer reuse:
;; Single article buffer is reused, not created per article</code></pre>
<h2 data-number="14.10" id="customization-patterns"><span class="header-section-number">14.10</span> Customization Patterns</h2>
<h3 data-number="14.10.1" id="group-parameters"><span class="header-section-number">14.10.1</span> Group Parameters</h3>
<p>Groups can have custom parameters:</p>
<pre class="elisp"><code>;; Set group parameter:
(gnus-group-set-parameter "nnimap+gmail:INBOX"
                          'display 'all)

;; Common parameters:
;; - to-address: Mailing list address
;; - to-list: Mailing list ID
;; - broken-reply-to: Override broken Reply-To
;; - gcc-self: Save copies of sent messages
;; - posting-style: Custom From/Sig for group
;; - expire-days: Group-specific expiry
;; - score-file: Group score file</code></pre>
<h3 data-number="14.10.2" id="select-methods"><span class="header-section-number">14.10.2</span> Select Methods</h3>
<pre class="elisp"><code>;; Primary select method:
(setq gnus-select-method
      '(nntp "news.example.com"))

;; Secondary select methods:
(setq gnus-secondary-select-methods
      '((nnimap "gmail"
                (nnimap-address "imap.gmail.com")
                (nnimap-server-port 993)
                (nnimap-stream ssl))
        (nnml "mail"
              (nnml-directory "~/Mail"))))

;; Method format:
;; (BACKEND SERVER-NAME PARAMETER...)</code></pre>
<h3 data-number="14.10.3" id="hooks-1"><span class="header-section-number">14.10.3</span> Hooks</h3>
<p>Gnus provides numerous hooks:</p>
<pre class="elisp"><code>;; Startup:
gnus-started-hook              ; After Gnus starts
gnus-before-startup-hook       ; Before connecting

;; Group buffer:
gnus-group-mode-hook           ; Group buffer created
gnus-select-group-hook         ; Before entering group

;; Summary buffer:
gnus-summary-mode-hook         ; Summary buffer created
gnus-summary-prepared-hook     ; After summary generated
gnus-select-article-hook       ; Article selected

;; Article buffer:
gnus-article-mode-hook         ; Article buffer created
gnus-article-prepare-hook      ; Before displaying article

;; Message composition:
message-mode-hook              ; Message buffer created
message-send-hook              ; Before sending
message-sent-hook              ; After sending</code></pre>
<h2 data-number="14.11" id="design-patterns-and-idioms"><span class="header-section-number">14.11</span> Design Patterns and
Idioms</h2>
<h3 data-number="14.11.1" id="the-three-buffer-model"><span class="header-section-number">14.11.1</span> The Three-Buffer Model</h3>
<p>Gnus‚Äôs core UI uses three connected buffers:</p>
<ol type="1">
<li><strong>Group Buffer</strong> (<em>Group</em>): Directory of
newsgroups
<ul>
<li>Entry point</li>
<li>Shows unread counts</li>
<li>Low-frequency updates</li>
</ul></li>
<li><strong>Summary Buffer</strong> (<em>Summary GROUPNAME</em>):
Article list
<ul>
<li>Threading display</li>
<li>High-frequency scanning</li>
<li>Marks and scores visible</li>
</ul></li>
<li><strong>Article Buffer</strong> (<em>Article GROUPNAME</em>):
Content display
<ul>
<li>Read-only (usually)</li>
<li>MIME rendering</li>
<li>Large content</li>
</ul></li>
</ol>
<p><strong>Navigation</strong>: Each buffer has commands to move
‚Äúdeeper‚Äù: - Group ‚Üí Summary: <code>RET</code> or <code>SPC</code> -
Summary ‚Üí Article: <code>RET</code> or <code>SPC</code> - Back:
<code>q</code> quits current buffer</p>
<h3 data-number="14.11.2" id="format-specifications"><span class="header-section-number">14.11.2</span> Format Specifications</h3>
<p>Gnus uses printf-style format strings extensively:</p>
<pre class="elisp"><code>;; Format specs are compiled to functions for speed
;; Example: "%U%R%z%I%(%[%4L: %-23,23f%]%) %s\n"

;; Compilation process (gnus-spec.el):
;; 1. Parse format string
;; 2. Generate Lisp code
;; 3. Byte-compile function
;; 4. Cache compiled function

;; Result: ~10x faster than interpreting format string</code></pre>
<h3 data-number="14.11.3" id="backend-inheritance"><span class="header-section-number">14.11.3</span> Backend Inheritance</h3>
<pre class="elisp"><code>;; Backends inherit via nnoo-import:

(nnoo-declare nndraft nnmh)  ; nndraft inherits from nnmh
(nnoo-import nndraft (nnmh))  ; Import all nnmh functions

;; Override specific functions:
(deffoo nndraft-request-accept-article (...)
  ;; Custom implementation
  )

;; Benefit: Code reuse, minimal duplication</code></pre>
<h3 data-number="14.11.4" id="range-compression"><span class="header-section-number">14.11.4</span> Range Compression</h3>
<pre class="elisp"><code>;; Article numbers stored as ranges:
;; "1-100,105,110-150" instead of 145 individual numbers

;; Operations:
(gnus-range-add '((1 . 100)) 101)
  ‚Üí ((1 . 101))

(gnus-range-difference '((1 . 100)) '((50 . 60)))
  ‚Üí ((1 . 49) (61 . 100))

;; Benefits:
;; - Compact storage
;; - Fast operations
;; - Efficient wire protocol</code></pre>
<h2 data-number="14.12" id="testing-and-debugging"><span class="header-section-number">14.12</span> Testing and Debugging</h2>
<h3 data-number="14.12.1" id="debug-variables"><span class="header-section-number">14.12.1</span> Debug Variables</h3>
<pre class="elisp"><code>;; Enable debugging:
(setq gnus-verbose 10)          ; Max verbosity
(setq gnus-verbose-backends 10) ; Backend verbosity
(setq nntp-record-commands t)   ; Log NNTP commands

;; Network tracing:
(setq nnimap-log-commands t)    ; IMAP command log</code></pre>
<h3 data-number="14.12.2" id="repair-commands"><span class="header-section-number">14.12.2</span> Repair Commands</h3>
<pre class="elisp"><code>;; Rebuild summary:
M-x gnus-summary-rescan-group

;; Regenerate NOV:
M-x nnml-generate-nov-databases

;; Repair newsrc:
M-x gnus-group-clear-data

;; Reset server:
M-x gnus-close-server
M-x gnus-open-server</code></pre>
<h2 data-number="14.13" id="historical-context-2"><span class="header-section-number">14.13</span> Historical Context</h2>
<p>Gnus evolved from GNUS (written by Masanobu UMEDA in 1987), which
itself was based on NNTP (Network News Transfer Protocol) readers of the
1980s.</p>
<p><strong>Evolution</strong>: - <strong>GNUS</strong> (1987): Original
newsreader - <strong>Gnus 5.x</strong> (1995): Major rewrite by Lars
Ingebrigtsen - Pluggable backend system (nnoo) - Scoring and adaptive
scoring - MIME support - <strong>Gnus 5.8+</strong> (2000s): Email
features mature - IMAP support - Agent (offline mode) - Registry -
<strong>Gnus 5.13</strong> (2010s-present): Modern features - HTML
rendering (shr) - OAuth2 authentication - Cloud synchronization -
Unified search</p>
<p><strong>Philosophy</strong>: ‚ÄúGnus is not just a newsreader; it‚Äôs a
way of life.‚Äù</p>
<p>The design emphasizes: - <strong>Flexibility</strong>: Highly
customizable - <strong>Extensibility</strong>: Plugin architecture -
<strong>Power</strong>: Complex features for advanced users -
<strong>Integration</strong>: Deep Emacs integration</p>
<h2 data-number="14.14" id="code-statistics"><span class="header-section-number">14.14</span> Code Statistics</h2>
<pre><code>Component               Lines    Purpose
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
gnus-sum.el           13,241    Summary buffer (article lists)
gnus-art.el            9,061    Article display
message.el             9,065    Message composition
gnus-group.el          4,869    Group buffer
gnus.el                4,204    Core definitions
gnus-agent.el          4,143    Offline mode
gnus-start.el          3,199    Startup/newsrc
gnus-score.el          3,188    Scoring system
nntp.el                2,700    NNTP backend
nnimap.el              2,700    IMAP backend
gnus-search.el         2,363    Search system
nnmail.el              2,300    Mail backend utilities
mm-decode.el           2,100    MIME decoding
gnus-uu.el             2,149    Binary extraction
gnus-msg.el            1,947    Message interface
mml.el                 1,800    MIME composition
gnus-topic.el          1,798    Topic mode
nnml.el                1,700    Mail spool backend
nnmaildir.el           1,900    Maildir backend
gnus-registry.el       1,304    Article registry
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
28 Backends           ~30,000   (nntp, nnimap, nnml, nnrss, etc.)
10 MIME modules        ~8,000   (mm-*.el)
30+ Feature modules   ~40,000   (cache, cite, cloud, demon, etc.)
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Total                120,363    106 files</code></pre>
<h2 data-number="14.15" id="key-takeaways-2"><span class="header-section-number">14.15</span> Key Takeaways</h2>
<p><strong>Gnus demonstrates</strong>:</p>
<ol type="1">
<li><strong>Layered Architecture</strong>: Clean separation between UI,
core, and backends</li>
<li><strong>Plugin System</strong>: Backends are swappable
implementations of protocol</li>
<li><strong>Data Abstraction</strong>: Ranges, hash tables, format specs
optimize performance</li>
<li><strong>Extensive Customization</strong>: Hundreds of options,
hooks, parameters</li>
<li><strong>Feature Modularity</strong>: Agent, scoring, registry are
independent modules</li>
<li><strong>Protocol Support</strong>: NNTP, IMAP, local spools, RSS via
unified interface</li>
<li><strong>MIME Handling</strong>: Comprehensive multipart message
support</li>
<li><strong>Threading</strong>: Sophisticated conversation
reconstruction</li>
<li><strong>Offline Operation</strong>: Agent enables disconnected
workflows</li>
<li><strong>Long-term Evolution</strong>: 35+ years of development,
maintaining backwards compatibility</li>
</ol>
<p><strong>Modern Relevance</strong>:</p>
<p>Despite email clients like Thunderbird and webmail, Gnus remains
relevant because: - <strong>Emacs Integration</strong>: Unified
environment for email, news, RSS - <strong>Keyboard Efficiency</strong>:
No mouse required - <strong>Programmability</strong>: Elisp
customization for any workflow - <strong>Backend Flexibility</strong>:
Read from multiple sources simultaneously - <strong>Privacy</strong>:
Complete control over data - <strong>Power Features</strong>: Scoring,
threading, splitting beyond typical clients</p>
<p>Gnus exemplifies how literate, modular design enables a complex
system to evolve while remaining maintainable.</p>
<h1 data-number="15" id="version-control-vc-system"><span class="header-section-number">15</span> Version Control (VC) System</h1>
<p><strong>Location</strong>: <code>/lisp/vc/</code>
<strong>Files</strong>: 39 files, 52,964 lines of code
<strong>Purpose</strong>: Unified interface for interacting with
multiple version control systems</p>
<h2 data-number="15.1" id="overview-6"><span class="header-section-number">15.1</span> Overview</h2>
<p>The Emacs Version Control (VC) system provides a consistent,
backend-agnostic interface for working with various version control
systems including Git, Mercurial, Subversion, Bazaar, CVS, RCS, SCCS,
and SRC. It abstracts the differences between these systems behind a
common API, allowing users to perform version control operations without
needing to know system-specific commands.</p>
<h2 data-number="15.2" id="architecture"><span class="header-section-number">15.2</span> Architecture</h2>
<h3 data-number="15.2.1" id="core-components"><span class="header-section-number">15.2.1</span> Core Components</h3>
<p>The VC system is organized into several architectural layers:</p>
<pre><code>‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    User Interface Layer                      ‚îÇ
‚îÇ  vc.el: High-level commands (commit, log, diff, etc.)       ‚îÇ
‚îÇ  vc-dir.el: Directory status browser                         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                  Backend Abstraction Layer                   ‚îÇ
‚îÇ  vc-hooks.el: Initialization &amp; property caching             ‚îÇ
‚îÇ  vc-dispatcher.el: Async command execution                  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                       Backend Layer                          ‚îÇ
‚îÇ  vc-git.el, vc-hg.el, vc-svn.el, vc-bzr.el, vc-cvs.el      ‚îÇ
‚îÇ  vc-rcs.el, vc-sccs.el, vc-src.el                           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                      Related Tools                           ‚îÇ
‚îÇ  diff-mode.el, log-view.el, log-edit.el                     ‚îÇ
‚îÇ  smerge-mode.el, ediff (10 files), vc-annotate.el          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò</code></pre>
<h3 data-number="15.2.2" id="file-organization"><span class="header-section-number">15.2.2</span> File Organization</h3>
<h4 data-number="15.2.2.1" id="core-files-5-files"><span class="header-section-number">15.2.2.1</span> Core Files (5 files)</h4>
<ul>
<li><strong><code>vc-hooks.el</code></strong> (1,164 lines): Preloaded
initialization, property caching, find-file hooks</li>
<li><strong><code>vc.el</code></strong> (5,283 lines): Main user
interface, backend dispatch, high-level operations</li>
<li><strong><code>vc-dispatcher.el</code></strong> (1,073 lines):
Command execution framework, async operations</li>
<li><strong><code>vc-dir.el</code></strong> (1,744 lines):
Directory-level status browser using ewoc</li>
<li><strong><code>vc-filewise.el</code></strong> (86 lines): Helper for
file-based VCS operations</li>
</ul>
<h4 data-number="15.2.2.2" id="backend-implementations-8-files"><span class="header-section-number">15.2.2.2</span> Backend Implementations (8
files)</h4>
<ul>
<li><strong><code>vc-git.el</code></strong> (2,846 lines): Git backend -
most feature-complete</li>
<li><strong><code>vc-hg.el</code></strong> (1,941 lines): Mercurial
backend</li>
<li><strong><code>vc-svn.el</code></strong> (840 lines): Subversion
backend</li>
<li><strong><code>vc-bzr.el</code></strong> (1,378 lines): Bazaar
backend</li>
<li><strong><code>vc-cvs.el</code></strong> (1,350 lines): CVS
backend</li>
<li><strong><code>vc-rcs.el</code></strong> (1,470 lines): RCS
backend</li>
<li><strong><code>vc-sccs.el</code></strong> (532 lines): SCCS
backend</li>
<li><strong><code>vc-src.el</code></strong> (337 lines): SRC backend
(RCS wrapper)</li>
</ul>
<h4 data-number="15.2.2.3" id="related-tools-15-files"><span class="header-section-number">15.2.2.3</span> Related Tools (15
files)</h4>
<ul>
<li><strong><code>diff-mode.el</code></strong> (3,505 lines): Major mode
for viewing/editing diffs</li>
<li><strong><code>log-view.el</code></strong> (956 lines): Revision log
browser</li>
<li><strong><code>log-edit.el</code></strong> (1,466 lines): Commit
message editor</li>
<li><strong><code>vc-annotate.el</code></strong> (835 lines):
Blame/annotate visualization</li>
<li><strong><code>smerge-mode.el</code></strong> (1,720 lines): Merge
conflict resolution</li>
<li><strong>Ediff suite</strong> (10 files, ~18,000 lines): Advanced
diff/merge/patch tool</li>
<li><strong>Emerge</strong> (3,064 lines): Older merge tool</li>
<li><strong>PCL-CVS</strong> (5 files): CVS-specific interface</li>
</ul>
<h4 data-number="15.2.2.4" id="supporting-files-11-files"><span class="header-section-number">15.2.2.4</span> Supporting Files (11
files)</h4>
<ul>
<li><strong><code>add-log.el</code></strong> (1,398 lines): ChangeLog
integration</li>
<li><strong><code>compare-w.el</code></strong> (427 lines): Window
comparison</li>
<li><strong><code>cvs-status.el</code></strong> (533 lines): CVS status
parsing</li>
<li><strong><code>diff.el</code></strong> (300 lines): Diff
utilities</li>
<li><strong><code>pcvs-*.el</code></strong> (4 files): PCL-CVS
components</li>
</ul>
<h2 data-number="15.3" id="backend-abstraction-layer"><span class="header-section-number">15.3</span> Backend Abstraction Layer</h2>
<h3 data-number="15.3.1" id="the-vc-call-dispatch-mechanism"><span class="header-section-number">15.3.1</span> The vc-call Dispatch
Mechanism</h3>
<p>The heart of VC‚Äôs abstraction is the <code>vc-call</code> macro and
<code>vc-call-backend</code> function, which dynamically dispatch
operations to backend-specific implementations:</p>
<pre class="elisp"><code>;; Location: /lisp/vc/vc-hooks.el:303-308

(defmacro vc-call (fun file &amp;rest args)
  "A convenience macro for calling VC backend functions.
Functions called by this macro must accept FILE as the first argument.
ARGS specifies any additional arguments. FUN should be unquoted."
  (macroexp-let2 nil file file
    `(vc-call-backend (vc-backend ,file) ',fun ,file ,@args)))</code></pre>
<p>This mechanism: 1. Determines the backend for a file via
<code>vc-backend</code> 2. Constructs the backend-specific function name
(e.g., <code>vc-git-state</code>) 3. Calls the function, or falls back
to <code>vc-default-*</code> if not implemented 4. Caches function
lookups in the backend‚Äôs <code>vc-functions</code> property</p>
<h3 data-number="15.3.2" id="backend-function-discovery"><span class="header-section-number">15.3.2</span> Backend Function
Discovery</h3>
<pre class="elisp"><code>;; Location: /lisp/vc/vc-hooks.el:264-279

(defun vc-make-backend-sym (backend sym)
  "Return BACKEND-specific version of VC symbol SYM."
  (intern (concat "vc-" (downcase (symbol-name backend))
                  "-" (symbol-name sym))))

(defun vc-find-backend-function (backend fun)
  "Return BACKEND-specific implementation of FUN.
If there is no such implementation, return the default implementation;
if that doesn't exist either, return nil."
  (let ((f (vc-make-backend-sym backend fun)))
    (if (fboundp f) f
      ;; Load vc-BACKEND.el if needed.
      (require (intern (concat "vc-" (downcase (symbol-name backend)))))
      (if (fboundp f) f
        (let ((def (vc-make-backend-sym 'default fun)))
          (if (fboundp def) (cons def backend) nil))))))</code></pre>
<p><strong>Auto-loading Pattern</strong>: Backend files use
<code>;;;###autoload</code> directives to register their presence
without loading the entire backend:</p>
<pre class="elisp"><code>;; Location: /lisp/vc/vc-git.el:285-290

;;;###autoload (defun vc-git-registered (file)
;;;###autoload   "Return non-nil if FILE is registered with git."
;;;###autoload   (if (vc-find-root file ".git")       ; Short cut.
;;;###autoload       (progn
;;;###autoload         (load "vc-git" nil t)
;;;###autoload         (vc-git-registered file))))</code></pre>
<h3 data-number="15.3.3" id="backend-api-contract"><span class="header-section-number">15.3.3</span> Backend API Contract</h3>
<p>Backends implement a standard set of functions documented in
<code>/lisp/vc/vc.el:108-755</code>. The API is divided into several
categories:</p>
<h4 data-number="15.3.3.1" id="backend-properties"><span class="header-section-number">15.3.3.1</span> 1. Backend Properties</h4>
<pre class="elisp"><code>;; Required (*)
(defun vc-BACKEND-revision-granularity ()
  ;; Return 'file or 'repository

;; Optional (-)
(defun vc-BACKEND-update-on-retrieve-tag () ...)
(defun vc-BACKEND-async-checkins () ...)
(defun vc-BACKEND-working-revision-symbol () ...)</code></pre>
<p><strong>Example from Git</strong>:</p>
<pre class="elisp"><code>;; Location: /lisp/vc/vc-git.el:279-281

(defun vc-git-revision-granularity () 'repository)
(defun vc-git-checkout-model (_files) 'implicit)
(defun vc-git-update-on-retrieve-tag () nil)</code></pre>
<h4 data-number="15.3.3.2" id="state-querying-functions"><span class="header-section-number">15.3.3.2</span> 2. State-Querying
Functions</h4>
<pre class="elisp"><code>;; * registered (file)
;;   Return non-nil if FILE is registered in this backend

;; * state (file)
;;   Return the current version control state:
;;   - 'up-to-date, 'edited, 'added, 'removed, 'missing
;;   - 'needs-update, 'needs-merge, 'unlocked-changes
;;   - 'conflict, 'unregistered, 'ignored

;; - dir-status-files (dir files update-function)
;;   Asynchronously produce status for FILES in DIR

;; * working-revision (file)
;;   Return the working revision (current checkout)

;; * checkout-model (files)
;;   Return 'implicit, 'explicit, or 'locking</code></pre>
<p><strong>Git State Implementation</strong>:</p>
<pre class="elisp"><code>;; Location: /lisp/vc/vc-git.el:402-428

(defun vc-git-state (file)
  "Git-specific version of `vc-state'."
  (let* ((args
          `("status" "--porcelain" "-z"
            "--untracked-files"
            ,@(when (version&lt;= "1.7.6.3" (vc-git--program-version))
                '("--ignored"))
            "--"))
        (status (apply #'vc-git--run-command-string file args)))
    (if (null status)
        'unregistered
      (vc-git--git-status-to-vc-state
       (mapcar (lambda (s) (substring s 0 2))
               (split-string status "\0" t))))))</code></pre>
<p>The state conversion logic handles Git‚Äôs two-character status
codes:</p>
<pre class="elisp"><code>;; Location: /lisp/vc/vc-git.el:369-400

(defun vc-git--git-status-to-vc-state (code-list)
  "Convert CODE-LIST to a VC status."
  (pcase code-list
    ('nil 'up-to-date)
    (`(,code)
     (pcase code
       ("!!" 'ignored)
       ("??" 'unregistered)
       ("D " 'removed)
       (_ (cond
           ((string-match-p "^.D$" code) 'missing)
           ((string-match-p "^[ M]+$" code) 'edited)
           ((string-match-p "^[ A]+$" code) 'added)
           ((string-match-p "^[ U]+$" code) 'conflict)
           (t 'edited)))))
    ('("D " "??") 'unregistered)
    (_ 'edited)))</code></pre>
<h4 data-number="15.3.3.3" id="state-changing-functions"><span class="header-section-number">15.3.3.3</span> 3. State-Changing
Functions</h4>
<pre class="elisp"><code>;; * create-repo ()
;;   Initialize a new repository

;; * register (files &amp;optional comment)
;;   Register FILES in version control

;; - responsible-p (file)
;;   Return non-nil if backend should handle FILE

;; * checkin (files comment &amp;optional rev)
;;   Commit changes with COMMENT

;; - checkin-patch (patch-string comment)
;;   Commit a patch without touching working tree

;; * find-revision (file rev buffer)
;;   Retrieve revision REV of FILE into BUFFER

;; * checkout (file &amp;optional rev)
;;   Check out revision REV of FILE

;; * revert (file &amp;optional contents-done)
;;   Revert FILE to working revision

;; - merge-branch ()
;;   Merge another branch into current

;; - pull (prompt)
;;   Pull upstream changes</code></pre>
<h4 data-number="15.3.3.4" id="history-functions"><span class="header-section-number">15.3.3.4</span> 4. History Functions</h4>
<pre class="elisp"><code>;; * print-log (files buffer &amp;optional shortlog start-revision limit)
;;   Insert revision log into BUFFER

;; * incoming-revision (&amp;optional upstream-location refresh)
;;   Return revision at head of upstream branch

;; - log-search (buffer pattern)
;;   Search for PATTERN in revision log

;; - log-view-mode ()
;;   Mode for displaying print-log output

;; * diff (files &amp;optional rev1 rev2 buffer async)
;;   Generate diff between revisions

;; - annotate-command (file buf &amp;optional rev)
;;   Generate annotated (blame) view

;; - region-history (file buffer lfrom lto)
;;   Show history of region between lines

;; - mergebase (rev1 &amp;optional rev2)
;;   Return common ancestor of revisions</code></pre>
<h4 data-number="15.3.3.5" id="tagbranch-system"><span class="header-section-number">15.3.3.5</span> 5. Tag/Branch System</h4>
<pre class="elisp"><code>;; - create-tag (dir name branchp)
;;   Create tag NAME, or branch if BRANCHP

;; - retrieve-tag (dir name update)
;;   Switch to tag/branch NAME</code></pre>
<h4 data-number="15.3.3.6" id="miscellaneous"><span class="header-section-number">15.3.3.6</span> 6. Miscellaneous</h4>
<pre class="elisp"><code>;; - root (file)
;;   Return root of VC hierarchy

;; - ignore (file &amp;optional directory remove)
;;   Add/remove FILE to ignore list

;; - find-ignore-file (file)
;;   Return ignore file (.gitignore, etc.)

;; - previous-revision (file rev)
;;   Return revision before REV

;; - next-revision (file rev)
;;   Return revision after REV

;; - delete-file (file)
;;   Delete FILE from repository

;; - rename-file (old new)
;;   Rename file in repository

;; - conflicted-files (dir)
;;   Return list of conflicted files

;; - repository-url (file-or-dir &amp;optional remote-name)
;;   Return repository URL</code></pre>
<h3 data-number="15.3.4" id="backend-registration"><span class="header-section-number">15.3.4</span> Backend Registration</h3>
<p>Backends are registered via the <code>vc-handled-backends</code>
customization variable:</p>
<pre class="elisp"><code>;; Location: /lisp/vc/vc-hooks.el:112-124

(defcustom vc-handled-backends '(RCS CVS SVN SCCS SRC Bzr Git Hg)
  "List of version control backends for which VC will be used.
Entries in this list will be tried in order to determine whether a
file is under that sort of version control.
Removing an entry from the list prevents VC from being activated
when visiting a file managed by that backend.
An empty list disables VC altogether."
  :type '(repeat symbol)
  :version "25.1"
  :group 'vc)</code></pre>
<p><strong>Backend Discovery Process</strong>: 1. When a file is opened,
<code>vc-refresh-state</code> (in <code>find-file-hook</code>) is called
2. <code>vc-registered</code> iterates through
<code>vc-handled-backends</code> 3. For each backend, calls
<code>vc-BACKEND-registered</code> (auto-loaded) 4. First backend that
returns non-nil ‚Äúclaims‚Äù the file 5. Backend is cached in file property
<code>vc-backend</code></p>
<h2 data-number="15.4" id="property-caching-system"><span class="header-section-number">15.4</span> Property Caching System</h2>
<p>VC maintains a per-file property cache to avoid repeated expensive
operations:</p>
<pre class="elisp"><code>;; Location: /lisp/vc/vc-hooks.el:229-252

(defvar vc-file-prop-obarray (make-hash-table :test 'equal)
  "Obarray for per-file properties.")

(defun vc-file-setprop (file property value)
  "Set per-file VC PROPERTY for FILE to VALUE."
  (if (and vc-touched-properties
           (not (memq property vc-touched-properties)))
      (setq vc-touched-properties (append (list property)
                                          vc-touched-properties)))
  (put (intern (expand-file-name file) vc-file-prop-obarray)
       property value))

(defun vc-file-getprop (file property)
  "Get per-file VC PROPERTY for FILE."
  (get (intern (expand-file-name file) vc-file-prop-obarray) property))</code></pre>
<p><strong>Cached Properties</strong>: - <code>vc-backend</code>: Which
backend manages this file - <code>vc-state</code>: Current state
(up-to-date, edited, etc.) - <code>vc-working-revision</code>: Current
revision/commit - <code>vc-checkout-time</code>: When file was last
checked out - <code>vc-git-symbolic-ref</code>: Git branch name - Plus
backend-specific properties</p>
<p><strong>Cache Invalidation</strong>: The
<code>with-vc-properties</code> macro coordinates cache updates:</p>
<pre class="elisp"><code>;; When a backend function returns a value, it's automatically cached
;; Example usage:
(vc-file-setprop file 'vc-state 'edited)
(vc-file-getprop file 'vc-state)  ; =&gt; 'edited</code></pre>
<h2 data-number="15.5" id="core-features"><span class="header-section-number">15.5</span> Core Features</h2>
<h3 data-number="15.5.1" id="file-status-queries"><span class="header-section-number">15.5.1</span> 1. File Status Queries</h3>
<p>The state machine is central to VC‚Äôs operation:</p>
<pre><code>            ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
            ‚îÇ unregistered ‚îÇ ‚Üê File not in VC
            ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                   ‚îÇ vc-register
                   ‚Üì
            ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
            ‚îÇ    added     ‚îÇ ‚Üê Staged for first commit
            ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                   ‚îÇ vc-checkin
                   ‚Üì
            ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
       ‚îå‚îÄ‚îÄ‚îÄ‚Üí‚îÇ up-to-date   ‚îÇ‚Üê‚îÄ‚îÄ‚îê
       ‚îÇ    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
       ‚îÇ           ‚îÇ edit       ‚îÇ
       ‚îÇ           ‚Üì            ‚îÇ
       ‚îÇ    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
       ‚îÇ    ‚îÇ    edited    ‚îÇ   ‚îÇ
       ‚îÇ    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
       ‚îÇ           ‚îÇ vc-checkin ‚îÇ
       ‚îÇ           ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚îÇ    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
       ‚îú‚îÄ‚îÄ‚îÄ‚Üí‚îÇ needs-update ‚îÇ ‚Üê Remote has changes
       ‚îÇ    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚îÇ    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
       ‚îî‚îÄ‚îÄ‚îÄ‚Üí‚îÇ needs-merge  ‚îÇ ‚Üê Both local and remote changes
            ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò</code></pre>
<p><strong>State Query Implementation</strong>:</p>
<pre class="elisp"><code>;; High-level state query (with caching)
(vc-state file)  ; Returns state symbol

;; Backend-specific implementation
(vc-call state file)  ; Dispatches to vc-BACKEND-state

;; Directory-level status
(vc-dir default-directory)  ; Opens status browser</code></pre>
<h3 data-number="15.5.2" id="diff-generation"><span class="header-section-number">15.5.2</span> 2. Diff Generation</h3>
<p>VC provides multiple diff interfaces:</p>
<p><strong>Buffer Diff</strong> (<code>vc-diff</code>):</p>
<pre class="elisp"><code>;; Compare working file with repository
C-x v =  ‚Üí vc-diff

;; Implementation dispatches to backend
(vc-call diff files rev1 rev2 buffer async)</code></pre>
<p><strong>Revision Range Diff</strong>:</p>
<pre class="elisp"><code>C-u C-x v =  ‚Üí Prompts for two revisions</code></pre>
<p><strong>Diff Modes</strong>: -
<strong><code>diff-mode</code></strong> (3,505 lines): Rich major mode
for viewing diffs - Syntax highlighting for hunks - Navigation between
hunks (<code>n</code>, <code>p</code>) - Apply/revert hunks
(<code>C-c C-a</code>, <code>C-c C-r</code>) - Refine hunks to show
word-level changes - Jump to source (<code>C-c C-c</code>) - Edit diffs
and update line numbers</p>
<pre class="elisp"><code>;; Location: /lisp/vc/diff-mode.el

;; Key features:
;; - Font-lock with syntax highlighting from source
;; - Hunk refinement (word-level diffs)
;; - Fringe indicators for +/- lines
;; - Integration with VC for applying patches</code></pre>
<h3 data-number="15.5.3" id="commit-interface"><span class="header-section-number">15.5.3</span> 3. Commit Interface</h3>
<p>The commit workflow uses a specialized log-edit buffer:</p>
<pre class="elisp"><code>;; Initiate commit
C-x v v  ‚Üí vc-next-action (context-aware)

;; For edited files, opens log-edit buffer
;; User types commit message
C-c C-c  ‚Üí log-edit-done (commits changes)</code></pre>
<p><strong>log-edit-mode</strong> provides: - Commit message history
(<code>M-p</code>, <code>M-n</code>) - ChangeLog integration
(<code>C-c C-a</code>) - Diff preview (<code>C-c C-d</code>) - File list
(<code>C-c C-f</code>) - Comment search (<code>M-r</code>,
<code>M-s</code>)</p>
<pre class="elisp"><code>;; Location: /lisp/vc/log-edit.el

(defvar-keymap log-edit-mode-map
  "C-c C-c" #'log-edit-done
  "C-c C-a" #'log-edit-insert-changelog
  "C-c C-w" #'log-edit-generate-changelog-from-diff
  "C-c C-d" #'log-edit-show-diff
  "C-c C-f" #'log-edit-show-files
  "M-n"     #'log-edit-next-comment
  "M-p"     #'log-edit-previous-comment)</code></pre>
<h3 data-number="15.5.4" id="log-viewing"><span class="header-section-number">15.5.4</span> 4. Log Viewing</h3>
<p><strong>log-view-mode</strong> displays revision history:</p>
<pre class="elisp"><code>C-x v l  ‚Üí vc-print-log

;; Navigation
n, p     ‚Üí Next/previous revision
d, =     ‚Üí Show diff for revision
D        ‚Üí Show changeset diff
f        ‚Üí Visit revision
a        ‚Üí Annotate at revision</code></pre>
<p><strong>Backend-Specific Log Formats</strong>:</p>
<p>Git uses custom format strings:</p>
<pre class="elisp"><code>;; Location: /lisp/vc/vc-git.el:195-213

(defcustom vc-git-root-log-format
  '("%d%h..: %an %ad %s"
    "^\\(?:[*/\\| ]+ \\)?\\(?2: ([^)]+)\\)?\\(?1:[0-9a-z]+\\)\\.\\.: \
\\(?3:.*?\\)[ \t]+\\(?4:[0-9]\\{4\\}-[0-9]\\{2\\}-[0-9]\\{2\\}\\)"
    ((1 'log-view-message)
     (2 'change-log-list nil lax)
     (3 'change-log-name)
     (4 'change-log-date)))
  "Git log format for `vc-print-root-log'.")</code></pre>
<h3 data-number="15.5.5" id="branch-management"><span class="header-section-number">15.5.5</span> 5. Branch Management</h3>
<p>Branch operations vary by backend capability:</p>
<pre class="elisp"><code>;; Create branch
C-x v s  ‚Üí vc-create-tag (with prefix arg for branch)

;; Switch branch
C-x v r  ‚Üí vc-retrieve-tag

;; Merge branch (Git/Hg/Bzr)
C-x v m  ‚Üí vc-merge-branch</code></pre>
<p><strong>Git Branch Implementation</strong>:</p>
<pre class="elisp"><code>;; Branches are stored in refs/heads/
;; Current branch tracked via symbolic-ref

(defun vc-git--symbolic-ref (file)
  (or (vc-file-getprop file 'vc-git-symbolic-ref)
      (let ((str (vc-git--run-command-string nil "symbolic-ref" "HEAD")))
        (vc-file-setprop file 'vc-git-symbolic-ref
                         (if str
                             (if (string-match "^\\(refs/heads/\\)?\\(.+\\)$" str)
                                 (match-string 2 str)
                               str))))))</code></pre>
<h3 data-number="15.5.6" id="merging-and-conflict-resolution"><span class="header-section-number">15.5.6</span> 6. Merging and Conflict
Resolution</h3>
<p><strong>smerge-mode</strong> handles merge conflicts:</p>
<pre class="elisp"><code>;; Location: /lisp/vc/smerge-mode.el

;; Automatically activated on files with conflict markers:
&lt;&lt;&lt;&lt;&lt;&lt;&lt; HEAD
version 1
=======
version 2
&gt;&gt;&gt;&gt;&gt;&gt;&gt; branch

;; Commands:
n, p     ‚Üí Navigate conflicts
RET      ‚Üí Keep current version
a        ‚Üí Keep all versions
l, u     ‚Üí Keep lower/upper version
E        ‚Üí Invoke ediff</code></pre>
<p><strong>Conflict Marker Recognition</strong>:</p>
<pre class="elisp"><code>(defun sm-try-smerge ()
  (save-excursion
    (goto-char (point-min))
    (when (re-search-forward "^&lt;&lt;&lt;&lt;&lt;&lt;&lt; " nil t)
      (smerge-mode 1))))
(add-hook 'find-file-hook 'sm-try-smerge t)</code></pre>
<p><strong>Three-Way Merge Structure</strong>:</p>
<pre><code>&lt;&lt;&lt;&lt;&lt;&lt;&lt; upper (or "mine")
Your changes
||||||| base (optional)
Common ancestor
=======
Their changes
&gt;&gt;&gt;&gt;&gt;&gt;&gt; lower (or "theirs")</code></pre>
<h2 data-number="15.6" id="related-tools"><span class="header-section-number">15.6</span> Related Tools</h2>
<h3 data-number="15.6.1" id="diff-mode.el-3505-lines"><span class="header-section-number">15.6.1</span> diff-mode.el (3,505
lines)</h3>
<p>Comprehensive diff viewing and editing:</p>
<p><strong>Key Features</strong>: - <strong>Syntax
Highlighting</strong>: Full source code syntax in hunks - <strong>Hunk
Refinement</strong>: Word-level change highlighting -
<strong>Navigation</strong>: Jump between files, hunks -
<strong>Application</strong>: Apply/reverse individual hunks -
<strong>Editing</strong>: Modify diffs, auto-update line numbers -
<strong>Fringe Indicators</strong>: Visual +/- markers</p>
<p><strong>Refinement Algorithm</strong>:</p>
<pre class="elisp"><code>;; Compares old/new versions at character level
;; Highlights exact changed words/characters
;; Can be automatic (font-lock) or on-demand
(defcustom diff-refine 'font-lock
  "If non-nil, enable hunk refinement.
The value `font-lock' means to refine during font-lock.
The value `navigation' means to refine each hunk as you visit it.")</code></pre>
<h3 data-number="15.6.2" id="log-view.el-956-lines"><span class="header-section-number">15.6.2</span> log-view.el (956 lines)</h3>
<p>Revision log browser supporting multiple VCS formats:</p>
<p><strong>Supported Formats</strong>: - RCS/CVS: Classic
<code>---</code> separator format - Subversion:
<code>r4622 | author | date</code> format - Git: Customizable via
<code>--pretty</code> format - Mercurial:
<code>changeset: 11:8ff1a4166444</code> format - Darcs: Patch-oriented
format</p>
<p><strong>Operations</strong>: - View diffs for revisions - Annotate at
revision - Cherry-pick commits - Modify commit messages - Mark/unmark
revisions</p>
<h3 data-number="15.6.3" id="ediff-suite-10-files-18000-lines"><span class="header-section-number">15.6.3</span> ediff Suite (10 files,
~18,000 lines)</h3>
<p>Advanced visual diff/merge tool:</p>
<p><strong>Components</strong>: - <strong><code>ediff.el</code></strong>
(1,655 lines): Main entry points -
<strong><code>ediff-util.el</code></strong> (4,098 lines): Core
functionality - <strong><code>ediff-mult.el</code></strong> (2,427
lines): Directory comparison -
<strong><code>ediff-wind.el</code></strong> (1,299 lines): Window
management - <strong><code>ediff-diff.el</code></strong> (1,474 lines):
Diff engine integration - <strong><code>ediff-init.el</code></strong>
(1,536 lines): Initialization -
<strong><code>ediff-merg.el</code></strong> (383 lines): Merge
operations - <strong><code>ediff-ptch.el</code></strong> (860 lines):
Patch application - <strong><code>ediff-help.el</code></strong> (305
lines): Help system - <strong><code>ediff-vers.el</code></strong> (193
lines): VC integration</p>
<p><strong>Ediff Modes</strong>: - 2-way file comparison - 3-way file
comparison - 2-way buffer comparison - 3-way merge with ancestor -
Directory comparison - Patch application - Revision comparison (VC
integration)</p>
<p><strong>Window Layouts</strong>:</p>
<pre><code>‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ         Control Panel              ‚îÇ  ‚Üê Small help/command buffer
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ     Buffer A    ‚îÇ    Buffer B      ‚îÇ  ‚Üê 2-way comparison
‚îÇ  (original)     ‚îÇ  (modified)      ‚îÇ
‚îÇ                 ‚îÇ                  ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ     Buffer C (optional)            ‚îÇ  ‚Üê 3-way: ancestor or output
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò</code></pre>
<h3 data-number="15.6.4" id="vc-annotate.el-835-lines"><span class="header-section-number">15.6.4</span> vc-annotate.el (835
lines)</h3>
<p>Blame/annotate visualization with color-coded age:</p>
<p><strong>Features</strong>: - Color-codes lines by age (recent ‚Üí old)
- Multiple color schemes (fullscale, scale, fixed days) - Navigate to
revision at line - Show diff at revision - Background/foreground
coloring modes</p>
<p><strong>Color Map</strong>:</p>
<pre class="elisp"><code>;; Default: HSV gradient from red (new) to blue (old)
;; TTY: Optimized color sequence for 8-color terminals
;; Customizable time scales (days, weeks, months)</code></pre>
<h3 data-number="15.6.5" id="vc-dir.el-1744-lines"><span class="header-section-number">15.6.5</span> vc-dir.el (1,744 lines)</h3>
<p>Directory-level status browser:</p>
<p><strong>Display Format</strong> (using <code>ewoc</code> - Emacs
Widget for Object Collections):</p>
<pre><code>VC Backend : Git
Working dir: /home/user/project
Branch     : main

                   ./
  edited           M  file1.el
  up-to-date          file2.el
  unregistered     ?? newfile.el
  ignored          !! temp.txt</code></pre>
<p><strong>Features</strong>: - Mark/unmark files - Mass operations
(commit, revert, etc.) - Asynchronous status updates - Backend-specific
extra info - Directory folding - Integration with VC commands</p>
<p><strong>Status Collection</strong> (async pattern):</p>
<pre class="elisp"><code>;; Backend calls update-function incrementally
(defun vc-BACKEND-dir-status-files (dir files update-function)
  ;; Start async process
  ;; As results arrive:
  (funcall update-function partial-results t)
  ;; When complete:
  (funcall update-function final-results nil))</code></pre>
<h2 data-number="15.7" id="design-patterns"><span class="header-section-number">15.7</span> Design Patterns</h2>
<h3 data-number="15.7.1" id="backend-registration-and-discovery"><span class="header-section-number">15.7.1</span> 1. Backend Registration and
Discovery</h3>
<p><strong>Registration</strong>:</p>
<pre class="elisp"><code>;; Backends declare themselves via:
;; 1. Entry in vc-handled-backends
;; 2. Autoload for vc-BACKEND-registered
;; 3. Backend file named vc-BACKEND.el

;; Example: vc-git.el
(put 'Git 'vc-functions nil)  ; Clear cache on reload

;;;###autoload
(defun vc-git-registered (file)
  (if (vc-find-root file ".git")
      (progn
        (load "vc-git" nil t)
        (vc-git-registered file))))</code></pre>
<p><strong>Discovery Process</strong>:</p>
<pre class="elisp"><code>;; 1. File opened ‚Üí find-file-hook ‚Üí vc-refresh-state
;; 2. vc-registered called
;; 3. Iterate vc-handled-backends
;; 4. For each backend:
;;    - Check if vc-BACKEND-registered autoload exists
;;    - Call it with short-circuit check (e.g., .git directory)
;;    - If true, load backend and call full function
;; 5. First successful backend "wins"
;; 6. Result cached in vc-backend property</code></pre>
<p><strong>Optimization - Root Caching</strong>:</p>
<pre class="elisp"><code>;; vc-find-root used by most backends
(defun vc-find-root (file witness)
  "Find the root of a checked out project.
The function walks up the directory tree from FILE looking for WITNESS."
  (let ((locate-dominating-stop-dir-regexp
         (or vc-ignore-dir-regexp locate-dominating-stop-dir-regexp)))
    (locate-dominating-file file witness)))

;; Git example:
(defun vc-git-root (file)
  (vc-find-root file ".git"))</code></pre>
<h3 data-number="15.7.2" id="asynchronous-operations"><span class="header-section-number">15.7.2</span> 2. Asynchronous
Operations</h3>
<p><strong>vc-dispatcher.el</strong> provides the async framework:</p>
<pre class="elisp"><code>;; Location: /lisp/vc/vc-dispatcher.el

;; Core async execution
(defun vc-do-command (buffer okstatus command file-or-list &amp;rest flags)
  "Execute a VC command, notifying user and checking for errors.
Output from COMMAND goes to BUFFER, or the current buffer if nil.
OKSTATUS is a list of acceptable exit statuses.
COMMAND is the name of the command to run.
FILE-OR-LIST is the name of a working file; it may be a list of files.
FLAGS are arguments to pass to COMMAND."
  ...)

;; Async with callback
(defun vc-start-logentry (files comment initial-contents msg action &amp;optional after-hook)
  "Accept a comment for an operation on FILES.
Opens a log-edit buffer and calls ACTION when user confirms."
  ...)</code></pre>
<p><strong>Async Dir-Status Pattern</strong>:</p>
<pre class="elisp"><code>;; Backend starts async process, calls update function as results arrive

(defun vc-git-dir-status-files (dir files update-function)
  "Asynchronously update vc-dir for FILES in DIR."
  (let ((buffer (get-buffer-create " *vc-git-status*")))
    (with-current-buffer buffer
      ;; Start git status --porcelain
      (vc-git-command buffer 'async files "status" "--porcelain" "-z")
      ;; Set process filter
      (vc-set-async-update
       buffer
       (lambda ()
         ;; Parse partial output
         (let ((results (parse-git-status)))
           ;; Update UI incrementally
           (funcall update-function results t)))
       (lambda ()
         ;; Parse final output
         (let ((results (parse-git-status)))
           ;; Final update
           (funcall update-function results nil)))))))</code></pre>
<p><strong>Process Filter</strong>:</p>
<pre class="elisp"><code>(defun vc-process-filter (p s)
  "An alternative output filter for async process P.
One difference with the default filter is that this inserts S after markers.
Another is that undo information is not kept."
  (let ((buffer (process-buffer p)))
    (when (buffer-live-p buffer)
      (with-current-buffer buffer
        (save-excursion
          (let ((buffer-undo-list t)
                (inhibit-read-only t))
            (goto-char (process-mark p))
            (insert s)
            (set-marker (process-mark p) (point))))))))</code></pre>
<h3 data-number="15.7.3" id="state-caching-and-invalidation"><span class="header-section-number">15.7.3</span> 3. State Caching and
Invalidation</h3>
<p><strong>Two-Level Caching</strong>:</p>
<ol type="1">
<li><strong>File Properties</strong> (short-term, in-memory):</li>
</ol>
<pre class="elisp"><code>(defvar vc-file-prop-obarray (make-hash-table :test 'equal)
  "Obarray for per-file properties.")

;; Cache backend and state
(vc-file-setprop file 'vc-backend 'Git)
(vc-file-setprop file 'vc-state 'edited)
(vc-file-setprop file 'vc-working-revision "abc123")</code></pre>
<ol start="2" type="1">
<li><strong>Backend-Specific Cache</strong> (persistent across
sessions):</li>
</ol>
<pre class="elisp"><code>;; Git stores branch name, stash count, etc.
(vc-file-setprop file 'vc-git-symbolic-ref "main")</code></pre>
<p><strong>Invalidation Strategy</strong>:</p>
<pre class="elisp"><code>;; Explicit invalidation after state-changing operations
(defun vc-resynch-buffer (file &amp;optional keep noquery reset-vc-info)
  "Resync buffer visiting FILE with its on-disk state.
If RESET-VC-INFO is non-nil, forget cached VC information."
  (when reset-vc-info
    (vc-file-clearprops file))
  ...)

;; Called after: commit, revert, update, merge

;; Automatic invalidation on file modification
(defun vc-after-save ()
  "Called from `basic-save-buffer' after saving a file."
  (when (vc-backend buffer-file-name)
    ;; State may have changed (conflict resolved, etc.)
    (vc-file-setprop buffer-file-name 'vc-state nil)))</code></pre>
<p><strong>Cache-Aware Property Access</strong>:</p>
<pre class="elisp"><code>(defun vc-state (file)
  "Return the VC state of FILE."
  (or (vc-file-getprop file 'vc-state)
      (let ((state (vc-call state file)))
        (vc-file-setprop file 'vc-state state)
        state)))</code></pre>
<h3 data-number="15.7.4" id="hook-system"><span class="header-section-number">15.7.4</span> 4. Hook System</h3>
<p>VC integrates deeply with Emacs via hooks:</p>
<pre class="elisp"><code>;; Find-file integration
(add-hook 'find-file-hook 'vc-refresh-state)

;; Save integration
;; (Called from basic-save-buffer in files.el)
(defun vc-after-save ()
  "Check VC state after saving."
  (when (vc-backend buffer-file-name)
    (vc-state-refresh buffer-file-name)
    (when (and (vc-state buffer-file-name)
               (eq (vc-state buffer-file-name) 'conflict)
               (not (vc-find-conflict-markers)))
      ;; Conflict markers removed, mark resolved
      (when vc-resolve-conflicts
        (vc-call mark-resolved (list buffer-file-name))))))

;; Kill-buffer hook
(add-hook 'kill-buffer-hook 'vc-kill-buffer-hook)

;; After-revert hook
(add-hook 'after-revert-hook 'vc-after-revert)</code></pre>
<h3 data-number="15.7.5" id="mode-line-integration"><span class="header-section-number">15.7.5</span> 5. Mode-Line
Integration</h3>
<p>VC updates the mode line to show file status:</p>
<pre class="elisp"><code>;; Mode line format: "Git-main:abc123"
;;                    ^^^ ^^^^ ^^^^^^
;;                    |   |    +- revision/commit
;;                    |   +- branch (if applicable)
;;                    +- backend

(defun vc-mode-line (file)
  "Set `vc-mode' to display the VC status of FILE."
  (let* ((backend (vc-backend file))
         (state (vc-state file))
         (state-echo (cdr (assoc state vc-state-heuristic-alist)))
         (face (vc-mode-line-face state))
         (string (vc-call-backend backend 'mode-line-string file)))
    (setq vc-mode
          (concat " " (propertize string 'face face
                                  'help-echo state-echo)))))</code></pre>
<p><strong>State Faces</strong>:</p>
<pre class="elisp"><code>;; Location: /lisp/vc/vc-hooks.el:48-98

(defface vc-up-to-date-state ...)
(defface vc-needs-update-state ...)
(defface vc-locked-state ...)
(defface vc-locally-added-state ...)
(defface vc-conflict-state ...)
(defface vc-removed-state ...)
(defface vc-missing-state ...)
(defface vc-edited-state ...)
(defface vc-ignored-state ...)</code></pre>
<h2 data-number="15.8" id="implementation-deep-dives-1"><span class="header-section-number">15.8</span> Implementation Deep Dives</h2>
<h3 data-number="15.8.1" id="git-backend-vc-git.el"><span class="header-section-number">15.8.1</span> Git Backend (vc-git.el)</h3>
<p>The Git backend is the most feature-complete and serves as a
reference implementation:</p>
<p><strong>Key Implementation Details</strong>:</p>
<ol type="1">
<li><strong>Command Execution</strong>:</li>
</ol>
<pre class="elisp"><code>(defun vc-git--run-command-string (file &amp;rest args)
  "Run git command with ARGS on FILE, return output string."
  (let ((default-directory (or (vc-git-root file) default-directory)))
    (apply 'vc-git--run-command-string-1 nil args)))

(defun vc-git-command (buffer okstatus file-or-list &amp;rest flags)
  "Wrapper for `vc-do-command' that uses vc-git-program."
  (apply 'vc-do-command buffer okstatus vc-git-program
         file-or-list flags))</code></pre>
<ol start="2" type="1">
<li><strong>Literal Pathspecs</strong> (for special characters):</li>
</ol>
<pre class="elisp"><code>(defvar vc-git-use-literal-pathspecs t
  "Non-nil to treat pathspecs literally.
Good example: \"test[56].xx\"")

;; Sets GIT_LITERAL_PATHSPECS=1 environment variable</code></pre>
<ol start="3" type="1">
<li><strong>Dir-Status Implementation</strong>:</li>
</ol>
<pre class="elisp"><code>(defun vc-git-dir-status-files (dir files update-function)
  (let ((args '("status" "--porcelain" "-z" "--untracked-files")))
    ;; Add --ignored if supported
    (when (version&lt;= "1.7.6.3" (vc-git--program-version))
      (push "--ignored" args))
    ;; Execute asynchronously
    (vc-git-dir-status-goto-stage 'update-index dir files
                                  update-function)))</code></pre>
<ol start="4" type="1">
<li><strong>Stash Integration</strong>:</li>
</ol>
<pre class="elisp"><code>(defun vc-git-dir-extra-headers (dir)
  "Git-specific extra headers for vc-dir."
  (concat
   (propertize "Branch     : " 'face 'vc-dir-header)
   (propertize (vc-git--symbolic-ref dir) 'face 'vc-dir-header-value)
   "\n"
   (when (vc-git-stash-list)
     (concat
      (propertize "Stash      : " 'face 'vc-dir-header)
      (vc-git-stash-summary)
      "\n"))))</code></pre>
<h3 data-number="15.8.2" id="dispatcher-architecture-vc-dispatcher.el"><span class="header-section-number">15.8.2</span> Dispatcher Architecture
(vc-dispatcher.el)</h3>
<p>The dispatcher provides infrastructure for directory buffers and
command execution:</p>
<p><strong>EWOC-Based Display</strong>:</p>
<pre class="elisp"><code>;; EWOC = Emacs Widget for Object Collections
;; Efficiently manages large lists with per-item rendering

(defvar vc-ewoc nil
  "The ewoc data structure for the directory buffer.")

(defun vc-dir-refresh ()
  "Refresh the directory buffer."
  (ewoc-filter vc-ewoc 'identity)  ; Keep all items
  (vc-call-backend vc-dir-backend 'dir-status-files
                   default-directory nil
                   #'vc-dir-status-update-function))</code></pre>
<p><strong>Command Log Buffer</strong>:</p>
<pre class="elisp"><code>(defcustom vc-command-messages nil
  "If non-nil, display messages about running back-end commands.")

;; All backend commands log to *vc-cmd* buffer
;; Useful for debugging and understanding what VC is doing</code></pre>
<h3 data-number="15.8.3" id="diff-mode-features-diff-mode.el"><span class="header-section-number">15.8.3</span> Diff Mode Features
(diff-mode.el)</h3>
<p><strong>Hunk Navigation and Application</strong>:</p>
<pre class="elisp"><code>;; Find next/previous hunk
(defun diff-hunk-next (&amp;optional arg)
  "Move to next hunk."
  (interactive "p")
  (diff-hunk-move arg))

;; Apply hunk to source file
(defun diff-apply-hunk (&amp;optional reverse)
  "Apply current hunk to source file.
With prefix arg, reverse the hunk."
  (interactive "P")
  (let* ((hunk (diff-hunk-text))
         (file (diff-find-file-name))
         (buffer (find-file-noselect file)))
    (with-current-buffer buffer
      (goto-char (diff-find-hunk-line-number))
      (patch-buffer hunk reverse))))</code></pre>
<p><strong>Syntax Highlighting in Hunks</strong>:</p>
<pre class="elisp"><code>(defcustom diff-font-lock-syntax t
  "If non-nil, diff hunk font-lock includes source language syntax."
  :type '(choice (const :tag "Automatic" t)
                 (const :tag "Hunk-only" hunk-only)
                 (const :tag "Disabled" nil)))

;; Detects language from file extension
;; Applies appropriate major-mode font-lock
;; Overlays diff highlighting on top</code></pre>
<h3 data-number="15.8.4" id="merge-conflict-resolution-smerge-mode.el"><span class="header-section-number">15.8.4</span> Merge Conflict Resolution
(smerge-mode.el)</h3>
<p><strong>Conflict Detection and Parsing</strong>:</p>
<pre class="elisp"><code>(defconst smerge-begin-re "^&lt;&lt;&lt;&lt;&lt;&lt;&lt; \\(.*\\)\n"
  "Regexp matching the start of a conflict.")

(defconst smerge-end-re "^&gt;&gt;&gt;&gt;&gt;&gt;&gt; \\(.*\\)\n"
  "Regexp matching the end of a conflict.")

(defconst smerge-base-re "^||||||| \\(.*\\)\n"
  "Regexp matching the base-revision marker.")

(defconst smerge-lower-re "^=======\n"
  "Regexp matching the lower-revision marker.")

(defun smerge-find-conflict ()
  "Find next merge conflict."
  (re-search-forward smerge-begin-re nil t))</code></pre>
<p><strong>Resolution Commands</strong>:</p>
<pre class="elisp"><code>(defun smerge-keep-upper ()
  "Keep upper (mine) version."
  (smerge-keep-n 1))

(defun smerge-keep-lower ()
  "Keep lower (theirs) version."
  (smerge-keep-n 3))

(defun smerge-keep-all ()
  "Keep all versions."
  (smerge-keep-n 0))

(defun smerge-ediff ()
  "Invoke ediff to resolve conflict."
  (let* ((buf (current-buffer))
         (upper (smerge-get-upper))
         (lower (smerge-get-lower))
         (base (smerge-get-base)))
    (ediff-merge-buffers-with-ancestor upper lower base)))</code></pre>
<h2 data-number="15.9" id="user-interaction-patterns"><span class="header-section-number">15.9</span> User Interaction Patterns</h2>
<h3 data-number="15.9.1" id="context-aware-vc-next-action"><span class="header-section-number">15.9.1</span> Context-Aware
vc-next-action</h3>
<p>The <code>C-x v v</code> command (<code>vc-next-action</code>) adapts
based on file state:</p>
<pre class="elisp"><code>(defun vc-next-action (verbose)
  "Do the next logical VC operation on file(s).
State     | Action
----------|--------------------------------------------------
unregistered | Register file
added     | Commit (if repository supports staging)
edited    | Commit changes
up-to-date| Check out for editing (locking VCS) or do nothing
needs-update | Pull/update from repository
needs-merge | Merge with upstream
conflict  | Mark resolved"
  (interactive "P")
  (let ((state (vc-state file)))
    (pcase state
      ('unregistered (vc-register))
      ('edited (vc-checkin))
      ('needs-update (vc-update))
      ...)))</code></pre>
<h3 data-number="15.9.2" id="prefix-arguments"><span class="header-section-number">15.9.2</span> Prefix Arguments</h3>
<p>Many VC commands use prefix arguments for variants:</p>
<pre class="elisp"><code>C-x v v      ; Next action
C-u C-x v v  ; Next action with prompts

C-x v =      ; Diff working vs. repository
C-u C-x v =  ; Diff between two revisions

C-x v l      ; Short log
C-u C-x v l  ; Long log with full messages

C-x v ~      ; Retrieve specific revision</code></pre>
<h3 data-number="15.9.3" id="file-set-operations"><span class="header-section-number">15.9.3</span> File Set Operations</h3>
<p>Modern VC operates on filesets, not individual files:</p>
<pre class="elisp"><code>;; In vc-dir buffer:
;; - Mark files (m, u, M, U)
;; - Operate on marked files (v, =, l, etc.)

;; From dired:
;; - Mark files in dired
;; - VC commands operate on marked files

;; Example: Commit multiple files
(vc-checkin files comment)  ; files is a list</code></pre>
<h2 data-number="15.10" id="configuration-and-customization"><span class="header-section-number">15.10</span> Configuration and
Customization</h2>
<h3 data-number="15.10.1" id="key-customization-variables"><span class="header-section-number">15.10.1</span> Key Customization
Variables</h3>
<pre class="elisp"><code>;; Backend selection
(setq vc-handled-backends '(Git Hg SVN))

;; Suppress prompts for experienced users
(setq vc-suppress-confirm t)

;; Follow symlinks without asking
(setq vc-follow-symlinks t)

;; Display in mode line
(setq vc-display-status t)  ; or 'no-backend or nil

;; Git-specific
(setq vc-git-diff-switches '("-b" "-w"))  ; Ignore whitespace
(setq vc-git-annotate-switches "-w")       ; Blame ignores whitespace
(setq vc-git-log-switches '("--graph" "--decorate"))

;; Diff mode
(setq diff-refine 'font-lock)  ; Auto-refine hunks
(setq diff-font-lock-syntax t)  ; Syntax highlight in diffs

;; Auto-resolve conflicts when markers removed
(setq vc-resolve-conflicts t)
(setq vc-git-resolve-conflicts 'unstage-maybe)</code></pre>
<h3 data-number="15.10.2" id="backend-precedence"><span class="header-section-number">15.10.2</span> Backend Precedence</h3>
<p>When multiple backends could handle a file:</p>
<pre class="elisp"><code>;; First match wins
(setq vc-handled-backends '(Git Hg SVN))

;; For nested repositories, inner takes precedence
;; Example: Git repo inside SVN checkout
;; .git found first ‚Üí Git backend used</code></pre>
<h3 data-number="15.10.3" id="performance-tuning"><span class="header-section-number">15.10.3</span> Performance Tuning</h3>
<pre class="elisp"><code>;; Ignore slow network mounts
(setq vc-ignore-dir-regexp
      (concat vc-ignore-dir-regexp "\\|^/mnt/slow-nfs"))

;; Async operations (Git 2.28+)
(setq vc-git-async-checkins t)

;; Disable VC for certain backends
(setq vc-handled-backends (delq 'RCS vc-handled-backends))</code></pre>
<h2 data-number="15.11" id="advanced-features"><span class="header-section-number">15.11</span> Advanced Features</h2>
<h3 data-number="15.11.1" id="annotateblame"><span class="header-section-number">15.11.1</span> 1. Annotate/Blame</h3>
<pre class="elisp"><code>C-x v g  ‚Üí vc-annotate

;; Shows each line with:
;; - Revision/commit that last changed it
;; - Author
;; - Date
;; - Color-coded by age

;; Commands in annotate buffer:
n, p     ‚Üí Next/previous revision
d        ‚Üí Show diff for revision
f        ‚Üí Visit revision
a        ‚Üí Re-annotate at revision</code></pre>
<h3 data-number="15.11.2" id="region-history"><span class="header-section-number">15.11.2</span> 2. Region History</h3>
<pre class="elisp"><code>C-x v h  ‚Üí vc-region-history

;; Shows log and diffs for selected region
;; Tracks history through renames and line movements
;; Git uses git log -L</code></pre>
<h3 data-number="15.11.3" id="shelvestash"><span class="header-section-number">15.11.3</span> 3. Shelve/Stash</h3>
<pre class="elisp"><code>;; Git stash shown in vc-dir header
;; Can apply, pop, drop stashes from vc-dir</code></pre>
<h3 data-number="15.11.4" id="working-trees-git-worktrees"><span class="header-section-number">15.11.4</span> 4. Working Trees (Git
Worktrees)</h3>
<pre class="elisp"><code>;; List other working trees
(vc-call known-other-working-trees)

;; Add working tree
(vc-call add-working-tree directory)

;; Delete working tree
(vc-call delete-working-tree directory)</code></pre>
<h3 data-number="15.11.5" id="cherry-pick"><span class="header-section-number">15.11.5</span> 5. Cherry-Pick</h3>
<pre class="elisp"><code>;; In log-view:
C  ‚Üí log-view-cherry-pick

;; Applies commit to current branch
;; Uses backend-specific cherry-pick</code></pre>
<h3 data-number="15.11.6" id="retrieve-revisions"><span class="header-section-number">15.11.6</span> 6. Retrieve Revisions</h3>
<pre class="elisp"><code>C-x v ~  ‚Üí vc-retrieve-revision

;; Opens specific revision in new buffer
;; Read-only, not in working tree
;; Can diff, annotate, etc.</code></pre>
<h2 data-number="15.12" id="error-handling-and-edge-cases"><span class="header-section-number">15.12</span> Error Handling and Edge
Cases</h2>
<h3 data-number="15.12.1" id="missing-backend-executable"><span class="header-section-number">15.12.1</span> Missing Backend
Executable</h3>
<pre class="elisp"><code>;; vc-git-registered checks for git executable
(defun vc-git-registered (file)
  (and (vc-git-root file)
       (executable-find vc-git-program)
       ...))

;; Avoids noisy errors if VCS not installed</code></pre>
<h3 data-number="15.12.2" id="corrupted-repository"><span class="header-section-number">15.12.2</span> Corrupted Repository</h3>
<pre class="elisp"><code>;; Backends should handle gracefully
(with-demoted-errors "VC error: %S"
  (vc-git--run-command-string file "status"))

;; Returns nil if command fails
;; VC treats as unregistered</code></pre>
<h3 data-number="15.12.3" id="nested-repositories"><span class="header-section-number">15.12.3</span> Nested Repositories</h3>
<pre class="elisp"><code>;; Inner repository takes precedence
;; vc-find-root stops at first match

;; Example:
;; /project/.git        ‚Üê Git repo
;; /project/vendor/.hg  ‚Üê Hg subrepo
;; /project/vendor/file.c ‚Üí Handled by Hg</code></pre>
<h3 data-number="15.12.4" id="remote-files-tramp"><span class="header-section-number">15.12.4</span> Remote Files (TRAMP)</h3>
<pre class="elisp"><code>;; VC works over TRAMP
;; Backend commands executed on remote host
;; May be slow; caching especially important

;; Connection-local variables for remote Git
(connection-local-set-profile-variables
 'vc-git-connection-default-profile
 '((vc-git--program-version . nil)))</code></pre>
<h2 data-number="15.13" id="testing-and-debugging-1"><span class="header-section-number">15.13</span> Testing and Debugging</h2>
<h3 data-number="15.13.1" id="debugging-vc-operations"><span class="header-section-number">15.13.1</span> Debugging VC
Operations</h3>
<pre class="elisp"><code>;; Enable command logging
(setq vc-command-messages t)

;; Check *vc-cmd* buffer for backend commands
;; Shows exact git/hg/svn commands executed

;; Trace backend calls
(trace-function 'vc-call-backend)
(trace-function 'vc-git-state)

;; Check file properties
(vc-file-getprop "file.el" 'vc-backend)  ; =&gt; Git
(vc-file-getprop "file.el" 'vc-state)     ; =&gt; edited</code></pre>
<h3 data-number="15.13.2" id="test-files"><span class="header-section-number">15.13.2</span> Test Files</h3>
<pre class="elisp"><code>;; VC has extensive test suite
;; /test/lisp/vc/

;; Test backends:
;; - vc-tests.el: Generic backend tests
;; - vc-git-tests.el: Git-specific tests
;; - ediff-*-tests.el: Ediff test suite</code></pre>
<h2 data-number="15.14" id="migration-and-compatibility"><span class="header-section-number">15.14</span> Migration and
Compatibility</h2>
<h3 data-number="15.14.1" id="supporting-new-vcs"><span class="header-section-number">15.14.1</span> Supporting New VCS</h3>
<p>To add support for a new VCS named ‚ÄúFOO‚Äù:</p>
<ol type="1">
<li><strong>Create <code>/lisp/vc/vc-foo.el</code></strong>:</li>
</ol>
<pre class="elisp"><code>;;; vc-foo.el --- VC backend for FOO

(require 'vc-dispatcher)

;; Backend properties
(defun vc-foo-revision-granularity () 'repository)
(defun vc-foo-checkout-model (_files) 'implicit)

;; State-querying
;;;###autoload
(defun vc-foo-registered (file)
  (if (vc-find-root file ".foo")
      (progn (load "vc-foo" nil t)
             (vc-foo-registered file))))

(defun vc-foo-registered (file)
  "Real implementation..."
  (vc-find-root file ".foo"))

(defun vc-foo-state (file)
  "Return state..."
  ...)

;; State-changing
(defun vc-foo-register (files &amp;optional comment) ...)
(defun vc-foo-checkin (files comment &amp;optional rev) ...)

;; History
(defun vc-foo-print-log (files buffer &amp;optional shortlog start-revision limit) ...)
(defun vc-foo-diff (files &amp;optional rev1 rev2 buffer async) ...)

(provide 'vc-foo)</code></pre>
<ol start="2" type="1">
<li><strong>Add to <code>vc-handled-backends</code></strong>:</li>
</ol>
<pre class="elisp"><code>(add-to-list 'vc-handled-backends 'FOO)</code></pre>
<ol start="3" type="1">
<li><p><strong>Implement mandatory functions</strong> (marked with
<code>*</code> in API contract)</p></li>
<li><p><strong>Implement optional functions</strong> as needed</p></li>
</ol>
<h3 data-number="15.14.2" id="backward-compatibility-1"><span class="header-section-number">15.14.2</span> Backward Compatibility</h3>
<p>VC maintains compatibility with older backend implementations:</p>
<pre class="elisp"><code>;; Default implementations for optional functions
(defun vc-default-find-ignore-file (backend file)
  "Default implementation finds .gitignore-style file."
  ...)

;; Fallback for missing functions
(vc-call-backend backend 'function args)
;; ‚Üí vc-BACKEND-function if exists
;; ‚Üí vc-default-function otherwise
;; ‚Üí error if neither exists</code></pre>
<h2 data-number="15.15" id="performance-characteristics-3"><span class="header-section-number">15.15</span> Performance
Characteristics</h2>
<h3 data-number="15.15.1" id="backend-speed-comparison"><span class="header-section-number">15.15.1</span> Backend Speed
Comparison</h3>
<table>
<colgroup>
<col style="width: 17%"/>
<col style="width: 25%"/>
<col style="width: 23%"/>
<col style="width: 9%"/>
<col style="width: 11%"/>
<col style="width: 13%"/>
</colgroup>
<thead>
<tr>
<th>Backend</th>
<th>State Query</th>
<th>Dir Status</th>
<th>Log</th>
<th>Diff</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td>Git</td>
<td>Fast</td>
<td>Fast</td>
<td>Fast</td>
<td>Fast</td>
<td>All operations local</td>
</tr>
<tr>
<td>Hg</td>
<td>Fast</td>
<td>Fast</td>
<td>Fast</td>
<td>Fast</td>
<td>All operations local</td>
</tr>
<tr>
<td>SVN</td>
<td>Medium</td>
<td>Slow</td>
<td>Medium</td>
<td>Medium</td>
<td>Network operations</td>
</tr>
<tr>
<td>Bzr</td>
<td>Medium</td>
<td>Medium</td>
<td>Medium</td>
<td>Medium</td>
<td>Hybrid model</td>
</tr>
<tr>
<td>CVS</td>
<td>Slow</td>
<td>Very Slow</td>
<td>Slow</td>
<td>Slow</td>
<td>File-by-file, network</td>
</tr>
<tr>
<td>RCS</td>
<td>Fast</td>
<td>Medium</td>
<td>Fast</td>
<td>Fast</td>
<td>Local, file-based</td>
</tr>
</tbody>
</table>
<h3 data-number="15.15.2" id="optimization-strategies-1"><span class="header-section-number">15.15.2</span> Optimization
Strategies</h3>
<ol type="1">
<li><strong>Property Caching</strong>: Avoid redundant state
queries</li>
<li><strong>Async Status</strong>: Don‚Äôt block on directory
scanning</li>
<li><strong>Lazy Loading</strong>: Backends loaded only when needed</li>
<li><strong>Root Caching</strong>: Remember repository roots</li>
<li><strong>Batch Operations</strong>: Group file operations when
possible</li>
</ol>
<h2 data-number="15.16" id="future-directions"><span class="header-section-number">15.16</span> Future Directions</h2>
<p>From <code>/lisp/vc/vc.el:820-849</code> (Todo section):</p>
<h3 data-number="15.16.1" id="planned-features"><span class="header-section-number">15.16.1</span> Planned Features</h3>
<pre class="elisp"><code>;; New Primitives:
;; - uncommit: undo last checkin, leave changes in place
;; - deal with push operations

;; Primitives that need changing:
;; - vc-update/vc-merge should work on whole repository
;; - Make sure *vc-dir* buffer updated after operations

;; Improved branch and tag handling:
;; - Generic mechanism for branch name display in mode-line
;; - Ability to list tags and branches</code></pre>
<h3 data-number="15.16.2" id="modern-vcs-trends"><span class="header-section-number">15.16.2</span> Modern VCS Trends</h3>
<p>Recent developments requiring VC evolution:</p>
<ol type="1">
<li><strong>Monorepo Support</strong>: Handle very large
repositories</li>
<li><strong>Sparse Checkouts</strong>: Git sparse-checkout, Hg
narrow</li>
<li><strong>Cloud Hosting</strong>: GitHub, GitLab, Bitbucket
integration</li>
<li><strong>Code Review</strong>: Pull request workflows</li>
<li><strong>CI/CD Integration</strong>: Show build status in VC
buffers</li>
</ol>
<h2 data-number="15.17" id="conclusion-4"><span class="header-section-number">15.17</span> Conclusion</h2>
<p>The Emacs VC system demonstrates exceptional software
architecture:</p>
<p><strong>Key Strengths</strong>: 1. <strong>Clean
Abstraction</strong>: Backend dispatch system is elegant and extensible
2. <strong>Comprehensive</strong>: Supports 8+ VCS with unified
interface 3. <strong>Performance</strong>: Property caching and async
operations keep it responsive 4. <strong>Integration</strong>: Deep
hooks into Emacs (find-file, save, mode-line) 5.
<strong>Maturity</strong>: 30+ years of refinement shows in edge case
handling</p>
<p><strong>Design Lessons</strong>: 1. <strong>Dispatch
Pattern</strong>: <code>vc-call</code> macro demonstrates dynamic
dispatch in Lisp 2. <strong>Caching Strategy</strong>: Two-level cache
(file properties + backend cache) 3. <strong>Async Design</strong>:
Callback-based async predates modern async/await 4. <strong>Hook
System</strong>: Multiple integration points for seamless UX 5.
<strong>Graceful Degradation</strong>: Missing backends/features handled
cleanly</p>
<p><strong>Code Organization</strong>: - <strong>39 files</strong>,
<strong>52,964 lines</strong> well-organized by concern - Clear
separation: core ‚Üí abstraction ‚Üí backends ‚Üí tools - Consistent naming:
<code>vc-BACKEND-FUNCTION</code> convention - Extensive documentation in
function contracts</p>
<p>The VC system remains one of Emacs‚Äôs most sophisticated subsystems,
providing a blueprint for building extensible, backend-agnostic
interfaces in Lisp.</p>
<h2 data-number="15.18" id="references-2"><span class="header-section-number">15.18</span> References</h2>
<h3 data-number="15.18.1" id="primary-source-files"><span class="header-section-number">15.18.1</span> Primary Source Files</h3>
<ul>
<li><code>/lisp/vc/vc.el</code> - Main interface and backend API
contract (lines 108-755)</li>
<li><code>/lisp/vc/vc-hooks.el</code> - Initialization and property
system</li>
<li><code>/lisp/vc/vc-dispatcher.el</code> - Async execution
framework</li>
<li><code>/lisp/vc/vc-git.el</code> - Reference backend
implementation</li>
</ul>
<h3 data-number="15.18.2" id="related-documentation"><span class="header-section-number">15.18.2</span> Related Documentation</h3>
<ul>
<li>Info manual: <code>(emacs) Version Control</code></li>
<li>Backend API: <code>/lisp/vc/vc.el</code> commentary section</li>
<li>Ediff manual: <code>(ediff) Top</code></li>
</ul>
<h3 data-number="15.18.3" id="key-data-structures"><span class="header-section-number">15.18.3</span> Key Data Structures</h3>
<ul>
<li>File property obarray: <code>vc-file-prop-obarray</code></li>
<li>Backend function cache:
<code>(get 'BACKEND 'vc-functions)</code></li>
<li>Dir fileinfo: <code>vc-dir-fileinfo</code> struct (ewoc
elements)</li>
</ul>
<h3 data-number="15.18.4" id="important-variables-1"><span class="header-section-number">15.18.4</span> Important Variables</h3>
<ul>
<li><code>vc-handled-backends</code> - Registered backends</li>
<li><code>vc-state</code> - File state symbols</li>
<li><code>vc-mode</code> - Mode line string</li>
<li><code>vc-directory-exclusion-list</code> - Ignored directories</li>
</ul>
<h1 data-number="16" id="cedet-collection-of-emacs-development-environment-tools"><span class="header-section-number">16</span> CEDET: Collection of Emacs
Development Environment Tools</h1>
<p><strong>Location:</strong> <code>/lisp/cedet/</code>
<strong>Files:</strong> 143 files, 70,084 lines of code
<strong>Author:</strong> Eric M. Ludlam (primary)
<strong>Version:</strong> 2.0 (integrated into Emacs core)</p>
<h2 data-number="16.1" id="executive-summary"><span class="header-section-number">16.1</span> Executive Summary</h2>
<p>CEDET is a comprehensive development environment toolkit that
provides infrastructure for parsing, analyzing, and manipulating source
code. It consists of three major components: <strong>Semantic</strong>
(parser framework), <strong>EDE</strong> (project management), and
<strong>SRecode</strong> (code generation). While historically
important, CEDET has been largely superseded by modern Language Server
Protocol (LSP) implementations via Eglot for many use cases, though it
remains valuable for languages without LSP servers and for understanding
Emacs‚Äôs parser infrastructure.</p>
<h2 data-number="16.2" id="major-components-overview"><span class="header-section-number">16.2</span> 1. Major Components
Overview</h2>
<h3 data-number="16.2.1" id="architecture-diagram"><span class="header-section-number">16.2.1</span> Architecture Diagram</h3>
<pre><code>‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                         CEDET 2.0                            ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                               ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚îÇ
‚îÇ  ‚îÇ  SEMANTIC   ‚îÇ  ‚îÇ     EDE     ‚îÇ  ‚îÇ   SRECODE   ‚îÇ         ‚îÇ
‚îÇ  ‚îÇ   (Parser)  ‚îÇ  ‚îÇ  (Projects) ‚îÇ  ‚îÇ (Templates) ‚îÇ         ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îÇ
‚îÇ         ‚îÇ                ‚îÇ                ‚îÇ                  ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê          ‚îÇ
‚îÇ  ‚îÇ         MODE-LOCAL (infrastructure)            ‚îÇ          ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò          ‚îÇ
‚îÇ                                                               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò</code></pre>
<h3 data-number="16.2.2" id="component-breakdown"><span class="header-section-number">16.2.2</span> Component Breakdown</h3>
<table>
<colgroup>
<col style="width: 26%"/>
<col style="width: 17%"/>
<col style="width: 21%"/>
<col style="width: 34%"/>
</colgroup>
<thead>
<tr>
<th>Component</th>
<th>Files</th>
<th>Purpose</th>
<th>Key Features</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Semantic</strong></td>
<td>74</td>
<td>Code parsing &amp; analysis</td>
<td>Parser generators (Bovine/Wisent), tag database, smart
completion</td>
</tr>
<tr>
<td><strong>EDE</strong></td>
<td>36</td>
<td>Project management</td>
<td>Build system integration, multi-language support, compilation</td>
</tr>
<tr>
<td><strong>SRecode</strong></td>
<td>23</td>
<td>Code generation</td>
<td>Template system, context-aware insertion</td>
</tr>
<tr>
<td><strong>Common</strong></td>
<td>10</td>
<td>Shared infrastructure</td>
<td>mode-local, data-debug, utilities</td>
</tr>
</tbody>
</table>
<h2 data-number="16.3" id="semantic-parser-framework-and-code-analysis"><span class="header-section-number">16.3</span> 2. Semantic: Parser Framework
and Code Analysis</h2>
<h3 data-number="16.3.1" id="the-tag-system-heart-of-semantic"><span class="header-section-number">16.3.1</span> 2.1 The Tag System: Heart of
Semantic</h3>
<p>Semantic represents all parsed code as <strong>tags</strong> -
structured data about code symbols. A tag is a 5-element list:</p>
<pre class="elisp"><code>;; From semantic/tag.el (lines 69-91)
;; Tag Structure: (NAME CLASS ATTRIBUTES PROPERTIES OVERLAY)
;;
;; Where:
;;   - NAME: string representing the tag name
;;   - CLASS: symbol like 'type, 'function, 'variable
;;   - ATTRIBUTES: public plist of language-specific data
;;   - PROPERTIES: private plist for internal use
;;   - OVERLAY: location data (overlay or [START END] vector)

(defsubst semantic-tag-name (tag)
  "Return the name of TAG."
  (car tag))

(defsubst semantic-tag-class (tag)
  "Return the class of TAG (e.g., 'function, 'variable, 'type)."
  (nth 1 tag))

(defsubst semantic-tag-attributes (tag)
  "Return the list of public attributes of TAG."
  (nth 2 tag))

(defsubst semantic-tag-properties (tag)
  "Return the list of private properties of TAG."
  (nth 3 tag))

(defsubst semantic-tag-overlay (tag)
  "Return the OVERLAY part of TAG."
  (nth 4 tag))</code></pre>
<p><strong>Example Tag Creation:</strong></p>
<pre class="elisp"><code>;; Creating a tag for: int add(int a, int b);
(semantic-tag
 "add"                          ; name
 'function                       ; class
 '(:arguments (("a" variable "int")
               ("b" variable "int"))
   :type "int")                 ; attributes
 nil                            ; properties (internal)
 (vector 100 150))              ; position [start end]</code></pre>
<h3 data-number="16.3.2" id="parser-infrastructure-bovine-vs.-wisent"><span class="header-section-number">16.3.2</span> 2.2 Parser Infrastructure:
Bovine vs.¬†Wisent</h3>
<p>Semantic supports two parser generator approaches:</p>
<h4 data-number="16.3.2.1" id="bovine-parser-ll---left-to-right-leftmost"><span class="header-section-number">16.3.2.1</span> Bovine Parser (LL -
Left-to-right, Leftmost)</h4>
<pre class="elisp"><code>;; From semantic/bovine.el (lines 1-34)
;; Semantic 1.x uses an LL parser named the "bovinator". This parser
;; had several conveniences which made parsing tags out of languages
;; with list characters easy. This parser lives on as one of many
;; available parsers for semantic the tool.
;;
;; Use when the language is simple, such as makefiles or other
;; data-declarative languages.

(defun semantic-bovinate-stream (stream &amp;optional nonterminal)
  "Bovinate STREAM, starting at the first NONTERMINAL rule.
Use `bovine-toplevel' if NONTERMINAL is not provided.
This is the core routine for converting a stream into a table.
Return the list (STREAM SEMANTIC-STREAM) where STREAM are those
elements of STREAM that have not been used."
  ;; Core parsing loop...
  )</code></pre>
<p><strong>Best for:</strong> Makefiles, simple declarative languages,
configuration files</p>
<h4 data-number="16.3.2.2" id="wisent-parser-lalr---look-ahead-lr"><span class="header-section-number">16.3.2.2</span> Wisent Parser (LALR -
Look-Ahead LR)</h4>
<pre class="elisp"><code>;; From semantic/wisent.el (lines 1-32)
;; Here are functions necessary to use the Wisent LALR parser from
;; Semantic environment.

(defvar wisent-lex-istream nil
  "Input stream of `semantic-lex' syntactic tokens.")

(define-wisent-lexer wisent-lex
  "Return the next available lexical token in Wisent's form.
The variable `wisent-lex-istream' contains the list of lexical tokens
produced by `semantic-lex'. Pop the next token available and convert
it to a form suitable for the Wisent's parser."
  (let* ((tk (car wisent-lex-istream)))
    (setq wisent-lex-istream (cdr wisent-lex-istream))
    (cons (semantic-lex-token-class tk)
          (cons (semantic-lex-token-text tk)
                (semantic-lex-token-bounds tk)))))</code></pre>
<p><strong>Best for:</strong> Complex languages with context-dependent
grammars (C++, Java, Python)</p>
<h3 data-number="16.3.3" id="language-parsers"><span class="header-section-number">16.3.3</span> 2.3 Language Parsers</h3>
<p>Semantic includes parsers for multiple languages:</p>
<p><strong>Bovine-based parsers:</strong> - C
(<code>semantic/bovine/c.el</code>) - Emacs Lisp
(<code>semantic/bovine/el.el</code>) - Make
(<code>semantic/bovine/make.el</code>) - Scheme
(<code>semantic/bovine/scm.el</code>)</p>
<p><strong>Wisent-based parsers:</strong> - Java
(<code>semantic/wisent/java-tags.el</code>) - JavaScript
(<code>semantic/wisent/javascript.el</code>) - Python
(<code>semantic/wisent/python.el</code>)</p>
<p><strong>Parser Setup Example:</strong></p>
<pre class="elisp"><code>;; From semantic.el (lines 234-257)
(defcustom semantic-new-buffer-setup-functions
  '((c-mode . semantic-default-c-setup)
    (c++-mode . semantic-default-c-setup)
    (html-mode . semantic-default-html-setup)
    (java-mode . wisent-java-default-setup)
    (js-mode . wisent-javascript-setup-parser)
    (python-mode . wisent-python-default-setup)
    (scheme-mode . semantic-default-scheme-setup)
    (srecode-template-mode . srecode-template-setup-parser)
    (texinfo-mode . semantic-default-texi-setup)
    (makefile-automake-mode . semantic-default-make-setup)
    (makefile-gmake-mode . semantic-default-make-setup)
    ;; ... more modes
    )
  "Alist of functions to call to set up Semantic parsing in the buffer.")</code></pre>
<h3 data-number="16.3.4" id="the-semantic-database-semanticdb"><span class="header-section-number">16.3.4</span> 2.4 The Semantic Database
(SemanticDB)</h3>
<p>SemanticDB caches parsed tags to disk for fast access across
sessions:</p>
<pre class="elisp"><code>;; From semantic/db.el (lines 1-112)
;; Maintain a database of tags for a group of files and enable
;; queries into the database.
;;
;; By default, assume one database per directory.

(defclass semanticdb-abstract-table ()
  ((parent-db :documentation "Database Object containing this table.")
   (major-mode :initarg :major-mode
               :documentation "Major mode this table belongs to.")
   (tags :initarg :tags
         :accessor semanticdb-get-tags
         :documentation "The tags belonging to this table.")
   (db-refs :initform nil
            :documentation "List of `semanticdb-table' objects referring to this one.")
   (index :type semanticdb-abstract-search-index
          :documentation "The search index for fast lookups.")
   (cache :type list
          :documentation "List of cache information for tools."))
  "A simple table for semantic tags.")</code></pre>
<p><strong>Database Features:</strong> 1. <strong>Persistent
storage</strong>: Tags saved to <code>~/.emacs.d/semanticdb/</code> 2.
<strong>Cross-file references</strong>: Track dependencies between files
3. <strong>Fast symbol lookup</strong>: Indexed search across entire
codebase 4. <strong>Lazy loading</strong>: Load tag data only when
needed</p>
<h3 data-number="16.3.5" id="code-analysis-and-completion"><span class="header-section-number">16.3.5</span> 2.5 Code Analysis and
Completion</h3>
<pre class="elisp"><code>;; From semantic/analyze.el (lines 1-124)
;; Semantic, as a tool, provides a nice list of searchable tags.
;; That information can provide some very accurate answers if the current
;; context of a position is known.

(defclass semantic-analyze-context ()
  ((bounds :initarg :bounds
           :documentation "The bounds of this context.")
   (prefix :initarg :prefix
           :documentation "List of tags defining local text.
This can be nil, or a list where the last element can be a string
representing text that may be incomplete.")
   (prefixclass :initarg :prefixclass
                :documentation "Tag classes expected at this context.")
   (prefixtypes :initarg :prefixtypes
                :documentation "List of tags defining types for :prefix.")
   (scope :initarg :scope
          :type semantic-scope-cache
          :documentation "List of tags available in scopetype.")
   (buffer :initarg :buffer
           :type buffer)
   (errors :initarg :errors))
  "Base analysis data for any context.")</code></pre>
<p><strong>Analysis Types:</strong></p>
<ol type="1">
<li><strong>Context Analysis</strong>
(<code>semantic-analyze-context</code>):
<ul>
<li>Determines what‚Äôs valid at point</li>
<li>Type inference</li>
<li>Scope resolution</li>
</ul></li>
<li><strong>Completion Analysis</strong>
(<code>semantic-analyze-completion</code>):
<ul>
<li>Smart completion based on context</li>
<li>Type-aware suggestions</li>
<li>Local variable tracking</li>
</ul></li>
<li><strong>Reference Analysis</strong> (<code>semantic-symref</code>):
<ul>
<li>Find symbol references</li>
<li>Call hierarchy</li>
<li>Cross-file navigation</li>
</ul></li>
</ol>
<h2 data-number="16.4" id="ede-emacs-development-environment-project-management"><span class="header-section-number">16.4</span> 3. EDE: Emacs Development
Environment (Project Management)</h2>
<h3 data-number="16.4.1" id="project-architecture"><span class="header-section-number">16.4.1</span> 3.1 Project
Architecture</h3>
<p>EDE provides object-oriented project management:</p>
<pre class="elisp"><code>;; From ede.el (lines 1-82)
;; EDE is the top level Lisp interface to a project management scheme
;; for Emacs. Emacs does many things well, including editing,
;; building, and debugging. Folks migrating from other IDEs don't
;; seem to think this qualifies, however, because they still have to
;; write the makefiles, and specify parameters to programs.
;;
;; This EDE mode will attempt to link these diverse programs together
;; into a comprehensive single interface, instead of a bunch of
;; different ones.

(defvar-local ede-object-root-project nil
  "The current buffer's current root project.")

(defvar-local ede-object-project nil
  "The current buffer's current project at that level.")

(defvar-local ede-object nil
  "The current buffer's target object.")</code></pre>
<p><strong>Project Hierarchy:</strong></p>
<pre><code>Project Root (ede-project)
  ‚îú‚îÄ‚îÄ Subproject 1
  ‚îÇ     ‚îú‚îÄ‚îÄ Target A (ede-target)
  ‚îÇ     ‚îÇ     ‚îú‚îÄ‚îÄ file1.c
  ‚îÇ     ‚îÇ     ‚îî‚îÄ‚îÄ file2.c
  ‚îÇ     ‚îî‚îÄ‚îÄ Target B
  ‚îÇ           ‚îî‚îÄ‚îÄ file3.c
  ‚îî‚îÄ‚îÄ Subproject 2
        ‚îî‚îÄ‚îÄ Target C
              ‚îú‚îÄ‚îÄ file4.c
              ‚îî‚îÄ‚îÄ file5.c</code></pre>
<h3 data-number="16.4.2" id="project-types"><span class="header-section-number">16.4.2</span> 3.2 Project Types</h3>
<p>EDE supports multiple project types through autodetection:</p>
<table>
<colgroup>
<col style="width: 36%"/>
<col style="width: 36%"/>
<col style="width: 27%"/>
</colgroup>
<thead>
<tr>
<th>Project Type</th>
<th>File Marker</th>
<th>Use Case</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>ede-proj</strong></td>
<td><code>Project.ede</code></td>
<td>EDE native projects with Makefile generation</td>
</tr>
<tr>
<td><strong>ede-cpp-root</strong></td>
<td><code>.git</code>, <code>.svn</code></td>
<td>C++ projects with existing build system</td>
</tr>
<tr>
<td><strong>ede-linux</strong></td>
<td><code>Kconfig</code>, <code>Makefile</code></td>
<td>Linux kernel source tree</td>
</tr>
<tr>
<td><strong>ede-maven</strong></td>
<td><code>pom.xml</code></td>
<td>Java Maven projects</td>
</tr>
<tr>
<td><strong>ede-emacs</strong></td>
<td><code>configure.ac</code></td>
<td>Emacs itself (special handling)</td>
</tr>
<tr>
<td><strong>ede-simple</strong></td>
<td>Auto-detect</td>
<td>Generic projects without specific structure</td>
</tr>
</tbody>
</table>
<p><strong>Project Class Hierarchy:</strong></p>
<pre class="elisp"><code>;; From ede/proj.el (lines 89-195)
(defclass ede-proj-target (ede-target)
  ((auxsource :initarg :auxsource
              :type list
              :documentation "Auxiliary source files.")
   (dirty :initform nil
          :type boolean)
   (compiler :initarg :compiler
             :type (or null symbol))
   (linker :initarg :linker
           :type (or null symbol)))
  "Abstract class for ede-proj targets.")

(defclass ede-proj-target-makefile (ede-proj-target)
  ((makefile :initarg :makefile
             :initform "Makefile"
             :type string)
   (partofall :initarg :partofall
              :initform t
              :type boolean)
   (configuration-variables :initarg :configuration-variables
                            :type list)
   (rules :initarg :rules
          :type (list-of ede-makefile-rule)))
  "Abstract class for Makefile based targets.")</code></pre>
<h3 data-number="16.4.3" id="build-system-integration"><span class="header-section-number">16.4.3</span> 3.3 Build System
Integration</h3>
<pre class="elisp"><code>;; Compilation commands from ede.el (lines 932-967)
(defun ede-compile-project ()
  "Compile the current project."
  (interactive)
  (let ((cp (ede-current-project)))
    (while (ede-parent-project cp)
      (setq cp (ede-parent-project cp)))
    (let ((ede-object cp))
      (ede-invoke-method 'project-compile-project))))

(defun ede-compile-target ()
  "Compile the current buffer's associated target."
  (interactive)
  (ede-invoke-method 'project-compile-target))

(defun ede-debug-target ()
  "Debug the current buffer's associated target."
  (interactive)
  (ede-invoke-method 'project-debug-target))

(defun ede-run-target ()
  "Run the current buffer's associated target."
  (interactive)
  (ede-invoke-method 'project-run-target'))</code></pre>
<p><strong>Key Bindings:</strong></p>
<ul>
<li><code>C-c . C</code> - Compile project</li>
<li><code>C-c . c</code> - Compile current target</li>
<li><code>C-c . D</code> - Debug target</li>
<li><code>C-c . R</code> - Run target</li>
<li><code>C-c . t</code> - Create new target</li>
<li><code>C-c . a</code> - Add file to target</li>
</ul>
<h3 data-number="16.4.4" id="project-configuration"><span class="header-section-number">16.4.4</span> 3.4 Project
Configuration</h3>
<pre class="elisp"><code>;; Example Project.ede file
(ede-proj-project "MyProject"
  :name "MyProject"
  :file "Project.ede"
  :targets (list
    (ede-proj-target-makefile-program "main"
      :name "main"
      :path ""
      :source '("main.c" "utils.c")
      :compiler 'cc-compiler
      :linker 'ld-linker)
    (ede-proj-target-makefile-shared-object "libmylib"
      :name "libmylib"
      :path "lib"
      :source '("mylib.c"))))</code></pre>
<h2 data-number="16.5" id="srecode-semantic-recoder-template-system"><span class="header-section-number">16.5</span> 4. SRecode: Semantic Recoder
(Template System)</h2>
<h3 data-number="16.5.1" id="template-language"><span class="header-section-number">16.5.1</span> 4.1 Template Language</h3>
<p>SRecode provides a powerful template system for code generation:</p>
<pre class="elisp"><code>;; From srecode/template.el (lines 1-69)
;; Semantic does the job of converting source code into useful tag
;; information. The set of `semantic-format-tag' functions has one
;; function that will create a prototype of a tag, which has severe
;; issues of complexity (in the format tag file itself) and inaccuracy
;; (for the purpose of C++ code.)
;;
;; Contemplation of the simplistic problem within the scope of
;; semantic showed that the solution was more complex than could
;; possibly be handled in semantic/format.el. Semantic Recoder, or
;; srecode is a rich API for generating code out of semantic tags, or
;; recoding the tags.</code></pre>
<h3 data-number="16.5.2" id="template-files"><span class="header-section-number">16.5.2</span> 4.2 Template Files</h3>
<p>SRecode templates use <code>.srt</code> files with special
syntax:</p>
<pre><code>;; Example from /etc/srecode/c.srt

template function :blank
----
{{?TYPE}} {{NAME}}({{#ARGS}}{{TYPE}} {{NAME}}{{#NOTLAST}}, {{/NOTLAST}}{{/ARGS}})
{
  {{^}}
}
----

template class :blank
----
class {{NAME}} {
public:
  {{NAME}}();
  virtual ~{{NAME}}();

  {{^}}
};
----</code></pre>
<p><strong>Template Directory Structure:</strong></p>
<div class="sourceCode" id="cb561"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb561-1"><a aria-hidden="true" href="#cb561-1" tabindex="-1"></a><span class="ex">$</span> ls <span class="at">-la</span> /home/user/emacs/etc/srecode/</span>
<span id="cb561-2"><a aria-hidden="true" href="#cb561-2" tabindex="-1"></a><span class="ex">c.srt</span>              <span class="co"># C templates</span></span>
<span id="cb561-3"><a aria-hidden="true" href="#cb561-3" tabindex="-1"></a><span class="ex">cpp.srt</span>            <span class="co"># C++ templates</span></span>
<span id="cb561-4"><a aria-hidden="true" href="#cb561-4" tabindex="-1"></a><span class="ex">default.srt</span>        <span class="co"># Language-agnostic</span></span>
<span id="cb561-5"><a aria-hidden="true" href="#cb561-5" tabindex="-1"></a><span class="ex">doc-cpp.srt</span>        <span class="co"># C++ documentation</span></span>
<span id="cb561-6"><a aria-hidden="true" href="#cb561-6" tabindex="-1"></a><span class="ex">doc-default.srt</span>    <span class="co"># Default documentation</span></span>
<span id="cb561-7"><a aria-hidden="true" href="#cb561-7" tabindex="-1"></a><span class="ex">doc-java.srt</span>       <span class="co"># Java documentation</span></span>
<span id="cb561-8"><a aria-hidden="true" href="#cb561-8" tabindex="-1"></a><span class="ex">ede-autoconf.srt</span>   <span class="co"># Autoconf templates</span></span>
<span id="cb561-9"><a aria-hidden="true" href="#cb561-9" tabindex="-1"></a><span class="ex">ede-make.srt</span>       <span class="co"># Makefile templates</span></span>
<span id="cb561-10"><a aria-hidden="true" href="#cb561-10" tabindex="-1"></a><span class="ex">el.srt</span>             <span class="co"># Emacs Lisp templates</span></span>
<span id="cb561-11"><a aria-hidden="true" href="#cb561-11" tabindex="-1"></a><span class="ex">getset-cpp.srt</span>     <span class="co"># C++ getter/setter</span></span>
<span id="cb561-12"><a aria-hidden="true" href="#cb561-12" tabindex="-1"></a><span class="ex">java.srt</span>           <span class="co"># Java templates</span></span>
<span id="cb561-13"><a aria-hidden="true" href="#cb561-13" tabindex="-1"></a><span class="ex">make.srt</span>           <span class="co"># Make templates</span></span>
<span id="cb561-14"><a aria-hidden="true" href="#cb561-14" tabindex="-1"></a><span class="ex">template.srt</span>       <span class="co"># Template meta-templates</span></span>
<span id="cb561-15"><a aria-hidden="true" href="#cb561-15" tabindex="-1"></a><span class="ex">texi.srt</span>           <span class="co"># Texinfo templates</span></span>
<span id="cb561-16"><a aria-hidden="true" href="#cb561-16" tabindex="-1"></a><span class="ex">wisent.srt</span>         <span class="co"># Wisent grammar templates</span></span></code></pre></div>
<h3 data-number="16.5.3" id="template-variables-and-context"><span class="header-section-number">16.5.3</span> 4.3 Template Variables and
Context</h3>
<pre class="elisp"><code>;; Template variables come from multiple sources:
;; 1. Current semantic tag (function, class, etc.)
;; 2. User input (prompts)
;; 3. Dictionary context (project, file, etc.)

;; Dictionary structure:
;; {{NAME}}        - Simple variable insertion
;; {{?NAME}}       - Optional (empty string if unset)
;; {{#NAME}}...{{/NAME}}  - Section (loop if list)
;; {{#NOTLAST}}...{{/NOTLAST}} - Conditional
;; {{^}}           - Cursor position after insertion</code></pre>
<h3 data-number="16.5.4" id="template-maps"><span class="header-section-number">16.5.4</span> 4.4 Template Maps</h3>
<pre class="elisp"><code>;; From srecode/map.el (lines 1-96)
;; Read template files, and build a map of where they can be found.
;; Save the map to disk, and refer to it when bootstrapping a new
;; Emacs session with srecode.

(defclass srecode-map (eieio-persistent)
  ((fileheaderline :initform ";; SRECODE TEMPLATE MAP")
   (files :initarg :files
          :initform nil
          :type list
          :documentation "An alist of files and the major-mode that they cover.")
   (apps :initarg :apps
         :initform nil
         :type list
         :documentation "An alist of applications."))
  "A map of srecode templates.")

(cl-defmethod srecode-map-entries-for-mode ((map srecode-map) mode)
  "Return the entries in MAP for major MODE."
  (let ((ans nil))
    (dolist (f (oref map files))
      (when (provided-mode-derived-p mode (cdr f))
        (setq ans (cons f ans))))
    ans))</code></pre>
<h2 data-number="16.6" id="integration-and-architecture"><span class="header-section-number">16.6</span> 5. Integration and
Architecture</h2>
<h3 data-number="16.6.1" id="mode-local-infrastructure"><span class="header-section-number">16.6.1</span> 5.1 Mode-Local
Infrastructure</h3>
<p>CEDET uses a sophisticated mode-local system for extensibility:</p>
<pre class="elisp"><code>;; From mode-local.el (lines 1-50)
;; Each major mode will want to support a specific set of behaviors.
;; Usually generic behaviors that need just a little bit of local
;; specifics.
;;
;; This library permits the setting of override functions for tasks of
;; that nature, and also provides reasonable defaults.
;;
;; There are buffer local variables (and there were frame local variables).
;; This library gives the illusion of mode specific variables.

(defun mode-local-map-mode-buffers (function modes)
  "Run FUNCTION on every file buffer with major mode in MODES."
  (setq modes (ensure-list modes))
  (mode-local-map-file-buffers
   function (lambda () (derived-mode-p modes))))

;; Allows mode-specific overrides:
;; - semantic-parse-region (parser implementation)
;; - semantic-tag-components (tag decomposition)
;; - ede-system-include-path (include paths)
;; - srecode-template-setup-parser (template parsing)</code></pre>
<h3 data-number="16.6.2" id="component-interaction-flow"><span class="header-section-number">16.6.2</span> 5.2 Component Interaction
Flow</h3>
<pre><code>User Action (e.g., M-TAB for completion)
    ‚îÇ
    ‚ñº
semantic-complete-analyze-inline
    ‚îÇ
    ‚îú‚îÄ‚ñ∫ semantic-analyze-current-context
    ‚îÇ       ‚îú‚îÄ‚ñ∫ semantic-fetch-tags (ensure buffer parsed)
    ‚îÇ       ‚îÇ       ‚îú‚îÄ‚ñ∫ semantic-parse-region (mode-local)
    ‚îÇ       ‚îÇ       ‚îî‚îÄ‚ñ∫ semanticdb-cache
    ‚îÇ       ‚îú‚îÄ‚ñ∫ semantic-scope-cache (determine scope)
    ‚îÇ       ‚îî‚îÄ‚ñ∫ semantic-analyze-scoped-tags
    ‚îÇ
    ‚îú‚îÄ‚ñ∫ semantic-complete-inline-analyzer
    ‚îÇ       ‚îî‚îÄ‚ñ∫ semanticdb-find-tags-by-name-regexp
    ‚îÇ
    ‚îî‚îÄ‚ñ∫ Display completions to user</code></pre>
<h3 data-number="16.6.3" id="idle-time-services"><span class="header-section-number">16.6.3</span> 5.3 Idle Time Services</h3>
<p>Semantic provides intelligent background processing:</p>
<pre class="elisp"><code>;; From semantic/idle.el (lines 1-150)
;; Originally, `semantic-auto-parse-mode' handled refreshing the
;; tags in a buffer in idle time. Other activities can be scheduled
;; in idle time, all of which require up-to-date tag tables.

(defcustom semantic-idle-scheduler-idle-time 1
  "Time in seconds of idle before scheduling events."
  :type 'number)

(defcustom semantic-idle-scheduler-work-idle-time 60
  "Time in seconds of idle before scheduling big work."
  :type 'number)

;; Idle services include:
;; - semantic-idle-scheduler-mode: Re-parse on idle
;; - semantic-idle-summary-mode: Show tag summary at point
;; - semantic-idle-completions-mode: Automatic completion popup
;; - semantic-idle-local-symbol-highlight-mode: Highlight references</code></pre>
<p><strong>Idle Mode Services:</strong></p>
<ol type="1">
<li><strong>Fast Services</strong> (1s idle):
<ul>
<li>Incremental parsing</li>
<li>Tag cache updates</li>
<li>Symbol highlighting</li>
</ul></li>
<li><strong>Slow Services</strong> (60s idle):
<ul>
<li>Database save</li>
<li>Cross-reference updates</li>
<li>Full buffer analysis</li>
</ul></li>
</ol>
<h2 data-number="16.7" id="modern-context-lsp-vs.-cedet"><span class="header-section-number">16.7</span> 6. Modern Context: LSP
vs.¬†CEDET</h2>
<h3 data-number="16.7.1" id="the-lsp-advantage"><span class="header-section-number">16.7.1</span> 6.1 The LSP Advantage</h3>
<p><strong>Language Server Protocol (via Eglot) provides:</strong></p>
<pre class="elisp"><code>;; Modern LSP approach with Eglot
(use-package eglot
  :hook ((c-mode . eglot-ensure)
         (c++-mode . eglot-ensure)
         (python-mode . eglot-ensure))
  :config
  ;; LSP provides:
  ;; - Company backend (completion)
  ;; - Xref backend (navigation)
  ;; - Flymake backend (diagnostics)
  ;; - Eldoc backend (documentation)
  ;; All with much better accuracy than CEDET
  )</code></pre>
<p><strong>LSP Benefits over CEDET:</strong> - ‚úÖ Language-specific
expertise (maintained by language communities) - ‚úÖ Full compiler
integration (accurate type information) - ‚úÖ IDE-quality features
(refactoring, renaming, etc.) - ‚úÖ Cross-editor compatibility - ‚úÖ
Active development and support</p>
<h3 data-number="16.7.2" id="when-cedet-still-makes-sense"><span class="header-section-number">16.7.2</span> 6.2 When CEDET Still Makes
Sense</h3>
<p><strong>Use CEDET when:</strong></p>
<ol type="1">
<li><strong>No LSP server available</strong>: Some languages lack LSP
implementations</li>
<li><strong>Offline development</strong>: CEDET works without external
processes</li>
<li><strong>Simple projects</strong>: For quick scripts, CEDET‚Äôs lighter
weight may be preferable</li>
<li><strong>Educational purposes</strong>: Understanding parser design
and implementation</li>
<li><strong>Legacy codebases</strong>: Existing CEDET
configurations</li>
<li><strong>Resource-constrained environments</strong>: CEDET uses less
memory than LSP servers</li>
</ol>
<h3 data-number="16.7.3" id="hybrid-approach"><span class="header-section-number">16.7.3</span> 6.3 Hybrid Approach</h3>
<pre class="elisp"><code>;; Use LSP where available, CEDET as fallback
(defun my-setup-completion ()
  "Set up completion based on available tools."
  (cond
   ;; Prefer LSP if available
   ((and (fboundp 'eglot-managed-p) (eglot-managed-p))
    (setq-local completion-at-point-functions
                (list (cape-capf-buster #'eglot-completion-at-point))))

   ;; Fall back to Semantic
   ((and (featurep 'semantic) (semantic-active-p))
    (setq-local completion-at-point-functions
                (list #'semantic-analyze-completion-at-point-function)))

   ;; Otherwise, use basic completion
   (t
    (setq-local completion-at-point-functions
                (list #'elisp-completion-at-point)))))</code></pre>
<h2 data-number="16.8" id="historical-context-and-evolution"><span class="header-section-number">16.8</span> 7. Historical Context and
Evolution</h2>
<h3 data-number="16.8.1" id="cedet-history"><span class="header-section-number">16.8.1</span> 7.1 CEDET History</h3>
<p><strong>Timeline:</strong></p>
<ul>
<li><strong>1997-2000</strong>: Original development by Eric Ludlam</li>
<li><strong>2.0 (2009)</strong>: Major rewrite, integration into
Emacs</li>
<li><strong>Emacs 23.2 (2010)</strong>: First bundled version</li>
<li><strong>Emacs 24+</strong>: Incremental improvements</li>
<li><strong>2016+</strong>: LSP emerges as alternative</li>
<li><strong>Present</strong>: Maintained but not actively developed</li>
</ul>
<h3 data-number="16.8.2" id="architectural-lessons"><span class="header-section-number">16.8.2</span> 7.2 Architectural
Lessons</h3>
<p>CEDET pioneered several concepts now standard in IDEs:</p>
<ol type="1">
<li><strong>Tag-based navigation</strong>: Jump to definition, find
references</li>
<li><strong>Incremental parsing</strong>: Parse only changed
regions</li>
<li><strong>Context-aware completion</strong>: Type inference for
suggestions</li>
<li><strong>Project awareness</strong>: Multi-file understanding</li>
<li><strong>Extensible architecture</strong>: Mode-local overrides</li>
</ol>
<h3 data-number="16.8.3" id="why-lsp-won"><span class="header-section-number">16.8.3</span> 7.3 Why LSP Won</h3>
<p><strong>Technical reasons:</strong></p>
<ol type="1">
<li><strong>Separation of concerns</strong>: Language logic in dedicated
servers</li>
<li><strong>Compiler integration</strong>: Direct access to compiler
internals</li>
<li><strong>Community distribution</strong>: Language experts maintain
servers</li>
<li><strong>Protocol standardization</strong>: One protocol, many
implementations</li>
<li><strong>Resource pooling</strong>: One server serves multiple
editors</li>
</ol>
<p><strong>Example comparison:</strong></p>
<pre class="elisp"><code>;; CEDET approach: Emacs must understand the language
;; - Maintain grammar files (.by, .wy)
;; - Keep up with language evolution
;; - Limited to what parser can express

;; LSP approach: Delegate to language experts
;; - Language server knows language intimately
;; - Compiler-level accuracy
;; - Full language feature support</code></pre>
<h2 data-number="16.9" id="code-examples-and-recipes"><span class="header-section-number">16.9</span> 8. Code Examples and
Recipes</h2>
<h3 data-number="16.9.1" id="basic-semantic-usage"><span class="header-section-number">16.9.1</span> 8.1 Basic Semantic
Usage</h3>
<pre class="elisp"><code>;;; Enable Semantic mode
(semantic-mode 1)

;; Enable idle services
(global-semantic-idle-scheduler-mode 1)
(global-semantic-idle-summary-mode 1)

;; Enable database for persistent tags
(global-semanticdb-minor-mode 1)

;; Enable decoration mode (adds visual indicators)
(global-semantic-decoration-mode 1)

;; Navigate tags
(global-set-key (kbd "C-c , j") 'semantic-complete-jump-local)
(global-set-key (kbd "C-c , J") 'semantic-complete-jump)
(global-set-key (kbd "C-c , n") 'senator-next-tag)
(global-set-key (kbd "C-c , p") 'senator-previous-tag)

;; Symbol reference searching
(global-set-key (kbd "C-c , g") 'semantic-symref-symbol)</code></pre>
<h3 data-number="16.9.2" id="ede-project-setup"><span class="header-section-number">16.9.2</span> 8.2 EDE Project Setup</h3>
<pre class="elisp"><code>;;; Enable EDE
(global-ede-mode 1)

;; Define a C++ project
(ede-cpp-root-project "MyProject"
  :name "My C++ Project"
  :file "~/projects/myproject/README"
  :include-path '("/include"
                  "/src/utils")
  :system-include-path '("/usr/include/boost"
                         "/usr/local/include")
  :spp-table '(("DEBUG" . "1")
               ("VERSION" . "\"1.0\"")))

;; Add custom compilation command
(defun my-project-compile ()
  "Compile my project."
  (interactive)
  (compile "make -C ~/projects/myproject"))</code></pre>
<h3 data-number="16.9.3" id="creating-custom-templates"><span class="header-section-number">16.9.3</span> 8.3 Creating Custom
Templates</h3>
<pre><code>;; File: ~/.emacs.d/templates/my-templates.srt

template file-header
----
/* {{FILENAME}}
 *
 * Author: {{AUTHOR}}
 * Date: {{DATE}}
 *
 * {{PROJECT}}
 */
----

template cpp-class
----
class {{NAME}} {
public:
    {{NAME}}();
    virtual ~{{NAME}}();

    // Copy and assignment
    {{NAME}}(const {{NAME}}&amp;) = delete;
    {{NAME}}&amp; operator=(const {{NAME}}&amp;) = delete;

private:
    {{^}}
};
----

template test-function
----
TEST({{TEST_SUITE}}, {{TEST_NAME}}) {
    // Arrange
    {{^}}

    // Act

    // Assert
}
----</code></pre>
<h3 data-number="16.9.4" id="advanced-semantic-analysis"><span class="header-section-number">16.9.4</span> 8.4 Advanced Semantic
Analysis</h3>
<pre class="elisp"><code>;;; Query the semantic database
(defun my-find-callers (function-name)
  "Find all callers of FUNCTION-NAME."
  (interactive "sFunction name: ")
  (let* ((refs (semantic-symref-find-references-by-name
                function-name 'function))
         (matches (semantic-symref-result-get-tags refs)))
    (pop-to-buffer "*Function Callers*")
    (erase-buffer)
    (dolist (match matches)
      (insert (format "%s:%d: %s\n"
                      (semantic-tag-file-name match)
                      (semantic-tag-start match)
                      (semantic-tag-name match))))))

;;; Analyze context at point
(defun my-analyze-point ()
  "Show analysis of current point."
  (interactive)
  (let ((ctxt (semantic-analyze-current-context)))
    (if ctxt
        (progn
          (message "Prefix: %S" (oref ctxt prefix))
          (message "Scope: %S" (semantic-scope-find 'function))
          (message "Type constraint: %S"
                   (semantic-analyze-type-constraint ctxt)))
      (message "No context available"))))</code></pre>
<h2 data-number="16.10" id="performance-considerations-4"><span class="header-section-number">16.10</span> 9. Performance
Considerations</h2>
<h3 data-number="16.10.1" id="optimization-strategies-2"><span class="header-section-number">16.10.1</span> 9.1 Optimization
Strategies</h3>
<pre class="elisp"><code>;;; Limit Semantic to certain modes
(setq semantic-new-buffer-setup-functions
      '((c-mode . semantic-default-c-setup)
        (c++-mode . semantic-default-c-setup)
        (emacs-lisp-mode . semantic-default-elisp-setup)))

;;; Set maximum buffer size for idle parsing
(setq semantic-idle-scheduler-max-buffer-size 100000) ; 100KB

;;; Reduce idle delay for faster response
(setq semantic-idle-scheduler-idle-time 0.5)

;;; Disable expensive features
(setq semantic-idle-scheduler-verbose-flag nil)
(global-semantic-highlight-edits-mode -1)</code></pre>
<h3 data-number="16.10.2" id="database-management"><span class="header-section-number">16.10.2</span> 9.2 Database
Management</h3>
<pre class="elisp"><code>;;; Control database location
(setq semanticdb-default-save-directory
      (expand-file-name "~/.emacs.d/semanticdb"))

;;; Periodic cleanup
(defun my-clean-old-semantic-caches ()
  "Remove semantic caches older than 30 days."
  (interactive)
  (let ((cutoff (- (float-time) (* 30 24 60 60))))
    (dolist (file (directory-files semanticdb-default-save-directory t "\\.semanticdb$"))
      (when (&lt; (float-time (nth 5 (file-attributes file))) cutoff)
        (delete-file file)))))</code></pre>
<h2 data-number="16.11" id="debugging-and-troubleshooting"><span class="header-section-number">16.11</span> 10. Debugging and
Troubleshooting</h2>
<h3 data-number="16.11.1" id="common-issues-1"><span class="header-section-number">16.11.1</span> 10.1 Common Issues</h3>
<p><strong>Problem: Semantic not parsing buffer</strong></p>
<pre class="elisp"><code>;; Check if semantic is active
(semantic-active-p)  ; Should return t

;; Check parse state
(semantic-parse-tree-state)  ; Should return nil if up-to-date

;; Force reparse
(semantic-force-refresh)

;; Check for errors
semantic-parser-warnings</code></pre>
<p><strong>Problem: Incomplete or wrong completions</strong></p>
<pre class="elisp"><code>;; Check if tags are being found
(semantic-fetch-tags)

;; Check database
(semanticdb-dump-current-table)

;; Verify include paths
(semantic-gcc-get-include-paths "c++")</code></pre>
<h3 data-number="16.11.2" id="debug-tools"><span class="header-section-number">16.11.2</span> 10.2 Debug Tools</h3>
<pre class="elisp"><code>;;; Enable verbose mode
(setq semantic-idle-scheduler-verbose-flag t)

;;; Use data-debug to inspect structures
(require 'data-debug)
(data-debug-new-buffer "*TAG DEBUG*")
(data-debug-insert-thing (semantic-current-tag) "&gt;" "")

;;; Bovination output
(bovinate t)  ; Parse and show output

;;; Check what's in scope
(semantic-calculate-scope)</code></pre>
<h2 data-number="16.12" id="comparison-matrix"><span class="header-section-number">16.12</span> 11. Comparison Matrix</h2>
<h3 data-number="16.12.1" id="cedet-vs.-lsp-feature-comparison"><span class="header-section-number">16.12.1</span> CEDET vs.¬†LSP Feature
Comparison</h3>
<table>
<colgroup>
<col style="width: 20%"/>
<col style="width: 34%"/>
<col style="width: 25%"/>
<col style="width: 18%"/>
</colgroup>
<thead>
<tr>
<th>Feature</th>
<th>CEDET/Semantic</th>
<th>LSP/Eglot</th>
<th>Winner</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Completion Accuracy</strong></td>
<td>Context-based, limited</td>
<td>Compiler-accurate</td>
<td>LSP ‚úì</td>
</tr>
<tr>
<td><strong>Jump to Definition</strong></td>
<td>Tag-based</td>
<td>AST-precise</td>
<td>LSP ‚úì</td>
</tr>
<tr>
<td><strong>Find References</strong></td>
<td>Text/tag search</td>
<td>Semantic search</td>
<td>LSP ‚úì</td>
</tr>
<tr>
<td><strong>Refactoring</strong></td>
<td>Limited</td>
<td>Full IDE support</td>
<td>LSP ‚úì</td>
</tr>
<tr>
<td><strong>Diagnostics</strong></td>
<td>Basic</td>
<td>Real-time compiler</td>
<td>LSP ‚úì</td>
</tr>
<tr>
<td><strong>Memory Usage</strong></td>
<td>Lower</td>
<td>Higher</td>
<td>CEDET ‚úì</td>
</tr>
<tr>
<td><strong>Startup Time</strong></td>
<td>Instant</td>
<td>Server startup delay</td>
<td>CEDET ‚úì</td>
</tr>
<tr>
<td><strong>Offline Work</strong></td>
<td>Full support</td>
<td>Limited</td>
<td>CEDET ‚úì</td>
</tr>
<tr>
<td><strong>Language Coverage</strong></td>
<td>~15 languages</td>
<td>100+ languages</td>
<td>LSP ‚úì</td>
</tr>
<tr>
<td><strong>Maintenance</strong></td>
<td>Low</td>
<td>Active</td>
<td>LSP ‚úì</td>
</tr>
<tr>
<td><strong>Emacs Integration</strong></td>
<td>Native</td>
<td>Via protocol</td>
<td>CEDET ‚úì</td>
</tr>
<tr>
<td><strong>Learning Curve</strong></td>
<td>Steep</td>
<td>Moderate</td>
<td>LSP ‚úì</td>
</tr>
</tbody>
</table>
<h2 data-number="16.13" id="migration-guide-cedet-to-lsp"><span class="header-section-number">16.13</span> 12. Migration Guide: CEDET to
LSP</h2>
<h3 data-number="16.13.1" id="equivalent-features"><span class="header-section-number">16.13.1</span> 12.1 Equivalent
Features</h3>
<pre class="elisp"><code>;;; OLD: CEDET/Semantic approach
(semantic-mode 1)
(global-semantic-idle-scheduler-mode 1)
(global-semanticdb-minor-mode 1)
(global-semantic-idle-summary-mode 1)

;;; NEW: LSP/Eglot approach
(use-package eglot
  :hook ((c-mode . eglot-ensure)
         (c++-mode . eglot-ensure)
         (python-mode . eglot-ensure))
  :bind (:map eglot-mode-map
              ("C-c l a" . eglot-code-actions)
              ("C-c l r" . eglot-rename)
              ("C-c l f" . eglot-format))
  :config
  ;; Eglot automatically provides:
  ;; - completion-at-point (M-TAB)
  ;; - xref-find-definitions (M-.)
  ;; - xref-find-references (M-?)
  ;; - eldoc-mode (automatic documentation)
  ;; - flymake-mode (diagnostics)
  )</code></pre>
<h3 data-number="16.13.2" id="feature-mapping"><span class="header-section-number">16.13.2</span> 12.2 Feature Mapping</h3>
<table>
<thead>
<tr>
<th>CEDET Function</th>
<th>LSP/Eglot Equivalent</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>semantic-complete-jump</code></td>
<td><code>xref-find-definitions</code> (M-.)</td>
</tr>
<tr>
<td><code>semantic-symref-symbol</code></td>
<td><code>xref-find-references</code> (M-?)</td>
</tr>
<tr>
<td><code>semantic-analyze-completion</code></td>
<td><code>completion-at-point</code> (M-TAB)</td>
</tr>
<tr>
<td><code>semantic-idle-summary-mode</code></td>
<td><code>eldoc-mode</code> (built-in)</td>
</tr>
<tr>
<td><code>semantic-decoration-mode</code></td>
<td><code>flymake-mode</code> (diagnostics)</td>
</tr>
<tr>
<td><code>semantic-ia-show-doc</code></td>
<td><code>eglot-help-at-point</code></td>
</tr>
<tr>
<td><code>semantic-force-refresh</code></td>
<td><code>eglot-reconnect</code></td>
</tr>
<tr>
<td><code>ede-compile-target</code></td>
<td><code>compile</code> + project.el</td>
</tr>
</tbody>
</table>
<h2 data-number="16.14" id="future-and-recommendations"><span class="header-section-number">16.14</span> 13. Future and
Recommendations</h2>
<h3 data-number="16.14.1" id="current-status-2025"><span class="header-section-number">16.14.1</span> 13.1 Current Status
(2025)</h3>
<ul>
<li><strong>Maintenance mode</strong>: Bugs fixed but no new
features</li>
<li><strong>Still functional</strong>: Works for supported
languages</li>
<li><strong>Declining usage</strong>: Most users migrated to LSP</li>
<li><strong>Educational value</strong>: Good for learning parser
design</li>
</ul>
<h3 data-number="16.14.2" id="recommendations"><span class="header-section-number">16.14.2</span> 13.2 Recommendations</h3>
<p><strong>For new projects:</strong> - ‚úÖ Use LSP (Eglot) if language
server available - ‚úÖ Use Tree-sitter for syntax highlighting - ‚ö†Ô∏è
Consider CEDET only for unsupported languages</p>
<p><strong>For existing CEDET users:</strong> - Evaluate migration to
LSP for each language - Keep CEDET for languages without LSP servers -
Gradually transition as LSP servers mature</p>
<p><strong>For Emacs Lisp development:</strong> - CEDET still relevant
(no LSP server yet) - Consider combination of CEDET + static analysis
tools</p>
<h3 data-number="16.14.3" id="learning-resources"><span class="header-section-number">16.14.3</span> 13.3 Learning
Resources</h3>
<p><strong>Documentation:</strong> - CEDET Manual:
<code>C-h i m CEDET RET</code> - Semantic Manual:
<code>C-h i m Semantic RET</code> - EDE Manual:
<code>C-h i m EDE RET</code></p>
<p><strong>Key Files to Study:</strong></p>
<pre><code>/lisp/cedet/semantic/tag.el      - Tag system fundamentals
/lisp/cedet/semantic/db.el       - Database architecture
/lisp/cedet/semantic/analyze.el  - Code analysis
/lisp/cedet/ede/proj.el          - Project structure
/lisp/cedet/mode-local.el        - Mode-local system</code></pre>
<h2 data-number="16.15" id="conclusion-5"><span class="header-section-number">16.15</span> Conclusion</h2>
<p>CEDET represents a heroic effort to bring IDE-like features to Emacs
through pure Elisp. While largely superseded by LSP for most languages,
it remains architecturally interesting and historically important. Its
tag-based approach, incremental parsing, and mode-local system
influenced modern development tools.</p>
<p>For modern Emacs users, CEDET serves as: 1. <strong>Fallback</strong>
for languages without LSP 2. <strong>Educational resource</strong> for
understanding parsers 3. <strong>Historical artifact</strong> of Emacs
development 4. <strong>Proof of concept</strong> that Emacs can be a
full IDE</p>
<p>The future belongs to LSP, but CEDET‚Äôs legacy lives on in the
patterns and approaches it pioneered.</p>
<h1 data-number="17" id="calc-advanced-calculator"><span class="header-section-number">17</span> Calc: Advanced Calculator</h1>
<p><strong>Location</strong>: <code>/home/user/emacs/lisp/calc/</code>
<strong>Size</strong>: 43 files, 55,552 lines of code
<strong>Author</strong>: David Gillespie <strong>Purpose</strong>:
Reverse Polish Notation (RPN) and algebraic calculator with
arbitrary-precision arithmetic</p>
<h2 data-number="17.1" id="overview-7"><span class="header-section-number">17.1</span> Overview</h2>
<p>Calc is a comprehensive computer algebra system integrated into
Emacs, providing sophisticated mathematical capabilities including
arbitrary-precision arithmetic, symbolic manipulation, calculus,
statistics, and unit conversions. It operates as both an RPN calculator
and an algebraic calculator, with extensive support for various
mathematical domains.</p>
<h3 data-number="17.1.1" id="key-features-1"><span class="header-section-number">17.1.1</span> Key Features</h3>
<ul>
<li><strong>Arbitrary-precision arithmetic</strong>: Integer, rational,
floating-point, and complex numbers</li>
<li><strong>Symbolic computation</strong>: Algebraic manipulation,
simplification, and solving</li>
<li><strong>Calculus</strong>: Derivatives, integrals, Taylor
series</li>
<li><strong>Linear algebra</strong>: Matrices, vectors, determinants,
eigenvalues</li>
<li><strong>Statistics</strong>: Mean, variance, regression,
distributions</li>
<li><strong>Financial calculations</strong>: Present value, future
value, amortization</li>
<li><strong>Unit conversions</strong>: Comprehensive physical units
system</li>
<li><strong>Multiple modes</strong>: RPN, algebraic, embedded mode</li>
<li><strong>Programmability</strong>: Keyboard macros, user-defined
functions, rewrite rules</li>
</ul>
<h2 data-number="17.2" id="architecture-1"><span class="header-section-number">17.2</span> Architecture</h2>
<h3 data-number="17.2.1" id="core-module-structure"><span class="header-section-number">17.2.1</span> Core Module Structure</h3>
<pre><code>calc/
‚îú‚îÄ‚îÄ calc.el              Main entry point (3,532 lines)
‚îú‚îÄ‚îÄ calc-ext.el          Extension loader (3,434 lines)
‚îú‚îÄ‚îÄ calc-macs.el         Macros and fundamental definitions
‚îÇ
‚îú‚îÄ‚îÄ Arithmetic &amp; Algebra
‚îÇ   ‚îú‚îÄ‚îÄ calc-arith.el    Arithmetic operations (3,067 lines)
‚îÇ   ‚îú‚îÄ‚îÄ calc-math.el     Mathematical functions (2,094 lines)
‚îÇ   ‚îú‚îÄ‚îÄ calc-alg.el      Algebraic functions (1,942 lines)
‚îÇ   ‚îú‚îÄ‚îÄ calcalg2.el      Advanced algebra (3,682 lines)
‚îÇ   ‚îú‚îÄ‚îÄ calcalg3.el      More algebra (1,942 lines)
‚îÇ   ‚îú‚îÄ‚îÄ calc-frac.el     Fraction arithmetic
‚îÇ   ‚îú‚îÄ‚îÄ calc-cplx.el     Complex numbers
‚îÇ   ‚îî‚îÄ‚îÄ calc-bin.el      Binary/octal/hex arithmetic
‚îÇ
‚îú‚îÄ‚îÄ Calculus &amp; Analysis
‚îÇ   ‚îú‚îÄ‚îÄ calc-misc.el     Miscellaneous functions
‚îÇ   ‚îú‚îÄ‚îÄ calc-funcs.el    Special functions
‚îÇ   ‚îî‚îÄ‚îÄ calc-poly.el     Polynomial operations
‚îÇ
‚îú‚îÄ‚îÄ Linear Algebra
‚îÇ   ‚îú‚îÄ‚îÄ calc-vec.el      Vector operations
‚îÇ   ‚îú‚îÄ‚îÄ calc-mtx.el      Matrix operations
‚îÇ   ‚îî‚îÄ‚îÄ calc-map.el      Mapping functions
‚îÇ
‚îú‚îÄ‚îÄ Statistics &amp; Finance
‚îÇ   ‚îú‚îÄ‚îÄ calc-stat.el     Statistical functions
‚îÇ   ‚îú‚îÄ‚îÄ calc-fin.el      Financial calculations
‚îÇ   ‚îú‚îÄ‚îÄ calc-nlfit.el    Nonlinear curve fitting
‚îÇ   ‚îî‚îÄ‚îÄ calc-comb.el     Combinatorics
‚îÇ
‚îú‚îÄ‚îÄ Data &amp; Units
‚îÇ   ‚îú‚îÄ‚îÄ calc-units.el    Unit conversions (2,390 lines)
‚îÇ   ‚îú‚îÄ‚îÄ calc-forms.el    Date/time, HMS, error forms (2,648 lines)
‚îÇ   ‚îî‚îÄ‚îÄ calc-store.el    Variable storage
‚îÇ
‚îú‚îÄ‚îÄ User Interface
‚îÇ   ‚îú‚îÄ‚îÄ calc-trail.el    Trail buffer management
‚îÇ   ‚îú‚îÄ‚îÄ calc-embed.el    Embedded mode (1,767 lines)
‚îÇ   ‚îú‚îÄ‚îÄ calc-yank.el     Copy/paste operations
‚îÇ   ‚îú‚îÄ‚îÄ calc-sel.el      Selection mechanism
‚îÇ   ‚îú‚îÄ‚îÄ calc-help.el     Help system
‚îÇ   ‚îú‚îÄ‚îÄ calc-menu.el     Menu interface (1,914 lines)
‚îÇ   ‚îî‚îÄ‚îÄ calc-keypd.el    Keypad mode
‚îÇ
‚îú‚îÄ‚îÄ Programming
‚îÇ   ‚îú‚îÄ‚îÄ calc-prog.el     User programming (2,190 lines)
‚îÇ   ‚îú‚îÄ‚îÄ calc-rewr.el     Rewrite rules (2,218 lines)
‚îÇ   ‚îî‚îÄ‚îÄ calc-rules.el    Rule definitions
‚îÇ
‚îú‚îÄ‚îÄ Language &amp; I/O
‚îÇ   ‚îú‚îÄ‚îÄ calc-lang.el     Language modes (2,691 lines)
‚îÇ   ‚îú‚îÄ‚îÄ calc-aent.el     Algebraic entry
‚îÇ   ‚îú‚îÄ‚îÄ calccomp.el      Composition/formatting (1,935 lines)
‚îÇ   ‚îî‚îÄ‚îÄ calc-graph.el    GNUPLOT interface (1,729 lines)
‚îÇ
‚îî‚îÄ‚îÄ Support
    ‚îú‚îÄ‚îÄ calc-mode.el     Mode management
    ‚îú‚îÄ‚îÄ calc-undo.el     Undo mechanism
    ‚îú‚îÄ‚îÄ calc-stuff.el    Utility functions
    ‚îî‚îÄ‚îÄ calc-incom.el    Incomplete objects</code></pre>
<h3 data-number="17.2.2" id="lazy-loading-design"><span class="header-section-number">17.2.2</span> Lazy Loading Design</h3>
<p>Calc uses a sophisticated lazy-loading architecture to minimize
startup time:</p>
<pre class="elisp"><code>;; From calc.el, lines 25-30:
;; Calc is split into many files.  This file is the main entry point.
;; This file includes autoload commands for various other basic Calc
;; facilities.  The more advanced features are based in calc-ext, which
;; in turn contains autoloads for the rest of the Calc files.  This
;; odd set of interactions is designed to make Calc's loading time
;; be as short as possible when only simple calculations are needed.</code></pre>
<p><strong>Loading Strategy</strong>: 1. <strong>calc.el</strong>: Core
functions, basic arithmetic, number normalization 2.
<strong>calc-ext.el</strong>: Extension loader, autoloads advanced
features on demand 3. <strong>Specialized modules</strong>: Loaded only
when their functionality is accessed</p>
<h2 data-number="17.3" id="data-representation"><span class="header-section-number">17.3</span> Data Representation</h2>
<h3 data-number="17.3.1" id="internal-number-format"><span class="header-section-number">17.3.1</span> Internal Number Format</h3>
<p>Calc uses a normalized internal representation for all mathematical
objects. From <code>/home/user/emacs/lisp/calc/calc.el</code> (lines
2548-2600):</p>
<pre class="elisp"><code>;;;; Arithmetic routines.
;;
;; An object as manipulated by one of these routines may take any of the
;; following forms:

;; integer                 An integer.

;; (frac NUM DEN)          A fraction.  NUM and DEN are integers.
;;                         Normalized, DEN &gt; 1.

;; (float NUM EXP)         A floating-point number, NUM * 10^EXP;
;;                         NUM and EXP are integers.
;;                         Normalized, NUM is not a multiple of 10, and
;;                         abs(NUM) &lt; 10^calc-internal-prec.
;;                         Normalized zero is stored as (float 0 0).

;; (cplx REAL IMAG)        A complex number; REAL and IMAG are any of above.
;;                         Normalized, IMAG is nonzero.

;; (polar R THETA)         Polar complex number.  Normalized, R &gt; 0 and THETA
;;                         is neither zero nor 180 degrees (pi radians).

;; (vec A B C ...)         Vector of objects A, B, C, ...  A matrix is a
;;                         vector of vectors.

;; (hms H M S)             Angle in hours-minutes-seconds form.  All three
;;                         components have the same sign; H and M must be
;;                         numerically integers; M and S are expected to
;;                         lie in the range [0,60).

;; (date N)                A date or date/time object.  N is an integer to
;;                         store a date only, or a fraction or float to
;;                         store a date and time.

;; (sdev X SIGMA)          Error form, X +/- SIGMA.  When normalized,
;;                         SIGMA &gt; 0.  X is any complex number and SIGMA
;;                         is real numbers; or these may be symbolic
;;                         expressions where SIGMA is assumed real.

;; (intv MASK LO HI)       Interval form.  MASK is 0=(), 1=(], 2=[), or 3=[].
;;                         LO and HI are any real numbers, or symbolic
;;                         expressions which are assumed real, and LO &lt; HI.
;;                         For [LO..HI], if LO = HI normalization produces LO,
;;                         and if LO &gt; HI normalization produces [LO..LO).
;;                         For other intervals, if LO &gt; HI normalization
;;                         sets HI equal to LO.

;; (mod N M)               Number modulo M.  When normalized, 0 &lt;= N &lt; M.
;;                         N and M are real numbers.

;; (var V S)               Symbolic variable.  V is a Lisp symbol which
;;                         represents the variable's visible name.  S is
;;                         the symbol which actually stores the variable's
;;                         value:  (var pi var-pi).</code></pre>
<h3 data-number="17.3.2" id="type-code-notation"><span class="header-section-number">17.3.2</span> Type Code Notation</h3>
<p>From lines 2604-2627:</p>
<pre class="elisp"><code>;; In the following comments, [x y z] means result is x, args must be y, z,
;; respectively, where the code letters are:
;;
;;    O  Normalized object (vector or number)
;;    V  Normalized vector
;;    N  Normalized number of any type
;;    N  Normalized complex number
;;    R  Normalized real number (float or rational)
;;    F  Normalized floating-point number
;;    T  Normalized rational number
;;    I  Normalized integer
;;    B  Normalized big integer
;;    S  Normalized small integer
;;    D  Digit (small integer, 0..999)
;;    L  normalized vector element list (without "vec")
;;    P  Predicate (truth value)
;;    X  Any Lisp object
;;    Z  "nil"
;;
;; Lower-case letters signify possibly un-normalized values.
;; "L.D" means a cons of an L and a D.
;; [N N; n n] means result will be normalized if argument is.
;; Also, [Public] marks routines intended to be called from outside.</code></pre>
<h3 data-number="17.3.3" id="examples-of-data-representation"><span class="header-section-number">17.3.3</span> Examples of Data
Representation</h3>
<pre class="elisp"><code>;; Integers (native Lisp integers)
42                    ; Small integer
123456789012345678    ; Big integer (arbitrary precision)

;; Fractions
(frac 17 3)          ; 17/3
(frac -5 2)          ; -5/2

;; Floating-point
(float 314 -2)       ; 3.14 (314 √ó 10^-2)
(float 12345 0)      ; 12345.0
(float 0 0)          ; 0.0

;; Complex numbers (rectangular)
(cplx 2 4)           ; 2 + 4i
(cplx (frac 1 2) 3)  ; 1/2 + 3i

;; Complex numbers (polar)
(polar 5 (float 314159 -5))  ; r=5, Œ∏=œÄ (approximately)

;; Vectors
(vec 1 2 3)          ; [1, 2, 3]

;; Matrices (vectors of vectors)
(vec (vec 1 2) (vec 3 4))    ; [[1, 2], [3, 4]]

;; Error forms
(sdev 100 5)         ; 100 ¬± 5

;; Intervals
(intv 3 1 4)         ; [1..4] (closed interval)
(intv 0 1 4)         ; (1..4) (open interval)

;; HMS (hours-minutes-seconds)
(hms 2 30 0)         ; 2¬∞30'0"

;; Modular forms
(mod 7 10)           ; 7 mod 10

;; Symbolic variables
(var x var-x)        ; Variable x</code></pre>
<h2 data-number="17.4" id="core-normalization"><span class="header-section-number">17.4</span> Core Normalization</h2>
<p>The <code>math-normalize</code> function is the heart of Calc‚Äôs type
system. From <code>/home/user/emacs/lisp/calc/calc.el</code> (lines
2636-2727):</p>
<pre class="elisp"><code>;;; Reduce an object to canonical (normalized) form.  [O o; Z Z] [Public]

(defvar math-normalize-error nil
  "Non-nil if the last call the `math-normalize' returned an error.")

(defun math-normalize (a)
  (setq math-normalize-error nil)
  (cond
   ((not (consp a)) a)
   ((eq (car a) 'float)
    (math-make-float (math-normalize (nth 1 a))
                     (nth 2 a)))
   ((or (memq (car a)
              '(frac cplx polar hms date mod sdev intv vec var quote
                     special-const calcFunc-if calcFunc-lambda
                     calcFunc-quote calcFunc-condition
                     calcFunc-evalto))
        (integerp (car a))
        (and (consp (car a))
             (not (eq (car (car a)) 'lambda))))
    (require 'calc-ext)
    (math-normalize-fancy a))
   (t
    (or (and calc-simplify-mode
             (require 'calc-ext)
             (math-normalize-nonstandard a))
        (let ((args (mapcar #'math-normalize (cdr a))))
          (or (condition-case err
                  (let ((func
                         (assq (car a) '( ( + . math-add )
                                          ( - . math-sub )
                                          ( * . math-mul )
                                          ( / . math-div )
                                          ( % . math-mod )
                                          ( ^ . math-pow )
                                          ( neg . math-neg )
                                          ( | . math-concat ) ))))
                    (or (and var-EvalRules
                             (progn
                               (or (eq var-EvalRules math-eval-rules-cache-tag)
                                   (progn
                                     (require 'calc-ext)
                                     (math-recompile-eval-rules)))
                               (and (or math-eval-rules-cache-other
                                        (assq (car a)
                                              math-eval-rules-cache))
                                    (math-apply-rewrites
                                     (cons (car a) args)
                                     (cdr math-eval-rules-cache)
                                     nil math-eval-rules-cache))))
                        (if func
                            (apply (cdr func) args)
                          (and (or (consp (car a))
                                   (fboundp (car a))
                                   (and (not (featurep 'calc-ext))
                                        (require 'calc-ext)
                                        (fboundp (car a))))
                               (apply (car a) args)))))
                (wrong-number-of-arguments
                 (setq math-normalize-error t)
                 (calc-record-why "*Wrong number of arguments"
                                  (cons (car a) args))
                 nil)
                (wrong-type-argument
                 (or calc-next-why
                     (calc-record-why "Wrong type of argument"
                                      (cons (car a) args)))
                 nil)
                (args-out-of-range
                 (setq math-normalize-error t)
                 (calc-record-why "*Argument out of range"
                                  (cons (car a) args))
                 nil)
                (inexact-result
                 (calc-record-why "No exact representation for result"
                                  (cons (car a) args))
                 nil)
                (math-overflow
                 (setq math-normalize-error t)
                 (calc-record-why "*Floating-point overflow occurred"
                                  (cons (car a) args))
                 nil)
                (math-underflow
                 (setq math-normalize-error t)
                 (calc-record-why "*Floating-point underflow occurred"
                                  (cons (car a) args))
                 nil)
                (void-variable
                 (setq math-normalize-error t)
                 (if (eq (nth 1 err) 'var-EvalRules)
                     (progn
                       (setq var-EvalRules nil)
                       (math-normalize (cons (car a) args)))
                   (calc-record-why "*Variable is void" (nth 1 err)))))
              (if (consp (car a))
                  (math-dimension-error)
                (cons (car a) args))))))))</code></pre>
<p><strong>Normalization guarantees</strong>: - All results are in
canonical form - Fractions are reduced to lowest terms - Floating-point
mantissas don‚Äôt end in zero - Complex numbers with zero imaginary part
become real - Error conditions are properly signaled and recorded</p>
<h2 data-number="17.5" id="stack-based-calculator-model"><span class="header-section-number">17.5</span> Stack-Based Calculator
Model</h2>
<h3 data-number="17.5.1" id="the-calculator-stack"><span class="header-section-number">17.5.1</span> The Calculator Stack</h3>
<p>From <code>/home/user/emacs/lisp/calc/calc.el</code> (lines
468-474):</p>
<pre class="elisp"><code>(defvar calc-stack '((top-of-stack 1 nil))
  "Calculator stack.
Entries are 3-lists:  Formula, Height (in lines), Selection (or nil).")

(defvar calc-stack-top 1
  "Index into `calc-stack' of \"top\" of stack.
This is 1 unless `calc-truncate-stack' has been used.")</code></pre>
<p><strong>Stack entry structure</strong>:</p>
<pre class="elisp"><code>(FORMULA HEIGHT SELECTION)</code></pre>
<ul>
<li><code>FORMULA</code>: The mathematical object (in normalized
form)</li>
<li><code>HEIGHT</code>: Number of display lines (for
line-breaking)</li>
<li><code>SELECTION</code>: Currently selected sub-expression, or
nil</li>
</ul>
<p><strong>Stack operations</strong>:</p>
<pre class="elisp"><code>;; From calc.el, line 1752
(defun calc-stack-size ()
  (- (length calc-stack) calc-stack-top))</code></pre>
<h3 data-number="17.5.2" id="rpn-vs.-algebraic-mode"><span class="header-section-number">17.5.2</span> RPN vs.¬†Algebraic Mode</h3>
<p>From the mode documentation (lines 1324-1329):</p>
<pre class="elisp"><code>(defun calc-mode ()
  "Calculator major mode.

This is a Reverse Polish notation (RPN) calculator featuring
arbitrary-precision integer, rational, floating-point, complex,
matrix, and symbolic arithmetic.

RPN calculation:  2 RET 3 +    produces 5.
Algebraic style:  ' 2+3 RET    produces 5.</code></pre>
<p><strong>RPN Mode</strong> (default): - Operands pushed onto stack
first - Operators consume stack items - Example: <code>2 RET 3 +</code>
‚Üí pushes 2, pushes 3, adds (pops both, pushes 5)</p>
<p><strong>Algebraic Mode</strong>: - Expressions entered using
<code>'</code> (quote) prefix - Standard infix notation - Example:
<code>' 2+3 RET</code> ‚Üí parses and evaluates expression</p>
<h2 data-number="17.6" id="arithmetic-operations"><span class="header-section-number">17.6</span> Arithmetic Operations</h2>
<h3 data-number="17.6.1" id="basic-arithmetic-calc-arith.el"><span class="header-section-number">17.6.1</span> Basic Arithmetic
(<code>calc-arith.el</code>)</h3>
<p>The arithmetic module (<code>calc-arith.el</code>, 3,067 lines)
implements fundamental operations with automatic type promotion:</p>
<pre class="elisp"><code>;; From calc.el, lines 2839-2863
;;; Compute the sum of A and B.  [O O O] [Public]
(defun math-add (a b)
  (or
   (and (not (or (consp a) (consp b)))
        (+ a b))
   (and (Math-zerop a) (not (eq (car-safe a) 'mod))
        (if (and (math-floatp a) (Math-ratp b)) (math-float b) b))
   (and (Math-zerop b) (not (eq (car-safe b) 'mod))
        (if (and (math-floatp b) (Math-ratp a)) (math-float a) a))
   (and (Math-objvecp a) (Math-objvecp b)
        (or
         (and (Math-ratp a) (Math-ratp b)
              (require 'calc-ext)
              (calc-add-fractions a b))
         (and (Math-realp a) (Math-realp b)
              (progn
                (or (and (consp a) (eq (car a) 'float))
                    (setq a (math-float a)))
                (or (and (consp b) (eq (car b) 'float))
                    (setq b (math-float b)))
                (math-add-float a b)))
         (and (require 'calc-ext)
              (math-add-objects-fancy a b))))
   (and (require 'calc-ext)
        (math-add-symb-fancy a b))))</code></pre>
<p><strong>Type promotion hierarchy</strong>: 1. Integer + Integer ‚Üí
Integer 2. Integer + Rational ‚Üí Rational 3. Rational + Float ‚Üí Float 4.
Real + Complex ‚Üí Complex 5. Scalar + Symbolic ‚Üí Symbolic expression</p>
<p><strong>Floating-point addition</strong> (lines 2865-2880):</p>
<pre class="elisp"><code>(defun math-add-float (a b)   ; [F F F]
  (let ((ediff (- (nth 2 a) (nth 2 b))))
    (if (&gt;= ediff 0)
        (if (&gt;= ediff (+ calc-internal-prec calc-internal-prec))
            a
          (math-make-float (math-add (nth 1 b)
                                     (if (eq ediff 0)
                                         (nth 1 a)
                                       (math-scale-left (nth 1 a) ediff)))
                           (nth 2 b)))
      (if (&gt;= (setq ediff (- ediff))
              (+ calc-internal-prec calc-internal-prec))
          b
        (math-make-float (math-add (nth 1 a)
                                   (math-scale-left (nth 1 b) ediff))
                         (nth 2 a))))))</code></pre>
<p>This implementation: - Aligns exponents before adding mantissas -
Handles precision loss when exponents differ greatly - Maintains
arbitrary precision through integer mantissa arithmetic</p>
<h3 data-number="17.6.2" id="mathematical-functions-calc-math.el"><span class="header-section-number">17.6.2</span> Mathematical Functions
(<code>calc-math.el</code>)</h3>
<p>The <code>calc-math.el</code> module (2,094 lines) provides
transcendental functions:</p>
<p><strong>Precision-aware computation</strong>:</p>
<pre class="elisp"><code>;; From calc-math.el, lines 37-82
(defvar math-emacs-precision
  (let* ((n 1)
         (x 9)
         (xx (+ x (* 9 (expt 10 (- n))))))
    (while (/= x xx)
      (progn
        (setq n (1+ n))
        (setq x xx)
        (setq xx (+ x (* 9 (expt 10 (- n)))))))
    (1- n))
  "The number of digits in an Emacs float.")

(defvar math-largest-emacs-expt
  (let ((x 1)
        (pow 1e2))
    ;; Find the largest power of 10 which is an Emacs float
    (while (and pow (&lt; pow 1.0e+INF))
      (setq x (* 2 x))
      (setq pow (ignore-errors (expt 10.0 (* 2 x)))))
    (setq pow (ignore-errors (expt 10.0 (1+ x))))
    (while (and pow (&lt; pow 1.0e+INF))
      (setq x (1+ x))
      (setq pow (ignore-errors (expt 10.0 (1+ x)))))
    (1- x))
  "The largest exponent which Calc will convert to an Emacs float.")

(defun math-use-emacs-fn (fn x)
  "Use the native Emacs function FN to evaluate the Calc number X.
If this can't be done, return NIL."
  (and
   (&lt;= calc-internal-prec math-emacs-precision)
   (math-realp x)
   (let* ((xpon (+ (nth 2 x) (1- (math-numdigs (nth 1 x))))))
     (and (&lt;= math-smallest-emacs-expt xpon)
          (&lt;= xpon math-largest-emacs-expt)
          (ignore-errors
            (math-read-number
             (number-to-string
              (funcall fn
                       (string-to-number
                        (let ((calc-number-radix 10)
                              (calc-twos-complement-mode nil))
                          (math-format-number x)))))))))))</code></pre>
<p>This code: - Determines Emacs float precision at compile time -
Delegates to native Emacs functions when possible - Falls back to
arbitrary-precision algorithms when needed</p>
<h2 data-number="17.7" id="algebraic-operations"><span class="header-section-number">17.7</span> Algebraic Operations</h2>
<h3 data-number="17.7.1" id="simplification-calc-alg.el"><span class="header-section-number">17.7.1</span> Simplification
(<code>calc-alg.el</code>)</h3>
<p>The algebraic module provides several levels of simplification:</p>
<pre class="elisp"><code>;; From calc.el, lines 721-729
(defcalcmodevar calc-simplify-mode 'alg
  "Type of simplification applied to results.
If `none', results are not simplified when pushed on the stack.
If `num', functions are simplified only when args are constant.
If nil, only limited simplifications are applied.
If `binary', `math-clip' is applied if appropriate.
If `alg', `math-simplify' is applied.
If `ext', `math-simplify-extended' is applied.
If `units', `math-simplify-units' is applied.")</code></pre>
<p><strong>Simplification modes</strong>: - <code>none</code>: No
automatic simplification - <code>num</code>: Numeric simplification only
- <code>nil</code>: Basic simplification - <code>binary</code>: Binary
mode simplification - <code>alg</code>: Algebraic simplification
(default) - <code>ext</code>: Extended simplification -
<code>units</code>: Unit-aware simplification</p>
<h3 data-number="17.7.2" id="symbolic-manipulation"><span class="header-section-number">17.7.2</span> Symbolic Manipulation</h3>
<p>From <code>calc-alg.el</code> (lines 53-66):</p>
<pre class="elisp"><code>(defun calc-simplify ()
  (interactive)
  (calc-slow-wrapper
   (let ((top (calc-top-n 1)))
     (if (calc-is-inverse)
         (setq top
               (let ((calc-simplify-mode nil))
                 (math-normalize (math-trig-rewrite top)))))
     (if (calc-is-hyperbolic)
         (setq top
               (let ((calc-simplify-mode nil))
                 (math-normalize (math-hyperbolic-trig-rewrite top)))))
     (calc-with-default-simplification
      (calc-enter-result 1 "simp" (math-simplify top))))))</code></pre>
<p><strong>Example simplifications</strong>: -
<code>sin(x)^2 + cos(x)^2</code> ‚Üí <code>1</code> - <code>(x+1)^2</code>
‚Üí <code>x^2 + 2x + 1</code> - <code>sqrt(8)</code> ‚Üí
<code>2*sqrt(2)</code> (in symbolic mode)</p>
<h2 data-number="17.8" id="calculus-calcalg2.el"><span class="header-section-number">17.8</span> Calculus
(<code>calcalg2.el</code>)</h2>
<p>The calculus module (3,682 lines) provides differentiation and
integration:</p>
<h3 data-number="17.8.1" id="differentiation"><span class="header-section-number">17.8.1</span> Differentiation</h3>
<pre class="elisp"><code>;; From calcalg2.el, lines 31-49
(defun calc-derivative (var num)
  (interactive "sDifferentiate with respect to: \np")
  (calc-slow-wrapper
   (when (&lt; num 0)
     (error "Order of derivative must be positive"))
   (let ((func (if (calc-is-hyperbolic) 'calcFunc-tderiv 'calcFunc-deriv))
         n expr)
     (if (or (equal var "") (equal var "$"))
         (setq n 2
               expr (calc-top-n 2)
               var (calc-top-n 1))
       (setq var (math-read-expr var))
       (when (eq (car-safe var) 'error)
         (error "Bad format in expression: %s" (nth 1 var)))
       (setq n 1
             expr (calc-top-n 1)))
     (while (&gt;= (setq num (1- num)) 0)
       (setq expr (list func expr var)))
     (calc-enter-result n "derv" expr))))</code></pre>
<p><strong>Differentiation features</strong>: - Symbolic derivatives of
elementary functions - Chain rule, product rule, quotient rule - Partial
derivatives (multiple variables) - Higher-order derivatives - Total
derivatives (<code>tderiv</code>)</p>
<h3 data-number="17.8.2" id="integration"><span class="header-section-number">17.8.2</span> Integration</h3>
<pre class="elisp"><code>;; From calcalg2.el, lines 51-65
(defun calc-integral (var &amp;optional arg)
  (interactive "sIntegration variable: \nP")
  (if arg
      (calc-tabular-command 'calcFunc-integ "Integration" "intg" nil var nil nil)
    (calc-slow-wrapper
     (if (or (equal var "") (equal var "$"))
         (calc-enter-result 2 "intg" (list 'calcFunc-integ
                                           (calc-top-n 2)
                                           (calc-top-n 1)))
       (let ((var (math-read-expr var)))
         (if (eq (car-safe var) 'error)
             (error "Bad format in expression: %s" (nth 1 var)))
         (calc-enter-result 1 "intg" (list 'calcFunc-integ
                                           (calc-top-n 1)
                                           var)))))))</code></pre>
<p><strong>Integration capabilities</strong>: - Symbolic integration of
elementary functions - Integration by parts - Integration by
substitution - Definite integrals - Numerical integration
(<code>ninteg</code>)</p>
<h2 data-number="17.9" id="vector-and-matrix-operations"><span class="header-section-number">17.9</span> Vector and Matrix
Operations</h2>
<h3 data-number="17.9.1" id="vector-representation-calc-vec.el"><span class="header-section-number">17.9.1</span> Vector Representation
(<code>calc-vec.el</code>)</h3>
<p>Vectors and matrices use the <code>vec</code> form:</p>
<pre class="elisp"><code>;; Vector: (vec element1 element2 ...)
;; Matrix: (vec (vec row1-col1 row1-col2 ...)
;;              (vec row2-col1 row2-col2 ...)
;;              ...)</code></pre>
<h3 data-number="17.9.2" id="matrix-operations-calc-mtx.el"><span class="header-section-number">17.9.2</span> Matrix Operations
(<code>calc-mtx.el</code>)</h3>
<p>From <code>calc-vec.el</code> documentation:</p>
<pre class="elisp"><code>;; From calc-vec.el, lines 611+
;;; Build a constant vector or matrix.  [Public]

;; From calc-vec.el, lines 910+
;;; Convert a scalar or vector into an NxN diagonal matrix.  [Public]

;; From calc-vec.el, lines 1072+
;;; Compute the row and column norms of a vector or matrix.  [Public]</code></pre>
<p><strong>Matrix capabilities</strong>: - Matrix multiplication -
Matrix inversion - Determinants - LU decomposition - Eigenvalues (via
external tools) - Row/column operations - Transpose, trace, rank</p>
<h2 data-number="17.10" id="units-system-calc-units.el"><span class="header-section-number">17.10</span> Units System
(<code>calc-units.el</code>)</h2>
<p>The units module (2,390 lines) provides comprehensive unit
conversion. From the file header:</p>
<pre class="elisp"><code>;;; Units table updated 9-Jan-91 by Ulrich M√ºller (ulm@vsnhd1.cern.ch)
;;; with some additions by Przemek Klosowski (przemek@rrdstrad.nist.gov)
;;; Updated April 2002 by Jochen K√ºpper

;;; Updated August 2007, using
;;;     CODATA (https://physics.nist.gov/cuu/Constants/index.html)
;;;     NIST   (https://physics.nist.gov/Pubs/SP811/appenB9.html)
;;;     ESUWM  (Encyclopaedia of Scientific Units, Weights and
;;;             Measures, by Fran√ßois Cardarelli)
;;; All conversions are exact unless otherwise noted.

;; Updated November 2018 for the redefinition of the SI
;; https://www.bipm.org/en/committees/cg/cgpm/26-2018/resolution-1

;; CODATA values last updated June 2024, using 2022 adjustment:
;; P. J. Mohr, E. Tiesinga, D. B. Newell, and B. N. Taylor (2024-05-08)</code></pre>
<p>Sample unit definitions (lines 53-100):</p>
<pre class="elisp"><code>(defvar math-standard-units
  '( ;; Length
    ( m       nil                    "*Meter" )
    ( in      "254*10^(-2) cm"       "Inch"  nil "2.54 cm")
    ( ft      "12 in"                "Foot")
    ( yd      "3 ft"                 "Yard" )
    ( mi      "5280 ft"              "Mile" )
    ( au      "149597870700 m"       "Astronomical Unit")
    ( lyr     "c yr"                 "Light Year" )
    ( pc      "(648000/pi) au"       "Parsec (**)")
    ( nmi     "1852 m"               "Nautical Mile" )

    ;; Area
    ( hect    "10000 m^2"            "*Hectare" )
    ( acre    "(1/640) mi^2"         "Acre" )

    ;; Volume
    ( L       "10^(-3) m^3"          "*Liter" )
    ( gal     "4 qt"                 "US Gallon" )

    ;; Time
    ( s       nil                    "*Second" )
    ( min     "60 s"                 "Minute" )
    ( hr      "60 min"               "Hour" )

    ;; Mass
    ( g       nil                    "*Gram" )
    ( lb      "16 oz"                "Pound (mass)" )

    ;; Force
    ( N       "m kg / s^2"           "*Newton" )
    ( dyn     "10^(-5) N"            "Dyne" )

    ;; Energy
    ( J       "N m"                  "*Joule" )
    ( eV      "ech V"                "Electron Volt" )
    ( cal     "4.184 J"              "Calorie" )

    ;; Power
    ( W       "J/s"                  "*Watt" )

    ;; And many more...
    ))</code></pre>
<p><strong>Unit features</strong>: - SI units and common non-SI units -
Automatic unit conversion - Unit simplification - Dimensional analysis -
Physical constants (speed of light, Planck‚Äôs constant, etc.)</p>
<h2 data-number="17.11" id="statistics-calc-stat.el"><span class="header-section-number">17.11</span> Statistics
(<code>calc-stat.el</code>)</h2>
<p>Statistical operations on vectors:</p>
<pre class="elisp"><code>;; From calc-stat.el, lines 31+
;;; Statistical operations on vectors.

(defun calc-vector-count (arg)
  (interactive "P")
  (calc-slow-wrapper
   (calc-vector-op "coun" 'calcFunc-vcount arg)))

(defun calc-vector-sum (arg)
  (interactive "P")
  (calc-slow-wrapper
   (if (calc-is-hyperbolic)
       (calc-vector-op "vprd" 'calcFunc-vprod arg)
     (calc-vector-op "vsum" 'calcFunc-vsum arg))))

(defun calc-vector-mean (arg)
  (interactive "P")
  (calc-slow-wrapper
   (if (calc-is-hyperbolic)
       (if (calc-is-inverse)
           (calc-vector-op "harm" 'calcFunc-vhmean arg)
         (calc-vector-op "medn" 'calcFunc-vmedian arg))
     (if (calc-is-inverse)
         (calc-vector-op "meae" 'calcFunc-vmeane arg)
       (calc-vector-op "mean" 'calcFunc-vmean arg)))))</code></pre>
<p><strong>Statistical capabilities</strong>: - Descriptive statistics:
mean, median, mode, variance, standard deviation - Correlation and
covariance - Linear regression - Curve fitting - Probability
distributions (normal, binomial, Poisson, etc.) - Hypothesis testing</p>
<h2 data-number="17.12" id="financial-functions-calc-fin.el"><span class="header-section-number">17.12</span> Financial Functions
(<code>calc-fin.el</code>)</h2>
<p>Time-value-of-money calculations:</p>
<pre class="elisp"><code>;; From calc-fin.el, lines 31+
;;; Financial functions.

(defun calc-fin-pv ()
  (interactive)
  (calc-slow-wrapper
   (if (calc-is-hyperbolic)
       (calc-enter-result 3 "pvl" (cons 'calcFunc-pvl (calc-top-list-n 3)))
     (let ((n (if (calc-is-option) 4 3)))
      (if (calc-is-inverse)
          (calc-enter-result n "pvb" (cons 'calcFunc-pvb (calc-top-list-n n)))
        (calc-enter-result n "pv" (cons 'calcFunc-pv (calc-top-list-n n))))))))

(defun calc-fin-npv (arg)
  (interactive "p")
  (calc-slow-wrapper
   (if (calc-is-inverse)
       (calc-vector-op "npvb" 'calcFunc-npvb (1+ arg))
     (calc-vector-op "npv" 'calcFunc-npv (1+ arg)))))</code></pre>
<p><strong>Financial calculations</strong>: - Present value (PV) and
future value (FV) - Net present value (NPV) - Internal rate of return
(IRR) - Payment schedules (PMT) - Loan amortization - Depreciation</p>
<h2 data-number="17.13" id="user-interface"><span class="header-section-number">17.13</span> User Interface</h2>
<h3 data-number="17.13.1" id="trail-buffer-calc-trail.el"><span class="header-section-number">17.13.1</span> Trail Buffer
(<code>calc-trail.el</code>)</h3>
<p>The trail maintains a history of all calculations:</p>
<pre class="elisp"><code>;; From calc-trail.el, lines 31+
;;; Trail commands.

(defun calc-trail-in ()
  (interactive)
  (let ((win (get-buffer-window (calc-trail-display t))))
    (and win (select-window win))))

(defun calc-trail-next (n)
  (interactive "p")
  (calc-with-trail-buffer
   (forward-line n)
   (calc-trail-here)))</code></pre>
<p><strong>Trail features</strong>: - Records all stack operations - Can
recall previous results - Searchable history - Can save/load trail
sessions</p>
<h3 data-number="17.13.2" id="embedded-mode-calc-embed.el"><span class="header-section-number">17.13.2</span> Embedded Mode
(<code>calc-embed.el</code>)</h3>
<p>Embedded mode allows Calc to operate directly in any buffer:</p>
<pre class="elisp"><code>;; From calc-embed.el, lines 64+
(defconst calc-embedded-mode-vars '(("twos-complement" . calc-twos-complement-mode)
                                    ("precision" . calc-internal-prec)
                                    ("word-size" . calc-word-size)
                                    ("angles" . calc-angle-mode)
                                    ("symbolic" . calc-symbolic-mode)
                                    ("matrix" . calc-matrix-mode)
                                    ("fractions" . calc-prefer-frac)
                                    ("complex" . calc-complex-mode)
                                    ("simplify" . calc-simplify-mode)
                                    ("language" . the-language)
                                    ("plain" . calc-show-plain)
                                    ("break" . calc-line-breaking)
                                    ("justify" . the-display-just)
                                    ("left-label" . calc-left-label)
                                    ("right-label" . calc-right-label)
                                    ("radix" . calc-number-radix)
                                    ("leading-zeros" . calc-leading-zeros)))</code></pre>
<p><strong>Embedded mode features</strong>: - Evaluates formulas in
place - Language-specific delimiters (LaTeX, C, Pascal, etc.) -
Automatic updates - Mode annotations embedded in comments</p>
<p>Example usage in a LaTeX document:</p>
<div class="sourceCode" id="cb606"><pre class="sourceCode latex"><code class="sourceCode latex"><span id="cb606-1"><a aria-hidden="true" href="#cb606-1" tabindex="-1"></a>The area of a circle is <span class="co">% Embed</span></span>
<span id="cb606-2"><a aria-hidden="true" href="#cb606-2" tabindex="-1"></a><span class="co">% calc-language: latex</span></span>
<span id="cb606-3"><a aria-hidden="true" href="#cb606-3" tabindex="-1"></a><span class="co">% calc-angles: rad</span></span>
<span id="cb606-4"><a aria-hidden="true" href="#cb606-4" tabindex="-1"></a><span class="ss">$$ A = </span><span class="sc">\pi</span><span class="ss"> r^2 = 3.14159 $$</span> <span class="co">% 3.14159265358979</span></span></code></pre></div>
<h3 data-number="17.13.3" id="complex-numbers-calc-cplx.el"><span class="header-section-number">17.13.3</span> Complex Numbers
(<code>calc-cplx.el</code>)</h3>
<p>Complex number support with multiple display formats:</p>
<pre class="elisp"><code>;; From calc-cplx.el, lines 59+
(defun calc-complex-notation ()
  (interactive)
  (calc-wrapper
   (calc-change-mode 'calc-complex-format nil t)
   (message "Displaying complex numbers in (X,Y) format")))

(defun calc-i-notation ()
  (interactive)
  (calc-wrapper
   (calc-change-mode 'calc-complex-format 'i t)
   (message "Displaying complex numbers in X+Yi format")))

(defun calc-j-notation ()
  (interactive)
  (calc-wrapper
   (calc-change-mode 'calc-complex-format 'j t)
   (message "Displaying complex numbers in X+Yj format")))

(defun calc-polar-mode (n)
  (interactive "P")
  (calc-wrapper
   (if (if n
           (&gt; (prefix-numeric-value n) 0)
         (eq calc-complex-mode 'cplx))
       (progn
         (calc-change-mode 'calc-complex-mode 'polar)
         (message "Preferring polar complex numbers"))
     (calc-change-mode 'calc-complex-mode 'cplx)
     (message "Preferring rectangular complex numbers"))))</code></pre>
<p><strong>Display formats</strong>: - <code>(2, 4)</code>: Rectangular
notation - <code>2+4i</code>: Engineering notation (i) -
<code>2+4j</code>: Engineering notation (j) - <code>(5; 1.107)</code>:
Polar notation (magnitude; angle)</p>
<h2 data-number="17.14" id="programming-features"><span class="header-section-number">17.14</span> Programming Features</h2>
<h3 data-number="17.14.1" id="user-defined-functions-calc-prog.el"><span class="header-section-number">17.14.1</span> User-Defined Functions
(<code>calc-prog.el</code>)</h3>
<p>The <code>defmath</code> macro simplifies creating Calc
functions:</p>
<pre class="elisp"><code>;; From calc.el, lines 3491-3504
;;;###autoload
(defmacro defmath (func args &amp;rest body)   ;  [Public]
  "Define Calc function.

Like `defun' except that code in the body of the definition can
make use of the full range of Calc data types and the usual
arithmetic operations are converted to their Calc equivalents.

The prefix `calcFunc-' is added to the specified name to get the
actual Lisp function name.

See Info node `(calc)Defining Functions'."
  (declare (doc-string 3) (indent defun))
  (require 'calc-ext)
  (math-do-defmath func args body))</code></pre>
<p><strong>Example</strong>:</p>
<pre class="elisp"><code>(defmath mysum (a b c)
  "Compute a + b + c"
  (+ a b c))

;; Creates: calcFunc-mysum
;; Automatically handles Calc types
;; Available as 'mysum(a,b,c)' in algebraic mode</code></pre>
<h3 data-number="17.14.2" id="keyboard-macros-2"><span class="header-section-number">17.14.2</span> Keyboard Macros</h3>
<p>Calc integrates with Emacs keyboard macros for repetitive
calculations.</p>
<h3 data-number="17.14.3" id="rewrite-rules-calc-rewr.el"><span class="header-section-number">17.14.3</span> Rewrite Rules
(<code>calc-rewr.el</code>)</h3>
<p>Powerful pattern-matching rewrite system (2,218 lines):</p>
<pre class="elisp"><code>;; Example rewrite rules:
;; sin(x)^2 + cos(x)^2 := 1
;; x + 0 := x
;; x * 1 := x
;; log(a*b) := log(a) + log(b)</code></pre>
<p>Users can define custom rewrite rules to automate algebraic
transformations.</p>
<h2 data-number="17.15" id="language-modes-calc-lang.el"><span class="header-section-number">17.15</span> Language Modes
(<code>calc-lang.el</code>)</h2>
<p>Calc can parse and format expressions in various languages (2,691
lines):</p>
<p><strong>Supported languages</strong>: - <code>normal</code>: Standard
Calc notation - <code>flat</code>: One-line format - <code>big</code>:
Large-character notation - <code>unform</code>: Unformatted Lisp -
<code>c</code>: C/C++ syntax - <code>pascal</code>: Pascal syntax -
<code>fortran</code>: Fortran syntax - <code>tex</code>: TeX/LaTeX
notation - <code>latex</code>: LaTeX-specific - <code>eqn</code>: Eqn
(troff) notation - <code>yacas</code>: Yacas CAS syntax -
<code>maxima</code>: Maxima syntax - <code>giac</code>: Giac syntax -
<code>math</code>: Mathematica syntax - <code>maple</code>: Maple
syntax</p>
<p>Example in different languages:</p>
<pre><code>Normal:   sqrt(x^2 + y^2)
Big:          __________
             / 2    2
            ‚àö x  + y

TeX:      \sqrt{x^{2} + y^{2}}
C:        sqrt(x*x + y*y)
Fortran:  SQRT(X**2 + Y**2)</code></pre>
<h2 data-number="17.16" id="precision-and-modes"><span class="header-section-number">17.16</span> Precision and Modes</h2>
<h3 data-number="17.16.1" id="precision-control"><span class="header-section-number">17.16.1</span> Precision Control</h3>
<p>From <code>calc.el</code> (lines 737-738):</p>
<pre class="elisp"><code>(defcalcmodevar calc-internal-prec 12
  "Number of digits of internal precision for calc-mode calculations.")</code></pre>
<p>Users can set precision from 3 to thousands of digits.</p>
<h3 data-number="17.16.2" id="angular-modes"><span class="header-section-number">17.16.2</span> Angular Modes</h3>
<pre class="elisp"><code>(defcalcmodevar calc-angle-mode 'deg
  "If deg, angles are in degrees; if rad, angles are in radians.
If hms, angles are in degrees-minutes-seconds.")</code></pre>
<p><strong>Angle modes</strong>: - <code>deg</code>: Degrees (default) -
<code>rad</code>: Radians - <code>hms</code>: Hours-minutes-seconds
(sexagesimal)</p>
<h3 data-number="17.16.3" id="display-modes"><span class="header-section-number">17.16.3</span> Display Modes</h3>
<p>From <code>calc.el</code> (lines 476-487):</p>
<pre class="elisp"><code>(defvar calc-display-sci-high 0
  "Floating-point numbers with this positive exponent or higher above the
current precision are displayed in scientific notation in `calc-mode'.")

(defvar calc-display-sci-low -3
  "Floating-point numbers with this negative exponent or lower are displayed
scientific notation in `calc-mode'.")</code></pre>
<p><strong>Number display formats</strong>: - Normal:
<code>12345.6789</code> - Scientific: <code>1.23456789e4</code> -
Engineering: <code>12.3456789e3</code> - Fixed-point: Always show
decimals - Binary, octal, hexadecimal - Fractions: <code>17:3</code>
(17/3)</p>
<h2 data-number="17.17" id="advanced-features-1"><span class="header-section-number">17.17</span> Advanced Features</h2>
<h3 data-number="17.17.1" id="arbitrary-precision"><span class="header-section-number">17.17.1</span> Arbitrary Precision</h3>
<p>Calc uses Lisp integers for arbitrary-precision arithmetic:</p>
<pre class="elisp"><code>;; Examples:
12345678901234567890123456789012345678901234567890  ; Exact integer
(factorial 100)  ; 93326215443944152681699238856266700490715968264381621468592963895217599993229915608941463976156518286253697920827223758251185210916864000000000000000000000000</code></pre>
<h3 data-number="17.17.2" id="symbolic-computation"><span class="header-section-number">17.17.2</span> Symbolic Computation</h3>
<p>Variables and symbolic expressions:</p>
<pre class="elisp"><code>;; From calc.el, lines 2596-2600
;; (var V S)               Symbolic variable.  V is a Lisp symbol which
;;                         represents the variable's visible name.  S is
;;                         the symbol which actually stores the variable's
;;                         value:  (var pi var-pi).</code></pre>
<p><strong>Example symbolic operations</strong>: - Simplify:
<code>(x+1)^2</code> ‚Üí <code>x^2 + 2*x + 1</code> - Factor:
<code>x^2 - 1</code> ‚Üí <code>(x-1)*(x+1)</code> - Solve:
<code>x^2 - 4 = 0</code> ‚Üí <code>x = 2</code> or <code>x = -2</code> -
Differentiate: <code>d/dx sin(x^2)</code> ‚Üí <code>2*x*cos(x^2)</code> -
Integrate: <code>‚à´ x*e^x dx</code> ‚Üí <code>x*e^x - e^x</code></p>
<h3 data-number="17.17.3" id="error-forms-and-intervals"><span class="header-section-number">17.17.3</span> Error Forms and
Intervals</h3>
<p><strong>Error forms</strong> (uncertainties):</p>
<pre class="elisp"><code>;; (sdev X SIGMA)          Error form, X +/- SIGMA.
100 +/- 5   ; Represented as (sdev 100 5)</code></pre>
<p>Error propagation through calculations: -
<code>(100 ¬± 5) + (200 ¬± 3)</code> ‚Üí <code>300 ¬± 5.83095</code> (‚àö(5¬≤ +
3¬≤)) - <code>(10 ¬± 0.1) * (20 ¬± 0.2)</code> ‚Üí <code>200 ¬± 2.236</code>
(propagated via calculus)</p>
<p><strong>Intervals</strong>:</p>
<pre class="elisp"><code>;; (intv MASK LO HI)       Interval form.  MASK is 0=(), 1=(], 2=[), or 3=[].
[1 .. 4]    ; Closed interval
(1 .. 4)    ; Open interval
[1 .. 4)    ; Half-open interval</code></pre>
<p>Interval arithmetic: - <code>[1..2] + [3..4]</code> ‚Üí
<code>[4..6]</code> - <code>[2..3] * [4..5]</code> ‚Üí
<code>[8..15]</code></p>
<h2 data-number="17.18" id="extension-points"><span class="header-section-number">17.18</span> Extension Points</h2>
<h3 data-number="17.18.1" id="custom-functions"><span class="header-section-number">17.18.1</span> Custom Functions</h3>
<p>Users can add custom functions via several mechanisms:</p>
<ol type="1">
<li><strong>defmath macro</strong>: For Lisp programmers</li>
<li><strong>Keyboard macros</strong>: For keyboard-driven function
definition</li>
<li><strong>Rewrite rules</strong>: For algebraic transformations</li>
<li><strong>External programs</strong>: Via GNUPLOT or other tools</li>
</ol>
<h3 data-number="17.18.2" id="hooks-2"><span class="header-section-number">17.18.2</span> Hooks</h3>
<pre class="elisp"><code>(defvar calc-load-hook nil
  "Hook run when Calc is loaded.")

(defvar calc-mode-hook nil
  "Hook run when entering Calc mode.")</code></pre>
<h3 data-number="17.18.3" id="settings-persistence"><span class="header-section-number">17.18.3</span> Settings Persistence</h3>
<pre class="elisp"><code>;; From calc.el, lines 232-235
(defcustom calc-settings-file
  (locate-user-emacs-file "calc.el" ".calc.el")
  "File in which to record permanent settings."
  :type '(file))</code></pre>
<p>User customizations are automatically saved to
<code>~/.emacs.d/calc.el</code>.</p>
<h2 data-number="17.19" id="implementation-insights"><span class="header-section-number">17.19</span> Implementation Insights</h2>
<h3 data-number="17.19.1" id="performance-optimizations-1"><span class="header-section-number">17.19.1</span> Performance
Optimizations</h3>
<ol type="1">
<li><strong>Lazy loading</strong>: Modules loaded on-demand</li>
<li><strong>Native arithmetic</strong>: Uses Lisp integers when
possible</li>
<li><strong>Precision limiting</strong>: Tracks precision to avoid
unnecessary computation</li>
<li><strong>Caching</strong>: Results cached for expensive
operations</li>
<li><strong>Native function delegation</strong>: Uses Emacs native
functions when precision allows</li>
</ol>
<p>Example from <code>calc-math.el</code> (lines 84-100):</p>
<pre class="elisp"><code>(defun math-use-emacs-fn (fn x)
  "Use the native Emacs function FN to evaluate the Calc number X.
If this can't be done, return NIL."
  (and
   (&lt;= calc-internal-prec math-emacs-precision)
   (math-realp x)
   (let* ((xpon (+ (nth 2 x) (1- (math-numdigs (nth 1 x))))))
     (and (&lt;= math-smallest-emacs-expt xpon)
          (&lt;= xpon math-largest-emacs-expt)
          (ignore-errors
            (math-read-number
             (number-to-string
              (funcall fn
                       (string-to-number
                        (let ((calc-number-radix 10)
                              (calc-twos-complement-mode nil))
                          (math-format-number x)))))))))))</code></pre>
<h3 data-number="17.19.2" id="error-handling"><span class="header-section-number">17.19.2</span> Error Handling</h3>
<p>Calc uses a sophisticated error recording system:</p>
<pre class="elisp"><code>;; Errors are recorded but don't necessarily abort
(calc-record-why "*Wrong number of arguments" expr)
(calc-record-why "Division by zero" expr)
(calc-record-why "*Floating-point overflow occurred" expr)</code></pre>
<p>Errors can be reviewed with the <code>w</code> (why) command.</p>
<h3 data-number="17.19.3" id="normalization-philosophy"><span class="header-section-number">17.19.3</span> Normalization
Philosophy</h3>
<p>All operations produce normalized results: - Ensures canonical
representation - Simplifies equality testing - Prevents error
accumulation - Makes pattern matching reliable</p>
<h2 data-number="17.20" id="usage-examples"><span class="header-section-number">17.20</span> Usage Examples</h2>
<h3 data-number="17.20.1" id="basic-rpn-calculations"><span class="header-section-number">17.20.1</span> Basic RPN Calculations</h3>
<pre><code>2 RET 3 +          ‚Üí 5
10 RET 3 /         ‚Üí 3.33333...
2 RET 3 RET 4 * +  ‚Üí 14  (2 + 3*4)</code></pre>
<h3 data-number="17.20.2" id="algebraic-entry"><span class="header-section-number">17.20.2</span> Algebraic Entry</h3>
<pre><code>' 2+3*4 RET        ‚Üí 14
' sin(pi/4) RET    ‚Üí 0.707106... (or sqrt(2)/2 in exact mode)
' integrate(x^2, x) RET  ‚Üí x^3/3</code></pre>
<h3 data-number="17.20.3" id="matrix-operations"><span class="header-section-number">17.20.3</span> Matrix Operations</h3>
<pre><code>[[1, 2], [3, 4]] RET    ; Enter matrix
RET &amp;                    ; Duplicate and invert
*                        ; Multiply by inverse ‚Üí identity matrix</code></pre>
<h3 data-number="17.20.4" id="unit-conversions"><span class="header-section-number">17.20.4</span> Unit Conversions</h3>
<pre><code>100 u c              ; Convert 100 to specified unit
55 mph RET u c m/s   ; 55 mph ‚Üí 24.5872 m/s
9.8 m/s^2 u c ft/s^2 ; Acceleration conversion</code></pre>
<h3 data-number="17.20.5" id="symbolic-computation-1"><span class="header-section-number">17.20.5</span> Symbolic Computation</h3>
<pre><code>' x^2 - 4 RET a f    ; Factor ‚Üí (x-2)*(x+2)
' sin(x) RET a d x   ; Differentiate ‚Üí cos(x)
' x*e^x RET a i x    ; Integrate ‚Üí x*e^x - e^x</code></pre>
<h2 data-number="17.21" id="integration-with-emacs"><span class="header-section-number">17.21</span> Integration with Emacs</h2>
<h3 data-number="17.21.1" id="embedding-in-buffers"><span class="header-section-number">17.21.1</span> Embedding in Buffers</h3>
<p>Calc can evaluate formulas directly in any buffer:</p>
<pre><code>C-x * e    ; Activate embedded mode</code></pre>
<p>Example in a text file:</p>
<pre><code>The area of a circle with radius 5 is:
pi * 5^2 = 78.5398163397448</code></pre>
<h3 data-number="17.21.2" id="quick-calculations"><span class="header-section-number">17.21.2</span> Quick Calculations</h3>
<pre><code>C-x * q    ; Quick calc (minibuffer)
M-x quick-calc</code></pre>
<h3 data-number="17.21.3" id="graph-integration"><span class="header-section-number">17.21.3</span> Graph Integration</h3>
<p>Calc integrates with GNUPLOT for visualization:</p>
<pre><code>' sin(x) RET        ; Define function
g f                 ; Fast plot
g a                 ; Add to plot
g p                 ; Print/save plot</code></pre>
<h2 data-number="17.22" id="design-philosophy-2"><span class="header-section-number">17.22</span> Design Philosophy</h2>
<h3 data-number="17.22.1" id="comprehensiveness"><span class="header-section-number">17.22.1</span> Comprehensiveness</h3>
<p>Calc aims to be a complete mathematical environment: - ‚ÄúDo everything
a scientific calculator can do, and much more‚Äù - Support for diverse
mathematical domains - Extensible architecture for user additions</p>
<h3 data-number="17.22.2" id="precision-and-correctness"><span class="header-section-number">17.22.2</span> Precision and
Correctness</h3>
<ul>
<li>Arbitrary precision by default</li>
<li>Exact arithmetic when possible</li>
<li>Clear distinction between exact and approximate</li>
<li>Comprehensive error handling</li>
</ul>
<h3 data-number="17.22.3" id="integration-1"><span class="header-section-number">17.22.3</span> Integration</h3>
<ul>
<li>Deep integration with Emacs</li>
<li>Embedded mode for document calculations</li>
<li>Trail for reproducibility</li>
<li>Language modes for various syntaxes</li>
</ul>
<h3 data-number="17.22.4" id="discoverability"><span class="header-section-number">17.22.4</span> Discoverability</h3>
<ul>
<li>Extensive help system (<code>h i</code> for manual)</li>
<li>Tutorial mode</li>
<li>Progressive disclosure (basic ‚Üí advanced)</li>
<li>Mnemonic key bindings</li>
</ul>
<h2 data-number="17.23" id="historical-note"><span class="header-section-number">17.23</span> Historical Note</h2>
<p>From the file headers, Calc was created by David Gillespie while at
Caltech, later at Synaptics. It represents one of the most comprehensive
computer algebra systems available in any text editor, rivaling
standalone systems like Mathematica, Maple, and Maxima in many
capabilities.</p>
<p>The TODO section in <code>calc.el</code> (lines 47-137) reveals
ongoing development priorities: - Improved rewrite mechanisms - Matrix
eigenvalues and SVD - Better numerical integration - Enhanced TeX
parsing - More tutorial examples - Spreadsheet-like features</p>
<h2 data-number="17.24" id="summary-3"><span class="header-section-number">17.24</span> Summary</h2>
<p>Calc demonstrates several advanced Emacs programming techniques:</p>
<ol type="1">
<li><strong>Modular architecture</strong>: 43 files with clear
separation of concerns</li>
<li><strong>Lazy loading</strong>: Sophisticated autoload system for
fast startup</li>
<li><strong>Type system</strong>: Rich internal representation with
normalization</li>
<li><strong>DSL integration</strong>: Multiple external language
syntaxes</li>
<li><strong>Symbolic computation</strong>: Full algebraic
manipulation</li>
<li><strong>Numerical methods</strong>: Arbitrary precision with
performance optimization</li>
<li><strong>User extensibility</strong>: Multiple extension
mechanisms</li>
<li><strong>Mode integration</strong>: Stack, algebraic, embedded, and
keypad modes</li>
</ol>
<p>The codebase showcases Lisp‚Äôs strengths in symbolic computation while
maintaining practical performance through careful optimization. It
remains one of Emacs‚Äôs most sophisticated subsystems, providing
professional-grade mathematical capabilities within the editor.</p>
<hr/>
<p><strong>Key Files Reference</strong>: -
<code>/home/user/emacs/lisp/calc/calc.el</code> - Core system (3,532
lines) - <code>/home/user/emacs/lisp/calc/calc-ext.el</code> - Extension
loader (3,434 lines) -
<code>/home/user/emacs/lisp/calc/calc-arith.el</code> - Arithmetic
(3,067 lines) - <code>/home/user/emacs/lisp/calc/calcalg2.el</code> -
Calculus (3,682 lines) -
<code>/home/user/emacs/lisp/calc/calc-units.el</code> - Units (2,390
lines) - <code>/home/user/emacs/lisp/calc/calc-lang.el</code> -
Languages (2,691 lines) -
<code>/home/user/emacs/lisp/calc/calc-prog.el</code> - Programming
(2,190 lines)</p>
<h1 data-number="18" id="platform-abstraction-layer-a-literate-programming-guide"><span class="header-section-number">18</span> Platform Abstraction Layer: A
Literate Programming Guide</h1>
<p><strong>Author:</strong> Documentation Team <strong>Last
Updated:</strong> 2025-11-18 <strong>Primary Sources:</strong>
<code>/home/user/emacs/src/termhooks.h</code>,
<code>/home/user/emacs/src/dispextern.h</code>,
<code>/home/user/emacs/src/terminal.c</code>,
<code>/home/user/emacs/src/xterm.c</code>,
<code>/home/user/emacs/src/w32term.c</code></p>
<hr/>
<h2 data-number="18.1" id="table-of-contents-7"><span class="header-section-number">18.1</span> Table of Contents</h2>
<ol type="1">
<li><a href="#executive-summary">Executive Summary</a></li>
<li><a href="#platform-overview">Platform Overview</a></li>
<li><a href="#core-abstraction-layer">Core Abstraction Layer</a></li>
<li><a href="#platform-implementations">Platform
Implementations</a></li>
<li><a href="#common-patterns">Common Patterns</a></li>
<li><a href="#case-study-x11-implementation">Case Study: X11
Implementation</a></li>
<li><a href="#integration-guide">Integration Guide</a></li>
<li><a href="#references">References</a></li>
</ol>
<hr/>
<h2 data-number="18.2" id="executive-summary-1"><span class="header-section-number">18.2</span> Executive Summary</h2>
<p>Emacs‚Äôs platform abstraction architecture is a masterclass in
portable software design. The system supports <strong>8 major
platforms</strong> through a carefully designed three-layer
architecture:</p>
<ol type="1">
<li><strong>Platform-Independent Layer</strong>: Common redisplay engine
and event processing</li>
<li><strong>Abstraction Interface</strong>: <code>struct terminal</code>
and <code>struct redisplay_interface</code></li>
<li><strong>Platform-Specific Implementations</strong>: X11, Windows,
macOS, Android, Haiku, GTK, TTY</li>
</ol>
<p>This document provides a literate programming exploration of how
Emacs achieves portability while maintaining performance and
platform-specific features.</p>
<p><strong>Key Statistics:</strong> - 8+ supported platforms (X11,
Windows, macOS/NS, Android, Haiku, GTK/PGTK, TTY, DOS) - ~60 hook
functions in the terminal abstraction - ~30 methods in the redisplay
interface - 19 Windows-specific files, 12 Android files, 8 Haiku files,
10+ X11 files</p>
<hr/>
<h2 data-number="18.3" id="platform-overview"><span class="header-section-number">18.3</span> Platform Overview</h2>
<h3 data-number="18.3.1" id="supported-platforms"><span class="header-section-number">18.3.1</span> 1.1 Supported Platforms</h3>
<p>Emacs defines its platform support through the
<code>enum output_method</code> type, found in
<code>/home/user/emacs/src/termhooks.h</code>:</p>
<div class="sourceCode" id="cb632"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb632-1"><a aria-hidden="true" href="#cb632-1" tabindex="-1"></a><span class="co">/* Output method of a terminal (and frames on this terminal, respectively).  */</span></span>
<span id="cb632-2"><a aria-hidden="true" href="#cb632-2" tabindex="-1"></a></span>
<span id="cb632-3"><a aria-hidden="true" href="#cb632-3" tabindex="-1"></a><span class="kw">enum</span> output_method</span>
<span id="cb632-4"><a aria-hidden="true" href="#cb632-4" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb632-5"><a aria-hidden="true" href="#cb632-5" tabindex="-1"></a>  output_initial<span class="op">,</span>      <span class="co">// Bootstrap terminal before real initialization</span></span>
<span id="cb632-6"><a aria-hidden="true" href="#cb632-6" tabindex="-1"></a>  output_termcap<span class="op">,</span>      <span class="co">// TTY/terminal using termcap/terminfo</span></span>
<span id="cb632-7"><a aria-hidden="true" href="#cb632-7" tabindex="-1"></a>  output_x_window<span class="op">,</span>     <span class="co">// X Window System (X11)</span></span>
<span id="cb632-8"><a aria-hidden="true" href="#cb632-8" tabindex="-1"></a>  output_msdos_raw<span class="op">,</span>    <span class="co">// MS-DOS direct video memory access</span></span>
<span id="cb632-9"><a aria-hidden="true" href="#cb632-9" tabindex="-1"></a>  output_w32<span class="op">,</span>          <span class="co">// Microsoft Windows (Win32 API)</span></span>
<span id="cb632-10"><a aria-hidden="true" href="#cb632-10" tabindex="-1"></a>  output_ns<span class="op">,</span>           <span class="co">// macOS/GNUstep (NextStep/Cocoa)</span></span>
<span id="cb632-11"><a aria-hidden="true" href="#cb632-11" tabindex="-1"></a>  output_pgtk<span class="op">,</span>         <span class="co">// Pure GTK (Wayland-compatible)</span></span>
<span id="cb632-12"><a aria-hidden="true" href="#cb632-12" tabindex="-1"></a>  output_haiku<span class="op">,</span>        <span class="co">// Haiku OS (BeOS successor)</span></span>
<span id="cb632-13"><a aria-hidden="true" href="#cb632-13" tabindex="-1"></a>  output_android<span class="op">,</span>      <span class="co">// Android mobile platform</span></span>
<span id="cb632-14"><a aria-hidden="true" href="#cb632-14" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<p><strong>Location:</strong>
<code>/home/user/emacs/src/termhooks.h:57-68</code></p>
<p>Each platform provides: - <strong>Window system integration</strong>:
Creating, managing, and destroying windows - <strong>Event
handling</strong>: Mouse, keyboard, and system events -
<strong>Rendering</strong>: Text, images, and graphical elements -
<strong>Platform services</strong>: Clipboard, drag-and-drop,
notifications</p>
<h3 data-number="18.3.2" id="design-philosophy-3"><span class="header-section-number">18.3.2</span> 1.2 Design Philosophy</h3>
<p>The abstraction follows these principles:</p>
<ol type="1">
<li><strong>Minimal Common Interface</strong>: The abstraction defines
the minimum required for portability</li>
<li><strong>Optional Extensions</strong>: Platforms can provide
additional capabilities through optional hooks</li>
<li><strong>Zero-Cost Abstraction</strong>: Most calls are direct
function pointers (no virtual dispatch overhead)</li>
<li><strong>Compile-Time Selection</strong>: Platform code is selected
at compile time via preprocessor</li>
<li><strong>Runtime Flexibility</strong>: Multiple terminals can coexist
(e.g., X11 + TTY simultaneously)</li>
</ol>
<hr/>
<h2 data-number="18.4" id="core-abstraction-layer"><span class="header-section-number">18.4</span> Core Abstraction Layer</h2>
<h3 data-number="18.4.1" id="the-terminal-structure"><span class="header-section-number">18.4.1</span> 2.1 The Terminal
Structure</h3>
<p>The <code>struct terminal</code> is the central abstraction for all
platform implementations. It represents a single display device
(graphical or text-based).</p>
<div class="sourceCode" id="cb633"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb633-1"><a aria-hidden="true" href="#cb633-1" tabindex="-1"></a><span class="co">/* Terminal-local parameters. */</span></span>
<span id="cb633-2"><a aria-hidden="true" href="#cb633-2" tabindex="-1"></a><span class="kw">struct</span> terminal</span>
<span id="cb633-3"><a aria-hidden="true" href="#cb633-3" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb633-4"><a aria-hidden="true" href="#cb633-4" tabindex="-1"></a>  <span class="co">/* This is for Lisp; the terminal code does not refer to it.  */</span></span>
<span id="cb633-5"><a aria-hidden="true" href="#cb633-5" tabindex="-1"></a>  <span class="kw">union</span> vectorlike_header header<span class="op">;</span></span>
<span id="cb633-6"><a aria-hidden="true" href="#cb633-6" tabindex="-1"></a></span>
<span id="cb633-7"><a aria-hidden="true" href="#cb633-7" tabindex="-1"></a>  <span class="co">/* Parameter alist of this terminal.  */</span></span>
<span id="cb633-8"><a aria-hidden="true" href="#cb633-8" tabindex="-1"></a>  Lisp_Object param_alist<span class="op">;</span></span>
<span id="cb633-9"><a aria-hidden="true" href="#cb633-9" tabindex="-1"></a></span>
<span id="cb633-10"><a aria-hidden="true" href="#cb633-10" tabindex="-1"></a>  <span class="co">/* List of charsets supported by the terminal.  */</span></span>
<span id="cb633-11"><a aria-hidden="true" href="#cb633-11" tabindex="-1"></a>  Lisp_Object charset_list<span class="op">;</span></span>
<span id="cb633-12"><a aria-hidden="true" href="#cb633-12" tabindex="-1"></a></span>
<span id="cb633-13"><a aria-hidden="true" href="#cb633-13" tabindex="-1"></a>  <span class="co">/* X selections that Emacs might own on this terminal.  */</span></span>
<span id="cb633-14"><a aria-hidden="true" href="#cb633-14" tabindex="-1"></a>  Lisp_Object Vselection_alist<span class="op">;</span></span>
<span id="cb633-15"><a aria-hidden="true" href="#cb633-15" tabindex="-1"></a></span>
<span id="cb633-16"><a aria-hidden="true" href="#cb633-16" tabindex="-1"></a>  <span class="co">/* Character to terminal glyph code mapping.  */</span></span>
<span id="cb633-17"><a aria-hidden="true" href="#cb633-17" tabindex="-1"></a>  Lisp_Object glyph_code_table<span class="op">;</span></span>
<span id="cb633-18"><a aria-hidden="true" href="#cb633-18" tabindex="-1"></a></span>
<span id="cb633-19"><a aria-hidden="true" href="#cb633-19" tabindex="-1"></a>  <span class="co">/* All earlier fields should be Lisp_Objects and are traced by GC.</span></span>
<span id="cb633-20"><a aria-hidden="true" href="#cb633-20" tabindex="-1"></a><span class="co">     All fields afterwards are ignored by the GC.  */</span></span>
<span id="cb633-21"><a aria-hidden="true" href="#cb633-21" tabindex="-1"></a></span>
<span id="cb633-22"><a aria-hidden="true" href="#cb633-22" tabindex="-1"></a>  <span class="co">/* Chain of all terminal devices. */</span></span>
<span id="cb633-23"><a aria-hidden="true" href="#cb633-23" tabindex="-1"></a>  <span class="kw">struct</span> terminal <span class="op">*</span>next_terminal<span class="op">;</span></span>
<span id="cb633-24"><a aria-hidden="true" href="#cb633-24" tabindex="-1"></a></span>
<span id="cb633-25"><a aria-hidden="true" href="#cb633-25" tabindex="-1"></a>  <span class="co">/* Unique id for this terminal device. */</span></span>
<span id="cb633-26"><a aria-hidden="true" href="#cb633-26" tabindex="-1"></a>  <span class="dt">int</span> id<span class="op">;</span></span>
<span id="cb633-27"><a aria-hidden="true" href="#cb633-27" tabindex="-1"></a></span>
<span id="cb633-28"><a aria-hidden="true" href="#cb633-28" tabindex="-1"></a>  <span class="co">/* The number of frames that are on this terminal. */</span></span>
<span id="cb633-29"><a aria-hidden="true" href="#cb633-29" tabindex="-1"></a>  <span class="dt">int</span> reference_count<span class="op">;</span></span>
<span id="cb633-30"><a aria-hidden="true" href="#cb633-30" tabindex="-1"></a></span>
<span id="cb633-31"><a aria-hidden="true" href="#cb633-31" tabindex="-1"></a>  <span class="co">/* The type of the terminal device. */</span></span>
<span id="cb633-32"><a aria-hidden="true" href="#cb633-32" tabindex="-1"></a>  <span class="kw">enum</span> output_method type<span class="op">;</span></span>
<span id="cb633-33"><a aria-hidden="true" href="#cb633-33" tabindex="-1"></a></span>
<span id="cb633-34"><a aria-hidden="true" href="#cb633-34" tabindex="-1"></a>  <span class="co">/* The name of the terminal device. */</span></span>
<span id="cb633-35"><a aria-hidden="true" href="#cb633-35" tabindex="-1"></a>  <span class="dt">char</span> <span class="op">*</span>name<span class="op">;</span></span>
<span id="cb633-36"><a aria-hidden="true" href="#cb633-36" tabindex="-1"></a></span>
<span id="cb633-37"><a aria-hidden="true" href="#cb633-37" tabindex="-1"></a>  <span class="co">/* The terminal's keyboard object. */</span></span>
<span id="cb633-38"><a aria-hidden="true" href="#cb633-38" tabindex="-1"></a>  <span class="kw">struct</span> kboard <span class="op">*</span>kboard<span class="op">;</span></span>
<span id="cb633-39"><a aria-hidden="true" href="#cb633-39" tabindex="-1"></a></span>
<span id="cb633-40"><a aria-hidden="true" href="#cb633-40" tabindex="-1"></a>  <span class="co">/* Device-type dependent data shared amongst all frames on this terminal.  */</span></span>
<span id="cb633-41"><a aria-hidden="true" href="#cb633-41" tabindex="-1"></a>  <span class="kw">union</span> display_info</span>
<span id="cb633-42"><a aria-hidden="true" href="#cb633-42" tabindex="-1"></a>  <span class="op">{</span></span>
<span id="cb633-43"><a aria-hidden="true" href="#cb633-43" tabindex="-1"></a>    <span class="kw">struct</span> tty_display_info <span class="op">*</span>tty<span class="op">;</span>        <span class="co">// termchar.h</span></span>
<span id="cb633-44"><a aria-hidden="true" href="#cb633-44" tabindex="-1"></a>    <span class="kw">struct</span> x_display_info <span class="op">*</span>x<span class="op">;</span>            <span class="co">// xterm.h</span></span>
<span id="cb633-45"><a aria-hidden="true" href="#cb633-45" tabindex="-1"></a>    <span class="kw">struct</span> w32_display_info <span class="op">*</span>w32<span class="op">;</span>        <span class="co">// w32term.h</span></span>
<span id="cb633-46"><a aria-hidden="true" href="#cb633-46" tabindex="-1"></a>    <span class="kw">struct</span> ns_display_info <span class="op">*</span>ns<span class="op">;</span>          <span class="co">// nsterm.h</span></span>
<span id="cb633-47"><a aria-hidden="true" href="#cb633-47" tabindex="-1"></a>    <span class="kw">struct</span> pgtk_display_info <span class="op">*</span>pgtk<span class="op">;</span>      <span class="co">// pgtkterm.h</span></span>
<span id="cb633-48"><a aria-hidden="true" href="#cb633-48" tabindex="-1"></a>    <span class="kw">struct</span> haiku_display_info <span class="op">*</span>haiku<span class="op">;</span>    <span class="co">// haikuterm.h</span></span>
<span id="cb633-49"><a aria-hidden="true" href="#cb633-49" tabindex="-1"></a>    <span class="kw">struct</span> android_display_info <span class="op">*</span>android<span class="op">;</span><span class="co">// androidterm.h</span></span>
<span id="cb633-50"><a aria-hidden="true" href="#cb633-50" tabindex="-1"></a>  <span class="op">}</span> display_info<span class="op">;</span></span>
<span id="cb633-51"><a aria-hidden="true" href="#cb633-51" tabindex="-1"></a></span>
<span id="cb633-52"><a aria-hidden="true" href="#cb633-52" tabindex="-1"></a>  <span class="co">/* Coding systems for terminal I/O */</span></span>
<span id="cb633-53"><a aria-hidden="true" href="#cb633-53" tabindex="-1"></a>  <span class="kw">struct</span> coding_system <span class="op">*</span>terminal_coding<span class="op">;</span>  <span class="co">// Output encoding</span></span>
<span id="cb633-54"><a aria-hidden="true" href="#cb633-54" tabindex="-1"></a>  <span class="kw">struct</span> coding_system <span class="op">*</span>keyboard_coding<span class="op">;</span>  <span class="co">// Input decoding</span></span>
<span id="cb633-55"><a aria-hidden="true" href="#cb633-55" tabindex="-1"></a></span>
<span id="cb633-56"><a aria-hidden="true" href="#cb633-56" tabindex="-1"></a>  <span class="co">/* Window-based redisplay interface (0 for tty devices). */</span></span>
<span id="cb633-57"><a aria-hidden="true" href="#cb633-57" tabindex="-1"></a>  <span class="kw">struct</span> redisplay_interface <span class="op">*</span>rif<span class="op">;</span></span>
<span id="cb633-58"><a aria-hidden="true" href="#cb633-58" tabindex="-1"></a></span>
<span id="cb633-59"><a aria-hidden="true" href="#cb633-59" tabindex="-1"></a>  <span class="co">/* ... Hook functions follow ... */</span></span>
<span id="cb633-60"><a aria-hidden="true" href="#cb633-60" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<p><strong>Location:</strong>
<code>/home/user/emacs/src/termhooks.h:472-878</code></p>
<p><strong>Key Insights:</strong></p>
<ol type="1">
<li><strong>Lisp Integration</strong>: First five fields are Lisp
objects, making terminals garbage-collected</li>
<li><strong>Union for Display Info</strong>: Platform-specific data
stored in tagged union (type-safe)</li>
<li><strong>Reference Counting</strong>: Terminals are deleted when
<code>reference_count</code> reaches zero</li>
<li><strong>Coding Systems</strong>: Separate encoding for input/output
handles internationalization</li>
</ol>
<h3 data-number="18.4.2" id="terminal-hook-functions"><span class="header-section-number">18.4.2</span> 2.2 Terminal Hook
Functions</h3>
<p>The terminal structure contains ~40 hook function pointers for
various operations:</p>
<h4 data-number="18.4.2.1" id="text-display-hooks-tty-centric"><span class="header-section-number">18.4.2.1</span> Text Display Hooks
(TTY-centric)</h4>
<div class="sourceCode" id="cb634"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb634-1"><a aria-hidden="true" href="#cb634-1" tabindex="-1"></a><span class="co">/* Text display hooks.  */</span></span>
<span id="cb634-2"><a aria-hidden="true" href="#cb634-2" tabindex="-1"></a><span class="dt">void</span> <span class="op">(*</span>cursor_to_hook<span class="op">)</span> <span class="op">(</span><span class="kw">struct</span> frame <span class="op">*</span>f<span class="op">,</span> <span class="dt">int</span> vpos<span class="op">,</span> <span class="dt">int</span> hpos<span class="op">);</span></span>
<span id="cb634-3"><a aria-hidden="true" href="#cb634-3" tabindex="-1"></a><span class="dt">void</span> <span class="op">(*</span>raw_cursor_to_hook<span class="op">)</span> <span class="op">(</span><span class="kw">struct</span> frame <span class="op">*,</span> <span class="dt">int</span><span class="op">,</span> <span class="dt">int</span><span class="op">);</span></span>
<span id="cb634-4"><a aria-hidden="true" href="#cb634-4" tabindex="-1"></a></span>
<span id="cb634-5"><a aria-hidden="true" href="#cb634-5" tabindex="-1"></a><span class="dt">void</span> <span class="op">(*</span>clear_to_end_hook<span class="op">)</span> <span class="op">(</span><span class="kw">struct</span> frame <span class="op">*);</span></span>
<span id="cb634-6"><a aria-hidden="true" href="#cb634-6" tabindex="-1"></a><span class="dt">void</span> <span class="op">(*</span>clear_frame_hook<span class="op">)</span> <span class="op">(</span><span class="kw">struct</span> frame <span class="op">*);</span></span>
<span id="cb634-7"><a aria-hidden="true" href="#cb634-7" tabindex="-1"></a><span class="dt">void</span> <span class="op">(*</span>clear_end_of_line_hook<span class="op">)</span> <span class="op">(</span><span class="kw">struct</span> frame <span class="op">*,</span> <span class="dt">int</span><span class="op">);</span></span>
<span id="cb634-8"><a aria-hidden="true" href="#cb634-8" tabindex="-1"></a></span>
<span id="cb634-9"><a aria-hidden="true" href="#cb634-9" tabindex="-1"></a><span class="dt">void</span> <span class="op">(*</span>ins_del_lines_hook<span class="op">)</span> <span class="op">(</span><span class="kw">struct</span> frame <span class="op">*</span>f<span class="op">,</span> <span class="dt">int</span><span class="op">,</span> <span class="dt">int</span><span class="op">);</span></span>
<span id="cb634-10"><a aria-hidden="true" href="#cb634-10" tabindex="-1"></a></span>
<span id="cb634-11"><a aria-hidden="true" href="#cb634-11" tabindex="-1"></a><span class="dt">void</span> <span class="op">(*</span>insert_glyphs_hook<span class="op">)</span> <span class="op">(</span><span class="kw">struct</span> frame <span class="op">*</span>f<span class="op">,</span> <span class="kw">struct</span> glyph <span class="op">*</span>s<span class="op">,</span> <span class="dt">int</span> n<span class="op">);</span></span>
<span id="cb634-12"><a aria-hidden="true" href="#cb634-12" tabindex="-1"></a><span class="dt">void</span> <span class="op">(*</span>write_glyphs_hook<span class="op">)</span> <span class="op">(</span><span class="kw">struct</span> frame <span class="op">*</span>f<span class="op">,</span> <span class="kw">struct</span> glyph <span class="op">*</span>s<span class="op">,</span> <span class="dt">int</span> n<span class="op">);</span></span>
<span id="cb634-13"><a aria-hidden="true" href="#cb634-13" tabindex="-1"></a><span class="dt">void</span> <span class="op">(*</span>delete_glyphs_hook<span class="op">)</span> <span class="op">(</span><span class="kw">struct</span> frame <span class="op">*,</span> <span class="dt">int</span><span class="op">);</span></span>
<span id="cb634-14"><a aria-hidden="true" href="#cb634-14" tabindex="-1"></a></span>
<span id="cb634-15"><a aria-hidden="true" href="#cb634-15" tabindex="-1"></a><span class="dt">void</span> <span class="op">(*</span>ring_bell_hook<span class="op">)</span> <span class="op">(</span><span class="kw">struct</span> frame <span class="op">*</span>f<span class="op">);</span></span>
<span id="cb634-16"><a aria-hidden="true" href="#cb634-16" tabindex="-1"></a><span class="dt">void</span> <span class="op">(*</span>toggle_invisible_pointer_hook<span class="op">)</span> <span class="op">(</span><span class="kw">struct</span> frame <span class="op">*</span>f<span class="op">,</span> <span class="dt">bool</span> invisible<span class="op">);</span></span>
<span id="cb634-17"><a aria-hidden="true" href="#cb634-17" tabindex="-1"></a></span>
<span id="cb634-18"><a aria-hidden="true" href="#cb634-18" tabindex="-1"></a><span class="dt">void</span> <span class="op">(*</span>reset_terminal_modes_hook<span class="op">)</span> <span class="op">(</span><span class="kw">struct</span> terminal <span class="op">*);</span></span>
<span id="cb634-19"><a aria-hidden="true" href="#cb634-19" tabindex="-1"></a><span class="dt">void</span> <span class="op">(*</span>set_terminal_modes_hook<span class="op">)</span> <span class="op">(</span><span class="kw">struct</span> terminal <span class="op">*);</span></span></code></pre></div>
<p><strong>Location:</strong>
<code>/home/user/emacs/src/termhooks.h:559-583</code></p>
<p>These hooks are primarily used for TTY terminals but can be
implemented by graphical terminals for certain operations.</p>
<h4 data-number="18.4.2.2" id="frame-and-window-hooks"><span class="header-section-number">18.4.2.2</span> Frame and Window
Hooks</h4>
<div class="sourceCode" id="cb635"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb635-1"><a aria-hidden="true" href="#cb635-1" tabindex="-1"></a><span class="co">/* Return the current position of the mouse. */</span></span>
<span id="cb635-2"><a aria-hidden="true" href="#cb635-2" tabindex="-1"></a><span class="dt">void</span> <span class="op">(*</span>mouse_position_hook<span class="op">)</span> <span class="op">(</span><span class="kw">struct</span> frame <span class="op">**</span>f<span class="op">,</span> <span class="dt">int</span> insist<span class="op">,</span></span>
<span id="cb635-3"><a aria-hidden="true" href="#cb635-3" tabindex="-1"></a>                             Lisp_Object <span class="op">*</span>bar_window<span class="op">,</span></span>
<span id="cb635-4"><a aria-hidden="true" href="#cb635-4" tabindex="-1"></a>                             <span class="kw">enum</span> scroll_bar_part <span class="op">*</span>part<span class="op">,</span></span>
<span id="cb635-5"><a aria-hidden="true" href="#cb635-5" tabindex="-1"></a>                             Lisp_Object <span class="op">*</span>x<span class="op">,</span> Lisp_Object <span class="op">*</span>y<span class="op">,</span></span>
<span id="cb635-6"><a aria-hidden="true" href="#cb635-6" tabindex="-1"></a>                             Time <span class="op">*);</span></span>
<span id="cb635-7"><a aria-hidden="true" href="#cb635-7" tabindex="-1"></a></span>
<span id="cb635-8"><a aria-hidden="true" href="#cb635-8" tabindex="-1"></a><span class="co">/* Get the focus frame. */</span></span>
<span id="cb635-9"><a aria-hidden="true" href="#cb635-9" tabindex="-1"></a>Lisp_Object <span class="op">(*</span>get_focus_frame<span class="op">)</span> <span class="op">(</span><span class="kw">struct</span> frame <span class="op">*</span>f<span class="op">);</span></span>
<span id="cb635-10"><a aria-hidden="true" href="#cb635-10" tabindex="-1"></a></span>
<span id="cb635-11"><a aria-hidden="true" href="#cb635-11" tabindex="-1"></a><span class="co">/* Shift frame focus. */</span></span>
<span id="cb635-12"><a aria-hidden="true" href="#cb635-12" tabindex="-1"></a><span class="dt">void</span> <span class="op">(*</span>focus_frame_hook<span class="op">)</span> <span class="op">(</span><span class="kw">struct</span> frame <span class="op">*</span>f<span class="op">,</span> <span class="dt">bool</span> noactivate<span class="op">);</span></span>
<span id="cb635-13"><a aria-hidden="true" href="#cb635-13" tabindex="-1"></a></span>
<span id="cb635-14"><a aria-hidden="true" href="#cb635-14" tabindex="-1"></a><span class="co">/* Frame rehighlight (when focus changes). */</span></span>
<span id="cb635-15"><a aria-hidden="true" href="#cb635-15" tabindex="-1"></a><span class="dt">void</span> <span class="op">(*</span>frame_rehighlight_hook<span class="op">)</span> <span class="op">(</span><span class="kw">struct</span> frame <span class="op">*);</span></span>
<span id="cb635-16"><a aria-hidden="true" href="#cb635-16" tabindex="-1"></a></span>
<span id="cb635-17"><a aria-hidden="true" href="#cb635-17" tabindex="-1"></a><span class="co">/* Raise or lower a frame. */</span></span>
<span id="cb635-18"><a aria-hidden="true" href="#cb635-18" tabindex="-1"></a><span class="dt">void</span> <span class="op">(*</span>frame_raise_lower_hook<span class="op">)</span> <span class="op">(</span><span class="kw">struct</span> frame <span class="op">*</span>f<span class="op">,</span> <span class="dt">bool</span> raise_flag<span class="op">);</span></span>
<span id="cb635-19"><a aria-hidden="true" href="#cb635-19" tabindex="-1"></a></span>
<span id="cb635-20"><a aria-hidden="true" href="#cb635-20" tabindex="-1"></a><span class="co">/* Make frame visible or invisible. */</span></span>
<span id="cb635-21"><a aria-hidden="true" href="#cb635-21" tabindex="-1"></a><span class="dt">void</span> <span class="op">(*</span>frame_visible_invisible_hook<span class="op">)</span> <span class="op">(</span><span class="kw">struct</span> frame <span class="op">*</span>f<span class="op">,</span> <span class="dt">bool</span> visible<span class="op">);</span></span>
<span id="cb635-22"><a aria-hidden="true" href="#cb635-22" tabindex="-1"></a></span>
<span id="cb635-23"><a aria-hidden="true" href="#cb635-23" tabindex="-1"></a><span class="co">/* Change fullscreen state. */</span></span>
<span id="cb635-24"><a aria-hidden="true" href="#cb635-24" tabindex="-1"></a><span class="dt">void</span> <span class="op">(*</span>fullscreen_hook<span class="op">)</span> <span class="op">(</span><span class="kw">struct</span> frame <span class="op">*</span>f<span class="op">);</span></span>
<span id="cb635-25"><a aria-hidden="true" href="#cb635-25" tabindex="-1"></a></span>
<span id="cb635-26"><a aria-hidden="true" href="#cb635-26" tabindex="-1"></a><span class="co">/* Iconify the frame. */</span></span>
<span id="cb635-27"><a aria-hidden="true" href="#cb635-27" tabindex="-1"></a><span class="dt">void</span> <span class="op">(*</span>iconify_frame_hook<span class="op">)</span> <span class="op">(</span><span class="kw">struct</span> frame <span class="op">*</span>f<span class="op">);</span></span>
<span id="cb635-28"><a aria-hidden="true" href="#cb635-28" tabindex="-1"></a></span>
<span id="cb635-29"><a aria-hidden="true" href="#cb635-29" tabindex="-1"></a><span class="co">/* Change window size. */</span></span>
<span id="cb635-30"><a aria-hidden="true" href="#cb635-30" tabindex="-1"></a><span class="dt">void</span> <span class="op">(*</span>set_window_size_hook<span class="op">)</span> <span class="op">(</span><span class="kw">struct</span> frame <span class="op">*</span>f<span class="op">,</span> <span class="dt">bool</span> change_gravity<span class="op">,</span></span>
<span id="cb635-31"><a aria-hidden="true" href="#cb635-31" tabindex="-1"></a>                              <span class="dt">int</span> width<span class="op">,</span> <span class="dt">int</span> height<span class="op">);</span></span>
<span id="cb635-32"><a aria-hidden="true" href="#cb635-32" tabindex="-1"></a></span>
<span id="cb635-33"><a aria-hidden="true" href="#cb635-33" tabindex="-1"></a><span class="co">/* Move frame to position. */</span></span>
<span id="cb635-34"><a aria-hidden="true" href="#cb635-34" tabindex="-1"></a><span class="dt">void</span> <span class="op">(*</span>set_frame_offset_hook<span class="op">)</span> <span class="op">(</span><span class="kw">struct</span> frame <span class="op">*</span>f<span class="op">,</span> <span class="dt">int</span> xoff<span class="op">,</span> <span class="dt">int</span> yoff<span class="op">,</span></span>
<span id="cb635-35"><a aria-hidden="true" href="#cb635-35" tabindex="-1"></a>                               <span class="dt">int</span> change_gravity<span class="op">);</span></span>
<span id="cb635-36"><a aria-hidden="true" href="#cb635-36" tabindex="-1"></a></span>
<span id="cb635-37"><a aria-hidden="true" href="#cb635-37" tabindex="-1"></a><span class="co">/* Set frame transparency. */</span></span>
<span id="cb635-38"><a aria-hidden="true" href="#cb635-38" tabindex="-1"></a><span class="dt">void</span> <span class="op">(*</span>set_frame_alpha_hook<span class="op">)</span> <span class="op">(</span><span class="kw">struct</span> frame <span class="op">*</span>f<span class="op">);</span></span>
<span id="cb635-39"><a aria-hidden="true" href="#cb635-39" tabindex="-1"></a></span>
<span id="cb635-40"><a aria-hidden="true" href="#cb635-40" tabindex="-1"></a><span class="co">/* Set new font. */</span></span>
<span id="cb635-41"><a aria-hidden="true" href="#cb635-41" tabindex="-1"></a>Lisp_Object <span class="op">(*</span>set_new_font_hook<span class="op">)</span> <span class="op">(</span><span class="kw">struct</span> frame <span class="op">*</span>f<span class="op">,</span> Lisp_Object font_object<span class="op">,</span></span>
<span id="cb635-42"><a aria-hidden="true" href="#cb635-42" tabindex="-1"></a>                                  <span class="dt">int</span> fontset<span class="op">);</span></span>
<span id="cb635-43"><a aria-hidden="true" href="#cb635-43" tabindex="-1"></a></span>
<span id="cb635-44"><a aria-hidden="true" href="#cb635-44" tabindex="-1"></a><span class="co">/* Set window icon. */</span></span>
<span id="cb635-45"><a aria-hidden="true" href="#cb635-45" tabindex="-1"></a><span class="dt">bool</span> <span class="op">(*</span>set_bitmap_icon_hook<span class="op">)</span> <span class="op">(</span><span class="kw">struct</span> frame <span class="op">*</span>f<span class="op">,</span> Lisp_Object file<span class="op">);</span></span>
<span id="cb635-46"><a aria-hidden="true" href="#cb635-46" tabindex="-1"></a></span>
<span id="cb635-47"><a aria-hidden="true" href="#cb635-47" tabindex="-1"></a><span class="co">/* Set window title. */</span></span>
<span id="cb635-48"><a aria-hidden="true" href="#cb635-48" tabindex="-1"></a><span class="dt">void</span> <span class="op">(*</span>implicit_set_name_hook<span class="op">)</span> <span class="op">(</span><span class="kw">struct</span> frame <span class="op">*</span>f<span class="op">,</span> Lisp_Object arg<span class="op">,</span></span>
<span id="cb635-49"><a aria-hidden="true" href="#cb635-49" tabindex="-1"></a>                                Lisp_Object oldval<span class="op">);</span></span></code></pre></div>
<p><strong>Location:</strong>
<code>/home/user/emacs/src/termhooks.h:619-705</code></p>
<h4 data-number="18.4.2.3" id="menu-and-dialog-hooks"><span class="header-section-number">18.4.2.3</span> Menu and Dialog Hooks</h4>
<div class="sourceCode" id="cb636"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb636-1"><a aria-hidden="true" href="#cb636-1" tabindex="-1"></a><span class="co">/* Display menus. */</span></span>
<span id="cb636-2"><a aria-hidden="true" href="#cb636-2" tabindex="-1"></a>Lisp_Object <span class="op">(*</span>menu_show_hook<span class="op">)</span> <span class="op">(</span><span class="kw">struct</span> frame <span class="op">*</span>f<span class="op">,</span> <span class="dt">int</span> x<span class="op">,</span> <span class="dt">int</span> y<span class="op">,</span> <span class="dt">int</span> menuflags<span class="op">,</span></span>
<span id="cb636-3"><a aria-hidden="true" href="#cb636-3" tabindex="-1"></a>                               Lisp_Object title<span class="op">,</span> <span class="dt">const</span> <span class="dt">char</span> <span class="op">**</span>error_name<span class="op">);</span></span>
<span id="cb636-4"><a aria-hidden="true" href="#cb636-4" tabindex="-1"></a></span>
<span id="cb636-5"><a aria-hidden="true" href="#cb636-5" tabindex="-1"></a><span class="co">/* Activate the menu bar. */</span></span>
<span id="cb636-6"><a aria-hidden="true" href="#cb636-6" tabindex="-1"></a><span class="dt">void</span> <span class="op">(*</span>activate_menubar_hook<span class="op">)</span> <span class="op">(</span><span class="kw">struct</span> frame <span class="op">*</span>f<span class="op">);</span></span>
<span id="cb636-7"><a aria-hidden="true" href="#cb636-7" tabindex="-1"></a></span>
<span id="cb636-8"><a aria-hidden="true" href="#cb636-8" tabindex="-1"></a><span class="co">/* Display popup dialog. */</span></span>
<span id="cb636-9"><a aria-hidden="true" href="#cb636-9" tabindex="-1"></a>Lisp_Object <span class="op">(*</span>popup_dialog_hook<span class="op">)</span> <span class="op">(</span><span class="kw">struct</span> frame <span class="op">*</span>f<span class="op">,</span> Lisp_Object header<span class="op">,</span></span>
<span id="cb636-10"><a aria-hidden="true" href="#cb636-10" tabindex="-1"></a>                                  Lisp_Object contents<span class="op">);</span></span></code></pre></div>
<p><strong>Location:</strong>
<code>/home/user/emacs/src/termhooks.h:707-718</code></p>
<h4 data-number="18.4.2.4" id="scroll-bar-hooks"><span class="header-section-number">18.4.2.4</span> Scroll Bar Hooks</h4>
<div class="sourceCode" id="cb637"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb637-1"><a aria-hidden="true" href="#cb637-1" tabindex="-1"></a><span class="co">/* Set the vertical scroll bar. */</span></span>
<span id="cb637-2"><a aria-hidden="true" href="#cb637-2" tabindex="-1"></a><span class="dt">void</span> <span class="op">(*</span>set_vertical_scroll_bar_hook<span class="op">)</span> <span class="op">(</span><span class="kw">struct</span> window <span class="op">*</span>window<span class="op">,</span></span>
<span id="cb637-3"><a aria-hidden="true" href="#cb637-3" tabindex="-1"></a>                                      <span class="dt">int</span> portion<span class="op">,</span> <span class="dt">int</span> whole<span class="op">,</span> <span class="dt">int</span> position<span class="op">);</span></span>
<span id="cb637-4"><a aria-hidden="true" href="#cb637-4" tabindex="-1"></a></span>
<span id="cb637-5"><a aria-hidden="true" href="#cb637-5" tabindex="-1"></a><span class="co">/* Set the horizontal scroll bar. */</span></span>
<span id="cb637-6"><a aria-hidden="true" href="#cb637-6" tabindex="-1"></a><span class="dt">void</span> <span class="op">(*</span>set_horizontal_scroll_bar_hook<span class="op">)</span> <span class="op">(</span><span class="kw">struct</span> window <span class="op">*</span>window<span class="op">,</span></span>
<span id="cb637-7"><a aria-hidden="true" href="#cb637-7" tabindex="-1"></a>                                        <span class="dt">int</span> portion<span class="op">,</span> <span class="dt">int</span> whole<span class="op">,</span> <span class="dt">int</span> position<span class="op">);</span></span>
<span id="cb637-8"><a aria-hidden="true" href="#cb637-8" tabindex="-1"></a></span>
<span id="cb637-9"><a aria-hidden="true" href="#cb637-9" tabindex="-1"></a><span class="co">/* Condemn scroll bars (mark for deletion). */</span></span>
<span id="cb637-10"><a aria-hidden="true" href="#cb637-10" tabindex="-1"></a><span class="dt">void</span> <span class="op">(*</span>condemn_scroll_bars_hook<span class="op">)</span> <span class="op">(</span><span class="kw">struct</span> frame <span class="op">*</span>frame<span class="op">);</span></span>
<span id="cb637-11"><a aria-hidden="true" href="#cb637-11" tabindex="-1"></a></span>
<span id="cb637-12"><a aria-hidden="true" href="#cb637-12" tabindex="-1"></a><span class="co">/* Redeem scroll bar (unmark from deletion). */</span></span>
<span id="cb637-13"><a aria-hidden="true" href="#cb637-13" tabindex="-1"></a><span class="dt">void</span> <span class="op">(*</span>redeem_scroll_bar_hook<span class="op">)</span> <span class="op">(</span><span class="kw">struct</span> window <span class="op">*</span>window<span class="op">);</span></span>
<span id="cb637-14"><a aria-hidden="true" href="#cb637-14" tabindex="-1"></a></span>
<span id="cb637-15"><a aria-hidden="true" href="#cb637-15" tabindex="-1"></a><span class="co">/* Remove condemned scroll bars. */</span></span>
<span id="cb637-16"><a aria-hidden="true" href="#cb637-16" tabindex="-1"></a><span class="dt">void</span> <span class="op">(*</span>judge_scroll_bars_hook<span class="op">)</span> <span class="op">(</span><span class="kw">struct</span> frame <span class="op">*</span>FRAME<span class="op">);</span></span></code></pre></div>
<p><strong>Location:</strong>
<code>/home/user/emacs/src/termhooks.h:753-810</code></p>
<h4 data-number="18.4.2.5" id="event-handling"><span class="header-section-number">18.4.2.5</span> Event Handling</h4>
<div class="sourceCode" id="cb638"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb638-1"><a aria-hidden="true" href="#cb638-1" tabindex="-1"></a><span class="co">/* Called to read input events.</span></span>
<span id="cb638-2"><a aria-hidden="true" href="#cb638-2" tabindex="-1"></a><span class="co"> *</span></span>
<span id="cb638-3"><a aria-hidden="true" href="#cb638-3" tabindex="-1"></a><span class="co"> * TERMINAL indicates which terminal device to read from.</span></span>
<span id="cb638-4"><a aria-hidden="true" href="#cb638-4" tabindex="-1"></a><span class="co"> * Input events should be read into HOLD_QUIT.</span></span>
<span id="cb638-5"><a aria-hidden="true" href="#cb638-5" tabindex="-1"></a><span class="co"> *</span></span>
<span id="cb638-6"><a aria-hidden="true" href="#cb638-6" tabindex="-1"></a><span class="co"> * Return value:</span></span>
<span id="cb638-7"><a aria-hidden="true" href="#cb638-7" tabindex="-1"></a><span class="co"> *   &gt; 0: N input events were read</span></span>
<span id="cb638-8"><a aria-hidden="true" href="#cb638-8" tabindex="-1"></a><span class="co"> *   = 0: No events immediately available</span></span>
<span id="cb638-9"><a aria-hidden="true" href="#cb638-9" tabindex="-1"></a><span class="co"> *   -1: Transient read error</span></span>
<span id="cb638-10"><a aria-hidden="true" href="#cb638-10" tabindex="-1"></a><span class="co"> *   -2: Device closed (hangup), should be deleted</span></span>
<span id="cb638-11"><a aria-hidden="true" href="#cb638-11" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb638-12"><a aria-hidden="true" href="#cb638-12" tabindex="-1"></a><span class="dt">int</span> <span class="op">(*</span>read_socket_hook<span class="op">)</span> <span class="op">(</span><span class="kw">struct</span> terminal <span class="op">*</span>terminal<span class="op">,</span></span>
<span id="cb638-13"><a aria-hidden="true" href="#cb638-13" tabindex="-1"></a>                         <span class="kw">struct</span> input_event <span class="op">*</span>hold_quit<span class="op">);</span></span>
<span id="cb638-14"><a aria-hidden="true" href="#cb638-14" tabindex="-1"></a></span>
<span id="cb638-15"><a aria-hidden="true" href="#cb638-15" tabindex="-1"></a><span class="co">/* Called when a frame's display becomes entirely up to date. */</span></span>
<span id="cb638-16"><a aria-hidden="true" href="#cb638-16" tabindex="-1"></a><span class="dt">void</span> <span class="op">(*</span>frame_up_to_date_hook<span class="op">)</span> <span class="op">(</span><span class="kw">struct</span> frame <span class="op">*);</span></span></code></pre></div>
<p><strong>Location:</strong>
<code>/home/user/emacs/src/termhooks.h:813-827</code></p>
<h3 data-number="18.4.3" id="the-redisplay-interface"><span class="header-section-number">18.4.3</span> 2.3 The Redisplay
Interface</h3>
<p>For graphical terminals, the <code>struct redisplay_interface</code>
provides methods for rendering:</p>
<div class="sourceCode" id="cb639"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb639-1"><a aria-hidden="true" href="#cb639-1" tabindex="-1"></a><span class="kw">struct</span> redisplay_interface</span>
<span id="cb639-2"><a aria-hidden="true" href="#cb639-2" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb639-3"><a aria-hidden="true" href="#cb639-3" tabindex="-1"></a>  <span class="co">/* Handlers for setting frame parameters.  */</span></span>
<span id="cb639-4"><a aria-hidden="true" href="#cb639-4" tabindex="-1"></a>  frame_parm_handler <span class="op">*</span>frame_parm_handlers<span class="op">;</span></span>
<span id="cb639-5"><a aria-hidden="true" href="#cb639-5" tabindex="-1"></a></span>
<span id="cb639-6"><a aria-hidden="true" href="#cb639-6" tabindex="-1"></a>  <span class="co">/* Produce glyphs/get display metrics for the display element. */</span></span>
<span id="cb639-7"><a aria-hidden="true" href="#cb639-7" tabindex="-1"></a>  <span class="dt">void</span> <span class="op">(*</span>produce_glyphs<span class="op">)</span> <span class="op">(</span><span class="kw">struct</span> it <span class="op">*</span>it<span class="op">);</span></span>
<span id="cb639-8"><a aria-hidden="true" href="#cb639-8" tabindex="-1"></a></span>
<span id="cb639-9"><a aria-hidden="true" href="#cb639-9" tabindex="-1"></a>  <span class="co">/* Write or insert LEN glyphs from STRING at the nominal output position. */</span></span>
<span id="cb639-10"><a aria-hidden="true" href="#cb639-10" tabindex="-1"></a>  <span class="dt">void</span> <span class="op">(*</span>write_glyphs<span class="op">)</span> <span class="op">(</span><span class="kw">struct</span> window <span class="op">*</span>w<span class="op">,</span> <span class="kw">struct</span> glyph_row <span class="op">*</span>row<span class="op">,</span></span>
<span id="cb639-11"><a aria-hidden="true" href="#cb639-11" tabindex="-1"></a>                        <span class="kw">struct</span> glyph <span class="op">*</span>string<span class="op">,</span> <span class="kw">enum</span> glyph_row_area area<span class="op">,</span> <span class="dt">int</span> len<span class="op">);</span></span>
<span id="cb639-12"><a aria-hidden="true" href="#cb639-12" tabindex="-1"></a></span>
<span id="cb639-13"><a aria-hidden="true" href="#cb639-13" tabindex="-1"></a>  <span class="dt">void</span> <span class="op">(*</span>insert_glyphs<span class="op">)</span> <span class="op">(</span><span class="kw">struct</span> window <span class="op">*</span>w<span class="op">,</span> <span class="kw">struct</span> glyph_row <span class="op">*</span>row<span class="op">,</span></span>
<span id="cb639-14"><a aria-hidden="true" href="#cb639-14" tabindex="-1"></a>                         <span class="kw">struct</span> glyph <span class="op">*</span>start<span class="op">,</span> <span class="kw">enum</span> glyph_row_area area<span class="op">,</span> <span class="dt">int</span> len<span class="op">);</span></span>
<span id="cb639-15"><a aria-hidden="true" href="#cb639-15" tabindex="-1"></a></span>
<span id="cb639-16"><a aria-hidden="true" href="#cb639-16" tabindex="-1"></a>  <span class="co">/* Clear from nominal output position to X. */</span></span>
<span id="cb639-17"><a aria-hidden="true" href="#cb639-17" tabindex="-1"></a>  <span class="dt">void</span> <span class="op">(*</span>clear_end_of_line<span class="op">)</span> <span class="op">(</span><span class="kw">struct</span> window <span class="op">*</span>w<span class="op">,</span> <span class="kw">struct</span> glyph_row <span class="op">*</span>row<span class="op">,</span></span>
<span id="cb639-18"><a aria-hidden="true" href="#cb639-18" tabindex="-1"></a>                             <span class="kw">enum</span> glyph_row_area area<span class="op">,</span> <span class="dt">int</span> x<span class="op">);</span></span>
<span id="cb639-19"><a aria-hidden="true" href="#cb639-19" tabindex="-1"></a></span>
<span id="cb639-20"><a aria-hidden="true" href="#cb639-20" tabindex="-1"></a>  <span class="co">/* Function to call to scroll the display. */</span></span>
<span id="cb639-21"><a aria-hidden="true" href="#cb639-21" tabindex="-1"></a>  <span class="dt">void</span> <span class="op">(*</span>scroll_run_hook<span class="op">)</span> <span class="op">(</span><span class="kw">struct</span> window <span class="op">*</span>w<span class="op">,</span> <span class="kw">struct</span> run <span class="op">*</span>run<span class="op">);</span></span>
<span id="cb639-22"><a aria-hidden="true" href="#cb639-22" tabindex="-1"></a></span>
<span id="cb639-23"><a aria-hidden="true" href="#cb639-23" tabindex="-1"></a>  <span class="co">/* Function to call after a line has been completely updated. */</span></span>
<span id="cb639-24"><a aria-hidden="true" href="#cb639-24" tabindex="-1"></a>  <span class="dt">void</span> <span class="op">(*</span>after_update_window_line_hook<span class="op">)</span> <span class="op">(</span><span class="kw">struct</span> window <span class="op">*</span>w<span class="op">,</span></span>
<span id="cb639-25"><a aria-hidden="true" href="#cb639-25" tabindex="-1"></a>                                         <span class="kw">struct</span> glyph_row <span class="op">*</span>desired_row<span class="op">);</span></span>
<span id="cb639-26"><a aria-hidden="true" href="#cb639-26" tabindex="-1"></a></span>
<span id="cb639-27"><a aria-hidden="true" href="#cb639-27" tabindex="-1"></a>  <span class="co">/* Function to call before beginning to update window W. */</span></span>
<span id="cb639-28"><a aria-hidden="true" href="#cb639-28" tabindex="-1"></a>  <span class="dt">void</span> <span class="op">(*</span>update_window_begin_hook<span class="op">)</span> <span class="op">(</span><span class="kw">struct</span> window <span class="op">*</span>w<span class="op">);</span></span>
<span id="cb639-29"><a aria-hidden="true" href="#cb639-29" tabindex="-1"></a></span>
<span id="cb639-30"><a aria-hidden="true" href="#cb639-30" tabindex="-1"></a>  <span class="co">/* Function to call after window W has been updated. */</span></span>
<span id="cb639-31"><a aria-hidden="true" href="#cb639-31" tabindex="-1"></a>  <span class="dt">void</span> <span class="op">(*</span>update_window_end_hook<span class="op">)</span> <span class="op">(</span><span class="kw">struct</span> window <span class="op">*</span>w<span class="op">,</span> <span class="dt">bool</span> cursor_on_p<span class="op">,</span></span>
<span id="cb639-32"><a aria-hidden="true" href="#cb639-32" tabindex="-1"></a>                                  <span class="dt">bool</span> mouse_face_overwritten_p<span class="op">);</span></span>
<span id="cb639-33"><a aria-hidden="true" href="#cb639-33" tabindex="-1"></a></span>
<span id="cb639-34"><a aria-hidden="true" href="#cb639-34" tabindex="-1"></a>  <span class="co">/* Flush the display of frame F (e.g., XFlush for X11). */</span></span>
<span id="cb639-35"><a aria-hidden="true" href="#cb639-35" tabindex="-1"></a>  <span class="dt">void</span> <span class="op">(*</span>flush_display<span class="op">)</span> <span class="op">(</span><span class="kw">struct</span> frame <span class="op">*</span>f<span class="op">);</span></span>
<span id="cb639-36"><a aria-hidden="true" href="#cb639-36" tabindex="-1"></a></span>
<span id="cb639-37"><a aria-hidden="true" href="#cb639-37" tabindex="-1"></a>  <span class="co">/* Clear the mouse highlight in window W. */</span></span>
<span id="cb639-38"><a aria-hidden="true" href="#cb639-38" tabindex="-1"></a>  <span class="dt">void</span> <span class="op">(*</span>clear_window_mouse_face<span class="op">)</span> <span class="op">(</span><span class="kw">struct</span> window <span class="op">*</span>w<span class="op">);</span></span>
<span id="cb639-39"><a aria-hidden="true" href="#cb639-39" tabindex="-1"></a></span>
<span id="cb639-40"><a aria-hidden="true" href="#cb639-40" tabindex="-1"></a>  <span class="co">/* Get glyph overhang (for complex scripts). */</span></span>
<span id="cb639-41"><a aria-hidden="true" href="#cb639-41" tabindex="-1"></a>  <span class="dt">void</span> <span class="op">(*</span>get_glyph_overhangs<span class="op">)</span> <span class="op">(</span><span class="kw">struct</span> glyph <span class="op">*</span>glyph<span class="op">,</span> <span class="kw">struct</span> frame <span class="op">*</span>f<span class="op">,</span></span>
<span id="cb639-42"><a aria-hidden="true" href="#cb639-42" tabindex="-1"></a>                               <span class="dt">int</span> <span class="op">*</span>left<span class="op">,</span> <span class="dt">int</span> <span class="op">*</span>right<span class="op">);</span></span>
<span id="cb639-43"><a aria-hidden="true" href="#cb639-43" tabindex="-1"></a></span>
<span id="cb639-44"><a aria-hidden="true" href="#cb639-44" tabindex="-1"></a>  <span class="co">/* Fix overlapping area display. */</span></span>
<span id="cb639-45"><a aria-hidden="true" href="#cb639-45" tabindex="-1"></a>  <span class="dt">void</span> <span class="op">(*</span>fix_overlapping_area<span class="op">)</span> <span class="op">(</span><span class="kw">struct</span> window <span class="op">*</span>w<span class="op">,</span> <span class="kw">struct</span> glyph_row <span class="op">*</span>row<span class="op">,</span></span>
<span id="cb639-46"><a aria-hidden="true" href="#cb639-46" tabindex="-1"></a>                                <span class="kw">enum</span> glyph_row_area area<span class="op">,</span> <span class="dt">int</span><span class="op">);</span></span>
<span id="cb639-47"><a aria-hidden="true" href="#cb639-47" tabindex="-1"></a></span>
<span id="cb639-48"><a aria-hidden="true" href="#cb639-48" tabindex="-1"></a><span class="pp">#ifdef HAVE_WINDOW_SYSTEM</span></span>
<span id="cb639-49"><a aria-hidden="true" href="#cb639-49" tabindex="-1"></a>  <span class="co">/* Draw a fringe bitmap. */</span></span>
<span id="cb639-50"><a aria-hidden="true" href="#cb639-50" tabindex="-1"></a>  <span class="dt">void</span> <span class="op">(*</span>draw_fringe_bitmap<span class="op">)</span> <span class="op">(</span><span class="kw">struct</span> window <span class="op">*</span>w<span class="op">,</span> <span class="kw">struct</span> glyph_row <span class="op">*</span>row<span class="op">,</span></span>
<span id="cb639-51"><a aria-hidden="true" href="#cb639-51" tabindex="-1"></a>                              <span class="kw">struct</span> draw_fringe_bitmap_params <span class="op">*</span>p<span class="op">);</span></span>
<span id="cb639-52"><a aria-hidden="true" href="#cb639-52" tabindex="-1"></a></span>
<span id="cb639-53"><a aria-hidden="true" href="#cb639-53" tabindex="-1"></a>  <span class="co">/* Define and destroy fringe bitmaps. */</span></span>
<span id="cb639-54"><a aria-hidden="true" href="#cb639-54" tabindex="-1"></a>  <span class="dt">void</span> <span class="op">(*</span>define_fringe_bitmap<span class="op">)</span> <span class="op">(</span><span class="dt">int</span> which<span class="op">,</span> <span class="dt">unsigned</span> <span class="dt">short</span> <span class="op">*</span>bits<span class="op">,</span> <span class="dt">int</span> h<span class="op">,</span> <span class="dt">int</span> wd<span class="op">);</span></span>
<span id="cb639-55"><a aria-hidden="true" href="#cb639-55" tabindex="-1"></a>  <span class="dt">void</span> <span class="op">(*</span>destroy_fringe_bitmap<span class="op">)</span> <span class="op">(</span><span class="dt">int</span> which<span class="op">);</span></span>
<span id="cb639-56"><a aria-hidden="true" href="#cb639-56" tabindex="-1"></a></span>
<span id="cb639-57"><a aria-hidden="true" href="#cb639-57" tabindex="-1"></a>  <span class="co">/* Compute glyph string overhangs. */</span></span>
<span id="cb639-58"><a aria-hidden="true" href="#cb639-58" tabindex="-1"></a>  <span class="dt">void</span> <span class="op">(*</span>compute_glyph_string_overhangs<span class="op">)</span> <span class="op">(</span><span class="kw">struct</span> glyph_string <span class="op">*</span>s<span class="op">);</span></span>
<span id="cb639-59"><a aria-hidden="true" href="#cb639-59" tabindex="-1"></a></span>
<span id="cb639-60"><a aria-hidden="true" href="#cb639-60" tabindex="-1"></a>  <span class="co">/* Draw a glyph string - THE CORE RENDERING FUNCTION. */</span></span>
<span id="cb639-61"><a aria-hidden="true" href="#cb639-61" tabindex="-1"></a>  <span class="dt">void</span> <span class="op">(*</span>draw_glyph_string<span class="op">)</span> <span class="op">(</span><span class="kw">struct</span> glyph_string <span class="op">*</span>s<span class="op">);</span></span>
<span id="cb639-62"><a aria-hidden="true" href="#cb639-62" tabindex="-1"></a></span>
<span id="cb639-63"><a aria-hidden="true" href="#cb639-63" tabindex="-1"></a>  <span class="co">/* Define cursor for frame. */</span></span>
<span id="cb639-64"><a aria-hidden="true" href="#cb639-64" tabindex="-1"></a>  <span class="dt">void</span> <span class="op">(*</span>define_frame_cursor<span class="op">)</span> <span class="op">(</span><span class="kw">struct</span> frame <span class="op">*</span>f<span class="op">,</span> Emacs_Cursor cursor<span class="op">);</span></span>
<span id="cb639-65"><a aria-hidden="true" href="#cb639-65" tabindex="-1"></a></span>
<span id="cb639-66"><a aria-hidden="true" href="#cb639-66" tabindex="-1"></a>  <span class="co">/* Clear area of frame. */</span></span>
<span id="cb639-67"><a aria-hidden="true" href="#cb639-67" tabindex="-1"></a>  <span class="dt">void</span> <span class="op">(*</span>clear_frame_area<span class="op">)</span> <span class="op">(</span><span class="kw">struct</span> frame <span class="op">*</span>f<span class="op">,</span> <span class="dt">int</span> x<span class="op">,</span> <span class="dt">int</span> y<span class="op">,</span></span>
<span id="cb639-68"><a aria-hidden="true" href="#cb639-68" tabindex="-1"></a>                            <span class="dt">int</span> width<span class="op">,</span> <span class="dt">int</span> height<span class="op">);</span></span>
<span id="cb639-69"><a aria-hidden="true" href="#cb639-69" tabindex="-1"></a></span>
<span id="cb639-70"><a aria-hidden="true" href="#cb639-70" tabindex="-1"></a>  <span class="co">/* Clear internal border area. */</span></span>
<span id="cb639-71"><a aria-hidden="true" href="#cb639-71" tabindex="-1"></a>  <span class="dt">void</span> <span class="op">(*</span>clear_under_internal_border<span class="op">)</span> <span class="op">(</span><span class="kw">struct</span> frame <span class="op">*</span>f<span class="op">);</span></span>
<span id="cb639-72"><a aria-hidden="true" href="#cb639-72" tabindex="-1"></a></span>
<span id="cb639-73"><a aria-hidden="true" href="#cb639-73" tabindex="-1"></a>  <span class="co">/* Draw window cursor. */</span></span>
<span id="cb639-74"><a aria-hidden="true" href="#cb639-74" tabindex="-1"></a>  <span class="dt">void</span> <span class="op">(*</span>draw_window_cursor<span class="op">)</span> <span class="op">(</span><span class="kw">struct</span> window <span class="op">*</span>w<span class="op">,</span></span>
<span id="cb639-75"><a aria-hidden="true" href="#cb639-75" tabindex="-1"></a>                              <span class="kw">struct</span> glyph_row <span class="op">*</span>glyph_row<span class="op">,</span></span>
<span id="cb639-76"><a aria-hidden="true" href="#cb639-76" tabindex="-1"></a>                              <span class="dt">int</span> x<span class="op">,</span> <span class="dt">int</span> y<span class="op">,</span></span>
<span id="cb639-77"><a aria-hidden="true" href="#cb639-77" tabindex="-1"></a>                              <span class="kw">enum</span> text_cursor_kinds cursor_type<span class="op">,</span></span>
<span id="cb639-78"><a aria-hidden="true" href="#cb639-78" tabindex="-1"></a>                              <span class="dt">int</span> cursor_width<span class="op">,</span> <span class="dt">bool</span> on_p<span class="op">,</span> <span class="dt">bool</span> active_p<span class="op">);</span></span>
<span id="cb639-79"><a aria-hidden="true" href="#cb639-79" tabindex="-1"></a></span>
<span id="cb639-80"><a aria-hidden="true" href="#cb639-80" tabindex="-1"></a>  <span class="co">/* Draw vertical window border. */</span></span>
<span id="cb639-81"><a aria-hidden="true" href="#cb639-81" tabindex="-1"></a>  <span class="dt">void</span> <span class="op">(*</span>draw_vertical_window_border<span class="op">)</span> <span class="op">(</span><span class="kw">struct</span> window <span class="op">*</span>w<span class="op">,</span></span>
<span id="cb639-82"><a aria-hidden="true" href="#cb639-82" tabindex="-1"></a>                                       <span class="dt">int</span> x<span class="op">,</span> <span class="dt">int</span> y_0<span class="op">,</span> <span class="dt">int</span> y_1<span class="op">);</span></span>
<span id="cb639-83"><a aria-hidden="true" href="#cb639-83" tabindex="-1"></a></span>
<span id="cb639-84"><a aria-hidden="true" href="#cb639-84" tabindex="-1"></a>  <span class="co">/* Draw window divider. */</span></span>
<span id="cb639-85"><a aria-hidden="true" href="#cb639-85" tabindex="-1"></a>  <span class="dt">void</span> <span class="op">(*</span>draw_window_divider<span class="op">)</span> <span class="op">(</span><span class="kw">struct</span> window <span class="op">*</span>w<span class="op">,</span></span>
<span id="cb639-86"><a aria-hidden="true" href="#cb639-86" tabindex="-1"></a>                               <span class="dt">int</span> x_0<span class="op">,</span> <span class="dt">int</span> x_1<span class="op">,</span> <span class="dt">int</span> y_0<span class="op">,</span> <span class="dt">int</span> y_1<span class="op">);</span></span>
<span id="cb639-87"><a aria-hidden="true" href="#cb639-87" tabindex="-1"></a></span>
<span id="cb639-88"><a aria-hidden="true" href="#cb639-88" tabindex="-1"></a>  <span class="co">/* Shift glyphs for insert. */</span></span>
<span id="cb639-89"><a aria-hidden="true" href="#cb639-89" tabindex="-1"></a>  <span class="dt">void</span> <span class="op">(*</span>shift_glyphs_for_insert<span class="op">)</span> <span class="op">(</span><span class="kw">struct</span> frame <span class="op">*</span>f<span class="op">,</span></span>
<span id="cb639-90"><a aria-hidden="true" href="#cb639-90" tabindex="-1"></a>                                   <span class="dt">int</span> x<span class="op">,</span> <span class="dt">int</span> y<span class="op">,</span> <span class="dt">int</span> width<span class="op">,</span></span>
<span id="cb639-91"><a aria-hidden="true" href="#cb639-91" tabindex="-1"></a>                                   <span class="dt">int</span> height<span class="op">,</span> <span class="dt">int</span> shift_by<span class="op">);</span></span>
<span id="cb639-92"><a aria-hidden="true" href="#cb639-92" tabindex="-1"></a></span>
<span id="cb639-93"><a aria-hidden="true" href="#cb639-93" tabindex="-1"></a>  <span class="co">/* Hourglass cursor. */</span></span>
<span id="cb639-94"><a aria-hidden="true" href="#cb639-94" tabindex="-1"></a>  <span class="dt">void</span> <span class="op">(*</span>show_hourglass<span class="op">)</span> <span class="op">(</span><span class="kw">struct</span> frame <span class="op">*</span>f<span class="op">);</span></span>
<span id="cb639-95"><a aria-hidden="true" href="#cb639-95" tabindex="-1"></a>  <span class="dt">void</span> <span class="op">(*</span>hide_hourglass<span class="op">)</span> <span class="op">(</span><span class="kw">struct</span> frame <span class="op">*</span>f<span class="op">);</span></span>
<span id="cb639-96"><a aria-hidden="true" href="#cb639-96" tabindex="-1"></a></span>
<span id="cb639-97"><a aria-hidden="true" href="#cb639-97" tabindex="-1"></a>  <span class="co">/* Calculate default face. */</span></span>
<span id="cb639-98"><a aria-hidden="true" href="#cb639-98" tabindex="-1"></a>  <span class="dt">void</span> <span class="op">(*</span>default_font_parameter<span class="op">)</span> <span class="op">(</span><span class="kw">struct</span> frame <span class="op">*</span>f<span class="op">,</span> Lisp_Object parms<span class="op">);</span></span>
<span id="cb639-99"><a aria-hidden="true" href="#cb639-99" tabindex="-1"></a><span class="pp">#endif </span><span class="co">/* HAVE_WINDOW_SYSTEM */</span></span>
<span id="cb639-100"><a aria-hidden="true" href="#cb639-100" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<p><strong>Location:</strong>
<code>/home/user/emacs/src/dispextern.h:3026-3153</code></p>
<p><strong>Key Design Points:</strong></p>
<ol type="1">
<li><strong>Glyph String Rendering</strong>: The
<code>draw_glyph_string</code> method is the workhorse for all text and
graphical element rendering</li>
<li><strong>Incremental Updates</strong>: Methods like
<code>after_update_window_line_hook</code> enable efficient partial
redraws</li>
<li><strong>Platform-Specific vs.¬†Generic</strong>: Some methods (like
<code>produce_glyphs</code>) have generic implementations shared across
platforms, while others (like <code>draw_glyph_string</code>) are
platform-specific</li>
</ol>
<h3 data-number="18.4.4" id="terminal-creation-and-initialization"><span class="header-section-number">18.4.4</span> 2.4 Terminal Creation and
Initialization</h3>
<p>The <code>create_terminal</code> function establishes a new
terminal:</p>
<div class="sourceCode" id="cb640"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb640-1"><a aria-hidden="true" href="#cb640-1" tabindex="-1"></a><span class="kw">struct</span> terminal <span class="op">*</span></span>
<span id="cb640-2"><a aria-hidden="true" href="#cb640-2" tabindex="-1"></a>create_terminal <span class="op">(</span><span class="kw">enum</span> output_method type<span class="op">,</span> <span class="kw">struct</span> redisplay_interface <span class="op">*</span>rif<span class="op">)</span></span>
<span id="cb640-3"><a aria-hidden="true" href="#cb640-3" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb640-4"><a aria-hidden="true" href="#cb640-4" tabindex="-1"></a>  <span class="kw">struct</span> terminal <span class="op">*</span>terminal <span class="op">=</span> allocate_terminal <span class="op">();</span></span>
<span id="cb640-5"><a aria-hidden="true" href="#cb640-5" tabindex="-1"></a>  Lisp_Object terminal_coding<span class="op">,</span> keyboard_coding<span class="op">;</span></span>
<span id="cb640-6"><a aria-hidden="true" href="#cb640-6" tabindex="-1"></a></span>
<span id="cb640-7"><a aria-hidden="true" href="#cb640-7" tabindex="-1"></a>  terminal<span class="op">-&gt;</span>next_terminal <span class="op">=</span> terminal_list<span class="op">;</span></span>
<span id="cb640-8"><a aria-hidden="true" href="#cb640-8" tabindex="-1"></a>  terminal_list <span class="op">=</span> terminal<span class="op">;</span></span>
<span id="cb640-9"><a aria-hidden="true" href="#cb640-9" tabindex="-1"></a>  terminal<span class="op">-&gt;</span>type <span class="op">=</span> type<span class="op">;</span></span>
<span id="cb640-10"><a aria-hidden="true" href="#cb640-10" tabindex="-1"></a>  terminal<span class="op">-&gt;</span>rif <span class="op">=</span> rif<span class="op">;</span></span>
<span id="cb640-11"><a aria-hidden="true" href="#cb640-11" tabindex="-1"></a>  terminal<span class="op">-&gt;</span>id <span class="op">=</span> next_terminal_id<span class="op">++;</span></span>
<span id="cb640-12"><a aria-hidden="true" href="#cb640-12" tabindex="-1"></a></span>
<span id="cb640-13"><a aria-hidden="true" href="#cb640-13" tabindex="-1"></a>  terminal<span class="op">-&gt;</span>keyboard_coding <span class="op">=</span> xmalloc <span class="op">(</span><span class="kw">sizeof</span> <span class="op">(</span><span class="kw">struct</span> coding_system<span class="op">));</span></span>
<span id="cb640-14"><a aria-hidden="true" href="#cb640-14" tabindex="-1"></a>  terminal<span class="op">-&gt;</span>terminal_coding <span class="op">=</span> xmalloc <span class="op">(</span><span class="kw">sizeof</span> <span class="op">(</span><span class="kw">struct</span> coding_system<span class="op">));</span></span>
<span id="cb640-15"><a aria-hidden="true" href="#cb640-15" tabindex="-1"></a></span>
<span id="cb640-16"><a aria-hidden="true" href="#cb640-16" tabindex="-1"></a>  <span class="co">/* If default coding systems for the terminal and the keyboard are</span></span>
<span id="cb640-17"><a aria-hidden="true" href="#cb640-17" tabindex="-1"></a><span class="co">     already defined, use them in preference to the defaults. */</span></span>
<span id="cb640-18"><a aria-hidden="true" href="#cb640-18" tabindex="-1"></a>  keyboard_coding <span class="op">=</span> find_symbol_value <span class="op">(</span>Qdefault_keyboard_coding_system<span class="op">);</span></span>
<span id="cb640-19"><a aria-hidden="true" href="#cb640-19" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>NILP <span class="op">(</span>keyboard_coding<span class="op">)</span></span>
<span id="cb640-20"><a aria-hidden="true" href="#cb640-20" tabindex="-1"></a>      <span class="op">||</span> BASE_EQ <span class="op">(</span>keyboard_coding<span class="op">,</span> Qunbound<span class="op">)</span></span>
<span id="cb640-21"><a aria-hidden="true" href="#cb640-21" tabindex="-1"></a>      <span class="op">||</span> NILP <span class="op">(</span>Fcoding_system_p <span class="op">(</span>keyboard_coding<span class="op">)))</span></span>
<span id="cb640-22"><a aria-hidden="true" href="#cb640-22" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb640-23"><a aria-hidden="true" href="#cb640-23" tabindex="-1"></a>      terminal<span class="op">-&gt;</span>keyboard_coding<span class="op">-&gt;</span>common_flags <span class="op">=</span> CODING_REQUIRE_DECODING_MASK<span class="op">;</span></span>
<span id="cb640-24"><a aria-hidden="true" href="#cb640-24" tabindex="-1"></a>      terminal<span class="op">-&gt;</span>keyboard_coding<span class="op">-&gt;</span>src_multibyte <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb640-25"><a aria-hidden="true" href="#cb640-25" tabindex="-1"></a>      terminal<span class="op">-&gt;</span>keyboard_coding<span class="op">-&gt;</span>dst_multibyte <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb640-26"><a aria-hidden="true" href="#cb640-26" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb640-27"><a aria-hidden="true" href="#cb640-27" tabindex="-1"></a>  <span class="cf">else</span></span>
<span id="cb640-28"><a aria-hidden="true" href="#cb640-28" tabindex="-1"></a>    setup_coding_system <span class="op">(</span>keyboard_coding<span class="op">,</span> terminal<span class="op">-&gt;</span>keyboard_coding<span class="op">);</span></span>
<span id="cb640-29"><a aria-hidden="true" href="#cb640-29" tabindex="-1"></a></span>
<span id="cb640-30"><a aria-hidden="true" href="#cb640-30" tabindex="-1"></a>  terminal_coding <span class="op">=</span> find_symbol_value <span class="op">(</span>Qdefault_terminal_coding_system<span class="op">);</span></span>
<span id="cb640-31"><a aria-hidden="true" href="#cb640-31" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>NILP <span class="op">(</span>terminal_coding<span class="op">)</span></span>
<span id="cb640-32"><a aria-hidden="true" href="#cb640-32" tabindex="-1"></a>      <span class="op">||</span> BASE_EQ <span class="op">(</span>terminal_coding<span class="op">,</span> Qunbound<span class="op">)</span></span>
<span id="cb640-33"><a aria-hidden="true" href="#cb640-33" tabindex="-1"></a>      <span class="op">||</span> NILP <span class="op">(</span>Fcoding_system_p <span class="op">(</span>terminal_coding<span class="op">)))</span></span>
<span id="cb640-34"><a aria-hidden="true" href="#cb640-34" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb640-35"><a aria-hidden="true" href="#cb640-35" tabindex="-1"></a>      terminal<span class="op">-&gt;</span>terminal_coding<span class="op">-&gt;</span>common_flags <span class="op">=</span> CODING_REQUIRE_ENCODING_MASK<span class="op">;</span></span>
<span id="cb640-36"><a aria-hidden="true" href="#cb640-36" tabindex="-1"></a>      terminal<span class="op">-&gt;</span>terminal_coding<span class="op">-&gt;</span>src_multibyte <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb640-37"><a aria-hidden="true" href="#cb640-37" tabindex="-1"></a>      terminal<span class="op">-&gt;</span>terminal_coding<span class="op">-&gt;</span>dst_multibyte <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb640-38"><a aria-hidden="true" href="#cb640-38" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb640-39"><a aria-hidden="true" href="#cb640-39" tabindex="-1"></a>  <span class="cf">else</span></span>
<span id="cb640-40"><a aria-hidden="true" href="#cb640-40" tabindex="-1"></a>    setup_coding_system <span class="op">(</span>terminal_coding<span class="op">,</span> terminal<span class="op">-&gt;</span>terminal_coding<span class="op">);</span></span>
<span id="cb640-41"><a aria-hidden="true" href="#cb640-41" tabindex="-1"></a></span>
<span id="cb640-42"><a aria-hidden="true" href="#cb640-42" tabindex="-1"></a>  <span class="cf">return</span> terminal<span class="op">;</span></span>
<span id="cb640-43"><a aria-hidden="true" href="#cb640-43" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>Location:</strong>
<code>/home/user/emacs/src/terminal.c:292-342</code></p>
<hr/>
<h2 data-number="18.5" id="platform-implementations"><span class="header-section-number">18.5</span> Platform Implementations</h2>
<h3 data-number="18.5.1" id="x11-x-window-system"><span class="header-section-number">18.5.1</span> 3.1 X11 (X Window
System)</h3>
<h4 data-number="18.5.1.1" id="file-structure"><span class="header-section-number">18.5.1.1</span> File Structure</h4>
<p>The X11 implementation spans multiple files:</p>
<table>
<colgroup>
<col style="width: 20%"/>
<col style="width: 31%"/>
<col style="width: 48%"/>
</colgroup>
<thead>
<tr>
<th>File</th>
<th>Purpose</th>
<th>LOC (approx)</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>xterm.c</code></td>
<td>Terminal implementation, event handling, rendering</td>
<td>32,000+</td>
</tr>
<tr>
<td><code>xterm.h</code></td>
<td>X11-specific data structures and declarations</td>
<td>1,500+</td>
</tr>
<tr>
<td><code>xfns.c</code></td>
<td>Frame functions, window management</td>
<td>8,000+</td>
</tr>
<tr>
<td><code>xmenu.c</code></td>
<td>Menu implementation</td>
<td>2,500+</td>
</tr>
<tr>
<td><code>xselect.c</code></td>
<td>X selection (clipboard) handling</td>
<td>3,500+</td>
</tr>
<tr>
<td><code>xfont.c</code></td>
<td>Core X font driver</td>
<td>1,500+</td>
</tr>
<tr>
<td><code>xftfont.c</code></td>
<td>Xft font driver (anti-aliasing)</td>
<td>1,000+</td>
</tr>
<tr>
<td><code>xsettings.c</code></td>
<td>XSETTINGS protocol support</td>
<td>1,000+</td>
</tr>
<tr>
<td><code>xrdb.c</code></td>
<td>X resource database</td>
<td>600+</td>
</tr>
<tr>
<td><code>xsmfns.c</code></td>
<td>X Session Management</td>
<td>500+</td>
</tr>
</tbody>
</table>
<p><strong>Total:</strong> ~52,600 lines of X11-specific code</p>
<h4 data-number="18.5.1.2" id="x11-redisplay-interface"><span class="header-section-number">18.5.1.2</span> X11 Redisplay
Interface</h4>
<div class="sourceCode" id="cb641"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb641-1"><a aria-hidden="true" href="#cb641-1" tabindex="-1"></a><span class="dt">static</span> <span class="kw">struct</span> redisplay_interface x_redisplay_interface <span class="op">=</span></span>
<span id="cb641-2"><a aria-hidden="true" href="#cb641-2" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb641-3"><a aria-hidden="true" href="#cb641-3" tabindex="-1"></a>  x_frame_parm_handlers<span class="op">,</span></span>
<span id="cb641-4"><a aria-hidden="true" href="#cb641-4" tabindex="-1"></a>  gui_produce_glyphs<span class="op">,</span>              <span class="co">// Generic (shared with other GUI platforms)</span></span>
<span id="cb641-5"><a aria-hidden="true" href="#cb641-5" tabindex="-1"></a>  gui_write_glyphs<span class="op">,</span>                <span class="co">// Generic</span></span>
<span id="cb641-6"><a aria-hidden="true" href="#cb641-6" tabindex="-1"></a>  gui_insert_glyphs<span class="op">,</span>               <span class="co">// Generic</span></span>
<span id="cb641-7"><a aria-hidden="true" href="#cb641-7" tabindex="-1"></a>  gui_clear_end_of_line<span class="op">,</span>           <span class="co">// Generic</span></span>
<span id="cb641-8"><a aria-hidden="true" href="#cb641-8" tabindex="-1"></a>  x_scroll_run<span class="op">,</span>                    <span class="co">// X11-specific</span></span>
<span id="cb641-9"><a aria-hidden="true" href="#cb641-9" tabindex="-1"></a>  x_after_update_window_line<span class="op">,</span>      <span class="co">// X11-specific</span></span>
<span id="cb641-10"><a aria-hidden="true" href="#cb641-10" tabindex="-1"></a>  NULL<span class="op">,</span> <span class="co">/* update_window_begin */</span></span>
<span id="cb641-11"><a aria-hidden="true" href="#cb641-11" tabindex="-1"></a>  NULL<span class="op">,</span> <span class="co">/* update_window_end   */</span></span>
<span id="cb641-12"><a aria-hidden="true" href="#cb641-12" tabindex="-1"></a>  x_flip_and_flush<span class="op">,</span>                <span class="co">// X11-specific (handles double-buffering)</span></span>
<span id="cb641-13"><a aria-hidden="true" href="#cb641-13" tabindex="-1"></a>  gui_clear_window_mouse_face<span class="op">,</span>     <span class="co">// Generic</span></span>
<span id="cb641-14"><a aria-hidden="true" href="#cb641-14" tabindex="-1"></a>  gui_get_glyph_overhangs<span class="op">,</span>         <span class="co">// Generic</span></span>
<span id="cb641-15"><a aria-hidden="true" href="#cb641-15" tabindex="-1"></a>  gui_fix_overlapping_area<span class="op">,</span>        <span class="co">// Generic</span></span>
<span id="cb641-16"><a aria-hidden="true" href="#cb641-16" tabindex="-1"></a>  x_draw_fringe_bitmap<span class="op">,</span>            <span class="co">// X11-specific</span></span>
<span id="cb641-17"><a aria-hidden="true" href="#cb641-17" tabindex="-1"></a><span class="pp">#ifdef USE_CAIRO</span></span>
<span id="cb641-18"><a aria-hidden="true" href="#cb641-18" tabindex="-1"></a>  x_cr_define_fringe_bitmap<span class="op">,</span>       <span class="co">// Cairo-specific</span></span>
<span id="cb641-19"><a aria-hidden="true" href="#cb641-19" tabindex="-1"></a>  x_cr_destroy_fringe_bitmap<span class="op">,</span>      <span class="co">// Cairo-specific</span></span>
<span id="cb641-20"><a aria-hidden="true" href="#cb641-20" tabindex="-1"></a><span class="pp">#else</span></span>
<span id="cb641-21"><a aria-hidden="true" href="#cb641-21" tabindex="-1"></a>  x_define_fringe_bitmap<span class="op">,</span>          <span class="co">// X11-specific</span></span>
<span id="cb641-22"><a aria-hidden="true" href="#cb641-22" tabindex="-1"></a>  x_destroy_fringe_bitmap<span class="op">,</span>         <span class="co">// X11-specific</span></span>
<span id="cb641-23"><a aria-hidden="true" href="#cb641-23" tabindex="-1"></a><span class="pp">#endif</span></span>
<span id="cb641-24"><a aria-hidden="true" href="#cb641-24" tabindex="-1"></a>  x_compute_glyph_string_overhangs<span class="op">,</span><span class="co">// X11-specific</span></span>
<span id="cb641-25"><a aria-hidden="true" href="#cb641-25" tabindex="-1"></a>  x_draw_glyph_string<span class="op">,</span>             <span class="co">// X11-specific (THE KEY RENDERING FUNCTION)</span></span>
<span id="cb641-26"><a aria-hidden="true" href="#cb641-26" tabindex="-1"></a>  x_define_frame_cursor<span class="op">,</span>           <span class="co">// X11-specific</span></span>
<span id="cb641-27"><a aria-hidden="true" href="#cb641-27" tabindex="-1"></a>  x_clear_frame_area<span class="op">,</span>              <span class="co">// X11-specific</span></span>
<span id="cb641-28"><a aria-hidden="true" href="#cb641-28" tabindex="-1"></a>  x_clear_under_internal_border<span class="op">,</span>   <span class="co">// X11-specific</span></span>
<span id="cb641-29"><a aria-hidden="true" href="#cb641-29" tabindex="-1"></a>  x_draw_window_cursor<span class="op">,</span>            <span class="co">// X11-specific</span></span>
<span id="cb641-30"><a aria-hidden="true" href="#cb641-30" tabindex="-1"></a>  x_draw_vertical_window_border<span class="op">,</span>   <span class="co">// X11-specific</span></span>
<span id="cb641-31"><a aria-hidden="true" href="#cb641-31" tabindex="-1"></a>  x_draw_window_divider<span class="op">,</span>           <span class="co">// X11-specific</span></span>
<span id="cb641-32"><a aria-hidden="true" href="#cb641-32" tabindex="-1"></a>  x_shift_glyphs_for_insert<span class="op">,</span>       <span class="co">// X11-specific</span></span>
<span id="cb641-33"><a aria-hidden="true" href="#cb641-33" tabindex="-1"></a>  x_show_hourglass<span class="op">,</span>                <span class="co">// X11-specific</span></span>
<span id="cb641-34"><a aria-hidden="true" href="#cb641-34" tabindex="-1"></a>  x_hide_hourglass<span class="op">,</span>                <span class="co">// X11-specific</span></span>
<span id="cb641-35"><a aria-hidden="true" href="#cb641-35" tabindex="-1"></a>  x_default_font_parameter         <span class="co">// X11-specific</span></span>
<span id="cb641-36"><a aria-hidden="true" href="#cb641-36" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<p><strong>Location:</strong>
<code>/home/user/emacs/src/xterm.c:31909-31944</code></p>
<p><strong>Analysis:</strong> - ~40% of methods use generic
implementations (code reuse across GUI platforms) - ~60% are
X11-specific (handling X11‚Äôs unique features and idiosyncrasies) - Cairo
support is conditional (modern rendering path)</p>
<h4 data-number="18.5.1.3" id="x11-terminal-creation"><span class="header-section-number">18.5.1.3</span> X11 Terminal Creation</h4>
<div class="sourceCode" id="cb642"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb642-1"><a aria-hidden="true" href="#cb642-1" tabindex="-1"></a><span class="dt">static</span> <span class="kw">struct</span> terminal <span class="op">*</span></span>
<span id="cb642-2"><a aria-hidden="true" href="#cb642-2" tabindex="-1"></a>x_create_terminal <span class="op">(</span><span class="kw">struct</span> x_display_info <span class="op">*</span>dpyinfo<span class="op">)</span></span>
<span id="cb642-3"><a aria-hidden="true" href="#cb642-3" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb642-4"><a aria-hidden="true" href="#cb642-4" tabindex="-1"></a>  <span class="kw">struct</span> terminal <span class="op">*</span>terminal<span class="op">;</span></span>
<span id="cb642-5"><a aria-hidden="true" href="#cb642-5" tabindex="-1"></a></span>
<span id="cb642-6"><a aria-hidden="true" href="#cb642-6" tabindex="-1"></a>  terminal <span class="op">=</span> create_terminal <span class="op">(</span>output_x_window<span class="op">,</span> <span class="op">&amp;</span>x_redisplay_interface<span class="op">);</span></span>
<span id="cb642-7"><a aria-hidden="true" href="#cb642-7" tabindex="-1"></a></span>
<span id="cb642-8"><a aria-hidden="true" href="#cb642-8" tabindex="-1"></a>  terminal<span class="op">-&gt;</span>display_info<span class="op">.</span>x <span class="op">=</span> dpyinfo<span class="op">;</span></span>
<span id="cb642-9"><a aria-hidden="true" href="#cb642-9" tabindex="-1"></a>  dpyinfo<span class="op">-&gt;</span>terminal <span class="op">=</span> terminal<span class="op">;</span></span>
<span id="cb642-10"><a aria-hidden="true" href="#cb642-10" tabindex="-1"></a></span>
<span id="cb642-11"><a aria-hidden="true" href="#cb642-11" tabindex="-1"></a>  <span class="co">/* kboard is initialized in x_term_init. */</span></span>
<span id="cb642-12"><a aria-hidden="true" href="#cb642-12" tabindex="-1"></a></span>
<span id="cb642-13"><a aria-hidden="true" href="#cb642-13" tabindex="-1"></a>  terminal<span class="op">-&gt;</span>clear_frame_hook <span class="op">=</span> x_clear_frame<span class="op">;</span></span>
<span id="cb642-14"><a aria-hidden="true" href="#cb642-14" tabindex="-1"></a>  terminal<span class="op">-&gt;</span>ins_del_lines_hook <span class="op">=</span> x_ins_del_lines<span class="op">;</span></span>
<span id="cb642-15"><a aria-hidden="true" href="#cb642-15" tabindex="-1"></a>  terminal<span class="op">-&gt;</span>delete_glyphs_hook <span class="op">=</span> x_delete_glyphs<span class="op">;</span></span>
<span id="cb642-16"><a aria-hidden="true" href="#cb642-16" tabindex="-1"></a>  terminal<span class="op">-&gt;</span>ring_bell_hook <span class="op">=</span> XTring_bell<span class="op">;</span></span>
<span id="cb642-17"><a aria-hidden="true" href="#cb642-17" tabindex="-1"></a>  terminal<span class="op">-&gt;</span>toggle_invisible_pointer_hook <span class="op">=</span> XTtoggle_invisible_pointer<span class="op">;</span></span>
<span id="cb642-18"><a aria-hidden="true" href="#cb642-18" tabindex="-1"></a>  terminal<span class="op">-&gt;</span>update_begin_hook <span class="op">=</span> x_update_begin<span class="op">;</span></span>
<span id="cb642-19"><a aria-hidden="true" href="#cb642-19" tabindex="-1"></a>  terminal<span class="op">-&gt;</span>update_end_hook <span class="op">=</span> x_update_end<span class="op">;</span></span>
<span id="cb642-20"><a aria-hidden="true" href="#cb642-20" tabindex="-1"></a>  terminal<span class="op">-&gt;</span>read_socket_hook <span class="op">=</span> XTread_socket<span class="op">;</span></span>
<span id="cb642-21"><a aria-hidden="true" href="#cb642-21" tabindex="-1"></a>  terminal<span class="op">-&gt;</span>frame_up_to_date_hook <span class="op">=</span> XTframe_up_to_date<span class="op">;</span></span>
<span id="cb642-22"><a aria-hidden="true" href="#cb642-22" tabindex="-1"></a><span class="pp">#ifdef HAVE_XDBE</span></span>
<span id="cb642-23"><a aria-hidden="true" href="#cb642-23" tabindex="-1"></a>  terminal<span class="op">-&gt;</span>buffer_flipping_unblocked_hook <span class="op">=</span> XTbuffer_flipping_unblocked_hook<span class="op">;</span></span>
<span id="cb642-24"><a aria-hidden="true" href="#cb642-24" tabindex="-1"></a><span class="pp">#endif</span></span>
<span id="cb642-25"><a aria-hidden="true" href="#cb642-25" tabindex="-1"></a>  terminal<span class="op">-&gt;</span>defined_color_hook <span class="op">=</span> x_defined_color<span class="op">;</span></span>
<span id="cb642-26"><a aria-hidden="true" href="#cb642-26" tabindex="-1"></a>  terminal<span class="op">-&gt;</span>query_frame_background_color <span class="op">=</span> x_query_frame_background_color<span class="op">;</span></span>
<span id="cb642-27"><a aria-hidden="true" href="#cb642-27" tabindex="-1"></a>  terminal<span class="op">-&gt;</span>query_colors <span class="op">=</span> x_query_colors<span class="op">;</span></span>
<span id="cb642-28"><a aria-hidden="true" href="#cb642-28" tabindex="-1"></a>  terminal<span class="op">-&gt;</span>mouse_position_hook <span class="op">=</span> XTmouse_position<span class="op">;</span></span>
<span id="cb642-29"><a aria-hidden="true" href="#cb642-29" tabindex="-1"></a>  terminal<span class="op">-&gt;</span>get_focus_frame <span class="op">=</span> x_get_focus_frame<span class="op">;</span></span>
<span id="cb642-30"><a aria-hidden="true" href="#cb642-30" tabindex="-1"></a>  terminal<span class="op">-&gt;</span>focus_frame_hook <span class="op">=</span> x_focus_frame<span class="op">;</span></span>
<span id="cb642-31"><a aria-hidden="true" href="#cb642-31" tabindex="-1"></a>  terminal<span class="op">-&gt;</span>frame_rehighlight_hook <span class="op">=</span> XTframe_rehighlight<span class="op">;</span></span>
<span id="cb642-32"><a aria-hidden="true" href="#cb642-32" tabindex="-1"></a>  terminal<span class="op">-&gt;</span>frame_raise_lower_hook <span class="op">=</span> XTframe_raise_lower<span class="op">;</span></span>
<span id="cb642-33"><a aria-hidden="true" href="#cb642-33" tabindex="-1"></a>  terminal<span class="op">-&gt;</span>frame_visible_invisible_hook <span class="op">=</span> x_make_frame_visible_invisible<span class="op">;</span></span>
<span id="cb642-34"><a aria-hidden="true" href="#cb642-34" tabindex="-1"></a>  terminal<span class="op">-&gt;</span>fullscreen_hook <span class="op">=</span> XTfullscreen_hook<span class="op">;</span></span>
<span id="cb642-35"><a aria-hidden="true" href="#cb642-35" tabindex="-1"></a>  terminal<span class="op">-&gt;</span>iconify_frame_hook <span class="op">=</span> x_iconify_frame<span class="op">;</span></span>
<span id="cb642-36"><a aria-hidden="true" href="#cb642-36" tabindex="-1"></a>  terminal<span class="op">-&gt;</span>set_window_size_hook <span class="op">=</span> x_set_window_size<span class="op">;</span></span>
<span id="cb642-37"><a aria-hidden="true" href="#cb642-37" tabindex="-1"></a>  terminal<span class="op">-&gt;</span>set_frame_offset_hook <span class="op">=</span> x_set_offset<span class="op">;</span></span>
<span id="cb642-38"><a aria-hidden="true" href="#cb642-38" tabindex="-1"></a>  terminal<span class="op">-&gt;</span>set_frame_alpha_hook <span class="op">=</span> x_set_frame_alpha<span class="op">;</span></span>
<span id="cb642-39"><a aria-hidden="true" href="#cb642-39" tabindex="-1"></a>  terminal<span class="op">-&gt;</span>set_new_font_hook <span class="op">=</span> x_new_font<span class="op">;</span></span>
<span id="cb642-40"><a aria-hidden="true" href="#cb642-40" tabindex="-1"></a>  terminal<span class="op">-&gt;</span>set_bitmap_icon_hook <span class="op">=</span> x_bitmap_icon<span class="op">;</span></span>
<span id="cb642-41"><a aria-hidden="true" href="#cb642-41" tabindex="-1"></a>  terminal<span class="op">-&gt;</span>implicit_set_name_hook <span class="op">=</span> x_implicitly_set_name<span class="op">;</span></span>
<span id="cb642-42"><a aria-hidden="true" href="#cb642-42" tabindex="-1"></a>  terminal<span class="op">-&gt;</span>menu_show_hook <span class="op">=</span> x_menu_show<span class="op">;</span></span>
<span id="cb642-43"><a aria-hidden="true" href="#cb642-43" tabindex="-1"></a><span class="pp">#ifdef HAVE_EXT_MENU_BAR</span></span>
<span id="cb642-44"><a aria-hidden="true" href="#cb642-44" tabindex="-1"></a>  terminal<span class="op">-&gt;</span>activate_menubar_hook <span class="op">=</span> x_activate_menubar<span class="op">;</span></span>
<span id="cb642-45"><a aria-hidden="true" href="#cb642-45" tabindex="-1"></a><span class="pp">#endif</span></span>
<span id="cb642-46"><a aria-hidden="true" href="#cb642-46" tabindex="-1"></a><span class="pp">#if defined (USE_X_TOOLKIT) || defined (USE_GTK)</span></span>
<span id="cb642-47"><a aria-hidden="true" href="#cb642-47" tabindex="-1"></a>  terminal<span class="op">-&gt;</span>popup_dialog_hook <span class="op">=</span> xw_popup_dialog<span class="op">;</span></span>
<span id="cb642-48"><a aria-hidden="true" href="#cb642-48" tabindex="-1"></a><span class="pp">#endif</span></span>
<span id="cb642-49"><a aria-hidden="true" href="#cb642-49" tabindex="-1"></a>  terminal<span class="op">-&gt;</span>change_tab_bar_height_hook <span class="op">=</span> x_change_tab_bar_height<span class="op">;</span></span>
<span id="cb642-50"><a aria-hidden="true" href="#cb642-50" tabindex="-1"></a><span class="pp">#ifndef HAVE_EXT_TOOL_BAR</span></span>
<span id="cb642-51"><a aria-hidden="true" href="#cb642-51" tabindex="-1"></a>  terminal<span class="op">-&gt;</span>change_tool_bar_height_hook <span class="op">=</span> x_change_tool_bar_height<span class="op">;</span></span>
<span id="cb642-52"><a aria-hidden="true" href="#cb642-52" tabindex="-1"></a><span class="pp">#endif</span></span>
<span id="cb642-53"><a aria-hidden="true" href="#cb642-53" tabindex="-1"></a>  terminal<span class="op">-&gt;</span>set_vertical_scroll_bar_hook <span class="op">=</span> XTset_vertical_scroll_bar<span class="op">;</span></span>
<span id="cb642-54"><a aria-hidden="true" href="#cb642-54" tabindex="-1"></a>  terminal<span class="op">-&gt;</span>set_horizontal_scroll_bar_hook <span class="op">=</span> XTset_horizontal_scroll_bar<span class="op">;</span></span>
<span id="cb642-55"><a aria-hidden="true" href="#cb642-55" tabindex="-1"></a>  terminal<span class="op">-&gt;</span>set_scroll_bar_default_width_hook <span class="op">=</span> x_set_scroll_bar_default_width<span class="op">;</span></span>
<span id="cb642-56"><a aria-hidden="true" href="#cb642-56" tabindex="-1"></a>  terminal<span class="op">-&gt;</span>set_scroll_bar_default_height_hook <span class="op">=</span> x_set_scroll_bar_default_height<span class="op">;</span></span>
<span id="cb642-57"><a aria-hidden="true" href="#cb642-57" tabindex="-1"></a>  terminal<span class="op">-&gt;</span>condemn_scroll_bars_hook <span class="op">=</span> XTcondemn_scroll_bars<span class="op">;</span></span>
<span id="cb642-58"><a aria-hidden="true" href="#cb642-58" tabindex="-1"></a>  terminal<span class="op">-&gt;</span>redeem_scroll_bar_hook <span class="op">=</span> XTredeem_scroll_bar<span class="op">;</span></span>
<span id="cb642-59"><a aria-hidden="true" href="#cb642-59" tabindex="-1"></a>  terminal<span class="op">-&gt;</span>judge_scroll_bars_hook <span class="op">=</span> XTjudge_scroll_bars<span class="op">;</span></span>
<span id="cb642-60"><a aria-hidden="true" href="#cb642-60" tabindex="-1"></a>  terminal<span class="op">-&gt;</span>get_string_resource_hook <span class="op">=</span> x_get_string_resource<span class="op">;</span></span>
<span id="cb642-61"><a aria-hidden="true" href="#cb642-61" tabindex="-1"></a>  terminal<span class="op">-&gt;</span>free_pixmap <span class="op">=</span> x_free_pixmap<span class="op">;</span></span>
<span id="cb642-62"><a aria-hidden="true" href="#cb642-62" tabindex="-1"></a>  terminal<span class="op">-&gt;</span>delete_frame_hook <span class="op">=</span> x_destroy_window<span class="op">;</span></span>
<span id="cb642-63"><a aria-hidden="true" href="#cb642-63" tabindex="-1"></a>  terminal<span class="op">-&gt;</span>delete_terminal_hook <span class="op">=</span> x_delete_terminal<span class="op">;</span></span>
<span id="cb642-64"><a aria-hidden="true" href="#cb642-64" tabindex="-1"></a>  terminal<span class="op">-&gt;</span>toolkit_position_hook <span class="op">=</span> x_toolkit_position<span class="op">;</span></span>
<span id="cb642-65"><a aria-hidden="true" href="#cb642-65" tabindex="-1"></a><span class="pp">#ifdef HAVE_XINPUT2</span></span>
<span id="cb642-66"><a aria-hidden="true" href="#cb642-66" tabindex="-1"></a>  terminal<span class="op">-&gt;</span>any_grab_hook <span class="op">=</span> x_have_any_grab<span class="op">;</span></span>
<span id="cb642-67"><a aria-hidden="true" href="#cb642-67" tabindex="-1"></a><span class="pp">#endif</span></span>
<span id="cb642-68"><a aria-hidden="true" href="#cb642-68" tabindex="-1"></a>  <span class="co">/* Other hooks are NULL by default.  */</span></span>
<span id="cb642-69"><a aria-hidden="true" href="#cb642-69" tabindex="-1"></a></span>
<span id="cb642-70"><a aria-hidden="true" href="#cb642-70" tabindex="-1"></a>  <span class="cf">return</span> terminal<span class="op">;</span></span>
<span id="cb642-71"><a aria-hidden="true" href="#cb642-71" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>Location:</strong>
<code>/home/user/emacs/src/xterm.c:32114-32183</code></p>
<p><strong>Key Features:</strong> 1. <strong>Comprehensive Hook
Implementation</strong>: Nearly all hooks are implemented 2.
<strong>Conditional Features</strong>: XDBE (double-buffering), XInput2
(advanced input), toolkit-specific dialogs 3. <strong>Scroll Bar
Lifecycle</strong>: Three-phase scroll bar management (condemn, redeem,
judge)</p>
<h3 data-number="18.5.2" id="windows-win32w32"><span class="header-section-number">18.5.2</span> 3.2 Windows (Win32/w32)</h3>
<h4 data-number="18.5.2.1" id="file-structure-1"><span class="header-section-number">18.5.2.1</span> File Structure</h4>
<p>The Windows implementation is the most extensive:</p>
<table>
<colgroup>
<col style="width: 20%"/>
<col style="width: 31%"/>
<col style="width: 48%"/>
</colgroup>
<thead>
<tr>
<th>File</th>
<th>Purpose</th>
<th>LOC (approx)</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>w32term.c</code></td>
<td>Terminal implementation, message loop, rendering</td>
<td>8,000+</td>
</tr>
<tr>
<td><code>w32term.h</code></td>
<td>Windows-specific structures</td>
<td>800+</td>
</tr>
<tr>
<td><code>w32fns.c</code></td>
<td>Frame functions, window procedures</td>
<td>10,000+</td>
</tr>
<tr>
<td><code>w32.c</code></td>
<td>OS-level functions (file system, processes, etc.)</td>
<td>10,000+</td>
</tr>
<tr>
<td><code>w32menu.c</code></td>
<td>Menu implementation</td>
<td>2,000+</td>
</tr>
<tr>
<td><code>w32select.c</code></td>
<td>Clipboard handling</td>
<td>1,500+</td>
</tr>
<tr>
<td><code>w32font.c</code></td>
<td>GDI font driver</td>
<td>2,500+</td>
</tr>
<tr>
<td><code>w32uniscribe.c</code></td>
<td>Uniscribe complex script shaping</td>
<td>1,000+</td>
</tr>
<tr>
<td><code>w32dwrite.c</code></td>
<td>DirectWrite font rendering</td>
<td>1,500+</td>
</tr>
<tr>
<td><code>w32console.c</code></td>
<td>Console (terminal) support</td>
<td>1,000+</td>
</tr>
<tr>
<td><code>w32proc.c</code></td>
<td>Process management</td>
<td>3,500+</td>
</tr>
<tr>
<td><code>w32heap.c</code></td>
<td>Heap management</td>
<td>500+</td>
</tr>
<tr>
<td><code>w32inevt.c</code></td>
<td>Console input events</td>
<td>600+</td>
</tr>
<tr>
<td><code>w32reg.c</code></td>
<td>Windows Registry access</td>
<td>300+</td>
</tr>
<tr>
<td><code>w32notify.c</code></td>
<td>File system change notifications</td>
<td>800+</td>
</tr>
<tr>
<td><code>w32image.c</code></td>
<td>Image loading via Windows Imaging Component</td>
<td>400+</td>
</tr>
<tr>
<td><code>w32cygwinx.c</code></td>
<td>Cygwin X11 integration</td>
<td>200+</td>
</tr>
<tr>
<td><code>w32xfns.c</code></td>
<td>Compatibility layer</td>
<td>300+</td>
</tr>
<tr>
<td><code>w32common.h</code></td>
<td>Common definitions</td>
<td>200+</td>
</tr>
</tbody>
</table>
<p><strong>Total:</strong> ~45,100 lines of Windows-specific code</p>
<h4 data-number="18.5.2.2" id="windows-redisplay-interface"><span class="header-section-number">18.5.2.2</span> Windows Redisplay
Interface</h4>
<div class="sourceCode" id="cb643"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb643-1"><a aria-hidden="true" href="#cb643-1" tabindex="-1"></a><span class="dt">static</span> <span class="kw">struct</span> redisplay_interface w32_redisplay_interface <span class="op">=</span></span>
<span id="cb643-2"><a aria-hidden="true" href="#cb643-2" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb643-3"><a aria-hidden="true" href="#cb643-3" tabindex="-1"></a>  w32_frame_parm_handlers<span class="op">,</span></span>
<span id="cb643-4"><a aria-hidden="true" href="#cb643-4" tabindex="-1"></a>  gui_produce_glyphs<span class="op">,</span></span>
<span id="cb643-5"><a aria-hidden="true" href="#cb643-5" tabindex="-1"></a>  gui_write_glyphs<span class="op">,</span></span>
<span id="cb643-6"><a aria-hidden="true" href="#cb643-6" tabindex="-1"></a>  gui_insert_glyphs<span class="op">,</span></span>
<span id="cb643-7"><a aria-hidden="true" href="#cb643-7" tabindex="-1"></a>  gui_clear_end_of_line<span class="op">,</span></span>
<span id="cb643-8"><a aria-hidden="true" href="#cb643-8" tabindex="-1"></a>  w32_scroll_run<span class="op">,</span></span>
<span id="cb643-9"><a aria-hidden="true" href="#cb643-9" tabindex="-1"></a>  w32_after_update_window_line<span class="op">,</span></span>
<span id="cb643-10"><a aria-hidden="true" href="#cb643-10" tabindex="-1"></a>  w32_update_window_begin<span class="op">,</span></span>
<span id="cb643-11"><a aria-hidden="true" href="#cb643-11" tabindex="-1"></a>  w32_update_window_end<span class="op">,</span></span>
<span id="cb643-12"><a aria-hidden="true" href="#cb643-12" tabindex="-1"></a>  <span class="dv">0</span><span class="op">,</span> <span class="co">/* flush_display */</span></span>
<span id="cb643-13"><a aria-hidden="true" href="#cb643-13" tabindex="-1"></a>  gui_clear_window_mouse_face<span class="op">,</span></span>
<span id="cb643-14"><a aria-hidden="true" href="#cb643-14" tabindex="-1"></a>  gui_get_glyph_overhangs<span class="op">,</span></span>
<span id="cb643-15"><a aria-hidden="true" href="#cb643-15" tabindex="-1"></a>  gui_fix_overlapping_area<span class="op">,</span></span>
<span id="cb643-16"><a aria-hidden="true" href="#cb643-16" tabindex="-1"></a>  w32_draw_fringe_bitmap<span class="op">,</span></span>
<span id="cb643-17"><a aria-hidden="true" href="#cb643-17" tabindex="-1"></a>  w32_define_fringe_bitmap<span class="op">,</span></span>
<span id="cb643-18"><a aria-hidden="true" href="#cb643-18" tabindex="-1"></a>  w32_destroy_fringe_bitmap<span class="op">,</span></span>
<span id="cb643-19"><a aria-hidden="true" href="#cb643-19" tabindex="-1"></a>  w32_compute_glyph_string_overhangs<span class="op">,</span></span>
<span id="cb643-20"><a aria-hidden="true" href="#cb643-20" tabindex="-1"></a>  w32_draw_glyph_string<span class="op">,</span>             <span class="co">// GDI/GDI+ rendering</span></span>
<span id="cb643-21"><a aria-hidden="true" href="#cb643-21" tabindex="-1"></a>  w32_define_frame_cursor<span class="op">,</span></span>
<span id="cb643-22"><a aria-hidden="true" href="#cb643-22" tabindex="-1"></a>  w32_clear_frame_area<span class="op">,</span></span>
<span id="cb643-23"><a aria-hidden="true" href="#cb643-23" tabindex="-1"></a>  w32_clear_under_internal_border<span class="op">,</span></span>
<span id="cb643-24"><a aria-hidden="true" href="#cb643-24" tabindex="-1"></a>  w32_draw_window_cursor<span class="op">,</span></span>
<span id="cb643-25"><a aria-hidden="true" href="#cb643-25" tabindex="-1"></a>  w32_draw_vertical_window_border<span class="op">,</span></span>
<span id="cb643-26"><a aria-hidden="true" href="#cb643-26" tabindex="-1"></a>  w32_draw_window_divider<span class="op">,</span></span>
<span id="cb643-27"><a aria-hidden="true" href="#cb643-27" tabindex="-1"></a>  w32_shift_glyphs_for_insert<span class="op">,</span></span>
<span id="cb643-28"><a aria-hidden="true" href="#cb643-28" tabindex="-1"></a>  w32_show_hourglass<span class="op">,</span></span>
<span id="cb643-29"><a aria-hidden="true" href="#cb643-29" tabindex="-1"></a>  w32_hide_hourglass<span class="op">,</span></span>
<span id="cb643-30"><a aria-hidden="true" href="#cb643-30" tabindex="-1"></a>  w32_default_font_parameter</span>
<span id="cb643-31"><a aria-hidden="true" href="#cb643-31" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<p><strong>Location:</strong>
<code>/home/user/emacs/src/w32term.c:7819-7848</code></p>
<p><strong>Unique Features:</strong> - No <code>flush_display</code>
(Windows handles this automatically) - GDI+ support for image
transformations - DirectWrite integration for high-quality text
rendering - Complex IME (Input Method Editor) support</p>
<h3 data-number="18.5.3" id="android-1"><span class="header-section-number">18.5.3</span> 3.3 Android</h3>
<h4 data-number="18.5.3.1" id="file-structure-2"><span class="header-section-number">18.5.3.1</span> File Structure</h4>
<p>The Android port is one of the newer additions:</p>
<table>
<thead>
<tr>
<th>File</th>
<th>Purpose</th>
<th>LOC (approx)</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>androidterm.c</code></td>
<td>Terminal implementation, event handling</td>
<td>6,800+</td>
</tr>
<tr>
<td><code>androidterm.h</code></td>
<td>Android structures</td>
<td>1,200+</td>
</tr>
<tr>
<td><code>androidfns.c</code></td>
<td>Frame functions</td>
<td>3,500+</td>
</tr>
<tr>
<td><code>android.c</code></td>
<td>Android system integration</td>
<td>15,000+</td>
</tr>
<tr>
<td><code>androidfont.c</code></td>
<td>Android font driver</td>
<td>1,500+</td>
</tr>
<tr>
<td><code>androidmenu.c</code></td>
<td>Menu implementation</td>
<td>1,800+</td>
</tr>
<tr>
<td><code>androidselect.c</code></td>
<td>Clipboard/selection</td>
<td>700+</td>
</tr>
<tr>
<td><code>androidgui.h</code></td>
<td>GUI definitions</td>
<td>400+</td>
</tr>
<tr>
<td><code>androidvfs.c</code></td>
<td>Virtual file system (content:// URIs)</td>
<td>2,500+</td>
</tr>
<tr>
<td><code>android-emacs.c</code></td>
<td>JNI bridge, Java integration</td>
<td>3,000+</td>
</tr>
<tr>
<td><code>android.h</code></td>
<td>Main Android header</td>
<td>1,000+</td>
</tr>
<tr>
<td><code>android-asset.h</code></td>
<td>Asset management</td>
<td>300+</td>
</tr>
</tbody>
</table>
<p><strong>Total:</strong> ~38,000 lines of Android-specific code</p>
<h4 data-number="18.5.3.2" id="android-redisplay-interface"><span class="header-section-number">18.5.3.2</span> Android Redisplay
Interface</h4>
<div class="sourceCode" id="cb644"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb644-1"><a aria-hidden="true" href="#cb644-1" tabindex="-1"></a><span class="dt">static</span> <span class="kw">struct</span> redisplay_interface android_redisplay_interface <span class="op">=</span></span>
<span id="cb644-2"><a aria-hidden="true" href="#cb644-2" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb644-3"><a aria-hidden="true" href="#cb644-3" tabindex="-1"></a><span class="pp">#ifndef ANDROID_STUBIFY</span></span>
<span id="cb644-4"><a aria-hidden="true" href="#cb644-4" tabindex="-1"></a>  android_frame_parm_handlers<span class="op">,</span></span>
<span id="cb644-5"><a aria-hidden="true" href="#cb644-5" tabindex="-1"></a>  gui_produce_glyphs<span class="op">,</span></span>
<span id="cb644-6"><a aria-hidden="true" href="#cb644-6" tabindex="-1"></a>  gui_write_glyphs<span class="op">,</span></span>
<span id="cb644-7"><a aria-hidden="true" href="#cb644-7" tabindex="-1"></a>  gui_insert_glyphs<span class="op">,</span></span>
<span id="cb644-8"><a aria-hidden="true" href="#cb644-8" tabindex="-1"></a>  gui_clear_end_of_line<span class="op">,</span></span>
<span id="cb644-9"><a aria-hidden="true" href="#cb644-9" tabindex="-1"></a>  android_scroll_run<span class="op">,</span></span>
<span id="cb644-10"><a aria-hidden="true" href="#cb644-10" tabindex="-1"></a>  android_after_update_window_line<span class="op">,</span></span>
<span id="cb644-11"><a aria-hidden="true" href="#cb644-11" tabindex="-1"></a>  NULL<span class="op">,</span> <span class="co">/* update_window_begin */</span></span>
<span id="cb644-12"><a aria-hidden="true" href="#cb644-12" tabindex="-1"></a>  NULL<span class="op">,</span> <span class="co">/* update_window_end   */</span></span>
<span id="cb644-13"><a aria-hidden="true" href="#cb644-13" tabindex="-1"></a>  android_flush_display<span class="op">,</span></span>
<span id="cb644-14"><a aria-hidden="true" href="#cb644-14" tabindex="-1"></a>  gui_clear_window_mouse_face<span class="op">,</span></span>
<span id="cb644-15"><a aria-hidden="true" href="#cb644-15" tabindex="-1"></a>  gui_get_glyph_overhangs<span class="op">,</span></span>
<span id="cb644-16"><a aria-hidden="true" href="#cb644-16" tabindex="-1"></a>  gui_fix_overlapping_area<span class="op">,</span></span>
<span id="cb644-17"><a aria-hidden="true" href="#cb644-17" tabindex="-1"></a>  android_draw_fringe_bitmap<span class="op">,</span></span>
<span id="cb644-18"><a aria-hidden="true" href="#cb644-18" tabindex="-1"></a>  android_define_fringe_bitmap<span class="op">,</span></span>
<span id="cb644-19"><a aria-hidden="true" href="#cb644-19" tabindex="-1"></a>  android_destroy_fringe_bitmap<span class="op">,</span></span>
<span id="cb644-20"><a aria-hidden="true" href="#cb644-20" tabindex="-1"></a>  android_compute_glyph_string_overhangs<span class="op">,</span></span>
<span id="cb644-21"><a aria-hidden="true" href="#cb644-21" tabindex="-1"></a>  android_draw_glyph_string<span class="op">,</span>         <span class="co">// Android Canvas API</span></span>
<span id="cb644-22"><a aria-hidden="true" href="#cb644-22" tabindex="-1"></a>  android_define_frame_cursor<span class="op">,</span></span>
<span id="cb644-23"><a aria-hidden="true" href="#cb644-23" tabindex="-1"></a>  android_clear_frame_area<span class="op">,</span></span>
<span id="cb644-24"><a aria-hidden="true" href="#cb644-24" tabindex="-1"></a>  android_clear_under_internal_border<span class="op">,</span></span>
<span id="cb644-25"><a aria-hidden="true" href="#cb644-25" tabindex="-1"></a>  android_draw_window_cursor<span class="op">,</span></span>
<span id="cb644-26"><a aria-hidden="true" href="#cb644-26" tabindex="-1"></a>  android_draw_vertical_window_border<span class="op">,</span></span>
<span id="cb644-27"><a aria-hidden="true" href="#cb644-27" tabindex="-1"></a>  android_draw_window_divider<span class="op">,</span></span>
<span id="cb644-28"><a aria-hidden="true" href="#cb644-28" tabindex="-1"></a>  android_shift_glyphs_for_insert<span class="op">,</span></span>
<span id="cb644-29"><a aria-hidden="true" href="#cb644-29" tabindex="-1"></a>  android_show_hourglass<span class="op">,</span></span>
<span id="cb644-30"><a aria-hidden="true" href="#cb644-30" tabindex="-1"></a>  android_hide_hourglass<span class="op">,</span></span>
<span id="cb644-31"><a aria-hidden="true" href="#cb644-31" tabindex="-1"></a>  android_default_font_parameter<span class="op">,</span></span>
<span id="cb644-32"><a aria-hidden="true" href="#cb644-32" tabindex="-1"></a><span class="pp">#endif</span></span>
<span id="cb644-33"><a aria-hidden="true" href="#cb644-33" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<p><strong>Location:</strong>
<code>/home/user/emacs/src/androidterm.c:6596-6625</code></p>
<p><strong>Unique Challenges:</strong> - <strong>JNI Overhead</strong>:
All windowing operations require Java Native Interface calls -
<strong>Threading</strong>: Android UI must run on main thread; Emacs
runs on background thread - <strong>Lifecycle</strong>: Android apps can
be paused/resumed/destroyed at any time - <strong>Touch Input</strong>:
Extensive touchscreen and gesture support</p>
<h3 data-number="18.5.4" id="gtkpgtk-pure-gtk"><span class="header-section-number">18.5.4</span> 3.4 GTK/PGTK (Pure GTK)</h3>
<p>The PGTK port is designed for Wayland compatibility:</p>
<div class="sourceCode" id="cb645"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb645-1"><a aria-hidden="true" href="#cb645-1" tabindex="-1"></a><span class="dt">static</span> <span class="kw">struct</span> redisplay_interface pgtk_redisplay_interface <span class="op">=</span> <span class="op">{</span></span>
<span id="cb645-2"><a aria-hidden="true" href="#cb645-2" tabindex="-1"></a>  pgtk_frame_parm_handlers<span class="op">,</span></span>
<span id="cb645-3"><a aria-hidden="true" href="#cb645-3" tabindex="-1"></a>  gui_produce_glyphs<span class="op">,</span></span>
<span id="cb645-4"><a aria-hidden="true" href="#cb645-4" tabindex="-1"></a>  gui_write_glyphs<span class="op">,</span></span>
<span id="cb645-5"><a aria-hidden="true" href="#cb645-5" tabindex="-1"></a>  gui_insert_glyphs<span class="op">,</span></span>
<span id="cb645-6"><a aria-hidden="true" href="#cb645-6" tabindex="-1"></a>  gui_clear_end_of_line<span class="op">,</span></span>
<span id="cb645-7"><a aria-hidden="true" href="#cb645-7" tabindex="-1"></a>  pgtk_scroll_run<span class="op">,</span></span>
<span id="cb645-8"><a aria-hidden="true" href="#cb645-8" tabindex="-1"></a>  pgtk_after_update_window_line<span class="op">,</span></span>
<span id="cb645-9"><a aria-hidden="true" href="#cb645-9" tabindex="-1"></a>  NULL<span class="op">,</span> <span class="co">/* gui_update_window_begin, */</span></span>
<span id="cb645-10"><a aria-hidden="true" href="#cb645-10" tabindex="-1"></a>  NULL<span class="op">,</span> <span class="co">/* gui_update_window_end, */</span></span>
<span id="cb645-11"><a aria-hidden="true" href="#cb645-11" tabindex="-1"></a>  pgtk_flush_display<span class="op">,</span></span>
<span id="cb645-12"><a aria-hidden="true" href="#cb645-12" tabindex="-1"></a>  gui_clear_window_mouse_face<span class="op">,</span></span>
<span id="cb645-13"><a aria-hidden="true" href="#cb645-13" tabindex="-1"></a>  gui_get_glyph_overhangs<span class="op">,</span></span>
<span id="cb645-14"><a aria-hidden="true" href="#cb645-14" tabindex="-1"></a>  gui_fix_overlapping_area<span class="op">,</span></span>
<span id="cb645-15"><a aria-hidden="true" href="#cb645-15" tabindex="-1"></a>  pgtk_draw_fringe_bitmap<span class="op">,</span></span>
<span id="cb645-16"><a aria-hidden="true" href="#cb645-16" tabindex="-1"></a>  pgtk_define_fringe_bitmap<span class="op">,</span></span>
<span id="cb645-17"><a aria-hidden="true" href="#cb645-17" tabindex="-1"></a>  pgtk_destroy_fringe_bitmap<span class="op">,</span></span>
<span id="cb645-18"><a aria-hidden="true" href="#cb645-18" tabindex="-1"></a>  pgtk_compute_glyph_string_overhangs<span class="op">,</span></span>
<span id="cb645-19"><a aria-hidden="true" href="#cb645-19" tabindex="-1"></a>  pgtk_draw_glyph_string<span class="op">,</span>            <span class="co">// Cairo rendering</span></span>
<span id="cb645-20"><a aria-hidden="true" href="#cb645-20" tabindex="-1"></a>  pgtk_define_frame_cursor<span class="op">,</span></span>
<span id="cb645-21"><a aria-hidden="true" href="#cb645-21" tabindex="-1"></a>  pgtk_clear_frame_area<span class="op">,</span></span>
<span id="cb645-22"><a aria-hidden="true" href="#cb645-22" tabindex="-1"></a>  pgtk_clear_under_internal_border<span class="op">,</span></span>
<span id="cb645-23"><a aria-hidden="true" href="#cb645-23" tabindex="-1"></a>  pgtk_draw_window_cursor<span class="op">,</span></span>
<span id="cb645-24"><a aria-hidden="true" href="#cb645-24" tabindex="-1"></a>  pgtk_draw_vertical_window_border<span class="op">,</span></span>
<span id="cb645-25"><a aria-hidden="true" href="#cb645-25" tabindex="-1"></a>  pgtk_draw_window_divider<span class="op">,</span></span>
<span id="cb645-26"><a aria-hidden="true" href="#cb645-26" tabindex="-1"></a>  pgtk_shift_glyphs_for_insert<span class="op">,</span></span>
<span id="cb645-27"><a aria-hidden="true" href="#cb645-27" tabindex="-1"></a>  pgtk_show_hourglass<span class="op">,</span></span>
<span id="cb645-28"><a aria-hidden="true" href="#cb645-28" tabindex="-1"></a>  pgtk_hide_hourglass<span class="op">,</span></span>
<span id="cb645-29"><a aria-hidden="true" href="#cb645-29" tabindex="-1"></a>  pgtk_default_font_parameter</span>
<span id="cb645-30"><a aria-hidden="true" href="#cb645-30" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<p><strong>Location:</strong>
<code>/home/user/emacs/src/pgtkterm.c:3716-3745</code></p>
<p><strong>Key Difference from X11:</strong> - <strong>Pure
GTK</strong>: No direct X11 dependency; works on Wayland - <strong>Cairo
Rendering</strong>: All drawing uses Cairo graphics library -
<strong>GTK Event Loop</strong>: Integrates with GTK‚Äôs event system</p>
<h3 data-number="18.5.5" id="haiku"><span class="header-section-number">18.5.5</span> 3.5 Haiku</h3>
<p>The Haiku port brings Emacs to the BeOS successor:</p>
<div class="sourceCode" id="cb646"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb646-1"><a aria-hidden="true" href="#cb646-1" tabindex="-1"></a><span class="dt">static</span> <span class="kw">struct</span> redisplay_interface haiku_redisplay_interface <span class="op">=</span></span>
<span id="cb646-2"><a aria-hidden="true" href="#cb646-2" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb646-3"><a aria-hidden="true" href="#cb646-3" tabindex="-1"></a>  haiku_frame_parm_handlers<span class="op">,</span></span>
<span id="cb646-4"><a aria-hidden="true" href="#cb646-4" tabindex="-1"></a>  gui_produce_glyphs<span class="op">,</span></span>
<span id="cb646-5"><a aria-hidden="true" href="#cb646-5" tabindex="-1"></a>  gui_write_glyphs<span class="op">,</span></span>
<span id="cb646-6"><a aria-hidden="true" href="#cb646-6" tabindex="-1"></a>  gui_insert_glyphs<span class="op">,</span></span>
<span id="cb646-7"><a aria-hidden="true" href="#cb646-7" tabindex="-1"></a>  gui_clear_end_of_line<span class="op">,</span></span>
<span id="cb646-8"><a aria-hidden="true" href="#cb646-8" tabindex="-1"></a>  haiku_scroll_run<span class="op">,</span></span>
<span id="cb646-9"><a aria-hidden="true" href="#cb646-9" tabindex="-1"></a>  haiku_after_update_window_line<span class="op">,</span></span>
<span id="cb646-10"><a aria-hidden="true" href="#cb646-10" tabindex="-1"></a>  NULL<span class="op">,</span> <span class="co">/* update_window_begin */</span></span>
<span id="cb646-11"><a aria-hidden="true" href="#cb646-11" tabindex="-1"></a>  NULL<span class="op">,</span> <span class="co">/* update_window_end */</span></span>
<span id="cb646-12"><a aria-hidden="true" href="#cb646-12" tabindex="-1"></a>  haiku_flush<span class="op">,</span></span>
<span id="cb646-13"><a aria-hidden="true" href="#cb646-13" tabindex="-1"></a>  gui_clear_window_mouse_face<span class="op">,</span></span>
<span id="cb646-14"><a aria-hidden="true" href="#cb646-14" tabindex="-1"></a>  gui_get_glyph_overhangs<span class="op">,</span></span>
<span id="cb646-15"><a aria-hidden="true" href="#cb646-15" tabindex="-1"></a>  gui_fix_overlapping_area<span class="op">,</span></span>
<span id="cb646-16"><a aria-hidden="true" href="#cb646-16" tabindex="-1"></a>  haiku_draw_fringe_bitmap<span class="op">,</span></span>
<span id="cb646-17"><a aria-hidden="true" href="#cb646-17" tabindex="-1"></a>  haiku_define_fringe_bitmap<span class="op">,</span></span>
<span id="cb646-18"><a aria-hidden="true" href="#cb646-18" tabindex="-1"></a>  haiku_destroy_fringe_bitmap<span class="op">,</span></span>
<span id="cb646-19"><a aria-hidden="true" href="#cb646-19" tabindex="-1"></a>  haiku_compute_glyph_string_overhangs<span class="op">,</span></span>
<span id="cb646-20"><a aria-hidden="true" href="#cb646-20" tabindex="-1"></a>  haiku_draw_glyph_string<span class="op">,</span>           <span class="co">// Haiku BView rendering</span></span>
<span id="cb646-21"><a aria-hidden="true" href="#cb646-21" tabindex="-1"></a>  haiku_define_frame_cursor<span class="op">,</span></span>
<span id="cb646-22"><a aria-hidden="true" href="#cb646-22" tabindex="-1"></a>  haiku_clear_frame_area<span class="op">,</span></span>
<span id="cb646-23"><a aria-hidden="true" href="#cb646-23" tabindex="-1"></a>  haiku_clear_under_internal_border<span class="op">,</span></span>
<span id="cb646-24"><a aria-hidden="true" href="#cb646-24" tabindex="-1"></a>  haiku_draw_window_cursor<span class="op">,</span></span>
<span id="cb646-25"><a aria-hidden="true" href="#cb646-25" tabindex="-1"></a>  haiku_draw_vertical_window_border<span class="op">,</span></span>
<span id="cb646-26"><a aria-hidden="true" href="#cb646-26" tabindex="-1"></a>  haiku_draw_window_divider<span class="op">,</span></span>
<span id="cb646-27"><a aria-hidden="true" href="#cb646-27" tabindex="-1"></a>  haiku_shift_glyphs_for_insert<span class="op">,</span></span>
<span id="cb646-28"><a aria-hidden="true" href="#cb646-28" tabindex="-1"></a>  haiku_show_hourglass<span class="op">,</span></span>
<span id="cb646-29"><a aria-hidden="true" href="#cb646-29" tabindex="-1"></a>  haiku_hide_hourglass<span class="op">,</span></span>
<span id="cb646-30"><a aria-hidden="true" href="#cb646-30" tabindex="-1"></a>  haiku_default_font_parameter<span class="op">,</span></span>
<span id="cb646-31"><a aria-hidden="true" href="#cb646-31" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<p><strong>Location:</strong>
<code>/home/user/emacs/src/haikuterm.c:3130-3160</code></p>
<h3 data-number="18.5.6" id="tty-terminaltext-mode"><span class="header-section-number">18.5.6</span> 3.6 TTY (Terminal/Text
Mode)</h3>
<p>TTY terminals have no redisplay interface (it‚Äôs NULL) but implement
all the text-based hooks:</p>
<div class="sourceCode" id="cb647"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb647-1"><a aria-hidden="true" href="#cb647-1" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span></span>
<span id="cb647-2"><a aria-hidden="true" href="#cb647-2" tabindex="-1"></a>set_tty_hooks <span class="op">(</span><span class="kw">struct</span> terminal <span class="op">*</span>terminal<span class="op">)</span></span>
<span id="cb647-3"><a aria-hidden="true" href="#cb647-3" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb647-4"><a aria-hidden="true" href="#cb647-4" tabindex="-1"></a>  terminal<span class="op">-&gt;</span>rif <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> <span class="co">/* ttys don't support window-based redisplay. */</span></span>
<span id="cb647-5"><a aria-hidden="true" href="#cb647-5" tabindex="-1"></a></span>
<span id="cb647-6"><a aria-hidden="true" href="#cb647-6" tabindex="-1"></a>  terminal<span class="op">-&gt;</span>cursor_to_hook <span class="op">=</span> <span class="op">&amp;</span>tty_cursor_to<span class="op">;</span></span>
<span id="cb647-7"><a aria-hidden="true" href="#cb647-7" tabindex="-1"></a>  terminal<span class="op">-&gt;</span>raw_cursor_to_hook <span class="op">=</span> <span class="op">&amp;</span>tty_raw_cursor_to<span class="op">;</span></span>
<span id="cb647-8"><a aria-hidden="true" href="#cb647-8" tabindex="-1"></a></span>
<span id="cb647-9"><a aria-hidden="true" href="#cb647-9" tabindex="-1"></a>  terminal<span class="op">-&gt;</span>clear_to_end_hook <span class="op">=</span> <span class="op">&amp;</span>tty_clear_to_end<span class="op">;</span></span>
<span id="cb647-10"><a aria-hidden="true" href="#cb647-10" tabindex="-1"></a>  terminal<span class="op">-&gt;</span>clear_frame_hook <span class="op">=</span> <span class="op">&amp;</span>tty_clear_frame<span class="op">;</span></span>
<span id="cb647-11"><a aria-hidden="true" href="#cb647-11" tabindex="-1"></a>  terminal<span class="op">-&gt;</span>clear_end_of_line_hook <span class="op">=</span> <span class="op">&amp;</span>tty_clear_end_of_line<span class="op">;</span></span>
<span id="cb647-12"><a aria-hidden="true" href="#cb647-12" tabindex="-1"></a></span>
<span id="cb647-13"><a aria-hidden="true" href="#cb647-13" tabindex="-1"></a>  terminal<span class="op">-&gt;</span>ins_del_lines_hook <span class="op">=</span> <span class="op">&amp;</span>tty_ins_del_lines<span class="op">;</span></span>
<span id="cb647-14"><a aria-hidden="true" href="#cb647-14" tabindex="-1"></a></span>
<span id="cb647-15"><a aria-hidden="true" href="#cb647-15" tabindex="-1"></a>  terminal<span class="op">-&gt;</span>insert_glyphs_hook <span class="op">=</span> <span class="op">&amp;</span>tty_insert_glyphs<span class="op">;</span></span>
<span id="cb647-16"><a aria-hidden="true" href="#cb647-16" tabindex="-1"></a>  terminal<span class="op">-&gt;</span>write_glyphs_hook <span class="op">=</span> <span class="op">&amp;</span>tty_write_glyphs<span class="op">;</span></span>
<span id="cb647-17"><a aria-hidden="true" href="#cb647-17" tabindex="-1"></a>  terminal<span class="op">-&gt;</span>delete_glyphs_hook <span class="op">=</span> <span class="op">&amp;</span>tty_delete_glyphs<span class="op">;</span></span>
<span id="cb647-18"><a aria-hidden="true" href="#cb647-18" tabindex="-1"></a></span>
<span id="cb647-19"><a aria-hidden="true" href="#cb647-19" tabindex="-1"></a>  terminal<span class="op">-&gt;</span>ring_bell_hook <span class="op">=</span> <span class="op">&amp;</span>tty_ring_bell<span class="op">;</span></span>
<span id="cb647-20"><a aria-hidden="true" href="#cb647-20" tabindex="-1"></a></span>
<span id="cb647-21"><a aria-hidden="true" href="#cb647-21" tabindex="-1"></a>  terminal<span class="op">-&gt;</span>reset_terminal_modes_hook <span class="op">=</span> <span class="op">&amp;</span>tty_reset_terminal_modes<span class="op">;</span></span>
<span id="cb647-22"><a aria-hidden="true" href="#cb647-22" tabindex="-1"></a>  terminal<span class="op">-&gt;</span>set_terminal_modes_hook <span class="op">=</span> <span class="op">&amp;</span>tty_set_terminal_modes<span class="op">;</span></span>
<span id="cb647-23"><a aria-hidden="true" href="#cb647-23" tabindex="-1"></a>  terminal<span class="op">-&gt;</span>update_end_hook <span class="op">=</span> <span class="op">&amp;</span>tty_update_end<span class="op">;</span></span>
<span id="cb647-24"><a aria-hidden="true" href="#cb647-24" tabindex="-1"></a></span>
<span id="cb647-25"><a aria-hidden="true" href="#cb647-25" tabindex="-1"></a>  terminal<span class="op">-&gt;</span>read_socket_hook <span class="op">=</span> <span class="op">&amp;</span>tty_read_avail_input<span class="op">;</span></span>
<span id="cb647-26"><a aria-hidden="true" href="#cb647-26" tabindex="-1"></a></span>
<span id="cb647-27"><a aria-hidden="true" href="#cb647-27" tabindex="-1"></a>  terminal<span class="op">-&gt;</span>delete_frame_hook <span class="op">=</span> <span class="op">&amp;</span>tty_free_frame_resources<span class="op">;</span></span>
<span id="cb647-28"><a aria-hidden="true" href="#cb647-28" tabindex="-1"></a>  terminal<span class="op">-&gt;</span>delete_terminal_hook <span class="op">=</span> <span class="op">&amp;</span>delete_tty<span class="op">;</span></span>
<span id="cb647-29"><a aria-hidden="true" href="#cb647-29" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>Location:</strong> <code>/home/user/emacs/src/term.c</code>
(approximate)</p>
<hr/>
<h2 data-number="18.6" id="common-patterns-2"><span class="header-section-number">18.6</span> Common Patterns</h2>
<h3 data-number="18.6.1" id="event-handling-abstraction"><span class="header-section-number">18.6.1</span> 4.1 Event Handling
Abstraction</h3>
<p>All platforms must translate native events into Emacs
<code>struct input_event</code>:</p>
<div class="sourceCode" id="cb648"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb648-1"><a aria-hidden="true" href="#cb648-1" tabindex="-1"></a><span class="kw">struct</span> input_event</span>
<span id="cb648-2"><a aria-hidden="true" href="#cb648-2" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb648-3"><a aria-hidden="true" href="#cb648-3" tabindex="-1"></a>  <span class="co">/* What kind of event was this?  */</span></span>
<span id="cb648-4"><a aria-hidden="true" href="#cb648-4" tabindex="-1"></a>  ENUM_BF <span class="op">(</span>event_kind<span class="op">)</span> kind <span class="op">:</span> EVENT_KIND_WIDTH<span class="op">;</span></span>
<span id="cb648-5"><a aria-hidden="true" href="#cb648-5" tabindex="-1"></a></span>
<span id="cb648-6"><a aria-hidden="true" href="#cb648-6" tabindex="-1"></a>  <span class="co">/* Used in scroll bar click events.  */</span></span>
<span id="cb648-7"><a aria-hidden="true" href="#cb648-7" tabindex="-1"></a>  ENUM_BF <span class="op">(</span>scroll_bar_part<span class="op">)</span> part <span class="op">:</span> <span class="dv">16</span><span class="op">;</span></span>
<span id="cb648-8"><a aria-hidden="true" href="#cb648-8" tabindex="-1"></a></span>
<span id="cb648-9"><a aria-hidden="true" href="#cb648-9" tabindex="-1"></a>  <span class="co">/* For keystroke/mouse events, this is the character/button.  */</span></span>
<span id="cb648-10"><a aria-hidden="true" href="#cb648-10" tabindex="-1"></a>  <span class="dt">unsigned</span> code<span class="op">;</span></span>
<span id="cb648-11"><a aria-hidden="true" href="#cb648-11" tabindex="-1"></a></span>
<span id="cb648-12"><a aria-hidden="true" href="#cb648-12" tabindex="-1"></a>  <span class="co">/* Modifier keys (shift, control, meta, etc.). */</span></span>
<span id="cb648-13"><a aria-hidden="true" href="#cb648-13" tabindex="-1"></a>  <span class="dt">unsigned</span> modifiers<span class="op">;</span></span>
<span id="cb648-14"><a aria-hidden="true" href="#cb648-14" tabindex="-1"></a></span>
<span id="cb648-15"><a aria-hidden="true" href="#cb648-15" tabindex="-1"></a>  <span class="co">/* Position information. */</span></span>
<span id="cb648-16"><a aria-hidden="true" href="#cb648-16" tabindex="-1"></a>  Lisp_Object x<span class="op">,</span> y<span class="op">;</span></span>
<span id="cb648-17"><a aria-hidden="true" href="#cb648-17" tabindex="-1"></a></span>
<span id="cb648-18"><a aria-hidden="true" href="#cb648-18" tabindex="-1"></a>  <span class="co">/* Timestamp. */</span></span>
<span id="cb648-19"><a aria-hidden="true" href="#cb648-19" tabindex="-1"></a>  Time timestamp<span class="op">;</span></span>
<span id="cb648-20"><a aria-hidden="true" href="#cb648-20" tabindex="-1"></a></span>
<span id="cb648-21"><a aria-hidden="true" href="#cb648-21" tabindex="-1"></a>  <span class="co">/* Frame or window where event occurred. */</span></span>
<span id="cb648-22"><a aria-hidden="true" href="#cb648-22" tabindex="-1"></a>  Lisp_Object frame_or_window<span class="op">;</span></span>
<span id="cb648-23"><a aria-hidden="true" href="#cb648-23" tabindex="-1"></a></span>
<span id="cb648-24"><a aria-hidden="true" href="#cb648-24" tabindex="-1"></a>  <span class="co">/* Additional data (varies by event type). */</span></span>
<span id="cb648-25"><a aria-hidden="true" href="#cb648-25" tabindex="-1"></a>  Lisp_Object arg<span class="op">;</span></span>
<span id="cb648-26"><a aria-hidden="true" href="#cb648-26" tabindex="-1"></a></span>
<span id="cb648-27"><a aria-hidden="true" href="#cb648-27" tabindex="-1"></a>  <span class="co">/* Device that generated the event. */</span></span>
<span id="cb648-28"><a aria-hidden="true" href="#cb648-28" tabindex="-1"></a>  Lisp_Object device<span class="op">;</span></span>
<span id="cb648-29"><a aria-hidden="true" href="#cb648-29" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<p><strong>Location:</strong>
<code>/home/user/emacs/src/termhooks.h:367-408</code></p>
<h4 data-number="18.6.1.1" id="platform-specific-event-translation"><span class="header-section-number">18.6.1.1</span> Platform-Specific Event
Translation</h4>
<p><strong>X11 Example</strong> (from <code>XTread_socket</code> in
xterm.c):</p>
<div class="sourceCode" id="cb649"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb649-1"><a aria-hidden="true" href="#cb649-1" tabindex="-1"></a><span class="co">// KeyPress event</span></span>
<span id="cb649-2"><a aria-hidden="true" href="#cb649-2" tabindex="-1"></a><span class="cf">case</span> KeyPress<span class="op">:</span></span>
<span id="cb649-3"><a aria-hidden="true" href="#cb649-3" tabindex="-1"></a>  <span class="op">{</span></span>
<span id="cb649-4"><a aria-hidden="true" href="#cb649-4" tabindex="-1"></a>    KeySym keysym<span class="op">;</span></span>
<span id="cb649-5"><a aria-hidden="true" href="#cb649-5" tabindex="-1"></a>    XKeyEvent xkey <span class="op">=</span> event<span class="op">-&gt;</span>xkey<span class="op">;</span></span>
<span id="cb649-6"><a aria-hidden="true" href="#cb649-6" tabindex="-1"></a></span>
<span id="cb649-7"><a aria-hidden="true" href="#cb649-7" tabindex="-1"></a>    <span class="co">// Translate X11 keysym to Emacs character</span></span>
<span id="cb649-8"><a aria-hidden="true" href="#cb649-8" tabindex="-1"></a>    nbytes <span class="op">=</span> XLookupString <span class="op">(&amp;</span>xkey<span class="op">,</span> copy_bufptr<span class="op">,</span> copy_bufsiz<span class="op">,</span></span>
<span id="cb649-9"><a aria-hidden="true" href="#cb649-9" tabindex="-1"></a>                            <span class="op">&amp;</span>keysym<span class="op">,</span> <span class="op">&amp;</span>compose_status<span class="op">);</span></span>
<span id="cb649-10"><a aria-hidden="true" href="#cb649-10" tabindex="-1"></a></span>
<span id="cb649-11"><a aria-hidden="true" href="#cb649-11" tabindex="-1"></a>    <span class="co">// Filter through input method</span></span>
<span id="cb649-12"><a aria-hidden="true" href="#cb649-12" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>x_filter_event <span class="op">(</span>dpyinfo<span class="op">,</span> <span class="op">&amp;</span>event<span class="op">))</span></span>
<span id="cb649-13"><a aria-hidden="true" href="#cb649-13" tabindex="-1"></a>      <span class="cf">break</span><span class="op">;</span></span>
<span id="cb649-14"><a aria-hidden="true" href="#cb649-14" tabindex="-1"></a></span>
<span id="cb649-15"><a aria-hidden="true" href="#cb649-15" tabindex="-1"></a>    <span class="co">// Create input_event</span></span>
<span id="cb649-16"><a aria-hidden="true" href="#cb649-16" tabindex="-1"></a>    inev<span class="op">.</span>kind <span class="op">=</span> <span class="op">(</span>keysym <span class="op">&lt;</span> <span class="dv">256</span><span class="op">)</span> <span class="op">?</span> ASCII_KEYSTROKE_EVENT</span>
<span id="cb649-17"><a aria-hidden="true" href="#cb649-17" tabindex="-1"></a>                                <span class="op">:</span> NON_ASCII_KEYSTROKE_EVENT<span class="op">;</span></span>
<span id="cb649-18"><a aria-hidden="true" href="#cb649-18" tabindex="-1"></a>    inev<span class="op">.</span>code <span class="op">=</span> keysym<span class="op">;</span></span>
<span id="cb649-19"><a aria-hidden="true" href="#cb649-19" tabindex="-1"></a>    inev<span class="op">.</span>modifiers <span class="op">=</span> x_x_to_emacs_modifiers <span class="op">(</span>dpyinfo<span class="op">,</span> xkey<span class="op">.</span>state<span class="op">);</span></span>
<span id="cb649-20"><a aria-hidden="true" href="#cb649-20" tabindex="-1"></a>    XSETFRAME <span class="op">(</span>inev<span class="op">.</span>frame_or_window<span class="op">,</span> f<span class="op">);</span></span>
<span id="cb649-21"><a aria-hidden="true" href="#cb649-21" tabindex="-1"></a>    inev<span class="op">.</span>timestamp <span class="op">=</span> xkey<span class="op">.</span>time<span class="op">;</span></span>
<span id="cb649-22"><a aria-hidden="true" href="#cb649-22" tabindex="-1"></a>  <span class="op">}</span></span></code></pre></div>
<p><strong>Windows Example</strong> (from <code>w32_read_socket</code>
in w32term.c):</p>
<div class="sourceCode" id="cb650"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb650-1"><a aria-hidden="true" href="#cb650-1" tabindex="-1"></a><span class="co">// WM_CHAR message</span></span>
<span id="cb650-2"><a aria-hidden="true" href="#cb650-2" tabindex="-1"></a><span class="cf">case</span> WM_CHAR<span class="op">:</span></span>
<span id="cb650-3"><a aria-hidden="true" href="#cb650-3" tabindex="-1"></a>  <span class="op">{</span></span>
<span id="cb650-4"><a aria-hidden="true" href="#cb650-4" tabindex="-1"></a>    <span class="co">// Windows sends character directly</span></span>
<span id="cb650-5"><a aria-hidden="true" href="#cb650-5" tabindex="-1"></a>    inev<span class="op">.</span>kind <span class="op">=</span> ASCII_KEYSTROKE_EVENT<span class="op">;</span></span>
<span id="cb650-6"><a aria-hidden="true" href="#cb650-6" tabindex="-1"></a>    inev<span class="op">.</span>code <span class="op">=</span> wParam<span class="op">;</span>  <span class="co">// Already a character code</span></span>
<span id="cb650-7"><a aria-hidden="true" href="#cb650-7" tabindex="-1"></a>    inev<span class="op">.</span>modifiers <span class="op">=</span> w32_get_modifiers <span class="op">();</span></span>
<span id="cb650-8"><a aria-hidden="true" href="#cb650-8" tabindex="-1"></a>    XSETFRAME <span class="op">(</span>inev<span class="op">.</span>frame_or_window<span class="op">,</span> f<span class="op">);</span></span>
<span id="cb650-9"><a aria-hidden="true" href="#cb650-9" tabindex="-1"></a>    inev<span class="op">.</span>timestamp <span class="op">=</span> msg<span class="op">.</span>time<span class="op">;</span></span>
<span id="cb650-10"><a aria-hidden="true" href="#cb650-10" tabindex="-1"></a>  <span class="op">}</span></span></code></pre></div>
<h3 data-number="18.6.2" id="font-backend-system"><span class="header-section-number">18.6.2</span> 4.2 Font Backend System</h3>
<p>Emacs uses a driver-based font system:</p>
<div class="sourceCode" id="cb651"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb651-1"><a aria-hidden="true" href="#cb651-1" tabindex="-1"></a><span class="kw">struct</span> font_driver</span>
<span id="cb651-2"><a aria-hidden="true" href="#cb651-2" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb651-3"><a aria-hidden="true" href="#cb651-3" tabindex="-1"></a>  <span class="co">/* Symbol indicating the type of the font-driver.  */</span></span>
<span id="cb651-4"><a aria-hidden="true" href="#cb651-4" tabindex="-1"></a>  Lisp_Object type<span class="op">;</span></span>
<span id="cb651-5"><a aria-hidden="true" href="#cb651-5" tabindex="-1"></a></span>
<span id="cb651-6"><a aria-hidden="true" href="#cb651-6" tabindex="-1"></a>  <span class="co">/* True if font names are case sensitive.  */</span></span>
<span id="cb651-7"><a aria-hidden="true" href="#cb651-7" tabindex="-1"></a>  <span class="dt">bool</span> case_sensitive<span class="op">;</span></span>
<span id="cb651-8"><a aria-hidden="true" href="#cb651-8" tabindex="-1"></a></span>
<span id="cb651-9"><a aria-hidden="true" href="#cb651-9" tabindex="-1"></a>  <span class="co">/* Return a cache of font-entities on frame F.  */</span></span>
<span id="cb651-10"><a aria-hidden="true" href="#cb651-10" tabindex="-1"></a>  Lisp_Object <span class="op">(*</span>get_cache<span class="op">)</span> <span class="op">(</span><span class="kw">struct</span> frame <span class="op">*</span>f<span class="op">);</span></span>
<span id="cb651-11"><a aria-hidden="true" href="#cb651-11" tabindex="-1"></a></span>
<span id="cb651-12"><a aria-hidden="true" href="#cb651-12" tabindex="-1"></a>  <span class="co">/* List fonts matching FONT_SPEC on FRAME.  */</span></span>
<span id="cb651-13"><a aria-hidden="true" href="#cb651-13" tabindex="-1"></a>  Lisp_Object <span class="op">(*</span>list<span class="op">)</span> <span class="op">(</span><span class="kw">struct</span> frame <span class="op">*</span>frame<span class="op">,</span> Lisp_Object font_spec<span class="op">);</span></span>
<span id="cb651-14"><a aria-hidden="true" href="#cb651-14" tabindex="-1"></a></span>
<span id="cb651-15"><a aria-hidden="true" href="#cb651-15" tabindex="-1"></a>  <span class="co">/* Find best matching font.  */</span></span>
<span id="cb651-16"><a aria-hidden="true" href="#cb651-16" tabindex="-1"></a>  Lisp_Object <span class="op">(*</span>match<span class="op">)</span> <span class="op">(</span><span class="kw">struct</span> frame <span class="op">*</span>f<span class="op">,</span> Lisp_Object font_spec<span class="op">);</span></span>
<span id="cb651-17"><a aria-hidden="true" href="#cb651-17" tabindex="-1"></a></span>
<span id="cb651-18"><a aria-hidden="true" href="#cb651-18" tabindex="-1"></a>  <span class="co">/* Optional: List available families.  */</span></span>
<span id="cb651-19"><a aria-hidden="true" href="#cb651-19" tabindex="-1"></a>  Lisp_Object <span class="op">(*</span>list_family<span class="op">)</span> <span class="op">(</span><span class="kw">struct</span> frame <span class="op">*</span>f<span class="op">);</span></span>
<span id="cb651-20"><a aria-hidden="true" href="#cb651-20" tabindex="-1"></a></span>
<span id="cb651-21"><a aria-hidden="true" href="#cb651-21" tabindex="-1"></a>  <span class="co">/* Open a font specified by FONT_ENTITY.  */</span></span>
<span id="cb651-22"><a aria-hidden="true" href="#cb651-22" tabindex="-1"></a>  Lisp_Object <span class="op">(*</span>open_font<span class="op">)</span> <span class="op">(</span><span class="kw">struct</span> frame <span class="op">*</span>f<span class="op">,</span> Lisp_Object font_entity<span class="op">,</span></span>
<span id="cb651-23"><a aria-hidden="true" href="#cb651-23" tabindex="-1"></a>                            <span class="dt">int</span> pixel_size<span class="op">);</span></span>
<span id="cb651-24"><a aria-hidden="true" href="#cb651-24" tabindex="-1"></a></span>
<span id="cb651-25"><a aria-hidden="true" href="#cb651-25" tabindex="-1"></a>  <span class="co">/* Close FONT.  */</span></span>
<span id="cb651-26"><a aria-hidden="true" href="#cb651-26" tabindex="-1"></a>  <span class="dt">void</span> <span class="op">(*</span>close_font<span class="op">)</span> <span class="op">(</span><span class="kw">struct</span> font <span class="op">*</span>font<span class="op">);</span></span>
<span id="cb651-27"><a aria-hidden="true" href="#cb651-27" tabindex="-1"></a></span>
<span id="cb651-28"><a aria-hidden="true" href="#cb651-28" tabindex="-1"></a>  <span class="co">/* Check if FONT has a glyph for character C.  */</span></span>
<span id="cb651-29"><a aria-hidden="true" href="#cb651-29" tabindex="-1"></a>  <span class="dt">int</span> <span class="op">(*</span>has_char<span class="op">)</span> <span class="op">(</span>Lisp_Object font<span class="op">,</span> <span class="dt">int</span> c<span class="op">);</span></span>
<span id="cb651-30"><a aria-hidden="true" href="#cb651-30" tabindex="-1"></a></span>
<span id="cb651-31"><a aria-hidden="true" href="#cb651-31" tabindex="-1"></a>  <span class="co">/* Return a glyph code of FONT for character C.  */</span></span>
<span id="cb651-32"><a aria-hidden="true" href="#cb651-32" tabindex="-1"></a>  <span class="dt">unsigned</span> <span class="op">(*</span>encode_char<span class="op">)</span> <span class="op">(</span><span class="kw">struct</span> font <span class="op">*</span>font<span class="op">,</span> <span class="dt">int</span> c<span class="op">);</span></span>
<span id="cb651-33"><a aria-hidden="true" href="#cb651-33" tabindex="-1"></a></span>
<span id="cb651-34"><a aria-hidden="true" href="#cb651-34" tabindex="-1"></a>  <span class="co">/* Compute metrics for glyphs.  */</span></span>
<span id="cb651-35"><a aria-hidden="true" href="#cb651-35" tabindex="-1"></a>  <span class="dt">void</span> <span class="op">(*</span>text_extents<span class="op">)</span> <span class="op">(</span><span class="kw">struct</span> font <span class="op">*</span>font<span class="op">,</span></span>
<span id="cb651-36"><a aria-hidden="true" href="#cb651-36" tabindex="-1"></a>                        <span class="dt">const</span> <span class="dt">unsigned</span> <span class="op">*</span>code<span class="op">,</span> <span class="dt">int</span> nglyphs<span class="op">,</span></span>
<span id="cb651-37"><a aria-hidden="true" href="#cb651-37" tabindex="-1"></a>                        <span class="kw">struct</span> font_metrics <span class="op">*</span>metrics<span class="op">);</span></span>
<span id="cb651-38"><a aria-hidden="true" href="#cb651-38" tabindex="-1"></a></span>
<span id="cb651-39"><a aria-hidden="true" href="#cb651-39" tabindex="-1"></a>  <span class="co">/* Draw glyphs.  */</span></span>
<span id="cb651-40"><a aria-hidden="true" href="#cb651-40" tabindex="-1"></a>  <span class="dt">int</span> <span class="op">(*</span>draw<span class="op">)</span> <span class="op">(</span><span class="kw">struct</span> glyph_string <span class="op">*</span>s<span class="op">,</span> <span class="dt">int</span> from<span class="op">,</span> <span class="dt">int</span> to<span class="op">,</span></span>
<span id="cb651-41"><a aria-hidden="true" href="#cb651-41" tabindex="-1"></a>               <span class="dt">int</span> x<span class="op">,</span> <span class="dt">int</span> y<span class="op">,</span> <span class="dt">bool</span> with_background<span class="op">);</span></span>
<span id="cb651-42"><a aria-hidden="true" href="#cb651-42" tabindex="-1"></a></span>
<span id="cb651-43"><a aria-hidden="true" href="#cb651-43" tabindex="-1"></a>  <span class="co">/* ... many more methods ... */</span></span>
<span id="cb651-44"><a aria-hidden="true" href="#cb651-44" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<p><strong>Location:</strong>
<code>/home/user/emacs/src/font.h:589-750</code></p>
<h4 data-number="18.6.2.1" id="platform-font-drivers"><span class="header-section-number">18.6.2.1</span> Platform Font Drivers</h4>
<p>Each platform provides one or more font drivers:</p>
<table>
<colgroup>
<col style="width: 23%"/>
<col style="width: 32%"/>
<col style="width: 44%"/>
</colgroup>
<thead>
<tr>
<th>Platform</th>
<th>Font Drivers</th>
<th>Backend Technology</th>
</tr>
</thead>
<tbody>
<tr>
<td>X11</td>
<td><code>xfont</code>, <code>xft</code></td>
<td>Core X fonts, Xft (FreeType + FontConfig)</td>
</tr>
<tr>
<td>Windows</td>
<td><code>w32font</code>, <code>w32uniscribe</code>,
<code>w32dwrite</code></td>
<td>GDI, Uniscribe, DirectWrite</td>
</tr>
<tr>
<td>macOS/NS</td>
<td><code>ns</code></td>
<td>Cocoa/AppKit NSFont</td>
</tr>
<tr>
<td>Android</td>
<td><code>androidfont</code>, <code>sfnt</code></td>
<td>Android Typeface, SFNT parser</td>
</tr>
<tr>
<td>Haiku</td>
<td><code>haikufont</code></td>
<td>Haiku BFont</td>
</tr>
<tr>
<td>GTK/PGTK</td>
<td><code>ftcr</code>, <code>xft</code></td>
<td>FreeType+Cairo, Xft</td>
</tr>
<tr>
<td>TTY</td>
<td>N/A</td>
<td>Terminal character capabilities</td>
</tr>
</tbody>
</table>
<p><strong>HarfBuzz Integration</strong>: Modern Emacs can use HarfBuzz
for complex text shaping across all platforms via the
<code>hbfont</code> driver.</p>
<h3 data-number="18.6.3" id="image-support"><span class="header-section-number">18.6.3</span> 4.3 Image Support</h3>
<p>Image loading and display is abstracted through image types:</p>
<div class="sourceCode" id="cb652"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb652-1"><a aria-hidden="true" href="#cb652-1" tabindex="-1"></a><span class="kw">struct</span> image</span>
<span id="cb652-2"><a aria-hidden="true" href="#cb652-2" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb652-3"><a aria-hidden="true" href="#cb652-3" tabindex="-1"></a>  <span class="co">/* Time when image was last displayed.  */</span></span>
<span id="cb652-4"><a aria-hidden="true" href="#cb652-4" tabindex="-1"></a>  <span class="kw">struct</span> timespec timestamp<span class="op">;</span></span>
<span id="cb652-5"><a aria-hidden="true" href="#cb652-5" tabindex="-1"></a></span>
<span id="cb652-6"><a aria-hidden="true" href="#cb652-6" tabindex="-1"></a>  <span class="co">/* Pixmaps of the image.  */</span></span>
<span id="cb652-7"><a aria-hidden="true" href="#cb652-7" tabindex="-1"></a>  Emacs_Pixmap pixmap<span class="op">,</span> mask<span class="op">;</span></span>
<span id="cb652-8"><a aria-hidden="true" href="#cb652-8" tabindex="-1"></a></span>
<span id="cb652-9"><a aria-hidden="true" href="#cb652-9" tabindex="-1"></a><span class="pp">#ifdef USE_CAIRO</span></span>
<span id="cb652-10"><a aria-hidden="true" href="#cb652-10" tabindex="-1"></a>  <span class="dt">void</span> <span class="op">*</span>cr_data<span class="op">;</span>                    <span class="co">// Cairo surface</span></span>
<span id="cb652-11"><a aria-hidden="true" href="#cb652-11" tabindex="-1"></a><span class="pp">#endif</span></span>
<span id="cb652-12"><a aria-hidden="true" href="#cb652-12" tabindex="-1"></a></span>
<span id="cb652-13"><a aria-hidden="true" href="#cb652-13" tabindex="-1"></a><span class="pp">#ifdef HAVE_X_WINDOWS</span></span>
<span id="cb652-14"><a aria-hidden="true" href="#cb652-14" tabindex="-1"></a>  XImage <span class="op">*</span>ximg<span class="op">,</span> <span class="op">*</span>mask_img<span class="op">;</span>          <span class="co">// X11 images</span></span>
<span id="cb652-15"><a aria-hidden="true" href="#cb652-15" tabindex="-1"></a><span class="pp">#endif</span></span>
<span id="cb652-16"><a aria-hidden="true" href="#cb652-16" tabindex="-1"></a></span>
<span id="cb652-17"><a aria-hidden="true" href="#cb652-17" tabindex="-1"></a><span class="pp">#ifdef HAVE_ANDROID</span></span>
<span id="cb652-18"><a aria-hidden="true" href="#cb652-18" tabindex="-1"></a>  <span class="kw">struct</span> android_image <span class="op">*</span>ximg<span class="op">,</span> <span class="op">*</span>mask_img<span class="op">;</span>  <span class="co">// Android bitmap</span></span>
<span id="cb652-19"><a aria-hidden="true" href="#cb652-19" tabindex="-1"></a><span class="pp">#endif</span></span>
<span id="cb652-20"><a aria-hidden="true" href="#cb652-20" tabindex="-1"></a></span>
<span id="cb652-21"><a aria-hidden="true" href="#cb652-21" tabindex="-1"></a><span class="pp">#ifdef HAVE_NTGUI</span></span>
<span id="cb652-22"><a aria-hidden="true" href="#cb652-22" tabindex="-1"></a>  XFORM xform<span class="op">;</span>                      <span class="co">// Transformation matrix</span></span>
<span id="cb652-23"><a aria-hidden="true" href="#cb652-23" tabindex="-1"></a>  <span class="dt">bool</span> smoothing<span class="op">;</span>                   <span class="co">// Bilinear filtering</span></span>
<span id="cb652-24"><a aria-hidden="true" href="#cb652-24" tabindex="-1"></a><span class="pp">#endif</span></span>
<span id="cb652-25"><a aria-hidden="true" href="#cb652-25" tabindex="-1"></a></span>
<span id="cb652-26"><a aria-hidden="true" href="#cb652-26" tabindex="-1"></a><span class="pp">#ifdef HAVE_HAIKU</span></span>
<span id="cb652-27"><a aria-hidden="true" href="#cb652-27" tabindex="-1"></a>  <span class="dt">double</span> transform<span class="op">[</span><span class="dv">3</span><span class="op">][</span><span class="dv">3</span><span class="op">];</span>           <span class="co">// Affine transformation</span></span>
<span id="cb652-28"><a aria-hidden="true" href="#cb652-28" tabindex="-1"></a>  <span class="dt">bool</span> use_bilinear_filtering<span class="op">;</span></span>
<span id="cb652-29"><a aria-hidden="true" href="#cb652-29" tabindex="-1"></a><span class="pp">#endif</span></span>
<span id="cb652-30"><a aria-hidden="true" href="#cb652-30" tabindex="-1"></a></span>
<span id="cb652-31"><a aria-hidden="true" href="#cb652-31" tabindex="-1"></a>  <span class="co">/* Colors allocated for this image.  */</span></span>
<span id="cb652-32"><a aria-hidden="true" href="#cb652-32" tabindex="-1"></a>  <span class="dt">unsigned</span> <span class="dt">long</span> <span class="op">*</span>colors<span class="op">;</span></span>
<span id="cb652-33"><a aria-hidden="true" href="#cb652-33" tabindex="-1"></a>  <span class="dt">int</span> ncolors<span class="op">;</span></span>
<span id="cb652-34"><a aria-hidden="true" href="#cb652-34" tabindex="-1"></a></span>
<span id="cb652-35"><a aria-hidden="true" href="#cb652-35" tabindex="-1"></a>  <span class="co">/* Image ID (for caching).  */</span></span>
<span id="cb652-36"><a aria-hidden="true" href="#cb652-36" tabindex="-1"></a>  <span class="dt">ptrdiff_t</span> id<span class="op">;</span></span>
<span id="cb652-37"><a aria-hidden="true" href="#cb652-37" tabindex="-1"></a></span>
<span id="cb652-38"><a aria-hidden="true" href="#cb652-38" tabindex="-1"></a>  <span class="co">/* ... many more fields ... */</span></span>
<span id="cb652-39"><a aria-hidden="true" href="#cb652-39" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<p><strong>Location:</strong>
<code>/home/user/emacs/src/dispextern.h:3172-3224</code></p>
<p><strong>Common Image Operations:</strong> 1.
<strong>Loading</strong>: Platform-specific loaders (XBM, PNG, JPEG,
SVG, etc.) 2. <strong>Caching</strong>: Images cached by ID to avoid
reloading 3. <strong>Scaling</strong>: Platform-specific scaling (some
use hardware acceleration) 4. <strong>Compositing</strong>: Blending
images with backgrounds</p>
<h3 data-number="18.6.4" id="clipboardselection-handling"><span class="header-section-number">18.6.4</span> 4.4 Clipboard/Selection
Handling</h3>
<p>Each platform implements selection (clipboard) differently:</p>
<table>
<thead>
<tr>
<th>Platform</th>
<th>Files</th>
<th>Mechanism</th>
</tr>
</thead>
<tbody>
<tr>
<td>X11</td>
<td><code>xselect.c</code></td>
<td>X selections (PRIMARY, CLIPBOARD, SECONDARY)</td>
</tr>
<tr>
<td>Windows</td>
<td><code>w32select.c</code></td>
<td>Windows Clipboard API</td>
</tr>
<tr>
<td>macOS/NS</td>
<td><code>nsselect.m</code></td>
<td>NSPasteboard</td>
</tr>
<tr>
<td>Android</td>
<td><code>androidselect.c</code></td>
<td>Android ClipboardManager</td>
</tr>
<tr>
<td>Haiku</td>
<td><code>haikuselect.c</code></td>
<td>Haiku clipboard</td>
</tr>
<tr>
<td>GTK/PGTK</td>
<td><code>pgtkselect.c</code></td>
<td>GTK clipboard</td>
</tr>
<tr>
<td>DOS</td>
<td><code>w16select.c</code></td>
<td>DOS clipboard</td>
</tr>
<tr>
<td>TTY</td>
<td>N/A</td>
<td>Limited or no clipboard support</td>
</tr>
</tbody>
</table>
<p><strong>Common Pattern:</strong></p>
<div class="sourceCode" id="cb653"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb653-1"><a aria-hidden="true" href="#cb653-1" tabindex="-1"></a><span class="co">// Set clipboard contents</span></span>
<span id="cb653-2"><a aria-hidden="true" href="#cb653-2" tabindex="-1"></a>DEFUN <span class="op">(</span><span class="st">"x-set-selection"</span><span class="op">,</span> Fx_set_selection<span class="op">,</span> <span class="op">...)</span></span>
<span id="cb653-3"><a aria-hidden="true" href="#cb653-3" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb653-4"><a aria-hidden="true" href="#cb653-4" tabindex="-1"></a>  <span class="co">// Platform-specific implementation</span></span>
<span id="cb653-5"><a aria-hidden="true" href="#cb653-5" tabindex="-1"></a>  <span class="co">// Stores DATA in SELECTION (e.g., CLIPBOARD)</span></span>
<span id="cb653-6"><a aria-hidden="true" href="#cb653-6" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb653-7"><a aria-hidden="true" href="#cb653-7" tabindex="-1"></a></span>
<span id="cb653-8"><a aria-hidden="true" href="#cb653-8" tabindex="-1"></a><span class="co">// Get clipboard contents</span></span>
<span id="cb653-9"><a aria-hidden="true" href="#cb653-9" tabindex="-1"></a>DEFUN <span class="op">(</span><span class="st">"x-get-selection"</span><span class="op">,</span> Fx_get_selection<span class="op">,</span> <span class="op">...)</span></span>
<span id="cb653-10"><a aria-hidden="true" href="#cb653-10" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb653-11"><a aria-hidden="true" href="#cb653-11" tabindex="-1"></a>  <span class="co">// Platform-specific implementation</span></span>
<span id="cb653-12"><a aria-hidden="true" href="#cb653-12" tabindex="-1"></a>  <span class="co">// Retrieves data from SELECTION</span></span>
<span id="cb653-13"><a aria-hidden="true" href="#cb653-13" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 data-number="18.6.5" id="menu-systems"><span class="header-section-number">18.6.5</span> 4.5 Menu Systems</h3>
<p>Menu implementation varies significantly:</p>
<p><strong>X11:</strong> - Toolkit menus (Motif, Athena, GTK, or Lucid
widget library) - Pop-up menus via <code>x_menu_show</code></p>
<p><strong>Windows:</strong> - Native Windows menus - Owner-drawn for
custom styling</p>
<p><strong>macOS:</strong> - Native Cocoa NSMenu</p>
<p><strong>Android:</strong> - Android menu system (options menu,
context menu)</p>
<p><strong>Haiku:</strong> - BMenu from Haiku Interface Kit</p>
<p><strong>TTY:</strong> - Text-based menu using <code>tmm.el</code>
(Text Mode Menu)</p>
<hr/>
<h2 data-number="18.7" id="case-study-x11-implementation"><span class="header-section-number">18.7</span> Case Study: X11
Implementation</h2>
<h3 data-number="18.7.1" id="architecture-overview-2"><span class="header-section-number">18.7.1</span> 5.1 Architecture
Overview</h3>
<p>The X11 port is the reference implementation for GUI platforms. Let‚Äôs
trace how text rendering works from start to finish.</p>
<h3 data-number="18.7.2" id="text-rendering-pipeline"><span class="header-section-number">18.7.2</span> 5.2 Text Rendering
Pipeline</h3>
<h4 data-number="18.7.2.1" id="step-1-redisplay-engine-calls-hook"><span class="header-section-number">18.7.2.1</span> Step 1: Redisplay Engine
Calls Hook</h4>
<p>From <code>xdisp.c</code> (the generic display engine):</p>
<div class="sourceCode" id="cb654"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb654-1"><a aria-hidden="true" href="#cb654-1" tabindex="-1"></a><span class="dt">void</span></span>
<span id="cb654-2"><a aria-hidden="true" href="#cb654-2" tabindex="-1"></a>draw_glyphs <span class="op">(</span><span class="kw">struct</span> window <span class="op">*</span>w<span class="op">,</span> <span class="kw">struct</span> glyph_row <span class="op">*</span>row<span class="op">,</span> <span class="op">...)</span></span>
<span id="cb654-3"><a aria-hidden="true" href="#cb654-3" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb654-4"><a aria-hidden="true" href="#cb654-4" tabindex="-1"></a>  <span class="co">// ... compute what needs to be drawn ...</span></span>
<span id="cb654-5"><a aria-hidden="true" href="#cb654-5" tabindex="-1"></a></span>
<span id="cb654-6"><a aria-hidden="true" href="#cb654-6" tabindex="-1"></a>  <span class="co">// Build glyph strings (groups of glyphs with same face)</span></span>
<span id="cb654-7"><a aria-hidden="true" href="#cb654-7" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(...)</span></span>
<span id="cb654-8"><a aria-hidden="true" href="#cb654-8" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb654-9"><a aria-hidden="true" href="#cb654-9" tabindex="-1"></a>      <span class="kw">struct</span> glyph_string <span class="op">*</span>s <span class="op">=</span> build_glyph_string <span class="op">(...);</span></span>
<span id="cb654-10"><a aria-hidden="true" href="#cb654-10" tabindex="-1"></a></span>
<span id="cb654-11"><a aria-hidden="true" href="#cb654-11" tabindex="-1"></a>      <span class="co">// Call platform-specific drawing</span></span>
<span id="cb654-12"><a aria-hidden="true" href="#cb654-12" tabindex="-1"></a>      FRAME_RIF <span class="op">(</span>f<span class="op">)-&gt;</span>draw_glyph_string <span class="op">(</span>s<span class="op">);</span></span>
<span id="cb654-13"><a aria-hidden="true" href="#cb654-13" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb654-14"><a aria-hidden="true" href="#cb654-14" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>This expands to:
<code>x_redisplay_interface.draw_glyph_string (s)</code></p>
<h4 data-number="18.7.2.2" id="step-2-x11-glyph-string-drawing"><span class="header-section-number">18.7.2.2</span> Step 2: X11 Glyph String
Drawing</h4>
<div class="sourceCode" id="cb655"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb655-1"><a aria-hidden="true" href="#cb655-1" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span></span>
<span id="cb655-2"><a aria-hidden="true" href="#cb655-2" tabindex="-1"></a>x_draw_glyph_string <span class="op">(</span><span class="kw">struct</span> glyph_string <span class="op">*</span>s<span class="op">)</span></span>
<span id="cb655-3"><a aria-hidden="true" href="#cb655-3" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb655-4"><a aria-hidden="true" href="#cb655-4" tabindex="-1"></a>  <span class="dt">bool</span> relief_drawn_p <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb655-5"><a aria-hidden="true" href="#cb655-5" tabindex="-1"></a></span>
<span id="cb655-6"><a aria-hidden="true" href="#cb655-6" tabindex="-1"></a>  <span class="co">/* Prepare GC (Graphics Context). */</span></span>
<span id="cb655-7"><a aria-hidden="true" href="#cb655-7" tabindex="-1"></a>  x_set_glyph_string_gc <span class="op">(</span>s<span class="op">);</span></span>
<span id="cb655-8"><a aria-hidden="true" href="#cb655-8" tabindex="-1"></a></span>
<span id="cb655-9"><a aria-hidden="true" href="#cb655-9" tabindex="-1"></a>  <span class="co">/* Draw background if necessary. */</span></span>
<span id="cb655-10"><a aria-hidden="true" href="#cb655-10" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>s<span class="op">-&gt;</span>background_filled_p<span class="op">)</span></span>
<span id="cb655-11"><a aria-hidden="true" href="#cb655-11" tabindex="-1"></a>    <span class="co">/* Background already filled */</span><span class="op">;</span></span>
<span id="cb655-12"><a aria-hidden="true" href="#cb655-12" tabindex="-1"></a>  <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>s<span class="op">-&gt;</span>first_glyph<span class="op">-&gt;</span>type <span class="op">==</span> IMAGE_GLYPH<span class="op">)</span></span>
<span id="cb655-13"><a aria-hidden="true" href="#cb655-13" tabindex="-1"></a>    x_draw_glyph_string_background <span class="op">(</span>s<span class="op">,</span> <span class="kw">true</span><span class="op">);</span></span>
<span id="cb655-14"><a aria-hidden="true" href="#cb655-14" tabindex="-1"></a>  <span class="cf">else</span></span>
<span id="cb655-15"><a aria-hidden="true" href="#cb655-15" tabindex="-1"></a>    x_draw_glyph_string_background <span class="op">(</span>s<span class="op">,</span> <span class="kw">false</span><span class="op">);</span></span>
<span id="cb655-16"><a aria-hidden="true" href="#cb655-16" tabindex="-1"></a></span>
<span id="cb655-17"><a aria-hidden="true" href="#cb655-17" tabindex="-1"></a>  <span class="co">/* Draw foreground. */</span></span>
<span id="cb655-18"><a aria-hidden="true" href="#cb655-18" tabindex="-1"></a>  <span class="cf">switch</span> <span class="op">(</span>s<span class="op">-&gt;</span>first_glyph<span class="op">-&gt;</span>type<span class="op">)</span></span>
<span id="cb655-19"><a aria-hidden="true" href="#cb655-19" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb655-20"><a aria-hidden="true" href="#cb655-20" tabindex="-1"></a>    <span class="cf">case</span> CHAR_GLYPH<span class="op">:</span></span>
<span id="cb655-21"><a aria-hidden="true" href="#cb655-21" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span>s<span class="op">-&gt;</span>for_overlaps<span class="op">)</span></span>
<span id="cb655-22"><a aria-hidden="true" href="#cb655-22" tabindex="-1"></a>        s<span class="op">-&gt;</span>background_filled_p <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb655-23"><a aria-hidden="true" href="#cb655-23" tabindex="-1"></a>      <span class="cf">else</span></span>
<span id="cb655-24"><a aria-hidden="true" href="#cb655-24" tabindex="-1"></a>        x_draw_glyph_string_background <span class="op">(</span>s<span class="op">,</span> <span class="kw">false</span><span class="op">);</span></span>
<span id="cb655-25"><a aria-hidden="true" href="#cb655-25" tabindex="-1"></a>      x_draw_glyph_string_foreground <span class="op">(</span>s<span class="op">);</span></span>
<span id="cb655-26"><a aria-hidden="true" href="#cb655-26" tabindex="-1"></a>      <span class="cf">break</span><span class="op">;</span></span>
<span id="cb655-27"><a aria-hidden="true" href="#cb655-27" tabindex="-1"></a></span>
<span id="cb655-28"><a aria-hidden="true" href="#cb655-28" tabindex="-1"></a>    <span class="cf">case</span> COMPOSITE_GLYPH<span class="op">:</span></span>
<span id="cb655-29"><a aria-hidden="true" href="#cb655-29" tabindex="-1"></a>      x_draw_composite_glyph_string_foreground <span class="op">(</span>s<span class="op">);</span></span>
<span id="cb655-30"><a aria-hidden="true" href="#cb655-30" tabindex="-1"></a>      <span class="cf">break</span><span class="op">;</span></span>
<span id="cb655-31"><a aria-hidden="true" href="#cb655-31" tabindex="-1"></a></span>
<span id="cb655-32"><a aria-hidden="true" href="#cb655-32" tabindex="-1"></a>    <span class="cf">case</span> STRETCH_GLYPH<span class="op">:</span></span>
<span id="cb655-33"><a aria-hidden="true" href="#cb655-33" tabindex="-1"></a>      x_draw_stretch_glyph_string <span class="op">(</span>s<span class="op">);</span></span>
<span id="cb655-34"><a aria-hidden="true" href="#cb655-34" tabindex="-1"></a>      <span class="cf">break</span><span class="op">;</span></span>
<span id="cb655-35"><a aria-hidden="true" href="#cb655-35" tabindex="-1"></a></span>
<span id="cb655-36"><a aria-hidden="true" href="#cb655-36" tabindex="-1"></a>    <span class="cf">case</span> IMAGE_GLYPH<span class="op">:</span></span>
<span id="cb655-37"><a aria-hidden="true" href="#cb655-37" tabindex="-1"></a>      x_draw_image_glyph_string <span class="op">(</span>s<span class="op">);</span></span>
<span id="cb655-38"><a aria-hidden="true" href="#cb655-38" tabindex="-1"></a>      <span class="cf">break</span><span class="op">;</span></span>
<span id="cb655-39"><a aria-hidden="true" href="#cb655-39" tabindex="-1"></a></span>
<span id="cb655-40"><a aria-hidden="true" href="#cb655-40" tabindex="-1"></a>    <span class="cf">case</span> XWIDGET_GLYPH<span class="op">:</span></span>
<span id="cb655-41"><a aria-hidden="true" href="#cb655-41" tabindex="-1"></a>      x_draw_xwidget_glyph_string <span class="op">(</span>s<span class="op">);</span></span>
<span id="cb655-42"><a aria-hidden="true" href="#cb655-42" tabindex="-1"></a>      <span class="cf">break</span><span class="op">;</span></span>
<span id="cb655-43"><a aria-hidden="true" href="#cb655-43" tabindex="-1"></a></span>
<span id="cb655-44"><a aria-hidden="true" href="#cb655-44" tabindex="-1"></a>    <span class="cf">case</span> GLYPHLESS_GLYPH<span class="op">:</span></span>
<span id="cb655-45"><a aria-hidden="true" href="#cb655-45" tabindex="-1"></a>      x_draw_glyphless_glyph_string_foreground <span class="op">(</span>s<span class="op">);</span></span>
<span id="cb655-46"><a aria-hidden="true" href="#cb655-46" tabindex="-1"></a>      <span class="cf">break</span><span class="op">;</span></span>
<span id="cb655-47"><a aria-hidden="true" href="#cb655-47" tabindex="-1"></a></span>
<span id="cb655-48"><a aria-hidden="true" href="#cb655-48" tabindex="-1"></a>    <span class="cf">default</span><span class="op">:</span></span>
<span id="cb655-49"><a aria-hidden="true" href="#cb655-49" tabindex="-1"></a>      emacs_abort <span class="op">();</span></span>
<span id="cb655-50"><a aria-hidden="true" href="#cb655-50" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb655-51"><a aria-hidden="true" href="#cb655-51" tabindex="-1"></a></span>
<span id="cb655-52"><a aria-hidden="true" href="#cb655-52" tabindex="-1"></a>  <span class="co">/* Draw underline, overline, strike-through. */</span></span>
<span id="cb655-53"><a aria-hidden="true" href="#cb655-53" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(!</span>s<span class="op">-&gt;</span>for_overlaps<span class="op">)</span></span>
<span id="cb655-54"><a aria-hidden="true" href="#cb655-54" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb655-55"><a aria-hidden="true" href="#cb655-55" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span>s<span class="op">-&gt;</span>face<span class="op">-&gt;</span>underline<span class="op">)</span></span>
<span id="cb655-56"><a aria-hidden="true" href="#cb655-56" tabindex="-1"></a>        x_draw_glyph_string_underline <span class="op">(</span>s<span class="op">);</span></span>
<span id="cb655-57"><a aria-hidden="true" href="#cb655-57" tabindex="-1"></a></span>
<span id="cb655-58"><a aria-hidden="true" href="#cb655-58" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span>s<span class="op">-&gt;</span>face<span class="op">-&gt;</span>overline_p<span class="op">)</span></span>
<span id="cb655-59"><a aria-hidden="true" href="#cb655-59" tabindex="-1"></a>        x_draw_overline <span class="op">(</span>s<span class="op">);</span></span>
<span id="cb655-60"><a aria-hidden="true" href="#cb655-60" tabindex="-1"></a></span>
<span id="cb655-61"><a aria-hidden="true" href="#cb655-61" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span>s<span class="op">-&gt;</span>face<span class="op">-&gt;</span>strike_through_p<span class="op">)</span></span>
<span id="cb655-62"><a aria-hidden="true" href="#cb655-62" tabindex="-1"></a>        x_draw_strike_through <span class="op">(</span>s<span class="op">);</span></span>
<span id="cb655-63"><a aria-hidden="true" href="#cb655-63" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb655-64"><a aria-hidden="true" href="#cb655-64" tabindex="-1"></a></span>
<span id="cb655-65"><a aria-hidden="true" href="#cb655-65" tabindex="-1"></a>  <span class="co">/* Draw box if needed. */</span></span>
<span id="cb655-66"><a aria-hidden="true" href="#cb655-66" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>s<span class="op">-&gt;</span>face<span class="op">-&gt;</span>box <span class="op">!=</span> FACE_NO_BOX<span class="op">)</span></span>
<span id="cb655-67"><a aria-hidden="true" href="#cb655-67" tabindex="-1"></a>    x_draw_glyph_string_box <span class="op">(</span>s<span class="op">);</span></span>
<span id="cb655-68"><a aria-hidden="true" href="#cb655-68" tabindex="-1"></a></span>
<span id="cb655-69"><a aria-hidden="true" href="#cb655-69" tabindex="-1"></a>  <span class="co">/* ... more decorations ... */</span></span>
<span id="cb655-70"><a aria-hidden="true" href="#cb655-70" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>Location:</strong> <code>/home/user/emacs/src/xterm.c</code>
(approximate, actual function is large)</p>
<h4 data-number="18.7.2.3" id="step-3-character-glyph-foreground-drawing"><span class="header-section-number">18.7.2.3</span> Step 3: Character Glyph
Foreground Drawing</h4>
<div class="sourceCode" id="cb656"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb656-1"><a aria-hidden="true" href="#cb656-1" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span></span>
<span id="cb656-2"><a aria-hidden="true" href="#cb656-2" tabindex="-1"></a>x_draw_glyph_string_foreground <span class="op">(</span><span class="kw">struct</span> glyph_string <span class="op">*</span>s<span class="op">)</span></span>
<span id="cb656-3"><a aria-hidden="true" href="#cb656-3" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb656-4"><a aria-hidden="true" href="#cb656-4" tabindex="-1"></a>  <span class="dt">int</span> i<span class="op">,</span> x<span class="op">;</span></span>
<span id="cb656-5"><a aria-hidden="true" href="#cb656-5" tabindex="-1"></a></span>
<span id="cb656-6"><a aria-hidden="true" href="#cb656-6" tabindex="-1"></a>  <span class="co">/* If font has no default ascent/descent, use metrics from glyphs. */</span></span>
<span id="cb656-7"><a aria-hidden="true" href="#cb656-7" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>s<span class="op">-&gt;</span>font_not_found_p <span class="op">||</span> <span class="op">!</span>s<span class="op">-&gt;</span>font<span class="op">)</span></span>
<span id="cb656-8"><a aria-hidden="true" href="#cb656-8" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb656-9"><a aria-hidden="true" href="#cb656-9" tabindex="-1"></a>      <span class="cf">for</span> <span class="op">(</span>i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> s<span class="op">-&gt;</span>nchars<span class="op">;</span> <span class="op">++</span>i<span class="op">)</span></span>
<span id="cb656-10"><a aria-hidden="true" href="#cb656-10" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb656-11"><a aria-hidden="true" href="#cb656-11" tabindex="-1"></a>          <span class="kw">struct</span> glyph <span class="op">*</span>g <span class="op">=</span> s<span class="op">-&gt;</span>first_glyph <span class="op">+</span> i<span class="op">;</span></span>
<span id="cb656-12"><a aria-hidden="true" href="#cb656-12" tabindex="-1"></a>          <span class="co">// Draw each glyph individually</span></span>
<span id="cb656-13"><a aria-hidden="true" href="#cb656-13" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb656-14"><a aria-hidden="true" href="#cb656-14" tabindex="-1"></a>      <span class="cf">return</span><span class="op">;</span></span>
<span id="cb656-15"><a aria-hidden="true" href="#cb656-15" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb656-16"><a aria-hidden="true" href="#cb656-16" tabindex="-1"></a></span>
<span id="cb656-17"><a aria-hidden="true" href="#cb656-17" tabindex="-1"></a>  <span class="co">/* Fast path: use font driver to draw entire string at once. */</span></span>
<span id="cb656-18"><a aria-hidden="true" href="#cb656-18" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>s<span class="op">-&gt;</span>font<span class="op">-&gt;</span>driver<span class="op">-&gt;</span>draw<span class="op">)</span></span>
<span id="cb656-19"><a aria-hidden="true" href="#cb656-19" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb656-20"><a aria-hidden="true" href="#cb656-20" tabindex="-1"></a>      s<span class="op">-&gt;</span>font<span class="op">-&gt;</span>driver<span class="op">-&gt;</span>draw <span class="op">(</span>s<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> s<span class="op">-&gt;</span>nchars<span class="op">,</span> s<span class="op">-&gt;</span>x<span class="op">,</span> s<span class="op">-&gt;</span>ybase<span class="op">,</span></span>
<span id="cb656-21"><a aria-hidden="true" href="#cb656-21" tabindex="-1"></a>                             s<span class="op">-&gt;</span>hl <span class="op">==</span> DRAW_CURSOR<span class="op">);</span></span>
<span id="cb656-22"><a aria-hidden="true" href="#cb656-22" tabindex="-1"></a>      <span class="cf">return</span><span class="op">;</span></span>
<span id="cb656-23"><a aria-hidden="true" href="#cb656-23" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb656-24"><a aria-hidden="true" href="#cb656-24" tabindex="-1"></a></span>
<span id="cb656-25"><a aria-hidden="true" href="#cb656-25" tabindex="-1"></a>  <span class="co">/* Fallback: draw using XDrawString. */</span></span>
<span id="cb656-26"><a aria-hidden="true" href="#cb656-26" tabindex="-1"></a>  <span class="dt">char</span> <span class="op">*</span>char1b <span class="op">=</span> alloca <span class="op">(</span>s<span class="op">-&gt;</span>nchars<span class="op">);</span></span>
<span id="cb656-27"><a aria-hidden="true" href="#cb656-27" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span>i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> s<span class="op">-&gt;</span>nchars<span class="op">;</span> <span class="op">++</span>i<span class="op">)</span></span>
<span id="cb656-28"><a aria-hidden="true" href="#cb656-28" tabindex="-1"></a>    char1b<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> s<span class="op">-&gt;</span>char2b<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb656-29"><a aria-hidden="true" href="#cb656-29" tabindex="-1"></a></span>
<span id="cb656-30"><a aria-hidden="true" href="#cb656-30" tabindex="-1"></a>  XDrawString <span class="op">(</span>s<span class="op">-&gt;</span>display<span class="op">,</span> FRAME_X_DRAWABLE <span class="op">(</span>s<span class="op">-&gt;</span>f<span class="op">),</span></span>
<span id="cb656-31"><a aria-hidden="true" href="#cb656-31" tabindex="-1"></a>               s<span class="op">-&gt;</span>gc<span class="op">,</span> s<span class="op">-&gt;</span>x<span class="op">,</span> s<span class="op">-&gt;</span>ybase<span class="op">,</span> char1b<span class="op">,</span> s<span class="op">-&gt;</span>nchars<span class="op">);</span></span>
<span id="cb656-32"><a aria-hidden="true" href="#cb656-32" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h4 data-number="18.7.2.4" id="step-4-font-driver-drawing-xft-example"><span class="header-section-number">18.7.2.4</span> Step 4: Font Driver
Drawing (Xft Example)</h4>
<p>For anti-aliased fonts, Xft (X FreeType) is used:</p>
<div class="sourceCode" id="cb657"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb657-1"><a aria-hidden="true" href="#cb657-1" tabindex="-1"></a><span class="dt">static</span> <span class="dt">int</span></span>
<span id="cb657-2"><a aria-hidden="true" href="#cb657-2" tabindex="-1"></a>xftfont_draw <span class="op">(</span><span class="kw">struct</span> glyph_string <span class="op">*</span>s<span class="op">,</span> <span class="dt">int</span> from<span class="op">,</span> <span class="dt">int</span> to<span class="op">,</span></span>
<span id="cb657-3"><a aria-hidden="true" href="#cb657-3" tabindex="-1"></a>              <span class="dt">int</span> x<span class="op">,</span> <span class="dt">int</span> y<span class="op">,</span> <span class="dt">bool</span> with_background<span class="op">)</span></span>
<span id="cb657-4"><a aria-hidden="true" href="#cb657-4" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb657-5"><a aria-hidden="true" href="#cb657-5" tabindex="-1"></a>  <span class="kw">struct</span> frame <span class="op">*</span>f <span class="op">=</span> s<span class="op">-&gt;</span>f<span class="op">;</span></span>
<span id="cb657-6"><a aria-hidden="true" href="#cb657-6" tabindex="-1"></a>  <span class="kw">struct</span> face <span class="op">*</span>face <span class="op">=</span> s<span class="op">-&gt;</span>face<span class="op">;</span></span>
<span id="cb657-7"><a aria-hidden="true" href="#cb657-7" tabindex="-1"></a>  <span class="kw">struct</span> xftfont_info <span class="op">*</span>xftfont_info <span class="op">=</span> <span class="op">(</span><span class="kw">struct</span> xftfont_info <span class="op">*)</span> s<span class="op">-&gt;</span>font<span class="op">;</span></span>
<span id="cb657-8"><a aria-hidden="true" href="#cb657-8" tabindex="-1"></a>  <span class="kw">struct</span> xft_draw_info <span class="op">*</span>draw_info<span class="op">;</span></span>
<span id="cb657-9"><a aria-hidden="true" href="#cb657-9" tabindex="-1"></a>  XftColor <span class="op">*</span>fg<span class="op">,</span> <span class="op">*</span>bg<span class="op">;</span></span>
<span id="cb657-10"><a aria-hidden="true" href="#cb657-10" tabindex="-1"></a></span>
<span id="cb657-11"><a aria-hidden="true" href="#cb657-11" tabindex="-1"></a>  <span class="co">/* Get or create XftDraw (rendering context). */</span></span>
<span id="cb657-12"><a aria-hidden="true" href="#cb657-12" tabindex="-1"></a>  draw_info <span class="op">=</span> xftfont_get_xft_draw <span class="op">(</span>f<span class="op">);</span></span>
<span id="cb657-13"><a aria-hidden="true" href="#cb657-13" tabindex="-1"></a></span>
<span id="cb657-14"><a aria-hidden="true" href="#cb657-14" tabindex="-1"></a>  <span class="co">/* Determine colors. */</span></span>
<span id="cb657-15"><a aria-hidden="true" href="#cb657-15" tabindex="-1"></a>  fg <span class="op">=</span> xftfont_get_color <span class="op">(</span>f<span class="op">,</span> face<span class="op">-&gt;</span>foreground<span class="op">);</span></span>
<span id="cb657-16"><a aria-hidden="true" href="#cb657-16" tabindex="-1"></a>  bg <span class="op">=</span> xftfont_get_color <span class="op">(</span>f<span class="op">,</span> face<span class="op">-&gt;</span>background<span class="op">);</span></span>
<span id="cb657-17"><a aria-hidden="true" href="#cb657-17" tabindex="-1"></a></span>
<span id="cb657-18"><a aria-hidden="true" href="#cb657-18" tabindex="-1"></a>  <span class="co">/* Draw background if requested. */</span></span>
<span id="cb657-19"><a aria-hidden="true" href="#cb657-19" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>with_background<span class="op">)</span></span>
<span id="cb657-20"><a aria-hidden="true" href="#cb657-20" tabindex="-1"></a>    XftDrawRect <span class="op">(</span>draw_info<span class="op">-&gt;</span>xft_draw<span class="op">,</span> bg<span class="op">,</span> x<span class="op">,</span> y <span class="op">-</span> face<span class="op">-&gt;</span>font<span class="op">-&gt;</span>ascent<span class="op">,</span></span>
<span id="cb657-21"><a aria-hidden="true" href="#cb657-21" tabindex="-1"></a>                 s<span class="op">-&gt;</span>width<span class="op">,</span> face<span class="op">-&gt;</span>font<span class="op">-&gt;</span>height<span class="op">);</span></span>
<span id="cb657-22"><a aria-hidden="true" href="#cb657-22" tabindex="-1"></a></span>
<span id="cb657-23"><a aria-hidden="true" href="#cb657-23" tabindex="-1"></a>  <span class="co">/* Draw glyphs. */</span></span>
<span id="cb657-24"><a aria-hidden="true" href="#cb657-24" tabindex="-1"></a>  XftDrawGlyphs <span class="op">(</span>draw_info<span class="op">-&gt;</span>xft_draw<span class="op">,</span> fg<span class="op">,</span> xftfont_info<span class="op">-&gt;</span>xftfont<span class="op">,</span></span>
<span id="cb657-25"><a aria-hidden="true" href="#cb657-25" tabindex="-1"></a>                 x<span class="op">,</span> y<span class="op">,</span> s<span class="op">-&gt;</span>char2b <span class="op">+</span> from<span class="op">,</span> to <span class="op">-</span> from<span class="op">);</span></span>
<span id="cb657-26"><a aria-hidden="true" href="#cb657-26" tabindex="-1"></a></span>
<span id="cb657-27"><a aria-hidden="true" href="#cb657-27" tabindex="-1"></a>  <span class="cf">return</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb657-28"><a aria-hidden="true" href="#cb657-28" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>Location:</strong>
<code>/home/user/emacs/src/xftfont.c</code> (approximate)</p>
<h3 data-number="18.7.3" id="event-processing-pipeline"><span class="header-section-number">18.7.3</span> 5.3 Event Processing
Pipeline</h3>
<h4 data-number="18.7.3.1" id="step-1-x-server-sends-event"><span class="header-section-number">18.7.3.1</span> Step 1: X Server Sends
Event</h4>
<p>X11 communicates via asynchronous events sent over a socket.</p>
<h4 data-number="18.7.3.2" id="step-2-xtread_socket-reads-events"><span class="header-section-number">18.7.3.2</span> Step 2:
<code>XTread_socket</code> Reads Events</h4>
<div class="sourceCode" id="cb658"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb658-1"><a aria-hidden="true" href="#cb658-1" tabindex="-1"></a><span class="dt">static</span> <span class="dt">int</span></span>
<span id="cb658-2"><a aria-hidden="true" href="#cb658-2" tabindex="-1"></a>XTread_socket <span class="op">(</span><span class="kw">struct</span> terminal <span class="op">*</span>terminal<span class="op">,</span> <span class="kw">struct</span> input_event <span class="op">*</span>hold_quit<span class="op">)</span></span>
<span id="cb658-3"><a aria-hidden="true" href="#cb658-3" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb658-4"><a aria-hidden="true" href="#cb658-4" tabindex="-1"></a>  <span class="dt">int</span> count <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb658-5"><a aria-hidden="true" href="#cb658-5" tabindex="-1"></a>  <span class="dt">bool</span> event_found <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb658-6"><a aria-hidden="true" href="#cb658-6" tabindex="-1"></a>  <span class="kw">struct</span> x_display_info <span class="op">*</span>dpyinfo <span class="op">=</span> terminal<span class="op">-&gt;</span>display_info<span class="op">.</span>x<span class="op">;</span></span>
<span id="cb658-7"><a aria-hidden="true" href="#cb658-7" tabindex="-1"></a></span>
<span id="cb658-8"><a aria-hidden="true" href="#cb658-8" tabindex="-1"></a>  block_input <span class="op">();</span></span>
<span id="cb658-9"><a aria-hidden="true" href="#cb658-9" tabindex="-1"></a></span>
<span id="cb658-10"><a aria-hidden="true" href="#cb658-10" tabindex="-1"></a>  <span class="co">/* Process all pending events. */</span></span>
<span id="cb658-11"><a aria-hidden="true" href="#cb658-11" tabindex="-1"></a>  <span class="cf">while</span> <span class="op">(</span>XPending <span class="op">(</span>dpyinfo<span class="op">-&gt;</span>display<span class="op">)</span> <span class="op">&gt;</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb658-12"><a aria-hidden="true" href="#cb658-12" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb658-13"><a aria-hidden="true" href="#cb658-13" tabindex="-1"></a>      XEvent event<span class="op">;</span></span>
<span id="cb658-14"><a aria-hidden="true" href="#cb658-14" tabindex="-1"></a>      XNextEvent <span class="op">(</span>dpyinfo<span class="op">-&gt;</span>display<span class="op">,</span> <span class="op">&amp;</span>event<span class="op">);</span></span>
<span id="cb658-15"><a aria-hidden="true" href="#cb658-15" tabindex="-1"></a></span>
<span id="cb658-16"><a aria-hidden="true" href="#cb658-16" tabindex="-1"></a>      <span class="co">/* Filter through input method. */</span></span>
<span id="cb658-17"><a aria-hidden="true" href="#cb658-17" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span>x_filter_event <span class="op">(</span>dpyinfo<span class="op">,</span> <span class="op">&amp;</span>event<span class="op">))</span></span>
<span id="cb658-18"><a aria-hidden="true" href="#cb658-18" tabindex="-1"></a>        <span class="cf">continue</span><span class="op">;</span></span>
<span id="cb658-19"><a aria-hidden="true" href="#cb658-19" tabindex="-1"></a></span>
<span id="cb658-20"><a aria-hidden="true" href="#cb658-20" tabindex="-1"></a>      <span class="co">/* Handle the event. */</span></span>
<span id="cb658-21"><a aria-hidden="true" href="#cb658-21" tabindex="-1"></a>      count <span class="op">+=</span> handle_one_xevent <span class="op">(</span>dpyinfo<span class="op">,</span> <span class="op">&amp;</span>event<span class="op">,</span> <span class="op">&amp;</span>event_found<span class="op">,</span> hold_quit<span class="op">);</span></span>
<span id="cb658-22"><a aria-hidden="true" href="#cb658-22" tabindex="-1"></a></span>
<span id="cb658-23"><a aria-hidden="true" href="#cb658-23" tabindex="-1"></a>      <span class="co">/* Check for quit. */</span></span>
<span id="cb658-24"><a aria-hidden="true" href="#cb658-24" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span>hold_quit<span class="op">-&gt;</span>kind <span class="op">!=</span> NO_EVENT<span class="op">)</span></span>
<span id="cb658-25"><a aria-hidden="true" href="#cb658-25" tabindex="-1"></a>        <span class="cf">break</span><span class="op">;</span></span>
<span id="cb658-26"><a aria-hidden="true" href="#cb658-26" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb658-27"><a aria-hidden="true" href="#cb658-27" tabindex="-1"></a></span>
<span id="cb658-28"><a aria-hidden="true" href="#cb658-28" tabindex="-1"></a>  unblock_input <span class="op">();</span></span>
<span id="cb658-29"><a aria-hidden="true" href="#cb658-29" tabindex="-1"></a>  <span class="cf">return</span> count<span class="op">;</span></span>
<span id="cb658-30"><a aria-hidden="true" href="#cb658-30" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>Location:</strong> <code>/home/user/emacs/src/xterm.c</code>
(approximate)</p>
<h4 data-number="18.7.3.3" id="step-3-handle_one_xevent-dispatches-event"><span class="header-section-number">18.7.3.3</span> Step 3:
<code>handle_one_xevent</code> Dispatches Event</h4>
<p>This massive function (1000+ lines) handles ~50 different X11 event
types:</p>
<div class="sourceCode" id="cb659"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb659-1"><a aria-hidden="true" href="#cb659-1" tabindex="-1"></a><span class="dt">static</span> <span class="dt">int</span></span>
<span id="cb659-2"><a aria-hidden="true" href="#cb659-2" tabindex="-1"></a>handle_one_xevent <span class="op">(</span><span class="kw">struct</span> x_display_info <span class="op">*</span>dpyinfo<span class="op">,</span></span>
<span id="cb659-3"><a aria-hidden="true" href="#cb659-3" tabindex="-1"></a>                   XEvent <span class="op">*</span>event<span class="op">,</span></span>
<span id="cb659-4"><a aria-hidden="true" href="#cb659-4" tabindex="-1"></a>                   <span class="dt">bool</span> <span class="op">*</span>event_found<span class="op">,</span></span>
<span id="cb659-5"><a aria-hidden="true" href="#cb659-5" tabindex="-1"></a>                   <span class="kw">struct</span> input_event <span class="op">*</span>hold_quit<span class="op">)</span></span>
<span id="cb659-6"><a aria-hidden="true" href="#cb659-6" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb659-7"><a aria-hidden="true" href="#cb659-7" tabindex="-1"></a>  <span class="kw">union</span> buffered_input_event inev<span class="op">;</span></span>
<span id="cb659-8"><a aria-hidden="true" href="#cb659-8" tabindex="-1"></a>  <span class="dt">int</span> count <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb659-9"><a aria-hidden="true" href="#cb659-9" tabindex="-1"></a>  <span class="kw">struct</span> frame <span class="op">*</span>f <span class="op">=</span> NULL<span class="op">;</span></span>
<span id="cb659-10"><a aria-hidden="true" href="#cb659-10" tabindex="-1"></a></span>
<span id="cb659-11"><a aria-hidden="true" href="#cb659-11" tabindex="-1"></a>  EVENT_INIT <span class="op">(</span>inev<span class="op">.</span>ie<span class="op">);</span></span>
<span id="cb659-12"><a aria-hidden="true" href="#cb659-12" tabindex="-1"></a></span>
<span id="cb659-13"><a aria-hidden="true" href="#cb659-13" tabindex="-1"></a>  <span class="co">/* Determine which frame this event is for. */</span></span>
<span id="cb659-14"><a aria-hidden="true" href="#cb659-14" tabindex="-1"></a>  f <span class="op">=</span> x_any_window_to_frame <span class="op">(</span>dpyinfo<span class="op">,</span> event<span class="op">-&gt;</span>xany<span class="op">.</span>window<span class="op">);</span></span>
<span id="cb659-15"><a aria-hidden="true" href="#cb659-15" tabindex="-1"></a></span>
<span id="cb659-16"><a aria-hidden="true" href="#cb659-16" tabindex="-1"></a>  <span class="cf">switch</span> <span class="op">(</span>event<span class="op">-&gt;</span>type<span class="op">)</span></span>
<span id="cb659-17"><a aria-hidden="true" href="#cb659-17" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb659-18"><a aria-hidden="true" href="#cb659-18" tabindex="-1"></a>    <span class="cf">case</span> KeyPress<span class="op">:</span></span>
<span id="cb659-19"><a aria-hidden="true" href="#cb659-19" tabindex="-1"></a>      <span class="co">// Handle keyboard input</span></span>
<span id="cb659-20"><a aria-hidden="true" href="#cb659-20" tabindex="-1"></a>      <span class="cf">break</span><span class="op">;</span></span>
<span id="cb659-21"><a aria-hidden="true" href="#cb659-21" tabindex="-1"></a></span>
<span id="cb659-22"><a aria-hidden="true" href="#cb659-22" tabindex="-1"></a>    <span class="cf">case</span> ButtonPress<span class="op">:</span></span>
<span id="cb659-23"><a aria-hidden="true" href="#cb659-23" tabindex="-1"></a>    <span class="cf">case</span> ButtonRelease<span class="op">:</span></span>
<span id="cb659-24"><a aria-hidden="true" href="#cb659-24" tabindex="-1"></a>      <span class="co">// Handle mouse buttons</span></span>
<span id="cb659-25"><a aria-hidden="true" href="#cb659-25" tabindex="-1"></a>      <span class="cf">break</span><span class="op">;</span></span>
<span id="cb659-26"><a aria-hidden="true" href="#cb659-26" tabindex="-1"></a></span>
<span id="cb659-27"><a aria-hidden="true" href="#cb659-27" tabindex="-1"></a>    <span class="cf">case</span> MotionNotify<span class="op">:</span></span>
<span id="cb659-28"><a aria-hidden="true" href="#cb659-28" tabindex="-1"></a>      <span class="co">// Handle mouse movement</span></span>
<span id="cb659-29"><a aria-hidden="true" href="#cb659-29" tabindex="-1"></a>      <span class="cf">break</span><span class="op">;</span></span>
<span id="cb659-30"><a aria-hidden="true" href="#cb659-30" tabindex="-1"></a></span>
<span id="cb659-31"><a aria-hidden="true" href="#cb659-31" tabindex="-1"></a>    <span class="cf">case</span> Expose<span class="op">:</span></span>
<span id="cb659-32"><a aria-hidden="true" href="#cb659-32" tabindex="-1"></a>      <span class="co">// Handle window exposure (needs redraw)</span></span>
<span id="cb659-33"><a aria-hidden="true" href="#cb659-33" tabindex="-1"></a>      <span class="cf">break</span><span class="op">;</span></span>
<span id="cb659-34"><a aria-hidden="true" href="#cb659-34" tabindex="-1"></a></span>
<span id="cb659-35"><a aria-hidden="true" href="#cb659-35" tabindex="-1"></a>    <span class="cf">case</span> ConfigureNotify<span class="op">:</span></span>
<span id="cb659-36"><a aria-hidden="true" href="#cb659-36" tabindex="-1"></a>      <span class="co">// Handle window size/position change</span></span>
<span id="cb659-37"><a aria-hidden="true" href="#cb659-37" tabindex="-1"></a>      <span class="cf">break</span><span class="op">;</span></span>
<span id="cb659-38"><a aria-hidden="true" href="#cb659-38" tabindex="-1"></a></span>
<span id="cb659-39"><a aria-hidden="true" href="#cb659-39" tabindex="-1"></a>    <span class="cf">case</span> FocusIn<span class="op">:</span></span>
<span id="cb659-40"><a aria-hidden="true" href="#cb659-40" tabindex="-1"></a>    <span class="cf">case</span> FocusOut<span class="op">:</span></span>
<span id="cb659-41"><a aria-hidden="true" href="#cb659-41" tabindex="-1"></a>      <span class="co">// Handle focus changes</span></span>
<span id="cb659-42"><a aria-hidden="true" href="#cb659-42" tabindex="-1"></a>      <span class="cf">break</span><span class="op">;</span></span>
<span id="cb659-43"><a aria-hidden="true" href="#cb659-43" tabindex="-1"></a></span>
<span id="cb659-44"><a aria-hidden="true" href="#cb659-44" tabindex="-1"></a>    <span class="cf">case</span> ClientMessage<span class="op">:</span></span>
<span id="cb659-45"><a aria-hidden="true" href="#cb659-45" tabindex="-1"></a>      <span class="co">// Handle protocol messages (e.g., WM_DELETE_WINDOW)</span></span>
<span id="cb659-46"><a aria-hidden="true" href="#cb659-46" tabindex="-1"></a>      <span class="cf">break</span><span class="op">;</span></span>
<span id="cb659-47"><a aria-hidden="true" href="#cb659-47" tabindex="-1"></a></span>
<span id="cb659-48"><a aria-hidden="true" href="#cb659-48" tabindex="-1"></a>    <span class="co">// ... ~40 more event types ...</span></span>
<span id="cb659-49"><a aria-hidden="true" href="#cb659-49" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb659-50"><a aria-hidden="true" href="#cb659-50" tabindex="-1"></a></span>
<span id="cb659-51"><a aria-hidden="true" href="#cb659-51" tabindex="-1"></a>  <span class="co">/* Queue the event. */</span></span>
<span id="cb659-52"><a aria-hidden="true" href="#cb659-52" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>inev<span class="op">.</span>ie<span class="op">.</span>kind <span class="op">!=</span> NO_EVENT<span class="op">)</span></span>
<span id="cb659-53"><a aria-hidden="true" href="#cb659-53" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb659-54"><a aria-hidden="true" href="#cb659-54" tabindex="-1"></a>      kbd_buffer_store_buffered_event <span class="op">(&amp;</span>inev<span class="op">,</span> hold_quit<span class="op">);</span></span>
<span id="cb659-55"><a aria-hidden="true" href="#cb659-55" tabindex="-1"></a>      count<span class="op">++;</span></span>
<span id="cb659-56"><a aria-hidden="true" href="#cb659-56" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb659-57"><a aria-hidden="true" href="#cb659-57" tabindex="-1"></a></span>
<span id="cb659-58"><a aria-hidden="true" href="#cb659-58" tabindex="-1"></a>  <span class="cf">return</span> count<span class="op">;</span></span>
<span id="cb659-59"><a aria-hidden="true" href="#cb659-59" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>Location:</strong> <code>/home/user/emacs/src/xterm.c</code>
(approximate)</p>
<h3 data-number="18.7.4" id="x11-specific-features"><span class="header-section-number">18.7.4</span> 5.4 X11-Specific
Features</h3>
<h4 data-number="18.7.4.1" id="graphics-contexts"><span class="header-section-number">18.7.4.1</span> Graphics Contexts</h4>
<p>X11 uses Graphics Contexts (GCs) to store drawing parameters:</p>
<div class="sourceCode" id="cb660"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb660-1"><a aria-hidden="true" href="#cb660-1" tabindex="-1"></a><span class="co">/* Create GCs for frame F. */</span></span>
<span id="cb660-2"><a aria-hidden="true" href="#cb660-2" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span></span>
<span id="cb660-3"><a aria-hidden="true" href="#cb660-3" tabindex="-1"></a>x_make_gcs <span class="op">(</span><span class="kw">struct</span> frame <span class="op">*</span>f<span class="op">)</span></span>
<span id="cb660-4"><a aria-hidden="true" href="#cb660-4" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb660-5"><a aria-hidden="true" href="#cb660-5" tabindex="-1"></a>  XGCValues gc_values<span class="op">;</span></span>
<span id="cb660-6"><a aria-hidden="true" href="#cb660-6" tabindex="-1"></a>  GC gc<span class="op">;</span></span>
<span id="cb660-7"><a aria-hidden="true" href="#cb660-7" tabindex="-1"></a></span>
<span id="cb660-8"><a aria-hidden="true" href="#cb660-8" tabindex="-1"></a>  <span class="co">/* Normal GC (default face colors). */</span></span>
<span id="cb660-9"><a aria-hidden="true" href="#cb660-9" tabindex="-1"></a>  gc_values<span class="op">.</span>foreground <span class="op">=</span> FRAME_FOREGROUND_PIXEL <span class="op">(</span>f<span class="op">);</span></span>
<span id="cb660-10"><a aria-hidden="true" href="#cb660-10" tabindex="-1"></a>  gc_values<span class="op">.</span>background <span class="op">=</span> FRAME_BACKGROUND_PIXEL <span class="op">(</span>f<span class="op">);</span></span>
<span id="cb660-11"><a aria-hidden="true" href="#cb660-11" tabindex="-1"></a>  gc_values<span class="op">.</span>graphics_exposures <span class="op">=</span> False<span class="op">;</span></span>
<span id="cb660-12"><a aria-hidden="true" href="#cb660-12" tabindex="-1"></a>  gc <span class="op">=</span> XCreateGC <span class="op">(</span>FRAME_X_DISPLAY <span class="op">(</span>f<span class="op">),</span> FRAME_X_DRAWABLE <span class="op">(</span>f<span class="op">),</span></span>
<span id="cb660-13"><a aria-hidden="true" href="#cb660-13" tabindex="-1"></a>                  GCForeground <span class="op">|</span> GCBackground <span class="op">|</span> GCGraphicsExposures<span class="op">,</span></span>
<span id="cb660-14"><a aria-hidden="true" href="#cb660-14" tabindex="-1"></a>                  <span class="op">&amp;</span>gc_values<span class="op">);</span></span>
<span id="cb660-15"><a aria-hidden="true" href="#cb660-15" tabindex="-1"></a>  f<span class="op">-&gt;</span>output_data<span class="op">.</span>x<span class="op">-&gt;</span>normal_gc <span class="op">=</span> gc<span class="op">;</span></span>
<span id="cb660-16"><a aria-hidden="true" href="#cb660-16" tabindex="-1"></a></span>
<span id="cb660-17"><a aria-hidden="true" href="#cb660-17" tabindex="-1"></a>  <span class="co">/* Reverse GC (inverse video). */</span></span>
<span id="cb660-18"><a aria-hidden="true" href="#cb660-18" tabindex="-1"></a>  gc_values<span class="op">.</span>foreground <span class="op">=</span> FRAME_BACKGROUND_PIXEL <span class="op">(</span>f<span class="op">);</span></span>
<span id="cb660-19"><a aria-hidden="true" href="#cb660-19" tabindex="-1"></a>  gc_values<span class="op">.</span>background <span class="op">=</span> FRAME_FOREGROUND_PIXEL <span class="op">(</span>f<span class="op">);</span></span>
<span id="cb660-20"><a aria-hidden="true" href="#cb660-20" tabindex="-1"></a>  gc <span class="op">=</span> XCreateGC <span class="op">(</span>FRAME_X_DISPLAY <span class="op">(</span>f<span class="op">),</span> FRAME_X_DRAWABLE <span class="op">(</span>f<span class="op">),</span></span>
<span id="cb660-21"><a aria-hidden="true" href="#cb660-21" tabindex="-1"></a>                  GCForeground <span class="op">|</span> GCBackground <span class="op">|</span> GCGraphicsExposures<span class="op">,</span></span>
<span id="cb660-22"><a aria-hidden="true" href="#cb660-22" tabindex="-1"></a>                  <span class="op">&amp;</span>gc_values<span class="op">);</span></span>
<span id="cb660-23"><a aria-hidden="true" href="#cb660-23" tabindex="-1"></a>  f<span class="op">-&gt;</span>output_data<span class="op">.</span>x<span class="op">-&gt;</span>reverse_gc <span class="op">=</span> gc<span class="op">;</span></span>
<span id="cb660-24"><a aria-hidden="true" href="#cb660-24" tabindex="-1"></a></span>
<span id="cb660-25"><a aria-hidden="true" href="#cb660-25" tabindex="-1"></a>  <span class="co">/* Cursor GC. */</span></span>
<span id="cb660-26"><a aria-hidden="true" href="#cb660-26" tabindex="-1"></a>  gc_values<span class="op">.</span>foreground <span class="op">=</span> f<span class="op">-&gt;</span>output_data<span class="op">.</span>x<span class="op">-&gt;</span>cursor_pixel<span class="op">;</span></span>
<span id="cb660-27"><a aria-hidden="true" href="#cb660-27" tabindex="-1"></a>  gc_values<span class="op">.</span>background <span class="op">=</span> FRAME_BACKGROUND_PIXEL <span class="op">(</span>f<span class="op">);</span></span>
<span id="cb660-28"><a aria-hidden="true" href="#cb660-28" tabindex="-1"></a>  gc <span class="op">=</span> XCreateGC <span class="op">(</span>FRAME_X_DISPLAY <span class="op">(</span>f<span class="op">),</span> FRAME_X_DRAWABLE <span class="op">(</span>f<span class="op">),</span></span>
<span id="cb660-29"><a aria-hidden="true" href="#cb660-29" tabindex="-1"></a>                  GCForeground <span class="op">|</span> GCBackground <span class="op">|</span> GCGraphicsExposures<span class="op">,</span></span>
<span id="cb660-30"><a aria-hidden="true" href="#cb660-30" tabindex="-1"></a>                  <span class="op">&amp;</span>gc_values<span class="op">);</span></span>
<span id="cb660-31"><a aria-hidden="true" href="#cb660-31" tabindex="-1"></a>  f<span class="op">-&gt;</span>output_data<span class="op">.</span>x<span class="op">-&gt;</span>cursor_gc <span class="op">=</span> gc<span class="op">;</span></span>
<span id="cb660-32"><a aria-hidden="true" href="#cb660-32" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h4 data-number="18.7.4.2" id="double-buffering-xdbe-extension"><span class="header-section-number">18.7.4.2</span> Double Buffering (XDBE
Extension)</h4>
<p>Modern X11 uses the XDBE extension for flicker-free updates:</p>
<div class="sourceCode" id="cb661"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb661-1"><a aria-hidden="true" href="#cb661-1" tabindex="-1"></a><span class="pp">#ifdef HAVE_XDBE</span></span>
<span id="cb661-2"><a aria-hidden="true" href="#cb661-2" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span></span>
<span id="cb661-3"><a aria-hidden="true" href="#cb661-3" tabindex="-1"></a>x_flip_and_flush <span class="op">(</span><span class="kw">struct</span> frame <span class="op">*</span>f<span class="op">)</span></span>
<span id="cb661-4"><a aria-hidden="true" href="#cb661-4" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb661-5"><a aria-hidden="true" href="#cb661-5" tabindex="-1"></a>  block_input <span class="op">();</span></span>
<span id="cb661-6"><a aria-hidden="true" href="#cb661-6" tabindex="-1"></a></span>
<span id="cb661-7"><a aria-hidden="true" href="#cb661-7" tabindex="-1"></a>  <span class="co">/* Flip back buffer to front buffer. */</span></span>
<span id="cb661-8"><a aria-hidden="true" href="#cb661-8" tabindex="-1"></a>  XdbeSwapBuffers <span class="op">(</span>FRAME_X_DISPLAY <span class="op">(</span>f<span class="op">),</span> <span class="op">&amp;</span>swap_info<span class="op">,</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb661-9"><a aria-hidden="true" href="#cb661-9" tabindex="-1"></a></span>
<span id="cb661-10"><a aria-hidden="true" href="#cb661-10" tabindex="-1"></a>  <span class="co">/* Flush X output queue. */</span></span>
<span id="cb661-11"><a aria-hidden="true" href="#cb661-11" tabindex="-1"></a>  XFlush <span class="op">(</span>FRAME_X_DISPLAY <span class="op">(</span>f<span class="op">));</span></span>
<span id="cb661-12"><a aria-hidden="true" href="#cb661-12" tabindex="-1"></a></span>
<span id="cb661-13"><a aria-hidden="true" href="#cb661-13" tabindex="-1"></a>  unblock_input <span class="op">();</span></span>
<span id="cb661-14"><a aria-hidden="true" href="#cb661-14" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb661-15"><a aria-hidden="true" href="#cb661-15" tabindex="-1"></a><span class="pp">#endif</span></span></code></pre></div>
<h4 data-number="18.7.4.3" id="x-resources"><span class="header-section-number">18.7.4.3</span> X Resources</h4>
<p>X11 supports configuration via X Resource Database:</p>
<div class="sourceCode" id="cb662"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb662-1"><a aria-hidden="true" href="#cb662-1" tabindex="-1"></a><span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span></span>
<span id="cb662-2"><a aria-hidden="true" href="#cb662-2" tabindex="-1"></a>x_get_string_resource <span class="op">(</span>XrmDatabase rdb<span class="op">,</span> <span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>name<span class="op">,</span> <span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>class<span class="op">)</span></span>
<span id="cb662-3"><a aria-hidden="true" href="#cb662-3" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb662-4"><a aria-hidden="true" href="#cb662-4" tabindex="-1"></a>  XrmValue value<span class="op">;</span></span>
<span id="cb662-5"><a aria-hidden="true" href="#cb662-5" tabindex="-1"></a>  <span class="dt">char</span> <span class="op">*</span>type<span class="op">;</span></span>
<span id="cb662-6"><a aria-hidden="true" href="#cb662-6" tabindex="-1"></a></span>
<span id="cb662-7"><a aria-hidden="true" href="#cb662-7" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>XrmGetResource <span class="op">(</span>rdb<span class="op">,</span> name<span class="op">,</span> class<span class="op">,</span> <span class="op">&amp;</span>type<span class="op">,</span> <span class="op">&amp;</span>value<span class="op">))</span></span>
<span id="cb662-8"><a aria-hidden="true" href="#cb662-8" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb662-9"><a aria-hidden="true" href="#cb662-9" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(!</span>strcmp <span class="op">(</span>type<span class="op">,</span> <span class="st">"String"</span><span class="op">))</span></span>
<span id="cb662-10"><a aria-hidden="true" href="#cb662-10" tabindex="-1"></a>        <span class="cf">return</span> <span class="op">(</span><span class="dt">const</span> <span class="dt">char</span> <span class="op">*)</span> value<span class="op">.</span>addr<span class="op">;</span></span>
<span id="cb662-11"><a aria-hidden="true" href="#cb662-11" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb662-12"><a aria-hidden="true" href="#cb662-12" tabindex="-1"></a></span>
<span id="cb662-13"><a aria-hidden="true" href="#cb662-13" tabindex="-1"></a>  <span class="cf">return</span> NULL<span class="op">;</span></span>
<span id="cb662-14"><a aria-hidden="true" href="#cb662-14" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>Example Usage:</strong></p>
<pre><code>Emacs.font: Monospace-12
Emacs.cursorColor: red</code></pre>
<hr/>
<h2 data-number="18.8" id="integration-guide"><span class="header-section-number">18.8</span> Integration Guide</h2>
<h3 data-number="18.8.1" id="adding-a-new-platform"><span class="header-section-number">18.8.1</span> 6.1 Adding a New
Platform</h3>
<p>To port Emacs to a new platform, you need to:</p>
<h4 data-number="18.8.1.1" id="step-1-define-output-method"><span class="header-section-number">18.8.1.1</span> Step 1: Define Output
Method</h4>
<p>Add new enum value in <code>termhooks.h</code>:</p>
<div class="sourceCode" id="cb664"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb664-1"><a aria-hidden="true" href="#cb664-1" tabindex="-1"></a><span class="kw">enum</span> output_method</span>
<span id="cb664-2"><a aria-hidden="true" href="#cb664-2" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb664-3"><a aria-hidden="true" href="#cb664-3" tabindex="-1"></a>  <span class="co">// ... existing values ...</span></span>
<span id="cb664-4"><a aria-hidden="true" href="#cb664-4" tabindex="-1"></a>  output_myplatform<span class="op">,</span></span>
<span id="cb664-5"><a aria-hidden="true" href="#cb664-5" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<h4 data-number="18.8.1.2" id="step-2-create-display-info-structure"><span class="header-section-number">18.8.1.2</span> Step 2: Create Display
Info Structure</h4>
<p>Define platform-specific data in a new header (e.g.,
<code>myplatformterm.h</code>):</p>
<div class="sourceCode" id="cb665"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb665-1"><a aria-hidden="true" href="#cb665-1" tabindex="-1"></a><span class="kw">struct</span> myplatform_display_info</span>
<span id="cb665-2"><a aria-hidden="true" href="#cb665-2" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb665-3"><a aria-hidden="true" href="#cb665-3" tabindex="-1"></a>  <span class="co">/* Display connection. */</span></span>
<span id="cb665-4"><a aria-hidden="true" href="#cb665-4" tabindex="-1"></a>  <span class="dt">void</span> <span class="op">*</span>connection<span class="op">;</span></span>
<span id="cb665-5"><a aria-hidden="true" href="#cb665-5" tabindex="-1"></a></span>
<span id="cb665-6"><a aria-hidden="true" href="#cb665-6" tabindex="-1"></a>  <span class="co">/* Screen information. */</span></span>
<span id="cb665-7"><a aria-hidden="true" href="#cb665-7" tabindex="-1"></a>  <span class="dt">int</span> screen_width<span class="op">,</span> screen_height<span class="op">;</span></span>
<span id="cb665-8"><a aria-hidden="true" href="#cb665-8" tabindex="-1"></a></span>
<span id="cb665-9"><a aria-hidden="true" href="#cb665-9" tabindex="-1"></a>  <span class="co">/* Color depth. */</span></span>
<span id="cb665-10"><a aria-hidden="true" href="#cb665-10" tabindex="-1"></a>  <span class="dt">int</span> depth<span class="op">;</span></span>
<span id="cb665-11"><a aria-hidden="true" href="#cb665-11" tabindex="-1"></a></span>
<span id="cb665-12"><a aria-hidden="true" href="#cb665-12" tabindex="-1"></a>  <span class="co">/* Default font. */</span></span>
<span id="cb665-13"><a aria-hidden="true" href="#cb665-13" tabindex="-1"></a>  <span class="kw">struct</span> font <span class="op">*</span>font<span class="op">;</span></span>
<span id="cb665-14"><a aria-hidden="true" href="#cb665-14" tabindex="-1"></a></span>
<span id="cb665-15"><a aria-hidden="true" href="#cb665-15" tabindex="-1"></a>  <span class="co">/* Cached resources. */</span></span>
<span id="cb665-16"><a aria-hidden="true" href="#cb665-16" tabindex="-1"></a>  Lisp_Object name_list_element<span class="op">;</span></span>
<span id="cb665-17"><a aria-hidden="true" href="#cb665-17" tabindex="-1"></a></span>
<span id="cb665-18"><a aria-hidden="true" href="#cb665-18" tabindex="-1"></a>  <span class="co">/* ... platform-specific fields ... */</span></span>
<span id="cb665-19"><a aria-hidden="true" href="#cb665-19" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<h4 data-number="18.8.1.3" id="step-3-implement-redisplay-interface"><span class="header-section-number">18.8.1.3</span> Step 3: Implement
Redisplay Interface</h4>
<p>Create <code>myplatformterm.c</code> and implement the redisplay
interface:</p>
<div class="sourceCode" id="cb666"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb666-1"><a aria-hidden="true" href="#cb666-1" tabindex="-1"></a><span class="dt">static</span> <span class="kw">struct</span> redisplay_interface myplatform_redisplay_interface <span class="op">=</span></span>
<span id="cb666-2"><a aria-hidden="true" href="#cb666-2" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb666-3"><a aria-hidden="true" href="#cb666-3" tabindex="-1"></a>  myplatform_frame_parm_handlers<span class="op">,</span></span>
<span id="cb666-4"><a aria-hidden="true" href="#cb666-4" tabindex="-1"></a>  gui_produce_glyphs<span class="op">,</span>                    <span class="co">// Can use generic</span></span>
<span id="cb666-5"><a aria-hidden="true" href="#cb666-5" tabindex="-1"></a>  gui_write_glyphs<span class="op">,</span>                      <span class="co">// Can use generic</span></span>
<span id="cb666-6"><a aria-hidden="true" href="#cb666-6" tabindex="-1"></a>  gui_insert_glyphs<span class="op">,</span>                     <span class="co">// Can use generic</span></span>
<span id="cb666-7"><a aria-hidden="true" href="#cb666-7" tabindex="-1"></a>  gui_clear_end_of_line<span class="op">,</span>                 <span class="co">// Can use generic</span></span>
<span id="cb666-8"><a aria-hidden="true" href="#cb666-8" tabindex="-1"></a>  myplatform_scroll_run<span class="op">,</span>                 <span class="co">// Platform-specific</span></span>
<span id="cb666-9"><a aria-hidden="true" href="#cb666-9" tabindex="-1"></a>  myplatform_after_update_window_line<span class="op">,</span>   <span class="co">// Platform-specific</span></span>
<span id="cb666-10"><a aria-hidden="true" href="#cb666-10" tabindex="-1"></a>  NULL<span class="op">,</span></span>
<span id="cb666-11"><a aria-hidden="true" href="#cb666-11" tabindex="-1"></a>  NULL<span class="op">,</span></span>
<span id="cb666-12"><a aria-hidden="true" href="#cb666-12" tabindex="-1"></a>  myplatform_flush_display<span class="op">,</span>              <span class="co">// Platform-specific</span></span>
<span id="cb666-13"><a aria-hidden="true" href="#cb666-13" tabindex="-1"></a>  gui_clear_window_mouse_face<span class="op">,</span>           <span class="co">// Can use generic</span></span>
<span id="cb666-14"><a aria-hidden="true" href="#cb666-14" tabindex="-1"></a>  gui_get_glyph_overhangs<span class="op">,</span>               <span class="co">// Can use generic</span></span>
<span id="cb666-15"><a aria-hidden="true" href="#cb666-15" tabindex="-1"></a>  gui_fix_overlapping_area<span class="op">,</span>              <span class="co">// Can use generic</span></span>
<span id="cb666-16"><a aria-hidden="true" href="#cb666-16" tabindex="-1"></a>  myplatform_draw_fringe_bitmap<span class="op">,</span>         <span class="co">// Platform-specific</span></span>
<span id="cb666-17"><a aria-hidden="true" href="#cb666-17" tabindex="-1"></a>  myplatform_define_fringe_bitmap<span class="op">,</span>       <span class="co">// Platform-specific</span></span>
<span id="cb666-18"><a aria-hidden="true" href="#cb666-18" tabindex="-1"></a>  myplatform_destroy_fringe_bitmap<span class="op">,</span>      <span class="co">// Platform-specific</span></span>
<span id="cb666-19"><a aria-hidden="true" href="#cb666-19" tabindex="-1"></a>  myplatform_compute_glyph_string_overhangs<span class="op">,</span>  <span class="co">// Platform-specific</span></span>
<span id="cb666-20"><a aria-hidden="true" href="#cb666-20" tabindex="-1"></a>  myplatform_draw_glyph_string<span class="op">,</span>          <span class="co">// CRITICAL: platform-specific</span></span>
<span id="cb666-21"><a aria-hidden="true" href="#cb666-21" tabindex="-1"></a>  myplatform_define_frame_cursor<span class="op">,</span>        <span class="co">// Platform-specific</span></span>
<span id="cb666-22"><a aria-hidden="true" href="#cb666-22" tabindex="-1"></a>  myplatform_clear_frame_area<span class="op">,</span>           <span class="co">// Platform-specific</span></span>
<span id="cb666-23"><a aria-hidden="true" href="#cb666-23" tabindex="-1"></a>  myplatform_clear_under_internal_border<span class="op">,</span><span class="co">// Platform-specific</span></span>
<span id="cb666-24"><a aria-hidden="true" href="#cb666-24" tabindex="-1"></a>  myplatform_draw_window_cursor<span class="op">,</span>         <span class="co">// Platform-specific</span></span>
<span id="cb666-25"><a aria-hidden="true" href="#cb666-25" tabindex="-1"></a>  myplatform_draw_vertical_window_border<span class="op">,</span><span class="co">// Platform-specific</span></span>
<span id="cb666-26"><a aria-hidden="true" href="#cb666-26" tabindex="-1"></a>  myplatform_draw_window_divider<span class="op">,</span>        <span class="co">// Platform-specific</span></span>
<span id="cb666-27"><a aria-hidden="true" href="#cb666-27" tabindex="-1"></a>  myplatform_shift_glyphs_for_insert<span class="op">,</span>    <span class="co">// Platform-specific</span></span>
<span id="cb666-28"><a aria-hidden="true" href="#cb666-28" tabindex="-1"></a>  myplatform_show_hourglass<span class="op">,</span>             <span class="co">// Platform-specific</span></span>
<span id="cb666-29"><a aria-hidden="true" href="#cb666-29" tabindex="-1"></a>  myplatform_hide_hourglass<span class="op">,</span>             <span class="co">// Platform-specific</span></span>
<span id="cb666-30"><a aria-hidden="true" href="#cb666-30" tabindex="-1"></a>  myplatform_default_font_parameter      <span class="co">// Platform-specific</span></span>
<span id="cb666-31"><a aria-hidden="true" href="#cb666-31" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<h4 data-number="18.8.1.4" id="step-4-create-terminal"><span class="header-section-number">18.8.1.4</span> Step 4: Create
Terminal</h4>
<div class="sourceCode" id="cb667"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb667-1"><a aria-hidden="true" href="#cb667-1" tabindex="-1"></a><span class="dt">static</span> <span class="kw">struct</span> terminal <span class="op">*</span></span>
<span id="cb667-2"><a aria-hidden="true" href="#cb667-2" tabindex="-1"></a>myplatform_create_terminal <span class="op">(</span><span class="kw">struct</span> myplatform_display_info <span class="op">*</span>dpyinfo<span class="op">)</span></span>
<span id="cb667-3"><a aria-hidden="true" href="#cb667-3" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb667-4"><a aria-hidden="true" href="#cb667-4" tabindex="-1"></a>  <span class="kw">struct</span> terminal <span class="op">*</span>terminal<span class="op">;</span></span>
<span id="cb667-5"><a aria-hidden="true" href="#cb667-5" tabindex="-1"></a></span>
<span id="cb667-6"><a aria-hidden="true" href="#cb667-6" tabindex="-1"></a>  terminal <span class="op">=</span> create_terminal <span class="op">(</span>output_myplatform<span class="op">,</span></span>
<span id="cb667-7"><a aria-hidden="true" href="#cb667-7" tabindex="-1"></a>                              <span class="op">&amp;</span>myplatform_redisplay_interface<span class="op">);</span></span>
<span id="cb667-8"><a aria-hidden="true" href="#cb667-8" tabindex="-1"></a></span>
<span id="cb667-9"><a aria-hidden="true" href="#cb667-9" tabindex="-1"></a>  terminal<span class="op">-&gt;</span>display_info<span class="op">.</span>myplatform <span class="op">=</span> dpyinfo<span class="op">;</span></span>
<span id="cb667-10"><a aria-hidden="true" href="#cb667-10" tabindex="-1"></a></span>
<span id="cb667-11"><a aria-hidden="true" href="#cb667-11" tabindex="-1"></a>  <span class="co">/* Set hooks. */</span></span>
<span id="cb667-12"><a aria-hidden="true" href="#cb667-12" tabindex="-1"></a>  terminal<span class="op">-&gt;</span>clear_frame_hook <span class="op">=</span> myplatform_clear_frame<span class="op">;</span></span>
<span id="cb667-13"><a aria-hidden="true" href="#cb667-13" tabindex="-1"></a>  terminal<span class="op">-&gt;</span>read_socket_hook <span class="op">=</span> myplatform_read_socket<span class="op">;</span></span>
<span id="cb667-14"><a aria-hidden="true" href="#cb667-14" tabindex="-1"></a>  terminal<span class="op">-&gt;</span>frame_up_to_date_hook <span class="op">=</span> myplatform_frame_up_to_date<span class="op">;</span></span>
<span id="cb667-15"><a aria-hidden="true" href="#cb667-15" tabindex="-1"></a>  terminal<span class="op">-&gt;</span>mouse_position_hook <span class="op">=</span> myplatform_mouse_position<span class="op">;</span></span>
<span id="cb667-16"><a aria-hidden="true" href="#cb667-16" tabindex="-1"></a>  terminal<span class="op">-&gt;</span>focus_frame_hook <span class="op">=</span> myplatform_focus_frame<span class="op">;</span></span>
<span id="cb667-17"><a aria-hidden="true" href="#cb667-17" tabindex="-1"></a>  terminal<span class="op">-&gt;</span>frame_raise_lower_hook <span class="op">=</span> myplatform_frame_raise_lower<span class="op">;</span></span>
<span id="cb667-18"><a aria-hidden="true" href="#cb667-18" tabindex="-1"></a>  terminal<span class="op">-&gt;</span>fullscreen_hook <span class="op">=</span> myplatform_fullscreen_hook<span class="op">;</span></span>
<span id="cb667-19"><a aria-hidden="true" href="#cb667-19" tabindex="-1"></a>  terminal<span class="op">-&gt;</span>menu_show_hook <span class="op">=</span> myplatform_menu_show<span class="op">;</span></span>
<span id="cb667-20"><a aria-hidden="true" href="#cb667-20" tabindex="-1"></a>  terminal<span class="op">-&gt;</span>popup_dialog_hook <span class="op">=</span> myplatform_popup_dialog<span class="op">;</span></span>
<span id="cb667-21"><a aria-hidden="true" href="#cb667-21" tabindex="-1"></a>  terminal<span class="op">-&gt;</span>set_vertical_scroll_bar_hook <span class="op">=</span> myplatform_set_vertical_scroll_bar<span class="op">;</span></span>
<span id="cb667-22"><a aria-hidden="true" href="#cb667-22" tabindex="-1"></a>  terminal<span class="op">-&gt;</span>condemn_scroll_bars_hook <span class="op">=</span> myplatform_condemn_scroll_bars<span class="op">;</span></span>
<span id="cb667-23"><a aria-hidden="true" href="#cb667-23" tabindex="-1"></a>  terminal<span class="op">-&gt;</span>redeem_scroll_bar_hook <span class="op">=</span> myplatform_redeem_scroll_bar<span class="op">;</span></span>
<span id="cb667-24"><a aria-hidden="true" href="#cb667-24" tabindex="-1"></a>  terminal<span class="op">-&gt;</span>judge_scroll_bars_hook <span class="op">=</span> myplatform_judge_scroll_bars<span class="op">;</span></span>
<span id="cb667-25"><a aria-hidden="true" href="#cb667-25" tabindex="-1"></a>  terminal<span class="op">-&gt;</span>delete_frame_hook <span class="op">=</span> myplatform_delete_frame<span class="op">;</span></span>
<span id="cb667-26"><a aria-hidden="true" href="#cb667-26" tabindex="-1"></a>  terminal<span class="op">-&gt;</span>delete_terminal_hook <span class="op">=</span> myplatform_delete_terminal<span class="op">;</span></span>
<span id="cb667-27"><a aria-hidden="true" href="#cb667-27" tabindex="-1"></a></span>
<span id="cb667-28"><a aria-hidden="true" href="#cb667-28" tabindex="-1"></a>  <span class="cf">return</span> terminal<span class="op">;</span></span>
<span id="cb667-29"><a aria-hidden="true" href="#cb667-29" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h4 data-number="18.8.1.5" id="step-5-implement-frame-functions"><span class="header-section-number">18.8.1.5</span> Step 5: Implement Frame
Functions</h4>
<p>Create <code>myplatformfns.c</code> with frame creation, parameter
setting, etc.</p>
<h4 data-number="18.8.1.6" id="step-6-implement-font-driver"><span class="header-section-number">18.8.1.6</span> Step 6: Implement Font
Driver</h4>
<p>Create font driver in <code>myplatformfont.c</code>.</p>
<h4 data-number="18.8.1.7" id="step-7-implement-event-loop"><span class="header-section-number">18.8.1.7</span> Step 7: Implement Event
Loop</h4>
<p>The <code>read_socket_hook</code> must: 1. Read native events from
the windowing system 2. Translate them to
<code>struct input_event</code> 3. Return event count (or error
codes)</p>
<h4 data-number="18.8.1.8" id="step-8-integration"><span class="header-section-number">18.8.1.8</span> Step 8: Integration</h4>
<ol type="1">
<li>Add configure.ac detection for your platform</li>
<li>Add Makefile rules</li>
<li>Add platform-specific initialization</li>
<li>Test extensively!</li>
</ol>
<h3 data-number="18.8.2" id="best-practices"><span class="header-section-number">18.8.2</span> 6.2 Best Practices</h3>
<ol type="1">
<li><strong>Reuse Generic Code</strong>: Functions prefixed with
<code>gui_</code> are often reusable</li>
<li><strong>Minimize Platform Code</strong>: Only implement what‚Äôs truly
platform-specific</li>
<li><strong>Follow Conventions</strong>: Study existing ports
(especially X11 and Windows)</li>
<li><strong>Handle Errors</strong>: Check all platform API calls for
errors</li>
<li><strong>Support Configuration</strong>: Allow users to customize via
frame parameters</li>
<li><strong>Document Limitations</strong>: Some platforms can‚Äôt support
all features</li>
</ol>
<hr/>
<h2 data-number="18.9" id="references-3"><span class="header-section-number">18.9</span> References</h2>
<h3 data-number="18.9.1" id="primary-source-files-1"><span class="header-section-number">18.9.1</span> Primary Source Files</h3>
<table>
<colgroup>
<col style="width: 36%"/>
<col style="width: 20%"/>
<col style="width: 43%"/>
</colgroup>
<thead>
<tr>
<th>Component</th>
<th>File</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>Terminal Abstraction</td>
<td><code>/home/user/emacs/src/termhooks.h</code></td>
<td>Terminal structure definition</td>
</tr>
<tr>
<td>Redisplay Interface</td>
<td><code>/home/user/emacs/src/dispextern.h</code></td>
<td>Redisplay interface definition</td>
</tr>
<tr>
<td>Terminal Management</td>
<td><code>/home/user/emacs/src/terminal.c</code></td>
<td>Terminal creation and deletion</td>
</tr>
<tr>
<td>X11 Implementation</td>
<td><code>/home/user/emacs/src/xterm.c</code></td>
<td>X11 terminal and rendering</td>
</tr>
<tr>
<td>X11 Frames</td>
<td><code>/home/user/emacs/src/xfns.c</code></td>
<td>X11 frame functions</td>
</tr>
<tr>
<td>Windows Implementation</td>
<td><code>/home/user/emacs/src/w32term.c</code></td>
<td>Windows terminal and rendering</td>
</tr>
<tr>
<td>Windows Frames</td>
<td><code>/home/user/emacs/src/w32fns.c</code></td>
<td>Windows frame functions</td>
</tr>
<tr>
<td>Android Implementation</td>
<td><code>/home/user/emacs/src/androidterm.c</code></td>
<td>Android terminal and rendering</td>
</tr>
<tr>
<td>Haiku Implementation</td>
<td><code>/home/user/emacs/src/haikuterm.c</code></td>
<td>Haiku terminal and rendering</td>
</tr>
<tr>
<td>GTK Implementation</td>
<td><code>/home/user/emacs/src/pgtkterm.c</code></td>
<td>Pure GTK terminal and rendering</td>
</tr>
<tr>
<td>TTY Implementation</td>
<td><code>/home/user/emacs/src/term.c</code></td>
<td>Text terminal implementation</td>
</tr>
<tr>
<td>Font System</td>
<td><code>/home/user/emacs/src/font.h</code></td>
<td>Font driver interface</td>
</tr>
<tr>
<td>Font Implementation</td>
<td><code>/home/user/emacs/src/font.c</code></td>
<td>Generic font code</td>
</tr>
</tbody>
</table>
<h3 data-number="18.9.2" id="key-concepts-1"><span class="header-section-number">18.9.2</span> Key Concepts</h3>
<ul>
<li><strong>Terminal</strong>: An abstraction representing a display
device (graphical or text)</li>
<li><strong>Redisplay Interface</strong>: Set of methods for rendering
graphics and text</li>
<li><strong>Glyph String</strong>: A sequence of glyphs (characters or
graphical elements) with the same face</li>
<li><strong>Face</strong>: Text attributes (font, color, etc.)</li>
<li><strong>Hook Functions</strong>: Function pointers in
<code>struct terminal</code> for platform-specific operations</li>
<li><strong>Display Info</strong>: Platform-specific data structure
(e.g., <code>x_display_info</code>, <code>w32_display_info</code>)</li>
<li><strong>Frame</strong>: An Emacs window (in windowing system
terminology)</li>
<li><strong>Window</strong>: A subdivision of a frame (internal Emacs
concept)</li>
</ul>
<h3 data-number="18.9.3" id="statistics-summary"><span class="header-section-number">18.9.3</span> Statistics Summary</h3>
<table>
<thead>
<tr>
<th>Metric</th>
<th>Value</th>
</tr>
</thead>
<tbody>
<tr>
<td>Supported Platforms</td>
<td>8+</td>
</tr>
<tr>
<td>Terminal Hook Functions</td>
<td>~40</td>
</tr>
<tr>
<td>Redisplay Interface Methods</td>
<td>~30</td>
</tr>
<tr>
<td>X11 Source Files</td>
<td>10+</td>
</tr>
<tr>
<td>Windows Source Files</td>
<td>19</td>
</tr>
<tr>
<td>Android Source Files</td>
<td>12</td>
</tr>
<tr>
<td>Total Platform-Specific LOC</td>
<td>~200,000+</td>
</tr>
</tbody>
</table>
<hr/>
<p><strong>End of Document</strong></p>
<p>This literate programming guide provides a comprehensive view of
Emacs‚Äôs platform abstraction architecture. By studying the patterns and
implementations here, you can understand how Emacs achieves portability
while maintaining performance and leveraging platform-specific
features.</p>
<h1 data-number="19" id="x11-window-system-integration"><span class="header-section-number">19</span> X11 Window System
Integration</h1>
<h2 data-number="19.1" id="overview-8"><span class="header-section-number">19.1</span> Overview</h2>
<p>This document provides comprehensive coverage of Emacs‚Äôs window
system integration, with a primary focus on X11 implementation as the
reference platform. X11 has been the main development and testing
platform for Emacs‚Äôs graphical features since X10 support was first
added, making it the most mature and feature-complete
implementation.</p>
<h3 data-number="19.1.1" id="architecture-overview-3"><span class="header-section-number">19.1.1</span> Architecture Overview</h3>
<p>The X11 integration is implemented across several key source
files:</p>
<table>
<colgroup>
<col style="width: 27%"/>
<col style="width: 31%"/>
<col style="width: 40%"/>
</colgroup>
<thead>
<tr>
<th>File</th>
<th>Lines</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>src/xterm.c</code></td>
<td>~33,000</td>
<td>Event loop, rendering, and main terminal interface</td>
</tr>
<tr>
<td><code>src/xfns.c</code></td>
<td>~10,600</td>
<td>Frame creation and management functions</td>
</tr>
<tr>
<td><code>src/xmenu.c</code></td>
<td>~2,900</td>
<td>Menu bar and popup menu handling</td>
</tr>
<tr>
<td><code>src/xselect.c</code></td>
<td>~3,500</td>
<td>Selection (clipboard) handling</td>
</tr>
<tr>
<td><code>src/xsettings.c</code></td>
<td>~1,800</td>
<td>XSETTINGS protocol for desktop integration</td>
</tr>
<tr>
<td><code>src/xrdb.c</code></td>
<td>~650</td>
<td>X Resource Database management</td>
</tr>
<tr>
<td><code>src/xfont.c</code></td>
<td>~1,000</td>
<td>Core X font backend</td>
</tr>
<tr>
<td><code>src/xftfont.c</code></td>
<td>~800</td>
<td>Xft/FreeType font backend</td>
</tr>
</tbody>
</table>
<h2 data-number="19.2" id="x11-integration-architecture"><span class="header-section-number">19.2</span> 1. X11 Integration
Architecture</h2>
<h3 data-number="19.2.1" id="display-connection-and-initialization"><span class="header-section-number">19.2.1</span> 1.1 Display Connection and
Initialization</h3>
<p>The X11 integration centers around the <code>x_display_info</code>
structure, which maintains all state for a connection to an X
server:</p>
<div class="sourceCode" id="cb668"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb668-1"><a aria-hidden="true" href="#cb668-1" tabindex="-1"></a><span class="co">/* From src/xterm.h */</span></span>
<span id="cb668-2"><a aria-hidden="true" href="#cb668-2" tabindex="-1"></a><span class="kw">struct</span> x_display_info</span>
<span id="cb668-3"><a aria-hidden="true" href="#cb668-3" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb668-4"><a aria-hidden="true" href="#cb668-4" tabindex="-1"></a>  <span class="co">/* Chain of all x_display_info structures */</span></span>
<span id="cb668-5"><a aria-hidden="true" href="#cb668-5" tabindex="-1"></a>  <span class="kw">struct</span> x_display_info <span class="op">*</span>next<span class="op">;</span></span>
<span id="cb668-6"><a aria-hidden="true" href="#cb668-6" tabindex="-1"></a></span>
<span id="cb668-7"><a aria-hidden="true" href="#cb668-7" tabindex="-1"></a>  <span class="co">/* Generic display parameters */</span></span>
<span id="cb668-8"><a aria-hidden="true" href="#cb668-8" tabindex="-1"></a>  <span class="kw">struct</span> terminal <span class="op">*</span>terminal<span class="op">;</span></span>
<span id="cb668-9"><a aria-hidden="true" href="#cb668-9" tabindex="-1"></a></span>
<span id="cb668-10"><a aria-hidden="true" href="#cb668-10" tabindex="-1"></a>  <span class="co">/* Xlib display connection */</span></span>
<span id="cb668-11"><a aria-hidden="true" href="#cb668-11" tabindex="-1"></a>  Display <span class="op">*</span>display<span class="op">;</span></span>
<span id="cb668-12"><a aria-hidden="true" href="#cb668-12" tabindex="-1"></a></span>
<span id="cb668-13"><a aria-hidden="true" href="#cb668-13" tabindex="-1"></a>  <span class="co">/* File descriptor for the connection */</span></span>
<span id="cb668-14"><a aria-hidden="true" href="#cb668-14" tabindex="-1"></a>  <span class="dt">int</span> connection<span class="op">;</span></span>
<span id="cb668-15"><a aria-hidden="true" href="#cb668-15" tabindex="-1"></a></span>
<span id="cb668-16"><a aria-hidden="true" href="#cb668-16" tabindex="-1"></a>  <span class="co">/* Security status */</span></span>
<span id="cb668-17"><a aria-hidden="true" href="#cb668-17" tabindex="-1"></a>  <span class="dt">bool</span> untrusted<span class="op">;</span></span>
<span id="cb668-18"><a aria-hidden="true" href="#cb668-18" tabindex="-1"></a></span>
<span id="cb668-19"><a aria-hidden="true" href="#cb668-19" tabindex="-1"></a>  <span class="co">/* Screen and visual information */</span></span>
<span id="cb668-20"><a aria-hidden="true" href="#cb668-20" tabindex="-1"></a>  Screen <span class="op">*</span>screen<span class="op">;</span></span>
<span id="cb668-21"><a aria-hidden="true" href="#cb668-21" tabindex="-1"></a>  Visual <span class="op">*</span>visual<span class="op">;</span></span>
<span id="cb668-22"><a aria-hidden="true" href="#cb668-22" tabindex="-1"></a>  XVisualInfo visual_info<span class="op">;</span></span>
<span id="cb668-23"><a aria-hidden="true" href="#cb668-23" tabindex="-1"></a>  Colormap cmap<span class="op">;</span></span>
<span id="cb668-24"><a aria-hidden="true" href="#cb668-24" tabindex="-1"></a>  <span class="dt">int</span> n_planes<span class="op">;</span></span>
<span id="cb668-25"><a aria-hidden="true" href="#cb668-25" tabindex="-1"></a>  <span class="dt">double</span> resx<span class="op">,</span> resy<span class="op">;</span>  <span class="co">/* DPI */</span></span>
<span id="cb668-26"><a aria-hidden="true" href="#cb668-26" tabindex="-1"></a></span>
<span id="cb668-27"><a aria-hidden="true" href="#cb668-27" tabindex="-1"></a><span class="pp">#ifdef HAVE_XRENDER</span></span>
<span id="cb668-28"><a aria-hidden="true" href="#cb668-28" tabindex="-1"></a>  XRenderPictFormat <span class="op">*</span>pict_format<span class="op">;</span></span>
<span id="cb668-29"><a aria-hidden="true" href="#cb668-29" tabindex="-1"></a><span class="pp">#endif</span></span>
<span id="cb668-30"><a aria-hidden="true" href="#cb668-30" tabindex="-1"></a></span>
<span id="cb668-31"><a aria-hidden="true" href="#cb668-31" tabindex="-1"></a>  <span class="co">/* Resource database */</span></span>
<span id="cb668-32"><a aria-hidden="true" href="#cb668-32" tabindex="-1"></a>  XrmDatabase rdb<span class="op">;</span></span>
<span id="cb668-33"><a aria-hidden="true" href="#cb668-33" tabindex="-1"></a></span>
<span id="cb668-34"><a aria-hidden="true" href="#cb668-34" tabindex="-1"></a>  <span class="co">/* Window manager communication atoms */</span></span>
<span id="cb668-35"><a aria-hidden="true" href="#cb668-35" tabindex="-1"></a>  Atom Xatom_wm_protocols<span class="op">;</span></span>
<span id="cb668-36"><a aria-hidden="true" href="#cb668-36" tabindex="-1"></a>  Atom Xatom_wm_take_focus<span class="op">;</span></span>
<span id="cb668-37"><a aria-hidden="true" href="#cb668-37" tabindex="-1"></a>  Atom Xatom_wm_save_yourself<span class="op">;</span></span>
<span id="cb668-38"><a aria-hidden="true" href="#cb668-38" tabindex="-1"></a>  Atom Xatom_wm_delete_window<span class="op">;</span></span>
<span id="cb668-39"><a aria-hidden="true" href="#cb668-39" tabindex="-1"></a>  Atom Xatom_wm_change_state<span class="op">;</span></span>
<span id="cb668-40"><a aria-hidden="true" href="#cb668-40" tabindex="-1"></a></span>
<span id="cb668-41"><a aria-hidden="true" href="#cb668-41" tabindex="-1"></a>  <span class="co">/* Selection atoms */</span></span>
<span id="cb668-42"><a aria-hidden="true" href="#cb668-42" tabindex="-1"></a>  Atom Xatom_CLIPBOARD<span class="op">;</span></span>
<span id="cb668-43"><a aria-hidden="true" href="#cb668-43" tabindex="-1"></a>  Atom Xatom_TIMESTAMP<span class="op">;</span></span>
<span id="cb668-44"><a aria-hidden="true" href="#cb668-44" tabindex="-1"></a>  Atom Xatom_TEXT<span class="op">;</span></span>
<span id="cb668-45"><a aria-hidden="true" href="#cb668-45" tabindex="-1"></a>  Atom Xatom_UTF8_STRING<span class="op">;</span></span>
<span id="cb668-46"><a aria-hidden="true" href="#cb668-46" tabindex="-1"></a>  Atom Xatom_TARGETS<span class="op">;</span></span>
<span id="cb668-47"><a aria-hidden="true" href="#cb668-47" tabindex="-1"></a>  <span class="co">/* ... many more atoms ... */</span></span>
<span id="cb668-48"><a aria-hidden="true" href="#cb668-48" tabindex="-1"></a></span>
<span id="cb668-49"><a aria-hidden="true" href="#cb668-49" tabindex="-1"></a>  <span class="co">/* Focus tracking */</span></span>
<span id="cb668-50"><a aria-hidden="true" href="#cb668-50" tabindex="-1"></a>  <span class="kw">struct</span> frame <span class="op">*</span>x_focus_frame<span class="op">;</span></span>
<span id="cb668-51"><a aria-hidden="true" href="#cb668-51" tabindex="-1"></a>  <span class="kw">struct</span> frame <span class="op">*</span>x_focus_event_frame<span class="op">;</span></span>
<span id="cb668-52"><a aria-hidden="true" href="#cb668-52" tabindex="-1"></a>  <span class="kw">struct</span> frame <span class="op">*</span>highlight_frame<span class="op">;</span></span>
<span id="cb668-53"><a aria-hidden="true" href="#cb668-53" tabindex="-1"></a></span>
<span id="cb668-54"><a aria-hidden="true" href="#cb668-54" tabindex="-1"></a>  <span class="co">/* Mouse tracking */</span></span>
<span id="cb668-55"><a aria-hidden="true" href="#cb668-55" tabindex="-1"></a>  <span class="kw">struct</span> frame <span class="op">*</span>last_mouse_frame<span class="op">;</span></span>
<span id="cb668-56"><a aria-hidden="true" href="#cb668-56" tabindex="-1"></a>  <span class="kw">struct</span> frame <span class="op">*</span>last_mouse_glyph_frame<span class="op">;</span></span>
<span id="cb668-57"><a aria-hidden="true" href="#cb668-57" tabindex="-1"></a>  <span class="kw">struct</span> scroll_bar <span class="op">*</span>last_mouse_scroll_bar<span class="op">;</span></span>
<span id="cb668-58"><a aria-hidden="true" href="#cb668-58" tabindex="-1"></a>  Time last_user_time<span class="op">;</span></span>
<span id="cb668-59"><a aria-hidden="true" href="#cb668-59" tabindex="-1"></a></span>
<span id="cb668-60"><a aria-hidden="true" href="#cb668-60" tabindex="-1"></a>  <span class="co">/* Graphics contexts */</span></span>
<span id="cb668-61"><a aria-hidden="true" href="#cb668-61" tabindex="-1"></a>  GC scratch_cursor_gc<span class="op">;</span></span>
<span id="cb668-62"><a aria-hidden="true" href="#cb668-62" tabindex="-1"></a>  Mouse_HLInfo mouse_highlight<span class="op">;</span></span>
<span id="cb668-63"><a aria-hidden="true" href="#cb668-63" tabindex="-1"></a></span>
<span id="cb668-64"><a aria-hidden="true" href="#cb668-64" tabindex="-1"></a>  <span class="co">/* Modifier key mappings */</span></span>
<span id="cb668-65"><a aria-hidden="true" href="#cb668-65" tabindex="-1"></a>  <span class="dt">unsigned</span> <span class="dt">int</span> meta_mod_mask<span class="op">;</span></span>
<span id="cb668-66"><a aria-hidden="true" href="#cb668-66" tabindex="-1"></a>  <span class="dt">unsigned</span> <span class="dt">int</span> shift_lock_mask<span class="op">;</span></span>
<span id="cb668-67"><a aria-hidden="true" href="#cb668-67" tabindex="-1"></a>  <span class="dt">unsigned</span> <span class="dt">int</span> alt_mod_mask<span class="op">;</span></span>
<span id="cb668-68"><a aria-hidden="true" href="#cb668-68" tabindex="-1"></a>  <span class="dt">unsigned</span> <span class="dt">int</span> super_mod_mask<span class="op">;</span></span>
<span id="cb668-69"><a aria-hidden="true" href="#cb668-69" tabindex="-1"></a>  <span class="dt">unsigned</span> <span class="dt">int</span> hyper_mod_mask<span class="op">;</span></span>
<span id="cb668-70"><a aria-hidden="true" href="#cb668-70" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<p><strong>Key Initialization Steps</strong> (in
<code>x_term_init</code> from <code>xterm.c</code>):</p>
<ol type="1">
<li><strong>Open Display Connection</strong>: Call
<code>XOpenDisplay()</code> to connect to X server</li>
<li><strong>Visual Selection</strong>: Choose appropriate visual
(TrueColor preferred)</li>
<li><strong>Colormap Creation</strong>: Create colormap based on
visual</li>
<li><strong>Atom Initialization</strong>: Intern all required atoms for
WM communication</li>
<li><strong>Extension Detection</strong>: Query for XRender, Xfixes,
XInput2, Xrandr, etc.</li>
<li><strong>Resource Loading</strong>: Load X resources from various
sources</li>
<li><strong>Input Method Setup</strong>: Initialize XIM for
internationalized input</li>
<li><strong>Event Mask Setup</strong>: Configure which events to
receive</li>
</ol>
<h3 data-number="19.2.2" id="x-resources-and-xsettings"><span class="header-section-number">19.2.2</span> 1.2 X Resources and
XSETTINGS</h3>
<h4 data-number="19.2.2.1" id="x-resource-database-xrdb.c"><span class="header-section-number">19.2.2.1</span> X Resource Database
(xrdb.c)</h4>
<p>The X Resource Database provides a hierarchical configuration system.
Emacs loads resources from multiple sources in priority order:</p>
<div class="sourceCode" id="cb669"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb669-1"><a aria-hidden="true" href="#cb669-1" tabindex="-1"></a><span class="co">/* Resource loading order (highest to lowest priority):</span></span>
<span id="cb669-2"><a aria-hidden="true" href="#cb669-2" tabindex="-1"></a><span class="co"> * 1. Command line options (-xrm)</span></span>
<span id="cb669-3"><a aria-hidden="true" href="#cb669-3" tabindex="-1"></a><span class="co"> * 2. RESOURCE_MANAGER property on root window</span></span>
<span id="cb669-4"><a aria-hidden="true" href="#cb669-4" tabindex="-1"></a><span class="co"> * 3. .Xdefaults in home directory</span></span>
<span id="cb669-5"><a aria-hidden="true" href="#cb669-5" tabindex="-1"></a><span class="co"> * 4. XENVIRONMENT file or .Xdefaults-hostname</span></span>
<span id="cb669-6"><a aria-hidden="true" href="#cb669-6" tabindex="-1"></a><span class="co"> * 5. Application defaults</span></span>
<span id="cb669-7"><a aria-hidden="true" href="#cb669-7" tabindex="-1"></a><span class="co"> */</span></span></code></pre></div>
<p><strong>Resource Specification Format</strong>:</p>
<pre><code>Emacs.font: Monospace-12
Emacs*background: white
Emacs*foreground: black
emacs.geometry: 80x40+100+100
Emacs.menuBar: on
Emacs.toolBar: off</code></pre>
<p><strong>Implementation</strong> (<code>src/xrdb.c</code>): -
<code>x_get_string_resource()</code>: Retrieve string resource value -
<code>x_get_resource()</code>: General resource retrieval with
class/name lookup - <code>x_load_resources()</code>: Load resources from
all sources into database - Support for <code>%C</code>,
<code>%N</code>, <code>%T</code>, <code>%L</code> escape sequences in
search paths</p>
<h4 data-number="19.2.2.2" id="xsettings-protocol-xsettings.c"><span class="header-section-number">19.2.2.2</span> XSETTINGS Protocol
(xsettings.c)</h4>
<p>XSETTINGS provides runtime desktop environment integration, allowing
Emacs to respond to theme changes, DPI changes, and other desktop-wide
settings.</p>
<div class="sourceCode" id="cb671"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb671-1"><a aria-hidden="true" href="#cb671-1" tabindex="-1"></a><span class="co">/* XSETTINGS mechanism:</span></span>
<span id="cb671-2"><a aria-hidden="true" href="#cb671-2" tabindex="-1"></a><span class="co"> * 1. XSETTINGS manager sets _XSETTINGS_SETTINGS property on root</span></span>
<span id="cb671-3"><a aria-hidden="true" href="#cb671-3" tabindex="-1"></a><span class="co"> * 2. Emacs monitors this property with PropertyNotify events</span></span>
<span id="cb671-4"><a aria-hidden="true" href="#cb671-4" tabindex="-1"></a><span class="co"> * 3. When changed, parse settings and apply updates</span></span>
<span id="cb671-5"><a aria-hidden="true" href="#cb671-5" tabindex="-1"></a><span class="co"> */</span></span></code></pre></div>
<p><strong>Monitored Settings</strong>: - <code>Xft/DPI</code>: Screen
DPI for font rendering - <code>Xft/Antialias</code>: Font antialiasing
preference - <code>Xft/Hinting</code>: Font hinting preference -
<code>Xft/RGBA</code>: Subpixel rendering order -
<code>Net/ThemeName</code>: GTK theme name - <code>Gtk/FontName</code>:
Default GTK font - <code>Gtk/ToolbarStyle</code>: Toolbar display
style</p>
<p><strong>Application Flow</strong>: 1. On startup, read
<code>_XSETTINGS_SETTINGS</code> property 2. Install
<code>PropertyNotify</code> handler on root window 3. When property
changes, re-read and parse settings 4. Generate
<code>CONFIG_CHANGED_EVENT</code> to update Emacs state 5. Update fonts,
themes, and UI elements as needed</p>
<h3 data-number="19.2.3" id="toolkit-integration"><span class="header-section-number">19.2.3</span> 1.3 Toolkit Integration</h3>
<p>Emacs supports three major X11 toolkit configurations:</p>
<h4 data-number="19.2.3.1" id="no-toolkit-configuration"><span class="header-section-number">19.2.3.1</span> No Toolkit
Configuration</h4>
<p><strong>Characteristics</strong>: - Simplest window structure: one X
window per frame - Native Emacs scrollbars - XMenu library for popup
menus (from X11R2) - Direct control over all X operations - Minimal
dependencies</p>
<p><strong>Window Structure</strong>:</p>
<pre><code>FRAME_X_WINDOW (f) == top-level window
  ‚îî‚îÄ‚îÄ Direct drawing and event handling</code></pre>
<h4 data-number="19.2.3.2" id="x-toolkit-intrinsics-xt-configuration"><span class="header-section-number">19.2.3.2</span> X Toolkit Intrinsics (Xt)
Configuration</h4>
<p>Two variants: <strong>Lucid</strong> and
<strong>Motif/LessTif</strong></p>
<p><strong>Lucid Widgets</strong>: - Custom Lucid Widget Library
(<code>lwlib/</code>) for menus - Xaw (or Xaw3d/neXtaw) for dialogs and
optional scrollbars - EmacsFrame widget (custom, in
<code>widget.c</code>)</p>
<p><strong>Motif/LessTif</strong>: - Motif widgets for menus, dialogs,
file panels - More native look but larger dependency</p>
<p><strong>Window Hierarchy</strong>:</p>
<pre><code>Outer Widget (ApplicationShell)
  ‚îî‚îÄ‚îÄ Menu Bar Widget (optional)
  ‚îî‚îÄ‚îÄ Edit Widget (EmacsFrame)
      ‚îî‚îÄ‚îÄ Drawing area for buffer display</code></pre>
<p><strong>Key Macros</strong>: - <code>FRAME_OUTER_WINDOW(f)</code>:
Top-level shell window - <code>FRAME_X_WINDOW(f)</code>: Edit widget
window (where drawing happens) - <code>FRAME_MENUBAR_WINDOW(f)</code>:
Menu bar widget window</p>
<p><strong>Special Considerations</strong>: - Properties for WM must be
set on outer widget - Drawing operations target edit widget - Menu bar
events require special redirection - Complex event dispatch through Xt
event loop</p>
<h4 data-number="19.2.3.3" id="gtk-configuration"><span class="header-section-number">19.2.3.3</span> GTK Configuration</h4>
<p><strong>GTK+ 2 and GTK 3 Support</strong>: - Full GTK widget set for
all UI elements - Menu bars, toolbars, dialogs, file choosers - GtkFixed
container for edit area - May use client-side decorations (GTK3)</p>
<p><strong>Window Structure</strong>:</p>
<pre><code>GtkWindow (may not be real X window in GTK3)
  ‚îî‚îÄ‚îÄ GtkFixed widget
      ‚îî‚îÄ‚îÄ FRAME_X_WINDOW: outer window for drawing</code></pre>
<p><strong>Special Features</strong>: - CSS styling support (GTK3) -
Native file choosers and dialogs - Better desktop integration -
Complications with client-side windows</p>
<p><strong>Event Handling</strong>: - Events come through GTK callback
system - <code>handle_one_xevent()</code> called from GTK event handlers
- <code>*finish</code> parameter for safe GTK event processing</p>
<h3 data-number="19.2.4" id="font-backends"><span class="header-section-number">19.2.4</span> 1.4 Font Backends</h3>
<p>Emacs X11 supports multiple font backends with automatic
fallback:</p>
<h4 data-number="19.2.4.1" id="core-x-fonts-xfont.c"><span class="header-section-number">19.2.4.1</span> Core X Fonts
(xfont.c)</h4>
<p><strong>Legacy bitmap and scalable fonts using core X11
protocol</strong></p>
<div class="sourceCode" id="cb675"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb675-1"><a aria-hidden="true" href="#cb675-1" tabindex="-1"></a><span class="kw">struct</span> xfont_info <span class="op">{</span></span>
<span id="cb675-2"><a aria-hidden="true" href="#cb675-2" tabindex="-1"></a>  <span class="kw">struct</span> font font<span class="op">;</span></span>
<span id="cb675-3"><a aria-hidden="true" href="#cb675-3" tabindex="-1"></a>  Display <span class="op">*</span>display<span class="op">;</span></span>
<span id="cb675-4"><a aria-hidden="true" href="#cb675-4" tabindex="-1"></a>  XFontStruct <span class="op">*</span>xfont<span class="op">;</span></span>
<span id="cb675-5"><a aria-hidden="true" href="#cb675-5" tabindex="-1"></a>  <span class="dt">unsigned</span> x_display_id<span class="op">;</span></span>
<span id="cb675-6"><a aria-hidden="true" href="#cb675-6" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<p><strong>Characteristics</strong>: - XLFD (X Logical Font Description)
naming - Server-side font storage - XFontStruct provides metrics -
Limited Unicode support - Mostly deprecated but still available</p>
<p><strong>Font Selection</strong>:</p>
<div class="sourceCode" id="cb676"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb676-1"><a aria-hidden="true" href="#cb676-1" tabindex="-1"></a><span class="co">/* XLFD pattern example:</span></span>
<span id="cb676-2"><a aria-hidden="true" href="#cb676-2" tabindex="-1"></a><span class="co"> * -misc-fixed-medium-r-normal--13-120-75-75-c-70-iso8859-1</span></span>
<span id="cb676-3"><a aria-hidden="true" href="#cb676-3" tabindex="-1"></a><span class="co"> */</span></span></code></pre></div>
<h4 data-number="19.2.4.2" id="xftfreetype-backend-xftfont.c"><span class="header-section-number">19.2.4.2</span> Xft/FreeType Backend
(xftfont.c)</h4>
<p><strong>Modern client-side font rendering with FreeType</strong></p>
<div class="sourceCode" id="cb677"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb677-1"><a aria-hidden="true" href="#cb677-1" tabindex="-1"></a><span class="kw">struct</span> xftface_info <span class="op">{</span></span>
<span id="cb677-2"><a aria-hidden="true" href="#cb677-2" tabindex="-1"></a>  <span class="dt">bool</span> bg_allocated_p<span class="op">;</span></span>
<span id="cb677-3"><a aria-hidden="true" href="#cb677-3" tabindex="-1"></a>  <span class="dt">bool</span> fg_allocated_p<span class="op">;</span></span>
<span id="cb677-4"><a aria-hidden="true" href="#cb677-4" tabindex="-1"></a>  XftColor xft_fg<span class="op">;</span></span>
<span id="cb677-5"><a aria-hidden="true" href="#cb677-5" tabindex="-1"></a>  XftColor xft_bg<span class="op">;</span></span>
<span id="cb677-6"><a aria-hidden="true" href="#cb677-6" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<p><strong>Features</strong>: - Client-side rendering using FreeType -
Full Unicode support via fontconfig - Antialiasing and hinting -
Subpixel rendering (ClearType-style) - Automatic font substitution and
fallback - Complex text shaping (via HarfBuzz integration)</p>
<p><strong>Rendering Pipeline</strong>: 1. Query fontconfig for font
matching pattern 2. Open font via FreeType 3. Allocate XftColors for
foreground/background 4. Create XftDraw context for target window 5. Use
<code>XftDrawStringUtf8()</code> or shaped glyphs 6. Optionally use
XRender for compositing</p>
<p><strong>XRENDER Integration</strong>:</p>
<div class="sourceCode" id="cb678"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb678-1"><a aria-hidden="true" href="#cb678-1" tabindex="-1"></a><span class="pp">#ifdef HAVE_XRENDER</span></span>
<span id="cb678-2"><a aria-hidden="true" href="#cb678-2" tabindex="-1"></a>  <span class="co">/* Use XRender for alpha blending and antialiasing */</span></span>
<span id="cb678-3"><a aria-hidden="true" href="#cb678-3" tabindex="-1"></a>  XRenderPictFormat <span class="op">*</span>pict_format <span class="op">=</span> dpyinfo<span class="op">-&gt;</span>pict_format<span class="op">;</span></span>
<span id="cb678-4"><a aria-hidden="true" href="#cb678-4" tabindex="-1"></a>  <span class="co">/* Supports proper alpha channel handling */</span></span>
<span id="cb678-5"><a aria-hidden="true" href="#cb678-5" tabindex="-1"></a><span class="pp">#endif</span></span></code></pre></div>
<h4 data-number="19.2.4.3" id="font-driver-selection"><span class="header-section-number">19.2.4.3</span> Font Driver Selection</h4>
<p>Priority order (first available is used): 1. <strong>Xft</strong> (if
<code>HAVE_XFT</code> defined) - preferred for modern systems 2.
<strong>X Core</strong> (always available) - fallback for old
systems</p>
<p>Applications can force font backend via:</p>
<pre class="elisp"><code>(set-frame-font "xft:Monospace-10")  ; Force Xft
(set-frame-font "fixed")              ; Use core X font</code></pre>
<h2 data-number="19.3" id="graphics-and-rendering"><span class="header-section-number">19.3</span> 2. Graphics and Rendering</h2>
<h3 data-number="19.3.1" id="graphics-contexts-1"><span class="header-section-number">19.3.1</span> 2.1 Graphics Contexts</h3>
<p><strong>Graphics Contexts (GCs)</strong> are X server-side objects
containing drawing attributes. Unlike other window systems, GCs are
fundamental to X11.</p>
<h4 data-number="19.3.1.1" id="gc-types-in-emacs"><span class="header-section-number">19.3.1.1</span> GC Types in Emacs</h4>
<div class="sourceCode" id="cb680"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb680-1"><a aria-hidden="true" href="#cb680-1" tabindex="-1"></a><span class="co">/* From struct x_output in xterm.h */</span></span>
<span id="cb680-2"><a aria-hidden="true" href="#cb680-2" tabindex="-1"></a><span class="kw">struct</span> x_output <span class="op">{</span></span>
<span id="cb680-3"><a aria-hidden="true" href="#cb680-3" tabindex="-1"></a>  <span class="co">/* Standard GCs for common operations */</span></span>
<span id="cb680-4"><a aria-hidden="true" href="#cb680-4" tabindex="-1"></a>  GC normal_gc<span class="op">;</span>        <span class="co">/* Default face colors */</span></span>
<span id="cb680-5"><a aria-hidden="true" href="#cb680-5" tabindex="-1"></a>  GC reverse_gc<span class="op">;</span>       <span class="co">/* Inverted colors */</span></span>
<span id="cb680-6"><a aria-hidden="true" href="#cb680-6" tabindex="-1"></a>  GC cursor_gc<span class="op">;</span>        <span class="co">/* Cursor in default face */</span></span>
<span id="cb680-7"><a aria-hidden="true" href="#cb680-7" tabindex="-1"></a></span>
<span id="cb680-8"><a aria-hidden="true" href="#cb680-8" tabindex="-1"></a>  <span class="co">/* Special purpose GCs */</span></span>
<span id="cb680-9"><a aria-hidden="true" href="#cb680-9" tabindex="-1"></a>  GC white_relief_gc<span class="op">;</span>  <span class="co">/* For 3D relief effects */</span></span>
<span id="cb680-10"><a aria-hidden="true" href="#cb680-10" tabindex="-1"></a>  GC black_relief_gc<span class="op">;</span></span>
<span id="cb680-11"><a aria-hidden="true" href="#cb680-11" tabindex="-1"></a>  GC relief_background<span class="op">;</span></span>
<span id="cb680-12"><a aria-hidden="true" href="#cb680-12" tabindex="-1"></a></span>
<span id="cb680-13"><a aria-hidden="true" href="#cb680-13" tabindex="-1"></a>  <span class="co">/* Other drawing state... */</span></span>
<span id="cb680-14"><a aria-hidden="true" href="#cb680-14" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<h4 data-number="19.3.1.2" id="gc-creation-and-management"><span class="header-section-number">19.3.1.2</span> GC Creation and
Management</h4>
<p><strong>Initial GC Setup</strong> (in <code>x_make_gc</code> from
<code>xfns.c</code>):</p>
<div class="sourceCode" id="cb681"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb681-1"><a aria-hidden="true" href="#cb681-1" tabindex="-1"></a><span class="dt">void</span> x_make_gc<span class="op">(</span><span class="kw">struct</span> frame <span class="op">*</span>f<span class="op">)</span></span>
<span id="cb681-2"><a aria-hidden="true" href="#cb681-2" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb681-3"><a aria-hidden="true" href="#cb681-3" tabindex="-1"></a>  XGCValues gc_values<span class="op">;</span></span>
<span id="cb681-4"><a aria-hidden="true" href="#cb681-4" tabindex="-1"></a></span>
<span id="cb681-5"><a aria-hidden="true" href="#cb681-5" tabindex="-1"></a>  <span class="co">/* Normal GC - foreground and background from default face */</span></span>
<span id="cb681-6"><a aria-hidden="true" href="#cb681-6" tabindex="-1"></a>  gc_values<span class="op">.</span>foreground <span class="op">=</span> FRAME_FOREGROUND_PIXEL<span class="op">(</span>f<span class="op">);</span></span>
<span id="cb681-7"><a aria-hidden="true" href="#cb681-7" tabindex="-1"></a>  gc_values<span class="op">.</span>background <span class="op">=</span> FRAME_BACKGROUND_PIXEL<span class="op">(</span>f<span class="op">);</span></span>
<span id="cb681-8"><a aria-hidden="true" href="#cb681-8" tabindex="-1"></a>  gc_values<span class="op">.</span>font <span class="op">=</span> FRAME_FONT<span class="op">(</span>f<span class="op">)-&gt;</span>fid<span class="op">;</span>  <span class="co">/* If using core X fonts */</span></span>
<span id="cb681-9"><a aria-hidden="true" href="#cb681-9" tabindex="-1"></a>  f<span class="op">-&gt;</span>output_data<span class="op">.</span>x<span class="op">-&gt;</span>normal_gc <span class="op">=</span></span>
<span id="cb681-10"><a aria-hidden="true" href="#cb681-10" tabindex="-1"></a>    XCreateGC<span class="op">(</span>FRAME_X_DISPLAY<span class="op">(</span>f<span class="op">),</span> FRAME_X_WINDOW<span class="op">(</span>f<span class="op">),</span></span>
<span id="cb681-11"><a aria-hidden="true" href="#cb681-11" tabindex="-1"></a>              GCForeground <span class="op">|</span> GCBackground <span class="op">|</span> GCFont<span class="op">,</span> <span class="op">&amp;</span>gc_values<span class="op">);</span></span>
<span id="cb681-12"><a aria-hidden="true" href="#cb681-12" tabindex="-1"></a></span>
<span id="cb681-13"><a aria-hidden="true" href="#cb681-13" tabindex="-1"></a>  <span class="co">/* Reverse GC - swapped colors */</span></span>
<span id="cb681-14"><a aria-hidden="true" href="#cb681-14" tabindex="-1"></a>  gc_values<span class="op">.</span>foreground <span class="op">=</span> FRAME_BACKGROUND_PIXEL<span class="op">(</span>f<span class="op">);</span></span>
<span id="cb681-15"><a aria-hidden="true" href="#cb681-15" tabindex="-1"></a>  gc_values<span class="op">.</span>background <span class="op">=</span> FRAME_FOREGROUND_PIXEL<span class="op">(</span>f<span class="op">);</span></span>
<span id="cb681-16"><a aria-hidden="true" href="#cb681-16" tabindex="-1"></a>  f<span class="op">-&gt;</span>output_data<span class="op">.</span>x<span class="op">-&gt;</span>reverse_gc <span class="op">=</span></span>
<span id="cb681-17"><a aria-hidden="true" href="#cb681-17" tabindex="-1"></a>    XCreateGC<span class="op">(</span>FRAME_X_DISPLAY<span class="op">(</span>f<span class="op">),</span> FRAME_X_WINDOW<span class="op">(</span>f<span class="op">),</span></span>
<span id="cb681-18"><a aria-hidden="true" href="#cb681-18" tabindex="-1"></a>              GCForeground <span class="op">|</span> GCBackground <span class="op">|</span> GCFont<span class="op">,</span> <span class="op">&amp;</span>gc_values<span class="op">);</span></span>
<span id="cb681-19"><a aria-hidden="true" href="#cb681-19" tabindex="-1"></a></span>
<span id="cb681-20"><a aria-hidden="true" href="#cb681-20" tabindex="-1"></a>  <span class="co">/* Cursor GC... */</span></span>
<span id="cb681-21"><a aria-hidden="true" href="#cb681-21" tabindex="-1"></a>  <span class="co">/* Relief GCs... */</span></span>
<span id="cb681-22"><a aria-hidden="true" href="#cb681-22" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h4 data-number="19.3.1.3" id="per-face-gc-computation"><span class="header-section-number">19.3.1.3</span> Per-Face GC
Computation</h4>
<p><strong>Face GC Preparation</strong> (in
<code>prepare_face_for_display</code> from <code>xfaces.c</code>):</p>
<div class="sourceCode" id="cb682"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb682-1"><a aria-hidden="true" href="#cb682-1" tabindex="-1"></a><span class="co">/* Each face gets a GC computed when first displayed */</span></span>
<span id="cb682-2"><a aria-hidden="true" href="#cb682-2" tabindex="-1"></a><span class="dt">void</span> prepare_face_for_display<span class="op">(</span><span class="kw">struct</span> frame <span class="op">*</span>f<span class="op">,</span> <span class="kw">struct</span> face <span class="op">*</span>face<span class="op">)</span></span>
<span id="cb682-3"><a aria-hidden="true" href="#cb682-3" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb682-4"><a aria-hidden="true" href="#cb682-4" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>face<span class="op">-&gt;</span>gc <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb682-5"><a aria-hidden="true" href="#cb682-5" tabindex="-1"></a>    XGCValues xgcv<span class="op">;</span></span>
<span id="cb682-6"><a aria-hidden="true" href="#cb682-6" tabindex="-1"></a>    <span class="dt">unsigned</span> <span class="dt">long</span> mask <span class="op">=</span> GCForeground <span class="op">|</span> GCBackground<span class="op">;</span></span>
<span id="cb682-7"><a aria-hidden="true" href="#cb682-7" tabindex="-1"></a></span>
<span id="cb682-8"><a aria-hidden="true" href="#cb682-8" tabindex="-1"></a>    xgcv<span class="op">.</span>foreground <span class="op">=</span> face<span class="op">-&gt;</span>foreground<span class="op">;</span></span>
<span id="cb682-9"><a aria-hidden="true" href="#cb682-9" tabindex="-1"></a>    xgcv<span class="op">.</span>background <span class="op">=</span> face<span class="op">-&gt;</span>background<span class="op">;</span></span>
<span id="cb682-10"><a aria-hidden="true" href="#cb682-10" tabindex="-1"></a></span>
<span id="cb682-11"><a aria-hidden="true" href="#cb682-11" tabindex="-1"></a>    <span class="co">/* Add font if using core X fonts */</span></span>
<span id="cb682-12"><a aria-hidden="true" href="#cb682-12" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>face<span class="op">-&gt;</span>font<span class="op">)</span> <span class="op">{</span></span>
<span id="cb682-13"><a aria-hidden="true" href="#cb682-13" tabindex="-1"></a>      xgcv<span class="op">.</span>font <span class="op">=</span> face<span class="op">-&gt;</span>font<span class="op">-&gt;</span>fid<span class="op">;</span></span>
<span id="cb682-14"><a aria-hidden="true" href="#cb682-14" tabindex="-1"></a>      mask <span class="op">|=</span> GCFont<span class="op">;</span></span>
<span id="cb682-15"><a aria-hidden="true" href="#cb682-15" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb682-16"><a aria-hidden="true" href="#cb682-16" tabindex="-1"></a></span>
<span id="cb682-17"><a aria-hidden="true" href="#cb682-17" tabindex="-1"></a>    <span class="co">/* Add graphics exposures control */</span></span>
<span id="cb682-18"><a aria-hidden="true" href="#cb682-18" tabindex="-1"></a>    xgcv<span class="op">.</span>graphics_exposures <span class="op">=</span> False<span class="op">;</span></span>
<span id="cb682-19"><a aria-hidden="true" href="#cb682-19" tabindex="-1"></a>    mask <span class="op">|=</span> GCGraphicsExposures<span class="op">;</span></span>
<span id="cb682-20"><a aria-hidden="true" href="#cb682-20" tabindex="-1"></a></span>
<span id="cb682-21"><a aria-hidden="true" href="#cb682-21" tabindex="-1"></a>    face<span class="op">-&gt;</span>gc <span class="op">=</span> XCreateGC<span class="op">(</span>FRAME_X_DISPLAY<span class="op">(</span>f<span class="op">),</span> FRAME_X_WINDOW<span class="op">(</span>f<span class="op">),</span></span>
<span id="cb682-22"><a aria-hidden="true" href="#cb682-22" tabindex="-1"></a>                         mask<span class="op">,</span> <span class="op">&amp;</span>xgcv<span class="op">);</span></span>
<span id="cb682-23"><a aria-hidden="true" href="#cb682-23" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb682-24"><a aria-hidden="true" href="#cb682-24" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h4 data-number="19.3.1.4" id="dynamic-gc-modification"><span class="header-section-number">19.3.1.4</span> Dynamic GC
Modification</h4>
<p>For special rendering (cursor, mouse highlight), GCs are modified
temporarily:</p>
<div class="sourceCode" id="cb683"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb683-1"><a aria-hidden="true" href="#cb683-1" tabindex="-1"></a><span class="co">/* In x_set_glyph_string_gc from xterm.c */</span></span>
<span id="cb683-2"><a aria-hidden="true" href="#cb683-2" tabindex="-1"></a><span class="dt">void</span> x_set_glyph_string_gc<span class="op">(</span><span class="kw">struct</span> glyph_string <span class="op">*</span>s<span class="op">)</span></span>
<span id="cb683-3"><a aria-hidden="true" href="#cb683-3" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb683-4"><a aria-hidden="true" href="#cb683-4" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>s<span class="op">-&gt;</span>hl <span class="op">==</span> DRAW_CURSOR<span class="op">)</span> <span class="op">{</span></span>
<span id="cb683-5"><a aria-hidden="true" href="#cb683-5" tabindex="-1"></a>    <span class="co">/* Drawing cursor - may need custom GC */</span></span>
<span id="cb683-6"><a aria-hidden="true" href="#cb683-6" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span><span class="co">/* cursor is in non-default face */</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb683-7"><a aria-hidden="true" href="#cb683-7" tabindex="-1"></a>      <span class="co">/* Create temporary GC with adjusted colors */</span></span>
<span id="cb683-8"><a aria-hidden="true" href="#cb683-8" tabindex="-1"></a>      XGCValues xgcv<span class="op">;</span></span>
<span id="cb683-9"><a aria-hidden="true" href="#cb683-9" tabindex="-1"></a>      xgcv<span class="op">.</span>foreground <span class="op">=</span> cursor_fg<span class="op">;</span></span>
<span id="cb683-10"><a aria-hidden="true" href="#cb683-10" tabindex="-1"></a>      xgcv<span class="op">.</span>background <span class="op">=</span> cursor_bg<span class="op">;</span></span>
<span id="cb683-11"><a aria-hidden="true" href="#cb683-11" tabindex="-1"></a>      s<span class="op">-&gt;</span>gc <span class="op">=</span> XCreateGC<span class="op">(</span>s<span class="op">-&gt;</span>display<span class="op">,</span> s<span class="op">-&gt;</span>window<span class="op">,</span></span>
<span id="cb683-12"><a aria-hidden="true" href="#cb683-12" tabindex="-1"></a>                        GCForeground <span class="op">|</span> GCBackground<span class="op">,</span> <span class="op">&amp;</span>xgcv<span class="op">);</span></span>
<span id="cb683-13"><a aria-hidden="true" href="#cb683-13" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb683-14"><a aria-hidden="true" href="#cb683-14" tabindex="-1"></a>      <span class="co">/* Use standard cursor GC */</span></span>
<span id="cb683-15"><a aria-hidden="true" href="#cb683-15" tabindex="-1"></a>      s<span class="op">-&gt;</span>gc <span class="op">=</span> s<span class="op">-&gt;</span>f<span class="op">-&gt;</span>output_data<span class="op">.</span>x<span class="op">-&gt;</span>cursor_gc<span class="op">;</span></span>
<span id="cb683-16"><a aria-hidden="true" href="#cb683-16" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb683-17"><a aria-hidden="true" href="#cb683-17" tabindex="-1"></a>  <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb683-18"><a aria-hidden="true" href="#cb683-18" tabindex="-1"></a>    <span class="co">/* Use face's GC */</span></span>
<span id="cb683-19"><a aria-hidden="true" href="#cb683-19" tabindex="-1"></a>    s<span class="op">-&gt;</span>gc <span class="op">=</span> s<span class="op">-&gt;</span>face<span class="op">-&gt;</span>gc<span class="op">;</span></span>
<span id="cb683-20"><a aria-hidden="true" href="#cb683-20" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb683-21"><a aria-hidden="true" href="#cb683-21" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 data-number="19.3.2" id="color-allocation"><span class="header-section-number">19.3.2</span> 2.2 Color Allocation</h3>
<p>X11 color handling is unique due to visual classes and colormaps.</p>
<h4 data-number="19.3.2.1" id="visual-classes"><span class="header-section-number">19.3.2.1</span> Visual Classes</h4>
<div class="sourceCode" id="cb684"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb684-1"><a aria-hidden="true" href="#cb684-1" tabindex="-1"></a><span class="co">/* Visual class determines color allocation strategy */</span></span>
<span id="cb684-2"><a aria-hidden="true" href="#cb684-2" tabindex="-1"></a><span class="kw">enum</span> <span class="op">{</span></span>
<span id="cb684-3"><a aria-hidden="true" href="#cb684-3" tabindex="-1"></a>  TrueColor<span class="op">,</span>    <span class="co">/* Direct RGB mapping, most common on modern systems */</span></span>
<span id="cb684-4"><a aria-hidden="true" href="#cb684-4" tabindex="-1"></a>  DirectColor<span class="op">,</span>  <span class="co">/* Like TrueColor but with programmable color map */</span></span>
<span id="cb684-5"><a aria-hidden="true" href="#cb684-5" tabindex="-1"></a>  PseudoColor<span class="op">,</span>  <span class="co">/* 8-bit indexed color with dynamic allocation */</span></span>
<span id="cb684-6"><a aria-hidden="true" href="#cb684-6" tabindex="-1"></a>  StaticColor<span class="op">,</span>  <span class="co">/* 8-bit indexed color, predefined palette */</span></span>
<span id="cb684-7"><a aria-hidden="true" href="#cb684-7" tabindex="-1"></a>  GrayScale<span class="op">,</span>    <span class="co">/* Dynamic grayscale */</span></span>
<span id="cb684-8"><a aria-hidden="true" href="#cb684-8" tabindex="-1"></a>  StaticGray    <span class="co">/* Static grayscale */</span></span>
<span id="cb684-9"><a aria-hidden="true" href="#cb684-9" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<h4 data-number="19.3.2.2" id="truecolor-visual-modern-systems"><span class="header-section-number">19.3.2.2</span> TrueColor Visual (Modern
Systems)</h4>
<p><strong>Direct RGB pixel computation</strong>, no allocation
needed:</p>
<div class="sourceCode" id="cb685"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb685-1"><a aria-hidden="true" href="#cb685-1" tabindex="-1"></a><span class="co">/* From x_make_truecolor_pixel in xterm.c */</span></span>
<span id="cb685-2"><a aria-hidden="true" href="#cb685-2" tabindex="-1"></a><span class="dt">unsigned</span> <span class="dt">long</span> x_make_truecolor_pixel<span class="op">(</span>Display_Info <span class="op">*</span>dpyinfo<span class="op">,</span></span>
<span id="cb685-3"><a aria-hidden="true" href="#cb685-3" tabindex="-1"></a>                                     <span class="dt">int</span> r<span class="op">,</span> <span class="dt">int</span> g<span class="op">,</span> <span class="dt">int</span> b<span class="op">)</span></span>
<span id="cb685-4"><a aria-hidden="true" href="#cb685-4" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb685-5"><a aria-hidden="true" href="#cb685-5" tabindex="-1"></a>  <span class="dt">unsigned</span> <span class="dt">long</span> pixel<span class="op">;</span></span>
<span id="cb685-6"><a aria-hidden="true" href="#cb685-6" tabindex="-1"></a>  <span class="dt">unsigned</span> <span class="dt">long</span> red_mult<span class="op">,</span> green_mult<span class="op">,</span> blue_mult<span class="op">;</span></span>
<span id="cb685-7"><a aria-hidden="true" href="#cb685-7" tabindex="-1"></a>  <span class="dt">int</span> red_shift<span class="op">,</span> green_shift<span class="op">,</span> blue_shift<span class="op">;</span></span>
<span id="cb685-8"><a aria-hidden="true" href="#cb685-8" tabindex="-1"></a></span>
<span id="cb685-9"><a aria-hidden="true" href="#cb685-9" tabindex="-1"></a>  <span class="co">/* Extract shift and multiplier from visual masks */</span></span>
<span id="cb685-10"><a aria-hidden="true" href="#cb685-10" tabindex="-1"></a>  <span class="co">/* For typical 24-bit TrueColor: R=0xFF0000, G=0x00FF00, B=0x0000FF */</span></span>
<span id="cb685-11"><a aria-hidden="true" href="#cb685-11" tabindex="-1"></a></span>
<span id="cb685-12"><a aria-hidden="true" href="#cb685-12" tabindex="-1"></a>  pixel <span class="op">=</span> <span class="op">(((</span>r <span class="op">*</span> red_mult<span class="op">)</span> <span class="op">&gt;&gt;</span> <span class="dv">8</span><span class="op">)</span> <span class="op">&lt;&lt;</span> red_shift<span class="op">)</span></span>
<span id="cb685-13"><a aria-hidden="true" href="#cb685-13" tabindex="-1"></a>        <span class="op">|</span> <span class="op">(((</span>g <span class="op">*</span> green_mult<span class="op">)</span> <span class="op">&gt;&gt;</span> <span class="dv">8</span><span class="op">)</span> <span class="op">&lt;&lt;</span> green_shift<span class="op">)</span></span>
<span id="cb685-14"><a aria-hidden="true" href="#cb685-14" tabindex="-1"></a>        <span class="op">|</span> <span class="op">(((</span>b <span class="op">*</span> blue_mult<span class="op">)</span> <span class="op">&gt;&gt;</span> <span class="dv">8</span><span class="op">)</span> <span class="op">&lt;&lt;</span> blue_shift<span class="op">);</span></span>
<span id="cb685-15"><a aria-hidden="true" href="#cb685-15" tabindex="-1"></a></span>
<span id="cb685-16"><a aria-hidden="true" href="#cb685-16" tabindex="-1"></a>  <span class="cf">return</span> pixel<span class="op">;</span></span>
<span id="cb685-17"><a aria-hidden="true" href="#cb685-17" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h4 data-number="19.3.2.3" id="non-truecolor-visuals-legacy-systems"><span class="header-section-number">19.3.2.3</span> Non-TrueColor Visuals
(Legacy Systems)</h4>
<p><strong>Requires explicit color allocation</strong>:</p>
<div class="sourceCode" id="cb686"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb686-1"><a aria-hidden="true" href="#cb686-1" tabindex="-1"></a><span class="co">/* From x_alloc_nearest_color_1 in xterm.c */</span></span>
<span id="cb686-2"><a aria-hidden="true" href="#cb686-2" tabindex="-1"></a><span class="dt">bool</span> x_alloc_nearest_color_1<span class="op">(</span>Display <span class="op">*</span>dpy<span class="op">,</span> Colormap cmap<span class="op">,</span> XColor <span class="op">*</span>color<span class="op">)</span></span>
<span id="cb686-3"><a aria-hidden="true" href="#cb686-3" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb686-4"><a aria-hidden="true" href="#cb686-4" tabindex="-1"></a>  <span class="co">/* Try to allocate exact color */</span></span>
<span id="cb686-5"><a aria-hidden="true" href="#cb686-5" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>XAllocColor<span class="op">(</span>dpy<span class="op">,</span> cmap<span class="op">,</span> color<span class="op">))</span></span>
<span id="cb686-6"><a aria-hidden="true" href="#cb686-6" tabindex="-1"></a>    <span class="cf">return</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb686-7"><a aria-hidden="true" href="#cb686-7" tabindex="-1"></a></span>
<span id="cb686-8"><a aria-hidden="true" href="#cb686-8" tabindex="-1"></a>  <span class="co">/* Allocation failed (colormap full), find closest existing color */</span></span>
<span id="cb686-9"><a aria-hidden="true" href="#cb686-9" tabindex="-1"></a>  XColor cells<span class="op">[</span><span class="dv">256</span><span class="op">];</span></span>
<span id="cb686-10"><a aria-hidden="true" href="#cb686-10" tabindex="-1"></a>  <span class="dt">int</span> ncolors <span class="op">=</span> DisplayCells<span class="op">(</span>dpy<span class="op">,</span> XScreenNumberOfScreen<span class="op">(</span>screen<span class="op">));</span></span>
<span id="cb686-11"><a aria-hidden="true" href="#cb686-11" tabindex="-1"></a></span>
<span id="cb686-12"><a aria-hidden="true" href="#cb686-12" tabindex="-1"></a>  <span class="co">/* Read all allocated colors */</span></span>
<span id="cb686-13"><a aria-hidden="true" href="#cb686-13" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> ncolors<span class="op">;</span> i<span class="op">++)</span></span>
<span id="cb686-14"><a aria-hidden="true" href="#cb686-14" tabindex="-1"></a>    cells<span class="op">[</span>i<span class="op">].</span>pixel <span class="op">=</span> i<span class="op">;</span></span>
<span id="cb686-15"><a aria-hidden="true" href="#cb686-15" tabindex="-1"></a>  XQueryColors<span class="op">(</span>dpy<span class="op">,</span> cmap<span class="op">,</span> cells<span class="op">,</span> ncolors<span class="op">);</span></span>
<span id="cb686-16"><a aria-hidden="true" href="#cb686-16" tabindex="-1"></a></span>
<span id="cb686-17"><a aria-hidden="true" href="#cb686-17" tabindex="-1"></a>  <span class="co">/* Find closest match using Euclidean distance in RGB space */</span></span>
<span id="cb686-18"><a aria-hidden="true" href="#cb686-18" tabindex="-1"></a>  <span class="dt">int</span> best <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb686-19"><a aria-hidden="true" href="#cb686-19" tabindex="-1"></a>  <span class="dt">unsigned</span> <span class="dt">long</span> min_distance <span class="op">=</span> ULONG_MAX<span class="op">;</span></span>
<span id="cb686-20"><a aria-hidden="true" href="#cb686-20" tabindex="-1"></a></span>
<span id="cb686-21"><a aria-hidden="true" href="#cb686-21" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> ncolors<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb686-22"><a aria-hidden="true" href="#cb686-22" tabindex="-1"></a>    <span class="dt">unsigned</span> <span class="dt">long</span> distance <span class="op">=</span></span>
<span id="cb686-23"><a aria-hidden="true" href="#cb686-23" tabindex="-1"></a>      <span class="op">(</span><span class="dt">long</span><span class="op">)(</span>color<span class="op">-&gt;</span>red <span class="op">-</span> cells<span class="op">[</span>i<span class="op">].</span>red<span class="op">)</span> <span class="op">*</span> <span class="op">(</span>color<span class="op">-&gt;</span>red <span class="op">-</span> cells<span class="op">[</span>i<span class="op">].</span>red<span class="op">)</span> <span class="op">+</span></span>
<span id="cb686-24"><a aria-hidden="true" href="#cb686-24" tabindex="-1"></a>      <span class="op">(</span><span class="dt">long</span><span class="op">)(</span>color<span class="op">-&gt;</span>green <span class="op">-</span> cells<span class="op">[</span>i<span class="op">].</span>green<span class="op">)</span> <span class="op">*</span> <span class="op">(</span>color<span class="op">-&gt;</span>green <span class="op">-</span> cells<span class="op">[</span>i<span class="op">].</span>green<span class="op">)</span> <span class="op">+</span></span>
<span id="cb686-25"><a aria-hidden="true" href="#cb686-25" tabindex="-1"></a>      <span class="op">(</span><span class="dt">long</span><span class="op">)(</span>color<span class="op">-&gt;</span>blue <span class="op">-</span> cells<span class="op">[</span>i<span class="op">].</span>blue<span class="op">)</span> <span class="op">*</span> <span class="op">(</span>color<span class="op">-&gt;</span>blue <span class="op">-</span> cells<span class="op">[</span>i<span class="op">].</span>blue<span class="op">);</span></span>
<span id="cb686-26"><a aria-hidden="true" href="#cb686-26" tabindex="-1"></a></span>
<span id="cb686-27"><a aria-hidden="true" href="#cb686-27" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>distance <span class="op">&lt;</span> min_distance<span class="op">)</span> <span class="op">{</span></span>
<span id="cb686-28"><a aria-hidden="true" href="#cb686-28" tabindex="-1"></a>      min_distance <span class="op">=</span> distance<span class="op">;</span></span>
<span id="cb686-29"><a aria-hidden="true" href="#cb686-29" tabindex="-1"></a>      best <span class="op">=</span> i<span class="op">;</span></span>
<span id="cb686-30"><a aria-hidden="true" href="#cb686-30" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb686-31"><a aria-hidden="true" href="#cb686-31" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb686-32"><a aria-hidden="true" href="#cb686-32" tabindex="-1"></a></span>
<span id="cb686-33"><a aria-hidden="true" href="#cb686-33" tabindex="-1"></a>  <span class="op">*</span>color <span class="op">=</span> cells<span class="op">[</span>best<span class="op">];</span></span>
<span id="cb686-34"><a aria-hidden="true" href="#cb686-34" tabindex="-1"></a>  <span class="cf">return</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb686-35"><a aria-hidden="true" href="#cb686-35" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h4 data-number="19.3.2.4" id="color-management-strategy"><span class="header-section-number">19.3.2.4</span> Color Management
Strategy</h4>
<p><strong>Allocation Points</strong>: - Face realization (when face is
first displayed) - Frame foreground/background changes - Color property
changes</p>
<p><strong>Deallocation Points</strong>: - Face unrealization - Frame
destruction - Color property changes (old color freed)</p>
<p><strong>Functions</strong>: - <code>load_color()</code>: Allocate
pixel for RGB color - <code>unload_color()</code>: Free allocated color
cell - <code>x_query_colors()</code>: Get RGB values from pixel
values</p>
<h3 data-number="19.3.3" id="double-buffering"><span class="header-section-number">19.3.3</span> 2.3 Double Buffering</h3>
<p><strong>XDBE (X Double Buffer Extension)</strong> eliminates flicker
during redisplay.</p>
<h4 data-number="19.3.3.1" id="implementation"><span class="header-section-number">19.3.3.1</span> Implementation</h4>
<div class="sourceCode" id="cb687"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb687-1"><a aria-hidden="true" href="#cb687-1" tabindex="-1"></a><span class="co">/* From src/xterm.h */</span></span>
<span id="cb687-2"><a aria-hidden="true" href="#cb687-2" tabindex="-1"></a><span class="pp">#ifdef HAVE_XDBE</span></span>
<span id="cb687-3"><a aria-hidden="true" href="#cb687-3" tabindex="-1"></a><span class="pp">#define FRAME_X_DOUBLE_BUFFERED_P</span><span class="op">(</span><span class="pp">f</span><span class="op">)</span><span class="pp"> </span><span class="op">\</span></span>
<span id="cb687-4"><a aria-hidden="true" href="#cb687-4" tabindex="-1"></a><span class="pp">  </span><span class="op">(</span><span class="pp">FRAME_X_WINDOW</span><span class="op">(</span><span class="pp">f</span><span class="op">)</span><span class="pp"> </span><span class="op">!=</span><span class="pp"> FRAME_X_RAW_DRAWABLE</span><span class="op">(</span><span class="pp">f</span><span class="op">))</span></span>
<span id="cb687-5"><a aria-hidden="true" href="#cb687-5" tabindex="-1"></a></span>
<span id="cb687-6"><a aria-hidden="true" href="#cb687-6" tabindex="-1"></a><span class="co">/* FRAME_X_WINDOW(f)        - Front buffer (visible window)</span></span>
<span id="cb687-7"><a aria-hidden="true" href="#cb687-7" tabindex="-1"></a><span class="co"> * FRAME_X_RAW_DRAWABLE(f)  - Back buffer (XdbeBackBuffer)</span></span>
<span id="cb687-8"><a aria-hidden="true" href="#cb687-8" tabindex="-1"></a><span class="co"> * Drawing always happens to back buffer</span></span>
<span id="cb687-9"><a aria-hidden="true" href="#cb687-9" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb687-10"><a aria-hidden="true" href="#cb687-10" tabindex="-1"></a><span class="pp">#endif</span></span></code></pre></div>
<h4 data-number="19.3.3.2" id="buffer-setup-in-x_window-from-xfns.c"><span class="header-section-number">19.3.3.2</span> Buffer Setup (in
<code>x_window</code> from <code>xfns.c</code>)</h4>
<div class="sourceCode" id="cb688"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb688-1"><a aria-hidden="true" href="#cb688-1" tabindex="-1"></a><span class="pp">#ifdef HAVE_XDBE</span></span>
<span id="cb688-2"><a aria-hidden="true" href="#cb688-2" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>use_xdbe<span class="op">)</span> <span class="op">{</span></span>
<span id="cb688-3"><a aria-hidden="true" href="#cb688-3" tabindex="-1"></a>    XdbeBackBuffer back_buffer<span class="op">;</span></span>
<span id="cb688-4"><a aria-hidden="true" href="#cb688-4" tabindex="-1"></a>    back_buffer <span class="op">=</span> XdbeAllocateBackBufferName<span class="op">(</span></span>
<span id="cb688-5"><a aria-hidden="true" href="#cb688-5" tabindex="-1"></a>      FRAME_X_DISPLAY<span class="op">(</span>f<span class="op">),</span></span>
<span id="cb688-6"><a aria-hidden="true" href="#cb688-6" tabindex="-1"></a>      FRAME_X_WINDOW<span class="op">(</span>f<span class="op">),</span></span>
<span id="cb688-7"><a aria-hidden="true" href="#cb688-7" tabindex="-1"></a>      XdbeBackground  <span class="co">/* Swap action: undefined -&gt; background */</span></span>
<span id="cb688-8"><a aria-hidden="true" href="#cb688-8" tabindex="-1"></a>    <span class="op">);</span></span>
<span id="cb688-9"><a aria-hidden="true" href="#cb688-9" tabindex="-1"></a></span>
<span id="cb688-10"><a aria-hidden="true" href="#cb688-10" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>back_buffer <span class="op">!=</span> None<span class="op">)</span> <span class="op">{</span></span>
<span id="cb688-11"><a aria-hidden="true" href="#cb688-11" tabindex="-1"></a>      f<span class="op">-&gt;</span>output_data<span class="op">.</span>x<span class="op">-&gt;</span>xdbe_back_buffer <span class="op">=</span> back_buffer<span class="op">;</span></span>
<span id="cb688-12"><a aria-hidden="true" href="#cb688-12" tabindex="-1"></a>      <span class="co">/* All drawing operations now target back_buffer */</span></span>
<span id="cb688-13"><a aria-hidden="true" href="#cb688-13" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb688-14"><a aria-hidden="true" href="#cb688-14" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb688-15"><a aria-hidden="true" href="#cb688-15" tabindex="-1"></a><span class="pp">#endif</span></span></code></pre></div>
<h4 data-number="19.3.3.3" id="rendering-cycle"><span class="header-section-number">19.3.3.3</span> Rendering Cycle</h4>
<div class="sourceCode" id="cb689"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb689-1"><a aria-hidden="true" href="#cb689-1" tabindex="-1"></a><span class="co">/* From xterm.c */</span></span>
<span id="cb689-2"><a aria-hidden="true" href="#cb689-2" tabindex="-1"></a></span>
<span id="cb689-3"><a aria-hidden="true" href="#cb689-3" tabindex="-1"></a><span class="co">/* 1. Begin update - prepare back buffer */</span></span>
<span id="cb689-4"><a aria-hidden="true" href="#cb689-4" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> x_update_window_begin<span class="op">(</span><span class="kw">struct</span> window <span class="op">*</span>w<span class="op">)</span></span>
<span id="cb689-5"><a aria-hidden="true" href="#cb689-5" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb689-6"><a aria-hidden="true" href="#cb689-6" tabindex="-1"></a>  <span class="kw">struct</span> frame <span class="op">*</span>f <span class="op">=</span> XFRAME<span class="op">(</span>WINDOW_FRAME<span class="op">(</span>w<span class="op">));</span></span>
<span id="cb689-7"><a aria-hidden="true" href="#cb689-7" tabindex="-1"></a></span>
<span id="cb689-8"><a aria-hidden="true" href="#cb689-8" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>FRAME_X_DOUBLE_BUFFERED_P<span class="op">(</span>f<span class="op">))</span> <span class="op">{</span></span>
<span id="cb689-9"><a aria-hidden="true" href="#cb689-9" tabindex="-1"></a>    <span class="co">/* Back buffer already allocated, ready for drawing */</span></span>
<span id="cb689-10"><a aria-hidden="true" href="#cb689-10" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb689-11"><a aria-hidden="true" href="#cb689-11" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb689-12"><a aria-hidden="true" href="#cb689-12" tabindex="-1"></a></span>
<span id="cb689-13"><a aria-hidden="true" href="#cb689-13" tabindex="-1"></a><span class="co">/* 2. Draw operations - all target back buffer */</span></span>
<span id="cb689-14"><a aria-hidden="true" href="#cb689-14" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> x_draw_glyph_string<span class="op">(</span><span class="kw">struct</span> glyph_string <span class="op">*</span>s<span class="op">)</span></span>
<span id="cb689-15"><a aria-hidden="true" href="#cb689-15" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb689-16"><a aria-hidden="true" href="#cb689-16" tabindex="-1"></a>  <span class="co">/* All Xlib drawing calls (XFillRectangle, XDrawString, etc.)</span></span>
<span id="cb689-17"><a aria-hidden="true" href="#cb689-17" tabindex="-1"></a><span class="co">   * automatically use FRAME_X_DRAWABLE(f), which is the back buffer</span></span>
<span id="cb689-18"><a aria-hidden="true" href="#cb689-18" tabindex="-1"></a><span class="co">   * when double buffering is enabled</span></span>
<span id="cb689-19"><a aria-hidden="true" href="#cb689-19" tabindex="-1"></a><span class="co">   */</span></span>
<span id="cb689-20"><a aria-hidden="true" href="#cb689-20" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb689-21"><a aria-hidden="true" href="#cb689-21" tabindex="-1"></a></span>
<span id="cb689-22"><a aria-hidden="true" href="#cb689-22" tabindex="-1"></a><span class="co">/* 3. End update - swap buffers */</span></span>
<span id="cb689-23"><a aria-hidden="true" href="#cb689-23" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> x_update_window_end<span class="op">(</span><span class="kw">struct</span> window <span class="op">*</span>w<span class="op">,</span> <span class="dt">bool</span> cursor_on_p<span class="op">,</span></span>
<span id="cb689-24"><a aria-hidden="true" href="#cb689-24" tabindex="-1"></a>                                <span class="dt">bool</span> mouse_face_overwritten_p<span class="op">)</span></span>
<span id="cb689-25"><a aria-hidden="true" href="#cb689-25" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb689-26"><a aria-hidden="true" href="#cb689-26" tabindex="-1"></a>  <span class="kw">struct</span> frame <span class="op">*</span>f <span class="op">=</span> XFRAME<span class="op">(</span>WINDOW_FRAME<span class="op">(</span>w<span class="op">));</span></span>
<span id="cb689-27"><a aria-hidden="true" href="#cb689-27" tabindex="-1"></a></span>
<span id="cb689-28"><a aria-hidden="true" href="#cb689-28" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>FRAME_X_DOUBLE_BUFFERED_P<span class="op">(</span>f<span class="op">))</span> <span class="op">{</span></span>
<span id="cb689-29"><a aria-hidden="true" href="#cb689-29" tabindex="-1"></a>    <span class="co">/* Mark that buffer needs to be swapped */</span></span>
<span id="cb689-30"><a aria-hidden="true" href="#cb689-30" tabindex="-1"></a>    FRAME_X_NEED_BUFFER_FLIP<span class="op">(</span>f<span class="op">)</span> <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb689-31"><a aria-hidden="true" href="#cb689-31" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb689-32"><a aria-hidden="true" href="#cb689-32" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb689-33"><a aria-hidden="true" href="#cb689-33" tabindex="-1"></a></span>
<span id="cb689-34"><a aria-hidden="true" href="#cb689-34" tabindex="-1"></a><span class="co">/* 4. Show frame - perform actual swap */</span></span>
<span id="cb689-35"><a aria-hidden="true" href="#cb689-35" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> x_flush<span class="op">(</span><span class="kw">struct</span> frame <span class="op">*</span>f<span class="op">)</span></span>
<span id="cb689-36"><a aria-hidden="true" href="#cb689-36" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb689-37"><a aria-hidden="true" href="#cb689-37" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>FRAME_X_DOUBLE_BUFFERED_P<span class="op">(</span>f<span class="op">)</span> <span class="op">&amp;&amp;</span> FRAME_X_NEED_BUFFER_FLIP<span class="op">(</span>f<span class="op">))</span> <span class="op">{</span></span>
<span id="cb689-38"><a aria-hidden="true" href="#cb689-38" tabindex="-1"></a>    XdbeSwapInfo swap_info<span class="op">;</span></span>
<span id="cb689-39"><a aria-hidden="true" href="#cb689-39" tabindex="-1"></a>    swap_info<span class="op">.</span>swap_window <span class="op">=</span> FRAME_X_WINDOW<span class="op">(</span>f<span class="op">);</span></span>
<span id="cb689-40"><a aria-hidden="true" href="#cb689-40" tabindex="-1"></a>    swap_info<span class="op">.</span>swap_action <span class="op">=</span> XdbeBackground<span class="op">;</span></span>
<span id="cb689-41"><a aria-hidden="true" href="#cb689-41" tabindex="-1"></a></span>
<span id="cb689-42"><a aria-hidden="true" href="#cb689-42" tabindex="-1"></a>    XdbeSwapBuffers<span class="op">(</span>FRAME_X_DISPLAY<span class="op">(</span>f<span class="op">),</span> <span class="op">&amp;</span>swap_info<span class="op">,</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb689-43"><a aria-hidden="true" href="#cb689-43" tabindex="-1"></a>    FRAME_X_NEED_BUFFER_FLIP<span class="op">(</span>f<span class="op">)</span> <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb689-44"><a aria-hidden="true" href="#cb689-44" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb689-45"><a aria-hidden="true" href="#cb689-45" tabindex="-1"></a></span>
<span id="cb689-46"><a aria-hidden="true" href="#cb689-46" tabindex="-1"></a>  XFlush<span class="op">(</span>FRAME_X_DISPLAY<span class="op">(</span>f<span class="op">));</span></span>
<span id="cb689-47"><a aria-hidden="true" href="#cb689-47" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>Benefits</strong>: - Eliminates tearing and flicker - Clean
atomic updates - Allows partial redraws while maintaining consistency -
Slight memory overhead (second buffer)</p>
<h3 data-number="19.3.4" id="glyph-string-rendering"><span class="header-section-number">19.3.4</span> 2.4 Glyph String
Rendering</h3>
<p>The core rendering function is <code>x_draw_glyph_string</code> (in
<code>xterm.c</code>), called by the redisplay engine.</p>
<h4 data-number="19.3.4.1" id="glyph-string-structure"><span class="header-section-number">19.3.4.1</span> Glyph String
Structure</h4>
<div class="sourceCode" id="cb690"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb690-1"><a aria-hidden="true" href="#cb690-1" tabindex="-1"></a><span class="kw">struct</span> glyph_string <span class="op">{</span></span>
<span id="cb690-2"><a aria-hidden="true" href="#cb690-2" tabindex="-1"></a>  <span class="co">/* Display connection and target */</span></span>
<span id="cb690-3"><a aria-hidden="true" href="#cb690-3" tabindex="-1"></a>  Display <span class="op">*</span>display<span class="op">;</span></span>
<span id="cb690-4"><a aria-hidden="true" href="#cb690-4" tabindex="-1"></a>  Window window<span class="op">;</span></span>
<span id="cb690-5"><a aria-hidden="true" href="#cb690-5" tabindex="-1"></a></span>
<span id="cb690-6"><a aria-hidden="true" href="#cb690-6" tabindex="-1"></a>  <span class="co">/* Rendering area */</span></span>
<span id="cb690-7"><a aria-hidden="true" href="#cb690-7" tabindex="-1"></a>  <span class="dt">int</span> x<span class="op">,</span> y<span class="op">,</span> width<span class="op">,</span> height<span class="op">;</span></span>
<span id="cb690-8"><a aria-hidden="true" href="#cb690-8" tabindex="-1"></a>  <span class="dt">int</span> ybase<span class="op">;</span>  <span class="co">/* Baseline for text */</span></span>
<span id="cb690-9"><a aria-hidden="true" href="#cb690-9" tabindex="-1"></a></span>
<span id="cb690-10"><a aria-hidden="true" href="#cb690-10" tabindex="-1"></a>  <span class="co">/* Visual properties */</span></span>
<span id="cb690-11"><a aria-hidden="true" href="#cb690-11" tabindex="-1"></a>  <span class="kw">struct</span> face <span class="op">*</span>face<span class="op">;</span></span>
<span id="cb690-12"><a aria-hidden="true" href="#cb690-12" tabindex="-1"></a>  <span class="kw">struct</span> font <span class="op">*</span>font<span class="op">;</span></span>
<span id="cb690-13"><a aria-hidden="true" href="#cb690-13" tabindex="-1"></a>  GC gc<span class="op">;</span></span>
<span id="cb690-14"><a aria-hidden="true" href="#cb690-14" tabindex="-1"></a></span>
<span id="cb690-15"><a aria-hidden="true" href="#cb690-15" tabindex="-1"></a>  <span class="co">/* Content */</span></span>
<span id="cb690-16"><a aria-hidden="true" href="#cb690-16" tabindex="-1"></a>  <span class="kw">struct</span> glyph <span class="op">*</span>first_glyph<span class="op">;</span></span>
<span id="cb690-17"><a aria-hidden="true" href="#cb690-17" tabindex="-1"></a>  <span class="dt">int</span> nchars<span class="op">;</span></span>
<span id="cb690-18"><a aria-hidden="true" href="#cb690-18" tabindex="-1"></a>  <span class="dt">unsigned</span> <span class="op">*</span>char2b<span class="op">;</span>  <span class="co">/* Unicode characters */</span></span>
<span id="cb690-19"><a aria-hidden="true" href="#cb690-19" tabindex="-1"></a></span>
<span id="cb690-20"><a aria-hidden="true" href="#cb690-20" tabindex="-1"></a>  <span class="co">/* Rendering hints */</span></span>
<span id="cb690-21"><a aria-hidden="true" href="#cb690-21" tabindex="-1"></a>  <span class="kw">enum</span> draw_glyphs_face hl<span class="op">;</span>  <span class="co">/* DRAW_NORMAL, DRAW_CURSOR, etc. */</span></span>
<span id="cb690-22"><a aria-hidden="true" href="#cb690-22" tabindex="-1"></a>  <span class="dt">bool</span> background_filled_p<span class="op">;</span></span>
<span id="cb690-23"><a aria-hidden="true" href="#cb690-23" tabindex="-1"></a></span>
<span id="cb690-24"><a aria-hidden="true" href="#cb690-24" tabindex="-1"></a>  <span class="co">/* Clipping */</span></span>
<span id="cb690-25"><a aria-hidden="true" href="#cb690-25" tabindex="-1"></a>  XRectangle clip<span class="op">;</span></span>
<span id="cb690-26"><a aria-hidden="true" href="#cb690-26" tabindex="-1"></a>  <span class="dt">int</span> clip_head<span class="op">,</span> clip_tail<span class="op">;</span></span>
<span id="cb690-27"><a aria-hidden="true" href="#cb690-27" tabindex="-1"></a></span>
<span id="cb690-28"><a aria-hidden="true" href="#cb690-28" tabindex="-1"></a>  <span class="co">/* Links to adjacent strings */</span></span>
<span id="cb690-29"><a aria-hidden="true" href="#cb690-29" tabindex="-1"></a>  <span class="kw">struct</span> glyph_string <span class="op">*</span>next<span class="op">,</span> <span class="op">*</span>prev<span class="op">;</span></span>
<span id="cb690-30"><a aria-hidden="true" href="#cb690-30" tabindex="-1"></a></span>
<span id="cb690-31"><a aria-hidden="true" href="#cb690-31" tabindex="-1"></a>  <span class="co">/* Type-specific data */</span></span>
<span id="cb690-32"><a aria-hidden="true" href="#cb690-32" tabindex="-1"></a>  <span class="co">/* ... for images, stretch glyphs, etc. ... */</span></span>
<span id="cb690-33"><a aria-hidden="true" href="#cb690-33" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<h4 data-number="19.3.4.2" id="rendering-pipeline"><span class="header-section-number">19.3.4.2</span> Rendering Pipeline</h4>
<div class="sourceCode" id="cb691"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb691-1"><a aria-hidden="true" href="#cb691-1" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> x_draw_glyph_string<span class="op">(</span><span class="kw">struct</span> glyph_string <span class="op">*</span>s<span class="op">)</span></span>
<span id="cb691-2"><a aria-hidden="true" href="#cb691-2" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb691-3"><a aria-hidden="true" href="#cb691-3" tabindex="-1"></a>  <span class="dt">bool</span> relief_drawn_p <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb691-4"><a aria-hidden="true" href="#cb691-4" tabindex="-1"></a></span>
<span id="cb691-5"><a aria-hidden="true" href="#cb691-5" tabindex="-1"></a>  <span class="co">/* 1. Setup GC for this string */</span></span>
<span id="cb691-6"><a aria-hidden="true" href="#cb691-6" tabindex="-1"></a>  x_set_glyph_string_gc<span class="op">(</span>s<span class="op">);</span></span>
<span id="cb691-7"><a aria-hidden="true" href="#cb691-7" tabindex="-1"></a></span>
<span id="cb691-8"><a aria-hidden="true" href="#cb691-8" tabindex="-1"></a>  <span class="co">/* 2. Set clipping region */</span></span>
<span id="cb691-9"><a aria-hidden="true" href="#cb691-9" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>s<span class="op">-&gt;</span>clip_head <span class="op">||</span> s<span class="op">-&gt;</span>clip_tail<span class="op">)</span> <span class="op">{</span></span>
<span id="cb691-10"><a aria-hidden="true" href="#cb691-10" tabindex="-1"></a>    XRectangle clip_rect<span class="op">;</span></span>
<span id="cb691-11"><a aria-hidden="true" href="#cb691-11" tabindex="-1"></a>    <span class="co">/* Compute clip rectangle */</span></span>
<span id="cb691-12"><a aria-hidden="true" href="#cb691-12" tabindex="-1"></a>    XSetClipRectangles<span class="op">(</span>s<span class="op">-&gt;</span>display<span class="op">,</span> s<span class="op">-&gt;</span>gc<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="op">&amp;</span>clip_rect<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> Unsorted<span class="op">);</span></span>
<span id="cb691-13"><a aria-hidden="true" href="#cb691-13" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb691-14"><a aria-hidden="true" href="#cb691-14" tabindex="-1"></a></span>
<span id="cb691-15"><a aria-hidden="true" href="#cb691-15" tabindex="-1"></a>  <span class="co">/* 3. Fill background if needed */</span></span>
<span id="cb691-16"><a aria-hidden="true" href="#cb691-16" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>s<span class="op">-&gt;</span>background_filled_p<span class="op">)</span> <span class="op">{</span></span>
<span id="cb691-17"><a aria-hidden="true" href="#cb691-17" tabindex="-1"></a>    <span class="co">/* Background already filled, skip */</span></span>
<span id="cb691-18"><a aria-hidden="true" href="#cb691-18" tabindex="-1"></a>  <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span><span class="co">/* background needs filling */</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb691-19"><a aria-hidden="true" href="#cb691-19" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>s<span class="op">-&gt;</span>stippled_p<span class="op">)</span> <span class="op">{</span></span>
<span id="cb691-20"><a aria-hidden="true" href="#cb691-20" tabindex="-1"></a>      <span class="co">/* Fill with stipple pattern */</span></span>
<span id="cb691-21"><a aria-hidden="true" href="#cb691-21" tabindex="-1"></a>      XSetFillStyle<span class="op">(</span>s<span class="op">-&gt;</span>display<span class="op">,</span> s<span class="op">-&gt;</span>gc<span class="op">,</span> FillOpaqueStippled<span class="op">);</span></span>
<span id="cb691-22"><a aria-hidden="true" href="#cb691-22" tabindex="-1"></a>      XFillRectangle<span class="op">(</span>s<span class="op">-&gt;</span>display<span class="op">,</span> FRAME_X_DRAWABLE<span class="op">(</span>s<span class="op">-&gt;</span>f<span class="op">),</span></span>
<span id="cb691-23"><a aria-hidden="true" href="#cb691-23" tabindex="-1"></a>                     s<span class="op">-&gt;</span>gc<span class="op">,</span> s<span class="op">-&gt;</span>x<span class="op">,</span> s<span class="op">-&gt;</span>y<span class="op">,</span> s<span class="op">-&gt;</span>width<span class="op">,</span> s<span class="op">-&gt;</span>height<span class="op">);</span></span>
<span id="cb691-24"><a aria-hidden="true" href="#cb691-24" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb691-25"><a aria-hidden="true" href="#cb691-25" tabindex="-1"></a>      <span class="co">/* Solid color background */</span></span>
<span id="cb691-26"><a aria-hidden="true" href="#cb691-26" tabindex="-1"></a>      XSetForeground<span class="op">(</span>s<span class="op">-&gt;</span>display<span class="op">,</span> s<span class="op">-&gt;</span>gc<span class="op">,</span> s<span class="op">-&gt;</span>face<span class="op">-&gt;</span>background<span class="op">);</span></span>
<span id="cb691-27"><a aria-hidden="true" href="#cb691-27" tabindex="-1"></a>      XFillRectangle<span class="op">(</span>s<span class="op">-&gt;</span>display<span class="op">,</span> FRAME_X_DRAWABLE<span class="op">(</span>s<span class="op">-&gt;</span>f<span class="op">),</span></span>
<span id="cb691-28"><a aria-hidden="true" href="#cb691-28" tabindex="-1"></a>                     s<span class="op">-&gt;</span>gc<span class="op">,</span> s<span class="op">-&gt;</span>x<span class="op">,</span> s<span class="op">-&gt;</span>y<span class="op">,</span> s<span class="op">-&gt;</span>width<span class="op">,</span> s<span class="op">-&gt;</span>height<span class="op">);</span></span>
<span id="cb691-29"><a aria-hidden="true" href="#cb691-29" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb691-30"><a aria-hidden="true" href="#cb691-30" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb691-31"><a aria-hidden="true" href="#cb691-31" tabindex="-1"></a></span>
<span id="cb691-32"><a aria-hidden="true" href="#cb691-32" tabindex="-1"></a>  <span class="co">/* 4. Draw the actual content based on type */</span></span>
<span id="cb691-33"><a aria-hidden="true" href="#cb691-33" tabindex="-1"></a>  <span class="cf">switch</span> <span class="op">(</span>s<span class="op">-&gt;</span>first_glyph<span class="op">-&gt;</span>type<span class="op">)</span> <span class="op">{</span></span>
<span id="cb691-34"><a aria-hidden="true" href="#cb691-34" tabindex="-1"></a>    <span class="cf">case</span> CHAR_GLYPH<span class="op">:</span></span>
<span id="cb691-35"><a aria-hidden="true" href="#cb691-35" tabindex="-1"></a>      <span class="co">/* Text rendering */</span></span>
<span id="cb691-36"><a aria-hidden="true" href="#cb691-36" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span>s<span class="op">-&gt;</span>font <span class="op">==</span> s<span class="op">-&gt;</span>face<span class="op">-&gt;</span>font<span class="op">)</span> <span class="op">{</span></span>
<span id="cb691-37"><a aria-hidden="true" href="#cb691-37" tabindex="-1"></a>        <span class="co">/* Simple case: can use font directly */</span></span>
<span id="cb691-38"><a aria-hidden="true" href="#cb691-38" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>s<span class="op">-&gt;</span>font<span class="op">-&gt;</span>driver <span class="op">==</span> <span class="op">&amp;</span>xfont_driver<span class="op">)</span> <span class="op">{</span></span>
<span id="cb691-39"><a aria-hidden="true" href="#cb691-39" tabindex="-1"></a>          <span class="co">/* Core X font */</span></span>
<span id="cb691-40"><a aria-hidden="true" href="#cb691-40" tabindex="-1"></a>          XDrawString16<span class="op">(</span>s<span class="op">-&gt;</span>display<span class="op">,</span> FRAME_X_DRAWABLE<span class="op">(</span>s<span class="op">-&gt;</span>f<span class="op">),</span> s<span class="op">-&gt;</span>gc<span class="op">,</span></span>
<span id="cb691-41"><a aria-hidden="true" href="#cb691-41" tabindex="-1"></a>                       s<span class="op">-&gt;</span>x<span class="op">,</span> s<span class="op">-&gt;</span>ybase<span class="op">,</span> <span class="op">(</span>XChar2b <span class="op">*)</span>s<span class="op">-&gt;</span>char2b<span class="op">,</span> s<span class="op">-&gt;</span>nchars<span class="op">);</span></span>
<span id="cb691-42"><a aria-hidden="true" href="#cb691-42" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>s<span class="op">-&gt;</span>font<span class="op">-&gt;</span>driver <span class="op">==</span> <span class="op">&amp;</span>xftfont_driver<span class="op">)</span> <span class="op">{</span></span>
<span id="cb691-43"><a aria-hidden="true" href="#cb691-43" tabindex="-1"></a>          <span class="co">/* Xft font - client-side rendering */</span></span>
<span id="cb691-44"><a aria-hidden="true" href="#cb691-44" tabindex="-1"></a>          XftDraw <span class="op">*</span>xft_draw <span class="op">=</span> <span class="co">/* get or create XftDraw */</span><span class="op">;</span></span>
<span id="cb691-45"><a aria-hidden="true" href="#cb691-45" tabindex="-1"></a>          XftColor xft_color<span class="op">;</span></span>
<span id="cb691-46"><a aria-hidden="true" href="#cb691-46" tabindex="-1"></a>          XftDrawStringUtf8<span class="op">(</span>xft_draw<span class="op">,</span> <span class="op">&amp;</span>xft_color<span class="op">,</span> s<span class="op">-&gt;</span>font<span class="op">-&gt;</span>xft_font<span class="op">,</span></span>
<span id="cb691-47"><a aria-hidden="true" href="#cb691-47" tabindex="-1"></a>                           s<span class="op">-&gt;</span>x<span class="op">,</span> s<span class="op">-&gt;</span>ybase<span class="op">,</span> utf8_text<span class="op">,</span> utf8_len<span class="op">);</span></span>
<span id="cb691-48"><a aria-hidden="true" href="#cb691-48" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb691-49"><a aria-hidden="true" href="#cb691-49" tabindex="-1"></a>      <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb691-50"><a aria-hidden="true" href="#cb691-50" tabindex="-1"></a>        <span class="co">/* Fallback font needed - more complex */</span></span>
<span id="cb691-51"><a aria-hidden="true" href="#cb691-51" tabindex="-1"></a>        <span class="co">/* Draw character by character with appropriate fonts */</span></span>
<span id="cb691-52"><a aria-hidden="true" href="#cb691-52" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb691-53"><a aria-hidden="true" href="#cb691-53" tabindex="-1"></a>      <span class="cf">break</span><span class="op">;</span></span>
<span id="cb691-54"><a aria-hidden="true" href="#cb691-54" tabindex="-1"></a></span>
<span id="cb691-55"><a aria-hidden="true" href="#cb691-55" tabindex="-1"></a>    <span class="cf">case</span> IMAGE_GLYPH<span class="op">:</span></span>
<span id="cb691-56"><a aria-hidden="true" href="#cb691-56" tabindex="-1"></a>      <span class="co">/* Image rendering */</span></span>
<span id="cb691-57"><a aria-hidden="true" href="#cb691-57" tabindex="-1"></a>      x_draw_image_glyph_string<span class="op">(</span>s<span class="op">);</span></span>
<span id="cb691-58"><a aria-hidden="true" href="#cb691-58" tabindex="-1"></a>      <span class="cf">break</span><span class="op">;</span></span>
<span id="cb691-59"><a aria-hidden="true" href="#cb691-59" tabindex="-1"></a></span>
<span id="cb691-60"><a aria-hidden="true" href="#cb691-60" tabindex="-1"></a>    <span class="cf">case</span> STRETCH_GLYPH<span class="op">:</span></span>
<span id="cb691-61"><a aria-hidden="true" href="#cb691-61" tabindex="-1"></a>      <span class="co">/* Stretch space - just background (already filled) */</span></span>
<span id="cb691-62"><a aria-hidden="true" href="#cb691-62" tabindex="-1"></a>      <span class="cf">break</span><span class="op">;</span></span>
<span id="cb691-63"><a aria-hidden="true" href="#cb691-63" tabindex="-1"></a></span>
<span id="cb691-64"><a aria-hidden="true" href="#cb691-64" tabindex="-1"></a>    <span class="cf">case</span> COMPOSITE_GLYPH<span class="op">:</span></span>
<span id="cb691-65"><a aria-hidden="true" href="#cb691-65" tabindex="-1"></a>      <span class="co">/* Composite character (e.g., emoji, ligatures) */</span></span>
<span id="cb691-66"><a aria-hidden="true" href="#cb691-66" tabindex="-1"></a>      x_draw_composite_glyph_string_foreground<span class="op">(</span>s<span class="op">);</span></span>
<span id="cb691-67"><a aria-hidden="true" href="#cb691-67" tabindex="-1"></a>      <span class="cf">break</span><span class="op">;</span></span>
<span id="cb691-68"><a aria-hidden="true" href="#cb691-68" tabindex="-1"></a></span>
<span id="cb691-69"><a aria-hidden="true" href="#cb691-69" tabindex="-1"></a>    <span class="cf">case</span> GLYPHLESS_GLYPH<span class="op">:</span></span>
<span id="cb691-70"><a aria-hidden="true" href="#cb691-70" tabindex="-1"></a>      <span class="co">/* Display representation for glyphless characters */</span></span>
<span id="cb691-71"><a aria-hidden="true" href="#cb691-71" tabindex="-1"></a>      x_draw_glyphless_glyph_string_foreground<span class="op">(</span>s<span class="op">);</span></span>
<span id="cb691-72"><a aria-hidden="true" href="#cb691-72" tabindex="-1"></a>      <span class="cf">break</span><span class="op">;</span></span>
<span id="cb691-73"><a aria-hidden="true" href="#cb691-73" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb691-74"><a aria-hidden="true" href="#cb691-74" tabindex="-1"></a></span>
<span id="cb691-75"><a aria-hidden="true" href="#cb691-75" tabindex="-1"></a>  <span class="co">/* 5. Draw text decorations */</span></span>
<span id="cb691-76"><a aria-hidden="true" href="#cb691-76" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>s<span class="op">-&gt;</span>face<span class="op">-&gt;</span>underline<span class="op">)</span> <span class="op">{</span></span>
<span id="cb691-77"><a aria-hidden="true" href="#cb691-77" tabindex="-1"></a>    x_draw_glyph_string_underline<span class="op">(</span>s<span class="op">);</span></span>
<span id="cb691-78"><a aria-hidden="true" href="#cb691-78" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb691-79"><a aria-hidden="true" href="#cb691-79" tabindex="-1"></a></span>
<span id="cb691-80"><a aria-hidden="true" href="#cb691-80" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>s<span class="op">-&gt;</span>face<span class="op">-&gt;</span>overline<span class="op">)</span> <span class="op">{</span></span>
<span id="cb691-81"><a aria-hidden="true" href="#cb691-81" tabindex="-1"></a>    x_draw_glyph_string_overline<span class="op">(</span>s<span class="op">);</span></span>
<span id="cb691-82"><a aria-hidden="true" href="#cb691-82" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb691-83"><a aria-hidden="true" href="#cb691-83" tabindex="-1"></a></span>
<span id="cb691-84"><a aria-hidden="true" href="#cb691-84" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>s<span class="op">-&gt;</span>face<span class="op">-&gt;</span>strike_through<span class="op">)</span> <span class="op">{</span></span>
<span id="cb691-85"><a aria-hidden="true" href="#cb691-85" tabindex="-1"></a>    x_draw_glyph_string_strike_through<span class="op">(</span>s<span class="op">);</span></span>
<span id="cb691-86"><a aria-hidden="true" href="#cb691-86" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb691-87"><a aria-hidden="true" href="#cb691-87" tabindex="-1"></a></span>
<span id="cb691-88"><a aria-hidden="true" href="#cb691-88" tabindex="-1"></a>  <span class="co">/* 6. Draw box (border around text) */</span></span>
<span id="cb691-89"><a aria-hidden="true" href="#cb691-89" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>s<span class="op">-&gt;</span>face<span class="op">-&gt;</span>box <span class="op">!=</span> FACE_NO_BOX<span class="op">)</span> <span class="op">{</span></span>
<span id="cb691-90"><a aria-hidden="true" href="#cb691-90" tabindex="-1"></a>    x_draw_glyph_string_box<span class="op">(</span>s<span class="op">);</span></span>
<span id="cb691-91"><a aria-hidden="true" href="#cb691-91" tabindex="-1"></a>    relief_drawn_p <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb691-92"><a aria-hidden="true" href="#cb691-92" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb691-93"><a aria-hidden="true" href="#cb691-93" tabindex="-1"></a></span>
<span id="cb691-94"><a aria-hidden="true" href="#cb691-94" tabindex="-1"></a>  <span class="co">/* 7. Reset clipping */</span></span>
<span id="cb691-95"><a aria-hidden="true" href="#cb691-95" tabindex="-1"></a>  XSetClipMask<span class="op">(</span>s<span class="op">-&gt;</span>display<span class="op">,</span> s<span class="op">-&gt;</span>gc<span class="op">,</span> None<span class="op">);</span></span>
<span id="cb691-96"><a aria-hidden="true" href="#cb691-96" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 data-number="19.3.5" id="image-rendering"><span class="header-section-number">19.3.5</span> 2.5 Image Rendering</h3>
<p>Images are rendered through the unified image API with X11-specific
backend.</p>
<h4 data-number="19.3.5.1" id="image-types-supported"><span class="header-section-number">19.3.5.1</span> Image Types Supported</h4>
<ul>
<li>XBM (X Bitmap) - native X format</li>
<li>XPM (X Pixmap) - native X color format</li>
<li>PNG, JPEG, GIF, TIFF - via external libraries</li>
<li>SVG - via librsvg</li>
<li>ImageMagick - via ImageMagick library</li>
</ul>
<h4 data-number="19.3.5.2" id="x11-image-rendering"><span class="header-section-number">19.3.5.2</span> X11 Image Rendering</h4>
<div class="sourceCode" id="cb692"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb692-1"><a aria-hidden="true" href="#cb692-1" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> x_draw_image_glyph_string<span class="op">(</span><span class="kw">struct</span> glyph_string <span class="op">*</span>s<span class="op">)</span></span>
<span id="cb692-2"><a aria-hidden="true" href="#cb692-2" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb692-3"><a aria-hidden="true" href="#cb692-3" tabindex="-1"></a>  <span class="kw">struct</span> image <span class="op">*</span>img <span class="op">=</span> IMAGE_FROM_ID<span class="op">(</span>s<span class="op">-&gt;</span>f<span class="op">,</span> s<span class="op">-&gt;</span>img<span class="op">-&gt;</span>id<span class="op">);</span></span>
<span id="cb692-4"><a aria-hidden="true" href="#cb692-4" tabindex="-1"></a></span>
<span id="cb692-5"><a aria-hidden="true" href="#cb692-5" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>img<span class="op">-&gt;</span>pixmap<span class="op">)</span> <span class="op">{</span></span>
<span id="cb692-6"><a aria-hidden="true" href="#cb692-6" tabindex="-1"></a>    <span class="co">/* Have X pixmap for image */</span></span>
<span id="cb692-7"><a aria-hidden="true" href="#cb692-7" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>img<span class="op">-&gt;</span>mask<span class="op">)</span> <span class="op">{</span></span>
<span id="cb692-8"><a aria-hidden="true" href="#cb692-8" tabindex="-1"></a>      <span class="co">/* Image has transparency - use clip mask */</span></span>
<span id="cb692-9"><a aria-hidden="true" href="#cb692-9" tabindex="-1"></a>      XSetClipMask<span class="op">(</span>s<span class="op">-&gt;</span>display<span class="op">,</span> s<span class="op">-&gt;</span>gc<span class="op">,</span> img<span class="op">-&gt;</span>mask<span class="op">);</span></span>
<span id="cb692-10"><a aria-hidden="true" href="#cb692-10" tabindex="-1"></a>      XSetClipOrigin<span class="op">(</span>s<span class="op">-&gt;</span>display<span class="op">,</span> s<span class="op">-&gt;</span>gc<span class="op">,</span> s<span class="op">-&gt;</span>x<span class="op">,</span> s<span class="op">-&gt;</span>y<span class="op">);</span></span>
<span id="cb692-11"><a aria-hidden="true" href="#cb692-11" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb692-12"><a aria-hidden="true" href="#cb692-12" tabindex="-1"></a></span>
<span id="cb692-13"><a aria-hidden="true" href="#cb692-13" tabindex="-1"></a>    <span class="co">/* Copy pixmap to window */</span></span>
<span id="cb692-14"><a aria-hidden="true" href="#cb692-14" tabindex="-1"></a>    XCopyArea<span class="op">(</span>s<span class="op">-&gt;</span>display<span class="op">,</span> img<span class="op">-&gt;</span>pixmap<span class="op">,</span> FRAME_X_DRAWABLE<span class="op">(</span>s<span class="op">-&gt;</span>f<span class="op">),</span> s<span class="op">-&gt;</span>gc<span class="op">,</span></span>
<span id="cb692-15"><a aria-hidden="true" href="#cb692-15" tabindex="-1"></a>              <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> img<span class="op">-&gt;</span>width<span class="op">,</span> img<span class="op">-&gt;</span>height<span class="op">,</span> s<span class="op">-&gt;</span>x<span class="op">,</span> s<span class="op">-&gt;</span>y<span class="op">);</span></span>
<span id="cb692-16"><a aria-hidden="true" href="#cb692-16" tabindex="-1"></a></span>
<span id="cb692-17"><a aria-hidden="true" href="#cb692-17" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>img<span class="op">-&gt;</span>mask<span class="op">)</span> <span class="op">{</span></span>
<span id="cb692-18"><a aria-hidden="true" href="#cb692-18" tabindex="-1"></a>      XSetClipMask<span class="op">(</span>s<span class="op">-&gt;</span>display<span class="op">,</span> s<span class="op">-&gt;</span>gc<span class="op">,</span> None<span class="op">);</span></span>
<span id="cb692-19"><a aria-hidden="true" href="#cb692-19" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb692-20"><a aria-hidden="true" href="#cb692-20" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb692-21"><a aria-hidden="true" href="#cb692-21" tabindex="-1"></a><span class="pp">#ifdef HAVE_XRENDER</span></span>
<span id="cb692-22"><a aria-hidden="true" href="#cb692-22" tabindex="-1"></a>  <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>img<span class="op">-&gt;</span>picture<span class="op">)</span> <span class="op">{</span></span>
<span id="cb692-23"><a aria-hidden="true" href="#cb692-23" tabindex="-1"></a>    <span class="co">/* Use XRender for alpha compositing */</span></span>
<span id="cb692-24"><a aria-hidden="true" href="#cb692-24" tabindex="-1"></a>    XRenderComposite<span class="op">(</span>s<span class="op">-&gt;</span>display<span class="op">,</span> PictOpOver<span class="op">,</span></span>
<span id="cb692-25"><a aria-hidden="true" href="#cb692-25" tabindex="-1"></a>                     img<span class="op">-&gt;</span>picture<span class="op">,</span>        <span class="co">/* source */</span></span>
<span id="cb692-26"><a aria-hidden="true" href="#cb692-26" tabindex="-1"></a>                     img<span class="op">-&gt;</span>mask_picture<span class="op">,</span>   <span class="co">/* mask (alpha channel) */</span></span>
<span id="cb692-27"><a aria-hidden="true" href="#cb692-27" tabindex="-1"></a>                     FRAME_X_PICTURE<span class="op">(</span>s<span class="op">-&gt;</span>f<span class="op">),</span> <span class="co">/* destination */</span></span>
<span id="cb692-28"><a aria-hidden="true" href="#cb692-28" tabindex="-1"></a>                     <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span>                <span class="co">/* src x, y */</span></span>
<span id="cb692-29"><a aria-hidden="true" href="#cb692-29" tabindex="-1"></a>                     <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span>                <span class="co">/* mask x, y */</span></span>
<span id="cb692-30"><a aria-hidden="true" href="#cb692-30" tabindex="-1"></a>                     s<span class="op">-&gt;</span>x<span class="op">,</span> s<span class="op">-&gt;</span>y<span class="op">,</span>          <span class="co">/* dst x, y */</span></span>
<span id="cb692-31"><a aria-hidden="true" href="#cb692-31" tabindex="-1"></a>                     img<span class="op">-&gt;</span>width<span class="op">,</span> img<span class="op">-&gt;</span>height<span class="op">);</span></span>
<span id="cb692-32"><a aria-hidden="true" href="#cb692-32" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb692-33"><a aria-hidden="true" href="#cb692-33" tabindex="-1"></a><span class="pp">#endif</span></span>
<span id="cb692-34"><a aria-hidden="true" href="#cb692-34" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2 data-number="19.4" id="event-processing"><span class="header-section-number">19.4</span> 3. Event Processing</h2>
<h3 data-number="19.4.1" id="event-loop-architecture-1"><span class="header-section-number">19.4.1</span> 3.1 Event Loop
Architecture</h3>
<p>The X11 event loop integrates with Emacs‚Äôs main loop using file
descriptor monitoring.</p>
<h4 data-number="19.4.1.1" id="top-level-flow"><span class="header-section-number">19.4.1.1</span> Top-Level Flow</h4>
<div class="sourceCode" id="cb693"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb693-1"><a aria-hidden="true" href="#cb693-1" tabindex="-1"></a><span class="co">/* From keyboard.c - main Emacs loop */</span></span>
<span id="cb693-2"><a aria-hidden="true" href="#cb693-2" tabindex="-1"></a><span class="cf">while</span> <span class="op">(</span><span class="kw">true</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb693-3"><a aria-hidden="true" href="#cb693-3" tabindex="-1"></a>  <span class="co">/* 1. Use pselect() to wait for input */</span></span>
<span id="cb693-4"><a aria-hidden="true" href="#cb693-4" tabindex="-1"></a>  <span class="dt">int</span> nfds <span class="op">=</span> pselect<span class="op">(</span>max_fd <span class="op">+</span> <span class="dv">1</span><span class="op">,</span> <span class="op">&amp;</span>readfds<span class="op">,</span> NULL<span class="op">,</span> NULL<span class="op">,</span> timeout<span class="op">,</span> <span class="op">&amp;</span>mask<span class="op">);</span></span>
<span id="cb693-5"><a aria-hidden="true" href="#cb693-5" tabindex="-1"></a></span>
<span id="cb693-6"><a aria-hidden="true" href="#cb693-6" tabindex="-1"></a>  <span class="co">/* 2. Check if X connection has data */</span></span>
<span id="cb693-7"><a aria-hidden="true" href="#cb693-7" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>FD_ISSET<span class="op">(</span>x_connection_fd<span class="op">,</span> <span class="op">&amp;</span>readfds<span class="op">))</span> <span class="op">{</span></span>
<span id="cb693-8"><a aria-hidden="true" href="#cb693-8" tabindex="-1"></a>    <span class="co">/* 3. Read X events */</span></span>
<span id="cb693-9"><a aria-hidden="true" href="#cb693-9" tabindex="-1"></a>    XTread_socket<span class="op">(</span>terminal<span class="op">,</span> <span class="op">&amp;</span>hold_quit<span class="op">);</span></span>
<span id="cb693-10"><a aria-hidden="true" href="#cb693-10" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb693-11"><a aria-hidden="true" href="#cb693-11" tabindex="-1"></a></span>
<span id="cb693-12"><a aria-hidden="true" href="#cb693-12" tabindex="-1"></a>  <span class="co">/* 4. Process Emacs events from keyboard buffer */</span></span>
<span id="cb693-13"><a aria-hidden="true" href="#cb693-13" tabindex="-1"></a>  <span class="co">/* ... */</span></span>
<span id="cb693-14"><a aria-hidden="true" href="#cb693-14" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h4 data-number="19.4.1.2" id="xtread_socket---main-event-reader"><span class="header-section-number">19.4.1.2</span> XTread_socket - Main Event
Reader</h4>
<div class="sourceCode" id="cb694"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb694-1"><a aria-hidden="true" href="#cb694-1" tabindex="-1"></a><span class="co">/* From xterm.c - reads and processes X events */</span></span>
<span id="cb694-2"><a aria-hidden="true" href="#cb694-2" tabindex="-1"></a><span class="dt">int</span> XTread_socket<span class="op">(</span><span class="kw">struct</span> terminal <span class="op">*</span>terminal<span class="op">,</span> <span class="kw">struct</span> input_event <span class="op">*</span>hold_quit<span class="op">)</span></span>
<span id="cb694-3"><a aria-hidden="true" href="#cb694-3" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb694-4"><a aria-hidden="true" href="#cb694-4" tabindex="-1"></a>  <span class="dt">int</span> count <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb694-5"><a aria-hidden="true" href="#cb694-5" tabindex="-1"></a>  <span class="dt">bool</span> event_found <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb694-6"><a aria-hidden="true" href="#cb694-6" tabindex="-1"></a>  <span class="kw">struct</span> x_display_info <span class="op">*</span>dpyinfo <span class="op">=</span> terminal<span class="op">-&gt;</span>display_info<span class="op">.</span>x<span class="op">;</span></span>
<span id="cb694-7"><a aria-hidden="true" href="#cb694-7" tabindex="-1"></a></span>
<span id="cb694-8"><a aria-hidden="true" href="#cb694-8" tabindex="-1"></a>  block_input<span class="op">();</span></span>
<span id="cb694-9"><a aria-hidden="true" href="#cb694-9" tabindex="-1"></a></span>
<span id="cb694-10"><a aria-hidden="true" href="#cb694-10" tabindex="-1"></a>  <span class="co">/* Process all pending events */</span></span>
<span id="cb694-11"><a aria-hidden="true" href="#cb694-11" tabindex="-1"></a>  <span class="cf">while</span> <span class="op">(</span>XPending<span class="op">(</span>dpyinfo<span class="op">-&gt;</span>display<span class="op">))</span> <span class="op">{</span></span>
<span id="cb694-12"><a aria-hidden="true" href="#cb694-12" tabindex="-1"></a>    XEvent xev<span class="op">;</span></span>
<span id="cb694-13"><a aria-hidden="true" href="#cb694-13" tabindex="-1"></a>    XNextEvent<span class="op">(</span>dpyinfo<span class="op">-&gt;</span>display<span class="op">,</span> <span class="op">&amp;</span>xev<span class="op">);</span></span>
<span id="cb694-14"><a aria-hidden="true" href="#cb694-14" tabindex="-1"></a></span>
<span id="cb694-15"><a aria-hidden="true" href="#cb694-15" tabindex="-1"></a>    <span class="co">/* Filter through input method first */</span></span>
<span id="cb694-16"><a aria-hidden="true" href="#cb694-16" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>x_filter_event<span class="op">(</span>dpyinfo<span class="op">,</span> <span class="op">&amp;</span>xev<span class="op">))</span></span>
<span id="cb694-17"><a aria-hidden="true" href="#cb694-17" tabindex="-1"></a>      <span class="cf">continue</span><span class="op">;</span></span>
<span id="cb694-18"><a aria-hidden="true" href="#cb694-18" tabindex="-1"></a></span>
<span id="cb694-19"><a aria-hidden="true" href="#cb694-19" tabindex="-1"></a>    <span class="co">/* Handle the event */</span></span>
<span id="cb694-20"><a aria-hidden="true" href="#cb694-20" tabindex="-1"></a>    count <span class="op">+=</span> handle_one_xevent<span class="op">(</span>dpyinfo<span class="op">,</span> <span class="op">&amp;</span>xev<span class="op">,</span> <span class="op">&amp;</span>finish<span class="op">,</span> hold_quit<span class="op">);</span></span>
<span id="cb694-21"><a aria-hidden="true" href="#cb694-21" tabindex="-1"></a></span>
<span id="cb694-22"><a aria-hidden="true" href="#cb694-22" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>finish <span class="op">==</span> X_EVENT_GOTO_OUT<span class="op">)</span></span>
<span id="cb694-23"><a aria-hidden="true" href="#cb694-23" tabindex="-1"></a>      <span class="cf">break</span><span class="op">;</span></span>
<span id="cb694-24"><a aria-hidden="true" href="#cb694-24" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb694-25"><a aria-hidden="true" href="#cb694-25" tabindex="-1"></a></span>
<span id="cb694-26"><a aria-hidden="true" href="#cb694-26" tabindex="-1"></a>  unblock_input<span class="op">();</span></span>
<span id="cb694-27"><a aria-hidden="true" href="#cb694-27" tabindex="-1"></a>  <span class="cf">return</span> count<span class="op">;</span></span>
<span id="cb694-28"><a aria-hidden="true" href="#cb694-28" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 data-number="19.4.2" id="event-translation---handle_one_xevent"><span class="header-section-number">19.4.2</span> 3.2 Event Translation -
handle_one_xevent</h3>
<p>This massive function (thousands of lines) translates X events into
Emacs events.</p>
<h4 data-number="19.4.2.1" id="event-type-handling"><span class="header-section-number">19.4.2.1</span> Event Type Handling</h4>
<div class="sourceCode" id="cb695"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb695-1"><a aria-hidden="true" href="#cb695-1" tabindex="-1"></a><span class="dt">static</span> <span class="dt">int</span> handle_one_xevent<span class="op">(</span><span class="kw">struct</span> x_display_info <span class="op">*</span>dpyinfo<span class="op">,</span></span>
<span id="cb695-2"><a aria-hidden="true" href="#cb695-2" tabindex="-1"></a>                            XEvent <span class="op">*</span>event<span class="op">,</span></span>
<span id="cb695-3"><a aria-hidden="true" href="#cb695-3" tabindex="-1"></a>                            <span class="dt">int</span> <span class="op">*</span>finish<span class="op">,</span></span>
<span id="cb695-4"><a aria-hidden="true" href="#cb695-4" tabindex="-1"></a>                            <span class="kw">struct</span> input_event <span class="op">*</span>hold_quit<span class="op">)</span></span>
<span id="cb695-5"><a aria-hidden="true" href="#cb695-5" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb695-6"><a aria-hidden="true" href="#cb695-6" tabindex="-1"></a>  <span class="dt">int</span> count <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb695-7"><a aria-hidden="true" href="#cb695-7" tabindex="-1"></a>  <span class="kw">struct</span> frame <span class="op">*</span>f <span class="op">=</span> NULL<span class="op">;</span></span>
<span id="cb695-8"><a aria-hidden="true" href="#cb695-8" tabindex="-1"></a></span>
<span id="cb695-9"><a aria-hidden="true" href="#cb695-9" tabindex="-1"></a>  <span class="co">/* Identify which frame this event belongs to */</span></span>
<span id="cb695-10"><a aria-hidden="true" href="#cb695-10" tabindex="-1"></a>  f <span class="op">=</span> x_any_window_to_frame<span class="op">(</span>dpyinfo<span class="op">,</span> event<span class="op">-&gt;</span>xany<span class="op">.</span>window<span class="op">);</span></span>
<span id="cb695-11"><a aria-hidden="true" href="#cb695-11" tabindex="-1"></a></span>
<span id="cb695-12"><a aria-hidden="true" href="#cb695-12" tabindex="-1"></a>  <span class="cf">switch</span> <span class="op">(</span>event<span class="op">-&gt;</span>type<span class="op">)</span> <span class="op">{</span></span>
<span id="cb695-13"><a aria-hidden="true" href="#cb695-13" tabindex="-1"></a></span>
<span id="cb695-14"><a aria-hidden="true" href="#cb695-14" tabindex="-1"></a>    <span class="co">/* ===== Keyboard Events ===== */</span></span>
<span id="cb695-15"><a aria-hidden="true" href="#cb695-15" tabindex="-1"></a>    <span class="cf">case</span> KeyPress<span class="op">:</span> <span class="op">{</span></span>
<span id="cb695-16"><a aria-hidden="true" href="#cb695-16" tabindex="-1"></a>      KeySym keysym<span class="op">;</span></span>
<span id="cb695-17"><a aria-hidden="true" href="#cb695-17" tabindex="-1"></a>      <span class="dt">char</span> copy_buffer<span class="op">[</span><span class="dv">81</span><span class="op">];</span></span>
<span id="cb695-18"><a aria-hidden="true" href="#cb695-18" tabindex="-1"></a>      <span class="dt">int</span> modifiers<span class="op">;</span></span>
<span id="cb695-19"><a aria-hidden="true" href="#cb695-19" tabindex="-1"></a></span>
<span id="cb695-20"><a aria-hidden="true" href="#cb695-20" tabindex="-1"></a>      <span class="co">/* Translate X key event to keysym */</span></span>
<span id="cb695-21"><a aria-hidden="true" href="#cb695-21" tabindex="-1"></a>      <span class="dt">int</span> nbytes <span class="op">=</span> XLookupString<span class="op">(&amp;</span>event<span class="op">-&gt;</span>xkey<span class="op">,</span> copy_buffer<span class="op">,</span></span>
<span id="cb695-22"><a aria-hidden="true" href="#cb695-22" tabindex="-1"></a>                                 <span class="kw">sizeof</span><span class="op">(</span>copy_buffer<span class="op">),</span> <span class="op">&amp;</span>keysym<span class="op">,</span> NULL<span class="op">);</span></span>
<span id="cb695-23"><a aria-hidden="true" href="#cb695-23" tabindex="-1"></a></span>
<span id="cb695-24"><a aria-hidden="true" href="#cb695-24" tabindex="-1"></a>      <span class="co">/* Or use XIM for composed input */</span></span>
<span id="cb695-25"><a aria-hidden="true" href="#cb695-25" tabindex="-1"></a>      <span class="pp">#ifdef HAVE_X_I18N</span></span>
<span id="cb695-26"><a aria-hidden="true" href="#cb695-26" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span>FRAME_XIC<span class="op">(</span>f<span class="op">))</span> <span class="op">{</span></span>
<span id="cb695-27"><a aria-hidden="true" href="#cb695-27" tabindex="-1"></a>        Status status<span class="op">;</span></span>
<span id="cb695-28"><a aria-hidden="true" href="#cb695-28" tabindex="-1"></a>        nbytes <span class="op">=</span> XmbLookupString<span class="op">(</span>FRAME_XIC<span class="op">(</span>f<span class="op">),</span> <span class="op">&amp;</span>event<span class="op">-&gt;</span>xkey<span class="op">,</span></span>
<span id="cb695-29"><a aria-hidden="true" href="#cb695-29" tabindex="-1"></a>                                copy_buffer<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>copy_buffer<span class="op">),</span></span>
<span id="cb695-30"><a aria-hidden="true" href="#cb695-30" tabindex="-1"></a>                                <span class="op">&amp;</span>keysym<span class="op">,</span> <span class="op">&amp;</span>status<span class="op">);</span></span>
<span id="cb695-31"><a aria-hidden="true" href="#cb695-31" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb695-32"><a aria-hidden="true" href="#cb695-32" tabindex="-1"></a>      <span class="pp">#endif</span></span>
<span id="cb695-33"><a aria-hidden="true" href="#cb695-33" tabindex="-1"></a></span>
<span id="cb695-34"><a aria-hidden="true" href="#cb695-34" tabindex="-1"></a>      <span class="co">/* Convert X modifiers to Emacs modifiers */</span></span>
<span id="cb695-35"><a aria-hidden="true" href="#cb695-35" tabindex="-1"></a>      modifiers <span class="op">=</span> x_x_to_emacs_modifiers<span class="op">(</span>dpyinfo<span class="op">,</span> event<span class="op">-&gt;</span>xkey<span class="op">.</span>state<span class="op">);</span></span>
<span id="cb695-36"><a aria-hidden="true" href="#cb695-36" tabindex="-1"></a></span>
<span id="cb695-37"><a aria-hidden="true" href="#cb695-37" tabindex="-1"></a>      <span class="co">/* Create Emacs keyboard event */</span></span>
<span id="cb695-38"><a aria-hidden="true" href="#cb695-38" tabindex="-1"></a>      inev<span class="op">.</span>kind <span class="op">=</span> <span class="op">(</span>keysym <span class="op">&lt;</span> <span class="dv">256</span><span class="op">)</span> <span class="op">?</span> ASCII_KEYSTROKE_EVENT</span>
<span id="cb695-39"><a aria-hidden="true" href="#cb695-39" tabindex="-1"></a>                                 <span class="op">:</span> NON_ASCII_KEYSTROKE_EVENT<span class="op">;</span></span>
<span id="cb695-40"><a aria-hidden="true" href="#cb695-40" tabindex="-1"></a>      inev<span class="op">.</span>code <span class="op">=</span> keysym<span class="op">;</span></span>
<span id="cb695-41"><a aria-hidden="true" href="#cb695-41" tabindex="-1"></a>      inev<span class="op">.</span>modifiers <span class="op">=</span> modifiers<span class="op">;</span></span>
<span id="cb695-42"><a aria-hidden="true" href="#cb695-42" tabindex="-1"></a>      XSETFRAME<span class="op">(</span>inev<span class="op">.</span>frame_or_window<span class="op">,</span> f<span class="op">);</span></span>
<span id="cb695-43"><a aria-hidden="true" href="#cb695-43" tabindex="-1"></a>      inev<span class="op">.</span>timestamp <span class="op">=</span> event<span class="op">-&gt;</span>xkey<span class="op">.</span>time<span class="op">;</span></span>
<span id="cb695-44"><a aria-hidden="true" href="#cb695-44" tabindex="-1"></a></span>
<span id="cb695-45"><a aria-hidden="true" href="#cb695-45" tabindex="-1"></a>      kbd_buffer_store_event<span class="op">(&amp;</span>inev<span class="op">);</span></span>
<span id="cb695-46"><a aria-hidden="true" href="#cb695-46" tabindex="-1"></a>      count<span class="op">++;</span></span>
<span id="cb695-47"><a aria-hidden="true" href="#cb695-47" tabindex="-1"></a>      <span class="cf">break</span><span class="op">;</span></span>
<span id="cb695-48"><a aria-hidden="true" href="#cb695-48" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb695-49"><a aria-hidden="true" href="#cb695-49" tabindex="-1"></a></span>
<span id="cb695-50"><a aria-hidden="true" href="#cb695-50" tabindex="-1"></a>    <span class="co">/* ===== Mouse Events ===== */</span></span>
<span id="cb695-51"><a aria-hidden="true" href="#cb695-51" tabindex="-1"></a>    <span class="cf">case</span> ButtonPress<span class="op">:</span></span>
<span id="cb695-52"><a aria-hidden="true" href="#cb695-52" tabindex="-1"></a>    <span class="cf">case</span> ButtonRelease<span class="op">:</span> <span class="op">{</span></span>
<span id="cb695-53"><a aria-hidden="true" href="#cb695-53" tabindex="-1"></a>      <span class="co">/* Translate mouse button and modifiers */</span></span>
<span id="cb695-54"><a aria-hidden="true" href="#cb695-54" tabindex="-1"></a>      <span class="dt">int</span> button <span class="op">=</span> event<span class="op">-&gt;</span>xbutton<span class="op">.</span>button<span class="op">;</span></span>
<span id="cb695-55"><a aria-hidden="true" href="#cb695-55" tabindex="-1"></a>      <span class="dt">int</span> modifiers <span class="op">=</span> x_x_to_emacs_modifiers<span class="op">(</span>dpyinfo<span class="op">,</span> event<span class="op">-&gt;</span>xbutton<span class="op">.</span>state<span class="op">);</span></span>
<span id="cb695-56"><a aria-hidden="true" href="#cb695-56" tabindex="-1"></a></span>
<span id="cb695-57"><a aria-hidden="true" href="#cb695-57" tabindex="-1"></a>      <span class="co">/* Determine event type */</span></span>
<span id="cb695-58"><a aria-hidden="true" href="#cb695-58" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span>event<span class="op">-&gt;</span>type <span class="op">==</span> ButtonPress<span class="op">)</span> <span class="op">{</span></span>
<span id="cb695-59"><a aria-hidden="true" href="#cb695-59" tabindex="-1"></a>        inev<span class="op">.</span>kind <span class="op">=</span> MOUSE_CLICK_EVENT<span class="op">;</span></span>
<span id="cb695-60"><a aria-hidden="true" href="#cb695-60" tabindex="-1"></a>        dpyinfo<span class="op">-&gt;</span>last_mouse_frame <span class="op">=</span> f<span class="op">;</span></span>
<span id="cb695-61"><a aria-hidden="true" href="#cb695-61" tabindex="-1"></a>      <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb695-62"><a aria-hidden="true" href="#cb695-62" tabindex="-1"></a>        inev<span class="op">.</span>kind <span class="op">=</span> MOUSE_CLICK_EVENT<span class="op">;</span>  <span class="co">/* Still reported as click */</span></span>
<span id="cb695-63"><a aria-hidden="true" href="#cb695-63" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb695-64"><a aria-hidden="true" href="#cb695-64" tabindex="-1"></a></span>
<span id="cb695-65"><a aria-hidden="true" href="#cb695-65" tabindex="-1"></a>      <span class="co">/* Map X button numbers to Emacs */</span></span>
<span id="cb695-66"><a aria-hidden="true" href="#cb695-66" tabindex="-1"></a>      <span class="cf">switch</span> <span class="op">(</span>button<span class="op">)</span> <span class="op">{</span></span>
<span id="cb695-67"><a aria-hidden="true" href="#cb695-67" tabindex="-1"></a>        <span class="cf">case</span> Button1<span class="op">:</span> inev<span class="op">.</span>code <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> <span class="cf">break</span><span class="op">;</span>  <span class="co">/* Left */</span></span>
<span id="cb695-68"><a aria-hidden="true" href="#cb695-68" tabindex="-1"></a>        <span class="cf">case</span> Button2<span class="op">:</span> inev<span class="op">.</span>code <span class="op">=</span> <span class="dv">1</span><span class="op">;</span> <span class="cf">break</span><span class="op">;</span>  <span class="co">/* Middle */</span></span>
<span id="cb695-69"><a aria-hidden="true" href="#cb695-69" tabindex="-1"></a>        <span class="cf">case</span> Button3<span class="op">:</span> inev<span class="op">.</span>code <span class="op">=</span> <span class="dv">2</span><span class="op">;</span> <span class="cf">break</span><span class="op">;</span>  <span class="co">/* Right */</span></span>
<span id="cb695-70"><a aria-hidden="true" href="#cb695-70" tabindex="-1"></a>        <span class="cf">case</span> Button4<span class="op">:</span> <span class="co">/* Wheel up */</span></span>
<span id="cb695-71"><a aria-hidden="true" href="#cb695-71" tabindex="-1"></a>          inev<span class="op">.</span>kind <span class="op">=</span> WHEEL_EVENT<span class="op">;</span></span>
<span id="cb695-72"><a aria-hidden="true" href="#cb695-72" tabindex="-1"></a>          inev<span class="op">.</span>code <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb695-73"><a aria-hidden="true" href="#cb695-73" tabindex="-1"></a>          modifiers <span class="op">|=</span> up_modifier<span class="op">;</span></span>
<span id="cb695-74"><a aria-hidden="true" href="#cb695-74" tabindex="-1"></a>          <span class="cf">break</span><span class="op">;</span></span>
<span id="cb695-75"><a aria-hidden="true" href="#cb695-75" tabindex="-1"></a>        <span class="cf">case</span> Button5<span class="op">:</span> <span class="co">/* Wheel down */</span></span>
<span id="cb695-76"><a aria-hidden="true" href="#cb695-76" tabindex="-1"></a>          inev<span class="op">.</span>kind <span class="op">=</span> WHEEL_EVENT<span class="op">;</span></span>
<span id="cb695-77"><a aria-hidden="true" href="#cb695-77" tabindex="-1"></a>          inev<span class="op">.</span>code <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb695-78"><a aria-hidden="true" href="#cb695-78" tabindex="-1"></a>          modifiers <span class="op">|=</span> down_modifier<span class="op">;</span></span>
<span id="cb695-79"><a aria-hidden="true" href="#cb695-79" tabindex="-1"></a>          <span class="cf">break</span><span class="op">;</span></span>
<span id="cb695-80"><a aria-hidden="true" href="#cb695-80" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb695-81"><a aria-hidden="true" href="#cb695-81" tabindex="-1"></a></span>
<span id="cb695-82"><a aria-hidden="true" href="#cb695-82" tabindex="-1"></a>      <span class="co">/* Set position */</span></span>
<span id="cb695-83"><a aria-hidden="true" href="#cb695-83" tabindex="-1"></a>      inev<span class="op">.</span>x <span class="op">=</span> event<span class="op">-&gt;</span>xbutton<span class="op">.</span>x<span class="op">;</span></span>
<span id="cb695-84"><a aria-hidden="true" href="#cb695-84" tabindex="-1"></a>      inev<span class="op">.</span>y <span class="op">=</span> event<span class="op">-&gt;</span>xbutton<span class="op">.</span>y<span class="op">;</span></span>
<span id="cb695-85"><a aria-hidden="true" href="#cb695-85" tabindex="-1"></a>      inev<span class="op">.</span>modifiers <span class="op">=</span> modifiers<span class="op">;</span></span>
<span id="cb695-86"><a aria-hidden="true" href="#cb695-86" tabindex="-1"></a>      XSETFRAME<span class="op">(</span>inev<span class="op">.</span>frame_or_window<span class="op">,</span> f<span class="op">);</span></span>
<span id="cb695-87"><a aria-hidden="true" href="#cb695-87" tabindex="-1"></a></span>
<span id="cb695-88"><a aria-hidden="true" href="#cb695-88" tabindex="-1"></a>      kbd_buffer_store_event<span class="op">(&amp;</span>inev<span class="op">);</span></span>
<span id="cb695-89"><a aria-hidden="true" href="#cb695-89" tabindex="-1"></a>      count<span class="op">++;</span></span>
<span id="cb695-90"><a aria-hidden="true" href="#cb695-90" tabindex="-1"></a>      <span class="cf">break</span><span class="op">;</span></span>
<span id="cb695-91"><a aria-hidden="true" href="#cb695-91" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb695-92"><a aria-hidden="true" href="#cb695-92" tabindex="-1"></a></span>
<span id="cb695-93"><a aria-hidden="true" href="#cb695-93" tabindex="-1"></a>    <span class="cf">case</span> MotionNotify<span class="op">:</span> <span class="op">{</span></span>
<span id="cb695-94"><a aria-hidden="true" href="#cb695-94" tabindex="-1"></a>      <span class="co">/* Mouse motion */</span></span>
<span id="cb695-95"><a aria-hidden="true" href="#cb695-95" tabindex="-1"></a>      inev<span class="op">.</span>kind <span class="op">=</span> MOUSE_MOVEMENT_EVENT<span class="op">;</span></span>
<span id="cb695-96"><a aria-hidden="true" href="#cb695-96" tabindex="-1"></a>      inev<span class="op">.</span>x <span class="op">=</span> event<span class="op">-&gt;</span>xmotion<span class="op">.</span>x<span class="op">;</span></span>
<span id="cb695-97"><a aria-hidden="true" href="#cb695-97" tabindex="-1"></a>      inev<span class="op">.</span>y <span class="op">=</span> event<span class="op">-&gt;</span>xmotion<span class="op">.</span>y<span class="op">;</span></span>
<span id="cb695-98"><a aria-hidden="true" href="#cb695-98" tabindex="-1"></a>      XSETFRAME<span class="op">(</span>inev<span class="op">.</span>frame_or_window<span class="op">,</span> f<span class="op">);</span></span>
<span id="cb695-99"><a aria-hidden="true" href="#cb695-99" tabindex="-1"></a></span>
<span id="cb695-100"><a aria-hidden="true" href="#cb695-100" tabindex="-1"></a>      <span class="co">/* Update mouse highlight */</span></span>
<span id="cb695-101"><a aria-hidden="true" href="#cb695-101" tabindex="-1"></a>      note_mouse_movement<span class="op">(</span>f<span class="op">,</span> <span class="op">&amp;</span>event<span class="op">-&gt;</span>xmotion<span class="op">);</span></span>
<span id="cb695-102"><a aria-hidden="true" href="#cb695-102" tabindex="-1"></a></span>
<span id="cb695-103"><a aria-hidden="true" href="#cb695-103" tabindex="-1"></a>      kbd_buffer_store_event<span class="op">(&amp;</span>inev<span class="op">);</span></span>
<span id="cb695-104"><a aria-hidden="true" href="#cb695-104" tabindex="-1"></a>      count<span class="op">++;</span></span>
<span id="cb695-105"><a aria-hidden="true" href="#cb695-105" tabindex="-1"></a>      <span class="cf">break</span><span class="op">;</span></span>
<span id="cb695-106"><a aria-hidden="true" href="#cb695-106" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb695-107"><a aria-hidden="true" href="#cb695-107" tabindex="-1"></a></span>
<span id="cb695-108"><a aria-hidden="true" href="#cb695-108" tabindex="-1"></a>    <span class="co">/* ===== Focus Events ===== */</span></span>
<span id="cb695-109"><a aria-hidden="true" href="#cb695-109" tabindex="-1"></a>    <span class="cf">case</span> FocusIn<span class="op">:</span></span>
<span id="cb695-110"><a aria-hidden="true" href="#cb695-110" tabindex="-1"></a>    <span class="cf">case</span> FocusOut<span class="op">:</span> <span class="op">{</span></span>
<span id="cb695-111"><a aria-hidden="true" href="#cb695-111" tabindex="-1"></a>      x_detect_focus_change<span class="op">(</span>dpyinfo<span class="op">,</span> f<span class="op">,</span> event<span class="op">,</span> <span class="op">&amp;</span>inev<span class="op">);</span></span>
<span id="cb695-112"><a aria-hidden="true" href="#cb695-112" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span>inev<span class="op">.</span>kind <span class="op">!=</span> NO_EVENT<span class="op">)</span> <span class="op">{</span></span>
<span id="cb695-113"><a aria-hidden="true" href="#cb695-113" tabindex="-1"></a>        kbd_buffer_store_event<span class="op">(&amp;</span>inev<span class="op">);</span></span>
<span id="cb695-114"><a aria-hidden="true" href="#cb695-114" tabindex="-1"></a>        count<span class="op">++;</span></span>
<span id="cb695-115"><a aria-hidden="true" href="#cb695-115" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb695-116"><a aria-hidden="true" href="#cb695-116" tabindex="-1"></a>      <span class="cf">break</span><span class="op">;</span></span>
<span id="cb695-117"><a aria-hidden="true" href="#cb695-117" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb695-118"><a aria-hidden="true" href="#cb695-118" tabindex="-1"></a></span>
<span id="cb695-119"><a aria-hidden="true" href="#cb695-119" tabindex="-1"></a>    <span class="co">/* ===== Exposure Events ===== */</span></span>
<span id="cb695-120"><a aria-hidden="true" href="#cb695-120" tabindex="-1"></a>    <span class="cf">case</span> Expose<span class="op">:</span> <span class="op">{</span></span>
<span id="cb695-121"><a aria-hidden="true" href="#cb695-121" tabindex="-1"></a>      <span class="co">/* Part of window needs redrawing */</span></span>
<span id="cb695-122"><a aria-hidden="true" href="#cb695-122" tabindex="-1"></a>      f<span class="op">-&gt;</span>output_data<span class="op">.</span>x<span class="op">-&gt;</span>has_been_visible <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb695-123"><a aria-hidden="true" href="#cb695-123" tabindex="-1"></a></span>
<span id="cb695-124"><a aria-hidden="true" href="#cb695-124" tabindex="-1"></a>      <span class="co">/* Mark region for redisplay */</span></span>
<span id="cb695-125"><a aria-hidden="true" href="#cb695-125" tabindex="-1"></a>      expose_frame<span class="op">(</span>f<span class="op">,</span> event<span class="op">-&gt;</span>xexpose<span class="op">.</span>x<span class="op">,</span> event<span class="op">-&gt;</span>xexpose<span class="op">.</span>y<span class="op">,</span></span>
<span id="cb695-126"><a aria-hidden="true" href="#cb695-126" tabindex="-1"></a>                   event<span class="op">-&gt;</span>xexpose<span class="op">.</span>width<span class="op">,</span> event<span class="op">-&gt;</span>xexpose<span class="op">.</span>height<span class="op">);</span></span>
<span id="cb695-127"><a aria-hidden="true" href="#cb695-127" tabindex="-1"></a>      <span class="cf">break</span><span class="op">;</span></span>
<span id="cb695-128"><a aria-hidden="true" href="#cb695-128" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb695-129"><a aria-hidden="true" href="#cb695-129" tabindex="-1"></a></span>
<span id="cb695-130"><a aria-hidden="true" href="#cb695-130" tabindex="-1"></a>    <span class="co">/* ===== Window Configuration ===== */</span></span>
<span id="cb695-131"><a aria-hidden="true" href="#cb695-131" tabindex="-1"></a>    <span class="cf">case</span> ConfigureNotify<span class="op">:</span> <span class="op">{</span></span>
<span id="cb695-132"><a aria-hidden="true" href="#cb695-132" tabindex="-1"></a>      <span class="co">/* Window moved or resized */</span></span>
<span id="cb695-133"><a aria-hidden="true" href="#cb695-133" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span>event<span class="op">-&gt;</span>xconfigure<span class="op">.</span>width <span class="op">!=</span> FRAME_PIXEL_WIDTH<span class="op">(</span>f<span class="op">)</span></span>
<span id="cb695-134"><a aria-hidden="true" href="#cb695-134" tabindex="-1"></a>          <span class="op">||</span> event<span class="op">-&gt;</span>xconfigure<span class="op">.</span>height <span class="op">!=</span> FRAME_PIXEL_HEIGHT<span class="op">(</span>f<span class="op">))</span> <span class="op">{</span></span>
<span id="cb695-135"><a aria-hidden="true" href="#cb695-135" tabindex="-1"></a>        <span class="co">/* Size changed */</span></span>
<span id="cb695-136"><a aria-hidden="true" href="#cb695-136" tabindex="-1"></a>        change_frame_size<span class="op">(</span>f<span class="op">,</span> event<span class="op">-&gt;</span>xconfigure<span class="op">.</span>width<span class="op">,</span></span>
<span id="cb695-137"><a aria-hidden="true" href="#cb695-137" tabindex="-1"></a>                         event<span class="op">-&gt;</span>xconfigure<span class="op">.</span>height<span class="op">,</span> <span class="kw">false</span><span class="op">,</span> <span class="kw">true</span><span class="op">,</span> <span class="kw">false</span><span class="op">);</span></span>
<span id="cb695-138"><a aria-hidden="true" href="#cb695-138" tabindex="-1"></a>        SET_FRAME_GARBAGED<span class="op">(</span>f<span class="op">);</span></span>
<span id="cb695-139"><a aria-hidden="true" href="#cb695-139" tabindex="-1"></a>        cancel_mouse_face<span class="op">(</span>f<span class="op">);</span></span>
<span id="cb695-140"><a aria-hidden="true" href="#cb695-140" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb695-141"><a aria-hidden="true" href="#cb695-141" tabindex="-1"></a></span>
<span id="cb695-142"><a aria-hidden="true" href="#cb695-142" tabindex="-1"></a>      <span class="co">/* Check for position change */</span></span>
<span id="cb695-143"><a aria-hidden="true" href="#cb695-143" tabindex="-1"></a>      x_check_expected_move<span class="op">(</span>f<span class="op">,</span> event<span class="op">-&gt;</span>xconfigure<span class="op">.</span>x<span class="op">,</span> event<span class="op">-&gt;</span>xconfigure<span class="op">.</span>y<span class="op">);</span></span>
<span id="cb695-144"><a aria-hidden="true" href="#cb695-144" tabindex="-1"></a>      <span class="cf">break</span><span class="op">;</span></span>
<span id="cb695-145"><a aria-hidden="true" href="#cb695-145" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb695-146"><a aria-hidden="true" href="#cb695-146" tabindex="-1"></a></span>
<span id="cb695-147"><a aria-hidden="true" href="#cb695-147" tabindex="-1"></a>    <span class="co">/* ===== Window Manager Events ===== */</span></span>
<span id="cb695-148"><a aria-hidden="true" href="#cb695-148" tabindex="-1"></a>    <span class="cf">case</span> ClientMessage<span class="op">:</span> <span class="op">{</span></span>
<span id="cb695-149"><a aria-hidden="true" href="#cb695-149" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span>event<span class="op">-&gt;</span>xclient<span class="op">.</span>message_type <span class="op">==</span> dpyinfo<span class="op">-&gt;</span>Xatom_wm_protocols<span class="op">)</span> <span class="op">{</span></span>
<span id="cb695-150"><a aria-hidden="true" href="#cb695-150" tabindex="-1"></a>        Atom protocol <span class="op">=</span> event<span class="op">-&gt;</span>xclient<span class="op">.</span>data<span class="op">.</span>l<span class="op">[</span><span class="dv">0</span><span class="op">];</span></span>
<span id="cb695-151"><a aria-hidden="true" href="#cb695-151" tabindex="-1"></a></span>
<span id="cb695-152"><a aria-hidden="true" href="#cb695-152" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>protocol <span class="op">==</span> dpyinfo<span class="op">-&gt;</span>Xatom_wm_delete_window<span class="op">)</span> <span class="op">{</span></span>
<span id="cb695-153"><a aria-hidden="true" href="#cb695-153" tabindex="-1"></a>          <span class="co">/* WM wants to delete window */</span></span>
<span id="cb695-154"><a aria-hidden="true" href="#cb695-154" tabindex="-1"></a>          inev<span class="op">.</span>kind <span class="op">=</span> DELETE_WINDOW_EVENT<span class="op">;</span></span>
<span id="cb695-155"><a aria-hidden="true" href="#cb695-155" tabindex="-1"></a>          XSETFRAME<span class="op">(</span>inev<span class="op">.</span>frame_or_window<span class="op">,</span> f<span class="op">);</span></span>
<span id="cb695-156"><a aria-hidden="true" href="#cb695-156" tabindex="-1"></a>          kbd_buffer_store_event<span class="op">(&amp;</span>inev<span class="op">);</span></span>
<span id="cb695-157"><a aria-hidden="true" href="#cb695-157" tabindex="-1"></a>          count<span class="op">++;</span></span>
<span id="cb695-158"><a aria-hidden="true" href="#cb695-158" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb695-159"><a aria-hidden="true" href="#cb695-159" tabindex="-1"></a>        <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>protocol <span class="op">==</span> dpyinfo<span class="op">-&gt;</span>Xatom_wm_take_focus<span class="op">)</span> <span class="op">{</span></span>
<span id="cb695-160"><a aria-hidden="true" href="#cb695-160" tabindex="-1"></a>          <span class="co">/* WM wants us to take focus */</span></span>
<span id="cb695-161"><a aria-hidden="true" href="#cb695-161" tabindex="-1"></a>          x_focus_frame<span class="op">(</span>f<span class="op">);</span></span>
<span id="cb695-162"><a aria-hidden="true" href="#cb695-162" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb695-163"><a aria-hidden="true" href="#cb695-163" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb695-164"><a aria-hidden="true" href="#cb695-164" tabindex="-1"></a>      <span class="cf">break</span><span class="op">;</span></span>
<span id="cb695-165"><a aria-hidden="true" href="#cb695-165" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb695-166"><a aria-hidden="true" href="#cb695-166" tabindex="-1"></a></span>
<span id="cb695-167"><a aria-hidden="true" href="#cb695-167" tabindex="-1"></a>    <span class="co">/* ===== Selection Events ===== */</span></span>
<span id="cb695-168"><a aria-hidden="true" href="#cb695-168" tabindex="-1"></a>    <span class="cf">case</span> SelectionRequest<span class="op">:</span> <span class="op">{</span></span>
<span id="cb695-169"><a aria-hidden="true" href="#cb695-169" tabindex="-1"></a>      x_handle_selection_request<span class="op">(&amp;</span>event<span class="op">-&gt;</span>xselectionrequest<span class="op">);</span></span>
<span id="cb695-170"><a aria-hidden="true" href="#cb695-170" tabindex="-1"></a>      <span class="cf">break</span><span class="op">;</span></span>
<span id="cb695-171"><a aria-hidden="true" href="#cb695-171" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb695-172"><a aria-hidden="true" href="#cb695-172" tabindex="-1"></a></span>
<span id="cb695-173"><a aria-hidden="true" href="#cb695-173" tabindex="-1"></a>    <span class="cf">case</span> SelectionClear<span class="op">:</span> <span class="op">{</span></span>
<span id="cb695-174"><a aria-hidden="true" href="#cb695-174" tabindex="-1"></a>      x_handle_selection_clear<span class="op">(&amp;</span>event<span class="op">-&gt;</span>xselectionclear<span class="op">);</span></span>
<span id="cb695-175"><a aria-hidden="true" href="#cb695-175" tabindex="-1"></a>      <span class="cf">break</span><span class="op">;</span></span>
<span id="cb695-176"><a aria-hidden="true" href="#cb695-176" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb695-177"><a aria-hidden="true" href="#cb695-177" tabindex="-1"></a></span>
<span id="cb695-178"><a aria-hidden="true" href="#cb695-178" tabindex="-1"></a>    <span class="cf">case</span> SelectionNotify<span class="op">:</span> <span class="op">{</span></span>
<span id="cb695-179"><a aria-hidden="true" href="#cb695-179" tabindex="-1"></a>      x_handle_selection_notify<span class="op">(&amp;</span>event<span class="op">-&gt;</span>xselection<span class="op">);</span></span>
<span id="cb695-180"><a aria-hidden="true" href="#cb695-180" tabindex="-1"></a>      <span class="cf">break</span><span class="op">;</span></span>
<span id="cb695-181"><a aria-hidden="true" href="#cb695-181" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb695-182"><a aria-hidden="true" href="#cb695-182" tabindex="-1"></a></span>
<span id="cb695-183"><a aria-hidden="true" href="#cb695-183" tabindex="-1"></a>    <span class="co">/* ===== Property Changes ===== */</span></span>
<span id="cb695-184"><a aria-hidden="true" href="#cb695-184" tabindex="-1"></a>    <span class="cf">case</span> PropertyNotify<span class="op">:</span> <span class="op">{</span></span>
<span id="cb695-185"><a aria-hidden="true" href="#cb695-185" tabindex="-1"></a>      x_handle_property_notify<span class="op">(&amp;</span>event<span class="op">-&gt;</span>xproperty<span class="op">);</span></span>
<span id="cb695-186"><a aria-hidden="true" href="#cb695-186" tabindex="-1"></a>      <span class="cf">break</span><span class="op">;</span></span>
<span id="cb695-187"><a aria-hidden="true" href="#cb695-187" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb695-188"><a aria-hidden="true" href="#cb695-188" tabindex="-1"></a></span>
<span id="cb695-189"><a aria-hidden="true" href="#cb695-189" tabindex="-1"></a>    <span class="co">/* ===== XInput2 Events ===== */</span></span>
<span id="cb695-190"><a aria-hidden="true" href="#cb695-190" tabindex="-1"></a><span class="pp">#ifdef HAVE_XINPUT2</span></span>
<span id="cb695-191"><a aria-hidden="true" href="#cb695-191" tabindex="-1"></a>    <span class="cf">case</span> GenericEvent<span class="op">:</span> <span class="op">{</span></span>
<span id="cb695-192"><a aria-hidden="true" href="#cb695-192" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span>event<span class="op">-&gt;</span>xcookie<span class="op">.</span>extension <span class="op">==</span> dpyinfo<span class="op">-&gt;</span>xi2_opcode<span class="op">)</span> <span class="op">{</span></span>
<span id="cb695-193"><a aria-hidden="true" href="#cb695-193" tabindex="-1"></a>        XGetEventData<span class="op">(</span>dpyinfo<span class="op">-&gt;</span>display<span class="op">,</span> <span class="op">&amp;</span>event<span class="op">-&gt;</span>xcookie<span class="op">);</span></span>
<span id="cb695-194"><a aria-hidden="true" href="#cb695-194" tabindex="-1"></a>        count <span class="op">+=</span> xi_handle_event<span class="op">(</span>dpyinfo<span class="op">,</span> <span class="op">&amp;</span>event<span class="op">-&gt;</span>xcookie<span class="op">,</span> <span class="op">&amp;</span>inev<span class="op">);</span></span>
<span id="cb695-195"><a aria-hidden="true" href="#cb695-195" tabindex="-1"></a>        XFreeEventData<span class="op">(</span>dpyinfo<span class="op">-&gt;</span>display<span class="op">,</span> <span class="op">&amp;</span>event<span class="op">-&gt;</span>xcookie<span class="op">);</span></span>
<span id="cb695-196"><a aria-hidden="true" href="#cb695-196" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb695-197"><a aria-hidden="true" href="#cb695-197" tabindex="-1"></a>      <span class="cf">break</span><span class="op">;</span></span>
<span id="cb695-198"><a aria-hidden="true" href="#cb695-198" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb695-199"><a aria-hidden="true" href="#cb695-199" tabindex="-1"></a><span class="pp">#endif</span></span>
<span id="cb695-200"><a aria-hidden="true" href="#cb695-200" tabindex="-1"></a></span>
<span id="cb695-201"><a aria-hidden="true" href="#cb695-201" tabindex="-1"></a>    <span class="co">/* Many more event types... */</span></span>
<span id="cb695-202"><a aria-hidden="true" href="#cb695-202" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb695-203"><a aria-hidden="true" href="#cb695-203" tabindex="-1"></a></span>
<span id="cb695-204"><a aria-hidden="true" href="#cb695-204" tabindex="-1"></a>  <span class="cf">return</span> count<span class="op">;</span></span>
<span id="cb695-205"><a aria-hidden="true" href="#cb695-205" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 data-number="19.4.3" id="input-method-support-xim"><span class="header-section-number">19.4.3</span> 3.3 Input Method Support
(XIM)</h3>
<p>For international text input (e.g., Chinese, Japanese, Korean):</p>
<div class="sourceCode" id="cb696"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb696-1"><a aria-hidden="true" href="#cb696-1" tabindex="-1"></a><span class="pp">#ifdef HAVE_X_I18N</span></span>
<span id="cb696-2"><a aria-hidden="true" href="#cb696-2" tabindex="-1"></a><span class="co">/* XIM provides pre-edit and composition */</span></span>
<span id="cb696-3"><a aria-hidden="true" href="#cb696-3" tabindex="-1"></a></span>
<span id="cb696-4"><a aria-hidden="true" href="#cb696-4" tabindex="-1"></a><span class="co">/* Create input context for frame */</span></span>
<span id="cb696-5"><a aria-hidden="true" href="#cb696-5" tabindex="-1"></a><span class="cf">if</span> <span class="op">(</span>FRAME_X_XIM<span class="op">(</span>f<span class="op">))</span> <span class="op">{</span></span>
<span id="cb696-6"><a aria-hidden="true" href="#cb696-6" tabindex="-1"></a>  FRAME_X_XIC<span class="op">(</span>f<span class="op">)</span> <span class="op">=</span> XCreateIC<span class="op">(</span></span>
<span id="cb696-7"><a aria-hidden="true" href="#cb696-7" tabindex="-1"></a>    FRAME_X_XIM<span class="op">(</span>f<span class="op">),</span></span>
<span id="cb696-8"><a aria-hidden="true" href="#cb696-8" tabindex="-1"></a>    XNInputStyle<span class="op">,</span> XIMPreeditNothing <span class="op">|</span> XIMStatusNothing<span class="op">,</span></span>
<span id="cb696-9"><a aria-hidden="true" href="#cb696-9" tabindex="-1"></a>    XNClientWindow<span class="op">,</span> FRAME_X_WINDOW<span class="op">(</span>f<span class="op">),</span></span>
<span id="cb696-10"><a aria-hidden="true" href="#cb696-10" tabindex="-1"></a>    XNFocusWindow<span class="op">,</span> FRAME_X_WINDOW<span class="op">(</span>f<span class="op">),</span></span>
<span id="cb696-11"><a aria-hidden="true" href="#cb696-11" tabindex="-1"></a>    NULL</span>
<span id="cb696-12"><a aria-hidden="true" href="#cb696-12" tabindex="-1"></a>  <span class="op">);</span></span>
<span id="cb696-13"><a aria-hidden="true" href="#cb696-13" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb696-14"><a aria-hidden="true" href="#cb696-14" tabindex="-1"></a></span>
<span id="cb696-15"><a aria-hidden="true" href="#cb696-15" tabindex="-1"></a><span class="co">/* During KeyPress handling */</span></span>
<span id="cb696-16"><a aria-hidden="true" href="#cb696-16" tabindex="-1"></a>Status status<span class="op">;</span></span>
<span id="cb696-17"><a aria-hidden="true" href="#cb696-17" tabindex="-1"></a>KeySym keysym<span class="op">;</span></span>
<span id="cb696-18"><a aria-hidden="true" href="#cb696-18" tabindex="-1"></a><span class="dt">char</span> buffer<span class="op">[</span><span class="dv">128</span><span class="op">];</span></span>
<span id="cb696-19"><a aria-hidden="true" href="#cb696-19" tabindex="-1"></a></span>
<span id="cb696-20"><a aria-hidden="true" href="#cb696-20" tabindex="-1"></a><span class="dt">int</span> nchars <span class="op">=</span> XmbLookupString<span class="op">(</span></span>
<span id="cb696-21"><a aria-hidden="true" href="#cb696-21" tabindex="-1"></a>  FRAME_X_XIC<span class="op">(</span>f<span class="op">),</span></span>
<span id="cb696-22"><a aria-hidden="true" href="#cb696-22" tabindex="-1"></a>  <span class="op">&amp;</span>event<span class="op">-&gt;</span>xkey<span class="op">,</span></span>
<span id="cb696-23"><a aria-hidden="true" href="#cb696-23" tabindex="-1"></a>  buffer<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>buffer<span class="op">),</span></span>
<span id="cb696-24"><a aria-hidden="true" href="#cb696-24" tabindex="-1"></a>  <span class="op">&amp;</span>keysym<span class="op">,</span> <span class="op">&amp;</span>status</span>
<span id="cb696-25"><a aria-hidden="true" href="#cb696-25" tabindex="-1"></a><span class="op">);</span></span>
<span id="cb696-26"><a aria-hidden="true" href="#cb696-26" tabindex="-1"></a></span>
<span id="cb696-27"><a aria-hidden="true" href="#cb696-27" tabindex="-1"></a><span class="cf">switch</span> <span class="op">(</span>status<span class="op">)</span> <span class="op">{</span></span>
<span id="cb696-28"><a aria-hidden="true" href="#cb696-28" tabindex="-1"></a>  <span class="cf">case</span> XLookupChars<span class="op">:</span></span>
<span id="cb696-29"><a aria-hidden="true" href="#cb696-29" tabindex="-1"></a>  <span class="cf">case</span> XLookupBoth<span class="op">:</span></span>
<span id="cb696-30"><a aria-hidden="true" href="#cb696-30" tabindex="-1"></a>    <span class="co">/* Got composed text - process UTF-8 string */</span></span>
<span id="cb696-31"><a aria-hidden="true" href="#cb696-31" tabindex="-1"></a>    <span class="cf">break</span><span class="op">;</span></span>
<span id="cb696-32"><a aria-hidden="true" href="#cb696-32" tabindex="-1"></a>  <span class="cf">case</span> XLookupKeySym<span class="op">:</span></span>
<span id="cb696-33"><a aria-hidden="true" href="#cb696-33" tabindex="-1"></a>    <span class="co">/* Regular key without composition */</span></span>
<span id="cb696-34"><a aria-hidden="true" href="#cb696-34" tabindex="-1"></a>    <span class="cf">break</span><span class="op">;</span></span>
<span id="cb696-35"><a aria-hidden="true" href="#cb696-35" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb696-36"><a aria-hidden="true" href="#cb696-36" tabindex="-1"></a><span class="pp">#endif</span></span></code></pre></div>
<h3 data-number="19.4.4" id="xinput2-extension"><span class="header-section-number">19.4.4</span> 3.4 XInput2 Extension</h3>
<p>Modern input device support for touchscreens, tablets,
multi-touch:</p>
<div class="sourceCode" id="cb697"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb697-1"><a aria-hidden="true" href="#cb697-1" tabindex="-1"></a><span class="pp">#ifdef HAVE_XINPUT2</span></span>
<span id="cb697-2"><a aria-hidden="true" href="#cb697-2" tabindex="-1"></a><span class="co">/* Enable XI2 events */</span></span>
<span id="cb697-3"><a aria-hidden="true" href="#cb697-3" tabindex="-1"></a>XIEventMask mask<span class="op">;</span></span>
<span id="cb697-4"><a aria-hidden="true" href="#cb697-4" tabindex="-1"></a><span class="dt">unsigned</span> <span class="dt">char</span> mask_bits<span class="op">[</span>XIMaskLen<span class="op">(</span>XI_LASTEVENT<span class="op">)]</span> <span class="op">=</span> <span class="op">{</span><span class="dv">0</span><span class="op">};</span></span>
<span id="cb697-5"><a aria-hidden="true" href="#cb697-5" tabindex="-1"></a></span>
<span id="cb697-6"><a aria-hidden="true" href="#cb697-6" tabindex="-1"></a>mask<span class="op">.</span>deviceid <span class="op">=</span> XIAllDevices<span class="op">;</span></span>
<span id="cb697-7"><a aria-hidden="true" href="#cb697-7" tabindex="-1"></a>mask<span class="op">.</span>mask_len <span class="op">=</span> <span class="kw">sizeof</span><span class="op">(</span>mask_bits<span class="op">);</span></span>
<span id="cb697-8"><a aria-hidden="true" href="#cb697-8" tabindex="-1"></a>mask<span class="op">.</span>mask <span class="op">=</span> mask_bits<span class="op">;</span></span>
<span id="cb697-9"><a aria-hidden="true" href="#cb697-9" tabindex="-1"></a></span>
<span id="cb697-10"><a aria-hidden="true" href="#cb697-10" tabindex="-1"></a>XISetMask<span class="op">(</span>mask_bits<span class="op">,</span> XI_Motion<span class="op">);</span></span>
<span id="cb697-11"><a aria-hidden="true" href="#cb697-11" tabindex="-1"></a>XISetMask<span class="op">(</span>mask_bits<span class="op">,</span> XI_ButtonPress<span class="op">);</span></span>
<span id="cb697-12"><a aria-hidden="true" href="#cb697-12" tabindex="-1"></a>XISetMask<span class="op">(</span>mask_bits<span class="op">,</span> XI_ButtonRelease<span class="op">);</span></span>
<span id="cb697-13"><a aria-hidden="true" href="#cb697-13" tabindex="-1"></a>XISetMask<span class="op">(</span>mask_bits<span class="op">,</span> XI_Enter<span class="op">);</span></span>
<span id="cb697-14"><a aria-hidden="true" href="#cb697-14" tabindex="-1"></a>XISetMask<span class="op">(</span>mask_bits<span class="op">,</span> XI_Leave<span class="op">);</span></span>
<span id="cb697-15"><a aria-hidden="true" href="#cb697-15" tabindex="-1"></a>XISetMask<span class="op">(</span>mask_bits<span class="op">,</span> XI_TouchBegin<span class="op">);</span></span>
<span id="cb697-16"><a aria-hidden="true" href="#cb697-16" tabindex="-1"></a>XISetMask<span class="op">(</span>mask_bits<span class="op">,</span> XI_TouchUpdate<span class="op">);</span></span>
<span id="cb697-17"><a aria-hidden="true" href="#cb697-17" tabindex="-1"></a>XISetMask<span class="op">(</span>mask_bits<span class="op">,</span> XI_TouchEnd<span class="op">);</span></span>
<span id="cb697-18"><a aria-hidden="true" href="#cb697-18" tabindex="-1"></a></span>
<span id="cb697-19"><a aria-hidden="true" href="#cb697-19" tabindex="-1"></a>XISelectEvents<span class="op">(</span>dpyinfo<span class="op">-&gt;</span>display<span class="op">,</span> FRAME_X_WINDOW<span class="op">(</span>f<span class="op">),</span> <span class="op">&amp;</span>mask<span class="op">,</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb697-20"><a aria-hidden="true" href="#cb697-20" tabindex="-1"></a><span class="pp">#endif</span></span></code></pre></div>
<h2 data-number="19.5" id="window-management"><span class="header-section-number">19.5</span> 4. Window Management</h2>
<h3 data-number="19.5.1" id="frame-creation"><span class="header-section-number">19.5.1</span> 4.1 Frame Creation</h3>
<p>Frame creation involves complex interaction with window manager.</p>
<h4 data-number="19.5.1.1" id="frame-creation-steps"><span class="header-section-number">19.5.1.1</span> Frame Creation Steps</h4>
<div class="sourceCode" id="cb698"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb698-1"><a aria-hidden="true" href="#cb698-1" tabindex="-1"></a><span class="co">/* From x_window in xfns.c */</span></span>
<span id="cb698-2"><a aria-hidden="true" href="#cb698-2" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> x_window<span class="op">(</span><span class="kw">struct</span> frame <span class="op">*</span>f<span class="op">)</span></span>
<span id="cb698-3"><a aria-hidden="true" href="#cb698-3" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb698-4"><a aria-hidden="true" href="#cb698-4" tabindex="-1"></a>  XSetWindowAttributes attributes<span class="op">;</span></span>
<span id="cb698-5"><a aria-hidden="true" href="#cb698-5" tabindex="-1"></a>  <span class="dt">unsigned</span> <span class="dt">long</span> attribute_mask<span class="op">;</span></span>
<span id="cb698-6"><a aria-hidden="true" href="#cb698-6" tabindex="-1"></a></span>
<span id="cb698-7"><a aria-hidden="true" href="#cb698-7" tabindex="-1"></a>  <span class="co">/* 1. Setup window attributes */</span></span>
<span id="cb698-8"><a aria-hidden="true" href="#cb698-8" tabindex="-1"></a>  attributes<span class="op">.</span>background_pixel <span class="op">=</span> FRAME_BACKGROUND_PIXEL<span class="op">(</span>f<span class="op">);</span></span>
<span id="cb698-9"><a aria-hidden="true" href="#cb698-9" tabindex="-1"></a>  attributes<span class="op">.</span>border_pixel <span class="op">=</span> f<span class="op">-&gt;</span>output_data<span class="op">.</span>x<span class="op">-&gt;</span>border_pixel<span class="op">;</span></span>
<span id="cb698-10"><a aria-hidden="true" href="#cb698-10" tabindex="-1"></a>  attributes<span class="op">.</span>bit_gravity <span class="op">=</span> StaticGravity<span class="op">;</span></span>
<span id="cb698-11"><a aria-hidden="true" href="#cb698-11" tabindex="-1"></a>  attributes<span class="op">.</span>backing_store <span class="op">=</span> NotUseful<span class="op">;</span></span>
<span id="cb698-12"><a aria-hidden="true" href="#cb698-12" tabindex="-1"></a>  attributes<span class="op">.</span>save_under <span class="op">=</span> True<span class="op">;</span></span>
<span id="cb698-13"><a aria-hidden="true" href="#cb698-13" tabindex="-1"></a>  attributes<span class="op">.</span>event_mask <span class="op">=</span> STANDARD_EVENT_SET<span class="op">;</span></span>
<span id="cb698-14"><a aria-hidden="true" href="#cb698-14" tabindex="-1"></a>  attributes<span class="op">.</span>colormap <span class="op">=</span> FRAME_X_COLORMAP<span class="op">(</span>f<span class="op">);</span></span>
<span id="cb698-15"><a aria-hidden="true" href="#cb698-15" tabindex="-1"></a>  attribute_mask <span class="op">=</span> <span class="op">(</span>CWBackPixel <span class="op">|</span> CWBorderPixel <span class="op">|</span> CWBitGravity</span>
<span id="cb698-16"><a aria-hidden="true" href="#cb698-16" tabindex="-1"></a>                   <span class="op">|</span> CWEventMask <span class="op">|</span> CWColormap<span class="op">);</span></span>
<span id="cb698-17"><a aria-hidden="true" href="#cb698-17" tabindex="-1"></a></span>
<span id="cb698-18"><a aria-hidden="true" href="#cb698-18" tabindex="-1"></a>  <span class="co">/* 2. Create window */</span></span>
<span id="cb698-19"><a aria-hidden="true" href="#cb698-19" tabindex="-1"></a>  FRAME_X_WINDOW<span class="op">(</span>f<span class="op">)</span> <span class="op">=</span> XCreateWindow<span class="op">(</span></span>
<span id="cb698-20"><a aria-hidden="true" href="#cb698-20" tabindex="-1"></a>    FRAME_X_DISPLAY<span class="op">(</span>f<span class="op">),</span></span>
<span id="cb698-21"><a aria-hidden="true" href="#cb698-21" tabindex="-1"></a>    FRAME_DISPLAY_INFO<span class="op">(</span>f<span class="op">)-&gt;</span>root_window<span class="op">,</span></span>
<span id="cb698-22"><a aria-hidden="true" href="#cb698-22" tabindex="-1"></a>    f<span class="op">-&gt;</span>left_pos<span class="op">,</span> f<span class="op">-&gt;</span>top_pos<span class="op">,</span></span>
<span id="cb698-23"><a aria-hidden="true" href="#cb698-23" tabindex="-1"></a>    FRAME_PIXEL_WIDTH<span class="op">(</span>f<span class="op">),</span> FRAME_PIXEL_HEIGHT<span class="op">(</span>f<span class="op">),</span></span>
<span id="cb698-24"><a aria-hidden="true" href="#cb698-24" tabindex="-1"></a>    f<span class="op">-&gt;</span>border_width<span class="op">,</span></span>
<span id="cb698-25"><a aria-hidden="true" href="#cb698-25" tabindex="-1"></a>    FRAME_DISPLAY_INFO<span class="op">(</span>f<span class="op">)-&gt;</span>n_planes<span class="op">,</span></span>
<span id="cb698-26"><a aria-hidden="true" href="#cb698-26" tabindex="-1"></a>    InputOutput<span class="op">,</span></span>
<span id="cb698-27"><a aria-hidden="true" href="#cb698-27" tabindex="-1"></a>    FRAME_X_VISUAL<span class="op">(</span>f<span class="op">),</span></span>
<span id="cb698-28"><a aria-hidden="true" href="#cb698-28" tabindex="-1"></a>    attribute_mask<span class="op">,</span> <span class="op">&amp;</span>attributes</span>
<span id="cb698-29"><a aria-hidden="true" href="#cb698-29" tabindex="-1"></a>  <span class="op">);</span></span>
<span id="cb698-30"><a aria-hidden="true" href="#cb698-30" tabindex="-1"></a></span>
<span id="cb698-31"><a aria-hidden="true" href="#cb698-31" tabindex="-1"></a>  <span class="co">/* 3. Set window manager hints */</span></span>
<span id="cb698-32"><a aria-hidden="true" href="#cb698-32" tabindex="-1"></a>  x_set_wm_hints<span class="op">(</span>f<span class="op">);</span></span>
<span id="cb698-33"><a aria-hidden="true" href="#cb698-33" tabindex="-1"></a></span>
<span id="cb698-34"><a aria-hidden="true" href="#cb698-34" tabindex="-1"></a>  <span class="co">/* 4. Set WM protocols */</span></span>
<span id="cb698-35"><a aria-hidden="true" href="#cb698-35" tabindex="-1"></a>  Atom protocols<span class="op">[</span><span class="dv">2</span><span class="op">];</span></span>
<span id="cb698-36"><a aria-hidden="true" href="#cb698-36" tabindex="-1"></a>  <span class="dt">int</span> n_protocols <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb698-37"><a aria-hidden="true" href="#cb698-37" tabindex="-1"></a>  protocols<span class="op">[</span>n_protocols<span class="op">++]</span> <span class="op">=</span> FRAME_DISPLAY_INFO<span class="op">(</span>f<span class="op">)-&gt;</span>Xatom_wm_delete_window<span class="op">;</span></span>
<span id="cb698-38"><a aria-hidden="true" href="#cb698-38" tabindex="-1"></a>  protocols<span class="op">[</span>n_protocols<span class="op">++]</span> <span class="op">=</span> FRAME_DISPLAY_INFO<span class="op">(</span>f<span class="op">)-&gt;</span>Xatom_wm_take_focus<span class="op">;</span></span>
<span id="cb698-39"><a aria-hidden="true" href="#cb698-39" tabindex="-1"></a>  XSetWMProtocols<span class="op">(</span>FRAME_X_DISPLAY<span class="op">(</span>f<span class="op">),</span> FRAME_X_WINDOW<span class="op">(</span>f<span class="op">),</span></span>
<span id="cb698-40"><a aria-hidden="true" href="#cb698-40" tabindex="-1"></a>                  protocols<span class="op">,</span> n_protocols<span class="op">);</span></span>
<span id="cb698-41"><a aria-hidden="true" href="#cb698-41" tabindex="-1"></a></span>
<span id="cb698-42"><a aria-hidden="true" href="#cb698-42" tabindex="-1"></a>  <span class="co">/* 5. Setup double buffering if available */</span></span>
<span id="cb698-43"><a aria-hidden="true" href="#cb698-43" tabindex="-1"></a><span class="pp">#ifdef HAVE_XDBE</span></span>
<span id="cb698-44"><a aria-hidden="true" href="#cb698-44" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>dpyinfo<span class="op">-&gt;</span>supports_xdbe<span class="op">)</span> <span class="op">{</span></span>
<span id="cb698-45"><a aria-hidden="true" href="#cb698-45" tabindex="-1"></a>    FRAME_X_RAW_DRAWABLE<span class="op">(</span>f<span class="op">)</span> <span class="op">=</span> XdbeAllocateBackBufferName<span class="op">(</span></span>
<span id="cb698-46"><a aria-hidden="true" href="#cb698-46" tabindex="-1"></a>      FRAME_X_DISPLAY<span class="op">(</span>f<span class="op">),</span> FRAME_X_WINDOW<span class="op">(</span>f<span class="op">),</span> XdbeBackground</span>
<span id="cb698-47"><a aria-hidden="true" href="#cb698-47" tabindex="-1"></a>    <span class="op">);</span></span>
<span id="cb698-48"><a aria-hidden="true" href="#cb698-48" tabindex="-1"></a>  <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb698-49"><a aria-hidden="true" href="#cb698-49" tabindex="-1"></a>    FRAME_X_RAW_DRAWABLE<span class="op">(</span>f<span class="op">)</span> <span class="op">=</span> FRAME_X_WINDOW<span class="op">(</span>f<span class="op">);</span></span>
<span id="cb698-50"><a aria-hidden="true" href="#cb698-50" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb698-51"><a aria-hidden="true" href="#cb698-51" tabindex="-1"></a><span class="pp">#else</span></span>
<span id="cb698-52"><a aria-hidden="true" href="#cb698-52" tabindex="-1"></a>  FRAME_X_RAW_DRAWABLE<span class="op">(</span>f<span class="op">)</span> <span class="op">=</span> FRAME_X_WINDOW<span class="op">(</span>f<span class="op">);</span></span>
<span id="cb698-53"><a aria-hidden="true" href="#cb698-53" tabindex="-1"></a><span class="pp">#endif</span></span>
<span id="cb698-54"><a aria-hidden="true" href="#cb698-54" tabindex="-1"></a></span>
<span id="cb698-55"><a aria-hidden="true" href="#cb698-55" tabindex="-1"></a>  <span class="co">/* 6. Create graphics contexts */</span></span>
<span id="cb698-56"><a aria-hidden="true" href="#cb698-56" tabindex="-1"></a>  x_make_gc<span class="op">(</span>f<span class="op">);</span></span>
<span id="cb698-57"><a aria-hidden="true" href="#cb698-57" tabindex="-1"></a></span>
<span id="cb698-58"><a aria-hidden="true" href="#cb698-58" tabindex="-1"></a>  <span class="co">/* 7. Set various properties */</span></span>
<span id="cb698-59"><a aria-hidden="true" href="#cb698-59" tabindex="-1"></a>  x_set_name<span class="op">(</span>f<span class="op">,</span> f<span class="op">-&gt;</span>name<span class="op">,</span> <span class="kw">true</span><span class="op">);</span></span>
<span id="cb698-60"><a aria-hidden="true" href="#cb698-60" tabindex="-1"></a>  x_set_icon_name<span class="op">(</span>f<span class="op">,</span> f<span class="op">-&gt;</span>icon_name<span class="op">);</span></span>
<span id="cb698-61"><a aria-hidden="true" href="#cb698-61" tabindex="-1"></a></span>
<span id="cb698-62"><a aria-hidden="true" href="#cb698-62" tabindex="-1"></a>  <span class="co">/* 8. Map window to make it visible */</span></span>
<span id="cb698-63"><a aria-hidden="true" href="#cb698-63" tabindex="-1"></a>  XMapWindow<span class="op">(</span>FRAME_X_DISPLAY<span class="op">(</span>f<span class="op">),</span> FRAME_X_WINDOW<span class="op">(</span>f<span class="op">));</span></span>
<span id="cb698-64"><a aria-hidden="true" href="#cb698-64" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 data-number="19.5.2" id="window-manager-hints"><span class="header-section-number">19.5.2</span> 4.2 Window Manager
Hints</h3>
<h4 data-number="19.5.2.1" id="wm_normal_hints-size-hints"><span class="header-section-number">19.5.2.1</span> WM_NORMAL_HINTS (Size
Hints)</h4>
<div class="sourceCode" id="cb699"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb699-1"><a aria-hidden="true" href="#cb699-1" tabindex="-1"></a><span class="dt">void</span> x_wm_set_size_hint<span class="op">(</span><span class="kw">struct</span> frame <span class="op">*</span>f<span class="op">,</span> <span class="dt">long</span> flags<span class="op">,</span> <span class="dt">bool</span> user_position<span class="op">)</span></span>
<span id="cb699-2"><a aria-hidden="true" href="#cb699-2" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb699-3"><a aria-hidden="true" href="#cb699-3" tabindex="-1"></a>  XSizeHints size_hints<span class="op">;</span></span>
<span id="cb699-4"><a aria-hidden="true" href="#cb699-4" tabindex="-1"></a></span>
<span id="cb699-5"><a aria-hidden="true" href="#cb699-5" tabindex="-1"></a>  <span class="co">/* Base size (frame without text area) */</span></span>
<span id="cb699-6"><a aria-hidden="true" href="#cb699-6" tabindex="-1"></a>  size_hints<span class="op">.</span>base_width <span class="op">=</span> FRAME_TEXT_COLS_TO_PIXEL_WIDTH<span class="op">(</span>f<span class="op">,</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb699-7"><a aria-hidden="true" href="#cb699-7" tabindex="-1"></a>  size_hints<span class="op">.</span>base_height <span class="op">=</span> FRAME_TEXT_LINES_TO_PIXEL_HEIGHT<span class="op">(</span>f<span class="op">,</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb699-8"><a aria-hidden="true" href="#cb699-8" tabindex="-1"></a></span>
<span id="cb699-9"><a aria-hidden="true" href="#cb699-9" tabindex="-1"></a>  <span class="co">/* Size increments (for text resize) */</span></span>
<span id="cb699-10"><a aria-hidden="true" href="#cb699-10" tabindex="-1"></a>  size_hints<span class="op">.</span>width_inc <span class="op">=</span> FRAME_COLUMN_WIDTH<span class="op">(</span>f<span class="op">);</span></span>
<span id="cb699-11"><a aria-hidden="true" href="#cb699-11" tabindex="-1"></a>  size_hints<span class="op">.</span>height_inc <span class="op">=</span> FRAME_LINE_HEIGHT<span class="op">(</span>f<span class="op">);</span></span>
<span id="cb699-12"><a aria-hidden="true" href="#cb699-12" tabindex="-1"></a></span>
<span id="cb699-13"><a aria-hidden="true" href="#cb699-13" tabindex="-1"></a>  <span class="co">/* Min/max sizes */</span></span>
<span id="cb699-14"><a aria-hidden="true" href="#cb699-14" tabindex="-1"></a>  size_hints<span class="op">.</span>min_width <span class="op">=</span> size_hints<span class="op">.</span>base_width<span class="op">;</span></span>
<span id="cb699-15"><a aria-hidden="true" href="#cb699-15" tabindex="-1"></a>  size_hints<span class="op">.</span>min_height <span class="op">=</span> size_hints<span class="op">.</span>base_height<span class="op">;</span></span>
<span id="cb699-16"><a aria-hidden="true" href="#cb699-16" tabindex="-1"></a>  size_hints<span class="op">.</span>max_width <span class="op">=</span> x_display_pixel_width<span class="op">(</span>FRAME_DISPLAY_INFO<span class="op">(</span>f<span class="op">));</span></span>
<span id="cb699-17"><a aria-hidden="true" href="#cb699-17" tabindex="-1"></a>  size_hints<span class="op">.</span>max_height <span class="op">=</span> x_display_pixel_height<span class="op">(</span>FRAME_DISPLAY_INFO<span class="op">(</span>f<span class="op">));</span></span>
<span id="cb699-18"><a aria-hidden="true" href="#cb699-18" tabindex="-1"></a></span>
<span id="cb699-19"><a aria-hidden="true" href="#cb699-19" tabindex="-1"></a>  <span class="co">/* Position */</span></span>
<span id="cb699-20"><a aria-hidden="true" href="#cb699-20" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>user_position<span class="op">)</span> <span class="op">{</span></span>
<span id="cb699-21"><a aria-hidden="true" href="#cb699-21" tabindex="-1"></a>    size_hints<span class="op">.</span>flags <span class="op">|=</span> USPosition<span class="op">;</span></span>
<span id="cb699-22"><a aria-hidden="true" href="#cb699-22" tabindex="-1"></a>    size_hints<span class="op">.</span>x <span class="op">=</span> f<span class="op">-&gt;</span>left_pos<span class="op">;</span></span>
<span id="cb699-23"><a aria-hidden="true" href="#cb699-23" tabindex="-1"></a>    size_hints<span class="op">.</span>y <span class="op">=</span> f<span class="op">-&gt;</span>top_pos<span class="op">;</span></span>
<span id="cb699-24"><a aria-hidden="true" href="#cb699-24" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb699-25"><a aria-hidden="true" href="#cb699-25" tabindex="-1"></a></span>
<span id="cb699-26"><a aria-hidden="true" href="#cb699-26" tabindex="-1"></a>  size_hints<span class="op">.</span>flags <span class="op">|=</span> PSize <span class="op">|</span> PResizeInc <span class="op">|</span> PMinSize <span class="op">|</span> PMaxSize <span class="op">|</span> PBaseSize<span class="op">;</span></span>
<span id="cb699-27"><a aria-hidden="true" href="#cb699-27" tabindex="-1"></a></span>
<span id="cb699-28"><a aria-hidden="true" href="#cb699-28" tabindex="-1"></a>  XSetWMNormalHints<span class="op">(</span>FRAME_X_DISPLAY<span class="op">(</span>f<span class="op">),</span> FRAME_OUTER_WINDOW<span class="op">(</span>f<span class="op">),</span> <span class="op">&amp;</span>size_hints<span class="op">);</span></span>
<span id="cb699-29"><a aria-hidden="true" href="#cb699-29" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h4 data-number="19.5.2.2" id="wm_hints-window-manager-hints"><span class="header-section-number">19.5.2.2</span> WM_HINTS (Window Manager
Hints)</h4>
<div class="sourceCode" id="cb700"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb700-1"><a aria-hidden="true" href="#cb700-1" tabindex="-1"></a><span class="dt">void</span> x_wm_set_wm_hints<span class="op">(</span><span class="kw">struct</span> frame <span class="op">*</span>f<span class="op">)</span></span>
<span id="cb700-2"><a aria-hidden="true" href="#cb700-2" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb700-3"><a aria-hidden="true" href="#cb700-3" tabindex="-1"></a>  XWMHints wm_hints<span class="op">;</span></span>
<span id="cb700-4"><a aria-hidden="true" href="#cb700-4" tabindex="-1"></a></span>
<span id="cb700-5"><a aria-hidden="true" href="#cb700-5" tabindex="-1"></a>  wm_hints<span class="op">.</span>flags <span class="op">=</span> InputHint <span class="op">|</span> StateHint<span class="op">;</span></span>
<span id="cb700-6"><a aria-hidden="true" href="#cb700-6" tabindex="-1"></a>  wm_hints<span class="op">.</span>input <span class="op">=</span> True<span class="op">;</span>  <span class="co">/* We want input */</span></span>
<span id="cb700-7"><a aria-hidden="true" href="#cb700-7" tabindex="-1"></a>  wm_hints<span class="op">.</span>initial_state <span class="op">=</span> f<span class="op">-&gt;</span>want_fullscreen <span class="op">?</span> IconicState <span class="op">:</span> NormalState<span class="op">;</span></span>
<span id="cb700-8"><a aria-hidden="true" href="#cb700-8" tabindex="-1"></a></span>
<span id="cb700-9"><a aria-hidden="true" href="#cb700-9" tabindex="-1"></a>  <span class="co">/* Icon pixmap */</span></span>
<span id="cb700-10"><a aria-hidden="true" href="#cb700-10" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>f<span class="op">-&gt;</span>output_data<span class="op">.</span>x<span class="op">-&gt;</span>icon_bitmap <span class="op">&gt;</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb700-11"><a aria-hidden="true" href="#cb700-11" tabindex="-1"></a>    wm_hints<span class="op">.</span>flags <span class="op">|=</span> IconPixmapHint<span class="op">;</span></span>
<span id="cb700-12"><a aria-hidden="true" href="#cb700-12" tabindex="-1"></a>    wm_hints<span class="op">.</span>icon_pixmap <span class="op">=</span> f<span class="op">-&gt;</span>output_data<span class="op">.</span>x<span class="op">-&gt;</span>icon_bitmap<span class="op">;</span></span>
<span id="cb700-13"><a aria-hidden="true" href="#cb700-13" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb700-14"><a aria-hidden="true" href="#cb700-14" tabindex="-1"></a></span>
<span id="cb700-15"><a aria-hidden="true" href="#cb700-15" tabindex="-1"></a>  <span class="co">/* Window group */</span></span>
<span id="cb700-16"><a aria-hidden="true" href="#cb700-16" tabindex="-1"></a>  wm_hints<span class="op">.</span>flags <span class="op">|=</span> WindowGroupHint<span class="op">;</span></span>
<span id="cb700-17"><a aria-hidden="true" href="#cb700-17" tabindex="-1"></a>  wm_hints<span class="op">.</span>window_group <span class="op">=</span> FRAME_DISPLAY_INFO<span class="op">(</span>f<span class="op">)-&gt;</span>client_leader_window<span class="op">;</span></span>
<span id="cb700-18"><a aria-hidden="true" href="#cb700-18" tabindex="-1"></a></span>
<span id="cb700-19"><a aria-hidden="true" href="#cb700-19" tabindex="-1"></a>  XSetWMHints<span class="op">(</span>FRAME_X_DISPLAY<span class="op">(</span>f<span class="op">),</span> FRAME_OUTER_WINDOW<span class="op">(</span>f<span class="op">),</span> <span class="op">&amp;</span>wm_hints<span class="op">);</span></span>
<span id="cb700-20"><a aria-hidden="true" href="#cb700-20" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h4 data-number="19.5.2.3" id="net_wm-hints-extended-window-manager-hints"><span class="header-section-number">19.5.2.3</span> _NET_WM Hints (Extended
Window Manager Hints)</h4>
<div class="sourceCode" id="cb701"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb701-1"><a aria-hidden="true" href="#cb701-1" tabindex="-1"></a><span class="co">/* Set window type */</span></span>
<span id="cb701-2"><a aria-hidden="true" href="#cb701-2" tabindex="-1"></a>Atom window_type <span class="op">=</span> XInternAtom<span class="op">(</span>display<span class="op">,</span> <span class="st">"_NET_WM_WINDOW_TYPE_NORMAL"</span><span class="op">,</span> False<span class="op">);</span></span>
<span id="cb701-3"><a aria-hidden="true" href="#cb701-3" tabindex="-1"></a>XChangeProperty<span class="op">(</span>display<span class="op">,</span> window<span class="op">,</span></span>
<span id="cb701-4"><a aria-hidden="true" href="#cb701-4" tabindex="-1"></a>                XInternAtom<span class="op">(</span>display<span class="op">,</span> <span class="st">"_NET_WM_WINDOW_TYPE"</span><span class="op">,</span> False<span class="op">),</span></span>
<span id="cb701-5"><a aria-hidden="true" href="#cb701-5" tabindex="-1"></a>                XA_ATOM<span class="op">,</span> <span class="dv">32</span><span class="op">,</span> PropModeReplace<span class="op">,</span></span>
<span id="cb701-6"><a aria-hidden="true" href="#cb701-6" tabindex="-1"></a>                <span class="op">(</span><span class="dt">unsigned</span> <span class="dt">char</span> <span class="op">*)&amp;</span>window_type<span class="op">,</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb701-7"><a aria-hidden="true" href="#cb701-7" tabindex="-1"></a></span>
<span id="cb701-8"><a aria-hidden="true" href="#cb701-8" tabindex="-1"></a><span class="co">/* Set window state (fullscreen, maximized, etc.) */</span></span>
<span id="cb701-9"><a aria-hidden="true" href="#cb701-9" tabindex="-1"></a><span class="cf">if</span> <span class="op">(</span>fullscreen<span class="op">)</span> <span class="op">{</span></span>
<span id="cb701-10"><a aria-hidden="true" href="#cb701-10" tabindex="-1"></a>  Atom state <span class="op">=</span> XInternAtom<span class="op">(</span>display<span class="op">,</span> <span class="st">"_NET_WM_STATE_FULLSCREEN"</span><span class="op">,</span> False<span class="op">);</span></span>
<span id="cb701-11"><a aria-hidden="true" href="#cb701-11" tabindex="-1"></a>  XChangeProperty<span class="op">(</span>display<span class="op">,</span> window<span class="op">,</span></span>
<span id="cb701-12"><a aria-hidden="true" href="#cb701-12" tabindex="-1"></a>                  XInternAtom<span class="op">(</span>display<span class="op">,</span> <span class="st">"_NET_WM_STATE"</span><span class="op">,</span> False<span class="op">),</span></span>
<span id="cb701-13"><a aria-hidden="true" href="#cb701-13" tabindex="-1"></a>                  XA_ATOM<span class="op">,</span> <span class="dv">32</span><span class="op">,</span> PropModeReplace<span class="op">,</span></span>
<span id="cb701-14"><a aria-hidden="true" href="#cb701-14" tabindex="-1"></a>                  <span class="op">(</span><span class="dt">unsigned</span> <span class="dt">char</span> <span class="op">*)&amp;</span>state<span class="op">,</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb701-15"><a aria-hidden="true" href="#cb701-15" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h4 data-number="19.5.2.4" id="motif-window-manager-hints"><span class="header-section-number">19.5.2.4</span> Motif Window Manager
Hints</h4>
<p>For borderless windows or custom decorations:</p>
<div class="sourceCode" id="cb702"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb702-1"><a aria-hidden="true" href="#cb702-1" tabindex="-1"></a><span class="pp">#define MWM_HINTS_DECORATIONS </span><span class="op">(</span><span class="dv">1</span><span class="bu">L</span><span class="pp"> </span><span class="op">&lt;&lt;</span><span class="pp"> </span><span class="dv">1</span><span class="op">)</span></span>
<span id="cb702-2"><a aria-hidden="true" href="#cb702-2" tabindex="-1"></a><span class="pp">#define MWM_DECOR_ALL         </span><span class="op">(</span><span class="dv">1</span><span class="bu">L</span><span class="pp"> </span><span class="op">&lt;&lt;</span><span class="pp"> </span><span class="dv">0</span><span class="op">)</span></span>
<span id="cb702-3"><a aria-hidden="true" href="#cb702-3" tabindex="-1"></a></span>
<span id="cb702-4"><a aria-hidden="true" href="#cb702-4" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb702-5"><a aria-hidden="true" href="#cb702-5" tabindex="-1"></a>  <span class="dt">unsigned</span> <span class="dt">long</span> flags<span class="op">;</span></span>
<span id="cb702-6"><a aria-hidden="true" href="#cb702-6" tabindex="-1"></a>  <span class="dt">unsigned</span> <span class="dt">long</span> functions<span class="op">;</span></span>
<span id="cb702-7"><a aria-hidden="true" href="#cb702-7" tabindex="-1"></a>  <span class="dt">unsigned</span> <span class="dt">long</span> decorations<span class="op">;</span></span>
<span id="cb702-8"><a aria-hidden="true" href="#cb702-8" tabindex="-1"></a>  <span class="dt">long</span> input_mode<span class="op">;</span></span>
<span id="cb702-9"><a aria-hidden="true" href="#cb702-9" tabindex="-1"></a>  <span class="dt">unsigned</span> <span class="dt">long</span> status<span class="op">;</span></span>
<span id="cb702-10"><a aria-hidden="true" href="#cb702-10" tabindex="-1"></a><span class="op">}</span> MwmHints<span class="op">;</span></span>
<span id="cb702-11"><a aria-hidden="true" href="#cb702-11" tabindex="-1"></a></span>
<span id="cb702-12"><a aria-hidden="true" href="#cb702-12" tabindex="-1"></a><span class="dt">void</span> x_set_mwm_hints<span class="op">(</span><span class="kw">struct</span> frame <span class="op">*</span>f<span class="op">,</span> <span class="dt">bool</span> decorated<span class="op">)</span></span>
<span id="cb702-13"><a aria-hidden="true" href="#cb702-13" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb702-14"><a aria-hidden="true" href="#cb702-14" tabindex="-1"></a>  MwmHints hints<span class="op">;</span></span>
<span id="cb702-15"><a aria-hidden="true" href="#cb702-15" tabindex="-1"></a>  Atom prop <span class="op">=</span> XInternAtom<span class="op">(</span>FRAME_X_DISPLAY<span class="op">(</span>f<span class="op">),</span> <span class="st">"_MOTIF_WM_HINTS"</span><span class="op">,</span> False<span class="op">);</span></span>
<span id="cb702-16"><a aria-hidden="true" href="#cb702-16" tabindex="-1"></a></span>
<span id="cb702-17"><a aria-hidden="true" href="#cb702-17" tabindex="-1"></a>  hints<span class="op">.</span>flags <span class="op">=</span> MWM_HINTS_DECORATIONS<span class="op">;</span></span>
<span id="cb702-18"><a aria-hidden="true" href="#cb702-18" tabindex="-1"></a>  hints<span class="op">.</span>decorations <span class="op">=</span> decorated <span class="op">?</span> MWM_DECOR_ALL <span class="op">:</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb702-19"><a aria-hidden="true" href="#cb702-19" tabindex="-1"></a></span>
<span id="cb702-20"><a aria-hidden="true" href="#cb702-20" tabindex="-1"></a>  XChangeProperty<span class="op">(</span>FRAME_X_DISPLAY<span class="op">(</span>f<span class="op">),</span> FRAME_OUTER_WINDOW<span class="op">(</span>f<span class="op">),</span></span>
<span id="cb702-21"><a aria-hidden="true" href="#cb702-21" tabindex="-1"></a>                  prop<span class="op">,</span> prop<span class="op">,</span> <span class="dv">32</span><span class="op">,</span> PropModeReplace<span class="op">,</span></span>
<span id="cb702-22"><a aria-hidden="true" href="#cb702-22" tabindex="-1"></a>                  <span class="op">(</span><span class="dt">unsigned</span> <span class="dt">char</span> <span class="op">*)&amp;</span>hints<span class="op">,</span> <span class="dv">5</span><span class="op">);</span></span>
<span id="cb702-23"><a aria-hidden="true" href="#cb702-23" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 data-number="19.5.3" id="desktop-integration"><span class="header-section-number">19.5.3</span> 4.3 Desktop Integration</h3>
<h4 data-number="19.5.3.1" id="desktop-notifications-via-d-bus"><span class="header-section-number">19.5.3.1</span> Desktop Notifications (via
D-Bus)</h4>
<p>Emacs uses D-Bus for desktop notifications (implemented in Lisp
calling D-Bus):</p>
<pre class="elisp"><code>;; From notifications.el
(defun notifications-notify (&amp;rest params)
  "Send notification via D-Bus to notification daemon"
  (dbus-call-method :session
                    "org.freedesktop.Notifications"
                    "/org/freedesktop/Notifications"
                    "org.freedesktop.Notifications"
                    "Notify"
                    app-name
                    replaces-id
                    app-icon
                    summary
                    body
                    actions
                    hints
                    timeout))</code></pre>
<h4 data-number="19.5.3.2" id="system-tray-integration"><span class="header-section-number">19.5.3.2</span> System Tray
Integration</h4>
<p>For system tray icon (when compiled with GTK or toolkit):</p>
<div class="sourceCode" id="cb704"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb704-1"><a aria-hidden="true" href="#cb704-1" tabindex="-1"></a><span class="co">/* GTK system tray implementation */</span></span>
<span id="cb704-2"><a aria-hidden="true" href="#cb704-2" tabindex="-1"></a><span class="pp">#ifdef USE_GTK</span></span>
<span id="cb704-3"><a aria-hidden="true" href="#cb704-3" tabindex="-1"></a>GtkStatusIcon <span class="op">*</span>icon <span class="op">=</span> gtk_status_icon_new_from_file<span class="op">(</span>icon_file<span class="op">);</span></span>
<span id="cb704-4"><a aria-hidden="true" href="#cb704-4" tabindex="-1"></a>gtk_status_icon_set_tooltip_text<span class="op">(</span>icon<span class="op">,</span> tooltip<span class="op">);</span></span>
<span id="cb704-5"><a aria-hidden="true" href="#cb704-5" tabindex="-1"></a>g_signal_connect<span class="op">(</span>icon<span class="op">,</span> <span class="st">"activate"</span><span class="op">,</span> G_CALLBACK<span class="op">(</span>tray_icon_callback<span class="op">),</span> NULL<span class="op">);</span></span>
<span id="cb704-6"><a aria-hidden="true" href="#cb704-6" tabindex="-1"></a><span class="pp">#endif</span></span></code></pre></div>
<h4 data-number="19.5.3.3" id="xembed-protocol"><span class="header-section-number">19.5.3.3</span> XEmbed Protocol</h4>
<p>For embedding in other applications:</p>
<div class="sourceCode" id="cb705"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb705-1"><a aria-hidden="true" href="#cb705-1" tabindex="-1"></a><span class="co">/* XEMBED protocol support */</span></span>
<span id="cb705-2"><a aria-hidden="true" href="#cb705-2" tabindex="-1"></a><span class="dt">void</span> x_embed_frame<span class="op">(</span><span class="kw">struct</span> frame <span class="op">*</span>f<span class="op">,</span> Window embedder_window<span class="op">)</span></span>
<span id="cb705-3"><a aria-hidden="true" href="#cb705-3" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb705-4"><a aria-hidden="true" href="#cb705-4" tabindex="-1"></a>  <span class="co">/* Send XEMBED_EMBEDDED_NOTIFY message */</span></span>
<span id="cb705-5"><a aria-hidden="true" href="#cb705-5" tabindex="-1"></a>  XClientMessageEvent xev<span class="op">;</span></span>
<span id="cb705-6"><a aria-hidden="true" href="#cb705-6" tabindex="-1"></a>  xev<span class="op">.</span>type <span class="op">=</span> ClientMessage<span class="op">;</span></span>
<span id="cb705-7"><a aria-hidden="true" href="#cb705-7" tabindex="-1"></a>  xev<span class="op">.</span>window <span class="op">=</span> FRAME_OUTER_WINDOW<span class="op">(</span>f<span class="op">);</span></span>
<span id="cb705-8"><a aria-hidden="true" href="#cb705-8" tabindex="-1"></a>  xev<span class="op">.</span>message_type <span class="op">=</span> dpyinfo<span class="op">-&gt;</span>Xatom_XEMBED<span class="op">;</span></span>
<span id="cb705-9"><a aria-hidden="true" href="#cb705-9" tabindex="-1"></a>  xev<span class="op">.</span>format <span class="op">=</span> <span class="dv">32</span><span class="op">;</span></span>
<span id="cb705-10"><a aria-hidden="true" href="#cb705-10" tabindex="-1"></a>  xev<span class="op">.</span>data<span class="op">.</span>l<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">=</span> CurrentTime<span class="op">;</span></span>
<span id="cb705-11"><a aria-hidden="true" href="#cb705-11" tabindex="-1"></a>  xev<span class="op">.</span>data<span class="op">.</span>l<span class="op">[</span><span class="dv">1</span><span class="op">]</span> <span class="op">=</span> XEMBED_EMBEDDED_NOTIFY<span class="op">;</span></span>
<span id="cb705-12"><a aria-hidden="true" href="#cb705-12" tabindex="-1"></a>  xev<span class="op">.</span>data<span class="op">.</span>l<span class="op">[</span><span class="dv">2</span><span class="op">]</span> <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb705-13"><a aria-hidden="true" href="#cb705-13" tabindex="-1"></a>  xev<span class="op">.</span>data<span class="op">.</span>l<span class="op">[</span><span class="dv">3</span><span class="op">]</span> <span class="op">=</span> embedder_window<span class="op">;</span></span>
<span id="cb705-14"><a aria-hidden="true" href="#cb705-14" tabindex="-1"></a>  xev<span class="op">.</span>data<span class="op">.</span>l<span class="op">[</span><span class="dv">4</span><span class="op">]</span> <span class="op">=</span> <span class="dv">0</span><span class="op">;</span>  <span class="co">/* XEMBED version */</span></span>
<span id="cb705-15"><a aria-hidden="true" href="#cb705-15" tabindex="-1"></a></span>
<span id="cb705-16"><a aria-hidden="true" href="#cb705-16" tabindex="-1"></a>  XSendEvent<span class="op">(</span>dpyinfo<span class="op">-&gt;</span>display<span class="op">,</span> embedder_window<span class="op">,</span> False<span class="op">,</span> NoEventMask<span class="op">,</span></span>
<span id="cb705-17"><a aria-hidden="true" href="#cb705-17" tabindex="-1"></a>             <span class="op">(</span>XEvent <span class="op">*)&amp;</span>xev<span class="op">);</span></span>
<span id="cb705-18"><a aria-hidden="true" href="#cb705-18" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 data-number="19.5.4" id="multi-monitor-support"><span class="header-section-number">19.5.4</span> 4.4 Multi-Monitor
Support</h3>
<h4 data-number="19.5.4.1" id="xrandr-extension"><span class="header-section-number">19.5.4.1</span> Xrandr Extension</h4>
<div class="sourceCode" id="cb706"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb706-1"><a aria-hidden="true" href="#cb706-1" tabindex="-1"></a><span class="pp">#ifdef HAVE_XRANDR</span></span>
<span id="cb706-2"><a aria-hidden="true" href="#cb706-2" tabindex="-1"></a><span class="co">/* Query monitor configuration */</span></span>
<span id="cb706-3"><a aria-hidden="true" href="#cb706-3" tabindex="-1"></a><span class="dt">void</span> x_get_monitor_attributes<span class="op">(</span><span class="kw">struct</span> x_display_info <span class="op">*</span>dpyinfo<span class="op">)</span></span>
<span id="cb706-4"><a aria-hidden="true" href="#cb706-4" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb706-5"><a aria-hidden="true" href="#cb706-5" tabindex="-1"></a>  XRRScreenResources <span class="op">*</span>resources<span class="op">;</span></span>
<span id="cb706-6"><a aria-hidden="true" href="#cb706-6" tabindex="-1"></a>  XRROutputInfo <span class="op">*</span>output_info<span class="op">;</span></span>
<span id="cb706-7"><a aria-hidden="true" href="#cb706-7" tabindex="-1"></a>  XRRCrtcInfo <span class="op">*</span>crtc_info<span class="op">;</span></span>
<span id="cb706-8"><a aria-hidden="true" href="#cb706-8" tabindex="-1"></a></span>
<span id="cb706-9"><a aria-hidden="true" href="#cb706-9" tabindex="-1"></a>  resources <span class="op">=</span> XRRGetScreenResources<span class="op">(</span>dpyinfo<span class="op">-&gt;</span>display<span class="op">,</span> dpyinfo<span class="op">-&gt;</span>root_window<span class="op">);</span></span>
<span id="cb706-10"><a aria-hidden="true" href="#cb706-10" tabindex="-1"></a></span>
<span id="cb706-11"><a aria-hidden="true" href="#cb706-11" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> resources<span class="op">-&gt;</span>noutput<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb706-12"><a aria-hidden="true" href="#cb706-12" tabindex="-1"></a>    output_info <span class="op">=</span> XRRGetOutputInfo<span class="op">(</span>dpyinfo<span class="op">-&gt;</span>display<span class="op">,</span> resources<span class="op">,</span></span>
<span id="cb706-13"><a aria-hidden="true" href="#cb706-13" tabindex="-1"></a>                                   resources<span class="op">-&gt;</span>outputs<span class="op">[</span>i<span class="op">]);</span></span>
<span id="cb706-14"><a aria-hidden="true" href="#cb706-14" tabindex="-1"></a></span>
<span id="cb706-15"><a aria-hidden="true" href="#cb706-15" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>output_info<span class="op">-&gt;</span>connection <span class="op">==</span> RR_Connected<span class="op">)</span> <span class="op">{</span></span>
<span id="cb706-16"><a aria-hidden="true" href="#cb706-16" tabindex="-1"></a>      crtc_info <span class="op">=</span> XRRGetCrtcInfo<span class="op">(</span>dpyinfo<span class="op">-&gt;</span>display<span class="op">,</span> resources<span class="op">,</span></span>
<span id="cb706-17"><a aria-hidden="true" href="#cb706-17" tabindex="-1"></a>                                 output_info<span class="op">-&gt;</span>crtc<span class="op">);</span></span>
<span id="cb706-18"><a aria-hidden="true" href="#cb706-18" tabindex="-1"></a></span>
<span id="cb706-19"><a aria-hidden="true" href="#cb706-19" tabindex="-1"></a>      <span class="co">/* Store monitor geometry */</span></span>
<span id="cb706-20"><a aria-hidden="true" href="#cb706-20" tabindex="-1"></a>      MonitorInfo <span class="op">*</span>monitor <span class="op">=</span> <span class="op">&amp;</span>dpyinfo<span class="op">-&gt;</span>monitors<span class="op">[</span>n_monitors<span class="op">++];</span></span>
<span id="cb706-21"><a aria-hidden="true" href="#cb706-21" tabindex="-1"></a>      monitor<span class="op">-&gt;</span>geom<span class="op">.</span>x <span class="op">=</span> crtc_info<span class="op">-&gt;</span>x<span class="op">;</span></span>
<span id="cb706-22"><a aria-hidden="true" href="#cb706-22" tabindex="-1"></a>      monitor<span class="op">-&gt;</span>geom<span class="op">.</span>y <span class="op">=</span> crtc_info<span class="op">-&gt;</span>y<span class="op">;</span></span>
<span id="cb706-23"><a aria-hidden="true" href="#cb706-23" tabindex="-1"></a>      monitor<span class="op">-&gt;</span>geom<span class="op">.</span>width <span class="op">=</span> crtc_info<span class="op">-&gt;</span>width<span class="op">;</span></span>
<span id="cb706-24"><a aria-hidden="true" href="#cb706-24" tabindex="-1"></a>      monitor<span class="op">-&gt;</span>geom<span class="op">.</span>height <span class="op">=</span> crtc_info<span class="op">-&gt;</span>height<span class="op">;</span></span>
<span id="cb706-25"><a aria-hidden="true" href="#cb706-25" tabindex="-1"></a>      monitor<span class="op">-&gt;</span>name <span class="op">=</span> xstrdup<span class="op">(</span>output_info<span class="op">-&gt;</span>name<span class="op">);</span></span>
<span id="cb706-26"><a aria-hidden="true" href="#cb706-26" tabindex="-1"></a></span>
<span id="cb706-27"><a aria-hidden="true" href="#cb706-27" tabindex="-1"></a>      <span class="co">/* Calculate DPI */</span></span>
<span id="cb706-28"><a aria-hidden="true" href="#cb706-28" tabindex="-1"></a>      monitor<span class="op">-&gt;</span>mm_width <span class="op">=</span> output_info<span class="op">-&gt;</span>mm_width<span class="op">;</span></span>
<span id="cb706-29"><a aria-hidden="true" href="#cb706-29" tabindex="-1"></a>      monitor<span class="op">-&gt;</span>mm_height <span class="op">=</span> output_info<span class="op">-&gt;</span>mm_height<span class="op">;</span></span>
<span id="cb706-30"><a aria-hidden="true" href="#cb706-30" tabindex="-1"></a></span>
<span id="cb706-31"><a aria-hidden="true" href="#cb706-31" tabindex="-1"></a>      XRRFreeCrtcInfo<span class="op">(</span>crtc_info<span class="op">);</span></span>
<span id="cb706-32"><a aria-hidden="true" href="#cb706-32" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb706-33"><a aria-hidden="true" href="#cb706-33" tabindex="-1"></a></span>
<span id="cb706-34"><a aria-hidden="true" href="#cb706-34" tabindex="-1"></a>    XRRFreeOutputInfo<span class="op">(</span>output_info<span class="op">);</span></span>
<span id="cb706-35"><a aria-hidden="true" href="#cb706-35" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb706-36"><a aria-hidden="true" href="#cb706-36" tabindex="-1"></a></span>
<span id="cb706-37"><a aria-hidden="true" href="#cb706-37" tabindex="-1"></a>  XRRFreeScreenResources<span class="op">(</span>resources<span class="op">);</span></span>
<span id="cb706-38"><a aria-hidden="true" href="#cb706-38" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb706-39"><a aria-hidden="true" href="#cb706-39" tabindex="-1"></a><span class="pp">#endif</span></span></code></pre></div>
<h2 data-number="19.6" id="comparison-with-other-platforms"><span class="header-section-number">19.6</span> 5. Comparison with Other
Platforms</h2>
<h3 data-number="19.6.1" id="architecture-comparison"><span class="header-section-number">19.6.1</span> 5.1 Architecture
Comparison</h3>
<table>
<colgroup>
<col style="width: 14%"/>
<col style="width: 8%"/>
<col style="width: 26%"/>
<col style="width: 21%"/>
<col style="width: 29%"/>
</colgroup>
<thead>
<tr>
<th>Aspect</th>
<th>X11</th>
<th>Windows (W32)</th>
<th>macOS (NS)</th>
<th>Pure GTK (PGTK)</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Main File</strong></td>
<td>xterm.c (33K)</td>
<td>w32term.c (27K)</td>
<td>nsterm.m (30K)</td>
<td>pgtkterm.c (20K)</td>
</tr>
<tr>
<td><strong>Protocol</strong></td>
<td>X11 protocol</td>
<td>Win32 API</td>
<td>Cocoa/AppKit</td>
<td>GTK3/4 + Wayland</td>
</tr>
<tr>
<td><strong>Event Model</strong></td>
<td>Xlib events</td>
<td>Windows messages</td>
<td>NSEvent</td>
<td>GLib main loop</td>
</tr>
<tr>
<td><strong>Graphics</strong></td>
<td>Xlib/XRender/Cairo</td>
<td>GDI/GDI+</td>
<td>Quartz 2D</td>
<td>Cairo only</td>
</tr>
<tr>
<td><strong>Font Backend</strong></td>
<td>Xft/Core X</td>
<td>Uniscribe/DirectWrite</td>
<td>Core Text</td>
<td>Pango/Cairo</td>
</tr>
<tr>
<td><strong>Color Model</strong></td>
<td>Visual-dependent</td>
<td>Direct RGB</td>
<td>Color spaces</td>
<td>Direct RGB</td>
</tr>
<tr>
<td><strong>Double Buffer</strong></td>
<td>XDBE (optional)</td>
<td>Built-in</td>
<td>Built-in</td>
<td>Cairo surfaces</td>
</tr>
</tbody>
</table>
<h3 data-number="19.6.2" id="event-processing-differences"><span class="header-section-number">19.6.2</span> 5.2 Event Processing
Differences</h3>
<h4 data-number="19.6.2.1" id="x11-event-loop"><span class="header-section-number">19.6.2.1</span> X11 Event Loop</h4>
<div class="sourceCode" id="cb707"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb707-1"><a aria-hidden="true" href="#cb707-1" tabindex="-1"></a><span class="co">/* X11: pselect on file descriptor */</span></span>
<span id="cb707-2"><a aria-hidden="true" href="#cb707-2" tabindex="-1"></a><span class="cf">while</span> <span class="op">(</span>XPending<span class="op">(</span>display<span class="op">))</span> <span class="op">{</span></span>
<span id="cb707-3"><a aria-hidden="true" href="#cb707-3" tabindex="-1"></a>  XNextEvent<span class="op">(</span>display<span class="op">,</span> <span class="op">&amp;</span>event<span class="op">);</span></span>
<span id="cb707-4"><a aria-hidden="true" href="#cb707-4" tabindex="-1"></a>  handle_one_xevent<span class="op">(</span>dpyinfo<span class="op">,</span> <span class="op">&amp;</span>event<span class="op">,</span> <span class="op">&amp;</span>finish<span class="op">,</span> hold_quit<span class="op">);</span></span>
<span id="cb707-5"><a aria-hidden="true" href="#cb707-5" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h4 data-number="19.6.2.2" id="windows-event-loop"><span class="header-section-number">19.6.2.2</span> Windows Event Loop</h4>
<div class="sourceCode" id="cb708"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb708-1"><a aria-hidden="true" href="#cb708-1" tabindex="-1"></a><span class="co">/* Windows: GetMessage/PeekMessage */</span></span>
<span id="cb708-2"><a aria-hidden="true" href="#cb708-2" tabindex="-1"></a>MSG msg<span class="op">;</span></span>
<span id="cb708-3"><a aria-hidden="true" href="#cb708-3" tabindex="-1"></a><span class="cf">while</span> <span class="op">(</span>PeekMessage<span class="op">(&amp;</span>msg<span class="op">,</span> NULL<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> PM_REMOVE<span class="op">))</span> <span class="op">{</span></span>
<span id="cb708-4"><a aria-hidden="true" href="#cb708-4" tabindex="-1"></a>  TranslateMessage<span class="op">(&amp;</span>msg<span class="op">);</span></span>
<span id="cb708-5"><a aria-hidden="true" href="#cb708-5" tabindex="-1"></a>  DispatchMessage<span class="op">(&amp;</span>msg<span class="op">);</span>  <span class="co">/* Calls window procedure */</span></span>
<span id="cb708-6"><a aria-hidden="true" href="#cb708-6" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb708-7"><a aria-hidden="true" href="#cb708-7" tabindex="-1"></a></span>
<span id="cb708-8"><a aria-hidden="true" href="#cb708-8" tabindex="-1"></a><span class="co">/* Window procedure handles events */</span></span>
<span id="cb708-9"><a aria-hidden="true" href="#cb708-9" tabindex="-1"></a>LRESULT CALLBACK w32_wnd_proc<span class="op">(</span>HWND hwnd<span class="op">,</span> UINT msg<span class="op">,</span> WPARAM wparam<span class="op">,</span> LPARAM lparam<span class="op">)</span></span>
<span id="cb708-10"><a aria-hidden="true" href="#cb708-10" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb708-11"><a aria-hidden="true" href="#cb708-11" tabindex="-1"></a>  <span class="cf">switch</span> <span class="op">(</span>msg<span class="op">)</span> <span class="op">{</span></span>
<span id="cb708-12"><a aria-hidden="true" href="#cb708-12" tabindex="-1"></a>    <span class="cf">case</span> WM_PAINT<span class="op">:</span> <span class="co">/* ... */</span> <span class="cf">break</span><span class="op">;</span></span>
<span id="cb708-13"><a aria-hidden="true" href="#cb708-13" tabindex="-1"></a>    <span class="cf">case</span> WM_KEYDOWN<span class="op">:</span> <span class="co">/* ... */</span> <span class="cf">break</span><span class="op">;</span></span>
<span id="cb708-14"><a aria-hidden="true" href="#cb708-14" tabindex="-1"></a>    <span class="co">/* ... */</span></span>
<span id="cb708-15"><a aria-hidden="true" href="#cb708-15" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb708-16"><a aria-hidden="true" href="#cb708-16" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h4 data-number="19.6.2.3" id="macos-event-loop"><span class="header-section-number">19.6.2.3</span> macOS Event Loop</h4>
<div class="sourceCode" id="cb709"><pre class="sourceCode objectivec"><code class="sourceCode objectivec"><span id="cb709-1"><a aria-hidden="true" href="#cb709-1" tabindex="-1"></a><span class="co">/* macOS: NSEvent from NSApplication */</span></span>
<span id="cb709-2"><a aria-hidden="true" href="#cb709-2" tabindex="-1"></a>NSEvent <span class="op">*</span>event<span class="op">;</span></span>
<span id="cb709-3"><a aria-hidden="true" href="#cb709-3" tabindex="-1"></a><span class="kw">while</span> <span class="op">((</span>event <span class="op">=</span> <span class="op">[</span>NSApp nextEventMatchingMask<span class="op">:</span>NSAnyEventMask</span>
<span id="cb709-4"><a aria-hidden="true" href="#cb709-4" tabindex="-1"></a>                       untilDate<span class="op">:[</span>NSDate distantFuture<span class="op">]</span></span>
<span id="cb709-5"><a aria-hidden="true" href="#cb709-5" tabindex="-1"></a>                       inMode<span class="op">:</span>NSDefaultRunLoopMode</span>
<span id="cb709-6"><a aria-hidden="true" href="#cb709-6" tabindex="-1"></a>                       dequeue<span class="op">:</span>YES<span class="op">]))</span> <span class="op">{</span></span>
<span id="cb709-7"><a aria-hidden="true" href="#cb709-7" tabindex="-1"></a>  <span class="op">[</span>NSApp sendEvent<span class="op">:</span>event<span class="op">];</span>  <span class="co">/* Dispatches to EmacsView */</span></span>
<span id="cb709-8"><a aria-hidden="true" href="#cb709-8" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb709-9"><a aria-hidden="true" href="#cb709-9" tabindex="-1"></a></span>
<span id="cb709-10"><a aria-hidden="true" href="#cb709-10" tabindex="-1"></a><span class="co">/* EmacsView handles events */</span></span>
<span id="cb709-11"><a aria-hidden="true" href="#cb709-11" tabindex="-1"></a><span class="kw">@implementation</span> EmacsView</span>
<span id="cb709-12"><a aria-hidden="true" href="#cb709-12" tabindex="-1"></a><span class="op">-</span> <span class="op">(</span><span class="dt">void</span><span class="op">)</span>keyDown<span class="op">:(</span>NSEvent <span class="op">*)</span>event <span class="op">{</span> <span class="co">/* ... */</span> <span class="op">}</span></span>
<span id="cb709-13"><a aria-hidden="true" href="#cb709-13" tabindex="-1"></a><span class="op">-</span> <span class="op">(</span><span class="dt">void</span><span class="op">)</span>mouseDown<span class="op">:(</span>NSEvent <span class="op">*)</span>event <span class="op">{</span> <span class="co">/* ... */</span> <span class="op">}</span></span>
<span id="cb709-14"><a aria-hidden="true" href="#cb709-14" tabindex="-1"></a><span class="kw">@end</span></span></code></pre></div>
<h4 data-number="19.6.2.4" id="pure-gtk-event-loop"><span class="header-section-number">19.6.2.4</span> Pure GTK Event Loop</h4>
<div class="sourceCode" id="cb710"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb710-1"><a aria-hidden="true" href="#cb710-1" tabindex="-1"></a><span class="co">/* PGTK: GLib main loop */</span></span>
<span id="cb710-2"><a aria-hidden="true" href="#cb710-2" tabindex="-1"></a><span class="cf">while</span> <span class="op">(</span>g_main_context_iteration<span class="op">(</span>NULL<span class="op">,</span> TRUE<span class="op">))</span> <span class="op">{</span></span>
<span id="cb710-3"><a aria-hidden="true" href="#cb710-3" tabindex="-1"></a>  <span class="co">/* GTK callbacks are invoked automatically */</span></span>
<span id="cb710-4"><a aria-hidden="true" href="#cb710-4" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb710-5"><a aria-hidden="true" href="#cb710-5" tabindex="-1"></a></span>
<span id="cb710-6"><a aria-hidden="true" href="#cb710-6" tabindex="-1"></a><span class="co">/* GTK signal handlers */</span></span>
<span id="cb710-7"><a aria-hidden="true" href="#cb710-7" tabindex="-1"></a>g_signal_connect<span class="op">(</span>widget<span class="op">,</span> <span class="st">"key-press-event"</span><span class="op">,</span></span>
<span id="cb710-8"><a aria-hidden="true" href="#cb710-8" tabindex="-1"></a>                 G_CALLBACK<span class="op">(</span>key_press_event_cb<span class="op">),</span> frame<span class="op">);</span></span>
<span id="cb710-9"><a aria-hidden="true" href="#cb710-9" tabindex="-1"></a>g_signal_connect<span class="op">(</span>widget<span class="op">,</span> <span class="st">"button-press-event"</span><span class="op">,</span></span>
<span id="cb710-10"><a aria-hidden="true" href="#cb710-10" tabindex="-1"></a>                 G_CALLBACK<span class="op">(</span>button_press_event_cb<span class="op">),</span> frame<span class="op">);</span></span></code></pre></div>
<h3 data-number="19.6.3" id="graphics-system-differences"><span class="header-section-number">19.6.3</span> 5.3 Graphics System
Differences</h3>
<h4 data-number="19.6.3.1" id="x11-graphics-contexts-vs-other-systems"><span class="header-section-number">19.6.3.1</span> X11 Graphics Contexts vs
Other Systems</h4>
<p><strong>X11</strong>: - Server-side GCs with cached state - Explicit
GC creation and management - <code>XCreateGC()</code>,
<code>XChangeGC()</code>, <code>XSetForeground()</code>, etc. - GCs
persist across drawing operations</p>
<p><strong>Windows</strong>: - Device Contexts (DCs) are temporary -
<code>BeginPaint()</code>/<code>EndPaint()</code> for each update -
State set per operation: <code>SetTextColor()</code>,
<code>SelectObject()</code> - No persistent GC equivalent</p>
<p><strong>macOS</strong>: - Graphics contexts are implicit in Cocoa -
<code>NSGraphicsContext</code> automatically managed - State set via
<code>NSColor</code>, <code>NSFont</code> objects - Quartz handles state
management</p>
<p><strong>Pure GTK</strong>: - Cairo context for all drawing -
<code>cairo_t *cr</code> parameter to draw functions - State machine:
<code>cairo_set_source_rgb()</code>, <code>cairo_stroke()</code>, etc. -
More modern, stateless API</p>
<h4 data-number="19.6.3.2" id="drawing-api-comparison"><span class="header-section-number">19.6.3.2</span> Drawing API
Comparison</h4>
<p><strong>Text Drawing</strong>:</p>
<div class="sourceCode" id="cb711"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb711-1"><a aria-hidden="true" href="#cb711-1" tabindex="-1"></a><span class="co">/* X11 with Xft */</span></span>
<span id="cb711-2"><a aria-hidden="true" href="#cb711-2" tabindex="-1"></a>XftDrawStringUtf8<span class="op">(</span>xft_draw<span class="op">,</span> <span class="op">&amp;</span>xft_color<span class="op">,</span> font<span class="op">,</span> x<span class="op">,</span> y<span class="op">,</span> text<span class="op">,</span> len<span class="op">);</span></span>
<span id="cb711-3"><a aria-hidden="true" href="#cb711-3" tabindex="-1"></a></span>
<span id="cb711-4"><a aria-hidden="true" href="#cb711-4" tabindex="-1"></a><span class="co">/* Windows */</span></span>
<span id="cb711-5"><a aria-hidden="true" href="#cb711-5" tabindex="-1"></a>TextOutW<span class="op">(</span>hdc<span class="op">,</span> x<span class="op">,</span> y<span class="op">,</span> text<span class="op">,</span> len<span class="op">);</span></span>
<span id="cb711-6"><a aria-hidden="true" href="#cb711-6" tabindex="-1"></a></span>
<span id="cb711-7"><a aria-hidden="true" href="#cb711-7" tabindex="-1"></a><span class="co">/* macOS */</span></span>
<span id="cb711-8"><a aria-hidden="true" href="#cb711-8" tabindex="-1"></a><span class="op">[</span>string drawAtPoint<span class="op">:</span>NSMakePoint<span class="op">(</span>x<span class="op">,</span> y<span class="op">)</span> withAttributes<span class="op">:</span>attrs<span class="op">];</span></span>
<span id="cb711-9"><a aria-hidden="true" href="#cb711-9" tabindex="-1"></a></span>
<span id="cb711-10"><a aria-hidden="true" href="#cb711-10" tabindex="-1"></a><span class="co">/* PGTK/Cairo */</span></span>
<span id="cb711-11"><a aria-hidden="true" href="#cb711-11" tabindex="-1"></a>pango_cairo_show_layout<span class="op">(</span>cr<span class="op">,</span> layout<span class="op">);</span></span></code></pre></div>
<p><strong>Rectangle Drawing</strong>:</p>
<div class="sourceCode" id="cb712"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb712-1"><a aria-hidden="true" href="#cb712-1" tabindex="-1"></a><span class="co">/* X11 */</span></span>
<span id="cb712-2"><a aria-hidden="true" href="#cb712-2" tabindex="-1"></a>XFillRectangle<span class="op">(</span>display<span class="op">,</span> drawable<span class="op">,</span> gc<span class="op">,</span> x<span class="op">,</span> y<span class="op">,</span> width<span class="op">,</span> height<span class="op">);</span></span>
<span id="cb712-3"><a aria-hidden="true" href="#cb712-3" tabindex="-1"></a></span>
<span id="cb712-4"><a aria-hidden="true" href="#cb712-4" tabindex="-1"></a><span class="co">/* Windows */</span></span>
<span id="cb712-5"><a aria-hidden="true" href="#cb712-5" tabindex="-1"></a>Rectangle<span class="op">(</span>hdc<span class="op">,</span> x<span class="op">,</span> y<span class="op">,</span> x <span class="op">+</span> width<span class="op">,</span> y <span class="op">+</span> height<span class="op">);</span></span>
<span id="cb712-6"><a aria-hidden="true" href="#cb712-6" tabindex="-1"></a></span>
<span id="cb712-7"><a aria-hidden="true" href="#cb712-7" tabindex="-1"></a><span class="co">/* macOS */</span></span>
<span id="cb712-8"><a aria-hidden="true" href="#cb712-8" tabindex="-1"></a>NSRectFill<span class="op">(</span>NSMakeRect<span class="op">(</span>x<span class="op">,</span> y<span class="op">,</span> width<span class="op">,</span> height<span class="op">));</span></span>
<span id="cb712-9"><a aria-hidden="true" href="#cb712-9" tabindex="-1"></a></span>
<span id="cb712-10"><a aria-hidden="true" href="#cb712-10" tabindex="-1"></a><span class="co">/* PGTK/Cairo */</span></span>
<span id="cb712-11"><a aria-hidden="true" href="#cb712-11" tabindex="-1"></a>cairo_rectangle<span class="op">(</span>cr<span class="op">,</span> x<span class="op">,</span> y<span class="op">,</span> width<span class="op">,</span> height<span class="op">);</span></span>
<span id="cb712-12"><a aria-hidden="true" href="#cb712-12" tabindex="-1"></a>cairo_fill<span class="op">(</span>cr<span class="op">);</span></span></code></pre></div>
<h3 data-number="19.6.4" id="font-system-differences"><span class="header-section-number">19.6.4</span> 5.4 Font System
Differences</h3>
<h4 data-number="19.6.4.1" id="font-backend-comparison"><span class="header-section-number">19.6.4.1</span> Font Backend
Comparison</h4>
<table>
<colgroup>
<col style="width: 34%"/>
<col style="width: 31%"/>
<col style="width: 34%"/>
</colgroup>
<thead>
<tr>
<th>Platform</th>
<th>Backend</th>
<th>Features</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>X11</strong></td>
<td>Core X fonts</td>
<td>Bitmap/scalable, XLFD, server-side</td>
</tr>
<tr>
<td><strong>X11</strong></td>
<td>Xft/FreeType</td>
<td>Client-side, fontconfig, antialiasing, Unicode</td>
</tr>
<tr>
<td><strong>Windows</strong></td>
<td>GDI fonts</td>
<td>LOGFONT structure, basic rendering</td>
</tr>
<tr>
<td><strong>Windows</strong></td>
<td>DirectWrite</td>
<td>Modern, advanced shaping, emoji support</td>
</tr>
<tr>
<td><strong>macOS</strong></td>
<td>Core Text</td>
<td>AAT shaping, color emoji, advanced typography</td>
</tr>
<tr>
<td><strong>PGTK</strong></td>
<td>Pango/Cairo</td>
<td>Fontconfig, HarfBuzz shaping, internationalization</td>
</tr>
</tbody>
</table>
<h4 data-number="19.6.4.2" id="font-selection-examples"><span class="header-section-number">19.6.4.2</span> Font Selection
Examples</h4>
<div class="sourceCode" id="cb713"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb713-1"><a aria-hidden="true" href="#cb713-1" tabindex="-1"></a><span class="co">/* X11 - XLFD */</span></span>
<span id="cb713-2"><a aria-hidden="true" href="#cb713-2" tabindex="-1"></a><span class="st">"-misc-fixed-medium-r-normal--13-120-75-75-c-70-iso8859-1"</span></span>
<span id="cb713-3"><a aria-hidden="true" href="#cb713-3" tabindex="-1"></a></span>
<span id="cb713-4"><a aria-hidden="true" href="#cb713-4" tabindex="-1"></a><span class="co">/* X11 - Fontconfig pattern */</span></span>
<span id="cb713-5"><a aria-hidden="true" href="#cb713-5" tabindex="-1"></a><span class="st">"Monospace-12:weight=bold:slant=italic"</span></span>
<span id="cb713-6"><a aria-hidden="true" href="#cb713-6" tabindex="-1"></a></span>
<span id="cb713-7"><a aria-hidden="true" href="#cb713-7" tabindex="-1"></a><span class="co">/* Windows - LOGFONT */</span></span>
<span id="cb713-8"><a aria-hidden="true" href="#cb713-8" tabindex="-1"></a>LOGFONT lf <span class="op">=</span> <span class="op">{</span><span class="dv">0</span><span class="op">};</span></span>
<span id="cb713-9"><a aria-hidden="true" href="#cb713-9" tabindex="-1"></a>lf<span class="op">.</span>lfHeight <span class="op">=</span> <span class="op">-</span><span class="dv">12</span><span class="op">;</span></span>
<span id="cb713-10"><a aria-hidden="true" href="#cb713-10" tabindex="-1"></a>lf<span class="op">.</span>lfWeight <span class="op">=</span> FW_BOLD<span class="op">;</span></span>
<span id="cb713-11"><a aria-hidden="true" href="#cb713-11" tabindex="-1"></a>strcpy<span class="op">(</span>lf<span class="op">.</span>lfFaceName<span class="op">,</span> <span class="st">"Consolas"</span><span class="op">);</span></span>
<span id="cb713-12"><a aria-hidden="true" href="#cb713-12" tabindex="-1"></a></span>
<span id="cb713-13"><a aria-hidden="true" href="#cb713-13" tabindex="-1"></a><span class="co">/* macOS - font descriptor */</span></span>
<span id="cb713-14"><a aria-hidden="true" href="#cb713-14" tabindex="-1"></a>NSDictionary <span class="op">*</span>attrs <span class="op">=</span> @<span class="op">{</span></span>
<span id="cb713-15"><a aria-hidden="true" href="#cb713-15" tabindex="-1"></a>  NSFontFamilyAttribute<span class="op">:</span> @<span class="st">"Menlo"</span><span class="op">,</span></span>
<span id="cb713-16"><a aria-hidden="true" href="#cb713-16" tabindex="-1"></a>  NSFontSizeAttribute<span class="op">:</span> @<span class="fl">12.0</span></span>
<span id="cb713-17"><a aria-hidden="true" href="#cb713-17" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb713-18"><a aria-hidden="true" href="#cb713-18" tabindex="-1"></a>NSFont <span class="op">*</span>font <span class="op">=</span> <span class="op">[</span>NSFont fontWithDescriptor<span class="op">:[</span>NSFontDescriptor fontDescriptorWithFontAttributes<span class="op">:</span>attrs<span class="op">]</span> size<span class="op">:</span><span class="fl">12.0</span><span class="op">];</span></span>
<span id="cb713-19"><a aria-hidden="true" href="#cb713-19" tabindex="-1"></a></span>
<span id="cb713-20"><a aria-hidden="true" href="#cb713-20" tabindex="-1"></a><span class="co">/* PGTK - Pango */</span></span>
<span id="cb713-21"><a aria-hidden="true" href="#cb713-21" tabindex="-1"></a>PangoFontDescription <span class="op">*</span>desc <span class="op">=</span> pango_font_description_from_string<span class="op">(</span><span class="st">"Monospace 12"</span><span class="op">);</span></span></code></pre></div>
<h3 data-number="19.6.5" id="color-handling"><span class="header-section-number">19.6.5</span> 5.5 Color Handling</h3>
<h4 data-number="19.6.5.1" id="color-allocation-1"><span class="header-section-number">19.6.5.1</span> Color Allocation</h4>
<p><strong>X11</strong>: Visual-dependent, may require allocation</p>
<div class="sourceCode" id="cb714"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb714-1"><a aria-hidden="true" href="#cb714-1" tabindex="-1"></a>XColor color<span class="op">;</span></span>
<span id="cb714-2"><a aria-hidden="true" href="#cb714-2" tabindex="-1"></a>color<span class="op">.</span>red <span class="op">=</span> r <span class="op">&lt;&lt;</span> <span class="dv">8</span><span class="op">;</span></span>
<span id="cb714-3"><a aria-hidden="true" href="#cb714-3" tabindex="-1"></a>color<span class="op">.</span>green <span class="op">=</span> g <span class="op">&lt;&lt;</span> <span class="dv">8</span><span class="op">;</span></span>
<span id="cb714-4"><a aria-hidden="true" href="#cb714-4" tabindex="-1"></a>color<span class="op">.</span>blue <span class="op">=</span> b <span class="op">&lt;&lt;</span> <span class="dv">8</span><span class="op">;</span></span>
<span id="cb714-5"><a aria-hidden="true" href="#cb714-5" tabindex="-1"></a><span class="cf">if</span> <span class="op">(</span>visual_class <span class="op">==</span> TrueColor<span class="op">)</span> <span class="op">{</span></span>
<span id="cb714-6"><a aria-hidden="true" href="#cb714-6" tabindex="-1"></a>  pixel <span class="op">=</span> x_make_truecolor_pixel<span class="op">(</span>r<span class="op">,</span> g<span class="op">,</span> b<span class="op">);</span></span>
<span id="cb714-7"><a aria-hidden="true" href="#cb714-7" tabindex="-1"></a><span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb714-8"><a aria-hidden="true" href="#cb714-8" tabindex="-1"></a>  XAllocColor<span class="op">(</span>display<span class="op">,</span> colormap<span class="op">,</span> <span class="op">&amp;</span>color<span class="op">);</span></span>
<span id="cb714-9"><a aria-hidden="true" href="#cb714-9" tabindex="-1"></a>  pixel <span class="op">=</span> color<span class="op">.</span>pixel<span class="op">;</span></span>
<span id="cb714-10"><a aria-hidden="true" href="#cb714-10" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>Windows/macOS/PGTK</strong>: Direct RGB</p>
<div class="sourceCode" id="cb715"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb715-1"><a aria-hidden="true" href="#cb715-1" tabindex="-1"></a><span class="co">/* Windows */</span></span>
<span id="cb715-2"><a aria-hidden="true" href="#cb715-2" tabindex="-1"></a>COLORREF color <span class="op">=</span> RGB<span class="op">(</span>r<span class="op">,</span> g<span class="op">,</span> b<span class="op">);</span></span>
<span id="cb715-3"><a aria-hidden="true" href="#cb715-3" tabindex="-1"></a></span>
<span id="cb715-4"><a aria-hidden="true" href="#cb715-4" tabindex="-1"></a><span class="co">/* macOS */</span></span>
<span id="cb715-5"><a aria-hidden="true" href="#cb715-5" tabindex="-1"></a>NSColor <span class="op">*</span>color <span class="op">=</span> <span class="op">[</span>NSColor colorWithRed<span class="op">:</span>r<span class="op">/</span><span class="fl">255.0</span> green<span class="op">:</span>g<span class="op">/</span><span class="fl">255.0</span> blue<span class="op">:</span>b<span class="op">/</span><span class="fl">255.0</span> alpha<span class="op">:</span><span class="fl">1.0</span><span class="op">];</span></span>
<span id="cb715-6"><a aria-hidden="true" href="#cb715-6" tabindex="-1"></a></span>
<span id="cb715-7"><a aria-hidden="true" href="#cb715-7" tabindex="-1"></a><span class="co">/* PGTK */</span></span>
<span id="cb715-8"><a aria-hidden="true" href="#cb715-8" tabindex="-1"></a>cairo_set_source_rgb<span class="op">(</span>cr<span class="op">,</span> r<span class="op">/</span><span class="fl">255.0</span><span class="op">,</span> g<span class="op">/</span><span class="fl">255.0</span><span class="op">,</span> b<span class="op">/</span><span class="fl">255.0</span><span class="op">);</span></span></code></pre></div>
<h3 data-number="19.6.6" id="clipboardselection"><span class="header-section-number">19.6.6</span> 5.6 Clipboard/Selection</h3>
<h4 data-number="19.6.6.1" id="x11-selections"><span class="header-section-number">19.6.6.1</span> X11 Selections</h4>
<p><strong>Three separate selections</strong>: - PRIMARY: Middle-click
paste, selected text - CLIPBOARD: Ctrl+C/V clipboard - SECONDARY: Rarely
used</p>
<p><strong>Implementation</strong> (<code>xselect.c</code>): - ICCCM
protocol for selection ownership - Incremental transfers for large data
(INCR) - Multiple formats via TARGETS atom - Asynchronous with
SelectionRequest/SelectionNotify</p>
<div class="sourceCode" id="cb716"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb716-1"><a aria-hidden="true" href="#cb716-1" tabindex="-1"></a><span class="co">/* Become selection owner */</span></span>
<span id="cb716-2"><a aria-hidden="true" href="#cb716-2" tabindex="-1"></a>XSetSelectionOwner<span class="op">(</span>display<span class="op">,</span> XA_PRIMARY<span class="op">,</span> window<span class="op">,</span> timestamp<span class="op">);</span></span>
<span id="cb716-3"><a aria-hidden="true" href="#cb716-3" tabindex="-1"></a></span>
<span id="cb716-4"><a aria-hidden="true" href="#cb716-4" tabindex="-1"></a><span class="co">/* Respond to SelectionRequest */</span></span>
<span id="cb716-5"><a aria-hidden="true" href="#cb716-5" tabindex="-1"></a><span class="dt">void</span> x_handle_selection_request<span class="op">(</span>XSelectionRequestEvent <span class="op">*</span>event<span class="op">)</span> <span class="op">{</span></span>
<span id="cb716-6"><a aria-hidden="true" href="#cb716-6" tabindex="-1"></a>  <span class="co">/* Convert selection to requested format (UTF8_STRING, etc.) */</span></span>
<span id="cb716-7"><a aria-hidden="true" href="#cb716-7" tabindex="-1"></a>  <span class="co">/* Send SelectionNotify with converted data */</span></span>
<span id="cb716-8"><a aria-hidden="true" href="#cb716-8" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h4 data-number="19.6.6.2" id="windows-clipboard"><span class="header-section-number">19.6.6.2</span> Windows Clipboard</h4>
<p><strong>Single clipboard</strong>: - No selection concept - Clipboard
opened/closed explicitly</p>
<div class="sourceCode" id="cb717"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb717-1"><a aria-hidden="true" href="#cb717-1" tabindex="-1"></a>OpenClipboard<span class="op">(</span>hwnd<span class="op">);</span></span>
<span id="cb717-2"><a aria-hidden="true" href="#cb717-2" tabindex="-1"></a>EmptyClipboard<span class="op">();</span></span>
<span id="cb717-3"><a aria-hidden="true" href="#cb717-3" tabindex="-1"></a>HGLOBAL hglob <span class="op">=</span> GlobalAlloc<span class="op">(</span>GMEM_MOVEABLE<span class="op">,</span> size<span class="op">);</span></span>
<span id="cb717-4"><a aria-hidden="true" href="#cb717-4" tabindex="-1"></a><span class="co">/* Copy data */</span></span>
<span id="cb717-5"><a aria-hidden="true" href="#cb717-5" tabindex="-1"></a>SetClipboardData<span class="op">(</span>CF_UNICODETEXT<span class="op">,</span> hglob<span class="op">);</span></span>
<span id="cb717-6"><a aria-hidden="true" href="#cb717-6" tabindex="-1"></a>CloseClipboard<span class="op">();</span></span></code></pre></div>
<h4 data-number="19.6.6.3" id="macos-pasteboard"><span class="header-section-number">19.6.6.3</span> macOS Pasteboard</h4>
<p><strong>NSPasteboard</strong>: - Multiple pasteboards (general, find,
drag) - Type-based data storage</p>
<div class="sourceCode" id="cb718"><pre class="sourceCode objectivec"><code class="sourceCode objectivec"><span id="cb718-1"><a aria-hidden="true" href="#cb718-1" tabindex="-1"></a>NSPasteboard <span class="op">*</span>pb <span class="op">=</span> <span class="op">[</span>NSPasteboard generalPasteboard<span class="op">];</span></span>
<span id="cb718-2"><a aria-hidden="true" href="#cb718-2" tabindex="-1"></a><span class="op">[</span>pb clearContents<span class="op">];</span></span>
<span id="cb718-3"><a aria-hidden="true" href="#cb718-3" tabindex="-1"></a><span class="op">[</span>pb setString<span class="op">:</span>text forType<span class="op">:</span>NSPasteboardTypeString<span class="op">];</span></span></code></pre></div>
<h4 data-number="19.6.6.4" id="pgtk-clipboard"><span class="header-section-number">19.6.6.4</span> PGTK Clipboard</h4>
<p><strong>GTK Clipboard API</strong>: - Abstracts X11 selections on X11
- Native clipboard on Wayland</p>
<div class="sourceCode" id="cb719"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb719-1"><a aria-hidden="true" href="#cb719-1" tabindex="-1"></a>GtkClipboard <span class="op">*</span>clipboard <span class="op">=</span> gtk_clipboard_get<span class="op">(</span>GDK_SELECTION_CLIPBOARD<span class="op">);</span></span>
<span id="cb719-2"><a aria-hidden="true" href="#cb719-2" tabindex="-1"></a>gtk_clipboard_set_text<span class="op">(</span>clipboard<span class="op">,</span> text<span class="op">,</span> <span class="op">-</span><span class="dv">1</span><span class="op">);</span></span></code></pre></div>
<h3 data-number="19.6.7" id="unique-x11-features"><span class="header-section-number">19.6.7</span> 5.7 Unique X11 Features</h3>
<h4 data-number="19.6.7.1" id="features-unique-to-or-most-advanced-on-x11"><span class="header-section-number">19.6.7.1</span> Features Unique to or Most
Advanced on X11</h4>
<ol type="1">
<li><strong>Window Manager Independence</strong>: Emacs can run with any
ICCCM-compliant WM</li>
<li><strong>Remote Display</strong>: <code>DISPLAY=remote:0 emacs</code>
works naturally</li>
<li><strong>X Resources</strong>: Hierarchical configuration system</li>
<li><strong>Fine-grained Visual Control</strong>: Choice of visual depth
and class</li>
<li><strong>Shape Extension</strong>: Non-rectangular windows</li>
<li><strong>XInput2</strong>: Advanced multi-device input</li>
<li><strong>XDND Protocol</strong>: Drag-and-drop with multiple
protocols</li>
<li><strong>Three Selections</strong>: PRIMARY, CLIPBOARD,
SECONDARY</li>
<li><strong>XRender Extension</strong>: Advanced compositing and
antialiasing</li>
<li><strong>Xft Integration</strong>: Direct FreeType/fontconfig
usage</li>
</ol>
<h3 data-number="19.6.8" id="platform-specific-challenges"><span class="header-section-number">19.6.8</span> 5.8 Platform-Specific
Challenges</h3>
<h4 data-number="19.6.8.1" id="x11-challenges"><span class="header-section-number">19.6.8.1</span> X11 Challenges</h4>
<ul>
<li><strong>Complexity</strong>: Many toolkits, extensions, and
configurations to support</li>
<li><strong>Visual Variety</strong>: Must handle multiple visual
classes</li>
<li><strong>Asynchronous Nature</strong>: Events and requests are
asynchronous</li>
<li><strong>Window Manager Variations</strong>: Different WMs behave
differently</li>
<li><strong>Font Complexity</strong>: Two completely different font
systems</li>
<li><strong>Color Allocation</strong>: Non-trivial on non-TrueColor
visuals</li>
</ul>
<h4 data-number="19.6.8.2" id="windows-challenges"><span class="header-section-number">19.6.8.2</span> Windows Challenges</h4>
<ul>
<li><strong>DPI Scaling</strong>: Complex per-monitor DPI awareness</li>
<li><strong>RTL Support</strong>: Right-to-left languages need special
handling</li>
<li><strong>GDI Limitations</strong>: Legacy GDI has many
limitations</li>
<li><strong>Message Pump</strong>: Must integrate with Windows message
loop</li>
<li><strong>Unicode Conversions</strong>: Constant UTF-16 ‚ÜîÔ∏é UTF-8
conversions</li>
</ul>
<h4 data-number="19.6.8.3" id="macos-challenges"><span class="header-section-number">19.6.8.3</span> macOS Challenges</h4>
<ul>
<li><strong>Sandboxing</strong>: App Store requirements restrict
functionality</li>
<li><strong>Objective-C Bridge</strong>: C ‚ÜîÔ∏é Objective-C impedance
mismatch</li>
<li><strong>Fullscreen Mode</strong>: macOS native fullscreen is very
different</li>
<li><strong>Menu Bar</strong>: Global menu bar vs frame menu bar</li>
<li><strong>Emoji/Color Fonts</strong>: Complex color glyph
rendering</li>
</ul>
<h4 data-number="19.6.8.4" id="pure-gtk-challenges"><span class="header-section-number">19.6.8.4</span> Pure GTK Challenges</h4>
<ul>
<li><strong>Wayland Immaturity</strong>: Some features still
incomplete</li>
<li><strong>GTK3 vs GTK4</strong>: Incompatible APIs</li>
<li><strong>Client-Side Decorations</strong>: Complications with window
decorations</li>
<li><strong>Limited Control</strong>: GTK abstracts away low-level
control</li>
<li><strong>Backend Abstraction</strong>: Must work on X11, Wayland,
Broadway</li>
</ul>
<h2 data-number="19.7" id="key-implementation-files"><span class="header-section-number">19.7</span> 6. Key Implementation
Files</h2>
<h3 data-number="19.7.1" id="source-file-reference"><span class="header-section-number">19.7.1</span> Source File Reference</h3>
<h4 data-number="19.7.1.1" id="core-x11-implementation"><span class="header-section-number">19.7.1.1</span> Core X11
Implementation</h4>
<table>
<colgroup>
<col style="width: 20%"/>
<col style="width: 30%"/>
<col style="width: 50%"/>
</colgroup>
<thead>
<tr>
<th>File</th>
<th>Purpose</th>
<th>Key Functions</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>src/xterm.c</code></td>
<td>Main terminal interface</td>
<td><code>XTread_socket</code>, <code>handle_one_xevent</code>,
<code>x_draw_glyph_string</code></td>
</tr>
<tr>
<td><code>src/xterm.h</code></td>
<td>X11 data structures</td>
<td><code>struct x_display_info</code>,
<code>struct x_output</code></td>
</tr>
<tr>
<td><code>src/xfns.c</code></td>
<td>Frame functions</td>
<td><code>x_window</code>, <code>x_create_frame</code>,
<code>x_set_*</code> parameter functions</td>
</tr>
<tr>
<td><code>src/xmenu.c</code></td>
<td>Menu handling</td>
<td><code>x_menu_show</code>, menu bar creation</td>
</tr>
<tr>
<td><code>src/xselect.c</code></td>
<td>Selection/clipboard</td>
<td><code>x_handle_selection_request</code>, ICCCM implementation</td>
</tr>
<tr>
<td><code>src/xsettings.c</code></td>
<td>Desktop integration</td>
<td>XSETTINGS protocol, theme integration</td>
</tr>
<tr>
<td><code>src/xrdb.c</code></td>
<td>Resource database</td>
<td>X resource loading and parsing</td>
</tr>
</tbody>
</table>
<h4 data-number="19.7.1.2" id="font-backends-1"><span class="header-section-number">19.7.1.2</span> Font Backends</h4>
<table>
<colgroup>
<col style="width: 40%"/>
<col style="width: 60%"/>
</colgroup>
<thead>
<tr>
<th>File</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>src/xfont.c</code></td>
<td>Core X font driver</td>
</tr>
<tr>
<td><code>src/xftfont.c</code></td>
<td>Xft/FreeType font driver</td>
</tr>
<tr>
<td><code>src/ftfont.c</code></td>
<td>FreeType base functionality (shared with other platforms)</td>
</tr>
<tr>
<td><code>src/font.c</code></td>
<td>Generic font API</td>
</tr>
</tbody>
</table>
<h4 data-number="19.7.1.3" id="supporting-files"><span class="header-section-number">19.7.1.3</span> Supporting Files</h4>
<table>
<thead>
<tr>
<th>File</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>src/widget.c</code></td>
<td>EmacsFrame widget (Xt configuration)</td>
</tr>
<tr>
<td><code>src/xgselect.c</code></td>
<td>GTK event integration</td>
</tr>
<tr>
<td><code>src/xsmfns.c</code></td>
<td>X Session Management</td>
</tr>
<tr>
<td><code>src/xwidget.c</code></td>
<td>WebKit widget embedding</td>
</tr>
</tbody>
</table>
<h3 data-number="19.7.2" id="header-dependencies"><span class="header-section-number">19.7.2</span> Header Dependencies</h3>
<pre><code>xterm.h
  ‚îú‚îÄ includes dispextern.h (redisplay interface)
  ‚îú‚îÄ includes X11/Xlib.h (Xlib API)
  ‚îú‚îÄ includes X11/Xutil.h (convenience functions)
  ‚îî‚îÄ defines x_display_info, x_output structures

dispextern.h
  ‚îú‚îÄ defines redisplay_interface (platform-independent)
  ‚îú‚îÄ defines glyph, glyph_string structures
  ‚îî‚îÄ common across all platforms

frame.h
  ‚îú‚îÄ defines generic frame structure
  ‚îî‚îÄ platform-specific output_data union</code></pre>
<h2 data-number="19.8" id="configuration-and-build-options"><span class="header-section-number">19.8</span> 7. Configuration and Build
Options</h2>
<h3 data-number="19.8.1" id="x11-build-configuration"><span class="header-section-number">19.8.1</span> X11 Build Configuration</h3>
<p>Key configure options:</p>
<div class="sourceCode" id="cb721"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb721-1"><a aria-hidden="true" href="#cb721-1" tabindex="-1"></a><span class="co"># Basic X11 support (always enabled if X11 detected)</span></span>
<span id="cb721-2"><a aria-hidden="true" href="#cb721-2" tabindex="-1"></a><span class="ex">./configure</span> <span class="at">--with-x</span></span>
<span id="cb721-3"><a aria-hidden="true" href="#cb721-3" tabindex="-1"></a></span>
<span id="cb721-4"><a aria-hidden="true" href="#cb721-4" tabindex="-1"></a><span class="co"># Without X11 (text-mode only)</span></span>
<span id="cb721-5"><a aria-hidden="true" href="#cb721-5" tabindex="-1"></a><span class="ex">./configure</span> <span class="at">--without-x</span></span>
<span id="cb721-6"><a aria-hidden="true" href="#cb721-6" tabindex="-1"></a></span>
<span id="cb721-7"><a aria-hidden="true" href="#cb721-7" tabindex="-1"></a><span class="co"># Toolkit selection</span></span>
<span id="cb721-8"><a aria-hidden="true" href="#cb721-8" tabindex="-1"></a><span class="ex">./configure</span> <span class="at">--with-x-toolkit</span><span class="op">=</span>gtk3    <span class="co"># GTK3 (recommended)</span></span>
<span id="cb721-9"><a aria-hidden="true" href="#cb721-9" tabindex="-1"></a><span class="ex">./configure</span> <span class="at">--with-x-toolkit</span><span class="op">=</span>gtk2    <span class="co"># GTK2 (legacy)</span></span>
<span id="cb721-10"><a aria-hidden="true" href="#cb721-10" tabindex="-1"></a><span class="ex">./configure</span> <span class="at">--with-x-toolkit</span><span class="op">=</span>lucid   <span class="co"># Lucid widgets</span></span>
<span id="cb721-11"><a aria-hidden="true" href="#cb721-11" tabindex="-1"></a><span class="ex">./configure</span> <span class="at">--with-x-toolkit</span><span class="op">=</span>motif   <span class="co"># Motif/LessTif</span></span>
<span id="cb721-12"><a aria-hidden="true" href="#cb721-12" tabindex="-1"></a><span class="ex">./configure</span> <span class="at">--with-x-toolkit</span><span class="op">=</span>no      <span class="co"># No toolkit</span></span>
<span id="cb721-13"><a aria-hidden="true" href="#cb721-13" tabindex="-1"></a></span>
<span id="cb721-14"><a aria-hidden="true" href="#cb721-14" tabindex="-1"></a><span class="co"># Font backends</span></span>
<span id="cb721-15"><a aria-hidden="true" href="#cb721-15" tabindex="-1"></a><span class="ex">./configure</span> <span class="at">--with-xft</span>               <span class="co"># Xft font support (recommended)</span></span>
<span id="cb721-16"><a aria-hidden="true" href="#cb721-16" tabindex="-1"></a><span class="ex">./configure</span> <span class="at">--without-xft</span>            <span class="co"># Core X fonts only</span></span>
<span id="cb721-17"><a aria-hidden="true" href="#cb721-17" tabindex="-1"></a></span>
<span id="cb721-18"><a aria-hidden="true" href="#cb721-18" tabindex="-1"></a><span class="co"># Optional X extensions</span></span>
<span id="cb721-19"><a aria-hidden="true" href="#cb721-19" tabindex="-1"></a><span class="ex">./configure</span> <span class="at">--with-xdbe</span>              <span class="co"># Double buffering</span></span>
<span id="cb721-20"><a aria-hidden="true" href="#cb721-20" tabindex="-1"></a><span class="ex">./configure</span> <span class="at">--with-xrender</span>           <span class="co"># XRender extension</span></span>
<span id="cb721-21"><a aria-hidden="true" href="#cb721-21" tabindex="-1"></a><span class="ex">./configure</span> <span class="at">--with-xinput2</span>           <span class="co"># XInput2 (multi-touch, etc.)</span></span>
<span id="cb721-22"><a aria-hidden="true" href="#cb721-22" tabindex="-1"></a><span class="ex">./configure</span> <span class="at">--with-xrandr</span>            <span class="co"># Xrandr (multi-monitor)</span></span>
<span id="cb721-23"><a aria-hidden="true" href="#cb721-23" tabindex="-1"></a><span class="ex">./configure</span> <span class="at">--with-xfixes</span>            <span class="co"># Xfixes extension</span></span>
<span id="cb721-24"><a aria-hidden="true" href="#cb721-24" tabindex="-1"></a></span>
<span id="cb721-25"><a aria-hidden="true" href="#cb721-25" tabindex="-1"></a><span class="co"># Image format support</span></span>
<span id="cb721-26"><a aria-hidden="true" href="#cb721-26" tabindex="-1"></a><span class="ex">./configure</span> <span class="at">--with-png</span> <span class="at">--with-jpeg</span> <span class="at">--with-gif</span> <span class="at">--with-tiff</span></span>
<span id="cb721-27"><a aria-hidden="true" href="#cb721-27" tabindex="-1"></a><span class="ex">./configure</span> <span class="at">--with-rsvg</span>              <span class="co"># SVG support</span></span>
<span id="cb721-28"><a aria-hidden="true" href="#cb721-28" tabindex="-1"></a><span class="ex">./configure</span> <span class="at">--with-imagemagick</span>       <span class="co"># ImageMagick</span></span>
<span id="cb721-29"><a aria-hidden="true" href="#cb721-29" tabindex="-1"></a></span>
<span id="cb721-30"><a aria-hidden="true" href="#cb721-30" tabindex="-1"></a><span class="co"># Cairo support (modern rendering)</span></span>
<span id="cb721-31"><a aria-hidden="true" href="#cb721-31" tabindex="-1"></a><span class="ex">./configure</span> <span class="at">--with-cairo</span>             <span class="co"># Use Cairo for rendering</span></span></code></pre></div>
<h3 data-number="19.8.2" id="preprocessor-conditionals"><span class="header-section-number">19.8.2</span> Preprocessor
Conditionals</h3>
<p>Major compile-time flags:</p>
<div class="sourceCode" id="cb722"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb722-1"><a aria-hidden="true" href="#cb722-1" tabindex="-1"></a><span class="pp">#ifdef HAVE_X11                    </span><span class="co">/* X11 support enabled */</span></span>
<span id="cb722-2"><a aria-hidden="true" href="#cb722-2" tabindex="-1"></a><span class="pp">#ifdef HAVE_X_WINDOWS             </span><span class="co">/* Generic X Windows */</span></span>
<span id="cb722-3"><a aria-hidden="true" href="#cb722-3" tabindex="-1"></a><span class="pp">#ifdef USE_X_TOOLKIT              </span><span class="co">/* Using Xt toolkit */</span></span>
<span id="cb722-4"><a aria-hidden="true" href="#cb722-4" tabindex="-1"></a><span class="pp">#ifdef USE_GTK                    </span><span class="co">/* Using GTK */</span></span>
<span id="cb722-5"><a aria-hidden="true" href="#cb722-5" tabindex="-1"></a><span class="pp">#ifdef USE_MOTIF                  </span><span class="co">/* Using Motif */</span></span>
<span id="cb722-6"><a aria-hidden="true" href="#cb722-6" tabindex="-1"></a><span class="pp">#ifdef USE_LUCID                  </span><span class="co">/* Using Lucid widgets */</span></span>
<span id="cb722-7"><a aria-hidden="true" href="#cb722-7" tabindex="-1"></a></span>
<span id="cb722-8"><a aria-hidden="true" href="#cb722-8" tabindex="-1"></a><span class="pp">#ifdef HAVE_XFT                   </span><span class="co">/* Xft fonts available */</span></span>
<span id="cb722-9"><a aria-hidden="true" href="#cb722-9" tabindex="-1"></a><span class="pp">#ifdef HAVE_XRENDER               </span><span class="co">/* XRender extension */</span></span>
<span id="cb722-10"><a aria-hidden="true" href="#cb722-10" tabindex="-1"></a><span class="pp">#ifdef HAVE_XDBE                  </span><span class="co">/* Double buffering */</span></span>
<span id="cb722-11"><a aria-hidden="true" href="#cb722-11" tabindex="-1"></a><span class="pp">#ifdef HAVE_XINPUT2               </span><span class="co">/* XInput2 support */</span></span>
<span id="cb722-12"><a aria-hidden="true" href="#cb722-12" tabindex="-1"></a><span class="pp">#ifdef HAVE_XRANDR                </span><span class="co">/* Xrandr extension */</span></span>
<span id="cb722-13"><a aria-hidden="true" href="#cb722-13" tabindex="-1"></a><span class="pp">#ifdef HAVE_XFIXES                </span><span class="co">/* Xfixes extension */</span></span>
<span id="cb722-14"><a aria-hidden="true" href="#cb722-14" tabindex="-1"></a></span>
<span id="cb722-15"><a aria-hidden="true" href="#cb722-15" tabindex="-1"></a><span class="pp">#ifdef HAVE_X_I18N                </span><span class="co">/* Input method support */</span></span>
<span id="cb722-16"><a aria-hidden="true" href="#cb722-16" tabindex="-1"></a><span class="pp">#ifdef HAVE_X11R6_XIM             </span><span class="co">/* X11R6 XIM */</span></span>
<span id="cb722-17"><a aria-hidden="true" href="#cb722-17" tabindex="-1"></a></span>
<span id="cb722-18"><a aria-hidden="true" href="#cb722-18" tabindex="-1"></a><span class="pp">#ifdef USE_CAIRO                  </span><span class="co">/* Cairo rendering */</span></span></code></pre></div>
<h2 data-number="19.9" id="performance-considerations-5"><span class="header-section-number">19.9</span> 8. Performance
Considerations</h2>
<h3 data-number="19.9.1" id="optimization-strategies-3"><span class="header-section-number">19.9.1</span> Optimization Strategies</h3>
<ol type="1">
<li><strong>Graphics Context Reuse</strong>: GCs are cached in faces and
frames</li>
<li><strong>Color Caching</strong>: Allocated colors stored to avoid
reallocations</li>
<li><strong>Font Caching</strong>: Font structures cached
per-display</li>
<li><strong>Double Buffering</strong>: Eliminates redundant redraws</li>
<li><strong>Exposure Compression</strong>: Multiple expose events
compressed</li>
<li><strong>Batch Rendering</strong>: Glyph strings combine multiple
glyphs</li>
</ol>
<h3 data-number="19.9.2" id="performance-tuning-1"><span class="header-section-number">19.9.2</span> Performance Tuning</h3>
<pre class="elisp"><code>;; Reduce X traffic
(setq x-wait-for-event-timeout nil)  ; Don't wait for events

;; Font optimization
(setq font-use-system-font t)  ; Use system font settings

;; Improve scrolling
(setq fast-but-imprecise-scrolling t)

;; Reduce redraws
(setq redisplay-skip-fontification-on-input t)</code></pre>
<h2 data-number="19.10" id="debugging-x11-issues"><span class="header-section-number">19.10</span> 9. Debugging X11 Issues</h2>
<h3 data-number="19.10.1" id="debug-tools-1"><span class="header-section-number">19.10.1</span> Debug Tools</h3>
<h4 data-number="19.10.1.1" id="x-event-tracing"><span class="header-section-number">19.10.1.1</span> X Event Tracing</h4>
<div class="sourceCode" id="cb724"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb724-1"><a aria-hidden="true" href="#cb724-1" tabindex="-1"></a><span class="co"># Set environment variables</span></span>
<span id="cb724-2"><a aria-hidden="true" href="#cb724-2" tabindex="-1"></a><span class="bu">export</span> <span class="va">XLIB_SKIP_ARGB_VISUALS</span><span class="op">=</span>1  <span class="co"># Avoid ARGB visual issues</span></span>
<span id="cb724-3"><a aria-hidden="true" href="#cb724-3" tabindex="-1"></a><span class="bu">export</span> <span class="va">XLIB_DEBUG</span><span class="op">=</span>1              <span class="co"># Enable Xlib debugging</span></span>
<span id="cb724-4"><a aria-hidden="true" href="#cb724-4" tabindex="-1"></a></span>
<span id="cb724-5"><a aria-hidden="true" href="#cb724-5" tabindex="-1"></a><span class="co"># Run with X synchronous mode (slow but catches errors immediately)</span></span>
<span id="cb724-6"><a aria-hidden="true" href="#cb724-6" tabindex="-1"></a><span class="ex">emacs</span> <span class="at">--eval</span> <span class="st">'(x-synchronize t)'</span></span></code></pre></div>
<h4 data-number="19.10.1.2" id="gdb-breakpoints"><span class="header-section-number">19.10.1.2</span> GDB Breakpoints</h4>
<pre class="gdb"><code># Break on X errors
break x_error_handler
break x_io_error_quitter

# Break on event handling
break handle_one_xevent
break XTread_socket

# Break on rendering
break x_draw_glyph_string
break x_flush</code></pre>
<h4 data-number="19.10.1.3" id="x-tools"><span class="header-section-number">19.10.1.3</span> X Tools</h4>
<div class="sourceCode" id="cb726"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb726-1"><a aria-hidden="true" href="#cb726-1" tabindex="-1"></a><span class="co"># Monitor X protocol</span></span>
<span id="cb726-2"><a aria-hidden="true" href="#cb726-2" tabindex="-1"></a><span class="ex">xscope</span></span>
<span id="cb726-3"><a aria-hidden="true" href="#cb726-3" tabindex="-1"></a></span>
<span id="cb726-4"><a aria-hidden="true" href="#cb726-4" tabindex="-1"></a><span class="co"># Window inspector</span></span>
<span id="cb726-5"><a aria-hidden="true" href="#cb726-5" tabindex="-1"></a><span class="ex">xwininfo</span> <span class="at">-tree</span> <span class="at">-root</span></span>
<span id="cb726-6"><a aria-hidden="true" href="#cb726-6" tabindex="-1"></a><span class="ex">xprop</span> <span class="at">-root</span></span>
<span id="cb726-7"><a aria-hidden="true" href="#cb726-7" tabindex="-1"></a></span>
<span id="cb726-8"><a aria-hidden="true" href="#cb726-8" tabindex="-1"></a><span class="co"># Event monitoring</span></span>
<span id="cb726-9"><a aria-hidden="true" href="#cb726-9" tabindex="-1"></a><span class="ex">xev</span></span>
<span id="cb726-10"><a aria-hidden="true" href="#cb726-10" tabindex="-1"></a></span>
<span id="cb726-11"><a aria-hidden="true" href="#cb726-11" tabindex="-1"></a><span class="co"># Resource inspection</span></span>
<span id="cb726-12"><a aria-hidden="true" href="#cb726-12" tabindex="-1"></a><span class="ex">xrdb</span> <span class="at">-query</span></span></code></pre></div>
<h3 data-number="19.10.2" id="common-issues-2"><span class="header-section-number">19.10.2</span> Common Issues</h3>
<ol type="1">
<li><strong>Visual Mismatch</strong>: Wrong visual selected ‚Üí color
problems</li>
<li><strong>Colormap Full</strong>: Can‚Äôt allocate colors ‚Üí closest
match used</li>
<li><strong>Font Not Found</strong>: Font pattern doesn‚Äôt match ‚Üí
fallback used</li>
<li><strong>Window Manager Issues</strong>: Hints not respected ‚Üí
positioning problems</li>
<li><strong>Input Method Problems</strong>: XIM conflicts ‚Üí garbled
input</li>
<li><strong>Extension Missing</strong>: Feature requires extension ‚Üí
disabled or fallback</li>
</ol>
<h2 data-number="19.11" id="future-directions-1"><span class="header-section-number">19.11</span> 10. Future Directions</h2>
<h3 data-number="19.11.1" id="x11-evolution"><span class="header-section-number">19.11.1</span> X11 Evolution</h3>
<ul>
<li><strong>Wayland Transition</strong>: Pure GTK build provides Wayland
support</li>
<li><strong>XRender Deprecation</strong>: Cairo becoming standard</li>
<li><strong>Modern Extensions</strong>: XInput2, XPresent, etc.</li>
<li><strong>HiDPI Support</strong>: Better scaling and monitor
handling</li>
<li><strong>Color Management</strong>: ICC profiles and color
spaces</li>
</ul>
<h3 data-number="19.11.2" id="code-modernization"><span class="header-section-number">19.11.2</span> Code Modernization</h3>
<ul>
<li>Reduce Xt dependencies (Xt is legacy)</li>
<li>Increase Cairo usage for rendering</li>
<li>Improve font fallback mechanisms</li>
<li>Better multi-monitor support</li>
<li>Enhanced accessibility</li>
</ul>
<h2 data-number="19.12" id="references-4"><span class="header-section-number">19.12</span> 11. References</h2>
<h3 data-number="19.12.1" id="specifications"><span class="header-section-number">19.12.1</span> Specifications</h3>
<ul>
<li><strong>X Window System Protocol</strong> (X11R7.7)</li>
<li><strong>ICCCM</strong> (Inter-Client Communication Conventions
Manual)</li>
<li><strong>EWMH</strong> (Extended Window Manager Hints / NetWM)</li>
<li><strong>XDND</strong> (X Drag and Drop)</li>
<li><strong>XEMBED</strong> Protocol</li>
<li><strong>XRender</strong> Extension Specification</li>
<li><strong>XInput2</strong> Protocol</li>
</ul>
<h3 data-number="19.12.2" id="source-documentation"><span class="header-section-number">19.12.2</span> Source Documentation</h3>
<p>Key documentation in source files: - <code>src/xterm.c</code>: Lines
1-400+ contain extensive documentation - <code>src/xfns.c</code>: Frame
function documentation - <code>lisp/x-dnd.el</code>: Drag and drop
protocol documentation - <code>lisp/term/x-win.el</code>: X window
system initialization</p>
<h3 data-number="19.12.3" id="external-resources-1"><span class="header-section-number">19.12.3</span> External Resources</h3>
<ul>
<li>X.Org Foundation: https://www.x.org/</li>
<li>Xlib Manual: https://www.x.org/releases/current/doc/</li>
<li>XCB Documentation: https://xcb.freedesktop.org/</li>
<li>FreeDesktop.org Specifications:
https://www.freedesktop.org/wiki/Specifications/</li>
</ul>
<hr/>
<p><strong>Document Metadata</strong> - <strong>Last Updated</strong>:
2025-01-18 - <strong>Emacs Version</strong>: 31.0.50 (development) -
<strong>Primary Author</strong>: Generated from source analysis -
<strong>Scope</strong>: X11 window system integration with platform
comparisons</p>
<h1 data-number="20" id="emacs-lisp-standard-library"><span class="header-section-number">20</span> Emacs Lisp Standard Library</h1>
<p><em>A literate programming guide to the core libraries that power
Emacs</em></p>
<hr/>
<h2 data-number="20.1" id="table-of-contents-8"><span class="header-section-number">20.1</span> Table of Contents</h2>
<ol type="1">
<li><a href="#introduction">Introduction</a></li>
<li><a href="#core-utilities">Core Utilities</a>
<ul>
<li><a href="#subrel---fundamental-subroutines">subr.el - Fundamental
Subroutines</a></li>
<li><a href="#simpleel---basic-editing-commands">simple.el - Basic
Editing Commands</a></li>
<li><a href="#filesel---file-operations">files.el - File
Operations</a></li>
<li><a href="#windowel---window-management">window.el - Window
Management</a></li>
</ul></li>
<li><a href="#data-structures">Data Structures</a>
<ul>
<li><a href="#seqel---sequence-manipulation">seq.el - Sequence
Manipulation</a></li>
<li><a href="#mapel---mapdictionary-operations">map.el - Map/Dictionary
Operations</a></li>
<li><a href="#ringel---ring-buffers">ring.el - Ring Buffers</a></li>
<li><a href="#avl-treeel---balanced-binary-trees">avl-tree.el - Balanced
Binary Trees</a></li>
</ul></li>
<li><a href="#completion-framework">Completion Framework</a>
<ul>
<li><a href="#minibufferel---minibuffer-and-completion">minibuffer.el -
Minibuffer and Completion</a></li>
</ul></li>
<li><a href="#search-and-replace">Search and Replace</a>
<ul>
<li><a href="#isearchel---incremental-search">isearch.el - Incremental
Search</a></li>
</ul></li>
<li><a href="#help-system">Help System</a>
<ul>
<li><a href="#helpel---help-commands">help.el - Help Commands</a></li>
</ul></li>
<li><a href="#customization">Customization</a>
<ul>
<li><a href="#customel---customization-framework">custom.el -
Customization Framework</a></li>
</ul></li>
</ol>
<hr/>
<h2 data-number="20.2" id="introduction-2"><span class="header-section-number">20.2</span> Introduction</h2>
<p>The Emacs Lisp standard library comprises the foundational Elisp code
that all other Emacs functionality depends on. These libraries, residing
in the <code>lisp/</code> directory, provide everything from fundamental
data structures and control flow to file operations, window management,
and user interaction.</p>
<p>This document follows the <strong>literate programming</strong>
philosophy: we‚Äôll explore not just what the code does, but <em>why</em>
it exists, how it‚Äôs structured, and how the pieces fit together. Each
section combines narrative explanation with concrete code examples and
API documentation.</p>
<h3 data-number="20.2.1" id="design-philosophy-4"><span class="header-section-number">20.2.1</span> Design Philosophy</h3>
<p>The standard library reflects several key design principles:</p>
<ol type="1">
<li><strong>Progressive Enhancement</strong>: Simple APIs for common
cases, with extensible mechanisms for complex scenarios</li>
<li><strong>Interactivity First</strong>: Most functions work both
programmatically and interactively</li>
<li><strong>Buffer-Centric</strong>: Operations typically apply to the
current buffer unless specified otherwise</li>
<li><strong>Customizable by Default</strong>: Extensive use of hooks,
variables, and customization groups</li>
</ol>
<hr/>
<h2 data-number="20.3" id="core-utilities"><span class="header-section-number">20.3</span> Core Utilities</h2>
<h3 data-number="20.3.1" id="subr.el---fundamental-subroutines"><span class="header-section-number">20.3.1</span> subr.el - Fundamental
Subroutines</h3>
<p><strong>Location</strong>: <code>/home/user/emacs/lisp/subr.el</code>
(7,876 lines)</p>
<p><code>subr.el</code> contains the fundamental building blocks of
Elisp - the subroutines that are loaded before almost anything else.
These functions are so fundamental that most Elisp programmers use them
without thinking about where they come from.</p>
<h4 data-number="20.3.1.1" id="philosophy-and-structure"><span class="header-section-number">20.3.1.1</span> Philosophy and
Structure</h4>
<p>The file deliberately avoids dependencies - it can‚Äôt even use
backquotes in its macro definitions because backquote.el hasn‚Äôt loaded
yet! This constraint forces extreme simplicity and elegance.</p>
<h4 data-number="20.3.1.2" id="basic-macros-and-control-flow"><span class="header-section-number">20.3.1.2</span> Basic Macros and Control
Flow</h4>
<h5 data-number="20.3.1.2.1" id="lambda-functions"><span class="header-section-number">20.3.1.2.1</span> Lambda Functions</h5>
<pre class="elisp"><code>(defmacro lambda (&amp;rest cdr)
  "Return an anonymous function.
Under lexical binding, the result is a closure."
  (list 'function (cons 'lambda cdr)))</code></pre>
<p>The <code>lambda</code> macro is foundational - it creates anonymous
functions. Under lexical binding (now the default), it produces closures
that capture their environment.</p>
<p><strong>Example</strong>:</p>
<pre class="elisp"><code>;; Create a counter using closure
(let ((count 0))
  (lambda () (setq count (1+ count))))</code></pre>
<h5 data-number="20.3.1.2.2" id="conditional-execution"><span class="header-section-number">20.3.1.2.2</span> Conditional
Execution</h5>
<pre class="elisp"><code>(defmacro when (cond &amp;rest body)
  "If COND yields non-nil, do BODY, else return nil."
  (declare (indent 1) (debug t))
  `(if ,cond (progn ,@body)))

(defmacro unless (cond &amp;rest body)
  "If COND yields nil, do BODY, else return nil."
  (declare (indent 1) (debug t))
  `(if ,cond nil (progn ,@body)))</code></pre>
<p>These macros provide more readable alternatives to <code>if</code>
when you only care about one branch:</p>
<pre class="elisp"><code>;; Instead of: (if (buffer-modified-p) (save-buffer) nil)
(when (buffer-modified-p)
  (save-buffer))

;; Instead of: (if (not (file-exists-p "~/.emacs")) (create-file "~/.emacs"))
(unless (file-exists-p "~/.emacs")
  (create-file "~/.emacs"))</code></pre>
<h4 data-number="20.3.1.3" id="variable-manipulation"><span class="header-section-number">20.3.1.3</span> Variable Manipulation</h4>
<h5 data-number="20.3.1.3.1" id="buffer-local-variables-1"><span class="header-section-number">20.3.1.3.1</span> Buffer-Local
Variables</h5>
<pre class="elisp"><code>(defmacro setq-local (&amp;rest pairs)
  "Make each VARIABLE local to current buffer and set it to corresponding VALUE."
  (declare (debug setq))
  (unless (evenp (length pairs))
    (error "PAIRS must have an even number of variable/value members"))
  (let ((expr nil))
    (while pairs
      (unless (symbolp (car pairs))
        (error "Attempting to set a non-symbol: %s" (car pairs)))
      (setq expr
            (cons
             (list 'setq (car pairs)
                   (list 'prog1
                    (car (cdr pairs))
                    (list 'make-local-variable (list 'quote (car pairs)))))
             expr))
      (setq pairs (cdr (cdr pairs))))
    (macroexp-progn (nreverse expr))))</code></pre>
<p>This powerful macro makes variables buffer-local and sets them in one
operation. It‚Äôs used extensively throughout Emacs for mode-specific
configuration:</p>
<pre class="elisp"><code>;; In a major mode's setup
(defun my-mode ()
  (setq-local comment-start "# "
              comment-end ""
              indent-tabs-mode nil))</code></pre>
<h5 data-number="20.3.1.3.2" id="default-values"><span class="header-section-number">20.3.1.3.2</span> Default Values</h5>
<pre class="elisp"><code>(defmacro setq-default (&amp;rest args)
  "Set the default value of variable VAR to VALUE.
More generally, you can use multiple variables and values, as in
  (setq-default VAR VALUE VAR VALUE...)"
  (declare (debug setq))
  (let ((exps nil))
    (while args
      (push `(set-default ',(pop args) ,(pop args)) exps))
    `(progn . ,(nreverse exps))))</code></pre>
<p>Sets the global default value of a variable, used as a fallback when
buffers don‚Äôt have buffer-local values.</p>
<h4 data-number="20.3.1.4" id="list-operations"><span class="header-section-number">20.3.1.4</span> List Operations</h4>
<h5 data-number="20.3.1.4.1" id="list-traversal"><span class="header-section-number">20.3.1.4.1</span> List Traversal</h5>
<pre class="elisp"><code>(defmacro dolist (spec &amp;rest body)
  "Loop over a list, evaluating BODY with VAR bound to each element.
\(fn (VAR LIST [RESULT]) BODY...)"
  (declare (indent 1) (debug ((symbolp form &amp;optional form) body)))
  ;; Implementation uses while loops internally
  ...)

(defmacro dotimes (spec &amp;rest body)
  "Loop a certain number of times, evaluating BODY with VAR bound to each integer.
\(fn (VAR COUNT [RESULT]) BODY...)"
  (declare (indent 1) (debug dolist))
  ...)</code></pre>
<p>The workhorses of iteration in Elisp:</p>
<pre class="elisp"><code>;; Iterate over a list
(dolist (file '("foo.el" "bar.el" "baz.el"))
  (load file))

;; Count from 0 to 9
(dotimes (i 10)
  (insert (format "Line %d\n" i)))</code></pre>
<h5 data-number="20.3.1.4.2" id="list-manipulation"><span class="header-section-number">20.3.1.4.2</span> List Manipulation</h5>
<pre class="elisp"><code>(defun last (list &amp;optional n)
  "Return the last link of LIST.  Its car is the last element.
If N is non-nil, return the Nth-to-last link of LIST."
  ...)

(defun butlast (list &amp;optional n)
  "Return a copy of LIST with the last N elements removed.
If N is omitted or nil, the last element is removed."
  ...)

(defun delete-dups (list)
  "Destructively remove `equal' duplicates from LIST.
Store the result in LIST and return it.  LIST must be a proper list."
  ...)</code></pre>
<p>These functions provide essential list processing:</p>
<pre class="elisp"><code>(last '(1 2 3 4 5))           ; =&gt; (5)
(butlast '(1 2 3 4 5))        ; =&gt; (1 2 3 4)
(delete-dups '(1 2 2 3 3 3))  ; =&gt; (1 2 3)</code></pre>
<h4 data-number="20.3.1.5" id="association-lists-alists"><span class="header-section-number">20.3.1.5</span> Association Lists
(alists)</h4>
<pre class="elisp"><code>(defun alist-get (key alist &amp;optional default remove testfn)
  "Return the value associated with KEY in ALIST.
If KEY is not found, return DEFAULT.
TESTFN defaults to `eq' when comparing keys."
  ...)

(defun assoc-default (key alist &amp;optional test default)
  "Find object KEY in a pseudo-alist ALIST.
ALIST is a list of conses or objects. Each element
 (or the element's car, if it is a cons) is compared with KEY by
 calling TEST, with two arguments: (i) the element or its car,
 and (ii) KEY."
  ...)</code></pre>
<p>Association lists are one of Elisp‚Äôs primary data structures:</p>
<pre class="elisp"><code>(let ((config '((indent . 4)
                (width . 80)
                (style . "gnu"))))
  (alist-get 'indent config))  ; =&gt; 4</code></pre>
<h4 data-number="20.3.1.6" id="numeric-predicates"><span class="header-section-number">20.3.1.6</span> Numeric Predicates</h4>
<pre class="elisp"><code>(defun zerop (number)
  "Return t if NUMBER is zero."
  (= number 0))

(defun plusp (number)
  "Return t if NUMBER is positive."
  (&gt; number 0))

(defun minusp (number)
  "Return t if NUMBER is negative."
  (&lt; number 0))

(defun oddp (number)
  "Return t if INTEGER is odd."
  (= (logand number 1) 1))

(defun evenp (number)
  "Return t if INTEGER is even."
  (= (logand number 1) 0))</code></pre>
<p>These predicates make numeric code more readable:</p>
<pre class="elisp"><code>(if (zerop count)
    (message "No items")
  (message "%d items" count))</code></pre>
<h4 data-number="20.3.1.7" id="key-functions-reference-1"><span class="header-section-number">20.3.1.7</span> Key Functions
Reference</h4>
<table>
<colgroup>
<col style="width: 35%"/>
<col style="width: 32%"/>
<col style="width: 32%"/>
</colgroup>
<thead>
<tr>
<th>Function</th>
<th>Purpose</th>
<th>Example</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>lambda</code></td>
<td>Create anonymous function</td>
<td><code>(lambda (x) (* x 2))</code></td>
</tr>
<tr>
<td><code>when</code></td>
<td>Conditional execution (true branch only)</td>
<td><code>(when test (do-something))</code></td>
</tr>
<tr>
<td><code>unless</code></td>
<td>Conditional execution (false branch only)</td>
<td><code>(unless ready (wait))</code></td>
</tr>
<tr>
<td><code>dolist</code></td>
<td>Iterate over list elements</td>
<td><code>(dolist (x list) (print x))</code></td>
</tr>
<tr>
<td><code>dotimes</code></td>
<td>Iterate N times</td>
<td><code>(dotimes (i 10) (insert "*"))</code></td>
</tr>
<tr>
<td><code>push</code></td>
<td>Add element to list</td>
<td><code>(push item stack)</code></td>
</tr>
<tr>
<td><code>pop</code></td>
<td>Remove and return first element</td>
<td><code>(pop stack)</code></td>
</tr>
<tr>
<td><code>setq-local</code></td>
<td>Set buffer-local variable</td>
<td><code>(setq-local indent-tabs-mode nil)</code></td>
</tr>
<tr>
<td><code>alist-get</code></td>
<td>Retrieve from association list</td>
<td><code>(alist-get 'key alist)</code></td>
</tr>
</tbody>
</table>
<hr/>
<h3 data-number="20.3.2" id="simple.el---basic-editing-commands"><span class="header-section-number">20.3.2</span> simple.el - Basic Editing
Commands</h3>
<p><strong>Location</strong>:
<code>/home/user/emacs/lisp/simple.el</code> (11,712 lines)</p>
<p><code>simple.el</code> contains the basic editing commands that users
interact with daily - commands for moving point, inserting text,
deleting text, and manipulating buffers. Despite the name ‚Äúsimple,‚Äù this
file is one of the largest in the standard library!</p>
<h4 data-number="20.3.2.1" id="the-next-error-framework"><span class="header-section-number">20.3.2.1</span> The Next-Error
Framework</h4>
<p>A powerful but often overlooked feature is the next-error framework,
which provides a generic interface for navigating through lists of
locations (compilation errors, grep matches, etc.):</p>
<pre class="elisp"><code>(defun next-error (&amp;optional arg reset)
  "Visit next compilation error and return buffer.
This function operates on a buffer with the most recent compilation,
grep, occur, etc. output."
  ...)

(defun previous-error (&amp;optional n)
  "Visit previous compilation error and return buffer."
  (interactive "p")
  (next-error (- (or n 1))))</code></pre>
<p><strong>Usage Example</strong>:</p>
<pre class="elisp"><code>;; After running M-x grep
;; C-x ` (next-error) jumps to first match
;; Subsequent C-x ` jumps to next matches</code></pre>
<h4 data-number="20.3.2.2" id="movement-commands"><span class="header-section-number">20.3.2.2</span> Movement Commands</h4>
<pre class="elisp"><code>(defun beginning-of-buffer (&amp;optional arg)
  "Move point to the beginning of the buffer."
  (interactive "^P")
  (or (consp arg)
      (region-active-p)
      (push-mark))
  (let ((size (- (point-max) (point-min))))
    (goto-char (if (and arg (not (consp arg)))
                   (+ (point-min)
                      (if (&gt; size 10000)
                          ;; Avoid overflow for large buffer sizes!
                          (* (prefix-numeric-value arg)
                             (/ size 10))
                        (/ (+ 10 (* size (prefix-numeric-value arg)))
                           10)))
                 (point-min))))
  (if (and arg (not (consp arg)))
      (forward-line 1)))

(defun end-of-buffer (&amp;optional arg)
  "Move point to the end of the buffer."
  ...)</code></pre>
<p>These commands demonstrate Emacs‚Äôs philosophy: even ‚Äúsimple‚Äù movement
commands handle edge cases (large buffers, numeric arguments, mark
management) gracefully.</p>
<h4 data-number="20.3.2.3" id="text-insertion-and-deletion-1"><span class="header-section-number">20.3.2.3</span> Text Insertion and
Deletion</h4>
<pre class="elisp"><code>(defun newline (&amp;optional arg interactive)
  "Insert a newline, and move to left margin of the new line if it's blank.
If option `use-hard-newlines' is non-nil, the newline is marked with
the text-property `hard'."
  (interactive "*P\np")
  ...)

(defun delete-blank-lines ()
  "On blank line, delete all surrounding blank lines, leaving just one.
On isolated blank line, delete that one.
On nonblank line, delete any immediately following blank lines."
  (interactive "*")
  ...)

(defun just-one-space (&amp;optional n)
  "Delete all spaces and tabs around point, leaving one space (or N spaces)."
  (interactive "*p")
  (cycle-spacing n nil 'single-shot))</code></pre>
<p><strong>Interactive Usage</strong>: - <code>C-o</code>
(<code>open-line</code>) - Insert newline without moving point -
<code>C-x C-o</code> (<code>delete-blank-lines</code>) - Clean up excess
blank lines - <code>M-SPC</code> (<code>just-one-space</code>) -
Collapse whitespace to single space</p>
<h4 data-number="20.3.2.4" id="counting-and-position-information"><span class="header-section-number">20.3.2.4</span> Counting and Position
Information</h4>
<pre class="elisp"><code>(defun count-words-region (start end &amp;optional arg)
  "Count the number of words in the region."
  ...)

(defun count-lines (start end &amp;optional ignore-invisible-lines)
  "Return number of lines between START and END."
  ...)

(defun what-line ()
  "Print the current buffer line number and narrowing status of point."
  (interactive)
  (let ((start (point-min))
        (n (line-number-at-pos)))
    (message "Line %d" n)))

(defun what-cursor-position (&amp;optional detail)
  "Print info on cursor position (on screen and within buffer)."
  (interactive "P")
  ;; Displays: character, encoding, point position, total size, column
  ...)</code></pre>
<p>These introspective commands help users understand their position in
a buffer. They‚Äôre extensively used in mode lines and status
displays.</p>
<h4 data-number="20.3.2.5" id="the-mark-and-region"><span class="header-section-number">20.3.2.5</span> The Mark and Region</h4>
<pre class="elisp"><code>(defun mark-whole-buffer ()
  "Put point at beginning and mark at end of buffer."
  (interactive)
  (push-mark (point))
  (push-mark (point-max) nil t)
  (goto-char (point-min)))</code></pre>
<p>The mark-ring system is fundamental to Emacs‚Äôs editing model,
allowing users to mark positions and return to them:</p>
<pre class="elisp"><code>;; Mark current position
(push-mark)

;; Jump back to previous mark
(set-mark-command t)  ; C-u C-SPC</code></pre>
<h4 data-number="20.3.2.6" id="key-functions-reference-2"><span class="header-section-number">20.3.2.6</span> Key Functions
Reference</h4>
<table>
<colgroup>
<col style="width: 31%"/>
<col style="width: 28%"/>
<col style="width: 40%"/>
</colgroup>
<thead>
<tr>
<th>Function</th>
<th>Purpose</th>
<th>Key Binding</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>next-error</code></td>
<td>Jump to next error/match</td>
<td><code>C-x `` | |</code>beginning-of-buffer<code>| Move to buffer start |</code>M-&lt;<code>| |</code>end-of-buffer<code>| Move to buffer end |</code>M-&gt;<code>| |</code>newline<code>| Insert newline |</code>RET<code>| |</code>delete-blank-lines<code>| Clean up blank lines |</code>C-x
C-o<code>| |</code>just-one-space<code>| Collapse whitespace |</code>M-SPC<code>| |</code>count-words-region<code>| Count words in region |</code>M-=<code>| |</code>what-cursor-position<code>| Show position info |</code>C-x
=<code>| |</code>mark-whole-buffer<code>| Select entire buffer |</code>C-x
h`</td>
</tr>
</tbody>
</table>
<hr/>
<h3 data-number="20.3.3" id="files.el---file-operations"><span class="header-section-number">20.3.3</span> files.el - File
Operations</h3>
<p><strong>Location</strong>:
<code>/home/user/emacs/lisp/files.el</code> (9,391 lines)</p>
<p><code>files.el</code> handles all file-related operations: visiting
files, saving buffers, backups, auto-saves, file-name handling, and
directory navigation. It‚Äôs the interface between Emacs buffers and the
filesystem.</p>
<h4 data-number="20.3.3.1" id="file-name-manipulation"><span class="header-section-number">20.3.3.1</span> File Name
Manipulation</h4>
<pre class="elisp"><code>(defun abbreviate-file-name (filename)
  "Return a version of FILENAME shortened using `directory-abbrev-alist'.
Also replaces home directory with ~ if applicable."
  ...)

(defun directory-abbrev-apply (filename)
  "Apply the abbreviations in `directory-abbrev-alist' to FILENAME."
  (dolist (dir-abbrev directory-abbrev-alist filename)
    (when (string-match (car dir-abbrev) filename)
      (setq filename (concat (cdr dir-abbrev)
                             (substring filename (match-end 0)))))))</code></pre>
<p><strong>Practical Use</strong>:</p>
<pre class="elisp"><code>;; Configure abbreviations
(setq directory-abbrev-alist
      '(("\\`/home/user/projects/" . "~/proj/")
        ("\\`/very/long/path/to/src/" . "/src/")))

;; Now file names are displayed more concisely
(abbreviate-file-name "/home/user/file.txt")  ; =&gt; "~/file.txt"</code></pre>
<h4 data-number="20.3.3.2" id="finding-and-visiting-files"><span class="header-section-number">20.3.3.2</span> Finding and Visiting
Files</h4>
<pre class="elisp"><code>(defun find-file (filename &amp;optional wildcards)
  "Edit file FILENAME.
Switch to a buffer visiting file FILENAME,
creating one if none already exists.
Interactively, the default if you just type RET is the current directory,
but the visited file name is available through the minibuffer history."
  (interactive
   (find-file-read-args "Find file: "
                        (confirm-nonexistent-file-or-buffer)))
  ...)

(defun find-file-noselect (filename &amp;optional nowarn rawfile wildcards)
  "Read file FILENAME into a buffer and return the buffer.
If a buffer exists visiting FILENAME, return that one, but verify
that the file has not changed since visited or saved."
  ...)</code></pre>
<p>The distinction is important: - <code>find-file</code> - Visit file
and display its buffer (interactive) - <code>find-file-noselect</code> -
Load file into buffer but don‚Äôt display (programmatic)</p>
<p><strong>Example</strong>:</p>
<pre class="elisp"><code>;; Load a file without displaying it
(with-current-buffer (find-file-noselect "config.el")
  (goto-char (point-min))
  (search-forward "setting")
  (buffer-substring-no-properties (point) (line-end-position)))</code></pre>
<h4 data-number="20.3.3.3" id="temporary-files"><span class="header-section-number">20.3.3.3</span> Temporary Files</h4>
<pre class="elisp"><code>(defun make-temp-file (prefix &amp;optional dir-flag suffix text)
  "Create a temporary file.
PREFIX is a string to be used in generating the file name.
If DIR-FLAG is non-nil, create a directory instead of a file.
SUFFIX, if non-nil, is added to the end of the file name.
TEXT, if non-nil, is written to the file initially."
  ...)</code></pre>
<p><strong>Usage</strong>:</p>
<pre class="elisp"><code>;; Create temporary file for processing
(let ((temp-file (make-temp-file "emacs-data-" nil ".json")))
  (with-temp-file temp-file
    (insert (json-encode data)))
  ;; Process temp-file
  (delete-file temp-file))</code></pre>
<h4 data-number="20.3.3.4" id="backup-and-auto-save-configuration"><span class="header-section-number">20.3.3.4</span> Backup and Auto-Save
Configuration</h4>
<pre class="elisp"><code>(defcustom make-backup-files t
  "Non-nil means make a backup of a file the first time it is saved."
  :type 'boolean
  :group 'backup)

(defcustom backup-by-copying nil
  "Non-nil means always use copying to create backup files."
  :type 'boolean
  :group 'backup)

(defcustom backup-directory-alist nil
  "Alist of filename patterns and backup directory names."
  :type '(repeat (cons (regexp :tag "Regexp matching filename")
                       (directory :tag "Backup directory name")))
  :group 'backup)</code></pre>
<p><strong>Configuration Example</strong>:</p>
<pre class="elisp"><code>;; Store all backups in one directory
(setq backup-directory-alist
      `(("." . ,(expand-file-name "~/.emacs.d/backups"))))

;; Keep multiple versions
(setq version-control t
      kept-new-versions 10
      kept-old-versions 5
      delete-old-versions t)</code></pre>
<h4 data-number="20.3.3.5" id="directory-operations-2"><span class="header-section-number">20.3.3.5</span> Directory Operations</h4>
<pre class="elisp"><code>(defun directory-files-recursively (dir regexp &amp;optional include-directories
                                        predicate follow-symlinks)
  "Return list of all files under DIR that have file names matching REGEXP.
This function works recursively."
  ...)

(defun locate-dominating-file (file name)
  "Look up the directory hierarchy from FILE for a directory containing NAME.
Stop at the first parent directory containing a file NAME,
and return the directory.  Return nil if not found."
  ...)</code></pre>
<p>The <code>locate-dominating-file</code> function is crucial for
project-aware features:</p>
<pre class="elisp"><code>;; Find project root (directory containing .git)
(locate-dominating-file default-directory ".git")

;; Find configuration file in parent directories
(locate-dominating-file buffer-file-name ".editorconfig")</code></pre>
<h4 data-number="20.3.3.6" id="key-functions-reference-3"><span class="header-section-number">20.3.3.6</span> Key Functions
Reference</h4>
<table>
<colgroup>
<col style="width: 34%"/>
<col style="width: 31%"/>
<col style="width: 34%"/>
</colgroup>
<thead>
<tr>
<th>Function</th>
<th>Purpose</th>
<th>Use Case</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>find-file</code></td>
<td>Visit file interactively</td>
<td>User opens file</td>
</tr>
<tr>
<td><code>find-file-noselect</code></td>
<td>Load file programmatically</td>
<td>Background processing</td>
</tr>
<tr>
<td><code>save-buffer</code></td>
<td>Save current buffer</td>
<td>Persist changes</td>
</tr>
<tr>
<td><code>write-file</code></td>
<td>Save with new name</td>
<td>‚ÄúSave As‚Äù operation</td>
</tr>
<tr>
<td><code>make-temp-file</code></td>
<td>Create temporary file</td>
<td>Processing scratch space</td>
</tr>
<tr>
<td><code>directory-files-recursively</code></td>
<td>List files recursively</td>
<td>Build file lists</td>
</tr>
<tr>
<td><code>locate-dominating-file</code></td>
<td>Find project root</td>
<td>Project detection</td>
</tr>
<tr>
<td><code>abbreviate-file-name</code></td>
<td>Shorten file paths</td>
<td>Display optimization</td>
</tr>
</tbody>
</table>
<hr/>
<h3 data-number="20.3.4" id="window.el---window-management"><span class="header-section-number">20.3.4</span> window.el - Window
Management</h3>
<p><strong>Location</strong>:
<code>/home/user/emacs/lisp/window.el</code> (11,465 lines)</p>
<p><code>window.el</code> manages the window system - splitting,
displaying buffers, managing window configurations, and controlling how
Emacs decides where to show things. Windows in Emacs are viewport
regions showing buffers, distinct from GUI frames.</p>
<h4 data-number="20.3.4.1" id="the-window-selection-state"><span class="header-section-number">20.3.4.1</span> The Window Selection
State</h4>
<pre class="elisp"><code>(defmacro save-selected-window (&amp;rest body)
  "Execute BODY, then select the previously selected window.
This macro saves and restores the selected window, as well as the
selected window in each frame."
  (declare (indent 0) (debug t))
  `(let ((save-selected-window--state (internal--before-save-selected-window)))
     (save-current-buffer
       (unwind-protect
           (progn ,@body)
         (internal--after-save-selected-window save-selected-window--state)))))</code></pre>
<p>This macro is fundamental for operations that temporarily switch
windows:</p>
<pre class="elisp"><code>(defun my-peek-other-window ()
  "Temporarily show another window's content."
  (save-selected-window
    (other-window 1)
    (message "Other window shows: %s" (buffer-name))
    ;; Window selection automatically restored
    ))</code></pre>
<h4 data-number="20.3.4.2" id="temporary-buffer-display"><span class="header-section-number">20.3.4.2</span> Temporary Buffer
Display</h4>
<pre class="elisp"><code>(defmacro with-temp-buffer-window (buffer-or-name action quit-function &amp;rest body)
  "Bind `standard-output' to BUFFER-OR-NAME, eval BODY, show the buffer.
BUFFER-OR-NAME must specify either a live buffer, or the name of
a buffer."
  (declare (debug t))
  ...)

(defun temp-buffer-window-show (buffer &amp;optional action)
  "Show temporary buffer BUFFER in a window.
Return the window showing BUFFER."
  ...)</code></pre>
<p>This pattern is used throughout Emacs for help buffers, completions,
and other transient displays:</p>
<pre class="elisp"><code>(with-temp-buffer-window "*My Output*" nil nil
  (princ "Temporary output here\n")
  (princ "Will be displayed in a window"))</code></pre>
<h4 data-number="20.3.4.3" id="display-actions"><span class="header-section-number">20.3.4.3</span> Display Actions</h4>
<p>The display-buffer system is Emacs‚Äôs sophisticated mechanism for
controlling where buffers appear:</p>
<pre class="elisp"><code>;; Display buffer in specific location
(display-buffer buffer
  '((display-buffer-reuse-window
     display-buffer-below-selected)
    (window-height . 10)))

;; Display but don't select
(display-buffer-no-window buffer
  '((side . bottom)
    (slot . 0)))</code></pre>
<p><strong>Action Functions</strong>: -
<code>display-buffer-same-window</code> - Reuse selected window -
<code>display-buffer-below-selected</code> - Split and show below -
<code>display-buffer-at-bottom</code> - Use bottom of frame -
<code>display-buffer-reuse-window</code> - Find existing window showing
buffer - <code>display-buffer-pop-up-window</code> - Create new window -
<code>display-buffer-pop-up-frame</code> - Create new frame</p>
<h4 data-number="20.3.4.4" id="window-configuration"><span class="header-section-number">20.3.4.4</span> Window Configuration</h4>
<pre class="elisp"><code>(defun current-window-configuration (&amp;optional frame)
  "Return an object representing the current window configuration of FRAME.
If FRAME is nil or omitted, use the selected frame."
  ...)

(defun set-window-configuration (configuration &amp;optional dont-set-frame)
  "Restore window configuration CONFIGURATION."
  ...)</code></pre>
<p><strong>Usage Pattern</strong>:</p>
<pre class="elisp"><code>(let ((config (current-window-configuration)))
  ;; Do something that changes windows
  (other-window 1)
  (delete-other-windows)
  ;; Restore original layout
  (set-window-configuration config))</code></pre>
<h4 data-number="20.3.4.5" id="window-splitting"><span class="header-section-number">20.3.4.5</span> Window Splitting</h4>
<pre class="elisp"><code>(defun split-window-below (&amp;optional size)
  "Split the selected window into two windows, one above the other."
  (interactive "P")
  ...)

(defun split-window-right (&amp;optional size)
  "Split the selected window into two side-by-side windows."
  (interactive "P")
  ...)</code></pre>
<h4 data-number="20.3.4.6" id="key-functions-reference-4"><span class="header-section-number">20.3.4.6</span> Key Functions
Reference</h4>
<table>
<colgroup>
<col style="width: 31%"/>
<col style="width: 28%"/>
<col style="width: 40%"/>
</colgroup>
<thead>
<tr>
<th>Function</th>
<th>Purpose</th>
<th>Typical Use</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>save-selected-window</code></td>
<td>Preserve window selection</td>
<td>Temporary window switches</td>
</tr>
<tr>
<td><code>with-temp-buffer-window</code></td>
<td>Display temporary content</td>
<td>Help buffers, output</td>
</tr>
<tr>
<td><code>display-buffer</code></td>
<td>Show buffer with control</td>
<td>Generic buffer display</td>
</tr>
<tr>
<td><code>split-window-below</code></td>
<td>Horizontal split</td>
<td>Create layout</td>
</tr>
<tr>
<td><code>split-window-right</code></td>
<td>Vertical split</td>
<td>Create layout</td>
</tr>
<tr>
<td><code>delete-window</code></td>
<td>Close window</td>
<td>Clean up layout</td>
</tr>
<tr>
<td><code>delete-other-windows</code></td>
<td>Keep only selected</td>
<td>Focus on one buffer</td>
</tr>
<tr>
<td><code>current-window-configuration</code></td>
<td>Save layout</td>
<td>Layout restoration</td>
</tr>
</tbody>
</table>
<hr/>
<h2 data-number="20.4" id="data-structures"><span class="header-section-number">20.4</span> Data Structures</h2>
<h3 data-number="20.4.1" id="seq.el---sequence-manipulation"><span class="header-section-number">20.4.1</span> seq.el - Sequence
Manipulation</h3>
<p><strong>Location</strong>:
<code>/home/user/emacs/lisp/emacs-lisp/seq.el</code></p>
<p><code>seq.el</code> provides a unified, generic API for working with
sequences (lists, vectors, strings). It uses cl-generic to dispatch to
the appropriate implementation based on sequence type.</p>
<h4 data-number="20.4.1.1" id="core-philosophy"><span class="header-section-number">20.4.1.1</span> Core Philosophy</h4>
<p>The key insight of <code>seq.el</code> is that many operations apply
to any ordered collection:</p>
<pre class="elisp"><code>;; Same API works on lists, vectors, and strings!
(seq-filter #'oddp [1 2 3 4 5])      ; =&gt; [1 3 5]
(seq-filter #'oddp '(1 2 3 4 5))     ; =&gt; (1 3 5)
(seq-map #'upcase "hello")           ; =&gt; "HELLO"</code></pre>
<h4 data-number="20.4.1.2" id="iteration"><span class="header-section-number">20.4.1.2</span> Iteration</h4>
<pre class="elisp"><code>(defmacro seq-doseq (spec &amp;rest body)
  "Loop over a SEQUENCE, evaluating BODY with VAR bound to each element.
Similar to `dolist' but works on lists, strings, and vectors.
\(fn (VAR SEQUENCE) BODY...)"
  (declare (indent 1) (debug ((symbolp form &amp;optional form) body)))
  `(seq-do (lambda (,(car spec))
             ,@body)
           ,(cadr spec)))

(defmacro seq-let (args sequence &amp;rest body)
  "Bind the variables in ARGS to the elements of SEQUENCE, then evaluate BODY.
ARGS can also include the `&amp;rest' marker."
  (declare (indent 2) (debug (sexp form body)))
  ...)</code></pre>
<p><strong>Examples</strong>:</p>
<pre class="elisp"><code>;; Iterate over any sequence
(seq-doseq (word ["apple" "banana" "cherry"])
  (insert word "\n"))

;; Destructure sequences
(seq-let [first second &amp;rest others] [1 2 3 4 5]
  (message "First: %s, Second: %s, Rest: %s" first second others))
;; =&gt; "First: 1, Second: 2, Rest: (3 4 5)"</code></pre>
<h4 data-number="20.4.1.3" id="filtering-and-mapping"><span class="header-section-number">20.4.1.3</span> Filtering and Mapping</h4>
<pre class="elisp"><code>(cl-defgeneric seq-filter (pred sequence)
  "Return a list of all elements for which PRED returns non-nil in SEQUENCE."
  ...)

(cl-defgeneric seq-map (function sequence)
  "Return the result of applying FUNCTION to each element of SEQUENCE."
  ...)

(defun seq-remove (pred sequence)
  "Return a list of all elements for which PRED returns nil in SEQUENCE."
  (seq-filter (lambda (elt) (not (funcall pred elt))) sequence))</code></pre>
<p><strong>Practical Examples</strong>:</p>
<pre class="elisp"><code>;; Filter files by extension
(seq-filter (lambda (f) (string-suffix-p ".el" f))
            (directory-files "/path/to/dir"))

;; Transform data
(seq-map (lambda (x) (* x x))
         [1 2 3 4 5])  ; =&gt; [1 4 9 16 25]

;; Remove empty strings
(seq-remove #'string-empty-p '("a" "" "b" "" "c"))  ; =&gt; ("a" "b" "c")</code></pre>
<h4 data-number="20.4.1.4" id="subsequences-and-access"><span class="header-section-number">20.4.1.4</span> Subsequences and
Access</h4>
<pre class="elisp"><code>(cl-defgeneric seq-subseq (sequence start &amp;optional end)
  "Return the sequence of elements of SEQUENCE from START to END.
END is exclusive."
  ...)

(defun seq-take (sequence n)
  "Return the first N elements of SEQUENCE."
  (seq-subseq sequence 0 n))

(defun seq-drop (sequence n)
  "Return SEQUENCE without its first N elements."
  (seq-subseq sequence n))</code></pre>
<p><strong>Usage</strong>:</p>
<pre class="elisp"><code>(seq-take [1 2 3 4 5] 3)        ; =&gt; [1 2 3]
(seq-drop "hello world" 6)      ; =&gt; "world"
(seq-subseq '(a b c d e) 1 4)   ; =&gt; (b c d)</code></pre>
<h4 data-number="20.4.1.5" id="searching-and-testing"><span class="header-section-number">20.4.1.5</span> Searching and Testing</h4>
<pre class="elisp"><code>(defun seq-find (pred sequence &amp;optional default)
  "Return the first element for which PRED returns non-nil in SEQUENCE."
  ...)

(defun seq-contains-p (sequence elt &amp;optional testfn)
  "Return non-nil if SEQUENCE contains an element equal to ELT."
  ...)

(defun seq-every-p (pred sequence)
  "Return non-nil if PRED returns non-nil for all elements of SEQUENCE."
  ...)

(defun seq-some (pred sequence)
  "Return non-nil if PRED returns non-nil for any element of SEQUENCE."
  ...)</code></pre>
<p><strong>Examples</strong>:</p>
<pre class="elisp"><code>;; Find first even number
(seq-find #'evenp [1 3 5 6 7])  ; =&gt; 6

;; Check if sequence contains element
(seq-contains-p '(a b c) 'b)    ; =&gt; t

;; Test all elements
(seq-every-p #'numberp [1 2 3])  ; =&gt; t
(seq-every-p #'numberp [1 'a 3]) ; =&gt; nil

;; Test any element
(seq-some #'stringp '(1 2 "three" 4))  ; =&gt; t</code></pre>
<h4 data-number="20.4.1.6" id="reduction"><span class="header-section-number">20.4.1.6</span> Reduction</h4>
<pre class="elisp"><code>(defun seq-reduce (function sequence initial-value)
  "Reduce SEQUENCE to a single value by successively applying FUNCTION.
Return the result of calling FUNCTION with INITIAL-VALUE and the
first element of SEQUENCE, then calling FUNCTION with that result
and the second element, etc."
  ...)</code></pre>
<p><strong>Examples</strong>:</p>
<pre class="elisp"><code>;; Sum numbers
(seq-reduce #'+ [1 2 3 4 5] 0)  ; =&gt; 15

;; Concatenate strings
(seq-reduce (lambda (acc s) (concat acc " " s))
            ["Hello" "from" "seq.el"]
            "")  ; =&gt; " Hello from seq.el"

;; Build alist
(seq-reduce (lambda (acc pair)
              (cons pair acc))
            '((:a . 1) (:b . 2))
            nil)</code></pre>
<h4 data-number="20.4.1.7" id="key-functions-reference-5"><span class="header-section-number">20.4.1.7</span> Key Functions
Reference</h4>
<table>
<colgroup>
<col style="width: 35%"/>
<col style="width: 32%"/>
<col style="width: 32%"/>
</colgroup>
<thead>
<tr>
<th>Function</th>
<th>Purpose</th>
<th>Example</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>seq-map</code></td>
<td>Transform each element</td>
<td><code>(seq-map #'1+ [1 2 3])</code></td>
</tr>
<tr>
<td><code>seq-filter</code></td>
<td>Keep matching elements</td>
<td><code>(seq-filter #'oddp [1 2 3])</code></td>
</tr>
<tr>
<td><code>seq-remove</code></td>
<td>Remove matching elements</td>
<td><code>(seq-remove #'oddp [1 2 3])</code></td>
</tr>
<tr>
<td><code>seq-reduce</code></td>
<td>Fold/accumulate</td>
<td><code>(seq-reduce #'+ [1 2 3] 0)</code></td>
</tr>
<tr>
<td><code>seq-find</code></td>
<td>Find first match</td>
<td><code>(seq-find #'evenp [1 2 3])</code></td>
</tr>
<tr>
<td><code>seq-take</code></td>
<td>First N elements</td>
<td><code>(seq-take [1 2 3 4] 2)</code></td>
</tr>
<tr>
<td><code>seq-drop</code></td>
<td>All but first N</td>
<td><code>(seq-drop [1 2 3 4] 2)</code></td>
</tr>
<tr>
<td><code>seq-contains-p</code></td>
<td>Test membership</td>
<td><code>(seq-contains-p [1 2 3] 2)</code></td>
</tr>
</tbody>
</table>
<hr/>
<h3 data-number="20.4.2" id="map.el---mapdictionary-operations"><span class="header-section-number">20.4.2</span> map.el - Map/Dictionary
Operations</h3>
<p><strong>Location</strong>:
<code>/home/user/emacs/lisp/emacs-lisp/map.el</code></p>
<p><code>map.el</code> provides a generic API for associative data
structures: alists, plists, and hash tables. Like <code>seq.el</code>,
it uses cl-generic for polymorphic dispatch.</p>
<h4 data-number="20.4.2.1" id="universal-map-access"><span class="header-section-number">20.4.2.1</span> Universal Map Access</h4>
<pre class="elisp"><code>(cl-defgeneric map-elt (map key &amp;optional default testfn)
  "Look up KEY in MAP and return its associated value.
If KEY is not found, return DEFAULT which defaults to nil."
  ...)

;; Works with different map types:
(map-elt '((a . 1) (b . 2)) 'a)              ; alist =&gt; 1
(map-elt '(:a 1 :b 2) :a)                    ; plist =&gt; 1
(map-elt #s(hash-table data (a 1 b 2)) 'a)  ; hash =&gt; 1</code></pre>
<h4 data-number="20.4.2.2" id="pattern-matching"><span class="header-section-number">20.4.2.2</span> Pattern Matching</h4>
<pre class="elisp"><code>(pcase-defmacro map (&amp;rest args)
  "Build a `pcase' pattern matching map elements.
Each element of ARGS can be (KEY PAT [DEFAULT])."
  ...)

(defmacro map-let (keys map &amp;rest body)
  "Bind the variables in KEYS to the elements of MAP, then evaluate BODY."
  (declare (indent 2))
  ...)</code></pre>
<p><strong>Destructuring Example</strong>:</p>
<pre class="elisp"><code>;; Extract values from maps
(map-let (name age city)
    '((name . "Alice")
      (age . 30)
      (city . "NYC"))
  (message "%s is %d years old and lives in %s" name age city))

;; Pattern matching in pcase
(pcase my-config
  ((map (:host host) (:port port) (:ssl ssl))
   (message "Connecting to %s:%d (SSL: %s)" host port ssl)))</code></pre>
<h4 data-number="20.4.2.3" id="map-manipulation"><span class="header-section-number">20.4.2.3</span> Map Manipulation</h4>
<pre class="elisp"><code>(cl-defgeneric map-put! (map key value &amp;optional testfn)
  "Associate KEY with VALUE in MAP.
This mutates the map if possible."
  ...)

(defun map-insert (map key value)
  "Return a new map based on MAP with KEY associated with VALUE."
  ...)

(defun map-delete (map key)
  "Return a new map based on MAP without KEY."
  ...)</code></pre>
<p><strong>Examples</strong>:</p>
<pre class="elisp"><code>;; Add to alist (immutable)
(setq config (map-insert config 'timeout 30))

;; Mutate hash table
(let ((hash (make-hash-table)))
  (map-put! hash 'key "value")
  hash)

;; Remove key
(setq config (map-delete config 'old-setting))</code></pre>
<h4 data-number="20.4.2.4" id="iteration-1"><span class="header-section-number">20.4.2.4</span> Iteration</h4>
<pre class="elisp"><code>(cl-defgeneric map-do (function map)
  "Apply FUNCTION to each key-value pair in MAP.
FUNCTION is called with two arguments: the key and the value."
  ...)

(defmacro map-let (keys map &amp;rest body)
  "Bind variables in KEYS to values in MAP, then eval BODY."
  ...)</code></pre>
<p><strong>Examples</strong>:</p>
<pre class="elisp"><code>;; Iterate over map entries
(map-do (lambda (key value)
          (message "%s =&gt; %s" key value))
        '((a . 1) (b . 2) (c . 3)))

;; Convert alist to hash table
(let ((hash (make-hash-table)))
  (map-do (lambda (k v) (puthash k v hash))
          my-alist)
  hash)</code></pre>
<h4 data-number="20.4.2.5" id="conversions"><span class="header-section-number">20.4.2.5</span> Conversions</h4>
<pre class="elisp"><code>(defun map-keys (map)
  "Return the list of keys in MAP."
  ...)

(defun map-values (map)
  "Return the list of values in MAP."
  ...)

(defun map-pairs (map)
  "Return the key-value pairs in MAP as a list of conses."
  ...)</code></pre>
<p><strong>Usage</strong>:</p>
<pre class="elisp"><code>(map-keys '((a . 1) (b . 2)))      ; =&gt; (a b)
(map-values '((a . 1) (b . 2)))    ; =&gt; (1 2)
(map-pairs '(:a 1 :b 2))           ; =&gt; ((‚Ä´:a . 1) (:b . 2))</code></pre>
<h4 data-number="20.4.2.6" id="key-functions-reference-6"><span class="header-section-number">20.4.2.6</span> Key Functions
Reference</h4>
<table>
<thead>
<tr>
<th>Function</th>
<th>Purpose</th>
<th>Example</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>map-elt</code></td>
<td>Get value by key</td>
<td><code>(map-elt map 'key)</code></td>
</tr>
<tr>
<td><code>map-put!</code></td>
<td>Set value (mutating)</td>
<td><code>(map-put! map 'k 'v)</code></td>
</tr>
<tr>
<td><code>map-insert</code></td>
<td>Add entry (immutable)</td>
<td><code>(map-insert map 'k 'v)</code></td>
</tr>
<tr>
<td><code>map-delete</code></td>
<td>Remove entry</td>
<td><code>(map-delete map 'key)</code></td>
</tr>
<tr>
<td><code>map-keys</code></td>
<td>List all keys</td>
<td><code>(map-keys map)</code></td>
</tr>
<tr>
<td><code>map-values</code></td>
<td>List all values</td>
<td><code>(map-values map)</code></td>
</tr>
<tr>
<td><code>map-do</code></td>
<td>Iterate over entries</td>
<td><code>(map-do fn map)</code></td>
</tr>
<tr>
<td><code>map-let</code></td>
<td>Destructure map</td>
<td><code>(map-let (k1 k2) map ...)</code></td>
</tr>
</tbody>
</table>
<hr/>
<h3 data-number="20.4.3" id="ring.el---ring-buffers"><span class="header-section-number">20.4.3</span> ring.el - Ring Buffers</h3>
<p><strong>Location</strong>:
<code>/home/user/emacs/lisp/emacs-lisp/ring.el</code></p>
<p>A ring is a fixed-size circular buffer that automatically overwrites
the oldest elements when full. Rings are used throughout Emacs for
history mechanisms (kill ring, command history, search history).</p>
<h4 data-number="20.4.3.1" id="ring-structure"><span class="header-section-number">20.4.3.1</span> Ring Structure</h4>
<pre class="elisp"><code>;; A ring is represented as: (hd-index length . vector)
;; - hd-index: vector index of oldest element
;; - length: current number of elements
;; - vector: the storage array

(defun make-ring (size)
  "Make a ring that can contain SIZE elements."
  (cons 0 (cons 0 (make-vector size nil))))

(defun ring-p (x)
  "Return t if X is a ring; nil otherwise."
  (and (consp x) (integerp (car x))
       (consp (cdr x)) (integerp (cadr x))
       (vectorp (cddr x))))</code></pre>
<h4 data-number="20.4.3.2" id="ring-operations"><span class="header-section-number">20.4.3.2</span> Ring Operations</h4>
<pre class="elisp"><code>(defun ring-insert (ring item)
  "Insert onto RING the item ITEM, as the newest (last) item.
If the ring is full, dump the oldest item to make room."
  ...)

(defun ring-remove (ring &amp;optional index)
  "Remove an item from RING and return it.
If optional INDEX is nil, remove the oldest item."
  ...)

(defun ring-ref (ring index)
  "Return RING's INDEX element.
INDEX = 0 is the most recently inserted; higher indices
correspond to older elements."
  ...)</code></pre>
<h4 data-number="20.4.3.3" id="practical-example-command-history"><span class="header-section-number">20.4.3.3</span> Practical Example: Command
History</h4>
<pre class="elisp"><code>;; Create a command history ring
(defvar my-command-history (make-ring 50)
  "History of recent commands.")

;; Add command to history
(defun my-record-command (command)
  (ring-insert my-command-history command))

;; Retrieve last N commands
(defun my-recent-commands (n)
  (cl-loop for i from 0 below (min n (ring-length my-command-history))
           collect (ring-ref my-command-history i)))

;; Usage
(my-record-command 'find-file)
(my-record-command 'save-buffer)
(my-recent-commands 2)  ; =&gt; (save-buffer find-file)</code></pre>
<h4 data-number="20.4.3.4" id="ring-traversal"><span class="header-section-number">20.4.3.4</span> Ring Traversal</h4>
<pre class="elisp"><code>(defun ring-elements (ring)
  "Return a list of the elements of RING, in order from newest to oldest."
  ...)

(defun ring-empty-p (ring)
  "Return t if RING is empty; nil otherwise."
  (zerop (cadr ring)))

(defun ring-size (ring)
  "Return the size of RING, the maximum number of elements it can contain."
  (length (cddr ring)))</code></pre>
<h4 data-number="20.4.3.5" id="real-world-usage-kill-ring"><span class="header-section-number">20.4.3.5</span> Real-World Usage: Kill
Ring</h4>
<p>The kill ring is Emacs‚Äôs clipboard history, implemented as a
ring:</p>
<pre class="elisp"><code>;; The kill ring stores clipboard history
(defvar kill-ring (make-ring 60))

;; Recent kills
(ring-ref kill-ring 0)  ; Most recent kill
(ring-ref kill-ring 1)  ; Previous kill

;; Yank (paste) cycles through the ring with M-y</code></pre>
<h4 data-number="20.4.3.6" id="key-functions-reference-7"><span class="header-section-number">20.4.3.6</span> Key Functions
Reference</h4>
<table>
<thead>
<tr>
<th>Function</th>
<th>Purpose</th>
<th>Example</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>make-ring</code></td>
<td>Create ring of size N</td>
<td><code>(make-ring 10)</code></td>
</tr>
<tr>
<td><code>ring-insert</code></td>
<td>Add newest element</td>
<td><code>(ring-insert ring item)</code></td>
</tr>
<tr>
<td><code>ring-remove</code></td>
<td>Remove element</td>
<td><code>(ring-remove ring 0)</code></td>
</tr>
<tr>
<td><code>ring-ref</code></td>
<td>Access by index</td>
<td><code>(ring-ref ring 0)</code></td>
</tr>
<tr>
<td><code>ring-length</code></td>
<td>Current size</td>
<td><code>(ring-length ring)</code></td>
</tr>
<tr>
<td><code>ring-empty-p</code></td>
<td>Test if empty</td>
<td><code>(ring-empty-p ring)</code></td>
</tr>
<tr>
<td><code>ring-elements</code></td>
<td>Convert to list</td>
<td><code>(ring-elements ring)</code></td>
</tr>
</tbody>
</table>
<hr/>
<h3 data-number="20.4.4" id="avl-tree.el---balanced-binary-trees"><span class="header-section-number">20.4.4</span> avl-tree.el - Balanced
Binary Trees</h3>
<p><strong>Location</strong>:
<code>/home/user/emacs/lisp/emacs-lisp/avl-tree.el</code></p>
<p>AVL trees are self-balancing binary search trees providing O(log n)
insertion, deletion, and retrieval. They‚Äôre used when you need sorted
data with efficient operations.</p>
<h4 data-number="20.4.4.1" id="tree-structure"><span class="header-section-number">20.4.4.1</span> Tree Structure</h4>
<pre class="elisp"><code>(cl-defstruct (avl-tree-
            :named
            (:constructor avl-tree--create (cmpfun))
            (:predicate avl-tree-p))
  (dummyroot (avl-tree--node-create nil nil nil 0))
  cmpfun)

;; Nodes: [left right data balance]
(cl-defstruct (avl-tree--node
            (:type vector)
            (:constructor avl-tree--node-create (left right data balance)))
  left right data balance)</code></pre>
<h4 data-number="20.4.4.2" id="creation-and-basic-operations"><span class="header-section-number">20.4.4.2</span> Creation and Basic
Operations</h4>
<pre class="elisp"><code>(defun avl-tree-create (compare-function)
  "Create an empty AVL tree.
COMPARE-FUNCTION is a function which takes two arguments, A and B,
and returns non-nil if A is less than B, and nil otherwise."
  (avl-tree--create compare-function))

(defun avl-tree-enter (tree data)
  "Insert DATA into the AVL TREE."
  ...)

(defun avl-tree-delete (tree data)
  "Delete DATA from the AVL TREE."
  ...)

(defun avl-tree-member (tree data)
  "Return non-nil if DATA is in TREE."
  ...)</code></pre>
<h4 data-number="20.4.4.3" id="example-sorted-set"><span class="header-section-number">20.4.4.3</span> Example: Sorted Set</h4>
<pre class="elisp"><code>;; Create a sorted set of numbers
(defvar my-numbers (avl-tree-create #'&lt;))

;; Insert elements (automatically sorted)
(avl-tree-enter my-numbers 5)
(avl-tree-enter my-numbers 2)
(avl-tree-enter my-numbers 8)
(avl-tree-enter my-numbers 1)

;; Check membership: O(log n)
(avl-tree-member my-numbers 2)  ; =&gt; t
(avl-tree-member my-numbers 7)  ; =&gt; nil

;; Iterate in sorted order
(avl-tree-mapc (lambda (x) (message "Number: %d" x))
               my-numbers)
;; Prints: 1, 2, 5, 8 (in order!)</code></pre>
<h4 data-number="20.4.4.4" id="traversal"><span class="header-section-number">20.4.4.4</span> Traversal</h4>
<pre class="elisp"><code>(defun avl-tree-map (map-function tree)
  "Apply MAP-FUNCTION to all elements in TREE.
The function is applied in ascending order."
  ...)

(defun avl-tree-mapc (map-function tree)
  "Apply MAP-FUNCTION to all elements in TREE for side effects."
  ...)

(defun avl-tree-mapcar (map-function tree)
  "Apply MAP-FUNCTION to all elements in TREE.
Return a list of the results, in ascending order."
  ...)</code></pre>
<h4 data-number="20.4.4.5" id="when-to-use-avl-trees"><span class="header-section-number">20.4.4.5</span> When to Use AVL Trees</h4>
<p><strong>Use AVL trees when:</strong> - You need sorted data with
efficient insertion/deletion - Lookups are more common than
modifications - You need to maintain a sorted collection dynamically</p>
<p><strong>Don‚Äôt use when:</strong> - Simple list is sufficient (&lt;
100 elements) - Hash tables would work (unordered data) - Read-only
sorted data (use sorted vector)</p>
<h4 data-number="20.4.4.6" id="key-functions-reference-8"><span class="header-section-number">20.4.4.6</span> Key Functions
Reference</h4>
<table>
<thead>
<tr>
<th>Function</th>
<th>Purpose</th>
<th>Complexity</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>avl-tree-create</code></td>
<td>Create empty tree</td>
<td>O(1)</td>
</tr>
<tr>
<td><code>avl-tree-enter</code></td>
<td>Insert element</td>
<td>O(log n)</td>
</tr>
<tr>
<td><code>avl-tree-delete</code></td>
<td>Remove element</td>
<td>O(log n)</td>
</tr>
<tr>
<td><code>avl-tree-member</code></td>
<td>Check membership</td>
<td>O(log n)</td>
</tr>
<tr>
<td><code>avl-tree-mapcar</code></td>
<td>Map to list</td>
<td>O(n)</td>
</tr>
<tr>
<td><code>avl-tree-empty</code></td>
<td>Check if empty</td>
<td>O(1)</td>
</tr>
</tbody>
</table>
<hr/>
<h2 data-number="20.5" id="completion-framework"><span class="header-section-number">20.5</span> Completion Framework</h2>
<h3 data-number="20.5.1" id="minibuffer.el---minibuffer-and-completion"><span class="header-section-number">20.5.1</span> minibuffer.el - Minibuffer
and Completion</h3>
<p><strong>Location</strong>:
<code>/home/user/emacs/lisp/minibuffer.el</code> (5,763 lines)</p>
<p>The minibuffer is Emacs‚Äôs command-line interface, and
<code>minibuffer.el</code> implements its sophisticated completion
system. This is one of Emacs‚Äôs most powerful subsystems.</p>
<h4 data-number="20.5.1.1" id="completion-tables"><span class="header-section-number">20.5.1.1</span> Completion Tables</h4>
<p>Completion tables are the heart of the system. They can be lists,
hash tables, functions, or alists:</p>
<pre class="elisp"><code>(defun completion-boundaries (string collection pred suffix)
  "Return the boundaries of text on which COLLECTION will operate.
STRING is the string on which completion will be performed.
SUFFIX is the string after point."
  ...)

(defun completion-metadata (string table pred)
  "Return the metadata of elements to complete at the end of STRING.
Metadata includes:
- `category': the kind of objects
- `annotation-function': function to add annotations
- `affixation-function': function to prepend/append prefix/suffix
- `group-function': function for grouping candidates
- `display-sort-function': function to sort in *Completions*
- `cycle-sort-function': function to sort when cycling"
  ...)</code></pre>
<h4 data-number="20.5.1.2" id="completion-metadata"><span class="header-section-number">20.5.1.2</span> Completion Metadata</h4>
<p>Metadata controls how completion behaves:</p>
<pre class="elisp"><code>;; Example: Define completion with metadata
(defun my-completion-table (string pred action)
  (if (eq action 'metadata)
      '(metadata
        (category . my-category)
        (annotation-function . my-annotate)
        (display-sort-function . my-sort))
    ;; Normal completion logic
    (all-completions string my-candidates pred)))

(defun my-annotate (candidate)
  "Add annotation to CANDIDATE."
  (concat " " (get-text-property 0 'info candidate)))</code></pre>
<h4 data-number="20.5.1.3" id="reading-with-completion"><span class="header-section-number">20.5.1.3</span> Reading with
Completion</h4>
<pre class="elisp"><code>(completing-read "Choose: " '("apple" "banana" "cherry"))

;; With custom metadata
(completing-read "Select file: "
                 (completion-table-dynamic
                  (lambda (prefix)
                    (file-name-all-completions prefix "~/")))
                 nil nil nil 'file-name-history)</code></pre>
<h4 data-number="20.5.1.4" id="completion-styles"><span class="header-section-number">20.5.1.4</span> Completion Styles</h4>
<p>Emacs supports multiple completion styles that can be mixed:</p>
<ul>
<li><strong>basic</strong>: Prefix matching (abc matches ‚Äúabc‚Ä¶‚Äù)</li>
<li><strong>partial</strong>: Wildcards (a*c matches ‚Äúabc‚Äù, ‚Äúaxc‚Äù)</li>
<li><strong>substring</strong>: Substring matching (bc matches
‚Äúabc‚Äù)</li>
<li><strong>flex</strong>: Flexible matching (fnd matches ‚Äúfind‚Äù)</li>
<li><strong>initials</strong>: Initials (fb matches ‚Äúfoo-bar‚Äù)</li>
</ul>
<pre class="elisp"><code>;; Configure completion styles
(setq completion-styles '(basic partial-completion emacs22))

;; Different styles for different categories
(setq completion-category-overrides
      '((file (styles basic partial-completion))
        (buffer (styles flex basic))))</code></pre>
<h4 data-number="20.5.1.5" id="completion-ui"><span class="header-section-number">20.5.1.5</span> Completion UI</h4>
<pre class="elisp"><code>;; Completion in region (at point)
(completion-in-region start end collection predicate)

;; Programmatic completion
(completion-all-completions
 string                  ; Input string
 collection             ; Completion table
 predicate              ; Filter function
 point)                 ; Position in string</code></pre>
<h4 data-number="20.5.1.6" id="real-world-example-custom-completion"><span class="header-section-number">20.5.1.6</span> Real-World Example: Custom
Completion</h4>
<pre class="elisp"><code>;; Define a completion command
(defun my-choose-project ()
  "Choose a project with completion."
  (interactive)
  (let* ((projects '(("emacs" . "~/src/emacs")
                     ("website" . "~/projects/website")
                     ("notes" . "~/notes")))
         (choice (completing-read "Project: "
                                  (lambda (string pred action)
                                    (if (eq action 'metadata)
                                        '(metadata (category . project))
                                      (complete-with-action
                                       action projects string pred))))))
    (message "Selected: %s -&gt; %s"
             choice
             (alist-get choice projects nil nil #'equal))))</code></pre>
<h4 data-number="20.5.1.7" id="key-functions-reference-9"><span class="header-section-number">20.5.1.7</span> Key Functions
Reference</h4>
<table>
<colgroup>
<col style="width: 34%"/>
<col style="width: 31%"/>
<col style="width: 34%"/>
</colgroup>
<thead>
<tr>
<th>Function</th>
<th>Purpose</th>
<th>Use Case</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>completing-read</code></td>
<td>Read with completion</td>
<td>Interactive input</td>
</tr>
<tr>
<td><code>completion-boundaries</code></td>
<td>Determine completion scope</td>
<td>Multi-part completion</td>
</tr>
<tr>
<td><code>completion-metadata</code></td>
<td>Get completion metadata</td>
<td>Custom completion</td>
</tr>
<tr>
<td><code>completion-all-completions</code></td>
<td>Get all matches</td>
<td>Programmatic access</td>
</tr>
<tr>
<td><code>completion-try-completion</code></td>
<td>Test completion</td>
<td>Validation</td>
</tr>
</tbody>
</table>
<hr/>
<h2 data-number="20.6" id="search-and-replace"><span class="header-section-number">20.6</span> Search and Replace</h2>
<h3 data-number="20.6.1" id="isearch.el---incremental-search"><span class="header-section-number">20.6.1</span> isearch.el - Incremental
Search</h3>
<p><strong>Location</strong>:
<code>/home/user/emacs/lisp/isearch.el</code></p>
<p>Incremental search (isearch) is Emacs‚Äôs signature search feature -
searching happens as you type, with immediate visual feedback.</p>
<h4 data-number="20.6.1.1" id="search-modes"><span class="header-section-number">20.6.1.1</span> Search Modes</h4>
<pre class="elisp"><code>(defgroup isearch nil
  "Incremental search minor mode."
  :group 'matching)

(defcustom search-upper-case 'not-yanks
  "If non-nil, upper case chars disable case fold searching.
That is, upper and lower case chars must match exactly."
  :type '(choice (const :tag "Case-sensitive when upper case used" not-yanks)
                 (const :tag "Always case-sensitive" t)
                 (const :tag "Never case-sensitive" nil)))</code></pre>
<h4 data-number="20.6.1.2" id="search-state"><span class="header-section-number">20.6.1.2</span> Search State</h4>
<p>Isearch maintains rich state during searching: - Search string and
position - Direction (forward/backward) - Regexp vs literal - Case
sensitivity - Wrapped status - Match history</p>
<h4 data-number="20.6.1.3" id="customization"><span class="header-section-number">20.6.1.3</span> Customization</h4>
<pre class="elisp"><code>;; Configure search behavior
(setq search-upper-case t)           ; Smart case
(setq isearch-lazy-count t)          ; Show match count
(setq isearch-allow-scroll t)        ; Allow scrolling during search
(setq isearch-wrap-pause 'no-ding)   ; Don't beep when wrapping</code></pre>
<h4 data-number="20.6.1.4" id="search-extensions"><span class="header-section-number">20.6.1.4</span> Search Extensions</h4>
<pre class="elisp"><code>;; Add custom search behavior
(defun my-isearch-word-at-point ()
  "Start isearch with word at point."
  (interactive)
  (let ((word (thing-at-point 'word)))
    (isearch-mode t nil nil nil)
    (isearch-yank-string word)))

;; Bind it
(define-key global-map (kbd "C-*") 'my-isearch-word-at-point)</code></pre>
<h4 data-number="20.6.1.5" id="key-functions-reference-10"><span class="header-section-number">20.6.1.5</span> Key Functions
Reference</h4>
<table>
<thead>
<tr>
<th>Function</th>
<th>Purpose</th>
<th>Default Binding</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>isearch-forward</code></td>
<td>Search forward</td>
<td><code>C-s</code></td>
</tr>
<tr>
<td><code>isearch-backward</code></td>
<td>Search backward</td>
<td><code>C-r</code></td>
</tr>
<tr>
<td><code>isearch-forward-regexp</code></td>
<td>Regexp search</td>
<td><code>C-M-s</code></td>
</tr>
<tr>
<td><code>isearch-yank-word</code></td>
<td>Yank word into search</td>
<td><code>C-s C-w</code></td>
</tr>
</tbody>
</table>
<hr/>
<h2 data-number="20.7" id="help-system"><span class="header-section-number">20.7</span> Help System</h2>
<h3 data-number="20.7.1" id="help.el---help-commands"><span class="header-section-number">20.7.1</span> help.el - Help Commands</h3>
<p><strong>Location</strong>:
<code>/home/user/emacs/lisp/help.el</code></p>
<p>The help system makes Emacs self-documenting. Every function,
variable, and key binding can be queried interactively.</p>
<h4 data-number="20.7.1.1" id="help-map"><span class="header-section-number">20.7.1.1</span> Help Map</h4>
<pre class="elisp"><code>(defvar-keymap help-map
  :doc "Keymap for characters following the Help key."
  "a"    #'apropos-command          ; Search commands
  "b"    #'describe-bindings        ; Show all key bindings
  "c"    #'describe-key-briefly     ; What does key do (brief)
  "f"    #'describe-function        ; Describe function
  "k"    #'describe-key             ; What does key do (detailed)
  "m"    #'describe-mode            ; Describe current modes
  "o"    #'describe-symbol          ; Describe symbol
  "v"    #'describe-variable        ; Describe variable
  "w"    #'where-is)                ; Where is command bound</code></pre>
<h4 data-number="20.7.1.2" id="interactive-help"><span class="header-section-number">20.7.1.2</span> Interactive Help</h4>
<p>All help commands follow a pattern: they read input, look up
documentation, and display it in a <code>*Help*</code> buffer:</p>
<pre class="elisp"><code>;; C-h f RET describe-function RET
;; Shows: signature, documentation, source location

;; C-h v RET completion-styles RET
;; Shows: value, documentation, customization info

;; C-h k C-x C-f
;; Shows: what find-file does</code></pre>
<h4 data-number="20.7.1.3" id="programmatic-help-access"><span class="header-section-number">20.7.1.3</span> Programmatic Help
Access</h4>
<pre class="elisp"><code>;; Get function documentation
(documentation 'car)
;; =&gt; "Return the car of LIST..."

;; Check if function is interactive
(commandp 'save-buffer)  ; =&gt; t

;; Find where function is defined
(find-function-noselect 'car)
;; =&gt; buffer visiting src/data.c</code></pre>
<h4 data-number="20.7.1.4" id="help-system-extensibility"><span class="header-section-number">20.7.1.4</span> Help System
Extensibility</h4>
<pre class="elisp"><code>;; Add custom help
(defun my-help-mode-hook ()
  "Customize help buffer."
  ;; Add custom key bindings
  (local-set-key (kbd "q") 'quit-window))

(add-hook 'help-mode-hook 'my-help-mode-hook)</code></pre>
<hr/>
<h2 data-number="20.8" id="customization-1"><span class="header-section-number">20.8</span> Customization</h2>
<h3 data-number="20.8.1" id="custom.el---customization-framework"><span class="header-section-number">20.8.1</span> custom.el - Customization
Framework</h3>
<p><strong>Location</strong>:
<code>/home/user/emacs/lisp/custom.el</code></p>
<p>The customization system provides a structured way to define and set
user options, with type checking, persistence, and UI support.</p>
<h4 data-number="20.8.1.1" id="defining-custom-variables"><span class="header-section-number">20.8.1.1</span> Defining Custom
Variables</h4>
<pre class="elisp"><code>(defcustom user-option value
  "Documentation string."
  :type 'type-specification
  :group 'group-name
  :options '(list of options))</code></pre>
<p><strong>Example</strong>:</p>
<pre class="elisp"><code>(defcustom my-indentation-width 4
  "Number of spaces for indentation."
  :type 'integer
  :group 'my-mode
  :safe #'integerp)

(defcustom my-completion-backend 'company
  "Which completion backend to use."
  :type '(choice (const :tag "Company" company)
                 (const :tag "Auto-complete" auto-complete)
                 (const :tag "Built-in" completion-at-point))
  :group 'my-mode)</code></pre>
<h4 data-number="20.8.1.2" id="custom-groups"><span class="header-section-number">20.8.1.2</span> Custom Groups</h4>
<pre class="elisp"><code>(defgroup my-mode nil
  "Settings for my-mode."
  :group 'programming
  :prefix "my-")</code></pre>
<h4 data-number="20.8.1.3" id="initialization-functions"><span class="header-section-number">20.8.1.3</span> Initialization
Functions</h4>
<pre class="elisp"><code>(defun custom-initialize-default (symbol exp)
  "Initialize SYMBOL with EXP if it doesn't have a default binding."
  ...)

(defun custom-initialize-set (symbol exp)
  "Initialize SYMBOL using its :set function."
  ...)

(defun custom-initialize-reset (symbol exp)
  "Initialize SYMBOL, running :set function."
  ...)</code></pre>
<h4 data-number="20.8.1.4" id="type-specifications"><span class="header-section-number">20.8.1.4</span> Type Specifications</h4>
<p>The <code>:type</code> keyword accepts sophisticated type
descriptions:</p>
<pre class="elisp"><code>:type 'boolean                    ; t or nil
:type 'integer                    ; Any integer
:type 'string                     ; Any string
:type 'file                       ; File name
:type 'directory                  ; Directory name
:type '(repeat string)            ; List of strings
:type '(choice (const :tag "A" a)
               (const :tag "B" b)) ; One of several options
:type '(alist :key-type string
              :value-type integer) ; Association list</code></pre>
<h4 data-number="20.8.1.5" id="custom-setters"><span class="header-section-number">20.8.1.5</span> Custom Setters</h4>
<pre class="elisp"><code>(defcustom my-variable value
  "Documentation."
  :type 'type
  :set (lambda (symbol value)
         ;; Validate or transform value
         (set-default symbol value)
         ;; Trigger side effects
         (my-update-configuration)))</code></pre>
<hr/>
<h2 data-number="20.9" id="conclusion-6"><span class="header-section-number">20.9</span> Conclusion</h2>
<p>The Emacs Lisp standard library is a masterclass in API design:</p>
<ol type="1">
<li><strong>Progressive Enhancement</strong>: Simple things are simple,
complex things are possible</li>
<li><strong>Consistency</strong>: Common patterns (predicates ending in
<code>-p</code>, destructive functions ending in <code>!</code>)</li>
<li><strong>Discoverability</strong>: Self-documenting code with
excellent docstrings</li>
<li><strong>Extensibility</strong>: Hooks, generic functions, and
customization at every level</li>
</ol>
<p>These libraries are not just utility code - they embody decades of
refinement in creating a programmable text editor. Understanding them
deeply enables you to:</p>
<ul>
<li>Write idiomatic Elisp code</li>
<li>Leverage existing abstractions instead of reinventing</li>
<li>Extend Emacs in ways consistent with its design philosophy</li>
<li>Contribute to Emacs development</li>
</ul>
<p>The standard library is meant to be read, understood, and learned
from. Every function has a story, every abstraction solves real
problems, and the whole system fits together into something greater than
its parts.</p>
<hr/>
<h2 data-number="20.10" id="further-reading-5"><span class="header-section-number">20.10</span> Further Reading</h2>
<ul>
<li><strong>Emacs Lisp Reference Manual</strong>: The definitive
guide</li>
<li><strong>Source Code</strong>: Read <code>lisp/*.el</code> files
directly</li>
<li><strong><code>M-x apropos</code></strong>: Discover related
functions</li>
<li><strong><code>C-h f</code>, <code>C-h v</code></strong>: Learn by
exploring</li>
</ul>
<p><strong>Happy hacking!</strong></p>
<h1 data-number="21" id="text-processing-search-and-regular-expressions"><span class="header-section-number">21</span> Text Processing: Search and
Regular Expressions</h1>
<p><strong>Author:</strong> Emacs Documentation Team <strong>Last
Updated:</strong> 2025-11-18 <strong>Status:</strong> Complete
<strong>Related:</strong>
<code>02-core-subsystems/03-buffer-text.md</code>,
<code>03-elisp-runtime/02-core-types.md</code></p>
<hr/>
<h2 data-number="21.1" id="table-of-contents-9"><span class="header-section-number">21.1</span> Table of Contents</h2>
<ol type="1">
<li><a href="#overview">Overview</a></li>
<li><a href="#search-system-architecture">Search System
Architecture</a></li>
<li><a href="#regular-expression-engine">Regular Expression
Engine</a></li>
<li><a href="#syntax-tables">Syntax Tables</a></li>
<li><a href="#case-handling">Case Handling</a></li>
<li><a href="#elisp-layer">Elisp Layer</a></li>
<li><a href="#integration-and-data-flow">Integration and Data
Flow</a></li>
<li><a href="#performance-characteristics">Performance
Characteristics</a></li>
<li><a href="#api-reference">API Reference</a></li>
</ol>
<hr/>
<h2 data-number="21.2" id="overview-9"><span class="header-section-number">21.2</span> Overview</h2>
<p>Emacs provides a sophisticated text processing subsystem that
combines multiple components for efficient searching, pattern matching,
and text analysis. This document covers the core components:</p>
<h3 data-number="21.2.1" id="component-summary"><span class="header-section-number">21.2.1</span> Component Summary</h3>
<table style="width:100%;">
<colgroup>
<col style="width: 27%"/>
<col style="width: 32%"/>
<col style="width: 17%"/>
<col style="width: 22%"/>
</colgroup>
<thead>
<tr>
<th>Component</th>
<th>Source File</th>
<th>Lines</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td>Search System</td>
<td><code>src/search.c</code></td>
<td>3,514</td>
<td>String search algorithms and caching</td>
</tr>
<tr>
<td>Regex Engine</td>
<td><code>src/regex-emacs.c</code></td>
<td>5,355</td>
<td>Pattern compilation and matching</td>
</tr>
<tr>
<td>Syntax Tables</td>
<td><code>src/syntax.c</code></td>
<td>3,831</td>
<td>Character classification and parsing</td>
</tr>
<tr>
<td>Case Handling</td>
<td><code>src/casefiddle.c</code></td>
<td>764</td>
<td>Case conversion and folding</td>
</tr>
</tbody>
</table>
<h3 data-number="21.2.2" id="key-features-2"><span class="header-section-number">21.2.2</span> Key Features</h3>
<ul>
<li><strong>Multiple search algorithms</strong>: Simple scan,
Boyer-Moore, and regex-based</li>
<li><strong>Incremental search</strong>: Real-time feedback as you type
(<code>isearch.el</code>)</li>
<li><strong>Syntax-aware parsing</strong>: Language-specific character
classification</li>
<li><strong>Unicode support</strong>: Full multibyte character
handling</li>
<li><strong>Case folding</strong>: Intelligent case-insensitive
matching</li>
<li><strong>Character folding</strong>: Match Unicode variants
(<code>char-fold.el</code>)</li>
<li><strong>Regex caching</strong>: Pattern compilation
optimization</li>
<li><strong>POSIX compliance</strong>: Optional POSIX backtracking
mode</li>
</ul>
<hr/>
<h2 data-number="21.3" id="search-system-architecture"><span class="header-section-number">21.3</span> Search System
Architecture</h2>
<h3 data-number="21.3.1" id="file-srcsearch.c-3514-lines"><span class="header-section-number">21.3.1</span> File:
<code>src/search.c</code> (3,514 lines)</h3>
<p>The search system provides multiple algorithms optimized for
different use cases.</p>
<h3 data-number="21.3.2" id="search-algorithms"><span class="header-section-number">21.3.2</span> Search Algorithms</h3>
<h4 data-number="21.3.2.1" id="simple-search"><span class="header-section-number">21.3.2.1</span> 1. Simple Search</h4>
<p>Used when case folding or translation makes Boyer-Moore
impossible.</p>
<div class="sourceCode" id="cb815"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb815-1"><a aria-hidden="true" href="#cb815-1" tabindex="-1"></a><span class="dt">static</span> EMACS_INT</span>
<span id="cb815-2"><a aria-hidden="true" href="#cb815-2" tabindex="-1"></a>simple_search <span class="op">(</span>EMACS_INT n<span class="op">,</span> <span class="dt">unsigned</span> <span class="dt">char</span> <span class="op">*</span>pat<span class="op">,</span></span>
<span id="cb815-3"><a aria-hidden="true" href="#cb815-3" tabindex="-1"></a>               <span class="dt">ptrdiff_t</span> len<span class="op">,</span> <span class="dt">ptrdiff_t</span> len_byte<span class="op">,</span> Lisp_Object trt<span class="op">,</span></span>
<span id="cb815-4"><a aria-hidden="true" href="#cb815-4" tabindex="-1"></a>               <span class="dt">ptrdiff_t</span> pos<span class="op">,</span> <span class="dt">ptrdiff_t</span> pos_byte<span class="op">,</span></span>
<span id="cb815-5"><a aria-hidden="true" href="#cb815-5" tabindex="-1"></a>               <span class="dt">ptrdiff_t</span> lim<span class="op">,</span> <span class="dt">ptrdiff_t</span> lim_byte<span class="op">)</span></span>
<span id="cb815-6"><a aria-hidden="true" href="#cb815-6" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb815-7"><a aria-hidden="true" href="#cb815-7" tabindex="-1"></a>  <span class="co">// Naive string matching with character-by-character comparison</span></span>
<span id="cb815-8"><a aria-hidden="true" href="#cb815-8" tabindex="-1"></a>  <span class="co">// Supports multibyte characters and translation tables</span></span>
<span id="cb815-9"><a aria-hidden="true" href="#cb815-9" tabindex="-1"></a>  <span class="co">// Time complexity: O(nm) where n=text length, m=pattern length</span></span>
<span id="cb815-10"><a aria-hidden="true" href="#cb815-10" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>Characteristics:</strong> - Handles arbitrary character
translations - Works with multibyte characters - Fallback when
Boyer-Moore cannot be used - No preprocessing required</p>
<h4 data-number="21.3.2.2" id="boyer-moore-search"><span class="header-section-number">21.3.2.2</span> 2. Boyer-Moore Search</h4>
<p>Fast algorithm for literal string search without complex
translations.</p>
<div class="sourceCode" id="cb816"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb816-1"><a aria-hidden="true" href="#cb816-1" tabindex="-1"></a><span class="dt">static</span> EMACS_INT</span>
<span id="cb816-2"><a aria-hidden="true" href="#cb816-2" tabindex="-1"></a>boyer_moore <span class="op">(</span>EMACS_INT n<span class="op">,</span> <span class="dt">unsigned</span> <span class="dt">char</span> <span class="op">*</span>base_pat<span class="op">,</span></span>
<span id="cb816-3"><a aria-hidden="true" href="#cb816-3" tabindex="-1"></a>             <span class="dt">ptrdiff_t</span> len_byte<span class="op">,</span></span>
<span id="cb816-4"><a aria-hidden="true" href="#cb816-4" tabindex="-1"></a>             Lisp_Object trt<span class="op">,</span> Lisp_Object inverse_trt<span class="op">,</span></span>
<span id="cb816-5"><a aria-hidden="true" href="#cb816-5" tabindex="-1"></a>             <span class="dt">ptrdiff_t</span> pos_byte<span class="op">,</span> <span class="dt">ptrdiff_t</span> lim_byte<span class="op">,</span></span>
<span id="cb816-6"><a aria-hidden="true" href="#cb816-6" tabindex="-1"></a>             <span class="dt">int</span> char_base<span class="op">)</span></span>
<span id="cb816-7"><a aria-hidden="true" href="#cb816-7" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb816-8"><a aria-hidden="true" href="#cb816-8" tabindex="-1"></a>  <span class="co">// Build skip table (BM_tab) for pattern</span></span>
<span id="cb816-9"><a aria-hidden="true" href="#cb816-9" tabindex="-1"></a>  <span class="co">// Skip characters that don't match last character of pattern</span></span>
<span id="cb816-10"><a aria-hidden="true" href="#cb816-10" tabindex="-1"></a>  <span class="co">// Time complexity: O(n/m) best case, O(nm) worst case</span></span>
<span id="cb816-11"><a aria-hidden="true" href="#cb816-11" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>Algorithm Details:</strong></p>
<ol type="1">
<li><p><strong>Preprocessing Phase:</strong></p>
<div class="sourceCode" id="cb817"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb817-1"><a aria-hidden="true" href="#cb817-1" tabindex="-1"></a><span class="co">// Build skip table: for each possible byte value,</span></span>
<span id="cb817-2"><a aria-hidden="true" href="#cb817-2" tabindex="-1"></a><span class="co">// store distance to skip if that byte is seen</span></span>
<span id="cb817-3"><a aria-hidden="true" href="#cb817-3" tabindex="-1"></a><span class="cf">for</span> <span class="op">(</span>i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="bn">0400</span><span class="op">;</span> i<span class="op">++)</span></span>
<span id="cb817-4"><a aria-hidden="true" href="#cb817-4" tabindex="-1"></a>  BM_tab<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> dirlen<span class="op">;</span>  <span class="co">// Default: skip entire pattern length</span></span>
<span id="cb817-5"><a aria-hidden="true" href="#cb817-5" tabindex="-1"></a></span>
<span id="cb817-6"><a aria-hidden="true" href="#cb817-6" tabindex="-1"></a><span class="co">// For bytes in pattern, store distance from end</span></span>
<span id="cb817-7"><a aria-hidden="true" href="#cb817-7" tabindex="-1"></a><span class="cf">while</span> <span class="op">(</span>i <span class="op">!=</span> dirlen<span class="op">)</span> <span class="op">{</span></span>
<span id="cb817-8"><a aria-hidden="true" href="#cb817-8" tabindex="-1"></a>  <span class="dt">unsigned</span> <span class="dt">char</span> c <span class="op">=</span> base_pat<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb817-9"><a aria-hidden="true" href="#cb817-9" tabindex="-1"></a>  BM_tab<span class="op">[</span>c<span class="op">]</span> <span class="op">=</span> dirlen <span class="op">-</span> i <span class="op">-</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb817-10"><a aria-hidden="true" href="#cb817-10" tabindex="-1"></a>  i<span class="op">++;</span></span>
<span id="cb817-11"><a aria-hidden="true" href="#cb817-11" tabindex="-1"></a><span class="op">}</span></span></code></pre></div></li>
<li><p><strong>Search Phase:</strong></p>
<ul>
<li>Compare pattern from right to left</li>
<li>On mismatch, skip ahead using BM_tab</li>
<li>Can skip multiple characters per comparison</li>
</ul></li>
</ol>
<p><strong>When Boyer-Moore is Used:</strong></p>
<div class="sourceCode" id="cb818"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb818-1"><a aria-hidden="true" href="#cb818-1" tabindex="-1"></a><span class="dt">bool</span> boyer_moore_ok <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb818-2"><a aria-hidden="true" href="#cb818-2" tabindex="-1"></a></span>
<span id="cb818-3"><a aria-hidden="true" href="#cb818-3" tabindex="-1"></a><span class="co">// Disable if:</span></span>
<span id="cb818-4"><a aria-hidden="true" href="#cb818-4" tabindex="-1"></a><span class="co">// - Case folding changes character lengths</span></span>
<span id="cb818-5"><a aria-hidden="true" href="#cb818-5" tabindex="-1"></a><span class="co">// - Translation maps to multiple characters</span></span>
<span id="cb818-6"><a aria-hidden="true" href="#cb818-6" tabindex="-1"></a><span class="co">// - Non-ASCII chars with complex equivalences</span></span>
<span id="cb818-7"><a aria-hidden="true" href="#cb818-7" tabindex="-1"></a></span>
<span id="cb818-8"><a aria-hidden="true" href="#cb818-8" tabindex="-1"></a><span class="cf">if</span> <span class="op">(</span>c <span class="op">!=</span> inverse <span class="op">&amp;&amp;</span> boyer_moore_ok<span class="op">)</span> <span class="op">{</span></span>
<span id="cb818-9"><a aria-hidden="true" href="#cb818-9" tabindex="-1"></a>  <span class="co">// Check if translation preserves simple mapping</span></span>
<span id="cb818-10"><a aria-hidden="true" href="#cb818-10" tabindex="-1"></a>  boyer_moore_ok <span class="op">=</span> <span class="co">// complex condition...</span></span>
<span id="cb818-11"><a aria-hidden="true" href="#cb818-11" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h4 data-number="21.3.2.3" id="regular-expression-search"><span class="header-section-number">21.3.2.3</span> 3. Regular Expression
Search</h4>
<p>Uses the compiled regex engine (see next section).</p>
<div class="sourceCode" id="cb819"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb819-1"><a aria-hidden="true" href="#cb819-1" tabindex="-1"></a><span class="co">// From looking_at_1() and re_search_2()</span></span>
<span id="cb819-2"><a aria-hidden="true" href="#cb819-2" tabindex="-1"></a><span class="kw">struct</span> regexp_cache <span class="op">*</span>cache_entry <span class="op">=</span> compile_pattern<span class="op">(</span></span>
<span id="cb819-3"><a aria-hidden="true" href="#cb819-3" tabindex="-1"></a>  string<span class="op">,</span></span>
<span id="cb819-4"><a aria-hidden="true" href="#cb819-4" tabindex="-1"></a>  <span class="op">&amp;</span>search_regs<span class="op">,</span></span>
<span id="cb819-5"><a aria-hidden="true" href="#cb819-5" tabindex="-1"></a>  case_canon_table<span class="op">,</span>  <span class="co">// For case-insensitive matching</span></span>
<span id="cb819-6"><a aria-hidden="true" href="#cb819-6" tabindex="-1"></a>  posix<span class="op">,</span></span>
<span id="cb819-7"><a aria-hidden="true" href="#cb819-7" tabindex="-1"></a>  multibyte</span>
<span id="cb819-8"><a aria-hidden="true" href="#cb819-8" tabindex="-1"></a><span class="op">);</span></span>
<span id="cb819-9"><a aria-hidden="true" href="#cb819-9" tabindex="-1"></a></span>
<span id="cb819-10"><a aria-hidden="true" href="#cb819-10" tabindex="-1"></a>re_match_2_internal<span class="op">(...);</span></span></code></pre></div>
<h3 data-number="21.3.3" id="regex-pattern-cache"><span class="header-section-number">21.3.3</span> Regex Pattern Cache</h3>
<p>To avoid recompiling patterns, Emacs maintains a cache:</p>
<div class="sourceCode" id="cb820"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb820-1"><a aria-hidden="true" href="#cb820-1" tabindex="-1"></a><span class="pp">#define REGEXP_CACHE_SIZE </span><span class="dv">20</span></span>
<span id="cb820-2"><a aria-hidden="true" href="#cb820-2" tabindex="-1"></a></span>
<span id="cb820-3"><a aria-hidden="true" href="#cb820-3" tabindex="-1"></a><span class="kw">struct</span> regexp_cache <span class="op">{</span></span>
<span id="cb820-4"><a aria-hidden="true" href="#cb820-4" tabindex="-1"></a>  <span class="kw">struct</span> regexp_cache <span class="op">*</span>next<span class="op">;</span></span>
<span id="cb820-5"><a aria-hidden="true" href="#cb820-5" tabindex="-1"></a>  Lisp_Object regexp<span class="op">,</span> f_whitespace_regexp<span class="op">;</span></span>
<span id="cb820-6"><a aria-hidden="true" href="#cb820-6" tabindex="-1"></a>  Lisp_Object syntax_table<span class="op">;</span></span>
<span id="cb820-7"><a aria-hidden="true" href="#cb820-7" tabindex="-1"></a>  <span class="kw">struct</span> re_pattern_buffer buf<span class="op">;</span></span>
<span id="cb820-8"><a aria-hidden="true" href="#cb820-8" tabindex="-1"></a>  <span class="dt">char</span> fastmap<span class="op">[</span><span class="bn">0400</span><span class="op">];</span></span>
<span id="cb820-9"><a aria-hidden="true" href="#cb820-9" tabindex="-1"></a>  <span class="dt">bool</span> posix<span class="op">;</span></span>
<span id="cb820-10"><a aria-hidden="true" href="#cb820-10" tabindex="-1"></a>  <span class="dt">bool</span> busy<span class="op">;</span>  <span class="co">// Prevents recursive use</span></span>
<span id="cb820-11"><a aria-hidden="true" href="#cb820-11" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb820-12"><a aria-hidden="true" href="#cb820-12" tabindex="-1"></a></span>
<span id="cb820-13"><a aria-hidden="true" href="#cb820-13" tabindex="-1"></a><span class="dt">static</span> <span class="kw">struct</span> regexp_cache searchbufs<span class="op">[</span>REGEXP_CACHE_SIZE<span class="op">];</span></span>
<span id="cb820-14"><a aria-hidden="true" href="#cb820-14" tabindex="-1"></a><span class="dt">static</span> <span class="kw">struct</span> regexp_cache <span class="op">*</span>searchbuf_head<span class="op">;</span>  <span class="co">// LRU list</span></span></code></pre></div>
<p><strong>Cache Lookup Logic:</strong> 1. Check if pattern matches
cached entry 2. Verify syntax table compatibility 3. Check
whitespace-regexp equivalence 4. If match found, move to front (LRU) 5.
If not found, reuse least-recently-used non-busy entry</p>
<h3 data-number="21.3.4" id="search-functions-api"><span class="header-section-number">21.3.4</span> Search Functions API</h3>
<h4 data-number="21.3.4.1" id="core-search-functions"><span class="header-section-number">21.3.4.1</span> Core Search Functions</h4>
<div class="sourceCode" id="cb821"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb821-1"><a aria-hidden="true" href="#cb821-1" tabindex="-1"></a>DEFUN <span class="op">(</span><span class="st">"search-forward"</span><span class="op">,</span> Fsearch_forward<span class="op">,</span> Ssearch_forward<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">4</span><span class="op">,</span> <span class="op">...);</span></span>
<span id="cb821-2"><a aria-hidden="true" href="#cb821-2" tabindex="-1"></a>DEFUN <span class="op">(</span><span class="st">"search-backward"</span><span class="op">,</span> Fsearch_backward<span class="op">,</span> Ssearch_backward<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">4</span><span class="op">,</span> <span class="op">...);</span></span>
<span id="cb821-3"><a aria-hidden="true" href="#cb821-3" tabindex="-1"></a>DEFUN <span class="op">(</span><span class="st">"re-search-forward"</span><span class="op">,</span> Fre_search_forward<span class="op">,</span> Sre_search_forward<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">4</span><span class="op">,</span> <span class="op">...);</span></span>
<span id="cb821-4"><a aria-hidden="true" href="#cb821-4" tabindex="-1"></a>DEFUN <span class="op">(</span><span class="st">"re-search-backward"</span><span class="op">,</span> Fre_search_backward<span class="op">,</span> Sre_search_backward<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">4</span><span class="op">,</span> <span class="op">...);</span></span>
<span id="cb821-5"><a aria-hidden="true" href="#cb821-5" tabindex="-1"></a>DEFUN <span class="op">(</span><span class="st">"posix-search-forward"</span><span class="op">,</span> Fposix_search_forward<span class="op">,</span> <span class="op">...);</span></span>
<span id="cb821-6"><a aria-hidden="true" href="#cb821-6" tabindex="-1"></a>DEFUN <span class="op">(</span><span class="st">"posix-search-backward"</span><span class="op">,</span> Fposix_search_backward<span class="op">,</span> <span class="op">...);</span></span></code></pre></div>
<p><strong>Common Parameters:</strong> - <code>string</code>: Pattern to
search for - <code>bound</code>: Limit of search (nil = end of buffer) -
<code>noerror</code>: If non-nil, return nil instead of error when not
found - <code>count</code>: Repeat search N times (negative =
backward)</p>
<hr/>
<h2 data-number="21.4" id="regular-expression-engine"><span class="header-section-number">21.4</span> Regular Expression Engine</h2>
<h3 data-number="21.4.1" id="file-srcregex-emacs.c-5355-lines"><span class="header-section-number">21.4.1</span> File:
<code>src/regex-emacs.c</code> (5,355 lines)</h3>
<p>Emacs uses a custom regex engine optimized for editor use cases.</p>
<h3 data-number="21.4.2" id="regex-opcodes"><span class="header-section-number">21.4.2</span> Regex Opcodes</h3>
<p>The engine compiles patterns into a bytecode format with these
opcodes:</p>
<div class="sourceCode" id="cb822"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb822-1"><a aria-hidden="true" href="#cb822-1" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">enum</span> <span class="op">{</span></span>
<span id="cb822-2"><a aria-hidden="true" href="#cb822-2" tabindex="-1"></a>  no_op <span class="op">=</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb822-3"><a aria-hidden="true" href="#cb822-3" tabindex="-1"></a>  succeed<span class="op">,</span>           <span class="co">// Immediate success, no backtracking</span></span>
<span id="cb822-4"><a aria-hidden="true" href="#cb822-4" tabindex="-1"></a></span>
<span id="cb822-5"><a aria-hidden="true" href="#cb822-5" tabindex="-1"></a>  <span class="co">// Literal matching</span></span>
<span id="cb822-6"><a aria-hidden="true" href="#cb822-6" tabindex="-1"></a>  exactn<span class="op">,</span>            <span class="co">// Match N literal bytes</span></span>
<span id="cb822-7"><a aria-hidden="true" href="#cb822-7" tabindex="-1"></a>  anychar<span class="op">,</span>           <span class="co">// Match any character (.)</span></span>
<span id="cb822-8"><a aria-hidden="true" href="#cb822-8" tabindex="-1"></a></span>
<span id="cb822-9"><a aria-hidden="true" href="#cb822-9" tabindex="-1"></a>  <span class="co">// Character sets</span></span>
<span id="cb822-10"><a aria-hidden="true" href="#cb822-10" tabindex="-1"></a>  charset<span class="op">,</span>           <span class="co">// Match one of specified characters [...]</span></span>
<span id="cb822-11"><a aria-hidden="true" href="#cb822-11" tabindex="-1"></a>  charset_not<span class="op">,</span>       <span class="co">// Match anything except [^...]</span></span>
<span id="cb822-12"><a aria-hidden="true" href="#cb822-12" tabindex="-1"></a></span>
<span id="cb822-13"><a aria-hidden="true" href="#cb822-13" tabindex="-1"></a>  <span class="co">// Grouping and backreferences</span></span>
<span id="cb822-14"><a aria-hidden="true" href="#cb822-14" tabindex="-1"></a>  start_memory<span class="op">,</span>      <span class="co">// Begin capture group \(...\)</span></span>
<span id="cb822-15"><a aria-hidden="true" href="#cb822-15" tabindex="-1"></a>  stop_memory<span class="op">,</span>       <span class="co">// End capture group</span></span>
<span id="cb822-16"><a aria-hidden="true" href="#cb822-16" tabindex="-1"></a>  duplicate<span class="op">,</span>         <span class="co">// Match previous group \N</span></span>
<span id="cb822-17"><a aria-hidden="true" href="#cb822-17" tabindex="-1"></a></span>
<span id="cb822-18"><a aria-hidden="true" href="#cb822-18" tabindex="-1"></a>  <span class="co">// Anchors</span></span>
<span id="cb822-19"><a aria-hidden="true" href="#cb822-19" tabindex="-1"></a>  begline<span class="op">,</span>           <span class="co">// ^ (beginning of line)</span></span>
<span id="cb822-20"><a aria-hidden="true" href="#cb822-20" tabindex="-1"></a>  endline<span class="op">,</span>           <span class="co">// $ (end of line)</span></span>
<span id="cb822-21"><a aria-hidden="true" href="#cb822-21" tabindex="-1"></a>  begbuf<span class="op">,</span>            <span class="co">// \` (beginning of buffer)</span></span>
<span id="cb822-22"><a aria-hidden="true" href="#cb822-22" tabindex="-1"></a>  endbuf<span class="op">,</span>            <span class="co">// \' (end of buffer)</span></span>
<span id="cb822-23"><a aria-hidden="true" href="#cb822-23" tabindex="-1"></a></span>
<span id="cb822-24"><a aria-hidden="true" href="#cb822-24" tabindex="-1"></a>  <span class="co">// Control flow</span></span>
<span id="cb822-25"><a aria-hidden="true" href="#cb822-25" tabindex="-1"></a>  jump<span class="op">,</span>              <span class="co">// Unconditional jump</span></span>
<span id="cb822-26"><a aria-hidden="true" href="#cb822-26" tabindex="-1"></a>  on_failure_jump<span class="op">,</span>   <span class="co">// Backtracking point</span></span>
<span id="cb822-27"><a aria-hidden="true" href="#cb822-27" tabindex="-1"></a>  on_failure_keep_string_jump<span class="op">,</span>  <span class="co">// Loop optimization</span></span>
<span id="cb822-28"><a aria-hidden="true" href="#cb822-28" tabindex="-1"></a>  on_failure_jump_loop<span class="op">,</span>         <span class="co">// Infinite loop detection</span></span>
<span id="cb822-29"><a aria-hidden="true" href="#cb822-29" tabindex="-1"></a>  on_failure_jump_smart<span class="op">,</span>        <span class="co">// Greedy * and + optimization</span></span>
<span id="cb822-30"><a aria-hidden="true" href="#cb822-30" tabindex="-1"></a></span>
<span id="cb822-31"><a aria-hidden="true" href="#cb822-31" tabindex="-1"></a>  <span class="co">// Repetition</span></span>
<span id="cb822-32"><a aria-hidden="true" href="#cb822-32" tabindex="-1"></a>  succeed_n<span class="op">,</span>         <span class="co">// Jump after N matches</span></span>
<span id="cb822-33"><a aria-hidden="true" href="#cb822-33" tabindex="-1"></a>  jump_n<span class="op">,</span>            <span class="co">// Bounded repetition</span></span>
<span id="cb822-34"><a aria-hidden="true" href="#cb822-34" tabindex="-1"></a>  set_number_at<span class="op">,</span>     <span class="co">// Dynamic counter update</span></span>
<span id="cb822-35"><a aria-hidden="true" href="#cb822-35" tabindex="-1"></a></span>
<span id="cb822-36"><a aria-hidden="true" href="#cb822-36" tabindex="-1"></a>  <span class="co">// Word boundaries</span></span>
<span id="cb822-37"><a aria-hidden="true" href="#cb822-37" tabindex="-1"></a>  wordbeg<span class="op">,</span>           <span class="co">// \&lt; (beginning of word)</span></span>
<span id="cb822-38"><a aria-hidden="true" href="#cb822-38" tabindex="-1"></a>  wordend<span class="op">,</span>           <span class="co">// \&gt; (end of word)</span></span>
<span id="cb822-39"><a aria-hidden="true" href="#cb822-39" tabindex="-1"></a>  wordbound<span class="op">,</span>         <span class="co">// \b (word boundary)</span></span>
<span id="cb822-40"><a aria-hidden="true" href="#cb822-40" tabindex="-1"></a>  notwordbound<span class="op">,</span>      <span class="co">// \B (not word boundary)</span></span>
<span id="cb822-41"><a aria-hidden="true" href="#cb822-41" tabindex="-1"></a></span>
<span id="cb822-42"><a aria-hidden="true" href="#cb822-42" tabindex="-1"></a>  <span class="co">// Symbol boundaries (Emacs extension)</span></span>
<span id="cb822-43"><a aria-hidden="true" href="#cb822-43" tabindex="-1"></a>  symbeg<span class="op">,</span>            <span class="co">// \_&lt; (beginning of symbol)</span></span>
<span id="cb822-44"><a aria-hidden="true" href="#cb822-44" tabindex="-1"></a>  symend<span class="op">,</span>            <span class="co">// \_&gt; (end of symbol)</span></span>
<span id="cb822-45"><a aria-hidden="true" href="#cb822-45" tabindex="-1"></a></span>
<span id="cb822-46"><a aria-hidden="true" href="#cb822-46" tabindex="-1"></a>  <span class="co">// Syntax-based matching</span></span>
<span id="cb822-47"><a aria-hidden="true" href="#cb822-47" tabindex="-1"></a>  syntaxspec<span class="op">,</span>        <span class="co">// \s followed by syntax code</span></span>
<span id="cb822-48"><a aria-hidden="true" href="#cb822-48" tabindex="-1"></a>  notsyntaxspec<span class="op">,</span>     <span class="co">// \S followed by syntax code</span></span>
<span id="cb822-49"><a aria-hidden="true" href="#cb822-49" tabindex="-1"></a></span>
<span id="cb822-50"><a aria-hidden="true" href="#cb822-50" tabindex="-1"></a>  <span class="co">// Category matching</span></span>
<span id="cb822-51"><a aria-hidden="true" href="#cb822-51" tabindex="-1"></a>  categoryspec<span class="op">,</span>      <span class="co">// Match character category</span></span>
<span id="cb822-52"><a aria-hidden="true" href="#cb822-52" tabindex="-1"></a>  notcategoryspec<span class="op">,</span>   <span class="co">// Match not in category</span></span>
<span id="cb822-53"><a aria-hidden="true" href="#cb822-53" tabindex="-1"></a></span>
<span id="cb822-54"><a aria-hidden="true" href="#cb822-54" tabindex="-1"></a>  at_dot             <span class="co">// Match at point</span></span>
<span id="cb822-55"><a aria-hidden="true" href="#cb822-55" tabindex="-1"></a><span class="op">}</span> re_opcode_t<span class="op">;</span></span></code></pre></div>
<h3 data-number="21.4.3" id="pattern-compilation"><span class="header-section-number">21.4.3</span> Pattern Compilation</h3>
<div class="sourceCode" id="cb823"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb823-1"><a aria-hidden="true" href="#cb823-1" tabindex="-1"></a><span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span></span>
<span id="cb823-2"><a aria-hidden="true" href="#cb823-2" tabindex="-1"></a>re_compile_pattern <span class="op">(</span><span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>pattern<span class="op">,</span> <span class="dt">ptrdiff_t</span> length<span class="op">,</span></span>
<span id="cb823-3"><a aria-hidden="true" href="#cb823-3" tabindex="-1"></a>                    <span class="dt">bool</span> posix_backtracking<span class="op">,</span></span>
<span id="cb823-4"><a aria-hidden="true" href="#cb823-4" tabindex="-1"></a>                    <span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>whitespace_regexp<span class="op">,</span></span>
<span id="cb823-5"><a aria-hidden="true" href="#cb823-5" tabindex="-1"></a>                    <span class="kw">struct</span> re_pattern_buffer <span class="op">*</span>bufp<span class="op">)</span></span>
<span id="cb823-6"><a aria-hidden="true" href="#cb823-6" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb823-7"><a aria-hidden="true" href="#cb823-7" tabindex="-1"></a>  <span class="co">// Parse pattern and generate opcodes</span></span>
<span id="cb823-8"><a aria-hidden="true" href="#cb823-8" tabindex="-1"></a>  <span class="co">// Build fastmap for quick pre-scanning</span></span>
<span id="cb823-9"><a aria-hidden="true" href="#cb823-9" tabindex="-1"></a>  <span class="co">// Handle character classes, ranges, etc.</span></span>
<span id="cb823-10"><a aria-hidden="true" href="#cb823-10" tabindex="-1"></a>  <span class="co">// Return NULL on success, error string on failure</span></span>
<span id="cb823-11"><a aria-hidden="true" href="#cb823-11" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>Compilation Steps:</strong></p>
<ol type="1">
<li><p><strong>Lexical Analysis</strong>: Parse pattern into tokens</p>
<ul>
<li>Literal characters</li>
<li>Special characters (*, +, ?, |, etc.)</li>
<li>Escape sequences (<code>\n</code>, <code>\t</code>, <code>\d</code>,
etc.)</li>
<li>Character classes ([a-z], [^0-9])</li>
<li>Groups <code>\(...\)</code></li>
</ul></li>
<li><p><strong>Syntax Validation</strong>: Check for errors</p>
<ul>
<li>Unmatched brackets</li>
<li>Invalid escape sequences</li>
<li>Invalid repetition operators</li>
</ul></li>
<li><p><strong>Code Generation</strong>: Emit opcodes</p>
<ul>
<li>Convert to internal bytecode</li>
<li>Optimize common patterns</li>
<li>Insert backtracking points</li>
</ul></li>
<li><p><strong>Fastmap Construction</strong>: Build quick-reject
table</p>
<div class="sourceCode" id="cb824"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb824-1"><a aria-hidden="true" href="#cb824-1" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> re_compile_fastmap <span class="op">(</span><span class="kw">struct</span> re_pattern_buffer <span class="op">*</span>bufp<span class="op">)</span></span>
<span id="cb824-2"><a aria-hidden="true" href="#cb824-2" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb824-3"><a aria-hidden="true" href="#cb824-3" tabindex="-1"></a>  <span class="co">// For each possible starting character,</span></span>
<span id="cb824-4"><a aria-hidden="true" href="#cb824-4" tabindex="-1"></a>  <span class="co">// mark if pattern could match starting with it</span></span>
<span id="cb824-5"><a aria-hidden="true" href="#cb824-5" tabindex="-1"></a>  <span class="dt">char</span> <span class="op">*</span>fastmap <span class="op">=</span> bufp<span class="op">-&gt;</span>fastmap<span class="op">;</span></span>
<span id="cb824-6"><a aria-hidden="true" href="#cb824-6" tabindex="-1"></a>  <span class="co">// ... analyze compiled pattern ...</span></span>
<span id="cb824-7"><a aria-hidden="true" href="#cb824-7" tabindex="-1"></a><span class="op">}</span></span></code></pre></div></li>
</ol>
<h3 data-number="21.4.4" id="pattern-matching-1"><span class="header-section-number">21.4.4</span> Pattern Matching</h3>
<div class="sourceCode" id="cb825"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb825-1"><a aria-hidden="true" href="#cb825-1" tabindex="-1"></a><span class="dt">static</span> <span class="dt">ptrdiff_t</span></span>
<span id="cb825-2"><a aria-hidden="true" href="#cb825-2" tabindex="-1"></a>re_match_2_internal <span class="op">(</span><span class="kw">struct</span> re_pattern_buffer <span class="op">*</span>bufp<span class="op">,</span></span>
<span id="cb825-3"><a aria-hidden="true" href="#cb825-3" tabindex="-1"></a>                     re_char <span class="op">*</span>string1<span class="op">,</span> <span class="dt">ptrdiff_t</span> size1<span class="op">,</span></span>
<span id="cb825-4"><a aria-hidden="true" href="#cb825-4" tabindex="-1"></a>                     re_char <span class="op">*</span>string2<span class="op">,</span> <span class="dt">ptrdiff_t</span> size2<span class="op">,</span></span>
<span id="cb825-5"><a aria-hidden="true" href="#cb825-5" tabindex="-1"></a>                     <span class="dt">ptrdiff_t</span> pos<span class="op">,</span></span>
<span id="cb825-6"><a aria-hidden="true" href="#cb825-6" tabindex="-1"></a>                     <span class="kw">struct</span> re_registers <span class="op">*</span>regs<span class="op">,</span></span>
<span id="cb825-7"><a aria-hidden="true" href="#cb825-7" tabindex="-1"></a>                     <span class="dt">ptrdiff_t</span> stop<span class="op">)</span></span>
<span id="cb825-8"><a aria-hidden="true" href="#cb825-8" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb825-9"><a aria-hidden="true" href="#cb825-9" tabindex="-1"></a>  <span class="co">// Main matching engine using backtracking</span></span>
<span id="cb825-10"><a aria-hidden="true" href="#cb825-10" tabindex="-1"></a>  <span class="co">// Handles split strings (gap buffer support)</span></span>
<span id="cb825-11"><a aria-hidden="true" href="#cb825-11" tabindex="-1"></a>  <span class="co">// Records match positions in regs</span></span>
<span id="cb825-12"><a aria-hidden="true" href="#cb825-12" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>Matching Algorithm:</strong></p>
<ol type="1">
<li><p><strong>Fastmap Pre-check</strong>:</p>
<div class="sourceCode" id="cb826"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb826-1"><a aria-hidden="true" href="#cb826-1" tabindex="-1"></a><span class="cf">if</span> <span class="op">(</span>fastmap <span class="op">&amp;&amp;</span> startpos <span class="op">&lt;</span> total_size <span class="op">&amp;&amp;</span> <span class="op">!</span>bufp<span class="op">-&gt;</span>can_be_null<span class="op">)</span> <span class="op">{</span></span>
<span id="cb826-2"><a aria-hidden="true" href="#cb826-2" tabindex="-1"></a>  <span class="co">// Quick reject: scan for valid starting characters</span></span>
<span id="cb826-3"><a aria-hidden="true" href="#cb826-3" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(!</span>fastmap<span class="op">[</span>RE_STRING_CHAR<span class="op">(</span>string<span class="op">,</span> startpos<span class="op">)])</span></span>
<span id="cb826-4"><a aria-hidden="true" href="#cb826-4" tabindex="-1"></a>    <span class="cf">continue</span><span class="op">;</span>  <span class="co">// Skip to next position</span></span>
<span id="cb826-5"><a aria-hidden="true" href="#cb826-5" tabindex="-1"></a><span class="op">}</span></span></code></pre></div></li>
<li><p><strong>Bytecode Interpretation</strong>:</p>
<ul>
<li>Execute opcodes sequentially</li>
<li>Push/pop failure points for backtracking</li>
<li>Record capture group positions</li>
</ul></li>
<li><p><strong>Backtracking</strong>:</p>
<ul>
<li>On failure, pop last failure point</li>
<li>Restore position and state</li>
<li>Try alternative paths</li>
</ul></li>
</ol>
<h3 data-number="21.4.5" id="regex-pattern-buffer"><span class="header-section-number">21.4.5</span> Regex Pattern Buffer</h3>
<div class="sourceCode" id="cb827"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb827-1"><a aria-hidden="true" href="#cb827-1" tabindex="-1"></a><span class="kw">struct</span> re_pattern_buffer <span class="op">{</span></span>
<span id="cb827-2"><a aria-hidden="true" href="#cb827-2" tabindex="-1"></a>  <span class="dt">unsigned</span> <span class="dt">char</span> <span class="op">*</span>buffer<span class="op">;</span>      <span class="co">// Compiled opcodes</span></span>
<span id="cb827-3"><a aria-hidden="true" href="#cb827-3" tabindex="-1"></a>  <span class="dt">ptrdiff_t</span> allocated<span class="op">;</span>        <span class="co">// Buffer size</span></span>
<span id="cb827-4"><a aria-hidden="true" href="#cb827-4" tabindex="-1"></a>  <span class="dt">ptrdiff_t</span> used<span class="op">;</span>            <span class="co">// Bytes used</span></span>
<span id="cb827-5"><a aria-hidden="true" href="#cb827-5" tabindex="-1"></a></span>
<span id="cb827-6"><a aria-hidden="true" href="#cb827-6" tabindex="-1"></a>  <span class="dt">int</span> charset_unibyte<span class="op">;</span>       <span class="co">// Charset at compile time</span></span>
<span id="cb827-7"><a aria-hidden="true" href="#cb827-7" tabindex="-1"></a>  <span class="dt">char</span> <span class="op">*</span>fastmap<span class="op">;</span>             <span class="co">// Quick-reject table</span></span>
<span id="cb827-8"><a aria-hidden="true" href="#cb827-8" tabindex="-1"></a></span>
<span id="cb827-9"><a aria-hidden="true" href="#cb827-9" tabindex="-1"></a>  Lisp_Object translate<span class="op">;</span>     <span class="co">// Case folding table</span></span>
<span id="cb827-10"><a aria-hidden="true" href="#cb827-10" tabindex="-1"></a></span>
<span id="cb827-11"><a aria-hidden="true" href="#cb827-11" tabindex="-1"></a>  <span class="co">// Flags</span></span>
<span id="cb827-12"><a aria-hidden="true" href="#cb827-12" tabindex="-1"></a>  <span class="dt">bool</span> fastmap_accurate<span class="op">;</span></span>
<span id="cb827-13"><a aria-hidden="true" href="#cb827-13" tabindex="-1"></a>  <span class="dt">bool</span> can_be_null<span class="op">;</span>          <span class="co">// Can match empty string</span></span>
<span id="cb827-14"><a aria-hidden="true" href="#cb827-14" tabindex="-1"></a>  <span class="dt">bool</span> not_bol<span class="op">;</span>              <span class="co">// Not at beginning of line</span></span>
<span id="cb827-15"><a aria-hidden="true" href="#cb827-15" tabindex="-1"></a>  <span class="dt">bool</span> not_eol<span class="op">;</span>              <span class="co">// Not at end of line</span></span>
<span id="cb827-16"><a aria-hidden="true" href="#cb827-16" tabindex="-1"></a>  <span class="dt">bool</span> used_syntax<span class="op">;</span>          <span class="co">// Uses syntax table</span></span>
<span id="cb827-17"><a aria-hidden="true" href="#cb827-17" tabindex="-1"></a>  <span class="dt">bool</span> multibyte<span class="op">;</span>            <span class="co">// Pattern is multibyte</span></span>
<span id="cb827-18"><a aria-hidden="true" href="#cb827-18" tabindex="-1"></a>  <span class="dt">bool</span> target_multibyte<span class="op">;</span>     <span class="co">// Target is multibyte</span></span>
<span id="cb827-19"><a aria-hidden="true" href="#cb827-19" tabindex="-1"></a></span>
<span id="cb827-20"><a aria-hidden="true" href="#cb827-20" tabindex="-1"></a>  <span class="co">// Match data</span></span>
<span id="cb827-21"><a aria-hidden="true" href="#cb827-21" tabindex="-1"></a>  <span class="dt">size_t</span> re_nsub<span class="op">;</span>            <span class="co">// Number of subexpressions</span></span>
<span id="cb827-22"><a aria-hidden="true" href="#cb827-22" tabindex="-1"></a></span>
<span id="cb827-23"><a aria-hidden="true" href="#cb827-23" tabindex="-1"></a>  <span class="co">// Registers for match positions</span></span>
<span id="cb827-24"><a aria-hidden="true" href="#cb827-24" tabindex="-1"></a>  <span class="co">// (managed externally in struct re_registers)</span></span>
<span id="cb827-25"><a aria-hidden="true" href="#cb827-25" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<h3 data-number="21.4.6" id="emacs-specific-extensions"><span class="header-section-number">21.4.6</span> Emacs-Specific
Extensions</h3>
<p><strong>1. Syntax Classes</strong> (<code>\s</code> and
<code>\S</code>):</p>
<pre><code>\sw  - Word constituent
\s_  - Symbol constituent
\s.  - Punctuation
\s(  - Open parenthesis
\s)  - Close parenthesis
\s"  - String quote
\s'  - Expression prefix
\s&lt;  - Comment start
\s&gt;  - Comment end
\s!  - Generic comment delimiter
\s|  - Generic string delimiter</code></pre>
<p><strong>2. Symbol Boundaries</strong> (<code>\_&lt;</code> and
<code>\_&gt;</code>): - Like word boundaries but for symbols - Respects
<code>symbol</code> syntax class</p>
<p><strong>3. Category Matching</strong> (<code>\c</code> and
<code>\C</code>): - Unicode character categories - Used for i18n and
script detection</p>
<p><strong>4. Position Matching</strong>:</p>
<pre><code>\`   - Beginning of buffer (not line)
\'   - End of buffer (not line)
\=   - At point (current cursor position)</code></pre>
<h3 data-number="21.4.7" id="posix-vs.-emacs-backtracking"><span class="header-section-number">21.4.7</span> POSIX vs.¬†Emacs
Backtracking</h3>
<p><strong>Emacs Mode (default)</strong>: - Stops at first match -
Faster for typical editor use - Non-greedy by default</p>
<p><strong>POSIX Mode</strong> (<code>posix-search-forward</code>): -
Finds longest possible match - Required for POSIX compliance - Slower
due to exhaustive search</p>
<div class="sourceCode" id="cb830"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb830-1"><a aria-hidden="true" href="#cb830-1" tabindex="-1"></a><span class="co">// In re_match_2_internal:</span></span>
<span id="cb830-2"><a aria-hidden="true" href="#cb830-2" tabindex="-1"></a><span class="cf">if</span> <span class="op">(</span>posix_backtracking<span class="op">)</span> <span class="op">{</span></span>
<span id="cb830-3"><a aria-hidden="true" href="#cb830-3" tabindex="-1"></a>  <span class="co">// Try all alternatives, keep longest</span></span>
<span id="cb830-4"><a aria-hidden="true" href="#cb830-4" tabindex="-1"></a><span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb830-5"><a aria-hidden="true" href="#cb830-5" tabindex="-1"></a>  <span class="co">// Stop at first match</span></span>
<span id="cb830-6"><a aria-hidden="true" href="#cb830-6" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 data-number="21.4.8" id="performance-optimizations-2"><span class="header-section-number">21.4.8</span> Performance
Optimizations</h3>
<p><strong>1. Smart Greedy Matching</strong>
(<code>on_failure_jump_smart</code>):</p>
<div class="sourceCode" id="cb831"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb831-1"><a aria-hidden="true" href="#cb831-1" tabindex="-1"></a><span class="co">// For patterns like a*b or a+b</span></span>
<span id="cb831-2"><a aria-hidden="true" href="#cb831-2" tabindex="-1"></a><span class="co">// Analyze loop to avoid unnecessary backtracking</span></span>
<span id="cb831-3"><a aria-hidden="true" href="#cb831-3" tabindex="-1"></a><span class="co">// If loop doesn't require backtracking, short-circuit it</span></span></code></pre></div>
<p><strong>2. String-Keeping Loops</strong>
(<code>on_failure_keep_string_jump</code>):</p>
<div class="sourceCode" id="cb832"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb832-1"><a aria-hidden="true" href="#cb832-1" tabindex="-1"></a><span class="co">// For simple loops that don't need position restoration</span></span>
<span id="cb832-2"><a aria-hidden="true" href="#cb832-2" tabindex="-1"></a><span class="co">// Saves stack space and time</span></span></code></pre></div>
<p><strong>3. Duplicate Detection</strong>:</p>
<div class="sourceCode" id="cb833"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb833-1"><a aria-hidden="true" href="#cb833-1" tabindex="-1"></a><span class="co">// Prevent infinite loops in patterns like (a*)*</span></span>
<span id="cb833-2"><a aria-hidden="true" href="#cb833-2" tabindex="-1"></a><span class="co">// Track visited states</span></span></code></pre></div>
<hr/>
<h2 data-number="21.5" id="syntax-tables"><span class="header-section-number">21.5</span> Syntax Tables</h2>
<h3 data-number="21.5.1" id="file-srcsyntax.c-3831-lines"><span class="header-section-number">21.5.1</span> File:
<code>src/syntax.c</code> (3,831 lines)</h3>
<p>Syntax tables classify characters for parsing and navigation.</p>
<h3 data-number="21.5.2" id="syntax-classes"><span class="header-section-number">21.5.2</span> Syntax Classes</h3>
<div class="sourceCode" id="cb834"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb834-1"><a aria-hidden="true" href="#cb834-1" tabindex="-1"></a><span class="kw">enum</span> syntaxcode <span class="op">{</span></span>
<span id="cb834-2"><a aria-hidden="true" href="#cb834-2" tabindex="-1"></a>  Swhitespace<span class="op">,</span>    <span class="co">// ' ' - whitespace characters</span></span>
<span id="cb834-3"><a aria-hidden="true" href="#cb834-3" tabindex="-1"></a>  Spunct<span class="op">,</span>         <span class="co">// '.' - punctuation</span></span>
<span id="cb834-4"><a aria-hidden="true" href="#cb834-4" tabindex="-1"></a>  Sword<span class="op">,</span>          <span class="co">// 'w' - word constituents</span></span>
<span id="cb834-5"><a aria-hidden="true" href="#cb834-5" tabindex="-1"></a>  Ssymbol<span class="op">,</span>        <span class="co">// '_' - symbol constituents (not word)</span></span>
<span id="cb834-6"><a aria-hidden="true" href="#cb834-6" tabindex="-1"></a>  Sopen<span class="op">,</span>          <span class="co">// '(' - open delimiter</span></span>
<span id="cb834-7"><a aria-hidden="true" href="#cb834-7" tabindex="-1"></a>  Sclose<span class="op">,</span>         <span class="co">// ')' - close delimiter</span></span>
<span id="cb834-8"><a aria-hidden="true" href="#cb834-8" tabindex="-1"></a>  Squote<span class="op">,</span>         <span class="co">// '\'' - prefix character (Lisp quote)</span></span>
<span id="cb834-9"><a aria-hidden="true" href="#cb834-9" tabindex="-1"></a>  Sstring<span class="op">,</span>        <span class="co">// '"' - string delimiter</span></span>
<span id="cb834-10"><a aria-hidden="true" href="#cb834-10" tabindex="-1"></a>  Smath<span class="op">,</span>          <span class="co">// '$' - paired delimiter (TeX)</span></span>
<span id="cb834-11"><a aria-hidden="true" href="#cb834-11" tabindex="-1"></a>  Sescape<span class="op">,</span>        <span class="co">// '\\' - escape character</span></span>
<span id="cb834-12"><a aria-hidden="true" href="#cb834-12" tabindex="-1"></a>  Scharquote<span class="op">,</span>     <span class="co">// '/' - character quote</span></span>
<span id="cb834-13"><a aria-hidden="true" href="#cb834-13" tabindex="-1"></a>  Scomment<span class="op">,</span>       <span class="co">// '&lt;' - comment starter</span></span>
<span id="cb834-14"><a aria-hidden="true" href="#cb834-14" tabindex="-1"></a>  Sendcomment<span class="op">,</span>    <span class="co">// '&gt;' - comment ender</span></span>
<span id="cb834-15"><a aria-hidden="true" href="#cb834-15" tabindex="-1"></a>  Sinherit<span class="op">,</span>       <span class="co">// '@' - inherit from standard table</span></span>
<span id="cb834-16"><a aria-hidden="true" href="#cb834-16" tabindex="-1"></a>  Scomment_fence<span class="op">,</span> <span class="co">// '!' - generic comment delimiter</span></span>
<span id="cb834-17"><a aria-hidden="true" href="#cb834-17" tabindex="-1"></a>  Sstring_fence<span class="op">,</span>  <span class="co">// '|' - generic string delimiter</span></span>
<span id="cb834-18"><a aria-hidden="true" href="#cb834-18" tabindex="-1"></a>  Smax            <span class="co">// Sentinel value</span></span>
<span id="cb834-19"><a aria-hidden="true" href="#cb834-19" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<h3 data-number="21.5.3" id="syntax-flags"><span class="header-section-number">21.5.3</span> Syntax Flags</h3>
<p>Eight single-bit flags provide additional information:</p>
<div class="sourceCode" id="cb835"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb835-1"><a aria-hidden="true" href="#cb835-1" tabindex="-1"></a><span class="co">// Extract flags from syntax descriptor</span></span>
<span id="cb835-2"><a aria-hidden="true" href="#cb835-2" tabindex="-1"></a><span class="dt">static</span> <span class="dt">bool</span> SYNTAX_FLAGS_COMSTART_FIRST<span class="op">(</span><span class="dt">int</span> flags<span class="op">);</span>   <span class="co">// First char of comment start</span></span>
<span id="cb835-3"><a aria-hidden="true" href="#cb835-3" tabindex="-1"></a><span class="dt">static</span> <span class="dt">bool</span> SYNTAX_FLAGS_COMSTART_SECOND<span class="op">(</span><span class="dt">int</span> flags<span class="op">);</span>  <span class="co">// Second char of comment start</span></span>
<span id="cb835-4"><a aria-hidden="true" href="#cb835-4" tabindex="-1"></a><span class="dt">static</span> <span class="dt">bool</span> SYNTAX_FLAGS_COMEND_FIRST<span class="op">(</span><span class="dt">int</span> flags<span class="op">);</span>     <span class="co">// First char of comment end</span></span>
<span id="cb835-5"><a aria-hidden="true" href="#cb835-5" tabindex="-1"></a><span class="dt">static</span> <span class="dt">bool</span> SYNTAX_FLAGS_COMEND_SECOND<span class="op">(</span><span class="dt">int</span> flags<span class="op">);</span>    <span class="co">// Second char of comment end</span></span>
<span id="cb835-6"><a aria-hidden="true" href="#cb835-6" tabindex="-1"></a><span class="dt">static</span> <span class="dt">bool</span> SYNTAX_FLAGS_PREFIX<span class="op">(</span><span class="dt">int</span> flags<span class="op">);</span>           <span class="co">// Is prefix character</span></span>
<span id="cb835-7"><a aria-hidden="true" href="#cb835-7" tabindex="-1"></a><span class="dt">static</span> <span class="dt">bool</span> SYNTAX_FLAGS_COMMENT_STYLEB<span class="op">(</span><span class="dt">int</span> flags<span class="op">);</span>   <span class="co">// Style b comment</span></span>
<span id="cb835-8"><a aria-hidden="true" href="#cb835-8" tabindex="-1"></a><span class="dt">static</span> <span class="dt">bool</span> SYNTAX_FLAGS_COMMENT_STYLEC<span class="op">(</span><span class="dt">int</span> flags<span class="op">);</span>   <span class="co">// Style c comment</span></span>
<span id="cb835-9"><a aria-hidden="true" href="#cb835-9" tabindex="-1"></a><span class="dt">static</span> <span class="dt">bool</span> SYNTAX_FLAGS_COMMENT_NESTED<span class="op">(</span><span class="dt">int</span> flags<span class="op">);</span>   <span class="co">// Nested comments allowed</span></span></code></pre></div>
<p><strong>Comment Styles:</strong> - <strong>Style a</strong>: Default
(C-style <code>/* ... */</code>) - <strong>Style b</strong>: Alternate
(C++-style <code>// ...</code>) - <strong>Style c</strong>: Nestable
(like <code>(* ... (* ... *) ... *)</code>)</p>
<h3 data-number="21.5.4" id="syntax-table-structure"><span class="header-section-number">21.5.4</span> Syntax Table Structure</h3>
<p>Syntax information is stored in char-tables:</p>
<div class="sourceCode" id="cb836"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb836-1"><a aria-hidden="true" href="#cb836-1" tabindex="-1"></a><span class="co">// Each buffer has its own syntax table</span></span>
<span id="cb836-2"><a aria-hidden="true" href="#cb836-2" tabindex="-1"></a>BVAR <span class="op">(</span>current_buffer<span class="op">,</span> syntax_table<span class="op">)</span></span>
<span id="cb836-3"><a aria-hidden="true" href="#cb836-3" tabindex="-1"></a></span>
<span id="cb836-4"><a aria-hidden="true" href="#cb836-4" tabindex="-1"></a><span class="co">// Syntax table is a char-table mapping characters to syntax descriptors</span></span>
<span id="cb836-5"><a aria-hidden="true" href="#cb836-5" tabindex="-1"></a><span class="co">// Descriptor format: (SYNTAX-CODE . MATCHING-CHAR)</span></span>
<span id="cb836-6"><a aria-hidden="true" href="#cb836-6" tabindex="-1"></a><span class="co">//   SYNTAX-CODE: integer with syntax class and flags</span></span>
<span id="cb836-7"><a aria-hidden="true" href="#cb836-7" tabindex="-1"></a><span class="co">//   MATCHING-CHAR: matching delimiter (for parens, etc.)</span></span></code></pre></div>
<h3 data-number="21.5.5" id="global-syntax-state"><span class="header-section-number">21.5.5</span> Global Syntax State</h3>
<div class="sourceCode" id="cb837"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb837-1"><a aria-hidden="true" href="#cb837-1" tabindex="-1"></a><span class="kw">struct</span> gl_state_s <span class="op">{</span></span>
<span id="cb837-2"><a aria-hidden="true" href="#cb837-2" tabindex="-1"></a>  Lisp_Object object<span class="op">;</span>        <span class="co">// Buffer or string being parsed</span></span>
<span id="cb837-3"><a aria-hidden="true" href="#cb837-3" tabindex="-1"></a>  <span class="dt">ptrdiff_t</span> b_property<span class="op">;</span>      <span class="co">// Beginning of property range</span></span>
<span id="cb837-4"><a aria-hidden="true" href="#cb837-4" tabindex="-1"></a>  <span class="dt">ptrdiff_t</span> e_property<span class="op">;</span>      <span class="co">// End of property range</span></span>
<span id="cb837-5"><a aria-hidden="true" href="#cb837-5" tabindex="-1"></a>  <span class="dt">ptrdiff_t</span> offset<span class="op">;</span>          <span class="co">// Position offset</span></span>
<span id="cb837-6"><a aria-hidden="true" href="#cb837-6" tabindex="-1"></a>  <span class="co">// ... more fields for syntax property tracking</span></span>
<span id="cb837-7"><a aria-hidden="true" href="#cb837-7" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb837-8"><a aria-hidden="true" href="#cb837-8" tabindex="-1"></a></span>
<span id="cb837-9"><a aria-hidden="true" href="#cb837-9" tabindex="-1"></a><span class="kw">extern</span> <span class="kw">struct</span> gl_state_s gl_state<span class="op">;</span></span></code></pre></div>
<h3 data-number="21.5.6" id="syntax-based-navigation"><span class="header-section-number">21.5.6</span> Syntax-Based Navigation</h3>
<h4 data-number="21.5.6.1" id="scanning-functions"><span class="header-section-number">21.5.6.1</span> Scanning Functions</h4>
<div class="sourceCode" id="cb838"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb838-1"><a aria-hidden="true" href="#cb838-1" tabindex="-1"></a><span class="co">// Skip characters matching a specification</span></span>
<span id="cb838-2"><a aria-hidden="true" href="#cb838-2" tabindex="-1"></a><span class="dt">static</span> Lisp_Object skip_chars<span class="op">(</span><span class="dt">bool</span> forward<span class="op">,</span> Lisp_Object string<span class="op">,</span> Lisp_Object lim<span class="op">);</span></span>
<span id="cb838-3"><a aria-hidden="true" href="#cb838-3" tabindex="-1"></a></span>
<span id="cb838-4"><a aria-hidden="true" href="#cb838-4" tabindex="-1"></a><span class="co">// Skip characters by syntax class</span></span>
<span id="cb838-5"><a aria-hidden="true" href="#cb838-5" tabindex="-1"></a><span class="dt">static</span> Lisp_Object skip_syntaxes<span class="op">(</span><span class="dt">bool</span> forward<span class="op">,</span> Lisp_Object string<span class="op">,</span> Lisp_Object lim<span class="op">);</span></span>
<span id="cb838-6"><a aria-hidden="true" href="#cb838-6" tabindex="-1"></a></span>
<span id="cb838-7"><a aria-hidden="true" href="#cb838-7" tabindex="-1"></a><span class="co">// Scan balanced expressions</span></span>
<span id="cb838-8"><a aria-hidden="true" href="#cb838-8" tabindex="-1"></a><span class="dt">static</span> Lisp_Object scan_lists<span class="op">(</span>EMACS_INT from<span class="op">,</span> EMACS_INT count<span class="op">,</span> EMACS_INT depth<span class="op">,</span> <span class="dt">bool</span> sexpflag<span class="op">);</span></span>
<span id="cb838-9"><a aria-hidden="true" href="#cb838-9" tabindex="-1"></a></span>
<span id="cb838-10"><a aria-hidden="true" href="#cb838-10" tabindex="-1"></a><span class="co">// Main parsing state machine</span></span>
<span id="cb838-11"><a aria-hidden="true" href="#cb838-11" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> scan_sexps_forward<span class="op">(</span><span class="kw">struct</span> lisp_parse_state <span class="op">*</span>state<span class="op">,</span></span>
<span id="cb838-12"><a aria-hidden="true" href="#cb838-12" tabindex="-1"></a>                               <span class="dt">ptrdiff_t</span> from<span class="op">,</span> <span class="dt">ptrdiff_t</span> from_byte<span class="op">,</span></span>
<span id="cb838-13"><a aria-hidden="true" href="#cb838-13" tabindex="-1"></a>                               <span class="dt">ptrdiff_t</span> end<span class="op">,</span> EMACS_INT targetdepth<span class="op">,</span></span>
<span id="cb838-14"><a aria-hidden="true" href="#cb838-14" tabindex="-1"></a>                               <span class="dt">bool</span> stopbefore<span class="op">,</span> <span class="dt">int</span> commentstop<span class="op">);</span></span></code></pre></div>
<h4 data-number="21.5.6.2" id="parse-state"><span class="header-section-number">21.5.6.2</span> Parse State</h4>
<div class="sourceCode" id="cb839"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb839-1"><a aria-hidden="true" href="#cb839-1" tabindex="-1"></a><span class="kw">struct</span> lisp_parse_state <span class="op">{</span></span>
<span id="cb839-2"><a aria-hidden="true" href="#cb839-2" tabindex="-1"></a>  EMACS_INT depth<span class="op">;</span>          <span class="co">// Paren depth at end</span></span>
<span id="cb839-3"><a aria-hidden="true" href="#cb839-3" tabindex="-1"></a>  <span class="dt">int</span> instring<span class="op">;</span>             <span class="co">// -1 if not in string, else terminator</span></span>
<span id="cb839-4"><a aria-hidden="true" href="#cb839-4" tabindex="-1"></a>  EMACS_INT incomment<span class="op">;</span>      <span class="co">// Comment nesting level (-1 if not in comment)</span></span>
<span id="cb839-5"><a aria-hidden="true" href="#cb839-5" tabindex="-1"></a>  <span class="dt">int</span> comstyle<span class="op">;</span>             <span class="co">// Comment style (a=0, b=1, or ST_COMMENT_STYLE)</span></span>
<span id="cb839-6"><a aria-hidden="true" href="#cb839-6" tabindex="-1"></a>  <span class="dt">bool</span> quoted<span class="op">;</span>              <span class="co">// Just after escape character</span></span>
<span id="cb839-7"><a aria-hidden="true" href="#cb839-7" tabindex="-1"></a>  EMACS_INT mindepth<span class="op">;</span>       <span class="co">// Minimum depth seen</span></span>
<span id="cb839-8"><a aria-hidden="true" href="#cb839-8" tabindex="-1"></a>  <span class="dt">ptrdiff_t</span> thislevelstart<span class="op">;</span> <span class="co">// Start of current level</span></span>
<span id="cb839-9"><a aria-hidden="true" href="#cb839-9" tabindex="-1"></a>  <span class="dt">ptrdiff_t</span> prevlevelstart<span class="op">;</span> <span class="co">// Start of containing level</span></span>
<span id="cb839-10"><a aria-hidden="true" href="#cb839-10" tabindex="-1"></a>  <span class="dt">ptrdiff_t</span> location<span class="op">;</span>       <span class="co">// Character position where parsing stopped</span></span>
<span id="cb839-11"><a aria-hidden="true" href="#cb839-11" tabindex="-1"></a>  <span class="dt">ptrdiff_t</span> location_byte<span class="op">;</span>  <span class="co">// Byte position</span></span>
<span id="cb839-12"><a aria-hidden="true" href="#cb839-12" tabindex="-1"></a>  <span class="dt">ptrdiff_t</span> comstr_start<span class="op">;</span>   <span class="co">// Start of last comment/string</span></span>
<span id="cb839-13"><a aria-hidden="true" href="#cb839-13" tabindex="-1"></a>  Lisp_Object levelstarts<span class="op">;</span>  <span class="co">// List of start positions of each level</span></span>
<span id="cb839-14"><a aria-hidden="true" href="#cb839-14" tabindex="-1"></a>  <span class="dt">int</span> prev_syntax<span class="op">;</span>          <span class="co">// Previous character's syntax</span></span>
<span id="cb839-15"><a aria-hidden="true" href="#cb839-15" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<h3 data-number="21.5.7" id="comment-and-string-handling"><span class="header-section-number">21.5.7</span> Comment and String
Handling</h3>
<p><strong>Two-Character Delimiters:</strong></p>
<div class="sourceCode" id="cb840"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb840-1"><a aria-hidden="true" href="#cb840-1" tabindex="-1"></a><span class="co">// C-style comments: /* and */</span></span>
<span id="cb840-2"><a aria-hidden="true" href="#cb840-2" tabindex="-1"></a><span class="co">// Tracked via COMSTART_FIRST + COMSTART_SECOND flags</span></span>
<span id="cb840-3"><a aria-hidden="true" href="#cb840-3" tabindex="-1"></a></span>
<span id="cb840-4"><a aria-hidden="true" href="#cb840-4" tabindex="-1"></a><span class="cf">if</span> <span class="op">(</span>SYNTAX_FLAGS_COMSTART_FIRST<span class="op">(</span>syntax<span class="op">)</span> <span class="op">&amp;&amp;</span> from <span class="op">&lt;</span> end<span class="op">)</span> <span class="op">{</span></span>
<span id="cb840-5"><a aria-hidden="true" href="#cb840-5" tabindex="-1"></a>  <span class="dt">int</span> next_char <span class="op">=</span> FETCH_CHAR<span class="op">(</span>from <span class="op">+</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb840-6"><a aria-hidden="true" href="#cb840-6" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>SYNTAX_FLAGS_COMSTART_SECOND<span class="op">(</span>SYNTAX_WITH_FLAGS<span class="op">(</span>next_char<span class="op">)))</span> <span class="op">{</span></span>
<span id="cb840-7"><a aria-hidden="true" href="#cb840-7" tabindex="-1"></a>    <span class="co">// Found two-char comment start</span></span>
<span id="cb840-8"><a aria-hidden="true" href="#cb840-8" tabindex="-1"></a>    comstyle <span class="op">=</span> SYNTAX_FLAGS_COMMENT_STYLE<span class="op">(</span>syntax1<span class="op">,</span> syntax2<span class="op">);</span></span>
<span id="cb840-9"><a aria-hidden="true" href="#cb840-9" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb840-10"><a aria-hidden="true" href="#cb840-10" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>Generic Delimiters (Fences):</strong></p>
<div class="sourceCode" id="cb841"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb841-1"><a aria-hidden="true" href="#cb841-1" tabindex="-1"></a><span class="co">// Scomment_fence and Sstring_fence</span></span>
<span id="cb841-2"><a aria-hidden="true" href="#cb841-2" tabindex="-1"></a><span class="co">// Any character with same syntax is matching delimiter</span></span>
<span id="cb841-3"><a aria-hidden="true" href="#cb841-3" tabindex="-1"></a><span class="co">// Example: Python's ''' or """</span></span></code></pre></div>
<h3 data-number="21.5.8" id="syntax-properties"><span class="header-section-number">21.5.8</span> Syntax Properties</h3>
<p>Override syntax table via text properties:</p>
<div class="sourceCode" id="cb842"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb842-1"><a aria-hidden="true" href="#cb842-1" tabindex="-1"></a><span class="co">// If parse_sexp_lookup_properties is true,</span></span>
<span id="cb842-2"><a aria-hidden="true" href="#cb842-2" tabindex="-1"></a><span class="co">// 'syntax-table' property overrides buffer's syntax table</span></span>
<span id="cb842-3"><a aria-hidden="true" href="#cb842-3" tabindex="-1"></a></span>
<span id="cb842-4"><a aria-hidden="true" href="#cb842-4" tabindex="-1"></a><span class="cf">if</span> <span class="op">(</span>parse_sexp_lookup_properties<span class="op">)</span> <span class="op">{</span></span>
<span id="cb842-5"><a aria-hidden="true" href="#cb842-5" tabindex="-1"></a>  Lisp_Object prop <span class="op">=</span> Fget_text_property<span class="op">(</span>pos<span class="op">,</span> Qsyntax_table<span class="op">,</span> Qnil<span class="op">);</span></span>
<span id="cb842-6"><a aria-hidden="true" href="#cb842-6" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(!</span>NILP<span class="op">(</span>prop<span class="op">))</span> <span class="op">{</span></span>
<span id="cb842-7"><a aria-hidden="true" href="#cb842-7" tabindex="-1"></a>    <span class="co">// Use property value instead of buffer syntax table</span></span>
<span id="cb842-8"><a aria-hidden="true" href="#cb842-8" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb842-9"><a aria-hidden="true" href="#cb842-9" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>Use Cases:</strong> - String interpolation in programming
languages - Heredocs with different syntax rules - Embedded languages
(e.g., SQL in strings)</p>
<hr/>
<h2 data-number="21.6" id="case-handling"><span class="header-section-number">21.6</span> Case Handling</h2>
<h3 data-number="21.6.1" id="file-srccasefiddle.c-764-lines"><span class="header-section-number">21.6.1</span> File:
<code>src/casefiddle.c</code> (764 lines)</h3>
<p>Handles case conversion with full Unicode support.</p>
<h3 data-number="21.6.2" id="case-operations"><span class="header-section-number">21.6.2</span> Case Operations</h3>
<div class="sourceCode" id="cb843"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb843-1"><a aria-hidden="true" href="#cb843-1" tabindex="-1"></a><span class="kw">enum</span> case_action <span class="op">{</span></span>
<span id="cb843-2"><a aria-hidden="true" href="#cb843-2" tabindex="-1"></a>  CASE_UP<span class="op">,</span>            <span class="co">// upcase: "hello" ‚Üí "HELLO"</span></span>
<span id="cb843-3"><a aria-hidden="true" href="#cb843-3" tabindex="-1"></a>  CASE_DOWN<span class="op">,</span>          <span class="co">// downcase: "HELLO" ‚Üí "hello"</span></span>
<span id="cb843-4"><a aria-hidden="true" href="#cb843-4" tabindex="-1"></a>  CASE_CAPITALIZE<span class="op">,</span>    <span class="co">// capitalize: "hello world" ‚Üí "Hello World"</span></span>
<span id="cb843-5"><a aria-hidden="true" href="#cb843-5" tabindex="-1"></a>  CASE_CAPITALIZE_UP  <span class="co">// upcase-initials: "hello world" ‚Üí "Hello World" (no downcasing)</span></span>
<span id="cb843-6"><a aria-hidden="true" href="#cb843-6" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<h3 data-number="21.6.3" id="casing-context"><span class="header-section-number">21.6.3</span> Casing Context</h3>
<div class="sourceCode" id="cb844"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb844-1"><a aria-hidden="true" href="#cb844-1" tabindex="-1"></a><span class="kw">struct</span> casing_context <span class="op">{</span></span>
<span id="cb844-2"><a aria-hidden="true" href="#cb844-2" tabindex="-1"></a>  Lisp_Object titlecase_char_table<span class="op">;</span>      <span class="co">// Title case mappings</span></span>
<span id="cb844-3"><a aria-hidden="true" href="#cb844-3" tabindex="-1"></a>  Lisp_Object specialcase_char_tables<span class="op">[</span><span class="dv">3</span><span class="op">];</span> <span class="co">// Special case rules (up/down/title)</span></span>
<span id="cb844-4"><a aria-hidden="true" href="#cb844-4" tabindex="-1"></a>  <span class="kw">enum</span> case_action flag<span class="op">;</span>                  <span class="co">// Operation type</span></span>
<span id="cb844-5"><a aria-hidden="true" href="#cb844-5" tabindex="-1"></a>  <span class="dt">bool</span> inbuffer<span class="op">;</span>                          <span class="co">// Operating on buffer vs. string</span></span>
<span id="cb844-6"><a aria-hidden="true" href="#cb844-6" tabindex="-1"></a>  <span class="dt">bool</span> inword<span class="op">;</span>                            <span class="co">// Currently in a word</span></span>
<span id="cb844-7"><a aria-hidden="true" href="#cb844-7" tabindex="-1"></a>  <span class="dt">bool</span> downcase_last<span class="op">;</span>                     <span class="co">// Last operation was downcase</span></span>
<span id="cb844-8"><a aria-hidden="true" href="#cb844-8" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<h3 data-number="21.6.4" id="unicode-case-mapping"><span class="header-section-number">21.6.4</span> Unicode Case Mapping</h3>
<p><strong>Simple Cases (one-to-one):</strong></p>
<div class="sourceCode" id="cb845"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb845-1"><a aria-hidden="true" href="#cb845-1" tabindex="-1"></a><span class="dt">static</span> <span class="kw">inline</span> <span class="dt">int</span> case_single_character<span class="op">(</span><span class="kw">struct</span> casing_context <span class="op">*</span>ctx<span class="op">,</span> <span class="dt">int</span> ch<span class="op">)</span> <span class="op">{</span></span>
<span id="cb845-2"><a aria-hidden="true" href="#cb845-2" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>flag <span class="op">==</span> CASE_DOWN<span class="op">)</span></span>
<span id="cb845-3"><a aria-hidden="true" href="#cb845-3" tabindex="-1"></a>    <span class="cf">return</span> downcase<span class="op">(</span>ch<span class="op">);</span>  <span class="co">// Uses Unicode lowercase table</span></span>
<span id="cb845-4"><a aria-hidden="true" href="#cb845-4" tabindex="-1"></a>  <span class="cf">else</span></span>
<span id="cb845-5"><a aria-hidden="true" href="#cb845-5" tabindex="-1"></a>    <span class="cf">return</span> upcase<span class="op">(</span>ch<span class="op">);</span>    <span class="co">// Uses Unicode uppercase table</span></span>
<span id="cb845-6"><a aria-hidden="true" href="#cb845-6" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>Special Cases (one-to-many):</strong></p>
<p>Some characters expand when cased:</p>
<div class="sourceCode" id="cb846"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb846-1"><a aria-hidden="true" href="#cb846-1" tabindex="-1"></a><span class="co">// Example: Ô¨Å (U+FB01 LATIN SMALL LIGATURE FI)</span></span>
<span id="cb846-2"><a aria-hidden="true" href="#cb846-2" tabindex="-1"></a><span class="co">// Uppercase: "FI" (two characters)</span></span>
<span id="cb846-3"><a aria-hidden="true" href="#cb846-3" tabindex="-1"></a></span>
<span id="cb846-4"><a aria-hidden="true" href="#cb846-4" tabindex="-1"></a><span class="dt">static</span> <span class="dt">bool</span> case_character<span class="op">(</span><span class="kw">struct</span> casing_str_buf <span class="op">*</span>buf<span class="op">,</span></span>
<span id="cb846-5"><a aria-hidden="true" href="#cb846-5" tabindex="-1"></a>                           <span class="kw">struct</span> casing_context <span class="op">*</span>ctx<span class="op">,</span></span>
<span id="cb846-6"><a aria-hidden="true" href="#cb846-6" tabindex="-1"></a>                           <span class="dt">int</span> ch<span class="op">,</span> <span class="dt">const</span> <span class="dt">unsigned</span> <span class="dt">char</span> <span class="op">*</span>next<span class="op">)</span> <span class="op">{</span></span>
<span id="cb846-7"><a aria-hidden="true" href="#cb846-7" tabindex="-1"></a>  <span class="co">// Check special-casing table</span></span>
<span id="cb846-8"><a aria-hidden="true" href="#cb846-8" tabindex="-1"></a>  prop <span class="op">=</span> CHAR_TABLE_REF<span class="op">(</span>ctx<span class="op">-&gt;</span>specialcase_char_tables<span class="op">[</span>flag<span class="op">],</span> ch<span class="op">);</span></span>
<span id="cb846-9"><a aria-hidden="true" href="#cb846-9" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>STRINGP<span class="op">(</span>prop<span class="op">))</span> <span class="op">{</span></span>
<span id="cb846-10"><a aria-hidden="true" href="#cb846-10" tabindex="-1"></a>    <span class="co">// Character expands to multiple characters</span></span>
<span id="cb846-11"><a aria-hidden="true" href="#cb846-11" tabindex="-1"></a>    memcpy<span class="op">(</span>buf<span class="op">-&gt;</span>data<span class="op">,</span> SDATA<span class="op">(</span>prop<span class="op">),</span> SBYTES<span class="op">(</span>prop<span class="op">));</span></span>
<span id="cb846-12"><a aria-hidden="true" href="#cb846-12" tabindex="-1"></a>    buf<span class="op">-&gt;</span>len_chars <span class="op">=</span> SCHARS<span class="op">(</span>prop<span class="op">);</span></span>
<span id="cb846-13"><a aria-hidden="true" href="#cb846-13" tabindex="-1"></a>    buf<span class="op">-&gt;</span>len_bytes <span class="op">=</span> SBYTES<span class="op">(</span>prop<span class="op">);</span></span>
<span id="cb846-14"><a aria-hidden="true" href="#cb846-14" tabindex="-1"></a>    <span class="cf">return</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb846-15"><a aria-hidden="true" href="#cb846-15" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb846-16"><a aria-hidden="true" href="#cb846-16" tabindex="-1"></a>  <span class="co">// ... handle simple case ...</span></span>
<span id="cb846-17"><a aria-hidden="true" href="#cb846-17" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>Examples of Special Cases:</strong> - <code>Ô¨Å</code> ‚Üí
<code>FI</code> (ligature) - <code>√ü</code> ‚Üí <code>SS</code> (German
eszett) - <code>Œê</code> (Greek iota with dialytika and tonos)</p>
<h3 data-number="21.6.5" id="greek-final-sigma"><span class="header-section-number">21.6.5</span> Greek Final Sigma</h3>
<p>Special handling for context-sensitive casing:</p>
<div class="sourceCode" id="cb847"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb847-1"><a aria-hidden="true" href="#cb847-1" tabindex="-1"></a><span class="kw">enum</span> <span class="op">{</span> GREEK_CAPITAL_LETTER_SIGMA <span class="op">=</span> <span class="bn">0x03A3</span> <span class="op">};</span>  <span class="co">// Œ£</span></span>
<span id="cb847-2"><a aria-hidden="true" href="#cb847-2" tabindex="-1"></a><span class="kw">enum</span> <span class="op">{</span> GREEK_SMALL_LETTER_FINAL_SIGMA <span class="op">=</span> <span class="bn">0x03C2</span> <span class="op">};</span> <span class="co">// œÇ</span></span>
<span id="cb847-3"><a aria-hidden="true" href="#cb847-3" tabindex="-1"></a></span>
<span id="cb847-4"><a aria-hidden="true" href="#cb847-4" tabindex="-1"></a><span class="co">// When downcasing Œ£:</span></span>
<span id="cb847-5"><a aria-hidden="true" href="#cb847-5" tabindex="-1"></a><span class="co">// - If at end of word ‚Üí œÇ (final sigma)</span></span>
<span id="cb847-6"><a aria-hidden="true" href="#cb847-6" tabindex="-1"></a><span class="co">// - If in middle of word ‚Üí œÉ (regular sigma)</span></span>
<span id="cb847-7"><a aria-hidden="true" href="#cb847-7" tabindex="-1"></a></span>
<span id="cb847-8"><a aria-hidden="true" href="#cb847-8" tabindex="-1"></a><span class="cf">if</span> <span class="op">(</span>was_inword <span class="op">&amp;&amp;</span> ch <span class="op">==</span> GREEK_CAPITAL_LETTER_SIGMA <span class="op">&amp;&amp;</span> changed</span>
<span id="cb847-9"><a aria-hidden="true" href="#cb847-9" tabindex="-1"></a>    <span class="op">&amp;&amp;</span> <span class="op">(!</span>next <span class="op">||</span> <span class="op">!</span>case_ch_is_word<span class="op">(</span>SYNTAX<span class="op">(</span>STRING_CHAR<span class="op">(</span>next<span class="op">)))))</span> <span class="op">{</span></span>
<span id="cb847-10"><a aria-hidden="true" href="#cb847-10" tabindex="-1"></a>  buf<span class="op">-&gt;</span>data<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">=</span> GREEK_SMALL_LETTER_FINAL_SIGMA<span class="op">;</span></span>
<span id="cb847-11"><a aria-hidden="true" href="#cb847-11" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 data-number="21.6.6" id="word-boundaries"><span class="header-section-number">21.6.6</span> Word Boundaries</h3>
<div class="sourceCode" id="cb848"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb848-1"><a aria-hidden="true" href="#cb848-1" tabindex="-1"></a><span class="dt">static</span> <span class="dt">bool</span> case_ch_is_word<span class="op">(</span><span class="kw">enum</span> syntaxcode syntax<span class="op">)</span> <span class="op">{</span></span>
<span id="cb848-2"><a aria-hidden="true" href="#cb848-2" tabindex="-1"></a>  <span class="cf">return</span> syntax <span class="op">==</span> Sword <span class="op">||</span></span>
<span id="cb848-3"><a aria-hidden="true" href="#cb848-3" tabindex="-1"></a>         <span class="op">(</span>case_symbols_as_words <span class="op">&amp;&amp;</span> syntax <span class="op">==</span> Ssymbol<span class="op">);</span></span>
<span id="cb848-4"><a aria-hidden="true" href="#cb848-4" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb848-5"><a aria-hidden="true" href="#cb848-5" tabindex="-1"></a></span>
<span id="cb848-6"><a aria-hidden="true" href="#cb848-6" tabindex="-1"></a><span class="co">// Variable: case-symbols-as-words</span></span>
<span id="cb848-7"><a aria-hidden="true" href="#cb848-7" tabindex="-1"></a><span class="co">// If non-nil, treat symbols as part of words for case operations</span></span>
<span id="cb848-8"><a aria-hidden="true" href="#cb848-8" tabindex="-1"></a><span class="co">// Useful for programming languages (camelCase, snake_case)</span></span></code></pre></div>
<h3 data-number="21.6.7" id="buffer-case-operations"><span class="header-section-number">21.6.7</span> Buffer Case Operations</h3>
<div class="sourceCode" id="cb849"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb849-1"><a aria-hidden="true" href="#cb849-1" tabindex="-1"></a><span class="dt">static</span> <span class="dt">ptrdiff_t</span></span>
<span id="cb849-2"><a aria-hidden="true" href="#cb849-2" tabindex="-1"></a>do_casify_multibyte_region<span class="op">(</span><span class="kw">struct</span> casing_context <span class="op">*</span>ctx<span class="op">,</span></span>
<span id="cb849-3"><a aria-hidden="true" href="#cb849-3" tabindex="-1"></a>                           <span class="dt">ptrdiff_t</span> <span class="op">*</span>startp<span class="op">,</span> <span class="dt">ptrdiff_t</span> <span class="op">*</span>endp<span class="op">)</span> <span class="op">{</span></span>
<span id="cb849-4"><a aria-hidden="true" href="#cb849-4" tabindex="-1"></a>  <span class="co">// For each character in region:</span></span>
<span id="cb849-5"><a aria-hidden="true" href="#cb849-5" tabindex="-1"></a>  <span class="co">// 1. Case according to context</span></span>
<span id="cb849-6"><a aria-hidden="true" href="#cb849-6" tabindex="-1"></a>  <span class="co">// 2. Handle size changes (e.g., √ü ‚Üí SS adds one character)</span></span>
<span id="cb849-7"><a aria-hidden="true" href="#cb849-7" tabindex="-1"></a>  <span class="co">// 3. Update text properties</span></span>
<span id="cb849-8"><a aria-hidden="true" href="#cb849-8" tabindex="-1"></a>  <span class="co">// 4. Return number of characters added/removed</span></span>
<span id="cb849-9"><a aria-hidden="true" href="#cb849-9" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>Challenge</strong>: Characters may change byte length: -
ASCII ‚Üí non-ASCII (Turkish i ‚Üí ƒ∞ in some locales) - Single ‚Üí multiple
characters (ligatures) - Non-ASCII ‚Üí ASCII (downcase in unibyte
buffers)</p>
<h3 data-number="21.6.8" id="api-functions"><span class="header-section-number">21.6.8</span> API Functions</h3>
<div class="sourceCode" id="cb850"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb850-1"><a aria-hidden="true" href="#cb850-1" tabindex="-1"></a>DEFUN <span class="op">(</span><span class="st">"upcase"</span><span class="op">,</span> Fupcase<span class="op">,</span> Supcase<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="op">...);</span></span>
<span id="cb850-2"><a aria-hidden="true" href="#cb850-2" tabindex="-1"></a>DEFUN <span class="op">(</span><span class="st">"downcase"</span><span class="op">,</span> Fdowncase<span class="op">,</span> Sdowncase<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="op">...);</span></span>
<span id="cb850-3"><a aria-hidden="true" href="#cb850-3" tabindex="-1"></a>DEFUN <span class="op">(</span><span class="st">"capitalize"</span><span class="op">,</span> Fcapitalize<span class="op">,</span> Scapitalize<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="op">...);</span></span>
<span id="cb850-4"><a aria-hidden="true" href="#cb850-4" tabindex="-1"></a>DEFUN <span class="op">(</span><span class="st">"upcase-initials"</span><span class="op">,</span> Fupcase_initials<span class="op">,</span> Supcase_initials<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="op">...);</span></span>
<span id="cb850-5"><a aria-hidden="true" href="#cb850-5" tabindex="-1"></a></span>
<span id="cb850-6"><a aria-hidden="true" href="#cb850-6" tabindex="-1"></a>DEFUN <span class="op">(</span><span class="st">"upcase-region"</span><span class="op">,</span> Fupcase_region<span class="op">,</span> Supcase_region<span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="op">...);</span></span>
<span id="cb850-7"><a aria-hidden="true" href="#cb850-7" tabindex="-1"></a>DEFUN <span class="op">(</span><span class="st">"downcase-region"</span><span class="op">,</span> Fdowncase_region<span class="op">,</span> Sdowncase_region<span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="op">...);</span></span>
<span id="cb850-8"><a aria-hidden="true" href="#cb850-8" tabindex="-1"></a>DEFUN <span class="op">(</span><span class="st">"capitalize-region"</span><span class="op">,</span> Fcapitalize_region<span class="op">,</span> Scapitalize_region<span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="op">...);</span></span>
<span id="cb850-9"><a aria-hidden="true" href="#cb850-9" tabindex="-1"></a>DEFUN <span class="op">(</span><span class="st">"upcase-initials-region"</span><span class="op">,</span> Fupcase_initials_region<span class="op">,</span> <span class="op">...);</span></span>
<span id="cb850-10"><a aria-hidden="true" href="#cb850-10" tabindex="-1"></a></span>
<span id="cb850-11"><a aria-hidden="true" href="#cb850-11" tabindex="-1"></a>DEFUN <span class="op">(</span><span class="st">"upcase-word"</span><span class="op">,</span> Fupcase_word<span class="op">,</span> Supcase_word<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="st">"p"</span><span class="op">,</span> <span class="op">...);</span></span>
<span id="cb850-12"><a aria-hidden="true" href="#cb850-12" tabindex="-1"></a>DEFUN <span class="op">(</span><span class="st">"downcase-word"</span><span class="op">,</span> Fdowncase_word<span class="op">,</span> Sdowncase_word<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="st">"p"</span><span class="op">,</span> <span class="op">...);</span></span>
<span id="cb850-13"><a aria-hidden="true" href="#cb850-13" tabindex="-1"></a>DEFUN <span class="op">(</span><span class="st">"capitalize-word"</span><span class="op">,</span> Fcapitalize_word<span class="op">,</span> Scapitalize_word<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="st">"p"</span><span class="op">,</span> <span class="op">...);</span></span></code></pre></div>
<hr/>
<h2 data-number="21.7" id="elisp-layer-1"><span class="header-section-number">21.7</span> Elisp Layer</h2>
<h3 data-number="21.7.1" id="incremental-search-lispisearch.el"><span class="header-section-number">21.7.1</span> Incremental Search
(<code>lisp/isearch.el</code>)</h3>
<p>Real-time search with immediate feedback.</p>
<h4 data-number="21.7.1.1" id="key-features-3"><span class="header-section-number">21.7.1.1</span> Key Features</h4>
<ol type="1">
<li><strong>Search Modes</strong>:
<ul>
<li>Plain string search</li>
<li>Regular expression search</li>
<li>Word search (match whole words)</li>
<li>Symbol search (match whole symbols)</li>
<li>Character folding (match Unicode variants)</li>
</ul></li>
<li><strong>Customization Variables</strong>:</li>
</ol>
<pre class="elisp"><code>;; Case sensitivity control
(defcustom search-upper-case 'not-yanks
  "If non-nil, uppercase in search string disables case folding.")

;; Whitespace handling
(defcustom search-whitespace-regexp "[ \t]+"
  "Regexp to match whitespace in incremental search.")

;; Invisible text
(defcustom search-invisible 'open
  "Whether to search invisible text.")

;; Wrapping behavior
(defcustom isearch-wrap-pause t
  "Pause before wrapping when no more matches.")</code></pre>
<ol start="3" type="1">
<li><strong>Search Ring</strong>:</li>
</ol>
<pre class="elisp"><code>;; Stores search history
(defvar search-ring nil)
(defvar regexp-search-ring nil)

;; Navigate through previous searches with M-p / M-n</code></pre>
<ol start="4" type="1">
<li><strong>Dynamic Updates</strong>:</li>
</ol>
<pre class="elisp"><code>;; Update search as you type
(defun isearch-search ()
  "Search for the current search string."
  (let ((result (isearch-search-string
                 isearch-string nil isearch-forward)))
    ;; Update highlight immediately
    (isearch-highlight ...)))</code></pre>
<h4 data-number="21.7.1.2" id="lazy-highlighting"><span class="header-section-number">21.7.1.2</span> Lazy Highlighting</h4>
<pre class="elisp"><code>;; Show all matches in buffer
(defvar isearch-lazy-highlight t
  "Controls lazy highlighting of matches.")

;; Highlight matches in viewport
(defun isearch-lazy-highlight-update ()
  "Update lazy highlighting of matches."
  ;; Scan visible portion of buffer
  ;; Apply overlay to each match
  ;; Stop at isearch-lazy-highlight-max-at-a-time)</code></pre>
<h3 data-number="21.7.2" id="regular-expression-builder-lispemacs-lispre-builder.el"><span class="header-section-number">21.7.2</span> Regular Expression Builder
(<code>lisp/emacs-lisp/re-builder.el</code>)</h3>
<p>Interactive regex development tool.</p>
<h4 data-number="21.7.2.1" id="features"><span class="header-section-number">21.7.2.1</span> Features</h4>
<ol type="1">
<li><strong>Live Preview</strong>:</li>
</ol>
<pre class="elisp"><code>;; Three input syntaxes:
;; - 'read: "\\(hello\\|world\\)"  (Lisp read syntax)
;; - 'string: "\(hello\|world\)"    (String syntax, less escaping)
;; - 'rx: (or "hello" "world")      (Symbolic rx syntax)

(defcustom reb-re-syntax 'read
  "Syntax for REs in RE Builder.")</code></pre>
<ol start="2" type="1">
<li><strong>Visual Feedback</strong>:</li>
</ol>
<pre class="elisp"><code>;; Highlight matches with colored overlays
(defface reb-match-0 ...)  ; Whole match
(defface reb-match-1 ...)  ; First subgroup
(defface reb-match-2 ...)  ; Second subgroup
; ... up to reb-match-3</code></pre>
<ol start="3" type="1">
<li><strong>Target Buffer</strong>:</li>
</ol>
<pre class="elisp"><code>;; Test regex against any buffer
(defun reb-change-target-buffer (buf)
  "Change target buffer for RE Builder."
  ;; Remove overlays from old buffer
  ;; Apply to new buffer)</code></pre>
<h3 data-number="21.7.3" id="character-folding-lispchar-fold.el"><span class="header-section-number">21.7.3</span> Character Folding
(<code>lisp/char-fold.el</code>)</h3>
<p>Match Unicode characters by similarity to ASCII.</p>
<h4 data-number="21.7.3.1" id="folding-table"><span class="header-section-number">21.7.3.1</span> Folding Table</h4>
<pre class="elisp"><code>(defconst char-fold--default-include
  '((?\" "ÔºÇ" """ """ "‚Äû" ...)   ; Match various quote styles
    (?' "'" "'" "‚Äö" "‚Äõ" ...)     ; Match various apostrophes
    (?√ü "ss")                     ; German eszett
    (?Œπ "Œê")                      ; Greek iota variants
    ...))

(defconst char-fold--default-exclude
  '((?–∏ "–π")))  ; Cyrillic: don't fold these</code></pre>
<h4 data-number="21.7.3.2" id="decomposition-based-folding"><span class="header-section-number">21.7.3.2</span> Decomposition-Based
Folding</h4>
<pre class="elisp"><code>;; Build equivalence table from Unicode decompositions
(defun char-fold--make-table ()
  ;; For each character with a decomposition:
  ;; 1. Let char match its decomposition
  ;; 2. Let decomposition match char
  ;; 3. Let base char match accented variants

  ;; Example: 'a' matches '√†', '√°', '√¢', '√£', '√§', '√•', ...
  ;; Example: 'e' matches '√®', '√©', '√™', '√´', ...
  )</code></pre>
<h4 data-number="21.7.3.3" id="converting-searches"><span class="header-section-number">21.7.3.3</span> Converting Searches</h4>
<pre class="elisp"><code>(defun char-fold-to-regexp (string)
  "Convert STRING to a regexp matching character variants."
  ;; For each character in string:
  ;; - If has variants, insert [...] with all variants
  ;; - Otherwise, use character literally

  ;; "cafe" ‚Üí "c[a√†√°√¢√£√§√•]f[e√®√©√™√´]"
  )</code></pre>
<h3 data-number="21.7.4" id="integration-example"><span class="header-section-number">21.7.4</span> Integration Example</h3>
<p>How these layers work together for a case-insensitive search:</p>
<pre class="elisp"><code>;; User types C-s hello RET

;; 1. isearch.el handles input
(isearch-forward)

;; 2. Determine search parameters
(let* ((case-fold-search t)           ; User wants case-insensitive
       (search-string "hello")
       (search-fn 'search-forward))   ; Use literal search, not regex

  ;; 3. If char-fold enabled, convert to regex
  (when char-fold-search
    (setq search-string (char-fold-to-regexp "hello"))
    (setq search-fn 're-search-forward))

  ;; 4. Call C layer
  (funcall search-fn search-string nil t))

;; 5. C layer (search.c):
;;    - Checks if Boyer-Moore can be used
;;    - Uses case_canon_table for case folding
;;    - Returns match position or nil

;; 6. Update display
(isearch-highlight (match-beginning 0) (match-end 0))</code></pre>
<hr/>
<h2 data-number="21.8" id="integration-and-data-flow"><span class="header-section-number">21.8</span> Integration and Data Flow</h2>
<h3 data-number="21.8.1" id="search-flow-diagram"><span class="header-section-number">21.8.1</span> Search Flow Diagram</h3>
<pre><code>User Input (C-s, M-C-s)
    ‚Üì
isearch.el (incremental search UI)
    ‚Üì
char-fold.el (optional: expand to Unicode variants)
    ‚Üì
search.c or regex-emacs.c
    ‚îú‚îÄ‚Üí simple_search() [Simple string matching]
    ‚îú‚îÄ‚Üí boyer_moore()   [Fast literal search]
    ‚îî‚îÄ‚Üí re_match_2()    [Regex matching]
        ‚Üì
    syntax.c (for \sw, \s_, etc. in regexes)
    casefiddle.c (for case-insensitive search)
        ‚Üì
Match position returned
    ‚Üì
isearch.el updates display</code></pre>
<h3 data-number="21.8.2" id="key-integration-points"><span class="header-section-number">21.8.2</span> Key Integration Points</h3>
<h4 data-number="21.8.2.1" id="case-folding-in-search"><span class="header-section-number">21.8.2.1</span> 1. Case Folding in
Search</h4>
<div class="sourceCode" id="cb863"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb863-1"><a aria-hidden="true" href="#cb863-1" tabindex="-1"></a><span class="co">// In search.c:</span></span>
<span id="cb863-2"><a aria-hidden="true" href="#cb863-2" tabindex="-1"></a><span class="cf">if</span> <span class="op">(!</span>NILP<span class="op">(</span>Vcase_fold_search<span class="op">))</span> <span class="op">{</span></span>
<span id="cb863-3"><a aria-hidden="true" href="#cb863-3" tabindex="-1"></a>  <span class="co">// Use case_canon_table for translation</span></span>
<span id="cb863-4"><a aria-hidden="true" href="#cb863-4" tabindex="-1"></a>  trt <span class="op">=</span> BVAR<span class="op">(</span>current_buffer<span class="op">,</span> case_canon_table<span class="op">);</span></span>
<span id="cb863-5"><a aria-hidden="true" href="#cb863-5" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb863-6"><a aria-hidden="true" href="#cb863-6" tabindex="-1"></a></span>
<span id="cb863-7"><a aria-hidden="true" href="#cb863-7" tabindex="-1"></a><span class="co">// case_canon_table maps:</span></span>
<span id="cb863-8"><a aria-hidden="true" href="#cb863-8" tabindex="-1"></a><span class="co">// 'A' ‚Üí 'a', 'B' ‚Üí 'b', ..., 'a' ‚Üí 'a', 'b' ‚Üí 'b', ...</span></span></code></pre></div>
<h4 data-number="21.8.2.2" id="syntax-tables-in-regex"><span class="header-section-number">21.8.2.2</span> 2. Syntax Tables in
Regex</h4>
<div class="sourceCode" id="cb864"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb864-1"><a aria-hidden="true" href="#cb864-1" tabindex="-1"></a><span class="co">// In regex-emacs.c, for \sw, \s_, etc.:</span></span>
<span id="cb864-2"><a aria-hidden="true" href="#cb864-2" tabindex="-1"></a><span class="pp">#define SYNTAX</span><span class="op">(</span><span class="pp">c</span><span class="op">)</span><span class="pp"> syntax_property</span><span class="op">(</span><span class="pp">c</span><span class="op">,</span><span class="pp"> </span><span class="dv">1</span><span class="op">)</span></span>
<span id="cb864-3"><a aria-hidden="true" href="#cb864-3" tabindex="-1"></a></span>
<span id="cb864-4"><a aria-hidden="true" href="#cb864-4" tabindex="-1"></a><span class="co">// During matching:</span></span>
<span id="cb864-5"><a aria-hidden="true" href="#cb864-5" tabindex="-1"></a><span class="cf">case</span> syntaxspec<span class="op">:</span></span>
<span id="cb864-6"><a aria-hidden="true" href="#cb864-6" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>SYNTAX<span class="op">(*</span>d<span class="op">)</span> <span class="op">==</span> <span class="op">(</span><span class="kw">enum</span> syntaxcode<span class="op">)</span> <span class="op">*</span>p<span class="op">++)</span></span>
<span id="cb864-7"><a aria-hidden="true" href="#cb864-7" tabindex="-1"></a>    <span class="co">// Match succeeds</span></span></code></pre></div>
<h4 data-number="21.8.2.3" id="whitespace-handling"><span class="header-section-number">21.8.2.3</span> 3. Whitespace
Handling</h4>
<pre class="elisp"><code>;; Elisp layer:
(setq search-whitespace-regexp "[ \t\n]+")

// C layer (search.c):
if (STRINGP(Vsearch_spaces_regexp)) {
  whitespace_regexp = SSDATA(Vsearch_spaces_regexp);
  // Pass to re_compile_pattern
}

// regex-emacs.c:
// Each space in pattern expands to whitespace_regexp</code></pre>
<h4 data-number="21.8.2.4" id="character-folding-integration"><span class="header-section-number">21.8.2.4</span> 4. Character Folding
Integration</h4>
<pre class="elisp"><code>;; Elisp converts literal search to regex:
(when char-fold-search
  ;; "hello" becomes regex like:
  ;; "[h]e[l]l[o]" but with Unicode variants:
  ;; "[hƒ•ƒß·∏£·∏•...][e√®√©√™√´...][l][l][o√≤√≥√¥√µ√∂...]"
  (setq pattern (char-fold-to-regexp pattern))
  (setq use-regex t))

// Then use regex search path instead of literal</code></pre>
<hr/>
<h2 data-number="21.9" id="performance-characteristics-4"><span class="header-section-number">21.9</span> Performance
Characteristics</h2>
<h3 data-number="21.9.1" id="algorithm-complexity"><span class="header-section-number">21.9.1</span> Algorithm Complexity</h3>
<table>
<colgroup>
<col style="width: 18%"/>
<col style="width: 18%"/>
<col style="width: 24%"/>
<col style="width: 20%"/>
<col style="width: 17%"/>
</colgroup>
<thead>
<tr>
<th>Algorithm</th>
<th>Best Case</th>
<th>Average Case</th>
<th>Worst Case</th>
<th>Use When</th>
</tr>
</thead>
<tbody>
<tr>
<td>Simple Search</td>
<td>O(n)</td>
<td>O(nm)</td>
<td>O(nm)</td>
<td>Case folding, translation</td>
</tr>
<tr>
<td>Boyer-Moore</td>
<td>O(n/m)</td>
<td>O(n)</td>
<td>O(nm)</td>
<td>Literal strings, no translation</td>
</tr>
<tr>
<td>Regex (DFA)</td>
<td>O(n)</td>
<td>O(n)</td>
<td>O(n)</td>
<td>Simple patterns, no backtracking</td>
</tr>
<tr>
<td>Regex (Backtracking)</td>
<td>O(n)</td>
<td>O(nm)</td>
<td>O(2^n)</td>
<td>Complex patterns, backreferences</td>
</tr>
</tbody>
</table>
<p>Where: - n = length of text being searched - m = length of
pattern</p>
<h3 data-number="21.9.2" id="memory-usage-2"><span class="header-section-number">21.9.2</span> Memory Usage</h3>
<p><strong>Regex Compilation:</strong></p>
<div class="sourceCode" id="cb867"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb867-1"><a aria-hidden="true" href="#cb867-1" tabindex="-1"></a><span class="co">// Typical compiled regex size:</span></span>
<span id="cb867-2"><a aria-hidden="true" href="#cb867-2" tabindex="-1"></a><span class="co">// Pattern: "foo.*bar"</span></span>
<span id="cb867-3"><a aria-hidden="true" href="#cb867-3" tabindex="-1"></a><span class="co">// Compiled: ~50-100 bytes (opcodes + metadata)</span></span>
<span id="cb867-4"><a aria-hidden="true" href="#cb867-4" tabindex="-1"></a></span>
<span id="cb867-5"><a aria-hidden="true" href="#cb867-5" tabindex="-1"></a><span class="co">// With character classes:</span></span>
<span id="cb867-6"><a aria-hidden="true" href="#cb867-6" tabindex="-1"></a><span class="co">// Pattern: "[a-zA-Z0-9_]+"</span></span>
<span id="cb867-7"><a aria-hidden="true" href="#cb867-7" tabindex="-1"></a><span class="co">// Compiled: ~300 bytes (bitmap for charset)</span></span></code></pre></div>
<p><strong>Regex Cache:</strong></p>
<div class="sourceCode" id="cb868"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb868-1"><a aria-hidden="true" href="#cb868-1" tabindex="-1"></a><span class="co">// 20 cached patterns √ó ~500 bytes average = ~10KB</span></span>
<span id="cb868-2"><a aria-hidden="true" href="#cb868-2" tabindex="-1"></a><span class="co">// Plus fastmaps: 20 √ó 256 bytes = ~5KB</span></span>
<span id="cb868-3"><a aria-hidden="true" href="#cb868-3" tabindex="-1"></a><span class="co">// Total: ~15KB for regex cache</span></span></code></pre></div>
<p><strong>Search Registers:</strong></p>
<div class="sourceCode" id="cb869"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb869-1"><a aria-hidden="true" href="#cb869-1" tabindex="-1"></a><span class="co">// Match data for up to 255 subexpressions</span></span>
<span id="cb869-2"><a aria-hidden="true" href="#cb869-2" tabindex="-1"></a><span class="co">// 2 positions per group √ó sizeof(ptrdiff_t)</span></span>
<span id="cb869-3"><a aria-hidden="true" href="#cb869-3" tabindex="-1"></a><span class="co">// Typical: 10 groups √ó 2 √ó 8 bytes = 160 bytes</span></span></code></pre></div>
<h3 data-number="21.9.3" id="optimization-strategies-4"><span class="header-section-number">21.9.3</span> Optimization Strategies</h3>
<h4 data-number="21.9.3.1" id="regex-caching"><span class="header-section-number">21.9.3.1</span> 1. Regex Caching</h4>
<div class="sourceCode" id="cb870"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb870-1"><a aria-hidden="true" href="#cb870-1" tabindex="-1"></a><span class="co">// Cache hit: ~0¬µs (pointer comparison)</span></span>
<span id="cb870-2"><a aria-hidden="true" href="#cb870-2" tabindex="-1"></a><span class="co">// Cache miss: ~100-1000¬µs (compilation time)</span></span>
<span id="cb870-3"><a aria-hidden="true" href="#cb870-3" tabindex="-1"></a><span class="co">// ‚Üí Keep frequently-used patterns cached</span></span></code></pre></div>
<h4 data-number="21.9.3.2" id="fastmap-usage"><span class="header-section-number">21.9.3.2</span> 2. Fastmap Usage</h4>
<div class="sourceCode" id="cb871"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb871-1"><a aria-hidden="true" href="#cb871-1" tabindex="-1"></a><span class="co">// Without fastmap: O(nm) per attempt</span></span>
<span id="cb871-2"><a aria-hidden="true" href="#cb871-2" tabindex="-1"></a><span class="co">// With fastmap: O(n) to scan + O(m) per valid attempt</span></span>
<span id="cb871-3"><a aria-hidden="true" href="#cb871-3" tabindex="-1"></a><span class="co">// ‚Üí Huge win for rare patterns in large text</span></span></code></pre></div>
<h4 data-number="21.9.3.3" id="boyer-moore-conditions"><span class="header-section-number">21.9.3.3</span> 3. Boyer-Moore
Conditions</h4>
<div class="sourceCode" id="cb872"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb872-1"><a aria-hidden="true" href="#cb872-1" tabindex="-1"></a><span class="co">// Boyer-Moore is ~3-10√ó faster than simple search</span></span>
<span id="cb872-2"><a aria-hidden="true" href="#cb872-2" tabindex="-1"></a><span class="co">// Use when:</span></span>
<span id="cb872-3"><a aria-hidden="true" href="#cb872-3" tabindex="-1"></a><span class="co">// - No case folding OR simple case folding</span></span>
<span id="cb872-4"><a aria-hidden="true" href="#cb872-4" tabindex="-1"></a><span class="co">// - No character translation</span></span>
<span id="cb872-5"><a aria-hidden="true" href="#cb872-5" tabindex="-1"></a><span class="co">// - Pattern length &gt; 2 characters</span></span></code></pre></div>
<h4 data-number="21.9.3.4" id="lazy-highlighting-limits"><span class="header-section-number">21.9.3.4</span> 4. Lazy Highlighting
Limits</h4>
<pre class="elisp"><code>;; Don't highlight too many matches
(defcustom isearch-lazy-highlight-max-at-a-time 20
  "Maximum matches to highlight at a time.")

;; Don't search too far
(defvar isearch-lazy-highlight-max nil
  "Maximum number of matches to highlight.")</code></pre>
<h3 data-number="21.9.4" id="performance-tips-for-users"><span class="header-section-number">21.9.4</span> Performance Tips for
Users</h3>
<ol type="1">
<li><strong>Use literal search when possible</strong> (not regex)
<ul>
<li>Boyer-Moore is much faster</li>
<li>Less CPU per keystroke in isearch</li>
</ul></li>
<li><strong>Anchor regexes when possible</strong>
<ul>
<li><code>^foo</code> or <code>foo$</code> skip impossible
positions</li>
<li>Fastmap can optimize better</li>
</ul></li>
<li><strong>Avoid catastrophic backtracking</strong>
<ul>
<li>Pattern <code>(a+)+b</code> on ‚Äúaaaaaa‚Ä¶‚Äù is exponential</li>
<li>Use possessive/atomic groups if available</li>
</ul></li>
<li><strong>Use word/symbol search</strong>
<ul>
<li><code>M-s w</code> for word search</li>
<li>Automatically anchors with <code>\&lt;...\&gt;</code></li>
</ul></li>
</ol>
<hr/>
<h2 data-number="21.10" id="api-reference"><span class="header-section-number">21.10</span> API Reference</h2>
<h3 data-number="21.10.1" id="c-functions"><span class="header-section-number">21.10.1</span> C Functions</h3>
<h4 data-number="21.10.1.1" id="search-functions"><span class="header-section-number">21.10.1.1</span> Search Functions</h4>
<div class="sourceCode" id="cb874"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb874-1"><a aria-hidden="true" href="#cb874-1" tabindex="-1"></a><span class="co">// search.c</span></span>
<span id="cb874-2"><a aria-hidden="true" href="#cb874-2" tabindex="-1"></a>Lisp_Object search_buffer<span class="op">(</span>Lisp_Object string<span class="op">,</span> <span class="dt">ptrdiff_t</span> pos<span class="op">,</span></span>
<span id="cb874-3"><a aria-hidden="true" href="#cb874-3" tabindex="-1"></a>                         <span class="dt">ptrdiff_t</span> pos_byte<span class="op">,</span> <span class="dt">ptrdiff_t</span> lim<span class="op">,</span></span>
<span id="cb874-4"><a aria-hidden="true" href="#cb874-4" tabindex="-1"></a>                         <span class="dt">ptrdiff_t</span> lim_byte<span class="op">,</span> EMACS_INT n<span class="op">,</span></span>
<span id="cb874-5"><a aria-hidden="true" href="#cb874-5" tabindex="-1"></a>                         <span class="dt">int</span> RE<span class="op">,</span> Lisp_Object trt<span class="op">,</span></span>
<span id="cb874-6"><a aria-hidden="true" href="#cb874-6" tabindex="-1"></a>                         Lisp_Object inverse_trt<span class="op">,</span> <span class="dt">bool</span> posix<span class="op">);</span></span>
<span id="cb874-7"><a aria-hidden="true" href="#cb874-7" tabindex="-1"></a></span>
<span id="cb874-8"><a aria-hidden="true" href="#cb874-8" tabindex="-1"></a>DEFUN<span class="op">(</span><span class="st">"search-forward"</span><span class="op">,</span> Fsearch_forward<span class="op">,</span> Ssearch_forward<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">4</span><span class="op">,</span> <span class="st">"MSearch: "</span><span class="op">,</span></span>
<span id="cb874-9"><a aria-hidden="true" href="#cb874-9" tabindex="-1"></a>      doc<span class="op">:</span> <span class="co">/* Search forward for STRING... */</span><span class="op">);</span></span>
<span id="cb874-10"><a aria-hidden="true" href="#cb874-10" tabindex="-1"></a></span>
<span id="cb874-11"><a aria-hidden="true" href="#cb874-11" tabindex="-1"></a>DEFUN<span class="op">(</span><span class="st">"re-search-forward"</span><span class="op">,</span> Fre_search_forward<span class="op">,</span> Sre_search_forward<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">4</span><span class="op">,</span></span>
<span id="cb874-12"><a aria-hidden="true" href="#cb874-12" tabindex="-1"></a>      doc<span class="op">:</span> <span class="co">/* Search forward for regular expression REGEXP... */</span><span class="op">);</span></span></code></pre></div>
<h4 data-number="21.10.1.2" id="regex-functions"><span class="header-section-number">21.10.1.2</span> Regex Functions</h4>
<div class="sourceCode" id="cb875"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb875-1"><a aria-hidden="true" href="#cb875-1" tabindex="-1"></a><span class="co">// regex-emacs.c</span></span>
<span id="cb875-2"><a aria-hidden="true" href="#cb875-2" tabindex="-1"></a><span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>re_compile_pattern<span class="op">(</span><span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>pattern<span class="op">,</span> <span class="dt">ptrdiff_t</span> length<span class="op">,</span></span>
<span id="cb875-3"><a aria-hidden="true" href="#cb875-3" tabindex="-1"></a>                               <span class="dt">bool</span> posix_backtracking<span class="op">,</span></span>
<span id="cb875-4"><a aria-hidden="true" href="#cb875-4" tabindex="-1"></a>                               <span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>whitespace_regexp<span class="op">,</span></span>
<span id="cb875-5"><a aria-hidden="true" href="#cb875-5" tabindex="-1"></a>                               <span class="kw">struct</span> re_pattern_buffer <span class="op">*</span>bufp<span class="op">);</span></span>
<span id="cb875-6"><a aria-hidden="true" href="#cb875-6" tabindex="-1"></a></span>
<span id="cb875-7"><a aria-hidden="true" href="#cb875-7" tabindex="-1"></a><span class="dt">ptrdiff_t</span> re_search<span class="op">(</span><span class="kw">struct</span> re_pattern_buffer <span class="op">*</span>bufp<span class="op">,</span></span>
<span id="cb875-8"><a aria-hidden="true" href="#cb875-8" tabindex="-1"></a>                   <span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>string<span class="op">,</span> <span class="dt">ptrdiff_t</span> size<span class="op">,</span></span>
<span id="cb875-9"><a aria-hidden="true" href="#cb875-9" tabindex="-1"></a>                   <span class="dt">ptrdiff_t</span> startpos<span class="op">,</span> <span class="dt">ptrdiff_t</span> range<span class="op">,</span></span>
<span id="cb875-10"><a aria-hidden="true" href="#cb875-10" tabindex="-1"></a>                   <span class="kw">struct</span> re_registers <span class="op">*</span>regs<span class="op">);</span></span>
<span id="cb875-11"><a aria-hidden="true" href="#cb875-11" tabindex="-1"></a></span>
<span id="cb875-12"><a aria-hidden="true" href="#cb875-12" tabindex="-1"></a><span class="dt">ptrdiff_t</span> re_match<span class="op">(</span><span class="kw">struct</span> re_pattern_buffer <span class="op">*</span>bufp<span class="op">,</span></span>
<span id="cb875-13"><a aria-hidden="true" href="#cb875-13" tabindex="-1"></a>                  <span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>string<span class="op">,</span> <span class="dt">ptrdiff_t</span> size<span class="op">,</span></span>
<span id="cb875-14"><a aria-hidden="true" href="#cb875-14" tabindex="-1"></a>                  <span class="dt">ptrdiff_t</span> pos<span class="op">,</span> <span class="kw">struct</span> re_registers <span class="op">*</span>regs<span class="op">);</span></span></code></pre></div>
<h4 data-number="21.10.1.3" id="syntax-functions"><span class="header-section-number">21.10.1.3</span> Syntax Functions</h4>
<div class="sourceCode" id="cb876"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb876-1"><a aria-hidden="true" href="#cb876-1" tabindex="-1"></a><span class="co">// syntax.c</span></span>
<span id="cb876-2"><a aria-hidden="true" href="#cb876-2" tabindex="-1"></a>DEFUN<span class="op">(</span><span class="st">"char-syntax"</span><span class="op">,</span> Fchar_syntax<span class="op">,</span> Schar_syntax<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb876-3"><a aria-hidden="true" href="#cb876-3" tabindex="-1"></a>      doc<span class="op">:</span> <span class="co">/* Return syntax code of CHARACTER... */</span><span class="op">);</span></span>
<span id="cb876-4"><a aria-hidden="true" href="#cb876-4" tabindex="-1"></a></span>
<span id="cb876-5"><a aria-hidden="true" href="#cb876-5" tabindex="-1"></a>DEFUN<span class="op">(</span><span class="st">"modify-syntax-entry"</span><span class="op">,</span> Fmodify_syntax_entry<span class="op">,</span> Smodify_syntax_entry<span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span><span class="op">,</span></span>
<span id="cb876-6"><a aria-hidden="true" href="#cb876-6" tabindex="-1"></a>      doc<span class="op">:</span> <span class="co">/* Set syntax for character CHAR according to NEWENTRY... */</span><span class="op">);</span></span>
<span id="cb876-7"><a aria-hidden="true" href="#cb876-7" tabindex="-1"></a></span>
<span id="cb876-8"><a aria-hidden="true" href="#cb876-8" tabindex="-1"></a>DEFUN<span class="op">(</span><span class="st">"scan-lists"</span><span class="op">,</span> Fscan_lists<span class="op">,</span> Sscan_lists<span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb876-9"><a aria-hidden="true" href="#cb876-9" tabindex="-1"></a>      doc<span class="op">:</span> <span class="co">/* Scan from character FROM by COUNT balanced expressions... */</span><span class="op">);</span></span>
<span id="cb876-10"><a aria-hidden="true" href="#cb876-10" tabindex="-1"></a></span>
<span id="cb876-11"><a aria-hidden="true" href="#cb876-11" tabindex="-1"></a>DEFUN<span class="op">(</span><span class="st">"scan-sexps"</span><span class="op">,</span> Fscan_sexps<span class="op">,</span> Sscan_sexps<span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb876-12"><a aria-hidden="true" href="#cb876-12" tabindex="-1"></a>      doc<span class="op">:</span> <span class="co">/* Scan from FROM by ARG s-expressions... */</span><span class="op">);</span></span>
<span id="cb876-13"><a aria-hidden="true" href="#cb876-13" tabindex="-1"></a></span>
<span id="cb876-14"><a aria-hidden="true" href="#cb876-14" tabindex="-1"></a>DEFUN<span class="op">(</span><span class="st">"parse-partial-sexp"</span><span class="op">,</span> Fparse_partial_sexp<span class="op">,</span> Sparse_partial_sexp<span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">6</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb876-15"><a aria-hidden="true" href="#cb876-15" tabindex="-1"></a>      doc<span class="op">:</span> <span class="co">/* Parse Lisp syntax starting at FROM until TO... */</span><span class="op">);</span></span></code></pre></div>
<h4 data-number="21.10.1.4" id="case-functions"><span class="header-section-number">21.10.1.4</span> Case Functions</h4>
<div class="sourceCode" id="cb877"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb877-1"><a aria-hidden="true" href="#cb877-1" tabindex="-1"></a><span class="co">// casefiddle.c</span></span>
<span id="cb877-2"><a aria-hidden="true" href="#cb877-2" tabindex="-1"></a>DEFUN<span class="op">(</span><span class="st">"upcase"</span><span class="op">,</span> Fupcase<span class="op">,</span> Supcase<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb877-3"><a aria-hidden="true" href="#cb877-3" tabindex="-1"></a>      doc<span class="op">:</span> <span class="co">/* Convert argument to upper case... */</span><span class="op">);</span></span>
<span id="cb877-4"><a aria-hidden="true" href="#cb877-4" tabindex="-1"></a></span>
<span id="cb877-5"><a aria-hidden="true" href="#cb877-5" tabindex="-1"></a>DEFUN<span class="op">(</span><span class="st">"downcase"</span><span class="op">,</span> Fdowncase<span class="op">,</span> Sdowncase<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb877-6"><a aria-hidden="true" href="#cb877-6" tabindex="-1"></a>      doc<span class="op">:</span> <span class="co">/* Convert argument to lower case... */</span><span class="op">);</span></span>
<span id="cb877-7"><a aria-hidden="true" href="#cb877-7" tabindex="-1"></a></span>
<span id="cb877-8"><a aria-hidden="true" href="#cb877-8" tabindex="-1"></a>DEFUN<span class="op">(</span><span class="st">"capitalize"</span><span class="op">,</span> Fcapitalize<span class="op">,</span> Scapitalize<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb877-9"><a aria-hidden="true" href="#cb877-9" tabindex="-1"></a>      doc<span class="op">:</span> <span class="co">/* Convert argument to capitalized form... */</span><span class="op">);</span></span>
<span id="cb877-10"><a aria-hidden="true" href="#cb877-10" tabindex="-1"></a></span>
<span id="cb877-11"><a aria-hidden="true" href="#cb877-11" tabindex="-1"></a>DEFUN<span class="op">(</span><span class="st">"upcase-region"</span><span class="op">,</span> Fupcase_region<span class="op">,</span> Supcase_region<span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span><span class="op">,</span></span>
<span id="cb877-12"><a aria-hidden="true" href="#cb877-12" tabindex="-1"></a>      <span class="st">"(list (region-beginning) (region-end) (region-noncontiguous-p))"</span><span class="op">,</span></span>
<span id="cb877-13"><a aria-hidden="true" href="#cb877-13" tabindex="-1"></a>      doc<span class="op">:</span> <span class="co">/* Convert the region to upper case... */</span><span class="op">);</span></span></code></pre></div>
<h3 data-number="21.10.2" id="elisp-functions"><span class="header-section-number">21.10.2</span> Elisp Functions</h3>
<h4 data-number="21.10.2.1" id="search-commands"><span class="header-section-number">21.10.2.1</span> Search Commands</h4>
<pre class="elisp"><code>;; Basic search
(search-forward STRING &amp;optional BOUND NOERROR COUNT)
(search-backward STRING &amp;optional BOUND NOERROR COUNT)

;; Regex search
(re-search-forward REGEXP &amp;optional BOUND NOERROR COUNT)
(re-search-backward REGEXP &amp;optional BOUND NOERROR COUNT)

;; POSIX regex
(posix-search-forward REGEXP &amp;optional BOUND NOERROR COUNT)
(posix-search-backward REGEXP &amp;optional BOUND NOERROR COUNT)

;; String matching (no buffer movement)
(string-match REGEXP STRING &amp;optional START)
(string-match-p REGEXP STRING &amp;optional START)  ; No match data
(looking-at REGEXP)
(looking-at-p REGEXP)  ; No match data</code></pre>
<h4 data-number="21.10.2.2" id="match-data"><span class="header-section-number">21.10.2.2</span> Match Data</h4>
<pre class="elisp"><code>;; Access match results
(match-beginning SUBEXP)  ; Start of match/group
(match-end SUBEXP)        ; End of match/group
(match-string SUBEXP &amp;optional STRING)  ; Extract matched text
(match-data)              ; All match positions
(set-match-data LIST)     ; Restore match positions

;; Replacement
(replace-match NEWTEXT &amp;optional FIXEDCASE LITERAL STRING SUBEXP)</code></pre>
<h4 data-number="21.10.2.3" id="syntax-functions-1"><span class="header-section-number">21.10.2.3</span> Syntax Functions</h4>
<pre class="elisp"><code>;; Syntax table operations
(char-syntax CHAR)
(modify-syntax-entry CHAR NEWENTRY &amp;optional SYNTAX-TABLE)
(set-syntax-table TABLE)

;; Parsing
(scan-lists FROM COUNT DEPTH)
(scan-sexps FROM COUNT)
(parse-partial-sexp FROM TO &amp;optional TARGETDEPTH STOPBEFORE OLDSTATE COMMENTSTOP)

;; Navigation
(forward-word &amp;optional ARG)
(backward-word &amp;optional ARG)
(forward-sexp &amp;optional ARG)
(backward-sexp &amp;optional ARG)</code></pre>
<h4 data-number="21.10.2.4" id="case-functions-1"><span class="header-section-number">21.10.2.4</span> Case Functions</h4>
<pre class="elisp"><code>;; String/character casing
(upcase OBJ)
(downcase OBJ)
(capitalize OBJ)
(upcase-initials OBJ)

;; Region casing
(upcase-region START END)
(downcase-region START END)
(capitalize-region START END)

;; Word casing
(upcase-word ARG)
(downcase-word ARG)
(capitalize-word ARG)</code></pre>
<h4 data-number="21.10.2.5" id="interactive-search"><span class="header-section-number">21.10.2.5</span> Interactive Search</h4>
<pre class="elisp"><code>;; Incremental search
(isearch-forward &amp;optional REGEXP-P NO-RECURSIVE-EDIT)
(isearch-backward &amp;optional REGEXP-P NO-RECURSIVE-EDIT)
(isearch-forward-regexp &amp;optional NOT-REGEXP NO-RECURSIVE-EDIT)
(isearch-backward-regexp &amp;optional NOT-REGEXP NO-RECURSIVE-EDIT)

;; Search modes
(isearch-toggle-case-fold)
(isearch-toggle-regexp)
(isearch-toggle-word)
(isearch-toggle-symbol)
(isearch-toggle-char-fold)</code></pre>
<hr/>
<h2 data-number="21.11" id="related-documentation-1"><span class="header-section-number">21.11</span> Related Documentation</h2>
<ul>
<li><strong>Buffer Management</strong>:
<code>04-buffer-management/01-buffer-core.md</code> - Gap buffer
structure</li>
<li><strong>Display Engine</strong>:
<code>05-display-engine/01-redisplay.md</code> - Highlighting
matches</li>
<li><strong>Elisp Runtime</strong>:
<code>03-elisp-runtime/02-core-types.md</code> - String and character
types</li>
<li><strong>Character Handling</strong>:
<code>15-internationalization/01-character-sets.md</code> - Unicode
support</li>
<li><strong>Syntax Tables</strong>: Detailed syntax table documentation
(if separate doc exists)</li>
</ul>
<hr/>
<h2 data-number="21.12" id="references-5"><span class="header-section-number">21.12</span> References</h2>
<h3 data-number="21.12.1" id="source-files-1"><span class="header-section-number">21.12.1</span> Source Files</h3>
<ul>
<li><code>src/search.c</code> - String search implementation (3,514
lines)</li>
<li><code>src/regex-emacs.c</code> - Regular expression engine (5,355
lines)</li>
<li><code>src/syntax.c</code> - Syntax table implementation (3,831
lines)</li>
<li><code>src/casefiddle.c</code> - Case conversion (764 lines)</li>
<li><code>src/regex-emacs.h</code> - Regex API and structures</li>
<li><code>src/syntax.h</code> - Syntax classes and macros</li>
</ul>
<h3 data-number="21.12.2" id="elisp-files"><span class="header-section-number">21.12.2</span> Elisp Files</h3>
<ul>
<li><code>lisp/isearch.el</code> - Incremental search</li>
<li><code>lisp/emacs-lisp/re-builder.el</code> - Interactive regex
development</li>
<li><code>lisp/char-fold.el</code> - Character folding for Unicode
matching</li>
<li><code>lisp/replace.el</code> - Search and replace commands</li>
<li><code>lisp/emacs-lisp/rx.el</code> - Symbolic regex syntax</li>
</ul>
<h3 data-number="21.12.3" id="documentation-1"><span class="header-section-number">21.12.3</span> Documentation</h3>
<ul>
<li>Emacs Lisp Manual: (elisp) Searching and Matching</li>
<li>Emacs Lisp Manual: (elisp) Syntax Tables</li>
<li>Emacs Manual: (emacs) Search</li>
<li>Emacs Manual: (emacs) Regexps</li>
</ul>
<h3 data-number="21.12.4" id="external-references"><span class="header-section-number">21.12.4</span> External References</h3>
<ul>
<li>Boyer-Moore Algorithm: Boyer, R.S., and Moore, J.S. (1977)</li>
<li>Unicode Case Mapping: Unicode Standard Annex #21</li>
<li>POSIX Regular Expressions: POSIX.2 (IEEE Std 1003.2)</li>
<li>Regular Expression Matching: Thompson, K. (1968), ‚ÄúRegular
Expression Search Algorithm‚Äù</li>
</ul>
<hr/>
<p><strong>Document History:</strong> - 2025-11-18: Initial
comprehensive documentation of text processing subsystem - Covers search
algorithms, regex engine, syntax tables, and case handling - Includes
performance characteristics and API reference</p>
<h1 data-number="22" id="emacs-build-system-and-testing-infrastructure"><span class="header-section-number">22</span> Emacs Build System and Testing
Infrastructure</h1>
<p><strong>Comprehensive guide to building, testing, and developing GNU
Emacs</strong></p>
<hr/>
<h2 data-number="22.1" id="table-of-contents-10"><span class="header-section-number">22.1</span> Table of Contents</h2>
<ul>
<li><a href="#1-build-system-architecture">1. Build System
Architecture</a></li>
<li><a href="#2-testing-infrastructure">2. Testing
Infrastructure</a></li>
<li><a href="#3-development-workflow">3. Development Workflow</a></li>
<li><a href="#4-quality-assurance">4. Quality Assurance</a></li>
<li><a href="#5-platform-specific-information">5. Platform-Specific
Information</a></li>
<li><a href="#6-continuous-integration">6. Continuous
Integration</a></li>
</ul>
<hr/>
<h2 data-number="22.2" id="build-system-architecture"><span class="header-section-number">22.2</span> 1. Build System
Architecture</h2>
<h3 data-number="22.2.1" id="overview-10"><span class="header-section-number">22.2.1</span> 1.1 Overview</h3>
<p>Emacs uses the GNU Autotools build system (Autoconf/Automake) to
provide portable configuration and building across diverse platforms.
The build system consists of:</p>
<ul>
<li><strong>configure.ac</strong> (273KB): Main configuration script
template</li>
<li><strong>Makefile.in</strong>: Top-level makefile template</li>
<li><strong>autogen.sh</strong>: Bootstrap script for repository
builds</li>
<li><strong>GNUmakefile</strong>: Convenience wrapper for unconfigured
builds</li>
<li><strong>m4/</strong>: 151 m4 macro files for feature detection</li>
<li><strong>build-aux/</strong>: Build helper scripts and tools</li>
</ul>
<h3 data-number="22.2.2" id="autoconfautomake-architecture"><span class="header-section-number">22.2.2</span> 1.2 Autoconf/Automake
Architecture</h3>
<h4 data-number="22.2.2.1" id="configuration-process-flow"><span class="header-section-number">22.2.2.1</span> Configuration Process
Flow</h4>
<pre><code>Repository Checkout
    ‚Üì
autogen.sh          # Generate configure script
    ‚Üì
configure           # Detect system features
    ‚Üì
config.status       # Generate Makefiles and config.h
    ‚Üì
make                # Build Emacs</code></pre>
<h4 data-number="22.2.2.2" id="key-configuration-files"><span class="header-section-number">22.2.2.2</span> Key Configuration
Files</h4>
<p><strong>configure.ac</strong> - Main configuration script (2.65+
required):</p>
<div class="sourceCode" id="cb884"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb884-1"><a aria-hidden="true" href="#cb884-1" tabindex="-1"></a><span class="co"># Minimum autoconf version requirement</span></span>
<span id="cb884-2"><a aria-hidden="true" href="#cb884-2" tabindex="-1"></a><span class="ex">AC_PREREQ</span><span class="er">(</span><span class="ex">[2.65]</span><span class="kw">)</span></span>
<span id="cb884-3"><a aria-hidden="true" href="#cb884-3" tabindex="-1"></a></span>
<span id="cb884-4"><a aria-hidden="true" href="#cb884-4" tabindex="-1"></a><span class="co"># Package definition</span></span>
<span id="cb884-5"><a aria-hidden="true" href="#cb884-5" tabindex="-1"></a><span class="ex">AC_INIT</span><span class="er">(</span><span class="ex">[GNU</span> Emacs], <span class="pp">[</span><span class="ss">31.0.50</span><span class="pp">]</span>, <span class="pp">[</span><span class="ss">bug</span><span class="pp">-</span><span class="ss">gnu</span><span class="pp">-</span><span class="ss">emacs@gnu.org</span><span class="pp">]</span><span class="kw">)</span></span>
<span id="cb884-6"><a aria-hidden="true" href="#cb884-6" tabindex="-1"></a></span>
<span id="cb884-7"><a aria-hidden="true" href="#cb884-7" tabindex="-1"></a><span class="co"># Key configuration sections:</span></span>
<span id="cb884-8"><a aria-hidden="true" href="#cb884-8" tabindex="-1"></a><span class="co"># - System type detection</span></span>
<span id="cb884-9"><a aria-hidden="true" href="#cb884-9" tabindex="-1"></a><span class="co"># - Compiler and tool checks</span></span>
<span id="cb884-10"><a aria-hidden="true" href="#cb884-10" tabindex="-1"></a><span class="co"># - Library dependency detection</span></span>
<span id="cb884-11"><a aria-hidden="true" href="#cb884-11" tabindex="-1"></a><span class="co"># - Feature option processing</span></span>
<span id="cb884-12"><a aria-hidden="true" href="#cb884-12" tabindex="-1"></a><span class="co"># - Platform-specific adaptations</span></span></code></pre></div>
<p><strong>aclocal.m4</strong> - Auto-generated from m4/ directory:</p>
<div class="sourceCode" id="cb885"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb885-1"><a aria-hidden="true" href="#cb885-1" tabindex="-1"></a><span class="co"># Built by autogen.sh from all m4/*.m4 files</span></span>
<span id="cb885-2"><a aria-hidden="true" href="#cb885-2" tabindex="-1"></a><span class="fu">ls</span> m4/<span class="pp">*</span>.m4 <span class="kw">|</span> <span class="va">LC_ALL</span><span class="op">=</span>C <span class="fu">sort</span> <span class="kw">|</span> <span class="fu">sed</span> <span class="st">'s,.*\.m4$,m4_include([&amp;]),'</span> <span class="op">&gt;</span> aclocal.m4</span></code></pre></div>
<h3 data-number="22.2.3" id="building-from-source"><span class="header-section-number">22.2.3</span> 1.3 Building from
Source</h3>
<h4 data-number="22.2.3.1" id="quick-start-release-tarball"><span class="header-section-number">22.2.3.1</span> Quick Start (Release
Tarball)</h4>
<div class="sourceCode" id="cb886"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb886-1"><a aria-hidden="true" href="#cb886-1" tabindex="-1"></a><span class="co"># 1. Download and extract</span></span>
<span id="cb886-2"><a aria-hidden="true" href="#cb886-2" tabindex="-1"></a><span class="fu">wget</span> https://ftp.gnu.org/gnu/emacs/emacs-VERSION.tar.xz</span>
<span id="cb886-3"><a aria-hidden="true" href="#cb886-3" tabindex="-1"></a><span class="fu">tar</span> <span class="at">-xf</span> emacs-VERSION.tar.xz</span>
<span id="cb886-4"><a aria-hidden="true" href="#cb886-4" tabindex="-1"></a><span class="bu">cd</span> emacs-VERSION</span>
<span id="cb886-5"><a aria-hidden="true" href="#cb886-5" tabindex="-1"></a></span>
<span id="cb886-6"><a aria-hidden="true" href="#cb886-6" tabindex="-1"></a><span class="co"># 2. Configure</span></span>
<span id="cb886-7"><a aria-hidden="true" href="#cb886-7" tabindex="-1"></a><span class="ex">./configure</span></span>
<span id="cb886-8"><a aria-hidden="true" href="#cb886-8" tabindex="-1"></a></span>
<span id="cb886-9"><a aria-hidden="true" href="#cb886-9" tabindex="-1"></a><span class="co"># 3. Build</span></span>
<span id="cb886-10"><a aria-hidden="true" href="#cb886-10" tabindex="-1"></a><span class="fu">make</span></span>
<span id="cb886-11"><a aria-hidden="true" href="#cb886-11" tabindex="-1"></a></span>
<span id="cb886-12"><a aria-hidden="true" href="#cb886-12" tabindex="-1"></a><span class="co"># 4. Test (optional)</span></span>
<span id="cb886-13"><a aria-hidden="true" href="#cb886-13" tabindex="-1"></a><span class="ex">src/emacs</span> <span class="at">-Q</span></span>
<span id="cb886-14"><a aria-hidden="true" href="#cb886-14" tabindex="-1"></a></span>
<span id="cb886-15"><a aria-hidden="true" href="#cb886-15" tabindex="-1"></a><span class="co"># 5. Install</span></span>
<span id="cb886-16"><a aria-hidden="true" href="#cb886-16" tabindex="-1"></a><span class="fu">sudo</span> make install</span></code></pre></div>
<h4 data-number="22.2.3.2" id="building-from-repository"><span class="header-section-number">22.2.3.2</span> Building from
Repository</h4>
<div class="sourceCode" id="cb887"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb887-1"><a aria-hidden="true" href="#cb887-1" tabindex="-1"></a><span class="co"># 1. Clone repository</span></span>
<span id="cb887-2"><a aria-hidden="true" href="#cb887-2" tabindex="-1"></a><span class="fu">git</span> clone https://git.savannah.gnu.org/git/emacs.git</span>
<span id="cb887-3"><a aria-hidden="true" href="#cb887-3" tabindex="-1"></a><span class="bu">cd</span> emacs</span>
<span id="cb887-4"><a aria-hidden="true" href="#cb887-4" tabindex="-1"></a></span>
<span id="cb887-5"><a aria-hidden="true" href="#cb887-5" tabindex="-1"></a><span class="co"># 2. Generate build system</span></span>
<span id="cb887-6"><a aria-hidden="true" href="#cb887-6" tabindex="-1"></a><span class="ex">./autogen.sh</span></span>
<span id="cb887-7"><a aria-hidden="true" href="#cb887-7" tabindex="-1"></a></span>
<span id="cb887-8"><a aria-hidden="true" href="#cb887-8" tabindex="-1"></a><span class="co"># 3. Configure with debug options</span></span>
<span id="cb887-9"><a aria-hidden="true" href="#cb887-9" tabindex="-1"></a><span class="ex">./configure</span> CFLAGS=<span class="st">'-O0 -g3'</span> <span class="at">--enable-checking</span><span class="op">=</span>all</span>
<span id="cb887-10"><a aria-hidden="true" href="#cb887-10" tabindex="-1"></a></span>
<span id="cb887-11"><a aria-hidden="true" href="#cb887-11" tabindex="-1"></a><span class="co"># 4. Build</span></span>
<span id="cb887-12"><a aria-hidden="true" href="#cb887-12" tabindex="-1"></a><span class="fu">make</span></span>
<span id="cb887-13"><a aria-hidden="true" href="#cb887-13" tabindex="-1"></a></span>
<span id="cb887-14"><a aria-hidden="true" href="#cb887-14" tabindex="-1"></a><span class="co"># 5. Run tests</span></span>
<span id="cb887-15"><a aria-hidden="true" href="#cb887-15" tabindex="-1"></a><span class="fu">make</span> check</span></code></pre></div>
<h4 data-number="22.2.3.3" id="out-of-tree-builds"><span class="header-section-number">22.2.3.3</span> Out-of-Tree Builds</h4>
<div class="sourceCode" id="cb888"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb888-1"><a aria-hidden="true" href="#cb888-1" tabindex="-1"></a><span class="co"># Create separate build directory</span></span>
<span id="cb888-2"><a aria-hidden="true" href="#cb888-2" tabindex="-1"></a><span class="fu">mkdir</span> build</span>
<span id="cb888-3"><a aria-hidden="true" href="#cb888-3" tabindex="-1"></a><span class="bu">cd</span> build</span>
<span id="cb888-4"><a aria-hidden="true" href="#cb888-4" tabindex="-1"></a></span>
<span id="cb888-5"><a aria-hidden="true" href="#cb888-5" tabindex="-1"></a><span class="co"># Configure from source directory</span></span>
<span id="cb888-6"><a aria-hidden="true" href="#cb888-6" tabindex="-1"></a><span class="ex">../emacs/configure</span></span>
<span id="cb888-7"><a aria-hidden="true" href="#cb888-7" tabindex="-1"></a></span>
<span id="cb888-8"><a aria-hidden="true" href="#cb888-8" tabindex="-1"></a><span class="co"># Build (source remains clean)</span></span>
<span id="cb888-9"><a aria-hidden="true" href="#cb888-9" tabindex="-1"></a><span class="fu">make</span></span></code></pre></div>
<h3 data-number="22.2.4" id="configure-options"><span class="header-section-number">22.2.4</span> 1.4 Configure Options</h3>
<h4 data-number="22.2.4.1" id="essential-build-options"><span class="header-section-number">22.2.4.1</span> Essential Build
Options</h4>
<div class="sourceCode" id="cb889"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb889-1"><a aria-hidden="true" href="#cb889-1" tabindex="-1"></a><span class="co"># Installation prefix</span></span>
<span id="cb889-2"><a aria-hidden="true" href="#cb889-2" tabindex="-1"></a><span class="ex">./configure</span> <span class="at">--prefix</span><span class="op">=</span>/opt/emacs</span>
<span id="cb889-3"><a aria-hidden="true" href="#cb889-3" tabindex="-1"></a></span>
<span id="cb889-4"><a aria-hidden="true" href="#cb889-4" tabindex="-1"></a><span class="co"># Debugging build (recommended for development)</span></span>
<span id="cb889-5"><a aria-hidden="true" href="#cb889-5" tabindex="-1"></a><span class="ex">./configure</span> <span class="dt">\</span></span>
<span id="cb889-6"><a aria-hidden="true" href="#cb889-6" tabindex="-1"></a>    <span class="at">--enable-checking</span><span class="op">=</span><span class="st">'yes,glyphs'</span> <span class="dt">\</span></span>
<span id="cb889-7"><a aria-hidden="true" href="#cb889-7" tabindex="-1"></a>    <span class="at">--enable-check-lisp-object-type</span> <span class="dt">\</span></span>
<span id="cb889-8"><a aria-hidden="true" href="#cb889-8" tabindex="-1"></a>    CFLAGS=<span class="st">'-O0 -g3'</span></span>
<span id="cb889-9"><a aria-hidden="true" href="#cb889-9" tabindex="-1"></a></span>
<span id="cb889-10"><a aria-hidden="true" href="#cb889-10" tabindex="-1"></a><span class="co"># Native compilation support</span></span>
<span id="cb889-11"><a aria-hidden="true" href="#cb889-11" tabindex="-1"></a><span class="ex">./configure</span> <span class="at">--with-native-compilation</span></span>
<span id="cb889-12"><a aria-hidden="true" href="#cb889-12" tabindex="-1"></a></span>
<span id="cb889-13"><a aria-hidden="true" href="#cb889-13" tabindex="-1"></a><span class="co"># Portable dumper (default since Emacs 27)</span></span>
<span id="cb889-14"><a aria-hidden="true" href="#cb889-14" tabindex="-1"></a><span class="ex">./configure</span> <span class="at">--with-dumping</span><span class="op">=</span>pdumper</span>
<span id="cb889-15"><a aria-hidden="true" href="#cb889-15" tabindex="-1"></a></span>
<span id="cb889-16"><a aria-hidden="true" href="#cb889-16" tabindex="-1"></a><span class="co"># Disable graphical features</span></span>
<span id="cb889-17"><a aria-hidden="true" href="#cb889-17" tabindex="-1"></a><span class="ex">./configure</span> <span class="at">--without-x</span> <span class="at">--without-ns</span></span>
<span id="cb889-18"><a aria-hidden="true" href="#cb889-18" tabindex="-1"></a></span>
<span id="cb889-19"><a aria-hidden="true" href="#cb889-19" tabindex="-1"></a><span class="co"># Minimal build</span></span>
<span id="cb889-20"><a aria-hidden="true" href="#cb889-20" tabindex="-1"></a><span class="ex">./configure</span> <span class="at">--without-all</span> <span class="at">--with-x-toolkit</span><span class="op">=</span>no</span>
<span id="cb889-21"><a aria-hidden="true" href="#cb889-21" tabindex="-1"></a></span>
<span id="cb889-22"><a aria-hidden="true" href="#cb889-22" tabindex="-1"></a><span class="co"># View all options</span></span>
<span id="cb889-23"><a aria-hidden="true" href="#cb889-23" tabindex="-1"></a><span class="ex">./configure</span> <span class="at">--help</span></span></code></pre></div>
<h4 data-number="22.2.4.2" id="feature-detection-1"><span class="header-section-number">22.2.4.2</span> Feature Detection</h4>
<p>The configure script automatically detects: - Compiler capabilities
(GCC, Clang, etc.) - System libraries (X11, GTK, Cairo, etc.) - Optional
features (GnuTLS, ImageMagick, etc.) - Platform-specific
requirements</p>
<div class="sourceCode" id="cb890"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb890-1"><a aria-hidden="true" href="#cb890-1" tabindex="-1"></a><span class="co"># Check detection results</span></span>
<span id="cb890-2"><a aria-hidden="true" href="#cb890-2" tabindex="-1"></a><span class="ex">./configure</span></span>
<span id="cb890-3"><a aria-hidden="true" href="#cb890-3" tabindex="-1"></a><span class="co"># Review output for "checking for..." lines</span></span>
<span id="cb890-4"><a aria-hidden="true" href="#cb890-4" tabindex="-1"></a></span>
<span id="cb890-5"><a aria-hidden="true" href="#cb890-5" tabindex="-1"></a><span class="co"># Force library paths if needed</span></span>
<span id="cb890-6"><a aria-hidden="true" href="#cb890-6" tabindex="-1"></a><span class="ex">./configure</span> <span class="dt">\</span></span>
<span id="cb890-7"><a aria-hidden="true" href="#cb890-7" tabindex="-1"></a>    CPPFLAGS=<span class="st">'-I/usr/local/include'</span> <span class="dt">\</span></span>
<span id="cb890-8"><a aria-hidden="true" href="#cb890-8" tabindex="-1"></a>    LDFLAGS=<span class="st">'-L/usr/local/lib'</span></span></code></pre></div>
<h3 data-number="22.2.5" id="makefile.in-structure"><span class="header-section-number">22.2.5</span> 1.5 Makefile.in
Structure</h3>
<p>The top-level Makefile coordinates recursive builds across
subdirectories:</p>
<div class="sourceCode" id="cb891"><pre class="sourceCode makefile"><code class="sourceCode makefile"><span id="cb891-1"><a aria-hidden="true" href="#cb891-1" tabindex="-1"></a><span class="co"># Subdirectories built in order</span></span>
<span id="cb891-2"><a aria-hidden="true" href="#cb891-2" tabindex="-1"></a><span class="dt">SUBDIR</span> <span class="ch">=</span><span class="st"> lib lib-src src lisp</span></span>
<span id="cb891-3"><a aria-hidden="true" href="#cb891-3" tabindex="-1"></a></span>
<span id="cb891-4"><a aria-hidden="true" href="#cb891-4" tabindex="-1"></a><span class="co"># Key variables</span></span>
<span id="cb891-5"><a aria-hidden="true" href="#cb891-5" tabindex="-1"></a><span class="dt">version</span><span class="ch">=</span><span class="st">31.0.50</span></span>
<span id="cb891-6"><a aria-hidden="true" href="#cb891-6" tabindex="-1"></a><span class="dt">configuration</span><span class="ch">=</span><span class="st">x86_64-unknown-linux-gnu</span></span>
<span id="cb891-7"><a aria-hidden="true" href="#cb891-7" tabindex="-1"></a><span class="dt">prefix</span><span class="ch">=</span><span class="st">/usr/local</span></span></code></pre></div>
<h4 data-number="22.2.5.1" id="important-make-targets"><span class="header-section-number">22.2.5.1</span> Important Make
Targets</h4>
<div class="sourceCode" id="cb892"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb892-1"><a aria-hidden="true" href="#cb892-1" tabindex="-1"></a><span class="co"># Build targets</span></span>
<span id="cb892-2"><a aria-hidden="true" href="#cb892-2" tabindex="-1"></a><span class="fu">make</span> all              <span class="co"># Standard build</span></span>
<span id="cb892-3"><a aria-hidden="true" href="#cb892-3" tabindex="-1"></a><span class="fu">make</span> bootstrap        <span class="co"># Clean rebuild from scratch</span></span>
<span id="cb892-4"><a aria-hidden="true" href="#cb892-4" tabindex="-1"></a><span class="fu">make</span> bootstrap-clean  <span class="co"># Prepare for bootstrap</span></span>
<span id="cb892-5"><a aria-hidden="true" href="#cb892-5" tabindex="-1"></a><span class="fu">make</span> actual-all       <span class="co"># Internal target (invoked by all)</span></span>
<span id="cb892-6"><a aria-hidden="true" href="#cb892-6" tabindex="-1"></a></span>
<span id="cb892-7"><a aria-hidden="true" href="#cb892-7" tabindex="-1"></a><span class="co"># Installation</span></span>
<span id="cb892-8"><a aria-hidden="true" href="#cb892-8" tabindex="-1"></a><span class="fu">make</span> install          <span class="co"># Install everything</span></span>
<span id="cb892-9"><a aria-hidden="true" href="#cb892-9" tabindex="-1"></a><span class="fu">make</span> install-strip    <span class="co"># Install with stripped binaries</span></span>
<span id="cb892-10"><a aria-hidden="true" href="#cb892-10" tabindex="-1"></a><span class="fu">make</span> uninstall        <span class="co"># Remove installation</span></span>
<span id="cb892-11"><a aria-hidden="true" href="#cb892-11" tabindex="-1"></a></span>
<span id="cb892-12"><a aria-hidden="true" href="#cb892-12" tabindex="-1"></a><span class="co"># Cleaning</span></span>
<span id="cb892-13"><a aria-hidden="true" href="#cb892-13" tabindex="-1"></a><span class="fu">make</span> clean            <span class="co"># Remove build artifacts</span></span>
<span id="cb892-14"><a aria-hidden="true" href="#cb892-14" tabindex="-1"></a><span class="fu">make</span> mostlyclean      <span class="co"># Remove most build artifacts</span></span>
<span id="cb892-15"><a aria-hidden="true" href="#cb892-15" tabindex="-1"></a><span class="fu">make</span> distclean        <span class="co"># Remove all generated files</span></span>
<span id="cb892-16"><a aria-hidden="true" href="#cb892-16" tabindex="-1"></a><span class="fu">make</span> maintainer-clean <span class="co"># Remove everything regeneratable</span></span>
<span id="cb892-17"><a aria-hidden="true" href="#cb892-17" tabindex="-1"></a><span class="fu">make</span> extraclean       <span class="co"># Remove backups and autosave files</span></span>
<span id="cb892-18"><a aria-hidden="true" href="#cb892-18" tabindex="-1"></a></span>
<span id="cb892-19"><a aria-hidden="true" href="#cb892-19" tabindex="-1"></a><span class="co"># Documentation</span></span>
<span id="cb892-20"><a aria-hidden="true" href="#cb892-20" tabindex="-1"></a><span class="fu">make</span> docs             <span class="co"># Build all documentation</span></span>
<span id="cb892-21"><a aria-hidden="true" href="#cb892-21" tabindex="-1"></a><span class="fu">make</span> info             <span class="co"># Build Info manuals</span></span>
<span id="cb892-22"><a aria-hidden="true" href="#cb892-22" tabindex="-1"></a><span class="fu">make</span> html             <span class="co"># Build HTML documentation</span></span>
<span id="cb892-23"><a aria-hidden="true" href="#cb892-23" tabindex="-1"></a><span class="fu">make</span> pdf              <span class="co"># Build PDF documentation</span></span>
<span id="cb892-24"><a aria-hidden="true" href="#cb892-24" tabindex="-1"></a><span class="fu">make</span> ps               <span class="co"># Build PostScript documentation</span></span>
<span id="cb892-25"><a aria-hidden="true" href="#cb892-25" tabindex="-1"></a></span>
<span id="cb892-26"><a aria-hidden="true" href="#cb892-26" tabindex="-1"></a><span class="co"># Testing</span></span>
<span id="cb892-27"><a aria-hidden="true" href="#cb892-27" tabindex="-1"></a><span class="fu">make</span> check            <span class="co"># Run standard test suite</span></span>
<span id="cb892-28"><a aria-hidden="true" href="#cb892-28" tabindex="-1"></a><span class="fu">make</span> check-expensive  <span class="co"># Include expensive tests</span></span>
<span id="cb892-29"><a aria-hidden="true" href="#cb892-29" tabindex="-1"></a><span class="fu">make</span> check-all        <span class="co"># Run all tests</span></span>
<span id="cb892-30"><a aria-hidden="true" href="#cb892-30" tabindex="-1"></a><span class="fu">make</span> check-maybe      <span class="co"># Run outdated tests only</span></span>
<span id="cb892-31"><a aria-hidden="true" href="#cb892-31" tabindex="-1"></a></span>
<span id="cb892-32"><a aria-hidden="true" href="#cb892-32" tabindex="-1"></a><span class="co"># Development</span></span>
<span id="cb892-33"><a aria-hidden="true" href="#cb892-33" tabindex="-1"></a><span class="fu">make</span> TAGS             <span class="co"># Update tags tables</span></span>
<span id="cb892-34"><a aria-hidden="true" href="#cb892-34" tabindex="-1"></a><span class="fu">make</span> check-declare    <span class="co"># Verify function declarations</span></span></code></pre></div>
<h3 data-number="22.2.6" id="bootstrap-process"><span class="header-section-number">22.2.6</span> 1.6 Bootstrap Process</h3>
<p>The bootstrap process rebuilds Emacs from a clean slate when build
dependencies have changed significantly.</p>
<h4 data-number="22.2.6.1" id="when-to-bootstrap"><span class="header-section-number">22.2.6.1</span> When to Bootstrap</h4>
<ul>
<li>First build from repository</li>
<li>After updating loaddefs.el or autoloads</li>
<li>After changes to fundamental Lisp files</li>
<li>When encountering mysterious build failures</li>
<li>After Git merge conflicts in generated files</li>
</ul>
<h4 data-number="22.2.6.2" id="bootstrap-procedure"><span class="header-section-number">22.2.6.2</span> Bootstrap Procedure</h4>
<div class="sourceCode" id="cb893"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb893-1"><a aria-hidden="true" href="#cb893-1" tabindex="-1"></a><span class="co"># Standard bootstrap</span></span>
<span id="cb893-2"><a aria-hidden="true" href="#cb893-2" tabindex="-1"></a><span class="fu">make</span> bootstrap</span>
<span id="cb893-3"><a aria-hidden="true" href="#cb893-3" tabindex="-1"></a></span>
<span id="cb893-4"><a aria-hidden="true" href="#cb893-4" tabindex="-1"></a><span class="co"># Bootstrap with custom configure options</span></span>
<span id="cb893-5"><a aria-hidden="true" href="#cb893-5" tabindex="-1"></a><span class="fu">make</span> bootstrap configure=<span class="st">"CFLAGS='-O0 -g3'"</span></span>
<span id="cb893-6"><a aria-hidden="true" href="#cb893-6" tabindex="-1"></a></span>
<span id="cb893-7"><a aria-hidden="true" href="#cb893-7" tabindex="-1"></a><span class="co"># Bootstrap with default configuration</span></span>
<span id="cb893-8"><a aria-hidden="true" href="#cb893-8" tabindex="-1"></a><span class="fu">make</span> bootstrap configure=default</span>
<span id="cb893-9"><a aria-hidden="true" href="#cb893-9" tabindex="-1"></a></span>
<span id="cb893-10"><a aria-hidden="true" href="#cb893-10" tabindex="-1"></a><span class="co"># Fast bootstrap (keeps cache)</span></span>
<span id="cb893-11"><a aria-hidden="true" href="#cb893-11" tabindex="-1"></a><span class="ex">./configure</span> <span class="at">-C</span></span>
<span id="cb893-12"><a aria-hidden="true" href="#cb893-12" tabindex="-1"></a><span class="fu">make</span> FAST=true bootstrap</span>
<span id="cb893-13"><a aria-hidden="true" href="#cb893-13" tabindex="-1"></a></span>
<span id="cb893-14"><a aria-hidden="true" href="#cb893-14" tabindex="-1"></a><span class="co"># Nuclear option: complete clean</span></span>
<span id="cb893-15"><a aria-hidden="true" href="#cb893-15" tabindex="-1"></a><span class="fu">git</span> clean <span class="at">-fdx</span>  <span class="co"># </span><span class="al">WARNING</span><span class="co">: Deletes all untracked files!</span></span>
<span id="cb893-16"><a aria-hidden="true" href="#cb893-16" tabindex="-1"></a><span class="ex">./autogen.sh</span></span>
<span id="cb893-17"><a aria-hidden="true" href="#cb893-17" tabindex="-1"></a><span class="ex">./configure</span></span>
<span id="cb893-18"><a aria-hidden="true" href="#cb893-18" tabindex="-1"></a><span class="fu">make</span></span></code></pre></div>
<h4 data-number="22.2.6.3" id="what-bootstrap-does"><span class="header-section-number">22.2.6.3</span> What Bootstrap Does</h4>
<ol type="1">
<li>Runs <code>bootstrap-clean</code> to remove:
<ul>
<li>All .elc (byte-compiled) files</li>
<li>Generated loaddefs files</li>
<li>Native-compiled .eln files</li>
<li>Info documentation</li>
</ul></li>
<li>Regenerates configuration if needed:
<ul>
<li>Runs autogen.sh if no configure exists</li>
<li>Rebuilds Makefiles</li>
</ul></li>
<li>Performs a complete build:
<ul>
<li>Builds C code (lib, src)</li>
<li>Byte-compiles all Lisp files</li>
<li>Generates autoloads (loaddefs.el)</li>
<li>Native-compiles if enabled</li>
<li>Builds documentation</li>
</ul></li>
</ol>
<h3 data-number="22.2.7" id="portable-dumper-pdumper"><span class="header-section-number">22.2.7</span> 1.7 Portable Dumper
(pdumper)</h3>
<p>The portable dumper creates a snapshot of Emacs state for fast
startup.</p>
<h4 data-number="22.2.7.1" id="overview-11"><span class="header-section-number">22.2.7.1</span> Overview</h4>
<div class="sourceCode" id="cb894"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb894-1"><a aria-hidden="true" href="#cb894-1" tabindex="-1"></a><span class="co"># Default dumping method since Emacs 27</span></span>
<span id="cb894-2"><a aria-hidden="true" href="#cb894-2" tabindex="-1"></a><span class="ex">./configure</span> <span class="at">--with-dumping</span><span class="op">=</span>pdumper</span>
<span id="cb894-3"><a aria-hidden="true" href="#cb894-3" tabindex="-1"></a></span>
<span id="cb894-4"><a aria-hidden="true" href="#cb894-4" tabindex="-1"></a><span class="co"># Creates dump file</span></span>
<span id="cb894-5"><a aria-hidden="true" href="#cb894-5" tabindex="-1"></a><span class="ex">src/emacs.pdmp</span>  <span class="co"># Loaded at startup</span></span></code></pre></div>
<h4 data-number="22.2.7.2" id="how-it-works"><span class="header-section-number">22.2.7.2</span> How It Works</h4>
<ol type="1">
<li><p><strong>Dump Creation</strong> (during build):</p>
<div class="sourceCode" id="cb895"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb895-1"><a aria-hidden="true" href="#cb895-1" tabindex="-1"></a><span class="co"># In src/Makefile, after building temacs:</span></span>
<span id="cb895-2"><a aria-hidden="true" href="#cb895-2" tabindex="-1"></a><span class="ex">./temacs</span> <span class="at">--batch</span> <span class="at">--load</span> loadup.el dump</span>
<span id="cb895-3"><a aria-hidden="true" href="#cb895-3" tabindex="-1"></a><span class="co"># Creates emacs.pdmp</span></span></code></pre></div></li>
<li><p><strong>Dump Loading</strong> (at startup):</p>
<ul>
<li>Emacs locates .pdmp file (same dir as binary)</li>
<li>Memory-maps dump contents</li>
<li>Restores Lisp objects, buffers, keymaps</li>
<li>Much faster than loading Lisp files</li>
</ul></li>
</ol>
<h4 data-number="22.2.7.3" id="dump-file-management"><span class="header-section-number">22.2.7.3</span> Dump File Management</h4>
<div class="sourceCode" id="cb896"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb896-1"><a aria-hidden="true" href="#cb896-1" tabindex="-1"></a><span class="co"># Location (installed)</span></span>
<span id="cb896-2"><a aria-hidden="true" href="#cb896-2" tabindex="-1"></a><span class="ex">/usr/local/libexec/emacs/31.0.50/x86_64-unknown-linux-gnu/emacs-*.pdmp</span></span>
<span id="cb896-3"><a aria-hidden="true" href="#cb896-3" tabindex="-1"></a></span>
<span id="cb896-4"><a aria-hidden="true" href="#cb896-4" tabindex="-1"></a><span class="co"># Location (build directory)</span></span>
<span id="cb896-5"><a aria-hidden="true" href="#cb896-5" tabindex="-1"></a><span class="ex">src/emacs.pdmp</span></span>
<span id="cb896-6"><a aria-hidden="true" href="#cb896-6" tabindex="-1"></a></span>
<span id="cb896-7"><a aria-hidden="true" href="#cb896-7" tabindex="-1"></a><span class="co"># Fingerprint-based naming</span></span>
<span id="cb896-8"><a aria-hidden="true" href="#cb896-8" tabindex="-1"></a><span class="ex">./src/emacs</span> <span class="at">--fingerprint</span></span>
<span id="cb896-9"><a aria-hidden="true" href="#cb896-9" tabindex="-1"></a><span class="co"># e.g., emacs-31.0.50-abc123def456.pdmp</span></span>
<span id="cb896-10"><a aria-hidden="true" href="#cb896-10" tabindex="-1"></a></span>
<span id="cb896-11"><a aria-hidden="true" href="#cb896-11" tabindex="-1"></a><span class="co"># Rebuild dump only</span></span>
<span id="cb896-12"><a aria-hidden="true" href="#cb896-12" tabindex="-1"></a><span class="bu">cd</span> src <span class="kw">&amp;&amp;</span> <span class="fu">make</span> emacs.pdmp</span></code></pre></div>
<h3 data-number="22.2.8" id="cross-compilation-support"><span class="header-section-number">22.2.8</span> 1.8 Cross-Compilation
Support</h3>
<p>Emacs supports cross-compilation for various platforms, notably
Android.</p>
<h4 data-number="22.2.8.1" id="android-build"><span class="header-section-number">22.2.8.1</span> Android Build</h4>
<div class="sourceCode" id="cb897"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb897-1"><a aria-hidden="true" href="#cb897-1" tabindex="-1"></a><span class="co"># See java/INSTALL for detailed instructions</span></span>
<span id="cb897-2"><a aria-hidden="true" href="#cb897-2" tabindex="-1"></a></span>
<span id="cb897-3"><a aria-hidden="true" href="#cb897-3" tabindex="-1"></a><span class="co"># Configure for Android</span></span>
<span id="cb897-4"><a aria-hidden="true" href="#cb897-4" tabindex="-1"></a><span class="bu">export</span> <span class="va">ANDROID_CC</span><span class="op">=&lt;</span>ndk-toolchain-prefix<span class="op">&gt;</span>-gcc</span>
<span id="cb897-5"><a aria-hidden="true" href="#cb897-5" tabindex="-1"></a><span class="bu">export</span> <span class="va">ANDROID_CFLAGS</span><span class="op">=</span><span class="st">"-I&lt;ndk-sysroot&gt;/include"</span></span>
<span id="cb897-6"><a aria-hidden="true" href="#cb897-6" tabindex="-1"></a></span>
<span id="cb897-7"><a aria-hidden="true" href="#cb897-7" tabindex="-1"></a><span class="ex">./configure</span> <span class="dt">\</span></span>
<span id="cb897-8"><a aria-hidden="true" href="#cb897-8" tabindex="-1"></a>    <span class="at">--host</span><span class="op">=</span>arm-linux-androideabi <span class="dt">\</span></span>
<span id="cb897-9"><a aria-hidden="true" href="#cb897-9" tabindex="-1"></a>    <span class="at">--with-ndk-path</span><span class="op">=</span>/path/to/ndk <span class="dt">\</span></span>
<span id="cb897-10"><a aria-hidden="true" href="#cb897-10" tabindex="-1"></a>    <span class="at">--with-ndk-build</span><span class="op">=</span>/path/to/ndk-build</span>
<span id="cb897-11"><a aria-hidden="true" href="#cb897-11" tabindex="-1"></a></span>
<span id="cb897-12"><a aria-hidden="true" href="#cb897-12" tabindex="-1"></a><span class="co"># Build</span></span>
<span id="cb897-13"><a aria-hidden="true" href="#cb897-13" tabindex="-1"></a><span class="fu">make</span></span>
<span id="cb897-14"><a aria-hidden="true" href="#cb897-14" tabindex="-1"></a></span>
<span id="cb897-15"><a aria-hidden="true" href="#cb897-15" tabindex="-1"></a><span class="co"># Android-specific features</span></span>
<span id="cb897-16"><a aria-hidden="true" href="#cb897-16" tabindex="-1"></a><span class="ex">cross/Makefile.in</span>           <span class="co"># Cross-compilation support</span></span>
<span id="cb897-17"><a aria-hidden="true" href="#cb897-17" tabindex="-1"></a><span class="ex">cross/ndk-build/Makefile.in</span> <span class="co"># NDK build system integration</span></span></code></pre></div>
<h4 data-number="22.2.8.2" id="cross-compilation-directory-structure"><span class="header-section-number">22.2.8.2</span> Cross-Compilation
Directory Structure</h4>
<pre><code>cross/
‚îú‚îÄ‚îÄ Makefile.in           # Cross-compilation rules
‚îú‚îÄ‚îÄ ndk-build/            # Android NDK build support
‚îÇ   ‚îî‚îÄ‚îÄ Makefile.in
‚îú‚îÄ‚îÄ README                # Cross-compilation notes
‚îî‚îÄ‚îÄ langinfo.h            # Platform headers

java/                     # Android-specific code
‚îú‚îÄ‚îÄ INSTALL               # Android build guide
‚îú‚îÄ‚îÄ Makefile.in
‚îî‚îÄ‚îÄ org/gnu/emacs/        # Java wrapper code</code></pre>
<h3 data-number="22.2.9" id="native-compilation-4"><span class="header-section-number">22.2.9</span> 1.9 Native Compilation</h3>
<p>Emacs can compile Lisp code to native machine code using
libgccjit.</p>
<h4 data-number="22.2.9.1" id="configuration"><span class="header-section-number">22.2.9.1</span> Configuration</h4>
<div class="sourceCode" id="cb899"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb899-1"><a aria-hidden="true" href="#cb899-1" tabindex="-1"></a><span class="co"># Enable native compilation</span></span>
<span id="cb899-2"><a aria-hidden="true" href="#cb899-2" tabindex="-1"></a><span class="ex">./configure</span> <span class="at">--with-native-compilation</span></span>
<span id="cb899-3"><a aria-hidden="true" href="#cb899-3" tabindex="-1"></a></span>
<span id="cb899-4"><a aria-hidden="true" href="#cb899-4" tabindex="-1"></a><span class="co"># Requires libgccjit</span></span>
<span id="cb899-5"><a aria-hidden="true" href="#cb899-5" tabindex="-1"></a><span class="co"># On Debian/Ubuntu:</span></span>
<span id="cb899-6"><a aria-hidden="true" href="#cb899-6" tabindex="-1"></a><span class="fu">sudo</span> apt install libgccjit-12-dev</span>
<span id="cb899-7"><a aria-hidden="true" href="#cb899-7" tabindex="-1"></a></span>
<span id="cb899-8"><a aria-hidden="true" href="#cb899-8" tabindex="-1"></a><span class="co"># On Fedora:</span></span>
<span id="cb899-9"><a aria-hidden="true" href="#cb899-9" tabindex="-1"></a><span class="fu">sudo</span> dnf install libgccjit-devel</span></code></pre></div>
<h4 data-number="22.2.9.2" id="how-it-works-1"><span class="header-section-number">22.2.9.2</span> How It Works</h4>
<div class="sourceCode" id="cb900"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb900-1"><a aria-hidden="true" href="#cb900-1" tabindex="-1"></a><span class="co"># During build, creates:</span></span>
<span id="cb900-2"><a aria-hidden="true" href="#cb900-2" tabindex="-1"></a><span class="ex">native-lisp/</span>              <span class="co"># Native-compiled .eln files</span></span>
<span id="cb900-3"><a aria-hidden="true" href="#cb900-3" tabindex="-1"></a><span class="ex">‚îî‚îÄ‚îÄ</span> 31.0.50-<span class="op">&lt;</span>hash<span class="op">&gt;</span>/</span>
<span id="cb900-4"><a aria-hidden="true" href="#cb900-4" tabindex="-1"></a>    <span class="ex">‚îî‚îÄ‚îÄ</span> preloaded/</span>
<span id="cb900-5"><a aria-hidden="true" href="#cb900-5" tabindex="-1"></a>        <span class="ex">‚îú‚îÄ‚îÄ</span> emacs-lisp/</span>
<span id="cb900-6"><a aria-hidden="true" href="#cb900-6" tabindex="-1"></a>        <span class="ex">‚îÇ</span>   ‚îî‚îÄ‚îÄ byte-opt-<span class="op">&lt;</span>hash<span class="op">&gt;</span>.eln</span>
<span id="cb900-7"><a aria-hidden="true" href="#cb900-7" tabindex="-1"></a>        <span class="ex">‚îî‚îÄ‚îÄ</span> ...</span>
<span id="cb900-8"><a aria-hidden="true" href="#cb900-8" tabindex="-1"></a></span>
<span id="cb900-9"><a aria-hidden="true" href="#cb900-9" tabindex="-1"></a><span class="co"># At runtime, compiles Lisp files to:</span></span>
<span id="cb900-10"><a aria-hidden="true" href="#cb900-10" tabindex="-1"></a><span class="ex">~/.emacs.d/eln-cache/31.0.50-</span><span class="op">&lt;</span>hash<span class="op">&gt;</span>/</span></code></pre></div>
<h4 data-number="22.2.9.3" id="build-targets"><span class="header-section-number">22.2.9.3</span> Build Targets</h4>
<div class="sourceCode" id="cb901"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb901-1"><a aria-hidden="true" href="#cb901-1" tabindex="-1"></a><span class="co"># Build trampolines (native compilation support)</span></span>
<span id="cb901-2"><a aria-hidden="true" href="#cb901-2" tabindex="-1"></a><span class="fu">make</span> trampolines</span>
<span id="cb901-3"><a aria-hidden="true" href="#cb901-3" tabindex="-1"></a></span>
<span id="cb901-4"><a aria-hidden="true" href="#cb901-4" tabindex="-1"></a><span class="co"># Install native-compiled files</span></span>
<span id="cb901-5"><a aria-hidden="true" href="#cb901-5" tabindex="-1"></a><span class="fu">make</span> install-eln</span></code></pre></div>
<h4 data-number="22.2.9.4" id="configuration-variables"><span class="header-section-number">22.2.9.4</span> Configuration
Variables</h4>
<div class="sourceCode" id="cb902"><pre class="sourceCode makefile"><code class="sourceCode makefile"><span id="cb902-1"><a aria-hidden="true" href="#cb902-1" tabindex="-1"></a><span class="co"># In Makefile.in</span></span>
<span id="cb902-2"><a aria-hidden="true" href="#cb902-2" tabindex="-1"></a><span class="dt">HAVE_NATIVE_COMP</span> <span class="ch">=</span><span class="st"> yes</span></span>
<span id="cb902-3"><a aria-hidden="true" href="#cb902-3" tabindex="-1"></a></span>
<span id="cb902-4"><a aria-hidden="true" href="#cb902-4" tabindex="-1"></a><span class="co"># ELN installation directory</span></span>
<span id="cb902-5"><a aria-hidden="true" href="#cb902-5" tabindex="-1"></a><span class="dt">ELN_DESTDIR</span> <span class="ch">=</span><span class="st"> /usr/local/lib/emacs/31.0.50/</span></span></code></pre></div>
<hr/>
<h2 data-number="22.3" id="testing-infrastructure"><span class="header-section-number">22.3</span> 2. Testing Infrastructure</h2>
<h3 data-number="22.3.1" id="test-directory-structure"><span class="header-section-number">22.3.1</span> 2.1 Test Directory
Structure</h3>
<pre><code>test/
‚îú‚îÄ‚îÄ README                  # Testing overview
‚îú‚îÄ‚îÄ Makefile.in            # Test execution framework
‚îú‚îÄ‚îÄ file-organization.org  # File naming conventions
‚îú‚îÄ‚îÄ data/                  # Shared test data
‚îú‚îÄ‚îÄ infra/                 # CI infrastructure
‚îÇ   ‚îú‚îÄ‚îÄ gitlab-ci.yml      # GitLab CI configuration
‚îÇ   ‚îú‚îÄ‚îÄ Dockerfile.emba    # CI container definition
‚îÇ   ‚îî‚îÄ‚îÄ test-jobs.yml      # Generated test job definitions
‚îú‚îÄ‚îÄ lisp/                  # Lisp feature tests (42 subdirs)
‚îÇ   ‚îú‚îÄ‚îÄ abbrev-tests.el
‚îÇ   ‚îú‚îÄ‚îÄ files-tests.el     # 105KB - comprehensive file tests
‚îÇ   ‚îú‚îÄ‚îÄ emacs-lisp/        # Emacs Lisp feature tests
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ert-tests.el   # ERT self-tests
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îÇ   ‚îú‚îÄ‚îÄ net/               # Network feature tests
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ tramp-tests.el # TRAMP remote access tests
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ src/                   # C implementation tests
‚îÇ   ‚îú‚îÄ‚îÄ emacs-tests.el
‚îÇ   ‚îú‚îÄ‚îÄ fileio-tests.el
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ lib-src/               # Utility program tests
‚îú‚îÄ‚îÄ manual/                # Manual testing procedures
‚îÇ   ‚îú‚îÄ‚îÄ etags/             # etags test suite
‚îÇ   ‚îú‚îÄ‚îÄ indent/            # Indentation test files
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îî‚îÄ‚îÄ misc/                  # Miscellaneous tests

Total: 677 test files (.el)</code></pre>
<h3 data-number="22.3.2" id="ert-emacs-lisp-regression-testing"><span class="header-section-number">22.3.2</span> 2.2 ERT (Emacs Lisp
Regression Testing)</h3>
<p>ERT is Emacs‚Äôs built-in testing framework, inspired by unit testing
frameworks.</p>
<h4 data-number="22.3.2.1" id="basic-test-structure"><span class="header-section-number">22.3.2.1</span> Basic Test Structure</h4>
<pre class="elisp"><code>;;; my-feature-tests.el --- Tests for my-feature

(require 'ert)
(require 'my-feature)

;; Simple test
(ert-deftest my-feature-test-basic ()
  "Test basic functionality of my-feature."
  (should (equal (my-function 1 2) 3)))

;; Test with setup/teardown
(ert-deftest my-feature-test-with-temp-buffer ()
  "Test my-feature with a temporary buffer."
  (with-temp-buffer
    (insert "test content")
    (should (= (buffer-size) 12))))

;; Test expecting error
(ert-deftest my-feature-test-error ()
  "Test that invalid input signals an error."
  (should-error (my-function nil nil)
                :type 'wrong-type-argument))

;; Test with tag
(ert-deftest my-feature-expensive-test ()
  :tags '(:expensive-test)
  "Expensive test that runs only when requested."
  (dotimes (i 1000000)
    (my-function i (1+ i))))

(provide 'my-feature-tests)</code></pre>
<h4 data-number="22.3.2.2" id="ert-assertions"><span class="header-section-number">22.3.2.2</span> ERT Assertions</h4>
<pre class="elisp"><code>;; Basic assertions
(should FORM)              ; Assert FORM is non-nil
(should-not FORM)          ; Assert FORM is nil
(should-error FORM)        ; Assert FORM signals error
(should-error FORM :type 'ERROR-TYPE)

;; Examples
(should (= (+ 1 2) 3))
(should (string= "foo" (upcase "FOO")))
(should-not (zerop 5))
(should-error (/ 1 0) :type 'arith-error)

;; Custom failure messages
(ert-fail "Explicit failure message")
(ert-skip "Test not applicable in this environment")</code></pre>
<h4 data-number="22.3.2.3" id="test-tags"><span class="header-section-number">22.3.2.3</span> Test Tags</h4>
<pre class="elisp"><code>;; Recognized tags in Emacs test suite:

:expensive-test  ; Takes significant time to run
:unstable        ; Under development, may fail
:nativecomp      ; Requires native compilation</code></pre>
<h3 data-number="22.3.3" id="running-tests"><span class="header-section-number">22.3.3</span> 2.3 Running Tests</h3>
<h4 data-number="22.3.3.1" id="command-line-test-execution"><span class="header-section-number">22.3.3.1</span> Command-Line Test
Execution</h4>
<div class="sourceCode" id="cb907"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb907-1"><a aria-hidden="true" href="#cb907-1" tabindex="-1"></a><span class="co"># Run all standard tests</span></span>
<span id="cb907-2"><a aria-hidden="true" href="#cb907-2" tabindex="-1"></a><span class="fu">make</span> check</span>
<span id="cb907-3"><a aria-hidden="true" href="#cb907-3" tabindex="-1"></a></span>
<span id="cb907-4"><a aria-hidden="true" href="#cb907-4" tabindex="-1"></a><span class="co"># Run expensive tests too</span></span>
<span id="cb907-5"><a aria-hidden="true" href="#cb907-5" tabindex="-1"></a><span class="fu">make</span> check-expensive</span>
<span id="cb907-6"><a aria-hidden="true" href="#cb907-6" tabindex="-1"></a></span>
<span id="cb907-7"><a aria-hidden="true" href="#cb907-7" tabindex="-1"></a><span class="co"># Run absolutely all tests</span></span>
<span id="cb907-8"><a aria-hidden="true" href="#cb907-8" tabindex="-1"></a><span class="fu">make</span> check-all</span>
<span id="cb907-9"><a aria-hidden="true" href="#cb907-9" tabindex="-1"></a></span>
<span id="cb907-10"><a aria-hidden="true" href="#cb907-10" tabindex="-1"></a><span class="co"># Run only outdated tests</span></span>
<span id="cb907-11"><a aria-hidden="true" href="#cb907-11" tabindex="-1"></a><span class="fu">make</span> check-maybe</span>
<span id="cb907-12"><a aria-hidden="true" href="#cb907-12" tabindex="-1"></a></span>
<span id="cb907-13"><a aria-hidden="true" href="#cb907-13" tabindex="-1"></a><span class="co"># Byte-compile all test files</span></span>
<span id="cb907-14"><a aria-hidden="true" href="#cb907-14" tabindex="-1"></a><span class="fu">make</span> check-byte-compile</span>
<span id="cb907-15"><a aria-hidden="true" href="#cb907-15" tabindex="-1"></a></span>
<span id="cb907-16"><a aria-hidden="true" href="#cb907-16" tabindex="-1"></a><span class="co"># Run specific test file</span></span>
<span id="cb907-17"><a aria-hidden="true" href="#cb907-17" tabindex="-1"></a><span class="fu">make</span> test/lisp/files-tests.log</span>
<span id="cb907-18"><a aria-hidden="true" href="#cb907-18" tabindex="-1"></a></span>
<span id="cb907-19"><a aria-hidden="true" href="#cb907-19" tabindex="-1"></a><span class="co"># Run test file without logging</span></span>
<span id="cb907-20"><a aria-hidden="true" href="#cb907-20" tabindex="-1"></a><span class="fu">make</span> test/lisp/files-tests</span>
<span id="cb907-21"><a aria-hidden="true" href="#cb907-21" tabindex="-1"></a></span>
<span id="cb907-22"><a aria-hidden="true" href="#cb907-22" tabindex="-1"></a><span class="co"># Run tests in subdirectory</span></span>
<span id="cb907-23"><a aria-hidden="true" href="#cb907-23" tabindex="-1"></a><span class="fu">make</span> lisp                  <span class="co"># All tests in test/lisp/</span></span>
<span id="cb907-24"><a aria-hidden="true" href="#cb907-24" tabindex="-1"></a><span class="fu">make</span> check-src             <span class="co"># All tests in test/src/</span></span>
<span id="cb907-25"><a aria-hidden="true" href="#cb907-25" tabindex="-1"></a><span class="fu">make</span> check-lisp-net        <span class="co"># All tests in test/lisp/net/</span></span></code></pre></div>
<h4 data-number="22.3.3.2" id="test-selectors"><span class="header-section-number">22.3.3.2</span> Test Selectors</h4>
<div class="sourceCode" id="cb908"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb908-1"><a aria-hidden="true" href="#cb908-1" tabindex="-1"></a><span class="co"># Run specific tests by selector</span></span>
<span id="cb908-2"><a aria-hidden="true" href="#cb908-2" tabindex="-1"></a><span class="fu">make</span> test/lisp/files-tests SELECTOR=<span class="st">'test-file-exists'</span></span>
<span id="cb908-3"><a aria-hidden="true" href="#cb908-3" tabindex="-1"></a></span>
<span id="cb908-4"><a aria-hidden="true" href="#cb908-4" tabindex="-1"></a><span class="co"># Use regex selector (note double $$)</span></span>
<span id="cb908-5"><a aria-hidden="true" href="#cb908-5" tabindex="-1"></a><span class="fu">make</span> test/lisp/files-tests SELECTOR=<span class="st">'"file$$"'</span></span>
<span id="cb908-6"><a aria-hidden="true" href="#cb908-6" tabindex="-1"></a></span>
<span id="cb908-7"><a aria-hidden="true" href="#cb908-7" tabindex="-1"></a><span class="co"># Predefined selectors</span></span>
<span id="cb908-8"><a aria-hidden="true" href="#cb908-8" tabindex="-1"></a><span class="va">SELECTOR</span><span class="op">=</span><span class="st">'$(SELECTOR_DEFAULT)'</span>   <span class="co"># Exclude :expensive-test, :unstable</span></span>
<span id="cb908-9"><a aria-hidden="true" href="#cb908-9" tabindex="-1"></a><span class="va">SELECTOR</span><span class="op">=</span><span class="st">'$(SELECTOR_EXPENSIVE)'</span> <span class="co"># Exclude :unstable only</span></span>
<span id="cb908-10"><a aria-hidden="true" href="#cb908-10" tabindex="-1"></a><span class="va">SELECTOR</span><span class="op">=</span><span class="st">'$(SELECTOR_ALL)'</span>       <span class="co"># Run all tests</span></span></code></pre></div>
<h4 data-number="22.3.3.3" id="test-execution-options"><span class="header-section-number">22.3.3.3</span> Test Execution
Options</h4>
<div class="sourceCode" id="cb909"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb909-1"><a aria-hidden="true" href="#cb909-1" tabindex="-1"></a><span class="co"># Use source .el files instead of .elc (better backtraces)</span></span>
<span id="cb909-2"><a aria-hidden="true" href="#cb909-2" tabindex="-1"></a><span class="fu">make</span> check TEST_LOAD_EL=yes</span>
<span id="cb909-3"><a aria-hidden="true" href="#cb909-3" tabindex="-1"></a></span>
<span id="cb909-4"><a aria-hidden="true" href="#cb909-4" tabindex="-1"></a><span class="co"># Run in interactive mode (for debugging)</span></span>
<span id="cb909-5"><a aria-hidden="true" href="#cb909-5" tabindex="-1"></a><span class="fu">make</span> test/lisp/files-tests TEST_INTERACTIVE=yes</span>
<span id="cb909-6"><a aria-hidden="true" href="#cb909-6" tabindex="-1"></a></span>
<span id="cb909-7"><a aria-hidden="true" href="#cb909-7" tabindex="-1"></a><span class="co"># Increase backtrace line length</span></span>
<span id="cb909-8"><a aria-hidden="true" href="#cb909-8" tabindex="-1"></a><span class="fu">make</span> check TEST_BACKTRACE_LINE_LENGTH=500</span>
<span id="cb909-9"><a aria-hidden="true" href="#cb909-9" tabindex="-1"></a></span>
<span id="cb909-10"><a aria-hidden="true" href="#cb909-10" tabindex="-1"></a><span class="co"># Show test timing summary (top N slowest tests)</span></span>
<span id="cb909-11"><a aria-hidden="true" href="#cb909-11" tabindex="-1"></a><span class="fu">make</span> check SUMMARIZE_TESTS=10</span>
<span id="cb909-12"><a aria-hidden="true" href="#cb909-12" tabindex="-1"></a></span>
<span id="cb909-13"><a aria-hidden="true" href="#cb909-13" tabindex="-1"></a><span class="co"># Set test timeout (in seconds)</span></span>
<span id="cb909-14"><a aria-hidden="true" href="#cb909-14" tabindex="-1"></a><span class="va">EMACS_TEST_TIMEOUT</span><span class="op">=</span>600 <span class="fu">make</span> check</span>
<span id="cb909-15"><a aria-hidden="true" href="#cb909-15" tabindex="-1"></a></span>
<span id="cb909-16"><a aria-hidden="true" href="#cb909-16" tabindex="-1"></a><span class="co"># Verbose test output</span></span>
<span id="cb909-17"><a aria-hidden="true" href="#cb909-17" tabindex="-1"></a><span class="va">EMACS_TEST_VERBOSE</span><span class="op">=</span>1 <span class="fu">make</span> check</span>
<span id="cb909-18"><a aria-hidden="true" href="#cb909-18" tabindex="-1"></a></span>
<span id="cb909-19"><a aria-hidden="true" href="#cb909-19" tabindex="-1"></a><span class="co"># Generate JUnit report</span></span>
<span id="cb909-20"><a aria-hidden="true" href="#cb909-20" tabindex="-1"></a><span class="va">EMACS_TEST_JUNIT_REPORT</span><span class="op">=</span>junit-report.xml <span class="fu">make</span> check</span>
<span id="cb909-21"><a aria-hidden="true" href="#cb909-21" tabindex="-1"></a></span>
<span id="cb909-22"><a aria-hidden="true" href="#cb909-22" tabindex="-1"></a><span class="co"># Pass extra options to Emacs</span></span>
<span id="cb909-23"><a aria-hidden="true" href="#cb909-23" tabindex="-1"></a><span class="fu">make</span> check EMACS_EXTRAOPT=<span class="st">"--eval '(setopt ert-batch-print-length nil)'"</span></span></code></pre></div>
<h4 data-number="22.3.3.4" id="interactive-test-execution"><span class="header-section-number">22.3.3.4</span> Interactive Test
Execution</h4>
<pre class="elisp"><code>;; Load test file in Emacs
(load-file "test/lisp/files-tests.el")

;; Run all tests in current file
M-x ert RET t RET

;; Run specific test
M-x ert RET test-name RET

;; Run tests matching pattern
M-x ert RET "^test-file" RET

;; Run tests with selector
M-x ert RET (not (tag :expensive-test)) RET

;; Re-run failed tests
M-x ert-results-rerun-all-tests

;; In *ert* buffer:
;; r - re-run test
;; d - re-run with debugger
;; . - jump to test definition
;; b - show backtrace
;; m - show messages</code></pre>
<h3 data-number="22.3.4" id="writing-new-tests"><span class="header-section-number">22.3.4</span> 2.4 Writing New Tests</h3>
<h4 data-number="22.3.4.1" id="file-organization-guidelines"><span class="header-section-number">22.3.4.1</span> File Organization
Guidelines</h4>
<p>From <code>test/file-organization.org</code>:</p>
<pre><code>1. Test file naming:
   source: lisp/emacs-lisp/pcase.el
   tests:  test/lisp/emacs-lisp/pcase-tests.el

2. Mirror source directory structure:
   source: lisp/progmodes/python.el
   tests:  test/lisp/progmodes/python-tests.el

3. Resource files:
   tests:     test/lisp/progmodes/flymake-tests.el
   resources: test/lisp/progmodes/flymake-resources/

4. Multiple test files for single feature:
   test/lisp/emacs-lisp/eieio-tests/
   ‚îú‚îÄ‚îÄ eieio-test-persist.el
   ‚îú‚îÄ‚îÄ eieio-test-methodinvoke.el
   ‚îî‚îÄ‚îÄ ...

5. Tests not tied to specific file:
   test/misc/
   ‚îî‚îÄ‚îÄ some-descriptive-name.el  # NOT *-tests.el</code></pre>
<h4 data-number="22.3.4.2" id="test-template"><span class="header-section-number">22.3.4.2</span> Test Template</h4>
<pre class="elisp"><code>;;; package-tests.el --- Tests for package.el  -*- lexical-binding: t -*-

;; Copyright (C) 2025 Free Software Foundation, Inc.

;; Author: Your Name &lt;you@example.com&gt;
;; Keywords: tests

;; This file is part of GNU Emacs.

;; GNU Emacs is free software: you can redistribute it and/or modify
;; it under the terms of the GNU General Public License as published by
;; the Free Software Foundation, either version 3 of the License, or
;; (at your option) any later version.

;; GNU Emacs is distributed in the hope that it will be useful,
;; but WITHOUT ANY WARRANTY; without even the implied warranty of
;; MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
;; GNU General Public License for more details.

;; You should have received a copy of the GNU General Public License
;; along with GNU Emacs.  If not, see &lt;https://www.gnu.org/licenses/&gt;.

;;; Commentary:

;; Tests for package.el functionality.

;;; Code:

(require 'ert)
(require 'package)

(ert-deftest package-test-feature-works ()
  "Test that package feature works correctly."
  (should (functionp 'package-initialize)))

(ert-deftest package-test-with-resources ()
  "Test using resource files."
  (let ((resource-file
         (expand-file-name "test-data.txt"
                           (expand-file-name
                            "package-resources"
                            (file-name-directory
                             (or load-file-name buffer-file-name))))))
    (should (file-exists-p resource-file))
    (with-temp-buffer
      (insert-file-contents resource-file)
      (should (&gt; (buffer-size) 0)))))

(provide 'package-tests)
;;; package-tests.el ends here</code></pre>
<h4 data-number="22.3.4.3" id="best-practices-1"><span class="header-section-number">22.3.4.3</span> Best Practices</h4>
<pre class="elisp"><code>;; 1. Test one thing per test function
(ert-deftest package-parse-good ()
  "Test parsing of valid package descriptor."
  (should (package-desc-p (package--read-pkg-desc "good"))))

(ert-deftest package-parse-bad ()
  "Test parsing of invalid package descriptor."
  (should-error (package--read-pkg-desc "bad")))

;; 2. Use descriptive test names
;; Good:  package-install-activates-dependencies
;; Bad:   test-1

;; 3. Use temporary buffers for I/O tests
(ert-deftest package-test-buffer-ops ()
  (with-temp-buffer
    (insert "test")
    (should (= (point) 5))))

;; 4. Use temporary files for file tests
(ert-deftest package-test-file-ops ()
  (let ((temp-file (make-temp-file "package-test")))
    (unwind-protect
        (progn
          (write-region "content" nil temp-file)
          (should (file-exists-p temp-file)))
      (delete-file temp-file))))

;; 5. Tag expensive or unstable tests
(ert-deftest package-network-test ()
  :tags '(:expensive-test)
  "Test package download from network."
  (package-refresh-contents))

;; 6. Use fixtures for complex setup
(defvar package-test-data-dir
  (expand-file-name "package-resources"
                    (file-name-directory
                     (or load-file-name buffer-file-name))))

;; 7. Document what you're testing
(ert-deftest package-version-compare ()
  "Test that package-version-join produces correct version strings.
See bug#12345 for background on this issue."
  (should (equal (package-version-join '(1 2 3)) "1.2.3")))</code></pre>
<h3 data-number="22.3.5" id="test-makefile-details"><span class="header-section-number">22.3.5</span> 2.5 Test Makefile
Details</h3>
<p>The test Makefile (<code>test/Makefile.in</code>) provides
sophisticated test execution:</p>
<div class="sourceCode" id="cb914"><pre class="sourceCode makefile"><code class="sourceCode makefile"><span id="cb914-1"><a aria-hidden="true" href="#cb914-1" tabindex="-1"></a><span class="co"># Test execution environment</span></span>
<span id="cb914-2"><a aria-hidden="true" href="#cb914-2" tabindex="-1"></a><span class="dt">EMACS</span> <span class="ch">=</span><span class="st"> ../src/emacs</span></span>
<span id="cb914-3"><a aria-hidden="true" href="#cb914-3" tabindex="-1"></a><span class="dt">EMACSOPT</span> <span class="ch">=</span><span class="st"> --no-init-file --no-site-file --no-site-lisp</span></span>
<span id="cb914-4"><a aria-hidden="true" href="#cb914-4" tabindex="-1"></a><span class="dt">TEST_HOME</span> <span class="ch">=</span><span class="st"> /nonexistent  </span><span class="co"># Isolate from user config</span></span>
<span id="cb914-5"><a aria-hidden="true" href="#cb914-5" tabindex="-1"></a></span>
<span id="cb914-6"><a aria-hidden="true" href="#cb914-6" tabindex="-1"></a><span class="co"># Selectors based on native compilation support</span></span>
<span id="cb914-7"><a aria-hidden="true" href="#cb914-7" tabindex="-1"></a><span class="cf">ifeq</span> (<span class="ch">$(</span><span class="dt">TEST_NATIVE_COMP</span><span class="ch">)</span>,yes)</span>
<span id="cb914-8"><a aria-hidden="true" href="#cb914-8" tabindex="-1"></a>  <span class="dt">SELECTOR_DEFAULT</span> <span class="ch">=</span><span class="st"> (not (or (tag :expensive-test) (tag :unstable)))</span></span>
<span id="cb914-9"><a aria-hidden="true" href="#cb914-9" tabindex="-1"></a><span class="cf">else</span></span>
<span id="cb914-10"><a aria-hidden="true" href="#cb914-10" tabindex="-1"></a>  <span class="dt">SELECTOR_DEFAULT</span> <span class="ch">=</span><span class="st"> (not (or (tag :expensive-test) (tag :unstable) (tag :nativecomp)))</span></span>
<span id="cb914-11"><a aria-hidden="true" href="#cb914-11" tabindex="-1"></a><span class="cf">endif</span></span>
<span id="cb914-12"><a aria-hidden="true" href="#cb914-12" tabindex="-1"></a></span>
<span id="cb914-13"><a aria-hidden="true" href="#cb914-13" tabindex="-1"></a><span class="co"># Test execution</span></span>
<span id="cb914-14"><a aria-hidden="true" href="#cb914-14" tabindex="-1"></a><span class="dv">%.log:</span><span class="dt"> %.elc</span></span>
<span id="cb914-15"><a aria-hidden="true" href="#cb914-15" tabindex="-1"></a><span class="er">    </span><span class="dt">HOME</span><span class="ch">=$(</span><span class="dt">TEST_HOME</span><span class="ch">)</span><span class="st"> </span><span class="ch">$(</span><span class="dt">emacs</span><span class="ch">)</span><span class="st"> </span><span class="ch">\</span></span>
<span id="cb914-16"><a aria-hidden="true" href="#cb914-16" tabindex="-1"></a><span class="st">      -l ert -l </span><span class="ch">$(</span><span class="dt">testloadfile</span><span class="ch">)</span><span class="st"> </span><span class="ch">\</span></span>
<span id="cb914-17"><a aria-hidden="true" href="#cb914-17" tabindex="-1"></a><span class="st">      --batch --eval '(ert-run-tests-batch-and-exit (quote </span><span class="ch">${</span><span class="dt">SELECTOR_ACTUAL</span><span class="ch">}</span><span class="st">))'</span></span></code></pre></div>
<h4 data-number="22.3.5.1" id="environment-variables"><span class="header-section-number">22.3.5.1</span> Environment Variables</h4>
<div class="sourceCode" id="cb915"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb915-1"><a aria-hidden="true" href="#cb915-1" tabindex="-1"></a><span class="co"># Set by Makefile</span></span>
<span id="cb915-2"><a aria-hidden="true" href="#cb915-2" tabindex="-1"></a><span class="va">EMACS_TEST_DIRECTORY</span><span class="op">=</span>/path/to/test  <span class="co"># Test root directory</span></span>
<span id="cb915-3"><a aria-hidden="true" href="#cb915-3" tabindex="-1"></a><span class="va">EMACS_EMBA_CI</span><span class="op">=</span>1                     <span class="co"># Set on emba.gnu.org</span></span>
<span id="cb915-4"><a aria-hidden="true" href="#cb915-4" tabindex="-1"></a><span class="va">EMACS_HYDRA_CI</span><span class="op">=</span>1                    <span class="co"># Set on hydra.nixos.org</span></span>
<span id="cb915-5"><a aria-hidden="true" href="#cb915-5" tabindex="-1"></a></span>
<span id="cb915-6"><a aria-hidden="true" href="#cb915-6" tabindex="-1"></a><span class="co"># User-configurable</span></span>
<span id="cb915-7"><a aria-hidden="true" href="#cb915-7" tabindex="-1"></a><span class="va">EMACS_TEST_JUNIT_REPORT</span><span class="op">=</span>report.xml  <span class="co"># JUnit report output</span></span>
<span id="cb915-8"><a aria-hidden="true" href="#cb915-8" tabindex="-1"></a><span class="va">EMACS_TEST_TIMEOUT</span><span class="op">=</span>3600             <span class="co"># Test timeout in seconds</span></span>
<span id="cb915-9"><a aria-hidden="true" href="#cb915-9" tabindex="-1"></a><span class="va">EMACS_TEST_VERBOSE</span><span class="op">=</span>1                <span class="co"># Verbose test output</span></span>
<span id="cb915-10"><a aria-hidden="true" href="#cb915-10" tabindex="-1"></a><span class="va">REMOTE_TEMPORARY_FILE_DIRECTORY</span><span class="op">=</span>/ssh:host:/tmp  <span class="co"># For remote tests</span></span></code></pre></div>
<hr/>
<h2 data-number="22.4" id="development-workflow"><span class="header-section-number">22.4</span> 3. Development Workflow</h2>
<h3 data-number="22.4.1" id="initial-setup"><span class="header-section-number">22.4.1</span> 3.1 Initial Setup</h3>
<div class="sourceCode" id="cb916"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb916-1"><a aria-hidden="true" href="#cb916-1" tabindex="-1"></a><span class="co"># Clone repository</span></span>
<span id="cb916-2"><a aria-hidden="true" href="#cb916-2" tabindex="-1"></a><span class="fu">git</span> clone https://git.savannah.gnu.org/git/emacs.git</span>
<span id="cb916-3"><a aria-hidden="true" href="#cb916-3" tabindex="-1"></a><span class="bu">cd</span> emacs</span>
<span id="cb916-4"><a aria-hidden="true" href="#cb916-4" tabindex="-1"></a></span>
<span id="cb916-5"><a aria-hidden="true" href="#cb916-5" tabindex="-1"></a><span class="co"># Configure for development (recommended settings)</span></span>
<span id="cb916-6"><a aria-hidden="true" href="#cb916-6" tabindex="-1"></a><span class="ex">./autogen.sh</span></span>
<span id="cb916-7"><a aria-hidden="true" href="#cb916-7" tabindex="-1"></a><span class="ex">./configure</span> <span class="dt">\</span></span>
<span id="cb916-8"><a aria-hidden="true" href="#cb916-8" tabindex="-1"></a>    <span class="at">--enable-checking</span><span class="op">=</span><span class="st">'yes,glyphs'</span> <span class="dt">\</span></span>
<span id="cb916-9"><a aria-hidden="true" href="#cb916-9" tabindex="-1"></a>    <span class="at">--enable-check-lisp-object-type</span> <span class="dt">\</span></span>
<span id="cb916-10"><a aria-hidden="true" href="#cb916-10" tabindex="-1"></a>    <span class="at">--with-native-compilation</span> <span class="dt">\</span></span>
<span id="cb916-11"><a aria-hidden="true" href="#cb916-11" tabindex="-1"></a>    CFLAGS=<span class="st">'-O0 -g3'</span></span>
<span id="cb916-12"><a aria-hidden="true" href="#cb916-12" tabindex="-1"></a></span>
<span id="cb916-13"><a aria-hidden="true" href="#cb916-13" tabindex="-1"></a><span class="co"># Build</span></span>
<span id="cb916-14"><a aria-hidden="true" href="#cb916-14" tabindex="-1"></a><span class="fu">make</span> <span class="at">-j</span><span class="va">$(</span><span class="fu">nproc</span><span class="va">)</span></span>
<span id="cb916-15"><a aria-hidden="true" href="#cb916-15" tabindex="-1"></a></span>
<span id="cb916-16"><a aria-hidden="true" href="#cb916-16" tabindex="-1"></a><span class="co"># Verify build</span></span>
<span id="cb916-17"><a aria-hidden="true" href="#cb916-17" tabindex="-1"></a><span class="ex">src/emacs</span> <span class="at">-Q</span> <span class="at">--eval</span> <span class="st">'(message "Emacs %s" emacs-version)'</span></span></code></pre></div>
<h3 data-number="22.4.2" id="debugging-with-gdblldb"><span class="header-section-number">22.4.2</span> 3.2 Debugging with
GDB/LLDB</h3>
<h4 data-number="22.4.2.1" id="gdb-setup"><span class="header-section-number">22.4.2.1</span> GDB Setup</h4>
<div class="sourceCode" id="cb917"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb917-1"><a aria-hidden="true" href="#cb917-1" tabindex="-1"></a><span class="co"># From etc/DEBUG:</span></span>
<span id="cb917-2"><a aria-hidden="true" href="#cb917-2" tabindex="-1"></a></span>
<span id="cb917-3"><a aria-hidden="true" href="#cb917-3" tabindex="-1"></a><span class="co"># Configure for debugging</span></span>
<span id="cb917-4"><a aria-hidden="true" href="#cb917-4" tabindex="-1"></a><span class="ex">./configure</span> <span class="dt">\</span></span>
<span id="cb917-5"><a aria-hidden="true" href="#cb917-5" tabindex="-1"></a>    <span class="at">--enable-checking</span><span class="op">=</span><span class="st">'yes,glyphs'</span> <span class="dt">\</span></span>
<span id="cb917-6"><a aria-hidden="true" href="#cb917-6" tabindex="-1"></a>    <span class="at">--enable-check-lisp-object-type</span> <span class="dt">\</span></span>
<span id="cb917-7"><a aria-hidden="true" href="#cb917-7" tabindex="-1"></a>    CFLAGS=<span class="st">'-O0 -g3 -gdwarf-4'</span></span>
<span id="cb917-8"><a aria-hidden="true" href="#cb917-8" tabindex="-1"></a></span>
<span id="cb917-9"><a aria-hidden="true" href="#cb917-9" tabindex="-1"></a><span class="co"># Additional flags for optimized builds</span></span>
<span id="cb917-10"><a aria-hidden="true" href="#cb917-10" tabindex="-1"></a><span class="va">CFLAGS</span><span class="op">=</span><span class="st">'-O2 -g3 -fno-omit-frame-pointer -fno-crossjumping'</span></span></code></pre></div>
<h4 data-number="22.4.2.2" id="starting-gdb"><span class="header-section-number">22.4.2.2</span> Starting GDB</h4>
<div class="sourceCode" id="cb918"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb918-1"><a aria-hidden="true" href="#cb918-1" tabindex="-1"></a><span class="co"># From command line</span></span>
<span id="cb918-2"><a aria-hidden="true" href="#cb918-2" tabindex="-1"></a><span class="bu">cd</span> src</span>
<span id="cb918-3"><a aria-hidden="true" href="#cb918-3" tabindex="-1"></a><span class="fu">gdb</span> ./emacs</span>
<span id="cb918-4"><a aria-hidden="true" href="#cb918-4" tabindex="-1"></a></span>
<span id="cb918-5"><a aria-hidden="true" href="#cb918-5" tabindex="-1"></a><span class="co"># From within Emacs</span></span>
<span id="cb918-6"><a aria-hidden="true" href="#cb918-6" tabindex="-1"></a><span class="ex">M-x</span> gdb RET</span>
<span id="cb918-7"><a aria-hidden="true" href="#cb918-7" tabindex="-1"></a><span class="fu">gdb</span> <span class="at">-i</span><span class="op">=</span>mi ./emacs</span>
<span id="cb918-8"><a aria-hidden="true" href="#cb918-8" tabindex="-1"></a></span>
<span id="cb918-9"><a aria-hidden="true" href="#cb918-9" tabindex="-1"></a><span class="co"># Enable GUI mode</span></span>
<span id="cb918-10"><a aria-hidden="true" href="#cb918-10" tabindex="-1"></a><span class="ex">M-x</span> gdb-many-windows</span>
<span id="cb918-11"><a aria-hidden="true" href="#cb918-11" tabindex="-1"></a></span>
<span id="cb918-12"><a aria-hidden="true" href="#cb918-12" tabindex="-1"></a><span class="co"># Attach to running Emacs</span></span>
<span id="cb918-13"><a aria-hidden="true" href="#cb918-13" tabindex="-1"></a><span class="fu">gdb</span> <span class="at">-i</span><span class="op">=</span>mi <span class="at">-p</span> PID</span></code></pre></div>
<h4 data-number="22.4.2.3" id="gdb-configuration"><span class="header-section-number">22.4.2.3</span> GDB Configuration</h4>
<p>The <code>src/.gdbinit</code> file defines custom commands:</p>
<pre class="gdb"><code># Lisp object inspection
pp expression        # Pretty-print Lisp object
pr                   # Print Lisp object
xpr                  # Examine Lisp object
xbacktrace           # Show Lisp backtrace

# Specialized printing
xtype                # Print type of Lisp object
xint                 # Print Lisp integer
xsymbol              # Print symbol
xstring              # Print string
xvector              # Print vector
xbuffer              # Print buffer

# Display debugging
xwindow              # Examine window
xframe               # Examine frame

# GDB safety
~/.gdbinit:
add-auto-load-safe-path /path/to/emacs/src/.gdbinit</code></pre>
<h4 data-number="22.4.2.4" id="debugging-techniques"><span class="header-section-number">22.4.2.4</span> Debugging Techniques</h4>
<pre class="gdb"><code># Set breakpoint in C function
(gdb) break xdisp.c:1234
(gdb) break Fsignal

# Conditional breakpoint
(gdb) break foo.c:100 if PT &gt;= 500

# Inspect Lisp backtrace
(gdb) xbacktrace

# Print Lisp variable
(gdb) pp Vload_path

# Continue execution
(gdb) continue
(gdb) step
(gdb) next
(gdb) finish</code></pre>
<h4 data-number="22.4.2.5" id="lldb-macos"><span class="header-section-number">22.4.2.5</span> LLDB (macOS)</h4>
<div class="sourceCode" id="cb921"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb921-1"><a aria-hidden="true" href="#cb921-1" tabindex="-1"></a><span class="co"># Start lldb</span></span>
<span id="cb921-2"><a aria-hidden="true" href="#cb921-2" tabindex="-1"></a><span class="ex">lldb</span> ./emacs</span>
<span id="cb921-3"><a aria-hidden="true" href="#cb921-3" tabindex="-1"></a></span>
<span id="cb921-4"><a aria-hidden="true" href="#cb921-4" tabindex="-1"></a><span class="co"># Run with arguments</span></span>
<span id="cb921-5"><a aria-hidden="true" href="#cb921-5" tabindex="-1"></a><span class="kw">(</span><span class="ex">lldb</span><span class="kw">)</span> <span class="ex">run</span> <span class="at">-Q</span></span>
<span id="cb921-6"><a aria-hidden="true" href="#cb921-6" tabindex="-1"></a></span>
<span id="cb921-7"><a aria-hidden="true" href="#cb921-7" tabindex="-1"></a><span class="co"># Set breakpoint</span></span>
<span id="cb921-8"><a aria-hidden="true" href="#cb921-8" tabindex="-1"></a><span class="kw">(</span><span class="ex">lldb</span><span class="kw">)</span> <span class="ex">breakpoint</span> set <span class="at">--file</span> xdisp.c <span class="at">--line</span> 1234</span>
<span id="cb921-9"><a aria-hidden="true" href="#cb921-9" tabindex="-1"></a><span class="kw">(</span><span class="ex">lldb</span><span class="kw">)</span> <span class="ex">br</span> s <span class="at">-n</span> Fsignal</span>
<span id="cb921-10"><a aria-hidden="true" href="#cb921-10" tabindex="-1"></a></span>
<span id="cb921-11"><a aria-hidden="true" href="#cb921-11" tabindex="-1"></a><span class="co"># Note: LLDB doesn't load .gdbinit</span></span>
<span id="cb921-12"><a aria-hidden="true" href="#cb921-12" tabindex="-1"></a><span class="co"># Custom commands need separate configuration</span></span></code></pre></div>
<h3 data-number="22.4.3" id="byte-compilation"><span class="header-section-number">22.4.3</span> 3.3 Byte Compilation</h3>
<h4 data-number="22.4.3.1" id="what-is-byte-compilation"><span class="header-section-number">22.4.3.1</span> What is Byte
Compilation?</h4>
<p>Byte compilation converts Emacs Lisp to a compact bytecode format for
faster execution.</p>
<pre class="elisp"><code>;; Source: hello.el
(defun hello-world ()
  "Print hello world."
  (message "Hello, world!"))

;; After byte compilation: hello.elc
;; Contains bytecode representation</code></pre>
<h4 data-number="22.4.3.2" id="byte-compiling-files"><span class="header-section-number">22.4.3.2</span> Byte Compiling Files</h4>
<div class="sourceCode" id="cb923"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb923-1"><a aria-hidden="true" href="#cb923-1" tabindex="-1"></a><span class="co"># During build</span></span>
<span id="cb923-2"><a aria-hidden="true" href="#cb923-2" tabindex="-1"></a><span class="fu">make</span>                    <span class="co"># Compiles all Lisp files</span></span>
<span id="cb923-3"><a aria-hidden="true" href="#cb923-3" tabindex="-1"></a></span>
<span id="cb923-4"><a aria-hidden="true" href="#cb923-4" tabindex="-1"></a><span class="co"># Rebuild all .elc files</span></span>
<span id="cb923-5"><a aria-hidden="true" href="#cb923-5" tabindex="-1"></a><span class="bu">cd</span> lisp</span>
<span id="cb923-6"><a aria-hidden="true" href="#cb923-6" tabindex="-1"></a><span class="fu">make</span> compile-always</span>
<span id="cb923-7"><a aria-hidden="true" href="#cb923-7" tabindex="-1"></a></span>
<span id="cb923-8"><a aria-hidden="true" href="#cb923-8" tabindex="-1"></a><span class="co"># Compile single file</span></span>
<span id="cb923-9"><a aria-hidden="true" href="#cb923-9" tabindex="-1"></a><span class="ex">emacs</span> <span class="at">--batch</span> <span class="at">-f</span> batch-byte-compile file.el</span>
<span id="cb923-10"><a aria-hidden="true" href="#cb923-10" tabindex="-1"></a></span>
<span id="cb923-11"><a aria-hidden="true" href="#cb923-11" tabindex="-1"></a><span class="co"># From within Emacs</span></span>
<span id="cb923-12"><a aria-hidden="true" href="#cb923-12" tabindex="-1"></a><span class="ex">M-x</span> byte-compile-file RET file.el RET</span>
<span id="cb923-13"><a aria-hidden="true" href="#cb923-13" tabindex="-1"></a><span class="ex">M-x</span> byte-recompile-directory RET dir RET</span></code></pre></div>
<h4 data-number="22.4.3.3" id="byte-compilation-targets"><span class="header-section-number">22.4.3.3</span> Byte Compilation
Targets</h4>
<div class="sourceCode" id="cb924"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb924-1"><a aria-hidden="true" href="#cb924-1" tabindex="-1"></a><span class="co"># In lisp/Makefile.in</span></span>
<span id="cb924-2"><a aria-hidden="true" href="#cb924-2" tabindex="-1"></a><span class="ex">compile-targets:</span>  <span class="co"># Compile all Lisp files</span></span>
<span id="cb924-3"><a aria-hidden="true" href="#cb924-3" tabindex="-1"></a><span class="ex">compile-always:</span>   <span class="co"># Force recompile</span></span>
<span id="cb924-4"><a aria-hidden="true" href="#cb924-4" tabindex="-1"></a><span class="ex">autoloads:</span>        <span class="co"># Regenerate loaddefs.el</span></span></code></pre></div>
<h4 data-number="22.4.3.4" id="byte-compilation-warnings"><span class="header-section-number">22.4.3.4</span> Byte Compilation
Warnings</h4>
<pre class="elisp"><code>;; Common warnings:

;; Warning: function 'foo' not known to be defined
;; Fix: Add (declare-function foo "file")

;; Warning: assignment to free variable 'bar'
;; Fix: Add (defvar bar) or use let-binding

;; Warning: reference to free variable 'baz'
;; Fix: Declare or pass as parameter

;; Suppress specific warning
(with-suppressed-warnings ((free-vars bar))
  (setq bar 123))</code></pre>
<h3 data-number="22.4.4" id="native-compilation-5"><span class="header-section-number">22.4.4</span> 3.4 Native Compilation</h3>
<p>Native compilation compiles Elisp to native machine code using
libgccjit.</p>
<h4 data-number="22.4.4.1" id="setup"><span class="header-section-number">22.4.4.1</span> Setup</h4>
<div class="sourceCode" id="cb926"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb926-1"><a aria-hidden="true" href="#cb926-1" tabindex="-1"></a><span class="co"># Enable during configure</span></span>
<span id="cb926-2"><a aria-hidden="true" href="#cb926-2" tabindex="-1"></a><span class="ex">./configure</span> <span class="at">--with-native-compilation</span></span>
<span id="cb926-3"><a aria-hidden="true" href="#cb926-3" tabindex="-1"></a></span>
<span id="cb926-4"><a aria-hidden="true" href="#cb926-4" tabindex="-1"></a><span class="co"># Requires libgccjit</span></span>
<span id="cb926-5"><a aria-hidden="true" href="#cb926-5" tabindex="-1"></a><span class="co"># Check if available</span></span>
<span id="cb926-6"><a aria-hidden="true" href="#cb926-6" tabindex="-1"></a><span class="ex">pkg-config</span> <span class="at">--modversion</span> libgccjit</span></code></pre></div>
<h4 data-number="22.4.4.2" id="how-it-works-2"><span class="header-section-number">22.4.4.2</span> How It Works</h4>
<pre class="elisp"><code>;; Automatic compilation at load time
(require 'some-package)  ; Triggers native compilation if needed

;; Compiled files stored in:
~/.emacs.d/eln-cache/31.0.50-&lt;hash&gt;/
  ‚îî‚îÄ‚îÄ some-package-&lt;hash&gt;.eln

;; System files:
/usr/local/lib/emacs/31.0.50/native-lisp/31.0.50-&lt;hash&gt;/</code></pre>
<h4 data-number="22.4.4.3" id="manual-native-compilation"><span class="header-section-number">22.4.4.3</span> Manual Native
Compilation</h4>
<pre class="elisp"><code>;; Compile single file
(native-compile "file.el")

;; Compile asynchronously
(native-compile-async "file.el")

;; Compile directory
(native-compile-async "/path/to/dir" 'recursively)

;; Check native compilation status
(native-comp-available-p)  ; =&gt; t if available</code></pre>
<h4 data-number="22.4.4.4" id="configuration-variables-1"><span class="header-section-number">22.4.4.4</span> Configuration
Variables</h4>
<pre class="elisp"><code>;; Where to store native-compiled files
comp-eln-load-path
;; =&gt; ("~/.emacs.d/eln-cache/"
;;     "/usr/local/lib/emacs/31.0.50/native-lisp/")

;; Compilation verbosity
native-comp-verbose  ; 0-3, higher = more verbose

;; Compilation optimization
native-comp-speed     ; 0-3 (optimization)
native-comp-debug     ; 0-3 (debug info)

;; Async compilation control
native-comp-async-jobs-number    ; Parallel jobs
native-comp-deferred-compilation ; Auto-compile on demand</code></pre>
<h4 data-number="22.4.4.5" id="build-system-integration-1"><span class="header-section-number">22.4.4.5</span> Build System
Integration</h4>
<div class="sourceCode" id="cb930"><pre class="sourceCode makefile"><code class="sourceCode makefile"><span id="cb930-1"><a aria-hidden="true" href="#cb930-1" tabindex="-1"></a><span class="co"># In Makefile.in</span></span>
<span id="cb930-2"><a aria-hidden="true" href="#cb930-2" tabindex="-1"></a><span class="dv">trampolines:</span><span class="dt"> src lisp</span></span>
<span id="cb930-3"><a aria-hidden="true" href="#cb930-3" tabindex="-1"></a><span class="er">    </span><span class="ch">$(</span><span class="dt">MAKE</span><span class="ch">)</span> -C lisp trampolines</span>
<span id="cb930-4"><a aria-hidden="true" href="#cb930-4" tabindex="-1"></a></span>
<span id="cb930-5"><a aria-hidden="true" href="#cb930-5" tabindex="-1"></a><span class="dv">install-eln:</span><span class="dt"> lisp</span></span>
<span id="cb930-6"><a aria-hidden="true" href="#cb930-6" tabindex="-1"></a>    <span class="co"># Install native-compiled files</span></span>
<span id="cb930-7"><a aria-hidden="true" href="#cb930-7" tabindex="-1"></a>    find native-lisp -exec install ...</span></code></pre></div>
<h3 data-number="22.4.5" id="documentation-generation"><span class="header-section-number">22.4.5</span> 3.5 Documentation
Generation</h3>
<h4 data-number="22.4.5.1" id="info-manuals"><span class="header-section-number">22.4.5.1</span> Info Manuals</h4>
<div class="sourceCode" id="cb931"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb931-1"><a aria-hidden="true" href="#cb931-1" tabindex="-1"></a><span class="co"># Build all documentation</span></span>
<span id="cb931-2"><a aria-hidden="true" href="#cb931-2" tabindex="-1"></a><span class="fu">make</span> docs</span>
<span id="cb931-3"><a aria-hidden="true" href="#cb931-3" tabindex="-1"></a></span>
<span id="cb931-4"><a aria-hidden="true" href="#cb931-4" tabindex="-1"></a><span class="co"># Build specific formats</span></span>
<span id="cb931-5"><a aria-hidden="true" href="#cb931-5" tabindex="-1"></a><span class="fu">make</span> info              <span class="co"># Info files</span></span>
<span id="cb931-6"><a aria-hidden="true" href="#cb931-6" tabindex="-1"></a><span class="fu">make</span> html              <span class="co"># HTML documentation</span></span>
<span id="cb931-7"><a aria-hidden="true" href="#cb931-7" tabindex="-1"></a><span class="fu">make</span> pdf               <span class="co"># PDF documentation</span></span>
<span id="cb931-8"><a aria-hidden="true" href="#cb931-8" tabindex="-1"></a><span class="fu">make</span> ps                <span class="co"># PostScript documentation</span></span>
<span id="cb931-9"><a aria-hidden="true" href="#cb931-9" tabindex="-1"></a><span class="fu">make</span> dvi               <span class="co"># DVI files</span></span>
<span id="cb931-10"><a aria-hidden="true" href="#cb931-10" tabindex="-1"></a></span>
<span id="cb931-11"><a aria-hidden="true" href="#cb931-11" tabindex="-1"></a><span class="co"># Individual manuals</span></span>
<span id="cb931-12"><a aria-hidden="true" href="#cb931-12" tabindex="-1"></a><span class="fu">make</span> emacs-info        <span class="co"># Emacs manual</span></span>
<span id="cb931-13"><a aria-hidden="true" href="#cb931-13" tabindex="-1"></a><span class="fu">make</span> elisp-info        <span class="co"># Elisp reference</span></span>
<span id="cb931-14"><a aria-hidden="true" href="#cb931-14" tabindex="-1"></a><span class="fu">make</span> lispref-pdf       <span class="co"># Elisp PDF</span></span>
<span id="cb931-15"><a aria-hidden="true" href="#cb931-15" tabindex="-1"></a><span class="fu">make</span> misc-html         <span class="co"># Misc manuals (org, gnus, etc.)</span></span>
<span id="cb931-16"><a aria-hidden="true" href="#cb931-16" tabindex="-1"></a></span>
<span id="cb931-17"><a aria-hidden="true" href="#cb931-17" tabindex="-1"></a><span class="co"># Install documentation</span></span>
<span id="cb931-18"><a aria-hidden="true" href="#cb931-18" tabindex="-1"></a><span class="fu">make</span> install-info</span>
<span id="cb931-19"><a aria-hidden="true" href="#cb931-19" tabindex="-1"></a><span class="fu">make</span> install-pdf</span>
<span id="cb931-20"><a aria-hidden="true" href="#cb931-20" tabindex="-1"></a><span class="fu">make</span> install-html</span></code></pre></div>
<h4 data-number="22.4.5.2" id="manual-sources"><span class="header-section-number">22.4.5.2</span> Manual Sources</h4>
<pre><code>doc/
‚îú‚îÄ‚îÄ emacs/             # Emacs user manual
‚îÇ   ‚îú‚îÄ‚îÄ emacs.texi
‚îÇ   ‚îî‚îÄ‚îÄ *.texi
‚îú‚îÄ‚îÄ lispref/           # Elisp reference manual
‚îÇ   ‚îú‚îÄ‚îÄ elisp.texi
‚îÇ   ‚îî‚îÄ‚îÄ *.texi
‚îú‚îÄ‚îÄ lispintro/         # Elisp introduction
‚îÇ   ‚îî‚îÄ‚îÄ emacs-lisp-intro.texi
‚îî‚îÄ‚îÄ misc/              # Miscellaneous manuals
    ‚îú‚îÄ‚îÄ org.org        # Org mode (Org format)
    ‚îú‚îÄ‚îÄ gnus.texi      # Gnus
    ‚îú‚îÄ‚îÄ tramp.texi     # TRAMP
    ‚îî‚îÄ‚îÄ ...</code></pre>
<h4 data-number="22.4.5.3" id="texinfo-processing"><span class="header-section-number">22.4.5.3</span> Texinfo Processing</h4>
<div class="sourceCode" id="cb933"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb933-1"><a aria-hidden="true" href="#cb933-1" tabindex="-1"></a><span class="co"># Build Info from Texinfo</span></span>
<span id="cb933-2"><a aria-hidden="true" href="#cb933-2" tabindex="-1"></a><span class="ex">makeinfo</span> emacs.texi <span class="at">-o</span> emacs.info</span>
<span id="cb933-3"><a aria-hidden="true" href="#cb933-3" tabindex="-1"></a></span>
<span id="cb933-4"><a aria-hidden="true" href="#cb933-4" tabindex="-1"></a><span class="co"># Build HTML</span></span>
<span id="cb933-5"><a aria-hidden="true" href="#cb933-5" tabindex="-1"></a><span class="ex">makeinfo</span> <span class="at">--html</span> emacs.texi</span>
<span id="cb933-6"><a aria-hidden="true" href="#cb933-6" tabindex="-1"></a></span>
<span id="cb933-7"><a aria-hidden="true" href="#cb933-7" tabindex="-1"></a><span class="co"># Build PDF (requires TeX)</span></span>
<span id="cb933-8"><a aria-hidden="true" href="#cb933-8" tabindex="-1"></a><span class="ex">texi2pdf</span> emacs.texi</span></code></pre></div>
<h4 data-number="22.4.5.4" id="documentation-validation"><span class="header-section-number">22.4.5.4</span> Documentation
Validation</h4>
<div class="sourceCode" id="cb934"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb934-1"><a aria-hidden="true" href="#cb934-1" tabindex="-1"></a><span class="co"># Check documentation</span></span>
<span id="cb934-2"><a aria-hidden="true" href="#cb934-2" tabindex="-1"></a><span class="fu">make</span> check-info</span>
<span id="cb934-3"><a aria-hidden="true" href="#cb934-3" tabindex="-1"></a></span>
<span id="cb934-4"><a aria-hidden="true" href="#cb934-4" tabindex="-1"></a><span class="co"># Expected output categories:</span></span>
<span id="cb934-5"><a aria-hidden="true" href="#cb934-5" tabindex="-1"></a><span class="co"># - Texinfo documentation system</span></span>
<span id="cb934-6"><a aria-hidden="true" href="#cb934-6" tabindex="-1"></a><span class="co"># - Emacs</span></span>
<span id="cb934-7"><a aria-hidden="true" href="#cb934-7" tabindex="-1"></a><span class="co"># - Emacs lisp</span></span>
<span id="cb934-8"><a aria-hidden="true" href="#cb934-8" tabindex="-1"></a><span class="co"># - Emacs editing modes</span></span>
<span id="cb934-9"><a aria-hidden="true" href="#cb934-9" tabindex="-1"></a><span class="co"># - Emacs network features</span></span>
<span id="cb934-10"><a aria-hidden="true" href="#cb934-10" tabindex="-1"></a><span class="co"># - Emacs misc features</span></span>
<span id="cb934-11"><a aria-hidden="true" href="#cb934-11" tabindex="-1"></a><span class="co"># - Emacs lisp libraries</span></span></code></pre></div>
<h3 data-number="22.4.6" id="release-process"><span class="header-section-number">22.4.6</span> 3.6 Release Process</h3>
<p>From <code>admin/release-process</code>:</p>
<h4 data-number="22.4.6.1" id="release-cycle"><span class="header-section-number">22.4.6.1</span> Release Cycle</h4>
<p><strong>Phase 1: Development</strong> (on master) - New features -
Feature branches - Major changes</p>
<p><strong>Phase 2: Stabilization</strong> (on emacs-NN branch) - Bug
fixes - Documentation - Testing</p>
<h4 data-number="22.4.6.2" id="release-branch-creation"><span class="header-section-number">22.4.6.2</span> Release Branch
Creation</h4>
<div class="sourceCode" id="cb935"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb935-1"><a aria-hidden="true" href="#cb935-1" tabindex="-1"></a><span class="co"># Create release branch</span></span>
<span id="cb935-2"><a aria-hidden="true" href="#cb935-2" tabindex="-1"></a><span class="fu">git</span> checkout <span class="at">-b</span> emacs-31 master</span>
<span id="cb935-3"><a aria-hidden="true" href="#cb935-3" tabindex="-1"></a></span>
<span id="cb935-4"><a aria-hidden="true" href="#cb935-4" tabindex="-1"></a><span class="co"># Update version on master</span></span>
<span id="cb935-5"><a aria-hidden="true" href="#cb935-5" tabindex="-1"></a><span class="co"># In admin/admin.el:</span></span>
<span id="cb935-6"><a aria-hidden="true" href="#cb935-6" tabindex="-1"></a><span class="kw">(</span><span class="ex">set-version</span> <span class="st">"32.0.50"</span><span class="kw">)</span></span>
<span id="cb935-7"><a aria-hidden="true" href="#cb935-7" tabindex="-1"></a></span>
<span id="cb935-8"><a aria-hidden="true" href="#cb935-8" tabindex="-1"></a><span class="co"># Update version on branch</span></span>
<span id="cb935-9"><a aria-hidden="true" href="#cb935-9" tabindex="-1"></a><span class="kw">(</span><span class="ex">set-version</span> <span class="st">"31.1"</span><span class="kw">)</span></span>
<span id="cb935-10"><a aria-hidden="true" href="#cb935-10" tabindex="-1"></a></span>
<span id="cb935-11"><a aria-hidden="true" href="#cb935-11" tabindex="-1"></a><span class="co"># Update customize-changed-options-previous-release</span></span>
<span id="cb935-12"><a aria-hidden="true" href="#cb935-12" tabindex="-1"></a><span class="co"># (for major releases only)</span></span></code></pre></div>
<h4 data-number="22.4.6.3" id="pre-release-checklist"><span class="header-section-number">22.4.6.3</span> Pre-Release Checklist</h4>
<div class="sourceCode" id="cb936"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb936-1"><a aria-hidden="true" href="#cb936-1" tabindex="-1"></a><span class="co"># 1. Update copyright years</span></span>
<span id="cb936-2"><a aria-hidden="true" href="#cb936-2" tabindex="-1"></a><span class="ex">M-x</span> set-copyright RET</span>
<span id="cb936-3"><a aria-hidden="true" href="#cb936-3" tabindex="-1"></a></span>
<span id="cb936-4"><a aria-hidden="true" href="#cb936-4" tabindex="-1"></a><span class="co"># 2. Check release-blocking bugs</span></span>
<span id="cb936-5"><a aria-hidden="true" href="#cb936-5" tabindex="-1"></a><span class="co"># See https://debbugs.gnu.org/</span></span>
<span id="cb936-6"><a aria-hidden="true" href="#cb936-6" tabindex="-1"></a></span>
<span id="cb936-7"><a aria-hidden="true" href="#cb936-7" tabindex="-1"></a><span class="co"># 3. Proofread manuals</span></span>
<span id="cb936-8"><a aria-hidden="true" href="#cb936-8" tabindex="-1"></a><span class="co"># Each chapter reviewed by 2+ people</span></span>
<span id="cb936-9"><a aria-hidden="true" href="#cb936-9" tabindex="-1"></a></span>
<span id="cb936-10"><a aria-hidden="true" href="#cb936-10" tabindex="-1"></a><span class="co"># 4. Run test suite</span></span>
<span id="cb936-11"><a aria-hidden="true" href="#cb936-11" tabindex="-1"></a><span class="fu">make</span> check-expensive</span>
<span id="cb936-12"><a aria-hidden="true" href="#cb936-12" tabindex="-1"></a></span>
<span id="cb936-13"><a aria-hidden="true" href="#cb936-13" tabindex="-1"></a><span class="co"># 5. Build on multiple platforms</span></span>
<span id="cb936-14"><a aria-hidden="true" href="#cb936-14" tabindex="-1"></a></span>
<span id="cb936-15"><a aria-hidden="true" href="#cb936-15" tabindex="-1"></a><span class="co"># 6. Create release tarball</span></span>
<span id="cb936-16"><a aria-hidden="true" href="#cb936-16" tabindex="-1"></a><span class="co"># See admin/make-tarball.txt</span></span></code></pre></div>
<h4 data-number="22.4.6.4" id="making-a-release"><span class="header-section-number">22.4.6.4</span> Making a Release</h4>
<p>Detailed instructions in <code>admin/make-tarball.txt</code>:</p>
<div class="sourceCode" id="cb937"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb937-1"><a aria-hidden="true" href="#cb937-1" tabindex="-1"></a><span class="co"># 1. Update version numbers</span></span>
<span id="cb937-2"><a aria-hidden="true" href="#cb937-2" tabindex="-1"></a><span class="ex">admin/admin.el:</span> <span class="er">(</span><span class="ex">set-version</span> <span class="st">"31.1"</span><span class="kw">)</span></span>
<span id="cb937-3"><a aria-hidden="true" href="#cb937-3" tabindex="-1"></a></span>
<span id="cb937-4"><a aria-hidden="true" href="#cb937-4" tabindex="-1"></a><span class="co"># 2. Update NEWS</span></span>
<span id="cb937-5"><a aria-hidden="true" href="#cb937-5" tabindex="-1"></a><span class="co"># Review all changes since last release</span></span>
<span id="cb937-6"><a aria-hidden="true" href="#cb937-6" tabindex="-1"></a></span>
<span id="cb937-7"><a aria-hidden="true" href="#cb937-7" tabindex="-1"></a><span class="co"># 3. Tag release</span></span>
<span id="cb937-8"><a aria-hidden="true" href="#cb937-8" tabindex="-1"></a><span class="fu">git</span> tag <span class="at">-a</span> emacs-31.1 <span class="at">-m</span> <span class="st">"Emacs 31.1 release"</span></span>
<span id="cb937-9"><a aria-hidden="true" href="#cb937-9" tabindex="-1"></a></span>
<span id="cb937-10"><a aria-hidden="true" href="#cb937-10" tabindex="-1"></a><span class="co"># 4. Create tarball</span></span>
<span id="cb937-11"><a aria-hidden="true" href="#cb937-11" tabindex="-1"></a><span class="bu">cd</span> admin</span>
<span id="cb937-12"><a aria-hidden="true" href="#cb937-12" tabindex="-1"></a><span class="ex">./make-tarball</span> emacs-31.1</span>
<span id="cb937-13"><a aria-hidden="true" href="#cb937-13" tabindex="-1"></a></span>
<span id="cb937-14"><a aria-hidden="true" href="#cb937-14" tabindex="-1"></a><span class="co"># 5. Sign and upload</span></span>
<span id="cb937-15"><a aria-hidden="true" href="#cb937-15" tabindex="-1"></a><span class="ex">gpg</span> <span class="at">--detach-sign</span> emacs-31.1.tar.xz</span>
<span id="cb937-16"><a aria-hidden="true" href="#cb937-16" tabindex="-1"></a><span class="co"># Upload to ftp.gnu.org</span></span></code></pre></div>
<hr/>
<h2 data-number="22.5" id="quality-assurance"><span class="header-section-number">22.5</span> 4. Quality Assurance</h2>
<h3 data-number="22.5.1" id="static-analysis-tools"><span class="header-section-number">22.5.1</span> 4.1 Static Analysis
Tools</h3>
<h4 data-number="22.5.1.1" id="check-declare"><span class="header-section-number">22.5.1.1</span> Check Declare</h4>
<p>Verify function declarations match definitions:</p>
<div class="sourceCode" id="cb938"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb938-1"><a aria-hidden="true" href="#cb938-1" tabindex="-1"></a><span class="co"># Check entire codebase</span></span>
<span id="cb938-2"><a aria-hidden="true" href="#cb938-2" tabindex="-1"></a><span class="fu">make</span> check-declare</span>
<span id="cb938-3"><a aria-hidden="true" href="#cb938-3" tabindex="-1"></a></span>
<span id="cb938-4"><a aria-hidden="true" href="#cb938-4" tabindex="-1"></a><span class="co"># From Emacs</span></span>
<span id="cb938-5"><a aria-hidden="true" href="#cb938-5" tabindex="-1"></a><span class="ex">M-x</span> check-declare-directory RET lisp/ RET</span>
<span id="cb938-6"><a aria-hidden="true" href="#cb938-6" tabindex="-1"></a></span>
<span id="cb938-7"><a aria-hidden="true" href="#cb938-7" tabindex="-1"></a><span class="co"># In source file</span></span>
<span id="cb938-8"><a aria-hidden="true" href="#cb938-8" tabindex="-1"></a><span class="kw">;;;</span><span class="co">###autoload</span></span>
<span id="cb938-9"><a aria-hidden="true" href="#cb938-9" tabindex="-1"></a><span class="kw">(</span><span class="ex">declare-function</span> external-func <span class="st">"ext-file"</span> <span class="er">(</span><span class="ex">arg1</span> arg2<span class="kw">))</span></span></code></pre></div>
<h4 data-number="22.5.1.2" id="checkdoc"><span class="header-section-number">22.5.1.2</span> Checkdoc</h4>
<p>Validate documentation strings:</p>
<pre class="elisp"><code>;; Run on current buffer
M-x checkdoc

;; Run on file
M-x checkdoc-file

;; Run on directory
M-x checkdoc-directory

;; Common checkdoc requirements:
;; - First line is complete sentence
;; - Function args in UPPERCASE
;; - End with period
;; - Describe return value

;; Good docstring:
(defun my-function (ARG1 ARG2)
  "Do something with ARG1 and ARG2.
ARG1 should be a string.
ARG2 should be a number.
Return the result as a list."
  ...)

;; checkdoc configuration
(setq checkdoc-spellcheck-documentation-flag t)
(setq checkdoc-arguments-in-order-flag t)</code></pre>
<h4 data-number="22.5.1.3" id="package-lint"><span class="header-section-number">22.5.1.3</span> Package Lint</h4>
<p>Check package metadata and structure:</p>
<pre class="elisp"><code>;; From package-lint.el (ELPA)
(require 'package-lint)

;; Check current buffer
M-x package-lint-current-buffer

;; Required package headers:
;; Author: Name &lt;email&gt;
;; Version: 1.0
;; Package-Requires: ((emacs "26.1"))
;; Keywords: convenience
;; URL: https://example.com</code></pre>
<h4 data-number="22.5.1.4" id="byte-compiler-warnings"><span class="header-section-number">22.5.1.4</span> Byte Compiler
Warnings</h4>
<div class="sourceCode" id="cb941"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb941-1"><a aria-hidden="true" href="#cb941-1" tabindex="-1"></a><span class="co"># Compile with warnings</span></span>
<span id="cb941-2"><a aria-hidden="true" href="#cb941-2" tabindex="-1"></a><span class="ex">emacs</span> <span class="at">--batch</span> <span class="at">-f</span> batch-byte-compile file.el <span class="dv">2</span><span class="op">&gt;&amp;</span><span class="dv">1</span> <span class="kw">|</span> <span class="fu">grep</span> <span class="at">-i</span> warning</span>
<span id="cb941-3"><a aria-hidden="true" href="#cb941-3" tabindex="-1"></a></span>
<span id="cb941-4"><a aria-hidden="true" href="#cb941-4" tabindex="-1"></a><span class="co"># Configure warning level</span></span>
<span id="cb941-5"><a aria-hidden="true" href="#cb941-5" tabindex="-1"></a><span class="kw">(</span><span class="ex">setq</span> byte-compile-warnings t<span class="kw">)</span>     <span class="kw">;</span> <span class="ex">All</span> warnings</span>
<span id="cb941-6"><a aria-hidden="true" href="#cb941-6" tabindex="-1"></a><span class="kw">(</span><span class="ex">setq</span> byte-compile-warnings nil<span class="kw">)</span>   <span class="kw">;</span> <span class="ex">No</span> warnings</span>
<span id="cb941-7"><a aria-hidden="true" href="#cb941-7" tabindex="-1"></a><span class="kw">(</span><span class="ex">setq</span> byte-compile-warnings <span class="st">'(free-vars unresolved))  ; Specific</span></span></code></pre></div>
<h3 data-number="22.5.2" id="compiler-warnings"><span class="header-section-number">22.5.2</span> 4.2 Compiler Warnings</h3>
<h4 data-number="22.5.2.1" id="configuration-warning-flags"><span class="header-section-number">22.5.2.1</span> Configuration Warning
Flags</h4>
<div class="sourceCode" id="cb942"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb942-1"><a aria-hidden="true" href="#cb942-1" tabindex="-1"></a><span class="co"># In configure.ac</span></span>
<span id="cb942-2"><a aria-hidden="true" href="#cb942-2" tabindex="-1"></a><span class="ex">WARN_CFLAGS</span> = <span class="at">-Wall</span> <span class="at">-Wextra</span> <span class="at">-Wno-unused-parameter</span> ...</span>
<span id="cb942-3"><a aria-hidden="true" href="#cb942-3" tabindex="-1"></a><span class="ex">WERROR_CFLAGS</span> = <span class="at">-Werror</span>  <span class="co"># Treat warnings as errors</span></span>
<span id="cb942-4"><a aria-hidden="true" href="#cb942-4" tabindex="-1"></a></span>
<span id="cb942-5"><a aria-hidden="true" href="#cb942-5" tabindex="-1"></a><span class="co"># Build with maximum warnings</span></span>
<span id="cb942-6"><a aria-hidden="true" href="#cb942-6" tabindex="-1"></a><span class="ex">./configure</span> CFLAGS=<span class="st">'-Wall -Wextra -Werror'</span></span>
<span id="cb942-7"><a aria-hidden="true" href="#cb942-7" tabindex="-1"></a></span>
<span id="cb942-8"><a aria-hidden="true" href="#cb942-8" tabindex="-1"></a><span class="co"># Disable specific warnings</span></span>
<span id="cb942-9"><a aria-hidden="true" href="#cb942-9" tabindex="-1"></a><span class="ex">./configure</span> CFLAGS=<span class="st">'-Wall -Wno-unused-variable'</span></span></code></pre></div>
<h4 data-number="22.5.2.2" id="gcc-warning-options"><span class="header-section-number">22.5.2.2</span> GCC Warning Options</h4>
<div class="sourceCode" id="cb943"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb943-1"><a aria-hidden="true" href="#cb943-1" tabindex="-1"></a><span class="co"># From m4/manywarnings.m4</span></span>
<span id="cb943-2"><a aria-hidden="true" href="#cb943-2" tabindex="-1"></a><span class="co"># Emacs enables numerous warnings:</span></span>
<span id="cb943-3"><a aria-hidden="true" href="#cb943-3" tabindex="-1"></a><span class="ex">-Wall</span>                    <span class="co"># Standard warnings</span></span>
<span id="cb943-4"><a aria-hidden="true" href="#cb943-4" tabindex="-1"></a><span class="ex">-Wextra</span>                  <span class="co"># Extra warnings</span></span>
<span id="cb943-5"><a aria-hidden="true" href="#cb943-5" tabindex="-1"></a><span class="ex">-Wcast-align</span>             <span class="co"># Alignment casts</span></span>
<span id="cb943-6"><a aria-hidden="true" href="#cb943-6" tabindex="-1"></a><span class="ex">-Wdouble-promotion</span>       <span class="co"># Float to double</span></span>
<span id="cb943-7"><a aria-hidden="true" href="#cb943-7" tabindex="-1"></a><span class="ex">-Wformat-security</span>        <span class="co"># Printf format security</span></span>
<span id="cb943-8"><a aria-hidden="true" href="#cb943-8" tabindex="-1"></a><span class="ex">-Wimplicit-fallthrough</span>   <span class="co"># Switch fallthrough</span></span>
<span id="cb943-9"><a aria-hidden="true" href="#cb943-9" tabindex="-1"></a><span class="ex">-Wmissing-prototypes</span>     <span class="co"># Missing prototypes</span></span>
<span id="cb943-10"><a aria-hidden="true" href="#cb943-10" tabindex="-1"></a><span class="ex">-Wshadow</span>                 <span class="co"># Variable shadowing</span></span>
<span id="cb943-11"><a aria-hidden="true" href="#cb943-11" tabindex="-1"></a><span class="ex">-Wunused</span>                 <span class="co"># Unused code</span></span>
<span id="cb943-12"><a aria-hidden="true" href="#cb943-12" tabindex="-1"></a><span class="co"># And many more...</span></span></code></pre></div>
<h3 data-number="22.5.3" id="addresssanitizer-asan"><span class="header-section-number">22.5.3</span> 4.3 AddressSanitizer
(ASan)</h3>
<p>AddressSanitizer detects memory errors at runtime.</p>
<h4 data-number="22.5.3.1" id="building-with-asan"><span class="header-section-number">22.5.3.1</span> Building with ASan</h4>
<div class="sourceCode" id="cb944"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb944-1"><a aria-hidden="true" href="#cb944-1" tabindex="-1"></a><span class="co"># Configure with ASan</span></span>
<span id="cb944-2"><a aria-hidden="true" href="#cb944-2" tabindex="-1"></a><span class="ex">./configure</span> <span class="dt">\</span></span>
<span id="cb944-3"><a aria-hidden="true" href="#cb944-3" tabindex="-1"></a>    CFLAGS=<span class="st">'-fsanitize=address -fsanitize-address-use-after-scope -O1 -g3'</span> <span class="dt">\</span></span>
<span id="cb944-4"><a aria-hidden="true" href="#cb944-4" tabindex="-1"></a>    LDFLAGS=<span class="st">'-fsanitize=address'</span></span>
<span id="cb944-5"><a aria-hidden="true" href="#cb944-5" tabindex="-1"></a></span>
<span id="cb944-6"><a aria-hidden="true" href="#cb944-6" tabindex="-1"></a><span class="co"># Build</span></span>
<span id="cb944-7"><a aria-hidden="true" href="#cb944-7" tabindex="-1"></a><span class="fu">make</span></span>
<span id="cb944-8"><a aria-hidden="true" href="#cb944-8" tabindex="-1"></a></span>
<span id="cb944-9"><a aria-hidden="true" href="#cb944-9" tabindex="-1"></a><span class="co"># Run (ASan enabled automatically)</span></span>
<span id="cb944-10"><a aria-hidden="true" href="#cb944-10" tabindex="-1"></a><span class="ex">src/emacs</span></span>
<span id="cb944-11"><a aria-hidden="true" href="#cb944-11" tabindex="-1"></a></span>
<span id="cb944-12"><a aria-hidden="true" href="#cb944-12" tabindex="-1"></a><span class="co"># ASan will report errors like:</span></span>
<span id="cb944-13"><a aria-hidden="true" href="#cb944-13" tabindex="-1"></a><span class="co"># - Heap buffer overflow</span></span>
<span id="cb944-14"><a aria-hidden="true" href="#cb944-14" tabindex="-1"></a><span class="co"># - Stack buffer overflow</span></span>
<span id="cb944-15"><a aria-hidden="true" href="#cb944-15" tabindex="-1"></a><span class="co"># - Use after free</span></span>
<span id="cb944-16"><a aria-hidden="true" href="#cb944-16" tabindex="-1"></a><span class="co"># - Use after return</span></span>
<span id="cb944-17"><a aria-hidden="true" href="#cb944-17" tabindex="-1"></a><span class="co"># - Double free</span></span>
<span id="cb944-18"><a aria-hidden="true" href="#cb944-18" tabindex="-1"></a><span class="co"># - Memory leaks</span></span></code></pre></div>
<h4 data-number="22.5.3.2" id="asan-configuration"><span class="header-section-number">22.5.3.2</span> ASan Configuration</h4>
<div class="sourceCode" id="cb945"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb945-1"><a aria-hidden="true" href="#cb945-1" tabindex="-1"></a><span class="co"># ASan runtime options</span></span>
<span id="cb945-2"><a aria-hidden="true" href="#cb945-2" tabindex="-1"></a><span class="bu">export</span> <span class="va">ASAN_OPTIONS</span><span class="op">=</span><span class="st">'detect_leaks=1:symbolize=1:abort_on_error=1'</span></span>
<span id="cb945-3"><a aria-hidden="true" href="#cb945-3" tabindex="-1"></a></span>
<span id="cb945-4"><a aria-hidden="true" href="#cb945-4" tabindex="-1"></a><span class="co"># Symbolize backtraces</span></span>
<span id="cb945-5"><a aria-hidden="true" href="#cb945-5" tabindex="-1"></a><span class="bu">export</span> <span class="va">ASAN_SYMBOLIZER_PATH</span><span class="op">=</span>/usr/bin/llvm-symbolizer</span></code></pre></div>
<h4 data-number="22.5.3.3" id="asan-in-configure.ac"><span class="header-section-number">22.5.3.3</span> ASan in configure.ac</h4>
<div class="sourceCode" id="cb946"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb946-1"><a aria-hidden="true" href="#cb946-1" tabindex="-1"></a><span class="co">// Automatic detection</span></span>
<span id="cb946-2"><a aria-hidden="true" href="#cb946-2" tabindex="-1"></a><span class="pp">#if defined __SANITIZE_ADDRESS__ || __has_feature (address_sanitizer)</span></span>
<span id="cb946-3"><a aria-hidden="true" href="#cb946-3" tabindex="-1"></a>  <span class="co">// ASan is enabled</span></span>
<span id="cb946-4"><a aria-hidden="true" href="#cb946-4" tabindex="-1"></a><span class="pp">#endif</span></span>
<span id="cb946-5"><a aria-hidden="true" href="#cb946-5" tabindex="-1"></a></span>
<span id="cb946-6"><a aria-hidden="true" href="#cb946-6" tabindex="-1"></a><span class="co">// Headers checked</span></span>
<span id="cb946-7"><a aria-hidden="true" href="#cb946-7" tabindex="-1"></a>sanitizer<span class="op">/</span>asan_interface<span class="op">.</span>h</span>
<span id="cb946-8"><a aria-hidden="true" href="#cb946-8" tabindex="-1"></a>sanitizer<span class="op">/</span>lsan_interface<span class="op">.</span>h</span>
<span id="cb946-9"><a aria-hidden="true" href="#cb946-9" tabindex="-1"></a>sanitizer<span class="op">/</span>common_interface_defs<span class="op">.</span>h</span></code></pre></div>
<h3 data-number="22.5.4" id="valgrind-support"><span class="header-section-number">22.5.4</span> 4.4 Valgrind Support</h3>
<p>Valgrind provides memory debugging and profiling.</p>
<h4 data-number="22.5.4.1" id="valgrind-headers"><span class="header-section-number">22.5.4.1</span> Valgrind Headers</h4>
<div class="sourceCode" id="cb947"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb947-1"><a aria-hidden="true" href="#cb947-1" tabindex="-1"></a><span class="co"># configure.ac checks for</span></span>
<span id="cb947-2"><a aria-hidden="true" href="#cb947-2" tabindex="-1"></a><span class="ex">AC_CHECK_HEADERS</span><span class="er">(</span><span class="ex">[valgrind/valgrind.h]</span><span class="kw">)</span></span>
<span id="cb947-3"><a aria-hidden="true" href="#cb947-3" tabindex="-1"></a></span>
<span id="cb947-4"><a aria-hidden="true" href="#cb947-4" tabindex="-1"></a><span class="co"># When available, Emacs uses Valgrind client requests</span></span>
<span id="cb947-5"><a aria-hidden="true" href="#cb947-5" tabindex="-1"></a><span class="co">#include &lt;valgrind/valgrind.h&gt;</span></span></code></pre></div>
<h4 data-number="22.5.4.2" id="running-under-valgrind"><span class="header-section-number">22.5.4.2</span> Running Under
Valgrind</h4>
<div class="sourceCode" id="cb948"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb948-1"><a aria-hidden="true" href="#cb948-1" tabindex="-1"></a><span class="co"># Memory error detection</span></span>
<span id="cb948-2"><a aria-hidden="true" href="#cb948-2" tabindex="-1"></a><span class="fu">valgrind</span> <span class="at">--leak-check</span><span class="op">=</span>full <span class="at">--track-origins</span><span class="op">=</span>yes src/emacs <span class="at">-Q</span></span>
<span id="cb948-3"><a aria-hidden="true" href="#cb948-3" tabindex="-1"></a></span>
<span id="cb948-4"><a aria-hidden="true" href="#cb948-4" tabindex="-1"></a><span class="co"># Cachegrind (cache profiling)</span></span>
<span id="cb948-5"><a aria-hidden="true" href="#cb948-5" tabindex="-1"></a><span class="fu">valgrind</span> <span class="at">--tool</span><span class="op">=</span>cachegrind src/emacs <span class="at">-Q</span></span>
<span id="cb948-6"><a aria-hidden="true" href="#cb948-6" tabindex="-1"></a></span>
<span id="cb948-7"><a aria-hidden="true" href="#cb948-7" tabindex="-1"></a><span class="co"># Callgrind (call profiling)</span></span>
<span id="cb948-8"><a aria-hidden="true" href="#cb948-8" tabindex="-1"></a><span class="fu">valgrind</span> <span class="at">--tool</span><span class="op">=</span>callgrind src/emacs <span class="at">-Q</span></span>
<span id="cb948-9"><a aria-hidden="true" href="#cb948-9" tabindex="-1"></a></span>
<span id="cb948-10"><a aria-hidden="true" href="#cb948-10" tabindex="-1"></a><span class="co"># Massif (heap profiling)</span></span>
<span id="cb948-11"><a aria-hidden="true" href="#cb948-11" tabindex="-1"></a><span class="fu">valgrind</span> <span class="at">--tool</span><span class="op">=</span>massif src/emacs <span class="at">-Q</span></span></code></pre></div>
<h4 data-number="22.5.4.3" id="suppression-files"><span class="header-section-number">22.5.4.3</span> Suppression Files</h4>
<div class="sourceCode" id="cb949"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb949-1"><a aria-hidden="true" href="#cb949-1" tabindex="-1"></a><span class="co"># Create suppression file for known issues</span></span>
<span id="cb949-2"><a aria-hidden="true" href="#cb949-2" tabindex="-1"></a><span class="fu">valgrind</span> <span class="at">--gen-suppressions</span><span class="op">=</span>all src/emacs <span class="at">-Q</span> <span class="dv">2</span><span class="op">&gt;&amp;</span><span class="dv">1</span> <span class="kw">|</span> <span class="dt">\</span></span>
<span id="cb949-3"><a aria-hidden="true" href="#cb949-3" tabindex="-1"></a>  <span class="fu">grep</span> <span class="at">-A</span> 50 <span class="st">"^{"</span> <span class="op">&gt;</span> emacs.supp</span>
<span id="cb949-4"><a aria-hidden="true" href="#cb949-4" tabindex="-1"></a></span>
<span id="cb949-5"><a aria-hidden="true" href="#cb949-5" tabindex="-1"></a><span class="co"># Use suppression file</span></span>
<span id="cb949-6"><a aria-hidden="true" href="#cb949-6" tabindex="-1"></a><span class="fu">valgrind</span> <span class="at">--suppressions</span><span class="op">=</span>emacs.supp src/emacs <span class="at">-Q</span></span></code></pre></div>
<h3 data-number="22.5.5" id="code-coverage"><span class="header-section-number">22.5.5</span> 4.5 Code Coverage</h3>
<h4 data-number="22.5.5.1" id="coverage-build"><span class="header-section-number">22.5.5.1</span> Coverage Build</h4>
<div class="sourceCode" id="cb950"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb950-1"><a aria-hidden="true" href="#cb950-1" tabindex="-1"></a><span class="co"># Configure with coverage</span></span>
<span id="cb950-2"><a aria-hidden="true" href="#cb950-2" tabindex="-1"></a><span class="ex">./configure</span> CFLAGS=<span class="st">'--coverage -O0 -g3'</span></span>
<span id="cb950-3"><a aria-hidden="true" href="#cb950-3" tabindex="-1"></a></span>
<span id="cb950-4"><a aria-hidden="true" href="#cb950-4" tabindex="-1"></a><span class="co"># Build</span></span>
<span id="cb950-5"><a aria-hidden="true" href="#cb950-5" tabindex="-1"></a><span class="fu">make</span></span>
<span id="cb950-6"><a aria-hidden="true" href="#cb950-6" tabindex="-1"></a></span>
<span id="cb950-7"><a aria-hidden="true" href="#cb950-7" tabindex="-1"></a><span class="co"># Run tests</span></span>
<span id="cb950-8"><a aria-hidden="true" href="#cb950-8" tabindex="-1"></a><span class="fu">make</span> check</span>
<span id="cb950-9"><a aria-hidden="true" href="#cb950-9" tabindex="-1"></a></span>
<span id="cb950-10"><a aria-hidden="true" href="#cb950-10" tabindex="-1"></a><span class="co"># Generate coverage report</span></span>
<span id="cb950-11"><a aria-hidden="true" href="#cb950-11" tabindex="-1"></a><span class="ex">lcov</span> <span class="at">--capture</span> <span class="at">--directory</span> src <span class="at">--output-file</span> coverage.info</span>
<span id="cb950-12"><a aria-hidden="true" href="#cb950-12" tabindex="-1"></a><span class="ex">genhtml</span> coverage.info <span class="at">--output-directory</span> coverage-html</span></code></pre></div>
<h4 data-number="22.5.5.2" id="hydra-coverage-job"><span class="header-section-number">22.5.5.2</span> Hydra Coverage Job</h4>
<p>From <code>admin/notes/hydra</code>:</p>
<pre><code>The 'coverage' job does a gcov build and then runs
'make check-expensive'. Fails if any test fails.</code></pre>
<hr/>
<h2 data-number="22.6" id="platform-specific-information"><span class="header-section-number">22.6</span> 5. Platform-Specific
Information</h2>
<h3 data-number="22.6.1" id="unixlinux"><span class="header-section-number">22.6.1</span> 5.1 Unix/Linux</h3>
<h4 data-number="22.6.1.1" id="standard-build"><span class="header-section-number">22.6.1.1</span> Standard Build</h4>
<div class="sourceCode" id="cb952"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb952-1"><a aria-hidden="true" href="#cb952-1" tabindex="-1"></a><span class="ex">./configure</span></span>
<span id="cb952-2"><a aria-hidden="true" href="#cb952-2" tabindex="-1"></a><span class="fu">make</span></span>
<span id="cb952-3"><a aria-hidden="true" href="#cb952-3" tabindex="-1"></a><span class="fu">sudo</span> make install</span></code></pre></div>
<h4 data-number="22.6.1.2" id="common-issues-3"><span class="header-section-number">22.6.1.2</span> Common Issues</h4>
<div class="sourceCode" id="cb953"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb953-1"><a aria-hidden="true" href="#cb953-1" tabindex="-1"></a><span class="co"># Missing dependencies</span></span>
<span id="cb953-2"><a aria-hidden="true" href="#cb953-2" tabindex="-1"></a><span class="co"># Debian/Ubuntu:</span></span>
<span id="cb953-3"><a aria-hidden="true" href="#cb953-3" tabindex="-1"></a><span class="fu">sudo</span> apt-get install build-essential libgtk-3-dev libgnutls28-dev <span class="dt">\</span></span>
<span id="cb953-4"><a aria-hidden="true" href="#cb953-4" tabindex="-1"></a>  libtiff5-dev libgif-dev libjpeg-dev libpng-dev libxpm-dev <span class="dt">\</span></span>
<span id="cb953-5"><a aria-hidden="true" href="#cb953-5" tabindex="-1"></a>  libncurses-dev texinfo</span>
<span id="cb953-6"><a aria-hidden="true" href="#cb953-6" tabindex="-1"></a></span>
<span id="cb953-7"><a aria-hidden="true" href="#cb953-7" tabindex="-1"></a><span class="co"># Fedora:</span></span>
<span id="cb953-8"><a aria-hidden="true" href="#cb953-8" tabindex="-1"></a><span class="fu">sudo</span> dnf install gcc make ncurses-devel gnutls-devel gtk3-devel</span>
<span id="cb953-9"><a aria-hidden="true" href="#cb953-9" tabindex="-1"></a></span>
<span id="cb953-10"><a aria-hidden="true" href="#cb953-10" tabindex="-1"></a><span class="co"># Arch:</span></span>
<span id="cb953-11"><a aria-hidden="true" href="#cb953-11" tabindex="-1"></a><span class="fu">sudo</span> pacman <span class="at">-S</span> base-devel libx11 libxpm libjpeg-turbo libtiff giflib <span class="dt">\</span></span>
<span id="cb953-12"><a aria-hidden="true" href="#cb953-12" tabindex="-1"></a>  libpng gnutls ncurses</span></code></pre></div>
<h3 data-number="22.6.2" id="macos"><span class="header-section-number">22.6.2</span> 5.2 macOS</h3>
<h4 data-number="22.6.2.1" id="building-on-macos"><span class="header-section-number">22.6.2.1</span> Building on macOS</h4>
<div class="sourceCode" id="cb954"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb954-1"><a aria-hidden="true" href="#cb954-1" tabindex="-1"></a><span class="co"># Install dependencies with Homebrew</span></span>
<span id="cb954-2"><a aria-hidden="true" href="#cb954-2" tabindex="-1"></a><span class="ex">brew</span> install autoconf automake texinfo gnutls librsvg</span>
<span id="cb954-3"><a aria-hidden="true" href="#cb954-3" tabindex="-1"></a></span>
<span id="cb954-4"><a aria-hidden="true" href="#cb954-4" tabindex="-1"></a><span class="co"># Configure for macOS</span></span>
<span id="cb954-5"><a aria-hidden="true" href="#cb954-5" tabindex="-1"></a><span class="ex">./configure</span> <span class="at">--with-ns</span> <span class="at">--with-modules</span></span>
<span id="cb954-6"><a aria-hidden="true" href="#cb954-6" tabindex="-1"></a></span>
<span id="cb954-7"><a aria-hidden="true" href="#cb954-7" tabindex="-1"></a><span class="co"># Build Emacs.app</span></span>
<span id="cb954-8"><a aria-hidden="true" href="#cb954-8" tabindex="-1"></a><span class="fu">make</span></span>
<span id="cb954-9"><a aria-hidden="true" href="#cb954-9" tabindex="-1"></a><span class="fu">make</span> install</span>
<span id="cb954-10"><a aria-hidden="true" href="#cb954-10" tabindex="-1"></a></span>
<span id="cb954-11"><a aria-hidden="true" href="#cb954-11" tabindex="-1"></a><span class="co"># Result: nextstep/Emacs.app</span></span>
<span id="cb954-12"><a aria-hidden="true" href="#cb954-12" tabindex="-1"></a><span class="co"># Copy to /Applications if desired</span></span></code></pre></div>
<h4 data-number="22.6.2.2" id="macos-specific-options"><span class="header-section-number">22.6.2.2</span> macOS-Specific
Options</h4>
<div class="sourceCode" id="cb955"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb955-1"><a aria-hidden="true" href="#cb955-1" tabindex="-1"></a><span class="co"># For X11 build instead</span></span>
<span id="cb955-2"><a aria-hidden="true" href="#cb955-2" tabindex="-1"></a><span class="ex">./configure</span> <span class="at">--with-x-toolkit</span><span class="op">=</span>lucid</span>
<span id="cb955-3"><a aria-hidden="true" href="#cb955-3" tabindex="-1"></a></span>
<span id="cb955-4"><a aria-hidden="true" href="#cb955-4" tabindex="-1"></a><span class="co"># For Terminal-only build</span></span>
<span id="cb955-5"><a aria-hidden="true" href="#cb955-5" tabindex="-1"></a><span class="ex">./configure</span> <span class="at">--without-ns</span> <span class="at">--without-x</span></span></code></pre></div>
<p>See <code>nextstep/INSTALL</code> for details.</p>
<h3 data-number="22.6.3" id="windows-mingwmsys2"><span class="header-section-number">22.6.3</span> 5.3 Windows
(MinGW/MSYS2)</h3>
<div class="sourceCode" id="cb956"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb956-1"><a aria-hidden="true" href="#cb956-1" tabindex="-1"></a><span class="co"># In MSYS2 shell</span></span>
<span id="cb956-2"><a aria-hidden="true" href="#cb956-2" tabindex="-1"></a><span class="ex">./configure</span></span>
<span id="cb956-3"><a aria-hidden="true" href="#cb956-3" tabindex="-1"></a><span class="fu">make</span></span>
<span id="cb956-4"><a aria-hidden="true" href="#cb956-4" tabindex="-1"></a></span>
<span id="cb956-5"><a aria-hidden="true" href="#cb956-5" tabindex="-1"></a><span class="co"># Result: src/emacs.exe</span></span></code></pre></div>
<p>See <code>nt/INSTALL</code> and <code>nt/INSTALL.W64</code> for
details.</p>
<h3 data-number="22.6.4" id="android-2"><span class="header-section-number">22.6.4</span> 5.4 Android</h3>
<div class="sourceCode" id="cb957"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb957-1"><a aria-hidden="true" href="#cb957-1" tabindex="-1"></a><span class="co"># Configure for Android</span></span>
<span id="cb957-2"><a aria-hidden="true" href="#cb957-2" tabindex="-1"></a><span class="bu">export</span> <span class="va">ANDROID_CC</span><span class="op">=&lt;</span>ndk-toolchain<span class="op">&gt;</span>-gcc</span>
<span id="cb957-3"><a aria-hidden="true" href="#cb957-3" tabindex="-1"></a><span class="ex">./configure</span> <span class="at">--host</span><span class="op">=</span>arm-linux-androideabi</span>
<span id="cb957-4"><a aria-hidden="true" href="#cb957-4" tabindex="-1"></a></span>
<span id="cb957-5"><a aria-hidden="true" href="#cb957-5" tabindex="-1"></a><span class="co"># Build</span></span>
<span id="cb957-6"><a aria-hidden="true" href="#cb957-6" tabindex="-1"></a><span class="fu">make</span></span></code></pre></div>
<p>See <code>java/INSTALL</code> for complete Android build
instructions.</p>
<h3 data-number="22.6.5" id="ms-dos"><span class="header-section-number">22.6.5</span> 5.5 MS-DOS</h3>
<p>See <code>msdos/INSTALL</code> for MS-DOS build instructions
(historical platform).</p>
<hr/>
<h2 data-number="22.7" id="continuous-integration"><span class="header-section-number">22.7</span> 6. Continuous Integration</h2>
<h3 data-number="22.7.1" id="ci-platforms"><span class="header-section-number">22.7.1</span> 6.1 CI Platforms</h3>
<p>Emacs uses multiple CI platforms:</p>
<ol type="1">
<li><strong>Emba</strong> (https://emba.gnu.org/emacs/emacs) - Primary
GitLab CI</li>
<li><strong>Hydra</strong>
(https://hydra.nixos.org/jobset/gnu/emacs-trunk) - Nix-based builds</li>
<li><strong>GitLab CI</strong> - Configured via
<code>.gitlab-ci.yml</code></li>
</ol>
<h3 data-number="22.7.2" id="emba-gitlab-ci"><span class="header-section-number">22.7.2</span> 6.2 Emba (GitLab CI)</h3>
<h4 data-number="22.7.2.1" id="configuration-files"><span class="header-section-number">22.7.2.1</span> Configuration Files</h4>
<pre><code>.gitlab-ci.yml              # Main CI entry point
test/infra/
‚îú‚îÄ‚îÄ gitlab-ci.yml           # Actual CI configuration
‚îú‚îÄ‚îÄ test-jobs.yml           # Generated test job definitions
‚îú‚îÄ‚îÄ Dockerfile.emba         # CI container definition
‚îî‚îÄ‚îÄ Makefile                # CI infrastructure tools</code></pre>
<h4 data-number="22.7.2.2" id="workflow"><span class="header-section-number">22.7.2.2</span> Workflow</h4>
<p>From <code>admin/notes/emba</code>:</p>
<div class="sourceCode" id="cb959"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb959-1"><a aria-hidden="true" href="#cb959-1" tabindex="-1"></a><span class="co"># Pipeline stages</span></span>
<span id="cb959-2"><a aria-hidden="true" href="#cb959-2" tabindex="-1"></a><span class="fu">stages</span><span class="kw">:</span></span>
<span id="cb959-3"><a aria-hidden="true" href="#cb959-3" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> build-images</span><span class="co">          # Create Docker images</span></span>
<span id="cb959-4"><a aria-hidden="true" href="#cb959-4" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> platform-images</span><span class="co">       # Platform-specific images</span></span>
<span id="cb959-5"><a aria-hidden="true" href="#cb959-5" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> native-comp-images</span><span class="co">    # Native compilation images</span></span>
<span id="cb959-6"><a aria-hidden="true" href="#cb959-6" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> normal</span><span class="co">                # Standard tests</span></span>
<span id="cb959-7"><a aria-hidden="true" href="#cb959-7" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> platforms</span><span class="co">             # Platform-specific tests</span></span>
<span id="cb959-8"><a aria-hidden="true" href="#cb959-8" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> native-comp</span><span class="co">           # Native compilation tests</span></span></code></pre></div>
<h4 data-number="22.7.2.3" id="branch-rules"><span class="header-section-number">22.7.2.3</span> Branch Rules</h4>
<div class="sourceCode" id="cb960"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb960-1"><a aria-hidden="true" href="#cb960-1" tabindex="-1"></a><span class="co"># From test/infra/gitlab-ci.yml</span></span>
<span id="cb960-2"><a aria-hidden="true" href="#cb960-2" tabindex="-1"></a><span class="fu">workflow</span><span class="kw">:</span></span>
<span id="cb960-3"><a aria-hidden="true" href="#cb960-3" tabindex="-1"></a><span class="at">  </span><span class="fu">rules</span><span class="kw">:</span></span>
<span id="cb960-4"><a aria-hidden="true" href="#cb960-4" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">if</span><span class="kw">:</span><span class="at"> </span><span class="st">'$CI_PIPELINE_SOURCE == "merge_request_event"'</span></span>
<span id="cb960-5"><a aria-hidden="true" href="#cb960-5" tabindex="-1"></a><span class="at">      </span><span class="fu">when</span><span class="kw">:</span><span class="at"> never</span></span>
<span id="cb960-6"><a aria-hidden="true" href="#cb960-6" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">if</span><span class="kw">:</span><span class="at"> </span><span class="st">'$CI_COMMIT_BRANCH !~ /^(master|emacs|feature|fix)/'</span></span>
<span id="cb960-7"><a aria-hidden="true" href="#cb960-7" tabindex="-1"></a><span class="at">      </span><span class="fu">when</span><span class="kw">:</span><span class="at"> never</span></span>
<span id="cb960-8"><a aria-hidden="true" href="#cb960-8" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">when</span><span class="kw">:</span><span class="at"> always</span></span>
<span id="cb960-9"><a aria-hidden="true" href="#cb960-9" tabindex="-1"></a></span>
<span id="cb960-10"><a aria-hidden="true" href="#cb960-10" tabindex="-1"></a><span class="co"># Only these branches trigger CI:</span></span>
<span id="cb960-11"><a aria-hidden="true" href="#cb960-11" tabindex="-1"></a><span class="co"># - master*</span></span>
<span id="cb960-12"><a aria-hidden="true" href="#cb960-12" tabindex="-1"></a><span class="co"># - emacs-*</span></span>
<span id="cb960-13"><a aria-hidden="true" href="#cb960-13" tabindex="-1"></a><span class="co"># - feature/*</span></span>
<span id="cb960-14"><a aria-hidden="true" href="#cb960-14" tabindex="-1"></a><span class="co"># - fix/*</span></span></code></pre></div>
<h4 data-number="22.7.2.4" id="environment-variables-1"><span class="header-section-number">22.7.2.4</span> Environment Variables</h4>
<div class="sourceCode" id="cb961"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb961-1"><a aria-hidden="true" href="#cb961-1" tabindex="-1"></a><span class="fu">variables</span><span class="kw">:</span></span>
<span id="cb961-2"><a aria-hidden="true" href="#cb961-2" tabindex="-1"></a><span class="at">  </span><span class="fu">EMACS_EMBA_CI</span><span class="kw">:</span><span class="at"> </span><span class="dv">1</span></span>
<span id="cb961-3"><a aria-hidden="true" href="#cb961-3" tabindex="-1"></a><span class="at">  </span><span class="fu">EMACS_TEST_JUNIT_REPORT</span><span class="kw">:</span><span class="at"> junit-test-report.xml</span></span>
<span id="cb961-4"><a aria-hidden="true" href="#cb961-4" tabindex="-1"></a><span class="at">  </span><span class="fu">EMACS_TEST_TIMEOUT</span><span class="kw">:</span><span class="at"> </span><span class="dv">3600</span></span>
<span id="cb961-5"><a aria-hidden="true" href="#cb961-5" tabindex="-1"></a><span class="at">  </span><span class="fu">EMACS_TEST_VERBOSE</span><span class="kw">:</span><span class="at"> </span><span class="dv">1</span></span></code></pre></div>
<h4 data-number="22.7.2.5" id="test-execution"><span class="header-section-number">22.7.2.5</span> Test Execution</h4>
<div class="sourceCode" id="cb962"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb962-1"><a aria-hidden="true" href="#cb962-1" tabindex="-1"></a><span class="co"># Generate test jobs</span></span>
<span id="cb962-2"><a aria-hidden="true" href="#cb962-2" tabindex="-1"></a><span class="fu">make</span> <span class="at">-C</span> test generate-test-jobs</span>
<span id="cb962-3"><a aria-hidden="true" href="#cb962-3" tabindex="-1"></a></span>
<span id="cb962-4"><a aria-hidden="true" href="#cb962-4" tabindex="-1"></a><span class="co"># Creates test/infra/test-jobs.yml with:</span></span>
<span id="cb962-5"><a aria-hidden="true" href="#cb962-5" tabindex="-1"></a><span class="co"># - Job for each test subdirectory</span></span>
<span id="cb962-6"><a aria-hidden="true" href="#cb962-6" tabindex="-1"></a><span class="co"># - Proper dependencies</span></span>
<span id="cb962-7"><a aria-hidden="true" href="#cb962-7" tabindex="-1"></a><span class="co"># - Artifact collection</span></span></code></pre></div>
<h4 data-number="22.7.2.6" id="job-types"><span class="header-section-number">22.7.2.6</span> Job Types</h4>
<div class="sourceCode" id="cb963"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb963-1"><a aria-hidden="true" href="#cb963-1" tabindex="-1"></a><span class="co"># Build jobs</span></span>
<span id="cb963-2"><a aria-hidden="true" href="#cb963-2" tabindex="-1"></a><span class="fu">build-image-*</span><span class="kw">:</span></span>
<span id="cb963-3"><a aria-hidden="true" href="#cb963-3" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> Create Docker image with Emacs build</span></span>
<span id="cb963-4"><a aria-hidden="true" href="#cb963-4" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> Run only if Makefiles changed</span></span>
<span id="cb963-5"><a aria-hidden="true" href="#cb963-5" tabindex="-1"></a></span>
<span id="cb963-6"><a aria-hidden="true" href="#cb963-6" tabindex="-1"></a><span class="co"># Test jobs</span></span>
<span id="cb963-7"><a aria-hidden="true" href="#cb963-7" tabindex="-1"></a><span class="fu">test-*</span><span class="kw">:</span></span>
<span id="cb963-8"><a aria-hidden="true" href="#cb963-8" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> Run tests in pre-built image</span></span>
<span id="cb963-9"><a aria-hidden="true" href="#cb963-9" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> Collect JUnit reports</span></span>
<span id="cb963-10"><a aria-hidden="true" href="#cb963-10" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> Archive logs</span></span>
<span id="cb963-11"><a aria-hidden="true" href="#cb963-11" tabindex="-1"></a></span>
<span id="cb963-12"><a aria-hidden="true" href="#cb963-12" tabindex="-1"></a><span class="co"># Special jobs</span></span>
<span id="cb963-13"><a aria-hidden="true" href="#cb963-13" tabindex="-1"></a><span class="fu">test-tree-sitter</span><span class="kw">:</span></span>
<span id="cb963-14"><a aria-hidden="true" href="#cb963-14" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> Test tree-sitter grammar compatibility</span></span>
<span id="cb963-15"><a aria-hidden="true" href="#cb963-15" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> Generate compatibility-report.html</span></span></code></pre></div>
<h3 data-number="22.7.3" id="hydra-nix-based"><span class="header-section-number">22.7.3</span> 6.3 Hydra (Nix-based)</h3>
<p>From <code>admin/notes/hydra</code>:</p>
<h4 data-number="22.7.3.1" id="hydra-jobs"><span class="header-section-number">22.7.3.1</span> Hydra Jobs</h4>
<pre><code>1. 'tarball' job:
   - Checkout from repository
   - Bootstrap
   - Run make-dist
   - Create release tarball

2. 'build' job:
   - Use tarball from (1)
   - Normal build
   - Multiple platforms

3. 'coverage' job:
   - GCov build
   - Run make check-expensive
   - Fails if tests fail
   - Generate coverage report</code></pre>
<h4 data-number="22.7.3.2" id="notifications"><span class="header-section-number">22.7.3.2</span> Notifications</h4>
<pre><code>Build status notifications sent to:
  emacs-buildstatus@gnu.org

Subscribe at:
  https://lists.gnu.org/mailman/listinfo/emacs-buildstatus</code></pre>
<h4 data-number="22.7.3.3" id="identifying-ci-environment"><span class="header-section-number">22.7.3.3</span> Identifying CI
Environment</h4>
<div class="sourceCode" id="cb966"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb966-1"><a aria-hidden="true" href="#cb966-1" tabindex="-1"></a><span class="co"># Check if running on CI</span></span>
<span id="cb966-2"><a aria-hidden="true" href="#cb966-2" tabindex="-1"></a><span class="cf">if</span> <span class="bu">[</span> <span class="ot">-n</span> <span class="st">"</span><span class="va">$EMACS_EMBA_CI</span><span class="st">"</span> <span class="bu">]</span><span class="kw">;</span> <span class="cf">then</span></span>
<span id="cb966-3"><a aria-hidden="true" href="#cb966-3" tabindex="-1"></a>    <span class="bu">echo</span> <span class="st">"Running on Emba"</span></span>
<span id="cb966-4"><a aria-hidden="true" href="#cb966-4" tabindex="-1"></a><span class="cf">fi</span></span>
<span id="cb966-5"><a aria-hidden="true" href="#cb966-5" tabindex="-1"></a></span>
<span id="cb966-6"><a aria-hidden="true" href="#cb966-6" tabindex="-1"></a><span class="cf">if</span> <span class="bu">[</span> <span class="ot">-n</span> <span class="st">"</span><span class="va">$EMACS_HYDRA_CI</span><span class="st">"</span> <span class="bu">]</span><span class="kw">;</span> <span class="cf">then</span></span>
<span id="cb966-7"><a aria-hidden="true" href="#cb966-7" tabindex="-1"></a>    <span class="bu">echo</span> <span class="st">"Running on Hydra"</span></span>
<span id="cb966-8"><a aria-hidden="true" href="#cb966-8" tabindex="-1"></a><span class="cf">fi</span></span></code></pre></div>
<h3 data-number="22.7.4" id="local-ci-testing"><span class="header-section-number">22.7.4</span> 6.4 Local CI Testing</h3>
<div class="sourceCode" id="cb967"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb967-1"><a aria-hidden="true" href="#cb967-1" tabindex="-1"></a><span class="co"># Build CI Docker image</span></span>
<span id="cb967-2"><a aria-hidden="true" href="#cb967-2" tabindex="-1"></a><span class="bu">cd</span> test/infra</span>
<span id="cb967-3"><a aria-hidden="true" href="#cb967-3" tabindex="-1"></a><span class="ex">docker</span> build <span class="at">-f</span> Dockerfile.emba <span class="at">-t</span> emacs-ci .</span>
<span id="cb967-4"><a aria-hidden="true" href="#cb967-4" tabindex="-1"></a></span>
<span id="cb967-5"><a aria-hidden="true" href="#cb967-5" tabindex="-1"></a><span class="co"># Run tests in container</span></span>
<span id="cb967-6"><a aria-hidden="true" href="#cb967-6" tabindex="-1"></a><span class="ex">docker</span> run <span class="at">-it</span> emacs-ci /bin/bash</span>
<span id="cb967-7"><a aria-hidden="true" href="#cb967-7" tabindex="-1"></a><span class="bu">cd</span> /checkout</span>
<span id="cb967-8"><a aria-hidden="true" href="#cb967-8" tabindex="-1"></a><span class="fu">make</span> check</span></code></pre></div>
<h3 data-number="22.7.5" id="ci-best-practices"><span class="header-section-number">22.7.5</span> 6.5 CI Best Practices</h3>
<pre class="elisp"><code>;; Detect CI environment in tests
(when (getenv "EMACS_EMBA_CI")
  ;; Adjust for CI environment
  (setq some-timeout (* 2 some-timeout)))

;; Skip tests not suitable for CI
(ert-deftest my-test ()
  :tags '(:unstable)
  ...)

;; Use junit reporting
;; CI automatically sets EMACS_TEST_JUNIT_REPORT</code></pre>
<hr/>
<h2 data-number="22.8" id="quick-reference"><span class="header-section-number">22.8</span> 7. Quick Reference</h2>
<h3 data-number="22.8.1" id="common-build-commands"><span class="header-section-number">22.8.1</span> 7.1 Common Build
Commands</h3>
<div class="sourceCode" id="cb969"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb969-1"><a aria-hidden="true" href="#cb969-1" tabindex="-1"></a><span class="co"># First time setup</span></span>
<span id="cb969-2"><a aria-hidden="true" href="#cb969-2" tabindex="-1"></a><span class="ex">./autogen.sh</span></span>
<span id="cb969-3"><a aria-hidden="true" href="#cb969-3" tabindex="-1"></a><span class="ex">./configure</span></span>
<span id="cb969-4"><a aria-hidden="true" href="#cb969-4" tabindex="-1"></a><span class="fu">make</span></span>
<span id="cb969-5"><a aria-hidden="true" href="#cb969-5" tabindex="-1"></a></span>
<span id="cb969-6"><a aria-hidden="true" href="#cb969-6" tabindex="-1"></a><span class="co"># Development build</span></span>
<span id="cb969-7"><a aria-hidden="true" href="#cb969-7" tabindex="-1"></a><span class="ex">./configure</span> CFLAGS=<span class="st">'-O0 -g3'</span> <span class="at">--enable-checking</span><span class="op">=</span>all</span>
<span id="cb969-8"><a aria-hidden="true" href="#cb969-8" tabindex="-1"></a><span class="fu">make</span> <span class="at">-j</span><span class="va">$(</span><span class="fu">nproc</span><span class="va">)</span></span>
<span id="cb969-9"><a aria-hidden="true" href="#cb969-9" tabindex="-1"></a></span>
<span id="cb969-10"><a aria-hidden="true" href="#cb969-10" tabindex="-1"></a><span class="co"># Clean rebuild</span></span>
<span id="cb969-11"><a aria-hidden="true" href="#cb969-11" tabindex="-1"></a><span class="fu">make</span> bootstrap</span>
<span id="cb969-12"><a aria-hidden="true" href="#cb969-12" tabindex="-1"></a></span>
<span id="cb969-13"><a aria-hidden="true" href="#cb969-13" tabindex="-1"></a><span class="co"># Run Emacs</span></span>
<span id="cb969-14"><a aria-hidden="true" href="#cb969-14" tabindex="-1"></a><span class="ex">src/emacs</span> <span class="at">-Q</span></span>
<span id="cb969-15"><a aria-hidden="true" href="#cb969-15" tabindex="-1"></a></span>
<span id="cb969-16"><a aria-hidden="true" href="#cb969-16" tabindex="-1"></a><span class="co"># Install</span></span>
<span id="cb969-17"><a aria-hidden="true" href="#cb969-17" tabindex="-1"></a><span class="fu">sudo</span> make install</span></code></pre></div>
<h3 data-number="22.8.2" id="common-test-commands"><span class="header-section-number">22.8.2</span> 7.2 Common Test
Commands</h3>
<div class="sourceCode" id="cb970"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb970-1"><a aria-hidden="true" href="#cb970-1" tabindex="-1"></a><span class="co"># All standard tests</span></span>
<span id="cb970-2"><a aria-hidden="true" href="#cb970-2" tabindex="-1"></a><span class="fu">make</span> check</span>
<span id="cb970-3"><a aria-hidden="true" href="#cb970-3" tabindex="-1"></a></span>
<span id="cb970-4"><a aria-hidden="true" href="#cb970-4" tabindex="-1"></a><span class="co"># Specific test file</span></span>
<span id="cb970-5"><a aria-hidden="true" href="#cb970-5" tabindex="-1"></a><span class="fu">make</span> test/lisp/files-tests</span>
<span id="cb970-6"><a aria-hidden="true" href="#cb970-6" tabindex="-1"></a></span>
<span id="cb970-7"><a aria-hidden="true" href="#cb970-7" tabindex="-1"></a><span class="co"># With verbose output</span></span>
<span id="cb970-8"><a aria-hidden="true" href="#cb970-8" tabindex="-1"></a><span class="va">EMACS_TEST_VERBOSE</span><span class="op">=</span>1 <span class="fu">make</span> check</span>
<span id="cb970-9"><a aria-hidden="true" href="#cb970-9" tabindex="-1"></a></span>
<span id="cb970-10"><a aria-hidden="true" href="#cb970-10" tabindex="-1"></a><span class="co"># Expensive tests</span></span>
<span id="cb970-11"><a aria-hidden="true" href="#cb970-11" tabindex="-1"></a><span class="fu">make</span> check-expensive</span>
<span id="cb970-12"><a aria-hidden="true" href="#cb970-12" tabindex="-1"></a></span>
<span id="cb970-13"><a aria-hidden="true" href="#cb970-13" tabindex="-1"></a><span class="co"># Interactive debugging</span></span>
<span id="cb970-14"><a aria-hidden="true" href="#cb970-14" tabindex="-1"></a><span class="fu">make</span> test/lisp/files-tests TEST_INTERACTIVE=yes</span></code></pre></div>
<h3 data-number="22.8.3" id="common-development-tasks"><span class="header-section-number">22.8.3</span> 7.3 Common Development
Tasks</h3>
<div class="sourceCode" id="cb971"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb971-1"><a aria-hidden="true" href="#cb971-1" tabindex="-1"></a><span class="co"># Update after Git pull</span></span>
<span id="cb971-2"><a aria-hidden="true" href="#cb971-2" tabindex="-1"></a><span class="fu">make</span></span>
<span id="cb971-3"><a aria-hidden="true" href="#cb971-3" tabindex="-1"></a></span>
<span id="cb971-4"><a aria-hidden="true" href="#cb971-4" tabindex="-1"></a><span class="co"># If build fails mysteriously</span></span>
<span id="cb971-5"><a aria-hidden="true" href="#cb971-5" tabindex="-1"></a><span class="fu">make</span> bootstrap</span>
<span id="cb971-6"><a aria-hidden="true" href="#cb971-6" tabindex="-1"></a></span>
<span id="cb971-7"><a aria-hidden="true" href="#cb971-7" tabindex="-1"></a><span class="co"># Check for errors before commit</span></span>
<span id="cb971-8"><a aria-hidden="true" href="#cb971-8" tabindex="-1"></a><span class="fu">make</span> check-declare</span>
<span id="cb971-9"><a aria-hidden="true" href="#cb971-9" tabindex="-1"></a><span class="fu">make</span> check</span>
<span id="cb971-10"><a aria-hidden="true" href="#cb971-10" tabindex="-1"></a></span>
<span id="cb971-11"><a aria-hidden="true" href="#cb971-11" tabindex="-1"></a><span class="co"># Update TAGS</span></span>
<span id="cb971-12"><a aria-hidden="true" href="#cb971-12" tabindex="-1"></a><span class="fu">make</span> TAGS</span>
<span id="cb971-13"><a aria-hidden="true" href="#cb971-13" tabindex="-1"></a></span>
<span id="cb971-14"><a aria-hidden="true" href="#cb971-14" tabindex="-1"></a><span class="co"># Rebuild documentation</span></span>
<span id="cb971-15"><a aria-hidden="true" href="#cb971-15" tabindex="-1"></a><span class="fu">make</span> docs</span></code></pre></div>
<h3 data-number="22.8.4" id="common-configuration-options"><span class="header-section-number">22.8.4</span> 7.4 Common Configuration
Options</h3>
<div class="sourceCode" id="cb972"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb972-1"><a aria-hidden="true" href="#cb972-1" tabindex="-1"></a><span class="co"># Minimal build</span></span>
<span id="cb972-2"><a aria-hidden="true" href="#cb972-2" tabindex="-1"></a><span class="ex">./configure</span> <span class="at">--without-all</span></span>
<span id="cb972-3"><a aria-hidden="true" href="#cb972-3" tabindex="-1"></a></span>
<span id="cb972-4"><a aria-hidden="true" href="#cb972-4" tabindex="-1"></a><span class="co"># Debug build</span></span>
<span id="cb972-5"><a aria-hidden="true" href="#cb972-5" tabindex="-1"></a><span class="ex">./configure</span> CFLAGS=<span class="st">'-O0 -g3'</span> <span class="at">--enable-checking</span><span class="op">=</span>all</span>
<span id="cb972-6"><a aria-hidden="true" href="#cb972-6" tabindex="-1"></a></span>
<span id="cb972-7"><a aria-hidden="true" href="#cb972-7" tabindex="-1"></a><span class="co"># Native compilation</span></span>
<span id="cb972-8"><a aria-hidden="true" href="#cb972-8" tabindex="-1"></a><span class="ex">./configure</span> <span class="at">--with-native-compilation</span></span>
<span id="cb972-9"><a aria-hidden="true" href="#cb972-9" tabindex="-1"></a></span>
<span id="cb972-10"><a aria-hidden="true" href="#cb972-10" tabindex="-1"></a><span class="co"># Without X11</span></span>
<span id="cb972-11"><a aria-hidden="true" href="#cb972-11" tabindex="-1"></a><span class="ex">./configure</span> <span class="at">--without-x</span></span>
<span id="cb972-12"><a aria-hidden="true" href="#cb972-12" tabindex="-1"></a></span>
<span id="cb972-13"><a aria-hidden="true" href="#cb972-13" tabindex="-1"></a><span class="co"># With specific toolkit</span></span>
<span id="cb972-14"><a aria-hidden="true" href="#cb972-14" tabindex="-1"></a><span class="ex">./configure</span> <span class="at">--with-x-toolkit</span><span class="op">=</span>gtk3</span></code></pre></div>
<hr/>
<h2 data-number="22.9" id="additional-resources"><span class="header-section-number">22.9</span> 8. Additional Resources</h2>
<h3 data-number="22.9.1" id="documentation-files"><span class="header-section-number">22.9.1</span> 8.1 Documentation Files</h3>
<ul>
<li><strong>INSTALL</strong> - Building from release tarball</li>
<li><strong>INSTALL.REPO</strong> - Building from Git repository</li>
<li><strong>etc/DEBUG</strong> - Comprehensive debugging guide</li>
<li><strong>admin/notes/</strong> - Developer notes and procedures
<ul>
<li><strong>admin/notes/hydra</strong> - Hydra CI information</li>
<li><strong>admin/notes/emba</strong> - Emba CI information</li>
<li><strong>admin/release-process</strong> - Release procedures</li>
</ul></li>
<li><strong>test/README</strong> - Testing overview</li>
<li><strong>test/file-organization.org</strong> - Test file
conventions</li>
</ul>
<h3 data-number="22.9.2" id="online-resources"><span class="header-section-number">22.9.2</span> 8.2 Online Resources</h3>
<ul>
<li><strong>Emacs Manual</strong>:
https://www.gnu.org/software/emacs/manual/</li>
<li><strong>Elisp Reference</strong>:
https://www.gnu.org/software/emacs/manual/elisp.html</li>
<li><strong>ERT Manual</strong>:
https://www.gnu.org/software/emacs/manual/html_node/ert/</li>
<li><strong>Emba CI</strong>: https://emba.gnu.org/emacs/emacs</li>
<li><strong>Hydra CI</strong>:
https://hydra.nixos.org/jobset/gnu/emacs-trunk</li>
<li><strong>Bug Tracker</strong>: https://debbugs.gnu.org/</li>
<li><strong>Mailing Lists</strong>:
https://savannah.gnu.org/mail/?group=emacs</li>
</ul>
<h3 data-number="22.9.3" id="directories-to-know"><span class="header-section-number">22.9.3</span> 8.3 Directories to Know</h3>
<pre><code>emacs/
‚îú‚îÄ‚îÄ src/                # C source code
‚îú‚îÄ‚îÄ lisp/               # Emacs Lisp code
‚îú‚îÄ‚îÄ lib/                # Gnulib portability library
‚îú‚îÄ‚îÄ lib-src/            # Utility programs
‚îú‚îÄ‚îÄ etc/                # Support files
‚îú‚îÄ‚îÄ doc/                # Documentation sources
‚îú‚îÄ‚îÄ test/               # Test suite
‚îú‚îÄ‚îÄ admin/              # Development tools
‚îú‚îÄ‚îÄ build-aux/          # Build helper scripts
‚îî‚îÄ‚îÄ m4/                 # Autoconf macros</code></pre>
<h3 data-number="22.9.4" id="key-make-variables"><span class="header-section-number">22.9.4</span> 8.4 Key Make Variables</h3>
<div class="sourceCode" id="cb974"><pre class="sourceCode makefile"><code class="sourceCode makefile"><span id="cb974-1"><a aria-hidden="true" href="#cb974-1" tabindex="-1"></a><span class="co"># Common variables</span></span>
<span id="cb974-2"><a aria-hidden="true" href="#cb974-2" tabindex="-1"></a>CFLAGS          <span class="co"># C compiler flags</span></span>
<span id="cb974-3"><a aria-hidden="true" href="#cb974-3" tabindex="-1"></a>LDFLAGS         <span class="co"># Linker flags</span></span>
<span id="cb974-4"><a aria-hidden="true" href="#cb974-4" tabindex="-1"></a>prefix          <span class="co"># Installation prefix</span></span>
<span id="cb974-5"><a aria-hidden="true" href="#cb974-5" tabindex="-1"></a>DESTDIR         <span class="co"># Installation staging directory</span></span>
<span id="cb974-6"><a aria-hidden="true" href="#cb974-6" tabindex="-1"></a></span>
<span id="cb974-7"><a aria-hidden="true" href="#cb974-7" tabindex="-1"></a><span class="co"># Test variables</span></span>
<span id="cb974-8"><a aria-hidden="true" href="#cb974-8" tabindex="-1"></a>SELECTOR        <span class="co"># Test selector expression</span></span>
<span id="cb974-9"><a aria-hidden="true" href="#cb974-9" tabindex="-1"></a>TEST_LOAD_EL    <span class="co"># Use .el files instead of .elc</span></span>
<span id="cb974-10"><a aria-hidden="true" href="#cb974-10" tabindex="-1"></a>TEST_INTERACTIVE <span class="co"># Run tests interactively</span></span>
<span id="cb974-11"><a aria-hidden="true" href="#cb974-11" tabindex="-1"></a>EMACS_TEST_VERBOSE <span class="co"># Verbose test output</span></span></code></pre></div>
<hr/>
<h2 data-number="22.10" id="troubleshooting"><span class="header-section-number">22.10</span> 9. Troubleshooting</h2>
<h3 data-number="22.10.1" id="build-issues"><span class="header-section-number">22.10.1</span> 9.1 Build Issues</h3>
<p><strong>Problem</strong>:
<code>configure: error: C compiler cannot create executables</code></p>
<div class="sourceCode" id="cb975"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb975-1"><a aria-hidden="true" href="#cb975-1" tabindex="-1"></a><span class="co"># Solution: Install compiler</span></span>
<span id="cb975-2"><a aria-hidden="true" href="#cb975-2" tabindex="-1"></a><span class="fu">sudo</span> apt-get install build-essential  <span class="co"># Debian/Ubuntu</span></span>
<span id="cb975-3"><a aria-hidden="true" href="#cb975-3" tabindex="-1"></a><span class="fu">sudo</span> dnf install gcc make             <span class="co"># Fedora</span></span></code></pre></div>
<p><strong>Problem</strong>:
<code>configure: error: The following required libraries were not found: gnutls</code></p>
<div class="sourceCode" id="cb976"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb976-1"><a aria-hidden="true" href="#cb976-1" tabindex="-1"></a><span class="co"># Solution: Install missing library</span></span>
<span id="cb976-2"><a aria-hidden="true" href="#cb976-2" tabindex="-1"></a><span class="fu">sudo</span> apt-get install libgnutls28-dev  <span class="co"># Debian/Ubuntu</span></span>
<span id="cb976-3"><a aria-hidden="true" href="#cb976-3" tabindex="-1"></a><span class="fu">sudo</span> dnf install gnutls-devel         <span class="co"># Fedora</span></span></code></pre></div>
<p><strong>Problem</strong>: <code>make</code> fails with mysterious
errors</p>
<div class="sourceCode" id="cb977"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb977-1"><a aria-hidden="true" href="#cb977-1" tabindex="-1"></a><span class="co"># Solution: Try bootstrap</span></span>
<span id="cb977-2"><a aria-hidden="true" href="#cb977-2" tabindex="-1"></a><span class="fu">make</span> bootstrap</span>
<span id="cb977-3"><a aria-hidden="true" href="#cb977-3" tabindex="-1"></a></span>
<span id="cb977-4"><a aria-hidden="true" href="#cb977-4" tabindex="-1"></a><span class="co"># If that fails, nuclear option:</span></span>
<span id="cb977-5"><a aria-hidden="true" href="#cb977-5" tabindex="-1"></a><span class="fu">git</span> clean <span class="at">-fdx</span>  <span class="co"># </span><span class="al">WARNING</span><span class="co">: Deletes all untracked files</span></span>
<span id="cb977-6"><a aria-hidden="true" href="#cb977-6" tabindex="-1"></a><span class="ex">./autogen.sh</span></span>
<span id="cb977-7"><a aria-hidden="true" href="#cb977-7" tabindex="-1"></a><span class="ex">./configure</span></span>
<span id="cb977-8"><a aria-hidden="true" href="#cb977-8" tabindex="-1"></a><span class="fu">make</span></span></code></pre></div>
<p><strong>Problem</strong>: <code>.gdbinit</code> not loaded</p>
<div class="sourceCode" id="cb978"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb978-1"><a aria-hidden="true" href="#cb978-1" tabindex="-1"></a><span class="co"># Solution: Add to ~/.gdbinit:</span></span>
<span id="cb978-2"><a aria-hidden="true" href="#cb978-2" tabindex="-1"></a><span class="ex">add-auto-load-safe-path</span> /path/to/emacs/src/.gdbinit</span></code></pre></div>
<h3 data-number="22.10.2" id="test-issues"><span class="header-section-number">22.10.2</span> 9.2 Test Issues</h3>
<p><strong>Problem</strong>: Tests fail with
<code>(file-missing "Cannot open load file" ...)</code></p>
<div class="sourceCode" id="cb979"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb979-1"><a aria-hidden="true" href="#cb979-1" tabindex="-1"></a><span class="co"># Solution: Rebuild autoloads</span></span>
<span id="cb979-2"><a aria-hidden="true" href="#cb979-2" tabindex="-1"></a><span class="bu">cd</span> lisp</span>
<span id="cb979-3"><a aria-hidden="true" href="#cb979-3" tabindex="-1"></a><span class="fu">make</span> autoloads</span></code></pre></div>
<p><strong>Problem</strong>: Tests timeout</p>
<div class="sourceCode" id="cb980"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb980-1"><a aria-hidden="true" href="#cb980-1" tabindex="-1"></a><span class="co"># Solution: Increase timeout</span></span>
<span id="cb980-2"><a aria-hidden="true" href="#cb980-2" tabindex="-1"></a><span class="va">EMACS_TEST_TIMEOUT</span><span class="op">=</span>7200 <span class="fu">make</span> check</span></code></pre></div>
<p><strong>Problem</strong>: Remote tests fail</p>
<div class="sourceCode" id="cb981"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb981-1"><a aria-hidden="true" href="#cb981-1" tabindex="-1"></a><span class="co"># Solution: Set remote directory</span></span>
<span id="cb981-2"><a aria-hidden="true" href="#cb981-2" tabindex="-1"></a><span class="va">REMOTE_TEMPORARY_FILE_DIRECTORY</span><span class="op">=</span>/ssh:host:/tmp <span class="fu">make</span> check</span></code></pre></div>
<h3 data-number="22.10.3" id="platform-specific-issues"><span class="header-section-number">22.10.3</span> 9.3 Platform-Specific
Issues</h3>
<p>See platform-specific INSTALL files for detailed troubleshooting: -
<code>nt/INSTALL</code> - Windows - <code>nextstep/INSTALL</code> -
macOS - <code>java/INSTALL</code> - Android - <code>etc/PROBLEMS</code>
- Common problems across platforms</p>
<hr/>
<p><strong>Document Version</strong>: 1.0 <strong>Last Updated</strong>:
2025 <strong>Emacs Version</strong>: 31.0.50 (development)</p>
<p>For the most current information, always refer to the documentation
files in the Emacs source tree and the online resources listed
above.</p>
<h1 data-number="23" id="evolution-of-coding-patterns-and-practices-in-emacs"><span class="header-section-number">23</span> Evolution of Coding Patterns and
Practices in Emacs</h1>
<h2 data-number="23.1" id="executive-summary-2"><span class="header-section-number">23.1</span> Executive Summary</h2>
<p>This document traces the evolution of coding patterns, architectural
decisions, and development practices in GNU Emacs from its initial
public release in 1985 through 2025. Drawing from 40 years of
development history, we analyze how the codebase has adapted to changing
technologies, maintained backward compatibility, and continuously
improved while preserving its foundational design principles.</p>
<h2 data-number="23.2" id="historical-timeline"><span class="header-section-number">23.2</span> Historical Timeline</h2>
<h3 data-number="23.2.1" id="early-era-1985-1999-foundation-and-stability"><span class="header-section-number">23.2.1</span> Early Era (1985-1999):
Foundation and Stability</h3>
<p><strong>GNU Emacs 13</strong> (March 1985) - Initial public release -
Development began in 1984 as a fresh implementation with Lisp at its
core - Early development used magnetic tape distribution (half-inch
9-track 1600-bpi reels) - No version control systems initially; later
moved to CVS</p>
<p><strong>Key Characteristics:</strong> - C core with dynamic Lisp
layer - Manual ChangeLog maintenance - Focus on portability across Unix
variants (BSD, System V)</p>
<h3 data-number="23.2.2" id="modernization-era-2000-2011-version-control-and-standards"><span class="header-section-number">23.2.2</span> Modernization Era
(2000-2011): Version Control and Standards</h3>
<p><strong>Major Transitions:</strong> - Migration from CVS to Bazaar,
then to Git (2008-2014) - Introduction of structured testing frameworks
- Formalization of contribution processes</p>
<h3 data-number="23.2.3" id="contemporary-era-2012-2025-performance-and-modern-features"><span class="header-section-number">23.2.3</span> Contemporary Era
(2012-2025): Performance and Modern Features</h3>
<p><strong>Emacs 24</strong> (2012): Lexical Binding Revolution
<strong>Emacs 28</strong> (2021): Native Compilation <strong>Emacs
29</strong> (2022): Tree-sitter Integration</p>
<h2 data-number="23.3" id="coding-style-evolution"><span class="header-section-number">23.3</span> Coding Style Evolution</h2>
<h3 data-number="23.3.1" id="c-code-patterns"><span class="header-section-number">23.3.1</span> C Code Patterns</h3>
<h4 data-number="23.3.1.1" id="early-c-code-1986"><span class="header-section-number">23.3.1.1</span> Early C Code (1986)</h4>
<p>From <code>/home/user/emacs/src/ChangeLog.1</code>:</p>
<pre><code>1986-05-18  Richard M. Stallman  (rms@prep)

    * alloc.c (malloc_warning_1): Add some advice on
    the significance of the warning.

1986-04-24  Richard M. Stallman  (rms@prep)

    * insdel.c (del_range): Args passed to adjust_markers
    are now properly adjusted for the gap.</code></pre>
<p><strong>Characteristics:</strong> - Simple, descriptive commit
messages - Direct author attribution - Focus on specific function
fixes</p>
<h4 data-number="23.3.1.2" id="modern-c-code-2025"><span class="header-section-number">23.3.1.2</span> Modern C Code (2025)</h4>
<p>From <code>/home/user/emacs/src/alloc.c</code>:</p>
<div class="sourceCode" id="cb983"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb983-1"><a aria-hidden="true" href="#cb983-1" tabindex="-1"></a><span class="co">/* Storage allocation and gc for GNU Emacs Lisp interpreter.</span></span>
<span id="cb983-2"><a aria-hidden="true" href="#cb983-2" tabindex="-1"></a></span>
<span id="cb983-3"><a aria-hidden="true" href="#cb983-3" tabindex="-1"></a><span class="co">Copyright (C) 1985-2025 Free Software Foundation, Inc.</span></span>
<span id="cb983-4"><a aria-hidden="true" href="#cb983-4" tabindex="-1"></a></span>
<span id="cb983-5"><a aria-hidden="true" href="#cb983-5" tabindex="-1"></a><span class="co">This file is part of GNU Emacs.</span></span>
<span id="cb983-6"><a aria-hidden="true" href="#cb983-6" tabindex="-1"></a><span class="co">*/</span></span>
<span id="cb983-7"><a aria-hidden="true" href="#cb983-7" tabindex="-1"></a></span>
<span id="cb983-8"><a aria-hidden="true" href="#cb983-8" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;config.h&gt;</span></span>
<span id="cb983-9"><a aria-hidden="true" href="#cb983-9" tabindex="-1"></a></span>
<span id="cb983-10"><a aria-hidden="true" href="#cb983-10" tabindex="-1"></a><span class="pp">#ifdef HAVE_TREE_SITTER</span></span>
<span id="cb983-11"><a aria-hidden="true" href="#cb983-11" tabindex="-1"></a><span class="pp">#include </span><span class="im">"treesit.h"</span></span>
<span id="cb983-12"><a aria-hidden="true" href="#cb983-12" tabindex="-1"></a><span class="pp">#endif</span></span>
<span id="cb983-13"><a aria-hidden="true" href="#cb983-13" tabindex="-1"></a></span>
<span id="cb983-14"><a aria-hidden="true" href="#cb983-14" tabindex="-1"></a><span class="co">/* AddressSanitizer exposes additional functions for manually marking</span></span>
<span id="cb983-15"><a aria-hidden="true" href="#cb983-15" tabindex="-1"></a><span class="co">   memory as poisoned/unpoisoned.  When ASan is enabled and the needed</span></span>
<span id="cb983-16"><a aria-hidden="true" href="#cb983-16" tabindex="-1"></a><span class="co">   header is available, memory is poisoned when:</span></span>
<span id="cb983-17"><a aria-hidden="true" href="#cb983-17" tabindex="-1"></a></span>
<span id="cb983-18"><a aria-hidden="true" href="#cb983-18" tabindex="-1"></a><span class="co">   * An ablock is freed (lisp_align_free)</span></span>
<span id="cb983-19"><a aria-hidden="true" href="#cb983-19" tabindex="-1"></a><span class="co">   * An interval_block is initially allocated (make_interval)</span></span>
<span id="cb983-20"><a aria-hidden="true" href="#cb983-20" tabindex="-1"></a><span class="co">   ...</span></span>
<span id="cb983-21"><a aria-hidden="true" href="#cb983-21" tabindex="-1"></a><span class="co">*/</span></span>
<span id="cb983-22"><a aria-hidden="true" href="#cb983-22" tabindex="-1"></a><span class="pp">#if ADDRESS_SANITIZER &amp;&amp; defined HAVE_SANITIZER_ASAN_INTERFACE_H</span></span>
<span id="cb983-23"><a aria-hidden="true" href="#cb983-23" tabindex="-1"></a><span class="pp"># define GC_ASAN_POISON_OBJECTS </span><span class="dv">1</span></span>
<span id="cb983-24"><a aria-hidden="true" href="#cb983-24" tabindex="-1"></a><span class="pp"># include </span><span class="im">&lt;sanitizer/asan_interface.h&gt;</span></span>
<span id="cb983-25"><a aria-hidden="true" href="#cb983-25" tabindex="-1"></a><span class="pp">#endif</span></span></code></pre></div>
<p><strong>Evolution:</strong> - Comprehensive header comments
explaining purpose and context - Extensive use of conditional
compilation for feature detection - Integration with modern debugging
tools (AddressSanitizer, Valgrind) - Detailed comments explaining memory
management strategies - Support for modern platforms (Android, Windows
NT, pthread)</p>
<h3 data-number="23.3.2" id="elisp-code-evolution"><span class="header-section-number">23.3.2</span> Elisp Code Evolution</h3>
<h4 data-number="23.3.2.1" id="pre-lexical-binding-era"><span class="header-section-number">23.3.2.1</span> Pre-Lexical Binding
Era</h4>
<p>Early Elisp files used dynamic binding exclusively:</p>
<pre class="elisp"><code>;;; Old style - dynamic binding
(defun old-function (arg)
  (let ((temp (process-arg arg)))
    (do-something temp)))</code></pre>
<p><strong>Issues:</strong> - Variable capture risks - Performance
limitations - Harder to reason about scope</p>
<h4 data-number="23.3.2.2" id="modern-lexical-binding-emacs-24"><span class="header-section-number">23.3.2.2</span> Modern Lexical Binding
(Emacs 24+)</h4>
<p>From <code>/home/user/emacs/lisp/simple.el</code>:</p>
<pre class="elisp"><code>;;; simple.el --- basic editing commands for Emacs  -*- lexical-binding: t -*-

;; Copyright (C) 1985-1987, 1993-2025 Free Software Foundation, Inc.

;;; Commentary:

;; A grab-bag of basic Emacs commands not specifically related to some
;; major mode or to file-handling.

;;; Code:

(eval-when-compile (require 'cl-lib))

(declare-function widget-apply "wid-edit" (widget property &amp;rest args))
(declare-function widget-convert "wid-edit" (type &amp;rest args))</code></pre>
<p><strong>Modern Patterns:</strong> - <code>lexical-binding: t</code>
in file header (307+ files in lisp/) - <code>declare-function</code> for
forward declarations - <code>eval-when-compile</code> for
compilation-time dependencies - Structured commentary sections</p>
<h4 data-number="23.3.2.3" id="native-compilation-support-emacs-28"><span class="header-section-number">23.3.2.3</span> Native Compilation Support
(Emacs 28+)</h4>
<p>From <code>/home/user/emacs/src/comp.c</code>:</p>
<div class="sourceCode" id="cb986"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb986-1"><a aria-hidden="true" href="#cb986-1" tabindex="-1"></a><span class="co">/* Compile Emacs Lisp into native code.</span></span>
<span id="cb986-2"><a aria-hidden="true" href="#cb986-2" tabindex="-1"></a><span class="co">   Copyright (C) 2019-2025 Free Software Foundation, Inc.</span></span>
<span id="cb986-3"><a aria-hidden="true" href="#cb986-3" tabindex="-1"></a></span>
<span id="cb986-4"><a aria-hidden="true" href="#cb986-4" tabindex="-1"></a><span class="co">Author: Andrea Corallo &lt;acorallo@gnu.org&gt;</span></span>
<span id="cb986-5"><a aria-hidden="true" href="#cb986-5" tabindex="-1"></a><span class="co">*/</span></span>
<span id="cb986-6"><a aria-hidden="true" href="#cb986-6" tabindex="-1"></a></span>
<span id="cb986-7"><a aria-hidden="true" href="#cb986-7" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;config.h&gt;</span></span>
<span id="cb986-8"><a aria-hidden="true" href="#cb986-8" tabindex="-1"></a></span>
<span id="cb986-9"><a aria-hidden="true" href="#cb986-9" tabindex="-1"></a><span class="pp">#ifdef HAVE_NATIVE_COMP</span></span>
<span id="cb986-10"><a aria-hidden="true" href="#cb986-10" tabindex="-1"></a></span>
<span id="cb986-11"><a aria-hidden="true" href="#cb986-11" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;libgccjit.h&gt;</span></span></code></pre></div>
<p><strong>Innovation:</strong> - JIT compilation of Elisp to native
code - Integration with libgccjit - Dynamic library loading on Windows -
Significant performance improvements</p>
<h4 data-number="23.3.2.4" id="tree-sitter-integration-emacs-29"><span class="header-section-number">23.3.2.4</span> Tree-sitter Integration
(Emacs 29+)</h4>
<p>From <code>/home/user/emacs/src/treesit.c</code>:</p>
<div class="sourceCode" id="cb987"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb987-1"><a aria-hidden="true" href="#cb987-1" tabindex="-1"></a><span class="co">/* Tree-sitter integration for GNU Emacs.</span></span>
<span id="cb987-2"><a aria-hidden="true" href="#cb987-2" tabindex="-1"></a></span>
<span id="cb987-3"><a aria-hidden="true" href="#cb987-3" tabindex="-1"></a><span class="co">Copyright (C) 2021-2025 Free Software Foundation, Inc.</span></span>
<span id="cb987-4"><a aria-hidden="true" href="#cb987-4" tabindex="-1"></a></span>
<span id="cb987-5"><a aria-hidden="true" href="#cb987-5" tabindex="-1"></a><span class="co">Maintainer: Yuan Fu &lt;casouri@gmail.com&gt;</span></span>
<span id="cb987-6"><a aria-hidden="true" href="#cb987-6" tabindex="-1"></a><span class="co">*/</span></span>
<span id="cb987-7"><a aria-hidden="true" href="#cb987-7" tabindex="-1"></a></span>
<span id="cb987-8"><a aria-hidden="true" href="#cb987-8" tabindex="-1"></a><span class="pp">#if HAVE_TREE_SITTER</span></span>
<span id="cb987-9"><a aria-hidden="true" href="#cb987-9" tabindex="-1"></a></span>
<span id="cb987-10"><a aria-hidden="true" href="#cb987-10" tabindex="-1"></a><span class="co">/* Dynamic loading of libtree-sitter.  */</span></span></code></pre></div>
<p><strong>Modern Parsing:</strong> - External library integration -
Modern incremental parsing - Language server protocol support - Better
syntax highlighting and navigation</p>
<h2 data-number="23.4" id="architectural-evolution"><span class="header-section-number">23.4</span> Architectural Evolution</h2>
<h3 data-number="23.4.1" id="major-subsystem-additions"><span class="header-section-number">23.4.1</span> Major Subsystem
Additions</h3>
<h4 data-number="23.4.1.1" id="native-compilation-2019-2021"><span class="header-section-number">23.4.1.1</span> 1. Native Compilation
(2019-2021)</h4>
<p><strong>Design Decisions:</strong> - Optional feature requiring
libgccjit - JIT compilation in subprocess to isolate errors - Maintains
compatibility with byte-compiled code - AOT and JIT compilation
modes</p>
<p><strong>From NEWS.28:</strong></p>
<pre><code>** Emacs now optionally supports native compilation of Lisp files.
To enable this, configure Emacs with the '--with-native-compilation' option.
This requires the libgccjit library to be installed and functional.

Note that JIT native compilation is done in a fresh session of Emacs
that is run in a subprocess, so it can legitimately report some
warnings and errors that aren't uncovered by byte-compilation.</code></pre>
<h4 data-number="23.4.1.2" id="tree-sitter-2021-2022"><span class="header-section-number">23.4.1.2</span> 2. Tree-sitter
(2021-2022)</h4>
<p><strong>Integration Strategy:</strong> - Dynamic library loading (not
statically linked) - Coexistence with traditional parsing - Gradual
migration path for major modes - Language grammar modules loaded
separately</p>
<h4 data-number="23.4.1.3" id="modern-graphics-and-display"><span class="header-section-number">23.4.1.3</span> 3. Modern Graphics and
Display</h4>
<p><strong>Evolution:</strong> - Cairo graphics (default since Emacs 28)
- HarfBuzz text shaping - Emoji support with Unicode 14.0 - 24-bit color
terminal support</p>
<h3 data-number="23.4.2" id="refactoring-patterns"><span class="header-section-number">23.4.2</span> Refactoring Patterns</h3>
<h4 data-number="23.4.2.1" id="incremental-modernization-1"><span class="header-section-number">23.4.2.1</span> Incremental
Modernization</h4>
<p>The codebase shows consistent patterns of incremental
improvement:</p>
<ol type="1">
<li><strong>Feature Flags</strong>: New features are optional and
detected at compile time</li>
<li><strong>Compatibility Layers</strong>: Old APIs maintained alongside
new ones</li>
<li><strong>Gradual Migration</strong>: Multiple versions of transition
support</li>
</ol>
<p>Example from configure options evolution: - Emacs 24:
<code>--with-file-notification</code> - Emacs 28:
<code>--with-native-compilation</code> - Modern:
<code>--with-tree-sitter</code>, <code>--with-cairo</code></p>
<h2 data-number="23.5" id="deprecation-strategy"><span class="header-section-number">23.5</span> Deprecation Strategy</h2>
<h3 data-number="23.5.1" id="systematic-obsolescence"><span class="header-section-number">23.5.1</span> Systematic Obsolescence</h3>
<p>From <code>/home/user/emacs/lisp/subr.el</code>:</p>
<pre class="elisp"><code>(make-obsolete 'ESC-prefix 'esc-map "28.1")
(make-obsolete 'Control-X-prefix 'ctl-x-map "28.1")
(make-obsolete 'string-as-unibyte "use `encode-coding-string'." "26.1")
(make-obsolete 'string-make-unibyte "use `encode-coding-string'." "26.1")</code></pre>
<p><strong>Deprecation Principles:</strong> 1. <strong>Version
Attribution</strong>: Each obsolete item marked with version number 2.
<strong>Migration Path</strong>: Replacement suggested in deprecation
message 3. <strong>Long Sunset</strong>: Features remain functional for
multiple versions 4. <strong>Documentation</strong>: NEWS files announce
deprecations</p>
<h3 data-number="23.5.2" id="version-tagging"><span class="header-section-number">23.5.2</span> Version Tagging</h3>
<pre class="elisp"><code>(defcustom new-option nil
  "Documentation string."
  :type 'boolean
  :version "29.1"  ; First version where this appears
  :group 'editing)</code></pre>
<p>All new <code>defcustom</code> and <code>defface</code> declarations
require <code>:version</code> tags.</p>
<h2 data-number="23.6" id="community-practices-evolution"><span class="header-section-number">23.6</span> Community Practices
Evolution</h2>
<h3 data-number="23.6.1" id="commit-message-standards"><span class="header-section-number">23.6.1</span> Commit Message
Standards</h3>
<h4 data-number="23.6.1.1" id="early-format-1986"><span class="header-section-number">23.6.1.1</span> Early Format (1986)</h4>
<pre><code>1986-05-05  Richard M. Stallman  (rms@prep)

    * isearch.el (isearch):
    Fix bug extending a search string in place
    in reverse regexp search.</code></pre>
<p><strong>Characteristics:</strong> - Manual ChangeLog entries - Simple
date/author/file format - Brief descriptions</p>
<h4 data-number="23.6.1.2" id="modern-format-2025"><span class="header-section-number">23.6.1.2</span> Modern Format (2025)</h4>
<pre><code>; Improve wording of documentation of 'hs-cycle-filter'

* lisp/replace.el (replace--push-stack, perform-replace): Use markers

lisp/emacs-lisp/bytecomp.el (define-widget): Add `funarg-positions`

hideshow: Simplify code. (Bug#79585)</code></pre>
<p><strong>Evolution:</strong> - Semicolon prefix for documentation-only
changes - Asterisk prefix for substantive changes - Bug tracker
integration (Bug#NNNNN) - Automatic ChangeLog generation from commit
messages - File and function specificity in commit subjects</p>
<h3 data-number="23.6.2" id="git-workflow-modern-era"><span class="header-section-number">23.6.2</span> Git Workflow (Modern
Era)</h3>
<p>From <code>/home/user/emacs/admin/notes/git-workflow</code>:</p>
<div class="sourceCode" id="cb993"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb993-1"><a aria-hidden="true" href="#cb993-1" tabindex="-1"></a><span class="co"># Standard workflow</span></span>
<span id="cb993-2"><a aria-hidden="true" href="#cb993-2" tabindex="-1"></a><span class="fu">git</span> config <span class="at">--global</span> user.name <span class="st">"Your Name"</span></span>
<span id="cb993-3"><a aria-hidden="true" href="#cb993-3" tabindex="-1"></a><span class="fu">git</span> config <span class="at">--global</span> user.email <span class="st">"your.email@example.com"</span></span>
<span id="cb993-4"><a aria-hidden="true" href="#cb993-4" tabindex="-1"></a><span class="fu">git</span> config <span class="at">--global</span> transfer.fsckObjects true  <span class="co"># Integrity checking</span></span>
<span id="cb993-5"><a aria-hidden="true" href="#cb993-5" tabindex="-1"></a></span>
<span id="cb993-6"><a aria-hidden="true" href="#cb993-6" tabindex="-1"></a><span class="co"># Work with multiple branches</span></span>
<span id="cb993-7"><a aria-hidden="true" href="#cb993-7" tabindex="-1"></a><span class="fu">git</span> worktree add ../emacs-30 emacs-30</span>
<span id="cb993-8"><a aria-hidden="true" href="#cb993-8" tabindex="-1"></a></span>
<span id="cb993-9"><a aria-hidden="true" href="#cb993-9" tabindex="-1"></a><span class="co"># Workflow</span></span>
<span id="cb993-10"><a aria-hidden="true" href="#cb993-10" tabindex="-1"></a><span class="fu">git</span> pull <span class="at">--rebase</span>  <span class="co"># Update before pushing</span></span>
<span id="cb993-11"><a aria-hidden="true" href="#cb993-11" tabindex="-1"></a><span class="fu">git</span> push</span></code></pre></div>
<p><strong>Best Practices:</strong> 1. <strong>Worktrees</strong>:
Multiple branches accessible simultaneously 2. <strong>Rebase
Workflow</strong>: Keep linear history 3. <strong>Integrity
Checks</strong>: fsckObjects enabled 4. <strong>Backporting</strong>:
Cherry-pick with <code>-xe</code> flag and ‚ÄúBackport:‚Äù annotation</p>
<h3 data-number="23.6.3" id="bug-tracking-integration"><span class="header-section-number">23.6.3</span> Bug Tracking
Integration</h3>
<p>From <code>/home/user/emacs/admin/notes/bugtracker</code>:</p>
<p><strong>Modern Workflow:</strong> 1. <strong>Report</strong>:
<code>M-x report-emacs-bug</code> or email to bug-gnu-emacs@gnu.org 2.
<strong>Track</strong>: Automatic assignment via debbugs.gnu.org 3.
<strong>Comment</strong>: Reply to NNNN@debbugs.gnu.org 4.
<strong>Close</strong>: Email NNNN-done@debbugs.gnu.org 5.
<strong>Metadata</strong>: Control via control@debbugs.gnu.org</p>
<p><strong>Severity Levels:</strong> - <code>serious</code>: Major
functionality broken - <code>important</code>: Significant but not
critical - <code>normal</code>: Standard bugs - <code>minor</code>:
Small issues - <code>wishlist</code>: Feature requests</p>
<p><strong>Tags:</strong> - <code>moreinfo</code>: Needs additional
information - <code>unreproducible</code>: Cannot reproduce -
<code>wontfix</code>: Won‚Äôt be fixed - <code>patch</code>: Patch
available - <code>notabug</code>: Not actually a bug</p>
<h3 data-number="23.6.4" id="testing-evolution"><span class="header-section-number">23.6.4</span> Testing Evolution</h3>
<h4 data-number="23.6.4.1" id="modern-test-infrastructure"><span class="header-section-number">23.6.4.1</span> Modern Test
Infrastructure</h4>
<p><strong>Statistics:</strong> - 677 test files in
<code>/home/user/emacs/test/</code> - 217+ files with
<code>ert-deftest</code> (ERT framework) - Comprehensive test coverage
for new features</p>
<p><strong>Test Patterns:</strong></p>
<pre class="elisp"><code>(ert-deftest test-name ()
  "Test description."
  (should (equal expected actual)))

(ert-deftest expensive-test ()
  "Long-running test."
  :tags '(:expensive-test)
  (should (complex-operation)))</code></pre>
<p><strong>Testing Requirements</strong> (from CONTRIBUTE): 1. Add tests
with bug fixes and new features 2. Mark expensive tests with
<code>:tags '(:expensive-test)</code> 3. Run <code>make check</code>
before committing 4. Test specific files:
<code>make filename-tests</code> 5. Test out-of-tree builds</p>
<h3 data-number="23.6.5" id="documentation-standards"><span class="header-section-number">23.6.5</span> Documentation Standards</h3>
<h4 data-number="23.6.5.1" id="news-file-evolution"><span class="header-section-number">23.6.5.1</span> NEWS File Evolution</h4>
<p>Each major version has comprehensive NEWS file documenting
changes:</p>
<p><strong>Structure:</strong> - Installation Changes - Startup Changes
- Core Changes - Specialized Modes and Packages - Lisp Changes -
Deprecated/Obsolete Features</p>
<h4 data-number="23.6.5.2" id="documentation-requirements"><span class="header-section-number">23.6.5.2</span> Documentation
Requirements</h4>
<p>From <code>/home/user/emacs/CONTRIBUTE</code>:</p>
<ol type="1">
<li><p><strong>etc/NEWS Entry</strong>: Required for user-visible
changes</p>
<ul>
<li>Mark <code>---</code> if no manual updates needed</li>
<li>Mark <code>+++</code> if manual fully updated</li>
<li>Summarize in one line for outline mode</li>
</ul></li>
<li><p><strong>Version Tags</strong>: All new defcustom/defface need
<code>:version</code></p></li>
<li><p><strong>Texinfo Indexing</strong>: Use proper index commands</p>
<ul>
<li><code>@vindex</code> for variables</li>
<li><code>@findex</code> for functions/commands</li>
<li><code>@kindex</code> for key bindings</li>
</ul></li>
<li><p><strong>Style Guide</strong>:</p>
<ul>
<li>American English spelling</li>
<li>Two spaces between sentences</li>
<li>Use <code>checkdoc</code> before submitting</li>
</ul></li>
</ol>
<h3 data-number="23.6.6" id="code-review-process"><span class="header-section-number">23.6.6</span> Code Review Process</h3>
<h4 data-number="23.6.6.1" id="contribution-workflow"><span class="header-section-number">23.6.6.1</span> Contribution Workflow</h4>
<ol type="1">
<li><strong>Small Changes</strong> (&lt;12 lines): Can be accepted
without copyright assignment</li>
<li><strong>Larger Changes</strong>: Require FSF copyright
assignment</li>
<li><strong>Patch Format</strong>: Use <code>git format-patch</code>
with attachment</li>
<li><strong>Discussion</strong>: Patches reviewed on emacs-devel@ or
bug-gnu-emacs@</li>
</ol>
<h4 data-number="23.6.6.2" id="review-criteria"><span class="header-section-number">23.6.6.2</span> Review Criteria</h4>
<p>From practice observed in recent commits:</p>
<ol type="1">
<li><strong>Style Consistency</strong>: Must match existing code
style</li>
<li><strong>Documentation</strong>: Changes documented in NEWS and
manuals</li>
<li><strong>Tests</strong>: New features require tests</li>
<li><strong>Backward Compatibility</strong>: Breaking changes avoided or
well-justified</li>
<li><strong>Performance</strong>: No significant regressions</li>
</ol>
<h2 data-number="23.7" id="technical-debt-management"><span class="header-section-number">23.7</span> Technical Debt Management</h2>
<h3 data-number="23.7.1" id="approaches-to-technical-debt"><span class="header-section-number">23.7.1</span> Approaches to Technical
Debt</h3>
<h4 data-number="23.7.1.1" id="gradual-modernization"><span class="header-section-number">23.7.1.1</span> 1. Gradual
Modernization</h4>
<p><strong>Pattern</strong>: Introduce new features alongside old
ones</p>
<p>Example - Lexical Binding: - Emacs 24: Introduced opt-in lexical
binding - Emacs 24-27: Gradual migration of core files - Modern: 307+
files converted, dynamic binding still supported</p>
<h4 data-number="23.7.1.2" id="feature-flags-and-conditionals"><span class="header-section-number">23.7.1.2</span> 2. Feature Flags and
Conditionals</h4>
<div class="sourceCode" id="cb995"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb995-1"><a aria-hidden="true" href="#cb995-1" tabindex="-1"></a><span class="pp">#ifdef HAVE_TREE_SITTER</span></span>
<span id="cb995-2"><a aria-hidden="true" href="#cb995-2" tabindex="-1"></a><span class="pp">#include </span><span class="im">"treesit.h"</span></span>
<span id="cb995-3"><a aria-hidden="true" href="#cb995-3" tabindex="-1"></a><span class="pp">#endif</span></span>
<span id="cb995-4"><a aria-hidden="true" href="#cb995-4" tabindex="-1"></a></span>
<span id="cb995-5"><a aria-hidden="true" href="#cb995-5" tabindex="-1"></a><span class="pp">#ifdef HAVE_NATIVE_COMP</span></span>
<span id="cb995-6"><a aria-hidden="true" href="#cb995-6" tabindex="-1"></a><span class="co">// Native compilation support</span></span>
<span id="cb995-7"><a aria-hidden="true" href="#cb995-7" tabindex="-1"></a><span class="pp">#endif</span></span>
<span id="cb995-8"><a aria-hidden="true" href="#cb995-8" tabindex="-1"></a></span>
<span id="cb995-9"><a aria-hidden="true" href="#cb995-9" tabindex="-1"></a><span class="pp">#if ADDRESS_SANITIZER</span></span>
<span id="cb995-10"><a aria-hidden="true" href="#cb995-10" tabindex="-1"></a><span class="co">// Debugging support</span></span>
<span id="cb995-11"><a aria-hidden="true" href="#cb995-11" tabindex="-1"></a><span class="pp">#endif</span></span></code></pre></div>
<p><strong>Benefits:</strong> - Optional features don‚Äôt break minimal
builds - Platform-specific code isolated - Easier to maintain and
test</p>
<h4 data-number="23.7.1.3" id="compatibility-shims"><span class="header-section-number">23.7.1.3</span> 3. Compatibility
Shims</h4>
<pre class="elisp"><code>(make-obsolete-variable 'old-name 'new-name "28.1")

(defun old-function (args)
  "Obsolete. Use `new-function' instead."
  (declare (obsolete new-function "28.1"))
  (new-function args))</code></pre>
<p><strong>Strategy:</strong> - Keep old functions working - Emit
warnings during byte-compilation - Provide clear migration path - Remove
only after multiple major versions</p>
<h4 data-number="23.7.1.4" id="platform-support-strategy"><span class="header-section-number">23.7.1.4</span> 4. Platform Support
Strategy</h4>
<p><strong>Active Support:</strong> - GNU/Linux (primary platform) -
macOS/GNUstep (Nextstep) - Windows (native and WSL) - Android (recent
addition) - BSD variants</p>
<p><strong>Deprecated/Removed:</strong> - OpenBSD &lt; 5.3 (removed
Emacs 28) - Old Unix variants (gradually phased out) - Obsolete
libraries (libXft deprecated, Cairo preferred)</p>
<h3 data-number="23.7.2" id="backward-compatibility-principles"><span class="header-section-number">23.7.2</span> Backward Compatibility
Principles</h3>
<h4 data-number="23.7.2.1" id="version-numbering"><span class="header-section-number">23.7.2.1</span> Version Numbering</h4>
<p>From HISTORY: - Major versions: Significant changes (18, 19, 20,
etc.) - Minor versions: Feature releases (24.1, 24.2, etc.) - Micro
versions: Bug fixes only</p>
<h4 data-number="23.7.2.2" id="compatibility-guarantees"><span class="header-section-number">23.7.2.2</span> Compatibility
Guarantees</h4>
<ol type="1">
<li><strong>Elisp Code</strong>: Old elisp generally continues to
work</li>
<li><strong>Configuration</strong>: <code>.emacs</code> files from old
versions usually work</li>
<li><strong>Data Files</strong>: File formats maintain backward
compatibility</li>
<li><strong>C API</strong>: Internal C API can change between
majors</li>
</ol>
<h4 data-number="23.7.2.3" id="breaking-changes-process"><span class="header-section-number">23.7.2.3</span> Breaking Changes
Process</h4>
<p>When breaking changes are necessary:</p>
<ol type="1">
<li><strong>Announce Early</strong>: In NEWS for previous version</li>
<li><strong>Provide Warning Period</strong>: Usually 2+ major
versions</li>
<li><strong>Offer Migration Tools</strong>: Where possible</li>
<li><strong>Document Thoroughly</strong>: Why and how to migrate</li>
</ol>
<h2 data-number="23.8" id="error-handling-evolution"><span class="header-section-number">23.8</span> Error Handling Evolution</h2>
<h3 data-number="23.8.1" id="modern-error-patterns"><span class="header-section-number">23.8.1</span> Modern Error Patterns</h3>
<h4 data-number="23.8.1.1" id="declarative-error-handling"><span class="header-section-number">23.8.1.1</span> Declarative Error
Handling</h4>
<pre class="elisp"><code>(declare-function function-name "file-name" (args))

(when (&lt; emacs-major-version 29)
  (error "This package requires Emacs 29 or later"))</code></pre>
<h4 data-number="23.8.1.2" id="user-friendly-errors"><span class="header-section-number">23.8.1.2</span> User-Friendly Errors</h4>
<pre class="elisp"><code>(user-error "Cannot perform operation in read-only buffer")
;; vs older:
(error "Buffer is read-only")</code></pre>
<p><strong>user-error</strong> doesn‚Äôt generate backtrace in interactive
use, better UX.</p>
<h3 data-number="23.8.2" id="c-code-error-handling"><span class="header-section-number">23.8.2</span> C Code Error Handling</h3>
<p>Modern C code uses sophisticated error handling:</p>
<div class="sourceCode" id="cb999"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb999-1"><a aria-hidden="true" href="#cb999-1" tabindex="-1"></a><span class="co">/* From keyboard.c */</span></span>
<span id="cb999-2"><a aria-hidden="true" href="#cb999-2" tabindex="-1"></a><span class="pp">#if defined HAVE_STACK_OVERFLOW_HANDLING &amp;&amp; !defined WINDOWSNT</span></span>
<span id="cb999-3"><a aria-hidden="true" href="#cb999-3" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;setjmp.h&gt;</span></span>
<span id="cb999-4"><a aria-hidden="true" href="#cb999-4" tabindex="-1"></a><span class="pp">#endif</span></span></code></pre></div>
<p><strong>Patterns:</strong> - Stack overflow protection - Signal
handling - Graceful degradation on missing features - Platform-specific
error paths</p>
<h2 data-number="23.9" id="key-transitions-analysis"><span class="header-section-number">23.9</span> Key Transitions Analysis</h2>
<h3 data-number="23.9.1" id="pre-git-to-git-2008-2014"><span class="header-section-number">23.9.1</span> 1. Pre-Git to Git
(2008-2014)</h3>
<p><strong>Impact:</strong> - Easier branching and merging - Distributed
development - Better tracking of authorship - Simplified backporting</p>
<p><strong>Challenges:</strong> - Migration of history - Learning curve
for contributors - Tool integration updates</p>
<h3 data-number="23.9.2" id="lexical-binding-emacs-24-2012"><span class="header-section-number">23.9.2</span> 2. Lexical Binding (Emacs
24, 2012)</h3>
<p><strong>Motivation:</strong> - Performance improvements - Safer
scoping - Better optimization opportunities</p>
<p><strong>Migration Strategy:</strong> - Opt-in via file header -
Gradual conversion of core files - Compatibility maintained - Clear
documentation</p>
<p><strong>Impact:</strong> - ~45% of core lisp files now lexical -
Foundation for native compilation - More predictable code behavior</p>
<h3 data-number="23.9.3" id="native-compilation-emacs-28-2021"><span class="header-section-number">23.9.3</span> 3. Native Compilation (Emacs
28, 2021)</h3>
<p><strong>Technical Achievement:</strong> - 2-3x performance
improvement for compute-heavy code - JIT compilation support - Maintains
byte-code compatibility</p>
<p><strong>Design Decisions:</strong> - Optional feature (requires
libgccjit) - Separate compilation subprocess (isolation) - Transparent
to end users - Can coexist with byte-compiled code</p>
<p><strong>Challenges:</strong> - Platform compatibility - Build system
complexity - Debugging native code - Disk space for .eln files</p>
<h3 data-number="23.9.4" id="tree-sitter-integration-emacs-29-2022"><span class="header-section-number">23.9.4</span> 4. Tree-sitter Integration
(Emacs 29, 2022)</h3>
<p><strong>Advantages:</strong> - Incremental parsing - Error recovery -
Consistent syntax trees - Language server protocol compatibility</p>
<p><strong>Integration Approach:</strong> - Dynamic loading (not
required dependency) - Language grammars as separate modules -
Coexistence with traditional modes - New <code>-ts-mode</code> suffix
convention</p>
<p><strong>Impact on Modes:</strong></p>
<pre><code>python-mode        # Traditional
python-ts-mode     # Tree-sitter based</code></pre>
<p>Users can choose, gradual migration path.</p>
<h2 data-number="23.10" id="documentation-practices-evolution"><span class="header-section-number">23.10</span> Documentation Practices
Evolution</h2>
<h3 data-number="23.10.1" id="early-documentation"><span class="header-section-number">23.10.1</span> Early Documentation</h3>
<p>From NEWS.1-17 (1986):</p>
<pre><code>** Frustrated?

Try M-x doctor.

** Bored?

Try M-x hanoi.</code></pre>
<p><strong>Characteristics:</strong> - Playful tone - Less formal
structure - Focus on features</p>
<h3 data-number="23.10.2" id="modern-documentation"><span class="header-section-number">23.10.2</span> Modern Documentation</h3>
<p>Contemporary documentation is comprehensive and structured:</p>
<h4 data-number="23.10.2.1" id="inline-documentation-1"><span class="header-section-number">23.10.2.1</span> 1. Inline
Documentation</h4>
<pre class="elisp"><code>(defcustom idle-update-delay 0.5
  "Idle time delay before updating various things on the screen.
Various Emacs features that update auxiliary information when point moves
wait this many seconds after Emacs becomes idle before doing an update."
  :type 'number
  :group 'display
  :version "22.1")</code></pre>
<p><strong>Required Elements:</strong> - Clear description - Type
specification - Customization group - Version introduced</p>
<h4 data-number="23.10.2.2" id="manual-integration"><span class="header-section-number">23.10.2.2</span> 2. Manual
Integration</h4>
<p>Comprehensive Texinfo manuals: - Emacs Manual (user guide) - Elisp
Reference Manual - Specialized guides (Org, Gnus, etc.)</p>
<h4 data-number="23.10.2.3" id="commentary-sections"><span class="header-section-number">23.10.2.3</span> 3. Commentary
Sections</h4>
<pre class="elisp"><code>;;; Commentary:

;; This file provides basic editing commands.
;; It includes:
;; - Text manipulation
;; - Navigation
;; - Undo/redo
;; - Mark and region handling</code></pre>
<h3 data-number="23.10.3" id="comment-style-evolution"><span class="header-section-number">23.10.3</span> Comment Style
Evolution</h3>
<h4 data-number="23.10.3.1" id="c-code-comments"><span class="header-section-number">23.10.3.1</span> C Code Comments</h4>
<p><strong>Modern Style:</strong></p>
<div class="sourceCode" id="cb1004"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb1004-1"><a aria-hidden="true" href="#cb1004-1" tabindex="-1"></a><span class="co">/* AddressSanitizer exposes additional functions for manually marking</span></span>
<span id="cb1004-2"><a aria-hidden="true" href="#cb1004-2" tabindex="-1"></a><span class="co">   memory as poisoned/unpoisoned.  When ASan is enabled and the needed</span></span>
<span id="cb1004-3"><a aria-hidden="true" href="#cb1004-3" tabindex="-1"></a><span class="co">   header is available, memory is poisoned when:</span></span>
<span id="cb1004-4"><a aria-hidden="true" href="#cb1004-4" tabindex="-1"></a></span>
<span id="cb1004-5"><a aria-hidden="true" href="#cb1004-5" tabindex="-1"></a><span class="co">   * An ablock is freed (lisp_align_free), or ablocks are initially</span></span>
<span id="cb1004-6"><a aria-hidden="true" href="#cb1004-6" tabindex="-1"></a><span class="co">   allocated (lisp_align_malloc).</span></span>
<span id="cb1004-7"><a aria-hidden="true" href="#cb1004-7" tabindex="-1"></a><span class="co">   * An interval_block is initially allocated (make_interval).</span></span>
<span id="cb1004-8"><a aria-hidden="true" href="#cb1004-8" tabindex="-1"></a><span class="co">   ...</span></span>
<span id="cb1004-9"><a aria-hidden="true" href="#cb1004-9" tabindex="-1"></a></span>
<span id="cb1004-10"><a aria-hidden="true" href="#cb1004-10" tabindex="-1"></a><span class="co">   This feature can be disabled with the run-time flag</span></span>
<span id="cb1004-11"><a aria-hidden="true" href="#cb1004-11" tabindex="-1"></a><span class="co">   `allow_user_poisoning' set to zero.  */</span></span></code></pre></div>
<p><strong>Characteristics:</strong> - Multi-line explanatory comments -
Bulleted lists for complex information - Configuration options
documented - Clear purpose and context</p>
<h4 data-number="23.10.3.2" id="elisp-comments"><span class="header-section-number">23.10.3.2</span> Elisp Comments</h4>
<pre class="elisp"><code>;;; Package --- Summary line  -*- lexical-binding: t -*-

;; Copyright notice

;; Author: Name &lt;email&gt;
;; Keywords: keyword1 keyword2
;; Package: package-name

;;; Commentary:

;; Detailed description

;;; Code:

;; Implementation</code></pre>
<p>Standard structured format.</p>
<h2 data-number="23.11" id="performance-evolution"><span class="header-section-number">23.11</span> Performance Evolution</h2>
<h3 data-number="23.11.1" id="optimization-strategies-5"><span class="header-section-number">23.11.1</span> Optimization
Strategies</h3>
<h4 data-number="23.11.1.1" id="byte-compilation-traditional"><span class="header-section-number">23.11.1.1</span> 1. Byte Compilation
(Traditional)</h4>
<p>From <code>/home/user/emacs/lisp/emacs-lisp/bytecomp.el</code>:</p>
<pre class="elisp"><code>;; This version of the byte compiler has the following improvements:
;;  + optimization of compiled code:
;;    - removal of unreachable code;
;;    - removal of calls to side-effectless functions whose return-value
;;      is unused;
;;    - compile-time evaluation of safe constant forms
;;    - open-coding of literal lambdas;
;;    - peephole optimization of emitted code;
;;    - trivial functions are left uncompiled for speed.</code></pre>
<h4 data-number="23.11.1.2" id="native-compilation-modern"><span class="header-section-number">23.11.1.2</span> 2. Native Compilation
(Modern)</h4>
<p>Additional optimizations: - Machine code generation - Better register
allocation - Inlining opportunities - Type-based optimizations</p>
<h4 data-number="23.11.1.3" id="lazy-loading-2"><span class="header-section-number">23.11.1.3</span> 3. Lazy Loading</h4>
<pre class="elisp"><code>(autoload 'function-name "file-name"
  "Documentation."
  t)  ; Interactive</code></pre>
<p><strong>Benefits:</strong> - Faster startup - Reduced memory usage -
Load features on demand</p>
<h2 data-number="23.12" id="modern-development-tools-integration"><span class="header-section-number">23.12</span> Modern Development Tools
Integration</h2>
<h3 data-number="23.12.1" id="sanitizers-and-debugging"><span class="header-section-number">23.12.1</span> 1. Sanitizers and
Debugging</h3>
<div class="sourceCode" id="cb1008"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb1008-1"><a aria-hidden="true" href="#cb1008-1" tabindex="-1"></a><span class="pp">#if ADDRESS_SANITIZER</span></span>
<span id="cb1008-2"><a aria-hidden="true" href="#cb1008-2" tabindex="-1"></a><span class="pp"># include </span><span class="im">&lt;sanitizer/asan_interface.h&gt;</span></span>
<span id="cb1008-3"><a aria-hidden="true" href="#cb1008-3" tabindex="-1"></a><span class="pp">#endif</span></span>
<span id="cb1008-4"><a aria-hidden="true" href="#cb1008-4" tabindex="-1"></a></span>
<span id="cb1008-5"><a aria-hidden="true" href="#cb1008-5" tabindex="-1"></a><span class="pp">#if USE_VALGRIND</span></span>
<span id="cb1008-6"><a aria-hidden="true" href="#cb1008-6" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;valgrind/valgrind.h&gt;</span></span>
<span id="cb1008-7"><a aria-hidden="true" href="#cb1008-7" tabindex="-1"></a><span class="pp">#endif</span></span></code></pre></div>
<p><strong>Support for:</strong> - AddressSanitizer (memory errors) -
Valgrind (memory debugging) - GDB integration - Stack overflow
handling</p>
<h3 data-number="23.12.2" id="continuous-integration-1"><span class="header-section-number">23.12.2</span> 2. Continuous
Integration</h3>
<p>Modern development includes: - Automated testing on multiple
platforms - Regular builds for supported systems - Pre-merge testing
requirements</p>
<h3 data-number="23.12.3" id="package-management"><span class="header-section-number">23.12.3</span> 3. Package Management</h3>
<p>Integration with package.el: - ELPA (GNU Emacs Lisp Package Archive)
- MELPA (community packages) - Package versioning - Dependency
management</p>
<h2 data-number="23.13" id="lessons-learned"><span class="header-section-number">23.13</span> Lessons Learned</h2>
<h3 data-number="23.13.1" id="incremental-change-philosophy"><span class="header-section-number">23.13.1</span> 1. Incremental Change
Philosophy</h3>
<p><strong>Principle</strong>: Never break existing functionality
without extremely good reason.</p>
<p><strong>Application:</strong> - New features opt-in by default - Old
features deprecated slowly - Migration paths always provided -
Compatibility tested rigorously</p>
<h3 data-number="23.13.2" id="documentation-as-first-class-citizen"><span class="header-section-number">23.13.2</span> 2. Documentation as
First-Class Citizen</h3>
<p><strong>Evolution</strong>: From minimal comments to comprehensive
documentation: - Every user-facing change documented in NEWS - Manual
updates required for new features - Inline documentation improved
continuously - Examples and tutorials maintained</p>
<h3 data-number="23.13.3" id="testing-investment-pays-off"><span class="header-section-number">23.13.3</span> 3. Testing Investment Pays
Off</h3>
<p><strong>Growth</strong>: From ad-hoc testing to systematic test
suites: - 677 test files covering core functionality - ERT framework
provides structure - Expensive tests tagged separately - Pre-commit
testing encouraged</p>
<h3 data-number="23.13.4" id="platform-diversity-requires-discipline"><span class="header-section-number">23.13.4</span> 4. Platform Diversity
Requires Discipline</h3>
<p><strong>Approach</strong>: Support many platforms through: - Feature
detection at configure time - Conditional compilation - Graceful
degradation - Platform-specific maintainers</p>
<h3 data-number="23.13.5" id="community-stewardship"><span class="header-section-number">23.13.5</span> 5. Community
Stewardship</h3>
<p><strong>Long-term View</strong>: - Code written in 1986 still
maintained - Contributors from multiple generations - Institutional
knowledge preserved - Meritocratic governance</p>
<h2 data-number="23.14" id="current-state-2025"><span class="header-section-number">23.14</span> Current State (2025)</h2>
<h3 data-number="23.14.1" id="codebase-statistics"><span class="header-section-number">23.14.1</span> Codebase Statistics</h3>
<ul>
<li><strong>Languages</strong>: C (core), Elisp (extension), shell
scripts (build)</li>
<li><strong>Lines of Code</strong>: Millions (exact count varies by
what‚Äôs included)</li>
<li><strong>Active Development</strong>: Continuous</li>
<li><strong>Release Cycle</strong>: ~1 year between majors, frequent bug
fixes</li>
</ul>
<h3 data-number="23.14.2" id="modern-features"><span class="header-section-number">23.14.2</span> Modern Features</h3>
<ol type="1">
<li><strong>Native Compilation</strong>: Production ready</li>
<li><strong>Tree-sitter</strong>: Multiple language modes available</li>
<li><strong>LSP Integration</strong>: Via Eglot (built-in since
29.1)</li>
<li><strong>Modern Graphics</strong>: Cairo, HarfBuzz, emoji
support</li>
<li><strong>Improved Performance</strong>: JIT compilation, better
algorithms</li>
</ol>
<h3 data-number="23.14.3" id="development-practices"><span class="header-section-number">23.14.3</span> Development Practices</h3>
<ol type="1">
<li><strong>Version Control</strong>: Git with structured workflow</li>
<li><strong>Bug Tracking</strong>: debbugs.gnu.org integration</li>
<li><strong>Testing</strong>: ERT with extensive coverage</li>
<li><strong>Documentation</strong>: Comprehensive and maintained</li>
<li><strong>Code Review</strong>: Mailing list based, thorough</li>
</ol>
<h3 data-number="23.14.4" id="community-health"><span class="header-section-number">23.14.4</span> Community Health</h3>
<ol type="1">
<li><strong>Active Maintainers</strong>: Multiple core contributors</li>
<li><strong>Regular Releases</strong>: Predictable schedule</li>
<li><strong>Contributor Growth</strong>: New developers joining</li>
<li><strong>Package Ecosystem</strong>: Thriving third-party
packages</li>
<li><strong>Long-term Stability</strong>: 40 years of continuous
development</li>
</ol>
<h2 data-number="23.15" id="future-directions-2"><span class="header-section-number">23.15</span> Future Directions</h2>
<h3 data-number="23.15.1" id="emerging-patterns"><span class="header-section-number">23.15.1</span> Emerging Patterns</h3>
<ol type="1">
<li><strong>More Tree-sitter Modes</strong>: Gradual migration from
traditional parsing</li>
<li><strong>Improved LSP Support</strong>: Better integration, more
languages</li>
<li><strong>Performance Optimization</strong>: Continued native
compilation improvements</li>
<li><strong>Modern UI Capabilities</strong>: Better graphics, fonts,
rendering</li>
<li><strong>Platform Expansion</strong>: Android support maturing</li>
</ol>
<h3 data-number="23.15.2" id="technical-debt-areas"><span class="header-section-number">23.15.2</span> Technical Debt Areas</h3>
<ol type="1">
<li><strong>Old C Code</strong>: Some files date to 1986, gradual
modernization needed</li>
<li><strong>Dynamic Binding</strong>: Still default, migration to
lexical ongoing</li>
<li><strong>Build System</strong>: Complex, could be simplified</li>
<li><strong>Platform Support</strong>: Some legacy platforms still
supported</li>
</ol>
<h3 data-number="23.15.3" id="opportunities"><span class="header-section-number">23.15.3</span> Opportunities</h3>
<ol type="1">
<li><strong>Concurrency</strong>: Better support for parallel
execution</li>
<li><strong>Modern C Standards</strong>: Gradual adoption of C11/C17
features</li>
<li><strong>Memory Management</strong>: Improved GC algorithms</li>
<li><strong>Startup Time</strong>: Further optimization possible</li>
</ol>
<h2 data-number="23.16" id="conclusion-7"><span class="header-section-number">23.16</span> Conclusion</h2>
<p>The Emacs codebase represents a remarkable example of sustainable
software development over four decades. Key factors in its success:</p>
<ol type="1">
<li><strong>Conservative Innovation</strong>: New features added
carefully without breaking existing functionality</li>
<li><strong>Strong Documentation Culture</strong>: Every change
documented, manuals comprehensive</li>
<li><strong>Systematic Testing</strong>: Investment in test
infrastructure pays dividends</li>
<li><strong>Community Focus</strong>: Development process open,
inclusive, and meritocratic</li>
<li><strong>Long-term Thinking</strong>: Changes made with future
maintainability in mind</li>
</ol>
<p>The evolution from a simple text editor to a comprehensive computing
environment, while maintaining backward compatibility and code quality,
demonstrates principles applicable to any long-lived software
project:</p>
<ul>
<li><strong>Incremental change</strong> beats revolutionary
rewrites</li>
<li><strong>Documentation</strong> is as important as code</li>
<li><strong>Testing</strong> prevents regressions and builds
confidence</li>
<li><strong>Community</strong> sustains projects beyond individual
contributors</li>
<li><strong>Pragmatism</strong> balanced with vision enables lasting
success</li>
</ul>
<p>As Emacs enters its fifth decade, these practices position it well
for continued evolution and relevance in the modern software development
landscape.</p>
<h2 data-number="23.17" id="references-6"><span class="header-section-number">23.17</span> References</h2>
<h3 data-number="23.17.1" id="primary-sources-1"><span class="header-section-number">23.17.1</span> Primary Sources</h3>
<ul>
<li><code>/home/user/emacs/etc/NEWS*</code> - Historical release
notes</li>
<li><code>/home/user/emacs/ChangeLog*</code> - Historical commit
logs</li>
<li><code>/home/user/emacs/etc/HISTORY</code> - Version timeline</li>
<li><code>/home/user/emacs/CONTRIBUTE</code> - Contribution
guidelines</li>
<li><code>/home/user/emacs/admin/notes/</code> - Developer
documentation</li>
</ul>
<h3 data-number="23.17.2" id="key-files-analyzed"><span class="header-section-number">23.17.2</span> Key Files Analyzed</h3>
<ul>
<li><code>/home/user/emacs/src/alloc.c</code> - Memory management
evolution</li>
<li><code>/home/user/emacs/src/keyboard.c</code> - Core input
handling</li>
<li><code>/home/user/emacs/src/treesit.c</code> - Tree-sitter
integration</li>
<li><code>/home/user/emacs/src/comp.c</code> - Native compilation</li>
<li><code>/home/user/emacs/lisp/simple.el</code> - Core Elisp
functions</li>
<li><code>/home/user/emacs/lisp/emacs-lisp/bytecomp.el</code> - Byte
compiler</li>
</ul>
<h3 data-number="23.17.3" id="development-infrastructure"><span class="header-section-number">23.17.3</span> Development
Infrastructure</h3>
<ul>
<li>Git Repository: https://git.savannah.gnu.org/git/emacs.git</li>
<li>Bug Tracker: https://debbugs.gnu.org</li>
<li>Mailing Lists: emacs-devel@gnu.org, bug-gnu-emacs@gnu.org</li>
<li>Development Wiki: https://www.emacswiki.org</li>
</ul>
<hr/>
<p><em>Document Version: 1.0</em> <em>Date: 2025-11-18</em> <em>Analysis
Period: 1985-2025</em></p>
<h1 data-number="24" id="technology-industry-trends-and-emacs-evolution"><span class="header-section-number">24</span> Technology Industry Trends and
Emacs Evolution</h1>
<p>This chapter analyzes Emacs in the context of broader technology
industry trends and historical developments, explaining WHY Emacs
evolved the way it did by connecting it to industry changes over five
decades.</p>
<h2 data-number="24.1" id="table-of-contents-11"><span class="header-section-number">24.1</span> Table of Contents</h2>
<ol type="1">
<li><a href="#the-lisp-machine-era-1970s-1980s">The Lisp Machine Era
(1970s-1980s)</a></li>
<li><a href="#the-unix-wars-and-portability-1980s-1990s">The Unix Wars
and Portability (1980s-1990s)</a></li>
<li><a href="#the-rise-of-ides-1990s-2000s">The Rise of IDEs
(1990s-2000s)</a></li>
<li><a href="#the-web-era-2000s-2010s">The Web Era
(2000s-2010s)</a></li>
<li><a href="#the-language-server-protocol-revolution-2016-present">The
Language Server Protocol Revolution (2016-present)</a></li>
<li><a href="#mobile-computing-2010s-2020s">Mobile Computing
(2010s-2020s)</a></li>
<li><a href="#performance-wars-2010s-2020s">Performance Wars
(2010s-2020s)</a></li>
<li><a href="#modern-development-practices">Modern Development
Practices</a></li>
</ol>
<hr/>
<h2 data-number="24.2" id="the-lisp-machine-era-1970s-1980s"><span class="header-section-number">24.2</span> The Lisp Machine Era
(1970s-1980s)</h2>
<h3 data-number="24.2.1" id="industry-context"><span class="header-section-number">24.2.1</span> Industry Context</h3>
<p>The Lisp Machine era represents a unique period in computing history
when specialized hardware was designed specifically to run Lisp
efficiently. At the MIT AI Lab in the mid-1970s, Richard Greenblatt and
colleagues hand-assembled the first Lisp machines, creating the CADR
design that would spawn an industry.</p>
<p>Two companies emerged from MIT to commercialize this technology:</p>
<ul>
<li><p><strong>Symbolics, Inc.</strong> (founded 1980): Led by Russell
Noftsker and attracting most of the MIT hackers, Symbolics produced the
LM-2 (1981) at $70,000 per unit, shipping about 100 units. Their
second-generation 3600 expanded the CADR design with 36-bit words and
28-bit address space.</p></li>
<li><p><strong>Lisp Machines, Inc.¬†(LMI)</strong> (founded 1980): Led by
Richard Greenblatt, LMI produced the LAMBDA (1983), selling about 200
units. Texas Instruments licensed the design for their TI
Explorer.</p></li>
</ul>
<p>Despite modest commercial success (approximately 7,000 total units by
1988), Lisp machines pioneered technologies that became commonplace
decades later: - Windowing systems - Computer mice - High-resolution
bitmap graphics - Laser printing - Networking (Chaosnet) - Effective
garbage collection</p>
<h3 data-number="24.2.2" id="why-emacs-is-a-lisp-machine-for-text"><span class="header-section-number">24.2.2</span> Why Emacs is ‚ÄúA Lisp Machine
for Text‚Äù</h3>
<p>Emacs inherited and preserved the Lisp Machine‚Äôs fundamental design
philosophy: a powerful, self-modifying, introspective computing
environment where the distinction between user and programmer
dissolves.</p>
<p><strong>Key Lisp Machine Characteristics Emacs
Preserved:</strong></p>
<ol type="1">
<li><strong>Live Programming Environment</strong>: Everything can be
inspected and modified while running</li>
<li><strong>Self-Documenting</strong>: The system documents itself
through introspection</li>
<li><strong>Incremental Redefinition</strong>: Functions can be
redefined without restarting</li>
<li><strong>Image-Based Persistence</strong>: State persists across
sessions (saved registers, histories)</li>
<li><strong>Integrated Tools</strong>: Debugger, profiler, and
development tools are part of the environment</li>
</ol>
<p>The original Emacs (TECO-based) at MIT was contemporary with early
Lisp Machine development. GNU Emacs (1984-1985) emerged just as
commercial Lisp machines were entering the market. When LMI went
bankrupt in 1987, Emacs had already positioned itself as the portable
survivor of that culture.</p>
<h3 data-number="24.2.3" id="the-decline-of-lisp-machines-and-emacss-preservation"><span class="header-section-number">24.2.3</span> The Decline of Lisp Machines
and Emacs‚Äôs Preservation</h3>
<p>The Lisp Machine business collapsed for economic reasons: -
General-purpose workstations (Sun, Apollo) became powerful enough - Cost
differential was unsustainable ($70,000+ vs.¬†$10,000) - Market was too
small (AI research only) - Industry standardization favored Unix/C</p>
<p><strong>How Emacs Preserved the Model:</strong></p>
<p>Emacs successfully transplanted Lisp Machine culture to Unix and
other platforms by:</p>
<pre class="elisp"><code>;; From lisp/treesit.c comment showing Lisp Machine philosophy persists:
;; "Wrap the node in a Lisp_Object to be used in the Lisp machine."</code></pre>
<ul>
<li>Making Elisp the scripting substrate (vs.¬†shell scripts)</li>
<li>Providing complete introspection (<code>describe-function</code>,
<code>describe-variable</code>)</li>
<li>Maintaining self-documentation as a first-class feature</li>
<li>Preserving the ‚Äúenvironment, not just editor‚Äù philosophy</li>
<li>Keeping the interactive development loop central</li>
</ul>
<p>This preservation was crucial: it maintained a programming culture
and methodology that would have otherwise disappeared when Lisp machines
became economically unviable.</p>
<hr/>
<h2 data-number="24.3" id="the-unix-wars-and-portability-1980s-1990s"><span class="header-section-number">24.3</span> the Unix Wars and Portability
(1980s-1990s)</h2>
<h3 data-number="24.3.1" id="industry-context-1"><span class="header-section-number">24.3.1</span> Industry Context</h3>
<p>The Unix Wars of the late 1980s and early 1990s created a fragmented
landscape that made software portability a critical concern.</p>
<p><strong>The Fragmentation Problem:</strong></p>
<p>By the mid-1980s, three major Unix variants competed: -
<strong>AT&amp;T System III</strong>: Basis for Microsoft Xenix and IBM
PC/IX - <strong>AT&amp;T System V</strong>: AT&amp;T‚Äôs attempt at a new
standard - <strong>Berkeley Software Distribution (BSD)</strong>: The
academic alternative</p>
<p>The scale of fragmentation was staggering: database vendor Informix
had to maintain over 1,000 SKUs of their products to support 100+
different Unix systems. This wasn‚Äôt sustainable for anyone.</p>
<p><strong>Standardization Efforts:</strong></p>
<ul>
<li><strong>POSIX (1988)</strong>: Specified a ‚Äúlowest common
denominator‚Äù API</li>
<li><strong>Unix System V Release 4 (1989)</strong>: Attempted to merge
BSD and System V</li>
<li>Various vendor consortia fought for control</li>
</ul>
<h3 data-number="24.3.2" id="why-emacs-needed-cross-platform-support"><span class="header-section-number">24.3.2</span> Why Emacs Needed
Cross-Platform Support</h3>
<p>GNU Emacs began development in January 1984, right as the Unix wars
were heating up. Richard Stallman resigned from MIT to work on the GNU
Project, which aimed to create a complete free Unix-like operating
system.</p>
<p><strong>Strategic Portability Decisions:</strong></p>
<ol type="1">
<li><strong>Pure C Implementation</strong>: Unlike many Unix tools tied
to specific variants</li>
<li><strong>Autoconf Configuration</strong>: Systematic adaptation to
different Unix systems</li>
<li><strong>Minimal System Dependencies</strong>: Core functionality
worked everywhere</li>
<li><strong>Abstraction Layers</strong>: Platform differences isolated
in specific modules</li>
</ol>
<div class="sourceCode" id="cb1010"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb1010-1"><a aria-hidden="true" href="#cb1010-1" tabindex="-1"></a><span class="co">// Emacs used preprocessor conditionals extensively for portability</span></span>
<span id="cb1010-2"><a aria-hidden="true" href="#cb1010-2" tabindex="-1"></a><span class="pp">#ifdef BSD_SYSTEM</span></span>
<span id="cb1010-3"><a aria-hidden="true" href="#cb1010-3" tabindex="-1"></a>  <span class="co">// BSD-specific code</span></span>
<span id="cb1010-4"><a aria-hidden="true" href="#cb1010-4" tabindex="-1"></a><span class="pp">#endif</span></span>
<span id="cb1010-5"><a aria-hidden="true" href="#cb1010-5" tabindex="-1"></a><span class="pp">#ifdef USG</span></span>
<span id="cb1010-6"><a aria-hidden="true" href="#cb1010-6" tabindex="-1"></a>  <span class="co">// System V code</span></span>
<span id="cb1010-7"><a aria-hidden="true" href="#cb1010-7" tabindex="-1"></a><span class="pp">#endif</span></span></code></pre></div>
<p><strong>The Cross-Platform Architecture:</strong></p>
<p>Emacs addressed Unix fragmentation through: - Terminal independence
via termcap/terminfo - Display abstraction (TTY vs.¬†GUI) - File system
operation wrappers - Process handling abstractions</p>
<p>This wasn‚Äôt just Unix portability‚ÄîEmacs also ran on: - VMS (1980s) -
MS-DOS (late 1980s) - Windows (1990s) - macOS (2000s) - Android
(2020s)</p>
<h3 data-number="24.3.3" id="gnu-project-context-and-free-software-philosophy"><span class="header-section-number">24.3.3</span> GNU Project Context and Free
Software Philosophy</h3>
<p><strong>GNU Emacs Release History:</strong> - Development began:
January 5, 1984 - First release (13.0): March 20, 1985 - First widely
distributed version: 15.34, 1985 - Free Software Foundation founded:
October 1985</p>
<p>The GNU Project context was crucial to Emacs‚Äôs portability strategy.
Unlike commercial Unix vendors fighting for market share, the GNU
Project aimed to provide freedom through standardization on free
software.</p>
<p><strong>The GPL‚Äôs Role:</strong></p>
<p>The GNU Emacs License (1985) ensured: - Modifications must be shared
- Improvements benefit everyone - No vendor could fork and lock down -
Portability improvements stayed in the main codebase</p>
<p>This created a virtuous cycle: contributors from different Unix
vendors improved portability because they couldn‚Äôt lock down their
changes.</p>
<h3 data-number="24.3.4" id="competition-with-vivim"><span class="header-section-number">24.3.4</span> Competition with vi/vim</h3>
<p>The vi/Emacs rivalry reflected different responses to Unix
fragmentation:</p>
<p><strong>vi‚Äôs Approach:</strong> - Minimal, standardized (POSIX
specified ex/vi) - Present on every Unix system - Small, fast,
terminal-only - Part of Unix cultural identity</p>
<p><strong>Emacs‚Äôs Approach:</strong> - Maximal, extensible - Portable
but not always pre-installed - Large, powerful, supports GUI - Part of
Lisp/AI Lab culture</p>
<p><strong>Why Both Survived:</strong></p>
<p>They served different needs: - <strong>vi</strong>: System
administration, quick edits, guaranteed availability -
<strong>Emacs</strong>: Software development, customization, programming
environment</p>
<p>The competition drove quality improvements in both. Vim (1991) added
scripting and extensibility in response to Emacs. Emacs improved
performance and reduced memory usage in response to vi/vim‚Äôs
efficiency.</p>
<h3 data-number="24.3.5" id="x-window-system-adoption"><span class="header-section-number">24.3.5</span> X Window System
Adoption</h3>
<p>The X Window System (developed at MIT, first release 1984) became the
Unix GUI standard, but adoption was gradual and contentious.</p>
<p><strong>Emacs X Support Evolution:</strong></p>
<ul>
<li><strong>GNU Emacs 18</strong> (1987): Terminal-only, text-based</li>
<li><strong>GNU Emacs 19</strong> (1993): Full X Window System support
<ul>
<li>Multiple frames (X-level windows)</li>
<li>Mouse support</li>
<li>Multiple fonts</li>
<li>Colors and graphics</li>
</ul></li>
</ul>
<pre class="elisp"><code>;; From lisp/window.el - X integration required sophisticated abstractions
(defun window-system ()
  "The name of the window system through which the selected frame is displayed.")</code></pre>
<p><strong>The Delayed Adoption:</strong></p>
<p>Why did GUI support take so long (1984 ‚Üí 1993)?</p>
<ol type="1">
<li><strong>X11 Standardization</strong>: X11R1 (1987), stability came
with X11R4 (1989)</li>
<li><strong>Terminal Dominance</strong>: Most Unix users still used
terminals through early 1990s</li>
<li><strong>Toolkit Wars</strong>: Athena widgets vs.¬†Motif vs.¬†Open
Look</li>
<li><strong>Resource Constraints</strong>: X required significant
memory/CPU</li>
</ol>
<p><strong>Emacs‚Äôs GUI Strategy:</strong></p>
<p>Rather than commit to one toolkit, Emacs supported multiple: - Athena
widgets (free, basic) - Motif (commercial, sophisticated) - LessTif
(free Motif clone) - GTK+ (modern, cross-platform)</p>
<p>This flexibility proved prescient‚Äîtoolkit wars didn‚Äôt matter because
Emacs supported them all.</p>
<hr/>
<h2 data-number="24.4" id="the-rise-of-ides-1990s-2000s"><span class="header-section-number">24.4</span> The Rise of IDEs
(1990s-2000s)</h2>
<h3 data-number="24.4.1" id="industry-context-2"><span class="header-section-number">24.4.1</span> Industry Context</h3>
<p>The 1990s saw integrated development environments transform from
niche tools to dominant platforms, driven by object-oriented
programming, visual design, and corporate software development.</p>
<p><strong>Timeline of Major IDEs:</strong></p>
<ul>
<li><strong>Microsoft Visual Studio</strong> (late 1990s): Comprehensive
Windows development suite
<ul>
<li>By early 2000s: nearly 50% market share</li>
<li>Integrated debugger, visual designer, IntelliSense</li>
<li>Tight OS integration</li>
</ul></li>
<li><strong>Eclipse</strong> (2001): IBM‚Äôs Java IDE, open-sourced with
royalty-free license
<ul>
<li>Became most popular Java IDE until 2016</li>
<li>Plugin architecture</li>
<li>Workspace-centric model</li>
</ul></li>
<li><strong>IntelliJ IDEA</strong> (January 2001): JetBrains‚Äô
intelligent code analysis
<ul>
<li>Surpassed Eclipse in 2016</li>
<li>Deep language understanding</li>
<li>Powerful refactoring</li>
</ul></li>
</ul>
<p><strong>What IDEs Offered:</strong></p>
<ol type="1">
<li><strong>Integrated Debugging</strong>: Step through code, inspect
variables, set breakpoints</li>
<li><strong>Visual Design</strong>: GUI builders, drag-and-drop
components</li>
<li><strong>Code Intelligence</strong>: Auto-completion, syntax
checking, refactoring</li>
<li><strong>Project Management</strong>: Build systems, dependency
management</li>
<li><strong>Team Integration</strong>: Version control, code review,
issue tracking</li>
</ol>
<h3 data-number="24.4.2" id="why-emacs-added-ide-like-features-cedet"><span class="header-section-number">24.4.2</span> Why Emacs Added IDE-like
Features (CEDET)</h3>
<p>Emacs users faced a stark choice in the late 1990s: use Emacs with
basic text editing or switch to IDEs for serious development. CEDET
(Collection of Emacs Development Tools) aimed to bridge this gap.</p>
<p><strong>CEDET Integration (Emacs 23, 2009):</strong></p>
<pre class="elisp"><code>;; From lisp/cedet/semantic.el
;;; Commentary:
;;
;; API for providing the semantic content of a buffer.
;;
;; The Semantic API provides an interface to a series of different parser
;; implementations.  Each parser outputs a parse tree in a similar format
;; designed to handle typical functional and object oriented languages.

(defvar-local semantic--parse-table nil
  "Variable that defines how to parse top level items in a buffer.
This variable is for internal use only, and its content depends on the
external parser used.")</code></pre>
<p><strong>CEDET Components:</strong></p>
<ol type="1">
<li><strong>Semantic</strong>: Language parser producing abstract syntax
trees</li>
<li><strong>EDE</strong>: Project management (Emacs Development
Environment)</li>
<li><strong>SRecode</strong>: Template-based code generation</li>
<li><strong>EIEIO</strong>: CLOS-like object system for Elisp</li>
</ol>
<p><strong>The Architecture:</strong></p>
<p>CEDET implemented language-specific parsers using: -
<strong>Bovine</strong>: LL parser generator - <strong>Wisent</strong>:
LR parser generator - Hand-written parsers for complex languages</p>
<h3 data-number="24.4.3" id="the-tags-vs-semantic-parsing-debate"><span class="header-section-number">24.4.3</span> The Tags vs Semantic Parsing
Debate</h3>
<p>This debate represented fundamental architectural tradeoffs that
persisted for two decades.</p>
<p><strong>Tags (ctags/etags) Approach:</strong></p>
<div class="sourceCode" id="cb1013"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb1013-1"><a aria-hidden="true" href="#cb1013-1" tabindex="-1"></a><span class="co"># Simple, fast, universal</span></span>
<span id="cb1013-2"><a aria-hidden="true" href="#cb1013-2" tabindex="-1"></a><span class="ex">$</span> etags <span class="pp">*</span>.c <span class="pp">*</span>.h</span>
<span id="cb1013-3"><a aria-hidden="true" href="#cb1013-3" tabindex="-1"></a><span class="co"># Generated index file for quick lookup</span></span></code></pre></div>
<p><strong>Advantages:</strong> - Blazingly fast (regex-based) - Works
for any language - Minimal resource usage - Simple to understand and
debug - No language-specific code needed</p>
<p><strong>Disadvantages:</strong> - No context awareness (can‚Äôt
distinguish function call from definition) - No type information -
Breaks on macro-heavy code - Can‚Äôt support refactoring</p>
<p><strong>Semantic Parsing Approach:</strong></p>
<pre class="elisp"><code>;; Build full syntax tree
(semantic-fetch-tags)
;; Query with context
(semantic-find-tags-by-name "foo" (current-buffer))</code></pre>
<p><strong>Advantages:</strong> - Understands code structure - Supports
refactoring - Context-aware completion - Accurate cross-references -
Enables advanced features</p>
<p><strong>Disadvantages:</strong> - Resource intensive (memory + CPU) -
Language-specific parsers required - Complex implementation - Slower on
large codebases - Parser bugs affect functionality</p>
<p><strong>Why the Debate Persisted:</strong></p>
<ol type="1">
<li><strong>Performance Gap</strong>: Tags were 100-1000x faster on
large codebases</li>
<li><strong>Maintenance Burden</strong>: Each language needed a custom
parser</li>
<li><strong>Parser Accuracy</strong>: Keeping parsers current with
language evolution was hard</li>
<li><strong>User Experience</strong>: Semantic was noticeably slower in
practice</li>
<li><strong>Diminishing Returns</strong>: Most benefits came from simple
tags</li>
</ol>
<p><strong>The Industry Shift:</strong></p>
<p>By 2010s, hardware improved and expectations changed: - Modern IDEs
all used full parsing - Users expected accurate refactoring - Multi-core
CPUs made background parsing feasible - Language complexity (C++, Java
generics) defeated regex approaches</p>
<p>But Emacs faced a critical problem: maintaining parsers for dozens of
languages in Elisp was unsustainable.</p>
<h3 data-number="24.4.4" id="integration-vs-extensibility-tradeoffs"><span class="header-section-number">24.4.4</span> Integration vs Extensibility
Tradeoffs</h3>
<p>CEDET embodied Emacs‚Äôs fundamental tension: IDE integration vs.¬†text
editor extensibility.</p>
<p><strong>Integration Challenges:</strong></p>
<pre class="elisp"><code>;; CEDET needed to integrate with:
;; - Font-lock (syntax highlighting)
;; - Completion (completion-at-point)
;; - Imenu (buffer navigation)
;; - Which-function-mode (mode line display)
;; - Eldoc (inline documentation)</code></pre>
<p>Each integration point required careful design to: - Not break
existing workflows - Allow user customization - Support multiple
languages - Maintain performance</p>
<p><strong>The Extensibility Tax:</strong></p>
<p>Emacs‚Äôs strength (everything is customizable) became a weakness: -
Can‚Äôt assume standard keybindings - Can‚Äôt require specific packages -
Must support both GUI and terminal - Must handle user modifications
gracefully</p>
<p>Compare to Visual Studio or IntelliJ: - Controlled environment -
Standard UI/UX - Required components - Managed plugin API</p>
<p><strong>CEDET‚Äôs Mixed Success:</strong></p>
<p><strong>What Worked:</strong> - Demonstrated IDE features were
possible in Emacs - Infrastructure (parsing, tagging) became foundation
for later tools - Project management (EDE) provided useful
abstractions</p>
<p><strong>What Struggled:</strong> - Performance couldn‚Äôt match
native-code IDEs - Parser maintenance was overwhelming - Integration
complexity deterred users - Feature parity with commercial IDEs was
impossible</p>
<p><strong>The Deeper Issue:</strong></p>
<p>CEDET tried to compete with IDEs by replicating them, but Emacs‚Äôs
strength was never integration‚Äîit was customization and scriptability.
This realization led to different architectural choices later (LSP
integration via Eglot).</p>
<hr/>
<h2 data-number="24.5" id="the-web-era-2000s-2010s"><span class="header-section-number">24.5</span> The Web Era (2000s-2010s)</h2>
<h3 data-number="24.5.1" id="industry-context-3"><span class="header-section-number">24.5.1</span> Industry Context</h3>
<p>The web‚Äôs transformation from documents to applications changed how
developers worked. JavaScript evolved from toy scripting language to
enterprise platform. Cloud services made network integration
essential.</p>
<p><strong>Key Trends:</strong> - <strong>Rich Web Applications</strong>
(2004+): Gmail, Google Maps showed web‚Äôs potential - <strong>JavaScript
Renaissance</strong> (2006+): jQuery, Node.js made JS respectable -
<strong>Cloud APIs</strong> (2006+): AWS, web services became
infrastructure - <strong>Mobile Web</strong> (2007+): iPhone, responsive
design - <strong>Real-Time Web</strong> (2010+): WebSockets, streaming
data</p>
<h3 data-number="24.5.2" id="why-emacs-needed-web-browsing-eww"><span class="header-section-number">24.5.2</span> Why Emacs Needed Web
Browsing (eww)</h3>
<p>The traditional separation of ‚Äúeditor‚Äù and ‚Äúbrowser‚Äù broke down when:
- Documentation moved from man pages to websites - APIs required web
authentication - Code examples lived in online docs - GitHub, Stack
Overflow became essential - Package registries were web-based</p>
<p><strong>EWW Development (2013):</strong></p>
<pre class="elisp"><code>;; From lisp/net/eww.el
;;; eww.el --- Emacs Web Wowser  -*- lexical-binding:t -*-
;;
;; Copyright (C) 2013-2025 Free Software Foundation, Inc.
;;
;; Author: Lars Magne Ingebrigtsen &lt;larsi@gnus.org&gt;

(defgroup eww nil
  "Emacs Web Wowser."
  :version "25.1"
  :link '(custom-manual "(eww) Top")
  :group 'web
  :prefix "eww-")</code></pre>
<p><strong>Lars Ingebrigtsen‚Äôs Motivation:</strong></p>
<p>Lars (known for Gnus email/news reader) started writing shr.el
(Simple HTML Renderer) to read blogs in Gnus. He added: - Web browser
front-end - HTML form support - Basic navigation</p>
<p>Result: EWW (announced June 16, 2013, included in Emacs 24.4, October
2014)</p>
<p><strong>Design Philosophy:</strong></p>
<p>EWW explicitly did NOT try to compete with Firefox or Chrome: - No
JavaScript execution - Basic CSS support - Text-focused rendering -
Fast, lightweight</p>
<p><strong>Use Cases:</strong></p>
<ol type="1">
<li><strong>In-Editor Documentation</strong>: Browse docs without
leaving Emacs</li>
<li><strong>Quick References</strong>: Stack Overflow, man pages,
READMEs</li>
<li><strong>Package Info</strong>: MELPA, GitHub project pages</li>
<li><strong>Email HTML</strong>: Rendering HTML emails in Gnus</li>
<li><strong>Distraction-Free</strong>: No ads, popups, tracking</li>
</ol>
<p><strong>The Tradeoff:</strong></p>
<p>Accepting that EWW wasn‚Äôt a ‚Äúreal browser‚Äù freed it to be excellent
at what mattered: getting text content into Emacs where it could be
manipulated with Emacs tools.</p>
<h3 data-number="24.5.3" id="javascript-and-web-development-modes"><span class="header-section-number">24.5.3</span> JavaScript and Web
Development Modes</h3>
<p>JavaScript‚Äôs evolution from scorned to essential required Emacs to
take it seriously.</p>
<p><strong>The JavaScript Journey:</strong></p>
<ul>
<li><strong>js-mode</strong> (basic support): Simple syntax
highlighting</li>
<li><strong>js2-mode</strong> (community): Full parser, AST-based
features</li>
<li><strong>js-mode</strong> improvements: Merged community
innovations</li>
<li><strong>js-ts-mode</strong> (Emacs 29): Tree-sitter based,
modern</li>
</ul>
<p><strong>Web Stack Complexity:</strong></p>
<p>Modern web development required juggling: - HTML templates (various
syntaxes) - CSS preprocessors (SASS, LESS) - JavaScript frameworks
(React, Vue, Angular) - Build tools (Webpack, Babel) - TypeScript,
CoffeeScript, other JS variants</p>
<p><strong>Emacs‚Äôs Response:</strong></p>
<pre class="elisp"><code>;; Multi-mode support became essential
;; web-mode: Handle HTML/CSS/JS in one file
;; mmm-mode: Multiple major modes
;; polymode: Nested mode support</code></pre>
<p><strong>The Architecture Challenge:</strong></p>
<p>Emacs‚Äôs one-major-mode-per-buffer model struggled with: - JSX
(JavaScript + XML) - Vue single-file components - Template languages
embedding JS - CSS-in-JS</p>
<p>Tree-sitter (added Emacs 29, 2022) finally provided proper
multi-language parsing.</p>
<h3 data-number="24.5.4" id="cloud-synchronization-gnus-cloud"><span class="header-section-number">24.5.4</span> Cloud Synchronization (Gnus
Cloud)</h3>
<p><strong>The Cloud Synchronization Problem:</strong></p>
<p>Users worked on multiple machines: - Desktop at work - Laptop at home
- Remote servers - Mobile devices</p>
<p>Configuration, history, and state needed to sync.</p>
<p><strong>Gnus Cloud Approach:</strong></p>
<pre class="elisp"><code>;; Sync mail/news state across machines
;; Uses IMAP or file backend
;; Selective sync (not everything)</code></pre>
<p><strong>Broader Solutions:</strong></p>
<ul>
<li><strong>Dropbox/Git for configs</strong>: Manual sync of
~/.emacs.d</li>
<li><strong>TRAMP</strong>: Edit remote files transparently</li>
<li><strong>Server/Client</strong>: emacsclient connects to running
daemon</li>
<li><strong>Custom sync</strong>: Org-mode sync, bookmark sync</li>
</ul>
<p><strong>Why Full Cloud Sync Was Hard:</strong></p>
<ol type="1">
<li><strong>Buffer State</strong>: Can‚Äôt serialize everything</li>
<li><strong>Process State</strong>: Running processes don‚Äôt
transfer</li>
<li><strong>Platform Differences</strong>: File paths, available
programs differ</li>
<li><strong>Security</strong>: Sensitive data in buffers, histories</li>
<li><strong>Complexity</strong>: Emacs state is vast and varied</li>
</ol>
<p><strong>The Industry Standard:</strong></p>
<p>VS Code solved this with: - Settings Sync (built-in) - Remote
Development (SSH/containers) - Cloud workspaces (GitHub Codespaces)</p>
<p>Emacs‚Äôs decentralized approach meant community solutions rather than
one official method.</p>
<h3 data-number="24.5.5" id="network-protocols-and-apis"><span class="header-section-number">24.5.5</span> Network Protocols and
APIs</h3>
<p><strong>Network Support Evolution:</strong></p>
<p>Emacs needed to speak modern protocols:</p>
<pre class="elisp"><code>;; From package.el - HTTPS package archives
(require 'url)  ; HTTP/HTTPS client
(require 'tls)  ; TLS/SSL support

;; From eglot.el - JSON-RPC for LSP
(require 'jsonrpc)

;; From gnus - NNTP, IMAP, SMTP</code></pre>
<p><strong>Key Protocol Additions:</strong></p>
<ol type="1">
<li><strong>HTTPS (late 1990s)</strong>: Secure package downloads</li>
<li><strong>JSON/REST APIs (2000s)</strong>: Web service
integration</li>
<li><strong>WebSockets (2010s)</strong>: Real-time communication</li>
<li><strong>OAuth (2010s)</strong>: Authentication for cloud
services</li>
<li><strong>JSON-RPC (2018)</strong>: Language Server Protocol</li>
</ol>
<p><strong>The URL Library Evolution:</strong></p>
<p>Emacs‚Äôs url.el became surprisingly capable: - HTTP/HTTPS GET/POST -
Cookie handling - Authentication - Redirects - Caching</p>
<p>This enabled: - Package archives (ELPA, MELPA) - Weather reports,
stock quotes - API clients - GitHub integration</p>
<p><strong>Security Challenges:</strong></p>
<p>Network code brought new concerns: - Certificate validation - Secure
credential storage - XSS in HTML rendering - Arbitrary code from network
(packages)</p>
<p>The auth-source library unified credential management, but security
remained challenging in a system where everything is programmable.</p>
<hr/>
<h2 data-number="24.6" id="the-language-server-protocol-revolution-2016-present"><span class="header-section-number">24.6</span> The Language Server Protocol
Revolution (2016-present)</h2>
<h3 data-number="24.6.1" id="industry-context-microsofts-lsp-and-why-it-matters"><span class="header-section-number">24.6.1</span> Industry Context:
Microsoft‚Äôs LSP and Why It Matters</h3>
<p>On June 27, 2016, Microsoft announced the Language Server Protocol in
collaboration with Red Hat and Codenvy, fundamentally changing how
editors and IDEs provide language intelligence.</p>
<p><strong>The M√óN Problem:</strong></p>
<p>Before LSP: - M editors √ó N languages = M√óN implementations - Each
editor needed custom support for each language - Language features
(completion, go-to-definition) implemented differently everywhere -
Informix in the 1980s had 1,000+ SKUs; modern editors had similar
complexity</p>
<p><strong>The LSP Solution:</strong></p>
<p>With LSP: - M editors + N language servers = M+N implementations -
One language server supports all editors - Standardized JSON-RPC
protocol - Editors delegate language intelligence to servers</p>
<p><strong>Technical Foundation:</strong></p>
<div class="sourceCode" id="cb1020"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb1020-1"><a aria-hidden="true" href="#cb1020-1" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb1020-2"><a aria-hidden="true" href="#cb1020-2" tabindex="-1"></a>  <span class="dt">"jsonrpc"</span><span class="fu">:</span> <span class="st">"2.0"</span><span class="fu">,</span></span>
<span id="cb1020-3"><a aria-hidden="true" href="#cb1020-3" tabindex="-1"></a>  <span class="dt">"id"</span><span class="fu">:</span> <span class="dv">1</span><span class="fu">,</span></span>
<span id="cb1020-4"><a aria-hidden="true" href="#cb1020-4" tabindex="-1"></a>  <span class="dt">"method"</span><span class="fu">:</span> <span class="st">"textDocument/completion"</span><span class="fu">,</span></span>
<span id="cb1020-5"><a aria-hidden="true" href="#cb1020-5" tabindex="-1"></a>  <span class="dt">"params"</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb1020-6"><a aria-hidden="true" href="#cb1020-6" tabindex="-1"></a>    <span class="dt">"textDocument"</span><span class="fu">:</span> <span class="fu">{</span><span class="dt">"uri"</span><span class="fu">:</span> <span class="st">"file:///path/to/file.py"</span><span class="fu">},</span></span>
<span id="cb1020-7"><a aria-hidden="true" href="#cb1020-7" tabindex="-1"></a>    <span class="dt">"position"</span><span class="fu">:</span> <span class="fu">{</span><span class="dt">"line"</span><span class="fu">:</span> <span class="dv">10</span><span class="fu">,</span> <span class="dt">"character"</span><span class="fu">:</span> <span class="dv">5</span><span class="fu">}</span></span>
<span id="cb1020-8"><a aria-hidden="true" href="#cb1020-8" tabindex="-1"></a>  <span class="fu">}</span></span>
<span id="cb1020-9"><a aria-hidden="true" href="#cb1020-9" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<p><strong>Features Standardized:</strong></p>
<ul>
<li>Code completion</li>
<li>Go-to-definition/references</li>
<li>Hover documentation</li>
<li>Diagnostics (errors/warnings)</li>
<li>Refactoring</li>
<li>Code actions</li>
<li>Semantic highlighting</li>
</ul>
<p><strong>Why LSP Succeeded:</strong></p>
<ol type="1">
<li><strong>Microsoft‚Äôs Credibility</strong>: VS Code‚Äôs success
validated the protocol</li>
<li><strong>Industry Support</strong>: Google, Red Hat, Eclipse
Foundation joined</li>
<li><strong>Real Implementation</strong>: Not just a spec‚Äîworking
servers existed</li>
<li><strong>Pragmatic Design</strong>: JSON-RPC was simple,
language-agnostic</li>
<li><strong>Economic Incentive</strong>: Language vendors could support
all editors at once</li>
</ol>
<h3 data-number="24.6.2" id="eglot-vs-cedet-architectural-shift"><span class="header-section-number">24.6.2</span> Eglot vs CEDET:
Architectural Shift</h3>
<p>The adoption of LSP in Emacs represented a fundamental architectural
shift from CEDET‚Äôs approach.</p>
<p><strong>CEDET Architecture (2009-2016):</strong></p>
<pre class="elisp"><code>;; From lisp/cedet/semantic.el
;; Emacs maintains parsers for each language
(defvar-local semantic--parse-table nil
  "Variable that defines how to parse top level items in a buffer.")

;; Elisp-based parsers:
;; - semantic/bovine/c.el - C parser
;; - semantic/wisent/python.el - Python parser
;; - Hand-written parsers for complex languages</code></pre>
<p><strong>Eglot Architecture (2018+):</strong></p>
<pre class="elisp"><code>;; From lisp/progmodes/eglot.el
;;; Commentary:
;;
;; Eglot ("Emacs Polyglot") is an Emacs LSP client that stays out of
;; your way.

;; Eglot's main job is to hook up the information that language
;; servers offer via LSP to Emacs's UI facilities: Xref for
;; definition-chasing, Flymake for diagnostics, Eldoc for at-point
;; documentation, etc.</code></pre>
<p><strong>The Fundamental Difference:</strong></p>
<table>
<colgroup>
<col style="width: 36%"/>
<col style="width: 31%"/>
<col style="width: 31%"/>
</colgroup>
<thead>
<tr>
<th>Aspect</th>
<th>CEDET</th>
<th>Eglot</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Parser Location</strong></td>
<td>In Emacs (Elisp)</td>
<td>External process</td>
</tr>
<tr>
<td><strong>Language Support</strong></td>
<td>Emacs maintains</td>
<td>Language vendors maintain</td>
</tr>
<tr>
<td><strong>Performance</strong></td>
<td>Elisp speed limits</td>
<td>Native code servers</td>
</tr>
<tr>
<td><strong>Accuracy</strong></td>
<td>Elisp parser complexity limits</td>
<td>Full compiler integration</td>
</tr>
<tr>
<td><strong>Maintenance</strong></td>
<td>Emacs developers</td>
<td>Language communities</td>
</tr>
<tr>
<td><strong>Resource Usage</strong></td>
<td>In Emacs process</td>
<td>Separate process</td>
</tr>
</tbody>
</table>
<p><strong>Why This Mattered:</strong></p>
<ol type="1">
<li><strong>Accuracy</strong>: LSP servers often use actual compilers
(rust-analyzer, TypeScript server)</li>
<li><strong>Currency</strong>: Language vendors update servers with
language changes</li>
<li><strong>Performance</strong>: Native code servers outperform Elisp
parsers</li>
<li><strong>Coverage</strong>: Instant support for new languages (if
server exists)</li>
<li><strong>Maintenance</strong>: Emacs doesn‚Äôt maintain language
parsers</li>
</ol>
<p><strong>Eglot‚Äôs Design Philosophy:</strong></p>
<p>Created by Jo√£o T√°vora (first released 2018, announced on emacs-devel
May 2018):</p>
<pre class="elisp"><code>;; Eglot was designed to function with just the UI facilities found
;; in the latest Emacs core, as long as those facilities are also
;; available as GNU ELPA :core packages.</code></pre>
<p>Key principles: - <strong>Minimal Configuration</strong>: Work
out-of-the-box - <strong>Leverage Core</strong>: Use Xref, Flymake,
Eldoc, Company - <strong>Stay Out of the Way</strong>: Don‚Äôt impose UI
choices - <strong>Few Variables</strong>: Avoid configuration bloat</p>
<p><strong>Integration with Emacs (2023):</strong></p>
<p>Eglot was integrated into Emacs 29.1 (July 2023), becoming the
official LSP client. This marked Emacs‚Äôs definitive embrace of the
industry-standard approach.</p>
<h3 data-number="24.6.3" id="industry-standardization-benefits"><span class="header-section-number">24.6.3</span> Industry Standardization
Benefits</h3>
<p>LSP‚Äôs standardization brought benefits beyond just technical
implementation.</p>
<p><strong>Community Effects:</strong></p>
<ol type="1">
<li><strong>Language Vendor Investment</strong>: Microsoft, Google,
JetBrains, etc. fund server development</li>
<li><strong>Shared Infrastructure</strong>: One server serves Emacs, VS
Code, Vim, Sublime, etc.</li>
<li><strong>Better Testing</strong>: More users mean more bug
reports</li>
<li><strong>Feature Parity</strong>: All editors get same
capabilities</li>
<li><strong>Documentation</strong>: Standardized protocol means
transferable knowledge</li>
</ol>
<p><strong>Economic Impact:</strong></p>
<p>Before LSP, language tool developers faced: - High cost to support
multiple editors - Fragmented user bases - Duplication of effort -
Inconsistent features</p>
<p>After LSP: - One implementation serves everyone - Larger potential
user base justifies investment - Focus on quality, not breadth -
Innovation in server architecture</p>
<p><strong>Emacs-Specific Benefits:</strong></p>
<ol type="1">
<li><strong>Competitive Parity</strong>: Emacs gets same features as VS
Code</li>
<li><strong>Reduced Maintenance</strong>: No more language-specific
parser maintenance</li>
<li><strong>Faster Adoption</strong>: New languages instantly
supported</li>
<li><strong>Better Quality</strong>: Professional teams maintain
servers</li>
<li><strong>Resource Efficiency</strong>: Servers optimized in native
code</li>
</ol>
<p><strong>Tradeoffs:</strong></p>
<p>Not everything was better: - <strong>External Dependency</strong>:
Must install language servers - <strong>Process Overhead</strong>: IPC
costs, separate process management - <strong>Configuration
Complexity</strong>: Server-specific settings - <strong>Debugging
Opacity</strong>: Problems in external process harder to debug -
<strong>Network Latency</strong>: Remote servers slower</p>
<p>But the industry consensus was clear: benefits outweighed costs.</p>
<h3 data-number="24.6.4" id="tree-sitter-and-modern-parsing"><span class="header-section-number">24.6.4</span> Tree-sitter and Modern
Parsing</h3>
<p>While LSP solved language intelligence, Tree-sitter (2018, by Max
Brunsfeld) solved syntax highlighting and structural navigation.</p>
<p><strong>Tree-sitter Integration (Emacs 29, merged November 23,
2022):</strong></p>
<pre class="elisp"><code>;; From lisp/treesit.el
;; Maintainer: ‰ªòÁ¶πÂÆâ (Yuan Fu) &lt;casouri@gmail.com&gt;

;; This file is the Lisp counterpart of treesit.c.  Together they
;; provide tree-sitter integration for Emacs.  This file contains
;; convenient functions that are more idiomatic and flexible than the
;; exposed C API of tree-sitter.</code></pre>
<p><strong>What Tree-sitter Provides:</strong></p>
<ol type="1">
<li><strong>Incremental Parsing</strong>: Only reparse changed
regions</li>
<li><strong>Error Recovery</strong>: Produces tree even with syntax
errors</li>
<li><strong>Language Composition</strong>: Multiple languages in one
buffer (JSX, Vue)</li>
<li><strong>Structural Navigation</strong>: Navigate by syntax nodes,
not text</li>
<li><strong>Precise Highlighting</strong>: Context-aware, semantic
colors</li>
</ol>
<p><strong>Architecture:</strong></p>
<pre><code>‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Emacs Buffer                       ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ Tree-sitter Parser (C lib)    ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  ‚ñº                            ‚îÇ ‚îÇ
‚îÇ  ‚îÇ Concrete Syntax Tree          ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ            ‚ñº                        ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ treesit.el (Elisp queries)    ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  - Font-lock                  ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  - Indentation                ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  - Navigation                 ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò</code></pre>
<p><strong>Why Tree-sitter Complemented LSP:</strong></p>
<table>
<thead>
<tr>
<th>Feature</th>
<th>LSP</th>
<th>Tree-sitter</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Purpose</strong></td>
<td>Semantic intelligence</td>
<td>Syntax understanding</td>
</tr>
<tr>
<td><strong>Speed</strong></td>
<td>Async, server latency</td>
<td>Synchronous, instant</td>
</tr>
<tr>
<td><strong>Scope</strong></td>
<td>Project-wide</td>
<td>Single file</td>
</tr>
<tr>
<td><strong>Accuracy</strong></td>
<td>Compiler-grade</td>
<td>Syntax-only</td>
</tr>
<tr>
<td><strong>Use Cases</strong></td>
<td>Completion, refactoring</td>
<td>Highlighting, navigation</td>
</tr>
</tbody>
</table>
<p><strong>The Combined Architecture (Modern Emacs):</strong></p>
<pre class="elisp"><code>;; Tree-sitter for local, syntactic features:
(use-package python-ts-mode  ; Tree-sitter based
  :mode "\\.py\\'")

;; LSP for semantic, project-wide features:
(use-package eglot
  :hook (python-ts-mode . eglot-ensure))</code></pre>
<p><strong>Benefits of Separation:</strong></p>
<ol type="1">
<li><strong>Syntax works offline</strong>: No server needed for
highlighting</li>
<li><strong>Fast feedback</strong>: Tree-sitter is instant</li>
<li><strong>Complementary</strong>: Syntax + semantics = complete</li>
<li><strong>Fallback</strong>: Syntax works when server is broken</li>
<li><strong>Performance</strong>: Right tool for each job</li>
</ol>
<p><strong>Industry Convergence:</strong></p>
<p>By 2022, the industry had converged on: - Tree-sitter for syntax -
LSP for semantics - Native code for performance</p>
<p>Emacs joined this consensus, abandoning the ‚ÄúElisp parser‚Äù approach
after 13 years (CEDET 2009 ‚Üí Tree-sitter 2022).</p>
<hr/>
<h2 data-number="24.7" id="mobile-computing-2010s-2020s"><span class="header-section-number">24.7</span> Mobile Computing
(2010s-2020s)</h2>
<h3 data-number="24.7.1" id="industry-context-4"><span class="header-section-number">24.7.1</span> Industry Context</h3>
<p>The iPhone (2007) and Android (2008) transformed computing from
desktop-centric to mobile-first. By 2020s, mobile devices outnumbered
desktops globally.</p>
<p><strong>Developer Tools on Mobile:</strong></p>
<ul>
<li><strong>Tablets</strong>: iPad became coding platform (Swift
Playgrounds, Pythonista, Working Copy)</li>
<li><strong>Phones</strong>: Termux, Dcoder, other terminal/IDE
apps</li>
<li><strong>Remote Development</strong>: SSH clients, VNC, cloud
IDEs</li>
<li><strong>Native IDEs</strong>: Microsoft‚Äôs Visual Studio Code mobile
experiments</li>
</ul>
<p><strong>The Challenge:</strong></p>
<p>Traditional desktop IDEs (Visual Studio, IntelliJ, Eclipse) never
successfully moved to mobile: - UI paradigms don‚Äôt translate (menus,
keyboard shortcuts) - Screen size constraints - Touch interaction is
different - Resource limitations (memory, CPU, battery) - File system
access restrictions</p>
<h3 data-number="24.7.2" id="android-port-why-and-how"><span class="header-section-number">24.7.2</span> Android Port: Why and
How</h3>
<p><strong>Announcement and Development:</strong></p>
<ul>
<li>Announced: End of 2022</li>
<li>Declared ‚Äúfeature complete‚Äù: February 2023</li>
<li>Released: Emacs 30.1 (in development)</li>
<li>Developer: Po Lu and contributors</li>
</ul>
<p><strong>Why Port Emacs to Android:</strong></p>
<ol type="1">
<li><strong>Termux Integration</strong>: Existing Emacs-in-Termux users
wanted native app</li>
<li><strong>Org-Mode Users</strong>: Mobile org editing was highly
requested</li>
<li><strong>Note-Taking</strong>: Emacs as mobile writing
environment</li>
<li><strong>SSH Editing</strong>: Edit remote files on mobile</li>
<li><strong>Proving Ground</strong>: Could Emacs adapt to radically
different platform?</li>
</ol>
<p><strong>Technical Challenges:</strong></p>
<div class="sourceCode" id="cb1027"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb1027-1"><a aria-hidden="true" href="#cb1027-1" tabindex="-1"></a><span class="co">// From java/org/gnu/emacs/EmacsService.java</span></span>
<span id="cb1027-2"><a aria-hidden="true" href="#cb1027-2" tabindex="-1"></a><span class="co">// Android requires Java/Kotlin for system integration</span></span>
<span id="cb1027-3"><a aria-hidden="true" href="#cb1027-3" tabindex="-1"></a></span>
<span id="cb1027-4"><a aria-hidden="true" href="#cb1027-4" tabindex="-1"></a><span class="co">// Emacs needed to:</span></span>
<span id="cb1027-5"><a aria-hidden="true" href="#cb1027-5" tabindex="-1"></a><span class="co">// - Bridge C code to Java Android APIs</span></span>
<span id="cb1027-6"><a aria-hidden="true" href="#cb1027-6" tabindex="-1"></a><span class="co">// - Handle Android lifecycle (pause/resume)</span></span>
<span id="cb1027-7"><a aria-hidden="true" href="#cb1027-7" tabindex="-1"></a><span class="co">// - Integrate with Android permissions system</span></span>
<span id="cb1027-8"><a aria-hidden="true" href="#cb1027-8" tabindex="-1"></a><span class="co">// - Support Android storage (content providers)</span></span></code></pre></div>
<p><strong>Architecture:</strong></p>
<pre><code>‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Android System                      ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ Java Activity/Service         ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  (EmacsActivity.java)         ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ            ‚ñº JNI                    ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ Emacs C Core                  ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  (android.c bridge)           ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ            ‚ñº                        ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ Elisp Layer                   ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  (android-specific code)      ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò</code></pre>
<p><strong>Major Adaptations:</strong></p>
<ol type="1">
<li><strong>Storage Access Framework</strong>: Android‚Äôs restrictive
file access</li>
<li><strong>Content Providers</strong>: Accessing documents in cloud
storage</li>
<li><strong>Lifecycle Management</strong>: Apps pause/resume
frequently</li>
<li><strong>Permissions</strong>: Runtime permission requests</li>
<li><strong>Input Methods</strong>: On-screen keyboards, predictive
text</li>
</ol>
<h3 data-number="24.7.3" id="touch-screen-support"><span class="header-section-number">24.7.3</span> Touch Screen Support</h3>
<p>Touch interaction fundamentally differs from mouse/keyboard.</p>
<p><strong>Touch Gestures Implemented:</strong></p>
<pre class="elisp"><code>;; From etc/NEWS (Emacs 30):
;; "Extensive support for touch screen input and on-screen keyboards"

;; Gestures:
;; - Tap: Point and click
;; - Long-press: Context menu
;; - Drag: Scroll, select
;; - Pinch: Zoom (in supported modes)
;; - Two-finger: Scroll</code></pre>
<p><strong>UI Adaptations:</strong></p>
<ol type="1">
<li><strong>Larger Touch Targets</strong>: Buttons, links must be
finger-sized</li>
<li><strong>Gesture Navigation</strong>: Swipe-based commands</li>
<li><strong>Virtual Keyboard</strong>: Screen space when keyboard
appears</li>
<li><strong>Touch Selection</strong>: Different than mouse
selection</li>
<li><strong>Scrolling Physics</strong>: Momentum, bounce</li>
</ol>
<p><strong>Challenges Unique to Emacs:</strong></p>
<p>Most editors have UI elements (buttons, menus) suitable for touch.
Emacs is primarily keyboard-driven text:</p>
<ul>
<li><strong>Cursor Positioning</strong>: Finger is imprecise vs
mouse</li>
<li><strong>Selection</strong>: Drag-to-select on small text</li>
<li><strong>Commands</strong>: 1000+ commands, no keyboard shortcuts on
touch</li>
<li><strong>Discoverability</strong>: How do users find features?</li>
</ul>
<p><strong>Solutions:</strong></p>
<ul>
<li>Command palette (similar to M-x but touch-friendly)</li>
<li>Customizable touch gestures</li>
<li>Adapted mode-line (larger, touch targets)</li>
<li>On-screen key modifiers (Meta, Control)</li>
</ul>
<h3 data-number="24.7.4" id="challenges-of-mobile-emacs"><span class="header-section-number">24.7.4</span> Challenges of Mobile
Emacs</h3>
<p><strong>Platform Restrictions:</strong></p>
<ol type="1">
<li><strong>Background Processing</strong>: Android kills background
apps aggressively</li>
<li><strong>Process Spawning</strong>: Limited subprocess
capabilities</li>
<li><strong>File System</strong>: Sandboxed, restricted access</li>
<li><strong>Network</strong>: Mobile data considerations</li>
<li><strong>Battery</strong>: CPU-intensive operations drain
battery</li>
</ol>
<p><strong>UX Challenges:</strong></p>
<ol type="1">
<li><strong>Keyboard Dependency</strong>: Emacs assumes hardware
keyboard</li>
<li><strong>Screen Size</strong>: 6‚Äù phone vs 27‚Äù monitor</li>
<li><strong>Split Windows</strong>: Multi-window workflow
impractical</li>
<li><strong>Mouse Alternative</strong>: Touch isn‚Äôt mouse
equivalent</li>
<li><strong>Clipboard</strong>: Different clipboard model on mobile</li>
</ol>
<p><strong>Performance:</strong></p>
<pre class="elisp"><code>;; From etc/NEWS (Emacs 30):
;; "Process execution has been optimized on Android.
;; The run-time performance of subprocesses on recent Android releases..."

;; Even with optimization, mobile CPUs slower than desktop
;; Battery concerns limit sustained computation</code></pre>
<p><strong>Success Metrics:</strong></p>
<p>Despite challenges, Android Emacs succeeded for: -
<strong>Org-Mode</strong>: Capture, view, edit notes - <strong>Text
Editing</strong>: Basic editing, file viewing - <strong>Termux
Integration</strong>: Full development via Termux packages -
<strong>SSH/TRAMP</strong>: Edit remote files -
<strong>Reading</strong>: Documentation, logs, code review</p>
<p><strong>What Didn‚Äôt Work:</strong></p>
<ul>
<li>Heavy compilation (memory limits)</li>
<li>Large projects (slow on mobile CPUs)</li>
<li>Multi-window workflows (screen too small)</li>
<li>Casual users (too complex without keyboard)</li>
</ul>
<p><strong>Lessons Learned:</strong></p>
<ol type="1">
<li><strong>Core Portability</strong>: Emacs‚Äôs C core was adaptable</li>
<li><strong>Abstraction Layers</strong>: Display/system abstractions
enabled mobile</li>
<li><strong>Use Case Focus</strong>: Success required targeting specific
uses</li>
<li><strong>Community Driven</strong>: Android port was community
initiative</li>
<li><strong>Platform Integration</strong>: Success required embracing
platform (not fighting it)</li>
</ol>
<p><strong>Industry Comparison:</strong></p>
<p>Most ‚Äúeditors on mobile‚Äù are either: - Simple text editors (iA
Writer, Editorial) - Remote desktop to real IDE (Code Server, cloud
IDEs) - Limited IDE subsets (Swift Playgrounds)</p>
<p>Emacs‚Äôs Android port was unusual: full editor, locally running, on
mobile platform. This demonstrated Emacs‚Äôs architectural flexibility but
also highlighted fundamental desktop-mobile differences.</p>
<hr/>
<h2 data-number="24.8" id="performance-wars-2010s-2020s"><span class="header-section-number">24.8</span> Performance Wars
(2010s-2020s)</h2>
<h3 data-number="24.8.1" id="industry-context-jit-compilation-trends"><span class="header-section-number">24.8.1</span> Industry Context: JIT
Compilation Trends</h3>
<p>The 2010s saw dynamic languages embrace JIT (Just-In-Time)
compilation to achieve near-native performance.</p>
<p><strong>Timeline:</strong></p>
<ul>
<li><strong>V8 JavaScript Engine</strong> (2008): Chrome‚Äôs JIT made JS
fast</li>
<li><strong>PyPy</strong> (2007, mature ~2011): Python with JIT, 5-10x
speedup</li>
<li><strong>LuaJIT</strong> (2009): Lua JIT compiler</li>
<li><strong>Java HotSpot</strong>: Matured into production JIT</li>
<li><strong>Julia</strong> (2012): JIT from inception</li>
<li><strong>WebAssembly</strong> (2017): Near-native web
performance</li>
</ul>
<p><strong>The Performance Narrative:</strong></p>
<p>‚ÄúDynamic languages are slow‚Äù ‚Üí ‚ÄúJIT makes them fast enough‚Äù ‚Üí ‚ÄúNative
compilation when needed‚Äù</p>
<p><strong>Why Performance Suddenly Mattered:</strong></p>
<ol type="1">
<li><strong>Web Applications</strong>: JavaScript needed to run complex
apps</li>
<li><strong>Data Science</strong>: Python‚Äôs NumPy/pandas needed
speed</li>
<li><strong>Mobile</strong>: Battery and responsiveness constraints</li>
<li><strong>Cloud Costs</strong>: CPU time costs money at scale</li>
<li><strong>User Expectations</strong>: Sub-second response
expected</li>
</ol>
<h3 data-number="24.8.2" id="native-compilation-via-libgccjit"><span class="header-section-number">24.8.2</span> Native Compilation via
libgccjit</h3>
<p>Emacs‚Äôs response to the performance zeitgeist came from Andrea
Corallo‚Äôs native compilation project.</p>
<p><strong>Development Timeline:</strong></p>
<ul>
<li><strong>Research</strong>: 2019-2020</li>
<li><strong>Paper Published</strong>: ELS‚Äô20 (European Lisp Symposium),
April 27-28, 2020</li>
<li><strong>Feature Branch</strong>: feature/native-comp (nicknamed
‚Äúgccemacs‚Äù)</li>
<li><strong>Merged to Master</strong>: ~May 2021</li>
<li><strong>Released</strong>: Emacs 28.1 (April 2022)</li>
</ul>
<p><strong>Technical Approach:</strong></p>
<pre class="elisp"><code>;; From lisp/emacs-lisp/comp.el
;;; Commentary:
;;
;; This code is an attempt to make the pig fly.
;; Or, to put it another way to make a 911 out of a turbocharged VW Bug.

;; The native compiler employs the byte-compiler's internal
;; representation as input and exploits libgccjit to achieve code
;; generation using the GNU Compiler Collection (GCC) infrastructure.</code></pre>
<p><strong>Architecture:</strong></p>
<pre><code>‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Elisp Source Code (.el)                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                  ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Byte Compiler                           ‚îÇ
‚îÇ (byte-code representation)              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                  ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Native Compiler (comp.el, mostly Elisp) ‚îÇ
‚îÇ - Optimization passes                   ‚îÇ
‚îÇ - Type inference                        ‚îÇ
‚îÇ - Control flow analysis                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                  ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ C Back-end (comp.c)                     ‚îÇ
‚îÇ - Interface with libgccjit              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                  ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ libgccjit (GCC as library)              ‚îÇ
‚îÇ - Code generation                       ‚îÇ
‚îÇ - Optimization                          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                  ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Native Code (.eln files)                ‚îÇ
‚îÇ - Shared libraries loaded by Emacs      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò</code></pre>
<p><strong>Performance Results:</strong></p>
<p>From the 2020 paper: ‚Äúnative-compiled Elisp showing an increase of
performance ranging from 2.3x up to 42x with respect to the equivalent
byte-code.‚Äù</p>
<p>Typical real-world improvements: 2-5x for common operations.</p>
<p><strong>Configuration:</strong></p>
<pre class="elisp"><code>;; From lisp/emacs-lisp/comp.el
(defcustom native-comp-speed 2
  "Optimization level for native compilation, a number between -1 and 3.
 -1 functions are kept in bytecode form and no native compilation is performed
  0 native compilation is performed with no optimizations.
  1 light optimizations.
  2 max optimization level fully adherent to the language semantic.
  3 max optimization level, to be used only when necessary.
    Warning: with 3, the compiler is free to perform dangerous optimizations."
  :type 'integer
  :version "28.1")</code></pre>
<p><strong>Why This Approach:</strong></p>
<ol type="1">
<li><strong>Reuse Byte Compiler</strong>: Proven, mature compilation
pipeline</li>
<li><strong>Leverage GCC</strong>: World-class optimizer, maintained by
others</li>
<li><strong>Mostly Elisp</strong>: Optimization passes written in Elisp
(debuggable, extensible)</li>
<li><strong>Incremental</strong>: Works alongside byte-code</li>
<li><strong>Safe</strong>: Can verify optimizations preserve
semantics</li>
</ol>
<h3 data-number="24.8.3" id="why-performance-suddenly-mattered-more"><span class="header-section-number">24.8.3</span> Why Performance Suddenly
Mattered More</h3>
<p><strong>Historical Context:</strong></p>
<p>In the 1990s-2000s, Emacs performance was acceptable: - Computers
were slower, expectations lower - Competing with vi/vim on similar
hardware - Text editing isn‚Äôt computationally demanding - Users
tolerated startup time, lag</p>
<p><strong>What Changed in 2010s:</strong></p>
<ol type="1">
<li><strong>IDE Competition</strong>: VS Code, Atom instant startup via
Electron optimization</li>
<li><strong>LSP Servers</strong>: External processes needed responsive
Emacs to keep up</li>
<li><strong>Large Files</strong>: Codebases grew, files grew,
expectations didn‚Äôt</li>
<li><strong>Package Ecosystem</strong>: Hundreds of packages,
initialization time suffered</li>
<li><strong>Modern Languages</strong>: Complex syntax, heavy major
modes</li>
</ol>
<p><strong>Specific Pain Points:</strong></p>
<pre class="elisp"><code>;; Slow startup due to package loading
;; (package-initialize) loads all packages

;; Slow syntax highlighting on large files
;; (font-lock) in complex modes

;; Slow completion in large buffers
;; (completion-at-point) scans buffer

;; Slow scrolling with heavy modes
;; (jit-lock) recomputes on scroll</code></pre>
<p><strong>User Expectations Shifted:</strong></p>
<ul>
<li><strong>Sub-second startup</strong>: VS Code made this expected</li>
<li><strong>Smooth scrolling</strong>: 60fps on large files</li>
<li><strong>Instant feedback</strong>: Completion, diagnostics</li>
<li><strong>Background work</strong>: Don‚Äôt block user interaction</li>
</ul>
<p><strong>Native Compilation Impact:</strong></p>
<p>Native-comp addressed some, not all, performance issues:</p>
<p><strong>What It Helped:</strong> - Startup time (loading
native-compiled packages faster) - Heavy Elisp computation (org-mode,
parsing) - Complex major modes - Package initialization</p>
<p><strong>What It Didn‚Äôt Help:</strong> - I/O bound operations (reading
large files) - External process latency (LSP servers) - Display
rendering (C code already) - Fundamental algorithmic issues</p>
<h3 data-number="24.8.4" id="electron-and-resource-usage-debates"><span class="header-section-number">24.8.4</span> Electron and Resource Usage
Debates</h3>
<p><strong>The Electron Era:</strong></p>
<ul>
<li><strong>Atom</strong> (2014): GitHub‚Äôs Electron-based editor</li>
<li><strong>VS Code</strong> (2015): Microsoft‚Äôs Electron editor</li>
<li><strong>Slack, Discord, etc.</strong>: Electron for apps</li>
</ul>
<p><strong>The Accusation:</strong></p>
<p>‚ÄúElectron apps are bloated, use tons of RAM, slow‚Äù</p>
<p><strong>The Reality:</strong></p>
<pre><code>Resource Usage (typical):
- Emacs 28 (no native-comp): ~100MB RAM, basic setup
- Emacs 28 (native-comp): ~150MB RAM (cached .eln files)
- VS Code: ~300-500MB RAM (empty project)
- IntelliJ IDEA: ~1-2GB RAM (Java project)</code></pre>
<p><strong>But:</strong></p>
<p>VS Code felt faster for many users because: 1. <strong>Asynchronous
Everything</strong>: Non-blocking UI 2. <strong>Native
Rendering</strong>: GPU-accelerated scrolling 3. <strong>Optimized
Startup</strong>: Lazy loading, workers 4. <strong>Modern
Defaults</strong>: Good out-of-box experience</p>
<p><strong>Emacs‚Äôs Advantage:</strong></p>
<ul>
<li>Lower baseline resource usage</li>
<li>No JavaScript VM overhead</li>
<li>Smaller distribution size</li>
<li>Faster on older hardware</li>
</ul>
<p><strong>Emacs‚Äôs Disadvantage:</strong></p>
<ul>
<li>Synchronous Elisp blocked UI</li>
<li>No GPU acceleration</li>
<li>Slower startup with many packages</li>
<li>Default config not optimized</li>
</ul>
<p><strong>The Debate:</strong></p>
<p>Community split on whether to:</p>
<p><strong>Option A: Embrace Modern Patterns</strong> - Async Elisp
(threads added Emacs 26) - JIT compilation (native-comp) - Background
processing - Modern defaults</p>
<p><strong>Option B: Keep Lean</strong> - Minimal core - Optional
features - User configures what they need - Efficiency over
convenience</p>
<p><strong>Resolution:</strong></p>
<p>Emacs pursued middle path: - Native compilation (optional,
significant speedup) - Threads available but limited use - Package
system matured (easy to add features) - Better default experience (Emacs
29+)</p>
<p><strong>Industry Lesson:</strong></p>
<p>Performance perception ‚â† resource usage. Users valued: -
Responsiveness &gt; memory footprint - Smooth UI &gt; CPU efficiency -
Fast startup &gt; small binary</p>
<p>This required rethinking Emacs‚Äôs traditionally synchronous, blocking
architecture.</p>
<hr/>
<h2 data-number="24.9" id="modern-development-practices"><span class="header-section-number">24.9</span> Modern Development
Practices</h2>
<h3 data-number="24.9.1" id="git-dominance-and-vc-system-evolution"><span class="header-section-number">24.9.1</span> Git Dominance and VC System
Evolution</h3>
<p><strong>The Version Control Timeline:</strong></p>
<ul>
<li><strong>CVS</strong> (1990): Centralized, file-based</li>
<li><strong>Subversion</strong> (2000): Centralized, improved CVS</li>
<li><strong>Git</strong> (2005): Distributed, Linus Torvalds</li>
<li><strong>Mercurial</strong> (2005): Distributed, Python-based</li>
<li><strong>Git Wins</strong> (~2012): GitHub makes Git dominant</li>
</ul>
<p><strong>Emacs VC Support Evolution:</strong></p>
<p>Emacs‚Äôs VC (Version Control) system abstracted over multiple
backends:</p>
<pre class="elisp"><code>;; VC supported backends over the years:
;; - RCS (early 1990s)
;; - CVS (mid 1990s)
;; - Subversion (2000s)
;; - Git (mid 2000s)
;; - Mercurial (mid 2000s)
;; - Bazaar (2000s, Canonical)</code></pre>
<p><strong>The Architecture:</strong></p>
<pre class="elisp"><code>;; From lisp/vc/vc.el
;; Generic VC interface

(defun vc-register ()
  "Register current file into a version control system.")

;; Dispatches to backend-specific implementation:
;; - vc-git.el
;; - vc-svn.el
;; - vc-hg.el</code></pre>
<p><strong>Git‚Äôs Dominance Changed Everything:</strong></p>
<p>By mid-2010s, Git was ~90% of version control usage. This raised
questions:</p>
<ol type="1">
<li>Should Emacs focus on Git, de-emphasize others?</li>
<li>Should VC abstract over Git, or embrace Git-specific features?</li>
<li>What about GitHub/GitLab integration (PRs, issues, etc.)?</li>
</ol>
<p><strong>Three Approaches Emerged:</strong></p>
<p><strong>1. VC (Built-in):</strong> - Multi-backend abstraction -
Least-common-denominator features - Works for basic operations -
Conservative, stable</p>
<p><strong>2. Magit (Package):</strong> - Git-only, embraces Git‚Äôs full
feature set - Best-in-class Git interface (often cited as reason to use
Emacs) - Porcelain interface (high-level commands) -
Community-maintained, innovative</p>
<p><strong>3. Forge/GitHub Packages:</strong> - GitHub/GitLab/etc. API
integration - Pull requests, issues, code review - Web service features
in Emacs - Complemented Magit</p>
<p><strong>Why VC Remained Important:</strong></p>
<p>Despite Git dominance: - Emacs itself used Bazaar (until 2015), then
Git - Enterprise still uses SVN, Perforce - Abstraction allows switching
VCS - Simplicity for basic operations</p>
<p><strong>Git-Specific Optimizations:</strong></p>
<pre class="elisp"><code>;; From lisp/vc/vc-git.el
;; Git-specific features that don't fit VC abstraction:
;; - Staging area
;; - Rebasing
;; - Cherry-picking
;; - Stashing
;; - Worktrees</code></pre>
<p>VC-git grew to support these, but Magit‚Äôs UI/UX was superior.</p>
<p><strong>Industry Lesson:</strong></p>
<p>Abstraction (VC) vs.¬†specialization (Magit) is a false dichotomy.
Both valuable: - VC: For users who want simplicity, portability - Magit:
For users who want power, Git-specific features</p>
<h3 data-number="24.9.2" id="package-management-standardization-elpa"><span class="header-section-number">24.9.2</span> Package Management
Standardization (ELPA)</h3>
<p><strong>The Pre-ELPA Era:</strong></p>
<p>Before ~2010, Emacs package installation was manual: 1. Find .el file
on internet 2. Download to ~/.emacs.d/ 3. Add to load-path 4. Add
configuration to init.el 5. Hope dependencies are satisfied</p>
<p><strong>Problems:</strong></p>
<ul>
<li>No dependency management</li>
<li>No versioning</li>
<li>No updates</li>
<li>No discovery mechanism</li>
<li>Configuration complexity</li>
</ul>
<p><strong>Package.el Development (2007-2010):</strong></p>
<pre class="elisp"><code>;; From lisp/emacs-lisp/package.el
;; Copyright (C) 2007-2025 Free Software Foundation, Inc.
;;
;; Author: Tom Tromey &lt;tromey@redhat.com&gt;
;;         Daniel Hackney &lt;dan@haxney.org&gt;
;; Created: 10 Mar 2007

;; The idea behind package.el is to be able to download packages and
;; install them.  Packages are versioned and have versioned
;; dependencies.</code></pre>
<p><strong>ELPA Timeline:</strong></p>
<ul>
<li><strong>2007</strong>: package.el development begins</li>
<li><strong>2010</strong>: GNU ELPA established (elpa.gnu.org)</li>
<li><strong>2012</strong>: Marmalade (community archive)</li>
<li><strong>2013</strong>: MELPA (community archive, more
permissive)</li>
<li><strong>2021</strong>: NonGNU ELPA (FSF-hosted, but non-GNU
packages)</li>
</ul>
<p><strong>Architecture:</strong></p>
<pre class="elisp"><code>;; Package archive structure:
(setq package-archives
      '(("gnu" . "https://elpa.gnu.org/packages/")
        ("nongnu" . "https://elpa.nongnu.org/nongnu/")
        ("melpa" . "https://melpa.org/packages/")))

;; Package metadata:
;; - Package-Version
;; - Package-Requires (dependencies)
;; - Keywords
;; - Maintainer</code></pre>
<p><strong>What ELPA Standardized:</strong></p>
<ol type="1">
<li><strong>Package Format</strong>: .el single-file or .tar
multi-file</li>
<li><strong>Metadata</strong>: Standard headers for version,
dependencies</li>
<li><strong>Installation</strong>: Automated download, compile,
activate</li>
<li><strong>Dependencies</strong>: Recursive dependency resolution</li>
<li><strong>Updates</strong>: Check for newer versions</li>
<li><strong>Discovery</strong>: Browse available packages</li>
</ol>
<p><strong>Impact:</strong></p>
<pre><code>Emacs 22 (2007): ~50-100 widely-used packages (estimate)
Emacs 24 (2012): Package.el included, ELPA established
Emacs 29 (2023): 5,000+ packages on MELPA alone</code></pre>
<p><strong>Community Archives:</strong></p>
<p><strong>GNU ELPA:</strong> - Requires copyright assignment - Strict
quality standards - FSF-approved licenses only - Conservative,
stable</p>
<p><strong>MELPA:</strong> - No copyright assignment - Automated builds
from Git - Permissive submission - Bleeding edge, rapid updates</p>
<p><strong>NonGNU ELPA:</strong> - FSF-hosted (trusted) - No copyright
assignment required - Quality reviewed - Bridge between GNU and
MELPA</p>
<p><strong>Modern Package Management:</strong></p>
<pre class="elisp"><code>;; Minimal config for modern package management:
(require 'package)
(package-initialize)

;; Install package:
M-x package-install RET magit RET

;; Update packages:
M-x package-list-packages
U (mark upgrades)
x (execute)</code></pre>
<p><strong>Declarative Package Management:</strong></p>
<p>use-package (2012, integrated Emacs 29) revolutionized
configuration:</p>
<pre class="elisp"><code>(use-package magit
  :ensure t           ; Install if missing
  :bind ("C-x g" . magit-status)
  :config
  (setq magit-diff-refine-hunk 'all))</code></pre>
<p><strong>Industry Comparison:</strong></p>
<table>
<thead>
<tr>
<th>Emacs Package.el</th>
<th>Other Ecosystems</th>
</tr>
</thead>
<tbody>
<tr>
<td>2007-2010 development</td>
<td>npm (2010), pip (2008), cargo (2014)</td>
</tr>
<tr>
<td>Multiple archives</td>
<td>Centralized (mostly)</td>
</tr>
<tr>
<td>Manual curation (ELPA)</td>
<td>Automated (MELPA)</td>
</tr>
<tr>
<td>Elisp-only</td>
<td>Native code support varies</td>
</tr>
<tr>
<td>No lockfiles (until recently)</td>
<td>Lockfiles standard</td>
</tr>
</tbody>
</table>
<p><strong>Lessons Learned:</strong></p>
<ol type="1">
<li><strong>Centralization vs Distribution</strong>: Multiple archives
provided choice</li>
<li><strong>Curation vs Automation</strong>: Both approaches
valuable</li>
<li><strong>Discoverability</strong>: Package browsing as important as
installation</li>
<li><strong>Trust</strong>: Archive provenance matters (FSF-hosted vs
community)</li>
<li><strong>Stability</strong>: Bleeding-edge (MELPA) vs stable (ELPA)
both needed</li>
</ol>
<h3 data-number="24.9.3" id="testing-culture-ert-framework"><span class="header-section-number">24.9.3</span> Testing Culture (ERT
Framework)</h3>
<p><strong>Pre-ERT Testing:</strong></p>
<p>Before 2010, Emacs testing was ad-hoc: - Manual testing - Informal
test files - No standard framework - Inconsistent coverage - Hard to run
tests</p>
<p><strong>ERT (Emacs Lisp Regression Testing):</strong></p>
<pre class="elisp"><code>;; From lisp/emacs-lisp/ert.el
;; Copyright (C) 2007-2025 Free Software Foundation, Inc.
;;
;; Author: Christian Ohler &lt;ohler@gnu.org&gt;

;; ERT is a tool for automated testing in Emacs Lisp.  Its main
;; features are facilities for defining and running test cases and
;; reporting the results as well as for debugging test failures
;; interactively.</code></pre>
<p><strong>Development and Adoption:</strong></p>
<ul>
<li><strong>2007</strong>: Christian Ohler develops ERT</li>
<li><strong>2010</strong>: ERT included in Emacs 24</li>
<li><strong>2011+</strong>: Growing test coverage in Emacs core</li>
<li><strong>2015+</strong>: Expected for package submissions</li>
</ul>
<p><strong>ERT Features:</strong></p>
<pre class="elisp"><code>;; Define a test:
(ert-deftest my-addition-test ()
  "Test that addition works correctly."
  (should (= (+ 1 2) 3))
  (should-not (= (+ 1 2) 4))
  (should-error (+ 1 "not a number")))

;; Run tests:
M-x ert RET t RET  ; Run all tests

;; Run specific test:
M-x ert RET my-addition-test RET

;; Batch mode:
emacs -batch -l ert -l my-tests.el -f ert-run-tests-batch-and-exit</code></pre>
<p><strong>Testing Patterns:</strong></p>
<pre class="elisp"><code>;; Test fixtures:
(ert-deftest test-with-temp-buffer ()
  (with-temp-buffer
    (insert "test content")
    (should (= (point-max) 13))))

;; Skip tests conditionally:
(ert-deftest test-gui-feature ()
  (skip-unless (display-graphic-p))
  ;; test GUI feature
  )

;; Expected failures (known bugs):
:expected-result :failed</code></pre>
<p><strong>Impact on Emacs Development:</strong></p>
<p><strong>Before ERT (pre-2010):</strong> - Major changes risky
(unknown breakage) - Regressions common - Manual testing burden - Fear
of refactoring</p>
<p><strong>After ERT (2010+):</strong> - Automated regression detection
- Confidence in refactoring - Continuous integration possible - Better
code quality</p>
<p><strong>Test Coverage Growth:</strong></p>
<pre><code>Emacs 23 (2009): ~100 test files (estimate)
Emacs 24 (2012): ~200 test files (ERT added)
Emacs 29 (2023): ~1000+ test files

Coverage still incomplete, but growing</code></pre>
<p><strong>Industry Context:</strong></p>
<p><strong>Testing Frameworks Timeline:</strong> - JUnit (Java, 1997) -
PyUnit/unittest (Python, 2001) - RSpec (Ruby, 2005) - ERT (Elisp,
2007/2010) - Go testing (2009)</p>
<p>Emacs was relatively late to standardized testing, but ERT was
influenced by mature frameworks (especially JUnit patterns).</p>
<p><strong>Testing Challenges Unique to Emacs:</strong></p>
<ol type="1">
<li><strong>State Management</strong>: Emacs has global state (buffers,
windows, frames)</li>
<li><strong>Asynchronous Operations</strong>: Timers, processes</li>
<li><strong>User Interaction</strong>: Testing interactive commands</li>
<li><strong>Display</strong>: Testing visual features</li>
<li><strong>Platform Differences</strong>: Cross-platform testing</li>
</ol>
<p><strong>Solutions:</strong></p>
<pre class="elisp"><code>;; Mock user input:
(ert-deftest test-interactive-command ()
  (cl-letf (((symbol-function 'read-string)
             (lambda (&amp;rest _) "mocked input")))
    (should (equal (my-interactive-function) expected-result))))

;; Test with fresh Emacs state:
;; Run in subprocess:
(ert-deftest test-in-clean-environment ()
  :tags '(:expensive)
  ;; Uses emacs -batch subprocess
  )</code></pre>
<h3 data-number="24.9.4" id="continuous-integration-2"><span class="header-section-number">24.9.4</span> Continuous Integration</h3>
<p><strong>The CI Revolution:</strong></p>
<ul>
<li><strong>Travis CI</strong> (2011): Free CI for open source</li>
<li><strong>GitHub Actions</strong> (2019): Integrated CI/CD</li>
<li><strong>GitLab CI</strong> (2011): Built-in pipeline</li>
</ul>
<p><strong>Emacs CI Evolution:</strong></p>
<p><strong>Early Days (pre-2015):</strong> - Manual builds by
maintainers - Occasional automated builds - No PR testing - Slow
feedback loop</p>
<p><strong>Modern Era (2015+):</strong></p>
<div class="sourceCode" id="cb1049"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb1049-1"><a aria-hidden="true" href="#cb1049-1" tabindex="-1"></a><span class="co"># .github/workflows/test.yml (hypothetical)</span></span>
<span id="cb1049-2"><a aria-hidden="true" href="#cb1049-2" tabindex="-1"></a><span class="fu">name</span><span class="kw">:</span><span class="at"> Emacs CI</span></span>
<span id="cb1049-3"><a aria-hidden="true" href="#cb1049-3" tabindex="-1"></a><span class="fu">on</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="at">push</span><span class="kw">,</span><span class="at"> pull_request</span><span class="kw">]</span></span>
<span id="cb1049-4"><a aria-hidden="true" href="#cb1049-4" tabindex="-1"></a><span class="fu">jobs</span><span class="kw">:</span></span>
<span id="cb1049-5"><a aria-hidden="true" href="#cb1049-5" tabindex="-1"></a><span class="at">  </span><span class="fu">test</span><span class="kw">:</span></span>
<span id="cb1049-6"><a aria-hidden="true" href="#cb1049-6" tabindex="-1"></a><span class="at">    </span><span class="fu">runs-on</span><span class="kw">:</span><span class="at"> ubuntu-latest</span></span>
<span id="cb1049-7"><a aria-hidden="true" href="#cb1049-7" tabindex="-1"></a><span class="at">    </span><span class="fu">steps</span><span class="kw">:</span></span>
<span id="cb1049-8"><a aria-hidden="true" href="#cb1049-8" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> actions/checkout@v2</span></span>
<span id="cb1049-9"><a aria-hidden="true" href="#cb1049-9" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Run tests</span></span>
<span id="cb1049-10"><a aria-hidden="true" href="#cb1049-10" tabindex="-1"></a><span class="at">        </span><span class="fu">run</span><span class="kw">:</span><span class="at"> make check</span></span></code></pre></div>
<p><strong>What CI Enabled:</strong></p>
<ol type="1">
<li><strong>Automated Testing</strong>: Every commit tested</li>
<li><strong>Multi-Platform</strong>: Test on Linux, macOS, Windows
simultaneously</li>
<li><strong>Pull Request Verification</strong>: Changes tested before
merge</li>
<li><strong>Regression Detection</strong>: Immediate notification of
breakage</li>
<li><strong>Documentation Builds</strong>: Verify manual builds
correctly</li>
</ol>
<p><strong>Emacs Development Impact:</strong></p>
<ul>
<li>Faster review cycle</li>
<li>More contributor confidence</li>
<li>Catch platform-specific bugs</li>
<li>Enforce code standards</li>
<li>Build and test matrix:
<ul>
<li>Multiple Emacs versions</li>
<li>With/without features (native-comp, tree-sitter)</li>
<li>Different OSes</li>
</ul></li>
</ul>
<p><strong>Package Development:</strong></p>
<p>Modern Emacs packages expected to have: - ERT tests - CI
configuration (GitHub Actions) - MELPA integration - Automated
releases</p>
<p>Example: Magit, company-mode, lsp-mode all have comprehensive CI.</p>
<p><strong>Cultural Shift:</strong></p>
<p><strong>Old Model (pre-2010):</strong> - Manual testing by
maintainers - Trust in contributors - ‚ÄúWorks on my machine‚Äù - Slow
iteration</p>
<p><strong>New Model (2015+):</strong> - Automated verification - Trust
but verify - Multi-platform confidence - Rapid iteration</p>
<p><strong>Industry Convergence:</strong></p>
<p>By 2020, Emacs development practices converged with industry
standards: - Git + GitHub/GitLab - CI/CD pipelines - Automated testing -
Package management - Code review via PRs</p>
<p>This made Emacs more accessible to modern developers familiar with
these practices from other projects.</p>
<hr/>
<h2 data-number="24.10" id="synthesis-emacs-as-technology-survivor"><span class="header-section-number">24.10</span> Synthesis: Emacs as
Technology Survivor</h2>
<h3 data-number="24.10.1" id="themes-across-eras"><span class="header-section-number">24.10.1</span> Themes Across Eras</h3>
<p>Analyzing five decades of Emacs evolution reveals consistent patterns
in how it adapted to industry change:</p>
<p><strong>1. Preservation Through Abstraction</strong></p>
<p>Emacs survived by abstracting over: - Terminal types ‚Üí Display
abstraction - Unix variants ‚Üí Portability layer - Version control
systems ‚Üí VC abstraction - Window systems ‚Üí Frame/display model</p>
<p>Each abstraction preserved Emacs‚Äôs essence while adapting to changing
infrastructure.</p>
<p><strong>2. Selective Adoption</strong></p>
<p>Emacs didn‚Äôt chase every trend: - <strong>Adopted</strong>: LSP,
Tree-sitter, Git, package management - <strong>Rejected</strong>:
Complete GUI rewrite, JavaScript engine, mobile-first UI -
<strong>Adapted</strong>: Lisp Machine culture, IDE features, web
browsing</p>
<p>Success came from adopting trends that complemented Emacs‚Äôs
strengths.</p>
<p><strong>3. Community Over Corporation</strong></p>
<p>Unlike proprietary competitors (Visual Studio) or venture-backed
startups (Atom), Emacs evolved through: - Volunteer contributions -
Institutional support (FSF, universities) - User-driven development -
Long-term thinking</p>
<p>This slower pace allowed considered decisions but sometimes lagged
industry.</p>
<p><strong>4. Architectural Flexibility</strong></p>
<p>The same architecture that enabled a Lisp Machine in the 1980s
enabled: - Web browsing (2013) - LSP integration (2018) - Android port
(2023) - Native compilation (2022)</p>
<p>Emacs‚Äôs ‚Äúprogrammable editor‚Äù model proved more adaptable than
‚Äúeditor with plugins.‚Äù</p>
<h3 data-number="24.10.2" id="success-and-failure-metrics"><span class="header-section-number">24.10.2</span> Success and Failure
Metrics</h3>
<p><strong>Unqualified Successes:</strong></p>
<ol type="1">
<li><strong>Portability</strong>: Runs on every major platform (desktop,
mobile, server)</li>
<li><strong>Extensibility</strong>: 5,000+ packages, infinite
customization</li>
<li><strong>Longevity</strong>: 40+ years and still relevant</li>
<li><strong>Community</strong>: Active development, passionate
users</li>
<li><strong>LSP Adoption</strong>: Achieved feature parity with modern
editors</li>
</ol>
<p><strong>Qualified Successes:</strong></p>
<ol type="1">
<li><strong>Performance</strong>: Native-comp helped, but still slower
than VSCode for some tasks</li>
<li><strong>IDE Features</strong>: Capable, but fragmented (CEDET vs LSP
vs tags)</li>
<li><strong>Mobile</strong>: Works on Android, but UI not ideal</li>
<li><strong>Onboarding</strong>: Still steep learning curve despite
improvements</li>
<li><strong>Defaults</strong>: Better in recent versions, but legacy
cruft remains</li>
</ol>
<p><strong>Relative Failures:</strong></p>
<ol type="1">
<li><strong>Market Share</strong>: Niche compared to VS Code‚Äôs
dominance</li>
<li><strong>Visual Appeal</strong>: Terminal roots show, GUI feels
dated</li>
<li><strong>Discoverability</strong>: Features hidden behind
commands</li>
<li><strong>Async Architecture</strong>: Still mostly synchronous</li>
<li><strong>Modern UI Paradigms</strong>: Doesn‚Äôt match Electron-era
expectations</li>
</ol>
<h3 data-number="24.10.3" id="future-trends-and-emacss-position"><span class="header-section-number">24.10.3</span> Future Trends and Emacs‚Äôs
Position</h3>
<p><strong>Emerging Trends (2024+):</strong></p>
<ol type="1">
<li><strong>AI-Assisted Coding</strong>: GitHub Copilot, ChatGPT,
etc.</li>
<li><strong>Cloud Development</strong>: GitHub Codespaces, Gitpod</li>
<li><strong>Polyglot Workspaces</strong>: Multi-language projects</li>
<li><strong>Remote Development</strong>: Dev containers, SSH
workflows</li>
<li><strong>Declarative Configuration</strong>: Nix, Guix, reproducible
environments</li>
</ol>
<p><strong>Emacs‚Äôs Positioning:</strong></p>
<p><strong>AI Integration:</strong> - Copilot.el, gptel, other AI
packages emerging - REPL-based workflow suits interactive AI -
Extensibility enables experimentation - But: proprietary APIs, ethical
concerns</p>
<p><strong>Cloud Development:</strong> - TRAMP for remote editing
(decades old) - Server/client model enables remote - But: assumes local
Emacs installation</p>
<p><strong>Polyglot Support:</strong> - LSP provides multi-language
support - Tree-sitter enables complex syntax - Universal interface
across languages - Success: Emacs excels here</p>
<p><strong>Declarative Configuration:</strong> - Early adoption
(literate config, use-package) - Nix/Guix Emacs packages - Reproducible
setups - Cultural fit with Emacs community</p>
<h3 data-number="24.10.4" id="the-editor-wars-historical-perspective"><span class="header-section-number">24.10.4</span> The Editor Wars: Historical
Perspective</h3>
<p><strong>1980s-1990s: vi vs Emacs</strong> - Terminal dominance - Unix
culture wars - Efficiency vs power - <strong>Result</strong>: Both
thrived</p>
<p><strong>2000s-2010s: IDE vs Editors</strong> - Visual Studio,
Eclipse, IntelliJ - Integrated vs modular - Corporate vs community -
<strong>Result</strong>: Specialization (language-specific IDEs)</p>
<p><strong>2010s-2020s: Electron Era</strong> - Atom, VS Code, Sublime -
Modern UX, extensions - Cross-platform, fast - <strong>Result</strong>:
VS Code won market share</p>
<p><strong>2020s+: AI and Cloud</strong> - Copilot, Cursor, cloud IDEs -
AI assistance, remote development - Proprietary services -
<strong>Result</strong>: TBD</p>
<p><strong>Emacs‚Äôs Niche:</strong></p>
<p>Throughout these wars, Emacs retained a core audience valuing: -
Customization over convention - Keyboard over mouse - Scriptability over
simplicity - Longevity over trendiness - Local over cloud - Free
software over convenience</p>
<p>This niche is small but stable, ensuring Emacs‚Äôs survival even if not
dominance.</p>
<hr/>
<h2 data-number="24.11" id="conclusion-8"><span class="header-section-number">24.11</span> Conclusion</h2>
<p>Emacs‚Äôs five-decade evolution demonstrates that survival in
technology requires:</p>
<ol type="1">
<li><strong>Architectural Vision</strong>: The Lisp Machine model proved
remarkably adaptable</li>
<li><strong>Selective Adoption</strong>: Not every trend deserves
following</li>
<li><strong>Community Strength</strong>: Distributed development
outlasts corporate initiatives</li>
<li><strong>Principled Flexibility</strong>: Core values (freedom,
extensibility) guide adaptation</li>
<li><strong>Patience</strong>: Some trends (CEDET) fail; later
approaches (LSP) succeed</li>
</ol>
<p>The story of Emacs is ultimately about preserving a way of thinking
about computing‚Äîprogrammable, introspective, user-controlled‚Äîthrough
changing technological eras. From Lisp Machines to Language Servers, the
core insight remained: powerful tools emerge when users can program
their environment.</p>
<p>This isn‚Äôt merely nostalgia or conservatism. Modern trends (LSP,
Tree-sitter, native compilation) show Emacs incorporating industry
innovations. But it does so on its own terms, maintaining the ‚ÄúEmacs
nature‚Äù while gaining contemporary capabilities.</p>
<p>The question isn‚Äôt whether Emacs will survive the next decade‚Äîit
will, serving its dedicated community. The question is whether its core
insights about programmable, extensible environments will influence
future tools, or remain a niche philosophy in an era of polished,
opinionated products.</p>
<p>Given recent interest in local-first software, customizable AI
agents, and programmable systems, perhaps the next generation of tools
will rediscover what Emacs users knew all along: the best tool is the
one you can remake to suit your needs.</p>
<hr/>
<h2 data-number="24.12" id="references-and-further-reading"><span class="header-section-number">24.12</span> References and Further
Reading</h2>
<h3 data-number="24.12.1" id="academic-papers"><span class="header-section-number">24.12.1</span> Academic Papers</h3>
<ul>
<li>Corallo, A., Nassi, L., &amp; Manca, N. (2020). ‚ÄúBringing GNU Emacs
to Native Code.‚Äù <em>European Lisp Symposium 2020</em>.
arXiv:2004.02504</li>
</ul>
<h3 data-number="24.12.2" id="historical-documents"><span class="header-section-number">24.12.2</span> Historical Documents</h3>
<ul>
<li>Stallman, R. M. (1981). ‚ÄúEMACS: The Extensible, Customizable,
Self-Documenting Display Editor.‚Äù <em>MIT AI Lab Memo 519a</em>.</li>
<li>Moon, D. A. (1984). ‚ÄúGarbage Collection in a Large Lisp System.‚Äù
<em>Proceedings of the 1984 ACM Symposium on Lisp and Functional
Programming</em>.</li>
</ul>
<h3 data-number="24.12.3" id="industry-analysis"><span class="header-section-number">24.12.3</span> Industry Analysis</h3>
<ul>
<li>Microsoft Language Server Protocol:
https://microsoft.github.io/language-server-protocol/</li>
<li>Tree-sitter: https://tree-sitter.github.io/</li>
<li>Emacs News Files:
<code>/usr/share/emacs/[VERSION]/etc/NEWS*</code></li>
</ul>
<h3 data-number="24.12.4" id="key-figures"><span class="header-section-number">24.12.4</span> Key Figures</h3>
<ul>
<li>Richard Stallman: GNU Emacs creator, Free Software Foundation</li>
<li>Lars Ingebrigtsen: Gnus, EWW author</li>
<li>Andrea Corallo: Native compilation</li>
<li>Jo√£o T√°vora: Eglot LSP client</li>
<li>Yuan Fu (‰ªòÁ¶πÂÆâ): Tree-sitter integration</li>
<li>Po Lu: Android port</li>
<li>Christian Ohler: ERT testing framework</li>
</ul>
<h3 data-number="24.12.5" id="web-resources"><span class="header-section-number">24.12.5</span> Web Resources</h3>
<ul>
<li>GNU Emacs: https://www.gnu.org/software/emacs/</li>
<li>Emacs Wiki: https://www.emacswiki.org/</li>
<li>MELPA: https://melpa.org/</li>
<li>Emacs News: https://sachachua.com/blog/category/emacs-news/</li>
</ul>
<hr/>
<p><em>This document synthesizes information from web research, Emacs
source code, NEWS files, and historical documentation. All code examples
are from GNU Emacs 30.x (development version) unless otherwise
noted.</em></p>
<h1 data-number="25" id="chapter-20-comparative-analysis"><span class="header-section-number">25</span> Chapter 20: Comparative
Analysis</h1>
<h2 data-number="25.1" id="overview-12"><span class="header-section-number">25.1</span> Overview</h2>
<p>This chapter examines Emacs in the broader context of text editor and
IDE evolution, comparing architectural decisions, design philosophies,
and practical tradeoffs across five decades of editor development.</p>
<h2 data-number="25.2" id="purpose-1"><span class="header-section-number">25.2</span> Purpose</h2>
<p>Rather than advocacy or criticism, this chapter provides
<strong>objective analysis</strong> of different approaches to text
editing, helping readers:</p>
<ol type="1">
<li><strong>Understand design tradeoffs</strong>: Every editor makes
deliberate choices that optimize for specific goals</li>
<li><strong>Learn from diversity</strong>: Different architectures solve
different problems</li>
<li><strong>Recognize patterns</strong>: Common patterns emerge across
successful editors</li>
<li><strong>Make informed decisions</strong>: Choose tools based on
understanding, not dogma</li>
<li><strong>Appreciate history</strong>: Modern editors build on 50
years of experimentation</li>
</ol>
<h2 data-number="25.3" id="chapter-contents"><span class="header-section-number">25.3</span> Chapter Contents</h2>
<h3 data-number="25.3.1" id="editor-comparison.md"><span class="header-section-number">25.3.1</span> 01-editor-comparison.md</h3>
<p>Comprehensive comparison of Emacs against:</p>
<ol type="1">
<li><strong>Vi/Vim</strong>: Modal vs.¬†modeless editing, extension
languages, philosophy differences</li>
<li><strong>Modern Editors</strong>: VSCode, Sublime Text,
Atom‚Äîarchitecture, performance, LSP adoption</li>
<li><strong>IDEs</strong>: Visual Studio, IntelliJ,
Eclipse‚Äîlanguage-specific vs.¬†agnostic approaches</li>
<li><strong>Cloud Editors</strong>: GitHub Codespaces, Gitpod‚Äîlocal
vs.¬†remote development</li>
<li><strong>Historical Editors</strong>: TECO, EINE, ZWEI‚Äîevolution and
lessons learned</li>
</ol>
<h2 data-number="25.4" id="key-themes"><span class="header-section-number">25.4</span> Key Themes</h2>
<h3 data-number="25.4.1" id="no-best-editor"><span class="header-section-number">25.4.1</span> 1. No ‚ÄúBest‚Äù Editor</h3>
<p>Different editors optimize for different values: -
<strong>Emacs</strong>: Customization, keyboard efficiency, integration
depth - <strong>VSCode</strong>: Accessibility, modern UX, ecosystem
breadth - <strong>IntelliJ</strong>: Language expertise, refactoring
power - <strong>Vim</strong>: Modal efficiency, minimal resources,
ubiquity</p>
<h3 data-number="25.4.2" id="fundamental-tradeoffs"><span class="header-section-number">25.4.2</span> 2. Fundamental
Tradeoffs</h3>
<p>All editors face similar tradeoffs: - <strong>Extensibility
vs.¬†Performance</strong>: API boundaries vs.¬†full access - <strong>Power
vs.¬†Simplicity</strong>: Feature richness vs.¬†learning curve -
<strong>Local vs.¬†Remote</strong>: Offline capability vs.¬†collaboration
- <strong>Monolith vs.¬†Microservices</strong>: Integration
vs.¬†reusability</p>
<h3 data-number="25.4.3" id="convergent-evolution"><span class="header-section-number">25.4.3</span> 3. Convergent Evolution</h3>
<p>Modern editors converge on best practices: - <strong>LSP (Language
Server Protocol)</strong>: Universal language support -
<strong>Tree-sitter</strong>: Incremental parsing - <strong>Git
integration</strong>: Expected feature - <strong>Remote
development</strong>: Growing standard</p>
<h3 data-number="25.4.4" id="persistent-differences"><span class="header-section-number">25.4.4</span> 4. Persistent
Differences</h3>
<p>Some differences are philosophical: - <strong>Extension
model</strong>: Full access (Emacs) vs.¬†controlled API (VSCode) -
<strong>UI paradigm</strong>: Keyboard-first vs.¬†GUI-first -
<strong>Resource usage</strong>: Minimal (Vim) vs.¬†comprehensive
(IDEs)</p>
<h2 data-number="25.5" id="learning-objectives-2"><span class="header-section-number">25.5</span> Learning Objectives</h2>
<p>After reading this chapter, you should be able to:</p>
<ol type="1">
<li><strong>Explain architectural differences</strong> between major
editor categories</li>
<li><strong>Identify tradeoffs</strong> in extension system design (API
vs.¬†full access)</li>
<li><strong>Understand modal vs.¬†modeless</strong> paradigms and their
implications</li>
<li><strong>Recognize the impact of LSP</strong> on editor ecosystem
evolution</li>
<li><strong>Appreciate historical context</strong> (TECO ‚Üí GNU Emacs
evolution)</li>
<li><strong>Make informed tool choices</strong> based on workflow
requirements</li>
<li><strong>Apply lessons</strong> to your own software design
decisions</li>
</ol>
<h2 data-number="25.6" id="target-audience"><span class="header-section-number">25.6</span> Target Audience</h2>
<p>This chapter is valuable for:</p>
<ul>
<li><strong>Emacs users</strong> wanting to understand alternatives
objectively</li>
<li><strong>Tool evaluators</strong> comparing editors for team
adoption</li>
<li><strong>Software architects</strong> studying extensibility
patterns</li>
<li><strong>Computer science students</strong> learning software design
principles</li>
<li><strong>Curious developers</strong> interested in editor
evolution</li>
</ul>
<h2 data-number="25.7" id="reading-prerequisites"><span class="header-section-number">25.7</span> Reading Prerequisites</h2>
<ul>
<li><strong>Minimal</strong>: General familiarity with text editors</li>
<li><strong>Helpful</strong>: Experience with at least two different
editors</li>
<li><strong>Recommended</strong>: Understanding of Chapters 01-03 (Emacs
architecture)</li>
</ul>
<h2 data-number="25.8" id="recommended-reading-order"><span class="header-section-number">25.8</span> Recommended Reading Order</h2>
<ol type="1">
<li><strong>Quick overview</strong>: Read Executive Summary and
Conclusion (sections 1.0 and 8.0)</li>
<li><strong>Specific comparisons</strong>: Jump to relevant section
(Vi/Vim, VSCode, etc.)</li>
<li><strong>Deep dive</strong>: Read sequentially for complete
understanding</li>
<li><strong>Reference</strong>: Use as comparison reference during tool
evaluation</li>
</ol>
<h2 data-number="25.9" id="related-chapters-1"><span class="header-section-number">25.9</span> Related Chapters</h2>
<ul>
<li><strong>Chapter 00</strong>: Introduction (historical context)</li>
<li><strong>Chapter 01</strong>: Architecture (Emacs design
decisions)</li>
<li><strong>Chapter 03</strong>: Elisp Runtime (extension language
design)</li>
<li><strong>Chapter 18</strong>: Development Practices (evolution
patterns)</li>
</ul>
<h2 data-number="25.10" id="key-insights-preview"><span class="header-section-number">25.10</span> Key Insights Preview</h2>
<p><strong>From Vi/Vim:</strong> - Modal editing creates powerful
command composition - Minimal core + extensions = broad applicability -
Both modal and modeless survived because they optimize for different
workflows</p>
<p><strong>From Modern Editors:</strong> - Web technologies (Electron)
lower barrier to entry for extension developers - Process isolation
(VSCode) enables API stability and security - Good defaults matter more
than ultimate customizability for market success</p>
<p><strong>From IDEs:</strong> - Language-specific optimization enables
superior refactoring and debugging - Project-centric workflow
vs.¬†file-centric workflow serves different use cases - Semantic analysis
requires significant resource investment</p>
<p><strong>From Cloud Editors:</strong> - Instant environment setup
reduces onboarding friction - Collaboration features are increasingly
expected - Hybrid (local + remote) is emerging as best of both
worlds</p>
<p><strong>From Historical Editors:</strong> - Extension language must
be real programming language (Mocklisp ‚Üí Elisp) - Platform independence
is essential for longevity - Backward compatibility enables gradual
evolution without losing users</p>
<h2 data-number="25.11" id="philosophical-framework"><span class="header-section-number">25.11</span> Philosophical Framework</h2>
<p>This chapter embraces <strong>pluralism</strong>: multiple valid
approaches coexist because they serve different needs. Key
principles:</p>
<ol type="1">
<li><strong>No silver bullet</strong>: Every approach has tradeoffs</li>
<li><strong>Context matters</strong>: ‚ÄúBest‚Äù depends on workflow, team,
project</li>
<li><strong>Learn from all</strong>: Each editor contributes
insights</li>
<li><strong>Respect diversity</strong>: Different doesn‚Äôt mean
wrong</li>
<li><strong>Pragmatism wins</strong>: Use right tool for each job</li>
</ol>
<h2 data-number="25.12" id="document-statistics"><span class="header-section-number">25.12</span> Document Statistics</h2>
<ul>
<li><strong>Estimated Reading Time</strong>: 2-3 hours (comprehensive),
30 minutes (skimming)</li>
<li><strong>Page Count</strong>: ~65 pages (printed)</li>
<li><strong>Word Count</strong>: ~16,500 words</li>
<li><strong>Code Examples</strong>: 30+ from various editors</li>
<li><strong>Comparison Tables</strong>: 15+ detailed comparisons</li>
<li><strong>Historical Timeline</strong>: 1962 (TECO) to 2025
(present)</li>
</ul>
<h2 data-number="25.13" id="how-to-use-this-chapter"><span class="header-section-number">25.13</span> How to Use This Chapter</h2>
<p><strong>For Decision-Making:</strong> - Compare specific features
across editors - Understand tradeoffs for your use case - Evaluate based
on team needs, not personal preference</p>
<p><strong>For Learning:</strong> - Study different architectural
patterns - Understand why design decisions were made - Apply lessons to
your own projects</p>
<p><strong>For Teaching:</strong> - Use as comparative software
architecture case study - Illustrate design tradeoff principles - Show
evolution of software over time</p>
<h2 data-number="25.14" id="contributing"><span class="header-section-number">25.14</span> Contributing</h2>
<p>This chapter benefits from: - <strong>User experiences</strong>:
Real-world editor usage patterns - <strong>Corrections</strong>: Factual
errors or outdated information - <strong>Additions</strong>: New editors
or features worth comparing - <strong>Balance</strong>: Ensuring
objective, fair comparisons</p>
<p>Please submit feedback through standard Emacs contribution
channels.</p>
<hr/>
<p><strong>Chapter Status</strong>: Complete (v1.0.0) <strong>Last
Updated</strong>: 2025-11-18 <strong>Maintainer</strong>: Emacs
Documentation Team <strong>License</strong>: GNU Free Documentation
License</p>
<h1 data-number="26" id="editor-comparison-emacs-and-the-evolution-of-text-editing"><span class="header-section-number">26</span> Editor Comparison: Emacs and the
Evolution of Text Editing</h1>
<h2 data-number="26.1" id="executive-summary-3"><span class="header-section-number">26.1</span> Executive Summary</h2>
<p>This chapter provides an objective comparative analysis of Emacs
against other significant text editors and development environments,
examining architectural decisions, design philosophies, and the
tradeoffs each system makes. Rather than declaring a ‚Äúwinner,‚Äù we
explore why different approaches emerged, what problems they solve, and
what lessons the broader software community can learn from each
design.</p>
<p>The editors and IDEs compared here represent different eras,
philosophies, and use cases. Each made deliberate choices that optimized
for specific goals‚Äîand each paid specific costs for those choices. By
understanding these tradeoffs, we gain insight into fundamental
questions of software design: extensibility vs.¬†performance, simplicity
vs.¬†power, standards vs.¬†innovation, and local vs.¬†remote
computation.</p>
<h2 data-number="26.2" id="vivim-the-minimalist-alternative"><span class="header-section-number">26.2</span> 1. Vi/Vim: The Minimalist
Alternative</h2>
<h3 data-number="26.2.1" id="historical-context-and-philosophy"><span class="header-section-number">26.2.1</span> 1.1 Historical Context and
Philosophy</h3>
<p>While Emacs emerged from MIT‚Äôs AI Lab in the mid-1970s, Vi (Visual
Interface) was created by Bill Joy at UC Berkeley in 1976 for BSD Unix.
The two editors were born in the same era but in different cultures with
different constraints.</p>
<p><strong>Design Philosophy Differences:</strong></p>
<ul>
<li><strong>Emacs</strong>: ‚ÄúEverything is Lisp data‚Äù‚Äîextensibility
through a complete programming environment</li>
<li><strong>Vi/Vim</strong>: ‚ÄúDo one thing well‚Äù‚Äîefficient text editing
with composable commands</li>
</ul>
<p>Both philosophies are valid responses to different priorities. Emacs
prioritized customizability and self-documentation; Vi prioritized small
size, fast startup, and efficient operation on slow terminals.</p>
<h3 data-number="26.2.2" id="modal-vs.-modeless-editing"><span class="header-section-number">26.2.2</span> 1.2 Modal vs.¬†Modeless
Editing</h3>
<p><strong>Vi/Vim‚Äôs Modal Approach:</strong></p>
<pre><code>[Normal Mode] ‚îÄ‚Üí i ‚îÄ‚Üí [Insert Mode]
     ‚Üë                      ‚îÇ
     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ &lt;Esc&gt; ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò</code></pre>
<p>Commands are single keystrokes in normal mode: - <code>dd</code> -
delete line - <code>yy</code> - yank (copy) line - <code>p</code> -
paste - <code>3j</code> - move down 3 lines - <code>ciw</code> - change
inner word</p>
<p><strong>Emacs‚Äôs Modeless Approach:</strong></p>
<p>Commands are key chords, typically with modifiers: - <code>C-k</code>
- kill line (cut) - <code>C-y</code> - yank (paste) - <code>M-w</code> -
copy region - <code>C-n</code> - next line - <code>M-f</code> - forward
word</p>
<p><strong>Tradeoffs:</strong></p>
<table>
<colgroup>
<col style="width: 19%"/>
<col style="width: 36%"/>
<col style="width: 43%"/>
</colgroup>
<thead>
<tr>
<th>Aspect</th>
<th>Modal (Vi/Vim)</th>
<th>Modeless (Emacs)</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Learning Curve</strong></td>
<td>Steeper initial (mode confusion)</td>
<td>Gentler initial (just type)</td>
</tr>
<tr>
<td><strong>Efficiency</strong></td>
<td>Fewer keystrokes for complex edits</td>
<td>More consistent but more chords</td>
</tr>
<tr>
<td><strong>Cognitive Load</strong></td>
<td>Mode awareness required</td>
<td>Modifier key combinations</td>
</tr>
<tr>
<td><strong>Discovery</strong></td>
<td>Commands are single keys (harder to discover)</td>
<td>Self-documenting (C-h k)</td>
</tr>
<tr>
<td><strong>Muscle Memory</strong></td>
<td>Highly optimized for speed</td>
<td>More natural for beginners</td>
</tr>
</tbody>
</table>
<p><strong>Why Both Survived:</strong></p>
<p>Modal editing excels for <strong>intensive text manipulation</strong>
by touch typists who memorize commands. The composability of Vi commands
(<code>d3w</code> = delete 3 words, <code>y$</code> = yank to end of
line) creates a powerful editing language.</p>
<p>Modeless editing excels for <strong>discoverability and
consistency</strong>. Every command can be executed by name
(<code>M-x command-name</code>), documented interactively, and rebound.
The penalty is more complex key combinations.</p>
<p><strong>Architectural Insight:</strong> The modal/modeless divide
isn‚Äôt about which is ‚Äúbetter‚Äù‚Äîit‚Äôs about optimizing for different
cognitive models. Modal editing optimizes for <strong>expert
efficiency</strong>; modeless editing optimizes for <strong>gradual
learning and self-documentation</strong>.</p>
<h3 data-number="26.2.3" id="extension-languages-vimscript-vs.-elisp"><span class="header-section-number">26.2.3</span> 1.3 Extension Languages:
Vimscript vs.¬†Elisp</h3>
<p><strong>Vimscript Example:</strong></p>
<pre class="vim"><code>" @file: example.vim
" Vimscript function to toggle comments

function! ToggleComment()
    let l:line = getline('.')
    if l:line =~ '^\s*#'
        " Remove comment
        execute 's/^\(\s*\)#\s*/\1/'
    else
        " Add comment
        execute 's/^\(\s*\)/\1# /'
    endif
endfunction

nnoremap &lt;Leader&gt;c :call ToggleComment()&lt;CR&gt;</code></pre>
<p><strong>Equivalent Elisp:</strong></p>
<pre class="elisp"><code>;; @file: example.el
;; Elisp function to toggle comments

(defun toggle-comment ()
  "Toggle comment on current line."
  (interactive)
  (save-excursion
    (beginning-of-line)
    (if (looking-at "^\\s-*;")
        ;; Remove comment
        (replace-regexp "^\\(\\s-*\\);\\s-*" "\\1")
      ;; Add comment
      (insert "; "))))

(global-set-key (kbd "C-c c") #'toggle-comment)</code></pre>
<p><strong>Language Comparison:</strong></p>
<table>
<colgroup>
<col style="width: 33%"/>
<col style="width: 40%"/>
<col style="width: 25%"/>
</colgroup>
<thead>
<tr>
<th>Feature</th>
<th>Vimscript</th>
<th>Elisp</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Paradigm</strong></td>
<td>Imperative, procedural</td>
<td>Functional, Lisp family</td>
</tr>
<tr>
<td><strong>Type System</strong></td>
<td>Dynamic, string-oriented</td>
<td>Dynamic, symbol-oriented</td>
</tr>
<tr>
<td><strong>Namespace</strong></td>
<td>Global by default, <code>s:</code> for script-local</td>
<td>Packages, prefixes by convention</td>
</tr>
<tr>
<td><strong>Data Structures</strong></td>
<td>Lists, dictionaries (limited)</td>
<td>Rich: lists, vectors, hash tables, symbols</td>
</tr>
<tr>
<td><strong>Debugging</strong></td>
<td>Limited introspection</td>
<td>Full debugger, edebug, trace</td>
</tr>
<tr>
<td><strong>Documentation</strong></td>
<td>Help system, separate</td>
<td>Self-documenting, integrated</td>
</tr>
<tr>
<td><strong>Standard Library</strong></td>
<td>Editor-focused</td>
<td>General-purpose + editor</td>
</tr>
</tbody>
</table>
<p><strong>Design Decision Analysis:</strong></p>
<p>Vimscript evolved as an extension to ex (line editor) commands. It
grew organically to support scripting, resulting in a language optimized
for text processing but with limited abstraction capabilities.</p>
<p>Elisp was designed from the start as a full Lisp dialect. This made
Emacs heavier but enabled:</p>
<ol type="1">
<li><strong>True introspection</strong>: Query any function‚Äôs source,
documentation, or bindings</li>
<li><strong>First-class functions</strong>: Pass functions as values,
enabling higher-order programming</li>
<li><strong>Uniform syntax</strong>: Code is data (homoiconicity),
enabling sophisticated macros</li>
<li><strong>Rich ecosystem</strong>: Full programming language enables
complex packages</li>
</ol>
<p><strong>Lesson Learned:</strong> An extension language that starts as
a ‚Äúsimple scripting layer‚Äù will eventually grow complex. Choosing a
well-designed general-purpose language from the start pays dividends as
the system evolves.</p>
<h3 data-number="26.2.4" id="startup-time-and-resource-usage"><span class="header-section-number">26.2.4</span> 1.4 Startup Time and
Resource Usage</h3>
<p><strong>Typical Measurements (2025, modern hardware):</strong></p>
<table>
<thead>
<tr>
<th>Editor</th>
<th>Startup Time</th>
<th>Memory Footprint</th>
<th>Binary Size</th>
</tr>
</thead>
<tbody>
<tr>
<td>Vim (minimal config)</td>
<td>10-30ms</td>
<td>5-10 MB</td>
<td>3 MB</td>
</tr>
<tr>
<td>Vim (heavy plugins)</td>
<td>100-300ms</td>
<td>50-100 MB</td>
<td>N/A</td>
</tr>
<tr>
<td>Emacs (minimal config)</td>
<td>50-150ms</td>
<td>20-30 MB</td>
<td>60 MB</td>
</tr>
<tr>
<td>Emacs (daemon mode, client)</td>
<td>5-10ms</td>
<td>Shared</td>
<td>N/A</td>
</tr>
<tr>
<td>Emacs (heavy config)</td>
<td>500-2000ms</td>
<td>100-300 MB</td>
<td>N/A</td>
</tr>
<tr>
<td>Neovim (Lua, minimal)</td>
<td>8-25ms</td>
<td>8-15 MB</td>
<td>4 MB</td>
</tr>
</tbody>
</table>
<p><strong>Architectural Sources of Difference:</strong></p>
<p><strong>Vim‚Äôs Speed:</strong> - Compiled C core with minimal
dependencies - Simple plugin loading mechanism - Lazy loading by default
- No Lisp interpreter overhead</p>
<p><strong>Emacs‚Äôs Weight:</strong> - Full Lisp interpreter and compiler
- Native compilation (libgccjit) for speed but size - Eager loading of
core libraries - Rich built-in functionality (mail, IRC, calendar,
etc.)</p>
<p><strong>Mitigation Strategies:</strong></p>
<p>Emacs users address startup time through: 1. <strong>Daemon
mode</strong>: Start server once, connect with instant clients 2.
<strong>Lazy loading</strong>: <code>use-package</code>, autoload, and
deferred evaluation 3. <strong>Native compilation</strong>: Elisp
compiled to machine code (Emacs 28+) 4. <strong>Startup
profiling</strong>: Identify and optimize slow-loading packages</p>
<p>Vim users maintain speed by: 1. <strong>Plugin managers</strong>:
lazy.nvim, packer.nvim for deferred loading 2. <strong>Minimal
core</strong>: Small, fast base with optional extensions 3.
<strong>Async plugins</strong>: Background loading and processing</p>
<p><strong>Tradeoff Analysis:</strong></p>
<table>
<colgroup>
<col style="width: 37%"/>
<col style="width: 37%"/>
<col style="width: 25%"/>
</colgroup>
<thead>
<tr>
<th>Approach</th>
<th>Benefits</th>
<th>Costs</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Vim‚Äôs minimalism</strong></td>
<td>Fast startup, low memory, runs anywhere</td>
<td>Limited built-in features, plugin quality varies</td>
</tr>
<tr>
<td><strong>Emacs‚Äôs maximalism</strong></td>
<td>Rich environment, consistent integration</td>
<td>Heavy initial load, resource intensive</td>
</tr>
</tbody>
</table>
<p><strong>Modern Convergence:</strong></p>
<p>Interestingly, heavily configured Vim/Neovim setups with LSP,
tree-sitter, and modern plugins approach Emacs-level resource usage and
startup time. Meanwhile, Emacs with daemon mode and lazy loading
achieves Vim-like instant availability. The practical difference has
narrowed considerably.</p>
<h3 data-number="26.2.5" id="why-both-survived-different-optimization-targets"><span class="header-section-number">26.2.5</span> 1.5 Why Both Survived:
Different Optimization Targets</h3>
<p>After 45+ years, both editors remain actively developed with large
communities. This isn‚Äôt accidental‚Äîthey optimize for different use
cases:</p>
<p><strong>Vi/Vim Optimizes For:</strong> - <strong>Server
administration</strong>: Installed by default on Unix systems, minimal
dependencies - <strong>Quick edits</strong>: Fast startup for small
configuration changes - <strong>Modal efficiency</strong>: Minimal
keystrokes for complex transformations - <strong>Lightweight
environments</strong>: Low resource usage, terminal-first design</p>
<p><strong>Emacs Optimizes For:</strong> - <strong>Integrated
environments</strong>: One tool for editing, mail, organization,
development - <strong>Deep customization</strong>: Modify any behavior,
self-documenting exploration - <strong>Long sessions</strong>: Daemon
mode, persistent state, gradual configuration discovery -
<strong>Programming-centric</strong>: Rich language support, debugging,
project management</p>
<p><strong>Market Segmentation:</strong></p>
<p>In practice, many developers use both: - Vi/Vim for quick server
edits, git commits, system administration - Emacs for long-form
programming, research, writing, organization</p>
<p>This division of labor represents a stable equilibrium where each
tool excels in its domain.</p>
<h3 data-number="26.2.6" id="technical-innovations-from-each"><span class="header-section-number">26.2.6</span> 1.6 Technical Innovations
from Each</h3>
<p><strong>From Vi/Vim to the World:</strong></p>
<ol type="1">
<li><strong>Modal editing</strong>: Adopted by Kakoune, Helix, and as
plugins for other editors</li>
<li><strong>Composable commands</strong>: The ‚Äúverb-noun‚Äù model
(<code>d3w</code> = delete 3 words)</li>
<li><strong>Regular expressions</strong>: Vim‚Äôs regex flavor influenced
many tools</li>
<li><strong>Text objects</strong>: Operating on structured units (words,
sentences, paragraphs, blocks)</li>
<li><strong>Macros</strong>: Simple keystroke recording (<code>q</code>
register, <code>@</code> replay)</li>
</ol>
<p><strong>From Emacs to the World:</strong></p>
<ol type="1">
<li><strong>Self-documentation</strong>: Contextual help systems now
common</li>
<li><strong>Extension via full language</strong>: VSCode uses
JavaScript, Atom used CoffeeScript</li>
<li><strong>Syntax highlighting</strong>: Pioneered sophisticated,
customizable colorization</li>
<li><strong>Incremental search</strong>: Real-time feedback during
search</li>
<li><strong>Multiple buffers/windows</strong>: Tiled window
management</li>
<li><strong>Package management</strong>: Built-in package systems
(package.el ‚Üí modern equivalents)</li>
</ol>
<p><strong>Cross-Pollination:</strong></p>
<p>Modern editors borrow from both: - <strong>VSCode</strong>: Vim
keybindings extension (modal), but JavaScript extension API (Emacs
philosophy) - <strong>Kakoune/Helix</strong>: Modal editing but with
visible selection (hybrid approach) - <strong>Emacs evil-mode</strong>:
Full Vim emulation in Emacs (best of both?) - <strong>Neovim</strong>:
Lua API (lighter than Vimscript, more structured than original)</p>
<hr/>
<h2 data-number="26.3" id="modern-editors-vscode-sublime-text-atom"><span class="header-section-number">26.3</span> 2. Modern Editors: VSCode,
Sublime Text, Atom</h2>
<h3 data-number="26.3.1" id="the-new-generation-2008-2015"><span class="header-section-number">26.3.1</span> 2.1 The New Generation
(2008-2015)</h3>
<p>The late 2000s and early 2010s saw a new wave of editors designed for
modern development workflows, informed by decades of editor evolution
but unburdened by backward compatibility.</p>
<p><strong>Timeline:</strong> - <strong>Sublime Text</strong> (2008):
Proprietary, Python extensions, GPU-accelerated rendering -
<strong>Atom</strong> (2014): GitHub‚Äôs ‚Äúhackable‚Äù editor,
Electron-based, web technologies - <strong>VSCode</strong> (2015):
Microsoft‚Äôs open-source editor, TypeScript, Language Server Protocol</p>
<p>These editors learned from both Emacs and Vim but made different
architectural choices based on 2010s-era technologies and
expectations.</p>
<h3 data-number="26.3.2" id="extension-architecture-comparison"><span class="header-section-number">26.3.2</span> 2.2 Extension Architecture
Comparison</h3>
<p><strong>Emacs Extension Model:</strong></p>
<pre class="elisp"><code>;; Extensions run in same process, full access

(defun my-custom-command ()
  "Direct access to all Emacs internals."
  (interactive)
  ;; Can call any Emacs function
  (save-buffer)
  ;; Can modify any variable
  (setq fill-column 100)
  ;; Can redefine core functions
  (defadvice save-buffer (after my-save-hook activate)
    (message "Saved at %s" (current-time-string))))</code></pre>
<p><strong>VSCode Extension Model:</strong></p>
<div class="sourceCode" id="cb1054"><pre class="sourceCode typescript"><code class="sourceCode typescript"><span id="cb1054-1"><a aria-hidden="true" href="#cb1054-1" tabindex="-1"></a><span class="co">// Extensions run in separate process, controlled API</span></span>
<span id="cb1054-2"><a aria-hidden="true" href="#cb1054-2" tabindex="-1"></a></span>
<span id="cb1054-3"><a aria-hidden="true" href="#cb1054-3" tabindex="-1"></a><span class="im">import</span> <span class="op">*</span> <span class="im">as</span> vscode <span class="im">from</span> <span class="st">'vscode'</span><span class="op">;</span></span>
<span id="cb1054-4"><a aria-hidden="true" href="#cb1054-4" tabindex="-1"></a></span>
<span id="cb1054-5"><a aria-hidden="true" href="#cb1054-5" tabindex="-1"></a><span class="im">export</span> <span class="kw">function</span> <span class="fu">activate</span>(context<span class="op">:</span> vscode<span class="op">.</span><span class="at">ExtensionContext</span>) {</span>
<span id="cb1054-6"><a aria-hidden="true" href="#cb1054-6" tabindex="-1"></a>    <span class="co">// Limited to official Extension API</span></span>
<span id="cb1054-7"><a aria-hidden="true" href="#cb1054-7" tabindex="-1"></a>    <span class="kw">let</span> disposable <span class="op">=</span> vscode<span class="op">.</span><span class="at">commands</span><span class="op">.</span><span class="fu">registerCommand</span>(</span>
<span id="cb1054-8"><a aria-hidden="true" href="#cb1054-8" tabindex="-1"></a>        <span class="st">'extension.myCommand'</span><span class="op">,</span></span>
<span id="cb1054-9"><a aria-hidden="true" href="#cb1054-9" tabindex="-1"></a>        () <span class="kw">=&gt;</span> {</span>
<span id="cb1054-10"><a aria-hidden="true" href="#cb1054-10" tabindex="-1"></a>            <span class="co">// Can only use exposed APIs</span></span>
<span id="cb1054-11"><a aria-hidden="true" href="#cb1054-11" tabindex="-1"></a>            vscode<span class="op">.</span><span class="at">window</span><span class="op">.</span><span class="fu">showInformationMessage</span>(<span class="st">'Hello!'</span>)<span class="op">;</span></span>
<span id="cb1054-12"><a aria-hidden="true" href="#cb1054-12" tabindex="-1"></a>            <span class="co">// Cannot access internal implementation</span></span>
<span id="cb1054-13"><a aria-hidden="true" href="#cb1054-13" tabindex="-1"></a>        }</span>
<span id="cb1054-14"><a aria-hidden="true" href="#cb1054-14" tabindex="-1"></a>    )<span class="op">;</span></span>
<span id="cb1054-15"><a aria-hidden="true" href="#cb1054-15" tabindex="-1"></a></span>
<span id="cb1054-16"><a aria-hidden="true" href="#cb1054-16" tabindex="-1"></a>    context<span class="op">.</span><span class="at">subscriptions</span><span class="op">.</span><span class="fu">push</span>(disposable)<span class="op">;</span></span>
<span id="cb1054-17"><a aria-hidden="true" href="#cb1054-17" tabindex="-1"></a>}</span></code></pre></div>
<p><strong>Architectural Comparison:</strong></p>
<table>
<colgroup>
<col style="width: 21%"/>
<col style="width: 18%"/>
<col style="width: 21%"/>
<col style="width: 37%"/>
</colgroup>
<thead>
<tr>
<th>Aspect</th>
<th>Emacs</th>
<th>VSCode</th>
<th>Sublime Text</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Process Model</strong></td>
<td>Single process</td>
<td>Extension host process</td>
<td>Plugin host process</td>
</tr>
<tr>
<td><strong>API Boundary</strong></td>
<td>No boundary (full access)</td>
<td>Strict API, versioned</td>
<td>Python API, stable subset</td>
</tr>
<tr>
<td><strong>Extension Language</strong></td>
<td>Elisp (same as core)</td>
<td>JavaScript/TypeScript</td>
<td>Python</td>
</tr>
<tr>
<td><strong>Isolation</strong></td>
<td>None (extensions share state)</td>
<td>Process isolation</td>
<td>Some isolation</td>
</tr>
<tr>
<td><strong>Performance</strong></td>
<td>Direct function calls</td>
<td>IPC overhead</td>
<td>API calls</td>
</tr>
<tr>
<td><strong>Safety</strong></td>
<td>Caveat emptor</td>
<td>Sandboxed, restricted</td>
<td>Mostly sandboxed</td>
</tr>
<tr>
<td><strong>Power</strong></td>
<td>Unlimited</td>
<td>Limited to API</td>
<td>Limited to API</td>
</tr>
</tbody>
</table>
<p><strong>Tradeoff Analysis:</strong></p>
<p><strong>Emacs‚Äôs Approach: No Boundaries</strong></p>
<p><em>Benefits:</em> - Ultimate flexibility: modify any behavior - No
API limitations: if you can imagine it, you can code it - Simple mental
model: Elisp all the way down - No performance penalty for extension
calls</p>
<p><em>Costs:</em> - Extensions can break each other - No backward
compatibility guarantees for internals - Difficult to secure or sandbox
- Extension quality highly variable</p>
<p><strong>VSCode‚Äôs Approach: Strict API Boundary</strong></p>
<p><em>Benefits:</em> - Extensions cannot break core editor - Clean
upgrade path (API versioning) - Extensions can be partially trusted (run
in isolated process) - Consistent extension quality (API
constraints)</p>
<p><em>Costs:</em> - Extensions limited by API surface area - Some use
cases impossible (API doesn‚Äôt support it) - Performance overhead for IPC
- API expansion creates technical debt</p>
<p><strong>Lesson Learned:</strong> The API boundary question has no
perfect answer. Emacs chose maximum power at the cost of stability
guarantees. Modern editors chose stability at the cost of flexibility.
Each choice is defensible for its target audience.</p>
<h3 data-number="26.3.3" id="performance-characteristics-5"><span class="header-section-number">26.3.3</span> 2.3 Performance
Characteristics</h3>
<p><strong>Rendering Performance:</strong></p>
<p>Modern editors leverage decades of graphics optimization that didn‚Äôt
exist when Emacs was designed.</p>
<p><strong>Sublime Text‚Äôs Innovation:</strong> - Hardware-accelerated
rendering (GPU) - Immediate mode rendering (redraw everything each
frame) - Custom font rendering pipeline - Result: Smooth scrolling of
million-line files</p>
<p><strong>Emacs‚Äôs Approach:</strong> - Incremental redisplay (only
update changed regions) - Complex optimization heuristics
(try_window_id, etc.) - CPU-based rendering (though GTK+ uses GPU) -
Result: Efficient for typical files, struggles with huge files or rapid
scrolling</p>
<p><strong>Benchmarks (Indicative):</strong></p>
<table>
<thead>
<tr>
<th>Operation</th>
<th>Emacs</th>
<th>VSCode</th>
<th>Sublime</th>
</tr>
</thead>
<tbody>
<tr>
<td>Open 1MB file</td>
<td>200ms</td>
<td>150ms</td>
<td>50ms</td>
</tr>
<tr>
<td>Open 10MB file</td>
<td>2s</td>
<td>1.5s</td>
<td>500ms</td>
</tr>
<tr>
<td>Scroll through 100K lines</td>
<td>Janky</td>
<td>Smooth</td>
<td>Very smooth</td>
</tr>
<tr>
<td>Syntax highlight 10K line file</td>
<td>300ms</td>
<td>200ms</td>
<td>100ms</td>
</tr>
<tr>
<td>Find in 1000 files</td>
<td>5s</td>
<td>3s (ripgrep)</td>
<td>2s</td>
</tr>
</tbody>
</table>
<p><strong>Why the Difference?</strong></p>
<ol type="1">
<li><strong>Graphics Architecture:</strong>
<ul>
<li>Emacs: Designed for character-cell terminals, adapted to
graphics</li>
<li>Modern editors: Designed for GPUs from day one</li>
</ul></li>
<li><strong>Rendering Strategy:</strong>
<ul>
<li>Emacs: Optimize for not rendering (incremental updates)</li>
<li>Modern editors: Optimize for rendering everything fast (GPU)</li>
</ul></li>
<li><strong>File Handling:</strong>
<ul>
<li>Emacs: Load entire file into memory (gap buffer)</li>
<li>Sublime: Memory-mapped files, lazy loading</li>
<li>VSCode: Streaming for large files</li>
</ul></li>
<li><strong>Technical Debt:</strong>
<ul>
<li>Emacs: 40 years of backward compatibility</li>
<li>Modern editors: Clean slate, modern tooling</li>
</ul></li>
</ol>
<p><strong>Emacs‚Äôs Counter-Arguments:</strong></p>
<p>While Emacs may be slower at raw rendering, it often wins at
<em>workflow</em> speed: - Incremental search: See matches while typing
- Keyboard-centric: No mouse required for complex operations -
Integrated tools: No context switching to shell/browser -
Programmability: Automate complex workflows</p>
<p><strong>Example: Complex Refactoring Task</strong></p>
<p>VSCode approach: 1. Open ‚ÄúFind and Replace‚Äù dialog 2. Use regex:
<code>function (\w+)\(</code> ‚Üí <code>const $1 = (</code> 3. Review each
match 4. Click ‚ÄúReplace All‚Äù</p>
<p>Emacs approach:</p>
<pre class="elisp"><code>;; Write and execute immediately in *scratch*
(query-replace-regexp
  "function \\(\\w+\\)("
  "const \\1 = (")
;; Or record keyboard macro and replay
;; Or write custom function for project-specific needs</code></pre>
<p>The Emacs approach requires more expertise but enables: - Complex
transformations beyond regex - Project-specific customizations -
Reproducible, shareable solutions</p>
<h3 data-number="26.3.4" id="language-server-protocol-the-great-convergence"><span class="header-section-number">26.3.4</span> 2.4 Language Server
Protocol: The Great Convergence</h3>
<p><strong>Historical Context:</strong></p>
<p>Before LSP, every editor implemented its own language support: -
Emacs: CEDET, auto-complete, etags - Vim: ctags, YouCompleteMe -
Eclipse: JDT (Java Development Tools) - Visual Studio: Proprietary
C#/C++ engines</p>
<p>This led to fragmentation: excellent Java support in Eclipse,
excellent C# in Visual Studio, mediocre everything-else everywhere.</p>
<p><strong>Microsoft‚Äôs Innovation (2016):</strong></p>
<p>The Language Server Protocol separates: - <strong>Client</strong>:
Editor (any editor) - <strong>Server</strong>: Language intelligence
(one server per language)</p>
<pre><code>‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  VSCode  ‚îÇ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄJSON-RPC‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫‚îÇ   pyright    ‚îÇ
‚îÇ  Emacs   ‚îÇ                    ‚îÇ  (Python)    ‚îÇ
‚îÇ  Vim     ‚îÇ                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Editor  ‚îÇ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄJSON-RPC‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫‚îÇ   rust-      ‚îÇ
‚îÇ          ‚îÇ                    ‚îÇ   analyzer   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò</code></pre>
<p><strong>Protocol Features:</strong> - Go to definition - Find
references - Autocomplete - Hover documentation - Rename symbol -
Diagnostics (errors/warnings) - Formatting - Code actions
(refactorings)</p>
<p><strong>Adoption:</strong></p>
<table>
<thead>
<tr>
<th>Editor</th>
<th>LSP Client</th>
<th>Year</th>
</tr>
</thead>
<tbody>
<tr>
<td>VSCode</td>
<td>Built-in</td>
<td>2016</td>
</tr>
<tr>
<td>Emacs</td>
<td>lsp-mode</td>
<td>2017</td>
</tr>
<tr>
<td>Emacs</td>
<td>eglot (now built-in)</td>
<td>2018</td>
</tr>
<tr>
<td>Vim</td>
<td>vim-lsp, coc.nvim</td>
<td>2018</td>
</tr>
<tr>
<td>Neovim</td>
<td>Built-in</td>
<td>2021</td>
</tr>
<tr>
<td>Sublime</td>
<td>LSP package</td>
<td>2017</td>
</tr>
</tbody>
</table>
<p><strong>Impact on Emacs:</strong></p>
<p>LSP was a game-changer for Emacs because it:</p>
<ol type="1">
<li><strong>Solved the integration problem</strong>: One client (eglot)
works with all LSP servers</li>
<li><strong>Leveraged external investment</strong>: Use pyright
(Microsoft), rust-analyzer (Rust team), etc.</li>
<li><strong>Reduced maintenance burden</strong>: No need for
Emacs-specific language tools</li>
<li><strong>Improved quality</strong>: Language teams maintain their own
servers (better than editor-specific implementations)</li>
</ol>
<p><strong>Architectural Lesson:</strong></p>
<p>LSP represents a shift from ‚Äúeditor does everything‚Äù to ‚Äúeditor
orchestrates specialized tools.‚Äù This is actually very Unix-like:
composable tools communicating via standard protocols.</p>
<p>Emacs had to adapt: - <strong>Old model</strong>: Emacs-specific
tools (CEDET, semantic, etc.) - <strong>New model</strong>: Emacs as LSP
client, external servers</p>
<p>This demonstrates Emacs‚Äôs adaptability: despite being older, it could
adopt modern protocols and remain competitive.</p>
<h3 data-number="26.3.5" id="web-technology-integration"><span class="header-section-number">26.3.5</span> 2.5 Web Technology
Integration</h3>
<p><strong>Atom and Early VSCode:</strong></p>
<p>Both were built on Electron (Chromium + Node.js):</p>
<pre><code>‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ         Editor UI (HTML/CSS/JS)      ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ         Electron Framework           ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îÇ
‚îÇ  ‚îÇ Chromium   ‚îÇ  ‚îÇ  Node.js   ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ (Renderer) ‚îÇ  ‚îÇ  (Native)  ‚îÇ    ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò</code></pre>
<p><strong>Benefits:</strong> - Web developers can write extensions
(huge pool of developers) - Rich UI capabilities (HTML/CSS for
interfaces) - Cross-platform by default (Chromium runs everywhere) -
Rapid development (web technologies iterate fast)</p>
<p><strong>Costs:</strong> - Memory overhead (Chromium is heavy) -
Startup time (JavaScript engine initialization) - Performance ceiling
(JavaScript slower than native) - Resource usage (Electron apps often
use 200-500MB)</p>
<p><strong>VSCode‚Äôs Evolution:</strong></p>
<p>VSCode started as an Electron app but heavily optimized: - Native
text buffer (C++) - Web workers for extensions - Careful memory
management - Result: Performs better than ‚Äúnative‚Äù Electron baseline</p>
<p><strong>Emacs‚Äôs Position:</strong></p>
<p>Emacs never adopted web technologies for its core (though packages
exist for embedded browsers via xwidget). This represents a fundamental
philosophical difference:</p>
<p><strong>Emacs philosophy:</strong> - Terminal-first (works over SSH)
- Keyboard-centric (mouse optional) - Lightweight client (daemon mode) -
Local-first (works offline)</p>
<p><strong>Web-based editors philosophy:</strong> - GUI-first (mouse and
keyboard) - Rich visual feedback (animations, icons, colors) -
Cloud-ready (can run remotely) - Modern look (contemporary UI
expectations)</p>
<p><strong>Market Segmentation:</strong></p>
<p>The web-based approach attracted developers who wanted: - Familiar
web development skills - Modern aesthetics - Integrated terminals and
debuggers - Git GUI integration</p>
<p>Emacs retained developers who wanted: - Keyboard-driven workflows -
Terminal compatibility - Minimal resource usage - Offline-first
operation</p>
<h3 data-number="26.3.6" id="market-success-factors"><span class="header-section-number">26.3.6</span> 2.6 Market Success
Factors</h3>
<p><strong>VSCode‚Äôs Dominance (2025):</strong></p>
<p>VSCode achieved ~70% market share among professional developers
by:</p>
<ol type="1">
<li><strong>Free and open source</strong>: Lowered adoption barrier</li>
<li><strong>Microsoft backing</strong>: Resources for quality, polish,
marketing</li>
<li><strong>Extension marketplace</strong>: Easy discovery and
installation</li>
<li><strong>Integrated terminal</strong>: No need to switch to
shell</li>
<li><strong>Git integration</strong>: Visual diff, staging, commits</li>
<li><strong>Remote development</strong>: Edit files on
servers/containers/WSL</li>
<li><strong>Debugger integration</strong>: Visual debugging for many
languages</li>
<li><strong>IntelliSense</strong>: Excellent autocomplete via LSP</li>
<li><strong>Modern aesthetics</strong>: Looks contemporary, appeals to
new developers</li>
<li><strong>Low barrier to entry</strong>: Works well out of the
box</li>
</ol>
<p><strong>Sublime Text‚Äôs Niche:</strong></p>
<p>Sublime maintained a loyal following through: - Speed: Still the
fastest for very large files - Simplicity: No mandatory updates, offline
activation - Stability: Very reliable, rarely crashes - Performance:
Consistently snappy</p>
<p><strong>Atom‚Äôs Decline:</strong></p>
<p>Atom (discontinued 2022) struggled because: - Performance: Slower
than VSCode despite similar architecture - Microsoft focus: VSCode got
more investment from Microsoft - Extension ecosystem: Developers favored
VSCode - Unique value: Insufficient differentiation</p>
<p><strong>Emacs‚Äôs Persistence:</strong></p>
<p>Emacs retained its community through: - Sunk cost: Years of
configuration investment - Unique capabilities: Org-mode, Magit,
integration depth - Keyboard efficiency: Modal-like efficiency without
modes (evil-mode) - Programmability: Can customize anything -
Philosophy: Appeals to hacker culture - Stability: Config from 2010
often still works</p>
<p><strong>Lesson Learned:</strong> Market success in the 2020s
requires: - Low barrier to entry (works out of box) - Modern aesthetics
(appeals to new developers) - Corporate backing OR strong community -
Unique differentiation (why choose this over VSCode?)</p>
<p>Emacs survives by serving a niche that values deep customization over
immediate usability.</p>
<hr/>
<h2 data-number="26.4" id="integrated-development-environments-ides"><span class="header-section-number">26.4</span> 3. Integrated Development
Environments (IDEs)</h2>
<h3 data-number="26.4.1" id="philosophy-language-specific-vs.-language-agnostic"><span class="header-section-number">26.4.1</span> 3.1 Philosophy:
Language-Specific vs.¬†Language-Agnostic</h3>
<p><strong>IDE Philosophy (Visual Studio, IntelliJ, Eclipse):</strong> -
Optimized for specific languages/platforms - Deep semantic understanding
of code - Integrated debugging, profiling, deployment - Project-centric
workflow</p>
<p><strong>Emacs Philosophy:</strong> - Language-agnostic core, language
support via modes - General-purpose editor, programming as primary use
case - Extensible to support any language - Buffer/file-centric
workflow</p>
<p><strong>Architectural Implications:</strong></p>
<p><strong>IntelliJ IDEA for Java:</strong></p>
<pre><code>‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ    Java-Specific Intelligence      ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ  Full AST (Abstract Syntax  ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  Tree) in memory            ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ                              ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  Type inference engine       ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  Dataflow analysis          ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  Semantic highlighting      ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ         Refactoring Engine         ‚îÇ
‚îÇ  - Rename (with scope analysis)    ‚îÇ
‚îÇ  - Extract method                  ‚îÇ
‚îÇ  - Inline variable                 ‚îÇ
‚îÇ  - Change signature                ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ         Project Model              ‚îÇ
‚îÇ  - Dependencies (Maven/Gradle)     ‚îÇ
‚îÇ  - Build system integration        ‚îÇ
‚îÇ  - Test runner                     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò</code></pre>
<p><strong>Emacs for Java:</strong></p>
<pre><code>‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ        Generic Editor Core         ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ  Gap buffer (text storage)  ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  Syntax tables              ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  Generic modes              ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ         Language Support           ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ  java-mode (syntax)         ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  eglot + jdtls (LSP)        ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  dap-mode (debugging)       ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  projectile (projects)      ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò</code></pre>
<p><strong>Tradeoff:</strong></p>
<table>
<colgroup>
<col style="width: 40%"/>
<col style="width: 25%"/>
<col style="width: 35%"/>
</colgroup>
<thead>
<tr>
<th>Aspect</th>
<th>IDE</th>
<th>Emacs</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Java support quality</strong></td>
<td>Excellent, deeply integrated</td>
<td>Good, via LSP + extensions</td>
</tr>
<tr>
<td><strong>Python support quality</strong></td>
<td>Separate IDE (PyCharm)</td>
<td>Same editor, different mode</td>
</tr>
<tr>
<td><strong>Refactoring</strong></td>
<td>Semantically aware</td>
<td>Text-based or LSP-based</td>
</tr>
<tr>
<td><strong>Learning curve</strong></td>
<td>One per language</td>
<td>One editor for all</td>
</tr>
<tr>
<td><strong>Resource usage</strong></td>
<td>High (full analysis)</td>
<td>Lower (on-demand)</td>
</tr>
<tr>
<td><strong>Startup time</strong></td>
<td>Slow (index project)</td>
<td>Fast (lazy loading)</td>
</tr>
</tbody>
</table>
<h3 data-number="26.4.2" id="project-management-approaches"><span class="header-section-number">26.4.2</span> 3.2 Project Management
Approaches</h3>
<p><strong>IDE Project Model (IntelliJ):</strong></p>
<div class="sourceCode" id="cb1060"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb1060-1"><a aria-hidden="true" href="#cb1060-1" tabindex="-1"></a><span class="co">// IntelliJ maintains full project graph:</span></span>
<span id="cb1060-2"><a aria-hidden="true" href="#cb1060-2" tabindex="-1"></a><span class="co">// - Module dependencies</span></span>
<span id="cb1060-3"><a aria-hidden="true" href="#cb1060-3" tabindex="-1"></a><span class="co">// - Library versions</span></span>
<span id="cb1060-4"><a aria-hidden="true" href="#cb1060-4" tabindex="-1"></a><span class="co">// - Build system configuration</span></span>
<span id="cb1060-5"><a aria-hidden="true" href="#cb1060-5" tabindex="-1"></a><span class="co">// - Test configurations</span></span>
<span id="cb1060-6"><a aria-hidden="true" href="#cb1060-6" tabindex="-1"></a><span class="co">// - Run configurations</span></span>
<span id="cb1060-7"><a aria-hidden="true" href="#cb1060-7" tabindex="-1"></a><span class="co">// - Deployment targets</span></span>
<span id="cb1060-8"><a aria-hidden="true" href="#cb1060-8" tabindex="-1"></a></span>
<span id="cb1060-9"><a aria-hidden="true" href="#cb1060-9" tabindex="-1"></a>Project myProject</span>
<span id="cb1060-10"><a aria-hidden="true" href="#cb1060-10" tabindex="-1"></a>‚îú‚îÄ‚îÄ Module<span class="op">:</span> backend</span>
<span id="cb1060-11"><a aria-hidden="true" href="#cb1060-11" tabindex="-1"></a>‚îÇ   ‚îú‚îÄ‚îÄ Dependencies<span class="op">:</span> spring<span class="op">-</span>boot <span class="fl">3.0.0</span></span>
<span id="cb1060-12"><a aria-hidden="true" href="#cb1060-12" tabindex="-1"></a>‚îÇ   ‚îú‚îÄ‚îÄ <span class="bu">Source</span><span class="op">:</span> src<span class="op">/</span>main<span class="op">/</span>java</span>
<span id="cb1060-13"><a aria-hidden="true" href="#cb1060-13" tabindex="-1"></a>‚îÇ   ‚îú‚îÄ‚îÄ Tests<span class="op">:</span> src<span class="op">/</span>test<span class="op">/</span>java</span>
<span id="cb1060-14"><a aria-hidden="true" href="#cb1060-14" tabindex="-1"></a>‚îÇ   ‚îî‚îÄ‚îÄ Build<span class="op">:</span> Maven</span>
<span id="cb1060-15"><a aria-hidden="true" href="#cb1060-15" tabindex="-1"></a>‚îú‚îÄ‚îÄ Module<span class="op">:</span> frontend</span>
<span id="cb1060-16"><a aria-hidden="true" href="#cb1060-16" tabindex="-1"></a>‚îÇ   ‚îú‚îÄ‚îÄ Dependencies<span class="op">:</span> react <span class="fl">18.0.0</span></span>
<span id="cb1060-17"><a aria-hidden="true" href="#cb1060-17" tabindex="-1"></a>‚îÇ   ‚îú‚îÄ‚îÄ <span class="bu">Source</span><span class="op">:</span> src<span class="op">/</span></span>
<span id="cb1060-18"><a aria-hidden="true" href="#cb1060-18" tabindex="-1"></a>‚îÇ   ‚îî‚îÄ‚îÄ Build<span class="op">:</span> npm</span>
<span id="cb1060-19"><a aria-hidden="true" href="#cb1060-19" tabindex="-1"></a>‚îî‚îÄ‚îÄ <span class="bu">Configuration</span></span>
<span id="cb1060-20"><a aria-hidden="true" href="#cb1060-20" tabindex="-1"></a>    ‚îú‚îÄ‚îÄ Run<span class="op">:</span> Tomcat server</span>
<span id="cb1060-21"><a aria-hidden="true" href="#cb1060-21" tabindex="-1"></a>    ‚îú‚îÄ‚îÄ Debug<span class="op">:</span> <span class="bu">Remote</span> JVM</span>
<span id="cb1060-22"><a aria-hidden="true" href="#cb1060-22" tabindex="-1"></a>    ‚îî‚îÄ‚îÄ Deploy<span class="op">:</span> Docker</span></code></pre></div>
<p><strong>Emacs Project Approach:</strong></p>
<pre class="elisp"><code>;; Emacs infers project from directory structure
;; and version control

;; Project root = git/hg/svn root
(project-root (project-current))
;; ‚áí "/home/user/myproject/"

;; Find files in project
(project-find-file)  ; Uses completion

;; Search in project
(project-find-regexp "TODO")

;; Compile in project
(project-compile)  ; Runs make or configured command</code></pre>
<p><strong>Comparison:</strong></p>
<table>
<colgroup>
<col style="width: 42%"/>
<col style="width: 23%"/>
<col style="width: 33%"/>
</colgroup>
<thead>
<tr>
<th>Feature</th>
<th>IDE</th>
<th>Emacs</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Project Definition</strong></td>
<td>Explicit (.iml files, .project)</td>
<td>Implicit (VCS root)</td>
</tr>
<tr>
<td><strong>Dependencies</strong></td>
<td>Tracked, indexed, resolved</td>
<td>External (Maven, npm, etc.)</td>
</tr>
<tr>
<td><strong>Build System</strong></td>
<td>Integrated, visual</td>
<td>Shell command or mode</td>
</tr>
<tr>
<td><strong>Multi-module</strong></td>
<td>First-class support</td>
<td>Manual configuration</td>
</tr>
<tr>
<td><strong>Overhead</strong></td>
<td>High (index everything)</td>
<td>Low (discover on demand)</td>
</tr>
</tbody>
</table>
<p><strong>Use Case Suitability:</strong></p>
<p><strong>IDEs excel for:</strong> - Large, complex projects (thousands
of files) - Multi-module projects (microservices) - Heterogeneous builds
(Java + Kotlin + XML + SQL) - Team environments (standardized setup) -
Enterprise projects (complicated build processes)</p>
<p><strong>Emacs excels for:</strong> - Quick edits (no project indexing
delay) - Scripting languages (Python, Ruby, JavaScript) - Text files
(documentation, config) - Mixed workflows (edit code, write docs, check
mail) - Personal projects (custom setup per workflow)</p>
<h3 data-number="26.4.3" id="refactoring-capabilities"><span class="header-section-number">26.4.3</span> 3.3 Refactoring
Capabilities</h3>
<p><strong>IDE Strength: Semantic Refactoring</strong></p>
<p>IntelliJ‚Äôs ‚ÄúRename‚Äù refactoring:</p>
<div class="sourceCode" id="cb1062"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb1062-1"><a aria-hidden="true" href="#cb1062-1" tabindex="-1"></a><span class="co">// Before: cursor on 'oldName'</span></span>
<span id="cb1062-2"><a aria-hidden="true" href="#cb1062-2" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> UserService <span class="op">{</span></span>
<span id="cb1062-3"><a aria-hidden="true" href="#cb1062-3" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">oldName</span><span class="op">(</span>User user<span class="op">)</span> <span class="op">{</span>  <span class="co">// ‚Üê Cursor here</span></span>
<span id="cb1062-4"><a aria-hidden="true" href="#cb1062-4" tabindex="-1"></a>        <span class="co">// ...</span></span>
<span id="cb1062-5"><a aria-hidden="true" href="#cb1062-5" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb1062-6"><a aria-hidden="true" href="#cb1062-6" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb1062-7"><a aria-hidden="true" href="#cb1062-7" tabindex="-1"></a></span>
<span id="cb1062-8"><a aria-hidden="true" href="#cb1062-8" tabindex="-1"></a><span class="co">// After: "Rename Method" refactoring</span></span>
<span id="cb1062-9"><a aria-hidden="true" href="#cb1062-9" tabindex="-1"></a><span class="co">// - Renames method definition</span></span>
<span id="cb1062-10"><a aria-hidden="true" href="#cb1062-10" tabindex="-1"></a><span class="co">// - Renames all call sites</span></span>
<span id="cb1062-11"><a aria-hidden="true" href="#cb1062-11" tabindex="-1"></a><span class="co">// - Updates tests</span></span>
<span id="cb1062-12"><a aria-hidden="true" href="#cb1062-12" tabindex="-1"></a><span class="co">// - Updates documentation comments</span></span>
<span id="cb1062-13"><a aria-hidden="true" href="#cb1062-13" tabindex="-1"></a><span class="co">// - Respects scope (doesn't rename unrelated 'oldName')</span></span></code></pre></div>
<p><strong>How it works:</strong> 1. Parse entire codebase to AST 2.
Build semantic graph (definitions, references) 3. Find all references to
symbol 4. Update all references atomically 5. Preserve code structure
and formatting</p>
<p><strong>Emacs Approach: Text + Heuristics + LSP</strong></p>
<pre class="elisp"><code>;; Traditional Emacs: regexp-based
(query-replace-regexp "\\boldName\\b" "newName")

;; Modern Emacs: LSP-based
(eglot-rename "newName")  ; Uses LSP server for semantic awareness</code></pre>
<p><strong>LSP rename workflow:</strong> 1. Ask language server for
rename locations 2. Server performs semantic analysis 3. Returns
WorkspaceEdit with all changes 4. Emacs applies changes to open buffers
5. User reviews and confirms</p>
<p><strong>Comparison:</strong></p>
<table>
<thead>
<tr>
<th>Refactoring</th>
<th>IDE</th>
<th>Emacs (LSP)</th>
<th>Emacs (Traditional)</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Rename</strong></td>
<td>Full semantic</td>
<td>LSP server dependent</td>
<td>Text-based</td>
</tr>
<tr>
<td><strong>Extract Method</strong></td>
<td>Semantic</td>
<td>Some LSP servers</td>
<td>Keyboard macros</td>
</tr>
<tr>
<td><strong>Inline Variable</strong></td>
<td>Semantic</td>
<td>Some LSP servers</td>
<td>Manual</td>
</tr>
<tr>
<td><strong>Change Signature</strong></td>
<td>Semantic</td>
<td>Rare in LSP</td>
<td>Manual</td>
</tr>
<tr>
<td><strong>Move Class</strong></td>
<td>Semantic</td>
<td>Manual</td>
<td>Manual</td>
</tr>
<tr>
<td><strong>Safe Delete</strong></td>
<td>With usage search</td>
<td>Manual</td>
<td>Manual</td>
</tr>
</tbody>
</table>
<p><strong>Lesson Learned:</strong></p>
<p>Refactoring quality correlates with semantic understanding. IDEs
invest heavily in language-specific analysis; Emacs relies on external
tools (LSP servers) or text manipulation.</p>
<p>For heavy refactoring (large Java codebases), IDEs win decisively.
For light editing (scripting, configuration, prose), Emacs‚Äôs flexibility
wins.</p>
<h3 data-number="26.4.4" id="debugging-integration"><span class="header-section-number">26.4.4</span> 3.4 Debugging
Integration</h3>
<p><strong>Visual Studio Debugger (Native):</strong></p>
<div class="sourceCode" id="cb1064"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb1064-1"><a aria-hidden="true" href="#cb1064-1" tabindex="-1"></a><span class="co">// Integrated debugging with full GUI:</span></span>
<span id="cb1064-2"><a aria-hidden="true" href="#cb1064-2" tabindex="-1"></a><span class="co">// - Visual breakpoints</span></span>
<span id="cb1064-3"><a aria-hidden="true" href="#cb1064-3" tabindex="-1"></a><span class="co">// - Watch windows</span></span>
<span id="cb1064-4"><a aria-hidden="true" href="#cb1064-4" tabindex="-1"></a><span class="co">// - Call stack visualization</span></span>
<span id="cb1064-5"><a aria-hidden="true" href="#cb1064-5" tabindex="-1"></a><span class="co">// - Memory inspection</span></span>
<span id="cb1064-6"><a aria-hidden="true" href="#cb1064-6" tabindex="-1"></a><span class="co">// - Disassembly view</span></span>
<span id="cb1064-7"><a aria-hidden="true" href="#cb1064-7" tabindex="-1"></a><span class="co">// - Performance profiler</span></span>
<span id="cb1064-8"><a aria-hidden="true" href="#cb1064-8" tabindex="-1"></a></span>
<span id="cb1064-9"><a aria-hidden="true" href="#cb1064-9" tabindex="-1"></a><span class="dt">int</span> factorial<span class="op">(</span><span class="dt">int</span> n<span class="op">)</span> <span class="op">{</span></span>
<span id="cb1064-10"><a aria-hidden="true" href="#cb1064-10" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>n <span class="op">&lt;=</span> <span class="dv">1</span><span class="op">)</span> <span class="cf">return</span> <span class="dv">1</span><span class="op">;</span>  <span class="co">// ‚Üê Breakpoint (red dot)</span></span>
<span id="cb1064-11"><a aria-hidden="true" href="#cb1064-11" tabindex="-1"></a>    <span class="cf">return</span> n <span class="op">*</span> factorial<span class="op">(</span>n <span class="op">-</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb1064-12"><a aria-hidden="true" href="#cb1064-12" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb1064-13"><a aria-hidden="true" href="#cb1064-13" tabindex="-1"></a></span>
<span id="cb1064-14"><a aria-hidden="true" href="#cb1064-14" tabindex="-1"></a><span class="co">// Debugger shows:</span></span>
<span id="cb1064-15"><a aria-hidden="true" href="#cb1064-15" tabindex="-1"></a><span class="co">// - Current line (yellow arrow)</span></span>
<span id="cb1064-16"><a aria-hidden="true" href="#cb1064-16" tabindex="-1"></a><span class="co">// - Variable values (hover)</span></span>
<span id="cb1064-17"><a aria-hidden="true" href="#cb1064-17" tabindex="-1"></a><span class="co">// - Call stack (window)</span></span>
<span id="cb1064-18"><a aria-hidden="true" href="#cb1064-18" tabindex="-1"></a><span class="co">// - Watches (custom expressions)</span></span></code></pre></div>
<p><strong>Emacs Debugging:</strong></p>
<pre class="elisp"><code>;; Elisp debugging: edebug (integrated)
(defun factorial (n)
  (if (&lt;= n 1)
      1
    (* n (factorial (- n 1)))))

;; Enable debugging:
(edebug-defun)  ; M-x edebug-defun

;; Step through with keyboard:
;; SPC - step
;; g   - go (run to next breakpoint)
;; b   - set breakpoint
;; q   - quit debugger</code></pre>
<div class="sourceCode" id="cb1066"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb1066-1"><a aria-hidden="true" href="#cb1066-1" tabindex="-1"></a><span class="co"># Python debugging: dap-mode + debugpy</span></span>
<span id="cb1066-2"><a aria-hidden="true" href="#cb1066-2" tabindex="-1"></a><span class="co"># GUI-like experience in Emacs</span></span>
<span id="cb1066-3"><a aria-hidden="true" href="#cb1066-3" tabindex="-1"></a></span>
<span id="cb1066-4"><a aria-hidden="true" href="#cb1066-4" tabindex="-1"></a><span class="kw">def</span> factorial(n):</span>
<span id="cb1066-5"><a aria-hidden="true" href="#cb1066-5" tabindex="-1"></a>    <span class="cf">if</span> n <span class="op">&lt;=</span> <span class="dv">1</span>:</span>
<span id="cb1066-6"><a aria-hidden="true" href="#cb1066-6" tabindex="-1"></a>        <span class="cf">return</span> <span class="dv">1</span>  <span class="co"># ‚Üê Breakpoint (via dap-mode)</span></span>
<span id="cb1066-7"><a aria-hidden="true" href="#cb1066-7" tabindex="-1"></a>    <span class="cf">return</span> n <span class="op">*</span> factorial(n <span class="op">-</span> <span class="dv">1</span>)</span>
<span id="cb1066-8"><a aria-hidden="true" href="#cb1066-8" tabindex="-1"></a></span>
<span id="cb1066-9"><a aria-hidden="true" href="#cb1066-9" tabindex="-1"></a><span class="co"># Emacs shows:</span></span>
<span id="cb1066-10"><a aria-hidden="true" href="#cb1066-10" tabindex="-1"></a><span class="co"># - Breakpoint markers</span></span>
<span id="cb1066-11"><a aria-hidden="true" href="#cb1066-11" tabindex="-1"></a><span class="co"># - Local variables panel</span></span>
<span id="cb1066-12"><a aria-hidden="true" href="#cb1066-12" tabindex="-1"></a><span class="co"># - Call stack panel</span></span>
<span id="cb1066-13"><a aria-hidden="true" href="#cb1066-13" tabindex="-1"></a><span class="co"># - Debug console (REPL)</span></span></code></pre></div>
<p><strong>Debugging Comparison:</strong></p>
<table>
<colgroup>
<col style="width: 15%"/>
<col style="width: 23%"/>
<col style="width: 16%"/>
<col style="width: 22%"/>
<col style="width: 22%"/>
</colgroup>
<thead>
<tr>
<th>Feature</th>
<th>Visual Studio</th>
<th>IntelliJ</th>
<th>Emacs (GUD)</th>
<th>Emacs (DAP)</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Visual breakpoints</strong></td>
<td>‚úì</td>
<td>‚úì</td>
<td>‚úì (text-based)</td>
<td>‚úì</td>
</tr>
<tr>
<td><strong>Variable inspection</strong></td>
<td>Rich GUI</td>
<td>Rich GUI</td>
<td>Text output</td>
<td>Panel</td>
</tr>
<tr>
<td><strong>Call stack</strong></td>
<td>Visual tree</td>
<td>Visual tree</td>
<td>Text list</td>
<td>Panel</td>
</tr>
<tr>
<td><strong>Watches</strong></td>
<td>Dedicated window</td>
<td>Dedicated window</td>
<td>Manual</td>
<td>Panel</td>
</tr>
<tr>
<td><strong>Step debugging</strong></td>
<td>Click or F10</td>
<td>Click or F8</td>
<td>GDB commands</td>
<td>Click or key</td>
</tr>
<tr>
<td><strong>Hot reload</strong></td>
<td>C# supports</td>
<td>Java supports</td>
<td>Depends</td>
<td>Depends</td>
</tr>
<tr>
<td><strong>Memory inspection</strong></td>
<td>Visual tools</td>
<td>Visual tools</td>
<td>GDB commands</td>
<td>Limited</td>
</tr>
</tbody>
</table>
<p><strong>Architectural Difference:</strong></p>
<p>IDEs build debugging deeply into the experience: - Breakpoints are
persistent (saved with project) - Debug perspective (dedicated layout) -
Visual profiler (flamegraphs, timelines) - Integrated testing (debug
tests directly)</p>
<p>Emacs wraps external debuggers: - GUD (Grand Unified Debugger):
wrapper for gdb, pdb, jdb, etc. - DAP (Debug Adapter Protocol): Like LSP
but for debugging - Edebug: Native Elisp debugger (excellent)</p>
<p><strong>Lesson Learned:</strong></p>
<p>Debugging is where language-specific IDEs shine brightest. Years of
investment in debugging infrastructure pay off in productivity.</p>
<p>Emacs‚Äôs approach works but requires: - External debuggers (gdb, pdb,
etc.) - Protocol adapters (DAP servers) - User configuration</p>
<p>For debugging-heavy workflows (C++ systems programming, Java
enterprise), IDEs provide superior experience. For scripting languages
or when debugging is occasional, Emacs is adequate.</p>
<h3 data-number="26.4.5" id="emacss-unique-strengths-vs.-ides"><span class="header-section-number">26.4.5</span> 3.5 Emacs‚Äôs Unique Strengths
vs.¬†IDEs</h3>
<p>Despite IDEs‚Äô advantages in refactoring and debugging, Emacs offers
unique capabilities:</p>
<p><strong>1. Org Mode (No IDE Equivalent)</strong></p>
<div class="sourceCode" id="cb1067"><pre class="sourceCode org"><code class="sourceCode orgmode"><span id="cb1067-1"><a aria-hidden="true" href="#cb1067-1" tabindex="-1"></a><span class="fu">* Project Planning</span></span>
<span id="cb1067-2"><a aria-hidden="true" href="#cb1067-2" tabindex="-1"></a><span class="fu">** </span><span class="al">TODO</span><span class="fu"> Implement user authentication</span></span>
<span id="cb1067-3"><a aria-hidden="true" href="#cb1067-3" tabindex="-1"></a>   DEADLINE: &lt;2025-11-25&gt;</span>
<span id="cb1067-4"><a aria-hidden="true" href="#cb1067-4" tabindex="-1"></a></span>
<span id="cb1067-5"><a aria-hidden="true" href="#cb1067-5" tabindex="-1"></a><span class="fu">** </span><span class="in">DONE</span><span class="fu"> Design database schema</span></span>
<span id="cb1067-6"><a aria-hidden="true" href="#cb1067-6" tabindex="-1"></a>   CLOSED: <span class="ot">[2025-11-18</span>]</span>
<span id="cb1067-7"><a aria-hidden="true" href="#cb1067-7" tabindex="-1"></a></span>
<span id="cb1067-8"><a aria-hidden="true" href="#cb1067-8" tabindex="-1"></a><span class="fu">* Code Block Execution</span></span>
<span id="cb1067-9"><a aria-hidden="true" href="#cb1067-9" tabindex="-1"></a>#+begin_src python :results output</span>
<span id="cb1067-10"><a aria-hidden="true" href="#cb1067-10" tabindex="-1"></a>import pandas as pd</span>
<span id="cb1067-11"><a aria-hidden="true" href="#cb1067-11" tabindex="-1"></a>data = pd.read_csv('users.csv')</span>
<span id="cb1067-12"><a aria-hidden="true" href="#cb1067-12" tabindex="-1"></a>print(data.describe())</span>
<span id="cb1067-13"><a aria-hidden="true" href="#cb1067-13" tabindex="-1"></a>#+end_src</span>
<span id="cb1067-14"><a aria-hidden="true" href="#cb1067-14" tabindex="-1"></a></span>
<span id="cb1067-15"><a aria-hidden="true" href="#cb1067-15" tabindex="-1"></a><span class="pp">#+RESULTS:</span></span>
<span id="cb1067-16"><a aria-hidden="true" href="#cb1067-16" tabindex="-1"></a>:        age  account_balance</span>
<span id="cb1067-17"><a aria-hidden="true" href="#cb1067-17" tabindex="-1"></a>: count  1000      1000</span>
<span id="cb1067-18"><a aria-hidden="true" href="#cb1067-18" tabindex="-1"></a>: mean   35.2      5234.56</span>
<span id="cb1067-19"><a aria-hidden="true" href="#cb1067-19" tabindex="-1"></a>: ...</span></code></pre></div>
<p>Org-mode provides: - Project planning and task tracking - Literate
programming (code + documentation) - Export to HTML, LaTeX, PDF - Agenda
views across multiple files - Capture templates for quick notes</p>
<p><strong>No IDE offers comparable integrated project management and
documentation.</strong></p>
<p><strong>2. Magit (Best Git Interface, Period)</strong></p>
<pre><code>Status buffer:
Head:     main Branch main
Merge:    origin/main
Unstaged: modified README.md
          modified src/main.c
Staged:   new file tests/test_auth.c

Commands:
s - stage
u - unstage
c - commit
P - push
F - pull</code></pre>
<p>Magit provides: - Visual staging (hunk-by-hunk or line-by-line) -
Interactive rebasing - Commit history navigation - Blame annotations -
Branch management</p>
<p>Even developers who prefer IDEs often use Emacs just for Magit.</p>
<p><strong>3. Universal Interface</strong></p>
<p>Emacs treats everything as text buffers: - Source code - Shell output
- Compilation errors (clickable) - Git logs - File listings -
Documentation - Emails - Org files - Terminals</p>
<p>This uniformity enables: - Same keybindings everywhere - Same
search/navigation everywhere - Easy scripting (manipulate buffers) - No
context switching</p>
<p><strong>Example Workflow:</strong></p>
<pre class="elisp"><code>;; In Emacs, everything is a buffer:

;; Edit code
(find-file "src/main.c")

;; Compile (output in *compilation* buffer)
(compile "make")

;; Click error to jump to line

;; Run program (output in *shell* buffer)
(shell-command "./program")

;; Search output
(isearch-forward)

;; Email colleague (in *mail* buffer)
(compose-mail "colleague@example.com")

;; All in one application, same keybindings</code></pre>
<h3 data-number="26.4.6" id="when-to-choose-what"><span class="header-section-number">26.4.6</span> 3.6 When to Choose What</h3>
<p><strong>Choose an IDE (IntelliJ, Visual Studio, Eclipse)
when:</strong> - Working on large projects (100K+ lines) - Heavy
refactoring is frequent - Debugging is complex (multithreading,
distributed systems) - Team uses standardized setup - Language has
excellent IDE support (Java, C#, Kotlin) - GUI design is part of
workflow (Android, WPF) - Build system is complex (multi-module,
heterogeneous)</p>
<p><strong>Choose Emacs when:</strong> - Working across many
languages/file types - Customization is important (workflow
optimization) - Remote work via SSH (terminal-based editing) -
Keyboard-centric workflow preferred - Org-mode for project management -
Long-form writing (LaTeX, Markdown, documentation) - Scripting and
automation are common - Resource constraints (older hardware,
containers)</p>
<p><strong>Hybrid Approach:</strong></p>
<p>Many developers use both: - IDE for main development (Java, C#, large
projects) - Emacs for config files, scripts, documentation, git (Magit)
- IDE for debugging, Emacs for editing - Emacs for remote servers, IDE
for local development</p>
<hr/>
<h2 data-number="26.5" id="cloud-editors-and-remote-development"><span class="header-section-number">26.5</span> 4. Cloud Editors and Remote
Development</h2>
<h3 data-number="26.5.1" id="the-shift-to-remote-computing"><span class="header-section-number">26.5.1</span> 4.1 The Shift to Remote
Computing</h3>
<p><strong>Traditional Model (Local Editing):</strong></p>
<pre><code>‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Developer's PC   ‚îÇ
‚îÇ                   ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ  Emacs     ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ            ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚Üê edits ‚Üí ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ            ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  Local     ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  Files     ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò</code></pre>
<p><strong>Cloud Model (Remote Editing):</strong></p>
<pre><code>‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Developer's PC   ‚îÇ         ‚îÇ   Cloud Server      ‚îÇ
‚îÇ                   ‚îÇ         ‚îÇ                     ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ         ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ  Browser   ‚îÇ  ‚îÇ ‚Üê‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚Üí‚îÇ  Code Server ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  (VSCode)  ‚îÇ  ‚îÇ  HTTPS  ‚îÇ  ‚îÇ  (VSCode)    ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ         ‚îÇ  ‚îÇ              ‚îÇ  ‚îÇ
‚îÇ                   ‚îÇ         ‚îÇ  ‚îÇ  Remote      ‚îÇ  ‚îÇ
‚îÇ                   ‚îÇ         ‚îÇ  ‚îÇ  Files       ‚îÇ  ‚îÇ
‚îÇ                   ‚îÇ         ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò</code></pre>
<h3 data-number="26.5.2" id="cloud-editor-solutions"><span class="header-section-number">26.5.2</span> 4.2 Cloud Editor
Solutions</h3>
<p><strong>GitHub Codespaces (2020):</strong> - VSCode in browser -
Docker container per project - Full Linux environment - Integrated with
GitHub repositories - Pay per compute hour</p>
<p><strong>Gitpod (2020):</strong> - Similar to Codespaces - Works with
GitHub, GitLab, Bitbucket - Automated dev environments (declarative
configuration) - Free tier available</p>
<p><strong>Replit (2016):</strong> - Collaborative coding in browser -
Educational focus - Instant deployment - Language-agnostic</p>
<p><strong>cloud9 / AWS Cloud9 (2010/2016):</strong> - Amazon-owned -
Integrated with AWS services - Full IDE in browser - Lambda function
development</p>
<h3 data-number="26.5.3" id="local-vs.-remote-the-fundamental-tradeoff"><span class="header-section-number">26.5.3</span> 4.3 Local vs.¬†Remote: The
Fundamental Tradeoff</h3>
<p><strong>Advantages of Remote (Cloud Editors):</strong></p>
<ol type="1">
<li><strong>Environment Consistency</strong>
<ul>
<li>Everyone on team has identical setup</li>
<li>No ‚Äúworks on my machine‚Äù problems</li>
<li>Declarative configuration (Dockerfile, .gitpod.yml)</li>
</ul></li>
<li><strong>Powerful Compute</strong>
<ul>
<li>Use server-class hardware for compilation</li>
<li>Run resource-intensive tools (indexing, analysis)</li>
<li>Cheap thin clients (Chromebooks work great)</li>
</ul></li>
<li><strong>Instant Onboarding</strong>
<ul>
<li>New developer can start coding in minutes</li>
<li>No local setup required</li>
<li>Click link ‚Üí coding environment ready</li>
</ul></li>
<li><strong>Security</strong>
<ul>
<li>Code never leaves server</li>
<li>Reduced data exfiltration risk</li>
<li>Centralized access control</li>
</ul></li>
<li><strong>Collaboration</strong>
<ul>
<li>Live pair programming (shared cursors)</li>
<li>Real-time code review</li>
<li>Instant screen sharing</li>
</ul></li>
</ol>
<p><strong>Advantages of Local (Emacs, Traditional IDEs):</strong></p>
<ol type="1">
<li><strong>Offline Work</strong>
<ul>
<li>No internet required</li>
<li>Work on airplane, train, remote locations</li>
<li>No latency issues</li>
</ul></li>
<li><strong>Privacy</strong>
<ul>
<li>Code stays on your machine</li>
<li>No cloud provider has access</li>
<li>Compliance with data regulations</li>
</ul></li>
<li><strong>Performance</strong>
<ul>
<li>No network latency for keystrokes</li>
<li>Local files = instant access</li>
<li>No bandwidth constraints</li>
</ul></li>
<li><strong>Cost</strong>
<ul>
<li>One-time hardware purchase</li>
<li>No subscription fees</li>
<li>No per-hour charges</li>
</ul></li>
<li><strong>Customization</strong>
<ul>
<li>Full control over environment</li>
<li>Install any tools</li>
<li>No sandbox restrictions</li>
</ul></li>
</ol>
<p><strong>Emacs‚Äôs Position:</strong></p>
<p>Emacs is fundamentally <strong>local-first</strong> but supports
remote work via:</p>
<pre><code>‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Developer's PC   ‚îÇ         ‚îÇ   Remote Server     ‚îÇ
‚îÇ                   ‚îÇ         ‚îÇ                     ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ         ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ  Emacs     ‚îÇ  ‚îÇ ‚Üê‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚Üí‚îÇ  Files        ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ            ‚îÇ  ‚îÇ   SSH   ‚îÇ  ‚îÇ  (via TRAMP)  ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  (Local)   ‚îÇ  ‚îÇ   or    ‚îÇ  ‚îÇ               ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ            ‚îÇ  ‚îÇ  rsync  ‚îÇ  ‚îÇ  OR           ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ         ‚îÇ  ‚îÇ  Emacs        ‚îÇ  ‚îÇ
‚îÇ                   ‚îÇ         ‚îÇ  ‚îÇ  (Terminal)   ‚îÇ  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò</code></pre>
<p><strong>Three Remote Models for Emacs:</strong></p>
<ol type="1">
<li><p><strong>TRAMP (Transparent Remote Access, Multiple
Protocols)</strong></p>
<pre class="elisp"><code>;; Edit remote file as if local
(find-file "/ssh:user@server:/path/to/file")

;; Works with sudo, docker, kubernetes:
(find-file "/docker:container:/app/config")
(find-file "/sudo:root@localhost:/etc/hosts")</code></pre></li>
<li><p><strong>Emacs in Terminal over SSH</strong></p>
<div class="sourceCode" id="cb1074"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb1074-1"><a aria-hidden="true" href="#cb1074-1" tabindex="-1"></a><span class="fu">ssh</span> server</span>
<span id="cb1074-2"><a aria-hidden="true" href="#cb1074-2" tabindex="-1"></a><span class="ex">emacs</span> <span class="at">-nw</span> file.txt  <span class="co"># Terminal mode</span></span>
<span id="cb1074-3"><a aria-hidden="true" href="#cb1074-3" tabindex="-1"></a><span class="co"># Or use existing daemon:</span></span>
<span id="cb1074-4"><a aria-hidden="true" href="#cb1074-4" tabindex="-1"></a><span class="ex">emacsclient</span> <span class="at">-nw</span> file.txt</span></code></pre></div></li>
<li><p><strong>X11 Forwarding (GUI over SSH)</strong></p>
<div class="sourceCode" id="cb1075"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb1075-1"><a aria-hidden="true" href="#cb1075-1" tabindex="-1"></a><span class="fu">ssh</span> <span class="at">-X</span> server</span>
<span id="cb1075-2"><a aria-hidden="true" href="#cb1075-2" tabindex="-1"></a><span class="ex">emacs</span> file.txt  <span class="co"># GUI forwarded to local display</span></span></code></pre></div></li>
</ol>
<p><strong>Comparison:</strong></p>
<table>
<colgroup>
<col style="width: 27%"/>
<col style="width: 25%"/>
<col style="width: 27%"/>
<col style="width: 19%"/>
</colgroup>
<thead>
<tr>
<th>Approach</th>
<th>Latency</th>
<th>Features</th>
<th>Setup</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Codespaces</strong></td>
<td>Web latency</td>
<td>Full VSCode</td>
<td>Click link</td>
</tr>
<tr>
<td><strong>TRAMP</strong></td>
<td>Moderate</td>
<td>Full Emacs, local</td>
<td>Configure SSH</td>
</tr>
<tr>
<td><strong>SSH + Terminal Emacs</strong></td>
<td>Low (terminal)</td>
<td>Full Emacs, remote</td>
<td>SSH access</td>
</tr>
<tr>
<td><strong>X11 Forwarding</strong></td>
<td>High (graphics)</td>
<td>Full Emacs, remote GUI</td>
<td>X11 setup</td>
</tr>
</tbody>
</table>
<h3 data-number="26.5.4" id="collaboration-features"><span class="header-section-number">26.5.4</span> 4.4 Collaboration
Features</h3>
<p><strong>Cloud Editors‚Äô Strength: Real-Time Collaboration</strong></p>
<pre><code>GitHub Codespaces Live Share:
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Developer A        ‚îÇ         ‚îÇ  Developer B        ‚îÇ
‚îÇ                     ‚îÇ         ‚îÇ                     ‚îÇ
‚îÇ  Cursor position: ‚óè‚îÇ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§ Sees A's cursor: ‚óè  ‚îÇ
‚îÇ  Line 42           ‚îÇ         ‚îÇ  Line 42            ‚îÇ
‚îÇ                     ‚îÇ         ‚îÇ                     ‚îÇ
‚îÇ  Edits in real-time‚îÇ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫‚îÇ Sees edits live     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò</code></pre>
<p>Features: - Shared cursors (see where collaborators are) - Real-time
edits (see changes as typed) - Shared terminal (run commands together) -
Shared debugger (debug together) - Voice/video integration (some
platforms)</p>
<p><strong>Emacs Collaboration:</strong></p>
<p>Emacs‚Äôs collaboration is less integrated but exists:</p>
<ol type="1">
<li><strong>Rudel (Collaborative Editing)</strong>
<ul>
<li>Emacs package for collaborative editing</li>
<li>Protocol: Obby or custom</li>
<li>Relatively unmaintained</li>
</ul></li>
<li><strong>CRDT (Conflict-Free Replicated Data Type)</strong>
<ul>
<li>Modern collaborative editing for Emacs</li>
<li>Peer-to-peer synchronization</li>
<li>Active development</li>
</ul></li>
<li><strong>Traditional Screen Sharing</strong>
<ul>
<li>tmux + shared session</li>
<li>Traditional pair programming</li>
<li>One person types, others watch</li>
</ul></li>
</ol>
<p><strong>Realistic Assessment:</strong></p>
<p>For real-time collaboration, cloud editors (Codespaces, Gitpod) beat
Emacs decisively. The web platform makes this natural; desktop editors
require complex synchronization.</p>
<p>However, many ‚Äúcollaboration‚Äù scenarios don‚Äôt need real-time editing:
- Code review (use Magit + Forge) - Async discussion (comments, PRs) -
Knowledge sharing (documentation)</p>
<h3 data-number="26.5.5" id="resource-models"><span class="header-section-number">26.5.5</span> 4.5 Resource Models</h3>
<p><strong>Cloud Editors: Pay for Compute</strong></p>
<pre><code>GitHub Codespaces Pricing (2025):
- 2 cores, 4GB RAM:  $0.18/hour
- 4 cores, 8GB RAM:  $0.36/hour
- 8 cores, 16GB RAM: $0.72/hour
- 16 cores, 32GB RAM: $1.44/hour

Storage: $0.07/GB/month

Typical costs:
- Light use (20h/month): ~$7/month
- Medium use (160h/month): ~$58/month
- Heavy use (full-time): ~$288/month</code></pre>
<p><strong>Local Editors: Pay for Hardware</strong></p>
<pre><code>Developer Laptop (2025):
- MacBook Pro M3: $2000-4000
- High-end Linux laptop: $1500-3000
- Gaming laptop for development: $1200-2500

Lifespan: 3-5 years
Effective monthly cost: $30-100/month</code></pre>
<p><strong>Tradeoffs:</strong></p>
<table>
<colgroup>
<col style="width: 36%"/>
<col style="width: 31%"/>
<col style="width: 31%"/>
</colgroup>
<thead>
<tr>
<th>Aspect</th>
<th>Cloud</th>
<th>Local</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Upfront cost</strong></td>
<td>None</td>
<td>High ($1500+)</td>
</tr>
<tr>
<td><strong>Monthly cost</strong></td>
<td>Usage-based ($0-300)</td>
<td>Electricity (~$5)</td>
</tr>
<tr>
<td><strong>Scaling</strong></td>
<td>Instant (click button)</td>
<td>Impossible (buy new laptop)</td>
</tr>
<tr>
<td><strong>Portability</strong></td>
<td>Perfect (browser anywhere)</td>
<td>Limited (carry laptop)</td>
</tr>
<tr>
<td><strong>Privacy</strong></td>
<td>Shared infrastructure</td>
<td>Fully private</td>
</tr>
<tr>
<td><strong>Offline</strong></td>
<td>Impossible</td>
<td>Fully functional</td>
</tr>
</tbody>
</table>
<p><strong>Emacs‚Äôs Advantage:</strong></p>
<p>Emacs runs on anything: - 10-year-old laptops (still fast enough) -
Raspberry Pi (ARM support) - Android phones (termux + emacs) - Cloud
servers (terminal mode) - Docker containers (minimal overhead)</p>
<p>This flexibility means: - Low hardware requirements (cheap hardware
works) - Long hardware lifespan (no forced upgrades) - Flexible
deployment (local or remote)</p>
<h3 data-number="26.5.6" id="the-future-hybrid-models"><span class="header-section-number">26.5.6</span> 4.6 The Future: Hybrid
Models</h3>
<p><strong>Emerging Pattern: Best of Both</strong></p>
<p>Modern developers use hybrid approaches:</p>
<pre><code>‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ         Developer Workflow             ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ Local Development                      ‚îÇ
‚îÇ  - Quick edits (Emacs/Vim)            ‚îÇ
‚îÇ  - Git operations (Magit)             ‚îÇ
‚îÇ  - Documentation (Org-mode)           ‚îÇ
‚îÇ                                        ‚îÇ
‚îÇ Cloud Development                      ‚îÇ
‚îÇ  - Large builds (GitHub Actions)      ‚îÇ
‚îÇ  - Testing (cloud CI/CD)              ‚îÇ
‚îÇ  - Collaboration (Codespaces)         ‚îÇ
‚îÇ                                        ‚îÇ
‚îÇ Remote Files                           ‚îÇ
‚îÇ  - Edit via TRAMP (Emacs)             ‚îÇ
‚îÇ  - Edit via Remote SSH (VSCode)       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò</code></pre>
<p><strong>VSCode‚Äôs Innovation: Remote Development</strong></p>
<p>VSCode‚Äôs ‚ÄúRemote - SSH‚Äù extension: - VSCode UI runs locally -
Extension host runs on server - Feels local, but files/compute are
remote - Best of both worlds?</p>
<p><strong>Emacs Equivalent:</strong></p>
<pre class="elisp"><code>;; TRAMP provides similar functionality
(setq tramp-default-method "ssh")
(find-file "/ssh:server:/project/file.c")

;; Or run Emacs server on remote:
# On server:
emacs --daemon

# On local:
emacsclient -nw -s server:/path/to/file</code></pre>
<hr/>
<h2 data-number="26.6" id="historical-editors-learning-from-lineage"><span class="header-section-number">26.6</span> 5. Historical Editors:
Learning from Lineage</h2>
<h3 data-number="26.6.1" id="teco-the-primordial-text-editor"><span class="header-section-number">26.6.1</span> 5.1 TECO: The Primordial
Text Editor</h3>
<p><strong>TECO (Text Editor and COrrector, 1962-1990s)</strong></p>
<p>TECO wasn‚Äôt an editor in the modern sense‚Äîit was a <strong>text
processing language</strong> that could be used to edit text.</p>
<p><strong>Example TECO Program:</strong></p>
<pre class="teco"><code>!Delete all blank lines!
&lt;                       ! Start loop !
  .-Z;                 ! Exit if at end of buffer !
  &lt;                    ! Inner loop: skip non-blank lines !
    -L                 ! Back one line !
    .-B;               ! Exit if at beginning !
    0A-32"E 0K'        ! If line starts with space, kill it !
  &gt;
  L                    ! Forward one line !
&gt;</code></pre>
<p><strong>Characteristics:</strong> - Write-only syntax (notoriously
cryptic) - Powerful text manipulation - No visual feedback (batch
processing) - Turing-complete</p>
<p><strong>Original EMACS (1976):</strong></p>
<p>Stallman‚Äôs breakthrough was creating EMACS as a collection of TECO
macros that provided <strong>real-time editing</strong>:</p>
<pre class="teco"><code>!EMACS Command: Delete Word!
!Macro: M-D (Meta-D)!
&lt;                       ! Loop !
  .+1U0                ! Save position+1 in register 0 !
  0A-32"E D'           ! If space, delete !
  0A-65"G 0A-122"L D' ! If lowercase letter, delete !
  Q0-.;                ! If position unchanged, exit !
&gt;</code></pre>
<p><strong>What Emacs Inherited from TECO:</strong> - Concept of
‚Äúcommands‚Äù bound to keys - Extensibility (TECO macros ‚Üí Elisp functions)
- Buffer-based editing - Powerful text manipulation</p>
<p><strong>What Emacs Discarded:</strong> - Write-only syntax (Lisp is
readable) - Batch processing (real-time editing) - No visual feedback
(immediate screen updates)</p>
<h3 data-number="26.6.2" id="eine-and-zwei-lisp-machine-emacs"><span class="header-section-number">26.6.2</span> 5.2 EINE and ZWEI: Lisp
Machine EMACS</h3>
<p><strong>EINE (EINE Is Not EMACS, 1977)</strong></p>
<p>Written by Daniel Weinreb and Mike McMahon for Lisp Machines:</p>
<div class="sourceCode" id="cb1083"><pre class="sourceCode lisp"><code class="sourceCode commonlisp"><span id="cb1083-1"><a aria-hidden="true" href="#cb1083-1" tabindex="-1"></a><span class="co">;;; EINE: First Lisp-based EMACS</span></span>
<span id="cb1083-2"><a aria-hidden="true" href="#cb1083-2" tabindex="-1"></a></span>
<span id="cb1083-3"><a aria-hidden="true" href="#cb1083-3" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> delete-word </span>()</span>
<span id="cb1083-4"><a aria-hidden="true" href="#cb1083-4" tabindex="-1"></a>  <span class="st">"Delete from point to end of word."</span></span>
<span id="cb1083-5"><a aria-hidden="true" href="#cb1083-5" tabindex="-1"></a>  (<span class="kw">let</span> ((start (point)))</span>
<span id="cb1083-6"><a aria-hidden="true" href="#cb1083-6" tabindex="-1"></a>    (forward-word <span class="dv">1</span>)</span>
<span id="cb1083-7"><a aria-hidden="true" href="#cb1083-7" tabindex="-1"></a>    (delete-region start (point))))</span>
<span id="cb1083-8"><a aria-hidden="true" href="#cb1083-8" tabindex="-1"></a></span>
<span id="cb1083-9"><a aria-hidden="true" href="#cb1083-9" tabindex="-1"></a>(define-key *global-map* <span class="ch">#\M</span>eta-D <span class="dt">'delete-word</span>)</span></code></pre></div>
<p><strong>Innovations:</strong> - Written entirely in Lisp (not
extending another editor) - Object-oriented design (CLOS precursors) -
Integrated with Lisp environment - Multiple windows/frames</p>
<p><strong>ZWEI (Zwei Was EINE Initially, 1979)</strong></p>
<p>Successor to EINE, more sophisticated:</p>
<div class="sourceCode" id="cb1084"><pre class="sourceCode lisp"><code class="sourceCode commonlisp"><span id="cb1084-1"><a aria-hidden="true" href="#cb1084-1" tabindex="-1"></a><span class="co">;;; ZWEI: Object-oriented editor architecture</span></span>
<span id="cb1084-2"><a aria-hidden="true" href="#cb1084-2" tabindex="-1"></a></span>
<span id="cb1084-3"><a aria-hidden="true" href="#cb1084-3" tabindex="-1"></a>(<span class="kw">defclass</span><span class="fu"> editor-buffer </span>()</span>
<span id="cb1084-4"><a aria-hidden="true" href="#cb1084-4" tabindex="-1"></a>  ((name :accessor buffer-name)</span>
<span id="cb1084-5"><a aria-hidden="true" href="#cb1084-5" tabindex="-1"></a>   (contents :accessor buffer-contents)</span>
<span id="cb1084-6"><a aria-hidden="true" href="#cb1084-6" tabindex="-1"></a>   (point :accessor buffer-point)</span>
<span id="cb1084-7"><a aria-hidden="true" href="#cb1084-7" tabindex="-1"></a>   (mark :accessor buffer-mark)))</span>
<span id="cb1084-8"><a aria-hidden="true" href="#cb1084-8" tabindex="-1"></a></span>
<span id="cb1084-9"><a aria-hidden="true" href="#cb1084-9" tabindex="-1"></a>(<span class="kw">defmethod</span><span class="fu"> insert-char </span>((buffer editor-buffer) <span class="kw">char</span>)</span>
<span id="cb1084-10"><a aria-hidden="true" href="#cb1084-10" tabindex="-1"></a>  (<span class="kw">vector-push-extend</span> <span class="kw">char</span> (buffer-contents buffer))</span>
<span id="cb1084-11"><a aria-hidden="true" href="#cb1084-11" tabindex="-1"></a>  (<span class="kw">incf</span> (buffer-point buffer)))</span></code></pre></div>
<p><strong>What GNU Emacs Learned:</strong> - Lisp is ideal for editor
extension - Buffers as first-class objects - Window management concepts
- Self-documenting commands</p>
<p><strong>What GNU Emacs Did Differently:</strong> - Portable (not tied
to Lisp Machines) - C core for performance - Broader audience (Unix, not
just Lisp hackers)</p>
<h3 data-number="26.6.3" id="gosling-emacs-the-unix-compromise"><span class="header-section-number">26.6.3</span> 5.3 Gosling Emacs: The Unix
Compromise</h3>
<p><strong>Gosling Emacs (1981)</strong></p>
<p>Written by James Gosling (later creator of Java) for Unix:</p>
<div class="sourceCode" id="cb1085"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb1085-1"><a aria-hidden="true" href="#cb1085-1" tabindex="-1"></a><span class="co">/* Gosling Emacs: C editor with Mocklisp extension language */</span></span>
<span id="cb1085-2"><a aria-hidden="true" href="#cb1085-2" tabindex="-1"></a></span>
<span id="cb1085-3"><a aria-hidden="true" href="#cb1085-3" tabindex="-1"></a><span class="co">/* Core in C */</span></span>
<span id="cb1085-4"><a aria-hidden="true" href="#cb1085-4" tabindex="-1"></a><span class="dt">void</span> delete_word<span class="op">()</span> <span class="op">{</span></span>
<span id="cb1085-5"><a aria-hidden="true" href="#cb1085-5" tabindex="-1"></a>    <span class="dt">int</span> start <span class="op">=</span> point<span class="op">;</span></span>
<span id="cb1085-6"><a aria-hidden="true" href="#cb1085-6" tabindex="-1"></a>    forward_word<span class="op">();</span></span>
<span id="cb1085-7"><a aria-hidden="true" href="#cb1085-7" tabindex="-1"></a>    delete_region<span class="op">(</span>start<span class="op">,</span> point<span class="op">);</span></span>
<span id="cb1085-8"><a aria-hidden="true" href="#cb1085-8" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb1085-9"><a aria-hidden="true" href="#cb1085-9" tabindex="-1"></a></span>
<span id="cb1085-10"><a aria-hidden="true" href="#cb1085-10" tabindex="-1"></a><span class="co">/* Extension in Mocklisp (Lisp-like but not real Lisp) */</span></span>
<span id="cb1085-11"><a aria-hidden="true" href="#cb1085-11" tabindex="-1"></a><span class="op">(</span>defun search<span class="op">-</span>and<span class="op">-</span>replace <span class="op">(</span>old new<span class="op">)</span></span>
<span id="cb1085-12"><a aria-hidden="true" href="#cb1085-12" tabindex="-1"></a>  <span class="op">(</span>beginning<span class="op">-</span>of<span class="op">-</span>buffer<span class="op">)</span></span>
<span id="cb1085-13"><a aria-hidden="true" href="#cb1085-13" tabindex="-1"></a>  <span class="op">(</span><span class="cf">while</span> <span class="op">(</span>search<span class="op">-</span>forward old<span class="op">)</span></span>
<span id="cb1085-14"><a aria-hidden="true" href="#cb1085-14" tabindex="-1"></a>    <span class="op">(</span>replace<span class="op">-</span>match new<span class="op">)))</span></span></code></pre></div>
<p><strong>Mocklisp:</strong> - Lisp-like syntax - Not a real Lisp (no
first-class functions, limited data structures) - Performance-oriented
(compiled to bytecode) - Good enough for editor extensions</p>
<p><strong>Why Gosling Emacs Failed:</strong> - Licensing issues (later
made proprietary) - Mocklisp too limited for sophisticated extensions -
GNU Emacs offered full Lisp power</p>
<p><strong>What GNU Emacs Learned:</strong> - C core is necessary for
Unix portability - Extension language must be powerful, not just
Lisp-flavored - Free software licensing matters</p>
<h3 data-number="26.6.4" id="multics-emacs-multi-user-editing"><span class="header-section-number">26.6.4</span> 5.4 Multics Emacs:
Multi-User Editing</h3>
<p><strong>Multics Emacs (1978)</strong></p>
<p>EMACS implementation for Multics operating system:</p>
<pre class="pli"><code>/* Multics Emacs: PL/I with Emacs Lisp extension */

/* Unique feature: Multi-user editing */
DECLARE BUFFER_LOCK LOCK;

EDIT_BUFFER: PROCEDURE;
  /* Acquire lock on buffer */
  CALL LOCK_BUFFER(BUFFER_LOCK);

  /* Edit operations */
  CALL INSERT_TEXT("Hello");

  /* Release lock */
  CALL UNLOCK_BUFFER(BUFFER_LOCK);
END EDIT_BUFFER;</code></pre>
<p><strong>Innovations:</strong> - Multi-user editing (concurrent access
to files) - Locking mechanisms - Integrated with Multics security</p>
<p><strong>What Wasn‚Äôt Preserved:</strong> - Multi-user editing (too
complex, limited use case) - Multics-specific features (platform
died)</p>
<p><strong>Lesson:</strong> Not every innovation survives. Multi-user
editing proved less important than individual productivity.</p>
<h3 data-number="26.6.5" id="evolution-timeline-what-was-preserved"><span class="header-section-number">26.6.5</span> 5.5 Evolution Timeline: What
Was Preserved</h3>
<pre><code>1962: TECO
  ‚Üì
  Preserved: Extensibility, buffer concept
  Discarded: Cryptic syntax, batch processing
  ‚Üì
1976: TECO EMACS (Original)
  ‚Üì
  Preserved: Real-time editing, self-documentation
  Discarded: TECO dependency
  ‚Üì
1977-1979: EINE/ZWEI (Lisp Machine)
  ‚Üì
  Preserved: Lisp as extension language, buffer/window model
  Discarded: Lisp Machine dependency
  ‚Üì
1981: Gosling Emacs (Unix)
  ‚Üì
  Preserved: Unix portability, C core
  Discarded: Mocklisp (too limited), proprietary licensing
  ‚Üì
1985: GNU Emacs
  ‚Üì
  Synthesis: C core + full Lisp + Unix + free software
  ‚Üì
2025: Modern Emacs
  Additions: GUI, Unicode, LSP, tree-sitter, native compilation</code></pre>
<h3 data-number="26.6.6" id="architectural-lessons-from-history"><span class="header-section-number">26.6.6</span> 5.6 Architectural Lessons
from History</h3>
<p><strong>1. Extension Language Matters</strong></p>
<ul>
<li><strong>TECO</strong>: Too cryptic, limited audience</li>
<li><strong>Mocklisp</strong>: Too limited, couldn‚Äôt grow</li>
<li><strong>Elisp</strong>: Just right‚Äîpowerful enough, accessible
enough</li>
</ul>
<p><strong>Lesson:</strong> Extension language should be a real
programming language, not a limited scripting language. It will grow
beyond original intentions.</p>
<p><strong>2. Portability is Survival</strong></p>
<ul>
<li><strong>TECO</strong>: Died with PDP-10</li>
<li><strong>EINE/ZWEI</strong>: Died with Lisp Machines</li>
<li><strong>Multics Emacs</strong>: Died with Multics</li>
<li><strong>GNU Emacs</strong>: Survived by being portable (Unix,
Windows, macOS, Android)</li>
</ul>
<p><strong>Lesson:</strong> Platform independence is essential for
longevity. Abstracting platform-specific code pays off.</p>
<p><strong>3. Openness Wins</strong></p>
<ul>
<li><strong>Gosling Emacs</strong>: Became proprietary, abandoned</li>
<li><strong>GNU Emacs</strong>: Stayed free, thrived</li>
</ul>
<p><strong>Lesson:</strong> For developer tools, open source creates
network effects (shared extensions, knowledge, bug fixes).</p>
<p><strong>4. Backward Compatibility Enables Growth</strong></p>
<p>GNU Emacs maintained compatibility across 40 years: - Elisp from
1990s often still works - Configuration files rarely break - Users can
upgrade gradually</p>
<p><strong>Lesson:</strong> Breaking changes lose users. Deprecation
with warnings is better than removal.</p>
<p><strong>5. Complexity Must Be Optional</strong></p>
<ul>
<li><strong>Minimal Emacs</strong>: Works out of box,
<code>emacs -Q</code></li>
<li><strong>Configured Emacs</strong>: Users gradually add features</li>
<li><strong>Maximal Emacs</strong>: Org, Magit, Gnus, calc,
everything</li>
</ul>
<p><strong>Lesson:</strong> Power users should get power; beginners
should get simplicity. Layered complexity works.</p>
<hr/>
<h2 data-number="26.7" id="cross-cutting-lessons-and-insights"><span class="header-section-number">26.7</span> 6. Cross-Cutting Lessons and
Insights</h2>
<h3 data-number="26.7.1" id="the-extensibility-performance-tradeoff"><span class="header-section-number">26.7.1</span> 6.1 The
Extensibility-Performance Tradeoff</h3>
<p><strong>Spectrum of Approaches:</strong></p>
<pre><code>Less Extensible                                    More Extensible
Less Powerful                                      More Powerful
‚îÇ                                                              ‚îÇ
‚îÇ                                                              ‚îÇ
Nano ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Vim ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Sublime ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ VSCode ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Emacs
    ‚îÇ           ‚îÇ           ‚îÇ             ‚îÇ            ‚îÇ
    Simple      Modal       API           JavaScript   Lisp
    Fast        Vimscript   Restricted    Full access  Full access</code></pre>
<p><strong>Key Insight:</strong> There‚Äôs no free lunch. More
extensibility requires: - Runtime overhead (interpreter, API layer) -
Security considerations (sandboxing vs.¬†trust) - Complexity management
(extension conflicts)</p>
<p>Modern editors try to mitigate this: - <strong>VSCode</strong>:
Process isolation (safety) + comprehensive API (power) -
<strong>Emacs</strong>: No isolation (performance) + unlimited access
(power) - <strong>Vim</strong>: Minimal core (performance) + scripting
(flexibility)</p>
<p><strong>Best Practice from Each:</strong></p>
<ul>
<li><strong>Emacs</strong>: Trust users, give full access, document
everything</li>
<li><strong>VSCode</strong>: Protect core, version API, isolate
extensions</li>
<li><strong>Vim</strong>: Keep core minimal, let users add what they
need</li>
</ul>
<h3 data-number="26.7.2" id="the-keyboard-vs.-mouse-paradigm"><span class="header-section-number">26.7.2</span> 6.2 The Keyboard vs.¬†Mouse
Paradigm</h3>
<p><strong>Historical Context:</strong></p>
<p>Emacs and Vi predate the mouse (1970s). Modern editors assume mouse +
keyboard (2000s+).</p>
<p><strong>Implications:</strong></p>
<table>
<colgroup>
<col style="width: 19%"/>
<col style="width: 42%"/>
<col style="width: 38%"/>
</colgroup>
<thead>
<tr>
<th>Aspect</th>
<th>Keyboard-Centric</th>
<th>Mouse-Friendly</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Discovery</strong></td>
<td>Self-documentation, menus</td>
<td>Visual cues, tooltips</td>
</tr>
<tr>
<td><strong>Speed</strong></td>
<td>Fast (hands stay on keyboard)</td>
<td>Moderate (hand movement)</td>
</tr>
<tr>
<td><strong>Complexity</strong></td>
<td>High (memorize keybindings)</td>
<td>Low (see options)</td>
</tr>
<tr>
<td><strong>Accessibility</strong></td>
<td>Screen reader friendly</td>
<td>Requires pointing device</td>
</tr>
<tr>
<td><strong>Remote</strong></td>
<td>Works over SSH (terminal)</td>
<td>Requires graphical forwarding</td>
</tr>
</tbody>
</table>
<p><strong>Modern Hybrid:</strong></p>
<p>Best editors support both: - Keyboard for power users (efficiency) -
Mouse for discoverability (learning)</p>
<p>VSCode excels at this: - Command palette (keyboard,
<code>Ctrl+Shift+P</code>) - Context menus (mouse, right-click) -
Keybinding editor (GUI for customization)</p>
<p>Emacs supports both but keyboard-first: - Menu bar (mouse, mostly for
discovery) - Key bindings (primary interface) - <code>M-x</code>
(command by name)</p>
<p><strong>Lesson:</strong> Neither paradigm is obsolete. Support both,
optimize for your primary audience.</p>
<h3 data-number="26.7.3" id="the-monolith-vs.-microservices-debate"><span class="header-section-number">26.7.3</span> 6.3 The Monolith
vs.¬†Microservices Debate</h3>
<p><strong>Editor Architecture Spectrum:</strong></p>
<p><strong>Monolithic (Emacs):</strong></p>
<pre><code>‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ         Single Process          ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ  Editor Core             ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  Language Modes          ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  Extensions              ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  All in Elisp            ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò</code></pre>
<p><strong>Microservices (Modern):</strong></p>
<pre><code>‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Editor   ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫‚îÇ Language     ‚îÇ
‚îÇ Core     ‚îÇ     ‚îÇ Server (LSP) ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
     ‚îÇ
     ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
     ‚îÇ          ‚îÇ Debugger     ‚îÇ
     ‚îÇ          ‚îÇ (DAP)        ‚îÇ
     ‚îÇ          ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
     ‚îÇ
     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                ‚îÇ Formatter    ‚îÇ
                ‚îÇ (external)   ‚îÇ
                ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò</code></pre>
<p><strong>Tradeoffs:</strong></p>
<table>
<thead>
<tr>
<th>Aspect</th>
<th>Monolithic</th>
<th>Microservices</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Integration</strong></td>
<td>Tight, seamless</td>
<td>Requires protocols</td>
</tr>
<tr>
<td><strong>Reusability</strong></td>
<td>Extensions Emacs-specific</td>
<td>Tools editor-agnostic</td>
</tr>
<tr>
<td><strong>Performance</strong></td>
<td>Fast (in-process)</td>
<td>IPC overhead</td>
</tr>
<tr>
<td><strong>Reliability</strong></td>
<td>Crash affects everything</td>
<td>Isolation limits damage</td>
</tr>
<tr>
<td><strong>Development</strong></td>
<td>One language</td>
<td>Multiple languages/teams</td>
</tr>
</tbody>
</table>
<p><strong>Hybrid Approach (Modern Emacs):</strong></p>
<p>Emacs now does both: - <strong>Monolithic</strong>: Traditional Elisp
packages (Magit, Org-mode) - <strong>Microservices</strong>: LSP
servers, DAP debuggers, external formatters</p>
<p>This hybrid captures benefits of both: - Tight integration where it
matters (core editing) - External tools where reusability matters
(language support)</p>
<p><strong>Lesson:</strong> Monolith vs.¬†microservices isn‚Äôt binary. Use
the right architecture for each component.</p>
<h3 data-number="26.7.4" id="the-documentation-philosophy"><span class="header-section-number">26.7.4</span> 6.4 The Documentation
Philosophy</h3>
<p><strong>Emacs: Self-Documenting</strong> - Every function has
docstring - <code>C-h f</code> describes function - <code>C-h v</code>
describes variable - Source code is one click away - Inline discovery
(no external docs needed)</p>
<p><strong>Modern Editors: External Documentation</strong> - Official
docs (website) - Community tutorials (YouTube, blogs) - Stack Overflow -
Extension marketplaces - Built-in ‚Äúgetting started‚Äù guides</p>
<p><strong>Comparison:</strong></p>
<table>
<colgroup>
<col style="width: 30%"/>
<col style="width: 33%"/>
<col style="width: 36%"/>
</colgroup>
<thead>
<tr>
<th>Approach</th>
<th>Strengths</th>
<th>Weaknesses</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Self-documenting</strong></td>
<td>Always accurate, contextual, offline</td>
<td>Requires editor knowledge to use</td>
</tr>
<tr>
<td><strong>External docs</strong></td>
<td>Rich (videos, images), beginner-friendly</td>
<td>Can become outdated, requires internet</td>
</tr>
</tbody>
</table>
<p><strong>Best of Both:</strong></p>
<p>Modern Emacs packages combine approaches: - Docstrings
(self-documenting) - READMEs (external, GitHub) - Wiki pages (community
knowledge) - Videos (complex workflows)</p>
<p><strong>Lesson:</strong> Self-documentation scales with expertise.
External docs lower entry barrier. Provide both.</p>
<h3 data-number="26.7.5" id="the-configuration-explosion-problem"><span class="header-section-number">26.7.5</span> 6.5 The Configuration
Explosion Problem</h3>
<p><strong>Every extensible editor faces this:</strong></p>
<p>Users start simple, accumulate configuration, eventually have
unmaintainable mess.</p>
<p><strong>Emacs init.el Evolution:</strong></p>
<pre class="elisp"><code>;; Year 1: Simple
(setq inhibit-startup-screen t)
(global-linum-mode 1)

;; Year 5: Growing
(require 'package)
(add-to-list 'package-archives '("melpa" . "..."))
(package-initialize)
(unless (package-installed-p 'use-package)
  (package-install 'use-package))
;; ... 50 more lines ...

;; Year 10: Chaos
;; ... 1000 lines of accumulated configuration
;; ... copy-pasted snippets from Stack Overflow
;; ... half-understood code
;; ... conflicts and workarounds
;; ... fear of changing anything</code></pre>
<p><strong>Solutions Emerged:</strong></p>
<ol type="1">
<li><p><strong>use-package (Emacs)</strong>: Declarative package
configuration</p>
<pre class="elisp"><code>(use-package magit
  :ensure t
  :bind ("C-x g" . magit-status)
  :config
  (setq magit-display-buffer-function
        #'magit-display-buffer-fullframe-status-v1))</code></pre></li>
<li><p><strong>Doom Emacs / Spacemacs</strong>: Curated
distributions</p>
<ul>
<li>Pre-configured Emacs with sensible defaults</li>
<li>Modular (enable/disable features)</li>
<li>Maintained by community</li>
</ul></li>
<li><p><strong>VSCode Settings Sync</strong>: Cloud-based sync</p>
<ul>
<li>Settings stored in Microsoft account</li>
<li>Sync across machines</li>
<li>Less customization needed (good defaults)</li>
</ul></li>
</ol>
<p><strong>Lesson:</strong> Extensibility creates configuration debt.
Provide: - Good defaults (works well without configuration) -
Declarative configuration (use-package model) - Curated distributions
(opinionated bundles) - Sync mechanisms (portability across
machines)</p>
<h3 data-number="26.7.6" id="why-users-choose-one-over-another"><span class="header-section-number">26.7.6</span> 6.6 Why Users Choose One
Over Another</h3>
<p><strong>Real-World Decision Factors (2025):</strong></p>
<p><strong>Choose Emacs if:</strong> - You value keyboard efficiency
over discoverability - You want to customize <em>everything</em> - You
use Org-mode (no substitute) - You do remote development over SSH
frequently - You appreciate Lisp and functional programming - You‚Äôre
willing to invest time in learning - You want one tool for code +
writing + organization + email</p>
<p><strong>Choose VSCode if:</strong> - You want modern UI with minimal
configuration - You value ecosystem (largest extension marketplace) -
You need remote development (Remote SSH, Codespaces) - You prefer mouse
+ keyboard hybrid - You want integrated Git GUI - You need debugging for
multiple languages - You want beginner-friendly experience</p>
<p><strong>Choose IntelliJ/IDE if:</strong> - You work primarily in one
language (Java, Kotlin, etc.) - You need heavy refactoring tools - You
value semantic code analysis - You work on large codebases (100K+ lines)
- Your team standardizes on it - You need integrated build system
support</p>
<p><strong>Choose Vim/Neovim if:</strong> - You value modal editing
efficiency - You need minimal resource usage - You work frequently on
servers (via SSH) - You prefer minimalism and speed - You‚Äôre comfortable
with configuration - You want fast startup for quick edits</p>
<p><strong>The Pragmatic Approach:</strong></p>
<p>Many developers use multiple: - VSCode for main development (modern,
batteries-included) - Emacs for writing (Org-mode), git (Magit), config
files - Vim for server administration (quick edits, always installed) -
IDE for language-specific heavy lifting (Java in IntelliJ)</p>
<p><strong>Lesson:</strong> Editor choice is tribal, but pragmatism
wins. Use the best tool for each job.</p>
<hr/>
<h2 data-number="26.8" id="the-future-convergence-and-divergence"><span class="header-section-number">26.8</span> 7. The Future: Convergence and
Divergence</h2>
<h3 data-number="26.8.1" id="convergent-evolution-1"><span class="header-section-number">26.8.1</span> 7.1 Convergent
Evolution</h3>
<p><strong>Editors are converging on certain patterns:</strong></p>
<ol type="1">
<li><strong>LSP Adoption</strong>: Universal
<ul>
<li>Emacs: eglot (built-in as of 29)</li>
<li>VSCode: Built-in</li>
<li>Vim/Neovim: Multiple clients</li>
<li>Sublime: LSP package</li>
</ul></li>
<li><strong>Tree-sitter Parsing</strong>: Growing
<ul>
<li>Emacs: Built-in as of 29</li>
<li>Neovim: Built-in</li>
<li>Helix: Built-in</li>
<li>Provides: Fast, incremental, error-tolerant parsing</li>
</ul></li>
<li><strong>Remote Development</strong>: Standard
<ul>
<li>VSCode: Remote SSH, Codespaces</li>
<li>Emacs: TRAMP, terminal mode</li>
<li>Cloud editors: Native</li>
</ul></li>
<li><strong>Extension Marketplaces</strong>: Common
<ul>
<li>VSCode: Marketplace (web-based)</li>
<li>Emacs: MELPA, ELPA (package-list-packages)</li>
<li>Vim: Vim Awesome, plugin managers</li>
</ul></li>
<li><strong>Git Integration</strong>: Expected
<ul>
<li>Emacs: Magit (best-in-class)</li>
<li>VSCode: Source Control panel</li>
<li>IntelliJ: Git tooling</li>
<li>Integrated diff/blame/staging</li>
</ul></li>
</ol>
<p><strong>Lesson:</strong> Best ideas propagate across editors.
Standards (LSP, DAP, tree-sitter) accelerate this.</p>
<h3 data-number="26.8.2" id="persistent-differences-1"><span class="header-section-number">26.8.2</span> 7.2 Persistent
Differences</h3>
<p><strong>Some differences are philosophical and won‚Äôt
converge:</strong></p>
<ol type="1">
<li><strong>Extensibility Model</strong>
<ul>
<li>Emacs: Full access, Lisp</li>
<li>VSCode: Controlled API, JavaScript</li>
<li>Likely to remain different (different tradeoffs)</li>
</ul></li>
<li><strong>UI Philosophy</strong>
<ul>
<li>Emacs: Keyboard-first, text-based possible</li>
<li>Modern editors: GUI-first, keyboard shortcuts secondary</li>
<li>Reflects different user preferences</li>
</ul></li>
<li><strong>Resource Usage</strong>
<ul>
<li>Emacs: Can run on minimal hardware</li>
<li>Electron-based: Requires more resources</li>
<li>Different optimization targets</li>
</ul></li>
<li><strong>Offline Capability</strong>
<ul>
<li>Emacs: Fully offline</li>
<li>Cloud editors: Require internet</li>
<li>Fundamentally different architectures</li>
</ul></li>
</ol>
<h3 data-number="26.8.3" id="what-emacs-can-learn-from-others"><span class="header-section-number">26.8.3</span> 7.3 What Emacs Can Learn
from Others</h3>
<p><strong>From Modern Editors:</strong> 1. <strong>Better
defaults</strong>: Emacs 29+ improving (CUA bindings optional, better
UI) 2. <strong>Discovery mechanisms</strong>: Better help for beginners
3. <strong>Visual customization</strong>: GUI for settings (Custom
interface exists but underused) 4. <strong>Project templates</strong>:
Quick project setup 5. <strong>Integrated terminal</strong>: Eat mode,
vterm improve this</p>
<p><strong>From IDEs:</strong> 1. <strong>Refactoring tools</strong>:
LSP helps, but could go further 2. <strong>Debugger
integration</strong>: DAP mode exists, could be smoother 3.
<strong>Project management</strong>: project.el improving 4.
<strong>Testing integration</strong>: Better test runners</p>
<p><strong>From Vim:</strong> 1. <strong>Startup speed</strong>: Lazy
loading, daemon mode help 2. <strong>Minimal core</strong>: More
features as optional packages 3. <strong>Modal editing</strong>:
evil-mode shows this is possible</p>
<h3 data-number="26.8.4" id="what-others-can-learn-from-emacs"><span class="header-section-number">26.8.4</span> 7.4 What Others Can Learn
from Emacs</h3>
<p><strong>Universal Lessons:</strong></p>
<ol type="1">
<li><strong>Self-Documentation</strong>
<ul>
<li>Make help contextual and comprehensive</li>
<li>Inline documentation reduces friction</li>
</ul></li>
<li><strong>Programmability</strong>
<ul>
<li>Extension language should be real programming language</li>
<li>Users should be able to automate workflows</li>
</ul></li>
<li><strong>Longevity Through Stability</strong>
<ul>
<li>Backward compatibility enables gradual improvement</li>
<li>Breaking changes lose users</li>
</ul></li>
<li><strong>Integration Depth</strong>
<ul>
<li>Deep integration (Magit, Org) beats shallow plugins</li>
<li>Some features benefit from tight coupling</li>
</ul></li>
<li><strong>Community Ownership</strong>
<ul>
<li>User-driven development creates loyalty</li>
<li>Open governance prevents abandonment</li>
</ul></li>
</ol>
<hr/>
<h2 data-number="26.9" id="conclusion-learning-from-diversity"><span class="header-section-number">26.9</span> 8. Conclusion: Learning from
Diversity</h2>
<h3 data-number="26.9.1" id="there-is-no-best-editor"><span class="header-section-number">26.9.1</span> 8.1 There Is No ‚ÄúBest‚Äù
Editor</h3>
<p>Each editor represents a <strong>consistent set of
tradeoffs</strong>:</p>
<ul>
<li><strong>Emacs</strong>: Maximum customization, steep learning curve,
keyboard-centric</li>
<li><strong>VSCode</strong>: Modern balance, broad appeal, good
defaults</li>
<li><strong>IntelliJ</strong>: Language-specific excellence,
resource-intensive</li>
<li><strong>Vim</strong>: Modal efficiency, minimal resources,
ubiquity</li>
<li><strong>Cloud editors</strong>: Instant setup, collaboration,
requires internet</li>
</ul>
<p>These tradeoffs serve different users, workflows, and values. A Java
enterprise developer benefits from IntelliJ‚Äôs semantic refactoring. A
sysadmin benefits from Vim‚Äôs ubiquity and speed. A researcher benefits
from Emacs‚Äôs Org-mode. A team benefits from VSCode‚Äôs collaborative
features.</p>
<h3 data-number="26.9.2" id="architectural-insights"><span class="header-section-number">26.9.2</span> 8.2 Architectural
Insights</h3>
<p><strong>From 50 years of editor evolution:</strong></p>
<ol type="1">
<li><strong>Extensibility requires a real programming language</strong>
<ul>
<li>Scripting languages grow into full languages (Vimscript)</li>
<li>Start with a good language (Elisp, JavaScript, Lua)</li>
</ul></li>
<li><strong>Performance and flexibility trade off</strong>
<ul>
<li>API boundaries enable safety, limit power</li>
<li>Full access enables power, limits safety</li>
<li>Choose based on audience</li>
</ul></li>
<li><strong>UI paradigms are cultural, not technical</strong>
<ul>
<li>Modal vs.¬†modeless is preference, not superiority</li>
<li>Keyboard vs.¬†mouse depends on workflow</li>
<li>Support both when possible</li>
</ul></li>
<li><strong>Standards accelerate innovation</strong>
<ul>
<li>LSP, DAP, tree-sitter benefit all editors</li>
<li>Shared tools (language servers) prevent duplication</li>
</ul></li>
<li><strong>Longevity requires adaptability</strong>
<ul>
<li>Emacs adopted LSP, tree-sitter, native compilation</li>
<li>Rigid systems die (TECO, Multics Emacs)</li>
</ul></li>
<li><strong>Community matters more than features</strong>
<ul>
<li>Emacs survives on community, not market share</li>
<li>Open development creates resilience</li>
</ul></li>
</ol>
<h3 data-number="26.9.3" id="practical-recommendations"><span class="header-section-number">26.9.3</span> 8.3 Practical
Recommendations</h3>
<p><strong>For Users:</strong> - Try multiple editors, understand
tradeoffs - Use the right tool for each task - Invest time in learning
one deeply - Don‚Äôt be dogmatic (pragmatism wins)</p>
<p><strong>For Developers:</strong> - Study different approaches (learn
from diversity) - Understand why choices were made - Respect different
optimization targets - Contribute to standards (LSP, etc.)</p>
<p><strong>For Designers:</strong> - Know your audience (beginners
vs.¬†experts) - Make tradeoffs explicit (document why) - Provide escape
hatches (extensibility) - Learn from 50 years of editor evolution</p>
<h3 data-number="26.9.4" id="final-thoughts"><span class="header-section-number">26.9.4</span> 8.4 Final Thoughts</h3>
<p>Emacs is not ‚Äúbetter‚Äù than VSCode or IntelliJ or Vim. It‚Äôs
<strong>different</strong>, optimizing for different values:</p>
<ul>
<li><strong>Emacs</strong>: Hackability, consistency, integration,
longevity</li>
<li><strong>VSCode</strong>: Accessibility, modernity, ecosystem,
corporate backing</li>
<li><strong>IntelliJ</strong>: Language expertise, refactoring, IDE
experience</li>
<li><strong>Vim</strong>: Efficiency, minimalism, ubiquity, speed</li>
</ul>
<p>The fact that all these editors thrive in 2025 demonstrates that
there‚Äôs no single ‚Äúcorrect‚Äù way to edit text. Different approaches serve
different needs, and the diversity of editors reflects the diversity of
developers.</p>
<p><strong>What we learn from comparing Emacs to others:</strong></p>
<p>Software design is about <strong>tradeoffs</strong>, not absolutes.
Understanding the tradeoffs‚Äîand making them consciously‚Äîis the mark of
mature engineering. Emacs‚Äôs 40-year persistence shows that a consistent
philosophy, even if unconventional, can succeed when it serves its users
well.</p>
<p>The future of text editing is not convergence to a single ‚Äúbest‚Äù
editor, but continued diversity, with cross-pollination of ideas (like
LSP) and respect for different philosophies. That‚Äôs a healthy
ecosystem.</p>
<hr/>
<h2 data-number="26.10" id="references-and-further-reading-1"><span class="header-section-number">26.10</span> References and Further
Reading</h2>
<p><strong>Historical Sources:</strong> - Stallman, R. M. (1981).
‚ÄúEMACS: The Extensible, Customizable, Self-Documenting Display Editor‚Äù -
Weinreb, D. &amp; Moon, D. (1981). ‚ÄúLisp Machine Manual‚Äù - Finseth, C.
(1991). ‚ÄúThe Craft of Text Editing‚Äù</p>
<p><strong>Modern Comparisons:</strong> - ‚ÄúLanguage Server Protocol
Specification‚Äù (Microsoft, 2016) - ‚ÄúDebug Adapter Protocol
Specification‚Äù (Microsoft, 2018) - VSCode Architecture Documentation
(https://code.visualstudio.com/api) - Neovim Architecture Documentation
(https://neovim.io/doc/user/)</p>
<p><strong>Academic Papers:</strong> - Fraser, C. W. &amp; Hanson, D. R.
(1995). ‚ÄúA Retargetable C Compiler: Design and Implementation‚Äù -
Ballance, R. A., Maccabe, A. B., &amp; Ottenstein, K. J. (1990). ‚ÄúThe
Program Dependence Web‚Äù</p>
<p><strong>Community Resources:</strong> - r/emacs, r/vim, r/vscode
(Reddit communities) - Emacs Stack Exchange - ‚ÄúMastering Emacs‚Äù by
Mickey Petersen - ‚ÄúPractical Vim‚Äù by Drew Neil - VSCode Documentation
and Extension Guides</p>
<hr/>
<p><strong>Document Information:</strong> - <strong>File</strong>:
<code>/home/user/emacs/docs/20-comparative-analysis/01-editor-comparison.md</code>
- <strong>Chapter</strong>: 20 - Comparative Analysis -
<strong>Section</strong>: 01 - Editor Comparison -
<strong>Version</strong>: 1.0.0 - <strong>Date</strong>: 2025-11-18 -
<strong>Estimated Length</strong>: ~65 pages (printed) - <strong>Word
Count</strong>: ~16,500 words</p>
<h1 data-number="27" id="emacs-terminology-glossary"><span class="header-section-number">27</span> Emacs Terminology Glossary</h1>
<p>A comprehensive reference of Emacs terminology and concepts,
organized alphabetically with category tags.</p>
<p><strong>Categories:</strong> - <code>[Core]</code> - Core Emacs
concepts - <code>[Lisp]</code> - Emacs Lisp concepts -
<code>[Data]</code> - Data structures - <code>[Display]</code> - Display
system - <code>[System]</code> - System and I/O concepts -
<code>[Abbrev]</code> - Abbreviations and jargon</p>
<hr/>
<h2 data-number="27.1" id="a"><span class="header-section-number">27.1</span> A</h2>
<h3 data-number="27.1.1" id="abbrev-core-system"><span class="header-section-number">27.1.1</span> Abbrev <code>[Core]</code>
<code>[System]</code></h3>
<p><strong>Definition:</strong> A shorthand text expansion system where
a short word is automatically replaced with a longer phrase when
typed.</p>
<p><strong>Context:</strong> Used in text editing for inserting
frequently-used text. Abbrevs can be mode-specific or global.</p>
<p><strong>Related Terms:</strong> Auto-insert, Template, Skeleton</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/abbrevs.texi</code></p>
<hr/>
<h3 data-number="27.1.2" id="abstraction-barrier-lisp"><span class="header-section-number">27.1.2</span> Abstraction Barrier
<code>[Lisp]</code></h3>
<p><strong>Definition:</strong> A design principle separating interface
from implementation, allowing internal changes without affecting
external code.</p>
<p><strong>Context:</strong> Used in Emacs Lisp API design to maintain
compatibility across versions.</p>
<p><strong>Related Terms:</strong> API, Interface, Encapsulation</p>
<hr/>
<h3 data-number="27.1.3" id="active-keymap-core"><span class="header-section-number">27.1.3</span> Active Keymap
<code>[Core]</code></h3>
<p><strong>Definition:</strong> A keymap currently in effect for key
lookup, determined by the current major mode, active minor modes, and
local keymaps.</p>
<p><strong>Context:</strong> Multiple keymaps can be active
simultaneously with precedence rules determining which binding
applies.</p>
<p><strong>Related Terms:</strong> Keymap, Key Sequence, Key Binding</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/keymaps.texi</code></p>
<hr/>
<h3 data-number="27.1.4" id="active-region-core"><span class="header-section-number">27.1.4</span> Active Region
<code>[Core]</code></h3>
<p><strong>Definition:</strong> The region between point and mark when
the mark is active, typically highlighted visually.</p>
<p><strong>Context:</strong> Many commands operate on the active region.
Transient Mark Mode controls region visibility.</p>
<p><strong>Related Terms:</strong> Region, Mark, Point, Transient Mark
Mode</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/markers.texi</code></p>
<hr/>
<h3 data-number="27.1.5" id="advice-system"><span class="header-section-number">27.1.5</span> Advice
<code>[System]</code></h3>
<p><strong>Definition:</strong> A mechanism to modify the behavior of
existing functions by adding code before, after, or around them without
changing their definition.</p>
<p><strong>Context:</strong> Used for customization, debugging, and
extending functionality. Modern advice uses <code>advice-add</code>.</p>
<p><strong>Related Terms:</strong> Advice Combinator, nadvice, Defadvice
(deprecated)</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/functions.texi</code></p>
<hr/>
<h3 data-number="27.1.6" id="advice-combinator-lisp"><span class="header-section-number">27.1.6</span> Advice Combinator
<code>[Lisp]</code></h3>
<p><strong>Definition:</strong> Functions like <code>:before</code>,
<code>:after</code>, <code>:around</code>, <code>:override</code> that
specify how advice is combined with the original function.</p>
<p><strong>Context:</strong> Determines the execution order and
relationship between advised function and advice.</p>
<p><strong>Related Terms:</strong> Advice, advice-add, Function</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/functions.texi</code></p>
<hr/>
<h3 data-number="27.1.7" id="after-change-function-system"><span class="header-section-number">27.1.7</span> After-Change Function
<code>[System]</code></h3>
<p><strong>Definition:</strong> A function called automatically after
text is modified in a buffer, used to track or respond to changes.</p>
<p><strong>Context:</strong> Added to
<code>after-change-functions</code> hook. Receives start, end, and old
length as arguments.</p>
<p><strong>Related Terms:</strong> Before-Change Function, Hook,
Modification</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/text.texi</code></p>
<hr/>
<h3 data-number="27.1.8" id="after-string-display"><span class="header-section-number">27.1.8</span> After String
<code>[Display]</code></h3>
<p><strong>Definition:</strong> Text associated with an overlay or text
property that is displayed after the overlay‚Äôs region.</p>
<p><strong>Context:</strong> Used for adding annotations, inline images,
or supplementary text without modifying buffer contents.</p>
<p><strong>Related Terms:</strong> Before String, Overlay, Display
Property</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/display.texi</code></p>
<hr/>
<h3 data-number="27.1.9" id="ansi-escape-sequence-display"><span class="header-section-number">27.1.9</span> ANSI Escape Sequence
<code>[Display]</code></h3>
<p><strong>Definition:</strong> Terminal control codes for formatting
text output, including colors, cursor movement, and text attributes.</p>
<p><strong>Context:</strong> Processed by <code>ansi-color.el</code> in
compilation buffers, shell modes, and other terminal output.</p>
<p><strong>Related Terms:</strong> ANSI Color, Terminal, TTY</p>
<hr/>
<h3 data-number="27.1.10" id="alist-data"><span class="header-section-number">27.1.10</span> Alist
<code>[Data]</code></h3>
<p><strong>Definition:</strong> Association List - a list of cons cells
where each car is a key and each cdr is the associated value.</p>
<p><strong>Context:</strong> Common data structure for key-value
mappings in Emacs Lisp. Less efficient than hash tables for large
datasets.</p>
<p><strong>Related Terms:</strong> Plist, Hash Table, Cons Cell</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/lists.texi</code></p>
<hr/>
<h3 data-number="27.1.11" id="apropos-core"><span class="header-section-number">27.1.11</span> Apropos
<code>[Core]</code></h3>
<p><strong>Definition:</strong> A search system for finding commands,
variables, and functions matching a pattern or keyword.</p>
<p><strong>Context:</strong> Invoked with <code>M-x apropos</code>,
<code>apropos-command</code>, etc. for discovering functionality.</p>
<p><strong>Related Terms:</strong> Help System, Documentation,
Describe</p>
<hr/>
<h3 data-number="27.1.12" id="arc-mode-core"><span class="header-section-number">27.1.12</span> Arc Mode
<code>[Core]</code></h3>
<p><strong>Definition:</strong> A major mode for viewing and editing
archive files (ZIP, TAR, etc.) as if they were directories.</p>
<p><strong>Context:</strong> Allows browsing and modifying archive
contents without external tools.</p>
<p><strong>Related Terms:</strong> Major Mode, Dired, Archive</p>
<hr/>
<h3 data-number="27.1.13" id="argument-list-lisp"><span class="header-section-number">27.1.13</span> Argument List
<code>[Lisp]</code></h3>
<p><strong>Definition:</strong> The list of parameters accepted by a
function, specified in its definition.</p>
<p><strong>Context:</strong> Can include required, optional
(<code>&amp;optional</code>), rest (<code>&amp;rest</code>), and keyword
(<code>&amp;key</code> in CL) arguments.</p>
<p><strong>Related Terms:</strong> Lambda List, Parameter, Function</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/functions.texi</code></p>
<hr/>
<h3 data-number="27.1.14" id="ascii-system"><span class="header-section-number">27.1.14</span> ASCII
<code>[System]</code></h3>
<p><strong>Definition:</strong> American Standard Code for Information
Interchange - a 7-bit character encoding standard.</p>
<p><strong>Context:</strong> Subset of most character encodings used in
Emacs. ASCII characters are bytes 0-127.</p>
<p><strong>Related Terms:</strong> Character Set, Coding System, UTF-8,
Unibyte</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/nonascii.texi</code></p>
<hr/>
<h3 data-number="27.1.15" id="async-process-system"><span class="header-section-number">27.1.15</span> Async Process
<code>[System]</code></h3>
<p><strong>Definition:</strong> A subprocess that runs concurrently with
Emacs, allowing non-blocking I/O operations.</p>
<p><strong>Context:</strong> Created with <code>start-process</code>.
Output handled via process filters, completion via sentinels.</p>
<p><strong>Related Terms:</strong> Process, Filter, Sentinel,
Subprocess</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/processes.texi</code></p>
<hr/>
<h3 data-number="27.1.16" id="atom-lisp"><span class="header-section-number">27.1.16</span> Atom
<code>[Lisp]</code></h3>
<p><strong>Definition:</strong> Any Lisp object that is not a cons cell
- includes symbols, numbers, strings, vectors, etc.</p>
<p><strong>Context:</strong> Opposite of list/cons. Used in conditional
logic and type checking.</p>
<p><strong>Related Terms:</strong> Cons Cell, List, Symbol</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/lists.texi</code></p>
<hr/>
<h3 data-number="27.1.17" id="auto-composition-display"><span class="header-section-number">27.1.17</span> Auto-Composition
<code>[Display]</code></h3>
<p><strong>Definition:</strong> Automatic character composition for
complex scripts (Arabic, Indic, etc.) requiring glyph shaping.</p>
<p><strong>Context:</strong> Controlled by composition functions and
font backend. Happens during redisplay.</p>
<p><strong>Related Terms:</strong> Composition, Font, Glyph, Complex
Script</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/display.texi</code></p>
<hr/>
<h3 data-number="27.1.18" id="auto-fill-mode-core"><span class="header-section-number">27.1.18</span> Auto-Fill Mode
<code>[Core]</code></h3>
<p><strong>Definition:</strong> A minor mode that automatically breaks
lines at the fill column while typing.</p>
<p><strong>Context:</strong> Commonly used for writing text. Fill column
defaults to 70 characters.</p>
<p><strong>Related Terms:</strong> Fill Column, Minor Mode, Line
Wrapping</p>
<hr/>
<h3 data-number="27.1.19" id="auto-revert-mode-core"><span class="header-section-number">27.1.19</span> Auto-Revert Mode
<code>[Core]</code></h3>
<p><strong>Definition:</strong> A minor mode that automatically reverts
a buffer when its file changes on disk.</p>
<p><strong>Context:</strong> Useful for log files and files modified by
external programs.</p>
<p><strong>Related Terms:</strong> Revert Buffer, File Notification,
Minor Mode</p>
<hr/>
<h3 data-number="27.1.20" id="auto-save-core"><span class="header-section-number">27.1.20</span> Auto-Save
<code>[Core]</code></h3>
<p><strong>Definition:</strong> Automatic periodic saving of buffer
contents to a backup file (typically <code>#filename#</code>).</p>
<p><strong>Context:</strong> Protection against crashes and data loss.
Controlled by <code>auto-save-mode</code>.</p>
<p><strong>Related Terms:</strong> Backup File, Crash Recovery,
Auto-Save File</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/backups.texi</code></p>
<hr/>
<h3 data-number="27.1.21" id="autoload-lisp"><span class="header-section-number">27.1.21</span> Autoload
<code>[Lisp]</code></h3>
<p><strong>Definition:</strong> A mechanism to defer loading a
function‚Äôs definition until it‚Äôs first called, reducing startup
time.</p>
<p><strong>Context:</strong> Declared with <code>;;;###autoload</code>
magic comment or <code>autoload</code> function. Essential for package
management.</p>
<p><strong>Related Terms:</strong> Feature, Provide, Require, Lazy
Loading</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/loading.texi</code></p>
<hr/>
<h3 data-number="27.1.22" id="autoload-cookie-lisp"><span class="header-section-number">27.1.22</span> Autoload Cookie
<code>[Lisp]</code></h3>
<p><strong>Definition:</strong> The magic comment
<code>;;;###autoload</code> that marks definitions for automatic
autoload generation.</p>
<p><strong>Context:</strong> Processed during package compilation to
create autoload files.</p>
<p><strong>Related Terms:</strong> Autoload, Package, Loaddefs</p>
<hr/>
<h2 data-number="27.2" id="b"><span class="header-section-number">27.2</span> B</h2>
<h3 data-number="27.2.1" id="backtrace-lisp"><span class="header-section-number">27.2.1</span> Backtrace
<code>[Lisp]</code></h3>
<p><strong>Definition:</strong> A stack trace showing the sequence of
function calls leading to an error or debugger invocation.</p>
<p><strong>Context:</strong> Displayed in <code>*Backtrace*</code>
buffer during debugging. Shows call chain and arguments.</p>
<p><strong>Related Terms:</strong> Debugger, Stack Frame, Call Stack,
Edebug</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/debugging.texi</code></p>
<hr/>
<h3 data-number="27.2.2" id="backup-file-core"><span class="header-section-number">27.2.2</span> Backup File
<code>[Core]</code></h3>
<p><strong>Definition:</strong> A copy of a file made before saving,
typically named with a tilde suffix (<code>filename~</code>).</p>
<p><strong>Context:</strong> Controlled by
<code>make-backup-files</code>. Multiple backup versions can be
kept.</p>
<p><strong>Related Terms:</strong> Auto-Save, Version Control, Numbered
Backup</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/backups.texi</code></p>
<hr/>
<h3 data-number="27.2.3" id="balanced-expression-lisp"><span class="header-section-number">27.2.3</span> Balanced Expression
<code>[Lisp]</code></h3>
<p><strong>Definition:</strong> An s-expression with properly matched
delimiters (parentheses, brackets, quotes).</p>
<p><strong>Context:</strong> Required for valid Lisp code. Emacs
provides commands for navigating and manipulating balanced
expressions.</p>
<p><strong>Related Terms:</strong> S-expression, Sexp, Paren
Matching</p>
<hr/>
<h3 data-number="27.2.4" id="before-change-function-system"><span class="header-section-number">27.2.4</span> Before-Change Function
<code>[System]</code></h3>
<p><strong>Definition:</strong> A function called before text is
modified in a buffer, receiving the region about to be changed.</p>
<p><strong>Context:</strong> Added to
<code>before-change-functions</code> hook. Used for validation or
preparation.</p>
<p><strong>Related Terms:</strong> After-Change Function, Hook,
Modification</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/text.texi</code></p>
<hr/>
<h3 data-number="27.2.5" id="before-string-display"><span class="header-section-number">27.2.5</span> Before String
<code>[Display]</code></h3>
<p><strong>Definition:</strong> Text associated with an overlay or text
property displayed before the overlay‚Äôs region.</p>
<p><strong>Context:</strong> Used for annotations, line numbers, or
icons without modifying buffer text.</p>
<p><strong>Related Terms:</strong> After String, Overlay, Display
Property</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/display.texi</code></p>
<hr/>
<h3 data-number="27.2.6" id="beg-begv-data"><span class="header-section-number">27.2.6</span> BEG / BEGV
<code>[Data]</code></h3>
<p><strong>Definition:</strong> Buffer constants - BEG is position 1
(buffer beginning), BEGV is beginning of accessible region (after
narrowing).</p>
<p><strong>Context:</strong> C macros used throughout Emacs internals
for buffer boundary checks.</p>
<p><strong>Related Terms:</strong> Point, Z, ZV, Narrowing, Gap
Buffer</p>
<p><strong>Source:</strong> See <code>src/buffer.h</code></p>
<hr/>
<h3 data-number="27.2.7" id="bidirectional-text-display"><span class="header-section-number">27.2.7</span> Bidirectional Text
<code>[Display]</code></h3>
<p><strong>Definition:</strong> Text containing both left-to-right (LTR)
and right-to-left (RTL) scripts like Arabic or Hebrew.</p>
<p><strong>Context:</strong> Emacs implements the Unicode Bidirectional
Algorithm for correct display.</p>
<p><strong>Related Terms:</strong> BIDI, RTL, LTR, Unicode</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/display.texi</code></p>
<hr/>
<h3 data-number="27.2.8" id="binding-lisp"><span class="header-section-number">27.2.8</span> Binding
<code>[Lisp]</code></h3>
<p><strong>Definition:</strong> The association between a variable name
and its value, or a key sequence and its command.</p>
<p><strong>Context:</strong> Can be global, buffer-local, let-bound, or
dynamically scoped.</p>
<p><strong>Related Terms:</strong> Variable, Key Binding, Scope,
Environment</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/variables.texi</code></p>
<hr/>
<h3 data-number="27.2.9" id="bitmap-display"><span class="header-section-number">27.2.9</span> Bitmap
<code>[Display]</code></h3>
<p><strong>Definition:</strong> A small monochrome image used in the
fringe for indicators like continuation, truncation, or debugging
marks.</p>
<p><strong>Context:</strong> Defined with
<code>define-fringe-bitmap</code>. System bitmaps exist for common
indicators.</p>
<p><strong>Related Terms:</strong> Fringe, Glyph, Icon, Indicator</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/display.texi</code></p>
<hr/>
<h3 data-number="27.2.10" id="bobp-bolp-eobp-eolp-core"><span class="header-section-number">27.2.10</span> Bobp / Bolp / Eobp / Eolp
<code>[Core]</code></h3>
<p><strong>Definition:</strong> Predicates testing if point is at
Beginning Of Buffer, Beginning Of Line, End Of Buffer, or End Of
Line.</p>
<p><strong>Context:</strong> Common in motion and editing commands to
test boundary conditions.</p>
<p><strong>Related Terms:</strong> Point, Buffer Position, Predicate</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/positions.texi</code></p>
<hr/>
<h3 data-number="27.2.11" id="bool-vector-data"><span class="header-section-number">27.2.11</span> Bool Vector
<code>[Data]</code></h3>
<p><strong>Definition:</strong> A compact array of boolean values,
stored as bits rather than full Lisp objects.</p>
<p><strong>Context:</strong> Memory-efficient for large boolean arrays.
Used in char-tables and other internal structures.</p>
<p><strong>Related Terms:</strong> Vector, Bit Array, Char Table</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/sequences.texi</code></p>
<hr/>
<h3 data-number="27.2.12" id="buffer-core"><span class="header-section-number">27.2.12</span> Buffer
<code>[Core]</code></h3>
<p><strong>Definition:</strong> A Lisp object containing editable text,
either associated with a file or existing only in memory.</p>
<p><strong>Context:</strong> Fundamental to Emacs editing. Each buffer
has its own point, mark, local variables, and major mode.</p>
<p><strong>Related Terms:</strong> Current Buffer, Window, Point,
Mode</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/buffers.texi</code></p>
<hr/>
<h3 data-number="27.2.13" id="buffer-local-variable-lisp"><span class="header-section-number">27.2.13</span> Buffer-Local Variable
<code>[Lisp]</code></h3>
<p><strong>Definition:</strong> A variable that can have different
values in different buffers, overriding its global value.</p>
<p><strong>Context:</strong> Set with <code>make-local-variable</code>
or <code>setq-local</code>. Major modes typically set buffer-local
variables.</p>
<p><strong>Related Terms:</strong> Local Variable, Global Variable,
Buffer</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/variables.texi</code></p>
<hr/>
<h3 data-number="27.2.14" id="buffer-gap-data"><span class="header-section-number">27.2.14</span> Buffer Gap
<code>[Data]</code></h3>
<p><strong>Definition:</strong> An empty space in a buffer‚Äôs text
storage that allows efficient insertion and deletion at point.</p>
<p><strong>Context:</strong> Part of the gap buffer data structure.
Moves to follow editing operations.</p>
<p><strong>Related Terms:</strong> Gap Buffer, GPT, Point, Insertion</p>
<p><strong>Source:</strong> See <code>src/buffer.h</code></p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/buffers.texi</code></p>
<hr/>
<h3 data-number="27.2.15" id="buffer-list-core"><span class="header-section-number">27.2.15</span> Buffer List
<code>[Core]</code></h3>
<p><strong>Definition:</strong> The ordered collection of all live
buffers, with most recently selected buffers first.</p>
<p><strong>Context:</strong> Accessed via <code>buffer-list</code>.
Modified by buffer selection and killing.</p>
<p><strong>Related Terms:</strong> Buffer, Buried Buffer, Buffer
Menu</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/buffers.texi</code></p>
<hr/>
<h3 data-number="27.2.16" id="buffer-undo-list-core"><span class="header-section-number">27.2.16</span> Buffer-Undo-List
<code>[Core]</code></h3>
<p><strong>Definition:</strong> A list recording changes to a buffer to
enable undo operations.</p>
<p><strong>Context:</strong> Contains entries for insertions, deletions,
and property changes. Can be truncated or disabled.</p>
<p><strong>Related Terms:</strong> Undo, Redo, Change List</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/text.texi</code></p>
<hr/>
<h3 data-number="27.2.17" id="buried-buffer-core"><span class="header-section-number">27.2.17</span> Buried Buffer
<code>[Core]</code></h3>
<p><strong>Definition:</strong> A buffer moved to the end of the buffer
list, making it less likely to be displayed.</p>
<p><strong>Context:</strong> Created by <code>bury-buffer</code>. Keeps
buffers alive without showing them prominently.</p>
<p><strong>Related Terms:</strong> Buffer List, Hidden Buffer, Buffer
Switching</p>
<hr/>
<h3 data-number="27.2.18" id="byte-code-lisp"><span class="header-section-number">27.2.18</span> Byte Code
<code>[Lisp]</code></h3>
<p><strong>Definition:</strong> A compact intermediate representation of
compiled Lisp code executed by the byte-code interpreter.</p>
<p><strong>Context:</strong> Produced by the byte compiler. Faster than
interpreted Lisp but slower than native code.</p>
<p><strong>Related Terms:</strong> Byte Compiler, .elc File, Native
Compilation, LAP</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/compile.texi</code></p>
<hr/>
<h3 data-number="27.2.19" id="byte-compiler-lisp"><span class="header-section-number">27.2.19</span> Byte Compiler
<code>[Lisp]</code></h3>
<p><strong>Definition:</strong> The compiler that translates Emacs Lisp
source code into byte code.</p>
<p><strong>Context:</strong> Invoked via <code>byte-compile-file</code>
or during package installation. Produces <code>.elc</code> files.</p>
<p><strong>Related Terms:</strong> Byte Code, Compilation, .elc File,
Native Compilation</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/compile.texi</code></p>
<hr/>
<h3 data-number="27.2.20" id="byte-position-data"><span class="header-section-number">27.2.20</span> Byte Position
<code>[Data]</code></h3>
<p><strong>Definition:</strong> A position in a buffer measured in bytes
rather than characters, important for multibyte text.</p>
<p><strong>Context:</strong> Used internally. Most Lisp code uses
character positions.</p>
<p><strong>Related Terms:</strong> Character Position, Multibyte, Point,
Marker</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/positions.texi</code></p>
<hr/>
<h2 data-number="27.3" id="c"><span class="header-section-number">27.3</span> C</h2>
<h3 data-number="27.3.1" id="c-h-abbrev"><span class="header-section-number">27.3.1</span> C-h
<code>[Abbrev]</code></h3>
<p><strong>Definition:</strong> The help prefix key in Emacs, used to
access help commands.</p>
<p><strong>Context:</strong> <code>C-h k</code> describes key,
<code>C-h f</code> describes function, <code>C-h v</code> describes
variable, etc.</p>
<p><strong>Related Terms:</strong> Help, Describe, Apropos</p>
<hr/>
<h3 data-number="27.3.2" id="c-source-system"><span class="header-section-number">27.3.2</span> C Source
<code>[System]</code></h3>
<p><strong>Definition:</strong> The C language implementation of Emacs
core, providing primitives and performance-critical functions.</p>
<p><strong>Context:</strong> Located in <code>src/</code> directory.
Provides DEFUN primitives callable from Lisp.</p>
<p><strong>Related Terms:</strong> Primitive, DEFUN, Subr, Built-in</p>
<p><strong>Source:</strong> See <code>src/</code> directory</p>
<hr/>
<h3 data-number="27.3.3" id="call-stack-lisp"><span class="header-section-number">27.3.3</span> Call Stack
<code>[Lisp]</code></h3>
<p><strong>Definition:</strong> The runtime stack of function
invocations, showing which functions called which.</p>
<p><strong>Context:</strong> Visible in backtrace during debugging.
Limited by <code>max-lisp-eval-depth</code>.</p>
<p><strong>Related Terms:</strong> Backtrace, Stack Frame, Recursion</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/debugging.texi</code></p>
<hr/>
<h3 data-number="27.3.4" id="canonical-character-system"><span class="header-section-number">27.3.4</span> Canonical Character
<code>[System]</code></h3>
<p><strong>Definition:</strong> The normalized form of a character used
for case-insensitive comparisons and operations.</p>
<p><strong>Context:</strong> Handles case folding and equivalence
classes for various character sets.</p>
<p><strong>Related Terms:</strong> Case Table, Character Folding,
Normalization</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/nonascii.texi</code></p>
<hr/>
<h3 data-number="27.3.5" id="case-table-data"><span class="header-section-number">27.3.5</span> Case Table
<code>[Data]</code></h3>
<p><strong>Definition:</strong> A char-table defining
uppercase/lowercase relationships and case folding rules for
characters.</p>
<p><strong>Context:</strong> Language-specific case tables handle
different alphabets. Affects case conversion and searching.</p>
<p><strong>Related Terms:</strong> Char Table, Case Folding, Syntax
Table</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/nonascii.texi</code></p>
<hr/>
<h3 data-number="27.3.6" id="category-table-data"><span class="header-section-number">27.3.6</span> Category Table
<code>[Data]</code></h3>
<p><strong>Definition:</strong> A char-table assigning categories to
characters, used by regular expressions for character class
matching.</p>
<p><strong>Context:</strong> Categories are single-character symbols.
Used in <code>\cX</code> regexp syntax.</p>
<p><strong>Related Terms:</strong> Char Table, Regexp, Character
Class</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/syntax.texi</code></p>
<hr/>
<h3 data-number="27.3.7" id="cedet-abbrev"><span class="header-section-number">27.3.7</span> CEDET
<code>[Abbrev]</code></h3>
<p><strong>Definition:</strong> Collection of Emacs Development
Environment Tools - an infrastructure for parsing and analyzing
code.</p>
<p><strong>Context:</strong> Provides semantic analysis, project
management, and code navigation. Predecessor to modern LSP.</p>
<p><strong>Related Terms:</strong> Semantic, EDE, LSP, IDE</p>
<p><strong>Documentation:</strong> See <code>doc/misc/</code> for CEDET
manuals</p>
<hr/>
<h3 data-number="27.3.8" id="change-group-system"><span class="header-section-number">27.3.8</span> Change Group
<code>[System]</code></h3>
<p><strong>Definition:</strong> A mechanism to group multiple buffer
modifications into a single undoable unit.</p>
<p><strong>Context:</strong> Used by <code>atomic-change-group</code>.
All changes succeed together or are undone together.</p>
<p><strong>Related Terms:</strong> Undo, Transaction, Atomic
Operation</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/text.texi</code></p>
<hr/>
<h3 data-number="27.3.9" id="character-data"><span class="header-section-number">27.3.9</span> Character
<code>[Data]</code></h3>
<p><strong>Definition:</strong> A Lisp integer representing a Unicode
code point, the basic unit of text in Emacs.</p>
<p><strong>Context:</strong> Emacs 23+ uses Unicode internally.
Characters range from 0 to #x3FFFFF.</p>
<p><strong>Related Terms:</strong> Character Code, Unicode, Multibyte,
Codepoint</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/nonascii.texi</code></p>
<hr/>
<h3 data-number="27.3.10" id="character-class-lisp"><span class="header-section-number">27.3.10</span> Character Class
<code>[Lisp]</code></h3>
<p><strong>Definition:</strong> A regexp construct matching any
character in a specified set, enclosed in <code>[...]</code>.</p>
<p><strong>Context:</strong> Supports ranges <code>[a-z]</code>,
negation <code>[^...]</code>, and predefined classes
<code>[:alpha:]</code>.</p>
<p><strong>Related Terms:</strong> Regexp, Pattern Matching, Syntax
Class</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/searching.texi</code></p>
<hr/>
<h3 data-number="27.3.11" id="character-code-data"><span class="header-section-number">27.3.11</span> Character Code
<code>[Data]</code></h3>
<p><strong>Definition:</strong> The numeric value of a character,
typically a Unicode code point.</p>
<p><strong>Context:</strong> Obtained with <code>char-code</code>.
Character literals in Lisp use <code>?</code> syntax: <code>?A</code> =
65.</p>
<p><strong>Related Terms:</strong> Character, Unicode, Code Point</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/nonascii.texi</code></p>
<hr/>
<h3 data-number="27.3.12" id="character-position-data"><span class="header-section-number">27.3.12</span> Character Position
<code>[Data]</code></h3>
<p><strong>Definition:</strong> A position in a buffer measured in
characters, independent of multibyte encoding.</p>
<p><strong>Context:</strong> Standard for Lisp programming. May differ
from byte position in multibyte buffers.</p>
<p><strong>Related Terms:</strong> Byte Position, Point, Marker,
Position</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/positions.texi</code></p>
<hr/>
<h3 data-number="27.3.13" id="charset-system-1"><span class="header-section-number">27.3.13</span> Charset
<code>[System]</code></h3>
<p><strong>Definition:</strong> A character set defining a collection of
characters with numeric codes, like ASCII, ISO-8859-1, or Unicode.</p>
<p><strong>Context:</strong> Emacs supports multiple charsets but uses
Unicode as the universal internal representation.</p>
<p><strong>Related Terms:</strong> Coding System, Character Set,
Unicode, Multibyte</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/nonascii.texi</code></p>
<hr/>
<h3 data-number="27.3.14" id="char-table-data"><span class="header-section-number">27.3.14</span> Char-Table
<code>[Data]</code></h3>
<p><strong>Definition:</strong> A specialized array indexed by character
codes, used for character properties and mappings.</p>
<p><strong>Context:</strong> Used for syntax tables, case tables,
category tables, and display tables. Very memory-efficient.</p>
<p><strong>Related Terms:</strong> Syntax Table, Case Table, Display
Table, Array</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/sequences.texi</code></p>
<hr/>
<h3 data-number="27.3.15" id="circular-list-data"><span class="header-section-number">27.3.15</span> Circular List
<code>[Data]</code></h3>
<p><strong>Definition:</strong> A list structure containing a cycle,
where a cons cell‚Äôs cdr eventually points back to an earlier cell.</p>
<p><strong>Context:</strong> Can cause infinite loops. Detected by
<code>circular-list</code> error or print-circle.</p>
<p><strong>Related Terms:</strong> List, Cons Cell, Print Circle</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/lists.texi</code></p>
<hr/>
<h3 data-number="27.3.16" id="cl-common-lisp-lisp"><span class="header-section-number">27.3.16</span> CL (Common Lisp)
<code>[Lisp]</code></h3>
<p><strong>Definition:</strong> Common Lisp - a Lisp dialect whose
features are partially available in Emacs Lisp via cl-lib.</p>
<p><strong>Context:</strong> <code>cl-lib</code> provides loop,
destructuring, structures, and other CL features for Emacs Lisp.</p>
<p><strong>Related Terms:</strong> cl-lib, CLOS, Lisp Dialect</p>
<p><strong>Documentation:</strong> See <code>doc/misc/cl.texi</code></p>
<hr/>
<h3 data-number="27.3.17" id="closure-lisp"><span class="header-section-number">27.3.17</span> Closure
<code>[Lisp]</code></h3>
<p><strong>Definition:</strong> A function that captures and retains
access to variables from its defining lexical environment.</p>
<p><strong>Context:</strong> Enabled by lexical binding. Allows
functional programming patterns like partial application.</p>
<p><strong>Related Terms:</strong> Lexical Binding, Lambda, Anonymous
Function, Environment</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/variables.texi</code></p>
<hr/>
<h3 data-number="27.3.18" id="coding-system-system"><span class="header-section-number">27.3.18</span> Coding System
<code>[System]</code></h3>
<p><strong>Definition:</strong> A specification for encoding and
decoding text between internal Unicode and external byte
representations.</p>
<p><strong>Context:</strong> Examples: utf-8, iso-8859-1, euc-jp.
Automatically detected or explicitly set for files and processes.</p>
<p><strong>Related Terms:</strong> Character Encoding, Charset, EOL
Convention, Multibyte</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/nonascii.texi</code></p>
<hr/>
<h3 data-number="27.3.19" id="column-core"><span class="header-section-number">27.3.19</span> Column
<code>[Core]</code></h3>
<p><strong>Definition:</strong> A horizontal position in a line,
measured in characters or visual columns.</p>
<p><strong>Context:</strong> <code>current-column</code> returns point‚Äôs
column. Tab characters and variable-width fonts complicate column
calculation.</p>
<p><strong>Related Terms:</strong> Visual Column, Goal Column,
Indentation</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/positions.texi</code></p>
<hr/>
<h3 data-number="27.3.20" id="command-core"><span class="header-section-number">27.3.20</span> Command
<code>[Core]</code></h3>
<p><strong>Definition:</strong> An interactive function that can be
invoked via <code>M-x</code> or a key binding.</p>
<p><strong>Context:</strong> Declared with
<code>(interactive ...)</code> spec. Distinguishes user-callable from
internal functions.</p>
<p><strong>Related Terms:</strong> Interactive, Key Binding, M-x</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/commands.texi</code></p>
<hr/>
<h3 data-number="27.3.21" id="command-loop-system"><span class="header-section-number">27.3.21</span> Command Loop
<code>[System]</code></h3>
<p><strong>Definition:</strong> The main loop that reads user input,
executes commands, and updates the display.</p>
<p><strong>Context:</strong> Handles keyboard and mouse events, manages
keymaps, and triggers redisplay.</p>
<p><strong>Related Terms:</strong> Event Loop, Redisplay, Key
Sequence</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/commands.texi</code></p>
<hr/>
<h3 data-number="27.3.22" id="comment-syntax-lisp"><span class="header-section-number">27.3.22</span> Comment Syntax
<code>[Lisp]</code></h3>
<p><strong>Definition:</strong> Syntax rules defining how comments are
written in a programming language, stored in the syntax table.</p>
<p><strong>Context:</strong> Emacs supports multiple comment styles:
line comments, block comments, nested comments.</p>
<p><strong>Related Terms:</strong> Syntax Table, Comment Delimiters,
Syntax Class</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/syntax.texi</code></p>
<hr/>
<h3 data-number="27.3.23" id="compilation-lisp"><span class="header-section-number">27.3.23</span> Compilation
<code>[Lisp]</code></h3>
<p><strong>Definition:</strong> The process of translating Emacs Lisp
source code into byte code or native code for improved performance.</p>
<p><strong>Context:</strong> Byte compilation produces <code>.elc</code>
files. Native compilation produces <code>.eln</code> files.</p>
<p><strong>Related Terms:</strong> Byte Compiler, Native Compilation,
.elc, .eln</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/compile.texi</code></p>
<hr/>
<h3 data-number="27.3.24" id="composition-display"><span class="header-section-number">27.3.24</span> Composition
<code>[Display]</code></h3>
<p><strong>Definition:</strong> Combining multiple characters into a
single glyph for display, used in complex scripts and emoji.</p>
<p><strong>Context:</strong> Automatic for complex scripts (Arabic,
Devanagari). Can be manual via composition functions.</p>
<p><strong>Related Terms:</strong> Glyph, Font, Complex Script,
Auto-Composition</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/display.texi</code></p>
<hr/>
<h3 data-number="27.3.25" id="cons-cell-data"><span class="header-section-number">27.3.25</span> Cons Cell
<code>[Data]</code></h3>
<p><strong>Definition:</strong> The fundamental building block of Lisp
lists - a pair of two values (car and cdr).</p>
<p><strong>Context:</strong> Created with <code>cons</code>. Lists are
chains of cons cells. Dotted pairs have non-nil cdr.</p>
<p><strong>Related Terms:</strong> List, Car, Cdr, Pair</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/lists.texi</code></p>
<hr/>
<h3 data-number="27.3.26" id="continuation-line-display"><span class="header-section-number">27.3.26</span> Continuation Line
<code>[Display]</code></h3>
<p><strong>Definition:</strong> A logical line that spans multiple
screen lines due to line wrapping.</p>
<p><strong>Context:</strong> Indicated in the fringe. Controlled by
truncate-lines variable.</p>
<p><strong>Related Terms:</strong> Line Wrapping, Truncation, Visual
Line, Fringe</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/display.texi</code></p>
<hr/>
<h3 data-number="27.3.27" id="current-buffer-core"><span class="header-section-number">27.3.27</span> Current Buffer
<code>[Core]</code></h3>
<p><strong>Definition:</strong> The buffer that editing commands
implicitly operate on.</p>
<p><strong>Context:</strong> Set by <code>set-buffer</code> or
<code>with-current-buffer</code>. Often different from the displayed
buffer.</p>
<p><strong>Related Terms:</strong> Buffer, Selected Window,
set-buffer</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/buffers.texi</code></p>
<hr/>
<h3 data-number="27.3.28" id="customization-system"><span class="header-section-number">27.3.28</span> Customization
<code>[System]</code></h3>
<p><strong>Definition:</strong> The Emacs system for declaring user
options with types, defaults, and interactive editing.</p>
<p><strong>Context:</strong> Defined with <code>defcustom</code>. Edited
via Customize interface (<code>M-x customize</code>).</p>
<p><strong>Related Terms:</strong> Defcustom, Custom, User Option,
Variable</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/customize.texi</code></p>
<hr/>
<h3 data-number="27.3.29" id="custom-theme-system"><span class="header-section-number">27.3.29</span> Custom Theme
<code>[System]</code></h3>
<p><strong>Definition:</strong> A coordinated set of face and variable
customizations that can be loaded as a unit.</p>
<p><strong>Context:</strong> Themes provide consistent color schemes and
UI appearance. Multiple themes can be active.</p>
<p><strong>Related Terms:</strong> Face, Theme, Customization,
Appearance</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/customize.texi</code></p>
<hr/>
<h2 data-number="27.4" id="d"><span class="header-section-number">27.4</span> D</h2>
<h3 data-number="27.4.1" id="daemon-mode-system"><span class="header-section-number">27.4.1</span> Daemon Mode
<code>[System]</code></h3>
<p><strong>Definition:</strong> Running Emacs as a background server
process that clients can connect to.</p>
<p><strong>Context:</strong> Started with <code>emacs --daemon</code>.
Clients connect via <code>emacsclient</code>.</p>
<p><strong>Related Terms:</strong> Server, Client, Background
Process</p>
<p><strong>Documentation:</strong> See <code>doc/emacs/</code>
manual</p>
<hr/>
<h3 data-number="27.4.2" id="debug-on-error-lisp"><span class="header-section-number">27.4.2</span> Debug On Error
<code>[Lisp]</code></h3>
<p><strong>Definition:</strong> A variable that, when non-nil, invokes
the debugger automatically when an error occurs.</p>
<p><strong>Context:</strong> Essential for debugging. Set with
<code>M-x toggle-debug-on-error</code>.</p>
<p><strong>Related Terms:</strong> Debugger, Error, Backtrace,
Debugging</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/debugging.texi</code></p>
<hr/>
<h3 data-number="27.4.3" id="debugger-lisp"><span class="header-section-number">27.4.3</span> Debugger
<code>[Lisp]</code></h3>
<p><strong>Definition:</strong> An interactive tool for inspecting Lisp
execution, examining the call stack, and stepping through code.</p>
<p><strong>Context:</strong> Invoked by errors (when
<code>debug-on-error</code> is set), explicitly, or via breakpoints.</p>
<p><strong>Related Terms:</strong> Edebug, Backtrace, Breakpoint, Debug
On Error</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/debugging.texi</code></p>
<hr/>
<h3 data-number="27.4.4" id="defadvice-lisp-deprecated"><span class="header-section-number">27.4.4</span> Defadvice
<code>[Lisp]</code> (Deprecated)</h3>
<p><strong>Definition:</strong> Old advice system for modifying function
behavior, superseded by the new advice system.</p>
<p><strong>Context:</strong> Use <code>advice-add</code> instead.
Defadvice is retained for compatibility.</p>
<p><strong>Related Terms:</strong> Advice, advice-add, nadvice</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/functions.texi</code></p>
<hr/>
<h3 data-number="27.4.5" id="defconst-lisp"><span class="header-section-number">27.4.5</span> Defconst
<code>[Lisp]</code></h3>
<p><strong>Definition:</strong> Defines a constant variable with
documentation, though technically still mutable in Emacs Lisp.</p>
<p><strong>Context:</strong> Convention for values that shouldn‚Äôt
change. Sets a special variable like defvar.</p>
<p><strong>Related Terms:</strong> Defvar, Variable, Constant, Special
Variable</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/variables.texi</code></p>
<hr/>
<h3 data-number="27.4.6" id="defcustom-lisp"><span class="header-section-number">27.4.6</span> Defcustom
<code>[Lisp]</code></h3>
<p><strong>Definition:</strong> Defines a customizable user option with
type, default, and customize interface support.</p>
<p><strong>Context:</strong> Preferred over defvar for user-facing
configuration. Provides interactive editing.</p>
<p><strong>Related Terms:</strong> Customization, User Option, Defvar,
Custom</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/customize.texi</code></p>
<hr/>
<h3 data-number="27.4.7" id="defface-lisp"><span class="header-section-number">27.4.7</span> Defface
<code>[Lisp]</code></h3>
<p><strong>Definition:</strong> Defines a face with default attributes
and customization support.</p>
<p><strong>Context:</strong> Faces control text appearance. Defface
allows theme and user customization.</p>
<p><strong>Related Terms:</strong> Face, Customization, Theme,
Display</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/display.texi</code></p>
<hr/>
<h3 data-number="27.4.8" id="defmacro-lisp"><span class="header-section-number">27.4.8</span> Defmacro
<code>[Lisp]</code></h3>
<p><strong>Definition:</strong> Defines a Lisp macro that transforms
code at compile time.</p>
<p><strong>Context:</strong> Macros receive unevaluated arguments and
return code to be evaluated. Powerful but complex.</p>
<p><strong>Related Terms:</strong> Macro, Macro Expansion, Backquote,
Compile Time</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/macros.texi</code></p>
<hr/>
<h3 data-number="27.4.9" id="defsubst-lisp"><span class="header-section-number">27.4.9</span> Defsubst
<code>[Lisp]</code></h3>
<p><strong>Definition:</strong> Defines an inline function that the
compiler substitutes directly at call sites for performance.</p>
<p><strong>Context:</strong> Like C inline functions. Use for tiny,
frequently-called functions.</p>
<p><strong>Related Terms:</strong> Function, Inline, Compilation,
Optimization</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/functions.texi</code></p>
<hr/>
<h3 data-number="27.4.10" id="defun-lisp-system"><span class="header-section-number">27.4.10</span> DEFUN <code>[Lisp]</code>
<code>[System]</code></h3>
<p><strong>Definition:</strong> A C macro for defining primitives
(built-in functions) callable from Lisp.</p>
<p><strong>Context:</strong> Used in Emacs C source code. Specifies Lisp
name, C name, arguments, and documentation.</p>
<p><strong>Related Terms:</strong> Primitive, Subr, Built-in Function, C
Source</p>
<p><strong>Source:</strong> See <code>src/lisp.h</code></p>
<hr/>
<h3 data-number="27.4.11" id="defun-abbrev"><span class="header-section-number">27.4.11</span> Defun
<code>[Abbrev]</code></h3>
<p><strong>Definition:</strong> Short for ‚Äúdefine function‚Äù - refers to
function definitions or top-level forms.</p>
<p><strong>Context:</strong> Also refers to the beginning of a top-level
definition for navigation commands.</p>
<p><strong>Related Terms:</strong> Function, Beginning-of-Defun,
End-of-Defun</p>
<hr/>
<h3 data-number="27.4.12" id="defvar-lisp"><span class="header-section-number">27.4.12</span> Defvar
<code>[Lisp]</code></h3>
<p><strong>Definition:</strong> Defines a special (dynamically scoped)
variable with optional initial value and documentation.</p>
<p><strong>Context:</strong> Only sets value if variable is void.
Declares dynamic scope even under lexical binding.</p>
<p><strong>Related Terms:</strong> Variable, Special Variable, Dynamic
Binding, Defconst</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/variables.texi</code></p>
<hr/>
<h3 data-number="27.4.13" id="defvaralias-lisp"><span class="header-section-number">27.4.13</span> Defvaralias
<code>[Lisp]</code></h3>
<p><strong>Definition:</strong> Makes one variable an alias for another,
so they share the same value.</p>
<p><strong>Context:</strong> Used for renaming variables while
maintaining backward compatibility.</p>
<p><strong>Related Terms:</strong> Alias, Variable, Compatibility</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/variables.texi</code></p>
<hr/>
<h3 data-number="27.4.14" id="describe-core"><span class="header-section-number">27.4.14</span> Describe
<code>[Core]</code></h3>
<p><strong>Definition:</strong> Help system commands that display
documentation for functions, variables, keys, modes, etc.</p>
<p><strong>Context:</strong> <code>C-h f</code> (describe-function),
<code>C-h v</code> (describe-variable), <code>C-h k</code>
(describe-key).</p>
<p><strong>Related Terms:</strong> Help, Documentation, Apropos,
Info</p>
<hr/>
<h3 data-number="27.4.15" id="display-engine-display"><span class="header-section-number">27.4.15</span> Display Engine
<code>[Display]</code></h3>
<p><strong>Definition:</strong> The subsystem responsible for converting
buffer contents into screen pixels.</p>
<p><strong>Context:</strong> Handles text rendering, faces, overlays,
images, and all visual presentation.</p>
<p><strong>Related Terms:</strong> Redisplay, Glyph Matrix, Font
Backend, Rendering</p>
<p><strong>Source:</strong> See <code>src/xdisp.c</code></p>
<hr/>
<h3 data-number="27.4.16" id="display-property-display"><span class="header-section-number">27.4.16</span> Display Property
<code>[Display]</code></h3>
<p><strong>Definition:</strong> A text property or overlay property that
controls how text is displayed.</p>
<p><strong>Context:</strong> Can insert images, change text appearance,
add margins, or hide text.</p>
<p><strong>Related Terms:</strong> Text Property, Overlay, Image,
Invisible Text</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/display.texi</code></p>
<hr/>
<h3 data-number="27.4.17" id="display-spec-display"><span class="header-section-number">27.4.17</span> Display Spec
<code>[Display]</code></h3>
<p><strong>Definition:</strong> A specification for the display property
describing how to render text or insert non-text elements.</p>
<p><strong>Context:</strong> Complex format supporting images, space
specs, margins, and composed text.</p>
<p><strong>Related Terms:</strong> Display Property, Image Spec, Space
Spec</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/display.texi</code></p>
<hr/>
<h3 data-number="27.4.18" id="display-table-data"><span class="header-section-number">27.4.18</span> Display Table
<code>[Data]</code></h3>
<p><strong>Definition:</strong> A char-table specifying how to display
each character, supporting character substitution.</p>
<p><strong>Context:</strong> Can display non-printing characters,
control characters, or alternative glyphs.</p>
<p><strong>Related Terms:</strong> Char Table, Glyph, Character
Display</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/display.texi</code></p>
<hr/>
<h3 data-number="27.4.19" id="dotted-pair-data"><span class="header-section-number">27.4.19</span> Dotted Pair
<code>[Data]</code></h3>
<p><strong>Definition:</strong> A cons cell written as
<code>(a . b)</code> where the cdr is not a list.</p>
<p><strong>Context:</strong> Differs from proper list. Used for alist
entries and simple key-value pairs.</p>
<p><strong>Related Terms:</strong> Cons Cell, Pair, Alist, Improper
List</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/lists.texi</code></p>
<hr/>
<h3 data-number="27.4.20" id="dtrt-abbrev"><span class="header-section-number">27.4.20</span> DTRT
<code>[Abbrev]</code></h3>
<p><strong>Definition:</strong> ‚ÄúDo The Right Thing‚Äù - Emacs philosophy
of automatic, intelligent default behavior.</p>
<p><strong>Context:</strong> Features that automatically adapt to
context without user configuration.</p>
<p><strong>Related Terms:</strong> DWIM, Smart Defaults, Heuristics</p>
<hr/>
<h3 data-number="27.4.21" id="dwim-abbrev"><span class="header-section-number">27.4.21</span> DWIM
<code>[Abbrev]</code></h3>
<p><strong>Definition:</strong> ‚ÄúDo What I Mean‚Äù - commands that infer
user intention from context.</p>
<p><strong>Context:</strong> Example: <code>comment-dwim</code> comments
or uncomments depending on region state.</p>
<p><strong>Related Terms:</strong> DTRT, Context-Aware, Smart
Command</p>
<hr/>
<h3 data-number="27.4.22" id="dynamic-binding-lisp"><span class="header-section-number">27.4.22</span> Dynamic Binding
<code>[Lisp]</code></h3>
<p><strong>Definition:</strong> Variable scoping where bindings are
looked up in the runtime call stack rather than lexical environment.</p>
<p><strong>Context:</strong> Emacs Lisp‚Äôs traditional scoping. Special
variables use dynamic binding even under lexical-binding mode.</p>
<p><strong>Related Terms:</strong> Lexical Binding, Scope, Special
Variable, Environment</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/variables.texi</code></p>
<hr/>
<h3 data-number="27.4.23" id="dynamic-module-system"><span class="header-section-number">27.4.23</span> Dynamic Module
<code>[System]</code></h3>
<p><strong>Definition:</strong> A shared library that extends Emacs with
native code, loaded at runtime.</p>
<p><strong>Context:</strong> Provides high-performance extensions in C
or other languages. Requires module support enabled.</p>
<p><strong>Related Terms:</strong> FFI, Native Code, Shared Library,
Plugin</p>
<p><strong>Documentation:</strong> See <code>doc/lispref/</code>
manual</p>
<hr/>
<h2 data-number="27.5" id="e"><span class="header-section-number">27.5</span> E</h2>
<h3 data-number="27.5.1" id="echo-area-core"><span class="header-section-number">27.5.1</span> Echo Area
<code>[Core]</code></h3>
<p><strong>Definition:</strong> The single-line region at the bottom of
a frame for displaying messages and minibuffer input.</p>
<p><strong>Context:</strong> Shares space with minibuffer. Shows command
feedback, errors, and prompts.</p>
<p><strong>Related Terms:</strong> Minibuffer, Mode Line, Message,
Frame</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/display.texi</code></p>
<hr/>
<h3 data-number="27.5.2" id="edebug-lisp"><span class="header-section-number">27.5.2</span> Edebug
<code>[Lisp]</code></h3>
<p><strong>Definition:</strong> A source-level debugger for Emacs Lisp
supporting breakpoints, stepping, and expression evaluation.</p>
<p><strong>Context:</strong> Instruments functions for debugging. More
powerful than basic debugger.</p>
<p><strong>Related Terms:</strong> Debugger, Breakpoint, Step, Debug</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/edebug.texi</code></p>
<hr/>
<h3 data-number="27.5.3" id="electric-core"><span class="header-section-number">27.5.3</span> Electric
<code>[Core]</code></h3>
<p><strong>Definition:</strong> Automatic behavior triggered by certain
characters, like auto-indentation or paren insertion.</p>
<p><strong>Context:</strong> Electric Pair Mode, Electric Indent Mode.
‚ÄúElectric‚Äù keys have special smart behavior.</p>
<p><strong>Related Terms:</strong> Auto-Indent, Automatic, Smart
Behavior</p>
<hr/>
<h3 data-number="27.5.4" id="elpa-abbrev"><span class="header-section-number">27.5.4</span> ELPA
<code>[Abbrev]</code></h3>
<p><strong>Definition:</strong> Emacs Lisp Package Archive - the
official package repository for Emacs.</p>
<p><strong>Context:</strong> Accessed via package.el. Contains curated,
GNU-compatible packages.</p>
<p><strong>Related Terms:</strong> Package, MELPA, Package Manager,
Repository</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/package.texi</code></p>
<hr/>
<h3 data-number="27.5.5" id="elc-file-lisp"><span class="header-section-number">27.5.5</span> .elc File
<code>[Lisp]</code></h3>
<p><strong>Definition:</strong> Byte-compiled Emacs Lisp file containing
byte code.</p>
<p><strong>Context:</strong> Produced by byte compiler from
<code>.el</code> source. Faster to load and execute.</p>
<p><strong>Related Terms:</strong> Byte Code, Compilation, .el File,
.eln File</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/compile.texi</code></p>
<hr/>
<h3 data-number="27.5.6" id="eln-file-lisp"><span class="header-section-number">27.5.6</span> .eln File
<code>[Lisp]</code></h3>
<p><strong>Definition:</strong> Native-compiled Emacs Lisp file
containing machine code.</p>
<p><strong>Context:</strong> Produced by native compiler (GCC
libgccjit). Significantly faster than byte code.</p>
<p><strong>Related Terms:</strong> Native Compilation, Byte Code, .elc
File</p>
<p><strong>Documentation:</strong> See Emacs manual</p>
<hr/>
<h3 data-number="27.5.7" id="emulation-mode-core"><span class="header-section-number">27.5.7</span> Emulation Mode
<code>[Core]</code></h3>
<p><strong>Definition:</strong> A minor mode that emulates key bindings
and behavior of another editor (vi, CUA, etc.).</p>
<p><strong>Context:</strong> Examples: viper-mode, cua-mode. Uses
special keymap precedence.</p>
<p><strong>Related Terms:</strong> Minor Mode, Keymap, Key Binding,
Compatibility</p>
<hr/>
<h3 data-number="27.5.8" id="environment-variable-system"><span class="header-section-number">27.5.8</span> Environment Variable
<code>[System]</code></h3>
<p><strong>Definition:</strong> OS-level variables inherited by Emacs
process, accessible via <code>getenv</code> and <code>setenv</code>.</p>
<p><strong>Context:</strong> Affects PATH, locale, terminal settings,
etc. Can be set per-process for subprocesses.</p>
<p><strong>Related Terms:</strong> Process Environment, System,
Shell</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/os.texi</code></p>
<hr/>
<h3 data-number="27.5.9" id="eol-convention-system"><span class="header-section-number">27.5.9</span> EOL Convention
<code>[System]</code></h3>
<p><strong>Definition:</strong> End-of-line character convention - LF
(Unix), CRLF (DOS/Windows), or CR (old Mac).</p>
<p><strong>Context:</strong> Part of coding system. Auto-detected and
preserved when editing files.</p>
<p><strong>Related Terms:</strong> Coding System, Line Ending,
Newline</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/nonascii.texi</code></p>
<hr/>
<h3 data-number="27.5.10" id="error-lisp"><span class="header-section-number">27.5.10</span> Error
<code>[Lisp]</code></h3>
<p><strong>Definition:</strong> An exceptional condition signaled during
execution, interrupting normal control flow.</p>
<p><strong>Context:</strong> Signaled by <code>error</code>,
<code>signal</code>, or implicitly. Can be caught with
<code>condition-case</code>.</p>
<p><strong>Related Terms:</strong> Signal, Condition, Exception, Error
Symbol</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/errors.texi</code></p>
<hr/>
<h3 data-number="27.5.11" id="error-symbol-lisp"><span class="header-section-number">27.5.11</span> Error Symbol
<code>[Lisp]</code></h3>
<p><strong>Definition:</strong> A symbol representing an error type,
with an error-conditions property defining its hierarchy.</p>
<p><strong>Context:</strong> Used in <code>signal</code> and caught in
<code>condition-case</code>. Examples: <code>error</code>,
<code>file-error</code>, <code>void-variable</code>.</p>
<p><strong>Related Terms:</strong> Error, Condition, Signal,
Exception</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/errors.texi</code></p>
<hr/>
<h3 data-number="27.5.12" id="eval-lisp"><span class="header-section-number">27.5.12</span> Eval
<code>[Lisp]</code></h3>
<p><strong>Definition:</strong> The function that evaluates a Lisp form,
executing code represented as data.</p>
<p><strong>Context:</strong> Core of Lisp interpretation. Rarely needed
explicitly; most code is automatically evaluated.</p>
<p><strong>Related Terms:</strong> Evaluation, Interpreter, REPL,
Read-Eval-Print Loop</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/eval.texi</code></p>
<hr/>
<h3 data-number="27.5.13" id="evaluation-lisp"><span class="header-section-number">27.5.13</span> Evaluation
<code>[Lisp]</code></h3>
<p><strong>Definition:</strong> The process of executing Lisp code by
interpreting or running its compiled form.</p>
<p><strong>Context:</strong> Self-evaluating objects (numbers, strings)
return themselves. Symbols are looked up. Lists are function calls.</p>
<p><strong>Related Terms:</strong> Eval, Interpreter, Execution,
Read</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/eval.texi</code></p>
<hr/>
<h3 data-number="27.5.14" id="event-system"><span class="header-section-number">27.5.14</span> Event
<code>[System]</code></h3>
<p><strong>Definition:</strong> A user input action like a key press,
mouse click, or system notification.</p>
<p><strong>Context:</strong> Read by command loop, processed via keymaps
to invoke commands.</p>
<p><strong>Related Terms:</strong> Key Event, Mouse Event, Command Loop,
Input</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/commands.texi</code></p>
<hr/>
<h3 data-number="27.5.15" id="extent-data-xemacs"><span class="header-section-number">27.5.15</span> Extent <code>[Data]</code>
(XEmacs)</h3>
<p><strong>Definition:</strong> XEmacs equivalent of overlays - not used
in GNU Emacs.</p>
<p><strong>Context:</strong> Historical term. GNU Emacs uses overlays
instead.</p>
<p><strong>Related Terms:</strong> Overlay, XEmacs, Text Property</p>
<hr/>
<h2 data-number="27.6" id="f"><span class="header-section-number">27.6</span> F</h2>
<h3 data-number="27.6.1" id="face-display"><span class="header-section-number">27.6.1</span> Face
<code>[Display]</code></h3>
<p><strong>Definition:</strong> A named collection of text display
attributes like font, color, size, and weight.</p>
<p><strong>Context:</strong> Applied via text properties or overlays.
Themes customize faces.</p>
<p><strong>Related Terms:</strong> Font, Color, Text Property, Theme,
Display</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/display.texi</code></p>
<hr/>
<h3 data-number="27.6.2" id="face-attribute-display"><span class="header-section-number">27.6.2</span> Face Attribute
<code>[Display]</code></h3>
<p><strong>Definition:</strong> A property of a face like
<code>:foreground</code>, <code>:background</code>,
<code>:weight</code>, <code>:slant</code>, <code>:height</code>, or
<code>:family</code>.</p>
<p><strong>Context:</strong> Set with <code>set-face-attribute</code>.
Can be specified per-frame or globally.</p>
<p><strong>Related Terms:</strong> Face, Font, Display, Theme</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/display.texi</code></p>
<hr/>
<h3 data-number="27.6.3" id="face-remapping-display"><span class="header-section-number">27.6.3</span> Face Remapping
<code>[Display]</code></h3>
<p><strong>Definition:</strong> Buffer-local override of face
definitions, changing appearance without affecting global faces.</p>
<p><strong>Context:</strong> Used by text-scale-mode and similar
features. Implemented via <code>face-remapping-alist</code>.</p>
<p><strong>Related Terms:</strong> Face, Buffer-Local, Display,
Theme</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/display.texi</code></p>
<hr/>
<h3 data-number="27.6.4" id="feature-lisp"><span class="header-section-number">27.6.4</span> Feature
<code>[Lisp]</code></h3>
<p><strong>Definition:</strong> A named collection of related
functionality, registered when loaded via <code>provide</code>.</p>
<p><strong>Context:</strong> Prevents redundant loading. Required via
<code>require</code>. Tracked in <code>features</code> list.</p>
<p><strong>Related Terms:</strong> Provide, Require, Library,
Package</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/loading.texi</code></p>
<hr/>
<h3 data-number="27.6.5" id="field-core"><span class="header-section-number">27.6.5</span> Field
<code>[Core]</code></h3>
<p><strong>Definition:</strong> A region of text with semantic meaning,
like a form input field or completion candidate.</p>
<p><strong>Context:</strong> Defined by <code>field</code> text
property. Commands can move between fields.</p>
<p><strong>Related Terms:</strong> Text Property, Form, Widget,
Minibuffer</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/text.texi</code></p>
<hr/>
<h3 data-number="27.6.6" id="file-handler-system"><span class="header-section-number">27.6.6</span> File Handler
<code>[System]</code></h3>
<p><strong>Definition:</strong> A function that intercepts file
operations for special file name patterns (remote files, archives,
etc.).</p>
<p><strong>Context:</strong> Registered in
<code>file-name-handler-alist</code>. Enables TRAMP, compressed files,
archives.</p>
<p><strong>Related Terms:</strong> TRAMP, File Name, Remote File, Magic
File Name</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/files.texi</code></p>
<hr/>
<h3 data-number="27.6.7" id="file-local-variable-core"><span class="header-section-number">27.6.7</span> File Local Variable
<code>[Core]</code></h3>
<p><strong>Definition:</strong> A variable setting specified in a file‚Äôs
header or footer, effective when that file is visited.</p>
<p><strong>Context:</strong> Format:
<code>-*- mode: emacs-lisp; -*-</code> or <code>Local Variables:</code>
block. Security restrictions apply.</p>
<p><strong>Related Terms:</strong> Local Variable, Directory Local
Variable, Safe Local Variable</p>
<p><strong>Documentation:</strong> See Emacs manual</p>
<hr/>
<h3 data-number="27.6.8" id="fill-core"><span class="header-section-number">27.6.8</span> Fill
<code>[Core]</code></h3>
<p><strong>Definition:</strong> Reformatting text to fit within a
specified column width by adjusting line breaks.</p>
<p><strong>Context:</strong> Auto Fill Mode fills while typing.
<code>fill-paragraph</code> fills existing text.</p>
<p><strong>Related Terms:</strong> Fill Column, Auto Fill, Line
Breaking, Paragraph</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/text.texi</code></p>
<hr/>
<h3 data-number="27.6.9" id="fill-column-core"><span class="header-section-number">27.6.9</span> Fill Column
<code>[Core]</code></h3>
<p><strong>Definition:</strong> The target column width for filling
text, typically 70 characters.</p>
<p><strong>Context:</strong> Set per-buffer. Controlled by
<code>fill-column</code> variable.</p>
<p><strong>Related Terms:</strong> Fill, Auto Fill Mode, Column, Line
Width</p>
<hr/>
<h3 data-number="27.6.10" id="fill-prefix-core"><span class="header-section-number">27.6.10</span> Fill Prefix
<code>[Core]</code></h3>
<p><strong>Definition:</strong> A string prepended to each line during
filling, typically for maintaining indentation or comment markers.</p>
<p><strong>Context:</strong> Set automatically in many modes. Used by
fill commands.</p>
<p><strong>Related Terms:</strong> Fill, Prefix, Indentation,
Paragraph</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/text.texi</code></p>
<hr/>
<h3 data-number="27.6.11" id="filter-system"><span class="header-section-number">27.6.11</span> Filter
<code>[System]</code></h3>
<p><strong>Definition:</strong> A function called when an async process
produces output, receiving the process and output string.</p>
<p><strong>Context:</strong> Set with <code>set-process-filter</code>.
Handles incremental output parsing.</p>
<p><strong>Related Terms:</strong> Process, Sentinel, Async, Output</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/processes.texi</code></p>
<hr/>
<h3 data-number="27.6.12" id="finalizer-lisp"><span class="header-section-number">27.6.12</span> Finalizer
<code>[Lisp]</code></h3>
<p><strong>Definition:</strong> A function automatically called when an
object is garbage collected.</p>
<p><strong>Context:</strong> Used for cleanup of external resources.
Created with <code>make-finalizer</code>.</p>
<p><strong>Related Terms:</strong> Garbage Collection, Cleanup, Resource
Management</p>
<p><strong>Documentation:</strong> See <code>doc/lispref/</code>
manual</p>
<hr/>
<h3 data-number="27.6.13" id="font-display"><span class="header-section-number">27.6.13</span> Font
<code>[Display]</code></h3>
<p><strong>Definition:</strong> A typeface with specific size, weight,
and style used for rendering text.</p>
<p><strong>Context:</strong> Specified in face definitions. Font backend
handles font selection and rendering.</p>
<p><strong>Related Terms:</strong> Face, Font Backend, Glyph,
Typeface</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/display.texi</code></p>
<hr/>
<h3 data-number="27.6.14" id="font-backend-display"><span class="header-section-number">27.6.14</span> Font Backend
<code>[Display]</code></h3>
<p><strong>Definition:</strong> The low-level subsystem for font
discovery, loading, and rendering (ftfont, xft, harfbuzz, etc.).</p>
<p><strong>Context:</strong> Platform-specific. Multiple backends may be
available. Handles complex text shaping.</p>
<p><strong>Related Terms:</strong> Font, Harfbuzz, Rendering, Display
Engine</p>
<p><strong>Source:</strong> See <code>src/font.c</code></p>
<hr/>
<h3 data-number="27.6.15" id="font-lock-mode-display"><span class="header-section-number">27.6.15</span> Font Lock Mode
<code>[Display]</code></h3>
<p><strong>Definition:</strong> A minor mode providing syntax
highlighting through pattern matching and face application.</p>
<p><strong>Context:</strong> Uses <code>font-lock-keywords</code> for
patterns. Nearly universal in programming modes.</p>
<p><strong>Related Terms:</strong> Syntax Highlighting, Face, Pattern,
Major Mode</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/modes.texi</code></p>
<hr/>
<h3 data-number="27.6.16" id="font-lock-keywords-display"><span class="header-section-number">27.6.16</span> Font Lock Keywords
<code>[Display]</code></h3>
<p><strong>Definition:</strong> A list of patterns and faces defining
how Font Lock Mode highlights text.</p>
<p><strong>Context:</strong> Can be matchers, functions, or complex
specs with subexpressions and anchoring.</p>
<p><strong>Related Terms:</strong> Font Lock, Syntax Highlighting,
Regexp, Face</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/modes.texi</code></p>
<hr/>
<h3 data-number="27.6.17" id="form-lisp"><span class="header-section-number">27.6.17</span> Form
<code>[Lisp]</code></h3>
<p><strong>Definition:</strong> Any Lisp object that can be evaluated as
code.</p>
<p><strong>Context:</strong> Includes self-evaluating objects, symbols,
and lists representing function calls or special forms.</p>
<p><strong>Related Terms:</strong> S-expression, Expression,
Evaluation</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/eval.texi</code></p>
<hr/>
<h3 data-number="27.6.18" id="frame-core"><span class="header-section-number">27.6.18</span> Frame
<code>[Core]</code></h3>
<p><strong>Definition:</strong> A graphical window (GUI) or terminal
screen containing one or more Emacs windows.</p>
<p><strong>Context:</strong> Each frame has independent window layout.
Created with <code>make-frame</code>.</p>
<p><strong>Related Terms:</strong> Window, Window-System, Terminal,
Display</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/frames.texi</code></p>
<hr/>
<h3 data-number="27.6.19" id="frame-parameter-display"><span class="header-section-number">27.6.19</span> Frame Parameter
<code>[Display]</code></h3>
<p><strong>Definition:</strong> A named property of a frame controlling
its appearance or behavior (size, position, font, etc.).</p>
<p><strong>Context:</strong> Get with <code>frame-parameter</code>, set
with <code>modify-frame-parameters</code>.</p>
<p><strong>Related Terms:</strong> Frame, Window Parameter,
Configuration</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/frames.texi</code></p>
<hr/>
<h3 data-number="27.6.20" id="fringe-display"><span class="header-section-number">27.6.20</span> Fringe
<code>[Display]</code></h3>
<p><strong>Definition:</strong> Narrow vertical strips on the left and
right edges of windows displaying indicators.</p>
<p><strong>Context:</strong> Shows continuation, truncation, line
wrapping, breakpoints, and custom bitmaps.</p>
<p><strong>Related Terms:</strong> Margin, Bitmap, Window, Indicator</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/display.texi</code></p>
<hr/>
<h3 data-number="27.6.21" id="function-lisp"><span class="header-section-number">27.6.21</span> Function
<code>[Lisp]</code></h3>
<p><strong>Definition:</strong> A callable Lisp object that performs
computation and returns a value.</p>
<p><strong>Context:</strong> Can be lambda expression, symbol naming a
function, byte-code object, or primitive.</p>
<p><strong>Related Terms:</strong> Lambda, Defun, Primitive, Call</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/functions.texi</code></p>
<hr/>
<h3 data-number="27.6.22" id="function-cell-lisp"><span class="header-section-number">27.6.22</span> Function Cell
<code>[Lisp]</code></h3>
<p><strong>Definition:</strong> The slot in a symbol that holds its
function definition.</p>
<p><strong>Context:</strong> Separate from value cell. Accessed with
<code>symbol-function</code>.</p>
<p><strong>Related Terms:</strong> Symbol, Value Cell, Namespace,
Function</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/symbols.texi</code></p>
<hr/>
<h2 data-number="27.7" id="g"><span class="header-section-number">27.7</span> G</h2>
<h3 data-number="27.7.1" id="gap-buffer-data"><span class="header-section-number">27.7.1</span> Gap Buffer
<code>[Data]</code></h3>
<p><strong>Definition:</strong> An efficient data structure for editable
text using a movable gap for fast insertion/deletion at point.</p>
<p><strong>Context:</strong> Core buffer implementation. Gap follows
point to optimize editing at cursor.</p>
<p><strong>Related Terms:</strong> Buffer, Point, Gap, Insertion,
GPT</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/buffers.texi</code></p>
<p><strong>Source:</strong> See <code>src/buffer.h</code>,
<code>src/insdel.c</code></p>
<hr/>
<h3 data-number="27.7.2" id="garbage-collection-gc-system"><span class="header-section-number">27.7.2</span> Garbage Collection (GC)
<code>[System]</code></h3>
<p><strong>Definition:</strong> Automatic memory management that
reclaims unused Lisp objects.</p>
<p><strong>Context:</strong> Triggered when allocation exceeds
threshold. Can cause brief pauses. Stats in <code>gc-elapsed</code>.</p>
<p><strong>Related Terms:</strong> Memory Management, GC Threshold,
Finalizer, Weak Reference</p>
<p><strong>Documentation:</strong> See <code>doc/lispref/</code>
manual</p>
<hr/>
<h3 data-number="27.7.3" id="generic-function-lisp"><span class="header-section-number">27.7.3</span> Generic Function
<code>[Lisp]</code></h3>
<p><strong>Definition:</strong> A function that dispatches to different
implementations based on argument types (polymorphism).</p>
<p><strong>Context:</strong> Implemented via cl-generic. Supports single
and multiple dispatch.</p>
<p><strong>Related Terms:</strong> Method, CLOS, Polymorphism,
Dispatch</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/functions.texi</code></p>
<hr/>
<h3 data-number="27.7.4" id="glyph-display"><span class="header-section-number">27.7.4</span> Glyph
<code>[Display]</code></h3>
<p><strong>Definition:</strong> A graphical representation of a
character or display element on screen.</p>
<p><strong>Context:</strong> One character may produce multiple glyphs
(ligatures) or one glyph may represent multiple characters
(compositions).</p>
<p><strong>Related Terms:</strong> Glyph Matrix, Font, Character,
Display</p>
<p><strong>Source:</strong> See <code>src/dispextern.h</code></p>
<hr/>
<h3 data-number="27.7.5" id="glyph-matrix-display"><span class="header-section-number">27.7.5</span> Glyph Matrix
<code>[Display]</code></h3>
<p><strong>Definition:</strong> Internal data structure holding the
glyphs to be displayed in a window, organized by rows.</p>
<p><strong>Context:</strong> Maintained by display engine. Current and
desired matrices compared for efficient redisplay.</p>
<p><strong>Related Terms:</strong> Glyph, Redisplay, Display Engine,
Window</p>
<p><strong>Source:</strong> See <code>src/dispextern.h</code></p>
<hr/>
<h3 data-number="27.7.6" id="goal-column-core"><span class="header-section-number">27.7.6</span> Goal Column
<code>[Core]</code></h3>
<p><strong>Definition:</strong> The target column for vertical cursor
movement, maintained across lines of different lengths.</p>
<p><strong>Context:</strong> Preserves horizontal position when moving
through short lines. Can be set explicitly.</p>
<p><strong>Related Terms:</strong> Column, Vertical Motion, Track-EOL,
Cursor</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/positions.texi</code></p>
<hr/>
<h3 data-number="27.7.7" id="gpt-gpt_byte-data"><span class="header-section-number">27.7.7</span> GPT / GPT_BYTE
<code>[Data]</code></h3>
<p><strong>Definition:</strong> Gap PosiTion - macros for the position
of the buffer gap in characters and bytes.</p>
<p><strong>Context:</strong> C internals of gap buffer. Gap moves to
follow editing location.</p>
<p><strong>Related Terms:</strong> Gap Buffer, Buffer, Point, Z</p>
<p><strong>Source:</strong> See <code>src/buffer.h</code></p>
<hr/>
<h2 data-number="27.8" id="h"><span class="header-section-number">27.8</span> H</h2>
<h3 data-number="27.8.1" id="hash-table-data"><span class="header-section-number">27.8.1</span> Hash Table
<code>[Data]</code></h3>
<p><strong>Definition:</strong> An efficient key-value mapping data
structure with O(1) average lookup time.</p>
<p><strong>Context:</strong> Created with <code>make-hash-table</code>.
More efficient than alists for large datasets.</p>
<p><strong>Related Terms:</strong> Alist, Plist, Dictionary, Map</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/hash.texi</code></p>
<hr/>
<h3 data-number="27.8.2" id="header-line-display"><span class="header-section-number">27.8.2</span> Header Line
<code>[Display]</code></h3>
<p><strong>Definition:</strong> An optional first line in a window
displaying persistent information, separate from buffer contents.</p>
<p><strong>Context:</strong> Controlled by
<code>header-line-format</code>. Similar to mode line but at top of
window.</p>
<p><strong>Related Terms:</strong> Mode Line, Window, Display, Format
Spec</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/modes.texi</code></p>
<hr/>
<h3 data-number="27.8.3" id="help-core"><span class="header-section-number">27.8.3</span> Help
<code>[Core]</code></h3>
<p><strong>Definition:</strong> The comprehensive documentation system
providing function, variable, and key descriptions.</p>
<p><strong>Context:</strong> Accessed via <code>C-h</code> prefix.
Includes apropos, describe commands, info reader.</p>
<p><strong>Related Terms:</strong> Describe, Apropos, Info,
Documentation</p>
<p><strong>Documentation:</strong> See Emacs manual</p>
<hr/>
<h3 data-number="27.8.4" id="hook-system-1"><span class="header-section-number">27.8.4</span> Hook
<code>[System]</code></h3>
<p><strong>Definition:</strong> A variable holding a list of functions
called at specific points in execution.</p>
<p><strong>Context:</strong> Functions run via <code>run-hooks</code>.
Normal hooks take no arguments. Abnormal hooks may take arguments or
affect control flow.</p>
<p><strong>Related Terms:</strong> Normal Hook, Abnormal Hook, Add-Hook,
Callback</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/hooks.texi</code></p>
<hr/>
<h3 data-number="27.8.5" id="horizontal-scrolling-display"><span class="header-section-number">27.8.5</span> Horizontal Scrolling
<code>[Display]</code></h3>
<p><strong>Definition:</strong> Shifting displayed text left or right
within a window to view content beyond window width.</p>
<p><strong>Context:</strong> Automatic in truncate-lines mode. Manual
via <code>scroll-left</code>/<code>scroll-right</code>.</p>
<p><strong>Related Terms:</strong> Truncation, Scroll, Window,
Display</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/windows.texi</code></p>
<hr/>
<h2 data-number="27.9" id="i"><span class="header-section-number">27.9</span> I</h2>
<h3 data-number="27.9.1" id="idle-timer-system"><span class="header-section-number">27.9.1</span> Idle Timer
<code>[System]</code></h3>
<p><strong>Definition:</strong> A timer that fires after Emacs has been
idle (no user input) for a specified duration.</p>
<p><strong>Context:</strong> Created with
<code>run-with-idle-timer</code>. Used for background tasks, auto-save,
etc.</p>
<p><strong>Related Terms:</strong> Timer, Idle, Background Task,
Auto-Save</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/os.texi</code></p>
<hr/>
<h3 data-number="27.9.2" id="image-display"><span class="header-section-number">27.9.2</span> Image
<code>[Display]</code></h3>
<p><strong>Definition:</strong> A graphical picture displayed in a
buffer via display property or overlay.</p>
<p><strong>Context:</strong> Supports various formats (PNG, JPEG, SVG,
etc.). Can be inline or in margins.</p>
<p><strong>Related Terms:</strong> Display Property, Image Spec, Icon,
Graphic</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/display.texi</code></p>
<hr/>
<h3 data-number="27.9.3" id="image-descriptor-display"><span class="header-section-number">27.9.3</span> Image Descriptor
<code>[Display]</code></h3>
<p><strong>Definition:</strong> A Lisp structure specifying an image‚Äôs
type, source, and display properties.</p>
<p><strong>Context:</strong> Format:
<code>(image :type png :file "..." :scale 1.5)</code>. Used in display
specs.</p>
<p><strong>Related Terms:</strong> Image, Display Property, Image
Spec</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/display.texi</code></p>
<hr/>
<h3 data-number="27.9.4" id="imenu-core"><span class="header-section-number">27.9.4</span> Imenu
<code>[Core]</code></h3>
<p><strong>Definition:</strong> Index Menu - a system for creating
navigable indices of definitions in a buffer.</p>
<p><strong>Context:</strong> Generates menu of functions, classes, etc.
Customized per major mode.</p>
<p><strong>Related Terms:</strong> Which-Function, Index, Navigation,
Menu</p>
<hr/>
<h3 data-number="27.9.5" id="indentation-core"><span class="header-section-number">27.9.5</span> Indentation
<code>[Core]</code></h3>
<p><strong>Definition:</strong> Horizontal spacing at the beginning of
lines, typically for code structure visualization.</p>
<p><strong>Context:</strong> Controlled by major mode. Electric Indent
Mode automates indentation.</p>
<p><strong>Related Terms:</strong> Tab, Column, Electric, SMIE, Indent
Function</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/modes.texi</code></p>
<hr/>
<h3 data-number="27.9.6" id="indent-function-core"><span class="header-section-number">27.9.6</span> Indent Function
<code>[Core]</code></h3>
<p><strong>Definition:</strong> A function that calculates or performs
indentation, typically set by major mode.</p>
<p><strong>Context:</strong> Stored in
<code>indent-line-function</code>. Called by TAB and electric
indent.</p>
<p><strong>Related Terms:</strong> Indentation, Major Mode, SMIE,
Syntax</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/modes.texi</code></p>
<hr/>
<h3 data-number="27.9.7" id="indirect-buffer-core"><span class="header-section-number">27.9.7</span> Indirect Buffer
<code>[Core]</code></h3>
<p><strong>Definition:</strong> A buffer that shares text with another
(base) buffer but has independent point, mark, and local variables.</p>
<p><strong>Context:</strong> Created with
<code>make-indirect-buffer</code>. Useful for multiple views of same
content with different modes.</p>
<p><strong>Related Terms:</strong> Buffer, Base Buffer, Clone Buffer</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/buffers.texi</code></p>
<hr/>
<h3 data-number="27.9.8" id="info-core"><span class="header-section-number">27.9.8</span> Info
<code>[Core]</code></h3>
<p><strong>Definition:</strong> Emacs‚Äôs built-in hypertext documentation
reader for Texinfo manuals.</p>
<p><strong>Context:</strong> Accessed via <code>C-h i</code>. Contains
Emacs, Elisp, and package documentation.</p>
<p><strong>Related Terms:</strong> Manual, Documentation, Texinfo,
Help</p>
<p><strong>Documentation:</strong> See
<code>doc/misc/info.texi</code></p>
<hr/>
<h3 data-number="27.9.9" id="inhibit-quit-system"><span class="header-section-number">27.9.9</span> Inhibit Quit
<code>[System]</code></h3>
<p><strong>Definition:</strong> A variable that, when non-nil, prevents
<code>C-g</code> from interrupting execution.</p>
<p><strong>Context:</strong> Used for critical sections requiring
atomicity. Use sparingly to avoid hanging Emacs.</p>
<p><strong>Related Terms:</strong> Quit, C-g, Interrupt, Critical
Section</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/commands.texi</code></p>
<hr/>
<h3 data-number="27.9.10" id="init-file-core"><span class="header-section-number">27.9.10</span> Init File
<code>[Core]</code></h3>
<p><strong>Definition:</strong> The user‚Äôs Emacs configuration file,
typically <code>~/.emacs</code> or <code>~/.emacs.d/init.el</code>.</p>
<p><strong>Context:</strong> Loaded at startup. Contains personal
customizations, package configuration, etc.</p>
<p><strong>Related Terms:</strong> Configuration, Startup, .emacs, Early
Init File</p>
<p><strong>Documentation:</strong> See Emacs manual</p>
<hr/>
<h3 data-number="27.9.11" id="input-focus-display"><span class="header-section-number">27.9.11</span> Input Focus
<code>[Display]</code></h3>
<p><strong>Definition:</strong> The keyboard and interaction target,
determining which frame and window receives input events.</p>
<p><strong>Context:</strong> Managed by window manager.
<code>select-frame-set-input-focus</code> sets focus.</p>
<p><strong>Related Terms:</strong> Frame, Selected Window, Event,
Focus</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/frames.texi</code></p>
<hr/>
<h3 data-number="27.9.12" id="input-method-system"><span class="header-section-number">27.9.12</span> Input Method
<code>[System]</code></h3>
<p><strong>Definition:</strong> A system for inputting characters not
directly available on the keyboard, like CJK characters or accents.</p>
<p><strong>Context:</strong> Activated with <code>C-\</code>. Many
methods available for different languages and scripts.</p>
<p><strong>Related Terms:</strong> Multilingual, Quail, Character Input,
IME</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/nonascii.texi</code></p>
<hr/>
<h3 data-number="27.9.13" id="insertion-core"><span class="header-section-number">27.9.13</span> Insertion
<code>[Core]</code></h3>
<p><strong>Definition:</strong> Adding text to a buffer, increasing
buffer size and updating markers and overlays.</p>
<p><strong>Context:</strong> Performed by <code>insert</code>,
<code>insert-char</code>, <code>insert-file-contents</code>, etc.
Undoable.</p>
<p><strong>Related Terms:</strong> Deletion, Point, Gap Buffer,
Modification</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/text.texi</code></p>
<hr/>
<h3 data-number="27.9.14" id="insertion-type-data"><span class="header-section-number">27.9.14</span> Insertion Type
<code>[Data]</code></h3>
<p><strong>Definition:</strong> A marker property determining whether
the marker stays before or after text inserted at its position.</p>
<p><strong>Context:</strong> Set with
<code>set-marker-insertion-type</code>. Default is before (marker
advances).</p>
<p><strong>Related Terms:</strong> Marker, Insertion, Point,
Relocation</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/markers.texi</code></p>
<hr/>
<h3 data-number="27.9.15" id="interactive-lisp"><span class="header-section-number">27.9.15</span> Interactive
<code>[Lisp]</code></h3>
<p><strong>Definition:</strong> A special form declaring a function as a
command and specifying how to obtain its arguments interactively.</p>
<p><strong>Context:</strong> Takes an interactive spec. Enables
<code>M-x</code> invocation and key binding.</p>
<p><strong>Related Terms:</strong> Command, Interactive Spec, M-x, Call
Interactively</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/commands.texi</code></p>
<hr/>
<h3 data-number="27.9.16" id="interactive-spec-lisp"><span class="header-section-number">27.9.16</span> Interactive Spec
<code>[Lisp]</code></h3>
<p><strong>Definition:</strong> A string or form in
<code>interactive</code> describing how to read command arguments from
the user.</p>
<p><strong>Context:</strong> Code characters specify argument types:
<code>s</code> for string, <code>r</code> for region, <code>P</code> for
prefix arg, etc.</p>
<p><strong>Related Terms:</strong> Interactive, Command, Argument,
Prompt</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/commands.texi</code></p>
<hr/>
<h3 data-number="27.9.17" id="interpreter-lisp"><span class="header-section-number">27.9.17</span> Interpreter
<code>[Lisp]</code></h3>
<p><strong>Definition:</strong> The component of Emacs that evaluates
Lisp forms directly without compilation.</p>
<p><strong>Context:</strong> Slower than byte code or native code but
always available. Used for interactive evaluation.</p>
<p><strong>Related Terms:</strong> Evaluation, Byte Code, Native
Compilation, Eval</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/eval.texi</code></p>
<hr/>
<h3 data-number="27.9.18" id="interval-data"><span class="header-section-number">27.9.18</span> Interval
<code>[Data]</code></h3>
<p><strong>Definition:</strong> An internal data structure for storing
text properties efficiently over ranges of text.</p>
<p><strong>Context:</strong> Forms an interval tree. Users don‚Äôt
manipulate intervals directly; they work with text properties.</p>
<p><strong>Related Terms:</strong> Interval Tree, Text Property, Data
Structure</p>
<p><strong>Source:</strong> See <code>src/intervals.h</code></p>
<hr/>
<h3 data-number="27.9.19" id="interval-tree-data"><span class="header-section-number">27.9.19</span> Interval Tree
<code>[Data]</code></h3>
<p><strong>Definition:</strong> A balanced tree data structure for
efficiently storing and querying text properties over text ranges.</p>
<p><strong>Context:</strong> Internal implementation detail. Provides
O(log n) property lookup and modification.</p>
<p><strong>Related Terms:</strong> Interval, Text Property, Balanced
Tree, itree</p>
<p><strong>Source:</strong> See <code>src/intervals.h</code>,
<code>src/itree.c</code></p>
<hr/>
<h3 data-number="27.9.20" id="invisible-text-display"><span class="header-section-number">27.9.20</span> Invisible Text
<code>[Display]</code></h3>
<p><strong>Definition:</strong> Text marked with the
<code>invisible</code> property that is not displayed but remains in the
buffer.</p>
<p><strong>Context:</strong> Used for outlining, narrowing, and hiding
details. Point can skip over invisible text.</p>
<p><strong>Related Terms:</strong> Display Property, Text Property,
Outline, Ellipsis</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/display.texi</code></p>
<hr/>
<h3 data-number="27.9.21" id="isearch-core"><span class="header-section-number">27.9.21</span> Isearch
<code>[Core]</code></h3>
<p><strong>Definition:</strong> Incremental Search - an interactive
search mode showing matches as you type.</p>
<p><strong>Context:</strong> Started with <code>C-s</code>. Supports
regexp, word search, symbol search, and many variants.</p>
<p><strong>Related Terms:</strong> Search, Regexp, Incremental,
Replace</p>
<hr/>
<h2 data-number="27.10" id="j"><span class="header-section-number">27.10</span> J</h2>
<h3 data-number="27.10.1" id="jit-lock-display"><span class="header-section-number">27.10.1</span> JIT Lock
<code>[Display]</code></h3>
<p><strong>Definition:</strong> Just-In-Time syntax highlighting that
fontifies text as it becomes visible.</p>
<p><strong>Context:</strong> Defers fontification for performance.
Operates in chunks during redisplay.</p>
<p><strong>Related Terms:</strong> Font Lock, Fontification, Lazy,
Performance</p>
<p><strong>Documentation:</strong> See <code>lisp/jit-lock.el</code></p>
<hr/>
<h2 data-number="27.11" id="k"><span class="header-section-number">27.11</span> K</h2>
<h3 data-number="27.11.1" id="keyboard-macro-core"><span class="header-section-number">27.11.1</span> Keyboard Macro
<code>[Core]</code></h3>
<p><strong>Definition:</strong> A recorded sequence of keystrokes that
can be replayed to automate repetitive tasks.</p>
<p><strong>Context:</strong> Record with <code>C-x (</code>, stop with
<code>C-x )</code>, execute with <code>C-x e</code>. Can be named and
saved.</p>
<p><strong>Related Terms:</strong> Macro, Automation, Replay,
Command</p>
<p><strong>Documentation:</strong> See Emacs manual</p>
<hr/>
<h3 data-number="27.11.2" id="key-binding-core"><span class="header-section-number">27.11.2</span> Key Binding
<code>[Core]</code></h3>
<p><strong>Definition:</strong> An association between a key sequence
and a command in a keymap.</p>
<p><strong>Context:</strong> Created with <code>define-key</code>,
<code>global-set-key</code>, etc. Queried with
<code>describe-key</code>.</p>
<p><strong>Related Terms:</strong> Keymap, Key Sequence, Command,
Binding</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/keymaps.texi</code></p>
<hr/>
<h3 data-number="27.11.3" id="key-sequence-core"><span class="header-section-number">27.11.3</span> Key Sequence
<code>[Core]</code></h3>
<p><strong>Definition:</strong> A sequence of one or more key events
that can be bound to a command.</p>
<p><strong>Context:</strong> Examples: <code>C-x C-f</code>,
<code>M-x</code>, <code>C-c C-c</code>. Can include mouse events and
modifiers.</p>
<p><strong>Related Terms:</strong> Key Binding, Event, Prefix Key,
Keymap</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/keymaps.texi</code></p>
<hr/>
<h3 data-number="27.11.4" id="keymap-core"><span class="header-section-number">27.11.4</span> Keymap
<code>[Core]</code></h3>
<p><strong>Definition:</strong> A data structure mapping key sequences
to commands or other keymaps.</p>
<p><strong>Context:</strong> Multiple keymaps active simultaneously with
precedence rules. Can be sparse or full.</p>
<p><strong>Related Terms:</strong> Key Binding, Key Sequence, Active
Keymap, Prefix Key</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/keymaps.texi</code></p>
<hr/>
<h3 data-number="27.11.5" id="kill-abbrev-core"><span class="header-section-number">27.11.5</span> Kill <code>[Abbrev]</code>
<code>[Core]</code></h3>
<p><strong>Definition:</strong> Cutting or deleting text, saving it to
the kill ring for later yanking (pasting).</p>
<p><strong>Context:</strong> Unlike most editors‚Äô ‚Äúcut‚Äù, killed text is
added to a ring, not replacing previous kills.</p>
<p><strong>Related Terms:</strong> Kill Ring, Yank, Cut, Delete</p>
<p><strong>Documentation:</strong> See Emacs manual</p>
<hr/>
<h3 data-number="27.11.6" id="kill-ring-core"><span class="header-section-number">27.11.6</span> Kill Ring
<code>[Core]</code></h3>
<p><strong>Definition:</strong> A ring buffer storing previously killed
text, allowing retrieval of earlier kills.</p>
<p><strong>Context:</strong> <code>C-y</code> yanks most recent kill.
<code>M-y</code> cycles through kill ring.</p>
<p><strong>Related Terms:</strong> Kill, Yank, Clipboard, Ring
Buffer</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/text.texi</code></p>
<hr/>
<h3 data-number="27.11.7" id="killing-buffers-core"><span class="header-section-number">27.11.7</span> Killing Buffers
<code>[Core]</code></h3>
<p><strong>Definition:</strong> Removing a buffer from Emacs, freeing
its memory and closing any associated file.</p>
<p><strong>Context:</strong> Done with <code>kill-buffer</code>. Unsaved
changes prompt for confirmation.</p>
<p><strong>Related Terms:</strong> Buffer, Buried Buffer, Buffer
List</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/buffers.texi</code></p>
<hr/>
<h2 data-number="27.12" id="l"><span class="header-section-number">27.12</span> L</h2>
<h3 data-number="27.12.1" id="lambda-lisp"><span class="header-section-number">27.12.1</span> Lambda
<code>[Lisp]</code></h3>
<p><strong>Definition:</strong> An anonymous function definition created
with the <code>lambda</code> special form.</p>
<p><strong>Context:</strong> Creates a function object without naming
it. Often used as arguments to higher-order functions.</p>
<p><strong>Related Terms:</strong> Function, Anonymous Function,
Closure, Defun</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/functions.texi</code></p>
<hr/>
<h3 data-number="27.12.2" id="lambda-list-lisp"><span class="header-section-number">27.12.2</span> Lambda List
<code>[Lisp]</code></h3>
<p><strong>Definition:</strong> The parameter list of a lambda or defun,
possibly including <code>&amp;optional</code>, <code>&amp;rest</code>,
or <code>&amp;key</code>.</p>
<p><strong>Context:</strong> Specifies function arguments and their
types (required, optional, rest, keyword).</p>
<p><strong>Related Terms:</strong> Argument List, Lambda, Parameter,
Function</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/functions.texi</code></p>
<hr/>
<h3 data-number="27.12.3" id="lap-lisp"><span class="header-section-number">27.12.3</span> LAP
<code>[Lisp]</code></h3>
<p><strong>Definition:</strong> Lisp Assembly Program - a human-readable
representation of byte code.</p>
<p><strong>Context:</strong> Intermediate format between Lisp and byte
code. Used in byte compiler implementation.</p>
<p><strong>Related Terms:</strong> Byte Code, Disassembly, Byte
Compiler, Assembly</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/compile.texi</code></p>
<hr/>
<h3 data-number="27.12.4" id="lazy-loading-lisp"><span class="header-section-number">27.12.4</span> Lazy Loading
<code>[Lisp]</code></h3>
<p><strong>Definition:</strong> Deferring the loading of code until it‚Äôs
actually needed, improving startup time.</p>
<p><strong>Context:</strong> Implemented via autoload. Essential for
keeping Emacs responsive.</p>
<p><strong>Related Terms:</strong> Autoload, Feature, Loading,
Performance</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/loading.texi</code></p>
<hr/>
<h3 data-number="27.12.5" id="let-binding-lisp"><span class="header-section-number">27.12.5</span> Let Binding
<code>[Lisp]</code></h3>
<p><strong>Definition:</strong> A local variable binding created by
<code>let</code> or <code>let*</code>, shadowing outer bindings in its
scope.</p>
<p><strong>Context:</strong> <code>let</code> binds in parallel,
<code>let*</code> binds sequentially. Lexical or dynamic depending on
<code>lexical-binding</code>.</p>
<p><strong>Related Terms:</strong> Scope, Binding, Local Variable,
Lexical Binding</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/variables.texi</code></p>
<hr/>
<h3 data-number="27.12.6" id="lexical-binding-lisp"><span class="header-section-number">27.12.6</span> Lexical Binding
<code>[Lisp]</code></h3>
<p><strong>Definition:</strong> Variable scoping where bindings are
determined by textual structure rather than runtime call stack.</p>
<p><strong>Context:</strong> Enabled by <code>lexical-binding: t</code>
file header. Enables closures and better optimization.</p>
<p><strong>Related Terms:</strong> Dynamic Binding, Scope, Closure,
Environment</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/variables.texi</code></p>
<hr/>
<h3 data-number="27.12.7" id="library-lisp"><span class="header-section-number">27.12.7</span> Library
<code>[Lisp]</code></h3>
<p><strong>Definition:</strong> A file or collection of files providing
related functionality, loaded as a unit.</p>
<p><strong>Context:</strong> Loaded with <code>load-library</code> or
<code>require</code>. Provides features.</p>
<p><strong>Related Terms:</strong> Feature, Require, Package, Load</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/loading.texi</code></p>
<hr/>
<h3 data-number="27.12.8" id="line-number-core"><span class="header-section-number">27.12.8</span> Line Number
<code>[Core]</code></h3>
<p><strong>Definition:</strong> The sequential position of a line in a
buffer, starting from 1.</p>
<p><strong>Context:</strong> Display-line-numbers-mode shows line
numbers in margin. <code>line-number-at-pos</code> gets number.</p>
<p><strong>Related Terms:</strong> Line, Position, Margin, Display</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/positions.texi</code></p>
<hr/>
<h3 data-number="27.12.9" id="line-wrapping-display"><span class="header-section-number">27.12.9</span> Line Wrapping
<code>[Display]</code></h3>
<p><strong>Definition:</strong> Continuing long logical lines on
multiple screen lines rather than truncating.</p>
<p><strong>Context:</strong> Controlled by <code>truncate-lines</code>.
Visual-line-mode provides word wrapping.</p>
<p><strong>Related Terms:</strong> Continuation Line, Truncation, Visual
Line, Word Wrap</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/display.texi</code></p>
<hr/>
<h3 data-number="27.12.10" id="lisp_object-lisp-data"><span class="header-section-number">27.12.10</span> Lisp_Object
<code>[Lisp]</code> <code>[Data]</code></h3>
<p><strong>Definition:</strong> The fundamental C type representing any
Emacs Lisp value.</p>
<p><strong>Context:</strong> Tagged pointer encoding type and value.
Core of C implementation.</p>
<p><strong>Related Terms:</strong> Tagged Pointer, C Source, Type,
Value</p>
<p><strong>Source:</strong> See <code>src/lisp.h</code></p>
<hr/>
<h3 data-number="27.12.11" id="list-data"><span class="header-section-number">27.12.11</span> List
<code>[Data]</code></h3>
<p><strong>Definition:</strong> A sequence of cons cells linked by their
cdr pointers, terminated by nil.</p>
<p><strong>Context:</strong> Fundamental data structure in Lisp. Proper
lists end in nil. Improper lists end otherwise.</p>
<p><strong>Related Terms:</strong> Cons Cell, Nil, Proper List, Car,
Cdr</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/lists.texi</code></p>
<hr/>
<h3 data-number="27.12.12" id="load-lisp"><span class="header-section-number">27.12.12</span> Load
<code>[Lisp]</code></h3>
<p><strong>Definition:</strong> Reading and evaluating Lisp code from a
file.</p>
<p><strong>Context:</strong> Performed by <code>load</code>,
<code>require</code>, or during startup. Can load <code>.el</code>,
<code>.elc</code>, or <code>.eln</code> files.</p>
<p><strong>Related Terms:</strong> Require, Feature, Loading, Eval</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/loading.texi</code></p>
<hr/>
<h3 data-number="27.12.13" id="load-path-lisp"><span class="header-section-number">27.12.13</span> Load Path
<code>[Lisp]</code></h3>
<p><strong>Definition:</strong> A list of directories searched when
loading libraries, stored in <code>load-path</code> variable.</p>
<p><strong>Context:</strong> Modified by packages, users, and site
configuration. Order matters.</p>
<p><strong>Related Terms:</strong> Load, Library, Require, Path</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/loading.texi</code></p>
<hr/>
<h3 data-number="27.12.14" id="local-keymap-core"><span class="header-section-number">27.12.14</span> Local Keymap
<code>[Core]</code></h3>
<p><strong>Definition:</strong> A buffer-local or mode-specific keymap
containing bindings for that context.</p>
<p><strong>Context:</strong> Major and minor modes install local
keymaps. Overrides global keymap.</p>
<p><strong>Related Terms:</strong> Keymap, Buffer-Local, Major Mode,
Minor Mode</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/keymaps.texi</code></p>
<hr/>
<h3 data-number="27.12.15" id="local-variable-lisp"><span class="header-section-number">27.12.15</span> Local Variable
<code>[Lisp]</code></h3>
<p><strong>Definition:</strong> A variable whose binding is limited to a
specific scope (let binding, function parameter, or buffer-local).</p>
<p><strong>Context:</strong> Contrasts with global/special variables
visible everywhere.</p>
<p><strong>Related Terms:</strong> Let Binding, Buffer-Local Variable,
Scope, Binding</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/variables.texi</code></p>
<hr/>
<h3 data-number="27.12.16" id="locking-system"><span class="header-section-number">27.12.16</span> Locking
<code>[System]</code></h3>
<p><strong>Definition:</strong> A mechanism to prevent simultaneous
editing of a file by multiple processes.</p>
<p><strong>Context:</strong> Creates symbolic link lock file. Can be
disabled with <code>create-lockfiles</code>.</p>
<p><strong>Related Terms:</strong> File, Concurrent Editing, Lock File,
Version Control</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/files.texi</code></p>
<hr/>
<h3 data-number="27.12.17" id="lsp-abbrev"><span class="header-section-number">27.12.17</span> LSP
<code>[Abbrev]</code></h3>
<p><strong>Definition:</strong> Language Server Protocol - a standard
for IDE features like completion, navigation, and refactoring.</p>
<p><strong>Context:</strong> Supported by eglot and lsp-mode packages.
Modern alternative to CEDET.</p>
<p><strong>Related Terms:</strong> Eglot, lsp-mode, IDE, Language
Server</p>
<p><strong>Documentation:</strong> See
<code>doc/misc/eglot.texi</code></p>
<hr/>
<h2 data-number="27.13" id="m"><span class="header-section-number">27.13</span> M</h2>
<h3 data-number="27.13.1" id="m-x-core"><span class="header-section-number">27.13.1</span> M-x
<code>[Core]</code></h3>
<p><strong>Definition:</strong> The key sequence (Meta-x or Alt-x) for
executing commands by name.</p>
<p><strong>Context:</strong> Provides access to all interactive
commands. Supports completion and history.</p>
<p><strong>Related Terms:</strong> Execute Extended Command, Command,
Interactive</p>
<hr/>
<h3 data-number="27.13.2" id="macro-lisp"><span class="header-section-number">27.13.2</span> Macro
<code>[Lisp]</code></h3>
<p><strong>Definition:</strong> A special function that transforms code
at compile/read time rather than runtime.</p>
<p><strong>Context:</strong> Defined with <code>defmacro</code>.
Receives unevaluated arguments, returns code to evaluate.</p>
<p><strong>Related Terms:</strong> Defmacro, Macro Expansion, Backquote,
Special Form</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/macros.texi</code></p>
<hr/>
<h3 data-number="27.13.3" id="macro-expansion-lisp"><span class="header-section-number">27.13.3</span> Macro Expansion
<code>[Lisp]</code></h3>
<p><strong>Definition:</strong> The process of applying a macro to its
arguments to produce expanded code.</p>
<p><strong>Context:</strong> Happens at compile time (byte compilation)
or read time. Can be inspected with <code>macroexpand</code>.</p>
<p><strong>Related Terms:</strong> Macro, Compile Time, Defmacro,
Evaluation</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/macros.texi</code></p>
<hr/>
<h3 data-number="27.13.4" id="major-mode-core"><span class="header-section-number">27.13.4</span> Major Mode
<code>[Core]</code></h3>
<p><strong>Definition:</strong> A buffer-local mode defining primary
editing behavior, syntax, key bindings, and commands for a file
type.</p>
<p><strong>Context:</strong> Each buffer has exactly one major mode.
Examples: emacs-lisp-mode, python-mode, text-mode.</p>
<p><strong>Related Terms:</strong> Minor Mode, Mode, Derived Mode, Mode
Hook</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/modes.texi</code></p>
<hr/>
<h3 data-number="27.13.5" id="margin-display"><span class="header-section-number">27.13.5</span> Margin
<code>[Display]</code></h3>
<p><strong>Definition:</strong> White space on the left or right edge of
a window, outside the text area, for displaying annotations.</p>
<p><strong>Context:</strong> Can display text, images, or be empty.
Distinct from fringe.</p>
<p><strong>Related Terms:</strong> Fringe, Display Property, Window,
Annotation</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/display.texi</code></p>
<hr/>
<h3 data-number="27.13.6" id="mark-core"><span class="header-section-number">27.13.6</span> Mark
<code>[Core]</code></h3>
<p><strong>Definition:</strong> A saved buffer position marking one end
of the region, with point marking the other end.</p>
<p><strong>Context:</strong> Set with <code>C-SPC</code>. Can be
inactive (invisible) or active (visible region).</p>
<p><strong>Related Terms:</strong> Point, Region, Mark Ring, Marker</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/markers.texi</code></p>
<hr/>
<h3 data-number="27.13.7" id="mark-ring-core"><span class="header-section-number">27.13.7</span> Mark Ring
<code>[Core]</code></h3>
<p><strong>Definition:</strong> A buffer-local ring of previously set
mark positions, allowing navigation to earlier marks.</p>
<p><strong>Context:</strong> <code>C-u C-SPC</code> pops mark ring.
Separate from global mark ring.</p>
<p><strong>Related Terms:</strong> Mark, Ring Buffer, Navigation,
Point</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/markers.texi</code></p>
<hr/>
<h3 data-number="27.13.8" id="marker-data"><span class="header-section-number">27.13.8</span> Marker
<code>[Data]</code></h3>
<p><strong>Definition:</strong> A Lisp object representing a buffer
position that automatically updates when text is inserted or
deleted.</p>
<p><strong>Context:</strong> Unlike integer positions, markers track the
conceptual location between characters.</p>
<p><strong>Related Terms:</strong> Point, Position, Buffer,
Relocation</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/markers.texi</code></p>
<hr/>
<h3 data-number="27.13.9" id="match-data-lisp"><span class="header-section-number">27.13.9</span> Match Data
<code>[Lisp]</code></h3>
<p><strong>Definition:</strong> Information about the most recent
successful regexp search, including matched text and subexpressions.</p>
<p><strong>Context:</strong> Accessed via <code>match-beginning</code>,
<code>match-end</code>, <code>match-string</code>. Saved/restored with
<code>save-match-data</code>.</p>
<p><strong>Related Terms:</strong> Regexp, Search, Subexpression,
Capture Group</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/searching.texi</code></p>
<hr/>
<h3 data-number="27.13.10" id="melpa-abbrev"><span class="header-section-number">27.13.10</span> MELPA
<code>[Abbrev]</code></h3>
<p><strong>Definition:</strong> Milkypostman‚Äôs Emacs Lisp Package
Archive - a large community package repository.</p>
<p><strong>Context:</strong> Contains thousands of packages. Updates
frequently. Less curated than ELPA.</p>
<p><strong>Related Terms:</strong> ELPA, Package, Repository, Package
Manager</p>
<hr/>
<h3 data-number="27.13.11" id="message-core"><span class="header-section-number">27.13.11</span> Message
<code>[Core]</code></h3>
<p><strong>Definition:</strong> Text displayed in the echo area to
inform the user.</p>
<p><strong>Context:</strong> Created with <code>message</code> function.
Appears briefly or until next event.</p>
<p><strong>Related Terms:</strong> Echo Area, Minibuffer, Log,
<em>Messages</em> Buffer</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/display.texi</code></p>
<hr/>
<h3 data-number="27.13.12" id="meta-key-core"><span class="header-section-number">27.13.12</span> Meta Key
<code>[Core]</code></h3>
<p><strong>Definition:</strong> A modifier key (Alt or Esc) used in
Emacs key sequences, denoted M- in documentation.</p>
<p><strong>Context:</strong> <code>M-x</code> = Alt-x or Esc x.
Essential for Emacs key bindings.</p>
<p><strong>Related Terms:</strong> Modifier, Key Sequence, Control Key,
Esc</p>
<hr/>
<h3 data-number="27.13.13" id="minibuffer-core"><span class="header-section-number">27.13.13</span> Minibuffer
<code>[Core]</code></h3>
<p><strong>Definition:</strong> A special buffer appearing in the echo
area for user input (commands, files, strings, etc.).</p>
<p><strong>Context:</strong> Provides completion, history, and
sophisticated input methods. Active during prompts.</p>
<p><strong>Related Terms:</strong> Echo Area, Completion, Prompt, Read
Function</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/minibuf.texi</code></p>
<hr/>
<h3 data-number="27.13.14" id="minibuffer-history-core"><span class="header-section-number">27.13.14</span> Minibuffer History
<code>[Core]</code></h3>
<p><strong>Definition:</strong> Lists of previously entered minibuffer
inputs, accessible via M-p/M-n during prompts.</p>
<p><strong>Context:</strong> Separate histories for commands, files,
search strings, etc.</p>
<p><strong>Related Terms:</strong> Minibuffer, History, Completion</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/minibuf.texi</code></p>
<hr/>
<h3 data-number="27.13.15" id="minor-mode-core"><span class="header-section-number">27.13.15</span> Minor Mode
<code>[Core]</code></h3>
<p><strong>Definition:</strong> An optional buffer-local or global
feature that can be toggled independently of the major mode.</p>
<p><strong>Context:</strong> Multiple minor modes can be active
simultaneously. Examples: auto-fill-mode, font-lock-mode.</p>
<p><strong>Related Terms:</strong> Major Mode, Mode, Global Minor Mode,
Mode Line</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/modes.texi</code></p>
<hr/>
<h3 data-number="27.13.16" id="mode-hook-system"><span class="header-section-number">27.13.16</span> Mode Hook
<code>[System]</code></h3>
<p><strong>Definition:</strong> A hook run when a major or minor mode is
activated, allowing customization.</p>
<p><strong>Context:</strong> Named <code>&lt;mode&gt;-hook</code>. Add
functions with <code>add-hook</code>.</p>
<p><strong>Related Terms:</strong> Hook, Major Mode, Minor Mode,
Customization</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/modes.texi</code></p>
<hr/>
<h3 data-number="27.13.17" id="mode-line-display"><span class="header-section-number">27.13.17</span> Mode Line
<code>[Display]</code></h3>
<p><strong>Definition:</strong> The status line at the bottom of each
window displaying buffer name, mode, position, etc.</p>
<p><strong>Context:</strong> Highly customizable via
<code>mode-line-format</code>. Click-sensitive.</p>
<p><strong>Related Terms:</strong> Header Line, Window, Display, Format
Spec</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/modes.texi</code></p>
<hr/>
<h3 data-number="27.13.18" id="mode-line-format-display"><span class="header-section-number">27.13.18</span> Mode Line Format
<code>[Display]</code></h3>
<p><strong>Definition:</strong> A specification describing what to
display in the mode line, similar to format strings.</p>
<p><strong>Context:</strong> Complex nested structure supporting
conditionals, functions, and properties.</p>
<p><strong>Related Terms:</strong> Mode Line, Format Spec, Display,
Customization</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/modes.texi</code></p>
<hr/>
<h3 data-number="27.13.19" id="modification-time-system"><span class="header-section-number">27.13.19</span> Modification Time
<code>[System]</code></h3>
<p><strong>Definition:</strong> The timestamp when a file or buffer was
last modified.</p>
<p><strong>Context:</strong> Used to detect external changes. Checked
before saving.</p>
<p><strong>Related Terms:</strong> File, Buffer Modification, Timestamp,
Visited File</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/files.texi</code></p>
<hr/>
<h3 data-number="27.13.20" id="mouse-event-system"><span class="header-section-number">27.13.20</span> Mouse Event
<code>[System]</code></h3>
<p><strong>Definition:</strong> An event representing mouse movement,
clicks, drags, or wheel scrolling.</p>
<p><strong>Context:</strong> Includes position, button, modifiers, and
click count. Processed by keymaps.</p>
<p><strong>Related Terms:</strong> Event, Key Event, Click, Mouse</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/commands.texi</code></p>
<hr/>
<h3 data-number="27.13.21" id="multibyte-system"><span class="header-section-number">27.13.21</span> Multibyte
<code>[System]</code></h3>
<p><strong>Definition:</strong> A buffer or string encoding where
characters can occupy multiple bytes (UTF-8 internally).</p>
<p><strong>Context:</strong> Modern default. Contrasts with unibyte
(byte-oriented).</p>
<p><strong>Related Terms:</strong> Unicode, Unibyte, Coding System,
Character</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/nonascii.texi</code></p>
<hr/>
<h2 data-number="27.14" id="n"><span class="header-section-number">27.14</span> N</h2>
<h3 data-number="27.14.1" id="narrowing-core"><span class="header-section-number">27.14.1</span> Narrowing
<code>[Core]</code></h3>
<p><strong>Definition:</strong> Restricting buffer visibility and
editability to a portion, hiding text outside the region.</p>
<p><strong>Context:</strong> Commands like
<code>narrow-to-region</code>. Use <code>widen</code> to restore full
buffer.</p>
<p><strong>Related Terms:</strong> Region, Restriction, BEGV, ZV,
Widen</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/positions.texi</code></p>
<hr/>
<h3 data-number="27.14.2" id="native-compilation-lisp"><span class="header-section-number">27.14.2</span> Native Compilation
<code>[Lisp]</code></h3>
<p><strong>Definition:</strong> Compilation of Emacs Lisp to native
machine code using GCC‚Äôs libgccjit.</p>
<p><strong>Context:</strong> Produces <code>.eln</code> files.
Significantly faster than byte code.</p>
<p><strong>Related Terms:</strong> Byte Code, Compilation, .eln File,
Performance</p>
<p><strong>Documentation:</strong> See Emacs manual</p>
<hr/>
<h3 data-number="27.14.3" id="nil-lisp"><span class="header-section-number">27.14.3</span> Nil
<code>[Lisp]</code></h3>
<p><strong>Definition:</strong> The symbol representing both the empty
list and the boolean false value.</p>
<p><strong>Context:</strong> Only false value in Emacs Lisp. All other
values are true.</p>
<p><strong>Related Terms:</strong> T, Boolean, Empty List, False</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/lists.texi</code></p>
<hr/>
<h3 data-number="27.14.4" id="normal-hook-system"><span class="header-section-number">27.14.4</span> Normal Hook
<code>[System]</code></h3>
<p><strong>Definition:</strong> A hook where functions are called with
no arguments and whose return values are ignored.</p>
<p><strong>Context:</strong> Most hooks are normal hooks. Run with
<code>run-hooks</code>.</p>
<p><strong>Related Terms:</strong> Hook, Abnormal Hook, Run Hooks,
Callback</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/hooks.texi</code></p>
<hr/>
<h2 data-number="27.15" id="o"><span class="header-section-number">27.15</span> O</h2>
<h3 data-number="27.15.1" id="obarray-data"><span class="header-section-number">27.15.1</span> Obarray
<code>[Data]</code></h3>
<p><strong>Definition:</strong> A hash table (vector) for interning
symbols, ensuring each symbol name has one unique object.</p>
<p><strong>Context:</strong> Default obarray contains all global
symbols. Can create isolated obarrays.</p>
<p><strong>Related Terms:</strong> Symbol, Intern, Hash Table,
Namespace</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/symbols.texi</code></p>
<hr/>
<h3 data-number="27.15.2" id="overlay-data"><span class="header-section-number">27.15.2</span> Overlay
<code>[Data]</code></h3>
<p><strong>Definition:</strong> An object specifying a buffer region
with associated properties, independent of text properties.</p>
<p><strong>Context:</strong> Can specify faces, invisibility,
modification hooks, etc. Used for temporary highlighting.</p>
<p><strong>Related Terms:</strong> Text Property, Face, Invisible Text,
Before/After String</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/display.texi</code></p>
<hr/>
<h3 data-number="27.15.3" id="override-keymap-core"><span class="header-section-number">27.15.3</span> Override Keymap
<code>[Core]</code></h3>
<p><strong>Definition:</strong> A keymap with highest precedence,
overriding all other keymaps including minor modes.</p>
<p><strong>Context:</strong> Set via <code>overriding-local-map</code>
or <code>overriding-terminal-local-map</code>. Rarely used.</p>
<p><strong>Related Terms:</strong> Keymap, Precedence, Local Keymap</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/keymaps.texi</code></p>
<hr/>
<h2 data-number="27.16" id="p"><span class="header-section-number">27.16</span> P</h2>
<h3 data-number="27.16.1" id="package-system-1"><span class="header-section-number">27.16.1</span> Package
<code>[System]</code></h3>
<p><strong>Definition:</strong> A bundled collection of Emacs Lisp files
providing related functionality, installable via package.el.</p>
<p><strong>Context:</strong> Distributed via ELPA, MELPA, etc. Includes
metadata and dependencies.</p>
<p><strong>Related Terms:</strong> ELPA, MELPA, package.el, Library</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/package.texi</code></p>
<hr/>
<h3 data-number="27.16.2" id="package-manager-system"><span class="header-section-number">27.16.2</span> Package Manager
<code>[System]</code></h3>
<p><strong>Definition:</strong> The system (package.el) for discovering,
installing, and managing Emacs packages.</p>
<p><strong>Context:</strong> <code>M-x list-packages</code> browses
available packages. Handles dependencies automatically.</p>
<p><strong>Related Terms:</strong> Package, ELPA, MELPA,
Installation</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/package.texi</code></p>
<hr/>
<h3 data-number="27.16.3" id="paren-matching-display"><span class="header-section-number">27.16.3</span> Paren Matching
<code>[Display]</code></h3>
<p><strong>Definition:</strong> Highlighting or navigation to matching
delimiters (parentheses, brackets, braces).</p>
<p><strong>Context:</strong> Show-paren-mode highlights matches.
<code>forward-sexp</code> navigates by balanced expressions.</p>
<p><strong>Related Terms:</strong> Sexp, Balanced Expression, Syntax
Table, Delimiter</p>
<hr/>
<h3 data-number="27.16.4" id="parse-state-lisp"><span class="header-section-number">27.16.4</span> Parse State
<code>[Lisp]</code></h3>
<p><strong>Definition:</strong> Information about syntactic context at a
buffer position (comment depth, string state, paren depth, etc.).</p>
<p><strong>Context:</strong> Returned by
<code>parse-partial-sexp</code>. Critical for syntax-aware
operations.</p>
<p><strong>Related Terms:</strong> Syntax Table, Parsing, SMIE,
Context</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/syntax.texi</code></p>
<hr/>
<h3 data-number="27.16.5" id="plist-data"><span class="header-section-number">27.16.5</span> Plist
<code>[Data]</code></h3>
<p><strong>Definition:</strong> Property List - a list of alternating
keys and values: <code>(key1 val1 key2 val2 ...)</code>.</p>
<p><strong>Context:</strong> Simpler than alist for small datasets. Used
for symbol properties and faces.</p>
<p><strong>Related Terms:</strong> Alist, Symbol Property, List,
Key-Value</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/lists.texi</code></p>
<hr/>
<h3 data-number="27.16.6" id="point-core"><span class="header-section-number">27.16.6</span> Point
<code>[Core]</code></h3>
<p><strong>Definition:</strong> The current buffer position where
insertion and many operations occur, typically where cursor is
displayed.</p>
<p><strong>Context:</strong> An integer counting characters from buffer
start (1). Each buffer has its own point.</p>
<p><strong>Related Terms:</strong> Cursor, Mark, Position, Marker,
Insertion</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/positions.texi</code></p>
<hr/>
<h3 data-number="27.16.7" id="position-core"><span class="header-section-number">27.16.7</span> Position
<code>[Core]</code></h3>
<p><strong>Definition:</strong> A buffer location, represented as a
character number (integer) or marker.</p>
<p><strong>Context:</strong> Positions range from 1 (BEG) to
(point-max). Zero is never a valid position.</p>
<p><strong>Related Terms:</strong> Point, Marker, Character Position,
Byte Position</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/positions.texi</code></p>
<hr/>
<h3 data-number="27.16.8" id="predicate-lisp"><span class="header-section-number">27.16.8</span> Predicate
<code>[Lisp]</code></h3>
<p><strong>Definition:</strong> A function that returns a boolean value,
testing a condition or type.</p>
<p><strong>Context:</strong> Often named with <code>-p</code> suffix:
<code>bufferp</code>, <code>integerp</code>, <code>null</code>,
<code>boundp</code>.</p>
<p><strong>Related Terms:</strong> Boolean, Test, Type Check,
Function</p>
<p><strong>Documentation:</strong> See <code>doc/lispref/</code> various
sections</p>
<hr/>
<h3 data-number="27.16.9" id="prefix-argument-core"><span class="header-section-number">27.16.9</span> Prefix Argument
<code>[Core]</code></h3>
<p><strong>Definition:</strong> A numeric or symbolic argument passed to
commands via <code>C-u</code> or <code>M-&lt;number&gt;</code>.</p>
<p><strong>Context:</strong> Modifies command behavior. Raw form
<code>(4)</code> from one <code>C-u</code>, <code>(16)</code> from two,
etc.</p>
<p><strong>Related Terms:</strong> Universal Argument, C-u, Command,
Argument</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/commands.texi</code></p>
<hr/>
<h3 data-number="27.16.10" id="prefix-key-core"><span class="header-section-number">27.16.10</span> Prefix Key
<code>[Core]</code></h3>
<p><strong>Definition:</strong> A key sequence that is a prefix of
longer key sequences, like <code>C-x</code> or <code>C-c</code>.</p>
<p><strong>Context:</strong> Bound to a keymap rather than a command.
Opens further key possibilities.</p>
<p><strong>Related Terms:</strong> Key Sequence, Keymap, Key Binding</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/keymaps.texi</code></p>
<hr/>
<h3 data-number="27.16.11" id="primitive-lisp"><span class="header-section-number">27.16.11</span> Primitive
<code>[Lisp]</code></h3>
<p><strong>Definition:</strong> A function implemented in C rather than
Emacs Lisp, also called a subr or built-in function.</p>
<p><strong>Context:</strong> Provides core functionality and
performance-critical operations.</p>
<p><strong>Related Terms:</strong> Subr, Built-in, DEFUN, C Source</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/eval.texi</code></p>
<hr/>
<h3 data-number="27.16.12" id="print-lisp"><span class="header-section-number">27.16.12</span> Print
<code>[Lisp]</code></h3>
<p><strong>Definition:</strong> Converting Lisp objects to their textual
representation.</p>
<p><strong>Context:</strong> Opposite of read. <code>prin1</code> prints
readably, <code>princ</code> prints for humans, <code>print</code> adds
newline.</p>
<p><strong>Related Terms:</strong> Read, Printer, Format, Output</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/streams.texi</code></p>
<hr/>
<h3 data-number="27.16.13" id="process-system"><span class="header-section-number">27.16.13</span> Process
<code>[System]</code></h3>
<p><strong>Definition:</strong> A subprocess running concurrently with
Emacs, with optional I/O connections.</p>
<p><strong>Context:</strong> Created with <code>start-process</code> or
<code>make-process</code>. Can be synchronous or asynchronous.</p>
<p><strong>Related Terms:</strong> Subprocess, Filter, Sentinel, Async,
Pipe</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/processes.texi</code></p>
<hr/>
<h3 data-number="27.16.14" id="property-list-data"><span class="header-section-number">27.16.14</span> Property List
<code>[Data]</code></h3>
<p><strong>Definition:</strong> See Plist.</p>
<p><strong>Related Terms:</strong> Plist, Symbol Property</p>
<hr/>
<h3 data-number="27.16.15" id="provide-lisp"><span class="header-section-number">27.16.15</span> Provide
<code>[Lisp]</code></h3>
<p><strong>Definition:</strong> Declares that a library provides a named
feature, registering it in the <code>features</code> list.</p>
<p><strong>Context:</strong> Placed at end of library files. Paired with
<code>require</code>.</p>
<p><strong>Related Terms:</strong> Require, Feature, Library,
Loading</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/loading.texi</code></p>
<hr/>
<h2 data-number="27.17" id="q"><span class="header-section-number">27.17</span> Q</h2>
<h3 data-number="27.17.1" id="quail-system"><span class="header-section-number">27.17.1</span> Quail
<code>[System]</code></h3>
<p><strong>Definition:</strong> The Emacs input method framework for
entering non-ASCII characters.</p>
<p><strong>Context:</strong> Defines phonetic and other input methods
for various languages.</p>
<p><strong>Related Terms:</strong> Input Method, Multilingual, Character
Input</p>
<p><strong>Documentation:</strong> See leim/ directory</p>
<hr/>
<h3 data-number="27.17.2" id="query-replace-core"><span class="header-section-number">27.17.2</span> Query-Replace
<code>[Core]</code></h3>
<p><strong>Definition:</strong> Interactive search-and-replace that
prompts for confirmation at each match.</p>
<p><strong>Context:</strong> <code>M-%</code> for string,
<code>C-M-%</code> for regexp. Offers skip, replace, replace-all
options.</p>
<p><strong>Related Terms:</strong> Replace, Search, Interactive,
Regexp</p>
<p><strong>Documentation:</strong> See Emacs manual</p>
<hr/>
<h3 data-number="27.17.3" id="quit-core"><span class="header-section-number">27.17.3</span> Quit
<code>[Core]</code></h3>
<p><strong>Definition:</strong> Interrupting the current command or
operation, typically with <code>C-g</code>.</p>
<p><strong>Context:</strong> Signals <code>quit</code> condition. Can be
inhibited with <code>inhibit-quit</code>.</p>
<p><strong>Related Terms:</strong> C-g, Interrupt, Signal, Inhibit
Quit</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/commands.texi</code></p>
<hr/>
<h3 data-number="27.17.4" id="quote-lisp"><span class="header-section-number">27.17.4</span> Quote
<code>[Lisp]</code></h3>
<p><strong>Definition:</strong> A special form preventing evaluation of
its argument, returning it as data.</p>
<p><strong>Context:</strong> <code>'x</code> is shorthand for
<code>(quote x)</code>. Fundamental for treating code as data.</p>
<p><strong>Related Terms:</strong> Evaluation, Special Form, Backquote,
Unquote</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/eval.texi</code></p>
<hr/>
<h2 data-number="27.18" id="r"><span class="header-section-number">27.18</span> R</h2>
<h3 data-number="27.18.1" id="read-lisp"><span class="header-section-number">27.18.1</span> Read
<code>[Lisp]</code></h3>
<p><strong>Definition:</strong> Parsing textual representation to create
Lisp objects.</p>
<p><strong>Context:</strong> Opposite of print. Used by
<code>load</code>, <code>eval</code>, and REPL.</p>
<p><strong>Related Terms:</strong> Reader, Print, Parse,
S-expression</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/streams.texi</code></p>
<hr/>
<h3 data-number="27.18.2" id="read-only-buffer-core"><span class="header-section-number">27.18.2</span> Read-Only Buffer
<code>[Core]</code></h3>
<p><strong>Definition:</strong> A buffer where modifications are
prevented, signaling an error on edit attempts.</p>
<p><strong>Context:</strong> Controlled by <code>buffer-read-only</code>
variable. Toggle with <code>C-x C-q</code>.</p>
<p><strong>Related Terms:</strong> Buffer, Modification, Protection</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/buffers.texi</code></p>
<hr/>
<h3 data-number="27.18.3" id="reader-lisp"><span class="header-section-number">27.18.3</span> Reader
<code>[Lisp]</code></h3>
<p><strong>Definition:</strong> The component that parses textual Lisp
code into data structures.</p>
<p><strong>Context:</strong> Handles syntax like quotes, backquotes,
reader macros, and # syntax.</p>
<p><strong>Related Terms:</strong> Read, Parse, S-expression, Syntax</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/streams.texi</code></p>
<hr/>
<h3 data-number="27.18.4" id="recursion-lisp"><span class="header-section-number">27.18.4</span> Recursion
<code>[Lisp]</code></h3>
<p><strong>Definition:</strong> A function calling itself, directly or
indirectly.</p>
<p><strong>Context:</strong> Limited by
<code>max-lisp-eval-depth</code>. Tail recursion not optimized in Emacs
Lisp.</p>
<p><strong>Related Terms:</strong> Stack, Call Stack, Depth, Loop</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/functions.texi</code></p>
<hr/>
<h3 data-number="27.18.5" id="redisplay-display"><span class="header-section-number">27.18.5</span> Redisplay
<code>[Display]</code></h3>
<p><strong>Definition:</strong> The process of updating the screen to
reflect current buffer contents and state.</p>
<p><strong>Context:</strong> Normally automatic. Can be forced with
<code>redisplay</code> function. Performance-critical.</p>
<p><strong>Related Terms:</strong> Display Engine, Glyph Matrix,
Refresh, Rendering</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/display.texi</code></p>
<hr/>
<h3 data-number="27.18.6" id="regexp-lisp"><span class="header-section-number">27.18.6</span> Regexp
<code>[Lisp]</code></h3>
<p><strong>Definition:</strong> Regular Expression - a pattern language
for matching and searching text.</p>
<p><strong>Context:</strong> Emacs uses its own regexp syntax, similar
but not identical to POSIX or Perl.</p>
<p><strong>Related Terms:</strong> Pattern, Search, Match Data,
Character Class</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/searching.texi</code></p>
<hr/>
<h3 data-number="27.18.7" id="region-core"><span class="header-section-number">27.18.7</span> Region
<code>[Core]</code></h3>
<p><strong>Definition:</strong> The text between point and mark.</p>
<p><strong>Context:</strong> Many commands operate on the region.
Visibility controlled by transient-mark-mode.</p>
<p><strong>Related Terms:</strong> Point, Mark, Active Region,
Selection</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/markers.texi</code></p>
<hr/>
<h3 data-number="27.18.8" id="register-core"><span class="header-section-number">27.18.8</span> Register
<code>[Core]</code></h3>
<p><strong>Definition:</strong> A named storage location for positions,
text, windows configurations, or other data.</p>
<p><strong>Context:</strong> Accessed via single-character names.
<code>C-x r</code> prefix for register commands.</p>
<p><strong>Related Terms:</strong> Bookmark, Storage, Clipboard</p>
<p><strong>Documentation:</strong> See Emacs manual</p>
<hr/>
<h3 data-number="27.18.9" id="repl-lisp"><span class="header-section-number">27.18.9</span> REPL
<code>[Lisp]</code></h3>
<p><strong>Definition:</strong> Read-Eval-Print Loop - an interactive
programming environment.</p>
<p><strong>Context:</strong> <em>scratch</em> buffer and
<code>ielm</code> mode provide REPL functionality.</p>
<p><strong>Related Terms:</strong> Interactive, Eval, Read, Print</p>
<hr/>
<h3 data-number="27.18.10" id="require-lisp"><span class="header-section-number">27.18.10</span> Require
<code>[Lisp]</code></h3>
<p><strong>Definition:</strong> Loads a library if its feature has not
been provided yet.</p>
<p><strong>Context:</strong> Ensures dependencies are loaded. Idempotent
unlike <code>load</code>.</p>
<p><strong>Related Terms:</strong> Provide, Feature, Load, Library</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/loading.texi</code></p>
<hr/>
<h3 data-number="27.18.11" id="restriction-core"><span class="header-section-number">27.18.11</span> Restriction
<code>[Core]</code></h3>
<p><strong>Definition:</strong> The accessible portion of a buffer,
possibly limited by narrowing.</p>
<p><strong>Context:</strong> BEGV to ZV. Many commands respect
restriction.</p>
<p><strong>Related Terms:</strong> Narrowing, BEGV, ZV, Accessible
Region</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/positions.texi</code></p>
<hr/>
<h3 data-number="27.18.12" id="revert-buffer-core"><span class="header-section-number">27.18.12</span> Revert Buffer
<code>[Core]</code></h3>
<p><strong>Definition:</strong> Reloading a buffer‚Äôs contents from its
associated file, discarding changes.</p>
<p><strong>Context:</strong> <code>M-x revert-buffer</code>.
Auto-revert-mode does this automatically.</p>
<p><strong>Related Terms:</strong> Reload, File, Auto-Revert, Buffer</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/buffers.texi</code></p>
<hr/>
<h3 data-number="27.18.13" id="ring-buffer-data"><span class="header-section-number">27.18.13</span> Ring Buffer
<code>[Data]</code></h3>
<p><strong>Definition:</strong> A fixed-size circular buffer where
oldest entries are overwritten when full.</p>
<p><strong>Context:</strong> Used for kill ring, mark ring, command
history, etc.</p>
<p><strong>Related Terms:</strong> Kill Ring, Mark Ring, Circular
Buffer, History</p>
<p><strong>Documentation:</strong> See <code>lisp/ring.el</code></p>
<hr/>
<h2 data-number="27.19" id="s"><span class="header-section-number">27.19</span> S</h2>
<h3 data-number="27.19.1" id="safe-local-variable-core"><span class="header-section-number">27.19.1</span> Safe Local Variable
<code>[Core]</code></h3>
<p><strong>Definition:</strong> A file-local or directory-local variable
deemed safe to set without confirmation.</p>
<p><strong>Context:</strong> Registered in
<code>safe-local-variable-values</code> or with safe predicate.</p>
<p><strong>Related Terms:</strong> File Local Variable, Directory Local
Variable, Security</p>
<p><strong>Documentation:</strong> See Emacs manual</p>
<hr/>
<h3 data-number="27.19.2" id="save-excursion-lisp"><span class="header-section-number">27.19.2</span> Save-Excursion
<code>[Lisp]</code></h3>
<p><strong>Definition:</strong> A special form that saves and restores
point, mark, and current buffer around code execution.</p>
<p><strong>Context:</strong> Common pattern for temporary buffer
operations. Consider <code>save-current-buffer</code> if only buffer
matters.</p>
<p><strong>Related Terms:</strong> Point, Mark, Current Buffer,
Unwinding</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/positions.texi</code></p>
<hr/>
<h3 data-number="27.19.3" id="scope-lisp"><span class="header-section-number">27.19.3</span> Scope
<code>[Lisp]</code></h3>
<p><strong>Definition:</strong> The region of code where a variable
binding is visible and accessible.</p>
<p><strong>Context:</strong> Lexical scope based on code structure,
dynamic scope based on call stack.</p>
<p><strong>Related Terms:</strong> Binding, Lexical Binding, Dynamic
Binding, Visibility</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/variables.texi</code></p>
<hr/>
<h3 data-number="27.19.4" id="search-core"><span class="header-section-number">27.19.4</span> Search
<code>[Core]</code></h3>
<p><strong>Definition:</strong> Finding text matching a string or
pattern in a buffer.</p>
<p><strong>Context:</strong> Isearch (incremental),
<code>search-forward</code>, <code>re-search-forward</code> (regexp),
etc.</p>
<p><strong>Related Terms:</strong> Isearch, Regexp, Match Data, Find</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/searching.texi</code></p>
<hr/>
<h3 data-number="27.19.5" id="selected-frame-core"><span class="header-section-number">27.19.5</span> Selected Frame
<code>[Core]</code></h3>
<p><strong>Definition:</strong> The frame with input focus, receiving
keyboard and most commands.</p>
<p><strong>Context:</strong> Queried with <code>selected-frame</code>,
set with <code>select-frame-set-input-focus</code>.</p>
<p><strong>Related Terms:</strong> Frame, Input Focus, Selected
Window</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/frames.texi</code></p>
<hr/>
<h3 data-number="27.19.6" id="selected-window-core"><span class="header-section-number">27.19.6</span> Selected Window
<code>[Core]</code></h3>
<p><strong>Definition:</strong> The window receiving most commands and
usually displaying the cursor.</p>
<p><strong>Context:</strong> Its buffer is typically (but not always)
the current buffer.</p>
<p><strong>Related Terms:</strong> Window, Current Buffer, Cursor,
Selection</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/windows.texi</code></p>
<hr/>
<h3 data-number="27.19.7" id="sentinel-system"><span class="header-section-number">27.19.7</span> Sentinel
<code>[System]</code></h3>
<p><strong>Definition:</strong> A function called when an asynchronous
process changes state (exits, crashes, etc.).</p>
<p><strong>Context:</strong> Set with <code>set-process-sentinel</code>.
Receives process and state string.</p>
<p><strong>Related Terms:</strong> Process, Filter, Async, Callback</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/processes.texi</code></p>
<hr/>
<h3 data-number="27.19.8" id="server-mode-system"><span class="header-section-number">27.19.8</span> Server Mode
<code>[System]</code></h3>
<p><strong>Definition:</strong> Running Emacs as a server that clients
can connect to for editing.</p>
<p><strong>Context:</strong> Enables <code>emacsclient</code>. Can run
as daemon or in existing session.</p>
<p><strong>Related Terms:</strong> Daemon, Client, emacsclient</p>
<p><strong>Documentation:</strong> See Emacs manual</p>
<hr/>
<h3 data-number="27.19.9" id="s-expression-lisp"><span class="header-section-number">27.19.9</span> S-expression
<code>[Lisp]</code></h3>
<p><strong>Definition:</strong> Symbolic Expression - any valid Lisp
form: atom, list, or special syntax.</p>
<p><strong>Context:</strong> Fundamental unit of Lisp code and data.
Read by reader, evaluated by interpreter.</p>
<p><strong>Related Terms:</strong> Sexp, Form, Expression, List</p>
<p><strong>Documentation:</strong> See <code>doc/lispref/</code>
introduction</p>
<hr/>
<h3 data-number="27.19.10" id="sexp-abbrev"><span class="header-section-number">27.19.10</span> Sexp
<code>[Abbrev]</code></h3>
<p><strong>Definition:</strong> Abbreviation for S-expression.</p>
<p><strong>Context:</strong> Used in function names like
<code>forward-sexp</code>, <code>backward-sexp</code>.</p>
<p><strong>Related Terms:</strong> S-expression, Form, Expression</p>
<hr/>
<h3 data-number="27.19.11" id="signal-lisp"><span class="header-section-number">27.19.11</span> Signal
<code>[Lisp]</code></h3>
<p><strong>Definition:</strong> Throwing an error or condition,
interrupting normal execution flow.</p>
<p><strong>Context:</strong> Function <code>signal</code> or convenience
<code>error</code>. Caught by <code>condition-case</code>.</p>
<p><strong>Related Terms:</strong> Error, Condition, Exception,
Throw</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/errors.texi</code></p>
<hr/>
<h3 data-number="27.19.12" id="smie-lisp"><span class="header-section-number">27.19.12</span> SMIE
<code>[Lisp]</code></h3>
<p><strong>Definition:</strong> Simple Minded Indentation Engine - a
framework for implementing major mode indentation.</p>
<p><strong>Context:</strong> Simpler than full parsing. Uses precedence
grammar and tokens.</p>
<p><strong>Related Terms:</strong> Indentation, Major Mode, Parser,
Syntax</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/modes.texi</code></p>
<hr/>
<h3 data-number="27.19.13" id="special-form-lisp"><span class="header-section-number">27.19.13</span> Special Form
<code>[Lisp]</code></h3>
<p><strong>Definition:</strong> A built-in syntactic construct with
special evaluation rules, like <code>if</code>, <code>let</code>,
<code>quote</code>.</p>
<p><strong>Context:</strong> Arguments not automatically evaluated.
Cannot be redefined. Core language constructs.</p>
<p><strong>Related Terms:</strong> Form, Macro, Primitive,
Evaluation</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/eval.texi</code></p>
<hr/>
<h3 data-number="27.19.14" id="special-variable-lisp"><span class="header-section-number">27.19.14</span> Special Variable
<code>[Lisp]</code></h3>
<p><strong>Definition:</strong> A variable using dynamic binding even
under lexical-binding mode.</p>
<p><strong>Context:</strong> Declared with <code>defvar</code> or
<code>defconst</code>. Allows dynamic scoping when needed.</p>
<p><strong>Related Terms:</strong> Dynamic Binding, Defvar, Variable,
Scope</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/variables.texi</code></p>
<hr/>
<h3 data-number="27.19.15" id="subr-lisp"><span class="header-section-number">27.19.15</span> Subr
<code>[Lisp]</code></h3>
<p><strong>Definition:</strong> A primitive function implemented in C
(short for ‚Äúsubroutine‚Äù).</p>
<p><strong>Context:</strong> Type name for built-in functions.
<code>subrp</code> tests for this type.</p>
<p><strong>Related Terms:</strong> Primitive, Built-in, DEFUN, C
Source</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/eval.texi</code></p>
<hr/>
<h3 data-number="27.19.16" id="symbol-lisp"><span class="header-section-number">27.19.16</span> Symbol
<code>[Lisp]</code></h3>
<p><strong>Definition:</strong> A Lisp object with a name, used for
variables, functions, and as unique identifiers.</p>
<p><strong>Context:</strong> Has value cell, function cell, property
list, and name. Interned in obarray.</p>
<p><strong>Related Terms:</strong> Variable, Function, Intern,
Obarray</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/symbols.texi</code></p>
<hr/>
<h3 data-number="27.19.17" id="symbol-property-lisp"><span class="header-section-number">27.19.17</span> Symbol Property
<code>[Lisp]</code></h3>
<p><strong>Definition:</strong> A key-value association attached to a
symbol, stored in its property list.</p>
<p><strong>Context:</strong> Get with <code>get</code>, set with
<code>put</code>. Independent of variable/function bindings.</p>
<p><strong>Related Terms:</strong> Plist, Symbol, Property, Metadata</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/symbols.texi</code></p>
<hr/>
<h3 data-number="27.19.18" id="syntax-class-lisp"><span class="header-section-number">27.19.18</span> Syntax Class
<code>[Lisp]</code></h3>
<p><strong>Definition:</strong> A classification of characters (word,
whitespace, open paren, etc.) in a syntax table.</p>
<p><strong>Context:</strong> Determines parsing behavior. Examples: word
constituent, punctuation, comment delimiter.</p>
<p><strong>Related Terms:</strong> Syntax Table, Character Class,
Parsing</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/syntax.texi</code></p>
<hr/>
<h3 data-number="27.19.19" id="syntax-table-data"><span class="header-section-number">27.19.19</span> Syntax Table
<code>[Data]</code></h3>
<p><strong>Definition:</strong> A char-table defining the syntactic role
of each character for parsing and motion.</p>
<p><strong>Context:</strong> Each major mode typically has its own
syntax table. Affects forward-word, parse-partial-sexp, etc.</p>
<p><strong>Related Terms:</strong> Char Table, Syntax Class, Major Mode,
Parsing</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/syntax.texi</code></p>
<hr/>
<h2 data-number="27.20" id="t"><span class="header-section-number">27.20</span> T</h2>
<h3 data-number="27.20.1" id="t-lisp"><span class="header-section-number">27.20.1</span> T <code>[Lisp]</code></h3>
<p><strong>Definition:</strong> The symbol representing the canonical
true value, though any non-nil value is true.</p>
<p><strong>Context:</strong> Preferred over other values when explicit
true needed.</p>
<p><strong>Related Terms:</strong> Nil, Boolean, True, False</p>
<p><strong>Documentation:</strong> See <code>doc/lispref/</code>
introduction</p>
<hr/>
<h3 data-number="27.20.2" id="tab-core"><span class="header-section-number">27.20.2</span> Tab
<code>[Core]</code></h3>
<p><strong>Definition:</strong> The TAB character or key, typically
performing indentation or completion.</p>
<p><strong>Context:</strong> Can be literal character (ASCII 9) or
trigger smart behavior via keybinding.</p>
<p><strong>Related Terms:</strong> Indentation, Completion, Whitespace,
Electric</p>
<hr/>
<h3 data-number="27.20.3" id="tab-stop-core"><span class="header-section-number">27.20.3</span> Tab Stop
<code>[Core]</code></h3>
<p><strong>Definition:</strong> Column positions where TAB key moves
cursor in certain modes.</p>
<p><strong>Context:</strong> Controlled by <code>tab-stop-list</code>.
Used in text modes without smart indentation.</p>
<p><strong>Related Terms:</strong> Tab, Column, Indentation</p>
<hr/>
<h3 data-number="27.20.4" id="tagged-pointer-data"><span class="header-section-number">27.20.4</span> Tagged Pointer
<code>[Data]</code></h3>
<p><strong>Definition:</strong> An encoding scheme where type
information is stored in unused low bits of a pointer.</p>
<p><strong>Context:</strong> Lisp_Object uses tagged pointers for
efficient type representation.</p>
<p><strong>Related Terms:</strong> Lisp_Object, Type Tag, Pointer, C
Implementation</p>
<p><strong>Source:</strong> See <code>src/lisp.h</code></p>
<hr/>
<h3 data-number="27.20.5" id="text-property-data"><span class="header-section-number">27.20.5</span> Text Property
<code>[Data]</code></h3>
<p><strong>Definition:</strong> A property attached to a character or
range of characters, stored with the text itself.</p>
<p><strong>Context:</strong> Copied/deleted with text. Examples: face,
font-lock-face, invisible, help-echo.</p>
<p><strong>Related Terms:</strong> Overlay, Face, Display Property,
Interval</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/text.texi</code></p>
<hr/>
<h3 data-number="27.20.6" id="theme-display"><span class="header-section-number">27.20.6</span> Theme
<code>[Display]</code></h3>
<p><strong>Definition:</strong> See Custom Theme.</p>
<p><strong>Related Terms:</strong> Custom Theme, Face, Customization</p>
<hr/>
<h3 data-number="27.20.7" id="thread-system"><span class="header-section-number">27.20.7</span> Thread
<code>[System]</code></h3>
<p><strong>Definition:</strong> An independent strand of Lisp execution,
allowing concurrent computation.</p>
<p><strong>Context:</strong> Limited support. Created with
<code>make-thread</code>. Shares most state.</p>
<p><strong>Related Terms:</strong> Concurrency, Async, Parallel,
Mutex</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/threads.texi</code></p>
<hr/>
<h3 data-number="27.20.8" id="timer-system"><span class="header-section-number">27.20.8</span> Timer
<code>[System]</code></h3>
<p><strong>Definition:</strong> An object that schedules function
execution after a delay or at regular intervals.</p>
<p><strong>Context:</strong> Created with <code>run-with-timer</code> or
<code>run-at-time</code>. Can be idle timers.</p>
<p><strong>Related Terms:</strong> Idle Timer, Scheduling, Async,
Callback</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/os.texi</code></p>
<hr/>
<h3 data-number="27.20.9" id="tooltip-display"><span class="header-section-number">27.20.9</span> Tooltip
<code>[Display]</code></h3>
<p><strong>Definition:</strong> A small temporary window displaying help
text when hovering over UI elements.</p>
<p><strong>Context:</strong> Triggered by help-echo text property or
mode-line mouse hover.</p>
<p><strong>Related Terms:</strong> Help Echo, Mouse, Display, Popup</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/display.texi</code></p>
<hr/>
<h3 data-number="27.20.10" id="tramp-abbrev"><span class="header-section-number">27.20.10</span> TRAMP
<code>[Abbrev]</code></h3>
<p><strong>Definition:</strong> Transparent Remote Access, Multiple
Protocols - editing remote files as if local.</p>
<p><strong>Context:</strong> Syntax:
<code>/method:user@host:/path</code>. Supports ssh, sudo, docker,
etc.</p>
<p><strong>Related Terms:</strong> Remote File, File Handler, SSH,
Network</p>
<p><strong>Documentation:</strong> See
<code>doc/misc/tramp.texi</code></p>
<hr/>
<h3 data-number="27.20.11" id="transient-mark-mode-core"><span class="header-section-number">27.20.11</span> Transient Mark Mode
<code>[Core]</code></h3>
<p><strong>Definition:</strong> A mode where the region is highlighted
when the mark is active.</p>
<p><strong>Context:</strong> Default in modern Emacs. Affects
region-based commands.</p>
<p><strong>Related Terms:</strong> Region, Mark, Active Region,
Selection</p>
<p><strong>Documentation:</strong> See Emacs manual</p>
<hr/>
<h3 data-number="27.20.12" id="truncation-display"><span class="header-section-number">27.20.12</span> Truncation
<code>[Display]</code></h3>
<p><strong>Definition:</strong> Cutting off long lines at window edge
rather than wrapping to next screen line.</p>
<p><strong>Context:</strong> Controlled by <code>truncate-lines</code>.
Indicated by symbols in fringe.</p>
<p><strong>Related Terms:</strong> Line Wrapping, Continuation Line,
Fringe, Display</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/display.texi</code></p>
<hr/>
<h3 data-number="27.20.13" id="tty-system"><span class="header-section-number">27.20.13</span> TTY
<code>[System]</code></h3>
<p><strong>Definition:</strong> Text Terminal - a character-based
terminal without graphical capabilities.</p>
<p><strong>Context:</strong> Emacs runs in terminal or GUI. TTY has
fewer display features.</p>
<p><strong>Related Terms:</strong> Terminal, Frame, Display, GUI</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/frames.texi</code></p>
<hr/>
<h3 data-number="27.20.14" id="type-predicate-lisp"><span class="header-section-number">27.20.14</span> Type Predicate
<code>[Lisp]</code></h3>
<p><strong>Definition:</strong> A function testing whether an object is
of a specific type.</p>
<p><strong>Context:</strong> Examples: <code>stringp</code>,
<code>numberp</code>, <code>listp</code>, <code>bufferp</code>. Usually
end in <code>-p</code>.</p>
<p><strong>Related Terms:</strong> Predicate, Type, Type Check</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/objects.texi</code></p>
<hr/>
<h2 data-number="27.21" id="u"><span class="header-section-number">27.21</span> U</h2>
<h3 data-number="27.21.1" id="undo-core"><span class="header-section-number">27.21.1</span> Undo
<code>[Core]</code></h3>
<p><strong>Definition:</strong> Reversing previous buffer modifications,
restoring earlier state.</p>
<p><strong>Context:</strong> <code>C-/</code> or <code>C-x u</code>.
Undo itself can be undone. Tracked in buffer-undo-list.</p>
<p><strong>Related Terms:</strong> Redo, Buffer-Undo-List, Modification,
Revert</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/text.texi</code></p>
<hr/>
<h3 data-number="27.21.2" id="unibyte-system"><span class="header-section-number">27.21.2</span> Unibyte
<code>[System]</code></h3>
<p><strong>Definition:</strong> A buffer or string encoding where each
byte represents one character.</p>
<p><strong>Context:</strong> Legacy mode. Most buffers are multibyte.
Useful for binary data.</p>
<p><strong>Related Terms:</strong> Multibyte, Binary, Coding System,
Character</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/nonascii.texi</code></p>
<hr/>
<h3 data-number="27.21.3" id="unicode-system"><span class="header-section-number">27.21.3</span> Unicode
<code>[System]</code></h3>
<p><strong>Definition:</strong> Universal character encoding standard,
used internally by modern Emacs.</p>
<p><strong>Context:</strong> Supports all world scripts. Characters are
code points 0 to #x10FFFF.</p>
<p><strong>Related Terms:</strong> UTF-8, Character, Code Point,
Multibyte</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/nonascii.texi</code></p>
<hr/>
<h3 data-number="27.21.4" id="universal-argument-core"><span class="header-section-number">27.21.4</span> Universal Argument
<code>[Core]</code></h3>
<p><strong>Definition:</strong> The prefix command <code>C-u</code> for
passing numeric or symbolic arguments to commands.</p>
<p><strong>Context:</strong> <code>C-u</code> = 4, <code>C-u C-u</code>
= 16, <code>C-u 5</code> = 5, etc. Raw form <code>(4)</code>,
<code>(16)</code>, etc.</p>
<p><strong>Related Terms:</strong> Prefix Argument, C-u, Command,
Argument</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/commands.texi</code></p>
<hr/>
<h3 data-number="27.21.5" id="unwind-protect-lisp"><span class="header-section-number">27.21.5</span> Unwind-Protect
<code>[Lisp]</code></h3>
<p><strong>Definition:</strong> A special form ensuring cleanup code
runs even if protected code exits abnormally.</p>
<p><strong>Context:</strong> Like try/finally. Critical for resource
cleanup.</p>
<p><strong>Related Terms:</strong> Exception, Cleanup, Finally,
Non-Local Exit</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/control.texi</code></p>
<hr/>
<h3 data-number="27.21.6" id="user-option-lisp"><span class="header-section-number">27.21.6</span> User Option
<code>[Lisp]</code></h3>
<p><strong>Definition:</strong> A customizable variable intended for
user configuration.</p>
<p><strong>Context:</strong> Defined with <code>defcustom</code>.
Editable via Customize interface.</p>
<p><strong>Related Terms:</strong> Defcustom, Customization, Variable,
Configuration</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/customize.texi</code></p>
<hr/>
<h3 data-number="27.21.7" id="utf-8-system"><span class="header-section-number">27.21.7</span> UTF-8
<code>[System]</code></h3>
<p><strong>Definition:</strong> Unicode Transformation Format, 8-bit - a
variable-length character encoding for Unicode.</p>
<p><strong>Context:</strong> Emacs‚Äôs internal encoding. Default external
encoding for files.</p>
<p><strong>Related Terms:</strong> Unicode, Coding System, Multibyte,
Encoding</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/nonascii.texi</code></p>
<hr/>
<h2 data-number="27.22" id="v"><span class="header-section-number">27.22</span> V</h2>
<h3 data-number="27.22.1" id="value-cell-lisp"><span class="header-section-number">27.22.1</span> Value Cell
<code>[Lisp]</code></h3>
<p><strong>Definition:</strong> The slot in a symbol holding its
variable value.</p>
<p><strong>Context:</strong> Separate from function cell. Accessed with
<code>symbol-value</code>.</p>
<p><strong>Related Terms:</strong> Symbol, Function Cell, Variable,
Binding</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/symbols.texi</code></p>
<hr/>
<h3 data-number="27.22.2" id="variable-lisp"><span class="header-section-number">27.22.2</span> Variable
<code>[Lisp]</code></h3>
<p><strong>Definition:</strong> A named location for storing a value,
represented by a symbol.</p>
<p><strong>Context:</strong> Can be global, buffer-local, let-bound,
lexical, or dynamic.</p>
<p><strong>Related Terms:</strong> Symbol, Binding, Value Cell, Let</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/variables.texi</code></p>
<hr/>
<h3 data-number="27.22.3" id="vector-data"><span class="header-section-number">27.22.3</span> Vector
<code>[Data]</code></h3>
<p><strong>Definition:</strong> A fixed-size array of Lisp objects,
indexed by integers starting at 0.</p>
<p><strong>Context:</strong> Created with <code>[...]</code> or
<code>make-vector</code>. More efficient than lists for random
access.</p>
<p><strong>Related Terms:</strong> Array, Sequence, List, String</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/sequences.texi</code></p>
<hr/>
<h3 data-number="27.22.4" id="version-control-system"><span class="header-section-number">27.22.4</span> Version Control
<code>[System]</code></h3>
<p><strong>Definition:</strong> System integration for tracking file
changes with Git, SVN, etc.</p>
<p><strong>Context:</strong> VC mode provides unified interface.
<code>C-x v</code> prefix for VC commands.</p>
<p><strong>Related Terms:</strong> Git, VCS, Diff, Commit</p>
<p><strong>Documentation:</strong> See Emacs manual</p>
<hr/>
<h3 data-number="27.22.5" id="visiting-core"><span class="header-section-number">27.22.5</span> Visiting
<code>[Core]</code></h3>
<p><strong>Definition:</strong> Loading a file into a buffer for
editing, establishing the buffer-file association.</p>
<p><strong>Context:</strong> <code>C-x C-f</code> visits files. Buffer
becomes associated with file for saving.</p>
<p><strong>Related Terms:</strong> Find File, Buffer, File, Open</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/files.texi</code></p>
<hr/>
<h3 data-number="27.22.6" id="visual-line-mode-core"><span class="header-section-number">27.22.6</span> Visual Line Mode
<code>[Core]</code></h3>
<p><strong>Definition:</strong> A minor mode providing word-wrapped
display with motion commands treating screen lines as lines.</p>
<p><strong>Context:</strong> <code>C-n</code>/<code>C-p</code> move by
visual lines rather than logical lines.</p>
<p><strong>Related Terms:</strong> Line Wrapping, Word Wrap,
Continuation Line</p>
<p><strong>Documentation:</strong> See Emacs manual</p>
<hr/>
<h2 data-number="27.23" id="w"><span class="header-section-number">27.23</span> W</h2>
<h3 data-number="27.23.1" id="widget-display"><span class="header-section-number">27.23.1</span> Widget
<code>[Display]</code></h3>
<p><strong>Definition:</strong> An interactive UI element in a buffer,
like buttons, fields, or menus in the customization interface.</p>
<p><strong>Context:</strong> Implemented by widget.el. Used extensively
in Customize.</p>
<p><strong>Related Terms:</strong> Button, Field, Customize, UI</p>
<p><strong>Documentation:</strong> See <code>lisp/wid-edit.el</code></p>
<hr/>
<h3 data-number="27.23.2" id="widen-core"><span class="header-section-number">27.23.2</span> Widen
<code>[Core]</code></h3>
<p><strong>Definition:</strong> Removing narrowing restrictions to make
the entire buffer accessible.</p>
<p><strong>Context:</strong> Opposite of narrow.
<code>C-x n w</code>.</p>
<p><strong>Related Terms:</strong> Narrowing, Restriction, BEGV, ZV</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/positions.texi</code></p>
<hr/>
<h3 data-number="27.23.3" id="window-core"><span class="header-section-number">27.23.3</span> Window
<code>[Core]</code></h3>
<p><strong>Definition:</strong> A tiled area within a frame displaying a
buffer.</p>
<p><strong>Context:</strong> Frames contain one or more non-overlapping
windows. Each window displays exactly one buffer.</p>
<p><strong>Related Terms:</strong> Frame, Buffer, Split, Selected
Window</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/windows.texi</code></p>
<hr/>
<h3 data-number="27.23.4" id="window-configuration-core"><span class="header-section-number">27.23.4</span> Window Configuration
<code>[Core]</code></h3>
<p><strong>Definition:</strong> A snapshot of window layout in a frame,
including which buffers are displayed where.</p>
<p><strong>Context:</strong> Saved with
<code>current-window-configuration</code>, restored with
<code>set-window-configuration</code>.</p>
<p><strong>Related Terms:</strong> Window, Layout, Frame,
Configuration</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/windows.texi</code></p>
<hr/>
<h3 data-number="27.23.5" id="window-parameter-display"><span class="header-section-number">27.23.5</span> Window Parameter
<code>[Display]</code></h3>
<p><strong>Definition:</strong> A named property attached to a window
for storing metadata or controlling behavior.</p>
<p><strong>Context:</strong> Similar to frame parameters. Get/set with
<code>window-parameter</code> / <code>set-window-parameter</code>.</p>
<p><strong>Related Terms:</strong> Window, Frame Parameter, Metadata</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/windows.texi</code></p>
<hr/>
<h3 data-number="27.23.6" id="window-point-core"><span class="header-section-number">27.23.6</span> Window Point
<code>[Core]</code></h3>
<p><strong>Definition:</strong> Each window‚Äôs own point position in its
displayed buffer.</p>
<p><strong>Context:</strong> Separate from buffer‚Äôs point. Restored when
window redisplays buffer.</p>
<p><strong>Related Terms:</strong> Point, Window, Buffer, Cursor</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/windows.texi</code></p>
<hr/>
<h3 data-number="27.23.7" id="window-system-display"><span class="header-section-number">27.23.7</span> Window System
<code>[Display]</code></h3>
<p><strong>Definition:</strong> The graphical environment (X11, Wayland,
Windows, macOS) providing GUI capabilities.</p>
<p><strong>Context:</strong> Detected with <code>window-system</code>
variable. Affects available features.</p>
<p><strong>Related Terms:</strong> GUI, X11, Display, TTY, Frame</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/frames.texi</code></p>
<hr/>
<h3 data-number="27.23.8" id="window-tree-core"><span class="header-section-number">27.23.8</span> Window Tree
<code>[Core]</code></h3>
<p><strong>Definition:</strong> The hierarchical structure of window
splits within a frame.</p>
<p><strong>Context:</strong> Windows organized as binary tree of
horizontal/vertical splits.</p>
<p><strong>Related Terms:</strong> Window, Split, Frame, Layout</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/windows.texi</code></p>
<hr/>
<h3 data-number="27.23.9" id="word-wrap-display"><span class="header-section-number">27.23.9</span> Word Wrap
<code>[Display]</code></h3>
<p><strong>Definition:</strong> Breaking lines at word boundaries rather
than character boundaries for readability.</p>
<p><strong>Context:</strong> Enabled by visual-line-mode or word-wrap
variable.</p>
<p><strong>Related Terms:</strong> Line Wrapping, Visual Line Mode,
Fill</p>
<p><strong>Documentation:</strong> See Emacs manual</p>
<hr/>
<h2 data-number="27.24" id="x"><span class="header-section-number">27.24</span> X</h2>
<h3 data-number="27.24.1" id="x-window-system-display"><span class="header-section-number">27.24.1</span> X Window System
<code>[Display]</code></h3>
<p><strong>Definition:</strong> The traditional Unix/Linux graphical
windowing system, commonly called X11 or X.</p>
<p><strong>Context:</strong> One of several window systems Emacs
supports. Provides GUI features.</p>
<p><strong>Related Terms:</strong> Window System, GUI, Display,
Frame</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/frames.texi</code></p>
<hr/>
<h3 data-number="27.24.2" id="xref-core"><span class="header-section-number">27.24.2</span> Xref
<code>[Core]</code></h3>
<p><strong>Definition:</strong> Cross-reference - a system for finding
definitions and references of symbols.</p>
<p><strong>Context:</strong> <code>M-.</code> finds definitions,
<code>M-?</code> finds references. Backend-agnostic.</p>
<p><strong>Related Terms:</strong> Tags, LSP, Navigation, Definition</p>
<p><strong>Documentation:</strong> See Emacs manual</p>
<hr/>
<h2 data-number="27.25" id="y"><span class="header-section-number">27.25</span> Y</h2>
<h3 data-number="27.25.1" id="yank-abbrev-core"><span class="header-section-number">27.25.1</span> Yank <code>[Abbrev]</code>
<code>[Core]</code></h3>
<p><strong>Definition:</strong> Inserting text from the kill ring
(pasting).</p>
<p><strong>Context:</strong> <code>C-y</code> yanks most recent kill.
<code>M-y</code> cycles through kill ring.</p>
<p><strong>Related Terms:</strong> Kill, Kill Ring, Paste, Clipboard</p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/text.texi</code></p>
<hr/>
<h3 data-number="27.25.2" id="yank-pop-core"><span class="header-section-number">27.25.2</span> Yank-Pop
<code>[Core]</code></h3>
<p><strong>Definition:</strong> After yanking, replacing the yanked text
with an earlier kill from the kill ring.</p>
<p><strong>Context:</strong> <code>M-y</code> after <code>C-y</code>.
Cycles through kill ring history.</p>
<p><strong>Related Terms:</strong> Yank, Kill Ring, Ring Buffer</p>
<p><strong>Documentation:</strong> See Emacs manual</p>
<hr/>
<h2 data-number="27.26" id="z"><span class="header-section-number">27.26</span> Z</h2>
<h3 data-number="27.26.1" id="z-zv-data"><span class="header-section-number">27.26.1</span> Z / ZV
<code>[Data]</code></h3>
<p><strong>Definition:</strong> Buffer constants - Z is end position of
buffer, ZV is end of accessible region (after narrowing).</p>
<p><strong>Context:</strong> C macros. Z = (point-max) without
narrowing, ZV = (point-max) with narrowing.</p>
<p><strong>Related Terms:</strong> BEG, BEGV, Point, Narrowing, Gap
Buffer</p>
<p><strong>Source:</strong> See <code>src/buffer.h</code></p>
<p><strong>Documentation:</strong> See
<code>doc/lispref/buffers.texi</code></p>
<hr/>
<h2 data-number="27.27" id="appendix-common-patterns"><span class="header-section-number">27.27</span> Appendix: Common
Patterns</h2>
<h3 data-number="27.27.1" id="begv-to-zv-pattern-data"><span class="header-section-number">27.27.1</span> BEGV-to-ZV Pattern
<code>[Data]</code></h3>
<p><strong>Definition:</strong> The accessible region of a buffer,
respecting narrowing restrictions.</p>
<p><strong>Context:</strong> Many functions operate only within BEGV to
ZV.</p>
<p><strong>Related Terms:</strong> BEG, Z, Narrowing, Restriction</p>
<hr/>
<h3 data-number="27.27.2" id="car-cdr-recursion-lisp"><span class="header-section-number">27.27.2</span> Car-Cdr Recursion
<code>[Lisp]</code></h3>
<p><strong>Definition:</strong> The classic Lisp pattern of processing
lists by operating on first element (car) and recursing on rest
(cdr).</p>
<p><strong>Context:</strong> Fundamental to list processing in Lisp.</p>
<p><strong>Related Terms:</strong> Cons Cell, List, Recursion, Car,
Cdr</p>
<hr/>
<h3 data-number="27.27.3" id="save-match-data-pattern-lisp"><span class="header-section-number">27.27.3</span> Save-Match-Data Pattern
<code>[Lisp]</code></h3>
<p><strong>Definition:</strong> Protecting match data around code that
might perform regexp searches.</p>
<p><strong>Context:</strong> Prevents unintended modification of match
data from outer search.</p>
<p><strong>Related Terms:</strong> Match Data, Regexp, Search,
Unwinding</p>
<hr/>
<h3 data-number="27.27.4" id="with-current-buffer-pattern-lisp"><span class="header-section-number">27.27.4</span> With-Current-Buffer Pattern
<code>[Lisp]</code></h3>
<p><strong>Definition:</strong> Temporarily switching to another buffer
for operations, then restoring original buffer.</p>
<p><strong>Context:</strong> Safer than <code>set-buffer</code> for most
purposes. Macro handles unwinding.</p>
<p><strong>Related Terms:</strong> Current Buffer, Set-Buffer,
Save-Excursion</p>
<hr/>
<h2 data-number="27.28" id="document-statistics-1"><span class="header-section-number">27.28</span> Document Statistics</h2>
<p><strong>Total Terms:</strong> 230</p>
<p><strong>Categories Distribution:</strong> - Core Concepts: 85 terms -
Lisp Concepts: 62 terms - Data Structures: 28 terms - Display System: 35
terms - System Concepts: 30 terms - Abbreviations: 20 terms</p>
<p><strong>Primary Documentation References:</strong> -
<code>doc/lispref/</code> - Emacs Lisp Reference Manual -
<code>src/</code> - C source code and headers - <code>lisp/</code> -
Emacs Lisp implementation - <code>doc/emacs/</code> - User manual -
<code>doc/misc/</code> - Specialized manuals</p>
<hr/>
<p><strong>Last Updated:</strong> 2025-11-18</p>
<p><strong>Emacs Version:</strong> GNU Emacs (development version)</p>
<p><strong>License:</strong> GNU General Public License v3 or later</p>
<h1 data-number="28" id="comprehensive-index"><span class="header-section-number">28</span> Comprehensive Index</h1>
<p><em>GNU Emacs Encyclopedic Guide</em></p>
<hr/>
<h2 data-number="28.1" id="a-1"><span class="header-section-number">28.1</span> A</h2>
<p><strong>Address Sanitizer</strong> ‚Üí
17-development/01-build-and-testing.md <strong>Advice System</strong> ‚Üí
01-architecture/02-design-philosophy.md <strong>alloc.c</strong> ‚Üí
03-elisp-runtime/02-memory-management.md <strong>Android Port</strong> ‚Üí
06-platform-support/01-abstraction-layer.md,
19-industry-context/01-technology-trends.md <strong>Async I/O</strong> ‚Üí
02-core-subsystems/04-process-io.md <strong>Autoconf</strong> ‚Üí
17-development/01-build-and-testing.md <strong>Autoload</strong> ‚Üí
GLOSSARY.md, 08-elisp-library/01-standard-library.md <strong>AVL
Trees</strong> ‚Üí 08-elisp-library/01-standard-library.md</p>
<h2 data-number="28.2" id="b-1"><span class="header-section-number">28.2</span> B</h2>
<p><strong>Backend Abstraction</strong> ‚Üí
06-platform-support/01-abstraction-layer.md,
04-major-subsystems/03-version-control.md <strong>Backward
Compatibility</strong> ‚Üí 01-architecture/02-design-philosophy.md,
18-development-practices/01-coding-evolution.md <strong>Bidi
(Bidirectional Text)</strong> ‚Üí 02-core-subsystems/02-display-engine.md
<strong>Boyer-Moore Algorithm</strong> ‚Üí
09-text-processing/01-search-and-regex.md <strong>Buffer</strong> ‚Üí
GLOSSARY.md, 02-core-subsystems/01-buffer-management.md
<strong>buffer.c</strong> ‚Üí 02-core-subsystems/01-buffer-management.md
<strong>Build System</strong> ‚Üí 17-development/01-build-and-testing.md
<strong>Bytecode</strong> ‚Üí 03-elisp-runtime/01-interpreter-core.md
<strong>Bytecode Compilation</strong> ‚Üí
03-elisp-runtime/01-interpreter-core.md,
18-development-practices/01-coding-evolution.md</p>
<h2 data-number="28.3" id="c-1"><span class="header-section-number">28.3</span> C</h2>
<p><strong>Calc</strong> ‚Üí 04-major-subsystems/05-calc.md <strong>Case
Handling</strong> ‚Üí 09-text-processing/01-search-and-regex.md
<strong>CEDET</strong> ‚Üí 04-major-subsystems/04-cedet.md,
19-industry-context/01-technology-trends.md <strong>Character
Encoding</strong> ‚Üí 02-core-subsystems/05-file-io-encoding.md
<strong>Closures</strong> ‚Üí 03-elisp-runtime/01-interpreter-core.md
<strong>Coding Systems</strong> ‚Üí
02-core-subsystems/05-file-io-encoding.md <strong>Command Loop</strong>
‚Üí 02-core-subsystems/03-keyboard-events.md <strong>Completion</strong> ‚Üí
08-elisp-library/01-standard-library.md <strong>comp.c</strong> ‚Üí
03-elisp-runtime/01-interpreter-core.md <strong>Comparative
Analysis</strong> ‚Üí 20-comparative-analysis/01-editor-comparison.md
<strong>Cross-Platform Support</strong> ‚Üí
06-platform-support/01-abstraction-layer.md</p>
<h2 data-number="28.4" id="d-1"><span class="header-section-number">28.4</span> D</h2>
<p><strong>Data Structures</strong> ‚Üí GLOSSARY.md,
08-elisp-library/01-standard-library.md <strong>DEFUN Macro</strong> ‚Üí
03-elisp-runtime/01-interpreter-core.md,
01-architecture/02-design-philosophy.md <strong>Design
Philosophy</strong> ‚Üí 01-architecture/02-design-philosophy.md
<strong>Display Engine</strong> ‚Üí
02-core-subsystems/02-display-engine.md <strong>dispnew.c</strong> ‚Üí
02-core-subsystems/02-display-engine.md <strong>Double
Buffering</strong> ‚Üí 07-window-systems/01-x11-integration.md
<strong>Dynamic Binding</strong> ‚Üí
03-elisp-runtime/01-interpreter-core.md</p>
<h2 data-number="28.5" id="e-1"><span class="header-section-number">28.5</span> E</h2>
<p><strong>Eglot</strong> ‚Üí 19-industry-context/01-technology-trends.md
<strong>Elisp Interpreter</strong> ‚Üí
03-elisp-runtime/01-interpreter-core.md <strong>Emacs History</strong> ‚Üí
00-introduction/01-welcome.md,
18-development-practices/01-coding-evolution.md <strong>ERT
(Testing)</strong> ‚Üí 17-development/01-build-and-testing.md
<strong>eval.c</strong> ‚Üí 03-elisp-runtime/01-interpreter-core.md
<strong>Event Loop</strong> ‚Üí 02-core-subsystems/03-keyboard-events.md,
07-window-systems/01-x11-integration.md <strong>Extensibility</strong> ‚Üí
01-architecture/02-design-philosophy.md</p>
<h2 data-number="28.6" id="f-1"><span class="header-section-number">28.6</span> F</h2>
<p><strong>Faces</strong> ‚Üí 02-core-subsystems/02-display-engine.md
<strong>File I/O</strong> ‚Üí 02-core-subsystems/05-file-io-encoding.md
<strong>fileio.c</strong> ‚Üí 02-core-subsystems/05-file-io-encoding.md
<strong>Filters (Process)</strong> ‚Üí 02-core-subsystems/04-process-io.md
<strong>Font Backend</strong> ‚Üí 07-window-systems/01-x11-integration.md
<strong>Fringe</strong> ‚Üí 02-core-subsystems/02-display-engine.md</p>
<h2 data-number="28.7" id="g-1"><span class="header-section-number">28.7</span> G</h2>
<p><strong>Gap Buffer</strong> ‚Üí
02-core-subsystems/01-buffer-management.md <strong>Garbage
Collection</strong> ‚Üí 03-elisp-runtime/02-memory-management.md
<strong>Git History Analysis</strong> ‚Üí
18-development-practices/01-coding-evolution.md <strong>Glyph
Matrices</strong> ‚Üí 02-core-subsystems/02-display-engine.md <strong>GNU
Project</strong> ‚Üí 00-introduction/01-welcome.md <strong>Gnus</strong> ‚Üí
04-major-subsystems/02-gnus.md <strong>Graphics Context</strong> ‚Üí
07-window-systems/01-x11-integration.md <strong>GTK</strong> ‚Üí
06-platform-support/01-abstraction-layer.md</p>
<h2 data-number="28.8" id="h-1"><span class="header-section-number">28.8</span> H</h2>
<p><strong>Haiku</strong> ‚Üí 06-platform-support/01-abstraction-layer.md
<strong>Help System</strong> ‚Üí 08-elisp-library/01-standard-library.md,
01-architecture/02-design-philosophy.md <strong>Hooks</strong> ‚Üí
01-architecture/02-design-philosophy.md</p>
<h2 data-number="28.9" id="i-1"><span class="header-section-number">28.9</span> I</h2>
<p><strong>Image Rendering</strong> ‚Üí
07-window-systems/01-x11-integration.md <strong>Industry
Context</strong> ‚Üí 19-industry-context/01-technology-trends.md
<strong>Input Methods</strong> ‚Üí 07-window-systems/01-x11-integration.md
<strong>insdel.c</strong> ‚Üí 02-core-subsystems/01-buffer-management.md
<strong>Intervals</strong> ‚Üí 02-core-subsystems/01-buffer-management.md
<strong>Interval Trees</strong> ‚Üí
02-core-subsystems/01-buffer-management.md</p>
<h2 data-number="28.10" id="k-1"><span class="header-section-number">28.10</span> K</h2>
<p><strong>KBOARD</strong> ‚Üí 02-core-subsystems/03-keyboard-events.md
<strong>Keyboard Events</strong> ‚Üí
02-core-subsystems/03-keyboard-events.md <strong>keyboard.c</strong> ‚Üí
02-core-subsystems/03-keyboard-events.md <strong>Keyboard
Macros</strong> ‚Üí 02-core-subsystems/03-keyboard-events.md
<strong>Keymap</strong> ‚Üí 02-core-subsystems/03-keyboard-events.md,
GLOSSARY.md <strong>keymap.c</strong> ‚Üí
02-core-subsystems/03-keyboard-events.md</p>
<h2 data-number="28.11" id="l-1"><span class="header-section-number">28.11</span> L</h2>
<p><strong>Language Server Protocol (LSP)</strong> ‚Üí
19-industry-context/01-technology-trends.md <strong>Lexical
Binding</strong> ‚Üí 03-elisp-runtime/01-interpreter-core.md,
18-development-practices/01-coding-evolution.md
<strong>libgccjit</strong> ‚Üí 03-elisp-runtime/01-interpreter-core.md,
19-industry-context/01-technology-trends.md <strong>Lisp
Machine</strong> ‚Üí 00-introduction/01-welcome.md,
19-industry-context/01-technology-trends.md <strong>Lisp_Object</strong>
‚Üí 03-elisp-runtime/01-interpreter-core.md, GLOSSARY.md
<strong>lread.c</strong> ‚Üí 03-elisp-runtime/01-interpreter-core.md</p>
<h2 data-number="28.12" id="m-1"><span class="header-section-number">28.12</span> M</h2>
<p><strong>Makefile</strong> ‚Üí 17-development/01-build-and-testing.md
<strong>Markers</strong> ‚Üí 02-core-subsystems/01-buffer-management.md
<strong>Mark and Sweep</strong> ‚Üí
03-elisp-runtime/02-memory-management.md <strong>Memory
Management</strong> ‚Üí 03-elisp-runtime/02-memory-management.md
<strong>Minibuffer</strong> ‚Üí 08-elisp-library/01-standard-library.md,
GLOSSARY.md <strong>MIT AI Lab</strong> ‚Üí 00-introduction/01-welcome.md,
19-industry-context/01-technology-trends.md <strong>Mode Line</strong> ‚Üí
GLOSSARY.md <strong>Modularity</strong> ‚Üí
01-architecture/02-design-philosophy.md <strong>Mouse Events</strong> ‚Üí
02-core-subsystems/03-keyboard-events.md,
07-window-systems/01-x11-integration.md</p>
<h2 data-number="28.13" id="n-1"><span class="header-section-number">28.13</span> N</h2>
<p><strong>Native Compilation</strong> ‚Üí
03-elisp-runtime/01-interpreter-core.md,
19-industry-context/01-technology-trends.md <strong>Network
Processes</strong> ‚Üí 02-core-subsystems/04-process-io.md</p>
<h2 data-number="28.14" id="o-1"><span class="header-section-number">28.14</span> O</h2>
<p><strong>Org Mode</strong> ‚Üí 04-major-subsystems/01-org-mode.md
<strong>Overlays</strong> ‚Üí GLOSSARY.md</p>
<h2 data-number="28.15" id="p-1"><span class="header-section-number">28.15</span> P</h2>
<p><strong>Package Management</strong> ‚Üí
18-development-practices/01-coding-evolution.md <strong>pdumper</strong>
‚Üí 17-development/01-build-and-testing.md <strong>Performance</strong> ‚Üí
01-architecture/02-design-philosophy.md,
19-industry-context/01-technology-trends.md <strong>Platform
Abstraction</strong> ‚Üí 06-platform-support/01-abstraction-layer.md
<strong>Point</strong> ‚Üí GLOSSARY.md,
02-core-subsystems/01-buffer-management.md <strong>Portable
Dumper</strong> ‚Üí 00-introduction/01-welcome.md <strong>POSIX</strong> ‚Üí
02-core-subsystems/04-process-io.md <strong>print.c</strong> ‚Üí
03-elisp-runtime/01-interpreter-core.md <strong>Process
Management</strong> ‚Üí 02-core-subsystems/04-process-io.md
<strong>process.c</strong> ‚Üí 02-core-subsystems/04-process-io.md
<strong>Progressive Enhancement</strong> ‚Üí
01-architecture/02-design-philosophy.md <strong>PTY</strong> ‚Üí
02-core-subsystems/04-process-io.md</p>
<h2 data-number="28.16" id="r-1"><span class="header-section-number">28.16</span> R</h2>
<p><strong>Redisplay</strong> ‚Üí 02-core-subsystems/02-display-engine.md
<strong>redisplay_internal</strong> ‚Üí
02-core-subsystems/02-display-engine.md <strong>Regex Engine</strong> ‚Üí
09-text-processing/01-search-and-regex.md <strong>regex-emacs.c</strong>
‚Üí 09-text-processing/01-search-and-regex.md <strong>Region</strong> ‚Üí
GLOSSARY.md <strong>Richard Stallman</strong> ‚Üí
00-introduction/01-welcome.md</p>
<h2 data-number="28.17" id="s-1"><span class="header-section-number">28.17</span> S</h2>
<p><strong>Search</strong> ‚Üí 09-text-processing/01-search-and-regex.md
<strong>search.c</strong> ‚Üí 09-text-processing/01-search-and-regex.md
<strong>Self-Documentation</strong> ‚Üí
01-architecture/02-design-philosophy.md, 00-introduction/01-welcome.md
<strong>Sentinels</strong> ‚Üí 02-core-subsystems/04-process-io.md
<strong>Serial Port</strong> ‚Üí 02-core-subsystems/04-process-io.md
<strong>SFNT</strong> ‚Üí 06-platform-support/01-abstraction-layer.md
<strong>simple.el</strong> ‚Üí 08-elisp-library/01-standard-library.md
<strong>subr.el</strong> ‚Üí 08-elisp-library/01-standard-library.md
<strong>Syntax Tables</strong> ‚Üí
09-text-processing/01-search-and-regex.md, GLOSSARY.md
<strong>syntax.c</strong> ‚Üí
09-text-processing/01-search-and-regex.md</p>
<h2 data-number="28.18" id="t-1"><span class="header-section-number">28.18</span> T</h2>
<p><strong>Tagged Pointers</strong> ‚Üí
03-elisp-runtime/01-interpreter-core.md <strong>Terminal</strong> ‚Üí
GLOSSARY.md, 06-platform-support/01-abstraction-layer.md
<strong>Testing</strong> ‚Üí 17-development/01-build-and-testing.md
<strong>Text Properties</strong> ‚Üí
02-core-subsystems/01-buffer-management.md, GLOSSARY.md
<strong>Thread</strong> ‚Üí GLOSSARY.md <strong>Tree-sitter</strong> ‚Üí
00-introduction/01-welcome.md,
19-industry-context/01-technology-trends.md <strong>TTY</strong> ‚Üí
06-platform-support/01-abstraction-layer.md</p>
<h2 data-number="28.19" id="u-1"><span class="header-section-number">28.19</span> U</h2>
<p><strong>Unicode</strong> ‚Üí 02-core-subsystems/05-file-io-encoding.md,
09-text-processing/01-search-and-regex.md <strong>Unix Wars</strong> ‚Üí
19-industry-context/01-technology-trends.md <strong>UTF-8</strong> ‚Üí
02-core-subsystems/05-file-io-encoding.md</p>
<h2 data-number="28.20" id="v-1"><span class="header-section-number">28.20</span> V</h2>
<p><strong>VC (Version Control)</strong> ‚Üí
04-major-subsystems/03-version-control.md <strong>Vim
Comparison</strong> ‚Üí 20-comparative-analysis/01-editor-comparison.md
<strong>VSCode Comparison</strong> ‚Üí
20-comparative-analysis/01-editor-comparison.md</p>
<h2 data-number="28.21" id="w-1"><span class="header-section-number">28.21</span> W</h2>
<p><strong>Window</strong> ‚Üí GLOSSARY.md,
08-elisp-library/01-standard-library.md <strong>Window
Management</strong> ‚Üí 07-window-systems/01-x11-integration.md
<strong>window.el</strong> ‚Üí 08-elisp-library/01-standard-library.md
<strong>Windows (W32)</strong> ‚Üí
06-platform-support/01-abstraction-layer.md</p>
<h2 data-number="28.22" id="x-1"><span class="header-section-number">28.22</span> X</h2>
<p><strong>X11</strong> ‚Üí 07-window-systems/01-x11-integration.md,
06-platform-support/01-abstraction-layer.md <strong>xdisp.c</strong> ‚Üí
02-core-subsystems/02-display-engine.md <strong>xfaces.c</strong> ‚Üí
02-core-subsystems/02-display-engine.md <strong>Xft</strong> ‚Üí
07-window-systems/01-x11-integration.md <strong>XSETTINGS</strong> ‚Üí
07-window-systems/01-x11-integration.md <strong>xterm.c</strong> ‚Üí
07-window-systems/01-x11-integration.md</p>
<hr/>
<h2 data-number="28.23" id="cross-references-by-topic"><span class="header-section-number">28.23</span> Cross-References by
Topic</h2>
<h3 data-number="28.23.1" id="core-architecture-2"><span class="header-section-number">28.23.1</span> Core Architecture</h3>
<ul>
<li>Architecture Overview ‚Üí 01-architecture/02-design-philosophy.md</li>
<li>Buffer Management ‚Üí 02-core-subsystems/01-buffer-management.md</li>
<li>Display Engine ‚Üí 02-core-subsystems/02-display-engine.md</li>
<li>Elisp Runtime ‚Üí 03-elisp-runtime/01-interpreter-core.md</li>
<li>Memory Management ‚Üí 03-elisp-runtime/02-memory-management.md</li>
</ul>
<h3 data-number="28.23.2" id="user-interface-1"><span class="header-section-number">28.23.2</span> User Interface</h3>
<ul>
<li>Keyboard/Events ‚Üí 02-core-subsystems/03-keyboard-events.md</li>
<li>Window Systems ‚Üí 07-window-systems/01-x11-integration.md</li>
<li>Platform Support ‚Üí 06-platform-support/01-abstraction-layer.md</li>
</ul>
<h3 data-number="28.23.3" id="io-systems"><span class="header-section-number">28.23.3</span> I/O Systems</h3>
<ul>
<li>File I/O ‚Üí 02-core-subsystems/05-file-io-encoding.md</li>
<li>Process I/O ‚Üí 02-core-subsystems/04-process-io.md</li>
<li>Text Processing ‚Üí 09-text-processing/01-search-and-regex.md</li>
</ul>
<h3 data-number="28.23.4" id="major-applications"><span class="header-section-number">28.23.4</span> Major Applications</h3>
<ul>
<li>Org Mode ‚Üí 04-major-subsystems/01-org-mode.md</li>
<li>Gnus ‚Üí 04-major-subsystems/02-gnus.md</li>
<li>Version Control ‚Üí 04-major-subsystems/03-version-control.md</li>
<li>CEDET ‚Üí 04-major-subsystems/04-cedet.md</li>
<li>Calc ‚Üí 04-major-subsystems/05-calc.md</li>
</ul>
<h3 data-number="28.23.5" id="development"><span class="header-section-number">28.23.5</span> Development</h3>
<ul>
<li>Build System ‚Üí 17-development/01-build-and-testing.md</li>
<li>Coding Evolution ‚Üí
18-development-practices/01-coding-evolution.md</li>
<li>Testing ‚Üí 17-development/01-build-and-testing.md</li>
</ul>
<h3 data-number="28.23.6" id="context-analysis"><span class="header-section-number">28.23.6</span> Context &amp; Analysis</h3>
<ul>
<li>Historical Context ‚Üí 00-introduction/01-welcome.md</li>
<li>Industry Trends ‚Üí 19-industry-context/01-technology-trends.md</li>
<li>Editor Comparison ‚Üí
20-comparative-analysis/01-editor-comparison.md</li>
<li>Design Philosophy ‚Üí 01-architecture/02-design-philosophy.md</li>
</ul>
<hr/>
<p><em>Last Updated: 2025-11-18</em></p>
</main>
</div>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>
<script>
  // Mobile TOC toggle
  function toggleTOC() {
    const tocContent = document.getElementById('toc-content');
    tocContent.classList.toggle('active');
  }

  // Close TOC when clicking a link on mobile
  document.querySelectorAll('#TOC a').forEach(link => {
    link.addEventListener('click', () => {
      if (window.innerWidth < 1024) {
        document.getElementById('toc-content').classList.remove('active');
      }
    });
  });

  // Smooth scrolling for anchor links
  document.querySelectorAll('a[href^="#"]').forEach(anchor => {
    anchor.addEventListener('click', function (e) {
      e.preventDefault();
      const target = document.querySelector(this.getAttribute('href'));
      if (target) {
        target.scrollIntoView({
          behavior: 'smooth',
          block: 'start'
        });
      }
    });
  });

  // Search functionality
  let searchIndex = [];
  let fuse = null;

  // Build search index from all headings and paragraphs
  function buildSearchIndex() {
    const content = document.querySelector('.book-content');
    const items = [];

    // Index all headings
    content.querySelectorAll('h1, h2, h3, h4, h5, h6').forEach((heading, idx) => {
      const id = heading.id || `heading-`;
      if (!heading.id) heading.id = id;

      items.push({
        id: id,
        title: heading.textContent,
        content: heading.textContent,
        type: 'heading',
        level: heading.tagName
      });

      // Also index the paragraph after each heading for context
      let next = heading.nextElementSibling;
      if (next && (next.tagName === 'P' || next.tagName === 'DIV')) {
        items.push({
          id: id,
          title: heading.textContent,
          content: next.textContent.substring(0, 200),
          type: 'content',
          level: heading.tagName
        });
      }
    });

    // Index code blocks
    content.querySelectorAll('pre code').forEach((code, idx) => {
      const pre = code.closest('pre');
      const id = pre.id || `code-`;
      if (!pre.id) pre.id = id;

      items.push({
        id: id,
        title: 'Code: ' + code.textContent.substring(0, 50) + '...',
        content: code.textContent,
        type: 'code'
      });
    });

    searchIndex = items;

    // Initialize Fuse.js
    fuse = new Fuse(searchIndex, {
      keys: ['title', 'content'],
      threshold: 0.3,
      includeScore: true,
      minMatchCharLength: 2
    });
  }

  // Perform search
  function performSearch(query) {
    const resultsDiv = document.getElementById('search-results');

    if (!query || query.length < 2) {
      resultsDiv.innerHTML = '';
      resultsDiv.style.display = 'none';
      return;
    }

    const results = fuse.search(query);

    if (results.length === 0) {
      resultsDiv.innerHTML = '<div class="search-no-results">No results found</div>';
      resultsDiv.style.display = 'block';
      return;
    }

    // Display top 10 results
    const html = results.slice(0, 10).map(result => {
      const item = result.item;
      const typeIcon = item.type === 'heading' ? 'üìÑ' : item.type === 'code' ? 'üíª' : 'üìù';
      return '<a href="#' + item.id + '" class="search-result-item" onclick="closeSearchOnMobile()">' +
        '<span class="search-result-icon">' + typeIcon + '</span>' +
        '<span class="search-result-title">' + highlightMatch(item.title, query) + '</span>' +
        '</a>';
    }).join('');

    resultsDiv.innerHTML = html;
    resultsDiv.style.display = 'block';
  }

  // Highlight matching text
  function highlightMatch(text, query) {
    const regex = new RegExp('(' + query + ')', 'gi');
    return text.replace(regex, '<mark>$1</mark>');
  }

  // Close search results on mobile
  function closeSearchOnMobile() {
    if (window.innerWidth < 1024) {
      document.getElementById('search-results').style.display = 'none';
      document.getElementById('search-input').value = '';
      document.getElementById('toc-content').classList.remove('active');
    }
  }

  // Initialize search when page loads
  document.addEventListener('DOMContentLoaded', () => {
    buildSearchIndex();

    const searchInput = document.getElementById('search-input');
    searchInput.addEventListener('input', (e) => {
      performSearch(e.target.value);
    });

    // Close search results when clicking outside
    document.addEventListener('click', (e) => {
      const searchContainer = document.querySelector('.search-container');
      if (!searchContainer.contains(e.target)) {
        document.getElementById('search-results').style.display = 'none';
      }
    });
  });
</script>
</body>
</html>
